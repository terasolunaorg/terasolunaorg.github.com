<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>9.10. Implementation Example of Typical Security Requirements &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.4.1.RELEASE documentation</title>
    <link rel="stylesheet" href="../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '5.4.1.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="10. Unit test" href="../UnitTest/index.html" />
    <link rel="prev" title="9.9. OAuth" href="OAuth.html" /><script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../UnitTest/index.html" title="10. Unit test"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="OAuth.html" title="9.9. OAuth"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.4.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">9. Security countermeasures</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">9.10. Implementation Example of Typical Security Requirements</a><ul>
<li><a class="reference internal" href="#introduction">9.10.1. Introduction</a><ul>
<li><a class="reference internal" href="#topics-described-in-this-chapter">9.10.1.1. Topics described in this chapter</a></li>
<li><a class="reference internal" href="#target-readers">9.10.1.2. Target Readers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#description-of-application">9.10.2. Description of application</a><ul>
<li><a class="reference internal" href="#security-requirements">9.10.2.1. Security requirements</a></li>
<li><a class="reference internal" href="#functions">9.10.2.2. Functions</a></li>
<li><a class="reference internal" href="#specifications-for-authentication-authorization">9.10.2.3. Specifications for authentication/authorization</a><ul>
<li><a class="reference internal" href="#authentication">9.10.2.3.1. Authentication</a></li>
<li><a class="reference internal" href="#authorization">9.10.2.3.2. Authorization</a></li>
<li><a class="reference internal" href="#authentication-at-the-time-of-reissuing-password">9.10.2.3.3. Authentication at the time of reissuing password</a></li>
</ul>
</li>
<li><a class="reference internal" href="#design-information">9.10.2.4. Design information</a><ul>
<li><a class="reference internal" href="#page-transition">9.10.2.4.1. Page transition</a></li>
<li><a class="reference internal" href="#url-list">9.10.2.4.2. URL List</a></li>
<li><a class="reference internal" href="#er-diagram">9.10.2.4.3. ER diagram</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-method-and-code-description">9.10.3. Implementation method and code description</a><ul>
<li><a class="reference internal" href="#force-prompt-password-change">9.10.3.1. Force/Prompt password change</a><ul>
<li><a class="reference internal" href="#list-of-requirements-to-be-implemented">9.10.3.1.1. List of requirements to be implemented</a></li>
<li><a class="reference internal" href="#working-image">9.10.3.1.2. Working image</a></li>
<li><a class="reference internal" href="#implementation-method">9.10.3.1.3. Implementation method</a></li>
<li><a class="reference internal" href="#code-description">9.10.3.1.4. Code description</a></li>
</ul>
</li>
<li><a class="reference internal" href="#check-password-strength">9.10.3.2. Check password strength</a><ul>
<li><a class="reference internal" href="#id1">9.10.3.2.1. List of requirements to be implemented</a></li>
<li><a class="reference internal" href="#id2">9.10.3.2.2. Working image</a></li>
<li><a class="reference internal" href="#id3">9.10.3.2.3. Implementation method</a></li>
<li><a class="reference internal" href="#id4">9.10.3.2.4. Code description</a></li>
</ul>
</li>
<li><a class="reference internal" href="#account-lock">9.10.3.3. Account lock</a><ul>
<li><a class="reference internal" href="#id6">9.10.3.3.1. List of requirements to be implemented</a></li>
<li><a class="reference internal" href="#id7">9.10.3.3.2. Working image</a></li>
<li><a class="reference internal" href="#id8">9.10.3.3.3. Implementation method</a></li>
<li><a class="reference internal" href="#id9">9.10.3.3.4. Code description</a></li>
</ul>
</li>
<li><a class="reference internal" href="#display-the-date-and-time-of-last-login">9.10.3.4. Display the date and time of last login</a><ul>
<li><a class="reference internal" href="#id10">9.10.3.4.1. List of requirements to be implemented</a></li>
<li><a class="reference internal" href="#id11">9.10.3.4.2. Working image</a></li>
<li><a class="reference internal" href="#id12">9.10.3.4.3. Implementation method</a></li>
<li><a class="reference internal" href="#id13">9.10.3.4.4. Code description</a></li>
</ul>
</li>
<li><a class="reference internal" href="#creating-authentication-information-for-password-reissue">9.10.3.5. Creating authentication information for password reissue</a><ul>
<li><a class="reference internal" href="#id14">9.10.3.5.1. List of requirements to be implemented</a></li>
<li><a class="reference internal" href="#id15">9.10.3.5.2. Working image</a></li>
<li><a class="reference internal" href="#id16">9.10.3.5.3. Implementation method</a></li>
<li><a class="reference internal" href="#id17">9.10.3.5.4. Code description</a></li>
</ul>
</li>
<li><a class="reference internal" href="#distribution-of-authentication-information-for-password-reissue">9.10.3.6. Distribution of authentication information for password reissue</a><ul>
<li><a class="reference internal" href="#id18">9.10.3.6.1. List of requirements to be implemented</a></li>
<li><a class="reference internal" href="#id19">9.10.3.6.2. Working image</a></li>
<li><a class="reference internal" href="#id20">9.10.3.6.3. Implementation method</a></li>
<li><a class="reference internal" href="#id21">9.10.3.6.4. Code description</a></li>
</ul>
</li>
<li><a class="reference internal" href="#validation-at-the-time-of-executing-password-reissue">9.10.3.7. Validation at the time of executing password reissue</a><ul>
<li><a class="reference internal" href="#id22">9.10.3.7.1. List of requirements to be implemented</a></li>
<li><a class="reference internal" href="#id23">9.10.3.7.2. Working image</a></li>
<li><a class="reference internal" href="#id24">9.10.3.7.3. Implementation method</a></li>
<li><a class="reference internal" href="#id25">9.10.3.7.4. Code description</a></li>
</ul>
</li>
<li><a class="reference internal" href="#setting-failure-limit-for-the-password-reissue">9.10.3.8. Setting failure limit for the password reissue</a><ul>
<li><a class="reference internal" href="#id26">9.10.3.8.1. List of requirements to be implemented</a></li>
<li><a class="reference internal" href="#id27">9.10.3.8.2. Working image</a></li>
<li><a class="reference internal" href="#id28">9.10.3.8.3. Implementation method</a></li>
<li><a class="reference internal" href="#id29">9.10.3.8.4. Code description</a></li>
</ul>
</li>
<li><a class="reference internal" href="#input-check-validation-for-security">9.10.3.9. Input check validation for security</a><ul>
<li><a class="reference internal" href="#id30">9.10.3.9.1. List of requirements to be implemented</a></li>
<li><a class="reference internal" href="#id31">9.10.3.9.2. Working image</a></li>
<li><a class="reference internal" href="#id32">9.10.3.9.3. Implementation method</a></li>
<li><a class="reference internal" href="#id33">9.10.3.9.4. Code description</a></li>
</ul>
</li>
<li><a class="reference internal" href="#audit-log-output">9.10.3.10. Audit log output</a><ul>
<li><a class="reference internal" href="#id34">9.10.3.10.1. List of requirements to be implemented</a></li>
<li><a class="reference internal" href="#id35">9.10.3.10.2. Working image</a></li>
<li><a class="reference internal" href="#how-to-implement">9.10.3.10.3. How to implement</a></li>
<li><a class="reference internal" href="#id36">9.10.3.10.4. Code description</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#conclusion">9.10.4. Conclusion</a></li>
<li><a class="reference internal" href="#appendix">9.10.5. Appendix</a><ul>
<li><a class="reference internal" href="#passay-overview">9.10.5.1. Passay</a><ul>
<li><a class="reference internal" href="#password-validation">9.10.5.1.1. Password validation</a><ul>
<li><a class="reference internal" href="#overview">9.10.5.1.1.1. Overview</a></li>
<li><a class="reference internal" href="#how-to-use">9.10.5.1.1.2. How to use</a></li>
</ul>
</li>
<li><a class="reference internal" href="#password-generation">9.10.5.1.2. Password generation</a><ul>
<li><a class="reference internal" href="#id40">9.10.5.1.2.1. Overview</a></li>
<li><a class="reference internal" href="#id41">9.10.5.1.2.2. How to use</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="OAuth.html"
                        title="previous chapter">9.9. OAuth</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../UnitTest/index.html"
                        title="next chapter">10. Unit test</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/Security/SecureLoginDemo.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="implementation-example-of-typical-security-requirements">
<h1>9.10. Implementation Example of Typical Security Requirements<a class="headerlink" href="#implementation-example-of-typical-security-requirements" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id42">Introduction</a><ul>
<li><a class="reference internal" href="#topics-described-in-this-chapter" id="id43">Topics described in this chapter</a></li>
<li><a class="reference internal" href="#target-readers" id="id44">Target Readers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#description-of-application" id="id45">Description of application</a><ul>
<li><a class="reference internal" href="#security-requirements" id="id46">Security requirements</a></li>
<li><a class="reference internal" href="#functions" id="id47">Functions</a></li>
<li><a class="reference internal" href="#specifications-for-authentication-authorization" id="id48">Specifications for authentication/authorization</a><ul>
<li><a class="reference internal" href="#authentication" id="id49">Authentication</a></li>
<li><a class="reference internal" href="#authorization" id="id50">Authorization</a></li>
<li><a class="reference internal" href="#authentication-at-the-time-of-reissuing-password" id="id51">Authentication at the time of reissuing password</a></li>
</ul>
</li>
<li><a class="reference internal" href="#design-information" id="id52">Design information</a><ul>
<li><a class="reference internal" href="#page-transition" id="id53">Page transition</a></li>
<li><a class="reference internal" href="#url-list" id="id54">URL List</a></li>
<li><a class="reference internal" href="#er-diagram" id="id55">ER diagram</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-method-and-code-description" id="id56">Implementation method and code description</a><ul>
<li><a class="reference internal" href="#force-prompt-password-change" id="id57">Force/Prompt password change</a><ul>
<li><a class="reference internal" href="#list-of-requirements-to-be-implemented" id="id58">List of requirements to be implemented</a></li>
<li><a class="reference internal" href="#working-image" id="id59">Working image</a></li>
<li><a class="reference internal" href="#implementation-method" id="id60">Implementation method</a></li>
<li><a class="reference internal" href="#code-description" id="id61">Code description</a></li>
</ul>
</li>
<li><a class="reference internal" href="#check-password-strength" id="id62">Check password strength</a><ul>
<li><a class="reference internal" href="#id1" id="id63">List of requirements to be implemented</a></li>
<li><a class="reference internal" href="#id2" id="id64">Working image</a></li>
<li><a class="reference internal" href="#id3" id="id65">Implementation method</a></li>
<li><a class="reference internal" href="#id4" id="id66">Code description</a></li>
</ul>
</li>
<li><a class="reference internal" href="#account-lock" id="id67">Account lock</a><ul>
<li><a class="reference internal" href="#id6" id="id68">List of requirements to be implemented</a></li>
<li><a class="reference internal" href="#id7" id="id69">Working image</a></li>
<li><a class="reference internal" href="#id8" id="id70">Implementation method</a></li>
<li><a class="reference internal" href="#id9" id="id71">Code description</a></li>
</ul>
</li>
<li><a class="reference internal" href="#display-the-date-and-time-of-last-login" id="id72">Display the date and time of last login</a><ul>
<li><a class="reference internal" href="#id10" id="id73">List of requirements to be implemented</a></li>
<li><a class="reference internal" href="#id11" id="id74">Working image</a></li>
<li><a class="reference internal" href="#id12" id="id75">Implementation method</a></li>
<li><a class="reference internal" href="#id13" id="id76">Code description</a></li>
</ul>
</li>
<li><a class="reference internal" href="#creating-authentication-information-for-password-reissue" id="id77">Creating authentication information for password reissue</a><ul>
<li><a class="reference internal" href="#id14" id="id78">List of requirements to be implemented</a></li>
<li><a class="reference internal" href="#id15" id="id79">Working image</a></li>
<li><a class="reference internal" href="#id16" id="id80">Implementation method</a></li>
<li><a class="reference internal" href="#id17" id="id81">Code description</a></li>
</ul>
</li>
<li><a class="reference internal" href="#distribution-of-authentication-information-for-password-reissue" id="id82">Distribution of authentication information for password reissue</a><ul>
<li><a class="reference internal" href="#id18" id="id83">List of requirements to be implemented</a></li>
<li><a class="reference internal" href="#id19" id="id84">Working image</a></li>
<li><a class="reference internal" href="#id20" id="id85">Implementation method</a></li>
<li><a class="reference internal" href="#id21" id="id86">Code description</a></li>
</ul>
</li>
<li><a class="reference internal" href="#validation-at-the-time-of-executing-password-reissue" id="id87">Validation at the time of executing password reissue</a><ul>
<li><a class="reference internal" href="#id22" id="id88">List of requirements to be implemented</a></li>
<li><a class="reference internal" href="#id23" id="id89">Working image</a></li>
<li><a class="reference internal" href="#id24" id="id90">Implementation method</a></li>
<li><a class="reference internal" href="#id25" id="id91">Code description</a></li>
</ul>
</li>
<li><a class="reference internal" href="#setting-failure-limit-for-the-password-reissue" id="id92">Setting failure limit for the password reissue</a><ul>
<li><a class="reference internal" href="#id26" id="id93">List of requirements to be implemented</a></li>
<li><a class="reference internal" href="#id27" id="id94">Working image</a></li>
<li><a class="reference internal" href="#id28" id="id95">Implementation method</a></li>
<li><a class="reference internal" href="#id29" id="id96">Code description</a></li>
</ul>
</li>
<li><a class="reference internal" href="#input-check-validation-for-security" id="id97">Input check validation for security</a><ul>
<li><a class="reference internal" href="#id30" id="id98">List of requirements to be implemented</a></li>
<li><a class="reference internal" href="#id31" id="id99">Working image</a></li>
<li><a class="reference internal" href="#id32" id="id100">Implementation method</a></li>
<li><a class="reference internal" href="#id33" id="id101">Code description</a></li>
</ul>
</li>
<li><a class="reference internal" href="#audit-log-output" id="id102">Audit log output</a><ul>
<li><a class="reference internal" href="#id34" id="id103">List of requirements to be implemented</a></li>
<li><a class="reference internal" href="#id35" id="id104">Working image</a></li>
<li><a class="reference internal" href="#how-to-implement" id="id105">How to implement</a></li>
<li><a class="reference internal" href="#id36" id="id106">Code description</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#conclusion" id="id107">Conclusion</a></li>
<li><a class="reference internal" href="#appendix" id="id108">Appendix</a><ul>
<li><a class="reference internal" href="#passay-overview" id="id109">Passay</a><ul>
<li><a class="reference internal" href="#password-validation" id="id110">Password validation</a></li>
<li><a class="reference internal" href="#password-generation" id="id111">Password generation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id42">9.10.1. Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<div class="section" id="topics-described-in-this-chapter">
<h3><a class="toc-backref" href="#id43">9.10.1.1. Topics described in this chapter</a><a class="headerlink" href="#topics-described-in-this-chapter" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Example of implementation method to meet the typical security requirements using TERASOLUNA Server Framework for Java (5.x)</li>
<li>Implementation method and source code description using the sample application shown in <a class="reference internal" href="#app-description-sec"><span class="std std-ref">Description of application</span></a></li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<ul class="last simple">
<li>The implementation methods described in this chapter is just an example, and implementation must be carried out in the actual development as per the requirement.</li>
<li>Since it does not guarantee an exhaustive implementation of security measures, additional measures should be considered if necessary</li>
</ul>
</div>
</div>
<div class="section" id="target-readers">
<h3><a class="toc-backref" href="#id44">9.10.1.2. Target Readers</a><a class="headerlink" href="#target-readers" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Must understand the contents of <a class="reference internal" href="../ImplementationAtEachLayer/index.html"><span class="doc">Application Development</span></a></li>
<li>Must understand the contents of <a class="reference internal" href="SpringSecurity.html"><span class="doc">Spring Security Overview</span></a>, <a class="reference internal" href="Authentication.html"><span class="doc">Authentication</span></a>, <a class="reference internal" href="Authorization.html"><span class="doc">Authorization</span></a></li>
<li>Must complete implementation of <a class="reference internal" href="../Tutorial/TutorialSecurity.html"><span class="doc">Spring Security Tutorial</span></a></li>
</ul>
</div>
</div>
<div class="section" id="description-of-application">
<span id="app-description-sec"></span><h2><a class="toc-backref" href="#id45">9.10.2. Description of application</a><a class="headerlink" href="#description-of-application" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line">This section explains about a specific implementation method for security measures by using a sample application that meets the typical security requirements.</div>
<div class="line">The list of security requirements that describe the implementation in this section is shown below. The functions of the sample application used as a base and the specifications for authentication and authorization are also shown below.</div>
<div class="line">Henceforth, this sample application will be referred to as ‘the application’.</div>
</div>
<div class="section" id="security-requirements">
<span id="sec-requirements"></span><h3><a class="toc-backref" href="#id46">9.10.2.1. Security requirements</a><a class="headerlink" href="#security-requirements" title="Permalink to this headline">¶</a></h3>
<p>The list of security requirements fulfilled by the application is shown below. The implementation example is described in <a class="reference internal" href="#implement-description"><span class="std std-ref">Implementation method and code description</span></a> for each classification.</p>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="30%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Classification</th>
<th class="head">Requirement</th>
<th class="head">Overview</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><a class="reference internal" href="#password-change"><span class="std std-ref">Force/Prompt password change</span></a></td>
<td>Force password change when using initial password</td>
<td>Forces password change when authentication is successful using initial password</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>&#160;</td>
<td>Force to change expired password</td>
<td><div class="first last line-block">
<div class="line">Force password change when authentication is successful for the users who have not changed the password for a certain period</div>
<div class="line">In this application, it is intended only for Administrator</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>&#160;</td>
<td>Display message prompting password change</td>
<td>Displays message prompting password change when authentication is successful for the users who have not changed the password for a certain period</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><a class="reference internal" href="#password-strength"><span class="std std-ref">Check password strength</span></a></td>
<td>Specify minimum password length</td>
<td>Specifies the minimum length that can be set for the password</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>&#160;</td>
<td>Specify the type of characters for the password</td>
<td>Specifies the type of characters (uppercase letters, lowercase letters, numbers, symbols) that must be included in the password</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td>&#160;</td>
<td>Prohibit user name from being used as password</td>
<td>Prohibit user name of the account from being used in the password</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td>&#160;</td>
<td>Prohibit reuse of administrator password</td>
<td>Prohibit reusing the password which has been recently used by the administrator</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><a class="reference internal" href="#account-lock"><span class="std std-ref">Account lockout</span></a></td>
<td>Account lockout</td>
<td>If authentication of a certain account has failed for more than a specific number of times within a short period, then that account is set to ‘authentication disabled’ state (lockout state)</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td>&#160;</td>
<td>Specify account lockout duration</td>
<td>Specifies the duration for account lockout state</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td>&#160;</td>
<td>Unlock by administrator</td>
<td>Administrator can unlock any account</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><a class="reference internal" href="#last-login"><span class="std std-ref">Display date and time of last login</span></a></td>
<td>Display date and time of last login</td>
<td>After successful authentication of an account, displays the date and time of last successful authentication of that account on the top screen</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><a class="reference internal" href="#reissue-info-create"><span class="std std-ref">Create authentication information for password reissue</span></a></td>
<td>Assign random string to the password reissue URL</td>
<td>In order to prevent unauthorized access, a string that is difficult to guess is assigned to URL which is used to access the password reissue screen</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(13)</div>
</div>
</td>
<td>&#160;</td>
<td>Issue confidential information for password reissue</td>
<td>Create confidential information in advance (Random string) that is difficult to guess, in order to use for user verification at the time of reissuing password</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(14)</div>
</div>
</td>
<td><a class="reference internal" href="#reissue-info-delivery"><span class="std std-ref">Distribution of authentication information for password reissue</span></a></td>
<td>Send a mail for password reissue screen URL</td>
<td>Send the URL to access the password reissue screen to the registered e-mail address of the account</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(15)</div>
</div>
</td>
<td>&#160;</td>
<td>Separate distribution of the password reissue screen URL and confidential information</td>
<td>Distribute confidential information to the user using a mode other than e-mail as a precaution against leakage of password reissue screen URL</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(16)</div>
</div>
</td>
<td><a class="reference internal" href="#reissue-info-validate"><span class="std std-ref">Verification at the time of executing password reissue</span></a></td>
<td>Set validity period for authentication information for password reissue</td>
<td>Set validity period for password reissue screen URL and confidential information, and disable password reissue screen URL and confidential information if the validity period has expired</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(17)</div>
</div>
</td>
<td><a class="reference internal" href="#reissue-info-invalidate"><span class="std std-ref">Set the maximum limit for password reissue failure</span></a></td>
<td>Set the maximum limit for password reissue failure</td>
<td>Disable password reissue screen URL and confidential information when the authentication fails for a specific number of times at the time of password reissue</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(18)</div>
</div>
</td>
<td><a class="reference internal" href="#secure-input-validation"><span class="std std-ref">Input value check from security viewpoint</span></a></td>
<td>Set commonly prohibited characters for request parameters</td>
<td>Set commonly prohibited characters in overall application, for the string included in the request parameters</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(19)</div>
</div>
</td>
<td>&#160;</td>
<td>Set commonly prohibited string for uploaded file name</td>
<td>Set commonly prohibited string in overall application, for the uploaded file name</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(20)</div>
</div>
</td>
<td>&#160;</td>
<td>Input check for control string</td>
<td>Check whether control character is included in the input value.</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(21)</div>
</div>
</td>
<td>&#160;</td>
<td>Input check for file extension</td>
<td>Check whether extension of the uploaded file is allowed in the application.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(22)</div>
</div>
</td>
<td>&#160;</td>
<td>Input check for file name</td>
<td>Check whether the file name for the uploaded file matches with the pattern authorized in the application</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(23)</div>
</div>
</td>
<td>&#160;</td>
<td>Input check for URL domain</td>
<td>Check whether domain of input URL is authorized by the application.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(24)</div>
</div>
</td>
<td>&#160;</td>
<td>Input check for mail address domain</td>
<td>Check whether domain of input mail address is authorized by the application</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(25)</div>
</div>
</td>
<td><a class="reference internal" href="#audit-logging"><span class="std std-ref">Audit log output</span></a></td>
<td>Audit log output</td>
<td>Output date and time, user name, operation details and operation results for each request in a log</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="functions">
<h3><a class="toc-backref" href="#id47">9.10.2.2. Functions</a><a class="headerlink" href="#functions" title="Permalink to this headline">¶</a></h3>
<p>The application consists of following functions in addition to the application created in <a class="reference internal" href="../Tutorial/TutorialSecurity.html"><span class="doc">Spring Security Tutorial</span></a>.</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="30%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Function name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Create new account function</td>
<td>A function to create new account</td>
</tr>
<tr class="row-odd"><td>Password change function</td>
<td>Function to enable logged-in users to change their account password</td>
</tr>
<tr class="row-even"><td>Account lockout function</td>
<td>Function to set an account that has failed to authenticate more than a specific number of times in a short period to the ‘authentication disabled’ state</td>
</tr>
<tr class="row-odd"><td>Unlock function</td>
<td>Function to return the account which is in the ‘authentication disabled’ state due to the account lockout function, to the ‘authentication enabled’ state again</td>
</tr>
<tr class="row-even"><td>Password reissue function</td>
<td>Function that can set a new password if the user has forgotten the password, after the confirmation with the user</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since this application is a sample of security measures, it is essentially required.
Update function for registration information other than user registration function and password is not created.</p>
</div>
</div>
<div class="section" id="specifications-for-authentication-authorization">
<h3><a class="toc-backref" href="#id48">9.10.2.3. Specifications for authentication/authorization</a><a class="headerlink" href="#specifications-for-authentication-authorization" title="Permalink to this headline">¶</a></h3>
<p>In this application, the specifications for authentication/authorization are shown below respectively.</p>
<div class="section" id="authentication">
<h4><a class="toc-backref" href="#id49">9.10.2.3.1. Authentication</a><a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Initial password to be used for authentication will be issued by the application</li>
</ul>
</div>
<div class="section" id="authorization">
<h4><a class="toc-backref" href="#id50">9.10.2.3.2. Authorization</a><a class="headerlink" href="#authorization" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Authentication is required to access the screens other than login screen, screen used for creating an account and the screen used for password reissue</li>
<li><dl class="first docutils">
<dt>There are two types of roles, “General user” and “Administrator”</dt>
<dd><ul class="first last">
<li>A single account can have multiple roles</li>
</ul>
</dd>
</dl>
</li>
<li>Account unlock function can be used only by the account having administrator rights</li>
</ul>
</div>
<div class="section" id="authentication-at-the-time-of-reissuing-password">
<h4><a class="toc-backref" href="#id51">9.10.2.3.3. Authentication at the time of reissuing password</a><a class="headerlink" href="#authentication-at-the-time-of-reissuing-password" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><dl class="first docutils">
<dt>The following information created by the application is used for the password reissue authentication</dt>
<dd><ul class="first last">
<li>URL for Password reissue screen</li>
<li>Confidential information for authentication</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>URL of the password reissue screen generated by the application is in the following format:</dt>
<dd><ul class="first last">
<li><dl class="first docutils">
<dt>{baseUrl}/reissue/resetpassword?form&amp;token={token}</dt>
<dd><ul class="first last">
<li>{baseUrl} : Base URL of application</li>
<li>{token} : UUID version4 format string（36 characters including hyphen, 128bit）</li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
<li>A time-limit of 30 minutes is provided for the password reissue screen URL and authentication is possible only within the validity period</li>
</ul>
</div>
</div>
<div class="section" id="design-information">
<h3><a class="toc-backref" href="#id52">9.10.2.4. Design information</a><a class="headerlink" href="#design-information" title="Permalink to this headline">¶</a></h3>
<div class="section" id="page-transition">
<h4><a class="toc-backref" href="#id53">9.10.2.4.1. Page transition</a><a class="headerlink" href="#page-transition" title="Permalink to this headline">¶</a></h4>
<p>Screen transition diagram is shown below. Screen transition in case of an error is omitted.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_page_transition.png"><img alt="Page Transition" src="../_images/SecureLogin_page_transition.png" style="width: 80%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="20%" />
<col width="50%" />
<col width="30%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">Sr. No.</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">Screen Name</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">Access control</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Login screen</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create new account screen</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A screen to confirm input for creating new account</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">New account creation complete screen</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A screen to generate authentication information for password reissue</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A screen to complete generation of authentication information for password reissue</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Password reissue screen</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Password reissue complete screen</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Top screen</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authenticated users only</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Account information display screen</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authenticated users only</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Unlock screen</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Administrator only</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Unlock complete screen</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Administrator only</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(13)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Password change screen</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authenticated users only</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(14)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Password change complete screen</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authenticated users only</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="url-list">
<h4><a class="toc-backref" href="#id54">9.10.2.4.2. URL List</a><a class="headerlink" href="#url-list" title="Permalink to this headline">¶</a></h4>
<p>URL list is shown below.</p>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="15%" />
<col width="15%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Process name</th>
<th class="head">HTTP method</th>
<th class="head">URL</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>Display login screen</td>
<td>GET</td>
<td>/login</td>
<td>Display login screen</td>
</tr>
<tr class="row-odd"><td>2</td>
<td>Login</td>
<td>POST</td>
<td>/login</td>
<td>Authenticate using user name and password entered in the screen (performed by Spring Security)</td>
</tr>
<tr class="row-even"><td>3</td>
<td>Logout</td>
<td>POST</td>
<td>/logout</td>
<td>Log out (performed by Spring Security)</td>
</tr>
<tr class="row-odd"><td>4</td>
<td>Display top screen</td>
<td>GET</td>
<td>/</td>
<td>Display top screen</td>
</tr>
<tr class="row-even"><td>5</td>
<td>Display account information</td>
<td>GET</td>
<td>/accounts</td>
<td>Display account information of login user</td>
</tr>
<tr class="row-odd"><td>6</td>
<td>A screen to create new account</td>
<td>GET</td>
<td>/accounts/create?form</td>
<td>Display a screen to create new account</td>
</tr>
<tr class="row-even"><td>7</td>
<td>A screen to confirm input for creating new account</td>
<td>POST</td>
<td>/accounts/create?confirm</td>
<td>Display a screen to confirm input for creating new account</td>
</tr>
<tr class="row-odd"><td>8</td>
<td>Create new account</td>
<td>POST</td>
<td>/accounts/create</td>
<td>Create a new account with input details</td>
</tr>
<tr class="row-even"><td>9</td>
<td>A screen to complete creation of new account</td>
<td>GET</td>
<td>/accounts/create?complete</td>
<td>Display a screen to complete new account creation</td>
</tr>
<tr class="row-odd"><td>10</td>
<td>Display password change screen</td>
<td>GET</td>
<td>/password?form</td>
<td>Display password change screen</td>
</tr>
<tr class="row-even"><td>11</td>
<td>Password change</td>
<td>POST</td>
<td>/password</td>
<td>Change account password by using information input in the password change screen</td>
</tr>
<tr class="row-odd"><td>12</td>
<td>Display password change complete screen</td>
<td>GET</td>
<td>/password?complete</td>
<td>Display password change complete screen</td>
</tr>
<tr class="row-even"><td>13</td>
<td>Display unlock screen</td>
<td>GET</td>
<td>/unlock?form</td>
<td>Display unlock screen</td>
</tr>
<tr class="row-odd"><td>14</td>
<td>Unlock</td>
<td>POST</td>
<td>/unlock</td>
<td>Unlock an account by using information input in unlock screen</td>
</tr>
<tr class="row-even"><td>15</td>
<td>Display unlock complete screen</td>
<td>GET</td>
<td>/unlock?complete</td>
<td>Display unlock complete screen</td>
</tr>
<tr class="row-odd"><td>16</td>
<td>Display a screen to generate authentication information for password reissue</td>
<td>GET</td>
<td>/reissue/create?form</td>
<td>Display a screen to generate authentication information for password reissue</td>
</tr>
<tr class="row-even"><td>17</td>
<td>Generate authentication information for password reissue</td>
<td>POST</td>
<td>/reissue/create</td>
<td>Generate authentication information for password reissue</td>
</tr>
<tr class="row-odd"><td>18</td>
<td>A screen to complete generation of authentication information for password reissue</td>
<td>GET</td>
<td>/reissue/create?complete</td>
<td>Display a screen to complete generation of authentication information for password reissue</td>
</tr>
<tr class="row-even"><td>19</td>
<td>Display password reissue screen</td>
<td>GET</td>
<td>/reissue/resetpassword?form&amp;token={token}</td>
<td>Display user specific password reissue screen by using two request parameters</td>
</tr>
<tr class="row-odd"><td>20</td>
<td>Password reissue</td>
<td>POST</td>
<td>/reissue/resetpassword</td>
<td>Reissue password by using the information input in password reissue screen</td>
</tr>
<tr class="row-even"><td>21</td>
<td>Display password reissue complete screen</td>
<td>GET</td>
<td>/reissue/resetpassword?complete</td>
<td>Display password reissue complete screen</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="er-diagram">
<h4><a class="toc-backref" href="#id55">9.10.2.4.3. ER diagram</a><a class="headerlink" href="#er-diagram" title="Permalink to this headline">¶</a></h4>
<p>ER diagram in this application is shown below.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_ER.png"><img alt="Entity-Relation Diagram" src="../_images/SecureLogin_ER.png" style="width: 80%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="40%" />
<col width="30%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Entity name</th>
<th class="head">Description</th>
<th class="head">Attribute</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Account</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Registered account information of user</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">username : User name</div>
<div class="line">password : Password（Hashed）</div>
<div class="line">firstName : First name</div>
<div class="line">lastName : Last name</div>
<div class="line">email : E-mail address</div>
<div class="line">url : Individual Web site and blog URL</div>
<div class="line">profile : Profile</div>
<div class="line">roles : Role(s)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Account image</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Image registered by the user for the account</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">username : User name for the account corresponding to the account image</div>
<div class="line">body : Binary image file</div>
<div class="line">extension : Extension of image file</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Role</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Rights to be used in authorization</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">roleValue : Identifier of role</div>
<div class="line">roleLabel : Display name of role</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authentication successful event</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Information saved when authentication is successful in order to get the last login date and time of account</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">username : User name</div>
<div class="line">authenticationTimestamp : Date and time when authentication is successful</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authentication failed event</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Information saved when authentication failed to be used by account lockout function</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">username : User name</div>
<div class="line">authenticationTimestamp : Date and time when authentication failed</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Password change history</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Information saved at the time of password change to be used to determine password expiration date</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">username : User name</div>
<div class="line">useFrom : Date and time when changed password is activated</div>
<div class="line">password : Changed password</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authentication information for password reissue</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Information to be used for user verification at the time of password reissue</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">token : String used to make a unique and difficult to guess password reissue screen URL</div>
<div class="line">username : User name</div>
<div class="line">secret : String to be used for user verification</div>
<div class="line">experyDate : Expiry date of authentication information for password reissue</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Password reissue failed event</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Information saved in password reissue failure to restrict the number of attempts for password reissue</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">token : token used when failed to reissue password</div>
<div class="line">attemptDate : Date and time when password reissue was attempted</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>In order to determine initial password and password expiration, a design can also be adopted wherein the information such as last modified date and time of password is provided by adding a field to the account entity.
When implementation is done using this method, it is likely to lead to a situation where a column is added for determining various conditions in account table and entries are frequently updated.</p>
<p class="last">In this application, table is maintained in a simple form. In order to fulfil the requirements by simply using Insert and Delete without unnecessary updates of the entries, a design using event entity such as authentication successful event entity has been adopted.</p>
</div>
</div>
</div>
</div>
<div class="section" id="implementation-method-and-code-description">
<span id="implement-description"></span><h2><a class="toc-backref" href="#id56">9.10.3. Implementation method and code description</a><a class="headerlink" href="#implementation-method-and-code-description" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line">Method of implementation in this application and the code are described for each classification of security requirements.</div>
<div class="line">Only the minimum code required to fulfil the requirements for each classification is described here. Refer to <a class="reference external" href="https://github.com/terasolunaorg/tutorial-apps/tree/release/5.4.1.RELEASE/secure-login-demo">GitHub</a> for the complete code.</div>
<div class="line">SQL for initial data registration to run this application is placed <a class="reference external" href="https://github.com/terasolunaorg/tutorial-apps/tree/release/5.4.1.RELEASE/secure-login-demo/secure-login-demo/secure-login-env/src/main/resources/database">here</a>.</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In this application, Lombok is used to eliminate boilerplate code. For Lombok, refer <a class="reference internal" href="../Appendix/Lombok.html"><span class="doc">Reducing Boilerplate Code (Lombok)</span></a>.</p>
</div>
<div class="section" id="force-prompt-password-change">
<span id="password-change"></span><h3><a class="toc-backref" href="#id57">9.10.3.1. Force/Prompt password change</a><a class="headerlink" href="#force-prompt-password-change" title="Permalink to this headline">¶</a></h3>
<div class="section" id="list-of-requirements-to-be-implemented">
<h4><a class="toc-backref" href="#id58">9.10.3.1.1. List of requirements to be implemented</a><a class="headerlink" href="#list-of-requirements-to-be-implemented" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference internal" href="#sec-requirements"><span class="std std-ref">Force password change when initial password is used</span></a></li>
<li><a class="reference internal" href="#sec-requirements"><span class="std std-ref">Force to change expired administrator password</span></a></li>
<li><a class="reference internal" href="#sec-requirements"><span class="std std-ref">Display message prompting password change</span></a></li>
</ul>
</div>
<div class="section" id="working-image">
<h4><a class="toc-backref" href="#id59">9.10.3.1.2. Working image</a><a class="headerlink" href="#working-image" title="Permalink to this headline">¶</a></h4>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_change_password.png"><img alt="Change Password" src="../_images/SecureLogin_change_password.png" style="width: 80%;" /></a>
</div>
</div>
<div class="section" id="implementation-method">
<h4><a class="toc-backref" href="#id60">9.10.3.1.3. Implementation method</a><a class="headerlink" href="#implementation-method" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">In this application, the history when password is changed is stored as “Password change history” entity in the database. Using this password change history entity, the initial password and password expiration are determined.</div>
<div class="line">Note that, redirecting to the password change screen and displaying message on the screen are controlled based on the determination result.</div>
<div class="line">In particular, requirements are fulfilled by implementing and using the following process.</div>
</div>
<ul>
<li><p class="first">Saving password change history entity</p>
<p>When the password is changed, register password change history entity containing following information to the database.</p>
<ul class="simple">
<li>User name of the account for which password is changed</li>
<li>Date and time when changed password is activated</li>
</ul>
</li>
<li><p class="first">Determining initial password and password expiration</p>
<div class="line-block">
<div class="line">After authentication, search the password change history entity of the authenticated account from the database. If even a single record is not found, consider that initial password is being used.</div>
<div class="line">Otherwise, get the latest password change history entity, calculate the difference between current date and time, and date and time when the password is activated and determine whether the password has expired.</div>
</div>
</li>
<li><p class="first">Forcible redirect to password change screen</p>
<p>To force password change, the user is redirected to the password change screen in case a request is raised for a screen other than password change screen, when the conditions below are met.</p>
<ul class="simple">
<li>When initial password is used by an authenticated user</li>
<li>When authenticated user is administrator and password has expired</li>
</ul>
<p>Using <code class="docutils literal"><span class="pre">org.springframework.web.servlet.handler.HandlerInterceptor</span></code> , determine whether the above conditions are met before executing handler method of Controller.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">There are other methods to redirect to the password change screen after authentication, however, depending on the method, it is likely that user gets access to a screen different from that of a password change screen by clicking the URL directly after redirecting.
In the method that uses <code class="docutils literal"><span class="pre">HandlerInterceptor</span></code> , it cannot be avoided by a method wherein URL is directly clicked since the process is executed before executing handler method.</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Servlet Filter can also be used instead of <code class="docutils literal"><span class="pre">HandlerInterceptor</span></code> . For both the descriptions, refer to <a class="reference internal" href="../ImplementationAtEachLayer/ApplicationLayer.html#controller-common-process"><span class="std std-ref">Implementing common logic to be executed before and after calling controller</span></a>.
Here, <code class="docutils literal"><span class="pre">HandlerInterceptor</span></code>  is used to perform processing for only the requests allowed by the application.</p>
</div>
</li>
<li><p class="first">Display message prompting password change</p>
<p>Call the password expiration determination process described previously in the Controller. Pass the determination result to View, and switch show/hide message in View.</p>
</li>
</ul>
</div>
<div class="section" id="code-description">
<h4><a class="toc-backref" href="#id61">9.10.3.1.4. Code description</a><a class="headerlink" href="#code-description" title="Permalink to this headline">¶</a></h4>
<p>The code implemented according to the implementation method mentioned above is described sequentially.</p>
<ul>
<li><p class="first">Saving password change history entity</p>
<p>A series of implementations to register password change history entity in the database at the time of changing the password is shown below.</p>
<ul>
<li><p class="first">Implementation of Entity</p>
<p>Implementation of password change history entity is as below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.model</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordHistory</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span> <span class="c1">// (2)</span>

    <span class="kd">private</span> <span class="n">DateTime</span> <span class="n">useFrom</span><span class="o">;</span> <span class="c1">// (3)</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">User name of the account for which the password is changed</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Password after change</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Date and time of when changed password is activated</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Implementation of Repository</p>
<p>The Repository to register and search password change history entity to the database is shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.repository.passwordhistory</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PasswordHistoryRepository</span> <span class="o">{</span>

    <span class="kt">int</span> <span class="nf">create</span><span class="o">(</span><span class="n">PasswordHistory</span> <span class="n">history</span><span class="o">);</span> <span class="c1">// (1)</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">PasswordHistory</span><span class="o">&gt;</span> <span class="nf">findByUseFrom</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;username&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">username</span><span class="o">,</span>
            <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;useFrom&quot;</span><span class="o">)</span> <span class="n">LocalDateTime</span> <span class="n">useFrom</span><span class="o">);</span> <span class="c1">// (2)</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">PasswordHistory</span><span class="o">&gt;</span> <span class="nf">findLatest</span><span class="o">(</span>
            <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;username&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;limit&quot;</span><span class="o">)</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">);</span> <span class="c1">// (3)</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method to register <code class="docutils literal"><span class="pre">PasswordHistory</span></code>  object that has been assigned as an argument, as a record in the database</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method to get <code class="docutils literal"><span class="pre">PasswordHistory</span></code>  object newer than the date specifying the date and time when the password is activated, in descending order (new order) by considering user name that has been assigned as an argument, as the key</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method to get specified number of <code class="docutils literal"><span class="pre">PasswordHistory</span></code>  objects in new order by considering user name that has been assigned as an argument, as the key</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Mapping file is as described below.</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>

<span class="nt">&lt;mapper</span>
    <span class="na">namespace=</span><span class="s">&quot;org.terasoluna.securelogin.domain.repository.passwordhistory.PasswordHistoryRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;PasswordHistoryResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;PasswordHistory&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;username&quot;</span> <span class="na">column=</span><span class="s">&quot;username&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;password&quot;</span> <span class="na">column=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;useFrom&quot;</span> <span class="na">column=</span><span class="s">&quot;use_from&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/resultMap&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findByUseFrom&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;PasswordHistoryResultMap&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;![CDATA[</span>
<span class="cp">        SELECT</span>
<span class="cp">            username,</span>
<span class="cp">            password,</span>
<span class="cp">            use_from</span>
<span class="cp">        FROM</span>
<span class="cp">            password_history</span>
<span class="cp">        WHERE</span>
<span class="cp">            username = #{username} AND</span>
<span class="cp">            use_from &gt;= #{useFrom}</span>
<span class="cp">        ORDER BY use_from DESC</span>
<span class="cp">    ]]&gt;</span>
    <span class="nt">&lt;/select&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findLatest&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;PasswordHistoryResultMap&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;![CDATA[</span>
<span class="cp">        SELECT</span>
<span class="cp">            username,</span>
<span class="cp">            password,</span>
<span class="cp">            use_from</span>
<span class="cp">        FROM</span>
<span class="cp">            password_history</span>
<span class="cp">        WHERE</span>
<span class="cp">            username = #{username}</span>
<span class="cp">        ORDER BY use_from DESC</span>
<span class="cp">        LIMIT #{limit}</span>
<span class="cp">    ]]&gt;</span>
    <span class="nt">&lt;/select&gt;</span>

    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;create&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;PasswordHistory&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;![CDATA[</span>
<span class="cp">        INSERT INTO password_history (</span>
<span class="cp">            username,</span>
<span class="cp">            password,</span>
<span class="cp">            use_from</span>
<span class="cp">        ) VALUES (</span>
<span class="cp">            #{username},</span>
<span class="cp">            #{password},</span>
<span class="cp">            #{useFrom}</span>
<span class="cp">        )</span>
<span class="cp">    ]]&gt;</span>
    <span class="nt">&lt;/insert&gt;</span>
<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first">Service implementation</p>
<p>Password change history entity operations are also used in <a class="reference internal" href="#password-strength"><span class="std std-ref">Check password strength</span></a>.
Therefore, call the Repository method from SharedService as shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.passwordhistory</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordHistorySharedServiceImpl</span> <span class="kd">implements</span>
        <span class="n">PasswordHistorySharedService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordHistoryRepository</span> <span class="n">passwordHistoryRepository</span><span class="o">;</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="n">Propagation</span><span class="o">.</span><span class="na">REQUIRES_NEW</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">insert</span><span class="o">(</span><span class="n">PasswordHistory</span> <span class="n">history</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">passwordHistoryRepository</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">history</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">PasswordHistory</span><span class="o">&gt;</span> <span class="nf">findHistoriesByUseFrom</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span>
            <span class="n">LocalDateTime</span> <span class="n">useFrom</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">passwordHistoryRepository</span><span class="o">.</span><span class="na">findByUseFrom</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">useFrom</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">PasswordHistory</span><span class="o">&gt;</span> <span class="nf">findLatest</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">passwordHistoryRepository</span><span class="o">.</span><span class="na">findLatest</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">limit</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<p>Implementation of the process to save password change history entity in the database at the time of changing the password is shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.account</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountSharedServiceImpl</span> <span class="kd">implements</span> <span class="n">AccountSharedService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ClassicDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordHistorySharedService</span> <span class="n">passwordHistorySharedService</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">AccountRepository</span> <span class="n">accountRepository</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">updatePassword</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">rawPassword</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (1)</span>
        <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">passwordEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">rawPassword</span><span class="o">);</span>
        <span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="n">accountRepository</span><span class="o">.</span><span class="na">updatePassword</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span> <span class="c1">// (2)</span>

        <span class="n">LocalDateTime</span> <span class="n">passwordChangeDate</span> <span class="o">=</span> <span class="n">dateFactory</span><span class="o">.</span><span class="na">newTimestamp</span><span class="o">().</span><span class="na">toLocalDateTime</span><span class="o">();</span>

        <span class="n">PasswordHistory</span> <span class="n">passwordHistory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PasswordHistory</span><span class="o">();</span> <span class="c1">// (3)</span>
        <span class="n">passwordHistory</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
        <span class="n">passwordHistory</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="n">password</span><span class="o">);</span>
        <span class="n">passwordHistory</span><span class="o">.</span><span class="na">setUseFrom</span><span class="o">(</span><span class="n">passwordChangeDate</span><span class="o">);</span>
        <span class="n">passwordHistorySharedService</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">passwordHistory</span><span class="o">);</span> <span class="c1">// (4)</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A Method which is called while changing the password</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call the process to update the password in the database.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create password change history entity and set user name, changed password, and date and time when changed password is activated.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call the process to register the created password change history entity in the database.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</li>
<li><p class="first">Determining initial password and password expiration</p>
<p>Using the password change history entity registered in the database, implementation of the process to determine whether initial password is used and whether the password has expired is shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.account</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountSharedServiceImpl</span> <span class="kd">implements</span> <span class="n">AccountSharedService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ClassicDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordHistorySharedService</span> <span class="n">passwordHistorySharedService</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${security.passwordLifeTimeSeconds}&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="kt">int</span> <span class="n">passwordLifeTimeSeconds</span><span class="o">;</span>

    <span class="c1">// omitted</span>

   <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
   <span class="nd">@Override</span>
   <span class="nd">@Cacheable</span><span class="o">(</span><span class="s">&quot;isInitialPassword&quot;</span><span class="o">)</span>
   <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isInitialPassword</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (2)</span>
       <span class="n">List</span><span class="o">&lt;</span><span class="n">PasswordHistory</span><span class="o">&gt;</span> <span class="n">passwordHistories</span> <span class="o">=</span> <span class="n">passwordHistorySharedService</span>
               <span class="o">.</span><span class="na">findLatest</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span> <span class="c1">// (3)</span>
       <span class="k">return</span> <span class="n">passwordHistories</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">();</span> <span class="c1">// (4)</span>
   <span class="o">}</span>

   <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
   <span class="nd">@Override</span>
   <span class="nd">@Cacheable</span><span class="o">(</span><span class="s">&quot;isCurrentPasswordExpired&quot;</span><span class="o">)</span>
   <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isCurrentPasswordExpired</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (5)</span>
       <span class="n">List</span><span class="o">&lt;</span><span class="n">PasswordHistory</span><span class="o">&gt;</span> <span class="n">passwordHistories</span> <span class="o">=</span> <span class="n">passwordHistorySharedService</span>
               <span class="o">.</span><span class="na">findLatest</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span> <span class="c1">// (6)</span>

       <span class="k">if</span> <span class="o">(</span><span class="n">passwordHistories</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// (7)</span>
           <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
       <span class="o">}</span>

       <span class="k">if</span> <span class="o">(</span><span class="n">passwordHistories</span>
               <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
               <span class="o">.</span><span class="na">getUseFrom</span><span class="o">()</span>
               <span class="o">.</span><span class="na">isBefore</span><span class="o">(</span>
                       <span class="n">dateFactory</span><span class="o">.</span><span class="na">newTimestamp</span><span class="o">().</span><span class="na">toLocalDateTime</span><span class="o">()</span>
                               <span class="o">.</span><span class="na">minusSeconds</span><span class="o">(</span><span class="n">passwordLifeTimeSeconds</span><span class="o">)))</span> <span class="o">{</span> <span class="c1">// (8)</span>
           <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
       <span class="o">}</span>

       <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
   <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch the length of the time period (in seconds) for which password is valid, from the property file and set.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method which determines whether initial password is used, and returns true if it is used, or else returns false.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call the process to fetch single record of the latest password change history entity from the database.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">If password change history entity cannot be fetched from the database, determine that initial password is being used and return true. Otherwise, return false.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method which determines whether the password currently being used has expired and returns true if it has expired, or else returns false.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call the process to fetch single record of the latest password change history entity from the database.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">If password change history entity cannot be fetched from the database, determine that the password has expired and return true.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">If difference between the current date and time, and the date and time when the password fetched from the password change history entity is activated, is greater than the password validity period set in (1), determine that the password has expired and return true.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">If any of the conditions of (7), (8) is not met, determine that the password is within the validity period and return false.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><code class="docutils literal"><span class="pre">&#64;</span> <span class="pre">Cacheable</span></code>  assigned to isInitialPassword and isCurrentPasswordExpired is an annotation to use the Spring Cache Abstraction function.
The result for method arguments can be cached by assigning <code class="docutils literal"><span class="pre">&#64;Cacheable</span></code>  annotation.
Access to database during each initial password and password expiration determination is prevented by the use of the cache thereby preventing performance degradation.
Refer to <a class="reference external" href="http://docs.spring.io/spring/docs/4.3.14.RELEASE/spring-framework-reference/html/cache.html">Official document</a> for Cache Abstraction.</p>
<p>Further, while using cache, it should be noted that it is necessary to clear the cache as and when needed.
In this application, at the time of changing the password or during logout, clear the cache to determine password expiration and determine initial password again.</p>
<p class="last">Further, set cache TTL (Time to Live) as needed. Note that TTL is not set depending on the implementation of the cache to be used.</p>
</div>
</li>
<li><p class="first">Forcible redirect to password change screen</p>
<p>In order to enforce password change, the implementation of the process to be redirected to the password change screen is shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.common.interceptor</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordExpirationCheckInterceptor</span> <span class="kd">extends</span>
        <span class="n">HandlerInterceptorAdapter</span> <span class="o">{</span> <span class="c1">// (1)</span>

    <span class="nd">@Inject</span>
    <span class="n">AccountSharedService</span> <span class="n">accountSharedService</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">preHandle</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span>
            <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">Object</span> <span class="n">handler</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span> <span class="c1">// (2)</span>
        <span class="n">Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="o">(</span><span class="n">Authentication</span><span class="o">)</span> <span class="n">request</span>
                <span class="o">.</span><span class="na">getUserPrincipal</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">authentication</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Object</span> <span class="n">principal</span> <span class="o">=</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">principal</span> <span class="k">instanceof</span> <span class="n">UserDetails</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (3)</span>
                <span class="n">LoggedInUser</span> <span class="n">userDetails</span> <span class="o">=</span> <span class="o">(</span><span class="n">LoggedInUser</span><span class="o">)</span> <span class="n">principal</span><span class="o">;</span> <span class="c1">// (4)</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">userDetails</span><span class="o">.</span><span class="na">getAccount</span><span class="o">().</span><span class="na">getRoles</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="n">Role</span><span class="o">.</span><span class="na">ADMIN</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">accountSharedService</span>
                        <span class="o">.</span><span class="na">isCurrentPasswordExpired</span><span class="o">(</span><span class="n">userDetails</span><span class="o">.</span><span class="na">getUsername</span><span class="o">()))</span> <span class="c1">// (5)</span>
                        <span class="o">||</span> <span class="n">accountSharedService</span><span class="o">.</span><span class="na">isInitialPassword</span><span class="o">(</span><span class="n">userDetails</span>
                                <span class="o">.</span><span class="na">getUsername</span><span class="o">()))</span> <span class="o">{</span> <span class="c1">// (6)</span>
                    <span class="n">response</span><span class="o">.</span><span class="na">sendRedirect</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getContextPath</span><span class="o">()</span>
                            <span class="o">+</span> <span class="s">&quot;/password?form&quot;</span><span class="o">);</span> <span class="c1">// (7)</span>
                    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// (8)</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inherit <code class="docutils literal"><span class="pre">org.springframework.web.servlet.handler.HandlerInterceptorAdapter</span></code>  to include the process before the execution of handler method of Controller.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method executed before the execution of handler method of Controller</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Check whether the fetched user information is an object of <code class="docutils literal"><span class="pre">org.springframework.security.core.userdetails.UserDetails</span></code> .</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch <code class="docutils literal"><span class="pre">UserDetails</span></code>  object . In this application, a class called <code class="docutils literal"><span class="pre">LoggedInUser</span></code>  is created and used as the implementation of <code class="docutils literal"><span class="pre">UserDetails</span></code> .</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Determine whether the user is an administrator by fetching the role from <code class="docutils literal"><span class="pre">UserDetails</span></code>  object. Then, call the process to determine whether the password has expired. Perform logical AND (And) of these two results.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call the process to determine whether initial password is being used.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">If either (5) or (6) is true, redirect to the password change screen using <code class="docutils literal"><span class="pre">sendRedirect</span></code>  method of <code class="docutils literal"><span class="pre">javax.servlet.http.HttpServletResponse</span></code> .</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Return false to prevent handler method of Controller being executed continuously.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>The settings to enable the redirect process described above are as described below.</p>
<p><strong>spring-mvc.xml</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;mvc:interceptors&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;mvc:interceptor&gt;</span>
        <span class="nt">&lt;mvc:mapping</span> <span class="na">path=</span><span class="s">&quot;/**&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/password/**&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/reissue/**&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
        <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/resources/**&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/**/*.html&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;bean</span>
            <span class="na">class=</span><span class="s">&quot;org.terasoluna.securelogin.app.common.interceptor.PasswordExpirationCheckInterceptor&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
    <span class="nt">&lt;/mvc:interceptor&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;/mvc:interceptors&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use <code class="docutils literal"><span class="pre">HandlerInterceptor</span></code>  to access all the paths under “/”.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Exclude the paths under “/password” to prevent redirecting from password change screen to password change screen.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Exclude the paths under “/reissue” since it is not necessary to check password expiration at the time of reissuing password.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the class of <code class="docutils literal"><span class="pre">HandlerInterceptor</span></code> .</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Display message prompting password change</p>
<p>Implementation of Controller to display message prompting password change on top screen is shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.welcome</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HomeController</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">AccountSharedService</span> <span class="n">accountSharedService</span><span class="o">;</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="o">{</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span>
            <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span> <span class="o">})</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">home</span><span class="o">(</span><span class="nd">@AuthenticationPrincipal</span> <span class="n">LoggedInUser</span> <span class="n">userDetails</span><span class="o">,</span> <span class="c1">// (1)</span>
            <span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">userDetails</span><span class="o">.</span><span class="na">getAccount</span><span class="o">();</span> <span class="c1">// (2)</span>

        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;account&quot;</span><span class="o">,</span> <span class="n">account</span><span class="o">);</span>

        <span class="k">if</span><span class="o">(</span><span class="n">accountSharedService</span><span class="o">.</span><span class="na">isCurrentPasswordExpired</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">getUsername</span><span class="o">())){</span> <span class="c1">// (3)</span>
            <span class="n">ResultMessages</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="o">.</span><span class="na">warning</span><span class="o">().</span><span class="na">add</span><span class="o">(</span>
                    <span class="s">&quot;w.sl.pe.0001&quot;</span><span class="o">);</span>
            <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">messages</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// omitted</span>

        <span class="k">return</span> <span class="s">&quot;welcome/home&quot;</span><span class="o">;</span>

    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch object of <code class="docutils literal"><span class="pre">LoggedInUser</span></code>  for which <code class="docutils literal"><span class="pre">UserDetails</span></code>  is implemented by specifying <code class="docutils literal"><span class="pre">AuthenticationPrincipal</span></code>  annotation.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch account information retained by <code class="docutils literal"><span class="pre">LoggedInUser</span></code> .</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call the password expiration determination process by using the user name obtained from account information as an argument. If the result is true, fetch the message from the property file, set it in Model and pass it to View.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Implementation of View is as follows:</p>
<p><strong>Top screen(home.jsp)</strong></p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;body&gt;</span>
   <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
       <span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">&quot;expiredMessage&quot;</span><span class="nt">&gt;</span>
           <span class="nt">&lt;t:messagesPanel</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
       <span class="nt">&lt;/span&gt;</span>

       <span class="c">&lt;!-- omitted --&gt;</span>

   <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Using messagesPanel tag, display the password expiration message passed from the Controller.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
</div>
<div class="section" id="check-password-strength">
<span id="password-strength"></span><h3><a class="toc-backref" href="#id62">9.10.3.2. Check password strength</a><a class="headerlink" href="#check-password-strength" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id1">
<h4><a class="toc-backref" href="#id63">9.10.3.2.1. List of requirements to be implemented</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference internal" href="#sec-requirements"><span class="std std-ref">Specify minimum number of characters for password</span></a></li>
<li><a class="reference internal" href="#sec-requirements"><span class="std std-ref">Specify character type for password</span></a></li>
<li><a class="reference internal" href="#sec-requirements"><span class="std std-ref">Prohibit password containing user name</span></a></li>
<li><a class="reference internal" href="#sec-requirements"><span class="std std-ref">Prohibit reuse of administrator password</span></a></li>
</ul>
</div>
<div class="section" id="id2">
<h4><a class="toc-backref" href="#id64">9.10.3.2.2. Working image</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_password_validation.png"><img alt="Password Validation" src="../_images/SecureLogin_password_validation.png" style="width: 80%;" /></a>
</div>
</div>
<div class="section" id="id3">
<h4><a class="toc-backref" href="#id65">9.10.3.2.3. Implementation method</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><a class="reference internal" href="../ArchitectureInDetail/WebApplicationDetail/Validation.html"><span class="doc">Input Validation</span></a> function can be used to verify the strength of the password specified by the user at the time of password change. In this application, the strength of the password is verified by using Bean Validation.</div>
<div class="line">Requirements for password strength are wide-ranging and differ depending on the application.</div>
<div class="line">Use <a class="reference external" href="http://www.passay.org/">Passay</a> as the library for password validation and create the required Bean Validation annotation.</div>
<div class="line">Many functions that are commonly used in password validation have been provided in Passay. The functions that have not been provided can also be easily implemented by extending the standard functions.</div>
<div class="line">Refer to <a class="reference internal" href="#passay-overview"><span class="std std-ref">Appendix</span></a> for the overview of Passay.</div>
<div class="line">In particular, describe the following settings and process and fulfil the requirements using them.</div>
</div>
<ul>
<li><p class="first">Creating validation rules for Passay</p>
<p>Create the following validation rules to be used to fulfil the requirements.</p>
<blockquote>
<div><ul class="simple">
<li>Validation rule wherein minimum password length is set</li>
<li>Validation rule wherein the character type that must be included in the password is set</li>
<li>Validation rule to check that the password does not contain user name</li>
<li>Validation rule to check that same password has not been used recently</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Creating Passay validator</p>
<p>Create Passay validator wherein validation rules created above, are set.</p>
</li>
<li><p class="first">Creating Bean Validation annotation</p>
<p>Create an annotation for password validation using Passay validator.
All the validation rules can also be verified by one annotation, however, verifying various rules leads to complex process and reduced visibility. To avoid this, it should be implemented by dividing into two as shown below.</p>
<blockquote>
<div><ul>
<li><p class="first">Annotation to validate the characteristics of the password</p>
<p>Check the three validation rules, “Password is longer than the minimum string length”, “Password includes characters of the specified character type”, and “Password does not contain user name”</p>
</li>
<li><p class="first">Annotation to compare with previous password</p>
<p>Check that the recently used password is not reused by the administrator in recent period of time.</p>
</li>
</ul>
</div></blockquote>
<p>Any annotation is a correlation input check rule using user name and new password.
When a violation occurs in either of the inputs of both the rules, respective error message is displayed.</p>
</li>
<li><p class="first">Password validation</p>
<p>Perform password validation using the created Bean Validation annotation.</p>
</li>
</ul>
</div>
<div class="section" id="id4">
<h4><a class="toc-backref" href="#id66">9.10.3.2.4. Code description</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p>The code implemented according to the implementation method mentioned above is described sequentially. Password validation using Passay is described in <a class="reference internal" href="#password-validation"><span class="std std-ref">Password validation</span></a>.</p>
<ul>
<li><p class="first">Creating validation rules for Passay</p>
<div class="line-block">
<div class="line">Most of the verification rules used in this application can be defined by using the class provided in Passay by default.</div>
<div class="line">However, in the class provided by Passay, validation rule to compare with the hashed previous password cannot be defined in <code class="docutils literal"><span class="pre">org.springframework.security.crypto.password.PasswordEncoder</span></code> .</div>
<div class="line">Therefore, it is necessary to create a class with individual validation rules by extending the class provided by Passay as shown below.</div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.common.validation.rule</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EncodedPasswordHistoryRule</span> <span class="kd">extends</span> <span class="n">HistoryRule</span> <span class="o">{</span> <span class="c1">// (1)</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">;</span> <span class="c1">// (2)</span>

    <span class="kd">public</span> <span class="nf">EncodedPasswordHistoryRule</span><span class="o">(</span><span class="n">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">passwordEncoder</span> <span class="o">=</span> <span class="n">passwordEncoder</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">matches</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">rawPassword</span><span class="o">,</span>
            <span class="kd">final</span> <span class="n">PasswordData</span><span class="o">.</span><span class="na">Reference</span> <span class="n">reference</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (3)</span>
        <span class="k">return</span> <span class="n">passwordEncoder</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">rawPassword</span><span class="o">,</span> <span class="n">reference</span><span class="o">.</span><span class="na">getPassword</span><span class="o">());</span> <span class="c1">// (4)</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Extend <code class="docutils literal"><span class="pre">org.passay.HistoryRule</span></code>  to check that password is not a recently used password.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inject <code class="docutils literal"><span class="pre">PasswordEncoder</span></code>  used for password hashing.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Override the method to compare with previous password.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Compare with hashed password using <code class="docutils literal"><span class="pre">matches</span></code>  method of <code class="docutils literal"><span class="pre">PasswordEncoder</span></code> .</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Define a Bean for validation rules of Passay as shown below.</p>
<p><strong>applicationContext.xml</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;lengthRule&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.LengthRule&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;minimumLength&quot;</span> <span class="na">value=</span><span class="s">&quot;${security.passwordMinimumLength}&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;upperCaseRule&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.CharacterRule&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;data&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:constant</span> <span class="na">static-field=</span><span class="s">&quot;org.passay.EnglishCharacterData.UpperCase&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;num&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;lowerCaseRule&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.CharacterRule&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;data&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:constant</span> <span class="na">static-field=</span><span class="s">&quot;org.passay.EnglishCharacterData.LowerCase&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;num&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;digitRule&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.CharacterRule&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;data&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:constant</span> <span class="na">static-field=</span><span class="s">&quot;org.passay.EnglishCharacterData.Digit&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;num&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;specialCharacterRule&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.CharacterRule&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (5) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;data&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:constant</span> <span class="na">static-field=</span><span class="s">&quot;org.passay.EnglishCharacterData.Special&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;num&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;characterCharacteristicsRule&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.CharacterCharacteristicsRule&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (6) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;rules&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;list&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;upperCaseRule&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;lowerCaseRule&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;digitRule&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;specialCharacterRule&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;numberOfCharacteristics&quot;</span> <span class="na">value=</span><span class="s">&quot;3&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;usernameRule&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.UsernameRule&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (7) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;encodedPasswordHistoryRule&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.terasoluna.securelogin.app.common.validation.rule.EncodedPasswordHistoryRule&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (8) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;passwordEncoder&quot;</span> <span class="na">ref=</span><span class="s">&quot;passwordEncoder&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In <code class="docutils literal"><span class="pre">org.passay.LengthRule</span></code>  property to check the password length, set the minimum length of the password fetched from the property file.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A validation rule to check that one or more single-byte upper-case letters are included. Set <code class="docutils literal"><span class="pre">org.passay.EnglishCharacterData.UpperCase</span></code>  and numerical value 1 in <code class="docutils literal"><span class="pre">org.passay.CharacterRule</span></code>  constructor to check the character type included in the password.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A validation rule to check that one or more single-byte lower-case letters are included. Set <code class="docutils literal"><span class="pre">org.passay.EnglishCharacterData.LowerCase</span></code>  and numerical value 1 in <code class="docutils literal"><span class="pre">org.passay.CharacterRule</span></code>  constructor to check the character type included in the password.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A validation rule to check that one or more single-byte digits are included. Set <code class="docutils literal"><span class="pre">org.passay.EnglishCharacterData.Digit</span></code>  and numerical value 1 in <code class="docutils literal"><span class="pre">org.passay.CharacterRule</span></code>  constructor to check for the character type included in the password.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A validation rule to check that one or more single-byte symbols are included. Set <code class="docutils literal"><span class="pre">org.passay.EnglishCharacterData.Special</span></code>  and numerical value 1 in <code class="docutils literal"><span class="pre">org.passay.CharacterRule</span></code>  constructor to check for the character type included in the password.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A validation rule to check that 3 out of the 4 validation rules from (2)-(5) are met. Set Bean list defined in (2)-(5) and numerical value 3 in <code class="docutils literal"><span class="pre">org.passay.CharacterCharacteristicsRule</span></code>  property.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A validation rule to check that password does not contain user name</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A validation rule to check that the password is not included in the passwords used in the past</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Creating Passay validator</p>
<p>Using validation rules of Passay described above, Bean definition for validator to perform actual validation is shown below.</p>
<p><strong>applicationContext.xml</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;characteristicPasswordValidator&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.PasswordValidator&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;rules&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;list&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;lengthRule&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;characterCharacteristicsRule&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;usernameRule&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;encodedPasswordHistoryValidator&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.PasswordValidator&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;rules&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;list&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;encodedPasswordHistoryRule&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A validator to validate the characteristics of the password. Set a Bean for <code class="docutils literal"><span class="pre">LengthRule</span></code> , <code class="docutils literal"><span class="pre">CharacterCharacteristicsRule</span></code> , <code class="docutils literal"><span class="pre">UsernameRule</span></code>  as a property.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A validator to check the history of the passwords that were used in the past. Set a Bean for <code class="docutils literal"><span class="pre">EncodedPasswordHistoryRule</span></code>  as a property.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Creating Bean Validation annotation</p>
<p>To fulfil the requirements, create two annotations that use the validator described above.</p>
<ul>
<li><p class="first">Annotation to validate the characteristics of the password</p>
<p>The implementation of the annotation to check three validation rules - ‘password should be longer than the minimum string length, it should contain characters of specified character type and it should not contain user name’ is shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.common.validation</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{</span> <span class="n">StrongPasswordValidator</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span> <span class="c1">// (1)</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">TYPE</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">StrongPassword</span> <span class="o">{</span>
    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{org.terasoluna.securelogin.app.common.validation.StrongPassword.message}&quot;</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">String</span> <span class="nf">usernamePropertyName</span><span class="o">();</span> <span class="c1">// (2)</span>

    <span class="n">String</span> <span class="nf">newPasswordPropertyName</span><span class="o">();</span> <span class="c1">// (3)</span>

    <span class="nd">@Target</span><span class="o">({</span> <span class="n">TYPE</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">StrongPassword</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="nf">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify <code class="docutils literal"><span class="pre">ConstraintValidator</span></code>  to be used at the time of assigning annotation.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A property to specify property name of the user name.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A property to specify property name for the password.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.common.validation</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StrongPasswordValidator</span> <span class="kd">implements</span>
        <span class="n">ConstraintValidator</span><span class="o">&lt;</span><span class="n">StrongPassword</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="o">(</span><span class="s">&quot;characteristicPasswordValidator&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="n">PasswordValidator</span> <span class="n">characteristicPasswordValidator</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">usernamePropertyName</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">newPasswordPropertyName</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">StrongPassword</span> <span class="n">constraintAnnotation</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">usernamePropertyName</span> <span class="o">=</span> <span class="n">constraintAnnotation</span><span class="o">.</span><span class="na">usernamePropertyName</span><span class="o">();</span>
        <span class="n">newPasswordPropertyName</span> <span class="o">=</span> <span class="n">constraintAnnotation</span><span class="o">.</span><span class="na">newPasswordPropertyName</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isValid</span><span class="o">(</span><span class="n">Object</span> <span class="n">value</span><span class="o">,</span> <span class="n">ConstraintValidatorContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">BeanWrapper</span> <span class="n">beanWrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BeanWrapperImpl</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">beanWrapper</span><span class="o">.</span><span class="na">getPropertyValue</span><span class="o">(</span><span class="n">usernamePropertyName</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">newPassword</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">beanWrapper</span>
                <span class="o">.</span><span class="na">getPropertyValue</span><span class="o">(</span><span class="n">newPasswordPropertyName</span><span class="o">);</span>

        <span class="n">RuleResult</span> <span class="n">result</span> <span class="o">=</span> <span class="n">characteristicPasswordValidator</span>
                <span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">PasswordData</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">newPassword</span><span class="o">,</span> <span class="n">username</span><span class="o">,</span> <span class="kc">null</span><span class="o">));</span> <span class="c1">// (2)</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">isValid</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// (3)</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">context</span><span class="o">.</span><span class="na">disableDefaultConstraintViolation</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">message</span> <span class="o">:</span> <span class="n">characteristicPasswordValidator</span>
                    <span class="o">.</span><span class="na">getMessages</span><span class="o">(</span><span class="n">result</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// (4)</span>
                <span class="n">context</span><span class="o">.</span><span class="na">buildConstraintViolationWithTemplate</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">addPropertyNode</span><span class="o">(</span><span class="n">newPasswordPropertyName</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">addConstraintViolation</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inject validator of Passay.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create an instance of <code class="docutils literal"><span class="pre">org.passay.PasswordData</span></code> wherein password and user name are specified and perform validation by the validator.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Confirm the check result, if it is OK, return true, else return false.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch and set all the password validation error messages.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Annotation to compare with password used in the past</p>
<div class="line-block">
<div class="line">Implementation of the annotation to check that the administrator does not reuse the password used earlier within a short period of time, is shown below.</div>
<div class="line">Password change history entity is used to get the password used in the past. Refer to <a class="reference internal" href="#password-change"><span class="std std-ref">Force/Prompt password change</span></a> for the password change history entity.</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In the setting of “Prevent reuse of password used before specified period”, it is possible to reuse a password by repeating a password within a short period of time.
In order to prevent this, check is performed in this application by setting “Prevent reuse of password used from a certain period onwards</p>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.common.validation</span><span class="o">;</span>

<span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{</span> <span class="n">NotReusedPasswordValidator</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span> <span class="c1">// (1)</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">TYPE</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">NotReusedPassword</span> <span class="o">{</span>
    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{org.terasoluna.securelogin.app.common.validation.NotReusedPassword.message}&quot;</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">String</span> <span class="nf">usernamePropertyName</span><span class="o">();</span> <span class="c1">// (2)</span>

    <span class="n">String</span> <span class="nf">newPasswordPropertyName</span><span class="o">();</span> <span class="c1">// (3)</span>

    <span class="nd">@Target</span><span class="o">({</span> <span class="n">TYPE</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">NotReusedPassword</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="nf">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify <code class="docutils literal"><span class="pre">ConstraintValidator</span></code>  to be used while assigning an annotation.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A property to specify the property name of the user name. It is required to search the password used in the past, from the database.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A property to specify the property name of the password.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.common.validation</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NotReusedPasswordValidator</span> <span class="kd">implements</span>
        <span class="n">ConstraintValidator</span><span class="o">&lt;</span><span class="n">NotReusedPassword</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ClassicDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">AccountSharedService</span> <span class="n">accountSharedService</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordHistorySharedService</span> <span class="n">passwordHistorySharedService</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="o">(</span><span class="s">&quot;encodedPasswordHistoryValidator&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="n">PasswordValidator</span> <span class="n">encodedPasswordHistoryValidator</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${security.passwordHistoricalCheckingCount}&quot;</span><span class="o">)</span> <span class="c1">// (2)</span>
    <span class="kt">int</span> <span class="n">passwordHistoricalCheckingCount</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${security.passwordHistoricalCheckingPeriod}&quot;</span><span class="o">)</span> <span class="c1">// (3)</span>
    <span class="kt">int</span> <span class="n">passwordHistoricalCheckingPeriod</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">usernamePropertyName</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">newPasswordPropertyName</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">message</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">NotReusedPassword</span> <span class="n">constraintAnnotation</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">usernamePropertyName</span> <span class="o">=</span> <span class="n">constraintAnnotation</span><span class="o">.</span><span class="na">usernamePropertyName</span><span class="o">();</span>
        <span class="n">newPasswordPropertyName</span> <span class="o">=</span> <span class="n">constraintAnnotation</span><span class="o">.</span><span class="na">newPasswordPropertyName</span><span class="o">();</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">constraintAnnotation</span><span class="o">.</span><span class="na">message</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isValid</span><span class="o">(</span><span class="n">Object</span> <span class="n">value</span><span class="o">,</span> <span class="n">ConstraintValidatorContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">BeanWrapper</span> <span class="n">beanWrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BeanWrapperImpl</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">beanWrapper</span><span class="o">.</span><span class="na">getPropertyValue</span><span class="o">(</span><span class="n">usernamePropertyName</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">newPassword</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">beanWrapper</span>
                <span class="o">.</span><span class="na">getPropertyValue</span><span class="o">(</span><span class="n">newPasswordPropertyName</span><span class="o">);</span>

        <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">accountSharedService</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">currentPassword</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="na">getPassword</span><span class="o">();</span>

        <span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="n">checkNewPasswordDifferentFromCurrentPassword</span><span class="o">(</span>
                <span class="n">newPassword</span><span class="o">,</span> <span class="n">currentPassword</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span> <span class="c1">// (4)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="n">account</span><span class="o">.</span><span class="na">getRoles</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="n">Role</span><span class="o">.</span><span class="na">ADMIN</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// (5)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">checkHistoricalPassword</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">newPassword</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">checkNewPasswordDifferentFromCurrentPassword</span><span class="o">(</span>
            <span class="n">String</span> <span class="n">newPassword</span><span class="o">,</span> <span class="n">String</span> <span class="n">currentPassword</span><span class="o">,</span>
            <span class="n">ConstraintValidatorContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">passwordEncoder</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">newPassword</span><span class="o">,</span> <span class="n">currentPassword</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">context</span><span class="o">.</span><span class="na">disableDefaultConstraintViolation</span><span class="o">();</span>
            <span class="n">context</span><span class="o">.</span><span class="na">buildConstraintViolationWithTemplate</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">addPropertyNode</span><span class="o">(</span><span class="n">newPasswordPropertyName</span><span class="o">).</span><span class="na">addConstraintViolation</span><span class="o">();</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">checkHistoricalPassword</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span>
            <span class="n">String</span> <span class="n">newPassword</span><span class="o">,</span> <span class="n">ConstraintValidatorContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">LocalDateTime</span> <span class="n">useFrom</span> <span class="o">=</span> <span class="n">dateFactory</span><span class="o">.</span><span class="na">newTimestamp</span><span class="o">().</span><span class="na">toLocalDateTime</span><span class="o">()</span>
                <span class="o">.</span><span class="na">minusMinutes</span><span class="o">(</span><span class="n">passwordHistoricalCheckingPeriod</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">PasswordHistory</span><span class="o">&gt;</span> <span class="n">historyByTime</span> <span class="o">=</span> <span class="n">passwordHistorySharedService</span>
                <span class="o">.</span><span class="na">findHistoriesByUseFrom</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">useFrom</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">PasswordHistory</span><span class="o">&gt;</span> <span class="n">historyByCount</span> <span class="o">=</span> <span class="n">passwordHistorySharedService</span>
                <span class="o">.</span><span class="na">findLatest</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">passwordHistoricalCheckingCount</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">PasswordHistory</span><span class="o">&gt;</span> <span class="n">history</span> <span class="o">=</span> <span class="n">historyByCount</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">historyByTime</span>
                <span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">?</span> <span class="n">historyByCount</span> <span class="o">:</span> <span class="n">historyByTime</span><span class="o">;</span> <span class="c1">// (6)</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">PasswordData</span><span class="o">.</span><span class="na">Reference</span><span class="o">&gt;</span> <span class="n">historyData</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">PasswordHistory</span> <span class="n">h</span> <span class="o">:</span> <span class="n">history</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">historyData</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">PasswordData</span><span class="o">.</span><span class="na">HistoricalReference</span><span class="o">(</span><span class="n">h</span>
                    <span class="o">.</span><span class="na">getPassword</span><span class="o">()));</span> <span class="c1">// (7)</span>
        <span class="o">}</span>

        <span class="n">PasswordData</span> <span class="n">passwordData</span> <span class="o">=</span> <span class="n">PasswordData</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">newPassword</span><span class="o">,</span>
                <span class="n">username</span><span class="o">,</span> <span class="n">historyData</span><span class="o">);</span> <span class="c1">// (8)</span>
        <span class="n">RuleResult</span> <span class="n">result</span> <span class="o">=</span> <span class="n">encodedPasswordHistoryValidator</span>
                <span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">passwordData</span><span class="o">);</span> <span class="c1">// (9)</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">isValid</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// (10)</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">context</span><span class="o">.</span><span class="na">disableDefaultConstraintViolation</span><span class="o">();</span>
            <span class="n">context</span><span class="o">.</span><span class="na">buildConstraintViolationWithTemplate</span><span class="o">(</span>
                    <span class="n">encodedPasswordHistoryValidator</span><span class="o">.</span><span class="na">getMessages</span><span class="o">(</span><span class="n">result</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span> <span class="c1">// (11)</span>
                    <span class="o">.</span><span class="na">addPropertyNode</span><span class="o">(</span><span class="n">newPasswordPropertyName</span><span class="o">).</span><span class="na">addConstraintViolation</span><span class="o">();</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inject Passay validator.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch the threshold to prohibit reuse of password up to a previous date, from the property file and inject it.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch the threshold (in seconds) to prohibit the reuse of the password used from a date onwards, from the property file and inject it.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call the process to check whether new password is different from the currently used password. Perform this check regardless of the general user / administrator.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In case of administrator, call the process to check that new password is not included in the previously used passwords.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch the number of password change history entities specified in (2) and the password change history entities of the period specified in (3) and use the larger number of the two for the subsequent checks.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In order to make a comparison with the previous password using Passay validator, fetch the password from the password change history entity and create a list of <code class="docutils literal"><span class="pre">org.passay.PasswordData.HistoricalReference</span></code> .</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create an instance of <code class="docutils literal"><span class="pre">org.passay.PasswordData</span></code>  which specifies password, user name and list of previous passwords.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Perform validation by using the validator.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Confirm the check result, if it is OK, return true, else return false.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch the password validation error messages.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</li>
<li><p class="first">Password validation</p>
<p>Perform password validation in the application layer which use Bean Validation annotation.
Since input check other than Null check is covered by the annotation assigned to Form class, only <code class="docutils literal"><span class="pre">&#64;NotNull</span></code>  is assigned as a single item check.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.passwordchange</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@Data</span>
<span class="nd">@Compare</span><span class="o">(</span><span class="n">left</span> <span class="o">=</span> <span class="s">&quot;newPassword&quot;</span><span class="o">,</span> <span class="n">right</span> <span class="o">=</span> <span class="s">&quot;confirmNewPassword&quot;</span><span class="o">,</span> <span class="n">operator</span> <span class="o">=</span> <span class="n">Compare</span><span class="o">.</span><span class="na">Operator</span><span class="o">.</span><span class="na">EQUAL</span><span class="o">)</span> <span class="c1">// (1)</span>
<span class="nd">@StrongPassword</span><span class="o">(</span><span class="n">usernamePropertyName</span> <span class="o">=</span> <span class="s">&quot;username&quot;</span><span class="o">,</span> <span class="n">newPasswordPropertyName</span> <span class="o">=</span> <span class="s">&quot;newPassword&quot;</span><span class="o">)</span> <span class="c1">// (2)</span>
<span class="nd">@NotReusedPassword</span><span class="o">(</span><span class="n">usernamePropertyName</span> <span class="o">=</span> <span class="s">&quot;username&quot;</span><span class="o">,</span> <span class="n">newPasswordPropertyName</span> <span class="o">=</span> <span class="s">&quot;newPassword&quot;</span><span class="o">)</span> <span class="c1">// (3)</span>
<span class="nd">@ConfirmOldPassword</span><span class="o">(</span><span class="n">usernamePropertyName</span> <span class="o">=</span> <span class="s">&quot;username&quot;</span><span class="o">,</span> <span class="n">oldPasswordPropertyName</span> <span class="o">=</span> <span class="s">&quot;oldPassword&quot;</span><span class="o">)</span> <span class="c1">// (4)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordChangeForm</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">oldPassword</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">newPassword</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">confirmNewPassword</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">An annotation to check whether second input of new password is identical with the first input. Refer to <a class="reference internal" href="../ArchitectureInDetail/WebApplicationDetail/Validation.html#validation-terasoluna-gfw-list"><span class="std std-ref">terasoluna-gfw-validator check rules</span></a> for the details.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">An annotation to verify the characteristic of the password, described above</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">An annotation to compare with the previous password</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">An annotation to check that the entered current password is correct. Definition will be omitted.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.passwordchange</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;password&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordChangeController</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordChangeService</span> <span class="n">passwordService</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">change</span><span class="o">(</span><span class="nd">@AuthenticationPrincipal</span> <span class="n">LoggedInUser</span> <span class="n">userDetails</span><span class="o">,</span>
            <span class="nd">@Validated</span> <span class="n">PasswordChangeForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">bindingResult</span><span class="o">,</span> <span class="c1">// (1)</span>
            <span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">userDetails</span><span class="o">.</span><span class="na">getAccount</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">bindingResult</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">()</span> <span class="o">||</span>
                <span class="o">!</span><span class="n">account</span><span class="o">.</span><span class="na">getUsername</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">form</span><span class="o">.</span><span class="na">getUsername</span><span class="o">()))</span> <span class="o">{</span> <span class="c1">// (2)</span>
            <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">account</span><span class="o">);</span>
            <span class="k">return</span> <span class="s">&quot;passwordchange/changeForm&quot;</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">passwordService</span><span class="o">.</span><span class="na">updatePassword</span><span class="o">(</span><span class="n">form</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span>
                <span class="n">form</span><span class="o">.</span><span class="na">getNewPassword</span><span class="o">());</span>

        <span class="k">return</span> <span class="s">&quot;redirect:/password?complete&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A handler method called at the time of changing the password. Perform validation by assigning <code class="docutils literal"><span class="pre">&#64;Validated</span></code>  annotation to Form in the parameter.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Confirm that the user name for password change and the user name of the logged-in account are identical. If the two users are different, the user is again taken to the password change screen.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In this application, user name is fetched from the Form to perform password validation using the user name in Bean Validation.
It is assumed that in View, the user name set in <code class="docutils literal"><span class="pre">Model</span></code>  is retained as hidden, however, since there is a risk of tampering, user name obtained from the Form before password change is confirmed.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="account-lock">
<span id="id5"></span><h3><a class="toc-backref" href="#id67">9.10.3.3. Account lock</a><a class="headerlink" href="#account-lock" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id6">
<h4><a class="toc-backref" href="#id68">9.10.3.3.1. List of requirements to be implemented</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference internal" href="#sec-requirements"><span class="std std-ref">Account lock</span></a></li>
<li><a class="reference internal" href="#sec-requirements"><span class="std std-ref">Specifying account lockout duration</span></a></li>
<li><a class="reference internal" href="#sec-requirements"><span class="std std-ref">Unlocking by the administrator</span></a></li>
</ul>
</div>
<div class="section" id="id7">
<h4><a class="toc-backref" href="#id69">9.10.3.3.2. Working image</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Account lock</li>
</ul>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_lockout_ss.png"><img alt="Lockout" src="../_images/SecureLogin_lockout_ss.png" style="width: 80%;" /></a>
</div>
<div class="line-block">
<div class="line">In the login form, if you try to authenticate a user name with an incorrect password for a certain number of times, successively in a short duration, then that user’s account will be locked.
Locked account is not authenticated even if a set of correct user name and password is entered.</div>
<div class="line">Locked status is cancelled after a certain period of time or by unlocking it.</div>
</div>
<ul class="simple">
<li>Unlock</li>
</ul>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_unlock_ss.png"><img alt="Unlock" src="../_images/SecureLogin_unlock_ss.png" style="width: 80%;" /></a>
</div>
<p>Unlock function can be used only when the user having administrator rights has logged in.
If unlocking is carried out by entering the user name for which the locked status is to be resolved, then the account of that user returns to the status wherein authentication can be done again.</p>
</div>
<div class="section" id="id8">
<h4><a class="toc-backref" href="#id70">9.10.3.3.3. Implementation method</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">In Spring Security, an account lockout status can be set for <code class="docutils literal"><span class="pre">org.springframework.security.core.userdetails.UserDetails</span></code> .</div>
<div class="line">If “Locked” is set, Spring Security reads that setting and throws <code class="docutils literal"><span class="pre">org.springframework.security.authentication.LockedException</span></code> .</div>
<div class="line">By using this function, if only the process set in <code class="docutils literal"><span class="pre">UserDetails</span></code>  is implemented by determining whether the account is locked, lockout function can be implemented.</div>
</div>
<div class="line-block">
<div class="line">In this application, the history of authentication failure is stored in the database as an “authentication failure event” entity, and the lockout status of the account is determined using this authentication failure event entity.</div>
<div class="line">In particular, each requirement related to account lockout is fulfilled by implementing and using the following three processes.</div>
</div>
<ul>
<li><p class="first">Storing authentication failure event entity</p>
<p>In case of authentication failure due to invalid authentication information input, the events generated by Spring Security are handled and the user name used for authentication and the date and time when authentication was attempted are registered in the database as authentication failure event entity.</p>
</li>
<li><p class="first">Determining lockout status</p>
<p>For some accounts, if a certain number of new authentication failure event entities at the current time are more than a certain fixed number, the corresponding account is determined to be locked.
Call this determination process during authentication and set the determination results in the implementation class of <code class="docutils literal"><span class="pre">UserDetails</span></code> .</p>
</li>
<li><p class="first">Deleting authentication failure event entity</p>
<div class="line-block">
<div class="line">Delete all authentication failure event entities for an account.</div>
<div class="line">Since an account is targeted for lockout only when it fails to authenticate continuously, delete the authentication failure event entity when authentication is successful.</div>
<div class="line">Also, since the lockout status of the account is determined using the authentication failure event entity, unlock function can be implemented by deleting the authentication failure event entity.
Prevent account lockout from being executed by other than administrator using authorization function.</div>
</div>
</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Since authentication failure event entity is intended only to determine lockout, it is deleted when it is no longer required.
A separate log should be always saved when authentication log is required.</p>
</div>
<p>The working example of lockout function which uses authentication failure event entity is described with the help of the following figure.
Lockout by authentication failure for 3 times and lockout duration of 10 minutes is considered as an example.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_lockout.png"><img alt="Account Lockout" src="../_images/SecureLogin_lockout.png" style="width: 60%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authentication with incorrect password has been attempted three times in last 10 minutes, and authentication failure event entities for all the three occasions are stored in the database.</div>
<div class="line">Therefore, it is determined that the account is locked.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authentication failure event entities for 3 occasions are stored in the database.</div>
<div class="line">However, since authentication failure event entities are only for the two occasions in last 10 minutes, the account is determined to be “not locked”.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Similarly, a working example for unlocking is described in the following figure.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_unlock.png"><img alt="Account Lockout" src="../_images/SecureLogin_unlock.png" style="width: 60%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authentication with incorrect password has been attempted three times in last 10 minutes.</div>
<div class="line">Thereafter, since the authentication failure event entity is deleted, authentication failure event entity is not stored in the database and the account is determined as “not locked”.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id9">
<h4><a class="toc-backref" href="#id71">9.10.3.3.4. Code description</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">Common part</p>
<p>In this application, registration, search and deletion of authentication failure event entity for the database is commonly required to implement the functions related to account lockout.
Therefore, the implementation of domain layer / infrastructure layer related to the authentication failure event entity is shown first.</p>
<ul>
<li><p class="first">Implementation of Entity</p>
<p>The implementation of authentication failure event entity with user name and date and time when authentication was attempted is shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.model</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FailedAuthentication</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

  <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span> <span class="c1">// (1)</span>

  <span class="kd">private</span> <span class="n">LocalDateTime</span> <span class="n">authenticationTimestamp</span><span class="o">;</span> <span class="c1">// (2)</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">User name used for authentication</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Date and time when authentication was attempted</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Implementation of Repository</p>
<p>Repository to search, register and delete authentication failure event entity is shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.repository.authenticationevent</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">FailedAuthenticationRepository</span> <span class="o">{</span>

  <span class="kt">int</span> <span class="nf">create</span><span class="o">(</span><span class="n">FailedAuthentication</span> <span class="n">event</span><span class="o">);</span> <span class="c1">// (1)</span>

  <span class="n">List</span><span class="o">&lt;</span><span class="n">FailedAuthentication</span><span class="o">&gt;</span> <span class="nf">findLatest</span><span class="o">(</span>
                  <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;username&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">)</span> <span class="kt">long</span> <span class="n">count</span><span class="o">);</span> <span class="c1">// (2)</span>

  <span class="kt">int</span> <span class="nf">deleteByUsername</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;username&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">username</span><span class="o">);</span> <span class="c1">// (3)</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method to register <code class="docutils literal"><span class="pre">FailedAuthentication</span></code> object that is assigned as an argument, as a record in the database</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method to get specified number of <code class="docutils literal"><span class="pre">FailedAuthentication</span></code> objects in a new sequence by considering user name assigned as an argument, as the key</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method to delete the authentication failure event entity records collectively by considering user name assigned as an argument, as the key</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Mapping file is as below.</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>

<span class="nt">&lt;mapper</span>
  <span class="na">namespace=</span><span class="s">&quot;org.terasoluna.securelogin.domain.repository.authenticationevent.FailedAuthenticationRepository&quot;</span><span class="nt">&gt;</span>

  <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;failedAuthenticationResultMap&quot;</span>
          <span class="na">type=</span><span class="s">&quot;FailedAuthentication&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;username&quot;</span> <span class="na">column=</span><span class="s">&quot;username&quot;</span> <span class="nt">/&gt;</span>
          <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;authenticationTimestamp&quot;</span> <span class="na">column=</span><span class="s">&quot;authentication_timestamp&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/resultMap&gt;</span>

  <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;create&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;FailedAuthentication&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;![CDATA[</span>
<span class="cp">        INSERT INTO failed_authentication (</span>
<span class="cp">            username,</span>
<span class="cp">            authentication_timestamp</span>
<span class="cp">        ) VALUES (</span>
<span class="cp">          #{username},</span>
<span class="cp">            #{authenticationTimestamp}</span>
<span class="cp">        )</span>
<span class="cp">    ]]&gt;</span>
  <span class="nt">&lt;/insert&gt;</span>

  <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findLatest&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;failedAuthenticationResultMap&quot;</span><span class="nt">&gt;</span>
       <span class="cp">&lt;![CDATA[</span>
<span class="cp">            SELECT</span>
<span class="cp">                username,</span>
<span class="cp">                authentication_timestamp</span>
<span class="cp">            FROM</span>
<span class="cp">                failed_authentication</span>
<span class="cp">            WHERE</span>
<span class="cp">                username = #{username}</span>
<span class="cp">            ORDER BY authentication_timestamp DESC</span>
<span class="cp">            LIMIT #{count}</span>
<span class="cp">       ]]&gt;</span>
  <span class="nt">&lt;/select&gt;</span>

  <span class="nt">&lt;delete</span> <span class="na">id=</span><span class="s">&quot;deleteByUsername&quot;</span><span class="nt">&gt;</span>
     <span class="cp">&lt;![CDATA[</span>
<span class="cp">          DELETE FROM</span>
<span class="cp">              failed_authentication</span>
<span class="cp">          WHERE</span>
<span class="cp">              username = #{username}</span>
<span class="cp">     ]]&gt;</span>
  <span class="nt">&lt;/delete&gt;</span>
<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first">Implementation of Service</p>
<p>The service to call the method of the created Repository is defined as below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.authenticationevent</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthenticationEventSharedServiceImpl</span> <span class="kd">implements</span>
                <span class="n">AuthenticationEventSharedService</span> <span class="o">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Inject</span>
    <span class="n">ClassicDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">FailedAuthenticationRepository</span> <span class="n">failedAuthenticationRepository</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">AccountSharedService</span> <span class="n">accountSharedService</span><span class="o">;</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">FailedAuthentication</span><span class="o">&gt;</span> <span class="nf">findLatestFailureEvents</span><span class="o">(</span>
                    <span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">failedAuthenticationRepository</span><span class="o">.</span><span class="na">findLatest</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">count</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="n">Propagation</span><span class="o">.</span><span class="na">REQUIRES_NEW</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">authenticationFailure</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (1)</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">accountSharedService</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">username</span><span class="o">)){</span>
             <span class="n">FailedAuthentication</span> <span class="n">failureEvents</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FailedAuthentication</span><span class="o">();</span>
             <span class="n">failureEvents</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
             <span class="n">failureEvents</span><span class="o">.</span><span class="na">setAuthenticationTimestamp</span><span class="o">(</span><span class="n">dateFactory</span><span class="o">.</span><span class="na">newTimestamp</span><span class="o">()</span>
                     <span class="o">.</span><span class="na">toLocalDateTime</span><span class="o">());</span>

             <span class="n">failedAuthenticationRepository</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">failureEvents</span><span class="o">);</span>
         <span class="o">}</span>
     <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">deleteFailureEventByUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">failedAuthenticationRepository</span><span class="o">.</span><span class="na">deleteByUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method to create authentication failure event entity and register in the database.</div>
<div class="line">If account of the user name received as an argument does not exist, skip the process of registration to the database since it violates the foreign key constraints of the database.</div>
<div class="line">Since it is likely that authentication failure event entity is not registered by the exception after executing this method, <code class="docutils literal"><span class="pre">REQUIRES_NEW</span></code>  is specified in the propagation method of transaction.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</li>
</ul>
<p>The code implemented according to the implementation method is described below sequentially.</p>
<ul>
<li><p class="first">Storing authentication failure event entity</p>
<p>Use <code class="docutils literal"><span class="pre">&#64;EventListener</span></code>  annotation to execute the process by handling the event generated at the time of authentication failure.
For handling of event by using <code class="docutils literal"><span class="pre">&#64;EventListener</span></code>  annotation, refer <a class="reference internal" href="Authentication.html#springsecurityauthenticationevent"><span class="std std-ref">Handling authentication event</span></a> .</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.account</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountAuthenticationFailureBadCredentialsEventListener</span><span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">AuthenticationEventSharedService</span> <span class="n">authenticationEventSharedService</span><span class="o">;</span>

    <span class="nd">@EventListener</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onApplicationEvent</span><span class="o">(</span>
                    <span class="n">AuthenticationFailureBadCredentialsEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">event</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">().</span><span class="na">getPrincipal</span><span class="o">();</span> <span class="c1">// (2)</span>

        <span class="n">authenticationEventSharedService</span><span class="o">.</span><span class="na">authenticationFailure</span><span class="o">(</span><span class="n">username</span><span class="o">);</span> <span class="c1">// (3)</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">By assigning <code class="docutils literal"><span class="pre">&#64;EventListener</span></code>  annotation, when authentication fails due to invalid authentication information such as incorrect password etc., <code class="docutils literal"><span class="pre">onApplicationEvent</span></code>  method is executed.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch the user name used for authentication from <code class="docutils literal"><span class="pre">AuthenticationFailureBadCredentialsEvent</span></code>  object.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call the process to create authentication failure event entity and register in the database.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Determining lockout status</p>
<p>The process to determine account lockout status using authentication failure event entity is described.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.account</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountSharedServiceImpl</span> <span class="kd">implements</span> <span class="n">AccountSharedService</span> <span class="o">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Inject</span>
    <span class="n">ClassicDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">AuthenticationEventSharedService</span> <span class="n">authenticationEventSharedService</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${security.lockingDurationSeconds}&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="kt">int</span> <span class="n">lockingDurationSeconds</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${security.lockingThreshold}&quot;</span><span class="o">)</span> <span class="c1">// (2)</span>
    <span class="kt">int</span> <span class="n">lockingThreshold</span><span class="o">;</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isLocked</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">FailedAuthentication</span><span class="o">&gt;</span> <span class="n">failureEvents</span> <span class="o">=</span> <span class="n">authenticationEventSharedService</span>
                        <span class="o">.</span><span class="na">findLatestFailureEvents</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">lockingThreshold</span><span class="o">);</span> <span class="c1">// (3)</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">failureEvents</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">lockingThreshold</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (4)</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">failureEvents</span>
                <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">lockingThreshold</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="c1">// (5)</span>
                <span class="o">.</span><span class="na">getAuthenticationTimestamp</span><span class="o">()</span>
                <span class="o">.</span><span class="na">isBefore</span><span class="o">(</span>
                        <span class="n">dateFactory</span><span class="o">.</span><span class="na">newTimestamp</span><span class="o">().</span><span class="na">toLocalDateTime</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">minusSeconds</span><span class="o">(</span><span class="n">lockingDurationSeconds</span><span class="o">)))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the lockout duration in seconds. The value defined in Property file is injected.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the locking threshold. The account is locked when authentication fails only for the number of times specified here. The value defined in Property file is injected.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch the authentication failure event entity in new sequence only for the number same as the locking threshold.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">If the number of fetched authentication failure event entities is less than the locking threshold value, determine that the account is not locked.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">If the difference between oldest authentication failure time from the fetched authentication failure event entities and current time is greater than the locking duration, determine that the account is not locked.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">In <code class="docutils literal"><span class="pre">org.springframework.security.core.userdetails.User</span></code>  which is the implementation class of <code class="docutils literal"><span class="pre">UserDetails</span></code> , lockout status can be passed to the constructor.</div>
<div class="line">In this application, class that inherits <code class="docutils literal"><span class="pre">User</span></code>  and class that implements <code class="docutils literal"><span class="pre">org.springframework.security.core.userdetails.UserDetailsService</span></code>  are used as shown below.</div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.userdetails</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoggedInUser</span> <span class="kd">extends</span> <span class="n">User</span> <span class="o">{</span>

   <span class="c1">// omitted</span>

   <span class="kd">private</span> <span class="kd">final</span> <span class="n">Account</span> <span class="n">account</span><span class="o">;</span>

   <span class="kd">public</span> <span class="nf">LoggedInUser</span><span class="o">(</span><span class="n">Account</span> <span class="n">account</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">isLocked</span><span class="o">,</span>
           <span class="n">LocalDateTime</span> <span class="n">lastLoginDate</span><span class="o">,</span>
           <span class="n">List</span><span class="o">&lt;</span><span class="n">SimpleGrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span><span class="o">)</span> <span class="o">{</span>
       <span class="kd">super</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span> <span class="n">account</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span>
                   <span class="o">!</span><span class="n">isLocked</span><span class="o">,</span> <span class="n">authorities</span><span class="o">);</span> <span class="c1">// (1)</span>
       <span class="k">this</span><span class="o">.</span><span class="na">account</span> <span class="o">=</span> <span class="n">account</span><span class="o">;</span>

       <span class="c1">// omitted</span>
   <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Account</span> <span class="nf">getAccount</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">account</span><span class="o">;</span>
    <span class="o">}</span>

   <span class="c1">// omitted</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In the constructor of <code class="docutils literal"><span class="pre">User</span></code>  which is the parent class, pass ** Whether the account is locked** in truth-value. Note that it is necessary to pass true if the account is not locked.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.userdetails</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoggedInUserDetailsService</span> <span class="kd">implements</span> <span class="n">UserDetailsService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">AccountSharedService</span> <span class="n">accountSharedService</span><span class="o">;</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">UsernameNotFoundException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
           <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">accountSharedService</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
           <span class="n">List</span><span class="o">&lt;</span><span class="n">SimpleGrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
           <span class="k">for</span> <span class="o">(</span><span class="n">Role</span> <span class="n">role</span> <span class="o">:</span> <span class="n">account</span><span class="o">.</span><span class="na">getRoles</span><span class="o">())</span> <span class="o">{</span>
               <span class="n">authorities</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">SimpleGrantedAuthority</span><span class="o">(</span><span class="s">&quot;ROLE_&quot;</span>
                       <span class="o">+</span> <span class="n">role</span><span class="o">.</span><span class="na">getRoleValue</span><span class="o">()));</span>
           <span class="o">}</span>
           <span class="k">return</span> <span class="k">new</span> <span class="n">LoggedInUser</span><span class="o">(</span><span class="n">account</span><span class="o">,</span>
                   <span class="n">accountSharedService</span><span class="o">.</span><span class="na">isLocked</span><span class="o">(</span><span class="n">username</span><span class="o">),</span> <span class="c1">// (1)</span>
                   <span class="n">accountSharedService</span><span class="o">.</span><span class="na">getLastLoginDate</span><span class="o">(</span><span class="n">username</span><span class="o">),</span>
                   <span class="n">authorities</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ResourceNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">UsernameNotFoundException</span><span class="o">(</span><span class="s">&quot;user not found&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In constructor of <code class="docutils literal"><span class="pre">LoggedInUser</span></code> , pass the determination result of lockout status using <code class="docutils literal"><span class="pre">isLocked</span></code>  method.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Settings to use the created <code class="docutils literal"><span class="pre">UserDetailsService</span></code>  are as follows:</p>
<p><strong>spring-security.xml</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;sec:authentication-manager&gt;</span>
    <span class="nt">&lt;sec:authentication-provider</span>
        <span class="na">user-service-ref=</span><span class="s">&quot;loggedInUserDetailsService&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;sec:password-encoder</span> <span class="na">ref=</span><span class="s">&quot;passwordEncoder&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/sec:authentication-provider&gt;</span>
<span class="nt">&lt;/sec:authentication-manager&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify Bean id for <code class="docutils literal"><span class="pre">UserDetailsService</span></code> .</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Deleting authentication failure event entity</p>
<ul>
<li><p class="first">Deleting authentication failure event entity when authentication is successful</p>
<p>Since only consecutive authentication failures are used to determine lockout, delete the authentication failure event entity of the account when authentication is successful.
Create the method to be executed when authentication is successful in the Service created as a common part.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.authenticationevent</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthenticationEventSharedServiceImpl</span> <span class="kd">implements</span>
                <span class="n">AuthenticationEventSharedService</span> <span class="o">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="n">Propagation</span><span class="o">.</span><span class="na">REQUIRES_NEW</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">authenticationSuccess</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// omitted</span>

        <span class="n">deleteFailureEventByUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span> <span class="c1">// (1)</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Delete the authentication failure event entity for the account of the user name passed as an argument.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Use <code class="docutils literal"><span class="pre">&#64;EventListener</span></code>  annotation to execute the process by handling the event generated when authentication is successful.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.account</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountAuthenticationSuccessEventListener</span><span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">AuthenticationEventSharedService</span> <span class="n">authenticationEventSharedService</span><span class="o">;</span>

    <span class="nd">@EventListener</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onApplicationEvent</span><span class="o">(</span>
                    <span class="n">AuthenticationSuccessEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">LoggedInUser</span> <span class="n">details</span> <span class="o">=</span> <span class="o">(</span><span class="n">LoggedInUser</span><span class="o">)</span> <span class="n">event</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">()</span>
                <span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>

        <span class="n">authenticationEventSharedService</span><span class="o">.</span><span class="na">authenticationSuccess</span><span class="o">(</span><span class="n">details</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span> <span class="c1">// (2)</span>

    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">By assigning <code class="docutils literal"><span class="pre">&#64;EventListener</span></code>  annotation, <code class="docutils literal"><span class="pre">onApplicationEvent</span></code>  method is executed when authentication is successful.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch user name from <code class="docutils literal"><span class="pre">AuthenticationSuccessEvent</span></code>  and call the process to delete authentication failure event entity.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Unlocking</p>
<p>Since authentication failure event entity is used to determine lockout status, an account can be unlocked by deleting the authentication failure event entity.
Perform the authorization settings to restrict the usage of unlock function to “the user having administrator rights” and implement the domain layer / application layer.</p>
<ul>
<li><p class="first">Authorization settings</p>
<p>Set the rights for the user who can unlock an account as below.</p>
<p><strong>spring-security.xml</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

  <span class="nt">&lt;sec:http</span> <span class="na">pattern=</span><span class="s">&quot;/resources/**&quot;</span> <span class="na">security=</span><span class="s">&quot;none&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;sec:http&gt;</span>

      <span class="c">&lt;!-- omitted --&gt;</span>

      <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/unlock/**&quot;</span> <span class="na">access=</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;)&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

      <span class="c">&lt;!-- omitted --&gt;</span>

  <span class="nt">&lt;/sec:http&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Restrict the access rights for URL under /unlock to the administrator.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Implementation of Service</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.unlock</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Transactional</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UnlockServiceImpl</span> <span class="kd">implements</span> <span class="n">UnlockService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">AccountSharedService</span> <span class="n">accountSharedService</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">AuthenticationEventSharedService</span> <span class="n">authenticationEventSharedService</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">unlock</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">authenticationEventSharedService</span><span class="o">.</span><span class="na">deleteFailureEventByUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span> <span class="c1">// (1)</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Unlock an account by deleting the authentication failure event entity.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Implementation of Form</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.unlock</span><span class="o">;</span>

<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UnlockForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="nd">@NotEmpty</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Implementation of View</p>
<p><strong>Top screen(home.jsp)</strong></p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>

        <span class="c">&lt;!-- omitted --&gt;</span>

        <span class="nt">&lt;sec:authorize</span> <span class="na">url=</span><span class="s">&quot;/unlock&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;div&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">id=</span><span class="s">&quot;unlock&quot;</span> <span class="na">href=</span><span class="s">&quot;${f:h(pageContext.request.contextPath)}/unlock?form&quot;</span><span class="nt">&gt;</span>
                Unlock Account
            <span class="nt">&lt;/a&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/sec:authorize&gt;</span>

        <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Display only for the user who has access rights, under /unlock.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>Unlock form(unlokcForm.jsp)</strong></p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Unlock Account<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;t:messagesPanel</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:form</span> <span class="na">action=</span><span class="s">&quot;${f:h(pageContext.request.contextPath)}/unlock&quot;</span>
            <span class="na">method=</span><span class="s">&quot;POST&quot;</span> <span class="na">modelAttribute=</span><span class="s">&quot;unlockForm&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;table&gt;</span>
                <span class="nt">&lt;tr&gt;</span>
                    <span class="nt">&lt;th&gt;&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;username&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Username<span class="nt">&lt;/form:label&gt;</span>
                    <span class="nt">&lt;/th&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;username&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;username&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;/table&gt;</span>

            <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;submit&quot;</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Unlock&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/form:form&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;${f:h(pageContext.request.contextPath)}/&quot;</span><span class="nt">&gt;</span>go to Top<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<p><strong>Unlock completion screen(unlockComplete.jsp)</strong></p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>${f:h(username)}&#39;s account was successfully unlocked.<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;${f:h(pageContext.request.contextPath)}/&quot;</span><span class="nt">&gt;</span>go to Top<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first">Implementation of Controller</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.unlock</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/unlock&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UnlockController</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">UnlockService</span> <span class="n">unlockService</span><span class="o">;</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">showForm</span><span class="o">(</span><span class="n">UnlockForm</span> <span class="n">form</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;unlock/unlockForm&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">unlock</span><span class="o">(</span><span class="nd">@Validated</span> <span class="n">UnlockForm</span> <span class="n">form</span><span class="o">,</span>
            <span class="n">BindingResult</span> <span class="n">bindingResult</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">,</span>
            <span class="n">RedirectAttributes</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">bindingResult</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">showForm</span><span class="o">(</span><span class="n">form</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">unlockService</span><span class="o">.</span><span class="na">unlock</span><span class="o">(</span><span class="n">form</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span> <span class="c1">// (2)</span>
            <span class="n">attributes</span><span class="o">.</span><span class="na">addFlashAttribute</span><span class="o">(</span><span class="s">&quot;username&quot;</span><span class="o">,</span> <span class="n">form</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
            <span class="k">return</span> <span class="s">&quot;redirect:/unlock?complete&quot;</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">BusinessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getResultMessages</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">showForm</span><span class="o">(</span><span class="n">form</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;complete&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">unlockComplete</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;unlock/unlockComplete&quot;</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Map to the URL under /unlock. It can be accessed by administrator only depending on the authorization settings.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call the process to unlock an account by considering the user name obtained from the Form, as an argument.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="display-the-date-and-time-of-last-login">
<span id="last-login"></span><h3><a class="toc-backref" href="#id72">9.10.3.4. Display the date and time of last login</a><a class="headerlink" href="#display-the-date-and-time-of-last-login" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id10">
<h4><a class="toc-backref" href="#id73">9.10.3.4.1. List of requirements to be implemented</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference internal" href="#sec-requirements"><span class="std std-ref">Display of previous login date and time</span></a></li>
</ul>
</div>
<div class="section" id="id11">
<h4><a class="toc-backref" href="#id74">9.10.3.4.2. Working image</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_last_login.png"><img alt="Last Login Date" src="../_images/SecureLogin_last_login.png" style="width: 80%;" /></a>
</div>
</div>
<div class="section" id="id12">
<h4><a class="toc-backref" href="#id75">9.10.3.4.3. Implementation method</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">In this application, the history when authentication is successful is stored in the database as an “authentication successful event” entity, and date and time of previous login for the account is displayed on the top screen using this authentication successful event entity.</div>
<div class="line">In particular, fulfil the requirements by implementing the following two processes.</div>
</div>
<ul>
<li><p class="first">Storing authentication successful event entity</p>
<p>Handle the event generated by Spring Security when authentication is successful and register the username used for authentication and the date and time when authentication was successful in the database, as an authentication successful event entity.</p>
</li>
<li><p class="first">Fetch and display date and time of previous login</p>
<p>At the time of authentication, fetch the latest authentication successful event entity in the account from the database, fetch the authentication successful date and time from the event entity and set in <code class="docutils literal"><span class="pre">org.springframework.security.core.userdetails.UserDetails</span></code> .
Format, pass and display the authentication successful date and time retained by <code class="docutils literal"><span class="pre">UserDetails</span></code>  in jsp.</p>
</li>
</ul>
</div>
<div class="section" id="id13">
<h4><a class="toc-backref" href="#id76">9.10.3.4.4. Code description</a><a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">Common part</p>
<p>In this application, the authentication successful event entity must be registered and searched for the database in order to display previous login date and time.
Therefore, the implementation of domain layer / infrastructure layer related to the authentication successful event entity is described first.</p>
<ul>
<li><p class="first">Implementation of Entity</p>
<p>The implementation of authentication successful event entity with user name and date and time when authentication was successful is as below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.model</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SuccessfulAuthentication</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="kd">private</span> <span class="n">LocalDateTime</span> <span class="n">authenticationTimestamp</span><span class="o">;</span> <span class="c1">// (2)</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">User name used for authentication</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Date and time when authentication is attempted</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Implementation of Repository</p>
<p>Repository to search and register authentication successful event entity is shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.repository.authenticationevent</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SuccessfulAuthenticationRepository</span> <span class="o">{</span>

    <span class="kt">int</span> <span class="nf">create</span><span class="o">(</span><span class="n">SuccessfulAuthentication</span> <span class="n">event</span><span class="o">);</span> <span class="c1">// (1)</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">SuccessfulAuthentication</span><span class="o">&gt;</span> <span class="nf">findLatestEvents</span><span class="o">(</span>
           <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;username&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">)</span> <span class="kt">long</span> <span class="n">count</span><span class="o">);</span> <span class="c1">// (2)</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method to register <code class="docutils literal"><span class="pre">SuccessfulAuthentication</span></code> object that is assigned as an argument, as a record in the database</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method to fetch specified number of <code class="docutils literal"><span class="pre">SuccessfulAuthentication</span></code> objects in new sequence by considering user name assigned as an argument, as a key</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Mapping file is as below.</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>

<span class="nt">&lt;mapper</span>
    <span class="na">namespace=</span><span class="s">&quot;org.terasoluna.securelogin.domain.repository.authenticationevent.SuccessfulAuthenticationRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;successfulAuthenticationResultMap&quot;</span>
            <span class="na">type=</span><span class="s">&quot;SuccessfulAuthentication&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;username&quot;</span> <span class="na">column=</span><span class="s">&quot;username&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;authenticationTimestamp&quot;</span> <span class="na">column=</span><span class="s">&quot;authentication_timestamp&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/resultMap&gt;</span>

    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;create&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;SuccessfulAuthentication&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;![CDATA[</span>
<span class="cp">        INSERT INTO successful_authentication (</span>
<span class="cp">            username,</span>
<span class="cp">            authentication_timestamp</span>
<span class="cp">        ) VALUES (</span>
<span class="cp">            #{username},</span>
<span class="cp">            #{authenticationTimestamp}</span>
<span class="cp">        )</span>
<span class="cp">    ]]&gt;</span>
    <span class="nt">&lt;/insert&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findLatestEvents&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;successfulAuthenticationResultMap&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;![CDATA[</span>
<span class="cp">        SELECT</span>
<span class="cp">            username,</span>
<span class="cp">            authentication_timestamp</span>
<span class="cp">        FROM</span>
<span class="cp">            successful_authentication</span>
<span class="cp">        WHERE</span>
<span class="cp">            username = #{username}</span>
<span class="cp">        ORDER BY authentication_timestamp DESC</span>
<span class="cp">        LIMIT #{count}</span>
<span class="cp">    ]]&gt;</span>
    <span class="nt">&lt;/select&gt;</span>
<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first">Implementation of Service</p>
<p>The service to call the methods of the created Repository is shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.authenticationevent</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthenticationEventSharedServiceImpl</span> <span class="kd">implements</span>
     <span class="n">AuthenticationEventSharedService</span> <span class="o">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Inject</span>
    <span class="n">ClassicDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">SuccessfulAuthenticationRepository</span> <span class="n">successAuthenticationRepository</span><span class="o">;</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">SuccessfulAuthentication</span><span class="o">&gt;</span> <span class="nf">findLatestSuccessEvents</span><span class="o">(</span>
                    <span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">successAuthenticationRepository</span><span class="o">.</span><span class="na">findLatestEvents</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">count</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="n">Propagation</span><span class="o">.</span><span class="na">REQUIRES_NEW</span><span class="o">)</span>
    <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">authenticationSuccess</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">SuccessfulAuthentication</span> <span class="n">successEvent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SuccessfulAuthentication</span><span class="o">();</span>
          <span class="n">successEvent</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
          <span class="n">successEvent</span><span class="o">.</span><span class="na">setAuthenticationTimestamp</span><span class="o">(</span><span class="n">dateFactory</span><span class="o">.</span><span class="na">newTimestamp</span><span class="o">()</span>
                  <span class="o">.</span><span class="na">toLocalDateTime</span><span class="o">());</span>

          <span class="n">successAuthenticationRepository</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">successEvent</span><span class="o">);</span>
          <span class="n">deleteFailureEventByUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
      <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
<p>The code implemented according to the implementation method is described below sequentially.</p>
<ul>
<li><p class="first">Storing authentication successful event entity</p>
<p>Use <code class="docutils literal"><span class="pre">&#64;EventListener</span></code>  annotation to execute the process by handling the event generated when authentication is successful.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.account</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountAuthenticationSuccessEventListener</span><span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">AuthenticationEventSharedService</span> <span class="n">authenticationEventSharedService</span><span class="o">;</span>

    <span class="nd">@EventListener</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onApplicationEvent</span><span class="o">(</span><span class="n">AuthenticationSuccessEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">LoggedInUser</span> <span class="n">details</span> <span class="o">=</span> <span class="o">(</span><span class="n">LoggedInUser</span><span class="o">)</span> <span class="n">event</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span> <span class="c1">// (2)</span>

        <span class="n">authenticationEventSharedService</span><span class="o">.</span><span class="na">authenticationSuccess</span><span class="o">(</span><span class="n">details</span>
                <span class="o">.</span><span class="na">getUsername</span><span class="o">());</span> <span class="c1">// (3)</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">By assigning <code class="docutils literal"><span class="pre">&#64;EventListener</span></code>  annotation, <code class="docutils literal"><span class="pre">onApplicationEvent</span></code>  method is executed when authentication is successful.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch implementation class of <code class="docutils literal"><span class="pre">UserDetails</span></code>  from <code class="docutils literal"><span class="pre">AuthenticationSuccessEvent</span></code>  object. This class is described later.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call the process to create authentication successful event entity and register in the database.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Fetch and display date and time of previous login</p>
<p>The Service to fetch date and time of previous login from authentication successful event entity is shown below.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.account</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountSharedServiceImpl</span> <span class="kd">implements</span> <span class="n">AccountSharedService</span> <span class="o">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Inject</span>
    <span class="n">AuthenticationEventSharedService</span> <span class="n">authenticationEventSharedService</span><span class="o">;</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">LocalDateTime</span> <span class="nf">getLastLoginDate</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">SuccessfulAuthentication</span><span class="o">&gt;</span> <span class="n">events</span> <span class="o">=</span> <span class="n">authenticationEventSharedService</span>
                    <span class="o">.</span><span class="na">findLatestSuccessEvents</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span> <span class="c1">// (1)</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">events</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// (2)</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">events</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getAuthenticationTimestamp</span><span class="o">();</span> <span class="c1">// (3)</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch one record of the latest authentication successful event entity by considering the user name assigned as an argument, as the key.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Return null if even a single record of authentication successful event entity could not be fetched at the time of initial login.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch and return authentication date and time from authentication successful event entity.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Create a class that inherits <code class="docutils literal"><span class="pre">User</span></code>  and a class that implements <code class="docutils literal"><span class="pre">UserDetailsService</span></code>  as shown below to fetch the date and time of previous login and retain it in <code class="docutils literal"><span class="pre">UserDetails</span></code>  at the time of login.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.userdetails</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoggedInUser</span> <span class="kd">extends</span> <span class="n">User</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Account</span> <span class="n">account</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">LocalDateTime</span> <span class="n">lastLoginDate</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="kd">public</span> <span class="nf">LoggedInUser</span><span class="o">(</span><span class="n">Account</span> <span class="n">account</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">isLocked</span><span class="o">,</span>
            <span class="n">LocalDateTime</span> <span class="n">lastLoginDate</span><span class="o">,</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">SimpleGrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span><span class="o">)</span> <span class="o">{</span>

        <span class="kd">super</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span> <span class="n">account</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span>
                        <span class="o">!</span><span class="n">isLocked</span><span class="o">,</span> <span class="n">authorities</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">account</span> <span class="o">=</span> <span class="n">account</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">lastLoginDate</span> <span class="o">=</span> <span class="n">lastLoginDate</span><span class="o">;</span> <span class="c1">// (2)</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>

    <span class="kd">public</span> <span class="n">LocalDateTime</span> <span class="nf">getLastLoginDate</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// (3)</span>
        <span class="k">return</span> <span class="n">lastLoginDate</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Declare a field to retain the date and time of previous login.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set the date and time of previous login assigned as an argument in the field.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method to return the retained date and time of previous login</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.userdetails</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoggedInUserDetailsService</span> <span class="kd">implements</span> <span class="n">UserDetailsService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">AccountSharedService</span> <span class="n">accountSharedService</span><span class="o">;</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span>
                <span class="kd">throws</span> <span class="n">UsernameNotFoundException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">accountSharedService</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">SimpleGrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">Role</span> <span class="n">role</span> <span class="o">:</span> <span class="n">account</span><span class="o">.</span><span class="na">getRoles</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">authorities</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">SimpleGrantedAuthority</span><span class="o">(</span><span class="s">&quot;ROLE_&quot;</span>
                                    <span class="o">+</span> <span class="n">role</span><span class="o">.</span><span class="na">getRoleValue</span><span class="o">()));</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">LoggedInUser</span><span class="o">(</span><span class="n">account</span><span class="o">,</span>
                            <span class="n">accountSharedService</span><span class="o">.</span><span class="na">isLocked</span><span class="o">(</span><span class="n">username</span><span class="o">),</span>
                            <span class="n">accountSharedService</span><span class="o">.</span><span class="na">getLastLoginDate</span><span class="o">(</span><span class="n">username</span><span class="o">),</span> <span class="c1">// (1)</span>
                            <span class="n">authorities</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ResourceNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">UsernameNotFoundException</span><span class="o">(</span><span class="s">&quot;user not found&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch date and time of previous login by calling Service method and pass it to constructor of <code class="docutils literal"><span class="pre">LoggedInUser</span></code> .</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Implement application layer to display date and time of previous login on the top screen.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.welcome</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HomeController</span> <span class="o">{</span>

   <span class="nd">@Inject</span>
   <span class="n">AccountSharedService</span> <span class="n">accountSharedService</span><span class="o">;</span>

   <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="o">{</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span>
           <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span> <span class="o">})</span>
   <span class="kd">public</span> <span class="n">String</span> <span class="nf">home</span><span class="o">(</span><span class="nd">@AuthenticationPrincipal</span> <span class="n">LoggedInUser</span> <span class="n">userDetails</span><span class="o">,</span> <span class="c1">// (1)</span>
           <span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>

       <span class="c1">// omitted</span>

       <span class="n">LocalDateTime</span> <span class="n">lastLoginDate</span> <span class="o">=</span> <span class="n">userDetails</span><span class="o">.</span><span class="na">getLastLoginDate</span><span class="o">();</span> <span class="c1">// (2)</span>
       <span class="k">if</span> <span class="o">(</span><span class="n">lastLoginDate</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
           <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;lastLoginDate&quot;</span><span class="o">,</span> <span class="n">lastLoginDate</span>
                   <span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">DateTimeFormatter</span><span class="o">.</span><span class="na">ofPattern</span><span class="o">(</span><span class="s">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="o">)));</span> <span class="c1">// (3)</span>
       <span class="o">}</span>

       <span class="k">return</span> <span class="s">&quot;welcome/home&quot;</span><span class="o">;</span>

   <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch UserDetails object by using <code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code> .</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch date and time of last login from <code class="docutils literal"><span class="pre">LoggedInUserDetails</span></code> .</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Format date and time of last login, set it in Model and pass to View.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>Top screen(home.jsp)</strong></p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>

      <span class="c">&lt;!-- omitted --&gt;</span>

      <span class="nt">&lt;c:if</span> <span class="na">test=</span><span class="s">&quot;${!empty lastLoginDate}&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
          <span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">&quot;lastLogin&quot;</span><span class="nt">&gt;</span>
              Last login date is ${f:h(lastLoginDate)}. <span class="c">&lt;!-- (2) --&gt;</span>
          <span class="nt">&lt;/p&gt;</span>
      <span class="nt">&lt;/c:if&gt;</span>

      <span class="c">&lt;!-- omitted --&gt;</span>

  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Do not display if date and time of previous login is null.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Display the date and time of previous login passed from the Controller.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
</div>
<div class="section" id="creating-authentication-information-for-password-reissue">
<span id="reissue-info-create"></span><h3><a class="toc-backref" href="#id77">9.10.3.5. Creating authentication information for password reissue</a><a class="headerlink" href="#creating-authentication-information-for-password-reissue" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id14">
<h4><a class="toc-backref" href="#id78">9.10.3.5.1. List of requirements to be implemented</a><a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference internal" href="#sec-requirements"><span class="std std-ref">Assign random string to the URL for password reissue</span></a></li>
<li><a class="reference internal" href="#sec-requirements"><span class="std std-ref">Issue confidential information for password reissue</span></a></li>
</ul>
</div>
<div class="section" id="id15">
<h4><a class="toc-backref" href="#id79">9.10.3.5.2. Working image</a><a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h4>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_password_reissue_generate.png"><img alt="Generate Password Reissue Information" src="../_images/SecureLogin_password_reissue_generate.png" style="width: 80%;" /></a>
</div>
<p>Enter the user name for which password is to be reissued on the screen to generate authentication information for password reissue. At this time, the confidential information and token to be used for authentication during password reissue, are generated.
Confidential information is displayed on the screen and the URL for password reissue screen containing the token is sent to the registered e-mail address of the user.</p>
<p>There is an expiry date to the URL sent by e-mail. Password can be changed by accessing the URL within the expiry date and entering the confidential information and the new password.
If the URL sent by e-mail is accessed after the expiry date, the user is taken to the error screen.</p>
<p>Confidential information and token generation is described from the flow mentioned above.</p>
</div>
<div class="section" id="id16">
<h4><a class="toc-backref" href="#id80">9.10.3.5.3. Implementation method</a><a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">While reissuing the password, an alternative to password is required to verify that the user is the owner of the account.</div>
<div class="line">In this application, URL of password reissue screen and confidential information are used as the information to verify the user.</div>
<div class="line">Create a random string and add it to URL to make the password reissue screen URL unique and difficult to guess. Create confidential information which is in the form of a random string and use it for authentication as a measure against accidental leakage of URL.</div>
<div class="line">Create two random strings by different ways so that it becomes impossible to guess a string from the other string.</div>
<div class="line">In particular, fulfil the requirements by implementing the following process.</div>
</div>
<ul>
<li><p class="first">Creating and saving authentication information for password reissue</p>
<p>Store the following information as the authentication information for password reissue in the database.</p>
<ul class="simple">
<li>User name: User name of the account for which password is to be reissued</li>
<li>Token: Random string generated to make the password reissue screen URL unique and difficult to guess</li>
<li>Confidential information: Random string generated for user input at the time of password reissue</li>
<li>Expiry date: Expiry date for authentication information for password reissue</li>
</ul>
<p>Use <code class="docutils literal"><span class="pre">randomUUID</span></code>  method of <code class="docutils literal"><span class="pre">java.util.UUID</span></code>  class for token generation and Password generation function of Passay for generating confidential information.</p>
<p>Save the confidential information to the database by hashing similar to password.
Expiry date settings and confirmation process are described in <a class="reference internal" href="#reissue-info-validate"><span class="std std-ref">Validation at the time of executing password reissue</span></a>.
Refer to <a class="reference internal" href="#reissue-info-delivery"><span class="std std-ref">Distribute authentication information for password reissue</span></a> for the method to distribute authentication information for password reissue to the user.</p>
</li>
</ul>
</div>
<div class="section" id="id17">
<h4><a class="toc-backref" href="#id81">9.10.3.5.4. Code description</a><a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">Common part</p>
<p>In the implementation according to the implementation method mentioned above, the process to register and search the authentication information for password reissue in the database is commonly required.
Therefore, implementation of Entity and Repository related to the authentication information for password reissue is described first.</p>
<ul>
<li><p class="first">Creation of Entity</p>
<p>Create an Entity of authentication information for password reissue.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.model</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueInfo</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">token</span><span class="o">;</span> <span class="c1">// (2)</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">secret</span><span class="o">;</span> <span class="c1">// (3)</span>

    <span class="kd">private</span> <span class="n">LocalDateTime</span> <span class="n">expiryDate</span><span class="o">;</span> <span class="c1">// (4)</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">User name for password reissue</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">String that is generated to be included in the URL for password reissue (Token）</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">String to verify the user at the time of password reissue (Confidential information）</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Expiry date for authentication information for password reissue</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Implementation of Repository</p>
<p>Repository to search, register and delete the authentication information for password reissue is shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.repository.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PasswordReissueInfoRepository</span> <span class="o">{</span>

    <span class="kt">void</span> <span class="nf">create</span><span class="o">(</span><span class="n">PasswordReissueInfo</span> <span class="n">info</span><span class="o">);</span> <span class="c1">// (1)</span>

    <span class="n">PasswordReissueInfo</span> <span class="nf">findOne</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;token&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">token</span><span class="o">);</span> <span class="c1">// (2)</span>

    <span class="kt">int</span> <span class="nf">delete</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;token&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">token</span><span class="o">);</span> <span class="c1">// (3)</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
</li>
</ul>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method to register <code class="docutils literal"><span class="pre">PasswordReissueInfo</span></code> object that is assigned as an argument, as a record in the database</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method to search and fetch <code class="docutils literal"><span class="pre">PasswordReissueInfo</span></code> object by considering the token assigned as an argument, as the key</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method to delete <code class="docutils literal"><span class="pre">PasswordReissueInfo</span></code> object by considering the token assigned as an argument, as the key</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Mapping file is as below.</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>

<span class="nt">&lt;mapper</span>
    <span class="na">namespace=</span><span class="s">&quot;org.terasoluna.securelogin.domain.repository.passwordreissue.PasswordReissueInfoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;PasswordReissueInfoResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;PasswordReissueInfo&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;username&quot;</span> <span class="na">column=</span><span class="s">&quot;username&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;token&quot;</span> <span class="na">column=</span><span class="s">&quot;token&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;secret&quot;</span> <span class="na">column=</span><span class="s">&quot;secret&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;expiryDate&quot;</span> <span class="na">column=</span><span class="s">&quot;expiry_date&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/resultMap&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;PasswordReissueInfoResultMap&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;![CDATA[</span>
<span class="cp">        SELECT</span>
<span class="cp">            username,</span>
<span class="cp">            token,</span>
<span class="cp">            secret,</span>
<span class="cp">            expiry_date</span>
<span class="cp">        FROM</span>
<span class="cp">            password_reissue_info</span>
<span class="cp">        WHERE</span>
<span class="cp">            token = #{token}</span>
<span class="cp">    ]]&gt;</span>
    <span class="nt">&lt;/select&gt;</span>

    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;create&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;PasswordReissueInfo&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;![CDATA[</span>
<span class="cp">        INSERT INTO password_reissue_info (</span>
<span class="cp">            username,</span>
<span class="cp">            token,</span>
<span class="cp">            secret,</span>
<span class="cp">            expiry_date</span>
<span class="cp">        ) VALUES (</span>
<span class="cp">            #{username},</span>
<span class="cp">            #{token},</span>
<span class="cp">            #{secret},</span>
<span class="cp">            #{expiryDate}</span>
<span class="cp">        )</span>
<span class="cp">    ]]&gt;</span>
    <span class="nt">&lt;/insert&gt;</span>

    <span class="nt">&lt;delete</span> <span class="na">id=</span><span class="s">&quot;delete&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;![CDATA[</span>
<span class="cp">        DELETE FROM</span>
<span class="cp">            password_reissue_info</span>
<span class="cp">        WHERE</span>
<span class="cp">            token = #{token}</span>
<span class="cp">    ]]&gt;</span>
    <span class="nt">&lt;/delete&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>The code implemented according to the implementation method is described below.</p>
<ul>
<li><p class="first">Generating and storing authentication information for password reissue</p>
<ul>
<li><p class="first">Definition of password generator</p>
<p>The definition of password generator and generation rules to use the password generation function of Passay is shown below.
Refer to <a class="reference internal" href="#password-generation"><span class="std std-ref">Password generation</span></a> for the password generator and generation rules.</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for password generator to be used in password generation function of Passay</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for password generation rules to be used in password generation function of Passay. Using the validation rules that were used in <a class="reference internal" href="#password-strength"><span class="std std-ref">Check password strength</span></a>, define generation rules for the password containing one or more characters of single-byte upper case letters, single-byte lower case letters and single-byte digits respectively.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>applicationContext.xml</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;passwordGenerator&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.PasswordGenerator&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;util:list</span> <span class="na">id=</span><span class="s">&quot;passwordGenerationRules&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;upperCaseRule&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;lowerCaseRule&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;digitRule&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/util:list&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first">Implementation of Service</p>
<p>The implementation of the process to create authentication information for password reissue and store in the database is shown below. The authentication information generated in this process is sent by e-mail. Sending the information by e-mail is omitted here as it is described later.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueServiceImpl</span> <span class="kd">implements</span> <span class="n">PasswordReissueService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ClassicDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordReissueInfoRepository</span> <span class="n">passwordReissueInfoRepository</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">AccountSharedService</span> <span class="n">accountSharedService</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordGenerator</span> <span class="n">passwordGenerator</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="nd">@Resource</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;passwordGenerationRules&quot;</span><span class="o">)</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">CharacterRule</span><span class="o">&gt;</span> <span class="n">passwordGenerationRules</span><span class="o">;</span> <span class="c1">//(2)</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${security.tokenLifeTimeSeconds}&quot;</span><span class="o">)</span>
    <span class="kt">int</span> <span class="n">tokenLifeTimeSeconds</span><span class="o">;</span> <span class="c1">// (3)</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createAndSendReissueInfo</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">String</span> <span class="n">rowSecret</span> <span class="o">=</span> <span class="n">passwordGenerator</span><span class="o">.</span><span class="na">generatePassword</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="n">passwordGenerationRules</span><span class="o">);</span> <span class="c1">// (4)</span>

        <span class="k">if</span><span class="o">(!</span><span class="n">accountSharedService</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">username</span><span class="o">)){</span> <span class="c1">// (5)</span>
            <span class="k">return</span> <span class="n">rowSecret</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">Account</span> <span class="n">account</span><span class="o">=</span> <span class="n">accountSharedService</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">username</span><span class="o">);</span> <span class="c1">// (6)</span>

        <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span> <span class="c1">// (7)</span>

        <span class="n">LocalDateTime</span> <span class="n">expiryDate</span> <span class="o">=</span> <span class="n">dateFactory</span><span class="o">.</span><span class="na">newTimestamp</span><span class="o">().</span><span class="na">toLocalDateTime</span><span class="o">()</span>
                <span class="o">.</span><span class="na">plusSeconds</span><span class="o">(</span><span class="n">tokenLifeTimeSeconds</span><span class="o">);</span> <span class="c1">// (8)</span>

        <span class="n">PasswordReissueInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PasswordReissueInfo</span><span class="o">();</span> <span class="c1">// (9)</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setSecret</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">rowSecret</span><span class="o">));</span> <span class="c1">// (10)</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setExpiryDate</span><span class="o">(</span><span class="n">expiryDate</span><span class="o">);</span>

        <span class="n">passwordReissueInfoRepository</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">info</span><span class="o">);</span> <span class="c1">// (11)</span>

        <span class="c1">// omitted (Send E-Mail)</span>

        <span class="k">return</span> <span class="n">rowSecret</span><span class="o">;</span> <span class="c1">// (12)</span>

    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inject a password generator to be used in password generation function of Passay.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inject password generation rules to be used in password generation function of Passay.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the length of the period for which authentication information for password reissue is valid, in seconds. The value defined in the property file is injected.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create a random string of length 10 in accordance with the password generation rules using the password generation function of Passay to use as confidential information.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Check whether the account of user name that is passed as an argument, exists. If it does not exist, return dummy confidential information since non-existence of the user is not known.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch the account information of the user name included in the authentication information for password reissue.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create a random string using <code class="docutils literal"><span class="pre">randomUUID</span></code>  method of <code class="docutils literal"><span class="pre">java.util.UUID</span></code>  class to use as a token.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">By adding the value of (3) to current time, calculate expiry date for the authentication information for password reissue.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create authentication information for password reissue and set the user name, token, confidential information and expiry date.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set confidential information in <code class="docutils literal"><span class="pre">PasswordReissueInfo</span></code>  after hashing it.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Register the authentication information for password reissue in the database.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Return the created confidential information.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Implementation of Form</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CreateReissueInfoForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="nd">@NotEmpty</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Implementation of View</p>
<p><strong>Screen to create authentication information for password reissue(createReissueInfoForm.xml)</strong></p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Reissue password<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;t:messagesPanel</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:form</span>
            <span class="na">action=</span><span class="s">&quot;${f:h(pageContext.request.contextPath)}/reissue/create&quot;</span>
            <span class="na">method=</span><span class="s">&quot;POST&quot;</span> <span class="na">modelAttribute=</span><span class="s">&quot;createReissueInfoForm&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;table&gt;</span>
                <span class="nt">&lt;tr&gt;</span>
                    <span class="nt">&lt;th&gt;&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;username&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Username<span class="nt">&lt;/form:label&gt;</span>
                    <span class="nt">&lt;/th&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;username&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;username&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;/table&gt;</span>

            <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;submit&quot;</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Reissue password&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/form:form&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first">Implementation of Controller</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/reissue&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueController</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordReissueService</span> <span class="n">passwordReissueService</span><span class="o">;</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">showCreateReissueInfoForm</span><span class="o">(</span><span class="n">CreateReissueInfoForm</span> <span class="n">form</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;passwordreissue/createReissueInfoForm&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createReissueInfo</span><span class="o">(</span><span class="nd">@Validated</span> <span class="n">CreateReissueInfoForm</span> <span class="n">form</span><span class="o">,</span>
            <span class="n">BindingResult</span> <span class="n">bindingResult</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">,</span>
            <span class="n">RedirectAttributes</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">bindingResult</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">showCreateReissueInfoForm</span><span class="o">(</span><span class="n">form</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">String</span> <span class="n">rawSecret</span> <span class="o">=</span> <span class="n">passwordReissueService</span><span class="o">.</span><span class="na">createAndSendReissueInfo</span><span class="o">(</span><span class="n">form</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span> <span class="c1">// (1)</span>
        <span class="n">attributes</span><span class="o">.</span><span class="na">addFlashAttribute</span><span class="o">(</span><span class="s">&quot;secret&quot;</span><span class="o">,</span> <span class="n">rawSecret</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">&quot;redirect:/reissue/create?complete&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;complete&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createReissueInfoComplete</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;passwordreissue/createReissueInfoComplete&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create authentication information for password reissue from the user name fetched from Form and call the process registered in the database.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="distribution-of-authentication-information-for-password-reissue">
<span id="reissue-info-delivery"></span><h3><a class="toc-backref" href="#id82">9.10.3.6. Distribution of authentication information for password reissue</a><a class="headerlink" href="#distribution-of-authentication-information-for-password-reissue" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id18">
<h4><a class="toc-backref" href="#id83">9.10.3.6.1. List of requirements to be implemented</a><a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference internal" href="#sec-requirements"><span class="std std-ref">Separate distribution for password reissue screen URL and confidential information</span></a></li>
<li><a class="reference internal" href="#sec-requirements"><span class="std std-ref">Send e-mail for URL of password reissue screen</span></a></li>
</ul>
</div>
<div class="section" id="id19">
<h4><a class="toc-backref" href="#id84">9.10.3.6.2. Working image</a><a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h4>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_password_reissue_give.png"><img alt="Give Password Reissue Information" src="../_images/SecureLogin_password_reissue_give.png" style="width: 80%;" /></a>
</div>
<p>Creation of authentication information for password reissue is described in <a class="reference internal" href="#reissue-info-create"><span class="std std-ref">Creating authentication information for password reissue</span></a>.
The distribution of the created authentication information is described here.</p>
<p>Perform the authentication for password reissue using the password reissue screen URL and confidential information.
Distribute the information to the user using different methods to prevent the leakage of the information at the same time.
In this application, URL of the password reissue screen is sent to the registered e-mail address of the user, and confidential information is displayed on the screen.</p>
</div>
<div class="section" id="id20">
<h4><a class="toc-backref" href="#id85">9.10.3.6.3. Implementation method</a><a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Split the authentication information created using <a class="reference internal" href="#reissue-info-create"><span class="std std-ref">Create authentication information for password reissue</span></a> and distribute to the user using separate methods.</div>
<div class="line">Fulfil the requirements by implementing and using the following two processes.</div>
</div>
<ul>
<li><p class="first">Display confidential information on screen</p>
<p>Distribute the confidential information before hashing that is created using <a class="reference internal" href="#reissue-info-create"><span class="std std-ref">Create authentication information for password reissue</span></a> to the user by displaying it on the screen.</p>
</li>
<li><p class="first">Send an e-mail for URL of password reissue screen</p>
<p>Send the URL of password reissue screen including token that is created using <a class="reference internal" href="#reissue-info-create"><span class="std std-ref">Create authentication information for password reissue</span></a> by e-mail using the component for Spring Framework Mail linkage.</p>
</li>
</ul>
</div>
<div class="section" id="id21">
<h4><a class="toc-backref" href="#id86">9.10.3.6.4. Code description</a><a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h4>
<p>The code implemented according to the above implementation method is described sequentially.</p>
<ul>
<li><p class="first">Displaying confidential information on screen</p>
<p>A series of implementations to call the process to create confidential information from the Controller and display it in View is shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/reissue&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueController</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordReissueService</span> <span class="n">passwordReissueService</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createReissueInfo</span><span class="o">(</span><span class="nd">@Validated</span> <span class="n">CreateReissueInfoForm</span> <span class="n">form</span><span class="o">,</span>
            <span class="n">BindingResult</span> <span class="n">bindingResult</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">,</span>
            <span class="n">RedirectAttributes</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">bindingResult</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">showCreateReissueInfoForm</span><span class="o">(</span><span class="n">form</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">String</span> <span class="n">rawSecret</span> <span class="o">=</span> <span class="n">passwordReissueService</span><span class="o">.</span><span class="na">createAndSendReissueInfo</span><span class="o">(</span><span class="n">form</span>
                <span class="o">.</span><span class="na">getUsername</span><span class="o">());</span> <span class="c1">// (1)</span>
        <span class="n">attributes</span><span class="o">.</span><span class="na">addFlashAttribute</span><span class="o">(</span><span class="s">&quot;secret&quot;</span><span class="o">,</span> <span class="n">rawSecret</span><span class="o">);</span> <span class="c1">// (2)</span>
        <span class="k">return</span> <span class="s">&quot;redirect:/reissue/create?complete&quot;</span><span class="o">;</span> <span class="c1">// (3)</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;complete&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createReissueInfoComplete</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;passwordreissue/createReissueInfoComplete&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call the process to create confidential information.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Using RedirectAttributes, pass the confidential information to the redirect destination.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Redirect to completion screen of authentication information for password reissue.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>Screen to complete creation of authentication information for password reissue(createReissueInfoComplete.jsp)</strong></p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Your Password Reissue URL was successfully generated.<span class="nt">&lt;/h1&gt;</span>
        The URL was sent to your registered E-mail address.<span class="nt">&lt;br</span> <span class="nt">/&gt;</span> Please
        access the URL and enter the secret shown below.
        <span class="nt">&lt;h3&gt;</span>Secret : <span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">secret</span><span class="nt">&gt;</span>${f:h(secret)}<span class="nt">&lt;/span&gt;&lt;/h3&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Display confidential information on the screen.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Send a mail for URL of password reissue screen</p>
<p>The implementation of the process to create URL of password reissue screen from the authentication information for password reissue screen and send it by e-mail is shown below.
Refer to <a class="reference internal" href="../ArchitectureInDetail/MessagingDetail/Email.html"><span class="doc">Sending E-mail (SMTP)</span></a> for more information about how to add dependent libraries and how to fetch an e-mail session.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.mail</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueMailSharedServiceImpl</span> <span class="kd">implements</span>
        <span class="n">PasswordReissueMailSharedService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">JavaMailSender</span> <span class="n">mailSender</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="o">(</span><span class="s">&quot;passwordReissueMessage&quot;</span><span class="o">)</span>
    <span class="n">SimpleMailMessage</span> <span class="n">templateMessage</span><span class="o">;</span> <span class="c1">// (2)</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">send</span><span class="o">(</span><span class="n">String</span> <span class="n">to</span><span class="o">,</span> <span class="n">String</span> <span class="n">text</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SimpleMailMessage</span> <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleMailMessage</span><span class="o">(</span><span class="n">templateMessage</span><span class="o">);</span> <span class="c1">// (3)</span>
        <span class="n">message</span><span class="o">.</span><span class="na">setTo</span><span class="o">(</span><span class="n">to</span><span class="o">);</span>
        <span class="n">message</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">text</span><span class="o">);</span>
        <span class="n">mailSender</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inject a Bean for <code class="docutils literal"><span class="pre">org.springframework.mail.javamail.JavaMailSender</span></code> .</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inject a Bean for <code class="docutils literal"><span class="pre">org.springframework.mail.SimpleMailMessage</span></code>  in which email address of the source and e-mail title are set.</div>
<div class="line">In this application, only one Bean is defined for <code class="docutils literal"><span class="pre">SimpleMailMessage</span></code> , however, since multiple Beans are generally defined as a mail template, Bean name is specified by <code class="docutils literal"><span class="pre">&#64;Named</span></code> .</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create an instance of <code class="docutils literal"><span class="pre">SimpleMailMessage</span></code>  from the template, set the destination email address and text assigned as arguments and send.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueServiceImpl</span> <span class="kd">implements</span> <span class="n">PasswordReissueService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ClassicDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordReissueMailSharedService</span> <span class="n">mailSharedService</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">AccountSharedService</span> <span class="n">accountSharedService</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${security.tokenLifeTimeSeconds}&quot;</span><span class="o">)</span>
    <span class="kt">int</span> <span class="n">tokenLifeTimeSeconds</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${app.applicationBaseUrl}&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="n">String</span> <span class="n">baseUrl</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${app.passwordReissueProtocol}&quot;</span><span class="o">)</span>
    <span class="n">String</span> <span class="n">protocol</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createAndSendReissueInfo</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">String</span> <span class="n">rowSecret</span> <span class="o">=</span> <span class="n">passwordGenerator</span><span class="o">.</span><span class="na">generatePassword</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span>
                <span class="n">passwordGenerationRules</span><span class="o">);</span>

        <span class="k">if</span><span class="o">(!</span><span class="n">accountSharedService</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">username</span><span class="o">)){</span>
            <span class="k">return</span> <span class="n">rowSecret</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">Account</span> <span class="n">account</span><span class="o">=</span> <span class="n">accountSharedService</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>

        <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>

        <span class="n">LocalDateTime</span> <span class="n">expiryDate</span> <span class="o">=</span> <span class="n">dateFactory</span><span class="o">.</span><span class="na">newTimestamp</span><span class="o">().</span><span class="na">toLocalDateTime</span><span class="o">()</span>
                <span class="o">.</span><span class="na">plusSeconds</span><span class="o">(</span><span class="n">tokenLifeTimeSeconds</span><span class="o">);</span>

        <span class="n">PasswordReissueInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PasswordReissueInfo</span><span class="o">();</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setSecret</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">rowSecret</span><span class="o">));</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setExpiryDate</span><span class="o">(</span><span class="n">expiryDate</span><span class="o">);</span>

        <span class="n">passwordReissueInfoRepository</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">info</span><span class="o">);</span>

        <span class="n">UriComponentsBuilder</span> <span class="n">uriBuilder</span> <span class="o">=</span> <span class="n">UriComponentsBuilder</span><span class="o">.</span><span class="na">fromUriString</span><span class="o">(</span><span class="n">baseUrl</span><span class="o">);</span>
        <span class="n">uriBuilder</span><span class="o">.</span><span class="na">pathSegment</span><span class="o">(</span><span class="s">&quot;reissue&quot;</span><span class="o">).</span><span class="na">pathSegment</span><span class="o">(</span><span class="s">&quot;resetpassword&quot;</span><span class="o">)</span>
                <span class="o">.</span><span class="na">queryParam</span><span class="o">(</span><span class="s">&quot;form&quot;</span><span class="o">).</span><span class="na">queryParam</span><span class="o">(</span><span class="s">&quot;token&quot;</span><span class="o">,</span> <span class="n">info</span><span class="o">.</span><span class="na">getToken</span><span class="o">());</span>  <span class="c1">// (2)</span>
        <span class="n">String</span> <span class="n">passwordResetUrl</span> <span class="o">=</span> <span class="n">uriBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">().</span><span class="na">encode</span><span class="o">().</span><span class="na">toUriString</span><span class="o">();</span>

        <span class="n">mailSharedService</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">getEmail</span><span class="o">(),</span> <span class="n">passwordResetUrl</span><span class="o">);</span> <span class="c1">// (3)</span>

        <span class="k">return</span> <span class="n">rowSecret</span><span class="o">;</span>

    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch the base URL to be used in the password reissue screen URL from the property file.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Using the value fetched in (1) and the token included in the created authentication information for password reissue, create the URL of password reissue screen to be distributed to the user.</div>
<div class="line">Use <code class="docutils literal"><span class="pre">org.springframework.web.util.UriComponentsBuilder</span></code>  to create the URL. <code class="docutils literal"><span class="pre">UriComponentsBuilder</span></code>  is described in <a class="reference internal" href="../ArchitectureInDetail/WebServiceDetail/REST.html#restappendixhypermedialink"><span class="std std-ref">Implementing hypermedia link</span></a>.</div>
<div class="line">In the above example, the path of the created URL is “reissue/resetpassword?form&amp;token=512f1a33-da20-4b9f-9e26-8961e9071618”. (The token part is randomly generated.)</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Send an email with the URL of the password reissue screen mentioned in the mail text to the registered e-mail address of the user.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
</div>
<div class="section" id="validation-at-the-time-of-executing-password-reissue">
<span id="reissue-info-validate"></span><h3><a class="toc-backref" href="#id87">9.10.3.7. Validation at the time of executing password reissue</a><a class="headerlink" href="#validation-at-the-time-of-executing-password-reissue" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id22">
<h4><a class="toc-backref" href="#id88">9.10.3.7.1. List of requirements to be implemented</a><a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference internal" href="#sec-requirements"><span class="std std-ref">Setting validity period for authentication information for password reissue</span></a></li>
</ul>
</div>
<div class="section" id="id23">
<h4><a class="toc-backref" href="#id89">9.10.3.7.2. Working image</a><a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h4>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_password_reissue_execute.png"><img alt="Use Password Reissue Information" src="../_images/SecureLogin_password_reissue_execute.png" style="width: 80%;" /></a>
</div>
<p>The distribution of authentication information for password reissue is described in <a class="reference internal" href="#reissue-info-delivery"><span class="std std-ref">Distribution of authentication information for password reissue</span></a>.
The process for using the distributed authentication information is described below.</p>
<p>As the authentication at the time of password reissue, verify the confidential information and URL of password reissue screen distributed separately in <a class="reference internal" href="#reissue-info-delivery"><span class="std std-ref">Distribution of authentication information for password reissue</span></a>.
Password is reissued only if the set of token and confidential information that is included in the URL is correct.</p>
<p>Moreover, set expiry date to the authentication information so that it is not valid for a long period of time unnecessarily as generally password is reissued immediately after the creation of authentication information.
When the URL for password reissue screen is accessed, password reissue screen is displayed if the authentication information is within the expiry date and transits to error screen after the expiry date.</p>
</div>
<div class="section" id="id24">
<h4><a class="toc-backref" href="#id90">9.10.3.7.3. Implementation method</a><a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Token is included as a request parameter in the URL for password reissue screen sent by e-mail. Fetch the token when the password reissue screen is accessed and search the authentication information for password reissue from the database by considering this token as the key.</div>
<div class="line">At the time of creating authentication information, set the expiry date in advance and check for expiration when it is obtained from the database. If it is within the expiry date, display the change password screen and accept the input for confidential information and new password.</div>
<div class="line">If confidential information in the authentication information obtained from the database and the confidential information entered by the user are identical, then authentication is successful and password is reissued.</div>
<div class="line">In particular, fulfil the requirements by implementing the following three processes.</div>
</div>
<ul>
<li><p class="first">Setting expiry date for authentication information for password reissue</p>
<p>Set expiry date to the authentication information created in the process described in <a class="reference internal" href="#reissue-info-create"><span class="std std-ref">Creating authentication information for password reissue</span></a>.</p>
</li>
<li><p class="first">Check expiry date for authentication information for password reissue</p>
<p>When the password reissue screen is accessed, fetch the token included in the request parameter and search the authentication information for password reissue stored in the database considering the token as the key.
Compare the expiry date included in authentication information with current time and after expiry date, transit to the error screen.</p>
</li>
<li><p class="first">User verification using authentication information for password reissue</p>
<p>When reissuing the password, check whether the combination of user name, token and the confidential information provided by the user and the authentication information in the database are identical.
If they are identical, reissue the password. If they are not identical, display the error message.</p>
</li>
</ul>
</div>
<div class="section" id="id25">
<h4><a class="toc-backref" href="#id91">9.10.3.7.4. Code description</a><a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">Setting expiry date for authentication information for password reissue</p>
<p>The settings for expiry date to the authentication information for password reissue are included in the process described in <a class="reference internal" href="#reissue-info-create"><span class="std std-ref">Creating authentication information for password reissue</span></a>. Here, only relevant implementation points are shown again.</p>
<ul>
<li><p class="first">Implementation of Service</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueServiceImpl</span> <span class="kd">implements</span> <span class="n">PasswordReissueService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ClassicDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordReissueInfoRepository</span> <span class="n">passwordReissueInfoRepository</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${security.tokenLifeTimeSeconds}&quot;</span><span class="o">)</span>
    <span class="kt">int</span> <span class="n">tokenLifeTimeSeconds</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createAndSendReissueInfo</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// omitted</span>

        <span class="n">LocalDateTime</span> <span class="n">expiryDate</span> <span class="o">=</span> <span class="n">dateFactory</span><span class="o">.</span><span class="na">newTimestamp</span><span class="o">().</span><span class="na">toLocalDateTime</span><span class="o">()</span>
                <span class="o">.</span><span class="na">plusSeconds</span><span class="o">(</span><span class="n">tokenLifeTimeSeconds</span><span class="o">);</span> <span class="c1">// (2)</span>

        <span class="n">PasswordReissueInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PasswordReissueInfo</span><span class="o">();</span> <span class="c1">// (3)</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setSecret</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">rowSecret</span><span class="o">));</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setExpiryDate</span><span class="o">(</span><span class="n">expiryDate</span><span class="o">);</span>

        <span class="n">passwordReissueInfoRepository</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">info</span><span class="o">);</span> <span class="c1">// (4)</span>

        <span class="c1">// omitted (Send E-Mail)</span>

    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the length of the period for which authentication information for password reissue is valid, in seconds. The value defined in property file is injected.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">By adding the value of (1) to current time, calculate expiry date for the authentication information for password reissue.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create authentication information for password reissue and set the user name, token, confidential information and expiry date.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Register the authentication information for password reissue in the database.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</li>
<li><p class="first">Check expiry date of authentication information for password reissue</p>
<p>The implementation of the process to fetch authentication information for password reissue from the token included in the URL as a request parameter and check whether it is within the expiry date when the password reissue screen is accessed, is shown below.
In this process, it is also checked whether the maximum limit for password reissue failure has exceeded. However, it is omitted here and will be described later.</p>
<ul>
<li><p class="first">Implementation of Service</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueServiceImpl</span> <span class="kd">implements</span> <span class="n">PasswordReissueService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ClassicDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordReissueInfoRepository</span> <span class="n">passwordReissueInfoRepository</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Override</span>
    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">PasswordReissueInfo</span> <span class="nf">findOne</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">PasswordReissueInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="n">passwordReissueInfoRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">token</span><span class="o">);</span> <span class="c1">// (1)</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">info</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">ResourceNotFoundException</span><span class="o">(</span><span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">().</span><span class="na">add</span><span class="o">(</span>
                    <span class="n">MessageKeys</span><span class="o">.</span><span class="na">E_SL_PR_5002</span><span class="o">,</span> <span class="n">token</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">dateFactory</span><span class="o">.</span><span class="na">newTimestamp</span><span class="o">().</span><span class="na">toLocalDateTime</span><span class="o">()</span>
                 <span class="o">.</span><span class="na">isAfter</span><span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="na">getExpiryDate</span><span class="o">()))</span> <span class="o">{</span> <span class="c1">// (2)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="o">(</span><span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">().</span><span class="na">add</span><span class="o">(</span>
                    <span class="n">MessageKeys</span><span class="o">.</span><span class="na">E_SL_PR_2001</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="c1">// omitted (attempts exceeded upper bounds)</span>

        <span class="k">return</span> <span class="n">info</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch authentication information for password reissue from the database by considering the token assigned as an argument, as the key.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">After the expiry date, throw <code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.exception.BusinessException</span></code> .</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Implementation of Controller</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/reissue&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueController</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordReissueService</span> <span class="n">passwordReissueService</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;resetpassword&quot;</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">showPasswordResetForm</span><span class="o">(</span><span class="n">PasswordResetForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">,</span>
            <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;token&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (1)</span>

        <span class="n">PasswordReissueInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="n">passwordReissueService</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">token</span><span class="o">);</span> <span class="c1">// (3)</span>

        <span class="n">form</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
        <span class="n">form</span><span class="o">.</span><span class="na">setToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;passwordResetForm&quot;</span><span class="o">,</span> <span class="n">form</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">&quot;passwordreissue/passwordResetForm&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch the token included as a request parameter in the URL for password reissue screen.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call the Service method by passing the token in it. Authentication information is fetched from the database and expiry date is checked.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</li>
<li><p class="first">User verification using authentication information for password reissue</p>
<p>The implementation of the process to confirm whether the set of confidential information entered by the user on the password reissue screen and the token included in the URL of the password reissue screen is correct, is shown below.
This confirmation process is a password reissue-specific logic. Since it is a check in which the results vary depending on the contents of the database, it is implemented in the Service without using Bean Validation and Spring Validator.</p>
<ul>
<li><p class="first">Implementation of Service</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PasswordReissueService</span> <span class="o">{</span>

    <span class="c1">// omitted</span>

    <span class="kt">boolean</span> <span class="nf">resetPassword</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">token</span><span class="o">,</span> <span class="n">String</span> <span class="n">secret</span><span class="o">,</span> <span class="c1">// (1)</span>
            <span class="n">String</span> <span class="n">rawPassword</span><span class="o">);</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method to set the new password after user verification using user name, token and confidential information assigned as arguments</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueServiceImpl</span> <span class="kd">implements</span> <span class="n">PasswordReissueService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordReissueFailureSharedService</span> <span class="n">passwordReissueFailureSharedService</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordReissueInfoRepository</span> <span class="n">passwordReissueInfoRepository</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">AccountSharedService</span> <span class="n">accountSharedService</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">resetPassword</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">token</span><span class="o">,</span> <span class="n">String</span> <span class="n">secret</span><span class="o">,</span>
            <span class="n">String</span> <span class="n">rawPassword</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">PasswordReissueInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">token</span><span class="o">);</span> <span class="c1">// (1)</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">passwordEncoder</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">secret</span><span class="o">,</span> <span class="n">info</span><span class="o">.</span><span class="na">getSecret</span><span class="o">()))</span> <span class="o">{</span> <span class="c1">// (2)</span>
            <span class="n">passwordReissueFailureSharedService</span><span class="o">.</span><span class="na">resetFailure</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">token</span><span class="o">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="o">(</span><span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">().</span><span class="na">add</span><span class="o">(</span>
                <span class="n">MessageKeys</span><span class="o">.</span><span class="na">E_SL_PR_5003</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">failedPasswordReissueRepository</span><span class="o">.</span><span class="na">deleteByToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="n">passwordReissueInfoRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">token</span><span class="o">);</span> <span class="c1">// (3)</span>

        <span class="k">return</span> <span class="n">accountSharedService</span><span class="o">.</span><span class="na">updatePassword</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">rawPassword</span><span class="o">);</span> <span class="c1">// (4)</span>

    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Using the token assigned as an argument, fetch the authentication information for password reissue from the database. At this time, the expiry date is checked again.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Compare the hashed confidential information included in the authentication information for password reissue with the confidential information given as an argument. If they vary, throw <code class="docutils literal"><span class="pre">BusinessException</span></code> . Password reissue fails in this case.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Delete used authentication information from the database in order to prevent it from being reused.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Update the account password that has user name that was passed as an argument to the specified new password.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Implementation of Form</p>
<p>Since input check other than Null check is covered depending on the annotation assigned to the class, only <code class="docutils literal"><span class="pre">&#64;NotNull</span></code>  is assigned as a single item check.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Data</span>
<span class="nd">@Compare</span><span class="o">(</span><span class="n">left</span> <span class="o">=</span> <span class="s">&quot;newPassword&quot;</span><span class="o">,</span> <span class="n">right</span> <span class="o">=</span> <span class="s">&quot;confirmNewPassword&quot;</span><span class="o">,</span> <span class="n">operator</span> <span class="o">=</span> <span class="n">Compare</span><span class="o">.</span><span class="na">Operator</span><span class="o">.</span><span class="na">EQUAL</span><span class="o">)</span>
<span class="nd">@StrongPassword</span><span class="o">(</span><span class="n">usernamePropertyName</span> <span class="o">=</span> <span class="s">&quot;username&quot;</span><span class="o">,</span> <span class="n">newPasswordPropertyName</span> <span class="o">=</span> <span class="s">&quot;newPassword&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
<span class="nd">@NotReusedPassword</span><span class="o">(</span><span class="n">usernamePropertyName</span> <span class="o">=</span> <span class="s">&quot;username&quot;</span><span class="o">,</span> <span class="n">newPasswordPropertyName</span> <span class="o">=</span> <span class="s">&quot;newPassword&quot;</span><span class="o">)</span> <span class="c1">// (2)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordResetForm</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">token</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">secret</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">newPassword</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">confirmNewPassword</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">An annotation to check the password strength. Refer to <a class="reference internal" href="#password-strength"><span class="std std-ref">Check password strength</span></a> for details.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">An annotation to check reuse of password. Refer to <a class="reference internal" href="#password-strength"><span class="std std-ref">Check password strength</span></a> for details.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Implementation of View</p>
<p><strong>Password reissue screen(passwordResetForm.jsp)</strong></p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Reset Password<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;t:messagesPanel</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:form</span>
            <span class="na">action=</span><span class="s">&quot;${f:h(pageContext.request.contextPath)}/reissue/resetpassword&quot;</span>
            <span class="na">method=</span><span class="s">&quot;POST&quot;</span> <span class="na">modelAttribute=</span><span class="s">&quot;passwordResetForm&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;table&gt;</span>
                <span class="nt">&lt;tr&gt;</span>
                    <span class="nt">&lt;th&gt;&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;username&quot;</span><span class="nt">&gt;</span>Username<span class="nt">&lt;/form:label&gt;&lt;/th&gt;</span>
                    <span class="nt">&lt;td&gt;</span>${f:h(passwordResetForm.username)} <span class="nt">&lt;form:hidden</span>
                            <span class="na">path=</span><span class="s">&quot;username&quot;</span> <span class="na">value=</span><span class="s">&quot;${f:h(passwordResetForm.username)}&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
                    <span class="nt">&lt;/td&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;/tr&gt;</span>
                <span class="nt">&lt;form:hidden</span> <span class="na">path=</span><span class="s">&quot;token&quot;</span> <span class="na">value=</span><span class="s">&quot;${f:h(passwordResetForm.token)}&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
                <span class="nt">&lt;tr&gt;</span>
                    <span class="nt">&lt;th&gt;&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;secret&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Secret<span class="nt">&lt;/form:label&gt;</span>
                    <span class="nt">&lt;/th&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;form:password</span> <span class="na">path=</span><span class="s">&quot;secret&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;secret&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;/tr&gt;</span>
                <span class="nt">&lt;tr&gt;</span>
                    <span class="nt">&lt;th&gt;&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;newPassword&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>New password<span class="nt">&lt;/form:label&gt;</span>
                    <span class="nt">&lt;/th&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;form:password</span> <span class="na">path=</span><span class="s">&quot;newPassword&quot;</span>
                            <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;newPassword&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span>
                            <span class="na">htmlEscape=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;/tr&gt;</span>
                <span class="nt">&lt;tr&gt;</span>
                    <span class="nt">&lt;th&gt;&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;confirmNewPassword&quot;</span>
                            <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>New password(Confirm)<span class="nt">&lt;/form:label&gt;&lt;/th&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;form:password</span> <span class="na">path=</span><span class="s">&quot;confirmNewPassword&quot;</span>
                            <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;confirmNewPassword&quot;</span>
                            <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;/table&gt;</span>

            <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;submit&quot;</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Reset password&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/form:form&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Retain user name as a hidden item.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Retain token as a hidden item.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Prompt the user to enter confidential information for user verification.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>Password reissue screen(passwordResetComplete.jsp)</strong></p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Your password was successfully reset.<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;${f:h(pageContext.request.contextPath)}/&quot;</span><span class="nt">&gt;</span>go to Top<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first">Implementation of Controller</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/reissue&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueController</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordReissueService</span> <span class="n">passwordReissueService</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;resetpassword&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">resetPassword</span><span class="o">(</span><span class="nd">@Validated</span> <span class="n">PasswordResetForm</span> <span class="n">form</span><span class="o">,</span>
            <span class="n">BindingResult</span> <span class="n">bindingResult</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">bindingResult</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">showPasswordResetForm</span><span class="o">(</span><span class="n">form</span><span class="o">,</span> <span class="n">model</span><span class="o">,</span> <span class="n">form</span><span class="o">.</span><span class="na">getToken</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">passwordReissueService</span><span class="o">.</span><span class="na">resetPassword</span><span class="o">(</span><span class="n">form</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span>
                    <span class="n">form</span><span class="o">.</span><span class="na">getToken</span><span class="o">(),</span> <span class="n">form</span><span class="o">.</span><span class="na">getSecret</span><span class="o">(),</span> <span class="n">form</span><span class="o">.</span><span class="na">getNewPassword</span><span class="o">());</span> <span class="c1">// (1)</span>
            <span class="k">return</span> <span class="s">&quot;redirect:/reissue/resetpassword?complete&quot;</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">BusinessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getResultMessages</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">showPasswordResetForm</span><span class="o">(</span><span class="n">form</span><span class="o">,</span> <span class="n">model</span><span class="o">,</span> <span class="n">form</span><span class="o">.</span><span class="na">getToken</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;resetpassword&quot;</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;complete&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">resetPasswordComplete</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;passwordreissue/passwordResetComplete&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Pass the user name, token, confidential information and new password to the method of Service. If the combination of user name, token and confidential information is correct, it is updated to the new password.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="setting-failure-limit-for-the-password-reissue">
<span id="reissue-info-invalidate"></span><h3><a class="toc-backref" href="#id92">9.10.3.8. Setting failure limit for the password reissue</a><a class="headerlink" href="#setting-failure-limit-for-the-password-reissue" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id26">
<h4><a class="toc-backref" href="#id93">9.10.3.8.1. List of requirements to be implemented</a><a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference internal" href="#sec-requirements"><span class="std std-ref">Setting failure limit for password reissue</span></a></li>
</ul>
</div>
<div class="section" id="id27">
<h4><a class="toc-backref" href="#id94">9.10.3.8.2. Working image</a><a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h4>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_invalidate_token.png"><img alt="Page Transition" src="../_images/SecureLogin_invalidate_token.png" style="width: 80%;" /></a>
</div>
<p>Even if URL for password reissue screen is leaked for some reason, password will not be reissued illegally if the confidential information is not leaked.
Since a random value which cannot be guessed easily is used in the confidential information, it is highly unlikely to break the information easily. However, a maximum limit is set for the number of authentication failures to prevent brute force attack.
When the authentication failures for password reissue exceeds the maximum limit, the password reissue for that URL (token) is disabled.</p>
</div>
<div class="section" id="id28">
<h4><a class="toc-backref" href="#id95">9.10.3.8.3. Implementation method</a><a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">In this application, history of password reissue failure is stored in the database as “password reissue failure event” entity and number of failures for password reissue is measured by using the password reissue failure event entity.</div>
<div class="line">When the number of failures is greater than the maximum value set in advance, an exception is thrown when the user tries to access password reissue screen.</div>
<div class="line">In particular, fulfil the requirements by implementing and using following two processes.</div>
</div>
<ul>
<li><p class="first">Storing password reissue failure event entity</p>
<p>When a failure occurs in the user authentication, during the process “Confirmation of user using authentication information for password reissue” in <a class="reference internal" href="#reissue-info-validate"><span class="std std-ref">Validation at the time of executing password reissue</span></a>, set of the token used and failure date and time are registered in the database as password reissue failure event entity.</p>
</li>
<li><p class="first">Throwing an exception at the time of password reissue</p>
<p>When authentication information is fetched from the database for password reissue, number of password reissue failure event entities is measured and an exception is thrown if the number is more than the maximum limit.</p>
</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Since password reissue failure event entity is only intended for measuring number of failures for password reissue, it is deleted when it is no longer required.
When the log at the time of password reissue failure is required, a separate log must always be maintained.</p>
</div>
</div>
<div class="section" id="id29">
<h4><a class="toc-backref" href="#id96">9.10.3.8.4. Code description</a><a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">Common parts</p>
<p>As a prerequisite, each process mentioned in <a class="reference internal" href="#reissue-info-validate"><span class="std std-ref">Validation at the time of executing password reissue</span></a> should be implemented.
Other commonly required implementations related to registration, search and deletion of password reissue failure event entity for the database are shown below.</p>
<ul>
<li><p class="first">Implementation of Entity</p>
<p>Implementation of password reissue failure event entity is shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.model</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FailedPasswordReissue</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">token</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="kd">private</span> <span class="n">LocalDateTime</span> <span class="n">attemptDate</span><span class="o">;</span> <span class="c1">// (2)</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A token used for password reissue</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Date and time when password reissue is attempted</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Implementation of Repository</p>
<p>Repository for search, registration and deletion of Entity is shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.repository.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">FailedPasswordReissueRepository</span> <span class="o">{</span>

    <span class="kt">int</span> <span class="nf">countByToken</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;token&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">token</span><span class="o">);</span> <span class="c1">// (1)</span>

    <span class="kt">int</span> <span class="nf">create</span><span class="o">(</span><span class="n">FailedPasswordReissue</span> <span class="n">event</span><span class="o">);</span> <span class="c1">// (2)</span>

    <span class="kt">int</span> <span class="nf">deleteByToken</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;token&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">token</span><span class="o">);</span> <span class="c1">// (3)</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method which fetches number of <code class="docutils literal"><span class="pre">FailedPasswordReissue</span></code> objects considering token assigned as an argument, as a key.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method which registers <code class="docutils literal"><span class="pre">FailedPasswordReissue</span></code> object assigned as an argument, as the records of the database.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method which deletes <code class="docutils literal"><span class="pre">FailedPasswordReissue</span></code> object considering token assigned as an argument, as a key.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Mapping file is as given below.</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>

<span class="nt">&lt;mapper</span>
 <span class="na">namespace=</span><span class="s">&quot;org.terasoluna.securelogin.domain.repository.passwordreissue.FailedPasswordReissueRepository&quot;</span><span class="nt">&gt;</span>

 <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;countByToken&quot;</span> <span class="na">resultType=</span><span class="s">&quot;_int&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;![CDATA[</span>
<span class="cp">        SELECT</span>
<span class="cp">            COUNT(*)</span>
<span class="cp">        FROM</span>
<span class="cp">            failed_password_reissue</span>
<span class="cp">        WHERE</span>
<span class="cp">            token = #{token}</span>
<span class="cp">    ]]&gt;</span>
 <span class="nt">&lt;/select&gt;</span>

 <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;create&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;FailedPasswordReissue&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;![CDATA[</span>
<span class="cp">        INSERT INTO failed_password_reissue (</span>
<span class="cp">            token,</span>
<span class="cp">            attempt_date</span>
<span class="cp">        ) VALUES (</span>
<span class="cp">         #{token},</span>
<span class="cp">            #{attemptDate}</span>
<span class="cp">        )</span>
<span class="cp">    ]]&gt;</span>
 <span class="nt">&lt;/insert&gt;</span>

 <span class="nt">&lt;delete</span> <span class="na">id=</span><span class="s">&quot;deleteByToken&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;![CDATA[</span>
<span class="cp">     DELETE FROM</span>
<span class="cp">         failed_password_reissue</span>
<span class="cp">     WHERE</span>
<span class="cp">         token = #{token}</span>
<span class="cp">    ]]&gt;</span>
 <span class="nt">&lt;/delete&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
<p>Code implemented in accordance with the implementation method is described here sequentially.</p>
<ul>
<li><p class="first">Storing password reissue failure event entity</p>
<p>A class which implements the process to be carried out at the time of password reissue failure is shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.passwordreissue</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PasswordReissueFailureSharedService</span> <span class="o">{</span>

    <span class="kt">void</span> <span class="nf">resetFailure</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">token</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueFailureSharedServiceImpl</span> <span class="kd">implements</span>
        <span class="n">PasswordReissueFailureSharedService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ClassicDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">FailedPasswordReissueRepository</span> <span class="n">failedPasswordReissueRepository</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="n">Propagation</span><span class="o">.</span><span class="na">REQUIRES_NEW</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">resetFailure</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">FailedPasswordReissue</span> <span class="n">event</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FailedPasswordReissue</span><span class="o">();</span> <span class="c1">// (2)</span>
        <span class="n">event</span><span class="o">.</span><span class="na">setToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="n">event</span><span class="o">.</span><span class="na">setAttemptDate</span><span class="o">(</span><span class="n">dateFactory</span><span class="o">.</span><span class="na">newTimestamp</span><span class="o">().</span><span class="na">toLocalDateTime</span><span class="o">());</span>
        <span class="n">failedPasswordReissueRepository</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">event</span><span class="o">);</span> <span class="c1">// (3)</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It is a method which is called when a failure occurs during password reissue and has been designed to generate a run-time exception in the call source.</div>
<div class="line">Therefore, specify a propagation method in “REQUIRES_NEW” in order to perform transaction management separately from that of call source service.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create password reissue failure event entity and specify token and, failure date and time.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Register password reissue failure event entity created in (2), in database.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Call process at the time of password reissue failure from “Confirmation of user using authentication information for password reissue” process of <a class="reference internal" href="#reissue-info-validate"><span class="std std-ref">Validation at the time of executing password reissue</span></a>.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueServiceImpl</span> <span class="kd">implements</span> <span class="n">PasswordReissueService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordReissueFailureSharedService</span> <span class="n">passwordReissueFailureSharedService</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordReissueInfoRepository</span> <span class="n">passwordReissueInfoRepository</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">AccountSharedService</span> <span class="n">accountSharedService</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">resetPassword</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">token</span><span class="o">,</span> <span class="n">String</span> <span class="n">secret</span><span class="o">,</span>
            <span class="n">String</span> <span class="n">rawPassword</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">PasswordReissueInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">token</span><span class="o">);</span> <span class="c1">// (1)</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">passwordEncoder</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">secret</span><span class="o">,</span> <span class="n">info</span><span class="o">.</span><span class="na">getSecret</span><span class="o">()))</span> <span class="o">{</span> <span class="c1">// (2)</span>
            <span class="n">passwordReissueFailureSharedService</span><span class="o">.</span><span class="na">resetFailure</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">token</span><span class="o">);</span> <span class="c1">// (3)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="o">(</span><span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">().</span><span class="na">add</span><span class="o">(</span>  <span class="c1">// (4)</span>
                <span class="n">MessageKeys</span><span class="o">.</span><span class="na">E_SL_PR_5003</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="c1">//omitted</span>

    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch authentication information for password reissue from the database, using token assigned as an argument.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Compare hashed confidential information included in the authentication information for password reissue and confidential information assigned as an argument.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call a method of SharedService which performs a process at the time of password reissue failure.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A run-time exception is thrown, however since the process at the time of password reissue failure is performed in different transaction, it does not leave any impact.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Throwing an exception at the time of password reissue</p>
<p>Fetching number of failures at the time of password reissue and implementation of process when the number of failures reach the maximum limit are shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueServiceImpl</span> <span class="kd">implements</span> <span class="n">PasswordReissueService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">FailedPasswordReissueRepository</span> <span class="n">failedPasswordReissueRepository</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordReissueInfoRepository</span> <span class="n">passwordReissueInfoRepository</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${security.tokenValidityThreshold}&quot;</span><span class="o">)</span>
    <span class="kt">int</span> <span class="n">tokenValidityThreshold</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Override</span>
    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">PasswordReissueInfo</span> <span class="nf">findOne</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// omitted</span>

        <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">failedPasswordReissueRepository</span> <span class="c1">// (2)</span>
                <span class="o">.</span><span class="na">countByToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">tokenValidityThreshold</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (3)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="o">(</span><span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">().</span><span class="na">add</span><span class="o">(</span>
                    <span class="n">MessageKeys</span><span class="o">.</span><span class="na">E_SL_PR_5004</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">info</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch and set maximum value for number of failures at the time of password reissue, from property file.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch number of password reissue failure event entities from the database, considering token assigned as an argument, as a key.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Compare number of failure event entities at the time of password reissue that has been fetched and maximum limit for number of failures, and throw an exception if it exceeds the maximum limit.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
</div>
<div class="section" id="input-check-validation-for-security">
<span id="secure-input-validation"></span><h3><a class="toc-backref" href="#id97">9.10.3.9. Input check validation for security</a><a class="headerlink" href="#input-check-validation-for-security" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id30">
<h4><a class="toc-backref" href="#id98">9.10.3.9.1. List of requirements to be implemented</a><a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference internal" href="#sec-requirements"><span class="std std-ref">Configuration of common prohibited characters for request parameter</span></a></li>
<li><a class="reference internal" href="#sec-requirements"><span class="std std-ref">Configuration of common prohibited strings for uploaded file name</span></a></li>
<li><a class="reference internal" href="#sec-requirements"><span class="std std-ref">Input check for control characters</span></a></li>
<li><a class="reference internal" href="#sec-requirements"><span class="std std-ref">Input check for file extensions</span></a></li>
<li><a class="reference internal" href="#sec-requirements"><span class="std std-ref">Input check for file names</span></a></li>
<li><a class="reference internal" href="#sec-requirements"><span class="std std-ref">Input check for URL domain</span></a></li>
<li><a class="reference internal" href="#sec-requirements"><span class="std std-ref">Input check for mail address domain</span></a></li>
</ul>
</div>
<div class="section" id="id31">
<h4><a class="toc-backref" href="#id99">9.10.3.9.2. Working image</a><a class="headerlink" href="#id31" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Configuration of common prohibited strings</li>
</ul>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_common_input_validation.png"><img alt="Common input validation" src="../_images/SecureLogin_common_input_validation.png" style="width: 80%;" /></a>
</div>
<ul class="simple">
<li>Individual input check</li>
</ul>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_input_validation.png"><img alt="Input validation" src="../_images/SecureLogin_input_validation.png" style="width: 80%;" /></a>
</div>
</div>
<div class="section" id="id32">
<h4><a class="toc-backref" href="#id100">9.10.3.9.3. Implementation method</a><a class="headerlink" href="#id32" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Since the scope for performing a check greatly vary for the configuration of common prohibited characters of overall application and individual input checks, implementation is carried out separately.</div>
<div class="line">For configuration of common prohibited strings, two methods described in <a class="reference internal" href="../ImplementationAtEachLayer/ApplicationLayer.html#controller-common-process"><span class="std std-ref">Implementing common logic to be executed before and after calling controller</span></a> can be used. In this application, implementation is carried out by using Servlet Filter in order to perform check regardless of whether mapping is done in the handler method of Controller. When an input error occurs, it signifies that the input values which were not predicted as the results of normal user operation are input and are described in the configuration file so as to transit to a common error screen without considering reduction in usability.</div>
<div class="line">For individual input check, <a class="reference internal" href="../ArchitectureInDetail/WebApplicationDetail/Validation.html"><span class="doc">Input Validation</span></a> function can be used. Input value check is performed in this application using Bean Validation. For the individual input error, implementation is done so as to encourage re-input by displaying an error message for input items corresponding to Bean Validation.</div>
</div>
</div>
<div class="section" id="id33">
<h4><a class="toc-backref" href="#id101">9.10.3.9.4. Code description</a><a class="headerlink" href="#id33" title="Permalink to this headline">¶</a></h4>
<p>Code implemented in accordance with the implementation method above is explained sequentially.</p>
<ul>
<li><p class="first">Implementation of Servlet Filter</p>
<div class="line-block">
<div class="line">When the user input is to be used in the application, it may serve as a target for injection attacks like SQL injection and XSS directory traversal (path traversal).</div>
<div class="line">An implementation example of Servlet Filter to validate the input from the user in overall application is shown as a countermeasure for these attacks.</div>
<div class="line">In this application, it is verified that prohibited characters respectively configured for following items are not included.</div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Items</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Request parameters</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Since the request parameters are generally used for receiving the input from the user, the parameters act as a target for input check.</div>
<div class="line">Since both the parameter name and the value are entered by user, both the name and the value are checked.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Upload file name</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Since file upload function is executed in this application, the file name of uploaded file entered by user acts as a target for input check.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">Further, Since <code class="docutils literal"><span class="pre">org.springframework.web.multipart.MultipartRequest</span></code>  is used in the following code, using <code class="docutils literal"><span class="pre">org.springframework.web.multipart.support.MultipartFilter</span></code> is assumed. For <code class="docutils literal"><span class="pre">MultipartFilter</span></code> , refer <a class="reference internal" href="../ArchitectureInDetail/WebApplicationDetail/FileUpload.html"><span class="doc">File Upload</span></a>.</div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.common.filter</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">InputValidationFilter</span> <span class="kd">extends</span> <span class="n">OncePerRequestFilter</span> <span class="o">{</span> <span class="c1">// (1)</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Character</span><span class="o">&gt;</span> <span class="n">prohibitedChars</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Character</span><span class="o">&gt;</span> <span class="n">prohibitedCharsForFileName</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">InputValidationFilter</span><span class="o">(</span><span class="kt">char</span><span class="o">[]</span> <span class="n">prohibitedChars</span><span class="o">,</span>
            <span class="kt">char</span><span class="o">[]</span> <span class="n">prohibitedCharsForFileName</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">prohibitedChars</span> <span class="o">=</span> <span class="n">Chars</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">prohibitedChars</span><span class="o">);</span> <span class="c1">// (2)</span>
        <span class="k">this</span><span class="o">.</span><span class="na">prohibitedCharsForFileName</span> <span class="o">=</span> <span class="n">Chars</span>
                <span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">prohibitedCharsForFileName</span><span class="o">);</span> <span class="c1">// (3)</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doFilterInternal</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span>
            <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">request</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">validateRequestParams</span><span class="o">(</span><span class="n">request</span><span class="o">);</span> <span class="c1">// (4)</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">request</span> <span class="k">instanceof</span> <span class="n">MultipartRequest</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">validateFileNames</span><span class="o">((</span><span class="n">MultipartRequest</span><span class="o">)</span> <span class="n">request</span><span class="o">);</span> <span class="c1">// (5)</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span> <span class="c1">// (6)</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">validateRequestParams</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">[]&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameterMap</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">[]&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">params</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">validate</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">prohibitedChars</span><span class="o">);</span> <span class="c1">// (7)</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">value</span> <span class="o">:</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">validate</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">prohibitedChars</span><span class="o">);</span> <span class="c1">// (8)</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">validateFileNames</span><span class="o">(</span><span class="n">MultipartRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">MultipartFile</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">request</span><span class="o">.</span><span class="na">getFileMap</span><span class="o">()</span>
                <span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">filename</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">getOriginalFilename</span><span class="o">())</span>
                    <span class="o">.</span><span class="na">getName</span><span class="o">();</span> <span class="c1">// (9)</span>
            <span class="n">validate</span><span class="o">(</span><span class="n">filename</span><span class="o">,</span> <span class="n">prohibitedCharsForFileName</span><span class="o">);</span> <span class="c1">// (10)</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">validate</span><span class="o">(</span><span class="n">String</span> <span class="n">target</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Character</span><span class="o">&gt;</span> <span class="n">prohibited</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">hasLength</span><span class="o">(</span><span class="n">target</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">Character</span><span class="o">&gt;</span> <span class="n">chars</span> <span class="o">=</span> <span class="n">Chars</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">target</span><span class="o">.</span><span class="na">toCharArray</span><span class="o">());</span>
            <span class="k">for</span><span class="o">(</span><span class="n">Character</span> <span class="n">prohibitedChar</span> <span class="o">:</span> <span class="n">prohibited</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (11)</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">chars</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">prohibitedChar</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">InvalidCharacterException</span><span class="o">(</span>
                        <span class="s">&quot;The request contains prohibited charcter.&quot;</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It is guaranteed that the process is executed only once for the request by inheriting <code class="docutils literal"><span class="pre">org.springframework.web.filter.OncePerRequestFilter</span></code> .</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Receive the list of prohibited characters of request parameters as a string and store as a list of characters.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Receive the list of prohibited characters of file name as a string and store as a list of characters.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call a method to perform input check of request parameters</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In case of file upload request (when Content-Type is a POST request of <code class="docutils literal"><span class="pre">multipart/form-data</span></code> ), the <code class="docutils literal"><span class="pre">request</span></code>  object here acts as an instance of <code class="docutils literal"><span class="pre">StandardMultipartHttpServletRequest</span></code>  which implements <code class="docutils literal"><span class="pre">MultipartRequest</span></code> , using <code class="docutils literal"><span class="pre">MultipartFilter</span></code> function.</div>
<div class="line">Fetch file name by using <code class="docutils literal"><span class="pre">MultipartRequest</span></code>  API and call a method to perform input check.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">After completing input check, call a method to execute subsequent servlet filter process.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7), (8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch the list of request parameters from <code class="docutils literal"><span class="pre">HttpServletRequest</span></code> and call a method to perform actual input check for each request parameter name and request parameter value.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch the list of files uploaded from <code class="docutils literal"><span class="pre">MultipartRequest</span></code>  and fetch actual file name.</div>
<div class="line">Since path is included in the file name according to browser or OS of the client and path delimiter tends to vary, the process is required to fetch only file name.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call a method to perform actual input check for the file name of each uploaded file.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Check whether the string for input check is included in the prohibited characters - sequentially one character at a time and throw an exception if the prohibited character is included</div>
<div class="line"><code class="docutils literal"><span class="pre">InvalidCharacterException</span></code>  is an exception created by inheriting <code class="docutils literal"><span class="pre">RuntimeException</span></code> . Code is omitted.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">In this application, only request parameters and file names are checked for common prohibited characters.
If required, similar check can also be implemented for HTTP header or cookies by fetching the value of HTTP header and Cookie using <code class="docutils literal"><span class="pre">getHeaders</span></code>  and <code class="docutils literal"><span class="pre">getCookies</span></code>  of <code class="docutils literal"><span class="pre">HttpServletRequest</span></code> .</p>
</div>
</li>
<li><p class="first">Configuration of Servlet Filter</p>
<div class="line-block">
<div class="line">Configure in web.xml to validate created <code class="docutils literal"><span class="pre">InputValidationFilter</span></code> .</div>
<div class="line">Configuration is done by using <code class="docutils literal"><span class="pre">org.springframework.web.filter.DelegatingFilterProxy</span></code>  by reading prohibited characters from the property file and defining a Bean for <code class="docutils literal"><span class="pre">InputValidationFilter</span></code> .</div>
</div>
<p><strong>web.xml</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;filter&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>MultipartFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;filter-class&gt;</span>org.springframework.web.multipart.support.MultipartFilter<span class="nt">&lt;/filter-class&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;/filter&gt;</span>
<span class="nt">&lt;filter-mapping&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>MultipartFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
<span class="nt">&lt;/filter-mapping&gt;</span>

<span class="nt">&lt;filter&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>inputValidationFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;filter-class&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="nt">&lt;/filter-class&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/filter&gt;</span>
<span class="nt">&lt;filter-mapping&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>inputValidationFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
<span class="nt">&lt;/filter-mapping&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;error-page&gt;</span>
    <span class="nt">&lt;exception-type&gt;</span>org.terasoluna.securelogin.app.common.filter.exception.InvalidCharacterException<span class="nt">&lt;/exception-type&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;location&gt;</span>/WEB-INF/views/common/error/invalidCharacterError.jsp<span class="nt">&lt;/location&gt;</span>
<span class="nt">&lt;/error-page&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Configure <code class="docutils literal"><span class="pre">MultipartFilter</span></code>  which is a prerequisite for using <code class="docutils literal"><span class="pre">InputValidationFilter</span></code> .</div>
<div class="line">Note that <code class="docutils literal"><span class="pre">MultipartFilter</span></code>  must be defined even prior to <code class="docutils literal"><span class="pre">InputValidationFilter</span></code> </div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Configure <code class="docutils literal"><span class="pre">InputValidationFilter</span></code> for which a Bean is defined, using <code class="docutils literal"><span class="pre">DelegatingFilterProxy</span></code> .</div>
<div class="line">Bean name must be specified in the <code class="docutils literal"><span class="pre">&lt;filter-name&gt;</span></code> .</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Configure an error screen to be displayed when the <code class="docutils literal"><span class="pre">InvalidCharacterException</span></code>  exception is thrown.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since <code class="docutils literal"><span class="pre">MultipartFilter</span></code>  is used for input check of file name, configuration to validate upload function of Servlet 3.0 described in <a class="reference internal" href="../ArchitectureInDetail/WebApplicationDetail/FileUpload.html#file-upload-how-to-usr-application-settings"><span class="std std-ref">Application settings</span></a> is required in addition to the details described here.</p>
</div>
<p><strong>invalidCharacterError.jsp</strong></p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="k">&lt;%</span> <span class="n">response</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="n">HttpServletResponse</span><span class="o">.</span><span class="na">SC_BAD_REQUEST</span><span class="o">);</span> <span class="k">%&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;title&gt;</span>Invalid Character Error!<span class="nt">&lt;/title&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Since <code class="docutils literal"><span class="pre">InvalidCharacterException</span></code>  is an exception which originates in the client input, set HTTP status code to <code class="docutils literal"><span class="pre">400</span></code> (Bad Request).</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>applicationContext.xml</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;inputValidationFilter&quot;</span> <span class="na">class=</span><span class="s">&quot;org.terasoluna.securelogin.app.common.filter.InputValidationFilter&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">value=</span><span class="s">&quot;${app.security.prohibitedChars}&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span> <span class="na">value=</span><span class="s">&quot;${app.security.prohibitedCharsForFileName}&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch the list of prohibited characters of request parameter from  property, as a string</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch the list of prohibited characters of file name from property, as a string</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>application.properties</strong></p>
<div class="highlight-properties"><div class="highlight"><pre><span></span><span class="c">## (1)</span>
<span class="na">app.security.prohibitedChars</span><span class="o">=</span><span class="s">&amp;\\!&quot;&lt;&gt;*</span>

<span class="c">## (2)</span>
<span class="na">app.security.prohibitedCharsForFileName</span><span class="o">=</span><span class="s">&amp;\\!&quot;&lt;&gt;*;:</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In this application, specify a list of characters which are not intended to be included in the request parameters, as a string</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In this application, specify a list of characters which are not intended to be included in the uploaded file name, as a string</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Creating Bean Validation annotation</p>
<p>An annotation of Bean Validation which validates the input value based on the requirements is created to alleviate the security risk posed by the input value which was not considered in the specifications of application.</p>
<ul>
<li><p class="first">Annotation to verify that the control characters are not included</p>
<div class="line-block">
<div class="line">When the control characters are included in the input value, an unexpected issue is likely to occur in the application. Hence, it is checked that the control characters are not included for the input items which do not require input of control characters.</div>
<div class="line">Since only linefeed character of control characters is allowed in some cases at the time of text input, an annotation to allow linefeed code is created separately.</div>
<div class="line">It can be verified that control characters are not included by performing a check using normal expressions.</div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.common.validation</span><span class="o">;</span>

<span class="c1">// omitted</span>
<span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{})</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">FIELD</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="nd">@ReportAsSingleViolation</span>  <span class="c1">// (1)</span>
<span class="nd">@Pattern</span><span class="o">(</span><span class="n">regexp</span> <span class="o">=</span> <span class="s">&quot;^\\P{Cntrl}*$&quot;</span><span class="o">)</span> <span class="c1">// (2)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">NotContainControlChars</span> <span class="o">{</span>
    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{org.terasoluna.securelogin.app.common.validation.NotContainControlChars.message}&quot;</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="nd">@Target</span><span class="o">({</span> <span class="n">FIELD</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">NotContainControlChars</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="nf">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Assign <code class="docutils literal"><span class="pre">&#64;ReportAsSingleViolation</span></code>  annotation to output only the message specified in the annotation, as an error message.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Assign <code class="docutils literal"><span class="pre">&#64;Pattern</span></code> annotation to perform input check using normal expressions</div>
<div class="line">Since <code class="docutils literal"><span class="pre">\P{Cntrl}</span></code>  signifies “characters other than control characters” in the normal expressions of Java, <code class="docutils literal"><span class="pre">^\\P{Cntrl}*$</span></code> matches only with the string which does not include a control character from beginning to end</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">Similarly, implementation example for the annotation which allows linefeed code is shown below.</div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.common.validation</span><span class="o">;</span>

<span class="c1">// omitted</span>
<span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{})</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">FIELD</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="nd">@ReportAsSingleViolation</span>
<span class="nd">@Pattern</span><span class="o">(</span><span class="n">regexp</span> <span class="o">=</span> <span class="s">&quot;^[\\r\\n\\P{Cntrl}]*$&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">NotContainControlCharsExceptNewlines</span> <span class="o">{</span>
    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{org.terasoluna.securelogin.app.common.validation.NotContainControlCharsExceptNewlines.message}&quot;</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="nd">@Target</span><span class="o">({</span> <span class="n">FIELD</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">NotContainControlCharsExceptNewlines</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="nf">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify normal expressions to match the string consisting of only “characters other than control character (<code class="docutils literal"><span class="pre">\P{Cntrl}</span></code> )” and linefeed code (<code class="docutils literal"><span class="pre">\r</span></code> , <code class="docutils literal"><span class="pre">\n</span></code> ).</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Annotation to verify that extensions of the uploaded file are allowed</p>
<div class="line-block">
<div class="line">When a file uploaded by the user is to be received, the format of the file to be received is likely to be restricted. In such cases, a list of extensions for the files allowed is set and it is checked whether the extension of the uploaded file is included in the list.</div>
<div class="line">It is a specification which can be changed for whether the upper case and lower case extensions are to be differentiated.</div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Since extension of the file can be disguised easily, a file format should not be trusted unconditionally even after performing the extension check.</p>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.common.validation</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{</span> <span class="n">FileExtensionValidator</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">ElementType</span><span class="o">.</span><span class="na">FIELD</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">FileExtension</span> <span class="o">{</span>
    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{org.terasoluna.securelogin.app.common.validation.FileExtension.message}&quot;</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="nf">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">String</span><span class="o">[]</span> <span class="nf">extensions</span><span class="o">();</span>  <span class="c1">// (1)</span>

    <span class="kt">boolean</span> <span class="nf">ignoreCase</span><span class="o">()</span> <span class="k">default</span> <span class="kc">true</span><span class="o">;</span>  <span class="c1">// (2)</span>

    <span class="nd">@Target</span><span class="o">({</span> <span class="n">ElementType</span><span class="o">.</span><span class="na">FIELD</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">FileExtension</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify list of extensions to be allowed.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Whether to ignore the differentiation between uppercase and lowercase characters. Default value is <code class="docutils literal"><span class="pre">true</span></code>  (ignore)</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.common.validation</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FileExtensionValidator</span> <span class="kd">implements</span>
        <span class="n">ConstraintValidator</span><span class="o">&lt;</span><span class="n">FileExtension</span><span class="o">,</span> <span class="n">MultipartFile</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">extensions</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">ignoreCase</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">FileExtension</span> <span class="n">constraintAnnotation</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">extensions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;(</span>
                <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">constraintAnnotation</span><span class="o">.</span><span class="na">extensions</span><span class="o">()));</span>
        <span class="k">this</span><span class="o">.</span><span class="na">ignoreCase</span> <span class="o">=</span> <span class="n">constraintAnnotation</span><span class="o">.</span><span class="na">ignoreCase</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isValid</span><span class="o">(</span><span class="n">MultipartFile</span> <span class="n">value</span><span class="o">,</span>
            <span class="n">ConstraintValidatorContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>  <span class="c1">// (1)</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">String</span> <span class="n">fileNameExtension</span> <span class="o">=</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">getFilenameExtension</span><span class="o">(</span><span class="n">value</span>
                <span class="o">.</span><span class="na">getOriginalFilename</span><span class="o">());</span>  <span class="c1">// (2)</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">hasLength</span><span class="o">(</span><span class="n">fileNameExtension</span><span class="o">))</span> <span class="o">{</span>  <span class="c1">// (3)</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">extension</span> <span class="o">:</span> <span class="n">extensions</span><span class="o">)</span> <span class="o">{</span>  <span class="c1">// (4)</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">fileNameExtension</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">extension</span><span class="o">)</span> <span class="o">||</span> <span class="n">ignoreCase</span>
                    <span class="o">&amp;&amp;</span> <span class="n">fileNameExtension</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">extension</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Return <code class="docutils literal"><span class="pre">true</span></code>  in case of <code class="docutils literal"><span class="pre">null</span></code>  since <code class="docutils literal"><span class="pre">null</span></code>  check is performed by using another annotation.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch extension from the file name by using <code class="docutils literal"><span class="pre">getFilenameExtension</span></code>  method of <code class="docutils literal"><span class="pre">org.springframework.util.StringUtils</span></code> </div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Return <code class="docutils literal"><span class="pre">false</span></code> for the file without an extension since it is not permissible.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch extensions one by one from the list of extensions to be allowed and compare with the string fetched from the file name.</div>
<div class="line">Return <code class="docutils literal"><span class="pre">true</span></code>  if even one of the extensions show a match and return <code class="docutils literal"><span class="pre">false</span></code>  if it does not match with any of the extensions in the list.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Annotation that verifies that file name of the uploaded file matches with the patterns that are allowed</p>
<p>When a file uploaded by the user is to be received, the format of the file to be received is likely to be restricted. In such cases, pattern for the file name to be allowed is set in normal expression and it is checked that file name of uploaded file matches with the pattern.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.common.validation</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{</span> <span class="n">FileNamePatternValidator</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">ElementType</span><span class="o">.</span><span class="na">FIELD</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">FileNamePattern</span> <span class="o">{</span>

    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{org.terasoluna.securelogin.app.common.validation.FileNamePattern.message}&quot;</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="nf">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">String</span> <span class="nf">pattern</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;&quot;</span><span class="o">;</span>  <span class="c1">// (1)</span>

    <span class="nd">@Target</span><span class="o">({</span> <span class="n">ElementType</span><span class="o">.</span><span class="na">FIELD</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">FileNamePattern</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Pattern for the file name to be allowed</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.common.validation</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FileNamePatternValidator</span> <span class="kd">implements</span>
        <span class="n">ConstraintValidator</span><span class="o">&lt;</span><span class="n">FileNamePattern</span><span class="o">,</span> <span class="n">MultipartFile</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Pattern</span> <span class="n">pattern</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">FileNamePattern</span> <span class="n">constraintAnnotation</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">pattern</span> <span class="o">=</span> <span class="n">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="n">constraintAnnotation</span><span class="o">.</span><span class="na">pattern</span><span class="o">());</span>  <span class="c1">// (1)</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isValid</span><span class="o">(</span><span class="n">MultipartFile</span> <span class="n">value</span><span class="o">,</span>
            <span class="n">ConstraintValidatorContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>  <span class="c1">// (2)</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">String</span> <span class="n">filename</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">value</span><span class="o">.</span><span class="na">getOriginalFilename</span><span class="o">()).</span><span class="na">getName</span><span class="o">();</span>  <span class="c1">// (3)</span>
        <span class="k">return</span> <span class="n">pattern</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">filename</span><span class="o">).</span><span class="na">matches</span><span class="o">();</span>  <span class="c1">// (4)</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create and retain a pattern of normal expressions to be checked, as a <code class="docutils literal"><span class="pre">Pattern</span></code> .</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Return <code class="docutils literal"><span class="pre">true</span></code>  in case of <code class="docutils literal"><span class="pre">null</span></code>  since <code class="docutils literal"><span class="pre">null</span></code>  check is performed by using another annotation.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch actual file name from <code class="docutils literal"><span class="pre">MultipartRequest</span></code> . Since path is included in the file name in accordance with browser and OS of client and path delimiter varies, the process is required for fetching only file name.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Return <code class="docutils literal"><span class="pre">true</span></code>  when <code class="docutils literal"><span class="pre">Pattern</span></code>  created in (1) and file name match otherwise return <code class="docutils literal"><span class="pre">false</span></code> .</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Annotation to verify that domain of input URL is allowed</p>
<div class="line-block">
<div class="line">When a URL input by the user is to be received, the domain that are allowed are likely to be restricted. In such cases, list of domains allowed is set and it is checked whether the domain of input URL is a domain included in the list or is a subdomain.</div>
<div class="line">Since URL format is checked at the same time, implementation is done combining with <code class="docutils literal"><span class="pre">org.hibernate.validator.constraints.URL</span></code> .</div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.common.validation</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{</span> <span class="n">DomainRestrictedURLValidator</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">FIELD</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="nd">@URL</span>  <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">DomainRestrictedURL</span> <span class="o">{</span>

    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{org.terasoluna.securelogin.app.common.validation.DomainRestrictedURL.message}&quot;</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">String</span><span class="o">[]</span> <span class="nf">allowedDomains</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>  <span class="c1">// (2)</span>

    <span class="nd">@Target</span><span class="o">({</span> <span class="n">FIELD</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">DomainRestrictedURL</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="nf">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Assign <code class="docutils literal"><span class="pre">&#64;URL</span></code>  to check URL format.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">List of domains to be allowed</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.common.validation</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DomainRestrictedURLValidator</span> <span class="kd">implements</span>
        <span class="n">ConstraintValidator</span><span class="o">&lt;</span><span class="n">DomainRestrictedURL</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Pattern</span> <span class="n">URL_REGEX</span> <span class="o">=</span> <span class="n">Pattern</span>  <span class="c1">// (1)</span>
        <span class="o">.</span><span class="na">compile</span><span class="o">(</span> <span class="s">&quot;(?i)^(?:[a-z](?:[-a-z0-9\\+\\.])*)&quot;</span> <span class="o">+</span> <span class="c1">// protocol</span>
                 <span class="s">&quot;:(?:\\/\\/([^\\/:]+)&quot;</span> <span class="o">+</span> <span class="c1">// auth+host/ip</span>
                 <span class="s">&quot;(?::([0-9]*))?&quot;</span> <span class="o">+</span> <span class="c1">// port</span>
                 <span class="s">&quot;(?:\\/.*)*)$&quot;</span>
         <span class="o">);</span>

    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">allowedDomains</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">DomainRestrictedURL</span> <span class="n">constraintAnnotation</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">allowedDomains</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">constraintAnnotation</span>
                <span class="o">.</span><span class="na">allowedDomains</span><span class="o">()));</span>  <span class="c1">// (2)</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isValid</span><span class="o">(</span><span class="n">String</span> <span class="n">value</span><span class="o">,</span> <span class="n">ConstraintValidatorContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Matcher</span> <span class="n">urlMatcher</span> <span class="o">=</span> <span class="n">URL_REGEX</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">urlMatcher</span><span class="o">.</span><span class="na">matches</span><span class="o">())</span> <span class="o">{</span>  <span class="c1">// (3)</span>
            <span class="n">String</span> <span class="n">host</span> <span class="o">=</span> <span class="n">urlMatcher</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
            <span class="k">for</span><span class="o">(</span><span class="n">String</span> <span class="n">domain</span> <span class="o">:</span> <span class="n">allowedDomains</span><span class="o">)</span> <span class="o">{</span>  <span class="c1">// (4)</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">hasLength</span><span class="o">(</span><span class="n">host</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&quot;.&quot;</span><span class="o">+</span><span class="n">domain</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create and retain a pattern of normal expressions as a <code class="docutils literal"><span class="pre">Pattern</span></code> for fetching URL domain</div>
<div class="line">Since whether the URL format is correct is verified by <code class="docutils literal"><span class="pre">&#64;URL</span></code> , only minimum required expressions are specified here.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch and retain the list of domains to be allowed</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Check whether the URL format is correct. If the format is invalid, return <code class="docutils literal"><span class="pre">true</span></code> here since a validation error occurs in <code class="docutils literal"><span class="pre">URL</span></code>  annotation used in combination</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch the domain one by one from the list of domains to be allowed and check whether it matches with the end part of host name of URL. Return <code class="docutils literal"><span class="pre">true</span></code>  if even one of the values match and return <code class="docutils literal"><span class="pre">false</span></code>  if it does not match with any of the values</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Annotation to verify that domain of input mail address is allowed</p>
<div class="line-block">
<div class="line">When a mail address input by the user is to be received, the domains that are allowed are likely to be restricted. In such cases, list of allowed domains is set and it is checked that domain of input mail address is included in the list. It is a specification which can be changed to include whether to allow  the subdomain of domain.</div>
<div class="line">Since the mail address format is checked at the same time, implementation is done combining with <code class="docutils literal"><span class="pre">org.hibernate.validator.constraints.Email</span></code> .</div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.common.validation</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{</span> <span class="n">DomainRestrictedEmailValidator</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">FIELD</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="nd">@Email</span>  <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">DomainRestrictedEmail</span> <span class="o">{</span>
    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{org.terasoluna.securelogin.app.common.validation.DomainRestrictedEmail.message}&quot;</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">String</span><span class="o">[]</span> <span class="nf">allowedDomains</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>  <span class="c1">// (2)</span>

    <span class="kt">boolean</span> <span class="nf">allowSubDomain</span><span class="o">()</span> <span class="k">default</span> <span class="kc">false</span><span class="o">;</span>  <span class="c1">// (3)</span>

    <span class="nd">@Target</span><span class="o">({</span> <span class="n">FIELD</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">DomainRestrictedEmail</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="nf">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Assign <code class="docutils literal"><span class="pre">&#64;Email</span></code>  to check the mail address format</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">List of domains to be allowed</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Whether to allow a subdomain. Default value is <code class="docutils literal"><span class="pre">false</span></code>  (do not allow)</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.common.validation</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DomainRestrictedEmailValidator</span> <span class="kd">implements</span>
        <span class="n">ConstraintValidator</span><span class="o">&lt;</span><span class="n">DomainRestrictedEmail</span><span class="o">,</span> <span class="n">CharSequence</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">allowedDomains</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">allowSubDomain</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">DomainRestrictedEmail</span> <span class="n">constraintAnnotation</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">allowedDomains</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">constraintAnnotation</span>
                <span class="o">.</span><span class="na">allowedDomains</span><span class="o">()));</span>  <span class="c1">// (1)</span>
        <span class="n">allowSubDomain</span> <span class="o">=</span> <span class="n">constraintAnnotation</span><span class="o">.</span><span class="na">allowSubDomain</span><span class="o">();</span>  <span class="c1">// (2)</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isValid</span><span class="o">(</span><span class="n">CharSequence</span> <span class="n">value</span><span class="o">,</span>
            <span class="n">ConstraintValidatorContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>  <span class="c1">// (3)</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">domain</span> <span class="o">:</span> <span class="n">allowedDomains</span><span class="o">)</span> <span class="o">{</span>  <span class="c1">// (4)</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">value</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&quot;@&quot;</span> <span class="o">+</span> <span class="n">domain</span><span class="o">)</span>
                    <span class="o">||</span> <span class="o">(</span><span class="n">allowSubDomain</span> <span class="o">&amp;&amp;</span> <span class="n">value</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">endsWith</span><span class="o">(</span>
                            <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">domain</span><span class="o">)))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch and retain the list of domains to be allowed.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch and retain the truth value which indicates whether the subdomain is allowed</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Return <code class="docutils literal"><span class="pre">true</span></code> in case of <code class="docutils literal"><span class="pre">null</span></code>  since <code class="docutils literal"><span class="pre">null</span></code>  check is performed by another annotation</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch domain one by one from the list of domains to be allowed and check whether it matches with the domain part of the mail address. Return <code class="docutils literal"><span class="pre">true</span></code>  even if one of the domains show a match and return <code class="docutils literal"><span class="pre">false</span></code> of it does not match any of the domains.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</li>
<li><p class="first">Assigning annotation to Form class</p>
<p>Annotation created is assigned to the field of Form class of new account creation.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.account</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountCreateForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@NotContainControlChars</span>  <span class="c1">// (1)</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span><span class="o">=</span><span class="mi">4</span><span class="o">,</span> <span class="n">max</span><span class="o">=</span><span class="mi">128</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@NotContainControlChars</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span><span class="o">=</span><span class="mi">1</span><span class="o">,</span> <span class="n">max</span><span class="o">=</span><span class="mi">128</span><span class="o">)</span>
    <span class="nd">@DomainRestrictedEmail</span><span class="o">(</span><span class="n">allowedDomains</span><span class="o">={</span> <span class="s">&quot;domainexample.co.jp&quot;</span><span class="o">,</span>
             <span class="s">&quot;somedomainexample.co.jp&quot;</span> <span class="o">},</span> <span class="n">allowSubDomain</span><span class="o">=</span><span class="kc">true</span><span class="o">)</span>  <span class="c1">// (2)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@NotContainControlChars</span>
    <span class="nd">@DomainRestrictedURL</span><span class="o">(</span><span class="n">allowedDomains</span><span class="o">={</span> <span class="s">&quot;jp&quot;</span> <span class="o">})</span>  <span class="c1">// (3)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">url</span><span class="o">;</span>

    <span class="nd">@UploadFileRequired</span>
    <span class="nd">@UploadFileNotEmpty</span>
    <span class="nd">@UploadFileMaxSize</span>
    <span class="nd">@FileExtension</span><span class="o">(</span><span class="n">extensions</span> <span class="o">=</span> <span class="o">{</span> <span class="s">&quot;jpg&quot;</span><span class="o">,</span> <span class="s">&quot;png&quot;</span><span class="o">,</span> <span class="s">&quot;gif&quot;</span> <span class="o">})</span>  <span class="c1">// (4)</span>
    <span class="nd">@FileNamePattern</span><span class="o">(</span><span class="n">pattern</span> <span class="o">=</span> <span class="s">&quot;[a-zA-Z0-9_-]+\\.[a-zA-Z]{3}&quot;</span><span class="o">)</span>  <span class="c1">// (5)</span>
    <span class="kd">private</span> <span class="n">MultipartFile</span> <span class="n">image</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@NotContainControlCharsExceptNewlines</span>  <span class="c1">// (6)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">profile</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Check that control characters are not included.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Check that the mail address domain is “ntt.co.jp”, “nttdata.co.jp” or its subdomain</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Check that URL domain is “jp” or its subdomain</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Check that file extemsions are one of the “jpg”, “png” and “gif” extensions</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Check that the file name is of “repeating 1 or more characters of Alphanumeric, “_”, “-” ” + ” “.” ” + “single byte alphabet 3 characters” pattern</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Check that control characters other than linefeed character are not included</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
</div>
<div class="section" id="audit-log-output">
<span id="audit-logging"></span><h3><a class="toc-backref" href="#id102">9.10.3.10. Audit log output</a><a class="headerlink" href="#audit-log-output" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id34">
<h4><a class="toc-backref" href="#id103">9.10.3.10.1. List of requirements to be implemented</a><a class="headerlink" href="#id34" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference internal" href="#sec-requirements"><span class="std std-ref">Audit log output</span></a></li>
</ul>
</div>
<div class="section" id="id35">
<h4><a class="toc-backref" href="#id104">9.10.3.10.2. Working image</a><a class="headerlink" href="#id35" title="Permalink to this headline">¶</a></h4>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_logging.png"><img alt="Logging" src="../_images/SecureLogin_logging.png" style="width: 80%;" /></a>
</div>
<p>While calling a service class method, date and time of calling, name of the user calling and method name are output in a log for the audit in order to check the information regarding the application like the user who has performed the operation, date and time at which the operation is performed, what kind of operation is performed etc.
Further, for the results of method execution, log is output as “operation successful” if exception does not occur during the operation and “operation failed” if exception occurs during the process.</p>
<p>Log format is as below..</p>
<p><code class="docutils literal"><span class="pre">｛date</span> <span class="pre">and</span> <span class="pre">time</span> <span class="pre">of</span> <span class="pre">method</span> <span class="pre">calling｝｛Thread｝｛Name</span> <span class="pre">of</span> <span class="pre">user</span> <span class="pre">calling｝｛X-Track｝｛Log</span> <span class="pre">level｝｛Logger｝｛Message｝</span></code> </p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="30%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">Date and time of method calling</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Date and time at which service class method is called is output in “yyyy-MM-dd HH:mm:ss” format</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">Thread</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A thread which outputs the log</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">Name of user calling</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Output user name of Spring Security which calls service class method</div>
<div class="line">Kept blank in case of no login</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">X-Track</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">An ID which is set for each request to enhance traceability</div>
<div class="line">For details, refer <a class="reference internal" href="../ArchitectureInDetail/GeneralFuncDetail/Logging.html"><span class="doc">Logging</span></a> </div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">Log level</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Level of log which has been output</div>
<div class="line">Output in <code class="docutils literal"><span class="pre">info</span></code> level in this application</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">Logger</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A logger which outputs a log</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">Message</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Time at which a method is called: “[START SERVICE] ServiceClassName.methodName”</div>
<div class="line">Time at which method is successfully terminated: “[COMPLETE SERVICE] ServiceClassName.methodName”</div>
<div class="line">Exception occurrence time: “[SERVICE THROWS EXCEPTION] ExceptionClassName.methodName”</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="how-to-implement">
<h4><a class="toc-backref" href="#id105">9.10.3.10.3. How to implement</a><a class="headerlink" href="#how-to-implement" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">User name is fetched from authentication information of Spring Security in order to output user name in the log. Fetching user name and log output are implemented by using <code class="docutils literal"><span class="pre">org.terasoluna.gfw.security.web.logging.UserIdMDCPutFilter</span></code>  described in <a class="reference internal" href="../ArchitectureInDetail/GeneralFuncDetail/Logging.html"><span class="doc">Logging</span></a> .</div>
<div class="line">Further, operation details and operation results for the request are defined as below and output in a log, for this application.</div>
</div>
<ul class="simple">
<li>Operation details: Name of the method of service class that has been called</li>
<li>Operation results: Whether the exceptions have occurred in the results of method processing</li>
</ul>
<div class="line-block">
<div class="line">AOP(Aspect Oriented Programming) function offered by Spring can be used to achieve a cross-sectional function like log output for calling of all the methods of service class</div>
<div class="line">AOP offered by Spring offers many implementation methods. This application puts an emphasis on combining with implementation of logging related components offered by common library &lt;<a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw">https://github.com/terasolunaorg/terasoluna-gfw</a>&gt;`_ and adopts a method to implement <code class="docutils literal"><span class="pre">org.aopalliance.intercept.MethodInterceptor</span></code> .</div>
<div class="line">Requirements are fulfilled by implementation and configuration given below.</div>
</div>
<ul class="simple">
<li>Configure <code class="docutils literal"><span class="pre">UserIdMDCPutFilter</span></code> </li>
<li>Create an advice which outputs a log at the time of calling a method and after execution</li>
<li>Configure to apply the advice defined above for the class assigned with <code class="docutils literal"><span class="pre">&#64;Service</span></code> </li>
</ul>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Advice indicates a process which is executed for AOP within specified timing.
Further, the place where advice can be embedded is called a joining point whereas set of join points where advice is embedded is called as a point cut
For AOP function offered by Spring, refer Official document - AOP &lt;<a class="reference external" href="http://docs.spring.io/spring/docs/4.3.14.RELEASE/spring-framework-reference/html/aop.html">http://docs.spring.io/spring/docs/4.3.14.RELEASE/spring-framework-reference/html/aop.html</a>&gt;`_ .</p>
</div>
</div></blockquote>
</div>
<div class="section" id="id36">
<h4><a class="toc-backref" href="#id106">9.10.3.10.4. Code description</a><a class="headerlink" href="#id36" title="Permalink to this headline">¶</a></h4>
<p>Code implemented in accordance with the implementation method above is sequentially explained.</p>
<ul>
<li><p class="first">Configure <code class="docutils literal"><span class="pre">UserIdMDCPutFilter</span></code> </p>
<p>Configuration to output authenticated user name of Spring Security in log is shown below.</p>
<p><strong>spring-security.xml</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;sec:http&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
    <span class="nt">&lt;sec:custom-filter</span> <span class="na">ref=</span><span class="s">&quot;userIdMDCPutFilter&quot;</span> <span class="na">after=</span><span class="s">&quot;ANONYMOUS_FILTER&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;userIdMDCPutFilter&quot;</span> <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.security.web.logging.UserIdMDCPutFilter&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Configure <code class="docutils literal"><span class="pre">UserIdMDCPutFilter</span></code>  in Filter Chain of Spring Security to output a log immediately after generating user information</div>
<div class="line">By configuring <code class="docutils literal"><span class="pre">UserIdMDCPutFilter</span></code> , authenticated user name is added to MDC with a key called <code class="docutils literal"><span class="pre">USER</span></code> .</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>logback.xml</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">&quot;AUDIT_LOG_FILE&quot;</span>
    <span class="na">class=</span><span class="s">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;file&gt;</span>log/security-audit.log<span class="nt">&lt;/file&gt;</span>
    <span class="nt">&lt;rollingPolicy</span> <span class="na">class=</span><span class="s">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;fileNamePattern&gt;</span>log/security-audit-%d{yyyyMMdd}.log<span class="nt">&lt;/fileNamePattern&gt;</span>
        <span class="nt">&lt;maxHistory&gt;</span>7<span class="nt">&lt;/maxHistory&gt;</span>
    <span class="nt">&lt;/rollingPolicy&gt;</span>
    <span class="nt">&lt;encoder&gt;</span>
        <span class="nt">&lt;charset&gt;</span>UTF-8<span class="nt">&lt;/charset&gt;</span>
        <span class="nt">&lt;pattern&gt;</span><span class="cp">&lt;![CDATA[date:%d{yyyy-MM-dd HH:mm:ss}\tthread:%thread\tUSER:%X{USER}\tX-Track:%X{X-Track}\tlevel:%-5level\tlogger:%-48logger{48}\tmessage:%msg%n]]&gt;</span><span class="nt">&lt;/pattern&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;/encoder&gt;</span>
<span class="nt">&lt;/appender&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;logger</span>
   <span class="na">name=</span><span class="s">&quot;org.terasoluna.securelogin.domain.common.interceptor.ServiceCallLoggingInterceptor&quot;</span>
   <span class="na">additivity=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
   <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;info&quot;</span> <span class="nt">/&gt;</span>
   <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">&quot;AUDIT_LOG_FILE&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/logger&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define an appender for audit log output.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Describe “USER:%X{USER}” in the pattern definition</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a logger for audit log output</div>
<div class="line">Implementation of <code class="docutils literal"><span class="pre">org.terasoluna.securelogin.domain.common.interceptor.ServiceCallLoggingInterceptor</span></code>  will be explained later.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Create an advice which outputs a log at the time of calling a method and after execution</p>
<p>Implementation and configuration to output a log for operation details and operation results are shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span>  <span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.common.interceptor</span><span class="o">;</span>

  <span class="c1">// omitted</span>

  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServiceCallLoggingInterceptor</span> <span class="kd">implements</span> <span class="n">MethodInterceptor</span> <span class="o">{</span>  <span class="c1">// (1)</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span>
            <span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">ServiceCallLoggingInterceptor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">MethodInvocation</span> <span class="n">invocation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>  <span class="c1">// (2)</span>
        <span class="n">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="n">invocation</span><span class="o">.</span><span class="na">getMethod</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">invocation</span><span class="o">.</span><span class="na">getMethod</span><span class="o">().</span><span class="na">getDeclaringClass</span><span class="o">()</span>
                <span class="o">.</span><span class="na">getSimpleName</span><span class="o">();</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;[START SERVICE]{}.{}&quot;</span><span class="o">,</span> <span class="n">className</span><span class="o">,</span> <span class="n">methodName</span><span class="o">);</span>  <span class="c1">// (3)</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">invocation</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>  <span class="c1">// (4)</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;[COMPLETE SERVICE]{}.{}&quot;</span><span class="o">,</span> <span class="n">className</span><span class="o">,</span> <span class="n">methodName</span><span class="o">);</span>  <span class="c1">// (5)</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>  <span class="c1">// (6)</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;[SERVICE THROWS EXCEPTION]{}.{}&quot;</span><span class="o">,</span> <span class="n">className</span><span class="o">,</span>  <span class="c1">// (7)</span>
                    <span class="n">methodName</span><span class="o">);</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">Exception</span> <span class="o">:</span> <span class="o">{},</span> <span class="n">Message</span> <span class="o">:</span> <span class="o">{},</span> <span class="n">e</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span> <span class="c1">// (8)</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>  <span class="c1">// (9)</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Implement <code class="docutils literal"><span class="pre">MethodInterceptor</span></code>  to describe the processes to be carried out before and after calling a method</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Override <code class="docutils literal"><span class="pre">invoke</span></code>  method defined in <code class="docutils literal"><span class="pre">MethodInterceptor</span></code> </div>
<div class="line">Information like name of the method being called can be fetched from  <code class="docutils literal"><span class="pre">org.aopalliance.intercept.MethodInvocation</span></code>  object of argument</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Output name of the method to be called in a log before calling a method</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Perform actual method calling and fetch results</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Output a “operation successful” log message if an exception does not occur in the results of calling a method</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Return a object for results of method calling</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Output a “operation failed” message when an exception occurs in the results of calling a method</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Output exception class and exception message thus occurred</div>
<div class="line">Since it is for the auditing, a stack trace is not output to avoid redundancy in the log</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Throw an exception object thus occurred</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Detailed contents can also be output by using arguments at the time of calling a method, to further extend the example of this application.
However, in such a case, a password without hashing is likely to be output in a log. Hence, countermeasures like masking may be required.</p>
</div>
</li>
<li><p class="first">Configure for applying advice for a class assigned with <code class="docutils literal"><span class="pre">&#64;Service</span></code> .</p>
<p>Configuration of point cut for the advice is shown below.</p>
<p><strong>secure-login-domain.xml</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;serviceCallLoggingInterceptor&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.terasoluna.securelogin.domain.common.interceptor.ServiceCallLoggingInterceptor&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;aop:config&gt;</span>
    <span class="nt">&lt;aop:advisor</span> <span class="na">advice-ref=</span><span class="s">&quot;serviceCallLoggingInterceptor&quot;</span>
        <span class="na">pointcut=</span><span class="s">&quot;@within(org.springframework.stereotype.Service)&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/aop:config&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for advice class created above (implementation class of <code class="docutils literal"><span class="pre">MethodInterceptor</span></code> )</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set Bean which implements the advice, in <code class="docutils literal"><span class="pre">advice-ref</span></code>  attribute of <code class="docutils literal"><span class="pre">aop:advisor</span></code>  tag and set point cuts in <code class="docutils literal"><span class="pre">pointcut</span></code>  attribute respectively.</div>
<div class="line">By defining a point cut <code class="docutils literal"><span class="pre">&#64;within(org.springframework.stereotype.Service)</span></code> , the method calling of the class assigned with <code class="docutils literal"><span class="pre">&#64;Service</span></code>  is used as a target for advice.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Spring AOP adopts a proxy method wherein a proxy class which has been auto-created handles the method calling.
Note that, as a constraint of AOP of Proxy method, advice is not executed for the method calling of visibility other than <code class="docutils literal"><span class="pre">public</span></code>  or the method calling within the same class.
For details, refer <a class="reference external" href="http://docs.spring.io/spring/docs/4.3.14.RELEASE/spring-framework-reference/html/aop.html#aop-understanding-aop-proxies">Official document</a> .</p>
</div>
<p>Output results of log are as below.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">date:2016-08-18 13:45:42   thread:tomcat-http--7   USER:demo   X-Track:f514cc4159324ba28d8393f2c3062d89    level:INFO  logger:o.t.s.d.c.i.ServiceCallLoggingInterceptor        message:[START SERVICE]AccountSharedService.isInitialPassword</span>
<span class="go">date:2016-08-18 13:45:42   thread:tomcat-http--7   USER:demo   X-Track:f514cc4159324ba28d8393f2c3062d89    level:INFO  logger:o.t.s.d.c.i.ServiceCallLoggingInterceptor        message:[START SERVICE]PasswordHistorySharedService.findLatest</span>
<span class="go">date:2016-08-18 13:45:42   thread:tomcat-http--7   USER:demo   X-Track:f514cc4159324ba28d8393f2c3062d89    level:INFO  logger:o.t.s.d.c.i.ServiceCallLoggingInterceptor        message:[COMPLETE SERVICE]PasswordHistorySharedService.findLatest</span>
<span class="go">date:2016-08-18 13:45:42   thread:tomcat-http--7   USER:demo   X-Track:f514cc4159324ba28d8393f2c3062d89    level:INFO  logger:o.t.s.d.c.i.ServiceCallLoggingInterceptor        message:[COMPLETE SERVICE]AccountSharedService.isInitialPassword</span>
</pre></div>
</div>
<p>Log at the time occurrence of exception is as below. Since the log is for the process performed before login, the user name is not displayed.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">date:2016-08-18 13:52:32   thread:tomcat-http--10  USER:   X-Track:1a37a9a280014216a300b61e2f4bbb66    level:INFO  logger:o.t.s.d.c.i.ServiceCallLoggingInterceptor        message:[SERVICE THROWS EXCEPTION]AccountSharedService.findOne</span>
<span class="go">date:2016-08-18 13:52:32   thread:tomcat-http--10  USER:   X-Track:1a37a9a280014216a300b61e2f4bbb66    level:INFO  logger:o.t.s.d.c.i.ServiceCallLoggingInterceptor        message:[SERVICE THROWS EXCEPTION]UserDetailsService.loadUserByUsername</span>
<span class="go">date:2016-08-18 13:52:32   thread:tomcat-http--10  USER:   X-Track:1a37a9a280014216a300b61e2f4bbb66    level:INFO  logger:o.t.s.d.c.i.ServiceCallLoggingInterceptor        message:user not found</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="section" id="conclusion">
<h2><a class="toc-backref" href="#id107">9.10.4. Conclusion</a><a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line">This chapter explains about an example of implementation method for security measures using a sample application.</div>
<div class="line">Since it is likely that implementation method in this application cannot be used as it is in the actual development, a different customised method must be considered according to the requirements, using details of this chapter as a reference.</div>
</div>
</div>
<div class="section" id="appendix">
<h2><a class="toc-backref" href="#id108">9.10.5. Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this headline">¶</a></h2>
<div class="section" id="passay-overview">
<span id="id37"></span><h3><a class="toc-backref" href="#id109">9.10.5.1. Passay</a><a class="headerlink" href="#passay-overview" title="Permalink to this headline">¶</a></h3>
<p>Passay is a library which offers a password validation function and a password generation function.
Passay API consists of following three key components.</p>
<ul>
<li><p class="first">Validation rules</p>
<p>It defines the conditions which must be fulfilled by password. Validation rules which are used widely like length of the password and characters types to be included can be created easily by using the class offered by library. Besides, the necessary validation rules can also be defined by the user.</p>
</li>
<li><p class="first">Validator</p>
<p>A component which performs password validation based on validation rules. Various validation rules can be specified in a single validator.</p>
</li>
<li><p class="first">Generator</p>
<p>A component which generates a password in conformance with the validation rules for the assigned character type.</p>
</li>
</ul>
<p>When Passay function is to be used, following definition must be added to pom.xml.</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependencies&gt;</span>
  <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.passay<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>passay<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>1.1.0<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependencies&gt;</span>
</pre></div>
</div>
<div class="section" id="password-validation">
<span id="id38"></span><h4><a class="toc-backref" href="#id110">9.10.5.1.1. Password validation</a><a class="headerlink" href="#password-validation" title="Permalink to this headline">¶</a></h4>
<div class="section" id="overview">
<h5>9.10.5.1.1.1. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h5>
<div class="line-block">
<div class="line">A schematic diagram of the password validation flow in Passay is shown below.</div>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_passay.png"><img alt="Password Vaildation" src="../_images/SecureLogin_passay.png" style="width: 60%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create an instance of <code class="docutils literal"><span class="pre">org.passay.PasswordData</span></code>  and specify information related to password to be validated.</div>
<div class="line"><code class="docutils literal"><span class="pre">PasswordData</span></code>  can include list of passwords used in the past as a property in addition to password and user name.</div>
<div class="line">Passwords used in the past are retained as an instance of <code class="docutils literal"><span class="pre">org.passay.PasswordData.Reference</span></code> .</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Perform validation for <code class="docutils literal"><span class="pre">PasswordData</span></code> using a validator, in accordance with the validation rules.</div>
<div class="line">Validation rules are created as an instance of implementation class of <code class="docutils literal"><span class="pre">org.passay.Rule</span></code> . A validator is an instance of <code class="docutils literal"><span class="pre">org.passay.PasswordValidator</span></code>  and can include multiple validation rules as properties.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">An instance of <code class="docutils literal"><span class="pre">org.passay.RuleResult</span></code>  is created as validation result using a validator.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Password validation results can be fetched from <code class="docutils literal"><span class="pre">RuleResult</span></code>  as a <code class="docutils literal"><span class="pre">boolean</span></code>  value. Also, an error message can be fetched from <code class="docutils literal"><span class="pre">RuleResult</span></code>  by using a validator.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Some of the classes of validation rules offered by Passay are shown in the table below.</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="20%" />
<col width="40%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Class Name</th>
<th class="head">Description</th>
<th class="head">Key properties</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">LengthRule</span></code> </div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A class of validation rules to specify minimum and maximum value for password length.</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">minimuxLength</span></code> : Minimum value for password length (<code class="docutils literal"><span class="pre">int</span></code> ). Specify in constructor or setter.</div>
<div class="line"><code class="docutils literal"><span class="pre">maximumLength</span></code> : Maximum value for password length (<code class="docutils literal"><span class="pre">int</span></code> )。Specify in constructor or setter.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">CharacterRule</span></code> </div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A class of validation rules to specify character types that must be included in the password and the minimum number of characters of that character type.</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">characterData</span></code>: Character type (<code class="docutils literal"><span class="pre">org.passay.CharacterData</span></code> ). Specify in constructor.</div>
<div class="line"><code class="docutils literal"><span class="pre">numberOfCharacters</span></code> : Minimum number of characters (<code class="docutils literal"><span class="pre">int</span></code> ). Specify in constructor or setter.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">CharacterCharacteristicsRule</span></code> </div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A class of validation rules which specify the number of rules that should be fulfilled, from multiple <code class="docutils literal"><span class="pre">CharacterRule</span></code> .</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">rules</span></code>: List of validation rules related to character types (<code class="docutils literal"><span class="pre">List&lt;CharacterRule&gt;</span></code> ). Specify in setter.</div>
<div class="line"><code class="docutils literal"><span class="pre">numberOfCharacteristics</span></code> : Minimum number of rules that should be fulfilled (<code class="docutils literal"><span class="pre">int</span></code> ). Specify in setter.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">HistoryRule</span></code> </div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A class of validation rules which checks the pasword does not match with the password used previously.</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">None</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UsernameRule</span></code> </div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A class of validation rules to check that password should not contain the user name.</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">matchBackwards</span></code> : Also check whether the user name has been used in the reverse (<code class="docutils literal"><span class="pre">boolean</span></code> ). Specify in constructor or setter.</div>
<div class="line"><code class="docutils literal"><span class="pre">ignoreCase</span></code> : Not case-sensitive (<code class="docutils literal"><span class="pre">boolean</span></code> ). Specify in constructor or setter.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>In addition, classes of validation rules to check whether a specific character is to be included or to check using a regular expression are also provided.
For details, refer <a class="reference external" href="http://www.passay.org/">http://www.passay.org/</a>.</p>
</div>
<div class="section" id="how-to-use">
<h5>9.10.5.1.1.2. How to use<a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h5>
<p>A validator can be created by passing the list of <code class="docutils literal"><span class="pre">org.passay.Rule</span></code>  instance to the constructor of <code class="docutils literal"><span class="pre">PasswordValidator</span></code> .
DI can be applied by defining a Bean for validator as below which specifies the validation rules.
Note that, when a Bean is to be defined for multiple validation rules, DI must be applied using a Bean name, by combining <code class="docutils literal"><span class="pre">&#64;Inject</span></code>  and <code class="docutils literal"><span class="pre">&#64;Named</span></code> .</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- Password Rules. --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;upperCaseRule&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.CharacterRule&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;data&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:constant</span> <span class="na">static-field=</span><span class="s">&quot;org.passay.EnglishCharacterData.UpperCase&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;num&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;lowerCaseRule&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.CharacterRule&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;data&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:constant</span> <span class="na">static-field=</span><span class="s">&quot;org.passay.EnglishCharacterData.LowerCase&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;num&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;digitRule&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.CharacterRule&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (5) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;data&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:constant</span> <span class="na">static-field=</span><span class="s">&quot;org.passay.EnglishCharacterData.Digit&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;num&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- Password Validator. --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;characterPasswordValidator&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.PasswordValidator&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (6) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;rules&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;list&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;upperCaseRule&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;lowerCaseRule&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;digitRule&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for validation rules for specifying character type that must be included in the password and minimum number of characters for the character type.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify character type. Since <code class="docutils literal"><span class="pre">org.passay.EnglishCharacterData.UpperCase</span></code>  is passed, validation rules are set for single byte uppercase characters.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify number of characters. Since “1” is passed, validation rules are set to check whether one or more single byte uppercase characters are included.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It is similar to (1)-(3), however since <code class="docutils literal"><span class="pre">org.passay.EnglishCharacterData.LowerCase</span></code>  is passed as a character type, a bean is defined for the validation rules to check whether one or more single byte lowercase letters are included.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It is similar to (1)-(3), however, since <code class="docutils literal"><span class="pre">org.passay.EnglishCharacterData.Digit</span></code>  is passed as a character type, a bean is defined for the validation rules to check whether one or more single byte digit is included.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for validator. Pass a list of validation rules to the constructor.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Perform password validation by using created validator.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="n">PasswordValidator</span> <span class="n">characterPasswordValidator</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">validatePassword</span><span class="o">(</span><span class="n">String</span> <span class="n">password</span><span class="o">){</span>

    <span class="n">PasswordData</span> <span class="n">pd</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PasswordData</span><span class="o">(</span><span class="n">password</span><span class="o">);</span> <span class="c1">// (1)</span>
    <span class="n">RuleResult</span> <span class="n">result</span> <span class="o">=</span> <span class="n">characterPasswordValidator</span><span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">pd</span><span class="o">);</span> <span class="c1">// (2)</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">isValid</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// (3)</span>
       <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Password is valid&quot;</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
       <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;Invalid password:&quot;</span><span class="o">);</span>
       <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">msg</span> <span class="o">:</span> <span class="n">characterPasswordValidator</span><span class="o">.</span><span class="na">getMessages</span><span class="o">(</span><span class="n">result</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// (4)</span>
           <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
       <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Pass the password to be validated to the constructor of <code class="docutils literal"><span class="pre">PasswordData</span></code>  and create an instance.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Pass <code class="docutils literal"><span class="pre">PasswordData</span></code>  in the <code class="docutils literal"><span class="pre">validate</span></code>  method of <code class="docutils literal"><span class="pre">PasswordValidator</span></code>  as an argument and implement password validation.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch password validation results in truth value by using <code class="docutils literal"><span class="pre">isValid</span></code>  method of <code class="docutils literal"><span class="pre">RuleResult</span></code> .</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Pass <code class="docutils literal"><span class="pre">RuleResult</span></code>  in <code class="docutils literal"><span class="pre">getMessages</span></code>  method of <code class="docutils literal"><span class="pre">PasswordValidator</span></code>  as an argument and fetch error message.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="password-generation">
<span id="id39"></span><h4><a class="toc-backref" href="#id111">9.10.5.1.2. Password generation</a><a class="headerlink" href="#password-generation" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id40">
<h5>9.10.5.1.2.1. Overview<a class="headerlink" href="#id40" title="Permalink to this headline">¶</a></h5>
<div class="line-block">
<div class="line">Password generator and generation rules are used in the password generation function for Passay. A generator is an instance of <code class="docutils literal"><span class="pre">org.passay.PasswordGenerator</span></code> and the generation rules is a list of validation rules related to character type (<code class="docutils literal"><span class="pre">org.passay.CharacterRule</span></code> ).</div>
<div class="line">By assigning the length of the password to be generated and generation rules to the method of generator as arguments, a password which fulfils the generation rules is generated.</div>
</div>
</div>
<div class="section" id="id41">
<h5>9.10.5.1.2.2. How to use<a class="headerlink" href="#id41" title="Permalink to this headline">¶</a></h5>
<p>A method of creation of validation rules related to character type which is included in the generation rules is similar to <a class="reference internal" href="#password-validation"><span class="std std-ref">Password validation</span></a>.
DI can be applied by defining a bean for generation rules and generator as given below.</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- Password Rules. --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;upperCaseRule&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.CharacterRule&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;data&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:constant</span> <span class="na">static-field=</span><span class="s">&quot;org.passay.EnglishCharacterData.UpperCase&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;num&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;lowerCaseRule&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.CharacterRule&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;data&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:constant</span> <span class="na">static-field=</span><span class="s">&quot;org.passay.EnglishCharacterData.LowerCase&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;num&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;digitRule&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.CharacterRule&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (5) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;data&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:constant</span> <span class="na">static-field=</span><span class="s">&quot;org.passay.EnglishCharacterData.Digit&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;num&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

 <span class="c">&lt;!-- Password Generator. --&gt;</span>
 <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;passwordGenerator&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.PasswordGenerator&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (6) --&gt;</span>
 <span class="nt">&lt;util:list</span> <span class="na">id=</span><span class="s">&quot;passwordGenerationRules&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (7) --&gt;</span>
     <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;upperCaseRule&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;lowerCaseRule&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;digitRule&quot;</span> <span class="nt">/&gt;</span>
 <span class="nt">&lt;/util:list&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for validation rules for specifying the character type that should be included in the password, and minimum number of characters for the character type.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify character type. Since <code class="docutils literal"><span class="pre">org.passay.EnglishCharacterData.UpperCase</span></code>  is passed, validation rules are set for single byte uppercase characters.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify number of characters. Since “1” is passed, validation rules are set to check whether one or more single byte uppercase characters are included.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It is similar to (1)-(3), however since <code class="docutils literal"><span class="pre">org.passay.EnglishCharacterData.LowerCase</span></code>  is passed as a character type, a bean is defined for the validation rules to check whether one or more single byte lowercase letters are included.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It is similar to (1)-(3), however, since <code class="docutils literal"><span class="pre">org.passay.EnglishCharacterData.Digit</span></code>  is passed as a character type, a bean is defined for the validation rules to check whether one or more single byte digit is included.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a bean for generator.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a bean for generation rules. It is defined as a list of validation rules related to character type, defined in (1)-(5).</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Create a password by using created generator and generation rules.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="n">PasswordGenerator</span> <span class="n">passwordGenerator</span><span class="o">;</span>

<span class="nd">@Resource</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;passwordGenerationRules&quot;</span><span class="o">)</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">CharacterRule</span><span class="o">&gt;</span> <span class="n">passwordGenerationRules</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">generatePassword</span><span class="o">(){</span>

    <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">passwordGenerator</span><span class="o">.</span><span class="na">generatePassword</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="n">passwordGenerationRules</span><span class="o">);</span> <span class="c1">// (1)</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">If length of the password to be generated and the generation rules are passed to <code class="docutils literal"><span class="pre">generatePassword</span></code>  method of <code class="docutils literal"><span class="pre">PasswordGenerator</span></code>  as arguments, a password which fulfils the generation rules is created.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">When DI is to be applied to a collection for which a Bean is defined, an expected operation is not performed by <code class="docutils literal"><span class="pre">&#64;Inject</span></code>  + <code class="docutils literal"><span class="pre">&#64;Named</span></code> .
Therefore, DI is applied by Bean name using <code class="docutils literal"><span class="pre">&#64;Resource</span></code>  instead.</p>
</div>
</div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../UnitTest/index.html" title="10. Unit test"
             >next</a> |</li>
        <li class="right" >
          <a href="OAuth.html" title="9.9. OAuth"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.4.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >9. Security countermeasures</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer">
      © Copyright 2013-2018, NTT DATA Corporation. © Copyright 2013-2018, NTT Corporation.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3.Theme is <a href="http://github.com/vimalkvn/solar-theme">Solar</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>9.9. OAuth &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.4.1.RELEASE documentation</title>
    <link rel="stylesheet" href="../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '5.4.1.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="9.10. Implementation Example of Typical Security Requirements" href="SecureLoginDemo.html" />
    <link rel="prev" title="9.8. Encryption" href="Encryption.html" /><script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="SecureLoginDemo.html" title="9.10. Implementation Example of Typical Security Requirements"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Encryption.html" title="9.8. Encryption"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.4.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">9. Security countermeasures</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><br/><img src="../_static/logo_color.png" alt="TERASOLUNA" ><br/><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">9.9. OAuth</a><ul>
<li><a class="reference internal" href="#overview">9.9.1. Overview</a><ul>
<li><a class="reference internal" href="#about-oauth-2-0">9.9.1.1. About OAuth 2.0</a></li>
<li><a class="reference internal" href="#architecture-of-oauth-2-0">9.9.1.2. Architecture of OAuth 2.0</a><ul>
<li><a class="reference internal" href="#roles">9.9.1.2.1. Roles</a></li>
<li><a class="reference internal" href="#scope">9.9.1.2.2. Scope</a></li>
<li><a class="reference internal" href="#protocol-flow">9.9.1.2.3. Protocol flow</a></li>
<li><a class="reference internal" href="#authorization-grant">9.9.1.2.4. Authorization grant</a><ul>
<li><a class="reference internal" href="#authorization-code-grant">9.9.1.2.4.1. Authorization code grant</a></li>
<li><a class="reference internal" href="#implicit-grant">9.9.1.2.4.2. Implicit grant</a></li>
<li><a class="reference internal" href="#resource-owner-password-credential-grant">9.9.1.2.4.3. Resource owner password credential grant</a></li>
<li><a class="reference internal" href="#client-credential-grant">9.9.1.2.4.4. Client credential grant</a></li>
</ul>
</li>
<li><a class="reference internal" href="#life-cycle-of-access-token">9.9.1.2.5. Life cycle of access token</a></li>
</ul>
</li>
<li><a class="reference internal" href="#architecture-of-spring-security-oauth">9.9.1.3. Architecture of Spring Security OAuth</a><ul>
<li><a class="reference internal" href="#authorization-server">9.9.1.3.1. Authorization server</a><ul>
<li><a class="reference internal" href="#authentication-of-client">9.9.1.3.1.1. Authentication of client</a></li>
<li><a class="reference internal" href="#authentication-of-resource-owner">9.9.1.3.1.2. Authentication of resource owner</a></li>
<li><a class="reference internal" href="#fetching-authorization-from-resource-owner">9.9.1.3.1.3. Fetching authorization from resource owner</a><ul>
<li><a class="reference internal" href="#unauthorized-client-error">9.9.1.3.1.3.1. Unauthorized client error</a></li>
</ul>
</li>
<li><a class="reference internal" href="#issue-of-access-token">9.9.1.3.1.4. Issue of access token</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resource-server">9.9.1.3.2. Resource server</a></li>
<li><a class="reference internal" href="#client">9.9.1.3.3. Client</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">9.9.2. How to use</a><ul>
<li><a class="reference internal" href="#how-to-use-configuration">9.9.2.1. How to Use Configuration</a></li>
<li><a class="reference internal" href="#set-up-of-spring-security-oauth">9.9.2.2. Set-up of Spring Security OAuth</a></li>
<li><a class="reference internal" href="#implementation-of-authorization-code-grant">9.9.2.3. Implementation of authorization code grant</a><ul>
<li><a class="reference internal" href="#implementation-of-authorization-server">9.9.2.3.1. Implementation of authorization server</a><ul>
<li><a class="reference internal" href="#creation-of-setting-file-authorization-server">9.9.2.3.1.1. Creation of setting file (Authorization server)</a></li>
<li><a class="reference internal" href="#defining-authorization-server">9.9.2.3.1.2. Defining authorization server</a></li>
<li><a class="reference internal" href="#client-authentication">9.9.2.3.1.3. Client authentication</a></li>
<li><a class="reference internal" href="#resource-owner-authentication">9.9.2.3.1.4. Resource owner authentication</a></li>
<li><a class="reference internal" href="#authorization-for-each-scope">9.9.2.3.1.5. Authorization for each scope</a></li>
<li><a class="reference internal" href="#customising-scope-authorization-screen">9.9.2.3.1.6. Customising scope authorization screen</a></li>
<li><a class="reference internal" href="#error-handling-at-the-time-of-authorization-request">9.9.2.3.1.7. Error handling at the time of authorization request</a></li>
<li><a class="reference internal" href="#how-to-share-access-token-with-resource-server">9.9.2.3.1.8. How to share access token with resource server</a></li>
<li><a class="reference internal" href="#canceling-a-token-authorization-server">9.9.2.3.1.9. Canceling a token (authorization server)</a></li>
<li><a class="reference internal" href="#transaction-control">9.9.2.3.1.10. Transaction control</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-of-resource-server">9.9.2.3.2. Implementation of resource server</a><ul>
<li><a class="reference internal" href="#creating-a-setup-file-resource-server">9.9.2.3.2.1. Creating a setup file (resource server)</a></li>
<li><a class="reference internal" href="#setting-of-accessible-scope-for-the-resource">9.9.2.3.2.2. Setting of accessible scope for the resource</a></li>
<li><a class="reference internal" href="#how-to-link-access-token-with-authorization-server">9.9.2.3.2.3. How to link access token with authorization server</a></li>
<li><a class="reference internal" href="#fetching-user-information">9.9.2.3.2.4. Fetching user information</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-of-client">9.9.2.3.3. Implementation of client</a><ul>
<li><a class="reference internal" href="#creation-of-configuration-file-client">9.9.2.3.3.1. Creation of configuration file (Client)</a></li>
<li><a class="reference internal" href="#applying-oauth2clientcontextfilter">9.9.2.3.3.2. Applying OAuth2ClientContextFilter</a></li>
<li><a class="reference internal" href="#settings-of-oauth2resttemplate">9.9.2.3.3.3. Settings of OAuth2RestTemplate</a></li>
<li><a class="reference internal" href="#accessing-a-resource-server">9.9.2.3.3.4. Accessing a resource Server</a></li>
<li><a class="reference internal" href="#cancelling-a-token-client-server">9.9.2.3.3.5. Cancelling a token (Client server)</a></li>
<li><a class="reference internal" href="#error-handling">9.9.2.3.3.6. Error handling</a><ul>
<li><a class="reference internal" href="#error-handling-while-accessing-authorization-end-point">9.9.2.3.3.6.1. Error handling while accessing authorization end point</a></li>
<li><a class="reference internal" href="#token-end-point-and-error-handling-while-accessing-resource-server">9.9.2.3.3.6.2. Token end point and error handling while accessing resource server</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-of-implicit-grant">9.9.2.4. Implementation of implicit grant</a><ul>
<li><a class="reference internal" href="#implementationoauthauthorizationserverofimplicit">9.9.2.4.1. Implementation of authorization server</a><ul>
<li><a class="reference internal" href="#id5">9.9.2.4.1.1. Defining authorization server</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementationoauthresourceserverofimplicit">9.9.2.4.2. Implementation of resource server</a></li>
<li><a class="reference internal" href="#implementationoauthclientserverofimplicit">9.9.2.4.3. Implementation of client</a><ul>
<li><a class="reference internal" href="#accessing-a-resource-server-which-uses-javascript">9.9.2.4.3.1. Accessing a resource server which uses JavaScript</a></li>
<li><a class="reference internal" href="#id8">9.9.2.4.3.2. Cancelling a token (client server)</a></li>
<li><a class="reference internal" href="#oauthclienterrorhandlingwithimplicit">9.9.2.4.3.3. Error handling</a><ul>
<li><a class="reference internal" href="#oauthclienthandleerrorwhenaccessingauthorizationendpointwithimplicit">9.9.2.4.3.3.1. Error handling while accessing authorization end point</a></li>
<li><a class="reference internal" href="#error-handling-while-accessing-resource-server">9.9.2.4.3.3.2. Error handling while accessing resource server</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-of-resource-owner-password-credential-grant">9.9.2.5. Implementation of resource owner password credential grant</a><ul>
<li><a class="reference internal" href="#implementationoauthauthorizationserverofpassword">9.9.2.5.1. Implementation of authorization server</a><ul>
<li><a class="reference internal" href="#id12">9.9.2.5.1.1. Defining authorization server</a></li>
<li><a class="reference internal" href="#id13">9.9.2.5.1.2. Client authentication</a></li>
<li><a class="reference internal" href="#cancelling-a-token-authorization-server">9.9.2.5.1.3. Cancelling a token (authorization server)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementationoauthresourceserverofpassword">9.9.2.5.2. Implementation of resource server</a></li>
<li><a class="reference internal" href="#implementationoauthclientserverofpassword">9.9.2.5.3. Implementation of client</a><ul>
<li><a class="reference internal" href="#oauth2resttemplate-settings">9.9.2.5.3.1. OAuth2RestTemplate settings</a></li>
<li><a class="reference internal" href="#oauthclienterrorhandlingwithpassword">9.9.2.5.3.2. Error handling</a><ul>
<li><a class="reference internal" href="#error-handling-while-accessing-token-end-point-and-resource-server">9.9.2.5.3.2.1. Error handling while accessing token end point and resource server</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-of-client-credential-grant">9.9.2.6. Implementation of client credential grant</a><ul>
<li><a class="reference internal" href="#implementationoauthauthorizationserverofclientcredentials">9.9.2.6.1. Implementation of authorization server</a><ul>
<li><a class="reference internal" href="#id18">9.9.2.6.1.1. Defining authorization server</a></li>
<li><a class="reference internal" href="#id19">9.9.2.6.1.2. Client authentication</a></li>
<li><a class="reference internal" href="#id20">9.9.2.6.1.3. Cancelling a token (authorization server)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementationoauthresourceserverofclientcredentials">9.9.2.6.2. Implementation of resource server</a><ul>
<li><a class="reference internal" href="#id22">9.9.2.6.2.1. Fetching user information</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementationoauthclientserverofclientcredentials">9.9.2.6.3. Implementation of client</a><ul>
<li><a class="reference internal" href="#id24">9.9.2.6.3.1. OAuth2RestTemplate settings</a></li>
<li><a class="reference internal" href="#oauthclienterrorhandlingwithclient">9.9.2.6.3.2. Error handling</a><ul>
<li><a class="reference internal" href="#oauthclienthandleerrorwhenaccessingtokenendpointwithclient">9.9.2.6.3.2.1. Error handling while accessing token end point and resource server</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id27">9.9.2.6.3.3. Resource owner authentication</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend">9.9.3. How to extend</a><ul>
<li><a class="reference internal" href="#when-the-multiple-grant-types-are-supported-in-authorization-server">9.9.3.1. When the multiple grant types are supported in authorization server</a></li>
<li><a class="reference internal" href="#linking-authorization-server-and-resource-server-through-http-access">9.9.3.2. Linking Authorization Server and Resource Server through HTTP access</a><ul>
<li><a class="reference internal" href="#setting-authorization-server">9.9.3.2.1. Setting authorization server</a></li>
<li><a class="reference internal" href="#setting-resource-server">9.9.3.2.2. Setting resource server</a></li>
<li><a class="reference internal" href="#a-method-to-link-individual-items-to-resource-server">9.9.3.2.3. A method to link individual items to resource server</a><ul>
<li><a class="reference internal" href="#defaultaccesstokenconverter-means">9.9.3.2.3.1. DefaultAccessTokenConverter means</a></li>
<li><a class="reference internal" href="#id28">9.9.3.2.3.2. Implementation of Authorization Server</a></li>
<li><a class="reference internal" href="#id29">9.9.3.2.3.3. Implementation of Resource Server</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#customization-of-path-in-authorization-server">9.9.3.3. Customization of path in authorization server</a><ul>
<li><a class="reference internal" href="#customizable-path">9.9.3.3.1. Customizable path</a></li>
<li><a class="reference internal" href="#customization-of-path">9.9.3.3.2. Customization of path</a><ul>
<li><a class="reference internal" href="#customization-of-end-point">9.9.3.3.2.1. Customization of end point</a></li>
<li><a class="reference internal" href="#customize-forwarding-destination">9.9.3.3.2.2. Customize forwarding destination</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix">9.9.4. Appendix</a><ul>
<li><a class="reference internal" href="#errors-which-occur-while-accessing-authorization-server-and-resource-server-from-the-client">9.9.4.1. Errors which occur while accessing authorization server and resource server from the client</a><ul>
<li><a class="reference internal" href="#errors-which-occur-at-authorization-end-point">9.9.4.1.1. Errors which occur at authorization end point</a></li>
<li><a class="reference internal" href="#errors-which-occur-at-token-end-point">9.9.4.1.2. Errors which occur at token end point</a></li>
<li><a class="reference internal" href="#errors-which-occur-in-resource-server">9.9.4.1.3. Errors which occur in resource server</a></li>
</ul>
</li>
<li><a class="reference internal" href="#regarding-spring-security-oauth-extension">9.9.4.2. Regarding Spring Security OAuth extension</a><ul>
<li><a class="reference internal" href="#extension-of-access-token-request-and-its-response">9.9.4.2.1. Extension of access token request and its response</a><ul>
<li><a class="reference internal" href="#oauthappendixclient">9.9.4.2.1.1. Client</a></li>
<li><a class="reference internal" href="#oauthappendixauthorizationserver">9.9.4.2.1.2. Authorization server</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="Encryption.html"
                        title="previous chapter">9.8. Encryption</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="SecureLoginDemo.html"
                        title="next chapter">9.10. Implementation Example of Typical Security Requirements</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/Security/OAuth.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="oauth">
<span id="id1"></span><h1>9.9. OAuth<a class="headerlink" href="#oauth" title="Permalink to this headline">¶</a></h1>
<div class="admonition caution">
  <p class="first admonition-title">Caution</p>
  <p><strong>This version is already obsolete</strong>. Please check <a href="http://terasolunaorg.github.io/guideline/">the latest guideline</a>.</p>
</div>
<div class="contents local topic" id="index">
<p class="topic-title first">Index</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id66">Overview</a><ul>
<li><a class="reference internal" href="#about-oauth-2-0" id="id67">About OAuth 2.0</a></li>
<li><a class="reference internal" href="#architecture-of-oauth-2-0" id="id68">Architecture of OAuth 2.0</a><ul>
<li><a class="reference internal" href="#roles" id="id69">Roles</a></li>
<li><a class="reference internal" href="#scope" id="id70">Scope</a></li>
<li><a class="reference internal" href="#protocol-flow" id="id71">Protocol flow</a></li>
<li><a class="reference internal" href="#authorization-grant" id="id72">Authorization grant</a><ul>
<li><a class="reference internal" href="#authorization-code-grant" id="id73">Authorization code grant</a></li>
<li><a class="reference internal" href="#implicit-grant" id="id74">Implicit grant</a></li>
<li><a class="reference internal" href="#resource-owner-password-credential-grant" id="id75">Resource owner password credential grant</a></li>
<li><a class="reference internal" href="#client-credential-grant" id="id76">Client credential grant</a></li>
</ul>
</li>
<li><a class="reference internal" href="#life-cycle-of-access-token" id="id77">Life cycle of access token</a></li>
</ul>
</li>
<li><a class="reference internal" href="#architecture-of-spring-security-oauth" id="id78">Architecture of Spring Security OAuth</a><ul>
<li><a class="reference internal" href="#authorization-server" id="id79">Authorization server</a><ul>
<li><a class="reference internal" href="#authentication-of-client" id="id80">Authentication of client</a></li>
<li><a class="reference internal" href="#authentication-of-resource-owner" id="id81">Authentication of resource owner</a></li>
<li><a class="reference internal" href="#fetching-authorization-from-resource-owner" id="id82">Fetching authorization from resource owner</a><ul>
<li><a class="reference internal" href="#unauthorized-client-error" id="id83">Unauthorized client error</a></li>
</ul>
</li>
<li><a class="reference internal" href="#issue-of-access-token" id="id84">Issue of access token</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resource-server" id="id85">Resource server</a></li>
<li><a class="reference internal" href="#client" id="id86">Client</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use" id="id87">How to use</a><ul>
<li><a class="reference internal" href="#how-to-use-configuration" id="id88">How to Use Configuration</a></li>
<li><a class="reference internal" href="#set-up-of-spring-security-oauth" id="id89">Set-up of Spring Security OAuth</a></li>
<li><a class="reference internal" href="#implementation-of-authorization-code-grant" id="id90">Implementation of authorization code grant</a><ul>
<li><a class="reference internal" href="#implementation-of-authorization-server" id="id91">Implementation of authorization server</a><ul>
<li><a class="reference internal" href="#creation-of-setting-file-authorization-server" id="id92">Creation of setting file (Authorization server)</a></li>
<li><a class="reference internal" href="#defining-authorization-server" id="id93">Defining authorization server</a></li>
<li><a class="reference internal" href="#client-authentication" id="id94">Client authentication</a></li>
<li><a class="reference internal" href="#resource-owner-authentication" id="id95">Resource owner authentication</a></li>
<li><a class="reference internal" href="#authorization-for-each-scope" id="id96">Authorization for each scope</a></li>
<li><a class="reference internal" href="#customising-scope-authorization-screen" id="id97">Customising scope authorization screen</a></li>
<li><a class="reference internal" href="#error-handling-at-the-time-of-authorization-request" id="id98">Error handling at the time of authorization request</a></li>
<li><a class="reference internal" href="#how-to-share-access-token-with-resource-server" id="id99">How to share access token with resource server</a></li>
<li><a class="reference internal" href="#canceling-a-token-authorization-server" id="id100">Canceling a token (authorization server)</a></li>
<li><a class="reference internal" href="#transaction-control" id="id101">Transaction control</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-of-resource-server" id="id102">Implementation of resource server</a><ul>
<li><a class="reference internal" href="#creating-a-setup-file-resource-server" id="id103">Creating a setup file (resource server)</a></li>
<li><a class="reference internal" href="#setting-of-accessible-scope-for-the-resource" id="id104">Setting of accessible scope for the resource</a></li>
<li><a class="reference internal" href="#how-to-link-access-token-with-authorization-server" id="id105">How to link access token with authorization server</a></li>
<li><a class="reference internal" href="#fetching-user-information" id="id106">Fetching user information</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-of-client" id="id107">Implementation of client</a><ul>
<li><a class="reference internal" href="#creation-of-configuration-file-client" id="id108">Creation of configuration file (Client)</a></li>
<li><a class="reference internal" href="#applying-oauth2clientcontextfilter" id="id109">Applying OAuth2ClientContextFilter</a></li>
<li><a class="reference internal" href="#settings-of-oauth2resttemplate" id="id110">Settings of OAuth2RestTemplate</a></li>
<li><a class="reference internal" href="#accessing-a-resource-server" id="id111">Accessing a resource Server</a></li>
<li><a class="reference internal" href="#cancelling-a-token-client-server" id="id112">Cancelling a token (Client server)</a></li>
<li><a class="reference internal" href="#error-handling" id="id113">Error handling</a><ul>
<li><a class="reference internal" href="#error-handling-while-accessing-authorization-end-point" id="id114">Error handling while accessing authorization end point</a></li>
<li><a class="reference internal" href="#token-end-point-and-error-handling-while-accessing-resource-server" id="id115">Token end point and error handling while accessing resource server</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-of-implicit-grant" id="id116">Implementation of implicit grant</a><ul>
<li><a class="reference internal" href="#implementationoauthauthorizationserverofimplicit" id="id117">Implementation of authorization server</a><ul>
<li><a class="reference internal" href="#id5" id="id118">Defining authorization server</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementationoauthresourceserverofimplicit" id="id119">Implementation of resource server</a></li>
<li><a class="reference internal" href="#implementationoauthclientserverofimplicit" id="id120">Implementation of client</a><ul>
<li><a class="reference internal" href="#accessing-a-resource-server-which-uses-javascript" id="id121">Accessing a resource server which uses JavaScript</a></li>
<li><a class="reference internal" href="#id8" id="id122">Cancelling a token (client server)</a></li>
<li><a class="reference internal" href="#oauthclienterrorhandlingwithimplicit" id="id123">Error handling</a><ul>
<li><a class="reference internal" href="#oauthclienthandleerrorwhenaccessingauthorizationendpointwithimplicit" id="id124">Error handling while accessing authorization end point</a></li>
<li><a class="reference internal" href="#error-handling-while-accessing-resource-server" id="id125">Error handling while accessing resource server</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-of-resource-owner-password-credential-grant" id="id126">Implementation of resource owner password credential grant</a><ul>
<li><a class="reference internal" href="#implementationoauthauthorizationserverofpassword" id="id127">Implementation of authorization server</a><ul>
<li><a class="reference internal" href="#id12" id="id128">Defining authorization server</a></li>
<li><a class="reference internal" href="#id13" id="id129">Client authentication</a></li>
<li><a class="reference internal" href="#cancelling-a-token-authorization-server" id="id130">Cancelling a token (authorization server)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementationoauthresourceserverofpassword" id="id131">Implementation of resource server</a></li>
<li><a class="reference internal" href="#implementationoauthclientserverofpassword" id="id132">Implementation of client</a><ul>
<li><a class="reference internal" href="#oauth2resttemplate-settings" id="id133">OAuth2RestTemplate settings</a></li>
<li><a class="reference internal" href="#oauthclienterrorhandlingwithpassword" id="id134">Error handling</a><ul>
<li><a class="reference internal" href="#error-handling-while-accessing-token-end-point-and-resource-server" id="id135">Error handling while accessing token end point and resource server</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-of-client-credential-grant" id="id136">Implementation of client credential grant</a><ul>
<li><a class="reference internal" href="#implementationoauthauthorizationserverofclientcredentials" id="id137">Implementation of authorization server</a><ul>
<li><a class="reference internal" href="#id18" id="id138">Defining authorization server</a></li>
<li><a class="reference internal" href="#id19" id="id139">Client authentication</a></li>
<li><a class="reference internal" href="#id20" id="id140">Cancelling a token (authorization server)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementationoauthresourceserverofclientcredentials" id="id141">Implementation of resource server</a><ul>
<li><a class="reference internal" href="#id22" id="id142">Fetching user information</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementationoauthclientserverofclientcredentials" id="id143">Implementation of client</a><ul>
<li><a class="reference internal" href="#id24" id="id144">OAuth2RestTemplate settings</a></li>
<li><a class="reference internal" href="#oauthclienterrorhandlingwithclient" id="id145">Error handling</a><ul>
<li><a class="reference internal" href="#oauthclienthandleerrorwhenaccessingtokenendpointwithclient" id="id146">Error handling while accessing token end point and resource server</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id27" id="id147">Resource owner authentication</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend" id="id148">How to extend</a><ul>
<li><a class="reference internal" href="#when-the-multiple-grant-types-are-supported-in-authorization-server" id="id149">When the multiple grant types are supported in authorization server</a></li>
<li><a class="reference internal" href="#linking-authorization-server-and-resource-server-through-http-access" id="id150">Linking Authorization Server and Resource Server through HTTP access</a><ul>
<li><a class="reference internal" href="#setting-authorization-server" id="id151">Setting authorization server</a></li>
<li><a class="reference internal" href="#setting-resource-server" id="id152">Setting resource server</a></li>
<li><a class="reference internal" href="#a-method-to-link-individual-items-to-resource-server" id="id153">A method to link individual items to resource server</a><ul>
<li><a class="reference internal" href="#defaultaccesstokenconverter-means" id="id154">DefaultAccessTokenConverter means</a></li>
<li><a class="reference internal" href="#id28" id="id155">Implementation of Authorization Server</a></li>
<li><a class="reference internal" href="#id29" id="id156">Implementation of Resource Server</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#customization-of-path-in-authorization-server" id="id157">Customization of path in authorization server</a><ul>
<li><a class="reference internal" href="#customizable-path" id="id158">Customizable path</a></li>
<li><a class="reference internal" href="#customization-of-path" id="id159">Customization of path</a><ul>
<li><a class="reference internal" href="#customization-of-end-point" id="id160">Customization of end point</a></li>
<li><a class="reference internal" href="#customize-forwarding-destination" id="id161">Customize forwarding destination</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix" id="id162">Appendix</a><ul>
<li><a class="reference internal" href="#errors-which-occur-while-accessing-authorization-server-and-resource-server-from-the-client" id="id163">Errors which occur while accessing authorization server and resource server from the client</a><ul>
<li><a class="reference internal" href="#errors-which-occur-at-authorization-end-point" id="id164">Errors which occur at authorization end point</a></li>
<li><a class="reference internal" href="#errors-which-occur-at-token-end-point" id="id165">Errors which occur at token end point</a></li>
<li><a class="reference internal" href="#errors-which-occur-in-resource-server" id="id166">Errors which occur in resource server</a></li>
</ul>
</li>
<li><a class="reference internal" href="#regarding-spring-security-oauth-extension" id="id167">Regarding Spring Security OAuth extension</a><ul>
<li><a class="reference internal" href="#extension-of-access-token-request-and-its-response" id="id168">Extension of access token request and its response</a><ul>
<li><a class="reference internal" href="#oauthappendixclient" id="id169">Client</a></li>
<li><a class="reference internal" href="#oauthappendixauthorizationserver" id="id170">Authorization server</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<span id="oauthoverview"></span><h2><a class="toc-backref" href="#id66">9.9.1. Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This section explains the overview of OAuth 2.0 and the method to implement authorization control function as per the specifications of OAuth 2.0,
by using Spring Security OAuth which is one of the Spring project.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>Reference of Spring Security OAuth</strong></p>
<p class="last">Spring Security OAuth also provides the functions which are not introduced in this guideline.
Refer to   <a class="reference external" href="https://projects.spring.io/spring-security-oauth/docs/oauth2.html">OAuth 2 Developers Guide</a> , for the details of Spring Security OAuth.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="about-oauth-2-0">
<span id="oauthaboutoauth2-0"></span><h3><a class="toc-backref" href="#id67">9.9.1.1. About OAuth 2.0</a><a class="headerlink" href="#about-oauth-2-0" title="Permalink to this headline">¶</a></h3>
<p>OAuth 2.0 is the authorization framework where access range can be specified for the resources protected on server,
when HTTP service is used in third-party application.</p>
<p>OAuth 2.0 is specified as RFC, and it consists of various related technical specifications.</p>
<p>Important specifications of OAuth 2.0 are as follows.</p>
<table border="1" class="colwidths-given longtable docutils" id="id33">
<caption><span class="caption-text"><strong>OAuth 2.0 important specifications</strong></span><a class="headerlink" href="#id33" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="15%" />
<col width="30%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">RFC</th>
<th class="head">Overview</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">RFC 6749</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="http://tools.ietf.org/html/rfc6749">The OAuth 2.0 Authorization Framework</a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Technical specifications describing the most fundamental contents of OAuth 2.0, such as terminology and authorization methods.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">RFC 6750</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="https://tools.ietf.org/html/rfc6750">Bearer Token Usage</a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Technical specifications related to method of transferring the “Access token without signature” (Hereafter, referred as access token) within servers,
which is used for authorization control described in RFC 6749.</div>
<div class="line">Information about access token is described later.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">RFC 6819</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="https://tools.ietf.org/html/rfc6819">Threat Model and Security Considerations</a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Technical specifications about the security requirements that need to be considered while using OAuth 2.0</div>
<div class="line">In these guidelines, the concrete explanation about the study items is omitted.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">RFC 7519</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="https://tools.ietf.org/html/rfc7519">JSON Web Token (JWT)</a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Technical specifications related to “JSON Web Token (JWT)” which is a token including JSON that can be signed.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">RFC 7523</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="https://tools.ietf.org/html/rfc7523">JSON Web Token (JWT) Profile for OAuth 2.0 Client Authentication and Authorization Grants</a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Technical specifications related to method of using JWT prescribed in RFC 6819 as an access token to be used for authorization control described in RFC 6749.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">RFC 7009</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="https://tools.ietf.org/html/rfc7009">OAuth 2.0 Token Revocation</a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Technical specifications related to additional end point invalidating the token.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>In conventional client-server type authentication model, the third-party application performs authentication by using user authentication information (user name and password etc.)
in order to access the resources of the HTTP service.</p>
<p>In other words, user needs to share the authentication information with third party in order to provide the rights to
third party applications for accessing the resources; however it has the risks such as unintended access and
information leakage by the user, if there are defects and malicious operations
in third party application.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_TraditionalAuthenticationModel.png"><img alt="../_images/OAuth_TraditionalAuthenticationModel.png" src="../_images/OAuth_TraditionalAuthenticationModel.png" style="width: 100%;" /></a>
</div>
<p>On the other hand, in OAuth 2.0, authentication with HTTP service can be directly performed by the user,
and third party applications can access resources without sharing authentication information to third parties
by issuing information for authenticated requests called as “access token”.</p>
<p>Moreover, more flexible access control is achieved as compared with conventional client-server type authentication model,
by enabling the specification of access range (scope) of resources when access token is issued.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_OAuthAuthenticationModel.png"><img alt="../_images/OAuth_OAuthAuthenticationModel.png" src="../_images/OAuth_OAuthAuthenticationModel.png" style="width: 100%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="architecture-of-oauth-2-0">
<span id="oautharchitecture"></span><h3><a class="toc-backref" href="#id68">9.9.1.2. Architecture of OAuth 2.0</a><a class="headerlink" href="#architecture-of-oauth-2-0" title="Permalink to this headline">¶</a></h3>
<p>This section explains the roles, scope, authorization grant, and protocol flow defined in OAuth 2.0.
In OAuth 2.0, concepts such as scope and authorization grant are defined, and the specifications of authorization are prescribed by using these concepts.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="roles">
<span id="oauthrole"></span><h4><a class="toc-backref" href="#id69">9.9.1.2.1. Roles</a><a class="headerlink" href="#roles" title="Permalink to this headline">¶</a></h4>
<p>Following 4 roles are defined in OAuth 2.0.</p>
<table border="1" class="colwidths-given longtable docutils" id="id34">
<caption><span class="caption-text"><strong>Roles in OAuth 2.0</strong></span><a class="headerlink" href="#id34" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Role name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">Resource owner</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Role permitting the access to protected resources. User (End user) etc.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">Resource server</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Server providing the protected resources.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">Authorization server</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Server authenticating resource owner and issuing the access token (Information necessary for  client to access the resource server).</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">Client</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">Role getting the authorization of resource owner and making the request for protected resources on behalf of resource owner. Web application etc. Client information is registered in the authorization server in-advance and managed by client ID which is unique in the authorization server.</div>
</div>
<div class="line-block">
<div class="line">OAuth 2.0 defines following 2 client types based on the ability to maintain confidentiality of client credentials (client authentication information).</div>
</div>
<div class="line-block">
<div class="line">(1) Confidential</div>
<div class="line-block">
<div class="line">Client that can maintain the confidentiality of client credential.</div>
</div>
<div class="line">(2) Public</div>
<div class="line-block">
<div class="line">Client that cannot maintain the confidentiality of client credentials and cannot perform secure client authentication by using other means like the client executed on the device of resource owner.</div>
</div>
</div>
<div class="line-block">
<div class="line">Further, in OAuth 2.0, it is designed as client by considering following examples.</div>
<div class="line">(1) Confidential</div>
</div>
<ul>
<li><div class="first line-block">
<div class="line">Web application</div>
<div class="line">A client which runs on the application server.</div>
</div>
</li>
</ul>
<div class="line-block">
<div class="line">(2) Public</div>
</div>
<ul class="last">
<li><div class="first line-block">
<div class="line">User agent based application</div>
<div class="line">A client wherein the client code is downloaded from the application server and run in the user agent (browser etc.) of resource owner.</div>
<div class="line">JavaScript application etc.</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Native application</div>
<div class="line">A client which is installed and run on resource owner device.</div>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A user agent refers to a web browser etc. used by the resource owner.
In this guideline, resource owner (end user) and user agent are described separately to define the locations where end user operations occur.
End user operations occur when the resource owner is clearly defined in the guideline.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="scope">
<span id="oauthscope"></span><h4><a class="toc-backref" href="#id70">9.9.1.2.2. Scope</a><a class="headerlink" href="#scope" title="Permalink to this headline">¶</a></h4>
<p>The concept “Scope” is being used as a method of controlling access for resources protected in OAuth 2.0.</p>
<p>In response to the request from client, the authorization server can specify the access rights (read, write permissions etc.)
for the protected resources, including the scope in access token based on the policy of authorization server
or the instructions of resource owner.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="protocol-flow">
<span id="oauthprotocolflow"></span><h4><a class="toc-backref" href="#id71">9.9.1.2.3. Protocol flow</a><a class="headerlink" href="#protocol-flow" title="Permalink to this headline">¶</a></h4>
<p>In OAuth 2.0, resources are accessed in the following flow.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ProtocolFlow.png"><img alt="../_images/OAuth_ProtocolFlow.png" src="../_images/OAuth_ProtocolFlow.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id35">
<caption><span class="caption-text"><strong>Protocol flow of OAuth 2.0</strong></span><a class="headerlink" href="#id35" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authorization is requested for the resource owner. As shown in the above figure, the client directly makes a request to the resource owner,</div>
<div class="line">but it is recommended to request through the authorization server.</div>
<div class="line">Request is made through authorization server for the authorization code grant and</div>
<div class="line">implicit grant among the grant types described later.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client receives an authorization grant (described later) as the credentials representing authorization from resource owner.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client requests for access token by presenting own authentication information and authorization grant given by resource owner</div>
<div class="line">to the authorization server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authorization server authenticates the client and confirms the validity of authorization grant.</div>
<div class="line">It issues the access token if authorization grant is valid.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client requests to the resource protected on the resource server and authenticates with the issued access token.</div>
<div class="line"><br /></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource server checks the validity of access token, and accepts the request and responds to the resource if it is valid.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In order to simplify the complicated mechanism of signature and token exchange which was not popular in OAuth 1.0, the request handling access token needs to be made by HTTPS communication in OAuth 2.0.
(Using HTTPS communication prevents eavesdropping of access token)</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="authorization-grant">
<span id="authorizationgrant"></span><h4><a class="toc-backref" href="#id72">9.9.1.2.4. Authorization grant</a><a class="headerlink" href="#authorization-grant" title="Permalink to this headline">¶</a></h4>
<p>Authorization grant represents authorization from resource owner and it is used when client fetches the access token.
In OAuth 2.0, following 4 grant types are defined, however these can be individually extended such as adding the credential items etc.</p>
<p>Client requests the access token to authorization server from any of grant types and accesses the resource server with the fetched access token.
Authorization server must define 1 or more supporting grant types, and determine the grant type to be used among these as per the authorization request from client.</p>
<table border="1" class="colwidths-given longtable docutils" id="oauthauthorizationgrant">
<caption><span class="caption-text"><strong>Authorization grant in OAuth 2.0</strong></span><a class="headerlink" href="#oauthauthorizationgrant" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Grant type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">Authorization code grant</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In the flow of authorization code grant, the authorization server issues authorization code to client as an intermediary between client and resource owner, and the client issues the access token by passing the authorization code to authorization server.</div>
<div class="line">It is not necessary to share the credentials of resource owner to the client in order to issue the access token by using the authorization code issued by authorization server.</div>
<div class="line">Authorization code grant is used, when confidential client uses OAuth 2.0 similar to a Web application.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">Implicit grant</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In the flow of implicit grant, authorization server acts as an intermediary similar to authorization code grant, however it issues the access token directly instead of an authorization code.</div>
<div class="line">Since it is highly responsive and efficient, it is suitable for clients running on the browsers by using script languages.</div>
<div class="line">However, since the access token is encoded in URL, it may get leaked to a resource owner or other applications on the same device.</div>
<div class="line">Further, since the client is not authenticated, a risk of spoofing attack due to unauthorized usage of access token issued to other clients is also likely.</div>
<div class="line">Since a security risk is likely, it should be used only for public clients which require responsiveness and efficiency.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">Resource owner password credential grant</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In the flow of resource owner password credential grant, client uses the authentication information of resource owner as authorization grant and issues the access token directly.</div>
<div class="line">Since the credentials of resource owner must be shared with client, a risk of unauthorized usage or leakage of credentials is likely if client’s reliability is low.</div>
<div class="line">Resource owner password credential grant should be used only when there is high reliability between resource owner and client and when other grant types cannot be used.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">Client credential grant</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In the flow of client credential grant, authentication information of client is used as an authorization grant, and access token is issued directly.</div>
<div class="line">It is used when client is a resource owner.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">As mentioned in <a class="reference internal" href="#oauthauthorizationgrant"><span class="std std-ref">OAuth 2.0 authorization grant</span></a>, grant types other than authorization code grant have security risks and usage constraints. Therefore, using authorization grant on priority must be considered.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="authorization-code-grant">
<h5><a class="toc-backref" href="#id73">9.9.1.2.4.1. Authorization code grant</a><a class="headerlink" href="#authorization-code-grant" title="Permalink to this headline">¶</a></h5>
<p>Flow of authorization code grant is as follows.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_AuthorizationCodeGrant.png"><img alt="../_images/OAuth_AuthorizationCodeGrant.png" src="../_images/OAuth_AuthorizationCodeGrant.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id36">
<caption><span class="caption-text"><strong>Authorization code grant flow</strong></span><a class="headerlink" href="#id36" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource owner accesses the resources which are protected on resource server provided by the client through user agent (web browser etc.).</div>
<div class="line">Client redirects the user agent operated by resource owner to authorization end point on authorization server, in order to fetch authorization from resource owner.</div>
<div class="line">In this case, client includes the “Client ID for own identification”, “Scope requested to the resource as an option”, “Redirect URI for returning the user agent after authorization process performed by authorization server” and “State” in the request parameters.</div>
<div class="line">state is a random value associated with user agent and is used to ensure that series of flows is executed by the same user agent (CSRF countermeasures)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">User agent accesses the authorization end point of authorization server indicated to the client.</div>
<div class="line">Authorization server authenticates the resource owner through user agent and checks the validity of parameters by comparing it with the registered client information, based on the client ID, scope and redirect URI of request parameter.</div>
<div class="line">After confirmation, resource owner is asked to approve/ deny the access request.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource owner sends approval / denial of access request to the authorization server.</div>
<div class="line">When the resource owner allows access, the authorization server issues an instruction to redirect the user agent
to the client by using redirect URI included in the request parameter.</div>
<div class="line">At that time, authorization code is assigned as a request parameter of redirect URI.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">User agent accesses the redirect URI with assigned authorization code.</div>
<div class="line">When processing of client is completed, the response is returned to resource owner.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client sends the authorization code to the token end point on authorization server, in order to request the access token.</div>
<div class="line">Token end point of authorization server authenticates the client and verifies the validity of authorization code, and issues the access token and optional refresh token if it is valid.</div>
<div class="line">Refresh token is used to issue new access token when the access token is disabled or expired.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="implicit-grant">
<h5><a class="toc-backref" href="#id74">9.9.1.2.4.2. Implicit grant</a><a class="headerlink" href="#implicit-grant" title="Permalink to this headline">¶</a></h5>
<p>Flow of implicit grant is as follows.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ImplicitGrant.png"><img alt="../_images/OAuth_ImplicitGrant.png" src="../_images/OAuth_ImplicitGrant.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id37">
<caption><span class="caption-text"><strong>Flow of implicit grant</strong></span><a class="headerlink" href="#id37" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource owner accesses the pages required for resources which are protected on resource server provided by the client through user agent.</div>
<div class="line">Client gives access to authorization end point on authorization server for the user agent of resource owner, in order to fetch authorization from resource owner and issue the access token.</div>
<div class="line">In this case, client includes the “Client ID for own identification”, “Scope requested to the resource as an option”, “Redirect URI for returning the user agent after performing authorization process by authorization server” and “State”, in the request parameters.</div>
<div class="line">state is a random value associated with user agent and is used to ensure that series of flows is executed by the same user agent (CSRF countermeasures)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">User agent accesses the authorization end point of authorization server indicated to the client.</div>
<div class="line">Authorization server authenticates the resource owner through user agent and checks the validity of parameters by comparing it with the registered client information, based on the client ID, scope and redirect URI of request parameter.</div>
<div class="line">After confirmation, resource owner is asked to approve/ deny the access request.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource owner sends approval / denial of access request to the authorization server.</div>
<div class="line">When the resource owner allows access, the authorization server issues an instruction to redirect the user agent
to the client by using redirect URI included in the request parameter, and assigns the access token to URL fragment of redirect URI.</div>
<div class="line">Here, “client resource” refers to a static resource which is hosted on Web server etc. separately from client application.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">User agent sends a request to the client resource in accordance with the redirect instructions.
At that time, information of URL fragment is retained locally and URL fragments are not sent at the time of redirect.</div>
<div class="line">When client resource is accessed, the web page (usually, HTML document including the embedded script) is returned.</div>
<div class="line">User agent executes the script included in web page and extracts the access token from the locally saved URL fragment.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">User agent passes the access token to client.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="resource-owner-password-credential-grant">
<h5><a class="toc-backref" href="#id75">9.9.1.2.4.3. Resource owner password credential grant</a><a class="headerlink" href="#resource-owner-password-credential-grant" title="Permalink to this headline">¶</a></h5>
<p>Flow of resource owner password credential grant is as follows.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ResourceOwnerPasswordCredentialsGrant.png"><img alt="../_images/OAuth_ResourceOwnerPasswordCredentialsGrant.png" src="../_images/OAuth_ResourceOwnerPasswordCredentialsGrant.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id38">
<caption><span class="caption-text"><strong>Flow of resource owner password credential grant</strong></span><a class="headerlink" href="#id38" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource owner provides the credentials (user name, password) to the client.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client accesses the token end point of authorization server, in order to request the access token.</div>
<div class="line">In this case, client includes the credentials specified from resource owner and the scope requested to resource, in the request parameter.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Token end point of authorization server authenticates the client and verifies the credentials of resource owner. If it is valid, it issues the access token.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="client-credential-grant">
<h5><a class="toc-backref" href="#id76">9.9.1.2.4.4. Client credential grant</a><a class="headerlink" href="#client-credential-grant" title="Permalink to this headline">¶</a></h5>
<p>Flow of client credential grant is as follows.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ClientCredentialsGrant.png"><img alt="../_images/OAuth_ClientCredentialsGrant.png" src="../_images/OAuth_ClientCredentialsGrant.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id39">
<caption><span class="caption-text"><strong>Flow of client credential grant</strong></span><a class="headerlink" href="#id39" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client accesses the token end point of authorization server, in order to request the access token.</div>
<div class="line">In this case, client requests for access token including the client’s own credentials.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Token end point of authorization server authenticates the client and issues the access token when authentication is successful.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="life-cycle-of-access-token">
<span id="accesstokenlifecycle"></span><h4><a class="toc-backref" href="#id77">9.9.1.2.5. Life cycle of access token</a><a class="headerlink" href="#life-cycle-of-access-token" title="Permalink to this headline">¶</a></h4>
<p>Access token is issued by authorization server, by confirming the validity of authorization grant presented by the client.
For an issued access token, the scope is assigned based on the policy of authority server or the instructions of resource owner and access is retained for the protected resource.
Expiry period is set when the access token is issued, and if it expires, the access rights of protected resource are invalidated.</p>
<p>Flow from issue of access token till its invalidation is as follows.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_LifeCycleOfAccessToken.png"><img alt="../_images/OAuth_LifeCycleOfAccessToken.png" src="../_images/OAuth_LifeCycleOfAccessToken.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id40">
<caption><span class="caption-text"><strong>Flow from issue of access token till its invalidation</strong></span><a class="headerlink" href="#id40" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client presents the authorization grant and requests for access token.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authorization server confirms the authorization grant presented by client and issues the access token.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client presents the access token and requests for resource protected on resource server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource server verifies the validity of access token presented by client and if it is valid, performs processing for the resource protected on resource server.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client presents the access token (expired), and requests for the resource protected on resource server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource server verifies the validity of access token presented by client, and returns error if the access token has expired.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">When access token expires, the access rights of protected resources are invalidated, but access rights of protected resources can also be invalidated by disabling the access token before expiry of access token.</div>
<div class="line">When access token is to be disabled before its expiry, the client requests authorization server to cancel the token. Access rights of protected resources are invalidated for the disabled access token.</div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">When access token expires, authorization grant should be presented to authorization server again and validity should be re-confirmed by authorization server, in order to re-acquire the access token by client.
Therefore, when short validity term of access token is set, the usability decreases. On the other hand, when long validity term of access token is set, a high risk of disclosure or access token, and misuse is likely if it is disclosed.</div>
</div>
<div class="line-block">
<div class="line">Refresh token can be used to reduce the risk of disclosure without decreasing the usability of the token.
Refresh token can be used to get the new access token without re-submitting the authorization grant when access token is invalidated or expired.
When validity term is set at the time of issuing the refresh token and when refresh token expires, the access token cannot be re-issued.</div>
<div class="line">Risk of disclosure of access token and misuse at the time of disclosure can also be controlled while maintaining the usability with the re-issue of access token in short cycle, by setting the short validity term of access token and setting the long validity term of refresh token.</div>
</div>
<div class="line-block">
<div class="line">Issuing the refresh token is optional and is to be determined by the authorization server.</div>
</div>
<p>Flow of re-issuing the access token as per the refresh token is as follows.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_LifeCycleOfAccessTokenWithRefreshToken.png"><img alt="../_images/OAuth_LifeCycleOfAccessTokenWithRefreshToken.png" src="../_images/OAuth_LifeCycleOfAccessTokenWithRefreshToken.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id41">
<caption><span class="caption-text"><strong>Flow from issuing the access token till its re-issue</strong></span><a class="headerlink" href="#id41" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client presents the authorization grant and requests for access token.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authorization server confirms the authorization grant presented by client and issues the access token and refresh token.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client presents the access token and requests for resource protected on resource server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource server verifies the validity of access token presented by client, and if it is valid, it processes the resource protected on resource server.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client presents the access token (expired), and requests for the resource protected on resource server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource server verifies the validity of access token presented by client, and returns error if the access token has expired.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When an “access token expired” error is returned from the resource server,
the client requests a new access token by submitting a refresh token (expired).</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authorization server verifies the validity of refresh token presented by client and if it is valid, issues the access token and optional refresh token.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>When the refresh token expires, the authorization grant is submitted again to the authorization server.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_LifeCycleOfRefreshToken.png"><img alt="../_images/OAuth_LifeCycleOfRefreshToken.png" src="../_images/OAuth_LifeCycleOfRefreshToken.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id42">
<caption><span class="caption-text"><strong>Flow from issue of refresh token to its re-issue</strong></span><a class="headerlink" href="#id42" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When the client submits an expired access token and a “access token expired” error is returned from resource server,</div>
<div class="line">the client requests a new access token by submitting a refresh token (expired).</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authorization server verifies the validity of refresh token submitted by the client and returns an error when the refresh token has expired.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When refresh token expired error is returned from authorization server, the client submits the authorization grant again and requests an access token.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authorization server verifies the authorization grant submitted by the client and issues an access token and a refresh token.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="architecture-of-spring-security-oauth">
<span id="springsecurityoautharchitecture"></span><h3><a class="toc-backref" href="#id78">9.9.1.3. Architecture of Spring Security OAuth</a><a class="headerlink" href="#architecture-of-spring-security-oauth" title="Permalink to this headline">¶</a></h3>
<p>Spring Security OAuth is a library that provides functions necessary while building 3 roles such as Authorization Server, Resource Server, and Client as Spring applications among the roles defined in OAuth 2.0.
Spring Security OAuth is the technique that works by linking with the functions provided by Spring Framework (Spring MVC) and Spring Security, and it can build the authorization server, resource server and client by appropriate configuration (Bean definition) of default package provided by Spring Security OAuth.
Further, many extension points are provided similar to Spring Framework and Spring Security in order to incorporate the requirements that cannot be implemented in default package provided by Spring Security OAuth.</p>
<p>Further, refer to <a class="reference internal" href="Authentication.html"><span class="doc">Authentication</span></a> and <a class="reference internal" href="Authorization.html"><span class="doc">Authorization</span></a> for the details, when the functions provided by Spring Security are to be used for authentication/ authorization of requests within each roles.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Generally, in OAuth 2.0, all applications are not provided by one provider. In many cases, providers provide authorization servers and resource servers, and only the clients that work in coordination with these are implemented. Applications that work in coordination in such cases are not necessarily implemented by using Spring Security OAuth.
In the explanation of implementation method, a note will be added as appropriate for the methods to cooperate with applications which are implemented by architecture other than Spring Security OAuth.</p>
<p class="last">Please customize the implementation method introduced in this guideline as appropriate and use it in accordance with the specifications of applications that work in coordination.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>When authorization server, resource server, client are built by using Spring Security OAuth, process is performed with the flow given below.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_OAuth2Architecture.png"><img alt="../_images/OAuth_OAuth2Architecture.png" src="../_images/OAuth_OAuth2Architecture.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id43">
<caption><span class="caption-text"><strong>Flow of Spring Security OAuth</strong></span><a class="headerlink" href="#id43" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource owner accesses the client through user agent.</div>
<div class="line">Client calls <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.client.OAuth2RestTemplate</span></code> from service.</div>
<div class="line">In case of authorization grant accessing the authorization end point, instructions are given to user agent to redirect to authorization end point of authorization server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">The user agent accesses authorization endpoint (<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.endpoint.AuthorizationEndpoint</span></code>) of authorization server.</div>
<div class="line">Authorization endpoint receives the authorization request from the resource owner and issues an authorization code or access token after</div>
<div class="line">displaying a screen asking the resource owner for authorization.</div>
<div class="line">Issued authorization code or access token is passed to the client through user agent by using the redirect.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client accesses <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.endpoint.TokenEndpoint</span></code> which is the token end point of authorization server by using  <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>.</div>
<div class="line">Token end point calls <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.AuthorizationServerTokenServices</span></code>, validates the authorization grant submitted by the client and issue an access token.</div>
<div class="line">Issued access token is passed as a response to the client.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client uses  <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>, sets access token received from authorization server in request header to access the resource server.</div>
<div class="line">Resource server calls the <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.authentication.OAuth2AuthenticationManager</span></code> and validates access token and information associated with access token via <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.ResourceServerTokenServices</span></code>.</div>
<div class="line">When access token verification is successful, the resource corresponding to request from the client is returned.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>As mentioned earlier, usage of HTTPS communication at each end point is assumed in OAuth 2.0, however there may be the cases when HTTPS communication is used in
SSL accelerator or web server, or when distributed in multiple application servers by using load balancer.
When authorization code or redirect URL is embedded in client for linking the access token after authorization by resource owner,
the redirect URI indicating the SSL accelerator, Web server and load balancer should be embedded.</p>
<p>Spring (Spring Security OAuth) provides the technique for assembling the redirect URL by using any of the following headers.</p>
<ul class="simple">
<li>Forwarded header</li>
<li>X-Forwarded-Host header, X-Forwarded-Port header, X-Forwarded-Proto header</li>
</ul>
<p class="last">Setting should be done in order to assign the above mentioned headers at SSL accelerator and Web server, load balancer side, so that an appropriate redirect URI can be created in Spring(Spring Security OAuth).
If this is not performed, verification of request parameter (redirect URI) performed in the authorization code grant or implicit grant is likely to fail.</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">End point provided by Spring Security OAuth is implemented by extending the Spring MVC function. <code class="docutils literal"><span class="pre">&#64;FrameworkEndpoint</span></code> annotation is set in class at end point provided by Spring Security OAuth.
This is because <code class="docutils literal"><span class="pre">&#64;Controller</span></code> annotation does not conflict with the class registered by developer as a component.
Further, end point registered in <code class="docutils literal"><span class="pre">&#64;FrameworkEndpoint</span></code> annotation as component handles the <code class="docutils literal"><span class="pre">&#64;FrameworkEndpoint</span></code> method conflicting with URL as handler method, after reading <code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code> annotation of end point by <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.endpoint.FrameworkEndpointHandlerMapping</span></code> which is an extension class of <code class="docutils literal"><span class="pre">RequestMappingHandlerMapping</span></code>.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="authorization-server">
<span id="authorizationserver"></span><h4><a class="toc-backref" href="#id79">9.9.1.3.1. Authorization server</a><a class="headerlink" href="#authorization-server" title="Permalink to this headline">¶</a></h4>
<p>Authorization server provides functions for authentication of resource owner, obtaining authorization from a resource owner and issuing an access token.
Some grant types also provide functions for authentication of resource owner and obtaining authorization from resource owner because it is necessary
to ask the resource owner for authorization in order to issue a token.</p>
<p>Authorization server sends client information (information on which client is to be grant authorization, for what scope and which resource) and
verifies the access to be authorized and the scope and the resource for the same, and whether the access token can be issued, based on the information.</p>
<p>Note that, it is necessary to register client information in advance, in authorization server, however
OAuth 2.0 specifications do not prescribe a registration procedure for client information using authorization server,
and Spring Security OAuth also does not provide a registration procedure function for client information.
Hence, when you want to provide an interface for registering client information in the application, it must be implemented independently.</p>
<div class="section" id="authentication-of-client">
<h5><a class="toc-backref" href="#id80">9.9.1.3.1.1. Authentication of client</a><a class="headerlink" href="#authentication-of-client" title="Permalink to this headline">¶</a></h5>
<p>Each end point (will be explained later) provides a function which performs authentication of the client included in the request based on the client information managed by authorization server.</p>
</div>
<div class="section" id="authentication-of-resource-owner">
<h5><a class="toc-backref" href="#id81">9.9.1.3.1.2. Authentication of resource owner</a><a class="headerlink" href="#authentication-of-resource-owner" title="Permalink to this headline">¶</a></h5>
<p>When authorization is to be fetched from resource owner (will be explained later), authorization server must also authenticate the resource owner. This function is implemented by using authentication function provided by Spring Security.</p>
<p>For details, refer <a class="reference internal" href="Authentication.html#springsecurityauthentication"><span class="std std-ref">Authentication</span></a>.</p>
</div>
<div class="section" id="fetching-authorization-from-resource-owner">
<h5><a class="toc-backref" href="#id82">9.9.1.3.1.3. Fetching authorization from resource owner</a><a class="headerlink" href="#fetching-authorization-from-resource-owner" title="Permalink to this headline">¶</a></h5>
<p>Spring Security OAuth provides an authorization end point (<code class="docutils literal"><span class="pre">AuthorizationEndpoint</span></code>) by using Spring MVC function.</p>
<p>The client specifies the scope to be used while sending an authorization request. The scope specified by resource owner is authorized or
the scope for the client is authorized by authorization server when it matches with the scope assigned to the client, registered in advance, in authorization server.
While authorizing the client, the authorization by using Spring Security role explained in section of <a class="reference internal" href="Authorization.html#springsecurityauthorization"><span class="std std-ref">Authorization</span></a> can also be used.</p>
<p>Flow for accessing authorization end points is shown below.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_AutohrizationServerAuthArchitecture.png"><img alt="../_images/OAuth_AutohrizationServerAuthArchitecture.png" src="../_images/OAuth_AutohrizationServerAuthArchitecture.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id44">
<caption><span class="caption-text"><strong>Working of authorization server (In case of authorization end point access)</strong></span><a class="headerlink" href="#id44" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authorization server process is executed when the authorization end point (<code class="docutils literal"><span class="pre">/oauth/authorize</span></code>) of authorization server is accessed
by user agent in accordance with the instructions from the client.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In the <code class="docutils literal"><span class="pre">AuthorizationEndpoint</span></code> which processes URL for accessing (<code class="docutils literal"><span class="pre">/oauth/authorize</span></code>),
call <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.ClientDetailsService</span></code> method, and verify request parameter after fetching the client information registered in advance.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.approval.UserApprovalHandler</span></code> method and check whether authorization of scope is registered for client</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">If the authorization is not registered, <code class="docutils literal"><span class="pre">UserApprovalHandler</span></code> fetches an element of the screen asking for authorization of resource owner (authorization screen)
and forwards to URL (<code class="docutils literal"><span class="pre">/oauth/confirm_access</span></code>) which displays authorization screen.</div>
<div class="line">At that time, the scope to be inquired is the intersection of the request parameter and the client information registered in advance.
and is linked by using <code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code> of Spring MVC.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In the controller which processes URL for forwarding (<code class="docutils literal"><span class="pre">/oauth/confirm_access</span></code>),
authorization information is displayed to resource owner via user agent.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When the authorization is performed by screen operations of resource owner, the authorization end point (<code class="docutils literal"><span class="pre">/oauth/authorize</span></code>) is accessed again.</div>
<div class="line">At this time, <code class="docutils literal"><span class="pre">user_oauth_approval</span></code> is assigned as a request parameter.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthorizationEndpoint</span></code> assigns <code class="docutils literal"><span class="pre">user_oauth_approval</span></code>parameter and if accessed, calls method of <code class="docutils literal"><span class="pre">UserApprovalHandler</span></code>and registers authorization information.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Manage authorization status by <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.approval.ApprovalStore</span></code> in <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.approval.ApprovalStoreUserApprovalHandler</span></code> which is package of <code class="docutils literal"><span class="pre">UserApprovalHandler</span></code>.</div>
<div class="line">When authorization is performed by resource owner, call <code class="docutils literal"><span class="pre">ApprovalStore</span></code> method and register specified information.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">As described earlier, the scope to be inquired is the intersection of scope registered previously in authorization server and scope specified by request parameter at the time of authorization request by client.
For example, when the scope of READ and CREATE is specified by request parameters for the client assigning the scopes such as READ, CREATE, DELETE on authorization server, then the scope such as READ, CREATE which is the intersection of (READ,CREATE,DELETE) and (READ,CREATE) can be assigned.
When the scope that is not assigned to client on authorization server is specified by request parameter, an error occurs and access is denied.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="unauthorized-client-error">
<span id="definitionofbadclienterror"></span><h6><a class="toc-backref" href="#id83">9.9.1.3.1.3.1. Unauthorized client error</a><a class="headerlink" href="#unauthorized-client-error" title="Permalink to this headline">¶</a></h6>
<p>As per <a class="reference external" href="https://tools.ietf.org/html/rfc6749#section-4.1.2.1">4.1.2.1. Error Response</a> of RFC 6749,
if validity of redirect URI and client ID cannot be confirmed by request parameter verification, it is considered as an unauthorized client.
In this case, the user agent is not redirected to an unauthorized client and the user agent is directed to error screen provided by authorization server thus notifying the resource owner about unauthorized client.
In this guideline, the error above is called <strong>Unauthorized client error</strong>.</p>
<p>When an unauthorized client error occurs at the authorization endpoint, error notification is not sent to the client and transition is done to error screen of authorization server.
When an error other than unauthorized client error occurs at the authorization endpoint, an error notification is issued by redirecting to client, from authorization server.
Flow when an error occurs at the authorization endpoint is shown below.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_AuthorizationEndpointErrorHandling.png"><img alt="../_images/OAuth_AuthorizationEndpointErrorHandling.png" src="../_images/OAuth_AuthorizationEndpointErrorHandling.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id45">
<caption><span class="caption-text"><strong>Working of authorization server (Error handling in case of an unauthorized client error)</strong></span><a class="headerlink" href="#id45" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">A-1</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When an unauthorized client error occurs, it is forwarded to URL (<code class="docutils literal"><span class="pre">/oauth/error</span></code>) which displays an error screen.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">A-2</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In the controller which processes URL for forwarding (<code class="docutils literal"><span class="pre">/oauth/error</span></code>), error screen is displayed to resource owner through user agent.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id46">
<caption><span class="caption-text"><strong>Working of authorization server (Error handling for errors other than unauthorized client errors)</strong></span><a class="headerlink" href="#id46" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">B-1</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When an error other than unauthorized client error occurs, an error notification is redirected to the client from authorization server.</div>
<div class="line">Error information is assigned to redirect URI as request parameter.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">B-2</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Error information is passed to <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.client.token.AccessTokenProviderChain</span></code> through <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">B-3</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Restore the passed error information to exception and throw it as an exception.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="issue-of-access-token">
<span id="issueofaccesstoken"></span><h5><a class="toc-backref" href="#id84">9.9.1.3.1.4. Issue of access token</a><a class="headerlink" href="#issue-of-access-token" title="Permalink to this headline">¶</a></h5>
<p>Spring Security OAuth provides token end point (<code class="docutils literal"><span class="pre">TokenEndpoint</span></code>) by using Spring MVC function.</p>
<p>Token end point issues an access token by using <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.DefaultTokenServices</span></code> - a default implementation of <code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code>.
While issuing an access token, client information registered in authorization server is fetched via <code class="docutils literal"><span class="pre">ClientDetailsService</span></code> and used to verify whether the access token is to be issued.</p>
<p>Flow while accessing a token end point is shown below.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_AutohrizationServerTokenArchitecture.png"><img alt="../_images/OAuth_AutohrizationServerTokenArchitecture.png" src="../_images/OAuth_AutohrizationServerTokenArchitecture.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id47">
<caption><span class="caption-text"><strong>Working of authorization server (In case of token end point access)</strong></span><a class="headerlink" href="#id47" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Token end point process is executed by accessing the token end point (<code class="docutils literal"><span class="pre">/oauth/token</span></code>) of authorization server by the client</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call <code class="docutils literal"><span class="pre">ClientDetailsService</span></code> method and check whether the scope of request parameter is registered in client after fetching the previously registered client information.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When scope is registered, call <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.TokenGranter</span></code> method and issue access token.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call <code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code> method which issues an access token, in <code class="docutils literal"><span class="pre">AbstractTokenGranter</span></code> which is an implementation of <code class="docutils literal"><span class="pre">TokenGranter</span></code>.</div>
<div class="line"><code class="docutils literal"><span class="pre">AbstractTokenGranter</span></code> which is the base class of <code class="docutils literal"><span class="pre">TokenGranter</span></code> implemented as per grant type, and actual process is assigned to each class.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call <code class="docutils literal"><span class="pre">ClientDetailsService</span></code> method in <code class="docutils literal"><span class="pre">DefaultTokenServices</span></code> which is an implementation of <code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code> and fetch expiry date for the access token to be issued, and expiry and whether a refresh token is issued, for a refresh token.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Issue an access token based on information fetched from <code class="docutils literal"><span class="pre">ClientDetailsService</span></code>, in <code class="docutils literal"><span class="pre">DefaultTokenServices</span></code>.</div>
<div class="line">Issued access token is registered in <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.TokenStore</span></code> method which manages an access token.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="resource-server">
<span id="resourceserver"></span><h4><a class="toc-backref" href="#id85">9.9.1.3.2. Resource server</a><a class="headerlink" href="#resource-server" title="Permalink to this headline">¶</a></h4>
<p>Resource server provides a function to verify the validity of access token itself and accessing resources within the scope retained by access token.</p>
<p>Spring Security OAuth implements the verification function of access token, by using authentication and authorization framework of Spring Security.
Specifically, <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.authentication.OAuth2AuthenticationProcessingFilter</span></code> provided by Spring Security OAuth is used in Authentication Filter, <code class="docutils literal"><span class="pre">OAuth2AuthenticationManager</span></code> - an implementation class of
<code class="docutils literal"><span class="pre">AuthenticationManager</span></code> is used in authentication process and <code class="docutils literal"><span class="pre">OAuth2AuthenticationEntryPoint</span></code> - an implementation class of <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.error.OAuth2AuthenticationEntryPoint</span></code>is used in response of authentication error.</p>
<p>Refer to <a class="reference internal" href="Authentication.html#springsecurityauthentication"><span class="std std-ref">Authentication</span></a>for the details of Spring Security.</p>
<p>Configuration of resource server is as follows.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ResourceServerArchitecture.png"><img alt="../_images/OAuth_ResourceServerArchitecture.png" src="../_images/OAuth_ResourceServerArchitecture.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id48">
<caption><span class="caption-text"><strong>Working of resource server</strong></span><a class="headerlink" href="#id48" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When client accesses the resource server at the beginning, <code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code> is called.</div>
<div class="line">Access token is extracted in <code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code> through request.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">After extracting the access token, fetch the authentication information associated with access token by calling <code class="docutils literal"><span class="pre">ResourceServerTokenServices</span></code> method in <code class="docutils literal"><span class="pre">OAuth2AuthenticationManager</span></code> which is an implementation of <code class="docutils literal"><span class="pre">AuthenticationManager</span></code>.</div>
<div class="line">Further, verify the access token when authentication information is fetched.</div>
<div class="line">As a method of fetching authentication information associated with access token, a method of fetching the same by using  <code class="docutils literal"><span class="pre">TokenStore</span></code> commonly with the authorization server is listed besides the method of inquiring by HTTP to authorization server.</div>
<div class="line">How to fetch the authentication information depends on the implementation of <code class="docutils literal"><span class="pre">ResourceServerTokenServices</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2’)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When an authentication error occurs in <code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code>, delegate processing to <code class="docutils literal"><span class="pre">OAuth2AuthenticationEntryPoint</span></code>- an implementation of <code class="docutils literal"><span class="pre">AuthenticationEntryPoint</span></code> and send an error response.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When <code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code> process is completed, following Security Filter(<code class="docutils literal"><span class="pre">ExceptionTranslationFilter</span></code>) is called.</div>
<div class="line">For details of <code class="docutils literal"><span class="pre">ExceptionTranslationFilter</span></code>, refer <a class="reference internal" href="Authorization.html#authorizationerrorresponse"><span class="std std-ref">Response at the time of authorization error</span></a>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3’)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When an exception is captured in <code class="docutils literal"><span class="pre">ExceptionTranslationFilter</span></code>, delegate the process to <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.error.OAuth2AccessDeniedHandler</span></code> - an implementation of <code class="docutils literal"><span class="pre">AccessDeniedHandler</span></code> and send an error response.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When authentication and authorization of request is successful, a resource corresponding to a request from the client is returned.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="client">
<span id="id2"></span><h4><a class="toc-backref" href="#id86">9.9.1.3.3. Client</a><a class="headerlink" href="#client" title="Permalink to this headline">¶</a></h4>
<p>The client provides a function to guide (redirect) to the authorization server in order to obtain authorization from resource owner and a function to access resource server by fetching an access token.</p>
<p>Spring Security OAuth provides <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>and <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.client.filter.OAuth2ClientContextFilter</span></code>which are used to fetch access token and access a resource server.</p>
<p><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> is a class that extends <code class="docutils literal"><span class="pre">RestTemplate</span></code> and adds functions for OAuth 2.0, and consists of a mechanism to fetch access tokens again by using refresh tokens and a mechanism to throw exception (<code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code>) when authorization is required from resource owner for fetching access tokens.
Note that, by registering <code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code> in servlet filter, you can guide (redirect) to authorization server by handling <code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code> occurred in <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>.</p>
<p>Further, in  <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>, access token acquired from authorization server along with grant type specified <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.client.resource.OAuth2ProtectedResourceDetails</span></code> is saved in <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.client.DefaultOAuth2ClientContext</span></code> which is an implementation of <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.client.OAuth2ClientContext</span></code>.
<code class="docutils literal"><span class="pre">DefaultOAuth2ClientContext</span></code> is defined as Bean of session scope by default, and access token can be shared among multiple requests.</p>
<p>Configuration while using  <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> as client function is given below.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ClientArchitecture.png"><img alt="../_images/OAuth_ClientArchitecture.png" src="../_images/OAuth_ClientArchitecture.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id49">
<caption><span class="caption-text"><strong>Working of client</strong></span><a class="headerlink" href="#id49" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No,</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">User agent accesses the <code class="docutils literal"><span class="pre">Controller</span></code> so that <code class="docutils literal"><span class="pre">Service</span></code> of client can be called.</div>
<div class="line">Servlet function ( <code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code> ) for capturing <code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code> that may occur in (5) is applied for access along with access to resource server.</div>
<div class="line">User agent can access the authorization end point on authorization server, by applying this servlet function when `` UserRedirectRequiredException`` occurs.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> from <code class="docutils literal"><span class="pre">Service</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch access token retained by <code class="docutils literal"><span class="pre">OAuth2ClientContext</span></code>.</div>
<div class="line">When a valid access token is fetched, move to process (6).</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When access token is not saved at first access, or when validity period is lapsed, call <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.client.token.AccessTokenProvider</span></code>and fetch the access token.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch <code class="docutils literal"><span class="pre">AccessTokenProvider</span></code>the access token for grant type defined in <code class="docutils literal"><span class="pre">OAuth2ProtectedResourceDetails</span></code> as detailed information of resource.</div>
<div class="line"><code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code> is thrown when fetching of authorization code is not completed in <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.client.token.grant.code.AuthorizationCodeAccessTokenProvider</span></code> which is an implementation of authorization code grant.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify access token fetched in (3) or (5) and access resource server.</div>
<div class="line">When an exception occurs such as “access token expired” (<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.client.http.AccessTokenRequiredException</span></code>) while accessing, perform subsequent processes from (4) onwards again after initializing retained access token.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since implicit grants are generally adopted by clients implemented in JavaScript etc., a method to implement by using JavaScript is introduced in this guideline as well.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-use">
<span id="howtouse"></span><h2><a class="toc-backref" href="#id87">9.9.2. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<p>Bean definition example and implementation method required for using Spring Security OAuth is described.</p>
<div class="section" id="how-to-use-configuration">
<span id="oauthhowtouseconfiguration"></span><h3><a class="toc-backref" href="#id88">9.9.2.1. How to Use Configuration</a><a class="headerlink" href="#how-to-use-configuration" title="Permalink to this headline">¶</a></h3>
<p>As shown in “<a class="reference internal" href="#authorizationgrant"><span class="std std-ref">Authorization grant</span></a>”, flow between authorization server and client varies in OAuth 2.0 depending on the grant type.
Therefore, it is necessary to perform implementation in line with the grant type supported by the application.</p>
<p>In this guideline, explanation is given about how to implement authorization server, resource server and client for each grant type.</p>
<ul class="simple">
<li><dl class="first docutils">
<dt><em>How to proceed depending on grant type used</em></dt>
<dd>For implementation method for each grant type, an implementation method for authorization code grant is explained at first and the changes from that of authorization code grant are explained for other grant types.
<strong>While using any grant type, explanation about authorization code grant must be read first and then the explanation for grant type to be used is read.</strong></dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><em>How to proceed further according to the application to be created</em></dt>
<dd>Implementation of authorization server, resource server and client is independent and it is not necessary to understand how to implement all the applications.
<strong>When you want to implement any one application, only the explanation for the application to be implemented should be read.</strong></dd>
</dl>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="set-up-of-spring-security-oauth">
<span id="oauthsetup"></span><h3><a class="toc-backref" href="#id89">9.9.2.2. Set-up of Spring Security OAuth</a><a class="headerlink" href="#set-up-of-spring-security-oauth" title="Permalink to this headline">¶</a></h3>
<p>Spring Security OAuth is added as a dependent library in order to use the function provided by Spring Security OAuth.</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.security.oauth<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-security-oauth2<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Add Spring Security OAuth as a dependent library in <code class="file docutils literal"><span class="pre">pom.xml</span></code> of project using Spring Security OAuth.</div>
<div class="line">When resource server, authorization server, client are added as different project, respective description should be added.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">As given in above setting example, since it is assumed that dependency library version is managed by the parent project “terasoluna- gfw- parent”, it is not necessary to specify the version in pom.xml.
The dependent library mentioned above is defined in <a class="reference external" href="http://platform.spring.io/platform/">Spring IO Platform</a> used by terasoluna-gfw-parent.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="implementation-of-authorization-code-grant">
<span id="implementationautorizationcodegrant"></span><h3><a class="toc-backref" href="#id90">9.9.2.3. Implementation of authorization code grant</a><a class="headerlink" href="#implementation-of-authorization-code-grant" title="Permalink to this headline">¶</a></h3>
<p>How to implement authorization server, resource server and client by using authorization code grant is explained.</p>
<div class="section" id="implementation-of-authorization-server">
<span id="implementationoauthauthorizationserverofautorizationcode"></span><h4><a class="toc-backref" href="#id91">9.9.2.3.1. Implementation of authorization server</a><a class="headerlink" href="#implementation-of-authorization-server" title="Permalink to this headline">¶</a></h4>
<p>Implementation method of authorization server is described.</p>
<p>Authorization server provides end points for “fetching authorization from resource owners” and “issuing access tokens”, by using the function of Spring Security OAuth.
Further, while accessing the above-mentioned end point, it is necessary to authenticate the resource owner or client, and these guidelines are implemented by using the technique for authentication/ authorization of Spring Security.</p>
<div class="section" id="creation-of-setting-file-authorization-server">
<span id="oauthauthorizationservercreatesettingfile"></span><h5><a class="toc-backref" href="#id92">9.9.2.3.1.1. Creation of setting file (Authorization server)</a><a class="headerlink" href="#creation-of-setting-file-authorization-server" title="Permalink to this headline">¶</a></h5>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code> is created as configuration file for defining in authorization server.</div>
<div class="line"><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code> performs Bean definition of end points for providing the functions of authentication server, and makes security setting for the end points and sets the grant type supporting the authorization server.</div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
       <span class="na">xmlns:oauth2=</span><span class="s">&quot;http://www.springframework.org/schema/security/oauth2&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/security</span>
<span class="s">           http://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">           http://www.springframework.org/schema/security/oauth2</span>
<span class="s">           http://www.springframework.org/schema/security/spring-security-oauth2.xsd</span>
<span class="s">           http://www.springframework.org/schema/beans</span>
<span class="s">           http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>


<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<p>Next, settings are described in <code class="docutils literal"><span class="pre">web.xml</span></code> in order to read the created <code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">web.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;context-param&gt;</span>
    <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
    <span class="nt">&lt;param-value&gt;</span>
        classpath*:META-INF/spring/applicationContext.xml
        classpath*:META-INF/spring/oauth2-auth.xml  <span class="c">&lt;!-- (1) --&gt;</span>
        classpath*:META-INF/spring/spring-security.xml
    <span class="nt">&lt;/param-value&gt;</span>
<span class="nt">&lt;/context-param&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify a Bean definition file of  OAuth 2.0. It should be described before <code class="docutils literal"><span class="pre">spring-security.xml</span></code>, by considering the case when URL targeted for access control set in <code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code> is included in the URL targeted for access control set in <code class="docutils literal"><span class="pre">spring-security.xml</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="defining-authorization-server">
<span id="oauthauthorizationserverdefinition"></span><h5><a class="toc-backref" href="#id93">9.9.2.3.1.2. Defining authorization server</a><a class="headerlink" href="#defining-authorization-server" title="Permalink to this headline">¶</a></h5>
<p>Definitions of authorization server are added as below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;oauth2:authorization-code</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">Use  <code class="docutils literal"><span class="pre">&lt;oauth2:authorization-server&gt;</span></code> tag and define authorization server.</div>
<div class="line">By using <code class="docutils literal"><span class="pre">&lt;oauth2:authorization-server&gt;</span></code>tag, authorization end point for authorization and
token end point for issuing access token are registered as components.</div>
<div class="line"><br /></div>
<div class="line">Following path is set for accessing each component.</div>
</div>
<ul class="last simple">
<li>Authorization end point (<code class="docutils literal"><span class="pre">/oauth/authorize</span></code>)</li>
<li>Token end point (<code class="docutils literal"><span class="pre">/oauth/token</span></code>)</li>
<li>Forwarding destination while fetching authorization from resource owner (<code class="docutils literal"><span class="pre">/oauth/confirm_access</span></code>)</li>
<li>Forwarding destination when an unauthorized client error occurs in authorization end point (<code class="docutils literal"><span class="pre">/oauth/error</span></code>)</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use <code class="docutils literal"><span class="pre">&lt;oauth2:authorization-code</span> <span class="pre">/&gt;</span></code> tag and support authorization code grant.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use <code class="docutils literal"><span class="pre">&lt;oauth2:refresh-token</span> <span class="pre">/&gt;</span></code>tag and support refresh token.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><code class="docutils literal"><span class="pre">&lt;oauth2:authorization-code</span> <span class="pre">/&gt;</span></code>tag and <code class="docutils literal"><span class="pre">&lt;oauth2:refresh-token</span> <span class="pre">/&gt;</span></code>tag must be set in the above sequence.</p>
<p class="last">For details, refer <a class="reference internal" href="#orderofauthoraizationserversupportsetting"><span class="std std-ref">When the multiple grant types are supported in authorization server</span></a>.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>End point registered by using <code class="docutils literal"><span class="pre">&lt;oauth2:authorization-server&gt;</span></code>tag and path for forwarding
can be customized respectively.</p>
<p class="last">For details, refer <a class="reference internal" href="#customizeendpoint"><span class="std std-ref">Customization of end point</span></a>, <a class="reference internal" href="#customizeforward"><span class="std std-ref">Customize forwarding destination</span></a>.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since setting file above does not set <code class="docutils literal"><span class="pre">client-details-service-ref</span></code>parameter, errors due to grammatical errors are detected by IDE.
Errors are resolved by adding settings to be described later.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Authorization code is used for only the short period from issuing the authorization code till issuing the access token, hence it is managed in in-memory by default.
In case of configuration of multiple authorization servers, it should be managed in DB, in order to share authorization codes among multiple servers.
When authorization code is to be managed in DB, the following table, consisting of the column having authorization code as primary key and the column having authentication information, is created. Following example explains the DB definitions when PostgreSQL is used.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ERDiagramCode.png"><img alt="../_images/OAuth_ERDiagramCode.png" src="../_images/OAuth_ERDiagramCode.png" style="width: 30%;" /></a>
</div>
<p>BeanID of <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.code.JdbcAuthorizationCodeServices</span></code> managing authorization code in DB is specified in <code class="docutils literal"><span class="pre">authorization-code-services-ref</span></code> of <code class="docutils literal"><span class="pre">&lt;oauth2:authorization-code&gt;</span></code> tag, in the configuration file of authorization server.
Data source to be connected to table for authorization code storage is specified in the constructor of <code class="docutils literal"><span class="pre">JdbcAuthorizationCodeServices</span></code>.
<strong>Always</strong> refer to <a class="reference internal" href="#oauthauthorizationserverhowtocontrolltarnsaction"><span class="std std-ref">Transaction control</span></a> for the precautions while managing the authorization code permanently in DB.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server&gt;</span>
    <span class="nt">&lt;oauth2:authorization-code</span> <span class="na">authorization-code-services-ref=</span><span class="s">&quot;authorizationCodeServices&quot;</span><span class="nt">/&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;authorizationCodeServices&quot;</span>
      <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.code.JdbcAuthorizationCodeServices&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="client-authentication">
<span id="oauthauthorizationserverclientauthentication"></span><h5><a class="toc-backref" href="#id94">9.9.2.3.1.3. Client authentication</a><a class="headerlink" href="#client-authentication" title="Permalink to this headline">¶</a></h5>
<p>Clients that have accessed end points should be authenticated, in order to confirm whether they are registered clients.
Client is authenticated by verifying the client ID and password passed by client as parameters based on the client information retained by authorization server. Basic authentication is used for authentication.</p>
<p>Spring Security OAuth provides the implementation class of <code class="docutils literal"><span class="pre">ClientDetailsService</span></code> which is an interface for fetching the client information.
Further, <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.client.BaseClientDetails</span></code> class which is implementation class of <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.ClientDetails</span></code> interface is provided as a class retaining the client information.
<code class="docutils literal"><span class="pre">BaseClientDetails</span></code> provides the basic parameters such as client ID and supporting grant type etc. by using OAuth 2.0, and the parameters can be added by extending <code class="docutils literal"><span class="pre">BaseClientDetails</span></code>.
In this case, extension of <code class="docutils literal"><span class="pre">BaseClientDetails</span></code> and creation of <code class="docutils literal"><span class="pre">ClientDetailsService</span></code> implementation class is performed, and client information wherein client name is added as individual parameter is managed by using DB and the implementation method for authentication is explained.</p>
<p>At first, DB is created as below.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ERDiagram.png"><img alt="../_images/OAuth_ERDiagram.png" src="../_images/OAuth_ERDiagram.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">A table to retain client information. client_id is considered as primary key.</div>
<div class="line">Roles of each column are as below.</div>
</div>
<ul class="last simple">
<li>client_id: A column to retain the client ID which is an ID to identify a client.</li>
<li>client_secret: A column to retain the password which is used to authenticate the client.</li>
<li>client_name: An individual column to retain the client name. Not required since it is an individual column.</li>
<li>access_token_validity: A column to retain the validity period [seconds] of access token.</li>
<li>refresh_token_validity: A column to retain the validity period [seconds] of refresh token.</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A table to retain the scope information. It is mapped with the client information by considering client_id as the external key.</div>
<div class="line">Scope used for client authorization is retained in scope column. Records are registered only for the scope of client.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A table to retain the resource information. It is mapped with the client information by considering client_id as the external key.</div>
<div class="line">Resource ID used in resource server for identifying whether it is a resource that can be accessed by client is retained in resource_id column.</div>
<div class="line">Access to resource is permitted, only when resource ID defined for the resource retained by resource server is included in resource ID registered here.</div>
<div class="line">Records are registered only for the resource IDs accessible by client.</div>
<div class="line">When not even single resource ID is registered, all resources can be accessed, hence precaution must be taken when it is not registered.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A table to retain the grant information. It is mapped with the client information by considering client_id as the external key.</div>
<div class="line">Grant to be used by client is retained in authorized_grant_type column.</div>
<div class="line">Records are registered only for the grant count to be used by client</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A table to retain the redirect URI information. It is mapped with the client information by considering client_id as the external key.</div>
<div class="line">web_server_redirect_uri column retains the URL that redirects user agent after authorization by resource owner.</div>
<div class="line">Redirect URI to be retained is used in whitelist check of redirect URI declared by the client at the time of authorization request.</div>
<div class="line">Records are registered only for the URLs that can be declared by client.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>A model retaining the client information is created.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">Client.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">clientId</span><span class="o">;</span> <span class="c1">// (1)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">clientSecret</span><span class="o">;</span> <span class="c1">// (2)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">clientName</span><span class="o">;</span> <span class="c1">// (3)</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">accessTokenValidity</span><span class="o">;</span> <span class="c1">// (4)</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">refreshTokenValidity</span><span class="o">;</span> <span class="c1">// (5)</span>
    <span class="c1">// Getters and Setters are omitted</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A field to retain the client ID identifying the client.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A field to retain the password used for client authentication.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">An extended field to retain the client name which is not provided in Spring Security OAuth.</div>
<div class="line">Not required, since it is an extended field.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A field to retain the validity period [seconds] of access token.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A field to retain the validity period [seconds] of refresh token.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is necessary to create a Repository class for handling client information, however the explanation is omitted here.
For basic implementation methods, refer <a class="reference internal" href="../ImplementationAtEachLayer/DomainLayer.html#repository-label"><span class="std std-ref">Implementation of Repository</span></a>.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Detailed information of client can be extended easily by creating the class inheriting the <code class="docutils literal"><span class="pre">BaseClientDetails</span></code> class.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">OAuthClientDetails.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuthClientDetails</span> <span class="kd">extends</span> <span class="n">BaseClientDetails</span><span class="o">{</span>
    <span class="kd">private</span> <span class="n">Client</span> <span class="n">client</span><span class="o">;</span>
    <span class="c1">// Getter and Setter are omitted</span>
<span class="o">}</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.ClientDetailsService</span></code> is an interface for fetching the detailed client information required in authorization process from the data store.
Creation of <code class="docutils literal"><span class="pre">ClientDetailsService</span></code> implementation class is described below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">OAuthClientDetailsService.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;clientDetailsService&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuthClientDetailsService</span> <span class="kd">implements</span> <span class="n">ClientDetailsService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ClientRepository</span> <span class="n">clientRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">ClientDetails</span> <span class="nf">loadClientByClientId</span><span class="o">(</span><span class="n">String</span> <span class="n">clientId</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">ClientRegistrationException</span> <span class="o">{</span>

        <span class="n">Client</span> <span class="n">client</span> <span class="o">=</span> <span class="n">clientRepository</span><span class="o">.</span><span class="na">findClientByClientId</span><span class="o">(</span><span class="n">clientId</span><span class="o">);</span> <span class="c1">// (2)</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">client</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (3)</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="n">NoSuchClientException</span><span class="o">(</span><span class="s">&quot;No client with requested id: &quot;</span> <span class="o">+</span> <span class="n">clientId</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// (4)</span>
        <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">clientScopes</span> <span class="o">=</span> <span class="n">clientRepository</span><span class="o">.</span><span class="na">findClientScopesByClientId</span><span class="o">(</span><span class="n">clientId</span><span class="o">);</span>
        <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">clientResources</span> <span class="o">=</span> <span class="n">clientRepository</span><span class="o">.</span><span class="na">findClientResourcesByClientId</span><span class="o">(</span><span class="n">clientId</span><span class="o">);</span>
        <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">clientGrants</span> <span class="o">=</span> <span class="n">clientRepository</span><span class="o">.</span><span class="na">findClientGrantsByClientId</span><span class="o">(</span><span class="n">clientId</span><span class="o">);</span>
        <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">clientRedirectUris</span> <span class="o">=</span> <span class="n">clientRepository</span><span class="o">.</span><span class="na">findClientRedirectUrisByClientId</span><span class="o">(</span><span class="n">clientId</span><span class="o">);</span>

         <span class="c1">// (5)</span>
        <span class="n">OAuthClientDetails</span> <span class="n">clientDetails</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OAuthClientDetails</span><span class="o">();</span>
        <span class="n">clientDetails</span><span class="o">.</span><span class="na">setClientId</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">getClientId</span><span class="o">());</span>
        <span class="n">clientDetails</span><span class="o">.</span><span class="na">setClientSecret</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">getClientSecret</span><span class="o">());</span>
        <span class="n">clientDetails</span><span class="o">.</span><span class="na">setAccessTokenValiditySeconds</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">getAccessTokenValidity</span><span class="o">());</span>
        <span class="n">clientDetails</span><span class="o">.</span><span class="na">setRefreshTokenValiditySeconds</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">getRefreshTokenValidity</span><span class="o">());</span>
        <span class="n">clientDetails</span><span class="o">.</span><span class="na">setResourceIds</span><span class="o">(</span><span class="n">clientResources</span><span class="o">);</span>
        <span class="n">clientDetails</span><span class="o">.</span><span class="na">setScope</span><span class="o">(</span><span class="n">clientScopes</span><span class="o">);</span>
        <span class="n">clientDetails</span><span class="o">.</span><span class="na">setAuthorizedGrantTypes</span><span class="o">(</span><span class="n">clientGrants</span><span class="o">);</span>
        <span class="n">clientDetails</span><span class="o">.</span><span class="na">setRegisteredRedirectUri</span><span class="o">(</span><span class="n">clientRedirectUris</span><span class="o">);</span>
        <span class="n">clientDetails</span><span class="o">.</span><span class="na">setClient</span><span class="o">(</span><span class="n">client</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">clientDetails</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Add <code class="docutils literal"><span class="pre">&#64;Service</span></code> annotation to the class level as service in order to use it as target for component-scan.</div>
<div class="line">Specify Bean name as <code class="docutils literal"><span class="pre">clientDetailsService</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client information is fetched from DB.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When the client information is not found, an exception of Spring Security OAuth - <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.NoSuchClientException</span></code> is generated.</div>
<div class="line">Note that, this process is also called for fetching client information in authorization end point as well, however, it is handled by authorization end point when <code class="docutils literal"><span class="pre">NoSuchClientException</span></code>occurs,</div>
<div class="line">and <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.common.exceptions.BadClientCredentialsException</span></code> - a subclass of <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.common.exceptions.OAuth2Exception</span></code> is thrown.</div>
<div class="line">For handling methods when <code class="docutils literal"><span class="pre">OAuth2Exception</span></code>occurs in authorization end point, refer <a class="reference internal" href="#oauthauthorizationserverhowtohandleerror"><span class="std std-ref">Error handling at the time of authorization request</span></a>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch information associated with the client.</div>
<div class="line">If the process efficiency is reduced by calling Repository by dividing it for multiple times, fetch collectively in (2).</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set various types of fetched information in <code class="docutils literal"><span class="pre">OAuthClientDetails</span></code> field.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Add settings necessary for client authentication to <code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
     <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;oauth2:authorization-code</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>

<span class="nt">&lt;sec:http</span> <span class="na">pattern=</span><span class="s">&quot;/oauth/*token*/**&quot;</span>
    <span class="na">authentication-manager-ref=</span><span class="s">&quot;clientAuthenticationManager&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;sec:http-basic</span> <span class="na">entry-point-ref=</span><span class="s">&quot;oauthAuthenticationEntryPoint&quot;</span> <span class="nt">/&gt;</span>           <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;sec:csrf</span> <span class="na">disabled=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (4) --&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/**&quot;</span> <span class="na">access=</span><span class="s">&quot;isAuthenticated()&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (5) --&gt;</span>
    <span class="nt">&lt;sec:access-denied-handler</span> <span class="na">ref=</span><span class="s">&quot;oauth2AccessDeniedHandler&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (6) --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>

<span class="nt">&lt;sec:authentication-manager</span> <span class="na">alias=</span><span class="s">&quot;clientAuthenticationManager&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (7) --&gt;</span>
    <span class="nt">&lt;sec:authentication-provider</span> <span class="na">user-service-ref=</span><span class="s">&quot;clientDetailsUserService&quot;</span> <span class="nt">&gt;</span>  <span class="c">&lt;!-- (8) --&gt;</span>
        <span class="nt">&lt;sec:password-encoder</span> <span class="na">ref=</span><span class="s">&quot;passwordEncoder&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (9) --&gt;</span>
    <span class="nt">&lt;/sec:authentication-provider&gt;</span>
<span class="nt">&lt;/sec:authentication-manager&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;oauthAuthenticationEntryPoint&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.error.OAuth2AuthenticationEntryPoint&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;typeName&quot;</span> <span class="na">value=</span><span class="s">&quot;Basic&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (10) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;realmName&quot;</span> <span class="na">value=</span><span class="s">&quot;Realm&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (11) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;oauth2AccessDeniedHandler&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.error.OAuth2AccessDeniedHandler&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (12) --&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;clientDetailsUserService&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.client.ClientDetailsUserDetailsService&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (13) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;clientDetailsService&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (14) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify a Bean of <code class="docutils literal"><span class="pre">OAuthClientDetailsService</span></code> in <code class="docutils literal"><span class="pre">client-details-service-ref</span></code> attribute.</div>
<div class="line">Bean ID to be specified must match with Bean ID specified by implementation class of <code class="docutils literal"><span class="pre">ClientDetailsService</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">Specify a location below <code class="docutils literal"><span class="pre">/oauth/*token*/</span></code> as a target for access control
as an endpoint URL in order to perform  security settings for endpoint related to access token operation.
Endpoint URL defined by Spring Security OAuth and its default value are as below.</div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">/oauth/token</span></code> - an endpoint URL of endpoint used in issuing a token</li>
<li><code class="docutils literal"><span class="pre">/oauth/check_token</span></code>- an endpoint URL of endpoint used to verify a token</li>
<li><code class="docutils literal"><span class="pre">/oauth/token_key</span></code>- an endpoint URL of endpoint used for fetching a public key, when JWT signature is created by public key encryption method</li>
</ul>
<div class="last line-block">
<div class="line">Specify a Bean of <code class="docutils literal"><span class="pre">AuthenticationManager</span></code> for client authentication defined in (7), in <code class="docutils literal"><span class="pre">authentication-manager-ref</span></code> attribute.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Apply Basic authentication to client authentication.</div>
<div class="line">For details, refer <a class="reference external" href="http://docs.spring.io/spring-security/site/docs/4.2.4.RELEASE/reference/html/basic.html">Basic and Digest Authentication</a>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Invalidate CSRF countermeasures for accessing <code class="docutils literal"><span class="pre">/oauth/*token*/**</span></code>.</div>
<div class="line">Spring Security OAuth adopts validity check of the request using state parameter, which is recommended as a CSRF countermeasure of OAuth 2.0.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Settings which assign rights of access only to authenticated users, for locations under endpoint.</div>
<div class="line">How to specify access policy for Web resource, refer <a class="reference internal" href="Authorization.html"><span class="doc">Authorization</span></a>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify a Bean of <code class="docutils literal"><span class="pre">OAuth2AccessDeniedHandler</span></code> in <code class="docutils literal"><span class="pre">access-denied-handler</span></code>. Here, a Bean of <code class="docutils literal"><span class="pre">oauth2AccessDeniedHandler</span></code> defined in (12) is specified.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for <code class="docutils literal"><span class="pre">AuthenticationManager</span></code> for authentication of client.</div>
<div class="line"><code class="docutils literal"><span class="pre">AuthenticationManager</span></code> used in the authentication of resource owner and BeanID of alias must be specified.</div>
<div class="line">For authentication of resource owner, refer <a class="reference internal" href="#oauthauthorizationserverresourceownerauthentication"><span class="std std-ref">Resource owner authentication</span></a>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify a Bean of <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.client.ClientDetailsUserDetailsService</span></code> defined in (13) in <code class="docutils literal"><span class="pre">user-service-ref</span></code> attribute of <code class="docutils literal"><span class="pre">sec:authentication-provider</span></code>-ref``.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify a Bean of <code class="docutils literal"><span class="pre">PasswordEncoder</span></code> used in password hashing, which is used in client authentication.</div>
<div class="line">For details of password hashing, refer <a class="reference internal" href="Authentication.html#springsecurityauthenticationpasswordhashing"><span class="std std-ref">Password hashing</span></a>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When the client authentication fails, specify the scheme of client authentication submitted to the client in the response header.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When client authentication fails, specify the realm of client authentication submitted to the client by response header.</div>
<div class="line">Set when you want to customize realm of client authentication.</div>
<div class="line">When it is not specified, a default value <code class="docutils literal"><span class="pre">oauth</span></code>is set.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define <code class="docutils literal"><span class="pre">AccessDeniedHandler</span></code> for OAuth 2.0 provided by Spring Security OAuth.</div>
<div class="line"><code class="docutils literal"><span class="pre">OAuth2AccessDeniedHandler</span></code> handles exception occuring at the time of authorization error and sends error response.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(13)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for <code class="docutils literal"><span class="pre">ClientDetailsUserDetailsService</span></code>- an implementation class of <code class="docutils literal"><span class="pre">UserDetailsService</span></code>interface.</div>
<div class="line"><code class="docutils literal"><span class="pre">UserDetailsService</span></code>used for resource owner authentication and alias BeanID must be specified.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(14)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify a Bean of <code class="docutils literal"><span class="pre">OAuthClientDetailsService</span></code> which fetches client information from  database, in constructor argument.</div>
<div class="line">BeanID to be specified must match with BeanID specified by the implementation class of <code class="docutils literal"><span class="pre">ClientDetailsService</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="resource-owner-authentication">
<span id="oauthauthorizationserverresourceownerauthentication"></span><h5><a class="toc-backref" href="#id95">9.9.2.3.1.4. Resource owner authentication</a><a class="headerlink" href="#resource-owner-authentication" title="Permalink to this headline">¶</a></h5>
<p>When an authorization code grant is used for fetching an access token, a resource owner must be authenticated by a method like providing a login screen among others.</p>
<div class="line-block">
<div class="line">This guideline assumes the use of Spring Security for authentication of resource owner.</div>
<div class="line">A URL with an authorization end point URL must be defined in authorization settings as an access policy to enable access to authorized endpoint URL only to authenticated users.
Similarly, it is necessary to define the forward destination while fetching authorization from resource owner, and the forward destination when a bad client error occurs at authorization endpoint as access policy.</div>
<div class="line">For the controller which handles forward while fetching authorization from resource owner, refer <a class="reference internal" href="#oauthauthorizationserverhowtocustomizeauthorizeview"><span class="std std-ref">Customising scope authorization screen</span></a>, and
for the controller which handles bad client error at authorization end point, refer <a class="reference internal" href="#oauthauthorizationserverhowtohandleerror"><span class="std std-ref">Error handling at the time of authorization request</span></a>.</div>
</div>
<p>For details of Spring Security, refer <a class="reference internal" href="Authentication.html"><span class="doc">Authentication</span></a> and <a class="reference internal" href="Authorization.html"><span class="doc">Authorization</span></a>.</p>
<p>Definition examples of access policies which include authorization endpoint, a forward destination while fetching authorization from resource owner and a forward destination when an exception occurs at authorization endpoint are shown below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">spring-security.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span> <span class="na">authentication-manager-ref=</span><span class="s">&quot;authenticationManager&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;sec:form-login</span> <span class="na">login-page=</span><span class="s">&quot;/login&quot;</span>
        <span class="na">authentication-failure-url=</span><span class="s">&quot;/login?error=true&quot;</span>
        <span class="na">login-processing-url=</span><span class="s">&quot;/login&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:logout</span> <span class="na">logout-url=</span><span class="s">&quot;/logout&quot;</span>
        <span class="na">logout-success-url=</span><span class="s">&quot;/&quot;</span>
        <span class="na">delete-cookies=</span><span class="s">&quot;JSESSIONID&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:access-denied-handler</span> <span class="na">ref=</span><span class="s">&quot;accessDeniedHandler&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:custom-filter</span> <span class="na">ref=</span><span class="s">&quot;userIdMDCPutFilter&quot;</span> <span class="na">after=</span><span class="s">&quot;ANONYMOUS_FILTER&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:session-management</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/login/**&quot;</span> <span class="na">access=</span><span class="s">&quot;permitAll&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/oauth/**&quot;</span> <span class="na">access=</span><span class="s">&quot;isAuthenticated()&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>

 <span class="nt">&lt;sec:authentication-manager</span> <span class="na">alias=</span><span class="s">&quot;authenticationManager&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;sec:authentication-provider</span>
        <span class="na">user-service-ref=</span><span class="s">&quot;userDetailsService&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;sec:password-encoder</span> <span class="na">ref=</span><span class="s">&quot;passwordEncoder&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/sec:authentication-provider&gt;</span>
<span class="nt">&lt;/sec:authentication-manager&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;userDetailsService&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.core.userdetails.jdbc.JdbcDaoImpl&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Apply form authentication to authorization server and specify <code class="docutils literal"><span class="pre">authenticationManager</span></code>defined in (3), in <code class="docutils literal"><span class="pre">authentication-manager-ref</span></code>attribute.</div>
<div class="line">Since <code class="docutils literal"><span class="pre">AuthenticationManager</span></code>is defined in <code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>as well, BeanID of alias must be specified.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">Specify path (<code class="docutils literal"><span class="pre">/oauth/</span></code>) consisting of following so as to be accessible by authenticated users.</div>
</div>
<ul class="last simple">
<li>Authorization endpoint (<code class="docutils literal"><span class="pre">/oauth/authorize</span></code>)</li>
<li>Forward destination while fetching authorization from resource owner (<code class="docutils literal"><span class="pre">/oauth/confirm_access</span></code>)</li>
<li>Forward destination when a bad client error occurs at authorization end point (<code class="docutils literal"><span class="pre">/oauth/error</span></code>)</li>
</ul>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for <code class="docutils literal"><span class="pre">authenticationManager</span></code>for resource owner authentication.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="authorization-for-each-scope">
<span id="oauthauthorizationserverhowtoauthorizebyscope"></span><h5><a class="toc-backref" href="#id96">9.9.2.3.1.5. Authorization for each scope</a><a class="headerlink" href="#authorization-for-each-scope" title="Permalink to this headline">¶</a></h5>
<p>A setup method wherein each scope is authorized individually instead of authorizing the requested scope together while fetching the authorization from resource owner, is explained.</p>
<p>Authorization information must be controlled in a DB for performing perpetual management to prevent loss of authorization information at the time of restarting authorization server or to share authorization information across multiple authorization servers.
Following DB is created for storing authorization information for each scope. The example below explains DB definition when PostgreSQL is used.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ERDiagramApprovals.png"><img alt="../_images/OAuth_ERDiagramApprovals.png" src="../_images/OAuth_ERDiagramApprovals.png" style="width: 50%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">A table to retain authorization information. userId, clientId and scope are used as primary keys.</div>
<div class="line">Role of each column is as below.</div>
</div>
<ul class="last simple">
<li>userId： Column to retain user name of resource owner who performs the authorization.</li>
<li>clientId： Column to retain client ID of the client authorized by the resource owner.</li>
<li>scope： Column to retain scope authorized by resource owner.</li>
<li>status： Column to check whether the authorization is done by the resource owner. <code class="docutils literal"><span class="pre">APPROVED</span></code> is set when authorized and <code class="docutils literal"><span class="pre">DENIED</span></code> is set when authorization is denied.</li>
<li>expiresAt： Column to retain validity period of authorization information.</li>
<li>lastModifiedAt： Column to retain last modified date for authorization information.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Fetch authorization for each scope of resource owner and apply settings to store the same in DB and control.</p>
<p>Implementation example is as below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
     <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span>
     <span class="na">user-approval-handler-ref=</span><span class="s">&quot;userApprovalHandler&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

     <span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;/oauth2:authorization-server&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;userApprovalHandler&quot;</span>
      <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.approval.ApprovalStoreUserApprovalHandler&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;clientDetailsService&quot;</span> <span class="na">ref=</span><span class="s">&quot;clientDetailsService&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;approvalStore&quot;</span> <span class="na">ref=</span><span class="s">&quot;approvalStore&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;requestFactory&quot;</span> <span class="na">ref=</span><span class="s">&quot;requestFactory&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;approvalExpiryInSeconds&quot;</span> <span class="na">value=</span><span class="s">&quot;3200&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;approvalStore&quot;</span>
      <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.approval.JdbcApprovalStore&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;requestFactory&quot;</span>
      <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.request.DefaultOAuth2RequestFactory&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;clientDetailsService&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify a Bean of <code class="docutils literal"><span class="pre">ApprovalStoreUserApprovalHandler</span></code> defined in (2), in <code class="docutils literal"><span class="pre">user-approval-handler-ref</span></code> as <code class="docutils literal"><span class="pre">UserApprovalHandler</span></code> which performs authorization process of scope.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for <code class="docutils literal"><span class="pre">ApprovalStoreUserApprovalHandler</span></code> which performs authorization process of scope.</div>
<div class="line">Specify a Bean of <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.approval.JdbcApprovalStore</span></code> defined in (3), in <code class="docutils literal"><span class="pre">approvalStore</span></code> property which manages authorization results of resource owner.</div>
<div class="line">Specify a Bean of <code class="docutils literal"><span class="pre">OAuthClientDetailsService</span></code> in <code class="docutils literal"><span class="pre">clientDetailsService</span></code> property which fetches client information to be used in authorization process of scope.</div>
<div class="line">Specify a Bean of <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.request.DefaultOAuth2RequestFactory</span></code>in <code class="docutils literal"><span class="pre">requestFactory</span></code> property.</div>
<div class="line">Bean set in <code class="docutils literal"><span class="pre">requestFactory</span></code> property is not used by <code class="docutils literal"><span class="pre">ApprovalStoreUserApprovalHandler</span></code>, however, since an error occurs at the time of Bean generation of <code class="docutils literal"><span class="pre">ApprovalStoreUserApprovalHandler</span></code> when the setting is not applied, settings in <code class="docutils literal"><span class="pre">requestFactory</span></code> property is necessary.</div>
<div class="line">When validity period [Seconds] of authorization information is to be specified, validity period [Seconds] is set in <code class="docutils literal"><span class="pre">approvalExpiryInSeconds</span></code> property. If any setting is not applied, the authorization information will remain valid a month from authorization.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">Define a Bean for <code class="docutils literal"><span class="pre">JdbcApprovalStore</span></code> which manages authorization information in DB.</div>
<div class="line">Specify a database in the constructor to connect to the table for storing authorization information.</div>
<div class="line">For setting methods of data source, refer <a class="reference internal" href="../ArchitectureInDetail/DataAccessDetail/DataAccessCommon.html#data-access-common-howtouse-datasource"><span class="std std-ref">Datasource settings</span></a>.</div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">For precautions on perpetual management of authorization information in DB, <strong>always</strong> refer <a class="reference internal" href="#oauthauthorizationserverhowtocontrolltarnsaction"><span class="std std-ref">Transaction control</span></a>.</p>
</div>
<div class="last admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When perpetual management is not required to be performed for authorization information and is to be managed by in-memory instead of a DB, a Bean is to be defined for <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.approval.InMemoryApprovalStore</span></code> as <code class="docutils literal"><span class="pre">approvalStore</span></code>.</p>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="customising-scope-authorization-screen">
<span id="oauthauthorizationserverhowtocustomizeauthorizeview"></span><h5><a class="toc-backref" href="#id97">9.9.2.3.1.6. Customising scope authorization screen</a><a class="headerlink" href="#customising-scope-authorization-screen" title="Permalink to this headline">¶</a></h5>
<p>When the scope authorization screen is to be customised, it can be done by creating controller and JSP. An example is explained below wherein the scope authorization screen is customised.</p>
<p>When an endpoint which requests authorization to resource owner is to be called, it is forwarded to <code class="docutils literal"><span class="pre">/oauth/confirm_access</span></code>.
A controller which handles <code class="docutils literal"><span class="pre">/oauth/confirm_access</span></code> is created.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">OAuth2ApprovalController.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2ApprovalController</span> <span class="o">{</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/oauth/confirm_access&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">confirmAccess</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// omitted</span>
        <span class="k">return</span> <span class="s">&quot;approval/oauthConfirm&quot;</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use <code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code> annotation and perform mapping as a method for accessing <code class="docutils literal"><span class="pre">/oauth/confirm_access</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Next, a JSP of scope authorization screen is created.
Since scope for authorization is registered as <code class="docutils literal"><span class="pre">scopes</span></code>key and request parameter is registered as <code class="docutils literal"><span class="pre">authorizationRequest</span></code>,
scope authorization screen is displayed as it is.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauthConfirm.jsp</span></code></li>
</ul>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="k">&lt;%@</span> <span class="n">taglib</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;sec&quot;</span> <span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://www.springframework.org/security/tags&quot;</span> <span class="k">%&gt;</span>

<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>OAuth Approval<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;p&gt;</span>Do you authorize ${f:h(authorizationRequest.clientId)} to access your protected resources?<span class="nt">&lt;/p&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">&quot;confirmationForm&quot;</span> <span class="na">name=</span><span class="s">&#39;confirmationForm&#39;</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/oauth/authorize&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;c:forEach</span> <span class="na">var=</span><span class="s">&quot;scope&quot;</span> <span class="na">items=</span><span class="s">&quot;${scopes}&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
                <span class="nt">&lt;li&gt;</span>
                    ${f:h(scope.key)}
                    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;radio&quot;</span> <span class="na">name=</span><span class="s">&quot;${f:h(scope.key)}&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>Approve
                    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;radio&quot;</span> <span class="na">name=</span><span class="s">&quot;${f:h(scope.key)}&quot;</span> <span class="na">value=</span><span class="s">&quot;false&quot;</span><span class="nt">/&gt;</span>Deny
                <span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;/c:forEach&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;user_oauth_approval&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
            <span class="nt">&lt;sec:csrfInput</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (4) --&gt;</span>
            <span class="nt">&lt;label&gt;</span>
                <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;authorize&quot;</span> <span class="na">value=</span><span class="s">&quot;Authorize&quot;</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;/form&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client ID is displayed on the screen.</div>
<div class="line">Type of <code class="docutils literal"><span class="pre">authorizationRequest</span></code>is <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.AuthorizationRequest</span></code>and client ID is output by specifying <code class="docutils literal"><span class="pre">authorizationRequest.clientId</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A radio button is output for specifying authorization allowed/denied for each scope. Since target scope is included in <code class="docutils literal"><span class="pre">scopes</span></code>, specify <code class="docutils literal"><span class="pre">scopes</span></code>in <code class="docutils literal"><span class="pre">items</span></code>.</div>
<div class="line"><code class="docutils literal"><span class="pre">scopes</span></code>type is <code class="docutils literal"><span class="pre">LinkedHashMap</span></code>and retains authorization allowed/denied information for the scope, using scope name as a key.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring Security OAuth assigns <code class="docutils literal"><span class="pre">user_oauth_approval</span></code> to the request parameter by embedding <code class="docutils literal"><span class="pre">user_oauth_approval</span></code> as a hidden item.</div>
<div class="line"><code class="docutils literal"><span class="pre">user_oauth_approval</span></code> assigned to the request parameter can be used for executing a method which performs scope authorization of authorization endpoint.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify <code class="docutils literal"><span class="pre">&lt;sec:csrfInput</span> <span class="pre">/&gt;</span></code> element in <code class="docutils literal"><span class="pre">&lt;form&gt;</span></code> element of HTML in order to deliver CSRF token.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="error-handling-at-the-time-of-authorization-request">
<span id="oauthauthorizationserverhowtohandleerror"></span><h5><a class="toc-backref" href="#id98">9.9.2.3.1.7. Error handling at the time of authorization request</a><a class="headerlink" href="#error-handling-at-the-time-of-authorization-request" title="Permalink to this headline">¶</a></h5>
<p>When an unauthorized client error (errors related to security such as client not found, redirect URI check error) occurs, <code class="docutils literal"><span class="pre">OAuth2Exception</span></code> provided by Spring Security OAuth is thrown and request is forwarded to <code class="docutils literal"><span class="pre">/oauth/error</span></code>.
Therefore, a controller which handles <code class="docutils literal"><span class="pre">/oauth/error</span></code> must be created.
For details of unauthorized client error, refer <a class="reference internal" href="#definitionofbadclienterror"><span class="std std-ref">Unauthorized client error</span></a>.</p>
<p>Implementation example of controller is shown below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">OAuth2ErrorController.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2ErrorController</span> <span class="o">{</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/oauth/error&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">handleError</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// omitted</span>
        <span class="k">return</span> <span class="s">&quot;common/error/oauthError&quot;</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use <code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code> annotation and perform mapping as a method for accessing <code class="docutils literal"><span class="pre">/oauth/error</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Next, a JSP of error screen thus displayed is created.
Since details of exceptions occurred in authorization end point are registered in the <code class="docutils literal"><span class="pre">error</span></code>- attribute name of model, exception details are displayed on the screen using the same.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauthError.jsp</span></code></li>
</ul>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;title&gt;</span>OAuth Error!<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;${pageContext.request.contextPath}/resources/app/css/styles.css&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>OAuth Error!<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;c:if</span> <span class="na">test=</span><span class="s">&quot;${not empty error}&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;p&gt;</span>${f:h(error.oAuth2ErrorCode)}<span class="nt">&lt;/p&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
            <span class="nt">&lt;p&gt;</span>${f:h(error.message)}<span class="nt">&lt;/p&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;/c:if&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Output error code of OAuth 2.0 set in exception.</div>
<div class="line">Error code consists of values like <code class="docutils literal"><span class="pre">invalid_request</span></code> and <code class="docutils literal"><span class="pre">invalid_client</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Output error message set in exception.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When an error occurred at authorization end point is other than unauthorized client error,
error is notified to the client by redirecting to the controller for calling the client.
Error information while notifying the error is assigned to redirect URI as request parameter.
For error handling, refer <a class="reference internal" href="#oauthclienthandleerrorwhenaccessingauthorizationendpointwithcode"><span class="std std-ref">Error handling while accessing authorization end point</span></a>.</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>If the application supports Internet Explorer/Microsoft Edge, size of HTML generated as a response to error screen must be taken into consideration.</p>
<p>In Internet Explorer/Microsoft Edge, if the size of HTML sent as a response is less than specified value, a simple message offered by Internet Explorer/Microsoft Edge is displayed instead of error screen provided by the application.</p>
<p class="last">For the reference, refer “<a class="reference external" href="https://blogs.msdn.microsoft.com/ieinternals/2010/08/18/friendly-http-error-pages/">Friendly HTTP Error Pages</a>” for detail conditions of Internet Explorer.</p>
</div>
</div>
<div class="section" id="how-to-share-access-token-with-resource-server">
<span id="oauthauthorizationserverhowtoconfigureaccesstoken"></span><h5><a class="toc-backref" href="#id99">9.9.2.3.1.8. How to share access token with resource server</a><a class="headerlink" href="#how-to-share-access-token-with-resource-server" title="Permalink to this headline">¶</a></h5>
<p>Authorization server links with the access token via <code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code> so that the resource server can determine the authorization for accessing a resource based on access token.
Various methods exist for methods for linking.</p>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Method of linking</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Linking via DB</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method wherein a common DB is used and access token is linked.</div>
<div class="line">It can be used when resource server and authorization server share a DB.</div>
<div class="line">Authorization server specifies <code class="docutils literal"><span class="pre">DefaultTokenServices</span></code> as an implementation class of <code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code>, and <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.store.JdbcTokenStore</span></code> as an implementation of <code class="docutils literal"><span class="pre">TokenStore</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Linking via HTTP access</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method wherein access token is linked by accessing HTTP.</div>
<div class="line">This method is used when resource server and authorization server cannot use a common DB.</div>
<div class="line">Since the resource server requests the fetching and verification of access token to authorization server, authorization server is overloaded.</div>
<div class="line">Authorization server specifies <code class="docutils literal"><span class="pre">DefaultTokenServices</span></code> as an implementation class of <code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code>.</div>
<div class="line">Specify <code class="docutils literal"><span class="pre">JdbcTokenStore</span></code> when the access token is to be managed by DB and <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.store.InMemoryTokenStore</span></code>when it is to be managed by memory, as <code class="docutils literal"><span class="pre">TokenStore</span></code>.</div>
<div class="line">Implementation wherein the access token is managed by memory is exclusively for testing purpose since access tokens are lost due to operations like restarting a server etc.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Linking via JWT</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method wherein JWT is used and access token is linked.</div>
<div class="line">This method is used when resource server and authorization server cannot use a common DB.</div>
<div class="line">Since request is not sent to authorization server for fetching an access token, when compared with linking via HTTP access, authorization server is not overloaded.</div>
<div class="line">Authorization server specifies <code class="docutils literal"><span class="pre">DefaultTokenServices</span></code> as an implementation class of <code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code>and <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.store.JwtTokenStore</span></code> as an implementation of <code class="docutils literal"><span class="pre">TokenStore</span></code>.</div>
<div class="line">Access token is signed, encoded and decoded by using <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter</span></code>.</div>
<div class="line">There are two methods for signing and verification of access token - a method which uses public key and a method which uses common key.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Linking via memory</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method wherein access token is linked by sharing the memory.</div>
<div class="line">It can be used when an application is designed wherein resource server and authorization server become a single process.</div>
<div class="line">Authorization server specifies <code class="docutils literal"><span class="pre">DefaultTokenServices</span></code> as an implementation class of <code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code>and <code class="docutils literal"><span class="pre">InMemoryTokenStore</span></code> as an implementation of <code class="docutils literal"><span class="pre">TokenStore</span></code>.</div>
<div class="line">Since the access token is linked via memory, linking of access token using common DB and HTTP access is not necessary.</div>
<div class="line">Implementation wherein the access token is shared via memory is exclusively for testing purpose since access tokens are lost due to operations like restarting the server etc.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p class="last">How to implement linking by using JWT will be explained in detail in next version.</p>
</div>
<p>Here, a method wherein access token is linked via common DB is explained as a representative method.
A method to link via HTTP access is explained in How To Extend of this section.</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="#oauthauthorizationserverhowtocooperatewithhttp"><span class="std std-ref">Linking Authorization Server and Resource Server through HTTP access</span></a></li>
</ul>
</div></blockquote>
<p>When access token is linked via a common DB, <code class="docutils literal"><span class="pre">JdbcTokenStore</span></code> offered by Spring Security OAuth is used.</p>
<p>Implementation example is as below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
     <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span>
     <span class="na">user-approval-handler-ref=</span><span class="s">&quot;userApprovalHandler&quot;</span>
     <span class="na">token-services-ref=</span><span class="s">&quot;tokenServices&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;oauth2:authorization-code</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;tokenServices&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.DefaultTokenServices&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;tokenStore&quot;</span> <span class="na">ref=</span><span class="s">&quot;tokenStore&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;clientDetailsService&quot;</span> <span class="na">ref=</span><span class="s">&quot;clientDetailsService&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;supportRefreshToken&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;tokenStore&quot;</span>
  <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.store.JdbcTokenStore&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
  <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify <code class="docutils literal"><span class="pre">tokenServices</span></code> defined in (2) in <code class="docutils literal"><span class="pre">token-services-ref</span></code> attribute as TokenService used by authorization server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify <code class="docutils literal"><span class="pre">DefaultTokenServices</span></code> in <code class="docutils literal"><span class="pre">tokenServices</span></code> class.</div>
<div class="line">Specify <code class="docutils literal"><span class="pre">TokenStore</span></code> defined in (4), in <code class="docutils literal"><span class="pre">tokenStore</span></code> property as the token store which manages access tokens.</div>
<div class="line">This setting is applied to resource server as well when the access token is linked with resource server via common DB.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify <code class="docutils literal"><span class="pre">true</span></code> in <code class="docutils literal"><span class="pre">supportRefreshToken</span></code> attribute when refresh token is enabled.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for <code class="docutils literal"><span class="pre">JdbcTokenStore</span></code> as the token store.</div>
<div class="line">Specify a data source in the constructor for connecting to a table wherein token information is stored.</div>
<div class="line">For setting methods of data source, refer <a class="reference internal" href="../ArchitectureInDetail/DataAccessDetail/DataAccessCommon.html#data-access-common-howtouse-datasource"><span class="std std-ref">Datasource settings</span></a>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><code class="docutils literal"><span class="pre">JdbcTokenStore</span></code> creates following DB wherein a schema is defined for Spring Security OAuth, for linking the access tokens.
The example below explains the DB definition while using PostgreSQL as a common DB.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ERDiagramToken.png"><img alt="../_images/OAuth_ERDiagramToken.png" src="../_images/OAuth_ERDiagramToken.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">A table which manages the access token. It is used to share information of access token issued by authorization server with the resource server.</div>
<div class="line">Roles of each column are as below.</div>
</div>
<ul class="last">
<li><p class="first">authentication_id: A column to store authentication key which uniquely identifies authentication information. It is used as a primary key.</p>
</li>
<li><div class="first line-block">
<div class="line">token: A column which retains token information as a binary after serializing.</div>
<div class="line">Validity period of access token, scope, token ID of access token, token ID of refresh token, token type which shows types of token to be used are stored as information of the token to be retained.</div>
</div>
</li>
<li><p class="first">token_id: A column to retain token ID which uniquely identifies access token.</p>
</li>
<li><p class="first">user_name: A column to retain user name of authenticated resource owner.</p>
</li>
<li><p class="first">client_id: A column to retain client ID of authenticated client.</p>
</li>
<li><p class="first">authentication: A column which retains authentication information of resource owner and client as a binary after serializing.</p>
</li>
<li><p class="first">refresh_token: A column which retains token ID of refresh token associated with access token.</p>
</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">A table which manages refresh token associated with access token.</div>
<div class="line">Roles of each column are as given below.</div>
</div>
<ul class="last">
<li><p class="first">token_id: A column to retain token ID which uniquely identifies refresh token. It is used as a primary key.</p>
</li>
<li><p class="first">token: A column which retains token information as binary after serializing. It retains validity period of refresh token.</p>
</li>
<li><div class="first line-block">
<div class="line">authentication: A column that retains authentication information of resource owner and client as binary after serializing.</div>
<div class="line">Information same as authentication information retained by table which manages access tokens, is retained.</div>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When the token is managed by common DB, the expired token is deleted within the timing of use of access token by client.
Therefore, even if token has expired, access token is deleted only when it is accessed by the client.
Expired tokens must be purged separately by batch processing in order to delete the same from DB.</p>
</div>
</div>
<div class="section" id="canceling-a-token-authorization-server">
<span id="oauthauthorizationserverhowtocanceltoken"></span><h5><a class="toc-backref" href="#id100">9.9.2.3.1.9. Canceling a token (authorization server)</a><a class="headerlink" href="#canceling-a-token-authorization-server" title="Permalink to this headline">¶</a></h5>
<p>How to implement cancellation of issued access token is explained.</p>
<p>Access token can be cancelled by calling <code class="docutils literal"><span class="pre">revokeToken</span></code> method of a class
which implements <code class="docutils literal"><span class="pre">ConsumerTokenService</span></code> interface.
<code class="docutils literal"><span class="pre">DefaultTokenServices</span></code> class implements <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.ConsumerTokenServices</span></code> interface.</p>
<p>Authorization information can be deleted as well at the time of cancellation of access token.
When authorization request is sent without deleting authorization information after cancellation of access token, authorization information at the time of previous authorization request is reused.
Authorization information at the time of previous authorization request can be reused when validity period of authorization information is valid and entire authorization request scope is authorized.</p>
<p>Implementation example is given below.</p>
<p>An interface of service class which cancels a token and implementation class are created.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">RevokeTokenService.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RevokeTokenService</span> <span class="o">{</span>

    <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="nf">revokeToken</span><span class="o">(</span><span class="n">String</span> <span class="n">tokenValue</span><span class="o">,</span> <span class="n">String</span> <span class="n">clientId</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">RevokeTokenServiceImpl.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RevokeTokenServiceImpl</span> <span class="kd">implements</span> <span class="n">RevokeTokenService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ConsumerTokenServices</span> <span class="n">consumerService</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="nd">@Inject</span>
    <span class="n">TokenStore</span> <span class="n">tokenStore</span><span class="o">;</span> <span class="c1">// (2)</span>

    <span class="nd">@Inject</span>
    <span class="n">ApprovalStore</span> <span class="n">approvalStore</span><span class="o">;</span> <span class="c1">// (3)</span>

    <span class="nd">@Inject</span>
    <span class="n">JodaTimeDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">revokeToken</span><span class="o">(</span><span class="n">String</span> <span class="n">tokenValue</span><span class="o">,</span> <span class="n">String</span> <span class="n">clientId</span><span class="o">){</span> <span class="c1">// (4)</span>
        <span class="c1">// (5)</span>
        <span class="n">OAuth2Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="n">tokenStore</span><span class="o">.</span><span class="na">readAuthentication</span><span class="o">(</span><span class="n">tokenValue</span><span class="o">);</span>

        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">authentication</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">clientId</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">authentication</span><span class="o">.</span><span class="na">getOAuth2Request</span><span class="o">().</span><span class="na">getClientId</span><span class="o">()))</span> <span class="o">{</span> <span class="c1">// (6)</span>
                <span class="c1">// (7)</span>
                <span class="n">Authentication</span> <span class="n">user</span> <span class="o">=</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getUserAuthentication</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Approval</span><span class="o">&gt;</span> <span class="n">approvals</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
                    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">scope</span> <span class="o">:</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getOAuth2Request</span><span class="o">().</span><span class="na">getScope</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">approvals</span><span class="o">.</span><span class="na">add</span><span class="o">(</span>
                                <span class="k">new</span> <span class="n">Approval</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">clientId</span><span class="o">,</span> <span class="n">scope</span><span class="o">,</span> <span class="n">dateFactory</span><span class="o">.</span><span class="na">newDate</span><span class="o">(),</span> <span class="n">ApprovalStatus</span><span class="o">.</span><span class="na">APPROVED</span><span class="o">));</span>
                    <span class="o">}</span>
                    <span class="n">approvalStore</span><span class="o">.</span><span class="na">revokeApprovals</span><span class="o">(</span><span class="n">approvals</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">consumerService</span><span class="o">.</span><span class="na">revokeToken</span><span class="o">(</span><span class="n">tokenValue</span><span class="o">);</span> <span class="c1">// (8)</span>
                <span class="k">return</span> <span class="n">ResponseEntity</span><span class="o">.</span><span class="na">ok</span><span class="o">().</span><span class="na">body</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>

            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;error&quot;</span><span class="o">,</span> <span class="s">&quot;invalid_client&quot;</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">ResponseEntity</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">UNAUTHORIZED</span><span class="o">).</span><span class="na">body</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;error&quot;</span><span class="o">,</span> <span class="s">&quot;invalid_request&quot;</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">ResponseEntity</span><span class="o">.</span><span class="na">badRequest</span><span class="o">().</span><span class="na">body</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inject a Bean of <code class="docutils literal"><span class="pre">ConsumerTokenService</span></code> interface which cancels access tokens.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inject a Bean of <code class="docutils literal"><span class="pre">TokenStore</span></code> used to fetch authentication information while issuing an access token.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inject a Bean of <code class="docutils literal"><span class="pre">ApprovalStore</span></code> used to fetch authorization information while issuing an access token.</div>
<div class="line">It is not required when authorization information is not to be deleted while cancelling an access token.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Receive value of access token to be cancelled and client ID used for checking the client as parameters.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call <code class="docutils literal"><span class="pre">readAuthentication</span></code> method of <code class="docutils literal"><span class="pre">TokenStore</span></code> and fetch authentication information while issuing an access token.</div>
<div class="line">Token is deleted only when authentication information can be successfully fetched.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch client ID used at the time of issuing access token, from authentication information and check whether it matches with client ID of request parameter.</div>
<div class="line">Delete access token only when it matches with client ID at the time of issuing an access token.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch authentication information of resource owner at the time of issuing an access token.</div>
<div class="line">When authentication information of resource owner could be fetched, call <code class="docutils literal"><span class="pre">revokeApprovals</span></code> method of <code class="docutils literal"><span class="pre">TokenStore</span></code> and delete authorization information.</div>
<div class="line">Since authentication information for resource owner does not exist while using client credential grant, the parameters to be passed to <code class="docutils literal"><span class="pre">revokeApprovals</span></code> method cannot be generated.</div>
<div class="line">Therefore, authorization information cannot be deleted when it is not possible to fetch authentication information of resource owner.</div>
<div class="line">This process is not required when authorization information is not deleted while cancelling the access token.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call <code class="docutils literal"><span class="pre">revokeToken</span></code> method of <code class="docutils literal"><span class="pre">ConsumerTokenService</span></code> and delete access token and refresh token associated with access token.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>A controller which receives a cancellation request of token is created.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">TokenRevocationRestController.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;oauth&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TokenRevocationRestController</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">RevokeTokenService</span> <span class="n">revokeTokenService</span><span class="o">;</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;tokens/revoke&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="nf">revoke</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;token&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">tokenValue</span><span class="o">,</span>
        <span class="nd">@AuthenticationPrincipal</span> <span class="n">UserDetails</span> <span class="n">user</span><span class="o">){</span>

        <span class="c1">// (2)</span>
        <span class="n">String</span> <span class="n">clientId</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getUsername</span><span class="o">();</span>
        <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">revokeTokenService</span><span class="o">.</span><span class="na">revokeToken</span><span class="o">(</span><span class="n">tokenValue</span><span class="o">,</span> <span class="n">clientId</span><span class="o">);</span> <span class="c1">// (3)</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. no.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use <code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code> annotation and map as a method for accessing <code class="docutils literal"><span class="pre">&quot;/oauth/tokens/revoke&quot;</span></code>.</div>
<div class="line">The path specified here must apply Basic authentication and disable CSRF countermeasures, similar to settings performed in <a class="reference internal" href="#oauthauthorizationserverclientauthentication"><span class="std std-ref">Client authentication</span></a>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch client ID used while checking the cancellation of token, from authentication information generated in Basic authentication.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call <code class="docutils literal"><span class="pre">RevokeTokenService</span></code> and delete a token.</div>
<div class="line">Pass value of access token received as the request parameter and client ID received from authentication information as parameters.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">RFC 7009 states that <code class="docutils literal"><span class="pre">token_type_hint</span></code> can be arbitrarily assigned as a request parameter.
<code class="docutils literal"><span class="pre">token_type_hint</span></code> is a hint to determine whether to delete access token or refresh token.
<code class="docutils literal"><span class="pre">ConsumerTokenService</span></code> offered by Spring Security OAuth is not used in the implementation example above in order to delete both access token and refresh token by passing the access token.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The client which requests deletion of token to the authorization server should also delete a token retained by the client after deletion of authorization server.
For deletion of token of client server, refer <a class="reference internal" href="#oauthclientserverhowtocanceltoken"><span class="std std-ref">Cancelling a token (Client server)</span></a>.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="transaction-control">
<span id="oauthauthorizationserverhowtocontrolltarnsaction"></span><h5><a class="toc-backref" href="#id101">9.9.2.3.1.10. Transaction control</a><a class="headerlink" href="#transaction-control" title="Permalink to this headline">¶</a></h5>
<p>It explains precautions of transaction control in authorization server.</p>
<p>When the information handled by Spring Security OAuth (authorization code, authorization information, token) is to be managed in DB, transaction control must be considered.</p>
<p><code class="docutils literal"><span class="pre">&#64;Transactional</span></code> annotation is assigned in <code class="docutils literal"><span class="pre">DefaultTokenServices</span></code> which issues access token and refresh token, and transaction control is performed, however, <code class="docutils literal"><span class="pre">&#64;Transactional</span></code> annotation
is not assigned in <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.code.AuthorizationCodeServices</span></code> which handles authorization code and <code class="docutils literal"><span class="pre">UserApprovalHandler</span></code> which handles authorization information
and hence transaction control is not performed.</p>
<p>Hence, when autocommit of connection fetched from  <code class="docutils literal"><span class="pre">DataSource</span></code> is disabled, transaction control settings are mandatory since information to be managed is not registered in DB.
Further, even when autocommit is enabled, transaction control must be performed to ensure data consistency.</p>
<p>An example of transaction control when authorization code and authorization information are managed in DB is shown below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;tx:advice</span> <span class="na">id=</span><span class="s">&quot;oauthTransactionAdvice&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;tx:attributes&gt;</span>
        <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">&quot;*&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/tx:attributes&gt;</span>
<span class="nt">&lt;/tx:advice&gt;</span>

<span class="nt">&lt;aop:config&gt;</span>
    <span class="nt">&lt;aop:pointcut</span> <span class="na">id=</span><span class="s">&quot;authorizationOperation&quot;</span>
                  <span class="na">expression=</span><span class="s">&quot;execution(* org.springframework.security.oauth2.provider.code.AuthorizationCodeServices.*(..))&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;aop:pointcut</span> <span class="na">id=</span><span class="s">&quot;approvalOperation&quot;</span>
                  <span class="na">expression=</span><span class="s">&quot;execution(* org.springframework.security.oauth2.provider.approval.UserApprovalHandler.*(..))&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;aop:advisor</span> <span class="na">pointcut-ref=</span><span class="s">&quot;authorizationOperation&quot;</span> <span class="na">advice-ref=</span><span class="s">&quot;oauthTransactionAdvice&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;aop:advisor</span> <span class="na">pointcut-ref=</span><span class="s">&quot;approvalOperation&quot;</span> <span class="na">advice-ref=</span><span class="s">&quot;oauthTransactionAdvice&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/aop:config&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set <code class="docutils literal"><span class="pre">tx:advice</span></code> to manage transaction using AOP.</div>
<div class="line">Namespace and schema of <code class="docutils literal"><span class="pre">tx</span></code> are added to use this tag.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use AOP and set transaction boundary in each method which operates authorization code.</div>
<div class="line">Namespace and schema of <code class="docutils literal"><span class="pre">aop</span></code> are added to use this tag.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use AOP and set transaction boundary in each method which operates authorization information.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="implementation-of-resource-server">
<span id="implementationoauthresourceserverofautorizationcode"></span><h4><a class="toc-backref" href="#id102">9.9.2.3.2. Implementation of resource server</a><a class="headerlink" href="#implementation-of-resource-server" title="Permalink to this headline">¶</a></h4>
<p>How to implement a resource server is explained.</p>
<p>Resource server provides access token verification and authorization control for resources using Spring Security OAuth function.</p>
<p>Here, how to implement a resource server is explained by using implementation example wherein authorization is set for REST API of TODO resource.</p>
<div class="section" id="creating-a-setup-file-resource-server">
<h5><a class="toc-backref" href="#id103">9.9.2.3.2.1. Creating a setup file (resource server)</a><a class="headerlink" href="#creating-a-setup-file-resource-server" title="Permalink to this headline">¶</a></h5>
<p>A new Bean definition file for OAuth 2.0 is created while implementing a resource server.</p>
<p>Here, it is <code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code>.</p>
<p>Following settings are added to <code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code>.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xmlns:oauth2=</span><span class="s">&quot;http://www.springframework.org/schema/security/oauth2&quot;</span>
       <span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/security</span>
<span class="s">           http://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">           http://www.springframework.org/schema/security/oauth2</span>
<span class="s">           http://www.springframework.org/schema/security/spring-security-oauth2.xsd</span>
<span class="s">           http://www.springframework.org/schema/beans</span>
<span class="s">           http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;sec:http</span> <span class="na">pattern=</span><span class="s">&quot;/api/v1/todos/**&quot;</span> <span class="na">create-session=</span><span class="s">&quot;stateless&quot;</span>
                   <span class="na">entry-point-ref=</span><span class="s">&quot;oauth2AuthenticationEntryPoint&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;sec:access-denied-handler</span> <span class="na">ref=</span><span class="s">&quot;oauth2AccessDeniedHandler&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;sec:csrf</span> <span class="na">disabled=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
        <span class="nt">&lt;sec:custom-filter</span> <span class="na">ref=</span><span class="s">&quot;oauth2AuthenticationFilter&quot;</span>
                                <span class="na">before=</span><span class="s">&quot;PRE_AUTH_FILTER&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
        <span class="nt">&lt;sec:custom-filter</span> <span class="na">ref=</span><span class="s">&quot;userIdMDCPutFilter&quot;</span> <span class="na">after=</span><span class="s">&quot;ANONYMOUS_FILTER&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/sec:http&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;oauth2AccessDeniedHandler&quot;</span>
              <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.error.OAuth2AccessDeniedHandler&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (5) --&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;oauth2AuthenticationEntryPoint&quot;</span>
              <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.error.OAuth2AuthenticationEntryPoint&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (6) --&gt;</span>

    <span class="nt">&lt;oauth2:resource-server</span> <span class="na">id=</span><span class="s">&quot;oauth2AuthenticationFilter&quot;</span> <span class="na">resource-id=</span><span class="s">&quot;todoResource&quot;</span>
              <span class="na">token-services-ref=</span><span class="s">&quot;tokenServices&quot;</span> <span class="na">entry-point-ref=</span><span class="s">&quot;oauth2AuthenticationEntryPoint&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (7) --&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the pattern on path that is the target of authorization control in  <code class="docutils literal"><span class="pre">pattern</span></code> attribute.</div>
<div class="line">Specify the Bean of <code class="docutils literal"><span class="pre">OAuth2AuthenticationEntryPoint</span></code> in  <code class="docutils literal"><span class="pre">entry-point-ref</span></code>. Settings are required for definition, however the specified Bean is not used.
Actually, the Bean of <code class="docutils literal"><span class="pre">OAuth2AuthenticationEntryPoint</span></code> specified in <code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code> described later is used.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set the Bean of <code class="docutils literal"><span class="pre">OAuth2AccessDeniedHandler</span></code> in <code class="docutils literal"><span class="pre">access-denied-handler</span></code>. Here, specify a Bean of <code class="docutils literal"><span class="pre">oauth2AccessDeniedHandler</span></code>defined in (5).</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Invalidate CSRF countermeasures in this implementation example.</div>
<div class="line">For CSRF countermeasures, refer <a class="reference internal" href="../ArchitectureInDetail/WebServiceDetail/REST.html#resthowtousesecuritycsrf"><span class="std std-ref">CSRF measures</span></a>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set <code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code>as an authentication filter for resource server for resource server in <code class="docutils literal"><span class="pre">custom-filter</span></code>.</div>
<div class="line">Specify a Bean of <code class="docutils literal"><span class="pre">oauth2AuthenticationFilter</span></code>defined in (7).</div>
<div class="line">Since <code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code> is a filter for performing Pre-Authentication by using access token included in request,
set in such a way that <code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code> process is executed before <code class="docutils literal"><span class="pre">PRE_AUTH_FILTER</span></code> by specifying <code class="docutils literal"><span class="pre">PRE_AUTH_FILTER</span></code> in  <code class="docutils literal"><span class="pre">before</span></code>.</div>
<div class="line">For Pre-Authentication, refer <a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.0.x/reference/preauth.html">Pre-Authentication Scenarios</a>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define <code class="docutils literal"><span class="pre">AccessDeniedHandler</span></code> for resource server provided by Spring Security OAuth.</div>
<div class="line"> <code class="docutils literal"><span class="pre">OAuth2AccessDeniedHandler</span></code> sends the error response by handling the exceptions that occur at the time of authorization error.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define the Bean of <code class="docutils literal"><span class="pre">OAuth2AuthenticationEntryPoint</span></code> for sending the error response for OAuth.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define the ServletFilter for the resource server provided by Spring Security OAuth.</div>
<div class="line"><code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code>is registered as Authentication Filter by using <code class="docutils literal"><span class="pre">&lt;oauth2:resource-server&gt;</span></code>tag.</div>
<div class="line">The string specified in <code class="docutils literal"><span class="pre">id</span></code> attribute is the Bean ID. Here,``oauth2AuthenticationFilter`` is specified.</div>
<div class="line">Specify the resource ID provided by server in <code class="docutils literal"><span class="pre">resource-id</span></code> attribute. Here, <code class="docutils literal"><span class="pre">todoResource</span></code> is specified.</div>
<div class="line">It is verified whether the resource ID specified in <code class="docutils literal"><span class="pre">resource-id</span></code> attribute is included for the resource ID of client information linked to access token.</div>
<div class="line">As a result of verification, it is allowed to access the resource only when resource ID is included.</div>
<div class="line">Note that, definition of <code class="docutils literal"><span class="pre">resource-id</span></code>  is optional and when it is not defined, resource ID is not verified.</div>
<div class="line">Specify the ID of <code class="docutils literal"><span class="pre">TokenServices</span></code> in <code class="docutils literal"><span class="pre">token-services-ref</span></code> attribute. <code class="docutils literal"><span class="pre">TokenServices</span></code> is described later.</div>
<div class="line">Specify the Bean of <code class="docutils literal"><span class="pre">OAuth2AuthenticationEntryPoint</span></code> in  <code class="docutils literal"><span class="pre">entry-point-ref</span></code> attribute. Here, <code class="docutils literal"><span class="pre">oauth2AuthenticationEntryPoint</span></code> is specified.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Add the settings in  <code class="docutils literal"><span class="pre">web.xml</span></code> so as to read a created  <code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code>.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">web.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;context-param&gt;</span>
    <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
    <span class="nt">&lt;param-value&gt;</span>
        classpath*:META-INF/spring/applicationContext.xml
        classpath*:META-INF/spring/oauth2-resource.xml <span class="c">&lt;!-- (1) --&gt;</span>
        classpath*:META-INF/spring/spring-security.xml
    <span class="nt">&lt;/param-value&gt;</span>
<span class="nt">&lt;/context-param&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">First read <code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code> considering that the path including the path pattern set in <code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code> is set as the access control target in <code class="docutils literal"><span class="pre">spring-security.xml</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="setting-of-accessible-scope-for-the-resource">
<h5><a class="toc-backref" href="#id104">9.9.2.3.2.2. Setting of accessible scope for the resource</a><a class="headerlink" href="#setting-of-accessible-scope-for-the-resource" title="Permalink to this headline">¶</a></h5>
<p>In order to define the accessible scope for each resource, add the scope definition and Bean
definition for supporting SpEL expression in Bean definition file for OAuth 2.0.</p>
<p>Implementation example is as given below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xmlns:oauth2=</span><span class="s">&quot;http://www.springframework.org/schema/security/oauth2&quot;</span>
       <span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/security</span>
<span class="s">           http://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">           http://www.springframework.org/schema/security/oauth2</span>
<span class="s">           http://www.springframework.org/schema/security/spring-security-oauth2.xsd</span>
<span class="s">           http://www.springframework.org/schema/beans</span>
<span class="s">           http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;sec:http</span> <span class="na">pattern=</span><span class="s">&quot;/api/v1/todos/**&quot;</span> <span class="na">create-session=</span><span class="s">&quot;stateless&quot;</span>
                   <span class="na">entry-point-ref=</span><span class="s">&quot;oauth2AuthenticationEntryPoint&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;sec:access-denied-handler</span> <span class="na">ref=</span><span class="s">&quot;oauth2AccessDeniedHandler&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;sec:csrf</span> <span class="na">disabled=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;sec:expression-handler</span> <span class="na">ref=</span><span class="s">&quot;oauth2ExpressionHandler&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/**&quot;</span> <span class="na">method=</span><span class="s">&quot;GET&quot;</span>
                                <span class="na">access=</span><span class="s">&quot;#oauth2.hasScope(&#39;READ&#39;)&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/**&quot;</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span>
                                <span class="na">access=</span><span class="s">&quot;#oauth2.hasScope(&#39;CREATE&#39;)&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;sec:custom-filter</span> <span class="na">ref=</span><span class="s">&quot;oauth2AuthenticationFilter&quot;</span>
                                <span class="na">before=</span><span class="s">&quot;PRE_AUTH_FILTER&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;sec:custom-filter</span> <span class="na">ref=</span><span class="s">&quot;userIdMDCPutFilter&quot;</span> <span class="na">after=</span><span class="s">&quot;ANONYMOUS_FILTER&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/sec:http&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;oauth2:web-expression-handler</span> <span class="na">id=</span><span class="s">&quot;oauth2ExpressionHandler&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify a Bean of <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.expression.OAuth2WebSecurityExpressionHandler</span></code>in  <code class="docutils literal"><span class="pre">expression-handler</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define access policy as per the scope for the resource by using <code class="docutils literal"><span class="pre">intercept-url</span></code>.</div>
<div class="line">Specify the path pattern of resource to be retained in <code class="docutils literal"><span class="pre">pattern</span></code> attribute. In this implementation example, resource is retained under /api/v1/todos/.</div>
<div class="line">Specify the HTTP method of resource in  <code class="docutils literal"><span class="pre">method</span></code> attribute.</div>
<div class="line">Specify the scope that authorizes the access to resource in <code class="docutils literal"><span class="pre">access</span></code> attribute. Differentiate the setting value by upper-case and lower case characters.</div>
<div class="line">Here, it is specified by using SpEL expression.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define the Bean of  <code class="docutils literal"><span class="pre">OAuth2WebSecurityExpressionHandler</span></code>.</div>
<div class="line">SpeL for performing authorization control provided by Spring Security OAuth is supported by defining this Bean.</div>
<div class="line">Note that, the value specified in <code class="docutils literal"><span class="pre">id</span></code> attribute is the id for this bean.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>The main Expression provided by Spring Security OAuth is introduced.</p>
<p>For details, refer <a class="reference external" href="http://docs.spring.io/spring-security/oauth/apidocs/org/springframework/security/oauth2/provider/expression/OAuth2SecurityExpressionMethods.html">JavaDoc</a> of <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.expression.OAuth2SecurityExpressionMethods</span></code>.</p>
<table border="1" class="colwidths-given longtable docutils" id="id50">
<caption><span class="caption-text"><strong>Expression provided by Spring Security OAuth</strong></span><a class="headerlink" href="#id50" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Expression</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">hasScope(String</span> <span class="pre">scope)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Return <code class="docutils literal"><span class="pre">true</span></code> when the scope authorized by the resource owner and the scope of the argument matches in the client.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">hasAnyScope(String...</span> <span class="pre">scopes)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Return <code class="docutils literal"><span class="pre">true</span></code> when the scope authorized by the resource owner and one of the scopes of the argument matches in the client.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">hasScopeMatching(String</span> <span class="pre">scopeRegex)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Return <code class="docutils literal"><span class="pre">true</span></code> when the scope authorized by the resource owner and the regular expression specified in the argument matches in the client.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">hasAnyScopeMatching(String...</span> <span class="pre">scopesRegex)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Return <code class="docutils literal"><span class="pre">true</span></code> when the scope authorized by the resource owner and one of the regular expressions specified in the argument matches in the client.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">clientHasRole(String</span> <span class="pre">role)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Return <code class="docutils literal"><span class="pre">true</span></code> when the client performs the role specified in the argument.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">clientHasAnyRole(String...</span> <span class="pre">roles)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Return <code class="docutils literal"><span class="pre">true</span></code> when the client performs one of the roles specified in the argument.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">denyOAuthClient</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Deny request in OAuth 2.0. It is used so that only the resource owner can access the resources.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">isOAuth</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Allow request in OAuth 2.0. It is used so that the client can access the resources.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>SpEL expression can be used with SpEL provided by Spring Security.</p>
<p class="last">Refer to <a class="reference internal" href="Authorization.html#built-incommon-expressions"><span class="std std-ref">Built-In Web Expressions</span></a> for SpEL provided by Spring Security.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="how-to-link-access-token-with-authorization-server">
<h5><a class="toc-backref" href="#id105">9.9.2.3.2.3. How to link access token with authorization server</a><a class="headerlink" href="#how-to-link-access-token-with-authorization-server" title="Permalink to this headline">¶</a></h5>
<p>Authorization Server is linked with Resource Server via access token <code class="docutils literal"><span class="pre">TokenServices</span></code>.</p>
<p>Refer to <a class="reference internal" href="#oauthauthorizationserverhowtoconfigureaccesstoken"><span class="std std-ref">How to share access token with resource server</span></a> for the methods of linking.</p>
<p>Apply settings by the method of sharing DB.</p>
<p>Refer to <a class="reference internal" href="#oauthauthorizationserverhowtoconfigureaccesstoken"><span class="std std-ref">How to share access token with resource server</span></a> for the description of settings as the settings are same as <code class="docutils literal"><span class="pre">TokenServices</span></code> settings in authorization server.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;tokenServices&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.DefaultTokenServices&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;tokenStore&quot;</span> <span class="na">ref=</span><span class="s">&quot;tokenStore&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;tokenStore&quot;</span>
  <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.store.JdbcTokenStore&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A method which use <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.RemoteTokenServices</span></code> provided by Spring Security OAuth and a method which use
JSON Web Token are offered as the methods for linking the authorization server and resource server.
Refer to <a class="reference internal" href="#oauthauthorizationserverhowtocooperatewithhttp"><span class="std std-ref">Linking Authorization Server and Resource Server through HTTP access</span></a> for how to use <code class="docutils literal"><span class="pre">RemoteTokenServices</span></code> provided by Spring Security OAuth.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="fetching-user-information">
<span id="oauthresourceservergetprincipal"></span><h5><a class="toc-backref" href="#id106">9.9.2.3.2.4. Fetching user information</a><a class="headerlink" href="#fetching-user-information" title="Permalink to this headline">¶</a></h5>
<p>In the Resource Server, the authenticated resource owner information can be received by specifying <code class="docutils literal"><span class="pre">UserDetails</span></code> in method argument of Controller class and assigning <code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code> annotation similar to fetching method of the authentication information explained in <a class="reference internal" href="Authentication.html#springsecurityauthenticationintegrationwithspringmvc"><span class="std std-ref">Coordination between authentication process and Spring MVC</span></a>.
The implementation example is shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;api&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="o">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;todos&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">list</span><span class="o">(</span><span class="nd">@AuthenticationPrincipal</span> <span class="n">UserDetails</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (1)</span>

        <span class="c1">// omitted</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authentication information of resource owner is stored in the argument ``user``</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>When authentication information of the client is to be fetched, specify <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.OAuth2Authentication</span></code> in method argument of Controller class.
An example wherein <code class="docutils literal"><span class="pre">OAuth2Authentication</span></code> is specified in the method argument of Controller class and authentication information of the client and the resource owner is fetched, is given below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;api&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="o">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;todos&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">list</span><span class="o">(</span><span class="n">OAuth2Authentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (1)</span>

        <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getUserAuthentication</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span> <span class="c1">// (2)</span>
        <span class="n">String</span> <span class="n">clientId</span> <span class="o">=</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getOAuth2Request</span><span class="o">().</span><span class="na">getClientId</span><span class="o">();</span>  <span class="c1">// (3)</span>

        <span class="c1">// omitted</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authentication information of the resource owner and the client is stored in the argument <code class="docutils literal"><span class="pre">authentication</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch resource owner name from <code class="docutils literal"><span class="pre">authentication</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch client ID from  <code class="docutils literal"><span class="pre">authentication</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The implementation example is given above wherein <code class="docutils literal"><span class="pre">OAuth2Authentication</span></code> is used in the application layer.
When the implementation is to be done without depending on <code class="docutils literal"><span class="pre">OAuth2Authentication</span></code>, the same function is feasible by implementing <code class="docutils literal"><span class="pre">HandlerMethodArgumentResolver</span></code>.
Refer to <a class="reference internal" href="../ImplementationAtEachLayer/ApplicationLayer.html#methodargumentresolver"><span class="std std-ref">Implementing HandlerMethodArgumentResolver</span></a> for specific implementation method.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="implementation-of-client">
<span id="implementationoauthclientserverofautorizationcode"></span><h4><a class="toc-backref" href="#id107">9.9.2.3.3. Implementation of client</a><a class="headerlink" href="#implementation-of-client" title="Permalink to this headline">¶</a></h4>
<p>How to implement a client is explained.</p>
<p>How to implement by using <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> is explained here.</p>
<p>In <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>, the functions for fetching access token, sharing access token between multiple requests by <code class="docutils literal"><span class="pre">OAuth2ClientContext</span></code> and error handling when accessing the Resource Server
are implemented as per the grant type by <code class="docutils literal"><span class="pre">AccessTokenProvider</span></code> as independent functions of OAuth 2.0.</p>
<p>In client, <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> is used and resource can be accessed by using OAuth 2.0 function, by defining parameters according to application requirements such as grant type and scope.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When you want to access a resource server which is implemented by architecture other than Spring Security OAuth, it must be checked whether access from REST API is accepted. If API of resource server varies, access must be achieved by means other than <cite>OAuth2RestTemplate</cite>.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="creation-of-configuration-file-client">
<h5><a class="toc-backref" href="#id108">9.9.2.3.3.1. Creation of configuration file (Client)</a><a class="headerlink" href="#creation-of-configuration-file-client" title="Permalink to this headline">¶</a></h5>
<p>First create <code class="docutils literal"><span class="pre">oauth2-client.xml</span></code> as the configuration file for defining OAuth 2.0.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
    <span class="na">xmlns:oauth2=</span><span class="s">&quot;http://www.springframework.org/schema/security/oauth2&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;</span>
<span class="s">        http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">        http://www.springframework.org/schema/security/oauth2 http://www.springframework.org/schema/security/spring-security-oauth2.xsd</span>
<span class="s">    &quot;</span><span class="nt">&gt;</span>


<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Add the settings to <code class="docutils literal"><span class="pre">web.xml</span></code>so as to read the created <code class="docutils literal"><span class="pre">oauth2-client.xml</span></code>.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">web.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;context-param&gt;</span>
    <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
    <span class="nt">&lt;param-value&gt;</span>
        classpath*:META-INF/spring/applicationContext.xml
        classpath*:META-INF/spring/oauth2-client.xml  <span class="c">&lt;!-- (1) --&gt;</span>
        classpath*:META-INF/spring/spring-security.xml
    <span class="nt">&lt;/param-value&gt;</span>
<span class="nt">&lt;/context-param&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set so as to read <code class="docutils literal"><span class="pre">oauth2-client.xml</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="applying-oauth2clientcontextfilter">
<h5><a class="toc-backref" href="#id109">9.9.2.3.3.2. Applying OAuth2ClientContextFilter</a><a class="headerlink" href="#applying-oauth2clientcontextfilter" title="Permalink to this headline">¶</a></h5>
<p>Register <code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code> as a servlet filter.</p>
<p>By registering <code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>, when an attempt is made to access the Resource Server when authorization cannot be fetched by the resource owner,
a function to capture <code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code> and redirect to the page for fetching authorization of the resource owner provided by the Authorization Server
can be incorporated.</p>
<p>Add the following settings to <code class="docutils literal"><span class="pre">oauth2-client.xml</span></code>.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:client</span> <span class="na">id=</span><span class="s">&quot;oauth2ClientContextFilter&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Explanation</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Bean is defined for <code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>by using <code class="docutils literal"><span class="pre">&lt;oauth2:client&gt;</span></code>tag. The string specified in <code class="docutils literal"><span class="pre">id</span></code>attribute is used as Bean ID.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Add the settings of <code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>to <code class="docutils literal"><span class="pre">web.xml</span></code>.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">web.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;filter&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>oauth2ClientContextFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;filter-class&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="nt">&lt;/filter-class&gt;</span>
<span class="nt">&lt;/filter&gt;</span>
<span class="nt">&lt;filter-mapping&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>oauth2ClientContextFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>/oauth/*<span class="nt">&lt;/url-pattern&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/filter-mapping&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Register the Bean wherein BeanID matches with the filter name (value specified in the <code class="docutils literal"><span class="pre">&lt;filter-name&gt;</span></code> attribute) as a servlet filter by using  <code class="docutils literal"><span class="pre">DelegatingFilterProxy</span></code>.</div>
<div class="line">Set the value same as the BeanID specified in <code class="docutils literal"><span class="pre">id</span></code>attribute of <code class="docutils literal"><span class="pre">&lt;oauth2:client&gt;</span></code> in the filter name.</div>
<div class="line">It is recommended to mention <code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code> at the end of servlet filter definition so as not to perform  unintended exception handling of the exception generated in Spring Security OAuth.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code> is applied to the path wherein <code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code> may occur.</div>
<div class="line">In the above example, <code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code> is applied to all the requests.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since <code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code> generates redirect URI for returning the user agent after the authorization process by the Authorization Server in the pre-process of the filter,
a wide definition such as <code class="docutils literal"><span class="pre">/*</span></code> will result in futile processing in the path where <code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code> does not occur.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code> stores the URL to be redirected after the Authorization Server gets the authorization
from the resource owner with the attribute name <code class="docutils literal"><span class="pre">currentUri</span></code> in the request scope. Therefore, the attribute name <code class="docutils literal"><span class="pre">currentUri</span></code> cannot be used in the client.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>As mentioned above, <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.client.filter.OAuth2ClientContextFilter</span></code> is a servlet filter that captures ``UserRedirectRequiredException`` and redirects it to the Authorization Server.</p>
<p>However, if the <code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code> set in the blank project in advance, handles <code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code> first,
<code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code> will not work as intended.</p>
<p>Therefore, it is necessary to change the setting of <cite>spring-mvc.xml`</cite>  so that the <code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code> does not handle <code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code>.
Refer to <a class="reference internal" href="../ArchitectureInDetail/WebApplicationDetail/ExceptionHandling.html"><span class="doc">Exception Handling</span></a> for the description of <code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code> in detail.</p>
<p>Add <code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code> to <code class="docutils literal"><span class="pre">spring-mvc.xml</span></code> as the exclusion target of <code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">spring-mvc.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;systemExceptionResolver&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.SystemExceptionResolver&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;excludedExceptions&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;array&gt;</span>
            <span class="c">&lt;!-- (1) --&gt;</span>
            <span class="nt">&lt;value&gt;</span>org.springframework.security.oauth2.client.resource.UserRedirectRequiredException
            <span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/array&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Exclude <code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code> from handling target of <code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="settings-of-oauth2resttemplate">
<span id="oauth2resttemplatesettings"></span><h5><a class="toc-backref" href="#id110">9.9.2.3.3.3. Settings of OAuth2RestTemplate</a><a class="headerlink" href="#settings-of-oauth2resttemplate" title="Permalink to this headline">¶</a></h5>
<p>How to set <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>is explained.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:resource</span> <span class="na">id=</span><span class="s">&quot;todoAuthCodeGrantResource&quot;</span> <span class="na">client-id=</span><span class="s">&quot;firstSec&quot;</span>
                 <span class="na">client-secret=</span><span class="s">&quot;firstSecSecret&quot;</span>
                 <span class="na">type=</span><span class="s">&quot;authorization_code&quot;</span>
                 <span class="na">scope=</span><span class="s">&quot;READ,WRITE&quot;</span>
                 <span class="na">access-token-uri=</span><span class="s">&quot;${auth.serverUrl}/oauth/token&quot;</span>
                 <span class="na">user-authorization-uri=</span><span class="s">&quot;${auth.serverUrl}/oauth/authorize&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

<span class="nt">&lt;oauth2:rest-template</span> <span class="na">id=</span><span class="s">&quot;todoAuthCodeGrantResourceRestTemplate&quot;</span> <span class="na">resource=</span><span class="s">&quot;todoAuthCodeGrantResource&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define detailed information of the resource to be accessed , to be referred by <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>.</div>
<div class="line">Refer to the following table for the setting value of each item.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>.</div>
<div class="line">Specify BeanID of <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> in <code class="docutils literal"><span class="pre">id</span></code>.</div>
<div class="line">Specify <code class="docutils literal"><span class="pre">id</span></code> of Bean defined in (1) for <code class="docutils literal"><span class="pre">resource</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given longtable docutils" id="id51">
<caption><span class="caption-text"><strong>Resource detailed information</strong></span><a class="headerlink" href="#id51" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Items</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">id</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Bean ID of resource.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">client-id</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ID for identifying the client in the Authorization Server.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">client-secret</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Password used for authentication of client in the Authorization Server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">type</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Grant type. Specify <code class="docutils literal"><span class="pre">authorization_code</span></code> in case of authorization code grant.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">scope</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Enumerate the scope that requires authorization by separating with commas. Setting value is case-sensitive.</div>
<div class="line">Request all scopes set for the client in Authorization Server at the time of omitting.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">access-token-uri</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Endpoint URL of the Authorization Server for requesting the issue of access token.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">user-authorization-uri</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Endpoint URL of the Authorization Server for getting the authorization of resource owner.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>In this implementation example, context root of each server set during implementation is represented by following placeholders.</p>
<blockquote>
<div><table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">Placeholder key</th>
<th class="head">Setting value</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub"><code class="docutils literal"><span class="pre">auth.serverUrl</span></code></th>
<td>Context root of authorization server</td>
</tr>
<tr class="row-odd"><th class="stub"><code class="docutils literal"><span class="pre">resource.serverUrl</span></code></th>
<td>Context root of resource server</td>
</tr>
<tr class="row-even"><th class="stub"><code class="docutils literal"><span class="pre">client.serverUrl</span></code></th>
<td>Context root of client</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p class="last">Also, when absolute path of endpoint for each server is to be represented, path is specified below the placeholder to explicitly understand the path such as <code class="docutils literal"><span class="pre">${auth.serverUrl}/oauth/token</span></code>.
While developing a real application, for example, when the endpoint is in the external system, it is recommended to look at the method to specify the path according to the requirement
such as indicating the whole path by placeholder to deal with changes in endpoint path at the time of changing external system specifications.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>In  <code class="docutils literal"><span class="pre">&lt;oauth2:resource&gt;</span></code>tag,  <code class="docutils literal"><span class="pre">client-authentication-scheme</span></code> attribute is provided as the method to specify
client authentication method at the time of getting access token.
The values that can be specified in <code class="docutils literal"><span class="pre">client-authentication-scheme</span></code> parameter are as follows.</p>
<blockquote class="last">
<div><blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">header</span></code>: Basic authentication using Authorization header (Default value)</li>
<li><code class="docutils literal"><span class="pre">query</span></code> : Authentication using URL query parameter at the time of requesting</li>
<li><code class="docutils literal"><span class="pre">form</span></code>  : Authentication using body parameter at the time of requesting</li>
</ul>
</div></blockquote>
<p>In this guideline, since Basic authentication is used for authenticating the client, parameters are not specified in the above-mentioned setting example,
however, parameters should be specified as per the application requirements.</p>
</div></blockquote>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When issue of access token is requested for authorization server implemented by architecture other than Spring Security OAuth,
it must be noted that the request parameter is likely to be different from that given above.
In such a case, check architecture specification and set the required request parameters.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="accessing-a-resource-server">
<span id="oauthaccessofresourceserver"></span><h5><a class="toc-backref" href="#id111">9.9.2.3.3.4. Accessing a resource Server</a><a class="headerlink" href="#accessing-a-resource-server" title="Permalink to this headline">¶</a></h5>
<p>How to access the Resource Server using <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> is explained.</p>
<p>Since access to Authorization Server is hidden by <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> and <code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>,
the process to be performed for REST API provided by the Resource Server is described similar to normal access to REST API without being aware of the Authorization Server at the time of development.</p>
<p>The implementation example of Service class is shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">org.springframework.web.client.RestOperations</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">RestOperations</span> <span class="n">restOperations</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${resource.serverUrl}/api/v1/todos&quot;</span><span class="o">)</span>
    <span class="n">String</span> <span class="n">url</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">getTodoList</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Todo</span><span class="o">[]</span> <span class="n">todoArray</span> <span class="o">=</span> <span class="n">restOperations</span><span class="o">.</span>
            <span class="nf">getForObject</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">Todo</span><span class="o">[].</span><span class="na">class</span><span class="o">);</span> <span class="c1">// (2)</span>
        <span class="k">return</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">todoArray</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inject <code class="docutils literal"><span class="pre">RestOperations</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Access the specified URL with GET method in REST and receive the result in a list.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>When access token is not issued if <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> is used to access the Resource Server,
it is redirected to the Authorization Server at once.
Thereafter, when the issue of access token is complete, it is redirected to the client and access process to the resource server is called again.
At this time, since redirect to client is performed by GET, the Controller that may be redirected from Authorization Server, must allow GET.</p>
<p class="last">If access to the Resource Server before the redirect is POST, the parameter will be lost in GET after redirect.
In that case, a measure like retaining POST parameter in session, should be taken.
In this guideline, the explanation of specific handling method is omitted.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>When Spring Security is used, and when you try to fetch an access token by using <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> when user is not authenticated,
<code class="docutils literal"><span class="pre">org.springframework.security.authentication.InsufficientAuthenticationException</span></code> occurs, hence, it must be ensured that the user is
already authenticated on the path by using <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>.</p>
<p>Specifically, it should be confirmed that one of the following is being implemented.</p>
<ul class="simple">
<li>Ensure that Service method which use <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> is authenticated by <code class="docutils literal"><span class="pre">&#64;PreAuthorize</span></code></li>
<li>Ensure that path which use <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> is authenticated by <code class="docutils literal"><span class="pre">&lt;sec:intercept-url&gt;</span></code></li>
</ul>
<p>For details, refer <a class="reference internal" href="Authorization.html#authorizationtowebresources"><span class="std std-ref">Authorization of Web resource</span></a> and <a class="reference internal" href="Authorization.html#authorizationtomethod"><span class="std std-ref">Authorization for the method</span></a>.</p>
<p class="last">Note that, error does not occur in case of a client credential grant which does not require resource owner authentication since the client becomes a resource owner,
and in case of an implicit grant which does not use <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="cancelling-a-token-client-server">
<span id="oauthclientserverhowtocanceltoken"></span><h5><a class="toc-backref" href="#id112">9.9.2.3.3.5. Cancelling a token (Client server)</a><a class="headerlink" href="#cancelling-a-token-client-server" title="Permalink to this headline">¶</a></h5>
<p>How to cancel an issued access token is explained.</p>
<div class="line-block">
<div class="line">For cancellation of access token, a request is sent to authorization server and access token is deleted from <code class="docutils literal"><span class="pre">TokenStore</span></code>. a request header is set for Basic authentication, to carry out Basic authentication of client while sending a request to authorization server.</div>
<div class="line">For cancellation of token of authorization server, refer <a class="reference internal" href="#oauthauthorizationserverhowtocanceltoken"><span class="std std-ref">Canceling a token (authorization server)</span></a>.</div>
<div class="line">After requesting cancellation of access token to authorization server, client server must delete access token retained by <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>.</div>
</div>
<p>Implementation example is as shown below.</p>
<p>First, a <code class="docutils literal"><span class="pre">RestTemplate</span></code>setting is added to settings file to make a token cancellation request to authorization server.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;revokeRestTemplate&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.web.client.RestTemplate&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;interceptors&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;list&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;basicAuthInterceptor&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;basicAuthInterceptor&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.http.client.support.BasicAuthorizationInterceptor&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">value=</span><span class="s">&quot;${api.auth.username}&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span> <span class="na">value=</span><span class="s">&quot;${api.auth.password}&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for <code class="docutils literal"><span class="pre">RestTemplate</span></code> to make a token cancellation request to authorization server.</div>
<div class="line">Specify implementation class of <code class="docutils literal"><span class="pre">ClientHttpRequestInterceptor</span></code> in <code class="docutils literal"><span class="pre">interceptors</span></code> property to set request header for Basic authentication.</div>
<div class="line">For implementation method of implementation class of <code class="docutils literal"><span class="pre">ClientHttpRequestInterceptor</span></code> which sets a request header for Basic authentication, refer <a class="reference internal" href="../ArchitectureInDetail/WebServiceDetail/RestClient.html#restclientbasicauthorizationinterceptorbeandefinition"><span class="std std-ref">Request header setup process for Basic authentication</span></a>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>An interface of service class and the implementation class which cancel the token are created.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">RevokeTokenClientService.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RevokeTokenClientService</span> <span class="o">{</span>

    <span class="n">String</span> <span class="nf">revokeToken</span><span class="o">();</span>

<span class="o">}</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">RevokeTokenClientServiceImpl.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RevokeTokenClientServiceImpl</span> <span class="kd">implements</span> <span class="n">RevokeTokenClientService</span> <span class="o">{</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${auth.serverUrl}/api/v1/oth2/tokens/revoke&quot;</span><span class="o">)</span>
    <span class="n">String</span> <span class="n">revokeTokenUrl</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="o">(</span><span class="s">&quot;todoAuthCodeGrantResourceRestTemplate&quot;</span><span class="o">)</span>
    <span class="n">OAuth2RestOperations</span> <span class="n">oauth2RestOperations</span><span class="o">;</span> <span class="c1">// (2)</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="o">(</span><span class="s">&quot;revokeRestTemplate&quot;</span><span class="o">)</span>
    <span class="n">RestOperations</span> <span class="n">revokeRestOperations</span><span class="o">;</span> <span class="c1">// (3)</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">revokeToken</span><span class="o">()</span> <span class="o">{</span>

        <span class="n">String</span> <span class="n">tokenValue</span> <span class="o">=</span> <span class="n">getTokenValue</span><span class="o">(</span><span class="n">oauth2RestOperations</span><span class="o">);</span>

        <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">;</span>

        <span class="k">if</span><span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">hasLength</span><span class="o">(</span><span class="n">tokenValue</span><span class="o">)){</span>
            <span class="n">HttpHeaders</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="o">();</span>
            <span class="n">headers</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_FORM_URLENCODED</span><span class="o">);</span>
            <span class="n">MultiValueMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">variables</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedMultiValueMap</span><span class="o">&lt;&gt;();</span>
            <span class="n">variables</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;token&quot;</span><span class="o">,</span> <span class="n">tokenValue</span><span class="o">);</span>

            <span class="k">try</span> <span class="o">{</span>
                <span class="n">revokeRestOperations</span><span class="o">.</span><span class="na">postForObject</span><span class="o">(</span><span class="n">url</span><span class="o">,</span>
                        <span class="k">new</span> <span class="n">HttpEntity</span><span class="o">&lt;</span><span class="n">MultiValueMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;(</span><span class="n">variables</span><span class="o">,</span> <span class="n">headers</span><span class="o">),</span>
                        <span class="n">Void</span><span class="o">.</span><span class="na">class</span><span class="o">);</span> <span class="c1">// (4)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="s">&quot;success&quot;</span><span class="o">;</span>
                <span class="n">initContextToken</span><span class="o">(</span><span class="n">oauth2RestOperations</span><span class="o">);</span> <span class="c1">// (5)</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">HttpClientErrorException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">result</span> <span class="o">=</span> <span class="s">&quot;invalid request&quot;</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
            <span class="n">result</span> <span class="o">=</span><span class="s">&quot;token not exist&quot;</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// (6)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="nf">getTokenValue</span><span class="o">(</span><span class="n">OAuth2RestOperations</span> <span class="n">oauth2RestOperations</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">OAuth2AccessToken</span> <span class="n">token</span> <span class="o">=</span> <span class="n">restOperations</span><span class="o">.</span><span class="na">getOAuth2ClientContext</span><span class="o">()</span>
                <span class="o">.</span><span class="na">getAccessToken</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">token</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">token</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// (7)</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">initContextToken</span><span class="o">(</span><span class="n">OAuth2RestOperations</span> <span class="n">oauth2RestOperations</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">oauth2RestOperations</span><span class="o">.</span><span class="na">getOAuth2ClientContext</span><span class="o">().</span><span class="na">setAccessToken</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">URL to be used while requesting the cancellation of access token to the authorization server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inject <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> which retains the access token to be cancelled.</div>
<div class="line">Since there are multiple implementations of <code class="docutils literal"><span class="pre">RestOperations</span></code>, inject it by specifying Bean name with <code class="docutils literal"><span class="pre">&#64;Named</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inject <code class="docutils literal"><span class="pre">RestTemplate</span></code> for cancelling the access token.</div>
<div class="line">Since there are multiple implementations of <code class="docutils literal"><span class="pre">RestOperations</span></code>, inject it by specifying Bean name with <code class="docutils literal"><span class="pre">&#64;Named</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In order to cancel the access token in authorization server, it is accessed with method POST in REST.</div>
<div class="line">Set value of access token to be cancelled in the request parameter for passing it to the authorization server.</div>
<div class="line">Access token is fetched by passing <code class="docutils literal"><span class="pre">OAuth2RestOperations</span></code> to <code class="docutils literal"><span class="pre">getTokenValue</span></code> method defined in (6).</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Delete access token retained by <code class="docutils literal"><span class="pre">OAuth2RestOperations</span></code>.</div>
<div class="line">Access token is deleted by passing <code class="docutils literal"><span class="pre">OAuth2RestOperations</span></code> retaining the access token in <code class="docutils literal"><span class="pre">initContextToken</span></code> method defined in (7).</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Method of getting the access token retained by <code class="docutils literal"><span class="pre">OAuth2RestOperations</span></code> .</div>
<div class="line">Access token is fetched and returned by calling the <code class="docutils literal"><span class="pre">getAccessToken</span></code> method of <code class="docutils literal"><span class="pre">OAuth2RestOperations</span></code> passed as a parameter.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Method of deleting the access token retained by <code class="docutils literal"><span class="pre">OAuth2RestOperations</span></code> .</div>
<div class="line">Delete the access token by passing the null in <code class="docutils literal"><span class="pre">setAccessToken</span></code> method of <code class="docutils literal"><span class="pre">OAuth2RestOperations</span></code> passed as a parameter.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">Client cancels the token by calling the service created above within the timing when the access token becomes invalid.</div>
<div class="line">Since access token is retained in session scope in default implementation of Spring Security OAuth, token cancellation can be done when the client user logs out or the session is discarded due to session timeout.</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Authorization servers which are implemented with architecture other than Spring Security OAuth may not accept deletion of access tokens by REST API.</p>
<p class="last">In that case, architecture specification of authorization server must be checked and implement appropriately.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="error-handling">
<span id="oauthclienterrorhandlingwithcode"></span><h5><a class="toc-backref" href="#id113">9.9.2.3.3.6. Error handling</a><a class="headerlink" href="#error-handling" title="Permalink to this headline">¶</a></h5>
<p>Methods to handle errors which occur while accessing authorization server and resource server using <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>are explained.</p>
<div class="section" id="error-handling-while-accessing-authorization-end-point">
<span id="oauthclienthandleerrorwhenaccessingauthorizationendpointwithcode"></span><h6><a class="toc-backref" href="#id114">9.9.2.3.3.6.1. Error handling while accessing authorization end point</a><a class="headerlink" href="#error-handling-while-accessing-authorization-end-point" title="Permalink to this headline">¶</a></h6>
<p>Errors which occur at authorization end point are classified as exceptions other than invalid access error and bad client error.
For details of bad client error, refer <a class="reference internal" href="#definitionofbadclienterror"><span class="std std-ref">Unauthorized client error</span></a>.
For error handling when an unauthorized client error occurs, refer <a class="reference internal" href="#oauthauthorizationserverhowtohandleerror"><span class="std std-ref">Error handling at the time of authorization request</span></a>.
This section explains about error handling when errors other than unauthorized client error occur.</p>
<p>Errors notified to the client should be handled as below.</p>
<table border="1" class="colwidths-given longtable docutils" id="id52">
<caption><span class="caption-text"><strong>Errors which occur at authorization end point</strong></span><a class="headerlink" href="#id52" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Errors occurred</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authorization for resource owner denied</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.common.exceptions.UserDeniedAuthorizationException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It occurs when the resource owner rejects all the scope specified by the client, on scope authorization screen.</div>
<div class="line"><code class="docutils literal"><span class="pre">error=access_denied</span></code> and <code class="docutils literal"><span class="pre">error_description=User</span> <span class="pre">denied</span> <span class="pre">access</span></code> are set in request parameters of redirect URI.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>Regarding request parameters handled by response at the time of error</strong></p>
<p class="last">As specified in <a class="reference external" href="https://tools.ietf.org/html/rfc6749#section-4.1.2.1">4.1.2.1. Error Response</a> of RFC 6749,
request parameters <code class="docutils literal"><span class="pre">error</span></code> and <code class="docutils literal"><span class="pre">error_description</span></code> are included in response at the time of error, in OAuth 2.0.
Therefore, when parameters of these names are used at the time of business implementation, it must be noted that parameter names may show conflict in some cases.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>A process for handling exceptions thrown by <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> above should be implemented.
In this guideline, error handling is implemented in accordance with the following requirements.</p>
<ul>
<li><dl class="first docutils">
<dt>Determine whether the exception has occurred due to resource owner operations and change error screen</dt>
<dd><p class="first">Exceptions occurring in authorization server can be classified into exceptions which are caused by resource owner operations like “authorization denied”, and
the exceptions which are caused by application failures like “scope specified by the client does not exist in the client information of authorization server”.
Exceptions must be handled appropriately based on their classification.</p>
<ul class="last simple">
<li>For exceptions caused by resource owner operations, transition occurs to “Access denied screen” and reimplementation of operation is suggested</li>
<li>For exceptions which are not caused by application failures, transition occurs to “system error screen” and review of application settings is suggested</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Redirect to error screen for preventing unnecessary exposure of parameters to URL</dt>
<dd><p class="first">Following parameters are assigned to URL parameters in the flow of authorization code grant or implicit grant, however when an error occurs during flow,
and forwarding is done for error screen as it is, parameters are exposed in the address bar of the browser.
in order to prevent this, it is necessary to redirect to error screen.</p>
<ul class="simple">
<li><dl class="first docutils">
<dt>Authorization code (authorization code grant only)</dt>
<dd>When an error occurs from issue of authorization code to issue of access token</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">state</span></code> parameter</dt>
<dd>When an error occurs from authorization request to completed authorization of resource owner</dd>
</dl>
</li>
</ul>
<p class="last">For grant types other than authorization code grant and implicit grant, forwarding is used instead of redirect since the above parameters are not used.</p>
</dd>
</dl>
</li>
</ul>
<p>An example is given below wherein <code class="docutils literal"><span class="pre">UserDeniedAuthorizationException</span></code> for authorization denial of resource owner is handled and transition is done to access denied screen.</p>
<p>Note that, handling for transiting to system error screen must also be implemented in the same manner.
For handling of exceptions, refer <a class="reference internal" href="#oauthappendixoccuringerrors"><span class="std std-ref">Errors which occur while accessing authorization server and resource server from the client</span></a>.
Further, it is assumed in the example that <code class="docutils literal"><span class="pre">UserDeniedAuthorizationException</span></code> is handled commonly throughout the application and
<code class="docutils literal"><span class="pre">&#64;ControllerAdvice</span></code> annotation is used. For details, refer <a class="reference internal" href="../ImplementationAtEachLayer/ApplicationLayer.html#application-layer-controller-advice"><span class="std std-ref">Implementing “&#64;ControllerAdvice”</span></a>.</p>
<p>Implementation example is shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2ExceptionHandler</span> <span class="o">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="n">UserDeniedAuthorizationException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">handleUserDeniedAuthorizationException</span><span class="o">(</span>
            <span class="n">UserDeniedAuthorizationException</span> <span class="n">e</span><span class="o">,</span> <span class="n">RedirectAttributes</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// omitted</span>
        <span class="n">attributes</span><span class="o">.</span><span class="na">addFlashAttribute</span><span class="o">(</span><span class="s">&quot;exception&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">&quot;redirect:/oauthAccessDeniedError&quot;</span><span class="o">;</span> <span class="c1">// (2)</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Handle errors which occur in the controller.</div>
<div class="line">It is executed when <code class="docutils literal"><span class="pre">UserDeniedAuthorizationException</span></code> specified in <code class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></code> parameter occur.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Redirect to hide authorization code and <code class="docutils literal"><span class="pre">state</span></code> parameter.</div>
<div class="line">When exception is passed to redirect destination, exception to be passed is set by using <code class="docutils literal"><span class="pre">addFlashAttribute</span></code> method of <code class="docutils literal"><span class="pre">RedirectAttributes</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Also, a controller corresponding to path for redirecting <code class="docutils literal"><span class="pre">/oauthAccessDeniedError</span></code>must be defined to
redirect to <code class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></code>of <code class="docutils literal"><span class="pre">OAuth2ExceptionHandler</span></code>.</p>
<p>Definition example of controller is shown below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">OAuth2ErrorController.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2ErrorController</span> <span class="o">{</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/oauthAccessDeniedError&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">handleAccessDeniedError</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;common/error/accessDeniedError&quot;</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use <code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code> annotation and map as a method for accessing <code class="docutils literal"><span class="pre">/oauthAccessDeniedError</span></code>.</div>
<div class="line">When <code class="docutils literal"><span class="pre">/oauthAccessDeniedError</span></code> is called, access denied screen is displayed.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="token-end-point-and-error-handling-while-accessing-resource-server">
<span id="oauthclienthandleerrorwhenaccessingtokenendpointwithcode"></span><h6><a class="toc-backref" href="#id115">9.9.2.3.3.6.2. Token end point and error handling while accessing resource server</a><a class="headerlink" href="#token-end-point-and-error-handling-while-accessing-resource-server" title="Permalink to this headline">¶</a></h6>
<p>In the authorization code grant, all the errors that occur in token end point and resource server must be handled as system errors.
For errors occurred, refer <a class="reference internal" href="#oauthappendixoccuringerrors"><span class="std std-ref">Errors which occur while accessing authorization server and resource server from the client</span></a>.
Further, for error handling, refer <a class="reference internal" href="#oauthclienthandleerrorwhenaccessingauthorizationendpointwithcode"><span class="std std-ref">Error handling while accessing authorization end point</span></a>.</p>
</div>
</div>
</div>
</div>
<div class="section" id="implementation-of-implicit-grant">
<span id="implementationimplicitgrant"></span><h3><a class="toc-backref" href="#id116">9.9.2.4. Implementation of implicit grant</a><a class="headerlink" href="#implementation-of-implicit-grant" title="Permalink to this headline">¶</a></h3>
<p>Implementation methods for authorization server, resource server and client which use implicit grant are explained.</p>
<p>Explanation is given only for the changes from that of authorization code grant. For implementation and explanation other than changes, refer <a class="reference internal" href="#implementationautorizationcodegrant"><span class="std std-ref">Implementation of authorization code grant</span></a>.</p>
<p>Changes from that of authorization code grant while implementing each server are shown below.</p>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="30%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">Server</th>
<th class="head">Changes from that of authorization code grant</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">Authorization server</th>
<td><a class="reference internal" href="#oauthauthorizationserverdefinition"><span class="std std-ref">Defining authorization server</span></a></td>
</tr>
<tr class="row-odd"><th class="stub">Resource server</th>
<td>NIL</td>
</tr>
<tr class="row-even"><th class="stub">Client</th>
<td>All of <a class="reference internal" href="#implementationoauthclientserverofautorizationcode"><span class="std std-ref">Implementation of client</span></a></td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="implementationoauthauthorizationserverofimplicit">
<span id="id4"></span><h4><a class="toc-backref" href="#id117">9.9.2.4.1. Implementation of authorization server</a><a class="headerlink" href="#implementationoauthauthorizationserverofimplicit" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>must be changed from the implementation of authorization code grant.</p>
<p>For implementation other than <code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>, refer <a class="reference internal" href="#implementationoauthauthorizationserverofautorizationcode"><span class="std std-ref">Implementation of authorization server</span></a>.</p>
<div class="section" id="id5">
<h5><a class="toc-backref" href="#id118">9.9.2.4.1.1. Defining authorization server</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h5>
<p>Changes of <code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>from that of authorization code grant are shown below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
    <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span>
    <span class="na">user-approval-handler-ref=</span><span class="s">&quot;userApprovalHandler&quot;</span>
    <span class="na">token-services-ref=</span><span class="s">&quot;tokenServices&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;oauth2:implicit</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use <code class="docutils literal"><span class="pre">&lt;oauth2:implicit</span> <span class="pre">/&gt;</span></code>tag and support implicit grant.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><code class="docutils literal"><span class="pre">&lt;oauth2:implicit</span> <span class="pre">/&gt;</span></code>tag and <code class="docutils literal"><span class="pre">&lt;oauth2:refresh-token</span> <span class="pre">/&gt;</span></code>tag must be set in the above sequence.</p>
<p class="last">For details ,refer <a class="reference internal" href="#orderofauthoraizationserversupportsetting"><span class="std std-ref">When the multiple grant types are supported in authorization server</span></a>.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="implementationoauthresourceserverofimplicit">
<span id="id6"></span><h4><a class="toc-backref" href="#id119">9.9.2.4.2. Implementation of resource server</a><a class="headerlink" href="#implementationoauthresourceserverofimplicit" title="Permalink to this headline">¶</a></h4>
<p>Changes are not required from the implementation of authorization code grant.</p>
<p>Implementation should be created by referring <a class="reference internal" href="#implementationoauthresourceserverofautorizationcode"><span class="std std-ref">Implementation of resource server</span></a>.</p>
</div>
<div class="section" id="implementationoauthclientserverofimplicit">
<span id="id7"></span><h4><a class="toc-backref" href="#id120">9.9.2.4.3. Implementation of client</a><a class="headerlink" href="#implementationoauthclientserverofimplicit" title="Permalink to this headline">¶</a></h4>
<p>Generally, clients implemented by JavaScrtipt etc. are adopted in implicit grant.</p>
<p>As libraries other than Java are not provided in Spring Security OAuth, this guideline explains how to implement clients independently using JavaScript.</p>
<div class="section" id="accessing-a-resource-server-which-uses-javascript">
<span id="oauthclientusingjavascript"></span><h5><a class="toc-backref" href="#id121">9.9.2.4.3.1. Accessing a resource server which uses JavaScript</a><a class="headerlink" href="#accessing-a-resource-server-which-uses-javascript" title="Permalink to this headline">¶</a></h5>
<p>In this guideline, a method is explained wherein JSON format data is fetched from resource server by using JavaScript and displayed on the screen
as an implementation of client for implicit grant.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">jQuery (version 3.1.1) is used as a javaScript library in the implementation example explained below.
JQuery is stored under <code class="docutils literal"><span class="pre">src/main/webapp/resources/vendor</span></code>and created JavaScript file is stored under <code class="docutils literal"><span class="pre">src/main/webapp/resources/app/js</span></code>.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Access token storage destination</strong></p>
<p>When HTML5 compliant browser is used, local storage and session storage can be given as typical examples of storage destinations of access tokens.</p>
<p>Retention period and use for local and session storage are shown below.</p>
<blockquote>
<div><table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="15%" />
<col width="20%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">Storage destination</th>
<th class="head">Retention period</th>
<th class="head">Use</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">Local storage</th>
<td>Until it is explicitly cleared</td>
<td>When only one user is using the terminal browser, and when it is desired to reduce number of access token issues and improve convenience of service</td>
</tr>
<tr class="row-odd"><th class="stub">Session storage</th>
<td>Until tab and browser are closed</td>
<td>When multiple users are using terminal browser, when it is desired to prevent unauthorized use of access tokens and strengthen security</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p class="last">An implementation example wherein local storage is adopted is explained.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>A JavaScript wherein OAuth 2.0 function is independently implemented by client is created. Implementation example is shown below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2.js</span></code></li>
</ul>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">oauth2Func</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">exp</span><span class="p">,</span> <span class="nx">$</span><span class="p">)</span> <span class="p">{</span>
    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

    <span class="kd">var</span>
        <span class="nx">config</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">DEFAULT_LIFETIME</span> <span class="o">=</span> <span class="mi">3600</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">uuid</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">&quot;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&quot;</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[xy]/g</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">16</span><span class="o">|</span><span class="mi">0</span><span class="p">,</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">c</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span> <span class="o">?</span> <span class="nx">r</span> <span class="o">:</span> <span class="p">(</span><span class="nx">r</span><span class="o">&amp;</span><span class="mh">0x3</span><span class="o">|</span><span class="mh">0x8</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">v</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">encodeURL</span><span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nx">k</span> <span class="k">in</span> <span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">res</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">i</span><span class="o">++</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">?</span> <span class="s2">&quot;?&quot;</span> <span class="o">:</span> <span class="s2">&quot;&amp;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">params</span><span class="p">[</span><span class="nx">k</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">epoch</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span><span class="o">/</span><span class="mf">1000.0</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">parseQueryString</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">qs</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">e</span><span class="p">,</span>
            <span class="nx">a</span> <span class="o">=</span> <span class="sr">/\+/g</span><span class="p">,</span>
            <span class="nx">r</span> <span class="o">=</span> <span class="sr">/([^&amp;;=]+)=?([^&amp;;]*)/g</span><span class="p">,</span>
            <span class="nx">d</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">));</span> <span class="p">},</span>
            <span class="nx">q</span> <span class="o">=</span> <span class="nx">qs</span><span class="p">,</span>
            <span class="nx">urlParams</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="k">while</span> <span class="p">(</span><span class="nx">e</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">q</span><span class="p">))</span> <span class="p">{</span>
           <span class="nx">urlParams</span><span class="p">[</span><span class="nx">d</span><span class="p">(</span><span class="nx">e</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="nx">d</span><span class="p">(</span><span class="nx">e</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">urlParams</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">saveState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s2">&quot;state-&quot;</span> <span class="o">+</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">obj</span><span class="p">));</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">getState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s2">&quot;state-&quot;</span> <span class="o">+</span> <span class="nx">state</span><span class="p">));</span>
        <span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="s2">&quot;state-&quot;</span> <span class="o">+</span> <span class="nx">state</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">hasScope</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">scope</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">token</span><span class="p">.</span><span class="nx">scopes</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">token</span><span class="p">.</span><span class="nx">scopes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">scopes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">scope</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">filterTokens</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tokens</span><span class="p">,</span> <span class="nx">scopes</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (1)</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">scopes</span><span class="p">)</span> <span class="nx">scopes</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">,</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">now</span> <span class="o">=</span> <span class="nx">epoch</span><span class="p">(),</span>
        <span class="nx">usethis</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">usethis</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">tokens</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">expires</span> <span class="o">&amp;&amp;</span> <span class="nx">tokens</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">expires</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">now</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="nx">usethis</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

            <span class="k">for</span><span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">scopes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasScope</span><span class="p">(</span><span class="nx">tokens</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">scopes</span><span class="p">[</span><span class="nx">j</span><span class="p">]))</span> <span class="nx">usethis</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">usethis</span><span class="p">)</span> <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tokens</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">saveTokens</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s2">&quot;tokens-&quot;</span> <span class="o">+</span> <span class="nx">providerId</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">tokens</span><span class="p">));</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">getTokens</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">providerId</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s2">&quot;tokens-&quot;</span> <span class="o">+</span> <span class="nx">providerId</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">tokens</span><span class="p">)</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="k">return</span> <span class="nx">tokens</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">wipeTokens</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">providerId</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="s2">&quot;tokens-&quot;</span> <span class="o">+</span> <span class="nx">providerId</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">saveToken</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">token</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (2)</span>
        <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">getTokens</span><span class="p">(</span><span class="nx">providerId</span><span class="p">);</span>
        <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">filterTokens</span><span class="p">(</span><span class="nx">tokens</span><span class="p">);</span>
        <span class="nx">tokens</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
        <span class="nx">saveTokens</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">getToken</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">scopes</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">getTokens</span><span class="p">(</span><span class="nx">providerId</span><span class="p">);</span>
        <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">filterTokens</span><span class="p">(</span><span class="nx">tokens</span><span class="p">,</span> <span class="nx">scopes</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">tokens</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">sendAuthRequest</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">scopes</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (3)</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">config</span><span class="p">[</span><span class="nx">providerId</span><span class="p">])</span> <span class="k">throw</span> <span class="s2">&quot;Could not find configuration for provider &quot;</span> <span class="o">+</span> <span class="nx">providerId</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">co</span> <span class="o">=</span> <span class="nx">config</span><span class="p">[</span><span class="nx">providerId</span><span class="p">];</span>

        <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">uuid</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;response_type&quot;</span><span class="o">:</span> <span class="s2">&quot;token&quot;</span>
        <span class="p">};</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">state</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">co</span><span class="p">[</span><span class="s2">&quot;redirectUrl&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;redirect_uri&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">co</span><span class="p">[</span><span class="s2">&quot;redirectUrl&quot;</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">co</span><span class="p">[</span><span class="s2">&quot;clientId&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;client_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">co</span><span class="p">[</span><span class="s2">&quot;clientId&quot;</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">scopes</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;scope&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">scopes</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">authurl</span> <span class="o">=</span> <span class="nx">encodeURL</span><span class="p">(</span><span class="nx">co</span><span class="p">.</span><span class="nx">authorization</span><span class="p">,</span> <span class="nx">request</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;restoreHash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;providerId&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">providerId</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">scopes</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;scopes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">scopes</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">saveState</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">request</span><span class="p">);</span>
        <span class="nx">redirect</span><span class="p">(</span><span class="nx">authurl</span><span class="p">);</span>

    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">checkForToken</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">providerId</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (4)</span>
        <span class="kd">var</span> <span class="nx">h</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (5)</span>
            <span class="nx">h</span> <span class="o">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">errorinfo</span> <span class="o">=</span> <span class="nx">parseQueryString</span><span class="p">(</span><span class="nx">h</span><span class="p">);</span>
            <span class="nx">handleError</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">errorinfo</span><span class="p">);</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;access_token&quot;</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">h</span> <span class="o">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">atoken</span> <span class="o">=</span> <span class="nx">parseQueryString</span><span class="p">(</span><span class="nx">h</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">atoken</span><span class="p">.</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">getState</span><span class="p">(</span><span class="nx">atoken</span><span class="p">.</span><span class="nx">state</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">state</span><span class="p">)</span> <span class="k">throw</span> <span class="s2">&quot;Could not retrieve state&quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">state</span><span class="p">.</span><span class="nx">providerId</span><span class="p">)</span> <span class="k">throw</span> <span class="s2">&quot;Could not get providerId from state&quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">config</span><span class="p">[</span><span class="nx">state</span><span class="p">.</span><span class="nx">providerId</span><span class="p">])</span> <span class="k">throw</span> <span class="s2">&quot;Could not retrieve config for this provider.&quot;</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">now</span> <span class="o">=</span> <span class="nx">epoch</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;expires_in&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;expires&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">now</span> <span class="o">+</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;expires_in&quot;</span><span class="p">]);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;expires&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">now</span> <span class="o">+</span> <span class="nx">DEFAULT_LIFETIME</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;scope&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;scopes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;scope&quot;</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">[</span><span class="s2">&quot;scopes&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;scopes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">state</span><span class="p">[</span><span class="s2">&quot;scopes&quot;</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="nx">saveToken</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">atoken</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">restoreHash</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">restoreHash</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">handleError</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">cause</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (6)</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">config</span><span class="p">[</span><span class="nx">providerId</span><span class="p">])</span> <span class="k">throw</span> <span class="s2">&quot;Could not retrieve config for this provider.&quot;</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">co</span> <span class="o">=</span> <span class="nx">config</span><span class="p">[</span><span class="nx">providerId</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">errorDetail</span> <span class="o">=</span> <span class="nx">cause</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">errorDescription</span> <span class="o">=</span> <span class="nx">cause</span><span class="p">[</span><span class="s2">&quot;error_description&quot;</span><span class="p">];</span>

        <span class="c1">// redirect error page</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">co</span><span class="p">[</span><span class="s2">&quot;errRedirectUrl&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">errorDetail</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">errorDetail</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">errorDescription</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;error_description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">errorDescription</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">redirect</span><span class="p">(</span><span class="nx">encodeURL</span><span class="p">(</span><span class="nx">co</span><span class="p">[</span><span class="s2">&quot;errRedirectUrl&quot;</span><span class="p">],</span> <span class="nx">request</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Access Error. cause: &quot;</span> <span class="o">+</span> <span class="nx">errorDetail</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
                    <span class="o">+</span> <span class="nx">errorDescription</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>


    <span class="kd">var</span> <span class="nx">redirect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">initialize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">config</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">providerId</span><span class="p">;</span>
            <span class="k">for</span><span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">providerId</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">checkForToken</span><span class="p">(</span><span class="nx">providerId</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Error when retrieving token from hash: &quot;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">);</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">clearTokens</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (7)</span>
        <span class="kd">var</span> <span class="nx">key</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">wipeTokens</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">oajax</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">settings</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (8)</span>
        <span class="kd">var</span> <span class="nx">providerId</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">providerId</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">scopes</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">scopes</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">getToken</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">scopes</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">sendAuthRequest</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">scopes</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">settings</span><span class="p">.</span><span class="nx">headers</span><span class="p">)</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">headers</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="nx">settings</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;Authorization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Bearer &quot;</span> <span class="o">+</span> <span class="nx">token</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">];</span>

        <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="nx">settings</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">parseFailureJSON</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (9)</span>
        <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">responseJSON</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">error</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">errorDescription</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">error_description</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">co</span> <span class="o">=</span> <span class="nx">config</span><span class="p">[</span><span class="nx">providerId</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span> <span class="o">===</span> <span class="s2">&quot;invalid_token&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">errorDescription</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">getTokens</span><span class="p">(</span><span class="nx">providerId</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">token</span> <span class="k">of</span> <span class="nx">tokens</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">errorDescription</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">token</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">errorDescription</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;Invalid access token&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="c1">// clear expired tokens</span>
                        <span class="nx">wipeTokens</span><span class="p">(</span><span class="nx">providerId</span><span class="p">)</span>

                        <span class="c1">// redirect for get access token</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">co</span><span class="p">[</span><span class="s2">&quot;redirectUrl&quot;</span><span class="p">])</span> <span class="p">{</span>
                            <span class="nx">redirect</span><span class="p">(</span><span class="nx">co</span><span class="p">[</span><span class="s2">&quot;redirectUrl&quot;</span><span class="p">]);</span>
                            <span class="k">return</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">co</span><span class="p">[</span><span class="s2">&quot;errRedirectUrl&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">error</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">errorDescription</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;error_description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">errorDescription</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">redirect</span><span class="p">(</span><span class="nx">encodeURL</span><span class="p">(</span><span class="nx">co</span><span class="p">[</span><span class="s2">&quot;errRedirectUrl&quot;</span><span class="p">],</span> <span class="nx">request</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Access Error. cause: &quot;</span> <span class="o">+</span> <span class="nx">error</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">errorDescription</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">initialize</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="nx">clearTokens</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">clearTokens</span><span class="p">();</span>
        <span class="p">},</span>
        <span class="nx">oajax</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">oajax</span><span class="p">(</span><span class="nx">settings</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="nx">parseFailureJSON</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">parseFailureJSON</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

<span class="p">})(</span><span class="nb">window</span><span class="p">,</span> <span class="nx">jQuery</span><span class="p">);</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A function (<code class="docutils literal"><span class="pre">filterTokens</span></code>) which determines and returns access token which can be used by the client.</div>
<div class="line">Return the access token which has not expired and which matches with the scope specified by parameters, from the access tokens stored in the local storage.</div>
<div class="line">When the scope is not specified, return an access token which has not expired.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A function ((<code class="docutils literal"><span class="pre">saveToken</span></code>) which stores access token in the local storage.</div>
<div class="line">It acts as a key for storing access token array in the local storage, by receiving <code class="docutils literal"><span class="pre">providerId</span></code>of configuration information described later as an argument.</div>
<div class="line">Array of access tokens is obtained by adding <code class="docutils literal"><span class="pre">token</span></code>argument to access token obtained from <code class="docutils literal"><span class="pre">filterTokens</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A function (<code class="docutils literal"><span class="pre">sendAuthRequest</span></code>) to request authorization for authorization server.</div>
<div class="line">Fetch necessary parameters from configuration information and create a request.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A function (<code class="docutils literal"><span class="pre">checkForToken</span></code>) to fetch access token from authorization response.</div>
<div class="line">Verify response of authorization returned from hash of URL, and if it is normal, store the information in local storage by using <code class="docutils literal"><span class="pre">saveToken</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When an error is returned as a result of authorization, call <code class="docutils literal"><span class="pre">handleError</span></code>as a error handling process.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A function (<code class="docutils literal"><span class="pre">handleError</span></code>) to process errors at the time of authorization.</div>
<div class="line">In this guideline, redirect to redirect destination URL is carried out at the time of error specified in configuration information
as the implementation example of error handling.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A function (<code class="docutils literal"><span class="pre">clearTokens</span></code>) to clear access tokens stored in the local storage.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A function which requests access to resource for resource server (<code class="docutils literal"><span class="pre">oajax</span></code>).</div>
<div class="line">Fetch access token from local storage and send a request to resource server by using <code class="docutils literal"><span class="pre">ajax</span></code>function of jQuery.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">A function (<code class="docutils literal"><span class="pre">parseFailureJSON</span></code>) which analyzes JSON returned when an error occurs in <code class="docutils literal"><span class="pre">ajax</span></code>function and determines transition destination.</div>
<div class="line">Determine whether the access token has expired, delete access token when it is expired and display screen again.</div>
<div class="line">As an example, expiry of access token can be determined under following conditions.</div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">error</span></code>: <code class="docutils literal"><span class="pre">invalid_token</span></code></li>
<li><code class="docutils literal"><span class="pre">error_description</span></code>: Access token is included and <code class="docutils literal"><span class="pre">Invalid</span> <span class="pre">access</span> <span class="pre">token</span></code>is not included</li>
</ul>
<div class="line-block">
<div class="line">If the token is not expired, it is redirected by assigning <code class="docutils literal"><span class="pre">error</span></code>and <code class="docutils literal"><span class="pre">error_description</span></code>to URL for redirect at the time of error.</div>
</div>
<div class="last admonition note">
<p class="first admonition-title">Note</p>
<p><strong>About determination criteria</strong></p>
<p>Determination criteria shown above is not defined by specifications of Spring Security OAuth.
It is a workaround determination criteria based on current implementation of <code class="docutils literal"><span class="pre">TokenServices</span></code>and it must be noted that it is likely to be changed in accordance with the implementation changes of Spring Security OAuth in future.</p>
<ul class="simple">
<li>Return a character string <code class="docutils literal"><span class="pre">expired</span></code>which indicates <a class="reference external" href="https://github.com/spring-projects/spring-security-oauth/blob/master/spring-security-oauth2/src/main/java/org/springframework/security/oauth2/provider/token/DefaultTokenServices.java#L235">DefaultTokenServices</a>:Expired, and access token</li>
<li>Returns only access token and the character string which explicitly determines <a class="reference external" href="https://github.com/spring-projects/spring-security-oauth/blob/master/spring-security-oauth2/src/main/java/org/springframework/security/oauth2/provider/token/RemoteTokenServices.java#L110">RemoteTokenServices</a>:Expired is not returned</li>
</ul>
<p>If the resource server does not use <code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>, following conditions can be alleviated.</p>
<ul class="last simple">
<li><code class="docutils literal"><span class="pre">error</span></code>:<code class="docutils literal"><span class="pre">invalid_token</span></code></li>
<li><code class="docutils literal"><span class="pre">error_description</span></code>:<code class="docutils literal"><span class="pre">expired</span></code></li>
</ul>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>The implementation example of client is shown below.
In order to make URL of authorization server and resource server to be accessed as variable, URL is fetched from property and environment variables in controller and linked to the screen.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">TodoController.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoListController</span> <span class="o">{</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${client.serverUrl}&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="n">String</span> <span class="n">applicationContextUrl</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${auth.serverUrl}&quot;</span><span class="o">)</span> <span class="c1">// (2)</span>
    <span class="n">String</span> <span class="n">authServerUrl</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${resource.serverUrl}&quot;</span><span class="o">)</span> <span class="c1">// (3)</span>
    <span class="n">String</span> <span class="n">resourceServerUrl</span><span class="o">;</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;todo/get&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTodo</span><span class="o">(</span><span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;client.serverUrl&quot;</span><span class="o">,</span> <span class="n">applicationContextUr</span><span class="o">);</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;auth.serverUrl&quot;</span><span class="o">,</span> <span class="n">authServerUrl</span><span class="o">);</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;resource.serverUrl&quot;</span><span class="o">,</span> <span class="n">resourceServerUrl</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">&quot;todo/todoList&quot;</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch root path of client.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch root path of authorization server.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch root path of resource server.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Also, a controller is added which handles URL for redirect at the time of error (<code class="docutils literal"><span class="pre">/oauth/error</span></code>).
Implementation of controller is shown below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">OAuth2ErrorController.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/oauth/error&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2ErrorController</span> <span class="o">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">params</span> <span class="o">=</span> <span class="o">{</span> <span class="s">&quot;error=access_denied&quot;</span><span class="o">,</span>
            <span class="s">&quot;error_description=User denied access&quot;</span> <span class="o">})</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">handleAccessDeniedError</span><span class="o">(</span>
            <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;error&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">error</span><span class="o">,</span>
            <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;error_description&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">description</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// omitted</span>

        <span class="k">return</span> <span class="s">&quot;common/error/accessDeniedError&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span> <span class="c1">// (2)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">handleError</span><span class="o">(</span>
            <span class="nd">@RequestParam</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;error&quot;</span><span class="o">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span> <span class="n">String</span> <span class="n">error</span><span class="o">,</span>
            <span class="nd">@RequestParam</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;error_description&quot;</span><span class="o">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span> <span class="n">String</span> <span class="n">description</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// omitted</span>

        <span class="k">return</span> <span class="s">&quot;common/error/systemError&quot;</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">When the request parameter indicates Access denied for resource owner, move to Access denied screen.</div>
</div>
<ul class="last simple">
<li><code class="docutils literal"><span class="pre">error</span></code>: <code class="docutils literal"><span class="pre">access_denied</span></code></li>
<li><code class="docutils literal"><span class="pre">error_description</span></code>: <code class="docutils literal"><span class="pre">User</span> <span class="pre">denied</span> <span class="pre">access</span></code></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Move to System error screen except for (1).</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Implementation example of client screen (JSP) is shown.
In JSP, authorization server and resource server are accessed by using independently implemented JavaScript described earlier.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">todoList.jsp</span></code></li>
</ul>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;script</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;${pageContext.request.contextPath}/resources/vendor/jquery/jquery.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;script</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;${pageContext.request.contextPath}/resources/app/js/oauth2.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;script</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
&quot;use strict&quot;;

$(document).ready(function() {
    var result = oauth2Func.initialize({ // (2)
        &quot;todo&quot; : { // (3)
            clientId : &quot;client&quot;, // (4)
            redirectUrl : &quot;${client.serverUrl}/todo/get&quot;, // (5)
            errRedirectUrl : &quot;${client.serverUrl}/oauth/error&quot;, // (6)
            authorization : &quot;${auth.serverUrl}/oauth/authorize&quot; // (7)
        }
    });

    if (result) {
        oauth2Func.oajax({ // (8)
            url : &quot;${resource.serverUrl}/api/v1/todos&quot;, // (9)
            providerId : &quot;todo&quot;,  // (10)
            scopes : [ &quot;READ&quot; ],  // (11)
            dataType : &quot;json&quot;,    // (12)
            type : &quot;GET&quot;  // (13)
        }).done(function(data) {  // (14)
            $(&quot;#message&quot;).text(JSON.stringify(data));
        }).fail(function(data) {  // (15)
            oauth2Func.parseFailureJSON(&quot;todo&quot;, data);
        });
    }
});

<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">&quot;message&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the path that stores jQuery and individually implemented JavaScript respectively, mentioned earlier.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define configuration information to be used for authorization request and initialize the same.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify a unique value as an identifier for distinguishing the configuration information of each client.</div>
<div class="line">In the process of accessing resources described later, manage and fetch configuration information by using this item as a key.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify ID identifying the client.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify URL to redirect the client after authenticating the resource owner of authorization server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify URL for redirecting when an error is received from authorization server as the authorization response.</div>
<div class="line">These guidelines show the method of redirecting to client screen and displaying the error screen,
as an example of implementation when error is received.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify authorization end point of authorization server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Access the resource.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify access destination of resource server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify identifier of configuration information to be referred.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify scope to request authorization. Setting value is classified by upper case character and lower chase character.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify response format.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(13)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Access resource server GET method.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(14)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify process when processing is successful. Response after successful processing is stored in <code class="docutils literal"><span class="pre">message</span></code>.</div>
<div class="line">In this guideline, response is output as it is.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(15)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify a process to perform at the time of process failure.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>In this implementation example, a fixed value is used as a key for storing the access token in the local storage.</p>
<p>When the information is stored in the local storage with a fixed key, as in the implementation example, when multiple users use browser of the same terminal,
it may happen that information stored by one user is referred by another user unintentionally.</p>
<p class="last">When it is assumed that multiple users use browser of same terminal, session storage is adopted
and it is necessary to implement a system so that unintended and unauthorized use does not occur like storing a unique key for each user etc.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When access token issue is to be requested for the authorization server implemented by architecture other than Spring Security OAuth,
it must be noted that the request parameter is likely to be different from the parameter given above.
In that case, architecture specification must be checked and required request parameter must be set.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><div class="admonition-todo admonition" id="index-1">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p>When authorization servers and resource server that are not in the same domain are accessed from the clients created in JavaScript, support of <code class="docutils literal"><span class="pre">Cross-Origin</span> <span class="pre">Resource</span> <span class="pre">Sharing</span></code> is required on authorization server and resource server.</p>
<p class="last">Details will be described in the next versions.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id8">
<h5><a class="toc-backref" href="#id122">9.9.2.4.3.2. Cancelling a token (client server)</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h5>
<p>Cancellation of issued access token is explained.</p>
<p>For a method to delete access token from authorization server, refer <a class="reference internal" href="#oauthauthorizationserverhowtocanceltoken"><span class="std std-ref">Canceling a token (authorization server)</span></a>.</p>
<p>In the client, an access token stored in the local storage can be deleted by calling <code class="docutils literal"><span class="pre">clearTokens</span></code> of <code class="docutils literal"><span class="pre">oauth2.js</span></code>when the access token becomes unnecessary.</p>
<p>Implementation example is shown below.</p>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">oauth2Func</span><span class="p">.</span><span class="nx">clearTokens</span><span class="p">({</span> <span class="c1">// (1)</span>
        <span class="s2">&quot;todo&quot;</span> <span class="o">:</span> <span class="p">{}</span> <span class="c1">// (2)</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call <code class="docutils literal"><span class="pre">clearTokens</span></code>function to delete access tokens from local storage.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set a value same as a unique value set in <code class="docutils literal"><span class="pre">initialize</span></code>, as a key to refer access token.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Even if the access token is deleted from local storage, the access token can ve fetched again without requesting authorization of resource owner, as explained in <a class="reference internal" href="#oauthauthorizationserverhowtocanceltoken"><span class="std std-ref">Canceling a token (authorization server)</span></a>.
It must be noted that merely deleting the access token from the client is inadequate as a security measure.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">JavaScript may not be executed due to termination of browser, depending on the timing of deletion of access token.
When the security token must be deleted due to security requirement, considering that the user terminates the browser,
it must be noted that it is necessary to delete the access token at the point executing for the use case.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthclienterrorhandlingwithimplicit">
<span id="id9"></span><h5><a class="toc-backref" href="#id123">9.9.2.4.3.3. Error handling</a><a class="headerlink" href="#oauthclienterrorhandlingwithimplicit" title="Permalink to this headline">¶</a></h5>
<p>Methods to handle errors which occur while accessing authorization server and resource server in the implicit grant is explained.</p>
<div class="section" id="oauthclienthandleerrorwhenaccessingauthorizationendpointwithimplicit">
<span id="id10"></span><h6><a class="toc-backref" href="#id124">9.9.2.4.3.3.1. Error handling while accessing authorization end point</a><a class="headerlink" href="#oauthclienthandleerrorwhenaccessingauthorizationendpointwithimplicit" title="Permalink to this headline">¶</a></h6>
<p>Since errors handled from the errors which occur at authorization end point are same as in authorization code grant, refer <a class="reference internal" href="#oauthclienthandleerrorwhenaccessingauthorizationendpointwithcode"><span class="std std-ref">Error handling while accessing authorization end point</span></a>.
For error handling, refer <a class="reference internal" href="#oauthclientusingjavascript"><span class="std std-ref">Accessing a resource server which uses JavaScript</span></a>.</p>
</div>
<div class="section" id="error-handling-while-accessing-resource-server">
<span id="oauthclienthandleerrorwhenaccessingtokenendpointwithimplicit"></span><h6><a class="toc-backref" href="#id125">9.9.2.4.3.3.2. Error handling while accessing resource server</a><a class="headerlink" href="#error-handling-while-accessing-resource-server" title="Permalink to this headline">¶</a></h6>
<p>Handling must be done as below for errors which occur while accessing resource server.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id53">
<caption><span class="caption-text"><strong>Errors which occur in the resource server</strong></span><a class="headerlink" href="#id53" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Errors occurred</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Access token verification error</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.common.exceptions.InvalidTokenException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It occurs when validity of access token received from resource server could not be verified (abnormal system) or when access token has expired (normal system).</div>
<div class="line"><br /></div>
<div class="line">Since access token error is a combination of normal system and abnormal system, if this error is received when implicit grant <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> is not being used, it must be determined whether the access token has expired.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>For error handling, refer <a class="reference internal" href="#oauthclientusingjavascript"><span class="std std-ref">Accessing a resource server which uses JavaScript</span></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Handling of errors which occur due to resource owner operations are introduced alone above, however system errors must also be handled.
For errors occurred, refer <a class="reference internal" href="#oauthappendixoccuringerrors"><span class="std std-ref">Errors which occur while accessing authorization server and resource server from the client</span></a>.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="implementation-of-resource-owner-password-credential-grant">
<span id="implementationresourceownerpasswordcredentialsgrant"></span><h3><a class="toc-backref" href="#id126">9.9.2.5. Implementation of resource owner password credential grant</a><a class="headerlink" href="#implementation-of-resource-owner-password-credential-grant" title="Permalink to this headline">¶</a></h3>
<p>Implementation methods for authorization server, resource server and client which use resource owner password credential grant are explained.</p>
<p>Explanation is given only for the changes from that of authorization code grant. For explanation and implementation for other than changes, refer <a class="reference internal" href="#implementationautorizationcodegrant"><span class="std std-ref">Implementation of authorization code grant</span></a>.</p>
<p>Changes from that of authorization code grant while implementing each server are shown below.</p>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="30%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">Server</th>
<th class="head">Changes from that of authorization code grant</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">Authorization server</th>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#oauthauthorizationserverdefinition"><span class="std std-ref">Defining authorization server</span></a></div>
<div class="line"><a class="reference internal" href="#oauthauthorizationserverclientauthentication"><span class="std std-ref">Client authentication</span></a></div>
<div class="line"><a class="reference internal" href="#oauthauthorizationserverhowtocanceltoken"><span class="std std-ref">Canceling a token (authorization server)</span></a></div>
</div>
</td>
</tr>
<tr class="row-odd"><th class="stub">Resource server</th>
<td>Nil</td>
</tr>
<tr class="row-even"><th class="stub">Client</th>
<td><a class="reference internal" href="#oauth2resttemplatesettings"><span class="std std-ref">Settings of OAuth2RestTemplate</span></a></td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="implementationoauthauthorizationserverofpassword">
<span id="id11"></span><h4><a class="toc-backref" href="#id127">9.9.2.5.1. Implementation of authorization server</a><a class="headerlink" href="#implementationoauthauthorizationserverofpassword" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>must be changed from the implementation of authorization code grant and unnecessary definition must be deleted from DB and Service class.</p>
<p>For implementation of other than <code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>, refer <a class="reference internal" href="#implementationoauthauthorizationserverofautorizationcode"><span class="std std-ref">Implementation of authorization server</span></a>.</p>
<div class="section" id="id12">
<h5><a class="toc-backref" href="#id128">9.9.2.5.1.1. Defining authorization server</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h5>
<p>Changes of <code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code> from that of authorization code grant are shown below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
    <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span>
    <span class="na">user-approval-handler-ref=</span><span class="s">&quot;userApprovalHandler&quot;</span>
    <span class="na">token-services-ref=</span><span class="s">&quot;tokenServices&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:password</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use <code class="docutils literal"><span class="pre">&lt;oauth2:password</span> <span class="pre">/&gt;</span></code>tag and support resource owner password credential grant.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><code class="docutils literal"><span class="pre">&lt;oauth2:password</span> <span class="pre">/&gt;</span></code>tag and <code class="docutils literal"><span class="pre">&lt;oauth2:refresh-token</span> <span class="pre">/&gt;</span></code>tag must be set in the above sequence.</p>
<p class="last">For details, refer <a class="reference internal" href="#orderofauthoraizationserversupportsetting"><span class="std std-ref">When the multiple grant types are supported in authorization server</span></a>.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id13">
<h5><a class="toc-backref" href="#id129">9.9.2.5.1.2. Client authentication</a><a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h5>
<p>Access token is directly issued in the resource owner password credential grant as explained in <a class="reference internal" href="#authorizationgrant"><span class="std std-ref">Authorization grant</span></a>.
Therefore, authorization is not requested to the resource owner and redirection of user agent does not occur.</p>
<p>Table defined in <a class="reference internal" href="#oauthauthorizationserverclientauthentication"><span class="std std-ref">Client authentication</span></a> of authorization code grant should be deleted since <code class="docutils literal"><span class="pre">web_server_redirect_uris</span></code> is not required.</p>
</div>
<div class="section" id="cancelling-a-token-authorization-server">
<h5><a class="toc-backref" href="#id130">9.9.2.5.1.3. Cancelling a token (authorization server)</a><a class="headerlink" href="#cancelling-a-token-authorization-server" title="Permalink to this headline">¶</a></h5>
<p>In the implementation of authorization code grant, authorization information is canceled in accordance with cancellation of token for authorization server in <code class="docutils literal"><span class="pre">RevokeTokenServiceImpl.java</span></code>.</p>
<p>The process is deleted since cancellation of authorization information is not required in resource owner password credential grant which does not request authorization for resource owner.</p>
<p><code class="docutils literal"><span class="pre">RevokeTokenServiceImpl.java</span></code> which comments out cancellation of authorization information is shown below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">RevokeTokenClientService.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RevokeTokenServiceImpl</span> <span class="kd">implements</span> <span class="n">RevokeTokenService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ConsumerTokenServices</span> <span class="n">consumerService</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">TokenStore</span> <span class="n">tokenStore</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">ApprovalStore</span> <span class="n">approvalStore</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">JodaTimeDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">revokeToken</span><span class="o">(</span><span class="n">String</span> <span class="n">tokenValue</span><span class="o">,</span> <span class="n">String</span> <span class="n">clientId</span><span class="o">){</span>

        <span class="n">OAuth2Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="n">tokenStore</span><span class="o">.</span><span class="na">readAuthentication</span><span class="o">(</span><span class="n">tokenValue</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">authentication</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">clientId</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">authentication</span><span class="o">.</span><span class="na">getOAuth2Request</span><span class="o">().</span><span class="na">getClientId</span><span class="o">()))</span> <span class="o">{</span>
                <span class="cm">/* Authentication user = authentication.getUserAuthentication();</span>
<span class="cm">                if (user != null) {</span>
<span class="cm">                    Collection&lt;Approval&gt; approvals = new ArrayList&lt;&gt;();</span>
<span class="cm">                    for (String scope : authentication.getOAuth2Request().getScope()) {</span>
<span class="cm">                        approvals.add(</span>
<span class="cm">                                new Approval(user.getName(), clientId, scope, dateFactory.newDate(), ApprovalStatus.APPROVED));</span>
<span class="cm">                    }</span>
<span class="cm">                    approvalStore.revokeApprovals(approvals);</span>
<span class="cm">                } */</span>
                <span class="n">consumerService</span><span class="o">.</span><span class="na">revokeToken</span><span class="o">(</span><span class="n">tokenValue</span><span class="o">);</span>
                <span class="k">return</span> <span class="s">&quot;success&quot;</span><span class="o">;</span>

            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">return</span> <span class="s">&quot;invalid client&quot;</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">&quot;invalid token&quot;</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="implementationoauthresourceserverofpassword">
<span id="id14"></span><h4><a class="toc-backref" href="#id131">9.9.2.5.2. Implementation of resource server</a><a class="headerlink" href="#implementationoauthresourceserverofpassword" title="Permalink to this headline">¶</a></h4>
<p>Changes are not required from the implementation of authorization code grant.</p>
<p>Implementation should be created by referring <a class="reference internal" href="#implementationoauthresourceserverofautorizationcode"><span class="std std-ref">Implementation of resource server</span></a>.</p>
</div>
<div class="section" id="implementationoauthclientserverofpassword">
<span id="id15"></span><h4><a class="toc-backref" href="#id132">9.9.2.5.3. Implementation of client</a><a class="headerlink" href="#implementationoauthclientserverofpassword" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code> must be changed from the implementation of authorization code grant.</p>
<p>Implementation other than <code class="docutils literal"><span class="pre">oauth2-client.xml</span></code> must be created by referring <a class="reference internal" href="#implementationoauthclientserverofautorizationcode"><span class="std std-ref">Implementation of client</span></a>.</p>
<div class="section" id="oauth2resttemplate-settings">
<span id="oauth2resourceownerpasswordcredentialgrantresourcesettings"></span><h5><a class="toc-backref" href="#id133">9.9.2.5.3.1. OAuth2RestTemplate settings</a><a class="headerlink" href="#oauth2resttemplate-settings" title="Permalink to this headline">¶</a></h5>
<div class="line-block">
<div class="line">In the resource owner password credential grant, the client requests the issue of access token by using user name and password of resource owner.</div>
<div class="line">User name and password of resource owner must be set in <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> as parameters, however,
when multiple resource owners use the same client, changing setting details for each resource owner must be considered.</div>
<div class="line">A method to change between setting details for each resource owner is explained here wherein resource of <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> is set in Bean of Session scope
and information of resource owner is stored in that Bean.</div>
<div class="line">Since <code class="docutils literal"><span class="pre">&lt;oauth2:resource&gt;</span></code> tag normally used as a resource acts as a Bean of Singleton scope, a Bean must be defined independently while changing to Session scope.</div>
</div>
<p>A setup example of <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>is shown below.</p>
<p><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.client.token.grant.password.ResourceOwnerPasswordResourceDetails</span></code> is defined in Session scope so as to change between settings details of each resource owner and set in <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;todoPasswordGrantResource&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.client.token.grant.password.ResourceOwnerPasswordResourceDetails&quot;</span>
    <span class="na">scope=</span><span class="s">&quot;session&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;aop:scoped-proxy</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;clientId&quot;</span> <span class="na">value=</span><span class="s">&quot;firstSec&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;clientSecret&quot;</span> <span class="na">value=</span><span class="s">&quot;firstSecSecret&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;accessTokenUri&quot;</span> <span class="na">value=</span><span class="s">&quot;${auth.serverUrl}/oauth/token&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;scope&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;list&gt;</span>
            <span class="nt">&lt;value&gt;</span>READ<span class="nt">&lt;/value&gt;</span>
            <span class="nt">&lt;value&gt;</span>WRITE<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

<span class="nt">&lt;oauth2:rest-template</span> <span class="na">id=</span><span class="s">&quot;todoPasswordGrantResourceRestTemplate&quot;</span> <span class="na">resource=</span><span class="s">&quot;todoPasswordGrantResource&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define detail information for the resource to be accessed, referred by <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>.</div>
<div class="line">Refer to the table below for setting value of each item.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>.</div>
<div class="line">Specify Bean ID of <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>in  <code class="docutils literal"><span class="pre">id</span></code>.</div>
<div class="line">Specify <code class="docutils literal"><span class="pre">id</span></code>of Bean defined in (1), in <code class="docutils literal"><span class="pre">resource</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">class</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify a Bean which is a resource of <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>. Here, <code class="docutils literal"><span class="pre">ResourceOwnerPasswordResourceDetails</span></code> is specified.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">scope</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify session and use HTTPSession as scope range.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;aop:scoped-proxy</span> <span class="pre">/&gt;</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set the Session scope Bean to inject into a Singleton Bean - <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>.</div>
<div class="line">This setting is required because bean of Singleton has a longer life cycle than Session scope Bean.</div>
<div class="line">Namespace and schema of <code class="docutils literal"><span class="pre">aop</span></code> are added in order to use this tag.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">clientId</span></code> property</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify an ID to identify the client in the authorization server for <code class="docutils literal"><span class="pre">clientId</span></code> of Bean.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">clientSecret</span></code> property</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set password used for client authentication in the authorization server, for <code class="docutils literal"><span class="pre">clientSecret</span></code> of Bean.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">accessTokenUri</span></code> property</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the end point of authorization server to request issue of access token.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">scope</span></code> property</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set scope list which require authorization for <code class="docutils literal"><span class="pre">scope</span></code> of Bean.</div>
<div class="line">Specify <code class="docutils literal"><span class="pre">scope</span></code> in the list format unlike using <code class="docutils literal"><span class="pre">&lt;oauth2:resource&gt;</span></code> tag.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When the issue of access token is requested for authorization server implemented by architecture other than Spring Security OAuth,
it must be noted that the request parameters are likely to be different than those given above.
In that case, architecture specifications should be checked and required request parameters must be set.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For acquisition of user name and password of resource owner, it is to be entered by resource owner on the client screen when the access is required and stored in the Bean.
In this guideline, explanation about how to specifically fetch user name and password is omitted.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">In the authorization server explained in the guideline, password to be set in <code class="docutils literal"><span class="pre">ResourceOwnerPasswordResourceDetails</span></code> should be in plain text in order to perform comparison verification after hashing the password used for authentication.
Since the risk of handling of password by client in plain text is high, resource owner password credential grant should be used only in limited circumstances
like when the client and resource owner share a high trust relation or when the client is placed in a secure environment etc.
For settings of hashing in the authorization server, refer <a class="reference internal" href="#oauthauthorizationserverclientauthentication"><span class="std std-ref">Client authentication</span></a>.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthclienterrorhandlingwithpassword">
<span id="id16"></span><h5><a class="toc-backref" href="#id134">9.9.2.5.3.2. Error handling</a><a class="headerlink" href="#oauthclienterrorhandlingwithpassword" title="Permalink to this headline">¶</a></h5>
<p>Methods to handle errors which occur while accessing authorization server and resource server in resource server password credential grant are explained.</p>
<div class="section" id="error-handling-while-accessing-token-end-point-and-resource-server">
<span id="oauthclienthandleerrorwhenaccessingtokenendpointwithpassword"></span><h6><a class="toc-backref" href="#id135">9.9.2.5.3.2.1. Error handling while accessing token end point and resource server</a><a class="headerlink" href="#error-handling-while-accessing-token-end-point-and-resource-server" title="Permalink to this headline">¶</a></h6>
<p>For errors which must be handled, from the errors that occur in resource server, and error handling, refer <a class="reference internal" href="#oauthclienthandleerrorwhenaccessingtokenendpointwithcode"><span class="std std-ref">Token end point and error handling while accessing resource server</span></a>since it is same as authorization code grant.</p>
<p>Exceptions which occur at token end point are wrapped in <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.client.resource.OAuth2AccessDeniedException</span></code>by <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>of client.
Errors which require handling, from the errors wrapped by <code class="docutils literal"><span class="pre">OAuth2AccessDeniedException</span></code>are shown below.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id54">
<caption><span class="caption-text"><strong>Errors which occur in token end point</strong></span><a class="headerlink" href="#id54" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Errors occurred</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource owner authentication error</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.common.exceptions.InvalidGrantException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It occurs when there is an error in authentication information of resource submitted while using resource password credential grant.</div>
<div class="line">When an error occurs, <code class="docutils literal"><span class="pre">InvalidGrantException</span></code> is handled as an exception class on the authorization server.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>A process to handle exceptions thrown by <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> above must be implemented.
Implementation example is shown below.
For <code class="docutils literal"><span class="pre">&#64;ControllerAdvice</span></code> annotation used in the implementation example, refer <a class="reference internal" href="../ImplementationAtEachLayer/ApplicationLayer.html#application-layer-controller-advice"><span class="std std-ref">Implementing “&#64;ControllerAdvice”</span></a>.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2ExceptionHandler</span> <span class="o">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="n">OAuth2AccessDeniedException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">handleOAuth2AccessDeniedException</span><span class="o">(</span><span class="n">OAuth2AccessDeniedException</span> <span class="n">e</span><span class="o">,</span>
            <span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// omitted</span>

        <span class="c1">// (2)</span>
        <span class="n">Throwable</span> <span class="n">cause</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getCause</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cause</span> <span class="k">instanceof</span> <span class="n">InvalidGrantException</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">handleInvalidGrantException</span><span class="o">(((</span><span class="n">InvalidGrantException</span><span class="o">)</span> <span class="n">cause</span><span class="o">),</span>
                    <span class="n">model</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;exception&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>

        <span class="k">return</span> <span class="s">&quot;common/error/systemError&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="nf">handleInvalidGrantException</span><span class="o">(</span><span class="n">InvalidGrantException</span> <span class="n">e</span><span class="o">,</span>
            <span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;exception&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>

        <span class="k">return</span> <span class="s">&quot;common/error/accessDeniedError&quot;</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Handle errors which occur in the controller.</div>
<div class="line">It is executed when <code class="docutils literal"><span class="pre">OAuth2AccessDeniedException</span></code> specified in parameters of <code class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></code> occurs.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Determine transition destination screen according to cause of errors occurred.</div>
<div class="line">If the cause of the error is <code class="docutils literal"><span class="pre">InvalidGrantException</span></code>, transition occurs to “Access denied” screen.</div>
<div class="line">Transition occurs to “System error screen” for causes other than mentioned above.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Handling of only the errors which occur due to resource owner operations is introduced above, however, system errors must also be handled.
For errors occurred, refer <a class="reference internal" href="#oauthappendixoccuringerrors"><span class="std std-ref">Errors which occur while accessing authorization server and resource server from the client</span></a>.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="implementation-of-client-credential-grant">
<span id="clientcredentialsgrant"></span><h3><a class="toc-backref" href="#id136">9.9.2.6. Implementation of client credential grant</a><a class="headerlink" href="#implementation-of-client-credential-grant" title="Permalink to this headline">¶</a></h3>
<p>Implementation methods of authorization server, resource server and client which use client credential grant are explained.</p>
<p>Explanation is given only for changes from that of authorization code grant. For implementation and explanation for other than changes, refer <a class="reference internal" href="#implementationautorizationcodegrant"><span class="std std-ref">Implementation of authorization code grant</span></a>.</p>
<p>Changes from that of authorization code grant while implementing each server are shown below.</p>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="30%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">Server</th>
<th class="head">Changes from authorization code grant</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">Authorization server</th>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#oauthauthorizationserverdefinition"><span class="std std-ref">Defining authorization server</span></a></div>
<div class="line"><a class="reference internal" href="#oauthauthorizationserverclientauthentication"><span class="std std-ref">Client authentication</span></a></div>
<div class="line"><a class="reference internal" href="#oauthauthorizationserverhowtocanceltoken"><span class="std std-ref">Canceling a token (authorization server)</span></a></div>
</div>
</td>
</tr>
<tr class="row-odd"><th class="stub">Resource server</th>
<td><a class="reference internal" href="#oauthresourceservergetprincipal"><span class="std std-ref">Fetching user information</span></a></td>
</tr>
<tr class="row-even"><th class="stub">Client</th>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#oauth2resttemplatesettings"><span class="std std-ref">Settings of OAuth2RestTemplate</span></a></div>
<div class="line"><a class="reference internal" href="#oauthaccessofresourceserver"><span class="std std-ref">Accessing a resource Server</span></a></div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="implementationoauthauthorizationserverofclientcredentials">
<span id="id17"></span><h4><a class="toc-backref" href="#id137">9.9.2.6.1. Implementation of authorization server</a><a class="headerlink" href="#implementationoauthauthorizationserverofclientcredentials" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>must be changed from implementation of authorization code grant and unnecessary definitions should be deleted from DB and Service class.</p>
<p>Implementation other than <code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>must be created by referring <a class="reference internal" href="#implementationoauthauthorizationserverofautorizationcode"><span class="std std-ref">Implementation of authorization server</span></a>.</p>
<div class="section" id="id18">
<h5><a class="toc-backref" href="#id138">9.9.2.6.1.1. Defining authorization server</a><a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h5>
<p>Changes in <code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>from that of authorization code grant are shown below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
    <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span>
    <span class="na">token-endpoint-url=</span><span class="s">&quot;/oauth/token&quot;</span>
    <span class="na">token-services-ref=</span><span class="s">&quot;tokenServices&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:client-credentials</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use <code class="docutils literal"><span class="pre">&lt;oauth2:client-credentials</span> <span class="pre">/&gt;</span></code>tag and support client credential grant.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><code class="docutils literal"><span class="pre">&lt;oauth2:client-credentials</span> <span class="pre">/&gt;</span></code>tag and <code class="docutils literal"><span class="pre">&lt;oauth2:refresh-token</span> <span class="pre">/&gt;</span></code>tag must be set in the sequence given above.</p>
<p class="last">For details, refer <a class="reference internal" href="#orderofauthoraizationserversupportsetting"><span class="std std-ref">When the multiple grant types are supported in authorization server</span></a>.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id19">
<h5><a class="toc-backref" href="#id139">9.9.2.6.1.2. Client authentication</a><a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h5>
<p>Access token is directly issued in client credential grant as explained in <a class="reference internal" href="#authorizationgrant"><span class="std std-ref">Authorization grant</span></a>.
Therefore, authorization is not requested to the resource owner and redirection of user agent does not occur.</p>
<p>Table defined in <a class="reference internal" href="#oauthauthorizationserverclientauthentication"><span class="std std-ref">Client authentication</span></a> of authorization code grant should be deleted since <code class="docutils literal"><span class="pre">web_server_redirect_uris</span></code>is not required.</p>
</div>
<div class="section" id="id20">
<h5><a class="toc-backref" href="#id140">9.9.2.6.1.3. Cancelling a token (authorization server)</a><a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h5>
<p>In the implementation of authorization code grant, authorization information is cancelled in accordance with cancellation of token for authorization server in <code class="docutils literal"><span class="pre">RevokeTokenServiceImpl.java</span></code>.</p>
<p>The process is deleted since cancellation of authorization information is not required in client credential grant which does not request authorization for resource owner.</p>
<p><code class="docutils literal"><span class="pre">RevokeTokenServiceImpl.java</span></code> which comments out cancellation of authorization information is shown below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">RevokeTokenServiceImpl.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RevokeTokenServiceImpl</span> <span class="kd">implements</span> <span class="n">RevokeTokenService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ConsumerTokenServices</span> <span class="n">consumerService</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">TokenStore</span> <span class="n">tokenStore</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">ApprovalStore</span> <span class="n">approvalStore</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">JodaTimeDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">revokeToken</span><span class="o">(</span><span class="n">String</span> <span class="n">tokenValue</span><span class="o">,</span> <span class="n">String</span> <span class="n">clientId</span><span class="o">){</span>

        <span class="n">OAuth2Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="n">tokenStore</span><span class="o">.</span><span class="na">readAuthentication</span><span class="o">(</span><span class="n">tokenValue</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">authentication</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">clientId</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">authentication</span><span class="o">.</span><span class="na">getOAuth2Request</span><span class="o">().</span><span class="na">getClientId</span><span class="o">()))</span> <span class="o">{</span>
                <span class="cm">/* Authentication user = authentication.getUserAuthentication();</span>
<span class="cm">                if (user != null) {</span>
<span class="cm">                    Collection&lt;Approval&gt; approvals = new ArrayList&lt;&gt;();</span>
<span class="cm">                    for (String scope : authentication.getOAuth2Request().getScope()) {</span>
<span class="cm">                        approvals.add(</span>
<span class="cm">                                new Approval(user.getName(), clientId, scope, dateFactory.newDate(), ApprovalStatus.APPROVED));</span>
<span class="cm">                    }</span>
<span class="cm">                    approvalStore.revokeApprovals(approvals);</span>
<span class="cm">                } */</span>
                <span class="n">consumerService</span><span class="o">.</span><span class="na">revokeToken</span><span class="o">(</span><span class="n">tokenValue</span><span class="o">);</span>
                <span class="k">return</span> <span class="s">&quot;success&quot;</span><span class="o">;</span>

            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">return</span> <span class="s">&quot;invalid client&quot;</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">&quot;invalid token&quot;</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="implementationoauthresourceserverofclientcredentials">
<span id="id21"></span><h4><a class="toc-backref" href="#id141">9.9.2.6.2. Implementation of resource server</a><a class="headerlink" href="#implementationoauthresourceserverofclientcredentials" title="Permalink to this headline">¶</a></h4>
<p><a class="reference internal" href="#oauthresourceservergetprincipal"><span class="std std-ref">Fetching user information</span></a>must be changed from implementation of authorization code grant.</p>
<p>Implementation other than <a class="reference internal" href="#oauthresourceservergetprincipal"><span class="std std-ref">Fetching user information</span></a>must be created by referring <a class="reference internal" href="#implementationoauthresourceserverofautorizationcode"><span class="std std-ref">Implementation of resource server</span></a>.</p>
<div class="section" id="id22">
<h5><a class="toc-backref" href="#id142">9.9.2.6.2.1. Fetching user information</a><a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h5>
<p>Resource owner information is not stored in Spring Security, for the client credential grant wherein the user authentication is not performed.</p>
<p>Therefore, resource owner information cannot be received even after specifying <code class="docutils literal"><span class="pre">UserDetails</span></code> or <code class="docutils literal"><span class="pre">OAuth2Authentication</span></code> with <code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>annotation as an argument of Controller class, like implementation in authorization code grant.</p>
<p>Alternatively, since client information is retained, <code class="docutils literal"><span class="pre">String</span></code> is specified in the method argument of Controller and client ID can be fetched by assigning <code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code> annotation.</p>
<p>Changes from that of authorization code grant are shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;api&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="o">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;todos&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">list</span><span class="o">(</span><span class="nd">@AuthenticationPrincipal</span> <span class="n">String</span> <span class="n">clientId</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (1)</span>

        <span class="c1">// omitted</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client ID is stored in argument <code class="docutils literal"><span class="pre">clientId</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="implementationoauthclientserverofclientcredentials">
<span id="id23"></span><h4><a class="toc-backref" href="#id143">9.9.2.6.3. Implementation of client</a><a class="headerlink" href="#implementationoauthclientserverofclientcredentials" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code> must be changed from implementation of authorization code grant.</p>
<p>Implementation other than <code class="docutils literal"><span class="pre">oauth2-client.xml</span></code> must be created by referring <a class="reference internal" href="#implementationoauthclientserverofautorizationcode"><span class="std std-ref">Implementation of client</span></a>.</p>
<div class="section" id="id24">
<h5><a class="toc-backref" href="#id144">9.9.2.6.3.1. OAuth2RestTemplate settings</a><a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h5>
<p>A setup example of <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>is shown below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:resource</span> <span class="na">id=</span><span class="s">&quot;todoClientGrantResource&quot;</span> <span class="na">client-id=</span><span class="s">&quot;firstSecClient&quot;</span>
                <span class="na">client-secret=</span><span class="s">&quot;firstSecSecret&quot;</span>
                <span class="na">type=</span><span class="s">&quot;client_credentials&quot;</span>
                <span class="na">access-token-uri=</span><span class="s">&quot;${auth.serverUrl}/oauth/token&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

<span class="nt">&lt;oauth2:rest-template</span> <span class="na">id=</span><span class="s">&quot;todoClientGrantResourceRestTemplate&quot;</span> <span class="na">resource=</span><span class="s">&quot;todoClientGrantResource&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify grant type in <code class="docutils literal"><span class="pre">type</span></code> attribute. Specify <code class="docutils literal"><span class="pre">client_credentials</span></code> in case of client credential grant.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When the issue of access token is requested for authorization server implemented by architecture other than Spring Security OAuth,
it must be noted that the request parameters are likely to be different than those given above.
In that case, architecture specifications should be checked and required request parameters must be set.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthclienterrorhandlingwithclient">
<span id="id25"></span><h5><a class="toc-backref" href="#id145">9.9.2.6.3.2. Error handling</a><a class="headerlink" href="#oauthclienterrorhandlingwithclient" title="Permalink to this headline">¶</a></h5>
<div class="section" id="oauthclienthandleerrorwhenaccessingtokenendpointwithclient">
<span id="id26"></span><h6><a class="toc-backref" href="#id146">9.9.2.6.3.2.1. Error handling while accessing token end point and resource server</a><a class="headerlink" href="#oauthclienthandleerrorwhenaccessingtokenendpointwithclient" title="Permalink to this headline">¶</a></h6>
<p>In the client credential grant, all the errors which occur in token end point and resource server may be handled as system errors.
For errors occurred, refer <a class="reference internal" href="#oauthappendixoccuringerrors"><span class="std std-ref">Errors which occur while accessing authorization server and resource server from the client</span></a>.</p>
</div>
</div>
<div class="section" id="id27">
<h5><a class="toc-backref" href="#id147">9.9.2.6.3.3. Resource owner authentication</a><a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h5>
<p>Since the client acts as a resource owner in the client credential grant, authentication of resource owner as described in <a class="reference internal" href="#oauthauthorizationserverresourceownerauthentication"><span class="std std-ref">Resource owner authentication</span></a> is not required.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-extend">
<span id="oauthhowtoextend"></span><h2><a class="toc-backref" href="#id148">9.9.3. How to extend</a><a class="headerlink" href="#how-to-extend" title="Permalink to this headline">¶</a></h2>
<div class="section" id="when-the-multiple-grant-types-are-supported-in-authorization-server">
<span id="orderofauthoraizationserversupportsetting"></span><h3><a class="toc-backref" href="#id149">9.9.3.1. When the multiple grant types are supported in authorization server</a><a class="headerlink" href="#when-the-multiple-grant-types-are-supported-in-authorization-server" title="Permalink to this headline">¶</a></h3>
<p>As introduced in <a class="reference internal" href="#authorizationgrant"><span class="std std-ref">Authorization grant</span></a>, authorization server can support multiple grant types.</p>
<p>When multiple grant types are to be specified, they are to be set in the order shown in the table below since order of the tags is defined in XML schema.</p>
<p>If these are not set in numerical order, <code class="docutils literal"><span class="pre">org.springframework.beans.factory.xml.XmlBeanDefinitionStoreException</span></code> exception is thrown due to XML interpretation failure at the start of the application.</p>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">Sr. No.</th>
<th class="head">Tags</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">1</th>
<td><cite>&lt;oauth2:authorization-code /&gt;</cite></td>
</tr>
<tr class="row-odd"><th class="stub">2</th>
<td><cite>&lt;oauth2:implicit /&gt;</cite></td>
</tr>
<tr class="row-even"><th class="stub">3</th>
<td><cite>&lt;oauth2:refresh-token /&gt;</cite></td>
</tr>
<tr class="row-odd"><th class="stub">4</th>
<td><cite>&lt;oauth2:client-credentials /&gt;</cite></td>
</tr>
<tr class="row-even"><th class="stub">5</th>
<td><cite>&lt;oauth2:password /&gt;</cite></td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>As an example, setup examples while supporting authorization code grant, resource owner password credential grant and a refresh token are shown below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server&gt;</span>
    <span class="nt">&lt;oauth2:authorization-code</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;oauth2:password</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use <cite>&lt;oauth2:authorization-code /&gt;</cite> tag and support authorization code grant.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use <cite>&lt;oauth2:refresh-token /&gt;</cite> tag and support refresh token.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use <cite>&lt;oauth2:password /&gt;</cite> tag and support resource owner password credential grant.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="linking-authorization-server-and-resource-server-through-http-access">
<span id="oauthauthorizationserverhowtocooperatewithhttp"></span><h3><a class="toc-backref" href="#id150">9.9.3.2. Linking Authorization Server and Resource Server through HTTP access</a><a class="headerlink" href="#linking-authorization-server-and-resource-server-through-http-access" title="Permalink to this headline">¶</a></h3>
<p>The Resource Server and Authorization Server can be linked by performing HTTP access from the Resource Server to the check token endpoint of the Authorization Server.</p>
<p>Check token endpoint is the endpoint that receives the value of access token from the Resource Server and verifies the token instead of the Resource Server.
Check token endpoint fetches and verifies the access token using ``TokenServices``, and passes the information associated with the access token to the Resource Server when there is no problem in the verification.</p>
<p>Note that, check token end point is a unique function of Spring Security OAuth which is not defined in RFC, however,
in this guideline, response is sent in the same format as other end points defined in RFC.</p>
<p>Use <code class="docutils literal"><span class="pre">RemoteTokenServices</span></code> that is the implementation class of `` TokenServices``  for the Resource Server to access the check token endpoint of the Authorization Server.
<code class="docutils literal"><span class="pre">RemoteTokenServices</span></code> performs HTTP access of check token endpoint using <code class="docutils literal"><span class="pre">RestTemplate</span></code> and fetches the information associated with the access token.
Since the access token is verified by the check token endpoint, it is not verified by <code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>.</p>
<p>The implementation example is shown below.</p>
<div class="section" id="setting-authorization-server">
<h4><a class="toc-backref" href="#id151">9.9.3.2.1. Setting authorization server</a><a class="headerlink" href="#setting-authorization-server" title="Permalink to this headline">¶</a></h4>
<p>First, perform the settings for registering <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.endpoint.CheckTokenEndpoint</span></code> class as component for verifying token in the Authorization Server.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span> <span class="na">pattern=</span><span class="s">&quot;/oauth/*token*/**&quot;</span>
    <span class="na">authentication-manager-ref=</span><span class="s">&quot;clientAuthenticationManager&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;sec:http-basic</span> <span class="na">entry-point-ref=</span><span class="s">&quot;oauthAuthenticationEntryPoint&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:csrf</span> <span class="na">disabled=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/**&quot;</span> <span class="na">access=</span><span class="s">&quot;isAuthenticated()&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>

<span class="nt">&lt;oauth2:authorization-server</span>
     <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span>
     <span class="na">user-approval-handler-ref=</span><span class="s">&quot;userApprovalHandler&quot;</span>
     <span class="na">token-services-ref=</span><span class="s">&quot;tokenServices&quot;</span>
     <span class="na">check-token-enabled=</span><span class="s">&quot;true&quot;</span>
     <span class="na">check-token-endpoint-url=</span><span class="s">&quot;/oauth/check-token&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;oauth2:authorization-code</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:implicit</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:client-credentials</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:password</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify a location below <code class="docutils literal"><span class="pre">/oauth/*token*/</span></code>for access control, as an endpoint to perform security settings
for check token endpoint.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">CheckTokenEndpoint</span></code> is registered as a component by specifying <code class="docutils literal"><span class="pre">true</span></code> in <code class="docutils literal"><span class="pre">check-token-enabled</span></code> attribute of <code class="docutils literal"><span class="pre">&lt;oauth2:authorization-server&gt;</span></code>tag.</div>
<div class="line"><code class="docutils literal"><span class="pre">/oauth/check_token</span></code> is set as a check token endpoint.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>Security measures of check token endpoint</strong></p>
<p class="last">Check token end point of authorization server must be accessed only by resource server and it should not be used by any entity other than resource server.
In this guideline, access to check token end point is restricted by Basic authentication, however, if possible, it is recommended to perform higher level access restrictions such as IP restrictions on specific URLs on network.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Use <code class="docutils literal"><span class="pre">DefaultTokenServices</span></code> same when linking  <code class="docutils literal"><span class="pre">TokenServices</span></code> through shared DB.
<code class="docutils literal"><span class="pre">TokenStore</span></code> referred by <code class="docutils literal"><span class="pre">TokenServices</span></code> uses the implementation class of the interface as per the application requirements.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="setting-resource-server">
<h4><a class="toc-backref" href="#id152">9.9.3.2.2. Setting resource server</a><a class="headerlink" href="#setting-resource-server" title="Permalink to this headline">¶</a></h4>
<p>Perform the settings to use <code class="docutils literal"><span class="pre">RemoteTokenServices</span></code> as <code class="docutils literal"><span class="pre">TokenServices</span></code> in the configuration file of the Resource Server.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;tokenServices&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.RemoteTokenServices&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;checkTokenEndpointUrl&quot;</span> <span class="na">value=</span><span class="s">&quot;${auth.serverUrl}/oauth/check-token&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define Bean for <code class="docutils literal"><span class="pre">RemoteTokenServices</span></code> to enable fetching of information associated with the access token by accessing the check token endpoint of the Authorization Server.</div>
<div class="line">Set the URL in <code class="docutils literal"><span class="pre">checkTokenEndpointUrl</span></code> property to access check token endpoint.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set ID to identify resource server in authorization server, in <code class="docutils literal"><span class="pre">clientId</span></code> property.</div>
<div class="line">Set ID is used as a user name for Basic authentication while accessing check token end point.</div>
<div class="line">Client ID to be set must be registered in the client information of authorization server. For registration of client information, refer <a class="reference internal" href="#oauthauthorizationserverclientauthentication"><span class="std std-ref">Client authentication</span></a>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set a password used for authentication of resource server in authorization server, in <code class="docutils literal"><span class="pre">clientSecret</span></code> property.</div>
<div class="line">Set password is used as a password for Basic authentication while accessing check token end point.</div>
<div class="line">Password to be set must match password registered in client information of authorization server.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When verification error of access token occurs in the check token endpoint, HTTP status code 400(Bad Request) is returned in <code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>.
When HTTP status code 400(Bad Request) is returned in the default implementation of <code class="docutils literal"><span class="pre">RestTemplate</span></code>, error handling is done and <code class="docutils literal"><span class="pre">HttpClientErrorException</span></code> is generated.
<code class="docutils literal"><span class="pre">RestTemplate</span></code> to be used by <code class="docutils literal"><span class="pre">RemoteTokenServices</span></code> by default, is extended so that error handling is not performed when HTTP status code of response is 400 in order to link verification error of the access token to the client server.
When <code class="docutils literal"><span class="pre">RestTemplate</span></code> is injected in <code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>, note that this extension will not be applied.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>When <code class="docutils literal"><span class="pre">RemoteTokenServices</span></code> is used in the Resource Server, the username of the resource owner can be fetched by specifying <code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code> annotation in the handler method as the argument annotation in <code class="docutils literal"><span class="pre">String</span></code>.</p>
<p>The implementation example is as follows.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;api&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="o">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;todos&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">list</span><span class="o">(</span><span class="nd">@AuthenticationPrincipal</span> <span class="n">String</span> <span class="n">userName</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (1)</span>

        <span class="c1">// omitted</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Username of resource owner is stored in argument <code class="docutils literal"><span class="pre">userName</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="a-method-to-link-individual-items-to-resource-server">
<span id="oauthauthorizationserverhowtogetotherthanusername"></span><h4><a class="toc-backref" href="#id153">9.9.3.2.3. A method to link individual items to resource server</a><a class="headerlink" href="#a-method-to-link-individual-items-to-resource-server" title="Permalink to this headline">¶</a></h4>
<p>Even in case of the structure where DB is not shared between Authorization Server and Resource Server, there may be a case to link the item corresponding to the user information from the Authorization Server to the Resource Server, however
when <code class="docutils literal"><span class="pre">RemoteTokenServices</span></code> is to be used as <code class="docutils literal"><span class="pre">TokenServices</span></code> by the Resource Server, the information other than the user information cannot be fetched by the annotation <code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>annotation of handler method argument of the Resource Server.</p>
<p>An example of extending <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.DefaultAccessTokenConverter</span></code>that is a class to be used for linking access token by using <code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>and linking the information other than the username to the Resource Server is shown here.</p>
<div class="section" id="defaultaccesstokenconverter-means">
<h5><a class="toc-backref" href="#id154">9.9.3.2.3.1. DefaultAccessTokenConverter means</a><a class="headerlink" href="#defaultaccesstokenconverter-means" title="Permalink to this headline">¶</a></h5>
<p>Request authentication information of resource owner and client of the access token value to the Authorization Server from the Resource Server by using <code class="docutils literal"><span class="pre">RestTemplate</span></code>and fetch the result as <code class="docutils literal"><span class="pre">Map</span></code>for linking access token wherein <code class="docutils literal"><span class="pre">RemoteTokenServices</span></code> is used.
<code class="docutils literal"><span class="pre">DefaultAccessTokenConverter</span></code> is used as a convertor that converts the authentication information in Authorization Server to <code class="docutils literal"><span class="pre">Map</span></code>and <code class="docutils literal"><span class="pre">Map</span></code>in Resource Server to the authentication information.</p>
<p>By using this, the parameters linked between the Authorization Server and the Resource Server can be customized by extending ``DefaultAccessTokenConverter`` so as to add the return value from the Authorization Server to the <code class="docutils literal"><span class="pre">Map</span></code>.</p>
<p>In the following explanation, an example of linking independent items related to user information and independent items other than this to each other by customizing ``DefaultAccessTokenConverter`` and its property <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.DefaultUserAuthenticationConverter</span></code>in the Authorization Server, is shown.</p>
</div>
<div class="section" id="id28">
<h5><a class="toc-backref" href="#id155">9.9.3.2.3.2. Implementation of Authorization Server</a><a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h5>
<p>How to implement Authorization Server is explained.</p>
<p>First, extend <code class="docutils literal"><span class="pre">DefaultUserAuthenticationConverter</span></code> for adding independent item of the user information.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">CustomUserAuthenticationConverter</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomUserAuthenticationConverter</span> <span class="kd">extends</span> <span class="n">DefaultUserAuthenticationConverter</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">convertUserAuthentication</span><span class="o">(</span>
            <span class="n">Authentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">response</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">USERNAME</span><span class="o">,</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">authentication</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                <span class="o">!</span><span class="n">authentication</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">response</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">AUTHORITIES</span><span class="o">,</span> <span class="n">AuthorityUtils</span><span class="o">.</span><span class="na">authorityListToSet</span><span class="o">(</span>
                    <span class="n">authentication</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">()));</span>
        <span class="o">}</span>
        <span class="n">response</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;company_id&quot;</span><span class="o">,</span> <span class="s">&quot;COMZZZ&quot;</span><span class="o">);</span> <span class="c1">// (1)</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define the information to be passed to the Resource Server as an independent item <code class="docutils literal"><span class="pre">company_id</span></code> and set to <code class="docutils literal"><span class="pre">response</span></code>.</div>
<div class="line">The information set in <code class="docutils literal"><span class="pre">response</span></code>, is returned to the Resource Server in JSON format as response BODY at the time of verifying the token of check token endpoint.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Then, extend <code class="docutils literal"><span class="pre">DefaultAccessTokenConverter</span></code> for adding independent item of other than the user information.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">CustomAccessTokenConverter.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomAccessTokenConverter</span> <span class="kd">extends</span> <span class="n">DefaultAccessTokenConverter</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">convertAccessToken</span><span class="o">(</span><span class="n">OAuth2AccessToken</span> <span class="n">token</span><span class="o">,</span> <span class="n">OAuth2Authentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="o">{</span>

        <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unchecked&quot;</span><span class="o">)</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;)</span> <span class="kd">super</span><span class="o">.</span><span class="na">convertAccessToken</span><span class="o">(</span><span class="n">token</span><span class="o">,</span> <span class="n">authentication</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;business_id&quot;</span><span class="o">,</span><span class="s">&quot;BIDXXX&quot;</span><span class="o">);</span> <span class="c1">// (1)</span>
        <span class="c1">// omitted</span>

        <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define the information to be passed to the Resource Server as an independent item <code class="docutils literal"><span class="pre">business_id</span></code> and set to <code class="docutils literal"><span class="pre">response</span></code>.</div>
<div class="line">The information set in <code class="docutils literal"><span class="pre">response</span></code>, is returned to the Resource Server in JSON format as response BODY at the time of verifying the token of check token endpoint.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Perform the settings of <code class="docutils literal"><span class="pre">CustomUserAuthenticationConverter</span></code> and <code class="docutils literal"><span class="pre">CustomAccessTokenConverter</span></code> created in the configuration file of the Authorization Server.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
     <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span>
     <span class="na">user-approval-handler-ref=</span><span class="s">&quot;userApprovalHandler&quot;</span>
     <span class="na">token-services-ref=</span><span class="s">&quot;tokenServices&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;oauth2:authorization-code</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:implicit</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:client-credentials</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:password</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;checkTokenEndpoint&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.endpoint.CheckTokenEndpoint&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;tokenServices&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;accessTokenConverter&quot;</span> <span class="na">ref=</span><span class="s">&quot;accessTokenConverter&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;accessTokenConverter&quot;</span>
    <span class="na">class=</span><span class="s">&quot;com.example.oauth2.auth.converter.CustomAccessTokenConverter&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;userTokenConverter&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;bean</span>
            <span class="na">class=</span><span class="s">&quot;com.example.oauth2.auth.converter.CustomUserAuthenticationConverter&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">check-token-enabled</span></code> attribute of <code class="docutils literal"><span class="pre">&lt;oauth2:authorization-server&gt;</span> <span class="pre">tag</span></code> is not specified since Bean definition of <code class="docutils literal"><span class="pre">CheckTokenEndpoint</span></code> is independently done in (2).</div>
<div class="line"><code class="docutils literal"><span class="pre">/oauth/check_token</span></code> is set as a token check endpoint.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define Bean for <code class="docutils literal"><span class="pre">CheckTokenEndpoint</span></code>.</div>
<div class="line">By specifying Bean of <code class="docutils literal"><span class="pre">CustomAccessTokenConverter</span></code> defined in (3) in <code class="docutils literal"><span class="pre">accessTokenConverter</span></code> property, independent items added in <code class="docutils literal"><span class="pre">CustomAccessTokenConverter</span></code> and <code class="docutils literal"><span class="pre">CustomUserAuthenticationConverter</span></code> can be linked to the Resource Server.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define Bean for <code class="docutils literal"><span class="pre">CustomAccessTokenConverter</span></code> wherein <code class="docutils literal"><span class="pre">DefaultAccessTokenConverter</span></code> is extended.</div>
<div class="line">Specify Bean for <code class="docutils literal"><span class="pre">CustomUserAuthenticationConverter</span></code> wherein <code class="docutils literal"><span class="pre">DefaultUserAuthenticationConverter</span></code> is extended in <code class="docutils literal"><span class="pre">userTokenConverter</span></code> property.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id29">
<h5><a class="toc-backref" href="#id156">9.9.3.2.3.3. Implementation of Resource Server</a><a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h5>
<p>Add the function to fetch the information linked from Authorization Server in the Resource Server by <code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>annotation of the handler method argument.
First, create <code class="docutils literal"><span class="pre">OauthUser</span></code> class holding the information to be fetched by <code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>annotation.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">ResourceOwner.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OauthUser</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">companyId</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">businessId</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">clientId</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="kd">public</span> <span class="nf">OauthUser</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">companyId</span><span class="o">,</span> <span class="n">String</span> <span class="n">businessId</span><span class="o">,</span> <span class="n">String</span> <span class="n">clientId</span><span class="o">){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">username</span> <span class="o">=</span> <span class="n">username</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">companyId</span> <span class="o">=</span> <span class="n">companyId</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">businessId</span> <span class="o">=</span> <span class="n">businessId</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">clientId</span> <span class="o">=</span> <span class="n">clientId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Getters and Setters are omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.DefaultAccessTokenConverter</span></code> which performs setup for enabling fetching of user information by <code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code> annotation is expanded and a function is added to enable fetching of information other than user name.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">CustomUserAuthenticationConverter.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomUserAuthenticationConverter</span> <span class="kd">extends</span> <span class="n">DefaultUserAuthenticationConverter</span><span class="o">{</span>

    <span class="kd">private</span> <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">defaultAuthorities</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDefaultAuthorities</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">defaultAuthorities</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">defaultAuthorities</span> <span class="o">=</span> <span class="n">AuthorityUtils</span><span class="o">.</span><span class="na">commaSeparatedStringToAuthorityList</span><span class="o">(</span><span class="n">StringUtils</span>
                <span class="o">.</span><span class="na">arrayToCommaDelimitedString</span><span class="o">(</span><span class="n">defaultAuthorities</span><span class="o">));</span>
    <span class="o">}</span>

     <span class="c1">// (2)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Authentication</span> <span class="nf">extractAuthentication</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">USERNAME</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span> <span class="o">=</span> <span class="n">getAuthorities</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
            <span class="n">OauthUser</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OauthUser</span><span class="o">(</span>
                    <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">USERNAME</span><span class="o">),</span>
                    <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;company_id&quot;</span><span class="o">),</span>
                    <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;business_id&quot;</span><span class="o">),</span>
                    <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;client_id&quot;</span><span class="o">));</span> <span class="c1">// (3)</span>

            <span class="c1">// omitted</span>

            <span class="k">return</span> <span class="k">new</span> <span class="n">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="s">&quot;N/A&quot;</span><span class="o">,</span> <span class="n">authorities</span><span class="o">);</span> <span class="c1">// (4)</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">map</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">AUTHORITIES</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">defaultAuthorities</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">Object</span> <span class="n">authorities</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">AUTHORITIES</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">authorities</span> <span class="k">instanceof</span> <span class="n">String</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">AuthorityUtils</span><span class="o">.</span><span class="na">commaSeparatedStringToAuthorityList</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">authorities</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">authorities</span> <span class="k">instanceof</span> <span class="n">Collection</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">AuthorityUtils</span><span class="o">.</span><span class="na">commaSeparatedStringToAuthorityList</span><span class="o">(</span><span class="n">StringUtils</span>
                    <span class="o">.</span><span class="na">collectionToCommaDelimitedString</span><span class="o">((</span><span class="n">Collection</span><span class="o">&lt;?&gt;)</span> <span class="n">authorities</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;Authorities must be either a String or a Collection&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Implement <code class="docutils literal"><span class="pre">defaultAuthorities</span></code> used by <code class="docutils literal"><span class="pre">defaultAuthorities</span></code> and <code class="docutils literal"><span class="pre">getAuthorities</span></code> method since <code class="docutils literal"><span class="pre">getAuthorities</span></code> method implemented by <code class="docutils literal"><span class="pre">DefaultUserAuthenticationConverter</span></code> is defined by private.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method that extracts authentication information from the information linked from authorization server.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set information linked from authorization server in <code class="docutils literal"><span class="pre">OauthUser</span></code> class.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Information linked from authorization server can be fetched <code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code> annotation by setting <code class="docutils literal"><span class="pre">OauthUser</span></code> in the first argument of <code class="docutils literal"><span class="pre">UsernamePasswordAuthenticationToken</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Configure <code class="docutils literal"><span class="pre">CustomUserAuthenticationConverter</span></code> in setup file of resource server.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;tokenServices&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.RemoteTokenServices&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;checkTokenEndpointUrl&quot;</span> <span class="na">value=</span><span class="s">&quot;${auth.serverUrl}/oauth/check-token&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;accessTokenConverter&quot;</span> <span class="na">ref=</span><span class="s">&quot;accessTokenConverter&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;accessTokenConverter&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.DefaultAccessTokenConverter&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;userTokenConverter&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;com.example.oauth2.resource.converter.CustomUserAuthenticationConverter&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for <code class="docutils literal"><span class="pre">DefaultAccessTokenConverter</span></code>. Specify <code class="docutils literal"><span class="pre">CustomUserAuthenticationConverter</span></code>class in <code class="docutils literal"><span class="pre">userTokenConverter</span></code>property to enable fetching of information other than user name by <code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>annotation.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="section" id="customization-of-path-in-authorization-server">
<h3><a class="toc-backref" href="#id157">9.9.3.3. Customization of path in authorization server</a><a class="headerlink" href="#customization-of-path-in-authorization-server" title="Permalink to this headline">¶</a></h3>
<p>Authorization server can change the path for the end point and forwarding destination when a specific situation occur.
This section explains path for authorization server, and how to change the settings of related places.</p>
<div class="section" id="customizable-path">
<span id="customizableurl"></span><h4><a class="toc-backref" href="#id158">9.9.3.3.1. Customizable path</a><a class="headerlink" href="#customizable-path" title="Permalink to this headline">¶</a></h4>
<p>As explained in How to use, end point in conformance with RFC and Controller for processing a request forwarded in authorization server are registered as components
by performing definition using <code class="docutils literal"><span class="pre">&lt;oauth2:authorization-server&gt;</span></code>tag in the authorization server.
Also, the endpoints published by authorization server to client and resource server can be customized by changing
attribute value of &lt;oauth2:authorization-server&gt; tag.</p>
<p>Below, endpoints registered as components, and default path of forwarding destination and
attribute value of &lt;oauth2:authorization-server&gt; tag changed while customizing the endpoint are shown.</p>
<table border="1" class="colwidths-given longtable docutils" id="id55">
<caption><span class="caption-text"><strong>Endpoints</strong></span><a class="headerlink" href="#id55" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="20%" />
<col width="20%" />
<col width="20%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Attribute value</th>
<th class="head">Default path</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">Authorization endpoint</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">authorization-endpoint-url</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">/oauth/authorized</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Endpoint used by client to fetch authorization from resource owner.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">Token endpoint</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">token-endpoint-url</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">/oauth/token</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Endpoint used by client to issue an access token.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">Check token endpoint</div>
<div class="line">(It is set only for implementation of <a class="reference internal" href="#oauthauthorizationserverhowtocooperatewithhttp"><span class="std std-ref">Linking Authorization Server and Resource Server through HTTP access</span></a>.)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">check-token-endpoint-url</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">/oauth/check_token</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Endpoint used by resource server to verify access token.</div>
<div class="line">It is used to link access tokens through HTTP access. Further, this endpoint</div>
<div class="line">is not an endpoint defined by RFC, but an endpoint independently expanded by Spring Security OAuth.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id56">
<caption><span class="caption-text"><strong>Forwarding destination</strong></span><a class="headerlink" href="#id56" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="20%" />
<col width="20%" />
<col width="20%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Attribute value</th>
<th class="head">Default path</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">Forward destination for fetching authorization</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">user-approval-page</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">/oauth/confirm_access</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Forwarding destination used for returning authorization screen to resource owner.</div>
<div class="line">It is a path used in the authorization server process, and is not published for client or resource server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">Forwarding destination when an unauthorized client error occurs</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">error-page</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">/oauth/error</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Forward destination to use for notifying an error in the authorization endpoint to resource owner.</div>
<div class="line">It is a path used in the authorization server process, and is not published for client or resource server.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>These paths can be customized by changing the setting on the authorization server side.
A specific setting method is shown below.</p>
</div>
<div class="section" id="customization-of-path">
<span id="customizepath"></span><h4><a class="toc-backref" href="#id159">9.9.3.3.2. Customization of path</a><a class="headerlink" href="#customization-of-path" title="Permalink to this headline">¶</a></h4>
<div class="section" id="customization-of-end-point">
<span id="customizeendpoint"></span><h5><a class="toc-backref" href="#id160">9.9.3.3.2.1. Customization of end point</a><a class="headerlink" href="#customization-of-end-point" title="Permalink to this headline">¶</a></h5>
<p>As described above, each endpoint can be customized by changing the attribute value of &lt;oauth2:authorization-server&gt; tag.</p>
<p>Implementation example while changing endpoint is shown below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
    <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span>
    <span class="na">user-approval-handler-ref=</span><span class="s">&quot;userApprovalHandler&quot;</span>
    <span class="na">token-services-ref=</span><span class="s">&quot;tokenServices&quot;</span>
    <span class="na">token-endpoint-url=</span><span class="s">&quot;/api/token&quot;</span>
    <span class="na">authorization-endpoint-url=</span><span class="s">&quot;/api/authorize&quot;</span>
    <span class="na">check-token-endpoint-url=</span><span class="s">&quot;/api/check_token&quot;</span>
    <span class="na">check-token-enabled=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>

<span class="nt">&lt;sec:http</span> <span class="na">pattern=</span><span class="s">&quot;/api/*token*/**&quot;</span>
    <span class="na">authentication-manager-ref=</span><span class="s">&quot;clientAuthenticationManager&quot;</span> <span class="na">realm=</span><span class="s">&quot;Realm&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set URL in attribute value (<code class="docutils literal"><span class="pre">authorization-endpoint-url</span></code>,
<code class="docutils literal"><span class="pre">token-endpoint-url</span></code> and <code class="docutils literal"><span class="pre">check-token-endpoint-url</span></code> or endpoints of <code class="docutils literal"><span class="pre">&lt;oauth2:authorization-server&gt;</span></code> tag to be changed</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Change the target for access control so that it includes URL of endpoint related to access token operations.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Settings to refer endpoints must be changed in accordance with the endpoints to be changed.
In authorization server, refer endpoint settings of <code class="docutils literal"><span class="pre">spring-security.xml</span></code>of <a class="reference internal" href="#oauthauthorizationserverresourceownerauthentication"><span class="std std-ref">Resource owner authentication</span></a>and
<code class="docutils literal"><span class="pre">oauthConfirm.jsp</span></code>of <a class="reference internal" href="#oauthauthorizationserverhowtocustomizeauthorizeview"><span class="std std-ref">Customising scope authorization screen</span></a>.</p>
<p>Also, when the client implementation is being performed, <code class="docutils literal"><span class="pre">oauth2-client.xml</span></code>of <a class="reference internal" href="#oauth2resttemplatesettings"><span class="std std-ref">Settings of OAuth2RestTemplate</span></a>should also be referred since
the endpoint of the authorization server is set as the setting of authorization request.</p>
</div>
<div class="section" id="customize-forwarding-destination">
<span id="customizeforward"></span><h5><a class="toc-backref" href="#id161">9.9.3.3.2.2. Customize forwarding destination</a><a class="headerlink" href="#customize-forwarding-destination" title="Permalink to this headline">¶</a></h5>
<p>While fetching authorization from resource owner, it is forwarded to <code class="docutils literal"><span class="pre">/oauth/confirm_access</span></code>in the default setting.
Also, when an unauthorized error client error occurs at the authorization endpoint, it is forwarded to <code class="docutils literal"><span class="pre">/oauth/error</span></code>in default setting.
These forward destinations can be changed.</p>
<p>An implementation example while changing the forwarding destination is shown below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
    <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span>
    <span class="na">user-approval-handler-ref=</span><span class="s">&quot;userApprovalHandler&quot;</span>
    <span class="na">token-services-ref=</span><span class="s">&quot;tokenServices&quot;</span>
    <span class="na">error-page=</span><span class="s">&quot;forward:/api/error&quot;</span>
    <span class="na">user-approval-page=</span><span class="s">&quot;forward:/api/confirm_access&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set URL in attribute value for the forwarding destination of <code class="docutils literal"><span class="pre">&lt;oauth2:authorization-server&gt;</span></code>tag (<code class="docutils literal"><span class="pre">error-page</span></code>or <code class="docutils literal"><span class="pre">user-approval-page</span></code>).
URL to be set must be assigned a prefix <code class="docutils literal"><span class="pre">forward:</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>It must be noted that while changing the forward destination, change must be done in the corresponding controller as well.
Refer following in the implementation example.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">OAuth2ApprovalController.java</span></code>of <a class="reference internal" href="#oauthauthorizationserverhowtocustomizeauthorizeview"><span class="std std-ref">Customising scope authorization screen</span></a></li>
<li><code class="docutils literal"><span class="pre">OAuth2ErrorController.java</span></code>of <a class="reference internal" href="#oauthauthorizationserverhowtohandleerror"><span class="std std-ref">Error handling at the time of authorization request</span></a></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="appendix">
<span id="oauthappendix"></span><h2><a class="toc-backref" href="#id162">9.9.4. Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this headline">¶</a></h2>
<div class="section" id="errors-which-occur-while-accessing-authorization-server-and-resource-server-from-the-client">
<span id="oauthappendixoccuringerrors"></span><h3><a class="toc-backref" href="#id163">9.9.4.1. Errors which occur while accessing authorization server and resource server from the client</a><a class="headerlink" href="#errors-which-occur-while-accessing-authorization-server-and-resource-server-from-the-client" title="Permalink to this headline">¶</a></h3>
<p>In this guideline, methods of handling for errors which occur due to resource owner operations are described for the errors which occur while accessing authorization server and resource server from the client.
The errors that occur along with errors which are caused by resource owner operations are explained.</p>
<div class="section" id="errors-which-occur-at-authorization-end-point">
<h4><a class="toc-backref" href="#id164">9.9.4.1.1. Errors which occur at authorization end point</a><a class="headerlink" href="#errors-which-occur-at-authorization-end-point" title="Permalink to this headline">¶</a></h4>
<p>Errors which occur at authorization end point are classified as unauthorized client error and other errors, when an unauthorized client error occurs, error is notified by forwarding to error screen in authorization server.
For details of unauthorized error, refer <a class="reference internal" href="#definitionofbadclienterror"><span class="std std-ref">Unauthorized client error</span></a>.
Bad client error which occurs at authorization end point is explained below.</p>
<table border="1" class="colwidths-given longtable docutils" id="id57">
<caption><span class="caption-text"><strong>Bad client error which occur at the authorization end point</strong></span><a class="headerlink" href="#id57" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Errors occurred</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client does not exist error</div>
<div class="line"><code class="docutils literal"><span class="pre">NoSuchClientException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It occurs when the client who has made user agent access the authorization server is not registered in the client information retained by authorization server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Redirect URI mismatch error</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.common.exceptions.RedirectMismatchException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It occurs when host and root path of redirect URI which is sent as a parameter to authorization server by the client do not match with redirect URI registered in the authorization server.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>When the error occurred is other than bad client error, error information (<code class="docutils literal"><span class="pre">error</span></code>, <code class="docutils literal"><span class="pre">error_description</span></code>) is notified to the client as a request parameter and restored to the exception in <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>and is thrown.
Errors other than bad client error which occur at authorization end point are explained.</p>
<table border="1" class="colwidths-given longtable docutils" id="id58">
<caption><span class="caption-text"><strong>Errors other than bad client error which occur at authorization end point</strong></span><a class="headerlink" href="#id58" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Errors occurred</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Scope verification error</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.common.exceptions.InvalidScopeException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It occurs when scope specified by the client does not exist in the client information retained by authorization server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource verification error</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.common.exceptions.InvalidRequestException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It occurs when redirect URI which indicates transition destination after authorization is not set or when authorization is done without displaying authorization screen.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Response type error</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.common.exceptions.UnsupportedResponseTypeException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It occurs when <code class="docutils literal"><span class="pre">response_type</span></code>parameter specified by the client is not supported by authorization server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Grant type error</div>
<div class="line"><code class="docutils literal"><span class="pre">InvalidGrantException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It occurs when a grant type that can be used by the client does not exist or when grant types other than authorization code grant and implicit grant which cannot be used by redirect URI are specified.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authorization denied for resource owner</div>
<div class="line"><code class="docutils literal"><span class="pre">UserDeniedAuthorizationException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It occurs when resource owner rejects all the scopes specified by client, in the scope authorization screen.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource owner authentication error</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.authentication.InsufficientAuthenticationException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It occurs when the resource owner does not authenticate user while accessing authorization end point. It does not occur when appropriate security settings are done on the authorization server.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="errors-which-occur-at-token-end-point">
<h4><a class="toc-backref" href="#id165">9.9.4.1.2. Errors which occur at token end point</a><a class="headerlink" href="#errors-which-occur-at-token-end-point" title="Permalink to this headline">¶</a></h4>
<p>When an error occurs at token end point, it is wrapped in <code class="docutils literal"><span class="pre">OAuth2AccessDeniedException</span></code>by <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>of client.
Errors which occur at token end point are explained below.</p>
<table border="1" class="colwidths-given longtable docutils" id="id59">
<caption><span class="caption-text"><strong>Errors which occur at token end point</strong></span><a class="headerlink" href="#id59" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Errors occurred</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Basic authentication error</div>
<div class="line"><code class="docutils literal"><span class="pre">HttpClientErrorException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It occurs when Basic authentication of client fails.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client authentication error</div>
<div class="line"><code class="docutils literal"><span class="pre">InsufficientAuthenticationException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It occurs when authentication is not done before token end point process. It does not occur when appropriate security settings are done on the authorization server.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Scope verification error</div>
<div class="line"><code class="docutils literal"><span class="pre">InvalidScopeException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It occurs when the scope specified by the client does not exist in the client information retained by authorization server.</div>
<div class="line">It does not occur if <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>is used since it occurs as an error at authorization end point while using authorization code grant.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource owner authentication error</div>
<div class="line"><code class="docutils literal"><span class="pre">InvalidGrantException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It occurs when an error is detected in authentication information of resource owner submitted while using resource owner password credential grant.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">“Authorization code does not exist” error</div>
<div class="line"><code class="docutils literal"><span class="pre">InvalidGrantException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It occurs when authorization code passed to the authorization server from the client does not exist in authorization server, while using authorization code grant.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>In this guideline, it is assumed that <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>of Spring Security OAuth is used as a client,
<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>consists of a structure so that error does not occur for the settings are managed automatically.
Errors which occur when <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>of Spring Security OAuth is not used are explained below, for developing a client without using Spring Security OAuth.</p>
<table border="1" class="colwidths-given longtable docutils" id="id60">
<caption><span class="caption-text"><strong>[Reference] Errors which occur at token end point (when OAuth2RestTemplate is not used)</strong></span><a class="headerlink" href="#id60" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Errors occurred</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client verification error</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.common.exceptions.InvalidClientException</span></code></div>
</div>
</td>
<td><div class="first line-block">
<div class="line">It occurs when authenticated client and the client set in request parameter do not match.</div>
<div class="line">Basically, it occurs when client ID of client authenticated at token end point and the following client ID do not match.</div>
</div>
<ul class="last simple">
<li>Client ID set in request parameter of authorization request</li>
<li>Client ID set in request parameter of access token request</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Grant type error</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.common.exceptions.UnsupportedGrantTypeException</span></code></div>
</div>
</td>
<td><div class="first line-block">
<div class="line">It occurs when an error is detected in <code class="docutils literal"><span class="pre">grant_type</span></code>parameter specified in request to token end point.</div>
</div>
<ul class="last simple">
<li>When the grant type specified by the client is a grant type not supported by authorization server</li>
<li>When refresh token is used in the authorization server where a refresh token is not supported</li>
</ul>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Request verification error</div>
<div class="line"><code class="docutils literal"><span class="pre">InvalidRequestException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It occurs when <code class="docutils literal"><span class="pre">grant_type</span></code>parameter does not exist in the request to token end point.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Redirect URI verification error</div>
<div class="line"><code class="docutils literal"><span class="pre">RedirectMismatchException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It occurs when redirect URI used while accessing authorization end point and redirect URI set in the parameter while accessing token end point do not match.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="errors-which-occur-in-resource-server">
<h4><a class="toc-backref" href="#id166">9.9.4.1.3. Errors which occur in resource server</a><a class="headerlink" href="#errors-which-occur-in-resource-server" title="Permalink to this headline">¶</a></h4>
<p>When an error occurs in the resource server, processing of <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>of the client varies depending on errors occurred.
Errors which occur in resource server are explained below.</p>
<table border="1" class="colwidths-given longtable docutils" id="id61">
<caption><span class="caption-text"><strong>Errors which occur in resource server</strong></span><a class="headerlink" href="#id61" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Errors occurred</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Scope verification error</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.common.exceptions.InsufficientScopeException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It occurs when the scope required for accessing a protected resource does not exist in the scope retained by access token.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource ID verification error</div>
<div class="line"><code class="docutils literal"><span class="pre">UserDeniedAuthorizationException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It occurs when resource ID required for accessing a protected resource does not exist in resource ID of client information associated with access token.</div>
<div class="line">It is wrapped in <code class="docutils literal"><span class="pre">OAuth2AccessDeniedException</span></code>by <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>of the client.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Access token verification error</div>
<div class="line"><code class="docutils literal"><span class="pre">InvalidTokenException</span></code></div>
</div>
</td>
<td><div class="first line-block">
<div class="line">It occurs when validity of access token received from resource server could not be verified (abnormal system) or when access token has expired (normal system).</div>
<div class="line"><br /></div>
<div class="line">Since access token error is a combination of normal and abnormal systems, if you receive this error when not using implicit grant <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>, it is necessary to determine whether the access token has expired.</div>
<div class="line">For basic implementation example, refer <a class="reference internal" href="#oauthclientusingjavascript"><span class="std std-ref">Accessing a resource server which uses JavaScript</span></a>.</div>
</div>
<div class="last admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In this guideline, <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>is used for grant types other than implicit grant.
<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>checks the expiry of access token before accessing a resource server and reissues an access token when it is expired,
hence, access token expiry usually does not happen in the resource server.
Since <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>consists of a structure wherein resource server is accessed immediately after fetching access token, if the access token expires on resource server immediately after fetching even though it is within expiry of <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>,
a problem occurs for issuing of access token. In such a case, <code class="docutils literal"><span class="pre">AccessTokenRequiredException</span></code>is thrown in <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>.</p>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Check token end point Basic authentication error</div>
<div class="line"><code class="docutils literal"><span class="pre">HttpClientErrorException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It occurs when Basic authentication fails while accessing check token end point, in <a class="reference internal" href="#oauthauthorizationserverhowtocooperatewithhttp"><span class="std std-ref">Linking Authorization Server and Resource Server through HTTP access</span></a>.</div>
<div class="line">When error handling is to be performed at the client, error handling must be done at resource server so that resource server returns an appropriate error to the client.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="regarding-spring-security-oauth-extension">
<h3><a class="toc-backref" href="#id167">9.9.4.2. Regarding Spring Security OAuth extension</a><a class="headerlink" href="#regarding-spring-security-oauth-extension" title="Permalink to this headline">¶</a></h3>
<p>Extension specifications of OAuth2.0 are listed in <a class="reference external" href="https://tools.ietf.org/html/rfc6749#section-8">8. Extensibility</a>of RFC 6749.
Applications which provide authorization functions with OAuth 2.0 can be customised based on these.</p>
<p>Although Spring Security OAuth does not explicitly publish how to support extension points specified in RFC 6749 described earlier,
following extension points are supported.</p>
<ul class="simple">
<li><a class="reference external" href="https://tools.ietf.org/html/rfc6749#section-8.1">8.1 Defining Access Token Types</a></li>
<li><a class="reference external" href="https://tools.ietf.org/html/rfc6749#section-8.2">8.2 Defining New Endpoint Parameters</a></li>
<li><a class="reference external" href="https://tools.ietf.org/html/rfc6749#section-8.3">8.3 Defining New Authorization Grant Types</a></li>
</ul>
<p>This section particularly explains main components and process flow of extension points for access token and its response
related to <a class="reference external" href="https://tools.ietf.org/html/rfc6749#section-8.2">8.2 Defining New Endpoint Parameters</a>.</p>
<div class="section" id="extension-of-access-token-request-and-its-response">
<h4><a class="toc-backref" href="#id168">9.9.4.2.1. Extension of access token request and its response</a><a class="headerlink" href="#extension-of-access-token-request-and-its-response" title="Permalink to this headline">¶</a></h4>
<dl class="docutils">
<dt>Any parameter or header can be assigned to a request and its response as an extension point</dt>
<dd>for access token request and its response.</dd>
</dl>
<p>However, as described earlier, extension points are not provided in the authorization request.
Therefore, for example, when independent parameters are to be added in the authorization request,
it must be noted that Spring Security OAuth API itself must be upgraded which requires a fairly large upgrade.</p>
<div class="section" id="oauthappendixclient">
<span id="id31"></span><h5><a class="toc-backref" href="#id169">9.9.4.2.1.1. Client</a><a class="headerlink" href="#oauthappendixclient" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal"><span class="pre">RequestEnhancer</span></code>interface is provided in the client as an extension
point of access token request.
Main components and related diagrams for extension points are shown below.</p>
<table border="1" class="colwidths-given longtable docutils" id="id62">
<caption><span class="caption-text"><strong>Main components of client</strong></span><a class="headerlink" href="#id62" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Class, interface name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A class which extends <code class="docutils literal"><span class="pre">RestTemplate</span></code>and adds OAuth 2.0 functions.</div>
<div class="line">It consists of OAuth 2.0 specific functions such as fetching access token according to grant type.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2ProtectedResourceDetails</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">An interface of detail information to access a resource retained by resource server.</div>
<div class="line">Derived classes are provided to retain parameters corresponding to grant type, <code class="docutils literal"><span class="pre">AuthorizationCodeResourceDetails</span></code>is the implementation class for authorized code grant.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AccessTokenProvider</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">An interface which provides a function to fetch access tokens from authorization server.</div>
<div class="line">Derived classes are provided according to the grant type, and providers for each grant type implements
<code class="docutils literal"><span class="pre">AccessTokenProvider</span></code>and inherits <code class="docutils literal"><span class="pre">OAuth2AccessTokenSupport</span></code>.</div>
<div class="line">In case of authorization code grant, <code class="docutils literal"><span class="pre">AuthorizationCodeAccessTokenProvider</span></code>is the implementation class.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2AccessTokenSupport</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A base class which provides a function to fetch access token from authorization server.</div>
<div class="line">It provides a function to send access token request for authorization server, as a common process for grant types.</div>
<div class="line"><code class="docutils literal"><span class="pre">ClientAuthenticationHandler</span></code>and <code class="docutils literal"><span class="pre">RequestEnhancer</span></code>described later are used for generation of access token request.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthorizationCodeAccessTokenProvider</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A class which provides a function to fetch access token, in authorization code grant.</div>
<div class="line">It provides a function to create an authorization request, as a unique process of authorization code grant.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ClientAuthenticationHandler</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">An interface which provides a function to set client authentication information in header or form based on <code class="docutils literal"><span class="pre">OAuth2ProtectedResourceDetails</span></code>.
<code class="docutils literal"><span class="pre">DefaultClientAuthenticationHandler</span></code>is a default implementation class.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RequestEnhancer</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">An interface which provides a function to set parameters in header or form based on access token request
and <code class="docutils literal"><span class="pre">OAuth2ProtectedResourceDetails</span></code>.
<code class="docutils literal"><span class="pre">DefaultRequestEnhancer</span></code>is a default implementation class.</div>
<div class="line"><strong>One of the extension points in access token request.</strong></div>
<div class="line"><br /></div>
<div class="line">Note that, when you want to add unique items to request parameters, only the Bean definition of <code class="docutils literal"><span class="pre">DefaultRequestEnhancer</span></code>used as a default is required to be changed
and it is not necessary to create an implementation class of <code class="docutils literal"><span class="pre">RequestEnhancer</span></code>independently.</div>
<div class="line"><br /></div>
<div class="line">Basically, a Bean definition should be done as shown below.</div>
<div class="line"><br /></div>
<div class="line">(1) <code class="docutils literal"><span class="pre">DefaultRequestEnhancer</span></code></div>
<div class="line-block">
<div class="line">Set a key value in parameter which is to be added to <code class="docutils literal"><span class="pre">parameterIncludes</span></code>attribute.</div>
</div>
<div class="line">(2) <code class="docutils literal"><span class="pre">AuthorizationCodeAccessTokenProvider</span></code></div>
<div class="line-block">
<div class="line">Set <code class="docutils literal"><span class="pre">DefaultRequestEnhancer</span></code>of (1) in <code class="docutils literal"><span class="pre">tokenRequestEnhancer</span></code>attribute</div>
</div>
<div class="line">(3) <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code></div>
<div class="line-block">
<div class="line">Set <code class="docutils literal"><span class="pre">AuthorizationCodeAccessTokenProvider</span></code>of (2) in <code class="docutils literal"><span class="pre">access-token-provider</span></code>attribute.</div>
</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>As an example, flow for accessing a client from resource in the authorization code grant is shown below.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ClientAccessTokenRequest.png"><img alt="../_images/OAuth_ClientAccessTokenRequest.png" src="../_images/OAuth_ClientAccessTokenRequest.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id63">
<caption><span class="caption-text"><strong>Working of client (access token request)</strong></span><a class="headerlink" href="#id63" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client side process is started by calling <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>, while accessing a resource retained by the resource server.</div>
<div class="line">For flow till issue of authorization code on client side, refer <a class="reference internal" href="#client"><span class="std std-ref">Client</span></a>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">After issuing authorization code, <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>is called once again by redirecting to authorization server.
At that time, authorization code is retained in the session (<code class="docutils literal"><span class="pre">OAuth2ClientContext</span></code>).</div>
<div class="line"><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>calls <code class="docutils literal"><span class="pre">AccessTokenProvider</span></code>corresponding to grant type defined in <code class="docutils literal"><span class="pre">OAuth2ProtectedResourceDetails</span></code>.</div>
<div class="line"><code class="docutils literal"><span class="pre">AuthorizationCodeAccessTokenProvider</span></code>is called as an implementation class of <code class="docutils literal"><span class="pre">AccessTokenProvider</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In <code class="docutils literal"><span class="pre">AuthorizationCodeAccessTokenProvider</span></code>, client information from <code class="docutils literal"><span class="pre">ClientAuthenticationHandler</span></code>retained by <code class="docutils literal"><span class="pre">OAuth2AccessTokenSupport</span></code>, and
request parameter from <code class="docutils literal"><span class="pre">RequestEnhancer</span></code>are set in header or form, and access token request is created.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2AccessTokenSupport</span></code>uses the request created in (3) and sends access token request for the authorization server.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In authorization server, client is authenticated and validity of authorization grant is verified.</div>
<div class="line">When authorization grant is valid, access token is issued.</div>
<div class="line">For flow of issue of access token, refer <a class="reference internal" href="#issueofaccesstoken"><span class="std std-ref">Issue of access token</span></a>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AccessTokenProvider</span></code>returns the fetched access token to <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>.</div>
<div class="line"><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>retains the access token in the session (<code class="docutils literal"><span class="pre">OAuth2ClientContext</span></code>) and uses it to send the request for the resource server.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthappendixauthorizationserver">
<span id="id32"></span><h5><a class="toc-backref" href="#id170">9.9.4.2.1.2. Authorization server</a><a class="headerlink" href="#oauthappendixauthorizationserver" title="Permalink to this headline">¶</a></h5>
<p>In authorization server, <code class="docutils literal"><span class="pre">TokenEnhancer</span></code>interface is provided as an extension point
of access token response.
Main components related to extension points, and related diagrams are shown below.</p>
<table border="1" class="colwidths-given longtable docutils" id="id64">
<caption><span class="caption-text"><strong>Main components of authorization server</strong></span><a class="headerlink" href="#id64" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Class, interface name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AbstractEndpoint</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A base class which provides a common function of the end point receiving a request from the client, in the authorization server.
<code class="docutils literal"><span class="pre">TokenEndpoint</span></code>is the implementation class.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">TokenEndpoint</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A class which provides a function of endpoint for issuing access token, for a request from the client.</div>
<div class="line">It consists of a function to verify client, and parameters included in the request parameter.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ClientDetailsService</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">An interface which provides a function to verify client using OAuth 2.0 function.</div>
<div class="line">Derived classes are provided for each medium which manages client information, and <code class="docutils literal"><span class="pre">JdbcClientDetailsService</span></code>and <code class="docutils literal"><span class="pre">InMemoryClientDetailsService</span></code>are implementation classes.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">TokenGranter</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">An interface which provides a function to issue access token.</div>
<div class="line">Derived classes are provided corresponding to grant type. Provider for each grant always implements <code class="docutils literal"><span class="pre">TokenGranter</span></code>and inherits <code class="docutils literal"><span class="pre">AbstractTokenGranter</span></code>.</div>
<div class="line">In case of authorization code grant, <code class="docutils literal"><span class="pre">AuthorizationCodeTokenGranter</span></code>is the implementation class.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AbstractTokenGranter</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A base class which provides a function to issue access token.</div>
<div class="line">It consists of a function which fetches client information from request parameter, and verifies the grant type and calls inherent processing.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthorizationCodeTokenGranter</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A class which provides a function to issue access token in authorization code grant.</div>
<div class="line">It provides a function to verify authorization code and redirect URI included in access token request, as a process unique to authorization code grant.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthorizationCodeServices</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">An interface which provides a function to issue and manage authorization code, in authorization code grant.</div>
<div class="line">Derived classes are provided for each medium which manages authorization code, and <code class="docutils literal"><span class="pre">JdbcAuthorizationServerTokenServices</span></code>and <code class="docutils literal"><span class="pre">InMemoryAuthorizationServerTokenServices</span></code>are implementation classes.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">An interface which provides a function to issue access token and refresh token, required for authorization server. <code class="docutils literal"><span class="pre">DefaultTokenServices</span></code>is the default implementation class.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">TokenEnhancer</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">An interface which provides a function to assign additional information to the token generated by <code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code>.</div>
<div class="line">By extending this interface, it is possible to assign unique parameters to the information managed as access token, and the information returned to the client.</div>
<div class="line"><strong>One of the extension points in access token response.</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">TokenStore</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">An interface which provides a function to manage access token.</div>
<div class="line">Derived classes are provided for each medium which manages access token, and <code class="docutils literal"><span class="pre">JdbcTokenStore</span></code>are <code class="docutils literal"><span class="pre">InMemoryTokenStore</span></code>implementation classes.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>As an example, flow of accessing token end point of authorization server, in authorization code grant is shown below.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_AutohrizationServerAccessTokenResponse.png"><img alt="../_images/OAuth_AutohrizationServerAccessTokenResponse.png" src="../_images/OAuth_AutohrizationServerAccessTokenResponse.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id65">
<caption><span class="caption-text"><strong>Working of authorization server (access token response)</strong></span><a class="headerlink" href="#id65" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Process on authorization server side is started by calling <code class="docutils literal"><span class="pre">TokenEndpoint</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ClientDetailsService</span></code>retained by <code class="docutils literal"><span class="pre">AbstractEndpoint</span></code>is called in <code class="docutils literal"><span class="pre">TokenEndpoint</span></code>and is included in the access token request.
<code class="docutils literal"><span class="pre">TokenGranter</span></code>is called after verifying client information and parameter.</div>
<div class="line"><code class="docutils literal"><span class="pre">AuthorizationCodeTokenGranter</span></code>is the implementation class of <code class="docutils literal"><span class="pre">TokenGranter</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In <code class="docutils literal"><span class="pre">TokenGranter</span></code>, process of <code class="docutils literal"><span class="pre">AbstractTokenGranter</span></code>- a base class is carried out at first.</div>
<div class="line">In <code class="docutils literal"><span class="pre">AbstractTokenGranter</span></code>, client information specified in request parameter by calling <code class="docutils literal"><span class="pre">ClientDetailsService</span></code>is fetched,
and after verification of grant, grant type specific process (<code class="docutils literal"><span class="pre">AuthorizationCodeTokenGranter</span></code>) is called.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In <code class="docutils literal"><span class="pre">AuthorizationCodeTokenGranter</span></code>, <code class="docutils literal"><span class="pre">AuthorizationCodeServices</span></code>is called by specifying authorization code fetched from request parameter, information at the time of authorization request is fetched along with deletion of issued authorization code.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In <code class="docutils literal"><span class="pre">AuthorizationCodeServices</span></code>, client ID specified as a access token request parameter of authorization code grant, redirect URI and authorization request details fetched in (4) are compared and access token request validity is verified.</div>
<div class="line">If there are no problems in the verification results, authentication information is created from request parameter and authentication information of resource owner (user name etc.) fetched while requesting authorization and returned to the caller.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A process for fetching access token of <code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code>is called in <code class="docutils literal"><span class="pre">AbstractTokenGranter</span></code>.</div>
<div class="line"><code class="docutils literal"><span class="pre">DefaultTokenServices</span></code>is the implementation class of <code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Access token is created in <code class="docutils literal"><span class="pre">DefaultTokenServices</span></code>.</div>
<div class="line">When <code class="docutils literal"><span class="pre">TokenEnhancer</span></code>is specified, access token can be extended and additional parameters can be added.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">TokenStore</span></code>is called, access token created in (7) is registered along with authentication information created in (5) and the access token is returned <code class="docutils literal"><span class="pre">TokenEndpoint</span></code>for calling.</div>
<div class="line">A response is created in <code class="docutils literal"><span class="pre">TokenEndpoint</span></code>based on access token created in (7) and a response is sent for the request.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="SecureLoginDemo.html" title="9.10. Implementation Example of Typical Security Requirements"
             >next</a> |</li>
        <li class="right" >
          <a href="Encryption.html" title="9.8. Encryption"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.4.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >9. Security countermeasures</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer">
      © Copyright 2013-2018, NTT DATA Corporation. © Copyright 2013-2018, NTT Corporation.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3.Theme is <a href="http://github.com/vimalkvn/solar-theme">Solar</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>

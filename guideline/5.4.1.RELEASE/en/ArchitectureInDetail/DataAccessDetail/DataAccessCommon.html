<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>6.1. Database Access (Common) &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.4.1.RELEASE documentation</title>
    <link rel="stylesheet" href="../../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '5.4.1.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="6.2. Database Access (MyBatis3)" href="DataAccessMyBatis3.html" />
    <link rel="prev" title="6. Data Access" href="index.html" /><script src="../../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../../_static/solarized-dark.css" rel="stylesheet">
<link href="../../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="DataAccessMyBatis3.html" title="6.2. Database Access (MyBatis3)"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="6. Data Access"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.4.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">6. Data Access</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">6.1. Database Access (Common)</a><ul>
<li><a class="reference internal" href="#overview">6.1.1. Overview</a><ul>
<li><a class="reference internal" href="#about-jdbc-datasource">6.1.1.1. About JDBC DataSource</a><ul>
<li><a class="reference internal" href="#jdbc-datasource-provided-by-application-server">6.1.1.1.1. JDBC datasource provided by Application Server</a></li>
<li><a class="reference internal" href="#jdbc-datasource-provided-by-oss-third-party-library">6.1.1.1.2. JDBC datasource provided by OSS/Third-Party library</a></li>
<li><a class="reference internal" href="#jdbc-datasource-provided-by-spring-framework">6.1.1.1.3. JDBC datasource provided by Spring Framework</a></li>
</ul>
</li>
<li><a class="reference internal" href="#about-transaction-management">6.1.1.2. About transaction management</a></li>
<li><a class="reference internal" href="#about-declaration-of-transaction-boundary-attribute">6.1.1.3. About declaration of transaction boundary/attribute</a></li>
<li><a class="reference internal" href="#about-exclusion-control-of-data">6.1.1.4. About exclusion control of data</a></li>
<li><a class="reference internal" href="#about-exception-handling">6.1.1.5. About exception handling</a></li>
<li><a class="reference internal" href="#about-multiple-datasources">6.1.1.6. About multiple datasources</a></li>
<li><a class="reference internal" href="#about-common-library-classes">6.1.1.7. About common library classes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">6.1.2. How to use</a><ul>
<li><a class="reference internal" href="#datasource-settings">6.1.2.1. Datasource settings</a><ul>
<li><a class="reference internal" href="#settings-when-using-datasource-defined-in-application-server">6.1.2.1.1. Settings when using DataSource defined in Application Server</a></li>
<li><a class="reference internal" href="#settings-when-using-datasource-for-which-bean-is-defined">6.1.2.1.2. Settings when using DataSource for which Bean is defined</a></li>
</ul>
</li>
<li><a class="reference internal" href="#settings-to-enable-transaction-management">6.1.2.2. Settings to enable transaction management</a></li>
<li><a class="reference internal" href="#jdbc-debug-log-settings">6.1.2.3. JDBC debug log settings</a><ul>
<li><a class="reference internal" href="#settings-related-to-datasource-provided-by-log4jdbc">6.1.2.3.1. Settings related to datasource provided by log4jdbc</a></li>
<li><a class="reference internal" href="#log4jdbc-logger-settings">6.1.2.3.2. log4jdbc logger settings</a></li>
<li><a class="reference internal" href="#settings-of-log4jdbc-option">6.1.2.3.3. Settings of log4jdbc option</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend">6.1.3. How to extend</a><ul>
<li><a class="reference internal" href="#settings-for-using-multiple-datasources">6.1.3.1. Settings for using multiple datasources</a></li>
<li><a class="reference internal" href="#settings-to-switch-the-datasource-dynamically">6.1.3.2. Settings to switch the datasource dynamically</a><ul>
<li><a class="reference internal" href="#implementation-of-abstractroutingdatasource">6.1.3.2.1. Implementation of AbstractRoutingDataSource</a></li>
<li><a class="reference internal" href="#datasource-definition">6.1.3.2.2. Datasource definition</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-solve-the-problem">6.1.4. how to solve the problem</a><ul>
<li><a class="reference internal" href="#how-to-resolve-n-1">6.1.4.1. How to resolve N+1</a><ul>
<li><a class="reference internal" href="#resolving-n-1-using-joins-join-fetch">6.1.4.1.1. Resolving N+1 using JOINs (Join Fetch)</a></li>
<li><a class="reference internal" href="#resolving-n-1-by-fetching-related-records-in-batch">6.1.4.1.2. Resolving N+1 by fetching related records in batch</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix">6.1.5. Appendix</a><ul>
<li><a class="reference internal" href="#escaping-during-like-search">6.1.5.1. Escaping during LIKE search</a><ul>
<li><a class="reference internal" href="#specifications-of-escaping-of-common-library">6.1.5.1.1. Specifications of escaping of common library</a></li>
<li><a class="reference internal" href="#about-escaping-methods-provided-by-common-library">6.1.5.1.2. About escaping methods provided by common library</a></li>
<li><a class="reference internal" href="#how-to-use-common-library">6.1.5.1.3. How to use common library</a></li>
</ul>
</li>
<li><a class="reference internal" href="#about-sequencer">6.1.5.2. About Sequencer</a><ul>
<li><a class="reference internal" href="#about-classes-provided-by-common-library">6.1.5.2.1. About classes provided by common library</a></li>
<li><a class="reference internal" href="#data-access-common-howtouse-sequencer">6.1.5.2.2. How to use common library</a></li>
</ul>
</li>
<li><a class="reference internal" href="#classes-provided-by-spring-framework-for-converting-to-data-access-exception">6.1.5.3. Classes provided by Spring Framework for converting to data access exception</a></li>
<li><a class="reference internal" href="#jdbc-datasource-classes-provided-by-spring-framework">6.1.5.4. JDBC datasource classes provided by Spring Framework</a></li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">6. Data Access</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="DataAccessMyBatis3.html"
                        title="next chapter">6.2. Database Access (MyBatis3)</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/ArchitectureInDetail/DataAccessDetail/DataAccessCommon.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="database-access-common">
<h1>6.1. Database Access (Common)<a class="headerlink" href="#database-access-common" title="Permalink to this headline">Â¶</a></h1>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id11">Overview</a><ul>
<li><a class="reference internal" href="#about-jdbc-datasource" id="id12">About JDBC DataSource</a><ul>
<li><a class="reference internal" href="#jdbc-datasource-provided-by-application-server" id="id13">JDBC datasource provided by Application Server</a></li>
<li><a class="reference internal" href="#jdbc-datasource-provided-by-oss-third-party-library" id="id14">JDBC datasource provided by OSS/Third-Party library</a></li>
<li><a class="reference internal" href="#jdbc-datasource-provided-by-spring-framework" id="id15">JDBC datasource provided by Spring Framework</a></li>
</ul>
</li>
<li><a class="reference internal" href="#about-transaction-management" id="id16">About transaction management</a></li>
<li><a class="reference internal" href="#about-declaration-of-transaction-boundary-attribute" id="id17">About declaration of transaction boundary/attribute</a></li>
<li><a class="reference internal" href="#about-exclusion-control-of-data" id="id18">About exclusion control of data</a></li>
<li><a class="reference internal" href="#about-exception-handling" id="id19">About exception handling</a></li>
<li><a class="reference internal" href="#about-multiple-datasources" id="id20">About multiple datasources</a></li>
<li><a class="reference internal" href="#about-common-library-classes" id="id21">About common library classes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use" id="id22">How to use</a><ul>
<li><a class="reference internal" href="#datasource-settings" id="id23">Datasource settings</a><ul>
<li><a class="reference internal" href="#settings-when-using-datasource-defined-in-application-server" id="id24">Settings when using DataSource defined in Application Server</a></li>
<li><a class="reference internal" href="#settings-when-using-datasource-for-which-bean-is-defined" id="id25">Settings when using DataSource for which Bean is defined</a></li>
</ul>
</li>
<li><a class="reference internal" href="#settings-to-enable-transaction-management" id="id26">Settings to enable transaction management</a></li>
<li><a class="reference internal" href="#jdbc-debug-log-settings" id="id27">JDBC debug log settings</a><ul>
<li><a class="reference internal" href="#settings-related-to-datasource-provided-by-log4jdbc" id="id28">Settings related to datasource provided by log4jdbc</a></li>
<li><a class="reference internal" href="#log4jdbc-logger-settings" id="id29">log4jdbc logger settings</a></li>
<li><a class="reference internal" href="#settings-of-log4jdbc-option" id="id30">Settings of log4jdbc option</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend" id="id31">How to extend</a><ul>
<li><a class="reference internal" href="#settings-for-using-multiple-datasources" id="id32">Settings for using multiple datasources</a></li>
<li><a class="reference internal" href="#settings-to-switch-the-datasource-dynamically" id="id33">Settings to switch the datasource dynamically</a><ul>
<li><a class="reference internal" href="#implementation-of-abstractroutingdatasource" id="id34">Implementation of AbstractRoutingDataSource</a></li>
<li><a class="reference internal" href="#datasource-definition" id="id35">Datasource definition</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-solve-the-problem" id="id36">how to solve the problem</a><ul>
<li><a class="reference internal" href="#how-to-resolve-n-1" id="id37">How to resolve N+1</a><ul>
<li><a class="reference internal" href="#resolving-n-1-using-joins-join-fetch" id="id38">Resolving N+1 using JOINs (Join Fetch)</a></li>
<li><a class="reference internal" href="#resolving-n-1-by-fetching-related-records-in-batch" id="id39">Resolving N+1 by fetching related records in batch</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix" id="id40">Appendix</a><ul>
<li><a class="reference internal" href="#escaping-during-like-search" id="id41">Escaping during LIKE search</a><ul>
<li><a class="reference internal" href="#specifications-of-escaping-of-common-library" id="id42">Specifications of escaping of common library</a></li>
<li><a class="reference internal" href="#about-escaping-methods-provided-by-common-library" id="id43">About escaping methods provided by common library</a></li>
<li><a class="reference internal" href="#how-to-use-common-library" id="id44">How to use common library</a></li>
</ul>
</li>
<li><a class="reference internal" href="#about-sequencer" id="id45">About Sequencer</a><ul>
<li><a class="reference internal" href="#about-classes-provided-by-common-library" id="id46">About classes provided by common library</a></li>
<li><a class="reference internal" href="#data-access-common-howtouse-sequencer" id="id47">How to use common library</a></li>
</ul>
</li>
<li><a class="reference internal" href="#classes-provided-by-spring-framework-for-converting-to-data-access-exception" id="id48">Classes provided by Spring Framework for converting to data access exception</a></li>
<li><a class="reference internal" href="#jdbc-datasource-classes-provided-by-spring-framework" id="id49">JDBC datasource classes provided by Spring Framework</a></li>
</ul>
</li>
</ul>
</div>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p>The following topics in this chapter are currently under study.</p>
<ul class="last">
<li><div class="first line-block">
<div class="line">About multiple datasources</div>
<div class="line">For details, <a class="reference internal" href="#data-access-common-todo-multiple-datasource-overview"><span class="std std-ref">About multiple datasources of Overview</span></a> and <a class="reference internal" href="#data-access-common-todo-multiple-datasource-howtoextends"><span class="std std-ref">Settings for using multiple datasources of How to extends</span></a>.</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">About handling of unique constraint errors and pessimistic exclusion errors when using JPA</div>
<div class="line">For details, refer to <a class="reference internal" href="#data-access-common-todo-exception"><span class="std std-ref">Overview - About exception handling</span></a>.</div>
</div>
</li>
</ul>
</div>
<div class="section" id="overview">
<span id="data-access-overview-label"></span><h2><a class="toc-backref" href="#id11">6.1.1. Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">Â¶</a></h2>
<p>This chapter explains the method of accessing the data stored in RDBMS.</p>
<p>For the O/R Mapper dependent part, refer to</p>
<ul class="simple">
<li><a class="reference internal" href="DataAccessMyBatis3.html"><span class="doc">Database Access (MyBatis3)</span></a></li>
<li><a class="reference internal" href="DataAccessJpa.html"><span class="doc">Database Access (JPA)</span></a></li>
</ul>
<div class="section" id="about-jdbc-datasource">
<h3><a class="toc-backref" href="#id12">6.1.1.1. About JDBC DataSource</a><a class="headerlink" href="#about-jdbc-datasource" title="Permalink to this headline">Â¶</a></h3>
<div class="line-block">
<div class="line">RDBMS can be accessed from the application by referring to JDBC datasource.</div>
<div class="line">JDBC datasource can be used to exclude settings such as JDBC driver load, connection information (URL, user, password etc.) from application.</div>
<div class="line">Therefore, RDBMS to be used and environment in which the application is to be deployed need not be taken into account.</div>
</div>
<blockquote>
<div><div class="figure align-center" id="id3">
<a class="reference internal image-reference" href="../../_images/dataaccess_common-datasource.png"><img alt="about data source" src="../../_images/dataaccess_common-datasource.png" style="width: 90%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - About JDBC DataSource</strong></span></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">JDBC datasource is implemented from Application Server, OSS library, Third-Party library, Spring Framework etc.; hence it is necessary to select the datasource based on project requirements and deployment environment.</div>
<div class="line">The typical datasources are introduced below.</div>
</div>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="#datasource-application-server-label"><span class="std std-ref">JDBC datasource provided by Application Server</span></a></li>
<li><a class="reference internal" href="#datasource-oss-thirdparty-label"><span class="std std-ref">JDBC datasource provided by OSS/Third-Party library</span></a></li>
<li><a class="reference internal" href="#datasource-spring-framework-label"><span class="std std-ref">JDBC datasource provided by Spring Framework</span></a></li>
</ul>
</div></blockquote>
<div class="section" id="jdbc-datasource-provided-by-application-server">
<span id="datasource-application-server-label"></span><h4><a class="toc-backref" href="#id13">6.1.1.1.1. JDBC datasource provided by Application Server</a><a class="headerlink" href="#jdbc-datasource-provided-by-application-server" title="Permalink to this headline">Â¶</a></h4>
<div class="line-block">
<div class="line">When datasource is to be used in Web application, normally JDBC datasource provided by Application Server is used.</div>
<div class="line">JDBC datasource of Application Server provides functionalities required in web application such as Connection Pooling as standard functionalities.</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils" id="id4">
<caption><span class="caption-text"><strong>Datasources provided by Application Server</strong></span><a class="headerlink" href="#id4" title="Permalink to this table">Â¶</a></caption>
<colgroup>
<col width="10%" />
<col width="35%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Application Server</th>
<th class="head">Reference page</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>Apache Tomcat 8.5</td>
<td><div class="first last line-block">
<div class="line">Refer to <a class="reference external" href="http://tomcat.apache.org/tomcat-8.5-doc/jdbc-pool.html">Apache Tomcat 8.5 User Guide(The Tomcat JDBC Connection Pool)</a>.</div>
<div class="line">Refer to <a class="reference external" href="http://tomcat.apache.org/tomcat-8.5-doc/jndi-datasource-examples-howto.html">Apache Tomcat 8.5 User Guide(JNDI Datasource HOW-TO)</a> (Apache Commons DBCP 2).</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>Apache Tomcat 8.0</td>
<td><div class="first last line-block">
<div class="line">Refer to <a class="reference external" href="http://tomcat.apache.org/tomcat-8.0-doc/jdbc-pool.html">Apache Tomcat 8.0 User Guide(The Tomcat JDBC Connection Pool)</a>.</div>
<div class="line">Refer to <a class="reference external" href="http://tomcat.apache.org/tomcat-8.0-doc/jndi-datasource-examples-howto.html">Apache Tomcat 8.0 User Guide(JNDI Datasource HOW-TO)</a>(Apache Commons DBCP 2).</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>Apache Tomcat 7</td>
<td><div class="first last line-block">
<div class="line">Refer to <a class="reference external" href="http://tomcat.apache.org/tomcat-7.0-doc/jdbc-pool.html">Apache Tomcat 7 User Guide (The Tomcat JDBC Connection Pool)</a>.</div>
<div class="line">Refer to <a class="reference external" href="http://tomcat.apache.org/tomcat-7.0-doc/jndi-datasource-examples-howto.html">Apache Tomcat 7 User Guide (JNDI Datasource HOW-TO)</a> (Apache Commons DBCP).</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>Oracle WebLogic Server 12c</td>
<td>Refer to <a class="reference external" href="http://docs.oracle.com/middleware/1221/wls/INTRO/jdbc.htm">Oracle WebLogic Server Product Documentation</a>.</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>IBM WebSphere Application Server Version 9.0</td>
<td>Refer to <a class="reference external" href="http://www.ibm.com/support/knowledgecenter/SSEQTP_9.0.0/com.ibm.websphere.wlp.doc/ae/twlp_dep_configuring_ds.html?lang=en">WebSphere Application Server Online information center</a>.</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>JBoss Enterprise Application Platform 7.0</td>
<td>Refer <a class="reference external" href="https://access.redhat.com/documentation/en/red-hat-jboss-enterprise-application-platform/7.0/paged/configuration-guide/chapter-13-datasource-management">JBoss Enterprise Application Platform 7.0 Product Documentation</a>.</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td>JBoss Enterprise Application Platform 6.4</td>
<td>Refer <a class="reference external" href="https://access.redhat.com/documentation/en-US/JBoss_Enterprise_Application_Platform/6.4/html/Administration_and_Configuration_Guide/chap-Datasource_Management.html">JBoss Enterprise Application Platform 6.4 Product Documentation</a>.</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="jdbc-datasource-provided-by-oss-third-party-library">
<span id="datasource-oss-thirdparty-label"></span><h4><a class="toc-backref" href="#id14">6.1.1.1.2. JDBC datasource provided by OSS/Third-Party library</a><a class="headerlink" href="#jdbc-datasource-provided-by-oss-third-party-library" title="Permalink to this headline">Â¶</a></h4>
<div class="line-block">
<div class="line">When JDBC datasource of Application Server is not used, JDBC datasource of OSS/Third-Party library should be used.</div>
<div class="line">This guideline introduces only Apache Commons DBCP; however other libraries can also be used.</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils" id="id5">
<caption><span class="caption-text"><strong>JDBC datasource provided by OSS/Third-Party library</strong></span><a class="headerlink" href="#id5" title="Permalink to this table">Â¶</a></caption>
<colgroup>
<col width="10%" />
<col width="35%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Library name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>Apache Commons DBCP</td>
<td>Refer to <a class="reference external" href="http://commons.apache.org/proper/commons-dbcp/index.html">Apache Commons DBCP</a>.</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="jdbc-datasource-provided-by-spring-framework">
<span id="datasource-spring-framework-label"></span><h4><a class="toc-backref" href="#id15">6.1.1.1.3. JDBC datasource provided by Spring Framework</a><a class="headerlink" href="#jdbc-datasource-provided-by-spring-framework" title="Permalink to this headline">Â¶</a></h4>
<div class="line-block">
<div class="line">Implementation class of JDBC datasource of Spring Framework cannot be used as datasource of Web application since it does not provide connection pooling.</div>
<div class="line">In Spring Framework, implementation class and adapter class of JDBC datasource are provided; however they are introduced as  <a class="reference internal" href="#appendix-datasource-of-spring-label"><span class="std std-ref">JDBC datasource classes provided by Spring Framework</span></a> of Appendix, since usage is restricted.</div>
</div>
</div>
</div>
<div class="section" id="about-transaction-management">
<h3><a class="toc-backref" href="#id16">6.1.1.2. About transaction management</a><a class="headerlink" href="#about-transaction-management" title="Permalink to this headline">Â¶</a></h3>
<div class="line-block">
<div class="line">When transactions are to be stored using Spring Framework functionality, PlatformTransactionManager needs to be selected based on project requirements and deployment environment.</div>
<div class="line">For details, refer to <a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html#service-enable-transaction-management"><span class="std std-ref">Settings for using transaction management</span></a> of <a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html"><span class="doc">Domain Layer Implementation</span></a>.</div>
</div>
</div>
<div class="section" id="about-declaration-of-transaction-boundary-attribute">
<h3><a class="toc-backref" href="#id17">6.1.1.3. About declaration of transaction boundary/attribute</a><a class="headerlink" href="#about-declaration-of-transaction-boundary-attribute" title="Permalink to this headline">Â¶</a></h3>
<div class="line-block">
<div class="line">Transaction boundary and transaction attributes should be declared by specifying  <code class="docutils literal"><span class="pre">&#64;Transactional</span></code> annotation in Service.</div>
<div class="line">For details, refer to <a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html#service-transaction-management"><span class="std std-ref">Regarding transaction management</span></a> of <a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html"><span class="doc">Domain Layer Implementation</span></a> .</div>
</div>
</div>
<div class="section" id="about-exclusion-control-of-data">
<h3><a class="toc-backref" href="#id18">6.1.1.4. About exclusion control of data</a><a class="headerlink" href="#about-exclusion-control-of-data" title="Permalink to this headline">Â¶</a></h3>
<div class="line-block">
<div class="line">When updating data, it is necessary to execute exclusion control to ensure data consistency and integrity.</div>
<div class="line">For details on exclusion control of data, refer to <a class="reference internal" href="ExclusionControl.html"><span class="doc">Exclusive Control</span></a>.</div>
</div>
</div>
<div class="section" id="about-exception-handling">
<h3><a class="toc-backref" href="#id19">6.1.1.5. About exception handling</a><a class="headerlink" href="#about-exception-handling" title="Permalink to this headline">Â¶</a></h3>
<div class="line-block">
<div class="line">In Spring Framework, a function is provided to convert JDBC exception (<code class="docutils literal"><span class="pre">java.sql.SQLException</span></code>) and O/R Mapper specific exception to data access exception (subclass of (<code class="docutils literal"><span class="pre">org.springframework.dao.DataAccessException</span></code>) provided by Spring Framework.</div>
<div class="line">For the class which is converted to data access exception of Spring Framework, refer to <a class="reference internal" href="#appendix-dataaccessexception-converter-class-label"><span class="std std-ref">Classes provided by Spring Framework for converting to data access exception</span></a> of Appendix.</div>
</div>
<div class="line-block">
<div class="line">The converted data access exception need not be handled in application code; however, some errors (such as unique constraint violation, exclusion error etc.) need to be handled as per the requirements.</div>
<div class="line">When handling data access exception, exception of subclass notifying error details should be caught instead of <code class="docutils literal"><span class="pre">DataAccessException</span></code>.</div>
<div class="line">Typical subclasses which are likely to be handled in application code are as follows:</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils" id="id6">
<caption><span class="caption-text"><strong>Subclasses of DB access exception, which are likely to be handled</strong></span><a class="headerlink" href="#id6" title="Permalink to this table">Â¶</a></caption>
<colgroup>
<col width="10%" />
<col width="35%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Class name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.dao.</div>
<div class="line">DuplicateKeyException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Exception that occurs in case of unique constraint violation.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.dao.</div>
<div class="line">OptimisticLockingFailureException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Exception that occurs in case of optimistic locking failure. It occurs when same data is updated with different logic.</div>
<div class="line">This exception occurs when JPA is used as O/R Mapper. MyBatis does not have optimistic locking function; hence this exception does not occur from O/R Mapper.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.dao.</div>
<div class="line">PessimisticLockingFailureException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Exception that occurs in case of pessimistic locking failure. It occurs when same data is locked with different logic and the lock is not released even after âwaiting for unlockingâ timeout period has elapsed.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>When optimistic locking is to be implemented using MyBatis in O/R Mapper, it should be implemented as Service or Repository process.</p>
<p>As a method of notifying the optimistic locking failure to Controller, this guideline recommends generation of <code class="docutils literal"><span class="pre">OptimisticLockingFailureException</span></code> and exception of its child class.</p>
<p class="last">This is to make implementation of application layer (implementation of Controller) independent of O/R Mapper to be used.</p>
</div>
</div></blockquote>
<blockquote id="data-access-common-todo-exception">
<div><div class="admonition-todo admonition" id="index-1">
<p class="first admonition-title">Todo</p>
<p><strong>It has been recently found that using JPA (Hibernate) results in occurrence of unexpected errors.</strong></p>
<ul class="last simple">
<li>In case of unique constraint violation, <code class="docutils literal"><span class="pre">org.springframework.dao.DataIntegrityViolationException</span></code> occurs and not <code class="docutils literal"><span class="pre">DuplicateKeyException</span></code>.</li>
</ul>
</div>
</div></blockquote>
<p>See the example below for handling unique constraint violation as business exception.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="k">try</span> <span class="o">{</span>
    <span class="n">accountRepository</span><span class="o">.</span><span class="na">saveAndFlash</span><span class="o">(</span><span class="n">account</span><span class="o">);</span>
<span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">DuplicateKeyException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (1)</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="o">(</span><span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;e.xx.xx.0002&quot;</span><span class="o">),</span> <span class="n">e</span><span class="o">);</span> <span class="c1">// (2)</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Exception (DuplicateKeyException) that occurs in case of unique constraint violation is caught.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Business exception indicating that there is duplicate data is thrown.</div>
<div class="line">When exception is caught, make sure to specify the cause of exception (â<code class="docutils literal"><span class="pre">e</span></code>â ) in business exception.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="about-multiple-datasources">
<h3><a class="toc-backref" href="#id20">6.1.1.6. About multiple datasources</a><a class="headerlink" href="#about-multiple-datasources" title="Permalink to this headline">Â¶</a></h3>
<div class="line-block">
<div class="line">Multiple datasources may be required depending on the application.</div>
<div class="line">Typical cases wherein multiple datasources are required, are shown below.</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils" id="id7">
<caption><span class="caption-text"><strong>Typical case where multiple datasources are required</strong></span><a class="headerlink" href="#id7" title="Permalink to this table">Â¶</a></caption>
<colgroup>
<col width="10%" />
<col width="30%" />
<col width="30%" />
<col width="30%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Case</th>
<th class="head">Example</th>
<th class="head">Feature</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>When database and schema are divided according to data (tables).</td>
<td>When group of tables maintaining customer information and group of tables maintaining invoice information are stored in separate database and schema.</td>
<td>The data to be handled in the process is fixed; hence the datasource to be used can be defined statically.</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>When database and schema to be used are divided according to users (login users).</td>
<td>When database and schema are divided according to users (Multitenant etc.).</td>
<td>The datasource to be used differs depending on users; hence the datasource to be used dynamically can be defined.</td>
</tr>
</tbody>
</table>
<div class="admonition-todo admonition" id="index-2">
<span id="data-access-common-todo-multiple-datasource-overview"></span><p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p>The following details will be added in future.</p>
<ul class="last simple">
<li>Conceptual diagram</li>
</ul>
</div>
</div></blockquote>
</div>
<div class="section" id="about-common-library-classes">
<h3><a class="toc-backref" href="#id21">6.1.1.7. About common library classes</a><a class="headerlink" href="#about-common-library-classes" title="Permalink to this headline">Â¶</a></h3>
<div class="line-block">
<div class="line">Common library provides classes that carry out following processes.</div>
<div class="line">For more details about common library, refer to links given below.</div>
</div>
<ul class="simple">
<li><a class="reference internal" href="#data-access-common-appendix-like-escape"><span class="std std-ref">Escaping during LIKE search</span></a></li>
<li><a class="reference internal" href="#data-access-common-appendix-sequencer"><span class="std std-ref">About Sequencer</span></a></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="how-to-use">
<h2><a class="toc-backref" href="#id22">6.1.2. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="datasource-settings">
<span id="data-access-common-howtouse-datasource"></span><h3><a class="toc-backref" href="#id23">6.1.2.1. Datasource settings</a><a class="headerlink" href="#datasource-settings" title="Permalink to this headline">Â¶</a></h3>
<div class="section" id="settings-when-using-datasource-defined-in-application-server">
<h4><a class="toc-backref" href="#id24">6.1.2.1.1. Settings when using DataSource defined in Application Server</a><a class="headerlink" href="#settings-when-using-datasource-defined-in-application-server" title="Permalink to this headline">Â¶</a></h4>
<div class="line-block">
<div class="line">When using datasource defined in Application Server, it is necessary to perform settings in Bean definition file to register the object fetched through JNDI as a bean.</div>
<div class="line">Settings when PostgreSQL is used as database and Tomcat7 is used as Application Server are given below.</div>
</div>
<ul>
<li><p class="first"><code class="file docutils literal"><span class="pre">xxx-context.xml</span></code> (Tomcat config file)</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;Resource</span>
   <span class="na">type=</span><span class="s">&quot;javax.sql.DataSource&quot;</span>
   <span class="na">name=</span><span class="s">&quot;jdbc/SampleDataSource&quot;</span>
   <span class="na">driverClassName=</span><span class="s">&quot;org.postgresql.Driver&quot;</span>
   <span class="na">url=</span><span class="s">&quot;jdbc:postgresql://localhost:5432/terasoluna&quot;</span>
   <span class="na">username=</span><span class="s">&quot;postgres&quot;</span>
   <span class="na">password=</span><span class="s">&quot;postgres&quot;</span>
   <span class="na">defaultAutoCommit=</span><span class="s">&quot;false&quot;</span>
   <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="file docutils literal"><span class="pre">xxx-env.xml</span></code></p>
</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;jee:jndi-lookup</span> <span class="na">id=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">jndi-name=</span><span class="s">&quot;jdbc/SampleDataSource&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="10%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Attribute name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>-</td>
<td>Define datasource.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td>type</td>
<td>Specify resource type. Specify <code class="docutils literal"><span class="pre">javax.sql.DataSource</span></code>.</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td>name</td>
<td>Specify resource name. The name specified here is JNDI name.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td>driverClassName</td>
<td>Specify JDBC driver class. In the example, JDBC driver class provided by PostgreSQL is specified.</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td>url</td>
<td>Specify URL. [Needs to be changed as per environment]</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td>username</td>
<td>Specify user name. [Needs to be changed as per environment]</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td>password</td>
<td>Specify password of user. [Needs to be changed as per environment]</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td>defaultAutoCommit</td>
<td>Specify default value of auto commit flag. Specify âfalseâ. It is forcibly set to âfalseâ when it is under Transaction Management.</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>-</td>
<td><div class="first last line-block">
<div class="line">In case of Tomcat7, tomcat-jdbc-pool is used if factory attribute is omitted.</div>
<div class="line">For more details about settings, refer to <a class="reference external" href="http://tomcat.apache.org/tomcat-7.0-doc/jdbc-pool.html#Attributes">Attributes of The Tomcat JDBC Connection Pool</a>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>-</td>
<td>Specify JNDI name of datasource. In case of Tomcat, specify the value specified in resource name â(1)-nameâ at the time of defining datasource.</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="settings-when-using-datasource-for-which-bean-is-defined">
<h4><a class="toc-backref" href="#id25">6.1.2.1.2. Settings when using DataSource for which Bean is defined</a><a class="headerlink" href="#settings-when-using-datasource-for-which-bean-is-defined" title="Permalink to this headline">Â¶</a></h4>
<div class="line-block">
<div class="line">When using datasource of OSS/Third-Party library or JDBC datasource of Spring Framework without using the datasource provided by Application Server,</div>
<div class="line">bean for DataSource class needs to be defined in Bean definition file.</div>
<div class="line">Settings when PostgreSQL is used as database and Apache Commons DBCP is used as datasource are given below.</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">xxx-env.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">class=</span><span class="s">&quot;org.apache.commons.dbcp2.BasicDataSource&quot;</span>
    <span class="na">destroy-method=</span><span class="s">&quot;close&quot;</span><span class="nt">&gt;</span>                                           <span class="c">&lt;!-- (1) (8) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;driverClassName&quot;</span> <span class="na">value=</span><span class="s">&quot;org.postgresql.Driver&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;url&quot;</span> <span class="na">value=</span><span class="s">&quot;jdbc:postgresql://localhost:5432/terasoluna&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;username&quot;</span> <span class="na">value=</span><span class="s">&quot;postgres&quot;</span> <span class="nt">/&gt;</span>                     <span class="c">&lt;!-- (4) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span> <span class="na">value=</span><span class="s">&quot;postgres&quot;</span> <span class="nt">/&gt;</span>                     <span class="c">&lt;!-- (5) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultAutoCommit&quot;</span> <span class="na">value=</span><span class="s">&quot;false&quot;</span><span class="nt">/&gt;</span>               <span class="c">&lt;!-- (6) --&gt;</span>
    <span class="c">&lt;!-- (7) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>Specify implementation class of datasource. In the example, datasource class (<code class="docutils literal"><span class="pre">org.apache.commons.dbcp2.BasicDataSource</span></code>) provided by Apache Commons DBCP is specified.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>Specify JDBC driver class. In the example, JDBC driver class provided by PostgreSQL is specified.</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>Specify URL. [Needs to be changed as per environment]</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>Specify user name. [Needs to be changed as per environment]</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>Specify password of user. [Needs to be changed as per environment]</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td>Specify default value of auto commit flag. Specify âfalseâ. It is forcibly set to âfalseâ when it is under Transaction Management.</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In BasicDataSource, configuration values common in JDBC, JDBC driver specific properties values, connection pooling configuration values can be specified other than the values mentioned above.</div>
<div class="line">For more details about settings, refer to <a class="reference external" href="http://commons.apache.org/proper/commons-dbcp/configuration.html">DBCP Configuration</a>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In the example, values are specified directly; however, for fields where configuration values change with the environment, actual configuration values should be specified in properties file using Placeholder(${â¦}).</div>
<div class="line">For Placeholder, refer to <code class="docutils literal"><span class="pre">PropertyPlaceholderConfigurer</span></code> of <a class="reference external" href="http://docs.spring.io/spring/docs/4.3.14.RELEASE/spring-framework-reference/html/beans.html#beans-factory-extension-factory-postprocessors">Spring Reference Document</a>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div>
<div class="section" id="settings-to-enable-transaction-management">
<h3><a class="toc-backref" href="#id26">6.1.2.2. Settings to enable transaction management</a><a class="headerlink" href="#settings-to-enable-transaction-management" title="Permalink to this headline">Â¶</a></h3>
<p>For basic settings to enable transaction management, refer to <a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html#service-enable-transaction-management"><span class="std std-ref">Settings for using transaction management</span></a> of <a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html"><span class="doc">Domain Layer Implementation</span></a>.</p>
<p>For PlatformTransactionManager, the class to be used changes depending on the O/R Mapper used; hence for detailed settings, refer to:</p>
<ul class="simple">
<li><a class="reference internal" href="DataAccessMyBatis3.html"><span class="doc">Database Access (MyBatis3)</span></a></li>
<li><a class="reference internal" href="DataAccessJpa.html"><span class="doc">Database Access (JPA)</span></a></li>
</ul>
</div>
<div class="section" id="jdbc-debug-log-settings">
<span id="dataaccesscommondatasourcedebug"></span><h3><a class="toc-backref" href="#id27">6.1.2.3. JDBC debug log settings</a><a class="headerlink" href="#jdbc-debug-log-settings" title="Permalink to this headline">Â¶</a></h3>
<div class="line-block">
<div class="line">When more detailed information than the log output using O/R Mapper(MyBatis, Hibernate) is required, the information output using log4jdbc(log4jdbc-remix) can be used.</div>
<div class="line">For details on log4jdbc, refer to <a class="reference external" href="https://code.google.com/p/log4jdbc/">log4jdbc project page</a>.</div>
<div class="line">For details on log4jdbc-remix, refer to <a class="reference external" href="https://code.google.com/p/log4jdbc-remix/">log4jdbc-remix project page</a>.</div>
</div>
<p></p>
<blockquote>
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><strong>When Log4jdbcProxyDataSource offered by log4jdbc-remix is used, substantial overheads are likely to occur even if the log level is set in the configuration other than debug.</strong>
<strong>Therefore, it is recommended to use this setting for debugging, and connect to database without passing through Log4jdbcProxyDataSource while its release during performance test enviroment and commercial environment.</strong></p>
</div>
</div></blockquote>
<div class="section" id="settings-related-to-datasource-provided-by-log4jdbc">
<h4><a class="toc-backref" href="#id28">6.1.2.3.1. Settings related to datasource provided by log4jdbc</a><a class="headerlink" href="#settings-related-to-datasource-provided-by-log4jdbc" title="Permalink to this headline">Â¶</a></h4>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">xxx-env.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;jee:jndi-lookup</span> <span class="na">id=</span><span class="s">&quot;dataSourceSpied&quot;</span> <span class="na">jndi-name=</span><span class="s">&quot;jdbc/SampleDataSource&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">class=</span><span class="s">&quot;net.sf.log4jdbc.Log4jdbcProxyDataSource&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;dataSourceSpied&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>Define actual datasource. In the example, the datasource fetched through JNDI from Application Server is being used.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>Specify <code class="docutils literal"><span class="pre">net.sf.log4jdbc.Log4jdbcProxyDataSource</span></code> provided by log4jdbc.</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>In constructor, specify bean which is an actual datasource.</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>When the application is to be released in performance test environment or production environment, Log4jdbcProxyDataSource should not be used as datasource.</strong></p>
<p class="last">Specifically, exclude settings of (2) and (3) and change bean name of <code class="docutils literal"><span class="pre">dataSourceSpied</span></code> to <code class="docutils literal"><span class="pre">dataSource</span></code>.</p>
</div>
</div></blockquote>
</div>
<div class="section" id="log4jdbc-logger-settings">
<h4><a class="toc-backref" href="#id29">6.1.2.3.2. log4jdbc logger settings</a><a class="headerlink" href="#log4jdbc-logger-settings" title="Permalink to this headline">Â¶</a></h4>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">logback.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;jdbc.sqltiming&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;debug&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/logger&gt;</span>

<span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;jdbc.sqlonly&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;warn&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/logger&gt;</span>

<span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;jdbc.audit&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;warn&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/logger&gt;</span>

<span class="c">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;jdbc.connection&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;warn&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/logger&gt;</span>

<span class="c">&lt;!-- (5) --&gt;</span>
<span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;jdbc.resultset&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;warn&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/logger&gt;</span>

<span class="c">&lt;!-- (6) --&gt;</span>
<span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;jdbc.resultsettable&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;debug&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/logger&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Logger to output SQL execution time and SQL statement wherein the value is set in bind variable. Since this SQL contains values for bind variables, it can be executed using DB access tool.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Logger to output SQL statement wherein the value is set in bind variable. The difference with (1) is that SQL execution time is not output.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Logger to exclude ResultSet interface, call methods of JDBC interface and to output arguments and return values. This log is useful for analyzing the JDBC related issues; however volume of the output log is large.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Logger to output connected/disconnected events and number of connections in use. This log is useful for analyzing connection leak, but it need not be output unless there is connection leak issue.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Logger to call methods of ResultSet interface and output arguments and return values. This log is useful during analysis when actual result differs from expected result; however volume of the output log is large.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Logger to output the contents of ResultSet by converting them into a format so that they can be easily verified. This log is useful during analysis when actual result differs from expected result; however volume of the output log is large.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>Large amount of log is output depending on the type of logger; hence only the required logger should be defined or output.</strong></p>
<p>In the above sample, log level for loggers which output very useful logs during development, is set to <code class="docutils literal"><span class="pre">debug</span></code>.
As for other loggers, the log level needs to be set to <code class="docutils literal"><span class="pre">debug</span></code> whenever required.</p>
<p><strong>When the application is to be released in performance test environment or production environment, log using log4jdbc logger should not be output at the time of normal end of process.</strong></p>
<p class="last">Typically log level should be set to <code class="docutils literal"><span class="pre">warn</span></code>.</p>
</div>
</div></blockquote>
</div>
<div class="section" id="settings-of-log4jdbc-option">
<h4><a class="toc-backref" href="#id30">6.1.2.3.3. Settings of log4jdbc option</a><a class="headerlink" href="#settings-of-log4jdbc-option" title="Permalink to this headline">Â¶</a></h4>
<p>Default operations of log4jdbc can be customized by placing properties file <code class="file docutils literal"><span class="pre">log4jdbc.properties</span></code>under class path.</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">log4jdbc.properties</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-properties"><div class="highlight"><pre><span></span><span class="c"># (1)</span>
<span class="na">log4jdbc.dump.sql.maxlinelength</span><span class="o">=</span><span class="s">0</span>
<span class="c"># (2)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>Specify word-wrap setting for SQL statement. If â0â is specified, SQL statement is not wrapped.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>For option details, refer to <a class="reference external" href="https://code.google.com/p/log4jdbc/#Options">log4jdbc project page -Options-</a>.</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-extend">
<h2><a class="toc-backref" href="#id31">6.1.3. How to extend</a><a class="headerlink" href="#how-to-extend" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="settings-for-using-multiple-datasources">
<span id="data-access-common-todo-multiple-datasource-howtoextends"></span><h3><a class="toc-backref" href="#id32">6.1.3.1. Settings for using multiple datasources</a><a class="headerlink" href="#settings-for-using-multiple-datasources" title="Permalink to this headline">Â¶</a></h3>
<blockquote>
<div><div class="admonition-todo admonition" id="index-3">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p>Following details will be added in future.</p>
<ul class="last simple">
<li>Transaction management method may change depending on the processing pattern (like Update for multiple datasources, Update for a single datasource, Only for reference, No concurrent access etc.), hence breakdown is planned focusing on that area.</li>
</ul>
</div>
</div></blockquote>
</div>
<div class="section" id="settings-to-switch-the-datasource-dynamically">
<h3><a class="toc-backref" href="#id33">6.1.3.2. Settings to switch the datasource dynamically</a><a class="headerlink" href="#settings-to-switch-the-datasource-dynamically" title="Permalink to this headline">Â¶</a></h3>
<div class="line-block">
<div class="line">In order to define multiple datasources and then to switch them dynamically, it is necessary to create a class that inherits <code class="docutils literal"><span class="pre">org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource</span></code> and implement the conditions by which datasource is switched.</div>
<div class="line">This is to be implemented by mapping the key which is a return value of <code class="docutils literal"><span class="pre">determineCurrentLookupKey</span></code> method with the datasource. For selecting the key, usually context information like authenticated user information, time and locale etc. is to be used.</div>
</div>
<div class="section" id="implementation-of-abstractroutingdatasource">
<h4><a class="toc-backref" href="#id34">6.1.3.2.1. Implementation of AbstractRoutingDataSource</a><a class="headerlink" href="#implementation-of-abstractroutingdatasource" title="Permalink to this headline">Â¶</a></h4>
<div class="line-block">
<div class="line">The datasource can be switched dynamically by using the <code class="docutils literal"><span class="pre">DataSource</span></code> which is created by extending <code class="docutils literal"><span class="pre">AbstractRoutingDataSource</span></code>in a same way as the normal datasource.</div>
<div class="line">The example of switching the datasource based on time is given below.</div>
</div>
<ul class="simple">
<li>Example of implementing a class that inherits <code class="docutils literal"><span class="pre">AbstractRoutingDataSource</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.examples.infra.datasource</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.joda.time.DateTime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.date.jodatime.JodaTimeDateFactory</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RoutingDataSource</span> <span class="kd">extends</span> <span class="n">AbstractRoutingDataSource</span> <span class="o">{</span> <span class="c1">// (1)</span>

    <span class="nd">@Inject</span>
    <span class="n">JodaTimeDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span> <span class="c1">// (2)</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">Object</span> <span class="nf">determineCurrentLookupKey</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// (3)</span>

        <span class="n">DateTime</span> <span class="n">dateTime</span> <span class="o">=</span> <span class="n">dateFactory</span><span class="o">.</span><span class="na">newDateTime</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">hour</span> <span class="o">=</span> <span class="n">dateTime</span><span class="o">.</span><span class="na">getHourOfDay</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="mi">7</span> <span class="o">&lt;=</span> <span class="n">hour</span> <span class="o">&amp;&amp;</span> <span class="n">hour</span> <span class="o">&lt;=</span> <span class="mi">23</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (4)</span>
            <span class="k">return</span> <span class="s">&quot;OPEN&quot;</span><span class="o">;</span> <span class="c1">// (5)</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">&quot;CLOSE&quot;</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>Inherit <code class="docutils literal"><span class="pre">AbstractRoutingDataSource</span></code>.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>Use <code class="docutils literal"><span class="pre">JodaTimeDateFactory</span></code>to fetch time. For details, refer to <a class="reference internal" href="../GeneralFuncDetail/SystemDate.html"><span class="doc">System Date</span></a>.</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>Implement <code class="docutils literal"><span class="pre">determineCurrentLookupKey</span></code> method. The datasource to be used is defined by mapping the return value of this method and the <code class="docutils literal"><span class="pre">key</span></code> defined in <code class="docutils literal"><span class="pre">targetDataSources</span></code> of the bean definition file described later.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>In the method, refer to the context information (here Time) and switch the key. Here the implementation should be in accordance with the business requirements. This sample is being implemented so that the time returns different keys as âFrom 7:00 to 23:59â and  âFrom 0:00 to 6:59â.</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>Return the  <code class="docutils literal"><span class="pre">key</span></code> to be mapped with <code class="docutils literal"><span class="pre">targetDataSources</span></code> of the bean definition file described later.</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="datasource-definition">
<h4><a class="toc-backref" href="#id35">6.1.3.2.2. Datasource definition</a><a class="headerlink" href="#datasource-definition" title="Permalink to this headline">Â¶</a></h4>
<p>Define the  <code class="docutils literal"><span class="pre">AbstractRoutingDataSource</span></code>extended class which was created, in bean definition file.</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">xxx-env.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;dataSource&quot;</span>
    <span class="na">class=</span><span class="s">&quot;com.examples.infra.datasource.RoutingDataSource&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;targetDataSources&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;map&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;OPEN&quot;</span> <span class="na">value-ref=</span><span class="s">&quot;dataSourceOpen&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;CLOSE&quot;</span> <span class="na">value-ref=</span><span class="s">&quot;dataSourceClose&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/map&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultTargetDataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSourceDefault&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>Define a class that inherits <code class="docutils literal"><span class="pre">AbstractRoutingDataSource</span></code> created earlier.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>Define the datasource to be used. As for <code class="docutils literal"><span class="pre">key</span></code>, define the value that can be returned using <code class="docutils literal"><span class="pre">determineCurrentLookupKey</span></code> method. In <code class="docutils literal"><span class="pre">value-ref</span></code> , specify the datasource to be used for each <code class="docutils literal"><span class="pre">key</span></code>. Define in accordance with the number of datasources to be switched based on <a class="reference internal" href="#data-access-common-howtouse-datasource"><span class="std std-ref">Datasource settings</span></a>.</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>This datasource is used, when <code class="docutils literal"><span class="pre">key</span></code> specified in <code class="docutils literal"><span class="pre">determineCurrentLookupKey</span></code> method does not exist in <code class="docutils literal"><span class="pre">targetDataSources</span></code>. In case of implementation example, default setting is not used; however, this time <code class="docutils literal"><span class="pre">defaultTargetDataSource</span></code> is being used for description purpose.</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-solve-the-problem">
<h2><a class="toc-backref" href="#id36">6.1.4. how to solve the problem</a><a class="headerlink" href="#how-to-solve-the-problem" title="Permalink to this headline">Â¶</a></h2>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="how-to-resolve-n-1">
<span id="data-access-common-howtosolve-n-plus-1"></span><h3><a class="toc-backref" href="#id37">6.1.4.1. How to resolve N+1</a><a class="headerlink" href="#how-to-resolve-n-1" title="Permalink to this headline">Â¶</a></h3>
<p>N+1 occurs when more number of SQL statements need to be executed in accordance with the number of records to be fetched from the database. This problem causes high load on the database and deteriorates response time.</p>
<p>Details are given below.</p>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/dataaccess_common-n_plus_1.png"><img alt="about N+1 Problem" src="../../_images/dataaccess_common-n_plus_1.png" style="width: 90%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Search the records matching the search conditions from MainTable.</div>
<div class="line">In the above example, col1 of MainTable fetches <code class="docutils literal"><span class="pre">'Foo'</span></code> records and the total records fetched are 20.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">For each record searched in (1), related records are fetched from SubTable.</div>
<div class="line">In the above example, the id column of SubTable fetches the same records as the id column of records fetched in (1).</div>
<div class="line"><strong>This SQL is executed for number of records fetched in (1).</strong></div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">In the above example, <strong>SQL is executed totally 21 times.</strong></div>
<div class="line">Supposing there are 3 SubTables, <strong>SQL is executed totally 61 times; hence countermeasures are required.</strong></div>
</div>
</div></blockquote>
<p>Typical example to resolve N+1 is given below.</p>
<div class="section" id="resolving-n-1-using-joins-join-fetch">
<h4><a class="toc-backref" href="#id38">6.1.4.1.1. Resolving N+1 using JOINs (Join Fetch)</a><a class="headerlink" href="#resolving-n-1-using-joins-join-fetch" title="Permalink to this headline">Â¶</a></h4>
<div class="line-block">
<div class="line">By performing JOIN on SubTable and MainTable, records of MainTable and SubTable are fetched by executing SQL once.</div>
<div class="line">When relation of MainTable and SubTable is 1:1, check whether N+1 can be resolved using this method.</div>
</div>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/dataaccess_common-n_plus_1_solve_join.png"><img alt="about solve N+1 Problem using JOIN" src="../../_images/dataaccess_common-n_plus_1_solve_join.png" style="width: 90%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When searching records matching the search conditions, the records are fetched in batch from MainTable and SubTable, by performing JOIN on SubTable.</div>
<div class="line">In the above example, col1 of MainTable collectively fetches <code class="docutils literal"><span class="pre">'Foo'</span></code> records and records of SubTable that match the id of the records matching with search conditions.</div>
<div class="line">When there are duplicate column names, it is necessary to assign alias name in order to identify the table to which that column belongs.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">If JOIN (Join Fetch) is used, <strong>all the required data can be fetched by executing SQL once.</strong></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>When performing JOIN by JPQL</strong></p>
<p class="last">For example of performing JOIN using JPQL, refer to <a class="reference internal" href="DataAccessJpa.html#data-access-jpa-howtouse-join-fetch"><span class="std std-ref">JOIN FETCH</span></a>.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>When relation with SubTable is 1:N, the problem can be resolved using JOIN (Join Fetch); however the following points should be noted.</p>
<ul class="last simple">
<li>When JOIN is performed on records having 1:N relation, unnecessary data is fetched depending on the number of records in SubTable.
For details, refer to <a class="reference internal" href="DataAccessMyBatis3.html#dataaccessmybatis3appendixacquirerelatedobjectswarningsqlmapping"><span class="std std-ref">Notes during collective fetch</span></a>.</li>
<li>When using JPA (Hibernate), if N portions in 1:N are multiple, then it is necessary to use <code class="docutils literal"><span class="pre">java.util.Set</span></code> instead of <code class="docutils literal"><span class="pre">java.util.List</span></code> as a collection type storage N portion.</li>
</ul>
</div>
</div></blockquote>
</div>
<div class="section" id="resolving-n-1-by-fetching-related-records-in-batch">
<h4><a class="toc-backref" href="#id39">6.1.4.1.2. Resolving N+1 by fetching related records in batch</a><a class="headerlink" href="#resolving-n-1-by-fetching-related-records-in-batch" title="Permalink to this headline">Â¶</a></h4>
<div class="line-block">
<div class="line">There are cases where, it has proved better when the related records are fetched in batch for patterns with multiple 1:N relations etc.; and then sorted by programming.</div>
<div class="line">When relation with SubTable is 1:N, analyze whether the problem can be resolved using this method.</div>
</div>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/dataaccess_common-n_plus_1_solve_programing.png"><img alt="about solve N+1 Problem using programing" src="../../_images/dataaccess_common-n_plus_1_solve_programing.png" style="width: 90%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Search the records matching the search conditions from MainTable.</div>
<div class="line">In the above example, col1 of MainTable fetches <code class="docutils literal"><span class="pre">'Foo'</span></code> records and the total records fetched are 20.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">For each record searched in (1), related records are fetched from SubTable.</div>
<div class="line">Related records are not fetched one by one; but the records matching the foreign key of each record fetched in (1), are fetched in batch.</div>
<div class="line">In the above example, id column of SubTable collectively fetches same records as id column of records fetched in (1) using IN clause.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SubTable records fetched in (2) sorted and merged with records fetched in (1).</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">In the above example, <strong>all the required data can be fetched by executing SQL twice.</strong></div>
<div class="line">Even supposing there are 3 SubTables, <strong>SQL needs to be executed totally 4 times.</strong></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This method has a special feature. It can fetch only the required data by optimizing SQL execution.
It is necessary to sort SubTable records by programming; however when there are many SubTables or when number of N records in 1:N is more, there are cases wherein it is better to resolve the problem using this method.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="appendix">
<h2><a class="toc-backref" href="#id40">6.1.5. Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="escaping-during-like-search">
<span id="data-access-common-appendix-like-escape"></span><h3><a class="toc-backref" href="#id41">6.1.5.1. Escaping during LIKE search</a><a class="headerlink" href="#escaping-during-like-search" title="Permalink to this headline">Â¶</a></h3>
<p>When performing LIKE search, the values to be used as search conditions need to be escaped.</p>
<p>Following class is provided by common library as a component to perform escaping for LIKE search.</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="40%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Class</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">org.terasoluna.gfw.common.query.</div>
<div class="line">QueryEscapeUtils</div>
</div>
</td>
<td><p class="first">Utility class that provide methods to perform escaping of SQL and JPQL.</p>
<p>In this class,</p>
<ul class="simple">
<li>method to perform escaping for LIKE search</li>
</ul>
<p class="last">is provided.</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">org.terasoluna.gfw.common.query.</div>
<div class="line">LikeConditionEscape</div>
</div>
</td>
<td>Class to perform escaping for LIKE search.</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><code class="docutils literal"><span class="pre">LikeConditionEscape</span></code> is a class added from terasoluna-gfw-common 1.0.2.RELEASE
to fix â<a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw/issues/78">Bugs related to handling of wildcard characters for LIKE search</a>â.</p>
<p class="last"><code class="docutils literal"><span class="pre">LikeConditionEscape</span></code> class plays a role in absorbing the differences in wildcard characters that occur due to difference in database and database versions.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="specifications-of-escaping-of-common-library">
<h4><a class="toc-backref" href="#id42">6.1.5.1.1. Specifications of escaping of common library</a><a class="headerlink" href="#specifications-of-escaping-of-common-library" title="Permalink to this headline">Â¶</a></h4>
<p>Specifications of escaping provided by common library are as follows:</p>
<ul class="simple">
<li>Escape character is â<code class="docutils literal"><span class="pre">~</span></code>â.</li>
<li>Characters to be escaped by default are 2, namely â<code class="docutils literal"><span class="pre">%</span></code>â , â<code class="docutils literal"><span class="pre">_</span></code>â.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Till terasoluna-gfw-common 1.0.1.RELEASE, the characters to be escaped were 4, namely â<code class="docutils literal"><span class="pre">%</span></code>â , â<code class="docutils literal"><span class="pre">_</span></code>â , â<code class="docutils literal"><span class="pre">ï¼</span></code>â , â<code class="docutils literal"><span class="pre">ï¼¿</span></code>â ; however,
it is changed to 2 characters namely â<code class="docutils literal"><span class="pre">%</span></code>â , â<code class="docutils literal"><span class="pre">_</span></code>â from terasoluna-gfw-common 1.0.2.RELEASE
in order to fix the â<a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw/issues/78">Bugs related to handling of wildcard characters for LIKE search</a> â.</p>
<p class="last">In addition, a method for escaping that includes double byte characters â<code class="docutils literal"><span class="pre">ï¼</span></code>â , â<code class="docutils literal"><span class="pre">ï¼¿</span></code>â as characters to be escaped, is also provided.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>See the example of escaping below.</p>
<p><strong>[Example of escaping with default specifications]</strong></p>
<p>Example of escaping when default values used as characters to be escaped is given below.</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="15%" />
<col width="20%" />
<col width="10%" />
<col width="45%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">Sr. No.</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">Target</div>
<div class="line">String</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">After escaping</div>
<div class="line">String</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">Escaping</div>
<div class="line">Flag</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">Description</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>â<code class="docutils literal"><span class="pre">a</span></code>â</td>
<td>â<code class="docutils literal"><span class="pre">a</span></code>â</td>
<td>OFF</td>
<td>Escaping not done as the string does not contain character to be escaped.</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">a~</span></code></td>
<td><code class="docutils literal"><span class="pre">a~~</span></code></td>
<td>ON</td>
<td>Escaping done as the string contains escape character.</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">a%</span></code></td>
<td><code class="docutils literal"><span class="pre">a~%</span></code></td>
<td>ON</td>
<td>Escaping done as the string contains character to be escaped.</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">a_</span></code></td>
<td><code class="docutils literal"><span class="pre">a~_</span></code></td>
<td>ON</td>
<td>Similar to No.3.</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">_a%</span></code></td>
<td><code class="docutils literal"><span class="pre">~_a~%</span></code></td>
<td>ON</td>
<td>Escaping done as the string contains characters to be escaped. When there are multiple characters to be escaped, escaping is done for all characters.</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">aï¼</span></code></td>
<td><code class="docutils literal"><span class="pre">aï¼</span></code></td>
<td>OFF</td>
<td><p class="first">Similar to No.1.</p>
<p class="last">From terasoluna-gfw-common 1.0.2.RELEASE, â<code class="docutils literal"><span class="pre">ï¼</span></code>â is handled as character out of escaping scope in default specifications.</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">aï¼¿</span></code></td>
<td><code class="docutils literal"><span class="pre">aï¼¿</span></code></td>
<td>OFF</td>
<td><p class="first">Similar to No.1.</p>
<p class="last">From terasoluna-gfw-common 1.0.2.RELEASE, â<code class="docutils literal"><span class="pre">ï¼¿</span></code>â is handled as character out of escaping scope in default specifications.</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="8">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">&quot;</span> <span class="pre">&quot;</span></code></td>
<td><code class="docutils literal"><span class="pre">&quot;</span> <span class="pre">&quot;</span></code></td>
<td>OFF</td>
<td>Similar to No.1.</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="9">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">&quot;&quot;</span></code></td>
<td><code class="docutils literal"><span class="pre">&quot;&quot;</span></code></td>
<td>OFF</td>
<td>Similar to No.1.</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="10">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">null</span></code></td>
<td><code class="docutils literal"><span class="pre">null</span></code></td>
<td>OFF</td>
<td>Similar to No.1.</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p><strong>[Example of escaping when double byte characters are included]</strong></p>
<p>Example of escaping when double byte characters included as characters to be escaped is given below.</p>
<p>For other than Sr. No. 6 and 7, refer to escaping example of default specifications.</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="15%" />
<col width="20%" />
<col width="10%" />
<col width="45%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">Sr. No.</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">Target</div>
<div class="line">String</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">After escaping</div>
<div class="line">String</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">Escaping</div>
<div class="line">Flag</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">Description</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">aï¼</span></code></td>
<td><code class="docutils literal"><span class="pre">aï¼</span></code></td>
<td>ON</td>
<td>Escaping done as string contains characters to be escaped.</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">aï¼¿</span></code></td>
<td><code class="docutils literal"><span class="pre">a~ï¼¿</span></code></td>
<td>ON</td>
<td>Similar to No.6.</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="about-escaping-methods-provided-by-common-library">
<h4><a class="toc-backref" href="#id43">6.1.5.1.2. About escaping methods provided by common library</a><a class="headerlink" href="#about-escaping-methods-provided-by-common-library" title="Permalink to this headline">Â¶</a></h4>
<p>List of escaping methods for LIKE search of <code class="docutils literal"><span class="pre">QueryEscapeUtils</span></code> class and  <code class="docutils literal"><span class="pre">LikeConditionEscape</span></code> class provided by common library is given below.</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="35%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Method name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>toLikeCondition(String)</td>
<td><div class="first last line-block">
<div class="line">String passed as an argument is escaped for LIKE search.</div>
<div class="line">When specifying type of matching (Forward match, Backward match and Partial match) at SQL or JPQL side, perform only escaping using this method.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>toStartingWithCondition(String)</td>
<td><div class="first last line-block">
<div class="line">After escaping a string passed as an argument for LIKE search, assign â<code class="docutils literal"><span class="pre">%</span></code>â at the end of the string after escaping.</div>
<div class="line">This method is used in order to convert into a value for Forward match search.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>toEndingWithCondition(String)</td>
<td><div class="first last line-block">
<div class="line">After escaping a string passed as an argument for LIKE search, assign â<code class="docutils literal"><span class="pre">%</span></code>â at the beginning of the string after escaping.</div>
<div class="line">This method is used in order to convert into a value for Backward match search.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>toContainingCondition(String)</td>
<td><div class="first last line-block">
<div class="line">After escaping a string passed as an argument for LIKE search, assign â<code class="docutils literal"><span class="pre">%</span></code>â at the beginning and end of the string after escaping.</div>
<div class="line">This method is used in order to convert into a value for Partial match search.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Methods of No.2, 3, 4 are used when specifying the type of matching (Forward match, Backward match and Partial match) at program side and not at SQL or JPQL side.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="how-to-use-common-library">
<h4><a class="toc-backref" href="#id44">6.1.5.1.3. How to use common library</a><a class="headerlink" href="#how-to-use-common-library" title="Permalink to this headline">Â¶</a></h4>
<p>For example of escaping at the time of LIKE search, refer to the document for O/R Mapper to be used.</p>
<ul class="simple">
<li>When using MyBatis3, refer to <a class="reference internal" href="DataAccessMyBatis3.html#dataaccessmybatis3howtouselikeescape"><span class="std std-ref">Escape during LIKE search</span></a> of <a class="reference internal" href="DataAccessMyBatis3.html"><span class="doc">Database Access (MyBatis3)</span></a>.</li>
<li>When using JPA (Spring Data JPA), refer to <a class="reference internal" href="DataAccessJpa.html#data-access-jpa-howtouse-like-escape"><span class="std std-ref">Escaping at the time of LIKE search</span></a>of <a class="reference internal" href="DataAccessJpa.html"><span class="doc">Database Access (JPA)</span></a>.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>API for escaping should be used as per wildcard characters supported by database to be used.</p>
<p><strong>[In case of database that supports only â%â , â_â (single byte characters) as wildcard]</strong></p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">escapedWord</span> <span class="o">=</span> <span class="n">QueryEscapeUtils</span><span class="o">.</span><span class="na">toLikeCondition</span><span class="o">(</span><span class="n">word</span><span class="o">);</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">Sr. No.</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">Description</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>Escaping is done by directly using method of <code class="docutils literal"><span class="pre">QueryEscapeUtils</span></code> class.</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><strong>[In case of database that also supports âï¼â , âï¼¿â (double byte characters) as wildcard]</strong></p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">escapedWord</span> <span class="o">=</span> <span class="n">QueryEscapeUtils</span><span class="o">.</span><span class="na">withFullWidth</span><span class="o">()</span>  <span class="c1">// (2)</span>
                        <span class="o">.</span><span class="na">toLikeCondition</span><span class="o">(</span><span class="n">word</span><span class="o">);</span>        <span class="c1">// (3)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">Sr. No.</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">Description</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>Fetch instance of <code class="docutils literal"><span class="pre">LikeConditionEscape</span></code> class by calling <code class="docutils literal"><span class="pre">withFullWidth()</span></code> method of <code class="docutils literal"><span class="pre">QueryEscapeUtils</span></code> method.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>Perform escaping by using method of <code class="docutils literal"><span class="pre">LikeConditionEscape</span></code> class instance fetched in (2).</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="about-sequencer">
<span id="data-access-common-appendix-sequencer"></span><h3><a class="toc-backref" href="#id45">6.1.5.2. About Sequencer</a><a class="headerlink" href="#about-sequencer" title="Permalink to this headline">Â¶</a></h3>
<div class="line-block">
<div class="line">Sequencer is a common library for fetching sequence value.</div>
<div class="line">Use the sequence value fetched from Sequencer as a configuration value of primary key column of the database.</div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Reason for creating Sequencer as a common library</strong></p>
<p>The reason for creating Sequencer is that there is no mechanism to format the sequence value as string in ID generator functionality of JPA.
In actual application development, sometimes the formatted string is also set as primary key; hence Sequencer is provided as common library.</p>
<p>When value set as primary key is number, it is recommended to use ID generator functionality of JPA. For ID generator functionality of JPA, refer to <a class="reference internal" href="DataAccessJpa.html#data-access-jpa-how-to-use-way-to-add-entity"><span class="std std-ref">How to add entities</span></a> of <a class="reference internal" href="DataAccessJpa.html"><span class="doc">Database Access (JPA)</span></a>.</p>
<p class="last">The primary objective of creating Sequencer is to supplement functions which are not supported by JPA; but it can also be used when sequence value is required in the processes not relating to JPA.</p>
</div>
</div></blockquote>
<div class="section" id="about-classes-provided-by-common-library">
<h4><a class="toc-backref" href="#id46">6.1.5.2.1. About classes provided by common library</a><a class="headerlink" href="#about-classes-provided-by-common-library" title="Permalink to this headline">Â¶</a></h4>
<div class="line-block">
<div class="line">List of classes of Sequencer functionality of common library is as follows:</div>
<div class="line">For usage example, refer to <a class="reference internal" href="#data-access-common-howtouse-sequencer"><span class="std std-ref">How to use common library</span></a> of How to use.</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="30%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Class name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">org.terasoluna.gfw.common.sequencer.</div>
<div class="line">Sequencer</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Interface that defines the method to fetch subsequent sequence value (getNext) and method to return current sequence value (getCurrent).</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">org.terasoluna.gfw.common.sequencer.</div>
<div class="line">JdbcSequencer</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Implementation class of <code class="docutils literal"><span class="pre">Sequencer</span></code>  interface for JDBC.</div>
<div class="line">This class is used to fetch sequence value by executing SQL in the database.</div>
<div class="line">For this class, it is assumed that values are fetched from sequence object of the database; however it is also possible to fetch the values from other than sequence object by calling function registered in the database.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="data-access-common-howtouse-sequencer">
<span id="id2"></span><h4><a class="toc-backref" href="#id47">6.1.5.2.2. How to use common library</a><a class="headerlink" href="#data-access-common-howtouse-sequencer" title="Permalink to this headline">Â¶</a></h4>
<p>Define a bean for Sequencer.</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">xxx-infra.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;articleIdSequencer&quot;</span> <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.common.sequencer.JdbcSequencer&quot;</span><span class="nt">&gt;</span>
     <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
     <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;sequenceClass&quot;</span> <span class="na">value=</span><span class="s">&quot;java.lang.String&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- (4) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;nextValueQuery&quot;</span>
        <span class="na">value=</span><span class="s">&quot;SELECT TO_CHAR(NEXTVAL(&#39;seq_article&#39;),&#39;AFM0000000000&#39;)&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- (5) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;currentValueQuery&quot;</span>
        <span class="na">value=</span><span class="s">&quot;SELECT TO_CHAR(CURRVAL(&#39;seq_article&#39;),&#39;AFM0000000000&#39;)&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a bean for class that implements <code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.sequencer.Sequencer</span></code>.</div>
<div class="line">In the above example, (<code class="docutils literal"><span class="pre">JdbcSequencer</span></code>) class for fetching sequence value by executing SQL is specified.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the datasource for executing the SQL to fetch sequence value.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the type of sequence value to be fetched.</div>
<div class="line">In the above example, since conversion to string is done using SQL; <code class="docutils literal"><span class="pre">java.lang.String</span></code> type is specified.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify SQL for fetching subsequent sequence value.</div>
<div class="line">In the above example, sequence value fetched from sequence object of (PostgreSQL) database is formatted as string.</div>
<div class="line">When sequence value fetched from the database is â<code class="docutils literal"><span class="pre">1</span></code>â , <code class="docutils literal"><span class="pre">A0000000001</span></code> is returned as return value of <code class="docutils literal"><span class="pre">Sequencer#getNext()</span></code> method.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify SQL for fetching current sequence value.</div>
<div class="line">When sequence value fetched from the database is â<code class="docutils literal"><span class="pre">2</span></code>â , <code class="docutils literal"><span class="pre">A0000000002</span></code> is returned as return value of <code class="docutils literal"><span class="pre">Sequencer#getCurrent()</span></code> method.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>Fetch sequence value from Sequencer for which bean is defined.</p>
<ul class="simple">
<li>Service</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// omitted</span>

<span class="c1">// (1)</span>
<span class="nd">@Inject</span>
<span class="nd">@Named</span><span class="o">(</span><span class="s">&quot;articleIdSequencer&quot;</span><span class="o">)</span> <span class="c1">// (2)</span>
<span class="n">Sequencer</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">articleIdSequencer</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="n">Article</span> <span class="nf">createArticle</span><span class="o">(</span><span class="n">Article</span> <span class="n">inputArticle</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">String</span> <span class="n">articleId</span> <span class="o">=</span> <span class="n">articleIdSequencer</span><span class="o">.</span><span class="na">getNext</span><span class="o">();</span> <span class="c1">// (3)</span>
    <span class="n">inputArticle</span><span class="o">.</span><span class="na">setArticleId</span><span class="o">(</span><span class="n">articleId</span><span class="o">);</span>

    <span class="n">Article</span> <span class="n">savedArticle</span> <span class="o">=</span> <span class="n">articleRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">inputArticle</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">savedArticle</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inject <code class="docutils literal"><span class="pre">Sequencer</span></code> object for which bean is defined.</div>
<div class="line">In the above example, since sequence value is fetched as formatted string, <code class="docutils literal"><span class="pre">java.lang.String</span></code> type is specified as generics type of <code class="docutils literal"><span class="pre">Sequencer</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify bean name of the bean to be injected in value attribute of <code class="docutils literal"><span class="pre">&#64;javax.inject.Named</span></code> annotation.</div>
<div class="line">In the above example, bean name (<code class="docutils literal"><span class="pre">articleIdSequencer</span></code>) defined in <code class="file docutils literal"><span class="pre">xxx-infra.xml</span></code> is specified.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call <code class="docutils literal"><span class="pre">Sequencer#getNext()</span></code> method and fetch the subsequent sequence value.</div>
<div class="line">In the above example, fetched sequence value is used as Entity ID.</div>
<div class="line">When fetching current sequence value, call <code class="docutils literal"><span class="pre">Sequencer#getCurrent()</span></code> method.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">When <code class="docutils literal"><span class="pre">Sequencer</span></code> for which bean is defined is 1, <code class="docutils literal"><span class="pre">&#64;Named</span></code> annotation can be omitted. When specifying multiple sequencers, bean name needs to be specified using <code class="docutils literal"><span class="pre">&#64;Named</span></code> annotation.</p>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="classes-provided-by-spring-framework-for-converting-to-data-access-exception">
<span id="appendix-dataaccessexception-converter-class-label"></span><h3><a class="toc-backref" href="#id48">6.1.5.3. Classes provided by Spring Framework for converting to data access exception</a><a class="headerlink" href="#classes-provided-by-spring-framework-for-converting-to-data-access-exception" title="Permalink to this headline">Â¶</a></h3>
<p>Classes of Spring Framework which play a role in converting an exception to data access exception, are as follows:</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils" id="id8">
<caption><span class="caption-text"><strong>Classes of Spring Framework for converting to data access exception</strong></span><a class="headerlink" href="#id8" title="Permalink to this table">Â¶</a></caption>
<colgroup>
<col width="10%" />
<col width="30%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Class name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.jdbc.support.</div>
<div class="line">SQLErrorCodeSQLExceptionTranslator</div>
</div>
</td>
<td>When MyBatis or <code class="docutils literal"><span class="pre">JdbcTemplate</span></code> is used, JDBC exception is converted to data access exception of Spring Framework using this class. Conversion rules are mentioned in XML file. XML file used by default is <code class="docutils literal"><span class="pre">org/springframework/jdbc/support/sql-error-codes.xml</span></code> in <code class="docutils literal"><span class="pre">spring-jdbc.jar</span></code>.
It is also possible to change the default behavior by placing XML file (<code class="docutils literal"><span class="pre">sql-error-codes.xml</span></code>) just below class path.</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.orm.jpa.vendor.</div>
<div class="line">HibernateJpaDialect</div>
</div>
</td>
<td>When JPA (Hibernate implementation) is used, O/R Mapper exception (Hibernate exception) is converted to data access exception of Spring Framework using this class.</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.orm.jpa.</div>
<div class="line">EntityManagerFactoryUtils</div>
</div>
</td>
<td>If an exception that cannot be converted by <code class="docutils literal"><span class="pre">HibernateJpaDialect</span></code> has occurred, JPA exception is converted to data access exception of Spring Framework using this class.</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">Sub classes of</div>
<div class="line">org.hibernate.dialect.Dialect</div>
</div>
</td>
<td>When JPA (Hibernate implementation) is used, exceptions are converted to JDBC exception and O/R Mapper exception using this class.</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="jdbc-datasource-classes-provided-by-spring-framework">
<span id="appendix-datasource-of-spring-label"></span><h3><a class="toc-backref" href="#id49">6.1.5.4. JDBC datasource classes provided by Spring Framework</a><a class="headerlink" href="#jdbc-datasource-classes-provided-by-spring-framework" title="Permalink to this headline">Â¶</a></h3>
<div class="line-block">
<div class="line">Spring Framework provides implementation of JDBC datasource. However since they are very simple classes, they are rarely used in production environment.</div>
<div class="line">These classes are mainly used during Unit Testing.</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils" id="id9">
<caption><span class="caption-text"><strong>JDBC datasource classes provided by Spring Framework</strong></span><a class="headerlink" href="#id9" title="Permalink to this table">Â¶</a></caption>
<colgroup>
<col width="10%" />
<col width="35%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Class name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.jdbc.datasource.</div>
<div class="line">DriverManagerDataSource</div>
</div>
</td>
<td>Datasource class for creating new connection by calling <code class="docutils literal"><span class="pre">java.sql.DriverManager#getConnection</span></code> when connection fetch request is received from the application.
When connection pooling is required, Application Server datasource or datasource of OSS/Third-Party library should be used.</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.jdbc.datasource.</div>
<div class="line">SingleConnectionDataSource</div>
</div>
</td>
<td>Child class of <code class="docutils literal"><span class="pre">DriverManagerDataSource</span></code>.This class provides implementation of single shared connection. This is a datasource class for unit test which works with single thread.
Even in case of Unit Testing, if this class is used when datasource is to be accessed with multithread, care needs to be taken as it may not show the expected behavior.</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.jdbc.datasource.</div>
<div class="line">SimpleDriverDataSource</div>
</div>
</td>
<td>Datasource class for creating new connection by calling <code class="docutils literal"><span class="pre">java.sql.Driver#getConnection</span></code> when connection fetch request is received from the application.
When connection pooling is required, Application Server datasource or datasource of OSS/Third-Party library should be used.</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line">Spring Framework provides adapter classes with extended JDBC datasource operations.</div>
<div class="line">Specific adapter classes are introduced below.</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils" id="id10">
<caption><span class="caption-text"><strong>JDBC datasource adapter classes provided by Spring Framework</strong></span><a class="headerlink" href="#id10" title="Permalink to this table">Â¶</a></caption>
<colgroup>
<col width="10%" />
<col width="35%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Class name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.jdbc.datasource.</div>
<div class="line">TransactionAwareDataSourceProxy</div>
</div>
</td>
<td>Adapter class for converting a datasource which does not store transactions, into a datasource storing Spring Framework transactions.</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.jdbc.datasource.lookup.</div>
<div class="line">IsolationLevelDataSourceRoute</div>
</div>
</td>
<td>Adapter class for switching the datasource to be used based on independence level of an active transaction.</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="DataAccessMyBatis3.html" title="6.2. Database Access (MyBatis3)"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="6. Data Access"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.4.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >6. Data Access</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer">
      Â© Copyright 2013-2018, NTT DATA Corporation. Â© Copyright 2013-2018, NTT Corporation.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3.Theme is <a href="http://github.com/vimalkvn/solar-theme">Solar</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>
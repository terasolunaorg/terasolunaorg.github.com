<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>6.3. Database Access (JPA) &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.4.1.RELEASE documentation</title>
    <link rel="stylesheet" href="../../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '5.4.1.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="6.4. Exclusive Control" href="ExclusionControl.html" />
    <link rel="prev" title="6.2. Database Access (MyBatis3)" href="DataAccessMyBatis3.html" /><script src="../../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../../_static/solarized-dark.css" rel="stylesheet">
<link href="../../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ExclusionControl.html" title="6.4. Exclusive Control"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="DataAccessMyBatis3.html" title="6.2. Database Access (MyBatis3)"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.4.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">6. Data Access</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><br/><img src="../../_static/logo_color.png" alt="TERASOLUNA" title="TERASOLUNA" ><br/><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">6.3. Database Access (JPA)</a><ul>
<li><a class="reference internal" href="#overview">6.3.1. Overview</a><ul>
<li><a class="reference internal" href="#about-jpa">6.3.1.1. About JPA</a><ul>
<li><a class="reference internal" href="#o-r-mapping-of-jpa">6.3.1.1.1. O/R Mapping of JPA</a></li>
<li><a class="reference internal" href="#basic-jpa-terminology">6.3.1.1.2. Basic JPA terminology</a></li>
<li><a class="reference internal" href="#managing-life-cycle-of-entity">6.3.1.1.3. Managing life cycle of entity</a></li>
</ul>
</li>
<li><a class="reference internal" href="#about-spring-data-jpa">6.3.1.2. About Spring Data JPA</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">6.3.2. How to use</a><ul>
<li><a class="reference internal" href="#pom-xml-settings">6.3.2.1. pom.xml settings</a></li>
<li><a class="reference internal" href="#application-settings">6.3.2.2. Application Settings</a><ul>
<li><a class="reference internal" href="#datasource-settings">6.3.2.2.1. Datasource settings</a></li>
<li><a class="reference internal" href="#entitymanager-settings">6.3.2.2.2. EntityManager settings</a></li>
<li><a class="reference internal" href="#platformtransactionmanager-settings">6.3.2.2.3. PlatformTransactionManager settings</a></li>
<li><a class="reference internal" href="#persistence-xml-settings">6.3.2.2.4. persistence.xml settings</a></li>
<li><a class="reference internal" href="#settings-for-validating-spring-data-jpa">6.3.2.2.5. Settings for validating Spring Data JPA</a></li>
<li><a class="reference internal" href="#settings-for-using-jpa-annotations">6.3.2.2.6. Settings for using JPA annotations</a></li>
<li><a class="reference internal" href="#settings-for-converting-jpa-exception-to-dataaccessexception">6.3.2.2.7. Settings for converting JPA exception to DataAccessException</a></li>
<li><a class="reference internal" href="#openentitymanagerinviewinterceptor-settings">6.3.2.2.8. OpenEntityManagerInViewInterceptor settings</a></li>
</ul>
</li>
<li><a class="reference internal" href="#creating-repository-interface">6.3.2.3. Creating Repository interface</a><ul>
<li><a class="reference internal" href="#inheriting-the-interface-of-spring-data">6.3.2.3.1. Inheriting the interface of Spring Data</a></li>
<li><a class="reference internal" href="#inheriting-a-common-project-specific-interface-in-which-only-the-required-methods-are-defined">6.3.2.3.2. Inheriting a common project specific interface in which only the required methods are defined</a></li>
<li><a class="reference internal" href="#not-inheriting-the-interface">6.3.2.3.3. Not inheriting the interface</a></li>
</ul>
</li>
<li><a class="reference internal" href="#adding-query-method">6.3.2.4. Adding query method</a><ul>
<li><a class="reference internal" href="#defining-query-method">6.3.2.4.1. Defining query method</a></li>
<li><a class="reference internal" href="#specifying-query-to-be-executed">6.3.2.4.2. Specifying query to be executed</a></li>
<li><a class="reference internal" href="#fetching-entity-lock">6.3.2.4.3. Fetching entity lock</a></li>
<li><a class="reference internal" href="#operating-the-entities-of-persistence-layer-directly">6.3.2.4.4. Operating the entities of Persistence Layer directly</a></li>
<li><a class="reference internal" href="#setting-queryhints">6.3.2.4.5. Setting QueryHints</a></li>
</ul>
</li>
<li><a class="reference internal" href="#specifying-a-query-while-calling-a-query-method">6.3.2.5. Specifying a query while calling a query method</a><ul>
<li><a class="reference internal" href="#specifying-the-query-using-query-annotation">6.3.2.5.1. Specifying the query using &#64;Query annotation</a></li>
<li><a class="reference internal" href="#specifying-with-the-method-name-based-on-naming-conventions">6.3.2.5.2. Specifying with the method name based on naming conventions</a></li>
<li><a class="reference internal" href="#specifying-as-named-query-in-properties-file">6.3.2.5.3. Specifying as Named query in Properties file</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementing-the-process-to-search-entities">6.3.2.6. Implementing the process to search entities</a><ul>
<li><a class="reference internal" href="#searching-all-entities-matching-the-conditions">6.3.2.6.1. Searching all entities matching the conditions</a></li>
<li><a class="reference internal" href="#searching-page-of-entities-matching-the-conditions">6.3.2.6.2. Searching page of entities matching the conditions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementing-search-process-as-per-the-dynamic-conditions-of-entities">6.3.2.7. Implementing search process as per the dynamic conditions of entities</a><ul>
<li><a class="reference internal" href="#searching-all-entities-matching-the-dynamic-conditions">6.3.2.7.1. Searching all entities matching the dynamic conditions</a></li>
<li><a class="reference internal" href="#page-search-for-the-entities-matching-the-dynamic-conditions">6.3.2.7.2. Page search for the entities matching the dynamic conditions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementing-the-process-to-fetch-entities">6.3.2.8. Implementing the process to fetch entities</a><ul>
<li><a class="reference internal" href="#fetching-1-record-of-entity-by-specifying-id">6.3.2.8.1. Fetching 1 record of entity by specifying ID</a></li>
<li><a class="reference internal" href="#fetching-1-record-of-entity-by-specifying-conditions-other-than-id">6.3.2.8.2. Fetching 1 record of entity by specifying conditions other than ID</a></li>
</ul>
</li>
<li><a class="reference internal" href="#adding-entities">6.3.2.9. Adding entities</a><ul>
<li><a class="reference internal" href="#how-to-add-entities">6.3.2.9.1. How to add entities</a></li>
<li><a class="reference internal" href="#adding-parent-entity-and-related-entity">6.3.2.9.2. Adding parent-entity and related-entity</a></li>
<li><a class="reference internal" href="#adding-the-related-entity">6.3.2.9.3. Adding the related-entity</a></li>
<li><a class="reference internal" href="#adding-the-related-entity-directly">6.3.2.9.4. Adding the related-entity directly</a></li>
</ul>
</li>
<li><a class="reference internal" href="#updating-entities">6.3.2.10. Updating entities</a><ul>
<li><a class="reference internal" href="#how-to-update-entities">6.3.2.10.1. How to update entities</a></li>
<li><a class="reference internal" href="#updating-the-related-entity">6.3.2.10.2. Updating the related-entity</a></li>
<li><a class="reference internal" href="#updating-the-related-entity-directly">6.3.2.10.3. Updating the related-entity directly</a></li>
<li><a class="reference internal" href="#updating-by-using-query-method">6.3.2.10.4. Updating by using query method</a></li>
</ul>
</li>
<li><a class="reference internal" href="#deleting-entities">6.3.2.11. Deleting entities</a><ul>
<li><a class="reference internal" href="#deleting-parent-entity-and-related-entity">6.3.2.11.1. Deleting parent-entity and related-entity</a></li>
<li><a class="reference internal" href="#deleting-the-related-entity">6.3.2.11.2. Deleting the related-entity</a></li>
<li><a class="reference internal" href="#deleting-the-related-entity-directly">6.3.2.11.3. Deleting the related-entity directly</a></li>
<li><a class="reference internal" href="#deleting-using-query-method">6.3.2.11.4. Deleting using query method</a></li>
</ul>
</li>
<li><a class="reference internal" href="#escaping-at-the-time-of-like-search">6.3.2.12. Escaping at the time of LIKE search</a><ul>
<li><a class="reference internal" href="#usage-method-when-type-of-matching-is-to-be-specified-in-query">6.3.2.12.1. Usage method when type of matching is to be specified in query</a></li>
<li><a class="reference internal" href="#usage-method-when-specifying-type-of-matching-in-logic">6.3.2.12.2. Usage method when specifying type of matching in logic</a></li>
</ul>
</li>
<li><a class="reference internal" href="#join-fetch">6.3.2.13. JOIN FETCH</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend">6.3.3. How to extend</a><ul>
<li><a class="reference internal" href="#how-to-add-custom-method">6.3.3.1. How to add custom method</a><ul>
<li><a class="reference internal" href="#adding-individual-custom-method-to-entity-specific-repository-interface">6.3.3.1.1. Adding individual custom method to entity specific Repository interface</a></li>
<li><a class="reference internal" href="#adding-the-custom-methods-to-all-repository-interfaces-in-batch">6.3.3.1.2. Adding the custom methods to all Repository interfaces in batch</a></li>
</ul>
</li>
<li><a class="reference internal" href="#storing-query-fetch-results-in-objects-other-than-entity">6.3.3.2. Storing query fetch results in objects other than entity</a></li>
<li><a class="reference internal" href="#setting-audit-properties">6.3.3.3. Setting Audit properties</a></li>
<li><a class="reference internal" href="#adding-common-conditions-to-jpql-to-fetch-entities-from-persistence-layer">6.3.3.4. Adding common conditions to JPQL to fetch entities from persistence layer</a><ul>
<li><a class="reference internal" href="#adding-common-conditions-in-jpql-to-fetch-entities">6.3.3.4.1. Adding common conditions in JPQL to fetch entities</a></li>
<li><a class="reference internal" href="#adding-common-conditions-to-jpql-to-fetch-the-related-entities">6.3.3.4.2. Adding common conditions to JPQL to fetch the related-entities</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use-multiple-persistenceunits">6.3.3.5. How to use multiple PersistenceUnits</a></li>
<li><a class="reference internal" href="#how-to-use-native-query">6.3.3.6. How to use Native query</a></li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="DataAccessMyBatis3.html"
                        title="previous chapter">6.2. Database Access (MyBatis3)</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="ExclusionControl.html"
                        title="next chapter">6.4. Exclusive Control</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/ArchitectureInDetail/DataAccessDetail/DataAccessJpa.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="database-access-jpa">
<h1>6.3. Database Access (JPA)<a class="headerlink" href="#database-access-jpa" title="Permalink to this headline">¶</a></h1>
<div class="admonition caution">
  <p class="first admonition-title">Caution</p>
  <p><strong>This version is already obsolete</strong>. Please check <a href="http://terasolunaorg.github.io/guideline/">the latest guideline</a>.</p>
</div>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id13">Overview</a><ul>
<li><a class="reference internal" href="#about-jpa" id="id14">About JPA</a><ul>
<li><a class="reference internal" href="#o-r-mapping-of-jpa" id="id15">O/R Mapping of JPA</a></li>
<li><a class="reference internal" href="#basic-jpa-terminology" id="id16">Basic JPA terminology</a></li>
<li><a class="reference internal" href="#managing-life-cycle-of-entity" id="id17">Managing life cycle of entity</a></li>
</ul>
</li>
<li><a class="reference internal" href="#about-spring-data-jpa" id="id18">About Spring Data JPA</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use" id="id19">How to use</a><ul>
<li><a class="reference internal" href="#pom-xml-settings" id="id20">pom.xml settings</a></li>
<li><a class="reference internal" href="#application-settings" id="id21">Application Settings</a><ul>
<li><a class="reference internal" href="#datasource-settings" id="id22">Datasource settings</a></li>
<li><a class="reference internal" href="#entitymanager-settings" id="id23">EntityManager settings</a></li>
<li><a class="reference internal" href="#platformtransactionmanager-settings" id="id24">PlatformTransactionManager settings</a></li>
<li><a class="reference internal" href="#persistence-xml-settings" id="id25">persistence.xml settings</a></li>
<li><a class="reference internal" href="#settings-for-validating-spring-data-jpa" id="id26">Settings for validating Spring Data JPA</a></li>
<li><a class="reference internal" href="#settings-for-using-jpa-annotations" id="id27">Settings for using JPA annotations</a></li>
<li><a class="reference internal" href="#settings-for-converting-jpa-exception-to-dataaccessexception" id="id28">Settings for converting JPA exception to DataAccessException</a></li>
<li><a class="reference internal" href="#openentitymanagerinviewinterceptor-settings" id="id29">OpenEntityManagerInViewInterceptor settings</a></li>
</ul>
</li>
<li><a class="reference internal" href="#creating-repository-interface" id="id30">Creating Repository interface</a><ul>
<li><a class="reference internal" href="#inheriting-the-interface-of-spring-data" id="id31">Inheriting the interface of Spring Data</a></li>
<li><a class="reference internal" href="#inheriting-a-common-project-specific-interface-in-which-only-the-required-methods-are-defined" id="id32">Inheriting a common project specific interface in which only the required methods are defined</a></li>
<li><a class="reference internal" href="#not-inheriting-the-interface" id="id33">Not inheriting the interface</a></li>
</ul>
</li>
<li><a class="reference internal" href="#adding-query-method" id="id34">Adding query method</a><ul>
<li><a class="reference internal" href="#defining-query-method" id="id35">Defining query method</a></li>
<li><a class="reference internal" href="#specifying-query-to-be-executed" id="id36">Specifying query to be executed</a></li>
<li><a class="reference internal" href="#fetching-entity-lock" id="id37">Fetching entity lock</a></li>
<li><a class="reference internal" href="#operating-the-entities-of-persistence-layer-directly" id="id38">Operating the entities of Persistence Layer directly</a></li>
<li><a class="reference internal" href="#setting-queryhints" id="id39">Setting QueryHints</a></li>
</ul>
</li>
<li><a class="reference internal" href="#specifying-a-query-while-calling-a-query-method" id="id40">Specifying a query while calling a query method</a><ul>
<li><a class="reference internal" href="#specifying-the-query-using-query-annotation" id="id41">Specifying the query using &#64;Query annotation</a></li>
<li><a class="reference internal" href="#specifying-with-the-method-name-based-on-naming-conventions" id="id42">Specifying with the method name based on naming conventions</a></li>
<li><a class="reference internal" href="#specifying-as-named-query-in-properties-file" id="id43">Specifying as Named query in Properties file</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementing-the-process-to-search-entities" id="id44">Implementing the process to search entities</a><ul>
<li><a class="reference internal" href="#searching-all-entities-matching-the-conditions" id="id45">Searching all entities matching the conditions</a></li>
<li><a class="reference internal" href="#searching-page-of-entities-matching-the-conditions" id="id46">Searching page of entities matching the conditions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementing-search-process-as-per-the-dynamic-conditions-of-entities" id="id47">Implementing search process as per the dynamic conditions of entities</a><ul>
<li><a class="reference internal" href="#searching-all-entities-matching-the-dynamic-conditions" id="id48">Searching all entities matching the dynamic conditions</a></li>
<li><a class="reference internal" href="#page-search-for-the-entities-matching-the-dynamic-conditions" id="id49">Page search for the entities matching the dynamic conditions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementing-the-process-to-fetch-entities" id="id50">Implementing the process to fetch entities</a><ul>
<li><a class="reference internal" href="#fetching-1-record-of-entity-by-specifying-id" id="id51">Fetching 1 record of entity by specifying ID</a></li>
<li><a class="reference internal" href="#fetching-1-record-of-entity-by-specifying-conditions-other-than-id" id="id52">Fetching 1 record of entity by specifying conditions other than ID</a></li>
</ul>
</li>
<li><a class="reference internal" href="#adding-entities" id="id53">Adding entities</a><ul>
<li><a class="reference internal" href="#how-to-add-entities" id="id54">How to add entities</a></li>
<li><a class="reference internal" href="#adding-parent-entity-and-related-entity" id="id55">Adding parent-entity and related-entity</a></li>
<li><a class="reference internal" href="#adding-the-related-entity" id="id56">Adding the related-entity</a></li>
<li><a class="reference internal" href="#adding-the-related-entity-directly" id="id57">Adding the related-entity directly</a></li>
</ul>
</li>
<li><a class="reference internal" href="#updating-entities" id="id58">Updating entities</a><ul>
<li><a class="reference internal" href="#how-to-update-entities" id="id59">How to update entities</a></li>
<li><a class="reference internal" href="#updating-the-related-entity" id="id60">Updating the related-entity</a></li>
<li><a class="reference internal" href="#updating-the-related-entity-directly" id="id61">Updating the related-entity directly</a></li>
<li><a class="reference internal" href="#updating-by-using-query-method" id="id62">Updating by using query method</a></li>
</ul>
</li>
<li><a class="reference internal" href="#deleting-entities" id="id63">Deleting entities</a><ul>
<li><a class="reference internal" href="#deleting-parent-entity-and-related-entity" id="id64">Deleting parent-entity and related-entity</a></li>
<li><a class="reference internal" href="#deleting-the-related-entity" id="id65">Deleting the related-entity</a></li>
<li><a class="reference internal" href="#deleting-the-related-entity-directly" id="id66">Deleting the related-entity directly</a></li>
<li><a class="reference internal" href="#deleting-using-query-method" id="id67">Deleting using query method</a></li>
</ul>
</li>
<li><a class="reference internal" href="#escaping-at-the-time-of-like-search" id="id68">Escaping at the time of LIKE search</a><ul>
<li><a class="reference internal" href="#usage-method-when-type-of-matching-is-to-be-specified-in-query" id="id69">Usage method when type of matching is to be specified in query</a></li>
<li><a class="reference internal" href="#usage-method-when-specifying-type-of-matching-in-logic" id="id70">Usage method when specifying type of matching in logic</a></li>
</ul>
</li>
<li><a class="reference internal" href="#join-fetch" id="id71">JOIN FETCH</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend" id="id72">How to extend</a><ul>
<li><a class="reference internal" href="#how-to-add-custom-method" id="id73">How to add custom method</a><ul>
<li><a class="reference internal" href="#adding-individual-custom-method-to-entity-specific-repository-interface" id="id74">Adding individual custom method to entity specific Repository interface</a></li>
<li><a class="reference internal" href="#adding-the-custom-methods-to-all-repository-interfaces-in-batch" id="id75">Adding the custom methods to all Repository interfaces in batch</a></li>
</ul>
</li>
<li><a class="reference internal" href="#storing-query-fetch-results-in-objects-other-than-entity" id="id76">Storing query fetch results in objects other than entity</a></li>
<li><a class="reference internal" href="#setting-audit-properties" id="id77">Setting Audit properties</a></li>
<li><a class="reference internal" href="#adding-common-conditions-to-jpql-to-fetch-entities-from-persistence-layer" id="id78">Adding common conditions to JPQL to fetch entities from persistence layer</a><ul>
<li><a class="reference internal" href="#adding-common-conditions-in-jpql-to-fetch-entities" id="id79">Adding common conditions in JPQL to fetch entities</a></li>
<li><a class="reference internal" href="#adding-common-conditions-to-jpql-to-fetch-the-related-entities" id="id80">Adding common conditions to JPQL to fetch the related-entities</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use-multiple-persistenceunits" id="id81">How to use multiple PersistenceUnits</a></li>
<li><a class="reference internal" href="#how-to-use-native-query" id="id82">How to use Native query</a></li>
</ul>
</li>
</ul>
</div>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p>The following topics in this chapter are currently under study.</p>
<ul class="last">
<li><div class="first line-block">
<div class="line"><code class="file docutils literal"><span class="pre">persistence.xml</span></code> settings</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Implementing dynamic query using QueryDSL</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Examples of cases wherein it is desirable to change the default setting values for specifying fetch method of related-entities.</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Using multiple PersistenceUnits</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Using Native query</div>
</div>
</li>
</ul>
</div>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id13">6.3.1. Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line">This section explains the method to access the database using JPA.</div>
<div class="line">In this guideline, it is assumed that Hibernate is used as JPA provider and Spring Data JPA as JPA wrapper.</div>
</div>
<blockquote>
<div><div class="figure align-center" id="id2">
<a class="reference internal image-reference" href="../../_images/dataaccess_jpa.png"><img alt="Target of description" src="../../_images/dataaccess_jpa.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Target of description</strong></span></p>
</div>
</div></blockquote>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The contents described in this chapter may not be applicable for JPA providers other than Hibernate such as EclipseLink etc.</p>
</div>
<div class="section" id="about-jpa">
<h3><a class="toc-backref" href="#id14">6.3.1.1. About JPA</a><a class="headerlink" href="#about-jpa" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>JPA (Java Persistence API) defines the following as an API of Java:</dt>
<dd><ol class="first last arabic simple">
<li>a way of mapping the records in a relational database, with the java objects</li>
<li>a mechanism for reflecting the operations done on the java object, to the records in a relational database.</li>
</ol>
</dd>
</dl>
<div class="line-block">
<div class="line">JPA defines only specifications, it does not provide implementation.</div>
<div class="line">JPA implementation is provided as a reference implementation by the vendors developing O/R Mapper such as Hibernate.</div>
<div class="line">The reference implementation provided by the vendors developing O/R Mapper is called JPA Provider.</div>
</div>
<div class="section" id="o-r-mapping-of-jpa">
<h4><a class="toc-backref" href="#id15">6.3.1.1.1. O/R Mapping of JPA</a><a class="headerlink" href="#o-r-mapping-of-jpa" title="Permalink to this headline">¶</a></h4>
<p>Mapping of Java objects to the relational database records at the time of using JPA is as follows:</p>
<blockquote>
<div><div class="figure align-center" id="id3">
<a class="reference internal image-reference" href="../../_images/dataaccess_jpa_mapping.png"><img alt="Image of O/R Mapping" src="../../_images/dataaccess_jpa_mapping.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Image of O/R Mapping</strong></span></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">In JPA, if the value stored in the “managed” entity is changed (by calling setter method), there is a mechanism to reflect the changes in the relational database.</div>
<div class="line">This mechanism is quite similar to the client software such as Table viewer with Edit functionality.</div>
<div class="line">In client software such as Table viewer, if the value of viewer is changed, it is reflected in the database. While in JPA, if the value of Java object (JavaBean) called “Entity” is changed, it is reflected in the database.</div>
</div>
</div>
<div class="section" id="basic-jpa-terminology">
<h4><a class="toc-backref" href="#id16">6.3.1.1.2. Basic JPA terminology</a><a class="headerlink" href="#basic-jpa-terminology" title="Permalink to this headline">¶</a></h4>
<p>The basic terminology of JPA is described below.</p>
<blockquote>
<div><table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Term</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">Entity class</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A Java class representing the records in the relational database</div>
<div class="line">The class with <code class="docutils literal"><span class="pre">&#64;javax.persistence.Entity</span></code> annotation is an Entity class.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">EntityManager</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">An interface which provides API necessary for managing the life cycle of entity</div>
<div class="line">Using methods of <code class="docutils literal"><span class="pre">javax.persistence.EntityManager</span></code>, the application handles the relational database records as Java objects.</div>
<div class="line">When using Spring Data JPA, this interface is usually not used directly; however, if it is necessary to generate a query that cannot be expressed using the Spring Data JPA mechanism, then this interface can be used to fetch the entity.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">TypedQuery</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">An interface which provides API for searching an entity</div>
<div class="line">Using methods of <code class="docutils literal"><span class="pre">javax.persistence.TypedQuery</span></code>, the application searches for the entity matching the specified conditions other than ID.</div>
<div class="line">When using Spring Data JPA, this interface is usually not used directly; however, if it is necessary to generate a query that cannot be expressed using Spring Data JPA mechanism, then this interface can be used to search the entity.</div>
<div class="line">The method for directly operating (updating or deleting) the entity of persistence layer (DB) matching the conditions, is also provided in this interface.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">PersistenceContext</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Area for managing entities</div>
<div class="line">The life cycle of an entity that is fetched or created through <code class="docutils literal"><span class="pre">EntityManager</span></code> is managed by storing that entity in this area. The entity managed in this area is referred to as “Managed Entity”.</div>
<div class="line">This area cannot be directly accessed from the application.</div>
<div class="line">Apart from “Managed” entity, the other states of entity are “New”, “Removed” and “Detached”.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">find method</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Method for fetching “managed” entity</div>
<div class="line">If the entity corresponding to the ID does not exist in PersistenceContext, get (SELECT) the records stored in the relational database and create a “managed” entity.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">persist method</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Method for setting “new” entity created in the application, to “managed” entity</div>
<div class="line">It is a method of <code class="docutils literal"><span class="pre">EntityManager</span></code> and all the operations performed to INSERT the records in the relational database are accumulated in PersistenceContext (and later reflected to the database at the time of transaction commit or when the flush method of EntityManager is called).</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">merge method</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Method for setting the “detached” entity which is not managed in PersistenceContext, to “managed” entity.</div>
<div class="line">It is a method of <code class="docutils literal"><span class="pre">EntityManager</span></code> and the all operations performed to UPDATE the records stored in a relational database are accumulated in PersistenceContext (and later reflected to the database at the time of transaction commit or when the flush method of EntityManager is called).</div>
<div class="line">However, if the record matching the ID does not exist in the relational database, then INSERT is executed instead of UPDATE.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="8">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">remove method</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Method for setting the “managed” entity to “removed” entity</div>
<div class="line">It is a method of <code class="docutils literal"><span class="pre">EntityManager</span></code> and all the operations performed to DELETE the records stored in a relational database are accumulated in PersistenceContext.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="9">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">flush method</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Method for forcibly reflecting the operations performed for the entity managed in PersistenceContext to the relational database.</div>
<div class="line">It is a method of <code class="docutils literal"><span class="pre">EntityManager</span></code> and the accumulated un-reflected operations are reflected in the relational database.</div>
<div class="line">Normally, operations are reflected to the relational database only when a transaction is committed; however, flush method is used when the operation needs to be reflected in the database before committing a transaction.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="managing-life-cycle-of-entity">
<h4><a class="toc-backref" href="#id17">6.3.1.1.3. Managing life cycle of entity</a><a class="headerlink" href="#managing-life-cycle-of-entity" title="Permalink to this headline">¶</a></h4>
<p>The life cycle of entity is managed as follows:</p>
<blockquote>
<div><div class="figure align-center" id="id4">
<a class="reference internal image-reference" href="../../_images/dataaccess_jpa_lifecycle.png"><img alt="Life cycle of entity" src="../../_images/dataaccess_jpa_lifecycle.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Life cycle of entity</strong></span></p>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When persist method of <code class="docutils literal"><span class="pre">EntityManager</span></code> is called, the entity (“New” entity) passed as an argument is stored in PersistenceContext as “managed” entity.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When find method of <code class="docutils literal"><span class="pre">EntityManager</span></code> is called, a “managed” entity with ID passed as an argument, is returned.</div>
<div class="line">If it does not exist in PersistenceContext, the records to be mapped are retrieved from the relational database by executing a query and stored as “managed” entity.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When merge method of <code class="docutils literal"><span class="pre">EntityManager</span></code> is called, the state of the entity (“detached”) passed as an argument, is merged with “managed” entity.</div>
<div class="line">If it does not exist in PersistenceContext, the records to be mapped are retrieved from the relational database by executing a query. The state of the entity passed as an argument is merged after the “managed” entity is stored.</div>
<div class="line">Note that when this method is called, the entity passed as an argument does not necessarily get stored as “managed” entity unlike persist method.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When remove method of <code class="docutils literal"><span class="pre">EntityManager</span></code> is called, the “managed” entity passed as an argument becomes “removed” entity.</div>
<div class="line">If this method is called, it is not possible to retrieve the “removed” entity.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When flush method of <code class="docutils literal"><span class="pre">EntityManager</span></code> is called, the operations of the entity accumulated using persist, merge and remove methods are reflected in the relational database.</div>
<div class="line">By calling this method, the changes done for an entity are synchronized with the records of relational database.</div>
<div class="line">However, the changes made only for the records of relational database are not synchronized with the entity.</div>
<div class="line"><br /></div>
<div class="line">If the entity is searched by executing a query without using find method of <code class="docutils literal"><span class="pre">EntityManager</span></code>, then prior to the search process, a process similar to flush method is executed in the internal logic of <code class="docutils literal"><span class="pre">EntityManager</span></code> and the operations of the accumulated entity are reflected in the relational database.</div>
<div class="line">For timing to reflect the persistence operations at the time of using Spring Data JPA,</div>
<div class="line">refer to</div>
<div class="line-block">
<div class="line"><a class="reference internal" href="#how-to-create-repository-extends-springdata-flush-timing-note1"><span class="std std-ref">Reflection timing of persistence processing (1)</span></a></div>
<div class="line"><a class="reference internal" href="#how-to-create-repository-extends-springdata-flush-timing-note2"><span class="std std-ref">Reflection timing of persistence processing (2)</span></a></div>
</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p></p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>About other life cycle management methods</strong></p>
<p>The detach method, refresh method and clear method are available in <code class="docutils literal"><span class="pre">EntityManager</span></code> to manage the entity life cycle. However,
when using Spring Data JPA, there is no mechanism to call these methods using the default function, hence only their roles are described below.</p>
<ul class="simple">
<li>detach method is used to set a “managed” entity to “detached” entity.</li>
<li>refresh method is used to update the “managed” entity as per the state of relational database.</li>
<li>clear method is used to delete the entity managed in PersistenceContext and the accumulated operations from the memory.</li>
</ul>
<p class="last">clear method can be called by setting the clearAutomatically attribute of  <code class="docutils literal"><span class="pre">&#64;Modifying</span></code> annotation of Spring Data JPA to <code class="docutils literal"><span class="pre">true</span></code>.
For details, refer to <a class="reference internal" href="#data-access-jpa-howtouse-querymethod-modifying"><span class="std std-ref">Operating the entities of Persistence Layer directly</span></a>.</p>
</div>
</div></blockquote>
<p></p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>About operations of “new” and “detached” entities</strong></p>
<p class="last">The operations performed on “new” and “detached” entities are not reflected in the relational database unless persist method or merge method is called.</p>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="about-spring-data-jpa">
<h3><a class="toc-backref" href="#id18">6.3.1.2. About Spring Data JPA</a><a class="headerlink" href="#about-spring-data-jpa" title="Permalink to this headline">¶</a></h3>
<p>Spring Data JPA provides the library to create Repository using JPA.</p>
<div class="line-block">
<div class="line">If Spring Data JPA is used, it is possible to retrieve an entity that matches the specified conditions only by defining the</div>
<div class="line">query method in the Repository interface; hence the amount of implementation for performing the entity operations can be reduced.</div>
<div class="line">However, only static query which can be expressed using annotation, can be defined in query method; hence</div>
<div class="line">it is necessary to implement custom Repository class for the query such as dynamic query which cannot be expressed using annotation.</div>
</div>
<p>The basic flow at the time of accessing the database using Spring Data JPA is shown below.</p>
<blockquote>
<div><div class="figure align-center" id="id5">
<a class="reference internal image-reference" href="../../_images/dataaccess_jpa_basic_flow.png"><img alt="Basic flow of Spring Data JPA" src="../../_images/dataaccess_jpa_basic_flow.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Basic flow of Spring Data JPA</strong></span></p>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call the method of Repository interface from Service.</div>
<div class="line">Entity object, Entity ID etc. are passed as method calling parameters. In the above example, entity is passed, however a primitive value can also be passed.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Proxy class which dynamically implements Repository interface, delegates the process to <code class="docutils literal"><span class="pre">org.springframework.data.jpa.repository.support.SimpleJpaRepository</span></code> or custom Repository class.</div>
<div class="line">Parameters specified by Service are passed.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Repository implementation class calls JPA APIs.</div>
<div class="line">The parameters specified by Service and the parameters generated by implementation class of Repository are passed.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Hibernate JPA reference implementation calls the Hibernate core APIs.</div>
<div class="line">The parameters specified by implementation class of Repository and the parameters generated by Hibernate JPA reference implementation are passed.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Hibernate Core API generates SQL and bind values from the specified parameters and passes to JDBC driver.</div>
<div class="line">(API of java.sql.PreparedStatement is used for binding the actual values.)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JDBC driver executes SQL.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line">When creating the repository using Spring Data JPA, APIs of JPA need not be called directly; however, it is better to know which JPA method is being called by</div>
<div class="line">methods of Repository interface of Spring Data JPA.</div>
<div class="line">The JPA methods called by main methods of Repository interface of Spring Data JPA are shown below.</div>
</div>
<blockquote>
<div><div class="figure align-center" id="id6">
<a class="reference internal image-reference" href="../../_images/dataaccess_jpa_api-mapping.png"><img alt="API Mapping of Spring Data JPA and JPA" src="../../_images/dataaccess_jpa_api-mapping.png" style="width: 90%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - API Mapping of Spring Data JPA and JPA</strong></span></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="how-to-use">
<h2><a class="toc-backref" href="#id19">6.3.2. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<div class="section" id="pom-xml-settings">
<h3><a class="toc-backref" href="#id20">6.3.2.1. pom.xml settings</a><a class="headerlink" href="#pom-xml-settings" title="Permalink to this headline">¶</a></h3>
<p>When using JPA (Spring Data JPA) in infrastructure layer, add the following dependency to pom.xml</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.terasoluna.gfw<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>terasoluna-gfw-jpa-dependencies<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">terasoluna-gfw-jpa-dependencies</span></code> where the libraries associated with JPA are defined should be added to dependency.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In the above setting example, since it is assumed that the dependent library version is managed by the parent project terasoluna-gfw-parent, specifying the version in pom.xml is not necessary.</p>
</div>
</div>
<div class="section" id="application-settings">
<h3><a class="toc-backref" href="#id21">6.3.2.2. Application Settings</a><a class="headerlink" href="#application-settings" title="Permalink to this headline">¶</a></h3>
<div class="section" id="datasource-settings">
<h4><a class="toc-backref" href="#id22">6.3.2.2.1. Datasource settings</a><a class="headerlink" href="#datasource-settings" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Set connection information of the database to datasource.</div>
<div class="line">For datasource settings, refer to <a class="reference internal" href="DataAccessCommon.html#data-access-common-howtouse-datasource"><span class="std std-ref">Datasource settings</span></a>.</div>
</div>
</div>
<div class="section" id="entitymanager-settings">
<h4><a class="toc-backref" href="#id23">6.3.2.2.2. EntityManager settings</a><a class="headerlink" href="#entitymanager-settings" title="Permalink to this headline">¶</a></h4>
<p>Perform settings to use <code class="docutils literal"><span class="pre">EntityManager</span></code>.</p>
<ul class="simple">
<li>xxx-infra.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;jpaVendorAdapter&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;showSql&quot;</span> <span class="na">value=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;database&quot;</span> <span class="na">value=</span><span class="s">&quot;POSTGRESQL&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;entityManagerFactory&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- (5) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;packagesToScan&quot;</span> <span class="na">value=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- (6) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- (7) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;jpaVendorAdapter&quot;</span> <span class="na">ref=</span><span class="s">&quot;jpaVendorAdapter&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- (8) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;jpaPropertyMap&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:map&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.hbm2ddl.auto&quot;</span> <span class="na">value=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.ejb.naming_strategy&quot;</span>
                <span class="na">value=</span><span class="s">&quot;org.hibernate.cfg.ImprovedNamingStrategy&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.connection.charSet&quot;</span> <span class="na">value=</span><span class="s">&quot;UTF-8&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.show_sql&quot;</span> <span class="na">value=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.format_sql&quot;</span> <span class="na">value=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.use_sql_comments&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.jdbc.batch_size&quot;</span> <span class="na">value=</span><span class="s">&quot;30&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.jdbc.fetch_size&quot;</span> <span class="na">value=</span><span class="s">&quot;100&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/util:map&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the adapter class associated with JPA provider.</div>
<div class="line">Hibernate will be used as JPA provider; hence specify <code class="docutils literal"><span class="pre">org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>Set the SQL output flag. In the example, “false: Do not output” has been specified.</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set the value corresponding to RDBMS to be used. It is possible to specify the value defined in <code class="docutils literal"><span class="pre">org.springframework.orm.jpa.vendor.Database</span></code> enumerator type.</div>
<div class="line">In the example, “PostgreSQL” has been specified.</div>
<div class="line"><strong>[The value should be changed according to the database used in the project]</strong></div>
<div class="line">If the database to be used changes with the environment, the value should be defined in properties file.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify FactoryBean class to create <code class="docutils literal"><span class="pre">javax.persistence.EntityManagerFactory</span></code> instance.</div>
<div class="line">Specify <code class="docutils literal"><span class="pre">org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean</span></code> .</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the package where entity classes are kept.</div>
<div class="line">The entity classes of the specified package can be managed using <code class="docutils literal"><span class="pre">javax.persistence.EntityManager</span></code>.</div>
<div class="line"><strong>[The value should be changed to the relevant package name according to the project]</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the datasource to be used for accessing persistence layer (DB).</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify <code class="docutils literal"><span class="pre">JpaVendorAdapter</span></code> bean.</div>
<div class="line">Specify the bean set in (1).</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the settings to configure <code class="docutils literal"><span class="pre">EntityManager</span></code> of Hibernate.</div>
<div class="line">For details, refer to “<a class="reference external" href="http://docs.jboss.org/hibernate/orm/4.3/manual/en-US/html/ch03.html#configuration-optional">Hibernate Reference Documentation</a>” .</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p></p>
<blockquote>
<div><div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>When using the Oracle database, ANSI standard SQL JOIN for combining tables, can be used by specifying the following settings in <code class="docutils literal"><span class="pre">jpaPropertyMap</span></code> mentioned in (8).</p>
<blockquote class="last">
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;entityManagerFactory&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;jpaPropertyMap&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:map&gt;</span>
            <span class="c">&lt;!-- omitted --&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.dialect&quot;</span>
                   <span class="na">value=</span><span class="s">&quot;org.hibernate.dialect.Oracle12cDialect&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (9) --&gt;</span>
        <span class="nt">&lt;/util:map&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify <code class="docutils literal"><span class="pre">org.hibernate.dialect.Oracle12cDialect</span></code> in <code class="docutils literal"><span class="pre">hibernate.dialect</span></code>.</div>
<div class="line">By specifying <code class="docutils literal"><span class="pre">Oracle12cDialect</span></code>, ANSI standard SQL JOIN clause for combining the tables can be used.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">Perform the following settings when transaction manager (JTA) of the application server is to be used.</div>
<div class="line">The difference with the case wherein JTA is not used, is explained below.</div>
<div class="line">For other locations, same settings as the case wherein JTA is not used can be performed.</div>
</div>
<ul class="simple">
<li>xxx-infra.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;entityManagerFactory&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="c">&lt;!-- (10) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;jtaDataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;jpaPropertyMap&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:map&gt;</span>

            <span class="c">&lt;!-- omitted --&gt;</span>

            <span class="c">&lt;!-- (11)  --&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.transaction.jta.platform&quot;</span>
                <span class="na">value=</span><span class="s">&quot;org.hibernate.service.jta.platform.internal.WeblogicJtaPlatform&quot;</span> <span class="nt">/&gt;</span>

        <span class="nt">&lt;/util:map&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the datasource to be used for accessing persistence layer (DB).</div>
<div class="line">When using JTA, specify the DataSource defined in application server in <code class="docutils literal"><span class="pre">jtaDataSource</span></code> property and not in <code class="docutils literal"><span class="pre">dataSource</span></code> property.</div>
<div class="line">Refer to <a class="reference internal" href="DataAccessCommon.html#data-access-common-howtouse-datasource"><span class="std std-ref">Datasource settings</span></a> of common edition for the method to fetch DataSource defined in application server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Add JTA platform specification in <code class="docutils literal"><span class="pre">jpaPropertyMap</span></code> property.</div>
<div class="line">The above example illustrates usage of Weblogic JTA.</div>
<div class="line">The configurable value (platform) is FQCN of <code class="docutils literal"><span class="pre">org.hibernate.service.jta.platform.spi.JtaPlatform</span></code> implementation class.</div>
<div class="line">The implementation class for main application servers is provided by Hibernate.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p></p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>When it is necessary to switch the transaction manager to be used as per the environment, then it is recommended that you define <code class="docutils literal"><span class="pre">entityManagerFactory</span></code> bean in <code class="file docutils literal"><span class="pre">xxx-env.xml</span></code> instead of <code class="file docutils literal"><span class="pre">xxx-infra.xml</span></code>.</p>
<p class="last">An example wherein it is necessary to change the transaction manager as per environment can be: use of application server without JTA function such as Tomcat in case of local environment,
and use of application server with JTA function such as Weblogic in case of production environment as well as various test environments.</p>
</div>
</div></blockquote>
</div>
<div class="section" id="platformtransactionmanager-settings">
<h4><a class="toc-backref" href="#id24">6.3.2.2.3. PlatformTransactionManager settings</a><a class="headerlink" href="#platformtransactionmanager-settings" title="Permalink to this headline">¶</a></h4>
<p>Perform the following settings when using local transaction.</p>
<ul class="simple">
<li>xxx-env.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;transactionManager&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.orm.jpa.JpaTransactionManager&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;entityManagerFactory&quot;</span> <span class="na">ref=</span><span class="s">&quot;entityManagerFactory&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="6%" />
<col width="94%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>Specify <code class="docutils literal"><span class="pre">org.springframework.orm.jpa.JpaTransactionManager</span></code>. This class controls transaction by calling APIs of JPA.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify Factory of <code class="docutils literal"><span class="pre">EntityManager</span></code> to be used in the transaction.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>Perform the following settings when transaction manager (JTA) of the application server is to be used.</p>
<ul class="simple">
<li>xxx-env.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;tx:jta-transaction-manager</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="6%" />
<col width="94%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>The most appropriate <code class="docutils literal"><span class="pre">org.springframework.transaction.jta.JtaTransactionManager</span></code> is defined as bean with id as “transactionManager”, in the application server on which the application has been deployed.
This class controls the transaction by calling JTA APIs.</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="persistence-xml-settings">
<h4><a class="toc-backref" href="#id25">6.3.2.2.4. persistence.xml settings</a><a class="headerlink" href="#persistence-xml-settings" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">When using <code class="docutils literal"><span class="pre">LocalContainerEntityManagerFactoryBean</span></code>, there are no mandatory settings to be performed in <code class="file docutils literal"><span class="pre">persistence.xml</span></code>.</div>
</div>
<p></p>
<blockquote>
<div><div class="admonition-todo admonition" id="index-1">
<p class="first admonition-title">Todo</p>
<blockquote>
<div><strong>TBD</strong></div></blockquote>
<p>Currently, there are no mandatory settings to be performed in <code class="file docutils literal"><span class="pre">persistence.xml</span></code>; however such need may arise in future.</p>
<blockquote class="last">
<div>When using EntityManagerFactory in application server of Java EE, it may be necessary to perform few settings in <code class="file docutils literal"><span class="pre">persistence.xml</span></code> ;
hence we are planning to provide maintenance for such settings in future.</div></blockquote>
</div>
</div></blockquote>
</div>
<div class="section" id="settings-for-validating-spring-data-jpa">
<h4><a class="toc-backref" href="#id26">6.3.2.2.5. Settings for validating Spring Data JPA</a><a class="headerlink" href="#settings-for-validating-spring-data-jpa" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>xxx-infra.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:jpa=</span><span class="s">&quot;http://www.springframework.org/schema/data/jpa&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;.....</span>
<span class="s">    http://www.springframework.org/schema/data/jpa</span>
<span class="s">    http://www.springframework.org/schema/data/jpa/spring-jpa.xsd&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

    <span class="c">&lt;!-- ... --&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;jpa:repositories</span> <span class="na">base-package=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.repository&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="6%" />
<col width="94%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Import schema definition for Spring Data JPA configuration and assign (<code class="docutils literal"><span class="pre">jpa</span></code>) as namespace.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify base package wherein Repository interface and custom Repository class are stored.</div>
<div class="line">Interface inheriting <code class="docutils literal"><span class="pre">org.springframework.data.repository.Repository</span></code> and interface with <code class="docutils literal"><span class="pre">org.springframework.data.repository.RepositoryDefinition</span></code> annotation are automatically defined as a bean of Repository class of Spring Data JPA.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul>
<li><dl class="first docutils">
<dt>Attributes of &lt;jpa:repositories&gt; element</dt>
<dd><div class="first last line-block">
<div class="line">entity-manager-factory-ref, transaction-manager-ref, named-queries-location, query-lookup-strategy, factory-class and repository-impl-postfix are present as attributes.</div>
</div>
</dd>
</dl>
</li>
</ul>
<blockquote>
<div><table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="6%" />
<col width="20%" />
<col width="74%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Element</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>entity-manager-factory-ref</td>
<td><div class="first last line-block">
<div class="line">Specify Factory for generating <code class="docutils literal"><span class="pre">EntityManager</span></code> to be used in Repository.</div>
<div class="line">If multiple Factories of <code class="docutils literal"><span class="pre">EntityManager</span></code> are to be created, then it is necessary to specify the bean to be used.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>transaction-manager-ref</td>
<td><div class="first last line-block">
<div class="line">Specify <code class="docutils literal"><span class="pre">PlatformTransactionManager</span></code> to be used when the methods of Repository are called.</div>
<div class="line">The bean registered with <code class="docutils literal"><span class="pre">transactionManager</span></code> bean name is used by default.</div>
<div class="line">It needs to be specified when the bean name of <code class="docutils literal"><span class="pre">PlatformTransactionManager</span></code>  to be used is not <code class="docutils literal"><span class="pre">transactionManager</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>named-queries-location</td>
<td><div class="first last line-block">
<div class="line">Specify the location of Spring Data JPA properties file wherein Named Query is specified.</div>
<div class="line">“classpath:META-INF/jpa-named-queries.properties” is used by default.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>query-lookup-strategy</td>
<td><div class="first last line-block">
<div class="line">Specify the method to Lookup the query to be executed when query method is called.</div>
<div class="line">By default, it is <code class="docutils literal"><span class="pre">&quot;CREATE_IF_NOT_FOUND&quot;</span></code>. For details, refer to <a class="reference external" href="http://docs.spring.io/spring-data/commons/docs/1.13.7.RELEASE/reference/html/#repositories.query-methods.query-lookup-strategies">Spring Data Commons - Reference Documentation - “Query lookup strategies”</a>. Use the default settings if there is no specific reason.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>factory-class</td>
<td><div class="first last line-block">
<div class="line">Specify Factory for generating class to implement the process when the method of Repository interface is called.</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.data.jpa.repository.support.JpaRepositoryFactory</span></code> is used by default. Specify the Factory created for changing default implementation of Spring Data JPA or for adding a new method.</div>
<div class="line">For how to add a new method, refer to <a class="reference internal" href="#custommethod-all-label"><span class="std std-ref">Adding the custom methods to all Repository interfaces in batch</span></a>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>repository-impl-postfix</td>
<td><div class="first last line-block">
<div class="line">Specify suffix indicating that it is an implementation class of custom Repository.</div>
<div class="line">By default, it is <code class="docutils literal"><span class="pre">Impl</span></code>. For example: when Repository interface name is <code class="docutils literal"><span class="pre">OrderRepository</span></code>, <code class="docutils literal"><span class="pre">OrderRepositoryImpl</span></code> will be the implementation class of custom Repository. Use the default settings if there is no specific reason.</div>
<div class="line">For custom Repository, refer to “<a class="reference internal" href="#custommethod-individual-label"><span class="std std-ref">Adding individual custom method to entity specific Repository interface</span></a>”.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="settings-for-using-jpa-annotations">
<h4><a class="toc-backref" href="#id27">6.3.2.2.6. Settings for using JPA annotations</a><a class="headerlink" href="#settings-for-using-jpa-annotations" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">To inject <code class="docutils literal"><span class="pre">javax.persistence.EntityManagerFactory</span></code>  and  <code class="docutils literal"><span class="pre">javax.persistence.EntityManager</span></code> using the annotations (<code class="docutils literal"><span class="pre">javax.persistence.PersistenceContext</span></code> and <code class="docutils literal"><span class="pre">javax.persistence.PersistenceUnit</span></code>) provided by JPA, <code class="docutils literal"><span class="pre">org.springframework.orm.jpa.support.PersistenceAnnotationBeanPostProcessor</span></code> should be defined as bean.</div>
<div class="line">When <code class="docutils literal"><span class="pre">&lt;jpa:repositories&gt;</span></code> element is specified, bean is defined by default; hence no need to define it separately.</div>
</div>
</div>
<div class="section" id="settings-for-converting-jpa-exception-to-dataaccessexception">
<h4><a class="toc-backref" href="#id28">6.3.2.2.7. Settings for converting JPA exception to DataAccessException</a><a class="headerlink" href="#settings-for-converting-jpa-exception-to-dataaccessexception" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">To convert JPA exception to <code class="docutils literal"><span class="pre">DataAccessException</span></code> of Spring Framework, <code class="docutils literal"><span class="pre">org.springframework.dao.annotation.PersistenceExceptionTranslationPostProcessor</span></code> should be defined as bean.</div>
<div class="line">When <code class="docutils literal"><span class="pre">&lt;jpa:repositories&gt;</span></code> element is specified, bean is defined by default; hence no need to define it separately.</div>
</div>
</div>
<div class="section" id="openentitymanagerinviewinterceptor-settings">
<h4><a class="toc-backref" href="#id29">6.3.2.2.8. OpenEntityManagerInViewInterceptor settings</a><a class="headerlink" href="#openentitymanagerinviewinterceptor-settings" title="Permalink to this headline">¶</a></h4>
<p>To perform Lazy Fetching of Entity in application layer such as Controller and JSP etc., the lifetime of <code class="docutils literal"><span class="pre">EntityManager</span></code> should be extended till application layer
using <code class="docutils literal"><span class="pre">org.springframework.orm.jpa.support.OpenEntityManagerInViewInterceptor</span></code>.</p>
<blockquote>
<div><div class="figure align-center" id="id7">
<a class="reference internal image-reference" href="../../_images/dataaccess_jpa_entitymanager-lifetime-interceptor.png"><img alt="Lifetime of EntityManager on OpenEntityManagerInViewInterceptor" src="../../_images/dataaccess_jpa_entitymanager-lifetime-interceptor.png" style="width: 80%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Lifetime of EntityManager on OpenEntityManagerInViewInterceptor</strong></span></p>
</div>
</div></blockquote>
<p>When <code class="docutils literal"><span class="pre">OpenEntityManagerInViewInterceptor</span></code> is not to be used, the lifetime of <code class="docutils literal"><span class="pre">EntityManager</span></code> becomes same as that of transaction;
hence it is necessary to either fetch the data required in application layer as a process of Service class or to use Eager Fetch instead of Lazy Fetch.</p>
<blockquote>
<div><div class="figure align-center" id="id8">
<a class="reference internal image-reference" href="../../_images/dataaccess_jpa_entitymanager-lifetime-default.png"><img alt="Default lifetime of EntityManager" src="../../_images/dataaccess_jpa_entitymanager-lifetime-default.png" style="width: 80%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Default Life time of EntityManager</strong></span></p>
</div>
</div></blockquote>
<p>Considering the following perspectives, it is recommended that you use Lazy Fetch as fetch method and <code class="docutils literal"><span class="pre">OpenEntityManagerInViewInterceptor</span></code>.</p>
<ul class="simple">
<li>Fetching as a process of Service class leads to insignificant implementation such as calling only getter method or accessing the collection fetched by calling getter method.</li>
<li>When Eager Fetch is used, it is likely that the data which is not used in application layer is also fetched impacting the performance.</li>
</ul>
<p>See the example of <code class="docutils literal"><span class="pre">OpenEntityManagerInViewInterceptor</span></code> settings below.</p>
<ul class="simple">
<li>spring-mvc.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;mvc:interceptors&gt;</span>
    <span class="nt">&lt;mvc:interceptor&gt;</span>
        <span class="nt">&lt;mvc:mapping</span> <span class="na">path=</span><span class="s">&quot;/**&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/resources/**&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/**/*.html&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;bean</span>
            <span class="na">class=</span><span class="s">&quot;org.springframework.orm.jpa.support.OpenEntityManagerInViewInterceptor&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/mvc:interceptor&gt;</span>
<span class="nt">&lt;/mvc:interceptors&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="6%" />
<col width="94%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the path for which interceptor is to be applied and path for which interceptor is not to be applied.</div>
<div class="line">In this example, interceptor is being applied for paths other than paths of resource files (js, css, image etc.) and static web page (HTML).</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify <code class="docutils literal"><span class="pre">org.springframework.orm.jpa.support.OpenEntityManagerInViewInterceptor</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Interceptor not to be applied to the path of static resources</strong></p>
<p class="last">It is recommended that interceptor not be applied to the path of static resources (js, css, image, html etc.), as there is no data access in such cases.
Application of interceptor to the path of static resources leads to execution of unnecessary processes (such as instance generation and close process).</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">When Lazy Fetch is required in Servlet Filter, it is necessary to extend the lifetime of EntityManager till the Servlet Filter layer using <code class="docutils literal"><span class="pre">org.springframework.orm.jpa.support.OpenEntityManagerInViewFilter</span></code>.</div>
<div class="line">For example, this case is applicable when <code class="docutils literal"><span class="pre">org.springframework.security.core.userdetails.UserDetailsService</span></code> of SpringSecurity is inherited and if Entity object is accessed in the inherited logic.</div>
<div class="line">However, if Lazy Fetch is not required, there is no need to extend the lifetime of <code class="docutils literal"><span class="pre">EntityManager</span></code> till the Servlet Filter layer.</div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>About Lazy Fetch in Servlet Filter layer</strong></p>
<p class="last"><strong>It is recommended that you design and implement such that Lazy Fetch does not occur in Servlet Filter layer.</strong>
If <code class="docutils literal"><span class="pre">OpenEntityManagerInViewInterceptor</span></code> is used, it is possible to specify the applicable and non-applicable URL patterns; thus the path for which lifetime of “EntityManager” is to be extended till application layer can also be easily specified.
For the data access required in Servlet Filter, the data should either be fetched in advance in Service class or should be loaded in advance using Eager Fetch; thereby, avoiding the occurrence of Lazy Fetch.</p>
</div>
<div class="figure align-center" id="id9">
<a class="reference internal image-reference" href="../../_images/dataaccess_jpa_entitymanager-lifetime-filter.png"><img alt="Lifetime of EntityManager on OpenEntityManagerInViewFilter" src="../../_images/dataaccess_jpa_entitymanager-lifetime-filter.png" style="width: 80%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Lifetime of EntityManager on OpenEntityManagerInViewFilter</strong></span></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>See the example of <code class="docutils literal"><span class="pre">OpenEntityManagerInViewFilter</span></code> settings below.</p>
<ul class="simple">
<li>web.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;filter&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>Spring OpenEntityManagerInViewFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;filter-class&gt;</span>org.springframework.orm.jpa.support.OpenEntityManagerInViewFilter<span class="nt">&lt;/filter-class&gt;</span>
<span class="nt">&lt;/filter&gt;</span>
<span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;filter-mapping&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>Spring OpenEntityManagerInViewFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
<span class="nt">&lt;/filter-mapping&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="6%" />
<col width="94%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify <code class="docutils literal"><span class="pre">org.springframework.orm.jpa.support.OpenEntityManagerInViewFilter</span></code>.</div>
<div class="line">This Servlet Filter <strong>needs to be defined before the Servlet Filter in which Lazy Fetch occurs.</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the pattern of the URL for which filter is to be applied. It is recommended that you apply the filter only to the required path; however, if the settings are complicated, you can also specify “/*” (All Requests).</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If “/*” (All Requests) are specified in the pattern of the URL for which <code class="docutils literal"><span class="pre">OpenEntityManagerInViewFilter</span></code> is to be applied, <code class="docutils literal"><span class="pre">OpenEntityManagerInViewInterceptor</span></code> settings are not required.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="creating-repository-interface">
<h3><a class="toc-backref" href="#id30">6.3.2.3. Creating Repository interface</a><a class="headerlink" href="#creating-repository-interface" title="Permalink to this headline">¶</a></h3>
<p>Spring Data provides the following 3 methods to create entity specific Repository interface.</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="35%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">How to create</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><a class="reference internal" href="#how-to-create-repository-extends-springdata-label"><span class="std std-ref">Inheriting the interface of Spring Data</span></a></td>
<td>Create entity specific Repository interface by inheriting from the interface of Spring Data.
<strong>If there is no specific reason, then it is recommended that you create the entity specific Repository interface using this method.</strong></td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><a class="reference internal" href="#how-to-create-repository-extends-myinterface-label"><span class="std std-ref">Inheriting a common project specific interface in which only the required methods are defined</span></a></td>
<td>Out of all the methods of Repository interface of Spring Data, create a common project specific interface wherein only the required methods are specified. Inherit the common interface to create entity specific Repository interface.</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><a class="reference internal" href="#how-to-create-repository-notextends-label"><span class="std std-ref">Not inheriting the interface</span></a></td>
<td>Create entity specific Repository interface without inheriting the interface of Spring Data or common project specific common interface.</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="inheriting-the-interface-of-spring-data">
<span id="how-to-create-repository-extends-springdata-label"></span><h4><a class="toc-backref" href="#id31">6.3.2.3.1. Inheriting the interface of Spring Data</a><a class="headerlink" href="#inheriting-the-interface-of-spring-data" title="Permalink to this headline">¶</a></h4>
<p>The method to create entity specific Repository interface by inheriting from the interface of Spring Data is explained below.</p>
<p>Interfaces that can be inherited are as follows:</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="35%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Interface</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.data.repository</div>
<div class="line">CrudRepository</div>
</div>
</td>
<td>Repository interface for generic CRUD operations.</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.data.repository</div>
<div class="line">PagingAndSortingRepository</div>
</div>
</td>
<td>Repository interface wherein Pagination function and Sort function are added to findAll method of <code class="docutils literal"><span class="pre">CrudRepository</span></code>.</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>org.springframework.data.jpa.repository
JpaRepository</td>
<td><div class="first last line-block">
<div class="line">Repository interface that provides JPA specifications dependent methods.</div>
<div class="line"><code class="docutils literal"><span class="pre">PagingAndSortingRepository</span></code> is inherited; hence methods of <code class="docutils literal"><span class="pre">PagingAndSortingRepository</span></code> and <code class="docutils literal"><span class="pre">CrudRepository</span></code> can also be used.</div>
<div class="line"><strong>If there is no specific reason, it is recommended that you create entity specific Repository interface by inheriting this interface.</strong></div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>About default implementation of Repository interface of Spring Data</strong></p>
<p class="last">The methods defined in the above interface are implemented using <code class="docutils literal"><span class="pre">org.springframework.data.jpa.repository.support.SimpleJpaRepository</span></code>
of Spring Data JPA.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>The example is given below.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="o">{</span> <span class="c1">// (1)</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inherit <code class="docutils literal"><span class="pre">JpaRepository</span></code> and specify entity type in generic type <code class="docutils literal"><span class="pre">&lt;T&gt;</span></code> and entity ID type in generic type <code class="docutils literal"><span class="pre">&lt;ID</span> <span class="pre">extends</span> <span class="pre">Serializable&gt;</span></code>.</div>
<div class="line">In the above example, <code class="docutils literal"><span class="pre">Order</span></code> type is specified in entity and <code class="docutils literal"><span class="pre">Integer</span></code> type in entity ID.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>If entity specific Repository interface is created by inheriting <code class="docutils literal"><span class="pre">JpaRepository</span></code>, then the following methods can be implemented.</p>
<blockquote>
<div><table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="35%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Method</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>&lt;S extends T&gt; S save(S entity)</td>
<td><div class="first last line-block">
<div class="line">Method to accumulate persistence operations (INSERT/UPDATE) for the specified entity in <code class="docutils literal"><span class="pre">javax.persistence.EntityManager</span></code>.</div>
<div class="line">If the value is not set in ID property (property with <code class="docutils literal"><span class="pre">&#64;javax.persistence.Id</span></code> annotation or <code class="docutils literal"><span class="pre">&#64;javax.persistence.EmbeddedId</span></code> annotation), <code class="docutils literal"><span class="pre">persist</span></code> method of <code class="docutils literal"><span class="pre">EntityManager</span></code> is called and when the value is set, <code class="docutils literal"><span class="pre">merge</span></code> method is called.</div>
<div class="line">When merge method is called, please note that the returned Entity object is different from the Entity which is passed as an argument.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>&lt;S extends T&gt; List&lt;S&gt; save(Iterable&lt;S&gt; entities)</td>
<td><div class="first last line-block">
<div class="line">Method to accumulate persistence operations for multiple specified entities in <code class="docutils literal"><span class="pre">EntityManager</span></code>.</div>
<div class="line">The method is implemented by calling <code class="docutils literal"><span class="pre">&lt;S</span> <span class="pre">extends</span> <span class="pre">T&gt;</span> <span class="pre">S</span> <span class="pre">save(S</span> <span class="pre">entity)</span></code> method repeatedly.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>T saveAndFlush(T entity)</td>
<td><div class="first last line-block">
<div class="line">Once the persistence operations for the specified entity are accumulated in <code class="docutils literal"><span class="pre">EntityManager</span></code>, this method reflects the accumulated persistence operations (INSERT/UPDATE/DELETE) in persistence layer (DB).</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>void flush()</td>
<td>Method to execute persistence operations (INSERT/UPDATE/DELETE) for the entity accumulated in <code class="docutils literal"><span class="pre">EntityManager</span></code> in persistence layer (DB).</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>void delete(ID id)</td>
<td><div class="first last line-block">
<div class="line">Method to accumulate delete operation for the entity of specified ID, in <code class="docutils literal"><span class="pre">EntityManager</span></code>.</div>
<div class="line">This method calls <code class="docutils literal"><span class="pre">T</span> <span class="pre">findOne(ID)</span></code> method and converts the entity object to “managed” state under <code class="docutils literal"><span class="pre">EntityManager</span></code> and then deletes that object.</div>
<div class="line">If entity is not present when <code class="docutils literal"><span class="pre">T</span> <span class="pre">findOne(ID)</span></code> method is called, <code class="docutils literal"><span class="pre">org.springframework.dao.EmptyResultDataAccessException</span></code> occurs.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>void delete(T entity)</td>
<td><div class="first last line-block">
<div class="line">Method to accumulate delete operation for the specified entity, in <code class="docutils literal"><span class="pre">EntityManager</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td>void delete(Iterable&lt;? extends T&gt; entities)</td>
<td><div class="first last line-block">
<div class="line">Method to accumulate delete operations for the multiple specified entities, in <code class="docutils literal"><span class="pre">EntityManager</span></code>.</div>
<div class="line">This method is implemented by calling <code class="docutils literal"><span class="pre">void</span> <span class="pre">delete(T</span> <span class="pre">entity)</span></code> method repeatedly. In order to delete large number of entities, it is desirable to use <code class="docutils literal"><span class="pre">void</span> <span class="pre">deleteInBatch(Iterable&lt;T&gt;</span> <span class="pre">entities)</span></code> method.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="8">
<li></li>
</ol>
</td>
<td>void deleteAll()</td>
<td><div class="first last line-block">
<div class="line">Method to accumulate delete operations for all entities, in <code class="docutils literal"><span class="pre">EntityManager</span></code>.</div>
<div class="line">This method is implemented by repeatedly calling <code class="docutils literal"><span class="pre">void</span> <span class="pre">delete(T</span> <span class="pre">entity)</span></code> method for the entities fetched by <code class="docutils literal"><span class="pre">List&lt;T&gt;</span> <span class="pre">findAll()</span></code> method.</div>
<div class="line">In order to delete large number of entities, <code class="docutils literal"><span class="pre">void</span> <span class="pre">deleteAllInBatch()</span></code> method should be used. This method loads all the entities to be deleted in the memory, thus causing memory exhaustion.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="9">
<li></li>
</ol>
</td>
<td>void deleteInBatch(Iterable&lt;T&gt; entities)</td>
<td><div class="first last line-block">
<div class="line">Method to directly delete multiple specified entities from persistence layer (DB).</div>
<div class="line">When entities are deleted using this method, entities which are managed (cached) under <code class="docutils literal"><span class="pre">EntityManager</span></code> are not deleted. Hence if <code class="docutils literal"><span class="pre">T</span> <span class="pre">findOne(ID</span> <span class="pre">id)</span></code> method is called after the entity is deleted using this method, note that the entities managed in <code class="docutils literal"><span class="pre">EntityManager</span></code> will be returned.</div>
<div class="line">For a deleted entity, in subsequent processing, if there is a possibility of calling methods like <code class="docutils literal"><span class="pre">T</span> <span class="pre">findOne(ID</span> <span class="pre">id)</span></code> (which return the Entity object managed (cached) under <code class="docutils literal"><span class="pre">EntityManager</span></code>), the corresponding entity should be deleted using <code class="docutils literal"><span class="pre">void</span> <span class="pre">delete(Iterable&lt;?</span> <span class="pre">extends</span> <span class="pre">T&gt;</span> <span class="pre">entities)</span></code> method.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="10">
<li></li>
</ol>
</td>
<td>void deleteAllInBatch()</td>
<td><div class="first last line-block">
<div class="line">Method to directly delete all entities from persistence layer (DB).</div>
<div class="line">Similar to “void deleteInBatch(Iterable&lt;T&gt; entities)” method, note that the entity managed (cached) under “EntityManager” is not deleted.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="11">
<li></li>
</ol>
</td>
<td>T findOne(ID id)</td>
<td><div class="first last line-block">
<div class="line">Method to fetch the entity of specified ID from persistence layer (DB).</div>
<div class="line">The entity fetched from persistence layer is managed (cached) by <code class="docutils literal"><span class="pre">EntityManager</span></code>; hence 2nd time onwards, persistence layer is not accessed and the cached entity is returned.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="12">
<li></li>
</ol>
</td>
<td>List&lt;T&gt; findAll()</td>
<td><div class="first last line-block">
<div class="line">Method to fetch all entities from persistence layer (DB).</div>
<div class="line">The entity fetched from persistence layer is managed (cached) by <code class="docutils literal"><span class="pre">EntityManager</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="13">
<li></li>
</ol>
</td>
<td>Iterable&lt;T&gt; findAll(Iterable&lt;ID&gt; ids)</td>
<td><div class="first last line-block">
<div class="line">Method to fetch entities of multiple specified IDs, from persistence layer (DB).</div>
<div class="line">The entities fetched from persistence layer are managed (cached) by <code class="docutils literal"><span class="pre">EntityManager</span></code>. The specified IDs are searched using IN clause; hence be careful while using a DB where only limited number of values can be specified in IN clause such as Oracle.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="14">
<li></li>
</ol>
</td>
<td>List&lt;T&gt; findAll(Sort sort)</td>
<td><div class="first last line-block">
<div class="line">Method to fetch all entities from persistence layer (DB) in the specified sort order.</div>
<div class="line">The entity fetched from persistence layer is managed (cached) using <code class="docutils literal"><span class="pre">EntityManager</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="15">
<li></li>
</ol>
</td>
<td>Page&lt;T&gt; findAll(Pageable pageable)</td>
<td><div class="first last line-block">
<div class="line">Method to fetch the entity matching the specified page (sort order, page number, number of records to be displayed on page) from persistence layer (DB).</div>
<div class="line">The entity fetched from persistence layer is managed (cached) by <code class="docutils literal"><span class="pre">EntityManager</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="16">
<li></li>
</ol>
</td>
<td>boolean exists(ID id)</td>
<td><div class="first last line-block">
<div class="line">Method to check whether the entity of specified ID exists.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="17">
<li></li>
</ol>
</td>
<td>long count()</td>
<td><div class="first last line-block">
<div class="line">Returns the number of entities available.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>Behavior when using optimistic locking (&#64;javax.persistence.Version) of JPA</strong></p>
<p>When the entity is updated or deleted at the time of using optimistic locking ( <code class="docutils literal"><span class="pre">&#64;Version</span></code> ) of JPA, <code class="docutils literal"><span class="pre">org.springframework.dao.OptimisticLockingFailureException</span></code> occurs.
<code class="docutils literal"><span class="pre">OptimisticLockingFailureException</span></code> may occur in the following methods.</p>
<blockquote>
<div><ul class="simple">
<li>&lt;S extends T&gt; S save(S entity)</li>
<li>&lt;S extends T&gt; List&lt;S&gt; save(Iterable&lt;S&gt; entities)</li>
<li>T saveAndFlush(T entity)</li>
<li>void delete(ID id)</li>
<li>void delete(T entity)</li>
<li>void delete(Iterable&lt;? extends T&gt; entities)</li>
<li>void deleteAll()</li>
<li>void flush()</li>
</ul>
</div></blockquote>
<p class="last">For details on optimistic locking of JPA, refer to <a class="reference internal" href="ExclusionControl.html"><span class="doc">Exclusive Control</span></a>.</p>
</div>
</div></blockquote>
<blockquote id="how-to-create-repository-extends-springdata-flush-timing-note1">
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Timing to reflect persistence operations (1)</strong></p>
<p>For the entity managed under <code class="docutils literal"><span class="pre">EntityManager</span></code>, accumulated persistence operations are executed just before committing a transaction and reflected in persistence layer (DB).
Therefore, in order to handle errors such as unique constraint violation in transaction management (Service processing), it is necessary to call “saveAndFlush” method or “flush” method and execute persistence operations for the Entity accumulated in “EntityManager” forcibly.
If only an error is to be notified to the client, it is OK to perform exception handling in Controller and set an appropriate message.</p>
<p class="last"><code class="docutils literal"><span class="pre">saveAndFlush</span></code> and <code class="docutils literal"><span class="pre">flush</span></code> are JPA dependent methods, hence do not use these methods if there is no specific purpose.</p>
</div>
<ul class="simple">
<li>Normal flow</li>
</ul>
<blockquote>
<div><div class="figure align-center" id="id10">
<a class="reference internal image-reference" href="../../_images/dataaccess_jpa_persistence_flow_normal.png"><img alt="Normal sequence of persistence processing" src="../../_images/dataaccess_jpa_persistence_flow_normal.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Normal sequence of persistence processing</strong></span></p>
</div>
</div></blockquote>
<ul class="simple">
<li>flush flow</li>
</ul>
<blockquote>
<div><div class="figure align-center" id="id11">
<a class="reference internal image-reference" href="../../_images/dataaccess_jpa_persistence_flow_flush.png"><img alt="Sequence of persistence processing when flush method is used" src="../../_images/dataaccess_jpa_persistence_flow_flush.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Sequence of persistence processing when flush method is used</strong></span></p>
</div>
</div></blockquote>
</div></blockquote>
<blockquote id="how-to-create-repository-extends-springdata-flush-timing-note2">
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Timing to reflect persistence operations (2)</strong></p>
<p>When the following method is called, in order to avoid inconsistency between the data managed in <code class="docutils literal"><span class="pre">EntityManager</span></code> and persistence layer (DB),
the persistence operations of the entity accumulated in <code class="docutils literal"><span class="pre">EntityManager</span></code> are reflected in the persistence layer (DB) before the main process is carried out.</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">List&lt;T&gt;</span> <span class="pre">findAll</span></code> method</li>
<li><code class="docutils literal"><span class="pre">boolean</span> <span class="pre">exists(ID</span> <span class="pre">id)</span></code></li>
<li><code class="docutils literal"><span class="pre">long</span> <span class="pre">count()</span></code></li>
</ul>
</div></blockquote>
<p class="last">In case of above methods, query is executed directly in the persistence layer (DB); hence inconsistency may occur unless the operations are reflected in the persistence layer (DB) before the main process is carried out.
Calling of query methods described later also triggers the reflection of persistence operations for the entity accumulated in <code class="docutils literal"><span class="pre">EntityManager</span></code>, in the persistence layer (DB).</p>
</div>
<ul class="simple">
<li>Flow at the time of issuing queries</li>
</ul>
<blockquote>
<div><div class="figure align-center" id="id12">
<a class="reference internal image-reference" href="../../_images/dataaccess_jpa_persistence_flow_query.png"><img alt="Sequence of persistence processing when query method is used" src="../../_images/dataaccess_jpa_persistence_flow_query.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Sequence of persistence processing when query method is used</strong></span></p>
</div>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="inheriting-a-common-project-specific-interface-in-which-only-the-required-methods-are-defined">
<span id="how-to-create-repository-extends-myinterface-label"></span><h4><a class="toc-backref" href="#id32">6.3.2.3.2. Inheriting a common project specific interface in which only the required methods are defined</a><a class="headerlink" href="#inheriting-a-common-project-specific-interface-in-which-only-the-required-methods-are-defined" title="Permalink to this headline">¶</a></h4>
<p>Amongst the methods defined in interface of Spring Data, this section defines the method to create entity specific Repository interface by creating and
inheriting a common project specific interface in which only the required methods are defined.</p>
<p>The signature of methods should match with the methods of Repository interface of Spring Data;</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Assumed cases</strong></p>
<p class="last">Amongst the methods of Repository interface of Spring Data, there are methods which are not used or which are not desirable to be used in the actual application.
In order to remove such methods from Repository interface, refer below.
The methods defined in interface are implemented using <code class="docutils literal"><span class="pre">org.springframework.data.jpa.repository.support.SimpleJpaRepository</span></code> of Spring Data JPA.</p>
</div>
</div></blockquote>
<p>See the example below.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@NoRepositoryBean</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MyProjectRepository</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ID</span> <span class="kd">extends</span> <span class="n">Serializable</span><span class="o">&gt;</span> <span class="kd">extends</span>
        <span class="n">Repository</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ID</span><span class="o">&gt;</span> <span class="o">{</span> <span class="c1">// (2)</span>

    <span class="n">T</span> <span class="nf">findOne</span><span class="o">(</span><span class="n">ID</span> <span class="n">id</span><span class="o">);</span> <span class="c1">// (3)</span>

    <span class="n">T</span> <span class="nf">save</span><span class="o">(</span><span class="n">T</span> <span class="n">entity</span><span class="o">);</span> <span class="c1">// (3)</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderRepository</span> <span class="kd">extends</span> <span class="n">MyProjectRepository</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="o">{</span> <span class="c1">// (4)</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify <code class="docutils literal"><span class="pre">&#64;NoRepositoryBean</span></code> annotation to prevent the instantiation of <code class="docutils literal"><span class="pre">Repository</span></code> interfaces by Spring Data.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a common interface for the project by inheriting <code class="docutils literal"><span class="pre">org.springframework.data.repository.Repository</span></code>.</div>
<div class="line">Use generic type since it is a not entity specific interface.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>Select and define the required methods from the methods of Repository interface of Spring Data.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>Inherit this common interface and specify the type of entity in generic type <code class="docutils literal"><span class="pre">&lt;T&gt;</span></code> and type of entity ID in generic type <code class="docutils literal"><span class="pre">&lt;ID</span> <span class="pre">extends</span> <span class="pre">Serializable&gt;</span></code>. In this example, <code class="docutils literal"><span class="pre">Order</span></code> type is specified in entity and <code class="docutils literal"><span class="pre">Integer</span></code> type in entity ID.</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="not-inheriting-the-interface">
<span id="how-to-create-repository-notextends-label"></span><h4><a class="toc-backref" href="#id33">6.3.2.3.3. Not inheriting the interface</a><a class="headerlink" href="#not-inheriting-the-interface" title="Permalink to this headline">¶</a></h4>
<p>This section explains how to create entity specific Repository interface without inheriting any interface of Spring Data or common interface.</p>
<div class="line-block">
<div class="line">Specify <code class="docutils literal"><span class="pre">&#64;org.springframework.data.repository.RepositoryDefinition</span></code> annotation as class annotation and specify entity type in domainClass attribute and entity ID type in idClass attribute.</div>
<div class="line">The methods which have the same signature as methods defined in Repository interface of Spring Data need not be implemented.</div>
</div>
<p></p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Assumed cases</strong></p>
<p class="last">Repository can be created in this way when common entity operations are not required.
The methods having same signature as methods defined in Repository interface of Spring Data are implemented using <code class="docutils literal"><span class="pre">org.springframework.data.jpa.repository.support.SimpleJpaRepository</span></code> provided by Spring Data JPA.</p>
</div>
</div></blockquote>
<p>See the example below.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RepositoryDefinition</span><span class="o">(</span><span class="n">domainClass</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">idClass</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderRepository</span> <span class="o">{</span> <span class="c1">//(2)</span>

    <span class="n">Order</span> <span class="nf">findOne</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">);</span> <span class="c1">// (3)</span>

    <span class="n">Order</span> <span class="nf">save</span><span class="o">(</span><span class="n">Order</span> <span class="n">entity</span><span class="o">);</span> <span class="c1">// (3)</span>

    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify <code class="docutils literal"><span class="pre">&#64;RepositoryDefinition</span></code> annotation.</div>
<div class="line">In the example, <code class="docutils literal"><span class="pre">Order</span></code> type is specified in domainClass attribute (entity type) and <code class="docutils literal"><span class="pre">Integer</span></code> type in idClass attribute (entity ID type).</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>There is no need to inherit the interface (<code class="docutils literal"><span class="pre">org.springframework.data.repository.Repository</span></code>) of Spring Data.</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>Define the methods required for each entity.</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div>
<div class="section" id="adding-query-method">
<span id="data-access-jpa-how-to-use-querymethod"></span><h3><a class="toc-backref" href="#id34">6.3.2.4. Adding query method</a><a class="headerlink" href="#adding-query-method" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">It is difficult to develop the actual application using only the Spring Data interface which is used for performing generic CRUD operations.</div>
<div class="line">Therefore Spring Data provides a mechanism to add “query methods” for performing any persistence operations (SELECT/UPDATE/DELETE) for the entity specific Repository interface.</div>
<div class="line">In the added query method, entity operations are performed using query language (JPQL or Native SQL).</div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>What is JPQL</strong></p>
<p>JPQL is an abbreviation of “Java Persistence Query Language” and is the query language to perform entity operations (SELECT/UPDATE/DELETE) corresponding to the records of persistence layer (DB).
The syntax is similar to SQL; however, JPQL operates the entities mapped to the records of persistence layer instead of operating these records directly.
The entity operations are reflected to persistence layer (DB) using JPA provider (Hibernate).</p>
<p class="last">For details on JPQL, refer to <a class="reference external" href="http://download.oracle.com/otn-pub/jcp/persistence-2_1-fr-eval-spec/JavaPersistence.pdf">JSR 338: Java Persistence API, Version 2.1 Specification (PDF) “Chapter 4 Query Language”</a>.</p>
</div>
</div></blockquote>
<div class="section" id="defining-query-method">
<h4><a class="toc-backref" href="#id35">6.3.2.4.1. Defining query method</a><a class="headerlink" href="#defining-query-method" title="Permalink to this headline">¶</a></h4>
<p>Query method is defined as a method of entity specific Repository interface.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findByStatusCode</span><span class="o">(</span><span class="n">String</span> <span class="n">statusCode</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="specifying-query-to-be-executed">
<h4><a class="toc-backref" href="#id36">6.3.2.4.2. Specifying query to be executed</a><a class="headerlink" href="#specifying-query-to-be-executed" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Query to be executed should be specified at the time of calling query method.</div>
<div class="line">The method of specifying the query is as below. For details, refer to <a class="reference internal" href="#how-to-specify-query-label"><span class="std std-ref">Specifying a query while calling a query method</span></a>.</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="30%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Method to specify a query</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#how-to-specify-query-annotation-label"><span class="std std-ref">&#64;Query annotation</span></a></div>
<div class="line">(Spring Data functionality)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In the method to be added to entity specific Repository interface, specify <code class="docutils literal"><span class="pre">&#64;org.springframework.data.jpa.repository.Query</span></code> annotation and the query to be executed.</div>
<div class="line"><strong>When there is no specific reason, it is recommended that you specify the query using this method.</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#how-to-specify-query-mathodname-label"><span class="std std-ref">Method name based on naming conventions</span></a></div>
<div class="line">(Spring Data functionality)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the query to be executed by assigning a method name as per Spring Data naming conventions.</div>
<div class="line">Query (JPQL) is generated from the method name using Spring Data JPA functionality. Only a SELECT clause of JPQL can be generated.</div>
<div class="line"><strong>For a simple query having few conditions, this method can be used instead of using &#64;Query annotation.</strong> However, for a complex query with many conditions, a simple method name indicating behavior should be used and Query should be specified using <code class="docutils literal"><span class="pre">&#64;Query</span></code> annotation.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#how-to-specify-query-namedquery-properties-label"><span class="std std-ref">Named query of properties file</span></a></div>
<div class="line">(Spring Data functionality)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the query in a properties file.</div>
<div class="line"><strong>The location of method definition (entity specific Repository interface) and location wherein the query is specified (properties file) are separated; hence this way of specifying the query is not recommended.</strong></div>
<div class="line"><strong>However, when using Native SQL as query, check whether it is necessary to define the database dependent SQL in the properties file.</strong></div>
<div class="line">In case of applications for which any database can be selected or when the database changes (or is likely to be changed) depending on execution environment, then it is necessary to specify the Query using this method and manage the Properties file as environment dependent material.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Using multiple query specification methods</strong></p>
<p class="last">Particularly, there is no restriction on using multiple query specification methods. Query specification methods and restriction on their concurrent usage should be determined in accordance with the project.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Query Lookup methods</strong></p>
<p>The operations would be as follows since the Spring Data default setting is <code class="docutils literal"><span class="pre">CREATE_IF_NOT_FOUND</span></code>.</p>
<ol class="arabic simple">
<li>Look for the query specified in <code class="docutils literal"><span class="pre">&#64;Query</span></code> annotation.</li>
<li>Look for the corresponding query from Named query.</li>
<li>Create a query (JPQL) from method name and use it.</li>
<li>An error occurs when query (JPQL) cannot be created from method name.</li>
</ol>
<p class="last">For details on Query Lookup methods, refer to <a class="reference external" href="http://docs.spring.io/spring-data/commons/docs/1.13.7.RELEASE/reference/html/#repositories.query-methods.query-lookup-strategies">Spring Data Commons - Reference Documentation “Defining query methods” -  “Query lookup strategies”</a>.</p>
</div>
</div></blockquote>
</div>
<div class="section" id="fetching-entity-lock">
<h4><a class="toc-backref" href="#id37">6.3.2.4.3. Fetching entity lock</a><a class="headerlink" href="#fetching-entity-lock" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">To fetch entity lock, add <code class="docutils literal"><span class="pre">&#64;org.springframework.data.jpa.repository.Lock</span></code> annotation to query method and specify the lock mode.</div>
<div class="line">For details, refer to <a class="reference internal" href="ExclusionControl.html"><span class="doc">Exclusive Control</span></a>.</div>
</div>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Query</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;SELECT o FROM Order o WHERE o.status.code = :statusCode ORDER BY o.id DESC&quot;</span><span class="o">)</span>
<span class="nd">@Lock</span><span class="o">(</span><span class="n">LockModeType</span><span class="o">.</span><span class="na">PESSIMISTIC_WRITE</span><span class="o">)</span> <span class="c1">// (1)</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findByStatusCode</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;statusCode&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">statusCode</span><span class="o">);</span>
</pre></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (2) statusCode=&#39;accepted&#39;</span>
<span class="k">SELECT</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">id1_5_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="k">AS</span> <span class="n">status2_5_</span>
    <span class="k">FROM</span>
        <span class="n">t_order</span> <span class="n">order0_</span>
    <span class="k">WHERE</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="s1">&#39;accepted&#39;</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="k">DESC</span>
    <span class="k">FOR</span> <span class="k">UPDATE</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the lock mode in value attribute of <code class="docutils literal"><span class="pre">&#64;Lock</span></code> annotation.</div>
<div class="line">For the details on lock mode that can be specified, refer to <a class="reference external" href="http://docs.oracle.com/javaee/7/api/javax/persistence/LockModeType.html">Java Platform, Enterprise Edition API Specification</a>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Native SQL converted from JPQL.(DB to be used is PostgreSQL)</div>
<div class="line">In the example, <code class="docutils literal"><span class="pre">LockModeType.PESSIMISTIC_WRITE</span></code> has been specified; hence “FOR UPDATE” clause is added to SQL.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="operating-the-entities-of-persistence-layer-directly">
<span id="data-access-jpa-howtouse-querymethod-modifying"></span><h4><a class="toc-backref" href="#id38">6.3.2.4.4. Operating the entities of Persistence Layer directly</a><a class="headerlink" href="#operating-the-entities-of-persistence-layer-directly" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">It is recommended to perform update and delete operations on entity objects managed in <code class="docutils literal"><span class="pre">EntityManager</span></code>.</div>
<div class="line">However, when entities need to be updated or deleted in a batch, check whether the entities of persistence layer (DB) are operated using query method.</div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Reducing the causes of performance degradation</strong></p>
<p>Operating the entities of persistence layer directly reduces the frequency of SQLs that would be required to be executed for operating these entities.
Therefore, in case of applications that demand high performance, the causes of performance degradation can be reduced by operating the entities in batch using this method.
Such SQLs are as follows:</p>
<ul class="last simple">
<li>SQL for loading all entity objects in <code class="docutils literal"><span class="pre">EntityManager</span></code>. Need not be executed.</li>
<li>SQL for updating and deleting entity. This SQL was earlier required to be executed n times, but now it is sufficient to execute it only once.</li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Standards for deciding whether to operate entities of persistence layer directly</strong></p>
<p class="last">When operating the entities of persistence layer directly, since there are certain points to be careful about from functionality point of view, <strong>in case of applications which do not demand high performance,
it is recommended that the batch operations must also be performed through the entity objects managed in EntityManager.</strong>
For the points to be careful, refer to the example below.</p>
</div>
</div></blockquote>
<p>The example of directly operating the entities of persistence layer using query method is shown below.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Modifying</span> <span class="c1">// (1)</span>
<span class="nd">@Query</span><span class="o">(</span><span class="s">&quot;UPDATE OrderItem oi SET oi.logicalDelete = true WHERE oi.id.orderId = :orderId &quot;</span><span class="o">)</span> <span class="c1">// (2)</span>
<span class="kt">int</span> <span class="nf">updateToLogicalDelete</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;orderId&quot;</span><span class="o">)</span> <span class="n">Integer</span> <span class="n">orderId</span><span class="o">);</span> <span class="c1">// (3)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify <code class="docutils literal"><span class="pre">&#64;org.springframework.data.jpa.repository.Modifying</span></code> annotation indicating that the method is UPDATE query method.</div>
<div class="line">If not specified, error will occur at the time of execution.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify UPDATE or DELETE query.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">If update count or delete count is required, specify <code class="docutils literal"><span class="pre">int</span></code> or <code class="docutils literal"><span class="pre">java.lang.Integer</span></code> as return value and if count is not required, specify <code class="docutils literal"><span class="pre">void</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>Consistency with entities managed in EntityManager</strong></p>
<p>When entities of persistence layer are operated directly using query method, there is no change in the entities managed in EntityManager as per the default behavior of Spring Data JPA.
Therefore, it should be noted that the entity object fetched immediately after calling <code class="docutils literal"><span class="pre">JpaRepository#findOne(ID)</span></code> method would be in a state prior to the state of operating the entities.</p>
<p class="last">This behavior can be avoided by setting the clearAutomatically attribute of <code class="docutils literal"><span class="pre">&#64;Modifying</span></code> annotation to <code class="docutils literal"><span class="pre">true</span></code>.
When clearAutomatically attribute is set to <code class="docutils literal"><span class="pre">true</span></code>, <code class="docutils literal"><span class="pre">clear()</span></code> method of <code class="docutils literal"><span class="pre">EntityManager</span></code> is called after operating the entities of persistence layer directly, and the entity objects managed in <code class="docutils literal"><span class="pre">EntityManager</span></code> and the accumulated persistence operations are deleted from <code class="docutils literal"><span class="pre">EntityManager</span></code>.
Therefore, if <code class="docutils literal"><span class="pre">JpaRepository#findOne(ID)</span></code> method is called immediately, the mechanism is such that the latest entity would be fetched from the persistence layer and <code class="docutils literal"><span class="pre">EntityManager</span></code> status would be synchronized with the persistence layer.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>Points to be noted while using &#64;Modifying(clearAutomatically = true)</strong></p>
<p>By using <code class="docutils literal"><span class="pre">&#64;Modifying(clearAutomatically</span> <span class="pre">=</span> <span class="pre">true)</span></code>, it should be noted that the accumulated persistence operations (INSERT/UPDATE/DELETE) are also deleted from <code class="docutils literal"><span class="pre">EntityManager</span></code>.
Bugs may occur as the required persistence operations may not be reflected in the persistence layer.</p>
<p class="last">In order to avoid this problem, <code class="docutils literal"><span class="pre">JpaRepository#saveAndFlush(T</span> <span class="pre">entity)</span></code> or <code class="docutils literal"><span class="pre">JpaRepository#flush()</span></code> method should be called and the accumulated persistence operations should be reflected in the persistence layer before directly operating the entities of persistence layer.</p>
</div>
</div></blockquote>
</div>
<div class="section" id="setting-queryhints">
<h4><a class="toc-backref" href="#id39">6.3.2.4.5. Setting QueryHints</a><a class="headerlink" href="#setting-queryhints" title="Permalink to this headline">¶</a></h4>
<p>When it is necessary to set a hint in query, add <code class="docutils literal"><span class="pre">&#64;org.springframework.data.jpa.repository.QueryHints</span></code>  annotation to query method and
specify QueryHint ( <code class="docutils literal"><span class="pre">&#64;javax.persistence.QueryHint</span></code> ) in value attribute.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Query</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;SELECT o FROM Order o WHERE o.status.code = :statusCode ORDER BY o.id DESC&quot;</span><span class="o">)</span>
<span class="nd">@Lock</span><span class="o">(</span><span class="n">LockModeType</span><span class="o">.</span><span class="na">PESSIMISTIC_WRITE</span><span class="o">)</span>
<span class="nd">@QueryHints</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="o">{</span> <span class="nd">@QueryHint</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;javax.persistence.lock.timeout&quot;</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;0&quot;</span><span class="o">)</span> <span class="o">})</span> <span class="c1">// (1)</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findByStatusCode</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;statusCode&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">statusCode</span><span class="o">);</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify hint name in name attribute of <code class="docutils literal"><span class="pre">&#64;QueryHint</span></code> annotation and hint value in value attribute.</div>
<div class="line">In addition to the hint stipulated in JPA specifications, provider specific hint can be specified.</div>
<div class="line">In the above example, lock timeout is set to “<code class="docutils literal"><span class="pre">0</span></code>” (DB used is Oracle). “FOR UPDATE NOWAIT” clause is added to SQL.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>QueryHints that can be specified in Hibernate</strong></p>
<p>QueryHints stipulated in JPA specifications are as follows:
For details, refer to <a class="reference external" href="http://download.oracle.com/otn-pub/jcp/persistence-2_1-fr-eval-spec/JavaPersistence.pdf">JSR 338: Java Persistence API, Version 2.1 Specification (PDF)</a>.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">javax.persistence.query.timeout</span></code></li>
<li><code class="docutils literal"><span class="pre">javax.persistence.lock.timeout</span></code></li>
<li><code class="docutils literal"><span class="pre">javax.persistence.cache.retrieveMode</span></code></li>
<li><code class="docutils literal"><span class="pre">javax.persistence.cache.storeMode</span></code></li>
</ul>
<p class="last">For Hibernate specific QueryHints, refer to “3.4.1.8. Query hints” of <a class="reference external" href="http://docs.jboss.org/hibernate/entitymanager/3.6/reference/en/html/objectstate.html#d0e1109">Hibernate EntityManager User guide</a>.</p>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="specifying-a-query-while-calling-a-query-method">
<span id="how-to-specify-query-label"></span><h3><a class="toc-backref" href="#id40">6.3.2.5. Specifying a query while calling a query method</a><a class="headerlink" href="#specifying-a-query-while-calling-a-query-method" title="Permalink to this headline">¶</a></h3>
<p>The method of specifying a query to be executed while calling query method is given below.</p>
<ul class="simple">
<li><a class="reference internal" href="#how-to-specify-query-annotation-label"><span class="std std-ref">Specifying the query using &#64;Query annotation</span></a></li>
<li><a class="reference internal" href="#how-to-specify-query-mathodname-label"><span class="std std-ref">Specifying with the method name based on naming conventions</span></a></li>
<li><a class="reference internal" href="#how-to-specify-query-namedquery-properties-label"><span class="std std-ref">Specifying as Named query in Properties file</span></a></li>
</ul>
<div class="section" id="specifying-the-query-using-query-annotation">
<span id="how-to-specify-query-annotation-label"></span><h4><a class="toc-backref" href="#id41">6.3.2.5.1. Specifying the query using &#64;Query annotation</a><a class="headerlink" href="#specifying-the-query-using-query-annotation" title="Permalink to this headline">¶</a></h4>
<p>Specify the query(JPQL) to be executed in value attribute of <code class="docutils literal"><span class="pre">&#64;Query</span></code> annotation.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Query</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;SELECT o FROM Order o WHERE o.status.code = :statusCode ORDER BY o.id DESC&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findByStatusCode</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;statusCode&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">statusCode</span><span class="o">);</span>
</pre></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (2) statusCode=&#39;accepted&#39;</span>
<span class="k">SELECT</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">id1_5_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="k">AS</span> <span class="n">status2_5_</span>
    <span class="k">FROM</span>
        <span class="n">t_order</span> <span class="n">order0_</span>
    <span class="k">WHERE</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="s1">&#39;accepted&#39;</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="k">DESC</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the query(JPQL) to be executed in value attribute of <code class="docutils literal"><span class="pre">&#64;Query</span></code> annotation.</div>
<div class="line">In the above example, query for fetching the <code class="docutils literal"><span class="pre">Order</span></code> object in the descending order of <code class="docutils literal"><span class="pre">id</span></code> property has been specified. Here, the <code class="docutils literal"><span class="pre">code</span></code> property (<code class="docutils literal"><span class="pre">String</span></code> type) value of <code class="docutils literal"><span class="pre">status</span></code> property (<code class="docutils literal"><span class="pre">OrderStatus</span></code> type) stored in <code class="docutils literal"><span class="pre">Order</span></code> object is matched with the specified parameter value ( <code class="docutils literal"><span class="pre">statusCode</span></code> ).</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>Native SQL converted from JPQL. Query(JPQL) specified in value attribute of <code class="docutils literal"><span class="pre">&#64;Query</span></code> annotation is converted to Native SQL of database to be used.</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>How to specify Native SQL directly instead of JPQL</strong></p>
<p>Native SQL can be specified as query instead of JPQL by setting nativeQuery attribute to <code class="docutils literal"><span class="pre">true</span></code>.
<strong>Fundamentally it is recommended that you use JPQL; however, when there is a need to generate the query that cannot be expressed in JPQL, Native SQL can be specified directly.</strong>
To specify the database dependent SQL, analyze whether it can be defined in the properties file.</p>
<p class="last">For method of defining SQL in properties file, refer to “<a class="reference internal" href="#how-to-specify-query-namedquery-properties-label"><span class="std std-ref">Specifying as Named query in Properties file</span></a>”.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Named Parameters</strong></p>
<p>Named parameter can be used by assigning a name to bind parameter of the query and using this assigned name to specify the value.
To use Named Parameter, add <code class="docutils literal"><span class="pre">&#64;org.springframework.data.repository.query.Param</span></code> annotation to the argument from which the value has to be used to bind to the named parameter in the query. Specify the assigned parameter name in value attribute of param annotation.
ON the query side, at the position where parameter is to be bound in the query, specify it in the “:parametername”  format.</p>
<p class="last"><strong>When there is no specific reason, It is recommended to use Named Parameters considering maintainability and readability of Query.</strong></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">In case of LIKE search, if the type of matching (Forward match, Backward match and Partial match) is fixed, <code class="docutils literal"><span class="pre">%</span></code> can be specified in JPQL.</div>
<div class="line">However, this is in extended Spring Data JPA format and not in standard JPQL, so it can be specified only in JPQL specified with <code class="docutils literal"><span class="pre">&#64;Query</span></code> annotation.</div>
<div class="line">An error occurs if <code class="docutils literal"><span class="pre">%</span></code>  is specified in JPQL specified as Named query.</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="20%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Type of matching</th>
<th class="head">Format</th>
<th class="head">Specific example</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>Forward match</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">:parameterName%</span></code></div>
<div class="line">or</div>
<div class="line"><code class="docutils literal"><span class="pre">?n%</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">SELECT</span> <span class="pre">a</span> <span class="pre">FROM</span> <span class="pre">Account</span> <span class="pre">WHERE</span> <span class="pre">a.firstName</span> <span class="pre">LIKE</span> <span class="pre">:firstName%</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">SELECT</span> <span class="pre">a</span> <span class="pre">FROM</span> <span class="pre">Account</span> <span class="pre">WHERE</span> <span class="pre">a.firstName</span> <span class="pre">LIKE</span> <span class="pre">?1%</span></code></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>Backward match</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">%:parameterName</span></code></div>
<div class="line">or</div>
<div class="line"><code class="docutils literal"><span class="pre">%?n</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">SELECT</span> <span class="pre">a</span> <span class="pre">FROM</span> <span class="pre">Account</span> <span class="pre">WHERE</span> <span class="pre">a.firstName</span> <span class="pre">LIKE</span> <span class="pre">%:firstName</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">SELECT</span> <span class="pre">a</span> <span class="pre">FROM</span> <span class="pre">Account</span> <span class="pre">WHERE</span> <span class="pre">a.firstName</span> <span class="pre">LIKE</span> <span class="pre">%?1</span></code></div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>Partial match</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">%:parameterName%</span></code></div>
<div class="line">or</div>
<div class="line"><code class="docutils literal"><span class="pre">%?n%</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">SELECT</span> <span class="pre">a</span> <span class="pre">FROM</span> <span class="pre">Account</span> <span class="pre">WHERE</span> <span class="pre">a.firstName</span> <span class="pre">LIKE</span> <span class="pre">%:firstName%</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">SELECT</span> <span class="pre">a</span> <span class="pre">FROM</span> <span class="pre">Account</span> <span class="pre">WHERE</span> <span class="pre">a.firstName</span> <span class="pre">LIKE</span> <span class="pre">%?1%</span></code></div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Escaping at the time of LIKE search</strong></p>
<p>Search condition values should be escaped during LIKE search.</p>
<p class="last">The method for escaping these values is provided in <code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.query.QueryEscapeUtils</span></code> class; this class can be used if it meets the requirements.
For details on <code class="docutils literal"><span class="pre">QueryEscapeUtils</span></code> class, refer to “<a class="reference internal" href="DataAccessCommon.html#data-access-common-appendix-like-escape"><span class="std std-ref">Escaping during LIKE search</span></a>” of “<a class="reference internal" href="DataAccessCommon.html"><span class="doc">Database Access (Common)</span></a>”.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>When the type of matching needs to be changed dynamically</strong></p>
<p>When it is necessary to change the type of matching (Forward match, Backward match and Partial match) dynamically,
<code class="docutils literal"><span class="pre">%</span></code> should be added before and after the parameter value (same as conventional method), instead of specifying “<code class="docutils literal"><span class="pre">%</span></code>” in JPQL.</p>
<p class="last">The method for converting into search condition value corresponding to the type of matching is provided in <code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.query.QueryEscapeUtils</span></code> class;
this class can be used if it meets the requirements.
For details on <code class="docutils literal"><span class="pre">QueryEscapeUtils</span></code> class, refer to “<a class="reference internal" href="DataAccessCommon.html#data-access-common-appendix-like-escape"><span class="std std-ref">Escaping during LIKE search</span></a>” of “<a class="reference internal" href="DataAccessCommon.html"><span class="doc">Database Access (Common)</span></a>”.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">Sort conditions can be directly specified in query.</div>
<div class="line">See the example below.</div>
</div>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="o">@</span><span class="n">Query</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="ss">&quot;SELECT o FROM Order o WHERE o.status.code = :statusCode ORDER BY o.id DESC&quot;</span><span class="p">)</span>
<span class="n">Page</span><span class="o">&lt;</span><span class="k">Order</span><span class="o">&gt;</span> <span class="n">findByStatusCode</span><span class="p">(</span><span class="o">@</span><span class="n">Param</span><span class="p">(</span><span class="ss">&quot;statusCode&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">statusCode</span><span class="p">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="p">);</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>Specify <code class="docutils literal"><span class="pre">ORDER</span> <span class="pre">BY</span></code> in query. Specify <code class="docutils literal"><span class="pre">DESC</span></code> for sorting in descending order and <code class="docutils literal"><span class="pre">ASC</span></code> for ascending order. By default it is “ASC”, when nothing is specified.</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">In addition to directly specifying the sort conditions in query, they can be specified in <code class="docutils literal"><span class="pre">org.springframework.data.domain.Sort</span></code> object stored in <code class="docutils literal"><span class="pre">Pageable</span></code> object.</div>
<div class="line">When specifying the sort conditions using this method, there is no need to specify countQuery attribute.</div>
<div class="line">Example of sorting  using <code class="docutils literal"><span class="pre">Sort</span></code> object stored in <code class="docutils literal"><span class="pre">Pageable</span></code> object is shown below.</div>
</div>
<ul class="simple">
<li>Controller</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;list&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">list</span><span class="o">(</span><span class="nd">@PageableDefault</span><span class="o">(</span>
                        <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="o">,</span>
                        <span class="n">sort</span> <span class="o">=</span> <span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="c1">// (1)</span>
                        <span class="n">direction</span> <span class="o">=</span> <span class="n">Direction</span><span class="o">.</span><span class="na">DESC</span> <span class="c1">// (1)</span>
                        <span class="o">)</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">,</span>
                          <span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Page</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">orderPage</span> <span class="o">=</span> <span class="n">orderService</span><span class="o">.</span><span class="na">getOrders</span><span class="o">(</span><span class="n">pageable</span><span class="o">);</span> <span class="c1">// (2)</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;orderPage&quot;</span><span class="o">,</span> <span class="n">orderPage</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">&quot;order/list&quot;</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the sort conditions. Sort conditions are set in <code class="docutils literal"><span class="pre">Sort</span></code> object that can be fetched by <code class="docutils literal"><span class="pre">Pageable#getSort()</span></code> method.</div>
<div class="line">In the above example, DESC is specified as a sort condition for id field.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>Specify <code class="docutils literal"><span class="pre">Pageable</span></code> object and call Service method.</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Service (Caller)</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">String</span> <span class="nf">getOrders</span><span class="o">(</span><span class="n">Pageable</span> <span class="n">pageable</span><span class="o">){</span>
    <span class="k">return</span> <span class="n">orderRepository</span><span class="o">.</span><span class="na">findByStatusCode</span><span class="o">(</span><span class="s">&quot;accepted&quot;</span><span class="o">,</span> <span class="n">pageable</span><span class="o">);</span> <span class="c1">// (3)</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>Call Repository method by specifying <code class="docutils literal"><span class="pre">Pageable</span></code> object passed by Controller.</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Repository interface</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Query</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;SELECT o FROM Order o WHERE o.status.code = :statusCode&quot;</span><span class="o">)</span> <span class="c1">// (4)</span>
<span class="n">Page</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findByStatusCode</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;statusCode&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">statusCode</span><span class="o">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
</pre></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (5) statusCode=&#39;accepted&#39;</span>
<span class="k">SELECT</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="n">order0_</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">col_0_0_</span>
    <span class="k">FROM</span>
        <span class="n">t_order</span> <span class="n">order0_</span>
    <span class="k">WHERE</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="s1">&#39;accepted&#39;</span>

<span class="c1">-- (6) statusCode=&#39;accepted&#39;</span>
<span class="k">SELECT</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">id1_5_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="k">AS</span> <span class="n">status2_5_</span>
    <span class="k">FROM</span>
        <span class="n">t_order</span> <span class="n">order0_</span>
    <span class="k">WHERE</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="s1">&#39;accepted&#39;</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="k">DESC</span>
    <span class="k">LIMIT</span> <span class="mi">5</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>Do not specify “ORDER BY” clause in query. No need to specify countQuery attribute also.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>Native SQL for count converted from JPQL.</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Native SQL for “fetching the entity of the specified page location” converted from JPQL.</div>
<div class="line">Not specified in query; however “ORDER BY” clause is added to the condition specified in <code class="docutils literal"><span class="pre">Sort</span></code> object stored in <code class="docutils literal"><span class="pre">Pageable</span></code> object. In this example, it is SQL for PostgreSQL.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="specifying-with-the-method-name-based-on-naming-conventions">
<span id="how-to-specify-query-mathodname-label"></span><h4><a class="toc-backref" href="#id42">6.3.2.5.2. Specifying with the method name based on naming conventions</a><a class="headerlink" href="#specifying-with-the-method-name-based-on-naming-conventions" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Specify the query (JPQL) to be executed through method name as per the naming conventions of Spring Data JPA.</div>
<div class="line">JPQL is created from the method name by the functionality of Spring Data JPA.</div>
<div class="line">However, this is only possible for SELECT queries and not for UPDATE and DELETE.</div>
</div>
<p>For naming conventions for creating JPQL, refer to the following pages.</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="45%" />
<col width="45%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Reference page</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><a class="reference external" href="http://docs.spring.io/spring-data/commons/docs/1.13.7.RELEASE/reference/html/#repositories.query-methods.query-creation">Spring Data Commons - “Query creation” of Reference Documentation “Defining query methods”</a></td>
<td>This section describes method to specify Distinct, ORDER BY and Case insensitive.</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><a class="reference external" href="http://docs.spring.io/spring-data/commons/docs/1.13.7.RELEASE/reference/html/#repositories.query-methods.query-property-expressions">Spring Data Commons - “Property expressions” of Reference Documentation “Defining query methods”</a></td>
<td>This section describes method to specify the nested entity property in condition.</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><a class="reference external" href="http://docs.spring.io/spring-data/commons/docs/1.13.7.RELEASE/reference/html/#repositories.special-parameters">Spring Data Commons - “Special parameter handling” of Reference Documentation “Defining query methods”</a></td>
<td>This section describes special method arguments (<code class="docutils literal"><span class="pre">Pageable</span></code> , <code class="docutils literal"><span class="pre">Sort</span></code>).</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><a class="reference external" href="http://docs.spring.io/spring-data/jpa/docs/1.11.7.RELEASE/reference/html/#jpa.query-methods.query-creation">Spring Data JPA - “Query creation” of Reference Documentation “Query methods”</a></td>
<td>This section describes naming conventions (keywords) for creating JPQL.</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><a class="reference external" href="http://docs.spring.io/spring-data/commons/docs/1.13.7.RELEASE/reference/html/#repository-query-keywords">Spring Data Commons - Reference Documentation “Appendix C. Repository query keywords”</a></td>
<td>This section describes naming conventions (keywords) for creating JPQL.</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>See the example below.</p>
<ul class="simple">
<li>OrderRepositry.java</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">Page</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findByStatusCode</span><span class="o">(</span><span class="n">String</span> <span class="n">statusCode</span><span class="o">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">);</span> <span class="c1">// (1)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When the method name matches with <code class="docutils literal"><span class="pre">^(find|read|get).*By(.+)</span></code> pattern, JPQL is created from method name.</div>
<div class="line">In the <code class="docutils literal"><span class="pre">(.+)</span></code> portion, specify the property of entity which forms the query condition or keywords indicating the operation.</div>
<div class="line">In the example, <code class="docutils literal"><span class="pre">Order</span></code> object where <code class="docutils literal"><span class="pre">code</span></code> property ( <code class="docutils literal"><span class="pre">String</span></code> type) value of <code class="docutils literal"><span class="pre">status</span></code> property ( <code class="docutils literal"><span class="pre">OrderStatus</span></code> type) stored in <code class="docutils literal"><span class="pre">Order</span></code>  object is matched with the specified parameter value ( <code class="docutils literal"><span class="pre">statusCode</span></code> ), is being fetched in page format.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Count Query</li>
</ul>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (2) JPQL</span>
<span class="k">SELECT</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
    <span class="k">FROM</span>
        <span class="k">ORDER</span> <span class="k">AS</span> <span class="n">generatedAlias0</span>
            <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">generatedAlias0</span><span class="p">.</span><span class="n">status</span> <span class="k">AS</span> <span class="n">generatedAlias1</span>
        <span class="k">WHERE</span>
            <span class="n">generatedAlias1</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="o">?</span><span class="mi">1</span>

<span class="c1">-- (3) SQL statusCode=&#39;accepted&#39;</span>
<span class="k">SELECT</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">col_0_0_</span>
    <span class="k">FROM</span>
        <span class="n">t_order</span> <span class="n">order0_</span>
            <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">c_order_status</span> <span class="n">orderstatu1_</span>
                <span class="k">ON</span> <span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">orderstatu1_</span><span class="p">.</span><span class="n">code</span>
    <span class="k">WHERE</span>
        <span class="n">orderstatu1_</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;accepted&#39;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>JPQL query for count created from method name.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>Native SQL for count converted from JPQL of step (2).</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Query for fetching entities</li>
</ul>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (4) JPQL</span>
<span class="k">SELECT</span>
        <span class="n">generatedAlias0</span>
    <span class="k">FROM</span>
        <span class="k">ORDER</span> <span class="k">AS</span> <span class="n">generatedAlias0</span>
            <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">generatedAlias0</span><span class="p">.</span><span class="n">status</span> <span class="k">AS</span> <span class="n">generatedAlias1</span>
        <span class="k">WHERE</span>
            <span class="n">generatedAlias1</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="o">?</span><span class="mi">1</span>
        <span class="k">ORDER</span> <span class="k">BY</span>
            <span class="n">generatedAlias0</span><span class="p">.</span><span class="n">id</span> <span class="k">DESC</span><span class="p">;</span>

<span class="c1">-- (5) statusCode=&#39;accepted&#39;</span>
<span class="k">SELECT</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">id1_5_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="k">AS</span> <span class="n">status2_5_</span>
    <span class="k">FROM</span>
        <span class="n">t_order</span> <span class="n">order0_</span>
            <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">c_order_status</span> <span class="n">orderstatu1_</span>
                <span class="k">ON</span> <span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">orderstatu1_</span><span class="p">.</span><span class="n">code</span>
    <span class="k">WHERE</span>
        <span class="n">orderstatu1_</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;accepted&#39;</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="k">DESC</span>
    <span class="k">LIMIT</span> <span class="mi">5</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>JPQL query for fetching entities created from method name.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>Native SQL for fetching the entities converted from JPQL of step (4).</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="specifying-as-named-query-in-properties-file">
<span id="how-to-specify-query-namedquery-properties-label"></span><h4><a class="toc-backref" href="#id43">6.3.2.5.3. Specifying as Named query in Properties file</a><a class="headerlink" href="#specifying-as-named-query-in-properties-file" title="Permalink to this headline">¶</a></h4>
<p>Specify the query in the properties file (classpath:META-INF/jpa-named-queries.properties) of Spring Data JPA.</p>
<div class="line-block">
<div class="line"><strong>Consider using this method when it is required to write a database platform specific SQL at the time of using NativeQuery.</strong></div>
<div class="line"><strong>Even if it is database platform specific SQL, it is recommended that you use a method to directly specify in &#64;Query annotation when there is no dependency on the execution environment.</strong></div>
</div>
<ul class="simple">
<li>OrderRepositry.java</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Query</span><span class="o">(</span><span class="n">nativeQuery</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findAllByStatusCode</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;statusCode&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">statusCode</span><span class="o">);</span> <span class="c1">// (1)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>Regarding the lookup name of named query, class name of entity and method name linked by “<code class="docutils literal"><span class="pre">.</span></code>” (dot) is used.
In the above example, <code class="docutils literal"><span class="pre">Order.findAllByStatusCode</span></code> is used as Lookup name.</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>Specifying Lookup name of Named query</strong></p>
<p>As per default behavior, Lookup name is contructed by connecting class name of the entity linked with method name using “<code class="docutils literal"><span class="pre">.</span></code>” (dot). However, any name can be specified.</p>
<ul class="last simple">
<li>For fetching entities, specify it in name attribute of <code class="docutils literal"><span class="pre">&#64;Query</span></code> annotation.</li>
<li>For count at the time of page search, specify it in countName attribute of <code class="docutils literal"><span class="pre">&#64;Query</span></code> annotation.</li>
</ul>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Query</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;OrderRepository.findAllByStatusCode&quot;</span><span class="o">,</span> <span class="n">nativeQuery</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <span class="c1">// (2)</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findAllByStatusCode</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;statusCode&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">statusCode</span><span class="o">);</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>In the above example, <code class="docutils literal"><span class="pre">OrderRepository.findAllByStatusCode</span></code> is specified as the Lookup name for the query.</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">jpa-named-queries.properties</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-properties"><div class="highlight"><pre><span></span><span class="c"># (3)</span>
<span class="na">Order.findAllByStatusCode</span><span class="o">=</span><span class="s">SELECT * FROM order WHERE status_code = :statusCode</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the SQL to be executed by using lookup name for the query as the key.</div>
<div class="line">In the above example, the SQL to be executed has been specified by using <code class="docutils literal"><span class="pre">Order.findAllByStatusCode</span></code> as key.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>The method of specifying Named Query in any properties file instead of the properties file of Spring Data JPA is explained below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">xxx-infra.xml</span></code></li>
</ul>
<blockquote class="last">
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;jpa:repositories</span> <span class="na">base-package=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.repository&quot;</span>
    <span class="na">named-queries-location=</span><span class="s">&quot;classpath:META-INF/jpa/jpa-named-queries.properties&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify any properties file in named-queries-location attribute of &lt;jpa:repositories&gt; element.</div>
<div class="line">In the above example, <code class="file docutils literal"><span class="pre">META-INF/jpa/jpa-named-queries.properties</span></code> on class path is used.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="implementing-the-process-to-search-entities">
<h3><a class="toc-backref" href="#id44">6.3.2.6. Implementing the process to search entities</a><a class="headerlink" href="#implementing-the-process-to-search-entities" title="Permalink to this headline">¶</a></h3>
<p>The method to search entities is explained below.</p>
<div class="section" id="searching-all-entities-matching-the-conditions">
<h4><a class="toc-backref" href="#id45">6.3.2.6.1. Searching all entities matching the conditions</a><a class="headerlink" href="#searching-all-entities-matching-the-conditions" title="Permalink to this headline">¶</a></h4>
<p>Call a query method to fetch all entities that match the conditions.</p>
<ul class="simple">
<li>Repository interface</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AccountRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="c1">// (1)</span>
    <span class="nd">@Query</span><span class="o">(</span><span class="s">&quot;SELECT a FROM Account a WHERE :createdDateFrom &lt;= a.createdDate AND a.createdDate &lt; :createdDateTo ORDER BY a.createdDate DESC&quot;</span><span class="o">)</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="nf">findByCreatedDate</span><span class="o">(</span>
            <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;createdDateFrom&quot;</span><span class="o">)</span> <span class="n">Date</span> <span class="n">createdDateFrom</span><span class="o">,</span>
            <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;createdDateTo&quot;</span><span class="o">)</span> <span class="n">Date</span> <span class="n">createdDateTo</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a query method to return <code class="docutils literal"><span class="pre">java.util.List</span></code> interface.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Service</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="nf">getAccounts</span><span class="o">(</span><span class="n">Date</span> <span class="n">targetDate</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">LocalDate</span> <span class="n">targetLocalDate</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LocalDate</span><span class="o">(</span><span class="n">targetDate</span><span class="o">);</span>
    <span class="n">Date</span> <span class="n">fromDate</span> <span class="o">=</span> <span class="n">targetLocalDate</span><span class="o">.</span><span class="na">toDate</span><span class="o">();</span>
    <span class="n">Date</span> <span class="n">toDate</span> <span class="o">=</span> <span class="n">targetLocalDate</span><span class="o">.</span><span class="na">dayOfYear</span><span class="o">().</span><span class="na">addToCopy</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="na">toDate</span><span class="o">();</span>

    <span class="c1">// (2)</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="n">accounts</span> <span class="o">=</span> <span class="n">accountRepository</span><span class="o">.</span><span class="na">findByCreatedDate</span><span class="o">(</span><span class="n">fromDate</span><span class="o">,</span>
            <span class="n">toDate</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">accounts</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// (3)</span>
        <span class="c1">// ...</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">accounts</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call the query method defined in Repository interface.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">If the search result is 0 records, a blank list is returned. As null is not returned, null check is not required.</div>
<div class="line">If needed, implement the process when the search result is 0 records.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="searching-page-of-entities-matching-the-conditions">
<span id="dataaccessjpahowtousefindpage"></span><h4><a class="toc-backref" href="#id46">6.3.2.6.2. Searching page of entities matching the conditions</a><a class="headerlink" href="#searching-page-of-entities-matching-the-conditions" title="Permalink to this headline">¶</a></h4>
<p>Amongst the entities matching the conditions, call a query method to fetch the entities of the specified page.</p>
<ul class="simple">
<li>Repository interface</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AccountRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="c1">// (1)</span>
    <span class="nd">@Query</span><span class="o">(</span><span class="s">&quot;SELECT a FROM Account a WHERE :createdDateFrom &lt;= a.createdDate AND a.createdDate &lt; :createdDateTo&quot;</span><span class="o">)</span>
    <span class="n">Page</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="nf">findByCreatedDate</span><span class="o">(</span>
            <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;createdDateFrom&quot;</span><span class="o">)</span> <span class="n">Date</span> <span class="n">createdDateFrom</span><span class="o">,</span>
            <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;createdDateTo&quot;</span><span class="o">)</span> <span class="n">Date</span> <span class="n">createdDateTo</span><span class="o">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Receive <code class="docutils literal"><span class="pre">org.springframework.data.domain.Pageable</span></code> interface as an argument and define query method for returning <code class="docutils literal"><span class="pre">org.springframework.data.domain.Page</span></code> interface.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Controller</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;list&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">list</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;targetDate&quot;</span><span class="o">)</span> <span class="n">Date</span> <span class="n">targetDate</span><span class="o">,</span>
                   <span class="nd">@PageableDefault</span><span class="o">(</span>
                       <span class="n">page</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span>
                       <span class="n">value</span> <span class="o">=</span> <span class="mi">5</span><span class="o">,</span>
                       <span class="n">sort</span> <span class="o">=</span> <span class="o">{</span> <span class="s">&quot;createdDate&quot;</span> <span class="o">},</span>
                       <span class="n">direction</span> <span class="o">=</span> <span class="n">Direction</span><span class="o">.</span><span class="na">DESC</span><span class="o">)</span>
                       <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">,</span> <span class="c1">// (2)</span>
                   <span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Page</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">accountPage</span> <span class="o">=</span> <span class="n">accountService</span><span class="o">.</span><span class="na">getAccounts</span><span class="o">(</span><span class="n">targetDate</span><span class="o">,</span> <span class="n">pageable</span><span class="o">);</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;accountPage&quot;</span><span class="o">,</span> <span class="n">accountPage</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">&quot;account/list&quot;</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create object (<code class="docutils literal"><span class="pre">org.springframework.data.domain.Pageable</span></code>) for paging search provided by Spring Data.</div>
<div class="line">For details, refer to “<a class="reference internal" href="../WebApplicationDetail/Pagination.html"><span class="doc">Pagination</span></a>”.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Service</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Page</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="nf">getAccounts</span><span class="o">(</span><span class="n">Date</span> <span class="n">targetDate</span> <span class="o">,</span><span class="n">Pageable</span> <span class="n">pageable</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">LocalDate</span> <span class="n">targetLocalDate</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LocalDate</span><span class="o">(</span><span class="n">targetDate</span><span class="o">);</span>
    <span class="n">Date</span> <span class="n">fromDate</span> <span class="o">=</span> <span class="n">targetLocalDate</span><span class="o">.</span><span class="na">toDate</span><span class="o">();</span>
    <span class="n">Date</span> <span class="n">toDate</span> <span class="o">=</span> <span class="n">targetLocalDate</span><span class="o">.</span><span class="na">dayOfYear</span><span class="o">().</span><span class="na">addToCopy</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="na">toDate</span><span class="o">();</span>

    <span class="c1">// (3)</span>
    <span class="n">Page</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">accountRepository</span><span class="o">.</span><span class="na">findByCreatedDate</span><span class="o">(</span><span class="n">fromDate</span><span class="o">,</span>
            <span class="n">toDate</span><span class="o">,</span> <span class="n">pageable</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">page</span><span class="o">.</span><span class="na">hasContent</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// (4)</span>
        <span class="c1">// ...</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">page</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call the query method defined in Repository interface.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">If the search result is 0 records, a blank list will be set in <code class="docutils literal"><span class="pre">Page</span></code>  object and <code class="docutils literal"><span class="pre">false</span></code>  will be returned for <code class="docutils literal"><span class="pre">Page#hasContent()</span></code> method.</div>
<div class="line">If needed, implement the process when the search result is 0 records.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="implementing-search-process-as-per-the-dynamic-conditions-of-entities">
<h3><a class="toc-backref" href="#id47">6.3.2.7. Implementing search process as per the dynamic conditions of entities</a><a class="headerlink" href="#implementing-search-process-as-per-the-dynamic-conditions-of-entities" title="Permalink to this headline">¶</a></h3>
<p>To add query method to Repository for searching the entities as per dynamic conditions, search process should be implemented by creating
custom Repository interface and custom Repository class for the entity specific Repository interface.
For method of creating custom Repository interface and custom Repository class, refer to “<a class="reference internal" href="#custommethod-individual-label"><span class="std std-ref">Adding individual custom method to entity specific Repository interface</span></a>”.</p>
<p>See the description below to search entities by applying dynamic conditions.</p>
<div class="admonition-todo admonition" id="index-2">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p>Following contents will be added in future.</p>
<ul class="last simple">
<li>Example illustrating implementation of dynamic query using QueryDSL.</li>
</ul>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="searching-all-entities-matching-the-dynamic-conditions">
<h4><a class="toc-backref" href="#id48">6.3.2.7.1. Searching all entities matching the dynamic conditions</a><a class="headerlink" href="#searching-all-entities-matching-the-dynamic-conditions" title="Permalink to this headline">¶</a></h4>
<p>Implement and call the query method for fetching all entities matching the dynamic conditions.</p>
<p>See the example below.</p>
<p>Here, the conditions below are specified as dynamic conditions.</p>
<ul class="simple">
<li>Order ID</li>
<li>Product name</li>
<li>Order status (multiple statuses can be specified)</li>
</ul>
<p>Further, the search is narrowed down using AND operator for the orders matching the specified conditions.
If no condition is specified, a blank list will be returned.</p>
<ul class="simple">
<li>Criteria (JavaBean)</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderCriteria</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span> <span class="c1">// (1)</span>

    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">itemName</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">statusCodes</span><span class="o">;</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create a Criteria object (JavaBean) storing the search conditions.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Custom Repository interface</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderRepositoryCustom</span> <span class="o">{</span>

    <span class="n">Page</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findAllByCriteria</span><span class="o">(</span><span class="n">OrderCriteria</span> <span class="n">criteria</span><span class="o">);</span> <span class="c1">// (2)</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a method in custom Repository interface which receives Criteria object as an argument and returns List of Order objects.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Custom Repository class</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderRepositoryImpl</span> <span class="kd">implements</span> <span class="n">OrderRepositoryCustom</span> <span class="o">{</span> <span class="c1">// (3)</span>

    <span class="nd">@PersistenceContext</span>
    <span class="n">EntityManager</span> <span class="n">entityManager</span><span class="o">;</span> <span class="c1">// (4)</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findAllByCriteria</span><span class="o">(</span><span class="n">OrderCriteria</span> <span class="n">criteria</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (5)</span>

        <span class="c1">// Collect dynamic conditions.</span>
        <span class="c1">// (6)</span>
        <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">andConditions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
        <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">joinConditions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
        <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">bindParameters</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>

        <span class="c1">// (7)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">criteria</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">andConditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;o.id = :id&quot;</span><span class="o">);</span>
            <span class="n">bindParameters</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="n">criteria</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">CollectionUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">criteria</span><span class="o">.</span><span class="na">getStatusCodes</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">andConditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;o.status.code IN :statusCodes&quot;</span><span class="o">);</span>
            <span class="n">bindParameters</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;statusCodes&quot;</span><span class="o">,</span> <span class="n">criteria</span><span class="o">.</span><span class="na">getStatusCodes</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">hasLength</span><span class="o">(</span><span class="n">criteria</span><span class="o">.</span><span class="na">getItemName</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">joinConditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;o.orderItems oi&quot;</span><span class="o">);</span>
            <span class="n">joinConditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;oi.item i&quot;</span><span class="o">);</span>
            <span class="n">andConditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;i.name LIKE :itemName ESCAPE &#39;~&#39;&quot;</span><span class="o">);</span>
            <span class="n">bindParameters</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;itemName&quot;</span><span class="o">,</span> <span class="n">QueryEscapeUtils</span>
                    <span class="o">.</span><span class="na">toLikeCondition</span><span class="o">(</span><span class="n">criteria</span><span class="o">.</span><span class="na">getItemName</span><span class="o">()));</span>
        <span class="o">}</span>

        <span class="c1">// (8)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">andConditions</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="c1">// (9)</span>
        <span class="c1">// Create dynamic query.</span>
        <span class="kd">final</span> <span class="n">StringBuilder</span> <span class="n">queryString</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>

        <span class="c1">// (10)</span>
        <span class="n">queryString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;SELECT o FROM Order o&quot;</span><span class="o">);</span>

        <span class="c1">// (11)</span>
        <span class="c1">// add join conditions.</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">joinCondition</span> <span class="o">:</span> <span class="n">joinConditions</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">queryString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot; LEFT JOIN &quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">joinCondition</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// add conditions.</span>
        <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">andConditionsIt</span> <span class="o">=</span> <span class="n">andConditions</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">andConditionsIt</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">queryString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot; WHERE &quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">andConditionsIt</span><span class="o">.</span><span class="na">next</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">andConditionsIt</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">queryString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot; AND &quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">andConditionsIt</span><span class="o">.</span><span class="na">next</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="c1">// (12)</span>
        <span class="c1">// add order by condition.</span>
        <span class="n">queryString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot; ORDER BY o.id&quot;</span><span class="o">);</span>

        <span class="c1">// (13)</span>
        <span class="c1">// Create typed query.</span>
        <span class="kd">final</span> <span class="n">TypedQuery</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">findQuery</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span>
                <span class="n">queryString</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">Order</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">// Bind parameters.</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">bindParameter</span> <span class="o">:</span> <span class="n">bindParameters</span>
                <span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">findQuery</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="n">bindParameter</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">bindParameter</span>
                    <span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="c1">// (14)</span>
        <span class="c1">// Execute query.</span>
        <span class="k">return</span> <span class="n">findQuery</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>

    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create implementation class of custom Repository interface.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inject <code class="docutils literal"><span class="pre">EntityManager</span></code>.</div>
<div class="line">Inject using <code class="docutils literal"><span class="pre">&#64;javax.persistence.PersistenceContext</span></code> annotation.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Implement the query method to fetch all the entities matching the dynamic conditions.</div>
<div class="line">In the above example, the method is not split for explanation purpose; however it can be split if required.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define the variables (list for AND condition, list for join condition, bind parameter map) to build dynamic queries.</div>
<div class="line">Set the required information in the variables for the items for which conditions are specified in OrderCriteria object.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Determine whether conditions are specified in OrderCriteria object and set the required information for building dynamic queries.</div>
<div class="line">In the above example, the information is set to fetch the items wherein <code class="docutils literal"><span class="pre">id</span></code> is completely matched with the specified value, <code class="docutils literal"><span class="pre">statusCodes</span></code> is included in the specified list, and <code class="docutils literal"><span class="pre">itemName</span></code> satisfying forward match with the specified value.</div>
<div class="line">For <code class="docutils literal"><span class="pre">itemName</span></code>, the related-entities having the values to be compared have a complex nested relation; hence these entities should be joined.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In the above example, when conditions are not specified, return a blank list as there is no need to perform search.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When conditions are specified, build the query for searching entities.</div>
<div class="line">In the above example, query to be executed is built using <code class="docutils literal"><span class="pre">java.lang.StringBuilder</span></code> class.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Build static query elements.</div>
<div class="line">In the above example, SELECT clause and FROM clause are built as static query elements.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Build dynamic query elements.</div>
<div class="line">In the above example, conditions to be set in join conditions list (JOIN clause) and AND conditions list (WHERE clause) are built as dynamic query elements.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Build the static query elements.</div>
<div class="line">In the above example, ORDER BY clause is built as static query elements.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(13)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Convert the dynamically built query string into <code class="docutils literal"><span class="pre">javax.persistence.TypedQuery</span></code>, and set the bind parameters required for executing the query.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(14)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Execute the dynamically built query and fetch all the entities matching the conditions.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Entity specific Repository interface</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;,</span>
                                <span class="n">OrderRepositoryCustom</span> <span class="o">{</span> <span class="c1">// (15)</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(15)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inherit the custom Repository interface in entity specific Repository interface.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Service (Caller)</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// condition values for sample.</span>
<span class="n">Integer</span> <span class="n">conditionValueOfId</span> <span class="o">=</span> <span class="mi">4</span><span class="o">;</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">conditionValueOfStatusCodes</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">&quot;accepted&quot;</span><span class="o">);</span>
<span class="n">String</span> <span class="n">conditionValueOfItemName</span> <span class="o">=</span> <span class="s">&quot;Wat&quot;</span><span class="o">;</span>

<span class="c1">// implementation of sample.</span>
<span class="c1">// (16)</span>
<span class="n">OrderCriteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OrderCriteria</span><span class="o">();</span>
<span class="n">criteria</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">conditionValueOfId</span><span class="o">);</span>
<span class="n">criteria</span><span class="o">.</span><span class="na">setStatusCodes</span><span class="o">(</span><span class="n">conditionValueOfStatusCodes</span><span class="o">);</span>
<span class="n">criteria</span><span class="o">.</span><span class="na">setItemName</span><span class="o">(</span><span class="n">conditionValueOfItemName</span><span class="o">);</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">orderRepository</span><span class="o">.</span><span class="na">findAllByCriteria</span><span class="o">(</span><span class="n">criteria</span><span class="o">);</span> <span class="c1">// (17)</span>
<span class="k">if</span> <span class="o">(</span><span class="n">orders</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// (18)</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(16)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the search conditions in OrderCriteria object.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(17)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use OrderCriteria as an argument and call the query method to get all the entities matching the dynamic conditions.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(18)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Analyze the search results and perform the processing required in case of 0 records.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Executed JPQL(SQL)</li>
</ul>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (19)</span>
<span class="c1">--   conditionValueOfId=4</span>
<span class="c1">--   conditionValueOfStatusCodes = [&quot;accepted&quot;]</span>
<span class="c1">--   conditionValueOfItemName = &quot;Wat&quot;</span>

<span class="c1">-- JPQL</span>
<span class="k">SELECT</span>
        <span class="n">o</span>
    <span class="k">FROM</span>
        <span class="k">ORDER</span> <span class="n">o</span>
            <span class="k">JOIN</span> <span class="n">o</span><span class="p">.</span><span class="n">orderItems</span> <span class="n">oi</span>
                <span class="k">JOIN</span> <span class="n">oi</span><span class="p">.</span><span class="n">item</span> <span class="n">i</span>
            <span class="k">WHERE</span>
                <span class="n">o</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="p">:</span><span class="n">id</span>
                <span class="k">AND</span> <span class="n">o</span><span class="p">.</span><span class="n">status</span><span class="p">.</span><span class="n">code</span> <span class="k">IN</span> <span class="p">:</span><span class="n">statusCodes</span>
                <span class="k">AND</span> <span class="n">i</span><span class="p">.</span><span class="n">name</span> <span class="k">LIKE</span> <span class="p">:</span><span class="n">itemName</span> <span class="k">ESCAPE</span> <span class="s1">&#39;~&#39;</span>
            <span class="k">ORDER</span> <span class="k">BY</span>
                <span class="n">o</span><span class="p">.</span><span class="n">id</span>

<span class="c1">-- SQL</span>
<span class="k">SELECT</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">id1_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">created_by</span> <span class="k">AS</span> <span class="n">created2_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">created_date</span> <span class="k">AS</span> <span class="n">created3_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">last_modified_by</span> <span class="k">AS</span> <span class="n">last4_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">last_modified_date</span> <span class="k">AS</span> <span class="n">last5_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="k">AS</span> <span class="n">status6_6_</span>
    <span class="k">FROM</span>
        <span class="n">t_order</span> <span class="n">order0_</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">t_order_item</span> <span class="n">orderitems1_</span>
            <span class="k">ON</span> <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">orderitems1_</span><span class="p">.</span><span class="n">order_id</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">m_item</span> <span class="n">item2_</span>
            <span class="k">ON</span> <span class="n">orderitems1_</span><span class="p">.</span><span class="n">item_code</span> <span class="o">=</span> <span class="n">item2_</span><span class="p">.</span><span class="n">code</span>
<span class="k">WHERE</span>
    <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">AND</span> <span class="p">(</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">&#39;accepted&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">AND</span> <span class="p">(</span>
        <span class="n">item2_</span><span class="p">.</span><span class="n">name</span> <span class="k">LIKE</span> <span class="s1">&#39;Wat%&#39;</span> <span class="k">ESCAPE</span> <span class="s1">&#39;~&#39;</span>
    <span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">order0_</span><span class="p">.</span><span class="n">id</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(19)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Example of generated JPQL and SQL when all the conditions are specified.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (20)</span>
<span class="c1">--   conditionValueOfId=4</span>
<span class="c1">--   conditionValueOfStatusCodes = [&quot;accepted&quot;]</span>
<span class="c1">--   conditionValueOfItemName = &quot;&quot;</span>
<span class="c1">-- JPQL</span>
<span class="k">SELECT</span>
        <span class="n">o</span>
    <span class="k">FROM</span>
        <span class="k">ORDER</span> <span class="n">o</span>
    <span class="k">WHERE</span>
        <span class="n">o</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="p">:</span><span class="n">id</span>
        <span class="k">AND</span> <span class="n">o</span><span class="p">.</span><span class="n">status</span><span class="p">.</span><span class="n">code</span> <span class="k">IN</span> <span class="p">:</span><span class="n">statusCodes</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="n">o</span><span class="p">.</span><span class="n">id</span>

<span class="c1">-- SQL</span>
<span class="k">SELECT</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">id1_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">created_by</span> <span class="k">AS</span> <span class="n">created2_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">created_date</span> <span class="k">AS</span> <span class="n">created3_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">last_modified_by</span> <span class="k">AS</span> <span class="n">last4_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">last_modified_date</span> <span class="k">AS</span> <span class="n">last5_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="k">AS</span> <span class="n">status6_6_</span>
    <span class="k">FROM</span>
        <span class="n">t_order</span> <span class="n">order0_</span>
    <span class="k">WHERE</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">AND</span> <span class="p">(</span>
            <span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">&#39;accepted&#39;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(20)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Example of generated JPQL and SQL when conditions other than <code class="docutils literal"><span class="pre">iteName</span></code> are specified.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (21)</span>
<span class="c1">--   conditionValueOfId=4</span>
<span class="c1">--   conditionValueOfStatusCodes = []</span>
<span class="c1">--   conditionValueOfItemName = &quot;&quot;</span>
<span class="c1">-- JPQL</span>
<span class="k">SELECT</span>
        <span class="n">o</span>
    <span class="k">FROM</span>
        <span class="k">ORDER</span> <span class="n">o</span>
    <span class="k">WHERE</span>
        <span class="n">o</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="p">:</span><span class="n">id</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="n">o</span><span class="p">.</span><span class="n">id</span>

<span class="c1">-- SQL</span>
<span class="k">SELECT</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">id1_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">created_by</span> <span class="k">AS</span> <span class="n">created2_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">created_date</span> <span class="k">AS</span> <span class="n">created3_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">last_modified_by</span> <span class="k">AS</span> <span class="n">last4_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">last_modified_date</span> <span class="k">AS</span> <span class="n">last5_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="k">AS</span> <span class="n">status6_6_</span>
    <span class="k">FROM</span>
        <span class="n">t_order</span> <span class="n">order0_</span>
    <span class="k">WHERE</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(21)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Example of generated JPQL and SQL when only <code class="docutils literal"><span class="pre">id</span></code> is specified.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="page-search-for-the-entities-matching-the-dynamic-conditions">
<h4><a class="toc-backref" href="#id49">6.3.2.7.2. Page search for the entities matching the dynamic conditions</a><a class="headerlink" href="#page-search-for-the-entities-matching-the-dynamic-conditions" title="Permalink to this headline">¶</a></h4>
<p>Implement and call the query method to fetch the entities corresponding to the specified page, amongst the entities matching the dynamic conditions.</p>
<p>As shown in the example below, the specification is same as that for normal search except for fetching the corresponding page.
Further, the description for fetching all records is omitted.</p>
<ul class="simple">
<li>Custom Repository interface</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderRepositoryCustom</span> <span class="o">{</span>

    <span class="n">Page</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findPageByCriteria</span><span class="o">(</span><span class="n">OrderCriteria</span> <span class="n">criteria</span><span class="o">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">);</span> <span class="c1">// (1)</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define the query method to fetch the entities corresponding to the specified page, amongst the entities matching the dynamic conditions.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Custom Repository class</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderRepositoryCustomImpl</span> <span class="kd">implements</span> <span class="n">OrderRepositoryCustom</span> <span class="o">{</span>

    <span class="nd">@PersistenceContext</span>
    <span class="n">EntityManager</span> <span class="n">entityManager</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">Page</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findPageByCriteria</span><span class="o">(</span><span class="n">OrderCriteria</span> <span class="n">criteria</span><span class="o">,</span>
            <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (2)</span>

        <span class="c1">// collect dynamic conditions.</span>
        <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">andConditions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
        <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">joinConditions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
        <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">bindParameters</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">criteria</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">andConditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;o.id = :id&quot;</span><span class="o">);</span>
            <span class="n">bindParameters</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="n">criteria</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">CollectionUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">criteria</span><span class="o">.</span><span class="na">getStatusCodes</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">andConditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;o.status.code IN :statusCodes&quot;</span><span class="o">);</span>
            <span class="n">bindParameters</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;statusCodes&quot;</span><span class="o">,</span> <span class="n">criteria</span><span class="o">.</span><span class="na">getStatusCodes</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">hasLength</span><span class="o">(</span><span class="n">criteria</span><span class="o">.</span><span class="na">getItemName</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">joinConditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;o.orderItems oi&quot;</span><span class="o">);</span>
            <span class="n">joinConditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;oi.item i&quot;</span><span class="o">);</span>
            <span class="n">andConditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;i.name LIKE :itemName ESCAPE &#39;~&#39;&quot;</span><span class="o">);</span>
            <span class="n">bindParameters</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;itemName&quot;</span><span class="o">,</span> <span class="n">QueryEscapeUtils</span><span class="o">.</span><span class="na">toLikeCondition</span><span class="o">(</span><span class="n">criteria</span>
                    <span class="o">.</span><span class="na">getItemName</span><span class="o">()));</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">andConditions</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">PageImpl</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;(</span><span class="n">orders</span><span class="o">,</span> <span class="n">pageable</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span> <span class="c1">// (3)</span>
        <span class="o">}</span>

        <span class="c1">// create dynamic query.</span>
        <span class="kd">final</span> <span class="n">StringBuilder</span> <span class="n">queryString</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
        <span class="kd">final</span> <span class="n">StringBuilder</span> <span class="n">countQueryString</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span> <span class="c1">// (4)</span>
        <span class="kd">final</span> <span class="n">StringBuilder</span> <span class="n">conditionsString</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span> <span class="c1">// (4)</span>

        <span class="n">queryString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;SELECT o FROM Order o&quot;</span><span class="o">);</span>
        <span class="n">countQueryString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;SELECT COUNT(o) FROM Order o&quot;</span><span class="o">);</span> <span class="c1">// (5)</span>

        <span class="c1">// add join conditions.</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">joinCondition</span> <span class="o">:</span> <span class="n">joinConditions</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">conditionsString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot; JOIN &quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">joinCondition</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// add conditions.</span>
        <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">andConditionsIt</span> <span class="o">=</span> <span class="n">andConditions</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">andConditionsIt</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">conditionsString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot; WHERE &quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">andConditionsIt</span><span class="o">.</span><span class="na">next</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">andConditionsIt</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">conditionsString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot; AND &quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">andConditionsIt</span><span class="o">.</span><span class="na">next</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="n">queryString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">conditionsString</span><span class="o">);</span> <span class="c1">// (6)</span>
        <span class="n">countQueryString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">conditionsString</span><span class="o">);</span> <span class="c1">// (6)</span>

        <span class="c1">// add order by condition.</span>
        <span class="c1">// (7)</span>
        <span class="n">String</span> <span class="n">orderByString</span> <span class="o">=</span> <span class="n">QueryUtils</span><span class="o">.</span><span class="na">applySorting</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">,</span> <span class="n">pageable</span><span class="o">.</span><span class="na">getSort</span><span class="o">(),</span> <span class="s">&quot;o&quot;</span><span class="o">);</span>
        <span class="n">queryString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">orderByString</span><span class="o">);</span>

        <span class="c1">// create typed query.</span>
        <span class="kd">final</span> <span class="n">TypedQuery</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">countQuery</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span>
                <span class="n">countQueryString</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">Long</span><span class="o">.</span><span class="na">class</span><span class="o">);</span> <span class="c1">// (8)</span>

        <span class="kd">final</span> <span class="n">TypedQuery</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">findQuery</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span>
                <span class="n">queryString</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">Order</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="c1">// bind parameters.</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">bindParameter</span> <span class="o">:</span> <span class="n">bindParameters</span>
                <span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">countQuery</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="n">bindParameter</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">bindParameter</span>
                    <span class="o">.</span><span class="na">getValue</span><span class="o">());</span> <span class="c1">// (8)</span>
            <span class="n">findQuery</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="n">bindParameter</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">bindParameter</span>
                    <span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="kt">long</span> <span class="n">total</span> <span class="o">=</span> <span class="n">countQuery</span><span class="o">.</span><span class="na">getSingleResult</span><span class="o">().</span><span class="na">longValue</span><span class="o">();</span> <span class="c1">// (9)</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">orders</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">total</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (10)</span>
            <span class="n">findQuery</span><span class="o">.</span><span class="na">setFirstResult</span><span class="o">(</span><span class="n">pageable</span><span class="o">.</span><span class="na">getOffset</span><span class="o">());</span>
            <span class="n">findQuery</span><span class="o">.</span><span class="na">setMaxResults</span><span class="o">(</span><span class="n">pageable</span><span class="o">.</span><span class="na">getPageSize</span><span class="o">());</span>
            <span class="c1">// execute query.</span>
            <span class="n">orders</span> <span class="o">=</span> <span class="n">findQuery</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span> <span class="c1">// (11)</span>
            <span class="n">orders</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="k">new</span> <span class="n">PageImpl</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;(</span><span class="n">orders</span><span class="o">,</span> <span class="n">pageable</span><span class="o">,</span> <span class="n">total</span><span class="o">);</span> <span class="c1">// (12)</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Implement the query method to fetch the entities corresponding to the specified page, amongst the entities matching the dynamic conditions.</div>
<div class="line">In the above example, the method is not split for explanation purpose; however it can be split if required.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In the above example, when conditions are not specified, return a blank page information as there is no need to perform search.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create variables to build the queries to fetch records and to build the conditions (join condition and AND condition).</div>
<div class="line">Same conditions need to be used in query for fetching entities and in query for fetching records; hence variables are created to build the conditions (join condition and AND condition).</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Build the static query elements of query to fetch records.</div>
<div class="line">In the above example, SELECT clause and FROM clause are built as static query components.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Build the dynamic query elements for query to fetch entities and query to fetch records.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Sort conditions (ORDER BY clause) are built as dynamic query elements for the query to fetch entities.</div>
<div class="line">Utility component (<code class="docutils literal"><span class="pre">org.springframework.data.jpa.repository.query.QueryUtils</span></code>) provided by Spring Data JPA is used for building the ORDER BY clause.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Convert the query string for fetching the dynamically built records into <code class="docutils literal"><span class="pre">javax.persistence.TypedQuery</span></code> and set the bind parameter for required for executing the query.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Execute the query for fetching the records and get the total number of records matching the conditions.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">If the entities matching the conditions exist, execute the query for fetching the entities and fetch the information of the corresponding page.</div>
<div class="line">When executing the query for fetching entities, specify the start index for fetching records (<code class="docutils literal"><span class="pre">TypedQuery#setFirstResult</span></code>) and the number of records to be fetched (<code class="docutils literal"><span class="pre">TypedQuery#setMaxResults</span></code>).</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">If entity matching the conditions does not exist, a blank list should be fetched.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify entity list of the corresponding page, page information and total number of records matching the conditions as arguments and then create and return the <code class="docutils literal"><span class="pre">Page</span></code> object.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Service (Caller)</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// condition values for sample.</span>
<span class="n">Integer</span> <span class="n">conditionValueOfId</span> <span class="o">=</span> <span class="mi">4</span><span class="o">;</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">conditionValueOfStatusCodes</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">&quot;accepted&quot;</span><span class="o">);</span>
<span class="n">String</span> <span class="n">conditionValueOfItemName</span> <span class="o">=</span> <span class="s">&quot;Wat&quot;</span><span class="o">;</span>

<span class="c1">// implementation of sample.</span>
<span class="n">OrderCriteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OrderCriteria</span><span class="o">();</span>
<span class="n">criteria</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">conditionValueOfId</span><span class="o">);</span>
<span class="n">criteria</span><span class="o">.</span><span class="na">setStatusCodes</span><span class="o">(</span><span class="n">conditionValueOfStatusCodes</span><span class="o">);</span>
<span class="n">criteria</span><span class="o">.</span><span class="na">setItemName</span><span class="o">(</span><span class="n">conditionValueOfItemName</span><span class="o">);</span>
<span class="n">Page</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">orderPage</span> <span class="o">=</span> <span class="n">orderRepository</span><span class="o">.</span><span class="na">findPageByCriteria</span><span class="o">(</span><span class="n">criteria</span><span class="o">,</span>
        <span class="n">pageable</span><span class="o">);</span> <span class="c1">// (13)</span>
<span class="k">if</span> <span class="o">(!</span><span class="n">orderPage</span><span class="o">.</span><span class="na">hasContent</span><span class="o">())</span> <span class="o">{</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(13)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call the query method to fetch the entities corresponding to the specified page, amongst the entities matching the dynamic conditions.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="implementing-the-process-to-fetch-entities">
<h3><a class="toc-backref" href="#id50">6.3.2.8. Implementing the process to fetch entities</a><a class="headerlink" href="#implementing-the-process-to-fetch-entities" title="Permalink to this headline">¶</a></h3>
<p>The method of fetching entities is explained below.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="fetching-1-record-of-entity-by-specifying-id">
<h4><a class="toc-backref" href="#id51">6.3.2.8.1. Fetching 1 record of entity by specifying ID</a><a class="headerlink" href="#fetching-1-record-of-entity-by-specifying-id" title="Permalink to this headline">¶</a></h4>
<p>If the ID (Primary Key) is known, fetch the entity object by calling the findOne method of Repository interface.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Account</span> <span class="nf">getAccount</span><span class="o">(</span><span class="n">String</span> <span class="n">accountUuid</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">accountRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">accountUuid</span><span class="o">);</span> <span class="c1">// (1)</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">account</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (2)</span>
        <span class="c1">// ...</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">account</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the ID (Primary Key) of entity and call the findOne(ID) method of Repository interface.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When the specified entity ID does not exist, the return value would be null, hence null check is necessary.</div>
<div class="line">If needed, implement the process which is carried out when the specified entity ID does not exist.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Returned entity objects</strong></p>
<p class="last">When the entity object of specified ID is already managed by <code class="docutils literal"><span class="pre">EntityManager</span></code>, entity object managed by <code class="docutils literal"><span class="pre">EntityManager</span></code> is returned without
accessing the persistence layer (DB).
Therefore, if findOne method is used, unnecessary access to persistence layer can be controlled.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Load timing of the related-entity</strong></p>
<p>Load of the related-entity during query execution is determined based on the value specified in fetch attribute of annotations
(<code class="docutils literal"><span class="pre">&#64;javax.persistence.OneToOne</span></code> , <code class="docutils literal"><span class="pre">&#64;javax.persistence.OneToMany</span></code>, <code class="docutils literal"><span class="pre">&#64;javax.persistence.ManyToOne</span></code> , <code class="docutils literal"><span class="pre">&#64;javax.persistence.ManyToMany</span></code> ).</p>
<ul class="simple">
<li>In case of <code class="docutils literal"><span class="pre">javax.persistence.FetchType#LAZY</span></code> , related-entity is not covered under JOIN FETCH; hence it is loaded at the time of initial access.</li>
<li>In case of <code class="docutils literal"><span class="pre">javax.persistence.FetchType#EAGER</span></code> , related-entity is covered under JOIN FETCH; hence it is loaded at the time of loading the parent-entity.</li>
</ul>
<p>Default values of fetch attribute differ depending on annotations. See the default values below:</p>
<ul class="last simple">
<li><code class="docutils literal"><span class="pre">&#64;OneToOne</span></code> annotation: <code class="docutils literal"><span class="pre">EAGER</span></code></li>
<li><code class="docutils literal"><span class="pre">&#64;ManyToOne</span></code> annotation: <code class="docutils literal"><span class="pre">EAGER</span></code></li>
<li><code class="docutils literal"><span class="pre">&#64;OneToMany</span></code> annotation: <code class="docutils literal"><span class="pre">LAZY</span></code></li>
<li><code class="docutils literal"><span class="pre">&#64;ManyToMany</span></code> annotation: <code class="docutils literal"><span class="pre">LAZY</span></code></li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Sort order of the related-entities having 1:N(N:M) relationship</strong></p>
<p class="last">Specify <code class="docutils literal"><span class="pre">&#64;javax.persistence.OrderBy</span></code> annotation on the property of related-entities to control the sort order.</p>
</div>
<p>See the example below.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">&quot;order&quot;</span><span class="o">,</span> <span class="n">cascade</span> <span class="o">=</span> <span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span> <span class="n">orphanRemoval</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="nd">@OrderBy</span> <span class="c1">// (1)</span>
<span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">OrderItem</span><span class="o">&gt;</span> <span class="n">orderItems</span><span class="o">;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When value attribute is not specified, the entities are sorted in ascending order of ID.</div>
<div class="line">For details, refer to <a class="reference external" href="http://download.oracle.com/otn-pub/jcp/persistence-2_1-fr-eval-spec/JavaPersistence.pdf">JSR 338: Java Persistence API, Specification (PDF) of Version 2.1 “11.1.42 OrderBy Annotation”</a>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition-todo admonition" id="index-3">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p>Following contents will be added in future.</p>
<ul class="last simple">
<li>Example of cases wherein it is better to change fetch attribute from default value.</li>
</ul>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="fetching-1-record-of-entity-by-specifying-conditions-other-than-id">
<h4><a class="toc-backref" href="#id52">6.3.2.8.2. Fetching 1 record of entity by specifying conditions other than ID</a><a class="headerlink" href="#fetching-1-record-of-entity-by-specifying-conditions-other-than-id" title="Permalink to this headline">¶</a></h4>
<p>When the ID is not known, call the query method to search entities by conditions other than ID.</p>
<ul class="simple">
<li>Repository interface</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AccountRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="c1">// (1)</span>
    <span class="nd">@Query</span><span class="o">(</span><span class="s">&quot;SELECT a FROM Account a WHERE a.accountId = :accountId&quot;</span><span class="o">)</span>
    <span class="n">Account</span> <span class="nf">findByAccountId</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;accountId&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">accountId</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define the query method to search 1 record of entity by specifying items other than ID as conditions.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Service</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Account</span> <span class="nf">getAccount</span><span class="o">(</span><span class="n">String</span> <span class="n">accountId</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">accountRepository</span><span class="o">.</span><span class="na">findByAccountId</span><span class="o">(</span><span class="n">accountId</span><span class="o">);</span> <span class="c1">// (2)</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">account</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (3)</span>
        <span class="c1">// ...</span>
    <span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call the query method defined in Repository interface.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Similar to findOne method of Repository interface, when the entities matching the conditions do not exist, null will be returned. Hence null check is necessary.</div>
<div class="line">If needed, implement the process for the scenario when entities matching the specified conditions do not exist.</div>
<div class="line">When multiple entities matching the conditions exist, <code class="docutils literal"><span class="pre">org.springframework.dao.IncorrectResultSizeDataAccessException</span></code> occurs.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Returned entity objects</strong></p>
<p class="last">When a query method is called, the query is always executed on persistence layer (DB).
However, when the entities which are fetched by executing the query are already being managed in <code class="docutils literal"><span class="pre">EntityManager</span></code>, the entity objects fetched from DB are discarded and
the entity objects managed in <code class="docutils literal"><span class="pre">EntityManager</span></code> are returned.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Query method using ID + α as condition</strong></p>
<p>It is recommended not to create a query method wherein ID + α is used as condition.
It can be implemented by creating a logic that compares property value of entity objects fetched by calling findOne method.</p>
<p>The reason for not recommending the creation of this query method is that there is a possibility of the entity objects fetched by executing the query getting discarded and unnecessary query getting executed.
If the ID is known, it is desirable to use findOne method which prevents execution of unnecessary queries.
This should be consciously implemented especially in case of applications with high performance requirements.</p>
<p>However, if the following conditions are applicable, use of query method may reduce the frequency of query execution; hence query method can be used in such cases.</p>
<ul class="last simple">
<li>Properties of related objects (column of related table) are included in a part of + α condition.</li>
<li><code class="docutils literal"><span class="pre">LAZY</span></code> is included in FetchType of the related-entities as a condition.</li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Load timing of the related-entities</strong></p>
<p>Related-entities specified in JOIN FETCH are loaded immediately after executing the query.</p>
<p>The related-entities not specified in JOIN FETCH performs the following operations as per the values specified in  fetch attribute of
associated annotations ( <code class="docutils literal"><span class="pre">&#64;OneToOne</span></code> , <code class="docutils literal"><span class="pre">&#64;OneToMany</span></code> , <code class="docutils literal"><span class="pre">&#64;ManyToOne</span></code> , <code class="docutils literal"><span class="pre">&#64;ManyToMany</span></code> ).</p>
<ul class="last simple">
<li><code class="docutils literal"><span class="pre">javax.persistence.FetchType#LAZY</span></code> is covered under Lazy Load; hence the related-entities are loaded at the time of initial access.</li>
<li>In case of <code class="docutils literal"><span class="pre">javax.persistence.FetchType#EAGER</span></code>, query is executed to load the related-entities and objects of the related-entities are loaded.</li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Sort order of the related-entities having 1:N(N:M) relationship</p>
<ul class="last simple">
<li>The sort order of the related-entities specified in JOIN FETCH is controlled by specifying “ORDER BY” clause in JPQL.</li>
<li>The sort order of the related-entities loaded after executing the query is controlled by specifying <code class="docutils literal"><span class="pre">&#64;javax.persistence.OrderBy</span></code> annotation to the property of the related-entities.</li>
</ul>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="adding-entities">
<h3><a class="toc-backref" href="#id53">6.3.2.9. Adding entities</a><a class="headerlink" href="#adding-entities" title="Permalink to this headline">¶</a></h3>
<p>Example of adding entities is shown below.</p>
<div class="section" id="how-to-add-entities">
<span id="data-access-jpa-how-to-use-way-to-add-entity"></span><h4><a class="toc-backref" href="#id54">6.3.2.9.1. How to add entities</a><a class="headerlink" href="#how-to-add-entities" title="Permalink to this headline">¶</a></h4>
<p>In order to add an entity, create an entity object and call the save method of Repository interface.</p>
<ul class="simple">
<li>Service</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Order</span><span class="o">(</span><span class="s">&quot;accepted&quot;</span><span class="o">);</span> <span class="c1">// (1)</span>
<span class="n">order</span> <span class="o">=</span> <span class="n">orderRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">order</span><span class="o">);</span> <span class="c1">// (2)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create an instance of entity object and set the values for required properties.</div>
<div class="line">In the above example, ID generator of JPA is used for setting the ID. When ID generator of JPA is to be used, ID should not be set in the application code.</div>
<div class="line">If you set the ID in the application code, merge method of <code class="docutils literal"><span class="pre">EntityManager</span></code> gets called leading to execution of unnecessary processing.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call the save method of Repository interface and manage the entity objects created in (1) in <code class="docutils literal"><span class="pre">EntityManager</span></code>.</div>
<div class="line">Take note that entity object passed as an argument of save method will not be the one managed by <code class="docutils literal"><span class="pre">EntityManager</span></code>, but the entity object returned by save method will be the one managed by <code class="docutils literal"><span class="pre">EntityManager</span></code>.</div>
<div class="line">ID is set by the ID generator of JPA at the time of this process.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Demerits of the merge method getting called</strong></p>
<p class="last">merge method of <code class="docutils literal"><span class="pre">EntityManager</span></code> has a mechanism to fetch the entities having same ID from persistence layer (DB), when the entities are to be managed in <code class="docutils literal"><span class="pre">EntityManager</span></code>.
Process to fetch the entities becomes unnecessary while adding the entities. In case of application with high performance requirements, ID generation timing should also be taken into account.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Constraint error handling</strong></p>
<p class="last">When save method is called, query (INSERT) is not executed in the persistence layer (DB).
Therefore, when constraint error such as unique constraint violation needs to be handled, saveAndFlush method or flush method should be called
instead of save method of Repository interface.</p>
</div>
</div></blockquote>
<ul class="simple">
<li>Entity</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Entity</span> <span class="c1">// (3)</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;t_order&quot;</span><span class="o">)</span> <span class="c1">// (4)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="c1">// (5)</span>
    <span class="nd">@SequenceGenerator</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GEN_ORDER_ID&quot;</span><span class="o">,</span> <span class="n">sequenceName</span> <span class="o">=</span> <span class="s">&quot;s_order_id&quot;</span><span class="o">,</span>
                       <span class="n">allocationSize</span> <span class="o">=</span> <span class="mi">1</span><span class="o">)</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">GenerationType</span><span class="o">.</span><span class="na">SEQUENCE</span><span class="o">,</span>
                    <span class="n">generator</span> <span class="o">=</span> <span class="s">&quot;GEN_ORDER_ID&quot;</span><span class="o">)</span>
    <span class="nd">@Id</span> <span class="c1">// (6)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>

    <span class="c1">// (7)</span>
    <span class="nd">@ManyToOne</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;status_code&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">OrderStatus</span> <span class="n">status</span><span class="o">;</span>

    <span class="c1">// ...</span>

    <span class="kd">public</span> <span class="nf">Order</span><span class="o">(</span><span class="n">String</span> <span class="n">statusCode</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">status</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OrderStatus</span><span class="o">(</span><span class="n">statusCode</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Assign <code class="docutils literal"><span class="pre">&#64;javax.persistence.Entity</span></code> annotation to the entity class.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the table name to be mapped with the entity class in name attribute of <code class="docutils literal"><span class="pre">&#64;javax.persistence.Table</span></code> annotation.</div>
<div class="line">The table name need not be specified if it can be resolved from entity name; however, it has to be specified if it cannot be resolved from entity name.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">The annotations required for using ID generator of JPA are being specified.</div>
<div class="line">When using ID generator of JPA, specify <code class="docutils literal"><span class="pre">&#64;javax.persistence.GeneratedValue</span></code> annotation.</div>
<div class="line">When using sequence object, <code class="docutils literal"><span class="pre">&#64;javax.persistence.SequenceGenerator</span></code> annotation should be specified. When using table generator, <code class="docutils literal"><span class="pre">&#64;javax.persistence.TableGenerator</span></code> annotation should be specified.</div>
<div class="line">In the above example, ID is generated using the sequence object called <code class="docutils literal"><span class="pre">s_order_id</span></code> name.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Assign <code class="docutils literal"><span class="pre">&#64;javax.persistence.Id</span></code> annotation to the property that holds the primary key.</div>
<div class="line">In case of composite key, assign <code class="docutils literal"><span class="pre">&#64;javax.persistence.EmbeddedId</span></code> annotation.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Assign the associated annotations (<code class="docutils literal"><span class="pre">&#64;OneToOne</span></code> , <code class="docutils literal"><span class="pre">&#64;OneToMany</span></code> ,  <code class="docutils literal"><span class="pre">&#64;ManyToOne</span></code> , <code class="docutils literal"><span class="pre">&#64;ManyToMany</span></code> ) to the property that has a relationship with other entities.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Annotations for generating IDs</strong></p>
<p>For details on each annotation, refer to <a class="reference external" href="http://download.oracle.com/otn-pub/jcp/persistence-2_1-fr-eval-spec/JavaPersistence.pdf">JSR 338: Java Persistence API, Version 2.1 Specification (PDF)</a>.</p>
<ul class="last simple">
<li><code class="docutils literal"><span class="pre">&#64;GeneratedValue</span></code> : 11.1.20 GeneratedValue Annotation</li>
<li><code class="docutils literal"><span class="pre">&#64;SequenceGenerator</span></code> : 11.1.48 SequenceGenerator Annotation</li>
<li><code class="docutils literal"><span class="pre">&#64;TableGenerator</span></code> : 11.1.50 TableGenerator Annotation</li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>About method of generating IDs</strong></p>
<blockquote>
<div><p>For generating ID, specify the value of <code class="docutils literal"><span class="pre">javax.persistence.GenerationType</span></code> in strategy attribute of <code class="docutils literal"><span class="pre">&#64;GeneratedValue</span></code> annotation.
Values that can be specified are as follows:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">TABLE</span></code>:  Generate ID using persistence layer (DB) table.</li>
<li><code class="docutils literal"><span class="pre">SEQUENCE</span></code>: Generate ID using sequence object of persistence layer (DB).</li>
<li><code class="docutils literal"><span class="pre">IDENTITY</span></code>: Generate ID using identity column of persistence layer (DB).</li>
<li><code class="docutils literal"><span class="pre">AUTO</span></code>: Generate ID by selecting the most appropriate method in persistence layer (DB).</li>
</ul>
</div></blockquote>
<p class="last">Generally it is recommended to explicitly specify the type to be used instead of using <code class="docutils literal"><span class="pre">AUTO</span></code>.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="adding-parent-entity-and-related-entity">
<h4><a class="toc-backref" href="#id55">6.3.2.9.2. Adding parent-entity and related-entity</a><a class="headerlink" href="#adding-parent-entity-and-related-entity" title="Permalink to this headline">¶</a></h4>
<p>In order to add parent-entity and related-entity together, call the save method of Repository interface and manage the entity objects under <code class="docutils literal"><span class="pre">EntityManager</span></code>.
Then create the related-entity objects and map them with parent-entity objects.</p>
<p>In order to use this method, <code class="docutils literal"><span class="pre">persist</span></code> needs to be included in the cascade operation of the related-entity.</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Behavior of entities in case of cascade operations</strong></p>
<p>When the related-entity is specified under cascade operations, JPA operations for parent-entity (<code class="docutils literal"><span class="pre">persist</span></code>, <code class="docutils literal"><span class="pre">merge</span></code>, <code class="docutils literal"><span class="pre">remove</span></code>, <code class="docutils literal"><span class="pre">refresh</span></code>, <code class="docutils literal"><span class="pre">detach</span></code>)
are linked with related-entity and then carried out.</p>
<p>Mapping with the operations of Repository interface of Spring Data JPA is as follows:</p>
<ul class="simple">
<li>save method : <code class="docutils literal"><span class="pre">persist</span></code> or <code class="docutils literal"><span class="pre">merge</span></code></li>
<li>delete method : <code class="docutils literal"><span class="pre">remove</span></code></li>
</ul>
<p class="last"><code class="docutils literal"><span class="pre">refresh</span></code>, <code class="docutils literal"><span class="pre">detach</span></code> are not executed in default implementation of Spring Data JPA.</p>
</div>
</div></blockquote>
<ul class="simple">
<li>Service</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">itemCode</span> <span class="o">=</span> <span class="s">&quot;ITM0000001&quot;</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">itemQuantity</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
<span class="n">String</span> <span class="n">wayToPay</span> <span class="o">=</span> <span class="s">&quot;card&quot;</span><span class="o">;</span>

<span class="n">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Order</span><span class="o">(</span><span class="s">&quot;accepted&quot;</span><span class="o">);</span>
<span class="n">order</span> <span class="o">=</span> <span class="n">orderRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">order</span><span class="o">);</span> <span class="c1">// (1)</span>

<span class="n">OrderItem</span> <span class="n">orderItem</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OrderItem</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">itemCode</span><span class="o">,</span>
        <span class="n">itemQuantity</span><span class="o">);</span>
<span class="n">order</span><span class="o">.</span><span class="na">setOrderItems</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">singleton</span><span class="o">(</span><span class="n">orderItem</span><span class="o">));</span>    <span class="c1">// (2)</span>
<span class="n">order</span><span class="o">.</span><span class="na">setOrderPay</span><span class="o">(</span><span class="k">new</span> <span class="n">OrderPay</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">wayToPay</span><span class="o">));</span> <span class="c1">// (2)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">First, call the save method of Repository interface and bring the entity object under <code class="docutils literal"><span class="pre">EntityManager</span></code>.</div>
<div class="line">In the above example, save method is being called before setting the related-entity objects. This is because it is necessary to generate the ID (orderId) of parent-entity; this ID is used as a part of ID of the related entity.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set the related-entity objects for the parent-entity object (that are to be managed under <code class="docutils literal"><span class="pre">EntityManager</span></code>).</div>
<div class="line">When committing the transaction, persist operation (INSERT) on parent-entity object is linked with the related-entity objects.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Entity</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;t_order&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="nd">@Id</span>
    <span class="nd">@SequenceGenerator</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GEN_ORDER_ID&quot;</span><span class="o">,</span> <span class="n">sequenceName</span> <span class="o">=</span> <span class="s">&quot;s_order_id&quot;</span><span class="o">,</span>
                       <span class="n">allocationSize</span> <span class="o">=</span> <span class="mi">1</span><span class="o">)</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">GenerationType</span><span class="o">.</span><span class="na">SEQUENCE</span><span class="o">,</span>
                    <span class="n">generator</span> <span class="o">=</span> <span class="s">&quot;GEN_ORDER_ID&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">&quot;order&quot;</span><span class="o">,</span> <span class="n">cascade</span> <span class="o">=</span> <span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span>  <span class="c1">// (3)</span>
               <span class="n">orphanRemoval</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="nd">@OrderBy</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">OrderItem</span><span class="o">&gt;</span> <span class="n">orderItems</span><span class="o">;</span>

    <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">&quot;order&quot;</span><span class="o">,</span> <span class="n">cascade</span> <span class="o">=</span> <span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span>
              <span class="n">orphanRemoval</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">OrderPay</span> <span class="n">orderPay</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;status_code&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">OrderStatus</span> <span class="n">status</span><span class="o">;</span>

    <span class="c1">// ...</span>

    <span class="kd">public</span> <span class="nf">Order</span><span class="o">(</span><span class="n">String</span> <span class="n">statusCode</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">status</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OrderStatus</span><span class="o">(</span><span class="n">statusCode</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the cascade operation type (<code class="docutils literal"><span class="pre">javax.persistence.CascadeType</span></code>) in cascade attribute in corresponding annotation.</div>
<div class="line">In the above example, all operations are target of cascade to the related-entity.</div>
<div class="line">If there is no specific reason, it is recommended to consider all the operations for cascade.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>Related-entity for which cascade attribute should not be specified</strong></p>
<p class="last">If the transaction entity is associated with code and master entities, cascade attribute should not be specified.
In the above example, <code class="docutils literal"><span class="pre">OrderStatus</span></code> is the code entity; hence cascade attribute should not be specified in <code class="docutils literal"><span class="pre">&#64;ManyToOne</span></code> annotation of <code class="docutils literal"><span class="pre">status</span></code> property of <code class="docutils literal"><span class="pre">Order</span></code>.</p>
</div>
</div></blockquote>
<ul class="simple">
<li>Related-entity</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;t_order_item&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderItem</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="nd">@EmbeddedId</span>
    <span class="kd">private</span> <span class="n">OrderItemPK</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">quantity</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;order_id&quot;</span><span class="o">,</span> <span class="n">insertable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">updatable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Order</span> <span class="n">order</span><span class="o">;</span>

    <span class="c1">// ...</span>

    <span class="kd">public</span> <span class="nf">OrderItem</span><span class="o">(</span><span class="n">Integer</span> <span class="n">orderId</span><span class="o">,</span> <span class="n">String</span> <span class="n">itemCode</span><span class="o">,</span> <span class="kt">int</span> <span class="n">quantity</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OrderItemPK</span><span class="o">(</span><span class="n">orderId</span><span class="o">,</span> <span class="n">itemCode</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">quantity</span> <span class="o">=</span> <span class="n">quantity</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// ...</span>

<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;t_order_pay&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderPay</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;order_id&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">orderId</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;way_to_pay&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">wayToPay</span><span class="o">;</span>

    <span class="nd">@OneToOne</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;order_id&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Order</span> <span class="n">order</span><span class="o">;</span>

    <span class="c1">// ...</span>

    <span class="kd">public</span> <span class="nf">OrderPay</span><span class="o">(</span><span class="kt">int</span> <span class="n">orderId</span><span class="o">,</span> <span class="n">String</span> <span class="n">wayToPay</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">orderId</span> <span class="o">=</span> <span class="n">orderId</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">wayToPay</span> <span class="o">=</span> <span class="n">wayToPay</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="adding-the-related-entity">
<h4><a class="toc-backref" href="#id56">6.3.2.9.3. Adding the related-entity</a><a class="headerlink" href="#adding-the-related-entity" title="Permalink to this headline">¶</a></h4>
<p>In order to add a related-entity, link the newly created related-entity object with the parent-entity object fetched through Repository interface.</p>
<p>For using this method, <code class="docutils literal"><span class="pre">persist</span></code> and <code class="docutils literal"><span class="pre">merge</span></code> should be included in the cascade operation of the related-entity.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">itemCode</span> <span class="o">=</span> <span class="s">&quot;ITM0000003&quot;</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">quantity</span> <span class="o">=</span> <span class="mi">30</span><span class="o">;</span>

<span class="n">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">orderRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">orderId</span><span class="o">);</span> <span class="c1">// (1)</span>

<span class="n">OrderItem</span> <span class="n">orderItem</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OrderItem</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">itemCode</span><span class="o">,</span> <span class="n">quantity</span><span class="o">);</span>
<span class="n">order</span><span class="o">.</span><span class="na">getOrderItems</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">orderItem</span><span class="o">);</span> <span class="c1">// (2)</span>

<span class="n">OrderPay</span> <span class="n">orderPay</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="na">getOrderPay</span><span class="o">();</span>
<span class="k">if</span> <span class="o">(</span><span class="n">orderPay</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">order</span><span class="o">.</span><span class="na">setOrderPay</span><span class="o">(</span><span class="k">new</span> <span class="n">OrderPay</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="s">&quot;cash&quot;</span><span class="o">));</span> <span class="c1">// (3)</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">orderPay</span><span class="o">.</span><span class="na">setWayToPay</span><span class="o">(</span><span class="s">&quot;cash&quot;</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch the entity object using the Repository interface.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In case of entity with 1: N relationship, add the related-entity object to the collection fetched from the parent-entity object.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In case of entity with 1:1 relationship, set the related-entity object in the parent-entity object.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="adding-the-related-entity-directly">
<h4><a class="toc-backref" href="#id57">6.3.2.9.4. Adding the related-entity directly</a><a class="headerlink" href="#adding-the-related-entity-directly" title="Permalink to this headline">¶</a></h4>
<p>When a related-entity object is to be added directly without linking it with the parent-entity object, save it using the Repository interface of related-entity.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">itemCode</span> <span class="o">=</span> <span class="s">&quot;ITM0000003&quot;</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">quantity</span> <span class="o">=</span> <span class="mi">40</span><span class="o">;</span>

<span class="n">OrderItem</span> <span class="n">orderItem</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OrderItem</span><span class="o">(</span><span class="n">orderId</span><span class="o">,</span> <span class="n">itemCode</span><span class="o">,</span> <span class="n">quantity</span><span class="o">);</span> <span class="c1">// (1)</span>

<span class="n">orderItemRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">orderItem</span><span class="o">);</span> <span class="c1">// (2)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create an object of related-entity.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call the save method of Repository interface of the related-entity.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Merits of saving the related-entity object directly</strong></p>
<p class="last">The number of objects created is less. When fetching the parent-entity object, related-entity objects which are not necessary for the processing may also get created.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Demerits of saving the related-entity directly</strong></p>
<p class="last">When ID of the parent-entity is being used as a part of the related-entity ID, the ID should be set before calling the save method.
If ID is set, merge method of <code class="docutils literal"><span class="pre">EntityManager</span></code> is called as per the default implementation of Spring Data JPA.
Therefore, the entity with same ID is always fetched from persistence layer (DB).</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>Points to be noted at the time of using parent-entity object after the related-entity is added</strong></p>
<p>When the related-entity is added using Repository save method of related-entity,
it cannot be fetched through the parent-entity object since it is not linked with the parent-entity object.</p>
<p>To avoid this problem,</p>
<ol class="arabic simple">
<li>Related-entity object should not be added directly. It should first be linked with the parent-entity object, and then added.</li>
<li>Synchronization with persistence layer (DB) should be done before fetching the parent-entity, using saveAndFlush method.</li>
</ol>
<p class="last">In such a case, if there is no specific reason, objects of the related-entity should be added by the former method.
In the latter method, the problem cannot be avoided if the parent-entity object is already the “managed” entity.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="updating-entities">
<h3><a class="toc-backref" href="#id58">6.3.2.10. Updating entities</a><a class="headerlink" href="#updating-entities" title="Permalink to this headline">¶</a></h3>
<p>The example of updating entities is explained below.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="how-to-update-entities">
<h4><a class="toc-backref" href="#id59">6.3.2.10.1. How to update entities</a><a class="headerlink" href="#how-to-update-entities" title="Permalink to this headline">¶</a></h4>
<p>In order to update the entity, set the changed value to the entity object fetched using the Repository interface method.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">orderRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">orderId</span><span class="o">);</span> <span class="c1">// (1)</span>
<span class="n">order</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="k">new</span> <span class="n">OrderStatus</span><span class="o">(</span><span class="s">&quot;checking&quot;</span><span class="o">));</span> <span class="c1">// (2)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch the entity object using Repository interface method.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Update the state of entity object by calling setter method.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Calling the save method of Repository</strong></p>
<p>The entity object fetched using Repository interface method are managed under <code class="docutils literal"><span class="pre">EntityManager</span></code>.
For the entity objects managed under <code class="docutils literal"><span class="pre">EntityManager</span></code>, just by changing the state of objects using setter method,
the changes are reflected in persistence layer (DB) at the time of committing the transaction.
Therefore, there is no need to explicitly call the save method of Repository interface.</p>
<p class="last">However, save method needs to be called when the entity objects are not managed under <code class="docutils literal"><span class="pre">EntityManager</span></code>.
For example, when entity object is created based on the request parameters sent from the screen.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="updating-the-related-entity">
<h4><a class="toc-backref" href="#id60">6.3.2.10.2. Updating the related-entity</a><a class="headerlink" href="#updating-the-related-entity" title="Permalink to this headline">¶</a></h4>
<p>In order to update the related-entity, first fetch the related-entity from the parent entity which in turn can be fetched using Repository interface and then set the values to be updated in related-entity object.</p>
<p>For using this method, <code class="docutils literal"><span class="pre">merge</span></code> should be included in the cascade operation of related-entity.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">orderRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">orderId</span><span class="o">);</span> <span class="c1">// (1)</span>

<span class="k">for</span> <span class="o">(</span><span class="n">OrderItem</span> <span class="n">orderItem</span> <span class="o">:</span> <span class="n">order</span><span class="o">.</span><span class="na">getOrderItems</span><span class="o">())</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">newQuantity</span> <span class="o">=</span> <span class="n">quantityMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">orderItem</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">getItemCode</span><span class="o">());</span>
    <span class="n">orderItem</span><span class="o">.</span><span class="na">setQuantity</span><span class="o">(</span><span class="n">newQuantity</span><span class="o">);</span> <span class="c1">// (2)</span>
<span class="o">}</span>

<span class="n">order</span><span class="o">.</span><span class="na">getOrderPay</span><span class="o">().</span><span class="na">setWayToPay</span><span class="o">(</span><span class="s">&quot;cash&quot;</span><span class="o">);</span> <span class="c1">// (3)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use the Repository interface method to fetch entity objects.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In case of entity with 1:N relationship, the state of related-entity object stored in the collection fetched from parent-entity object is to be updated by calling the setter method.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In case of entity with 1:1 relationship, the state of related-entity object fetched from parent-entity object is to be updated by calling the setter method.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="updating-the-related-entity-directly">
<h4><a class="toc-backref" href="#id61">6.3.2.10.3. Updating the related-entity directly</a><a class="headerlink" href="#updating-the-related-entity-directly" title="Permalink to this headline">¶</a></h4>
<p>In order to update the related-entity directly without using the parent-entity, fetch the related-entity directly using its corresponding Repository interface and set the value to be changed.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">quantity</span> <span class="o">=</span> <span class="mi">43</span><span class="o">;</span>

<span class="n">OrderItem</span> <span class="n">orderItem</span> <span class="o">=</span> <span class="n">orderItemRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="k">new</span> <span class="n">OrderItemPK</span><span class="o">(</span>
        <span class="n">orderId</span><span class="o">,</span> <span class="n">itemCode</span><span class="o">));</span> <span class="c1">// (1)</span>

<span class="n">orderItem</span><span class="o">.</span><span class="na">setQuantity</span><span class="o">(</span><span class="n">quantity</span><span class="o">);</span> <span class="c1">// (2)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call findOne method of Repository interface of the related-entity and fetch the related-entity object.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Update the state of related-entity object using setter method.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Behavior at the time of using parent-entity after the related-entity is updated</strong></p>
<p class="last">When the related-entity is updated using save method of Repository for related-entity,
the related-entity stored in the parent-entity object is also updated unlike the case wherein the related-entity is added.
This is because the parent-entity stores the reference of same instance which is managed under <code class="docutils literal"><span class="pre">EntityManager</span></code>.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="updating-by-using-query-method">
<h4><a class="toc-backref" href="#id62">6.3.2.10.4. Updating by using query method</a><a class="headerlink" href="#updating-by-using-query-method" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Use query method to update the entity of persistence layer (DB) directly.</div>
<div class="line">For details, refer to “<a class="reference internal" href="#data-access-jpa-howtouse-querymethod-modifying"><span class="std std-ref">Operating the entities of Persistence Layer directly</span></a>”.</div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="deleting-entities">
<h3><a class="toc-backref" href="#id63">6.3.2.11. Deleting entities</a><a class="headerlink" href="#deleting-entities" title="Permalink to this headline">¶</a></h3>
<div class="section" id="deleting-parent-entity-and-related-entity">
<h4><a class="toc-backref" href="#id64">6.3.2.11.1. Deleting parent-entity and related-entity</a><a class="headerlink" href="#deleting-parent-entity-and-related-entity" title="Permalink to this headline">¶</a></h4>
<p>In order to delete parent-entity and related-entity together, call delete method of Repository interface.</p>
<p>For using this method, <code class="docutils literal"><span class="pre">remove</span></code> should be included in the cascade operation of the related-entity
or the setting for deleting the related-entity should be enabled (orphanRemoval attribute should be set to <code class="docutils literal"><span class="pre">true</span></code>).</p>
<ul class="simple">
<li>Service</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">orderRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">orderId</span><span class="o">);</span> <span class="c1">// (1)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify ID or entity object and call delete method of Repository interface.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Entity</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;t_order&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="c1">// ...</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">&quot;order&quot;</span><span class="o">,</span>
               <span class="n">cascade</span> <span class="o">=</span> <span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span> <span class="n">orphanRemoval</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <span class="c1">// (2)</span>
    <span class="nd">@OrderBy</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">OrderItem</span><span class="o">&gt;</span> <span class="n">orderItems</span><span class="o">;</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Include <code class="docutils literal"><span class="pre">remove</span></code> in cascade operations and enable the setting to delete the related-entity (set orphanRemoval attribute of the associated annotation to <code class="docutils literal"><span class="pre">true</span></code>).</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Deleting related-entity</strong></p>
<p class="last">If you do not want to delete the related-entity object, perform settings such that <code class="docutils literal"><span class="pre">remove</span></code> is not included in cascade operation.
Also, set orphanRemoval attribute to <code class="docutils literal"><span class="pre">false</span></code>.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="deleting-the-related-entity">
<span id="daba-access-jpa-howtouse-remove-relationship"></span><h4><a class="toc-backref" href="#id65">6.3.2.11.2. Deleting the related-entity</a><a class="headerlink" href="#deleting-the-related-entity" title="Permalink to this headline">¶</a></h4>
<p>In order to delete the related-entity, delete the related-entity object from the entity objects fetched through Repository interface.</p>
<p>For using this method, setting to delete the related-entity should be enabled (orphanRemoval attribute of the associated annotation should be set to <code class="docutils literal"><span class="pre">true</span></code>).</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Behavior when the setting to delete the related-entity is enabled</strong></p>
<p>Behavior when the setting to delete the related-entity is enabled is as follows:</p>
<ul class="simple">
<li>In case of entity with 1:N relationship, if the related-entity object is deleted from the collection, it is also deleted from the persistence layer (DB) at the time of committing the transaction.</li>
<li>In case of entity with 1:1 relationship, if the related-entity is set to <code class="docutils literal"><span class="pre">null</span></code>, it is also deleted from the persistence layer (DB) at the time of committing the transaction.</li>
</ul>
<p class="last">When the value of orphanRemoval attribute is set to <code class="docutils literal"><span class="pre">false</span></code> (which is also the default value), the related-entity is cleared from the memory;
however persistence operation (UPDATE/DELETE) is not carried out for deleted related-entity object.</p>
</div>
</div></blockquote>
<ul class="simple">
<li>Service</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">orderRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">orderId</span><span class="o">);</span> <span class="c1">// (1)</span>

<span class="c1">// (2)</span>
<span class="n">Set</span><span class="o">&lt;</span><span class="n">OrderItem</span><span class="o">&gt;</span> <span class="n">orderItemsOfRemoveTarget</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashSet</span><span class="o">&lt;</span><span class="n">OrderItem</span><span class="o">&gt;();</span> <span class="c1">// (3)</span>
<span class="k">for</span> <span class="o">(</span><span class="n">OrderItem</span> <span class="n">orderItem</span> <span class="o">:</span> <span class="n">order</span><span class="o">.</span><span class="na">getOrderItems</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">itemCode</span> <span class="o">=</span> <span class="n">orderItem</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">getItemCode</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">quantityMap</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">itemCode</span><span class="o">))</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">newQuantity</span> <span class="o">=</span> <span class="n">quantityMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">itemCode</span><span class="o">);</span>
        <span class="n">orderItem</span><span class="o">.</span><span class="na">setQuantity</span><span class="o">(</span><span class="n">newQuantity</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">orderItemsOfRemoveTarget</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">orderItem</span><span class="o">);</span> <span class="c1">// (4)</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="n">order</span><span class="o">.</span><span class="na">getOrderItems</span><span class="o">().</span><span class="na">removeAll</span><span class="o">(</span><span class="n">orderItemsOfRemoveTarget</span><span class="o">);</span> <span class="c1">// (5)</span>

<span class="n">order</span><span class="o">.</span><span class="na">setOrderPay</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span> <span class="c1">// (6)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch the entity object using Repository interface.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Describe the example to delete the entity with 1:N relationship.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create a collection for storing the related-entity object to be deleted.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Add the related-entity object to be deleted to the collection of (3).</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Delete it from the collection fetched from the related-entity object to be deleted.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In case of entity with 1:1 relationship, set the property to that stores the related-entity object to be deleted to <code class="docutils literal"><span class="pre">null</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Entity</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;t_order&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="nd">@SequenceGenerator</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GEN_ORDER_ID&quot;</span><span class="o">,</span> <span class="n">sequenceName</span> <span class="o">=</span> <span class="s">&quot;s_order_id&quot;</span><span class="o">,</span> <span class="n">allocationSize</span> <span class="o">=</span> <span class="mi">1</span><span class="o">)</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">GenerationType</span><span class="o">.</span><span class="na">SEQUENCE</span><span class="o">,</span> <span class="n">generator</span> <span class="o">=</span> <span class="s">&quot;GEN_ORDER_ID&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">&quot;order&quot;</span><span class="o">,</span> <span class="n">cascade</span> <span class="o">=</span> <span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span>
               <span class="n">orphanRemoval</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <span class="c1">// (7)</span>
    <span class="nd">@OrderBy</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">OrderItem</span><span class="o">&gt;</span> <span class="n">orderItems</span><span class="o">;</span>

    <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">&quot;order&quot;</span><span class="o">,</span> <span class="n">cascade</span> <span class="o">=</span> <span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span>
              <span class="n">orphanRemoval</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <span class="c1">// (7)</span>
    <span class="kd">private</span> <span class="n">OrderPay</span> <span class="n">orderPay</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;status_code&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">OrderStatus</span> <span class="n">status</span><span class="o">;</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Enable the setting to delete the related-entity (set orphanRemoval attribute to <code class="docutils literal"><span class="pre">true</span></code>).</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Associated annotations that can be specified for orphanRemoval attribute</strong></p>
<p class="last">There are 2 associated annotations that can be specified for orphanRemoval attribute; <code class="docutils literal"><span class="pre">&#64;OneToOne</span></code>  and  <code class="docutils literal"><span class="pre">&#64;OneToMany</span></code>.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="deleting-the-related-entity-directly">
<h4><a class="toc-backref" href="#id66">6.3.2.11.3. Deleting the related-entity directly</a><a class="headerlink" href="#deleting-the-related-entity-directly" title="Permalink to this headline">¶</a></h4>
<p>In order to delete the related-entity without using the parent-entity, call the delete method of Repository interface of related-entity.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">quantity</span> <span class="o">=</span> <span class="mi">43</span><span class="o">;</span>

<span class="n">orderItemRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="k">new</span> <span class="n">OrderItemPK</span><span class="o">(</span><span class="n">orderId</span><span class="o">,</span> <span class="n">itemCode</span><span class="o">));</span> <span class="c1">// (1)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify ID or entity object and call delete method of Repository interface of the related-entity.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>Points to be noted while deleting the related-entity directly</strong></p>
<p>When delete method of Repository for the related-entity is called, it should be noted that related-entity may not get deleted from persistence layer (DB) in some cases.</p>
<p>Such cases are as follows:</p>
<ul class="simple">
<li>findOne method is called in delete method; hence when the relation with parent-entity is <code class="docutils literal"><span class="pre">&#64;OneToOne</span></code>, the parent-entity ends up getting managed under <code class="docutils literal"><span class="pre">EntityManager</span></code>.
If the parent-entity ends up getting managed under <code class="docutils literal"><span class="pre">EntityManager</span></code>, the related-entity that was to be deleted using delete method may be loaded in the parent-entity object.
Once it is loaded under the parent-entity object, it will not be deleted from persistence layer (DB).</li>
<li>If the parent-entity object is fetched after calling the delete method, the related-entity which is deleted using delete method may be loaded in the parent-entity object.
Once it is loaded under parent-entity object, it cannot be deleted from persistence layer (DB).</li>
</ul>
<p>How to avoid this problem,</p>
<ol class="arabic simple">
<li>Instead of deleting the related-entity object directly, its association with the parent-entity should be deleted.</li>
</ol>
<p class="last">It may be possible to avoid this problem by reconsidering the associated annotation; however the best way to avoid this problem is not to delete the related-entity directly.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="deleting-using-query-method">
<h4><a class="toc-backref" href="#id67">6.3.2.11.4. Deleting using query method</a><a class="headerlink" href="#deleting-using-query-method" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Use query method in order to directly delete the entity from persistence layer (DB).</div>
<div class="line">For details, refer to “<a class="reference internal" href="#data-access-jpa-howtouse-querymethod-modifying"><span class="std std-ref">Operating the entities of Persistence Layer directly</span></a>”.</div>
</div>
<blockquote>
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>Handling of related-objects</strong></p>
<p>When the entity is deleted directly from the persistence layer (DB) using query method, irrespective of whether or not the associated annotation is specified,
the related-entity object is not deleted from the persistence layer.</p>
<p class="last"><code class="docutils literal"><span class="pre">void</span> <span class="pre">deleteInBatch(Iterable&lt;T&gt;</span> <span class="pre">entities)</span></code> and <code class="docutils literal"><span class="pre">void</span> <span class="pre">deleteAllInBatch()</span></code> of Repository interface operate in the same way.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="escaping-at-the-time-of-like-search">
<span id="data-access-jpa-howtouse-like-escape"></span><h3><a class="toc-backref" href="#id68">6.3.2.12. Escaping at the time of LIKE search</a><a class="headerlink" href="#escaping-at-the-time-of-like-search" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Escaping the values to be used as search criteria should be done for LIKE search.</div>
<div class="line">Escaping for LIKE search can be done using <code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.query.QueryEscapeUtils</span></code> class method of the common library.</div>
<div class="line">For specifications of escaping in common library, refer to “<a class="reference internal" href="DataAccessCommon.html#data-access-common-appendix-like-escape"><span class="std std-ref">Escaping during LIKE search</span></a>” of “<a class="reference internal" href="DataAccessCommon.html"><span class="doc">Database Access (Common)</span></a>”.</div>
</div>
<p>For the escaping method provided by common library, see the description below.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="usage-method-when-type-of-matching-is-to-be-specified-in-query">
<h4><a class="toc-backref" href="#id69">6.3.2.12.1. Usage method when type of matching is to be specified in query</a><a class="headerlink" href="#usage-method-when-type-of-matching-is-to-be-specified-in-query" title="Permalink to this headline">¶</a></h4>
<p>When type of matching (Forward match, Backward Match, Partial Match) is to be specified as JPQL, use the method that performs only escaping.</p>
<ul class="simple">
<li>Repository</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (1) (2)</span>
<span class="nd">@Query</span><span class="o">(</span><span class="s">&quot;SELECT a FROM Article a WHERE&quot;</span>
        <span class="o">+</span> <span class="s">&quot; (a.title LIKE %:word% ESCAPE &#39;~&#39; OR a.overview LIKE %:word% ESCAPE &#39;~&#39;)&quot;</span><span class="o">)</span>
<span class="n">Page</span><span class="o">&lt;</span><span class="n">Article</span><span class="o">&gt;</span> <span class="nf">findPageBy</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;word&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">word</span><span class="o">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify wildcard characters ( “<code class="docutils literal"><span class="pre">%</span></code>” or “<code class="docutils literal"><span class="pre">_</span></code>” ) for LIKE search in JPQL to be specified in <code class="docutils literal"><span class="pre">&#64;Query</span></code> annotation.</div>
<div class="line">In the above example, the type of matching is set to partial match by specifying wildcard ( “<code class="docutils literal"><span class="pre">%</span></code>” ) before and after the argument <code class="docutils literal"><span class="pre">word</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In case of escaping provided by the common library, “<code class="docutils literal"><span class="pre">~</span></code>” is being used as escape characters; hence specify <code class="docutils literal"><span class="pre">&quot;ESCAPE</span> <span class="pre">'~'&quot;</span></code> after LIKE clause.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>About wildcard character “_”</strong></p>
<p>As described in [<a class="reference internal" href="#how-to-specify-query-annotation-label"><span class="std std-ref">Specifying the query using &#64;Query annotation</span></a>], the wildcard character “<code class="docutils literal"><span class="pre">%</span></code>” can be use directly in JPQL only if the <code class="docutils literal"><span class="pre">&#64;Query</span></code> annotation is used.
The wildcard character “<code class="docutils literal"><span class="pre">_</span></code>” cannot use directly in LIKE search of JPQL. It can be used in the following two ways.</p>
<ol class="last arabic simple">
<li>Include wildcard character “<code class="docutils literal"><span class="pre">_</span></code>” in the bind variable.</li>
<li>Concatenate the wildcard character “<code class="docutils literal"><span class="pre">_</span></code>” with bind variable using database string concatenation function such as <code class="docutils literal"><span class="pre">CONCAT</span></code> .</li>
</ol>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Service</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">Page</span><span class="o">&lt;</span><span class="n">Article</span><span class="o">&gt;</span> <span class="nf">searchArticle</span><span class="o">(</span><span class="n">ArticleSearchCriteria</span> <span class="n">criteria</span><span class="o">,</span>
        <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">String</span> <span class="n">escapedWord</span> <span class="o">=</span> <span class="n">QueryEscapeUtils</span><span class="o">.</span><span class="na">toLikeCondition</span><span class="o">(</span><span class="n">criteria</span><span class="o">.</span><span class="na">getWord</span><span class="o">());</span> <span class="c1">// (3)</span>

    <span class="n">Page</span><span class="o">&lt;</span><span class="n">Article</span><span class="o">&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">articleRepository</span><span class="o">.</span><span class="na">findPageBy</span><span class="o">(</span><span class="n">escapedWord</span><span class="o">,</span> <span class="n">pageable</span><span class="o">);</span> <span class="c1">// (4)</span>

    <span class="k">return</span> <span class="n">page</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When type of matching of LIKE search is to be specified in query, call <code class="docutils literal"><span class="pre">QueryEscapeUtils#toLikeCondition(String)</span></code> method and perform only escaping for LIKE search.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Pass the value escaped for LIKE search as the argument of query method.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="usage-method-when-specifying-type-of-matching-in-logic">
<h4><a class="toc-backref" href="#id70">6.3.2.12.2. Usage method when specifying type of matching in logic</a><a class="headerlink" href="#usage-method-when-specifying-type-of-matching-in-logic" title="Permalink to this headline">¶</a></h4>
<p>When the type of matching (Forward match, Backward match, Partial match) is to be determined in logic, use the method that assigns wildcard to the escaped values.</p>
<ul class="simple">
<li>Repository</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="nd">@Query</span><span class="o">(</span><span class="s">&quot;SELECT a FROM Article a WHERE&quot;</span>
        <span class="o">+</span> <span class="s">&quot; (a.title LIKE :word ESCAPE &#39;~&#39; OR a.overview LIKE :word ESCAPE &#39;~&#39;)&quot;</span><span class="o">)</span>
<span class="n">Page</span><span class="o">&lt;</span><span class="n">Article</span><span class="o">&gt;</span> <span class="nf">findPageBy</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;word&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">word</span><span class="o">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Do not specify wildcard for LIKE search in JPQL to be specified in <code class="docutils literal"><span class="pre">&#64;Query</span></code> annotation.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Service</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">Page</span><span class="o">&lt;</span><span class="n">Article</span><span class="o">&gt;</span> <span class="nf">searchArticle</span><span class="o">(</span><span class="n">ArticleSearchCriteria</span> <span class="n">criteria</span><span class="o">,</span>
        <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">String</span> <span class="n">word</span> <span class="o">=</span> <span class="n">QueryEscapeUtils</span>
            <span class="o">.</span><span class="na">toContainingCondition</span><span class="o">(</span><span class="n">criteria</span><span class="o">.</span><span class="na">getWord</span><span class="o">());</span> <span class="c1">// (2)</span>

    <span class="n">Page</span><span class="o">&lt;</span><span class="n">Article</span><span class="o">&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">articleRepository</span><span class="o">.</span><span class="na">findPageBy</span><span class="o">(</span><span class="n">word</span><span class="o">,</span> <span class="n">pageable</span><span class="o">);</span> <span class="c1">// (3)</span>

    <span class="k">return</span> <span class="n">page</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When the type of matching is to be specified in logic, call any of the following methods and perform escaping for LIKE search and assign wildcard for LIKE search.</div>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">QueryEscapeUtils#toStartingWithCondition(String)</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">QueryEscapeUtils#toEndingWithCondition(String)</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">QueryEscapeUtils#toContainingCondition(String)</span></code></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Pass the value escaped for LIKE search assigned with wildcard as an argument of query method.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="join-fetch">
<span id="data-access-jpa-howtouse-join-fetch"></span><h3><a class="toc-backref" href="#id71">6.3.2.13. JOIN FETCH</a><a class="headerlink" href="#join-fetch" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">JOIN FETCH is a mechanism to reduce the number of queries generated for fetching entities, by joining and fetching the related-entities in batch.</div>
</div>
<div class="line-block">
<div class="line">When fetching the entities by executing any query, make sure to perform JOIN FETCH for properties where fetch attribute of associated annotation is <code class="docutils literal"><span class="pre">EAGER</span></code>.</div>
<div class="line">If JOIN FETCH is not performed, it may impact performance since queries to fetch the related-entities will be generated separately.</div>
</div>
<div class="line-block">
<div class="line">For properties where fetch attribute of related-annotation is <code class="docutils literal"><span class="pre">LAZY</span></code>, consider the frequency of use and determine whether or not to perform JOIN FETCH.</div>
<div class="line">JOIN FETCH should be performed in case of related-entities that are always referenced. However, if the cases wherein related-entities will be referenced are only few, then it is better to fetch the entities by executing the queries at the time of initial access instead of performing JOIN FETCH.</div>
</div>
<ul class="simple">
<li>Repository</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Query</span><span class="o">(</span><span class="s">&quot;SELECT a FROM Article a&quot;</span>
        <span class="o">+</span> <span class="s">&quot; INNER JOIN FETCH a.articleClass&quot;</span>   <span class="c1">// (1)</span>
        <span class="o">+</span> <span class="s">&quot; WHERE a.publishedDate = :publishedDate&quot;</span>
        <span class="o">+</span> <span class="s">&quot; ORDER BY a.articleId DESC&quot;</span><span class="o">)</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Article</span><span class="o">&gt;</span> <span class="nf">findAllByPublishedDate</span><span class="o">(</span>
        <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;publishedDate&quot;</span><span class="o">)</span> <span class="n">Date</span> <span class="n">publishedDate</span><span class="o">);</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify in <code class="docutils literal"><span class="pre">[LEFT</span> <span class="pre">[OUTER]</span> <span class="pre">|</span> <span class="pre">INNER]</span> <span class="pre">JOIN</span> <span class="pre">FETCH</span> <span class="pre">Properties</span> <span class="pre">to</span> <span class="pre">be</span> <span class="pre">joined</span></code>.</div>
<div class="line">See the pattern below.</div>
<div class="line"><br /></div>
<div class="line">1. <code class="docutils literal"><span class="pre">LEFT</span> <span class="pre">JOIN</span> <span class="pre">FETCH</span></code></div>
<div class="line-block">
<div class="line">Entity is obtained even if the related-entity does not exist.</div>
<div class="line">SQL will be <code class="docutils literal"><span class="pre">left</span> <span class="pre">outer</span> <span class="pre">join</span> <span class="pre">RelatedTable</span> <span class="pre">r</span> <span class="pre">on</span> <span class="pre">m.fkColumn</span> <span class="pre">=</span> <span class="pre">r.fkColumn</span></code>.</div>
</div>
<div class="line">2. <code class="docutils literal"><span class="pre">LEFT</span> <span class="pre">OUTER</span> <span class="pre">JOIN</span> <span class="pre">FETCH</span></code></div>
<div class="line-block">
<div class="line">Same as 1.</div>
</div>
<div class="line">3. <code class="docutils literal"><span class="pre">INNER</span> <span class="pre">JOIN</span> <span class="pre">FETCH</span></code></div>
<div class="line-block">
<div class="line">Entity is not obtained if related-entity does not exist.</div>
<div class="line">SQL will be  <code class="docutils literal"><span class="pre">inner</span> <span class="pre">join</span> <span class="pre">RelatedTable</span> <span class="pre">r</span> <span class="pre">on</span> <span class="pre">m.fkColumn</span> <span class="pre">=</span> <span class="pre">r.fkColumn</span></code>.</div>
</div>
<div class="line">4. <code class="docutils literal"><span class="pre">JOIN</span> <span class="pre">FETCH</span></code></div>
<div class="line-block">
<div class="line">Same as 3.</div>
<div class="line"><br /></div>
</div>
<div class="line">In the above example, articleClass property of Article class is specified as the JOIN FETCH target.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">JOIN FETCH is used as one of the solutions for N+1 problem.
For N+1 problem, refer to “<a class="reference internal" href="DataAccessCommon.html#data-access-common-howtosolve-n-plus-1"><span class="std std-ref">How to resolve N+1</span></a>”.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="how-to-extend">
<h2><a class="toc-backref" href="#id72">6.3.3. How to extend</a><a class="headerlink" href="#how-to-extend" title="Permalink to this headline">¶</a></h2>
<div class="section" id="how-to-add-custom-method">
<span id="data-access-jpa-how-to-extends-custommethod"></span><h3><a class="toc-backref" href="#id73">6.3.3.1. How to add custom method</a><a class="headerlink" href="#how-to-add-custom-method" title="Permalink to this headline">¶</a></h3>
<p>Spring Data provides mechanism to add any custom methods for the Repository interface.</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="35%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">How to Add</th>
<th class="head">Use case</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><a class="reference internal" href="#custommethod-individual-label"><span class="std std-ref">Adding individual custom method to entity specific Repository interface</span></a></td>
<td><div class="first last line-block">
<div class="line">Use when it is necessary to execute a query that cannot be expressed using the mechanism of query method of Spring Data.</div>
<div class="line">Add methods using this method when executing dynamic queries.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><a class="reference internal" href="#custommethod-all-label"><span class="std std-ref">Adding the custom methods to all Repository interfaces in batch</span></a></td>
<td><div class="first last line-block">
<div class="line">Use when it is necessary to execute a generic query that can be used in all Repository interfaces.</div>
<div class="line">Add methods using this method when executing project specific generic queries.</div>
<div class="line">If it is necessary to change the behavior of default implementation ( <code class="docutils literal"><span class="pre">SimpleJpaRepository</span></code> ) of Spring Data JPA, override the methods using this mechanism.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="adding-individual-custom-method-to-entity-specific-repository-interface">
<span id="custommethod-individual-label"></span><h4><a class="toc-backref" href="#id74">6.3.3.1.1. Adding individual custom method to entity specific Repository interface</a><a class="headerlink" href="#adding-individual-custom-method-to-entity-specific-repository-interface" title="Permalink to this headline">¶</a></h4>
<p>See the description below for adding individual custom method to entity specific Repository interface.</p>
<ul class="simple">
<li>Entity specific custom Repository interface</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderRepositoryCustom</span> <span class="o">{</span>

    <span class="c1">// (2)</span>
    <span class="n">Page</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findByCriteria</span><span class="o">(</span><span class="n">OrderCriteria</span> <span class="n">criteria</span><span class="o">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create a custom interface for defining custom methods.</div>
<div class="line">There are no specific restrictions for naming the interface; however it is recommended that you set it to entity specific Repository interface name + <code class="docutils literal"><span class="pre">Custom</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define custom methods.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Entity specific custom Repository class</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (3)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderRepositoryImpl</span> <span class="kd">implements</span> <span class="n">OrderRepositoryCustom</span> <span class="o">{</span>

    <span class="nd">@PersistenceContext</span>
    <span class="n">EntityManager</span> <span class="n">entityManager</span><span class="o">;</span> <span class="c1">// (4)</span>

    <span class="c1">// (5)</span>
    <span class="kd">public</span> <span class="n">Page</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findByCriteria</span><span class="o">(</span><span class="n">OrderCriteria</span> <span class="n">criteria</span><span class="o">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ...</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">PageImpl</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;(</span><span class="n">orders</span><span class="o">,</span> <span class="n">pageable</span><span class="o">,</span> <span class="n">totalCount</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create implementation class of custom interface.</div>
<div class="line">The class name should be, entity specific Repository interface name + <code class="docutils literal"><span class="pre">Impl</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Using <code class="docutils literal"><span class="pre">&#64;javax.persistence.PersistenceContext</span></code> annotation, inject <code class="docutils literal"><span class="pre">javax.persistence.EntityManager</span></code> which is necessary for executing the query.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Implement the method defined in custom interface.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Entity specific Repository interface</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;,</span>
        <span class="n">OrderRepositoryCustom</span> <span class="o">{</span> <span class="c1">// (6)</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inherit custom interface in entity specific Repository interface.</div>
<div class="line">Methods of implementation class of custom interface are called at runtime by inheriting Repository interface.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Service(Caller)</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Page</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">search</span><span class="o">(</span><span class="n">OrderCriteria</span> <span class="n">criteria</span><span class="o">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">orderRepository</span><span class="o">.</span><span class="na">findByCriteria</span><span class="o">(</span><span class="n">criteria</span><span class="o">,</span> <span class="n">pageable</span><span class="o">);</span> <span class="c1">// (7)</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Methods of entity specific Repository interface can be called similar to other methods.</div>
<div class="line">In the above example, if <code class="docutils literal"><span class="pre">OrderRepository#findByCriteria(OrderCriteria,</span> <span class="pre">Pageable)</span></code> is called, <code class="docutils literal"><span class="pre">OrderRepositoryImpl#findByCriteria(OrderCriteria,</span> <span class="pre">Pageable)</span></code> is executed.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="adding-the-custom-methods-to-all-repository-interfaces-in-batch">
<span id="custommethod-all-label"></span><h4><a class="toc-backref" href="#id75">6.3.3.1.2. Adding the custom methods to all Repository interfaces in batch</a><a class="headerlink" href="#adding-the-custom-methods-to-all-repository-interfaces-in-batch" title="Permalink to this headline">¶</a></h4>
<p>See the description below for adding the custom methods to all Repository interfaces in batch.</p>
<p>The method added in the example given below checks the version of the fetched entity and throws an optimistic exclusion error in case of a mismatch.</p>
<ul class="simple">
<li>Common Repository interface</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="nd">@NoRepositoryBean</span> <span class="c1">// (2)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MyProjectRepository</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ID</span> <span class="kd">extends</span> <span class="n">Serializable</span><span class="o">&gt;</span> <span class="kd">extends</span>
        <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ID</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="c1">// (3)</span>
    <span class="n">T</span> <span class="nf">findOneWithValidVersion</span><span class="o">(</span><span class="n">ID</span> <span class="n">id</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">version</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create a common Repository interface for defining the methods to be added.</div>
<div class="line">In the above example, common Repository interface is being created by inheriting <code class="docutils literal"><span class="pre">JpaRepository</span></code> of Spring Data.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Annotation to prevent common Repository interface implementation class (in this example, <code class="docutils literal"><span class="pre">MyProjectRepositoryImpl</span></code>) from being automatically registered as Repository Bean.</div>
<div class="line">When common Repository interface implementation class is to be stored under the package specified in base-package attribute of &lt;jpa:repositories&gt; element, there will be an error at start-up unless this annotation is specified.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define the method to be added. In the example, method to check the version of fetched entity is being added.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Common Repository interface implementation class</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (6)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyProjectRepositoryImpl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ID</span> <span class="kd">extends</span> <span class="n">Serializable</span><span class="o">&gt;</span>
        <span class="kd">extends</span> <span class="n">SimpleJpaRepository</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ID</span><span class="o">&gt;</span>
        <span class="kd">implements</span> <span class="n">MyProjectRepository</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ID</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">JpaEntityInformation</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ID</span><span class="o">&gt;</span> <span class="n">entityInformation</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">EntityManager</span> <span class="n">entityManager</span><span class="o">;</span>

    <span class="c1">// (7)</span>
    <span class="kd">public</span> <span class="nf">MyProjectRepositoryImpl</span><span class="o">(</span>
            <span class="n">JpaEntityInformation</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ID</span><span class="o">&gt;</span> <span class="n">entityInformation</span><span class="o">,</span>
            <span class="n">EntityManager</span> <span class="n">entityManager</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">entityInformation</span><span class="o">,</span> <span class="n">entityManager</span><span class="o">);</span>

        <span class="k">this</span><span class="o">.</span><span class="na">entityInformation</span> <span class="o">=</span> <span class="n">entityInformation</span><span class="o">;</span> <span class="c1">// (8)</span>
        <span class="k">this</span><span class="o">.</span><span class="na">entityManager</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">;</span> <span class="c1">// (8)</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">domainClass</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&quot;getVersion&quot;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchMethodException</span> <span class="o">|</span> <span class="n">SecurityException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// (9)</span>
    <span class="kd">public</span> <span class="n">T</span> <span class="nf">findOneWithValidVersion</span><span class="o">(</span><span class="n">ID</span> <span class="n">id</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">version</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">versionMethod</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">UnsupportedOperationException</span><span class="o">(</span>
                    <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
                            <span class="s">&quot;Does not found version field in entity class. class is &#39;%s&#39;.&quot;</span><span class="o">,</span>
                            <span class="n">entityInformation</span><span class="o">.</span><span class="na">getJavaType</span><span class="o">().</span><span class="na">getName</span><span class="o">()));</span>
        <span class="o">}</span>

        <span class="n">T</span> <span class="n">entity</span> <span class="o">=</span> <span class="n">findOne</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">entity</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">version</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Integer</span> <span class="n">currentVersion</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">currentVersion</span> <span class="o">=</span> <span class="o">(</span><span class="n">Integer</span><span class="o">)</span> <span class="n">versionMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="o">|</span> <span class="n">IllegalArgumentException</span>
                    <span class="o">|</span> <span class="n">InvocationTargetException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">version</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">currentVersion</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">ObjectOptimisticLockingFailureException</span><span class="o">(</span>
                        <span class="n">entityInformation</span><span class="o">.</span><span class="na">getJavaType</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span> <span class="n">id</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">entity</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create an implementation class of common Repository interface (in this example, <code class="docutils literal"><span class="pre">MyProjectRepository</span></code>).</div>
<div class="line">In the above example, implementation class is being created by inheriting `` SimpleJpaRepository`` of Spring Data.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create a constructor that takes <code class="docutils literal"><span class="pre">org.springframework.data.jpa.repository.support.JpaEntityInformation</span></code> and <code class="docutils literal"><span class="pre">javax.persistence.EntityManager</span></code> as arguments.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Store <code class="docutils literal"><span class="pre">JpaEntityInformation</span></code> and <code class="docutils literal"><span class="pre">EntityManager</span></code> as fields.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Implement the method defined in common Repository interface.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Changing default implementation</strong></p>
<p class="last">If the behavior of default implementation ( <code class="docutils literal"><span class="pre">SimpleJpaRepository</span></code> ) is to be changed, the method  for which behavior is to be changed can be overridden in this class.</p>
</div>
</div></blockquote>
<ul class="simple">
<li>Factory class for creating instances of common Repository interface implementation class</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (10)</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MyProjectRepositoryFactory</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ID</span> <span class="kd">extends</span> <span class="n">Serializable</span><span class="o">&gt;</span>
        <span class="kd">extends</span> <span class="n">JpaRepositoryFactory</span> <span class="o">{</span>

    <span class="c1">// (11)</span>
    <span class="kd">public</span> <span class="nf">MyProjectRepositoryFactory</span><span class="o">(</span><span class="n">EntityManager</span> <span class="n">entityManager</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">entityManager</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// (12)</span>
    <span class="kd">protected</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ID</span><span class="o">&gt;</span> <span class="nf">getTargetRepository</span><span class="o">(</span>
            <span class="n">RepositoryMetadata</span> <span class="n">metadata</span><span class="o">,</span> <span class="n">EntityManager</span> <span class="n">entityManager</span><span class="o">)</span> <span class="o">{</span>

        <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unchecked&quot;</span><span class="o">)</span>
        <span class="n">JpaEntityInformation</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ID</span><span class="o">&gt;</span> <span class="n">entityInformation</span> <span class="o">=</span> <span class="n">getEntityInformation</span><span class="o">((</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;)</span> <span class="n">metadata</span>
                <span class="o">.</span><span class="na">getDomainType</span><span class="o">());</span>

        <span class="n">MyProjectRepositoryImpl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ID</span><span class="o">&gt;</span> <span class="n">repositoryImpl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyProjectRepositoryImpl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ID</span><span class="o">&gt;(</span>
                <span class="n">entityInformation</span><span class="o">,</span> <span class="n">entityManager</span><span class="o">);</span>
        <span class="n">repositoryImpl</span>
                <span class="o">.</span><span class="na">setLockMetadataProvider</span><span class="o">(</span><span class="n">LockModeRepositoryPostProcessor</span><span class="o">.</span><span class="na">INSTANCE</span>
                        <span class="o">.</span><span class="na">getLockMetadataProvider</span><span class="o">());</span> <span class="c1">// (13)</span>

        <span class="k">return</span> <span class="n">repositoryImpl</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// (14)</span>
    <span class="kd">protected</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">getRepositoryBaseClass</span><span class="o">(</span><span class="n">RepositoryMetadata</span> <span class="n">metadata</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">MyProjectRepository</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create a Factory class for creating instances of common Repository interface implementation class.</div>
<div class="line">In the example, <code class="docutils literal"><span class="pre">org.springframework.data.jpa.repository.support.JpaRepositoryFactory</span></code> is being inherited in order to restrict the implementation of Factory class.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a constructor that takes <code class="docutils literal"><span class="pre">EntityManager</span></code> as argument and call constructor of parent class.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Override the method creating instances of implementation class. Create and return instances of the created implementation class (in this example, <code class="docutils literal"><span class="pre">MyProjectRepositoryImpl</span></code>).</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(13)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">This code is required to specify the lock mode using <code class="docutils literal"><span class="pre">&#64;Lock</span></code> annotation for <code class="docutils literal"><span class="pre">findOne</span></code> method and <code class="docutils literal"><span class="pre">findAll</span></code> methods of <code class="docutils literal"><span class="pre">SimpleJpaRepository</span></code> class of Spring Data JPA.</div>
<div class="line">Make sure to implement this piece of logic, since it is implemented in the method of <code class="docutils literal"><span class="pre">JpaRepositoryFactory</span></code>  which is being overridden.</div>
<div class="line">This process is required when the lock mode is to be specified using <code class="docutils literal"><span class="pre">findOne</span></code> and <code class="docutils literal"><span class="pre">findAll</span></code> methods amongst the methods to be extended.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(14)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Override the method that returns base interface of entity specific Repository interface, and return the created interface (in this example, <code class="docutils literal"><span class="pre">MyProjectRepository</span></code>) type.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>FactoryBean for creating Factory class instances</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (15)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyProjectRepositoryFactoryBean</span><span class="o">&lt;</span><span class="n">R</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ID</span><span class="o">&gt;,</span> <span class="n">T</span><span class="o">,</span> <span class="n">ID</span> <span class="kd">extends</span> <span class="n">Serializable</span><span class="o">&gt;</span>
        <span class="kd">extends</span> <span class="n">JpaRepositoryFactoryBean</span><span class="o">&lt;</span><span class="n">R</span><span class="o">,</span> <span class="n">T</span><span class="o">,</span> <span class="n">ID</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="c1">// (16)</span>
    <span class="kd">protected</span> <span class="n">RepositoryFactorySupport</span> <span class="nf">createRepositoryFactory</span><span class="o">(</span>
            <span class="n">EntityManager</span> <span class="n">entityManager</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">MyProjectRepositoryFactory</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ID</span><span class="o">&gt;(</span><span class="n">entityManager</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(15)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create FactoryBean class for creating Factory class instances.</div>
<div class="line">In the example, <code class="docutils literal"><span class="pre">org.springframework.data.jpa.repository.support.JpaRepositoryFactory</span></code> is being inherited in order to restrict the implementation of FactoryBean class.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(16)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Override the method used for creating the Factory class instances. Then, create and return instances of the created Factory class.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Entity specific Repository interface</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderRepository</span> <span class="kd">extends</span> <span class="n">MyProjectRepository</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="o">{</span> <span class="c1">// (17)</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(17)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inherit all entity specific Repository interfaces from the common interface (In this example: <code class="docutils literal"><span class="pre">MyProjectRepository</span></code>).</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">xxx-infra.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;jpa:repositories</span> <span class="na">base-package=</span><span class="s">&quot;x.y.z.domain.repository&quot;</span>
    <span class="na">factory-class=</span><span class="s">&quot;x.y.z.domain.repository.MyProjectRepositoryFactoryBean&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (18) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(18)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify class name of the created FactoryBean class (in the example, <code class="docutils literal"><span class="pre">MyProjectRepositoryFactoryBean</span></code>) in factory-class attribute of &lt;jpa:repositories&gt; element.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Service(Caller)</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Order</span> <span class="nf">updateOrder</span><span class="o">(</span><span class="n">Order</span> <span class="n">chngedOrder</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">version</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">orderRepository</span><span class="o">.</span><span class="na">findOneWithValidVersion</span><span class="o">(</span><span class="n">chngedOrder</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">version</span><span class="o">);</span> <span class="c1">// (19)</span>

    <span class="c1">// ....</span>

    <span class="k">return</span> <span class="n">order</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(19)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">The methods of entity specific Repository interface can be called similar to other methods.</div>
<div class="line">In the above example, when <code class="docutils literal"><span class="pre">OrderRepository#findOneWithValidVersion(Integer,</span> <span class="pre">Integer)</span></code> is called, <code class="docutils literal"><span class="pre">MyProjectRepositoryImpl#findOneWithValidVersion(Integer,</span> <span class="pre">Integer)</span></code> is executed.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="storing-query-fetch-results-in-objects-other-than-entity">
<h3><a class="toc-backref" href="#id76">6.3.3.2. Storing query fetch results in objects other than entity</a><a class="headerlink" href="#storing-query-fetch-results-in-objects-other-than-entity" title="Permalink to this headline">¶</a></h3>
<p>Query fetch results can be mapped to other objects than entities.
Use this method when records stored in persistence layer (DB) are to be handled as objects (JavaBean) other than entity.</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Assumed cases</strong></p>
<ol class="last arabic simple">
<li>When the aggregated information is to be fetched using Aggregate function in query, it is not possible to map the aggregation result to entity; hence it should be mapped with different objects.</li>
<li>In order to refer to only a part of information in a huge entity, or of a related-entity with complex nesting, there may be cases wherein it is desirable to map the results with JavaBean containing only the necessary properties.
This is because processing performance may get hampered due to the fact that mapping is carried out for items which are not needed in application processing or fetching of unnecessary information during the processing leading to memory exhaustion.
It may be obtained as entity if there is no significant impact on processing performance.</li>
</ol>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>See the example below.</p>
<ul class="simple">
<li>JavaBean</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderSummary</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">totalPrice</span><span class="o">;</span>

    <span class="c1">// ...</span>

    <span class="kd">public</span> <span class="nf">OrderSummary</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">,</span> <span class="n">Long</span> <span class="n">totalPrice</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (2)</span>
        <span class="kd">super</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">totalPrice</span> <span class="o">=</span> <span class="n">totalPrice</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create JavaBean for storing query results.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create a constructor for generating objects using query execution results.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Repository interface</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (3)</span>
<span class="nd">@Query</span><span class="o">(</span><span class="s">&quot;SELECT NEW x.y.z.domain.model.OrderSummary(o.id, SUM(i.price*oi.quantity))&quot;</span>
        <span class="o">+</span> <span class="s">&quot; FROM Order o LEFT JOIN o.orderItems oi LEFT JOIN oi.item i&quot;</span>
        <span class="o">+</span> <span class="s">&quot; GROUP BY o.id ORDER BY o.id DESC&quot;</span><span class="o">)</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">OrderSummary</span><span class="o">&gt;</span> <span class="nf">findOrderSummaries</span><span class="o">();</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the constructor created in (2).</div>
<div class="line">Specify the constructor by FQCN after “NEW” keyword.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="setting-audit-properties">
<h3><a class="toc-backref" href="#id77">6.3.3.3. Setting Audit properties</a><a class="headerlink" href="#setting-audit-properties" title="Permalink to this headline">¶</a></h3>
<p>This section introduces a mechanism to set values to Audit properties (Created By, Created Date-Time, Last Modified By, Last Modified Date-Time) of persistence layer and method to apply the same.</p>
<p>Spring Data JPA provides a mechanism to set values to Audit properties for newly created entities as well as modified entities.
This mechanism facilitates separation of logic of setting values to Audit properties from application code such as Service etc.</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Reasons to separate the logic to set values to Audit properties from application code</strong></p>
<ol class="last arabic simple">
<li>Setting the values to Audit properties is generally not an application requirement, but is essential as per the audit requirements of data.
This logic does not essentially belong to application code such as Service etc.;
hence it is better to separate it from application code.</li>
<li>As per JPA specifications, only when the values of the entities fetched from persistence layer change, the changes will be reflected in the persistence layer (by executing the SQL),
thereby avoiding the unnecessary access to persistence layer.
If the values are set unconditionally in Audit properties in the application code such as Service,
even if only Audit properties change, the changes are reflected in persistence layer making the effective JPA functionality ineffective.
This problem can be avoided if the values are set in Audit properties only when if they are changed;
however it cannot be recommended as it makes the application code complex.</li>
</ol>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>When Audit column of the persistence layer needs to be updated irrespective of the change in values</strong></p>
<p>If updating the Audit columns (Last Modified By, Last Modified Date-Time) even if there is no change in values is a part of application specifications,
then it becomes necessary to set Audit properties in application code such as Service etc.</p>
<p class="last">However, in such a case, the data modeling or application specifications are likely to be incorrect; hence it is better to revise these specifications.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>See the example below.</p>
<ul class="simple">
<li>Entity class</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">XxxEntity</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="c1">// ...</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;created_by&quot;</span><span class="o">)</span>
    <span class="nd">@CreatedBy</span> <span class="c1">// (1)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">createdBy</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;created_date&quot;</span><span class="o">)</span>
    <span class="nd">@CreatedDate</span> <span class="c1">// (2)</span>
    <span class="nd">@Type</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;org.jadira.usertype.dateandtime.joda.PersistentDateTime&quot;</span><span class="o">)</span> <span class="c1">// (3)</span>
    <span class="kd">private</span> <span class="n">DateTime</span> <span class="n">createdDate</span><span class="o">;</span> <span class="c1">// (4)</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;last_modified_by&quot;</span><span class="o">)</span>
    <span class="nd">@LastModifiedBy</span> <span class="c1">// (5)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">lastModifiedBy</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;last_modified_date&quot;</span><span class="o">)</span>
    <span class="nd">@LastModifiedDate</span> <span class="c1">// (6)</span>
    <span class="nd">@Type</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;org.jadira.usertype.dateandtime.joda.PersistentDateTime&quot;</span><span class="o">)</span> <span class="c1">// (3)</span>
    <span class="kd">private</span> <span class="n">DateTime</span> <span class="n">lastModifiedDate</span><span class="o">;</span> <span class="c1">// (4)</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Assign <code class="docutils literal"><span class="pre">&#64;org.springframework.data.annotation.CreatedBy</span></code> annotation to the field that stores “Created by”.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Assign <code class="docutils literal"><span class="pre">&#64;org.springframework.data.annotation.CreatedDate</span></code> annotation to the field that stores “Created date-time”.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When <code class="docutils literal"><span class="pre">org.joda.time.DateTime</span></code> type is to be used, assign <code class="docutils literal"><span class="pre">&#64;org.hibernate.annotations.Type</span></code> annotation to the field in order to handle in Hibernate.</div>
<div class="line">type attribute is fixed to <code class="docutils literal"><span class="pre">org.jadira.usertype.dateandtime.joda.PersistentDateTime</span></code>. This is applicable for “Last modified date-time” field also.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Field type that stores the “Created date-time” supports <code class="docutils literal"><span class="pre">org.joda.time.DateTime</span></code>, <code class="docutils literal"><span class="pre">java.util.Date</span></code>, <code class="docutils literal"><span class="pre">java.util.Calendar</span></code>, <code class="docutils literal"><span class="pre">java.lang.Long</span></code>, <code class="docutils literal"><span class="pre">long</span></code> types as well Date and Time APIs introduced in Java 8.</div>
<div class="line">This is applicable for “Last modified date” field also.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Assign <code class="docutils literal"><span class="pre">&#64;org.springframework.data.annotation.LastModifiedBy</span></code> annotation to the field type that stores “Last modified by”.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Assign <code class="docutils literal"><span class="pre">&#64;org.springframework.data.annotation.LastModifiedDate</span></code> annotation to the field that stores the “Last modified date-time”.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><code class="docutils literal"><span class="pre">&#64;Type</span></code> annotation is a Hibernate specific annotation and not a standard JPA annotation.</p>
</div>
</div></blockquote>
<ul class="simple">
<li>AuditorAware interface implementation class</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (7)</span>
<span class="nd">@Component</span> <span class="c1">// (8)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringSecurityAuditorAware</span> <span class="kd">implements</span> <span class="n">AuditorAware</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="c1">// (9)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getCurrentAuditor</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">()</span>
                <span class="o">.</span><span class="na">getAuthentication</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">authentication</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">authentication</span><span class="o">.</span><span class="na">isAuthenticated</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="o">((</span><span class="n">UserDetails</span><span class="o">)</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">()).</span><span class="na">getUsername</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create <code class="docutils literal"><span class="pre">org.springframework.data.domain.AuditorAware</span></code> interface implementation class.</div>
<div class="line"><code class="docutils literal"><span class="pre">AuditorAware</span></code> interface is used for resolving the entity operator (Created by or Last Modified by).</div>
<div class="line">This class should be created for each project.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">By assigning <code class="docutils literal"><span class="pre">&#64;Component</span></code> annotation, this class comes under the target of component-scan.</div>
<div class="line">Without assigning <code class="docutils literal"><span class="pre">&#64;Component</span></code> annotation, it is also ok to define a bean of this class in bean definition file.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Return the object to be set in the properties of entity operator (Created by or Last Modified by).</div>
<div class="line">In the above example, login user name (string) authenticated by SpringSecurity is returned as entity operator.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Object/relational mapping file( <code class="docutils literal"><span class="pre">orm.xml</span></code> )</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>

<span class="nt">&lt;entity-mappings</span> <span class="na">xmlns=</span><span class="s">&quot;http://java.sun.com/xml/ns/persistence/orm&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://java.sun.com/xml/ns/persistence/orm</span>
<span class="s">    http://java.sun.com/xml/ns/persistence/orm_2_0.xsd&quot;</span>
    <span class="na">version=</span><span class="s">&quot;2.0&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;persistence-unit-metadata&gt;</span>
        <span class="nt">&lt;persistence-unit-defaults&gt;</span>
            <span class="nt">&lt;entity-listeners&gt;</span>
                <span class="nt">&lt;entity-listener</span>
                    <span class="na">class=</span><span class="s">&quot;org.springframework.data.jpa.domain.support.AuditingEntityListener&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (10) --&gt;</span>
            <span class="nt">&lt;/entity-listeners&gt;</span>
        <span class="nt">&lt;/persistence-unit-defaults&gt;</span>
    <span class="nt">&lt;/persistence-unit-metadata&gt;</span>

<span class="nt">&lt;/entity-mappings&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify <code class="docutils literal"><span class="pre">org.springframework.data.jpa.domain.support.AuditingEntityListener</span></code> class as Entity Listener.</div>
<div class="line">Values are set in Audit properties of the methods implemented in this class.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">infra.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;jpa:auditing</span> <span class="na">auditor-aware-ref=</span><span class="s">&quot;springSecurityAuditorAware&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (11) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify bean of class for resolving entity operator created in (7) in auditor-aware-ref attribute of &lt;jpa:auditing&gt; element.</div>
<div class="line">In the above example, component-scan is performed for <code class="docutils literal"><span class="pre">SpringSecurityAuditorAware</span></code> implementation class; hence bean name <code class="docutils literal"><span class="pre">springSecurityAuditorAware</span></code> is specified.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>As default implementation, the values of <code class="docutils literal"><span class="pre">java.util.Calendar</span></code> instance returned by <code class="docutils literal"><span class="pre">getNow()</span></code> method of
<code class="docutils literal"><span class="pre">org.springframework.data.auditing.CurrentDateTimeProvider</span></code> are used for the values set in the fields with
<code class="docutils literal"><span class="pre">&#64;CreatedDate</span></code>  and <code class="docutils literal"><span class="pre">&#64;LastModifiedDate</span></code> annotations.</p>
<p>Extended example of changing the method to create the values to be used is shown below.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="nd">@Component</span> <span class="c1">// (2)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuditDateTimeProvider</span> <span class="kd">implements</span> <span class="n">DateTimeProvider</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">JodaTimeDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="c1">// (3)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Calendar</span> <span class="nf">getNow</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">DateTime</span> <span class="n">currentDateTime</span> <span class="o">=</span> <span class="n">dateFactory</span><span class="o">.</span><span class="na">newDateTime</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">currentDateTime</span><span class="o">.</span><span class="na">toGregorianCalendar</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create <code class="docutils literal"><span class="pre">org.springframework.data.auditing.DateTimeProvider</span></code> interface implementation class.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Assign <code class="docutils literal"><span class="pre">&#64;Component</span></code> annotation to  perform component-scan.</div>
<div class="line">Bean can be defined in Bean definition file without assigning <code class="docutils literal"><span class="pre">&#64;Component</span></code> annotation.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Return the instances to be set in the properties of entity operation date-time (Created Date-Time or Last Modified Date-Time).</div>
<div class="line">In the above example, the instances fetched from <code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.date.jodatime.JodaTimeDateFactory</span></code> of common library are returned as Operation Date-Time.</div>
<div class="line">For details on <code class="docutils literal"><span class="pre">JodaTimeDateFactory</span></code>, refer to “<a class="reference internal" href="../GeneralFuncDetail/SystemDate.html"><span class="doc">System Date</span></a>”.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">infra.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;jpa:auditing</span>
    <span class="na">auditor-aware-ref=</span><span class="s">&quot;springSecurityAuditorAware&quot;</span>
    <span class="na">date-time-provider-ref=</span><span class="s">&quot;auditDateTimeProvider&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In date-time-provider-ref attribute of &lt;jpa:auditing&gt; element, specify the bean of class to return the value set in entity operation date-time created in (1).</div>
<div class="line">In the above example, component-scan is performed for <code class="docutils literal"><span class="pre">AuditDateTimeProvider</span></code> implementation class; hence bean name <code class="docutils literal"><span class="pre">auditDateTimeProvider</span></code> is specified.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="adding-common-conditions-to-jpql-to-fetch-entities-from-persistence-layer">
<h3><a class="toc-backref" href="#id78">6.3.3.4. Adding common conditions to JPQL to fetch entities from persistence layer</a><a class="headerlink" href="#adding-common-conditions-to-jpql-to-fetch-entities-from-persistence-layer" title="Permalink to this headline">¶</a></h3>
<p>This section introduces a mechanism to add common conditions to JPQL for fetching the entities from persistence layer (DB).
This is an extended Hibernate function and not included in standard JPA specifications.</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Assumed cases</strong></p>
<p class="last">As per data monitoring and data storage period requirements, when an entity is to be deleted, the application should be designed such that it will delete the record logically (UPDATE of Logical Delete flag) and will not delete (DELETE) the record physically.
In case of such applications, the records deleted logically need to be uniformly excluded from the search target; hence rather than writing the condition to exclude logically deleted records in each and every query, it is better to specify it as a common condition.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>Applicable scope</strong></p>
<p class="last">It should be noted that the specified conditions will be added for all queries executed to operate the entities for which this mechanism is used. This mechanism cannot be used even if there is a single Query for which conditions are not to be added.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="adding-common-conditions-in-jpql-to-fetch-entities">
<h4><a class="toc-backref" href="#id79">6.3.3.4.1. Adding common conditions in JPQL to fetch entities</a><a class="headerlink" href="#adding-common-conditions-in-jpql-to-fetch-entities" title="Permalink to this headline">¶</a></h4>
<p>The method to add common conditions for JPQL which is executed at the time of calling Repository interface methods is as follows:</p>
<ul class="simple">
<li>Entity</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;t_order&quot;</span><span class="o">)</span>
<span class="nd">@Where</span><span class="o">(</span><span class="n">clause</span> <span class="o">=</span> <span class="s">&quot;is_logical_delete = false&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="c1">// ...</span>
    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>SQL executed at the time of calling the findOne method of Repository interface</li>
</ul>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
        <span class="c1">-- ....</span>
    <span class="k">FROM</span>
        <span class="n">t_order</span> <span class="n">order0_</span>
   <span class="k">WHERE</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">AND</span> <span class="p">(</span>
            <span class="n">order0_</span><span class="p">.</span><span class="n">is_logical_delete</span> <span class="o">=</span> <span class="k">false</span> <span class="c1">-- (2)</span>
        <span class="p">);</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Assign <code class="docutils literal"><span class="pre">&#64;org.hibernate.annotations.Where</span></code> annotation as entity class annotation and specify the common conditions in clause attribute.</div>
<div class="line">The WHERE clause should be specified in SQL instead of JPQL i.e. it is necessary to specify the column name instead of the property name of Java object.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">The condition specified with <code class="docutils literal"><span class="pre">&#64;Where</span></code> annotation is added.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>About Dialect extension</strong></p>
<p class="last">If SQL specific keywords are specified in <code class="docutils literal"><span class="pre">&#64;Where</span></code> annotation, Hibernate may recognize SQL specific keywords as a common string value and as a result expected SQL may not get generated.
It is necessary to extend the <code class="docutils literal"><span class="pre">Dialect</span></code> in case of SQL specific keywords are used in <code class="docutils literal"><span class="pre">&#64;Where</span></code> annotation.</p>
</div>
</div></blockquote>
<ul class="simple">
<li>Extending <code class="docutils literal"><span class="pre">Dialect</span></code> to register standard keywords such as <code class="docutils literal"><span class="pre">true</span></code>, <code class="docutils literal"><span class="pre">false</span></code> and <code class="docutils literal"><span class="pre">unknown</span></code>.</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.infra.hibernate</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExtendedPostgreSQL9Dialect</span> <span class="kd">extends</span> <span class="n">PostgreSQL9Dialect</span> <span class="o">{</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="nf">ExtendedPostgreSQL9Dialect</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">();</span>
        <span class="c1">// (2)</span>
        <span class="n">registerKeyword</span><span class="o">(</span><span class="s">&quot;true&quot;</span><span class="o">);</span>
        <span class="n">registerKeyword</span><span class="o">(</span><span class="s">&quot;false&quot;</span><span class="o">);</span>
        <span class="n">registerKeyword</span><span class="o">(</span><span class="s">&quot;unknown&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">By default Hiberanate-4.3 may not correctly process some of the SQL keywords. The BOOLEAN type keywords such as <code class="docutils literal"><span class="pre">true</span></code>, <code class="docutils literal"><span class="pre">false</span></code> and <code class="docutils literal"><span class="pre">unknown</span></code> are not registered in PostgreSQL dialect <code class="docutils literal"><span class="pre">org.hibernate.dialect.PostgreSQL9Dialect</span></code>. Therefore such keywords are recognized as a common string value and as a result incorrect SQL may get generated.</div>
<div class="line">It is necessary to extend <code class="docutils literal"><span class="pre">org.hibernate.dialect.Dialect</span></code> dialect in order to register such keywords.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Register the SQL keywords that are likely to be used in <code class="docutils literal"><span class="pre">&#64;Where</span></code> annotation.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Settings of extended Dialect</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;jpaVendorAdapter&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;databasePlatform&quot;</span> <span class="na">value=</span><span class="s">&quot;com.example.infra.hibernate.ExtendedPostgreSQL9Dialect&quot;</span><span class="nt">/&gt;</span> // (3)
    // ...
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">The extended <code class="docutils literal"><span class="pre">Dialect</span></code> is set as the value of <code class="docutils literal"><span class="pre">databasePlatform</span></code> property in <code class="docutils literal"><span class="pre">JpaVendorAdapter</span></code> of <code class="docutils literal"><span class="pre">EntityManager</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Class that can be specified</strong></p>
<p class="last"><code class="docutils literal"><span class="pre">&#64;Where</span></code> annotation is valid only in the class with <code class="docutils literal"><span class="pre">&#64;Entity</span></code>.
i.e. it is not assigned to SQL even if it is assigned to the base entity class with <code class="docutils literal"><span class="pre">&#64;javax.persistence.MappedSuperclass</span></code>.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><code class="docutils literal"><span class="pre">&#64;Where</span></code> annotation is a Hibernate specific annotation and not the standard JPA annotation.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="adding-common-conditions-to-jpql-to-fetch-the-related-entities">
<h4><a class="toc-backref" href="#id80">6.3.3.4.2. Adding common conditions to JPQL to fetch the related-entities</a><a class="headerlink" href="#adding-common-conditions-to-jpql-to-fetch-the-related-entities" title="Permalink to this headline">¶</a></h4>
<p>The method for adding common conditions for JPQL is shown below. JPQL is used for fetching the related-entities of the parent-entity which is fetched by calling Repository interface methods.</p>
<ul class="simple">
<li>Entity</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;t_order&quot;</span><span class="o">)</span>
<span class="nd">@Where</span><span class="o">(</span><span class="n">clause</span> <span class="o">=</span> <span class="s">&quot;is_logical_delete = false&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="c1">// ...</span>
    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">&quot;order&quot;</span><span class="o">,</span> <span class="n">cascade</span> <span class="o">=</span> <span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span> <span class="n">orphanRemoval</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="nd">@OrderBy</span>
    <span class="nd">@Where</span><span class="o">(</span><span class="n">clause</span><span class="o">=</span><span class="s">&quot;is_logical_delete = false&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">OrderItem</span><span class="o">&gt;</span> <span class="n">orderItems</span><span class="o">;</span>
    <span class="c1">// ...</span>

<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>SQL (Lazy Load) generated when accessing the related-entity</li>
</ul>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
        <span class="c1">-- ...</span>
    <span class="k">FROM</span>
        <span class="n">t_order_item</span> <span class="n">orderitems0_</span>
    <span class="k">WHERE</span>
        <span class="p">(</span><span class="n">orderitems0</span><span class="p">.</span><span class="n">is_logical_delete</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span> <span class="c1">-- (2)</span>
        <span class="k">AND</span> <span class="n">orderitems0_</span><span class="p">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="n">orderitems0_</span><span class="p">.</span><span class="n">item_code</span> <span class="k">ASC</span>
        <span class="p">,</span><span class="n">orderitems0_</span><span class="p">.</span><span class="n">order_id</span> <span class="k">ASC</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>SQL(Eager Load/Join Fetch) generated at the time of fetching parent-entity and its related-entity simultaneously</li>
</ul>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
    <span class="c1">-- ...</span>
    <span class="k">FROM</span>
        <span class="n">t_order</span> <span class="n">order0_</span>
            <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">t_order_item</span> <span class="n">orderitems1_</span>
                <span class="k">ON</span> <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">orderitems1_</span><span class="p">.</span><span class="n">order_id</span>
                <span class="k">AND</span> <span class="p">(</span><span class="n">orderitems1_</span><span class="p">.</span><span class="n">is_logical_delete</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span> <span class="c1">-- (2)</span>
    <span class="k">WHERE</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">AND</span> <span class="p">(</span>
            <span class="n">order0_</span><span class="p">.</span><span class="n">is_logical_delete</span> <span class="o">=</span> <span class="k">false</span>
        <span class="p">)</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="n">orderitems1_</span><span class="p">.</span><span class="n">item_code</span> <span class="k">ASC</span>
        <span class="p">,</span><span class="n">orderitems1_</span><span class="p">.</span><span class="n">order_id</span> <span class="k">ASC</span><span class="p">;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Assign <code class="docutils literal"><span class="pre">&#64;org.hibernate.annotations.Where</span></code> annotation as a related-entity field allocation and specify common conditions in clause attribute.</div>
<div class="line">The WHERE clause should be specified in SQL format instead of JPQL i.e. it is necessary to specify the column name instead of the property name of Java object.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">The condition specified with <code class="docutils literal"><span class="pre">&#64;Where</span></code> annotation is added.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Types of related-entities that can be specified</strong></p>
<p class="last">Adding common conditions to SQL generated at the time fetching the related-entities is possible only for the entities having <code class="docutils literal"><span class="pre">&#64;OneToMany</span></code> and <code class="docutils literal"><span class="pre">&#64;ManyToMany</span></code> relationship.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><code class="docutils literal"><span class="pre">&#64;Where</span></code> annotation is a Hibernate specific annotation and not the standard JPA annotation.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="how-to-use-multiple-persistenceunits">
<h3><a class="toc-backref" href="#id81">6.3.3.5. How to use multiple PersistenceUnits</a><a class="headerlink" href="#how-to-use-multiple-persistenceunits" title="Permalink to this headline">¶</a></h3>
<div class="admonition-todo admonition" id="index-4">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<blockquote class="last">
<div><p>Following topic will be added later.</p>
<ul class="simple">
<li>Examples for using multiple PersistenceUnits</li>
</ul>
</div></blockquote>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="how-to-use-native-query">
<h3><a class="toc-backref" href="#id82">6.3.3.6. How to use Native query</a><a class="headerlink" href="#how-to-use-native-query" title="Permalink to this headline">¶</a></h3>
<div class="admonition-todo admonition" id="index-5">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<blockquote class="last">
<div><p>Following topic will be added later.</p>
<ul class="simple">
<li>Examples of query that uses Native query</li>
</ul>
</div></blockquote>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ExclusionControl.html" title="6.4. Exclusive Control"
             >next</a> |</li>
        <li class="right" >
          <a href="DataAccessMyBatis3.html" title="6.2. Database Access (MyBatis3)"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.4.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >6. Data Access</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer">
      © Copyright 2013-2018, NTT DATA Corporation. © Copyright 2013-2018, NTT Corporation.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3.Theme is <a href="http://github.com/vimalkvn/solar-theme">Solar</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>

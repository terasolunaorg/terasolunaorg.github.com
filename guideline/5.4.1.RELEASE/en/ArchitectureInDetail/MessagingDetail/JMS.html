<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>8.2. JMS(Java Message Service) &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.4.1.RELEASE documentation</title>
    <link rel="stylesheet" href="../../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '5.4.1.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="9. Security countermeasures" href="../../Security/index.html" />
    <link rel="prev" title="8.1. Sending E-mail (SMTP)" href="Email.html" /><script src="../../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../../_static/solarized-dark.css" rel="stylesheet">
<link href="../../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../Security/index.html" title="9. Security countermeasures"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Email.html" title="8.1. Sending E-mail (SMTP)"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.4.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">8. Messaging</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><br/><img src="../../_static/logo_color.png" alt="TERASOLUNA" ><br/><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">8.2. JMS(Java Message Service)</a><ul>
<li><a class="reference internal" href="#overview">8.2.1. Overview</a><ul>
<li><a class="reference internal" href="#what-is-jms">8.2.1.1. What is JMS</a></li>
<li><a class="reference internal" href="#using-jms">8.2.1.2. Using JMS</a></li>
<li><a class="reference internal" href="#using-jms-which-use-component-of-spring-framework">8.2.1.3. Using JMS which use component of Spring Framework</a><ul>
<li><a class="reference internal" href="#when-messages-are-sent-synchronously">8.2.1.3.1. When messages are sent synchronously</a></li>
<li><a class="reference internal" href="#when-messages-are-received-asynchronously">8.2.1.3.2. When messages are received asynchronously</a></li>
<li><a class="reference internal" href="#when-the-messages-are-received-synchronously">8.2.1.3.3. When the messages are received synchronously</a></li>
</ul>
</li>
<li><a class="reference internal" href="#regarding-project-configuration">8.2.1.4. Regarding project configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">8.2.2. How to use</a><ul>
<li><a class="reference internal" href="#settings-that-are-common-for-both-sending-and-receiving-messages">8.2.2.1. Settings that are common for both sending and receiving messages</a><ul>
<li><a class="reference internal" href="#configuration-of-dependent-library">8.2.2.1.1. Configuration of dependent library</a></li>
<li><a class="reference internal" href="#configuration-of-connectionfactory">8.2.2.1.2. Configuration of <code class="docutils literal"><span class="pre">ConnectionFactory</span></code></a></li>
<li><a class="reference internal" href="#configuration-of-destinationresolver">8.2.2.1.3. Configuration of <code class="docutils literal"><span class="pre">DestinationResolver</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#a-method-to-synchronously-send-messages">8.2.2.2. A method to synchronously send messages</a><ul>
<li><a class="reference internal" href="#basic-synchronous-transmission">8.2.2.2.1. Basic synchronous transmission</a></li>
<li><a class="reference internal" href="#when-message-header-is-to-be-edited-and-sent-synchronously">8.2.2.2.2. When message header is to be edited and sent synchronously</a></li>
<li><a class="reference internal" href="#transaction-control">8.2.2.2.3. Transaction control</a></li>
</ul>
</li>
<li><a class="reference internal" href="#a-method-to-receive-messages-asynchronously">8.2.2.3. A method to receive messages asynchronously</a><ul>
<li><a class="reference internal" href="#basic-asynchronous-reception">8.2.2.3.1. Basic asynchronous reception</a></li>
<li><a class="reference internal" href="#fetching-header-information-of-messages">8.2.2.3.2. Fetching header information of messages</a></li>
<li><a class="reference internal" href="#process-results-after-asynchronous-reception-are-sent-as-messages">8.2.2.3.3. Process results after asynchronous reception are sent as messages</a></li>
<li><a class="reference internal" href="#when-messages-which-are-asynchronously-received-are-to-be-restricted">8.2.2.3.4. When messages which are asynchronously received are to be restricted</a></li>
<li><a class="reference internal" href="#input-check-for-the-messages-which-are-received-asynchronously">8.2.2.3.5. Input check for the messages which are received asynchronously</a></li>
<li><a class="reference internal" href="#jmshowtousetransactionmanagementforasyncreceive">8.2.2.3.6. Transaction control</a></li>
<li><a class="reference internal" href="#exception-handling-at-the-time-of-asynchronous-reception">8.2.2.3.7. Exception handling at the time of asynchronous reception</a></li>
</ul>
</li>
<li><a class="reference internal" href="#a-method-wherein-the-messages-are-synchronously-received">8.2.2.4. A method wherein the messages are synchronously received</a></li>
</ul>
</li>
<li><a class="reference internal" href="#appendix">8.2.3. Appendix</a><ul>
<li><a class="reference internal" href="#jms-provider-dependent-configuration">8.2.3.1. JMS provider dependent configuration</a><ul>
<li><a class="reference internal" href="#while-using-apache-activemq">8.2.3.1.1. While using Apache ActiveMQ</a></li>
</ul>
</li>
<li><a class="reference internal" href="#mass-mailing-of-identical-messages">8.2.3.2. Mass-mailing of identical messages</a></li>
<li><a class="reference internal" href="#sending-and-receiving-large-size-data">8.2.3.3. Sending and receiving large size data</a><ul>
<li><a class="reference internal" href="#id4">8.2.3.3.1. While using Apache ActiveMQ</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="Email.html"
                        title="previous chapter">8.1. Sending E-mail (SMTP)</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../../Security/index.html"
                        title="next chapter">9. Security countermeasures</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/ArchitectureInDetail/MessagingDetail/JMS.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="jms-java-message-service">
<h1>8.2. JMS(Java Message Service)<a class="headerlink" href="#jms-java-message-service" title="Permalink to this headline">¶</a></h1>
<div class="admonition caution">
  <p class="first admonition-title">Caution</p>
  <p><strong>This version is already obsolete</strong>. Please check <a href="http://terasolunaorg.github.io/guideline/">the latest guideline</a>.</p>
</div>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id6">Overview</a><ul>
<li><a class="reference internal" href="#what-is-jms" id="id7">What is JMS</a></li>
<li><a class="reference internal" href="#using-jms" id="id8">Using JMS</a></li>
<li><a class="reference internal" href="#using-jms-which-use-component-of-spring-framework" id="id9">Using JMS which use component of Spring Framework</a><ul>
<li><a class="reference internal" href="#when-messages-are-sent-synchronously" id="id10">When messages are sent synchronously</a></li>
<li><a class="reference internal" href="#when-messages-are-received-asynchronously" id="id11">When messages are received asynchronously</a></li>
<li><a class="reference internal" href="#when-the-messages-are-received-synchronously" id="id12">When the messages are received synchronously</a></li>
</ul>
</li>
<li><a class="reference internal" href="#regarding-project-configuration" id="id13">Regarding project configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use" id="id14">How to use</a><ul>
<li><a class="reference internal" href="#settings-that-are-common-for-both-sending-and-receiving-messages" id="id15">Settings that are common for both sending and receiving messages</a><ul>
<li><a class="reference internal" href="#configuration-of-dependent-library" id="id16">Configuration of dependent library</a></li>
<li><a class="reference internal" href="#configuration-of-connectionfactory" id="id17">Configuration of <code class="docutils literal"><span class="pre">ConnectionFactory</span></code></a></li>
<li><a class="reference internal" href="#configuration-of-destinationresolver" id="id18">Configuration of <code class="docutils literal"><span class="pre">DestinationResolver</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#a-method-to-synchronously-send-messages" id="id19">A method to synchronously send messages</a><ul>
<li><a class="reference internal" href="#basic-synchronous-transmission" id="id20">Basic synchronous transmission</a></li>
<li><a class="reference internal" href="#when-message-header-is-to-be-edited-and-sent-synchronously" id="id21">When message header is to be edited and sent synchronously</a></li>
<li><a class="reference internal" href="#transaction-control" id="id22">Transaction control</a></li>
</ul>
</li>
<li><a class="reference internal" href="#a-method-to-receive-messages-asynchronously" id="id23">A method to receive messages asynchronously</a><ul>
<li><a class="reference internal" href="#basic-asynchronous-reception" id="id24">Basic asynchronous reception</a></li>
<li><a class="reference internal" href="#fetching-header-information-of-messages" id="id25">Fetching header information of messages</a></li>
<li><a class="reference internal" href="#process-results-after-asynchronous-reception-are-sent-as-messages" id="id26">Process results after asynchronous reception are sent as messages</a></li>
<li><a class="reference internal" href="#when-messages-which-are-asynchronously-received-are-to-be-restricted" id="id27">When messages which are asynchronously received are to be restricted</a></li>
<li><a class="reference internal" href="#input-check-for-the-messages-which-are-received-asynchronously" id="id28">Input check for the messages which are received asynchronously</a></li>
<li><a class="reference internal" href="#jmshowtousetransactionmanagementforasyncreceive" id="id29">Transaction control</a></li>
<li><a class="reference internal" href="#exception-handling-at-the-time-of-asynchronous-reception" id="id30">Exception handling at the time of asynchronous reception</a></li>
</ul>
</li>
<li><a class="reference internal" href="#a-method-wherein-the-messages-are-synchronously-received" id="id31">A method wherein the messages are synchronously received</a></li>
</ul>
</li>
<li><a class="reference internal" href="#appendix" id="id32">Appendix</a><ul>
<li><a class="reference internal" href="#jms-provider-dependent-configuration" id="id33">JMS provider dependent configuration</a><ul>
<li><a class="reference internal" href="#while-using-apache-activemq" id="id34">While using Apache ActiveMQ</a></li>
</ul>
</li>
<li><a class="reference internal" href="#mass-mailing-of-identical-messages" id="id35">Mass-mailing of identical messages</a></li>
<li><a class="reference internal" href="#sending-and-receiving-large-size-data" id="id36">Sending and receiving large size data</a><ul>
<li><a class="reference internal" href="#id4" id="id37">While using Apache ActiveMQ</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<span id="jmsoverview"></span><h2><a class="toc-backref" href="#id6">8.2.1. Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This chapter explains how to send and receive messages which use components for JMS linking of JMS API and Spring Framework.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="what-is-jms">
<span id="jmsoverviewaboutjms"></span><h3><a class="toc-backref" href="#id7">8.2.1.1. What is JMS</a><a class="headerlink" href="#what-is-jms" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">JMS is a standard API for using MOM (Message Oriented Middleware) in Java.</div>
<div class="line">JMS architecture exchanges messages from client to client through JMS provider.</div>
<div class="line">Since JMS supports asynchronous messaging, a close coupling can be formed between the clients.</div>
<div class="line">Further, since the message can be stored in Queue by adopting a Point-to-Point model described later, messages can be received in accordance with the client performance.</div>
<div class="line">On the other hand, since the time lag is likely to occur in the messaging between clients, it is not suitable for the processes which require a real time response.</div>
<div class="line">For details of JMS, refer <a class="reference external" href="http://www.oracle.com/technetwork/java/index-jsp-142945.html">Java Message Service (JMS)</a>.</div>
<div class="line"><br /></div>
<div class="line">Asynchronous and synchronous messaging can be performed by using JMS.</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Use of JMS1.1 is assumed in this guideline.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">While using, the delivery method and the method to send and receive messages described below must be selected in accordance with the requirements.</div>
</div>
<ul class="simple">
<li><strong>Delivery model</strong></li>
</ul>
<blockquote>
<div><div class="line-block">
<div class="line">Delivery model consists of two models - Point-to-Point (PTP) and Publisher-Subscriber (Pub/Sub).</div>
<div class="line">A major difference between two models is in whether the sender and recipient ratio is 1:1 or 1:many, and should be selected based on the use.</div>
</div>
<ol class="arabic simple">
<li>Point-To-Point (PTP) model</li>
</ol>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../../_images/JMSQueue.png"><img alt="JMS Queue" src="../../_images/JMSQueue.png" style="width: 70%;" /></a>
</div>
<div class="line-block">
<div class="line">PTP model consists of 2 clients wherein one of the clients (Producer) sends a message and the other client (Consumer) alone receives that message.</div>
<div class="line">Destination of the message in PTP model is called as a Queue.</div>
<div class="line">Producer sends the message to the Queue and the Consumer fetches the message from the Queue, and the process is carried out.</div>
<div class="line">Message is fetched from the consumer or when the message reaches expiry period, the message is deleted from the Queue.</div>
<div class="line"><br /></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="2">
<li>Publisher-Subscriber (Pub/Sub) model</li>
</ol>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../../_images/JMSTopic.png"><img alt="JMS Topic" src="../../_images/JMSTopic.png" style="width: 70%;" /></a>
</div>
<div class="line-block">
<div class="line">Pub/Sub model consists of 2 clients wherein one of the clients (Publisher) issues (Publishes) the message and delivers that message to multiple other clients (Subscribers).</div>
<div class="line">Destination of the message in Pub/Sub model is called as a Topic.</div>
<div class="line">Subscriber raises a subscription request for the Topic and the Publisher issues a message in Topic.</div>
<div class="line">The message is delivered to all the subscribers who have raised a request for subscription.</div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><strong>This guideline explains how to implement PTP model which is widely used in general.</strong></div>
</div>
</div></blockquote>
<ul class="simple">
<li><strong>A method to send messages</strong></li>
</ul>
<blockquote>
<div><div class="line-block">
<div class="line">There are two types of processes for message sending - Synchronous transmission method and asynchronous transmission method for sending the messages to Queue or Topic however JMS1.1 supports only synchronous transmission method.</div>
</div>
<ol class="arabic simple">
<li>Synchronous transmission method</li>
</ol>
<blockquote>
<div><div class="line-block">
<div class="line">Message is processed and sent by explicitly calling a function to send messages.</div>
<div class="line">Subsequent processing is blocked in order to wait until the response is received from JMS provider.</div>
<div class="line"><br /></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="2">
<li>Asynchronous transmission method</li>
</ol>
<blockquote>
<div><div class="line-block">
<div class="line">Message is processed and sent by explicitly calling a function to send messages.</div>
<div class="line">Subsequent processing is continued since it is not necessary to wait for the response from JMS provider.</div>
<div class="line">For the details of asynchronous transmission method, refer <a class="reference external" href="http://download.oracle.com/otndocs/jcp/jms-2_0-fr-eval-spec/">Java Message Service(Version 2.0)</a>”7.3. Asynchronous send”.</div>
</div>
</div></blockquote>
</div></blockquote>
<ul class="simple">
<li><strong>Message reception method</strong></li>
</ul>
<blockquote>
<div><div class="line-block">
<div class="line">There are two types of methods for receiving messages - synchronous reception method and asynchronous reception method while implementing the process for receiving messages in Queue or Topic.</div>
<div class="line">As described later, since use cases of synchronous reception methods are limited, generally asynchronous reception methods are widely used.</div>
</div>
<ol class="arabic simple">
<li>Asynchronous reception method</li>
</ol>
<blockquote>
<div><div class="line-block">
<div class="line">When the message is received by Queue or Topic, the processing for the received message is initiated.</div>
<div class="line">Since the processing for one message is initiated without terminating the processing for the other message, it is suitable for parallel processing.</div>
<div class="line"><br /></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="2">
<li>Synchronous reception method</li>
</ol>
<blockquote>
<div><div class="line-block">
<div class="line">Receiving the message and related processing is initiated by explicitly calling the function which receives the message.</div>
<div class="line">The function which receives the message waits till the message is received  when the message does not exist in Queue or Topic.</div>
<div class="line">Hence, the waiting period for the message must be specified by configuring the timeout value.</div>
</div>
<div class="line-block">
<div class="line">As an example of synchronous reception of message, it can be used when the message accumulated in the Queue, in the Web application is to be fetched and processed at any time like screen operation etc or
when the messages are to be processed periodically in a batch.</div>
<div class="line"><br /></div>
</div>
</div></blockquote>
</div></blockquote>
<div class="line-block">
<div class="line">In JMS, the message consists of following parts.</div>
<div class="line">For details, refer “3. JMS Message Model” of <a class="reference external" href="http://download.oracle.com/otndocs/jcp/7195-jms-1.1-fr-spec-oth-JSpec/">Java Message Service(Version 1.1)</a>.</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Structure</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">Header</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Control information of message like destination and identifier, extension header (JMSX) of JMS, JMS provider specific header and application specific header are stored for JMS provider and application.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">Property</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Control information to be added to header is stored.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">Payload</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Message body is stored.</div>
<div class="line">As data types, 5 types of message types namely <code class="docutils literal"><span class="pre">javax.jms.BytesMessage</span></code>, <code class="docutils literal"><span class="pre">javax.jms.MapMessage</span></code>, <code class="docutils literal"><span class="pre">javax.jms.ObjectMessage</span></code>, <code class="docutils literal"><span class="pre">javax.jms.StreamMessage</span></code>and <code class="docutils literal"><span class="pre">javax.jms.TextMessage</span></code>are offered.</div>
<div class="line"><code class="docutils literal"><span class="pre">ObjectMessage</span></code> is used while sending a JavaBean.</div>
<div class="line">In such a case, JavaBean must be shared between the clients.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="using-jms">
<span id="jmsoverviewapi"></span><h3><a class="toc-backref" href="#id8">8.2.1.2. Using JMS</a><a class="headerlink" href="#using-jms" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">When the process is to be implemented by using JMS, it can be executed by using JMS API defined in Java EE (hereafter referred to as JMS API).</div>
<div class="line">However, this guideline assumes the use of JMS linking component of Spring Framework wherein the merits are significant as compared to using JMS API as it is (easy description etc).</div>
<div class="line">Hence, details of JMS API are not described.</div>
<div class="line">For details, refer <a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/jms/package-summary.html">Java API</a>.</div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For JMS, Java API is standardized however physical protocols of messages are not standardized.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since JMS implementation is incorporated in Java EE server as a standard, it can be used as a default (restricted while using JMS provider incorporated in Java EE server), however JMS must be separately implemented in Java EE server like Apache Tomcat wherein JMS is not incorporated.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="using-jms-which-use-component-of-spring-framework">
<span id="jmsoverviewspringjms"></span><h3><a class="toc-backref" href="#id9">8.2.1.3. Using JMS which use component of Spring Framework</a><a class="headerlink" href="#using-jms-which-use-component-of-spring-framework" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Following are provided as the libraries for sending and receiving messages in Spring Framework.</div>
</div>
<ul>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">spring-jms</span></code></dt>
<dd><div class="first last line-block">
<div class="line">It offers a component for the messaging which use JMS.</div>
<div class="line">By using the components included in this library, low level JMS API calling becomes unnecessary and the implementation becomes simplified.</div>
<div class="line"><code class="docutils literal"><span class="pre">spring-messaging</span></code> can be used.</div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">spring-messaging</span></code></dt>
<dd><div class="first last line-block">
<div class="line">It offers a component to abstract the infrastructure function which is required for creating application of messaging base.</div>
<div class="line">It consists of a set of annotations to associate with the message and the method for processing the same.</div>
<div class="line">By using the components included in the library, implementation style of messaging can be matched.</div>
</div>
</dd>
</dl>
</li>
</ul>
<div class="line-block">
<div class="line">Although implementation can be done only in <code class="docutils literal"><span class="pre">spring-jms</span></code>, implementation method can be combined by using <code class="docutils literal"><span class="pre">spring-messaging</span></code>.</div>
<div class="line">This guideline recommends the use of <code class="docutils literal"><span class="pre">spring-messaging</span></code> as well.</div>
</div>
<div class="line-block">
<div class="line">Here, prior to explaining basic implementation method, it is explained how the messages are sent and received by the components for JMS linking offered by Spring Framework.</div>
<div class="line">At  first, the components registered in the description are introduced.</div>
<div class="line">Spring Framework sends and receives messages through JMS API using interfaces and classes shown below.</div>
</div>
<ul>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">javax.jms.ConnectionFactory</span></code></dt>
<dd><div class="first last line-block">
<div class="line">An interface for creating a connection with JMS provider.</div>
<div class="line">It offers a function to create a connection to JMS provider from the application.</div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">javax.jms.Destination</span></code></dt>
<dd><div class="first last line-block">
<div class="line">An interface for indicating the address (Queue or topic).</div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">javax.jms.MessageProducer</span></code></dt>
<dd><div class="first last line-block">
<div class="line">An interface for sending messages.</div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">javax.jms.MessageConsumer</span></code></dt>
<dd><div class="first last line-block">
<div class="line">An interface for receiving messages.</div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">javax.jms.Message</span></code></dt>
<dd><div class="first last line-block">
<div class="line">An interface which shows the message that retains header and body.</div>
<div class="line">Messages are sent and received by implementation class of the interface.</div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">org.springframework.messaging.Message</span></code></dt>
<dd><div class="first last line-block">
<div class="line">An interface which abstracts messages handled by various messaging systems.</div>
<div class="line">It can also be used in JMS.</div>
<div class="line">As mentioned earlier, basically <code class="docutils literal"><span class="pre">org.springframework.messaging.Message</span></code> offered by spring-messaging is used to comply with implementation method of messaging.</div>
<div class="line">However, <code class="docutils literal"><span class="pre">javax.jms.Message</span></code> is used when it is preferable to use <code class="docutils literal"><span class="pre">org.springframework.jms.core.JmsTemplate</span></code>.</div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">org.springframework.jms.core.JmsMessagingTemplate</span></code> and <code class="docutils literal"><span class="pre">org.springframework.jms.core.JmsTemplate</span></code></dt>
<dd><div class="first last line-block">
<div class="line">A class which creates templates for generation and release of resources for using JMS API.</div>
<div class="line">The implementation can be simplified by using a message transmission and message synchronous reception function.</div>
<div class="line">Basically, <code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code> which can handle <code class="docutils literal"><span class="pre">org.springframework.messaging.Message</span></code> is used.</div>
<div class="line">Since <code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code> wraps <code class="docutils literal"><span class="pre">JmsTemplate</span></code>, configuration can be done by using <code class="docutils literal"><span class="pre">JmsTemplate</span></code> property.</div>
<div class="line">However, sometimes it is preferable to use a <code class="docutils literal"><span class="pre">JmsTemplate</span></code> as it is. Specific use cases are explained later.</div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">org.springframework.jms.listener.DefaultMessageListenerContainer</span></code></dt>
<dd><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code> receives messages from Queue and initiates <code class="docutils literal"><span class="pre">MessageListener</span></code> which processes the received messages.</div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">&#64;org.springframework.jms.annotation.JmsListener</span></code></dt>
<dd><div class="first last line-block">
<div class="line">A marker annotation which indicates that it is a method to be handled as <code class="docutils literal"><span class="pre">MessageListener</span></code> of JMS.</div>
<div class="line">A <code class="docutils literal"><span class="pre">&#64;JmsListener</span></code> annotation is assigned for a method which performs a process while receiving messages.</div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">org.springframework.jms.connection.JmsTransactionManager</span></code></dt>
<dd><div class="first last line-block">
<div class="line">An implementation class to manage transactions by calling API of JMS(<code class="docutils literal"><span class="pre">javax.jms.Connection</span></code>/ <code class="docutils literal"><span class="pre">javax.jms.Session</span></code>).</div>
</div>
</dd>
</dl>
</li>
</ul>
<div class="section" id="when-messages-are-sent-synchronously">
<span id="jmsoverviewsyncsend"></span><h4><a class="toc-backref" href="#id10">8.2.1.3.1. When messages are sent synchronously</a><a class="headerlink" href="#when-messages-are-sent-synchronously" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">The flow of the process to send messages synchronously is explained using the figure.</div>
</div>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../../_images/JMSSendOverview.png"><img alt="Send of Spring JMS" src="../../_images/JMSSendOverview.png" style="width: 70%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Execute the process in Service by passing “Destination name for sending” and “payload of messages to be sent” for <code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>.</div>
<div class="line"><code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code> delegates the process to <code class="docutils literal"><span class="pre">JmsTemplate</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsTemplate</span></code>fetches <code class="docutils literal"><span class="pre">javax.jms.Connection</span></code> from  <code class="docutils literal"><span class="pre">ConnectionFactory</span></code> fetched through JNDI.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsTemplate</span></code> passes <code class="docutils literal"><span class="pre">Destination</span></code> and messages to <code class="docutils literal"><span class="pre">MessageProducer</span></code>.</div>
<div class="line"><code class="docutils literal"><span class="pre">MessageProducer</span></code> is generated from  <code class="docutils literal"><span class="pre">javax.jms.Session</span></code>. (<code class="docutils literal"><span class="pre">Session</span></code> is generated from  <code class="docutils literal"><span class="pre">Connection</span></code> fetched in (2).)</div>
<div class="line">Further, <code class="docutils literal"><span class="pre">Destination</span></code> is fetched through JNDI based on “Destination name for sending” passed in (1).</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">MessageProducer</span></code> sends messages to <code class="docutils literal"><span class="pre">Destination</span></code> for sending.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="when-messages-are-received-asynchronously">
<span id="jmsoverviewasyncreceive"></span><h4><a class="toc-backref" href="#id11">8.2.1.3.2. When messages are received asynchronously</a><a class="headerlink" href="#when-messages-are-received-asynchronously" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">The flow of the process to receive messages asynchronously is explained using a figure.</div>
</div>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../../_images/JMSASyncOverview.png"><img alt="ASync of Spring JMS" src="../../_images/JMSASyncOverview.png" style="width: 70%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch <code class="docutils literal"><span class="pre">Connection</span></code> from  <code class="docutils literal"><span class="pre">ConnectionFactory</span></code> fetched through JNDI.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code> passes <code class="docutils literal"><span class="pre">Destination</span></code> to <code class="docutils literal"><span class="pre">MessageConsumer</span></code>.</div>
<div class="line"><code class="docutils literal"><span class="pre">MessageConsumer</span></code> is generated from <code class="docutils literal"><span class="pre">Session</span></code>. (<code class="docutils literal"><span class="pre">Session</span></code> is generated from <code class="docutils literal"><span class="pre">Connection</span></code> fetched in (1))</div>
<div class="line">Further, <code class="docutils literal"><span class="pre">Destination</span></code> is fetched through JNDI based on “Destination name for receiving” specified in <code class="docutils literal"><span class="pre">&#64;JmsListener</span></code> annotation.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">MessageConsumer</span></code> receives messages from <code class="docutils literal"><span class="pre">Destination</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method (listener method) configured by <code class="docutils literal"><span class="pre">&#64;JmsListener</span></code> annotation in <code class="docutils literal"><span class="pre">MessageListener</span></code> is called using received message as an argument. Listener method is managed by <code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code>.</div>
<div class="line"><br /></div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="when-the-messages-are-received-synchronously">
<span id="jmsoverviewsyncreceive"></span><h4><a class="toc-backref" href="#id12">8.2.1.3.3. When the messages are received synchronously</a><a class="headerlink" href="#when-the-messages-are-received-synchronously" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">The flow of the process to receive messages synchronously is explained using a figure.</div>
</div>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../../_images/JMSSyncOverview.png"><img alt="Sync of Spring JMS" src="../../_images/JMSSyncOverview.png" style="width: 70%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Pass “Destination name for receiving” in Service for <code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>.</div>
<div class="line"><code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code> delegates the process to <code class="docutils literal"><span class="pre">JmsTemplate</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsTemplate</span></code> fetches <code class="docutils literal"><span class="pre">Connection</span></code> from <code class="docutils literal"><span class="pre">ConnectionFactory</span></code> fetched through JNDI.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsTemplate</span></code> passes <code class="docutils literal"><span class="pre">Destination</span></code> and messages in <code class="docutils literal"><span class="pre">MessageConsumer</span></code>.</div>
<div class="line"><code class="docutils literal"><span class="pre">MessageConsumer</span></code> is generated from <code class="docutils literal"><span class="pre">Session</span></code>. (<code class="docutils literal"><span class="pre">Session</span></code> is generated from <code class="docutils literal"><span class="pre">Connection</span></code> fetched in (2).)</div>
<div class="line">Further, <code class="docutils literal"><span class="pre">Destination</span></code> is fetched through JNDI based on “Destination name for receiving” passed in (1).</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">MessageConsumer</span></code> receives the messages from <code class="docutils literal"><span class="pre">Destination</span></code>.</div>
<div class="line">Message is returned to the Service through <code class="docutils literal"><span class="pre">JmsTemplate</span></code> or <code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div>
<div class="section" id="regarding-project-configuration">
<span id="jmsoverviewaboutprojectconfiguration"></span><h3><a class="toc-backref" href="#id13">8.2.1.4. Regarding project configuration</a><a class="headerlink" href="#regarding-project-configuration" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Recommended configuration of the project while using JMS is explained.</div>
<div class="line">When serialised JavaBean is sent and received through <code class="docutils literal"><span class="pre">ObjectMessage</span></code>, the JavaBean must be shared by sending side and receiving side.</div>
<div class="line">In such a case, it is recommended to add a model project different from the existing blank project.</div>
</div>
<ul class="simple">
<li><strong>Sharing model</strong></li>
</ul>
<blockquote>
<div><ul>
<li><p class="first">When client of sending and receiving side does not provide a model</p>
<p>model project is added and Jar file is distributed in the client for communication.</p>
</li>
<li><p class="first">When client of sending and receiving side offer a model</p>
<p>The model provided is added to library.</p>
</li>
</ul>
<div class="line-block">
<div class="line">model project, and, relation between distributed archive file and existing project are as below.</div>
</div>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../../_images/ProjectStructure.png"><img alt="Projects" src="../../_images/ProjectStructure.png" style="width: 70%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="30%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Project name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">web project</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Place the listener class to receive messages asynchronously.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">domain project</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Place the Service executed from listener class for receiving messages asynchronously.</div>
<div class="line">Besides, Repository etc are same as used conventionally.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">model project or Jar file</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A class which is shared between the clients is used among the classes belonging to domain layer.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><div class="line-block">
<div class="line">Following are implemented to add a model project.</div>
</div>
<blockquote>
<div><ul class="simple">
<li>Creating a model project</li>
<li>Adding a dependency from domain project to model project</li>
</ul>
</div></blockquote>
<div class="line-block">
<div class="line">For detail addition method, refer <a class="reference internal" href="../WebServiceDetail/SOAP.html#soapappendixaddproject"><span class="std std-ref">Project configuration is changed for SOAP server.</span></a>  of <a class="reference internal" href="../WebServiceDetail/SOAP.html"><span class="doc">SOAP Web Service (Server/Client)</span></a>.
shared by JavaBean in the same way.</div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="how-to-use">
<span id="jmshowtouse"></span><h2><a class="toc-backref" href="#id14">8.2.2. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<div class="section" id="settings-that-are-common-for-both-sending-and-receiving-messages">
<span id="jmshowtouseenviromentsetting"></span><h3><a class="toc-backref" href="#id15">8.2.2.1. Settings that are common for both sending and receiving messages</a><a class="headerlink" href="#settings-that-are-common-for-both-sending-and-receiving-messages" title="Permalink to this headline">¶</a></h3>
<p>This section explains common settings required for sending and receiving messages.</p>
<div class="section" id="configuration-of-dependent-library">
<span id="jmshowtousedependentlibrary"></span><h4><a class="toc-backref" href="#id16">8.2.2.1.1. Configuration of dependent library</a><a class="headerlink" href="#configuration-of-dependent-library" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">spring-jms</span></code> of Spring Framework is added to pom.xml of domain project in order to use component for linking JMS of Spring Framework.</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/pom.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependencies&gt;</span>

     <span class="c">&lt;!-- (1) --&gt;</span>
     <span class="nt">&lt;dependency&gt;</span>
         <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
         <span class="nt">&lt;artifactId&gt;</span>spring-jms<span class="nt">&lt;/artifactId&gt;</span>
     <span class="nt">&lt;/dependency&gt;</span>

 <span class="nt">&lt;/dependencies&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Add dependencies to <code class="docutils literal"><span class="pre">spring-jms</span></code>.</div>
<div class="line">Since <code class="docutils literal"><span class="pre">spring-jms</span></code> is dependent on <code class="docutils literal"><span class="pre">spring-messaging</span></code>, <code class="docutils literal"><span class="pre">spring-messaging</span></code> is also added as a transitive dependent library.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">A library of JMS provider is added to pom.xml in addition to <code class="docutils literal"><span class="pre">spring-jms</span></code>.</div>
<div class="line">For additional examples of libraries for pom.xml, refer <a class="reference internal" href="#jmsappendixsettingsdependsonjmsprovider"><span class="std std-ref">JMS provider dependent configuration</span></a>.</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In the above setting example, since it is assumed that the dependent library version is managed by the parent project terasoluna-gfw-parent , specifying the version in pom.xml is not necessary.
The above dependent library used by terasoluna-gfw-parent is defined by <a class="reference external" href="http://platform.spring.io/platform/">Spring IO Platform</a>.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="configuration-of-connectionfactory">
<span id="jmshowtouseconnectionfactory"></span><h4><a class="toc-backref" href="#id17">8.2.2.1.2. Configuration of <code class="docutils literal"><span class="pre">ConnectionFactory</span></code></a><a class="headerlink" href="#configuration-of-connectionfactory" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">ConnectionFactory</span></code> definition method consists of two methods - a method defined by application server and a method defined by Bean definition file.</div>
<div class="line">A method defined by application server is selected to make Bean definition file independent of JMS provider unless there is a specific reason to do otherwise.</div>
<div class="line">This chapter explains a method defined by application server only.</div>
<div class="line">Configuration for using a JavaBean fetched in Bean definition file through JNDI must be performed in order to use <code class="docutils literal"><span class="pre">ConnectionFactory</span></code> defined in the application server.</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/resources/META-INF/spring/[projectName]-infra.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;jee:jndi-lookup</span> <span class="na">id=</span><span class="s">&quot;connectionFactory&quot;</span> <span class="na">jndi-name=</span><span class="s">&quot;jms/ConnectionFactory&quot;</span><span class="nt">/&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify JNDI name of <code class="docutils literal"><span class="pre">ConnectionFactory</span></code> offered by application server, in <code class="docutils literal"><span class="pre">jndi-name</span></code> attribute.</div>
<div class="line">Since <code class="docutils literal"><span class="pre">resource-ref</span></code> attribute is set to <code class="docutils literal"><span class="pre">true</span></code> by default, it is auto-assigned when no prefix exists for JNDI name (java:comp/env/).</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>When ConnectionFactory for which a Bean is defined is used</strong></p>
<p class="last">When JNDI is not used, <code class="docutils literal"><span class="pre">ConnectionFactory</span></code> can be used even when a Bean is defined for implementation class of <code class="docutils literal"><span class="pre">ConnectionFactory</span></code>.
In such a case, implementation class of <code class="docutils literal"><span class="pre">ConnectionFactory</span></code> is dependent on JMS provider. For details, refer <a class="reference internal" href="#jmsappendixsettingsdependsonjmsprovider"><span class="std std-ref">JMS provider dependent configuration</span></a> “configuration when JNDI is not used”.</p>
</div>
</div></blockquote>
</div>
<div class="section" id="configuration-of-destinationresolver">
<span id="jmshowtousedestinationresolver"></span><h4><a class="toc-backref" href="#id18">8.2.2.1.3. Configuration of <code class="docutils literal"><span class="pre">DestinationResolver</span></code></a><a class="headerlink" href="#configuration-of-destinationresolver" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Name resolution of Destination consists of 2 methods - Resolution by JNDI and Resolution by JMS provider.</div>
<div class="line">Resolution by JMS provider is performed by default, however resolution by JNDI is recommended for portability and control if there are no particular issues to address.</div>
</div>
<div class="line-block">
<div class="line">Name resolution of Destination can be performed by JNDI name, by using <code class="docutils literal"><span class="pre">org.springframework.jms.support.destination.JndiDestinationResolver</span></code>.</div>
<div class="line">How to define <code class="docutils literal"><span class="pre">JndiDestinationResolver</span></code> is shown below.</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/resources/META-INF/spring/[projectName]-infra.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;destinationResolver&quot;</span>
   <span class="na">class=</span><span class="s">&quot;org.springframework.jms.support.destination.JndiDestinationResolver&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;resourceRef&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for <code class="docutils literal"><span class="pre">JndiDestinationResolver</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">When there is no prefix in JNDI name (java:comp/env/), set <code class="docutils literal"><span class="pre">true</span></code>when it is auto-assigned. Default value is <code class="docutils literal"><span class="pre">false</span></code>.</div>
</div>
<div class="last admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Note that <code class="docutils literal"><span class="pre">resource-ref</span></code> attribute of <code class="docutils literal"><span class="pre">&lt;jee:jndi-lookup/&gt;</span></code> is different from the default value.</p>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div>
<div class="section" id="a-method-to-synchronously-send-messages">
<span id="jmshowtousesyncsendmessage"></span><h3><a class="toc-backref" href="#id19">8.2.2.2. A method to synchronously send messages</a><a class="headerlink" href="#a-method-to-synchronously-send-messages" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">A method to synchronously send messages from  client (Producer) to JMS provider, for PTP model is explained below.</div>
</div>
<div class="section" id="basic-synchronous-transmission">
<span id="jmshowtousesettingforsyncsend"></span><h4><a class="toc-backref" href="#id20">8.2.2.2.1. Basic synchronous transmission</a><a class="headerlink" href="#basic-synchronous-transmission" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Process of synchronous transmission to JMS provider is achieved by using <code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>.</div>
</div>
<div class="line-block">
<div class="line">An implementation example wherein object of <code class="docutils literal"><span class="pre">Todo</span></code> class is synchronously sent as a message.</div>
<div class="line">At first, how to configure <code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code> is shown below.</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/resources/META-INF/spring/[projectName]-infra.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;cachingConnectionFactory&quot;</span>
   <span class="na">class=</span><span class="s">&quot;org.springframework.jms.connection.CachingConnectionFactory&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
   <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;targetConnectionFactory&quot;</span> <span class="na">ref=</span><span class="s">&quot;connectionFactory&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
   <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;sessionCacheSize&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;jmsTemplate&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.jms.core.JmsTemplate&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;connectionFactory&quot;</span> <span class="na">ref=</span><span class="s">&quot;cachingConnectionFactory&quot;</span> <span class="nt">/&gt;</span>
   <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;destinationResolver&quot;</span> <span class="na">ref=</span><span class="s">&quot;destinationResolver&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- (5) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;jmsMessagingTemplate&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.jms.core.JmsMessagingTemplate&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;jmsTemplate&quot;</span> <span class="na">ref=</span><span class="s">&quot;jmsTemplate&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for <code class="docutils literal"><span class="pre">org.springframework.jms.connection.CachingConnectionFactory</span></code> which performs caching of <code class="docutils literal"><span class="pre">Session</span></code> and <code class="docutils literal"><span class="pre">MessageProducer/Consumer</span></code>.</div>
<div class="line">JMS provider specific <code class="docutils literal"><span class="pre">ConnectionFactory</span></code> looked up by Bean definition or JNDI name is not used as it is.
Cache function can be used by wrapping it in <code class="docutils literal"><span class="pre">CachingConnectionFactory</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify JMS provider specific <code class="docutils literal"><span class="pre">ConnectionFactory</span></code> which is looked up by Bean definition or JNDI name.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify cache count for <code class="docutils literal"><span class="pre">Session</span></code>. (Default value is 1)</div>
<div class="line">Although 1 is specified in this example, number of caches must be changed appropriately corresponding to performance requirements.</div>
<div class="line">When the session is required to be continued even after exceeding cache count, a new session is created and destroyed repeatedly without using a cache.</div>
<div class="line">This is likely to cause deterioration of process efficiency resulting in performance degradation.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for <code class="docutils literal"><span class="pre">JmsTemplate</span></code>.</div>
<div class="line"><code class="docutils literal"><span class="pre">JmsTemplate</span></code> alternates for a low level API handling (JMS API calling).</div>
<div class="line">For attributes that can be configured, refer list of attributes of <code class="docutils literal"><span class="pre">JmsTemplate</span></code> given below.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for <code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>. Inject <code class="docutils literal"><span class="pre">JmsTemplate</span></code> which alternates as a synchronous transmission process.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line">Attributes of <code class="docutils literal"><span class="pre">JmsTemplate</span></code> for synchronous transmission are as below.</div>
<div class="line">It must be configured as per requirement.</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="5%" />
<col width="20%" />
<col width="50%" />
<col width="15%" />
<col width="10%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Configuration item</th>
<th class="head">Details</th>
<th class="head">Mandatory</th>
<th class="head">Default value</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">connectionFactory</span></code></td>
<td><div class="first last line-block">
<div class="line">Configure <code class="docutils literal"><span class="pre">ConnectionFactory</span></code> to be used.</div>
</div>
</td>
<td>○</td>
<td>Nil (since it is mandatory)</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">pubSubDomain</span></code></td>
<td><div class="first last line-block">
<div class="line">Configure for a messaging model.</div>
<div class="line">Set <code class="docutils literal"><span class="pre">false</span></code> for PTP (Queue) model and set <code class="docutils literal"><span class="pre">true</span></code> for Pub/Sub (Topic).</div>
</div>
</td>
<td>-</td>
<td><code class="docutils literal"><span class="pre">false</span></code></td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">sessionTransacted</span></code></td>
<td><div class="first last line-block">
<div class="line">Specify whether the transaction control is performed in the session.</div>
<div class="line">In this guideline, <code class="docutils literal"><span class="pre">false</span></code> is recommended as a default for using transaction control described later.</div>
</div>
</td>
<td>-</td>
<td><code class="docutils literal"><span class="pre">false</span></code></td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">messageConverter</span></code></td>
<td><div class="first last line-block">
<div class="line">Specify message converter.</div>
<div class="line">Default can be used for the scope described in the guideline.</div>
</div>
</td>
<td>-</td>
<td><code class="docutils literal"><span class="pre">SimpleMessageConverter</span></code>(*1) is used.</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">destinationResolver</span></code></td>
<td><div class="first last line-block">
<div class="line">Specify DestinationResolver.</div>
<div class="line">In this guideline, it is recommended to use <code class="docutils literal"><span class="pre">JndiDestinationResolver</span></code> which performs name resolution in JNDI.</div>
</div>
</td>
<td>-</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DynamicDestinationResolver</span></code>(*2) is used.</div>
<div class="line">(When <code class="docutils literal"><span class="pre">DynamicDestinationResolver</span></code> is used, name resolution of Destination is performed by JMS provider.)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">defaultDestination</span></code></td>
<td><div class="first last line-block">
<div class="line">Specify existing Destination.</div>
<div class="line">When Destination is not specified explicitly, this Destination is used.</div>
</div>
</td>
<td>-</td>
<td>null (no existing destination)</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">deliveryMode</span></code></td>
<td><div class="first last line-block">
<div class="line">Select 1 (NON_PERSISTENT) or 2(PERSISTENT) for delivery mode.</div>
<div class="line">2(PERSISTENT) performs perpetuation of messages.</div>
<div class="line">1(NON_PERSISTENT) does not perform perpetuation of messages.</div>
<div class="line">Hence, even though performance shows improvement, messages are likely to get lost if JMS provider is restarted.</div>
<div class="line">In this guideline, it is recommended to use 2 (PERSISTENT) for avoiding loss of messages.</div>
<div class="line">When this configuration is used, note that <code class="docutils literal"><span class="pre">explicitQosEnabled</span></code> described later must be set to <code class="docutils literal"><span class="pre">true</span></code>.</div>
</div>
</td>
<td>-</td>
<td>2(PERSISTENT)</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="8">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">priority</span></code></td>
<td><div class="first last line-block">
<div class="line">Set priority for messages. Priority can be set from 0 to 9.</div>
<div class="line">Higher the number, higher is the priority.</div>
<div class="line">Priority is evaluated when the message is stored in the Queue at the time of synchronous transmission. Messages are stored in such a way that messages with high priority are extracted before the messages with low priority.</div>
<div class="line">FIFO (First-In-First-Out) system is employed for the messages with identical priorities.</div>
<div class="line">When this configuration is used, note that <code class="docutils literal"><span class="pre">explicitQosEnabled</span></code> described later must be set to <code class="docutils literal"><span class="pre">true</span></code>.</div>
</div>
</td>
<td>-</td>
<td>4</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="9">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">timeToLive</span></code></td>
<td><div class="first last line-block">
<div class="line">Specify validity period of messages in milliseconds.</div>
<div class="line">When the message reaches the validity period, JMS provider deletes the message from  Queue</div>
<div class="line">When this configuration is used, note that <code class="docutils literal"><span class="pre">explicitQosEnabled</span></code> described later must be set to <code class="docutils literal"><span class="pre">true</span></code>.</div>
</div>
</td>
<td>-</td>
<td>0 (Unrestricted)</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="10">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">explicitQosEnabled</span></code></td>
<td><div class="first last line-block">
<div class="line">Specify <code class="docutils literal"><span class="pre">true</span></code> when <code class="docutils literal"><span class="pre">deliveryMode</span></code>, <code class="docutils literal"><span class="pre">priority</span></code> and <code class="docutils literal"><span class="pre">timeToLive</span></code> are enabled.</div>
</div>
</td>
<td>-</td>
<td><code class="docutils literal"><span class="pre">false</span></code></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>(*1)<code class="docutils literal"><span class="pre">org.springframework.jms.support.converter.SimpleMessageConverter</span></code></p>
<p>(*2)<code class="docutils literal"><span class="pre">org.springframework.jms.support.destination.DynamicDestinationResolver</span></code></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">Next, a JavaBean is created for sending.</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/java/com/example/domain/model/Todo.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.model</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Todo</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span> <span class="c1">// (1)</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1L</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">description</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">finished</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getDescription</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">description</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDescription</span><span class="o">(</span><span class="n">String</span> <span class="n">description</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isFinished</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">finished</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFinished</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">finished</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">finished</span> <span class="o">=</span> <span class="n">finished</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Basically, a normal JavaBean can be used, however, a <code class="docutils literal"><span class="pre">java.io.Serializable</span></code> interface must be implemented  for a serialised transmission.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line">A process to perform actual synchronous transmission is described in the end.</div>
<div class="line">An implementation example is shown below wherein <code class="docutils literal"><span class="pre">Todo</span></code> object consisting of specified text is synchronously sent to Queue.</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/java/com/example/domain/service/todo/TodoServiceImpl.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service.todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jms.core.JmsMessagingTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">JmsMessagingTemplate</span> <span class="n">jmsMessagingTemplate</span><span class="o">;</span>    <span class="c1">// (1)</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendMessage</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>

       <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Todo</span><span class="o">();</span>
       <span class="c1">// omitted</span>

       <span class="n">jmsMessagingTemplate</span><span class="o">.</span><span class="na">convertAndSend</span><span class="o">(</span><span class="s">&quot;jms/queue/TodoMessageQueue&quot;</span><span class="o">,</span> <span class="n">todo</span><span class="o">);</span>  <span class="c1">// (2)</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inject <code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">By using <code class="docutils literal"><span class="pre">convertAndSend</span></code> method of <code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>, JavaBean of argument is converted to implementation class of <code class="docutils literal"><span class="pre">org.springframework.messaging.Message</span></code> interface and the message is synchronously sent for a specified Destination.</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.jms.support.converter.SimpleMessageConverter</span></code> is used in the default conversion.</div>
<div class="line">When <code class="docutils literal"><span class="pre">SimpleMessageConverter</span></code> is used, the class which implements <code class="docutils literal"><span class="pre">javax.jms.Message</span></code>, <code class="docutils literal"><span class="pre">java.lang.String</span></code>, <code class="docutils literal"><span class="pre">byte</span> <span class="pre">array</span></code>, <code class="docutils literal"><span class="pre">java.util.Map</span></code> and <code class="docutils literal"><span class="pre">java.io.Serializable</span></code> interface can be sent.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Exception handling of JMS in business logic</strong></p>
<p>As covered in <a class="reference external" href="http://docs.spring.io/spring/docs/4.3.14.RELEASE/javadoc-api/org/springframework/jms/core/JmsTemplate.html">JMS (Java Message Service) introduction</a>, exceptions are converted to run-time exceptions in Spring Framework.
Hence, a run-time exception must be handled while handling JMS exception in business logic.</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="20%" />
<col width="60%" />
<col width="20%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Template class</th>
<th class="head">A method to convert exceptions</th>
<th class="head">Exception after conversion</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">convertJmsException</span></code> method of <code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">MessagingException</span></code>(*1) and its sub-exception</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsTemplate</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">convertJmsAccessException</span></code> method of <code class="docutils literal"><span class="pre">JmsAccessor</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsException</span></code>(*2) and its sub-exception</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>(*1) <code class="docutils literal"><span class="pre">org.springframework.messaging.MessagingException</span></code></p>
<p class="last">(*2) <code class="docutils literal"><span class="pre">org.springframework.jms.JmsException</span></code></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="when-message-header-is-to-be-edited-and-sent-synchronously">
<span id="jmshowtousesettingforsendwithheader"></span><h4><a class="toc-backref" href="#id21">8.2.2.2.2. When message header is to be edited and sent synchronously</a><a class="headerlink" href="#when-message-header-is-to-be-edited-and-sent-synchronously" title="Permalink to this headline">¶</a></h4>
<p>Header attribute can be edited and then sent synchronously by specifying header attribute and value of Key-Value format in <code class="docutils literal"><span class="pre">convertAndSend</span></code> method argument of <code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>.
For header details, refer <a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/jms/Message.html">javax.jms.Messages</a>.
An implementation example wherein <code class="docutils literal"><span class="pre">JMSCorrelationID</span></code> of role which links sending and response messages is specified at the time of synchronous transmission.</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/java/com/example/domain/service/todo/TodoServiceImpl.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service.todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jms.core.JmsMessagingTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jms.support.JmsHeaders</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>

<span class="nd">@Inject</span>
<span class="n">JmsMessagingTemplate</span> <span class="n">jmsMessagingTemplate</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendMessageWithCorrelationId</span><span class="o">(</span><span class="n">String</span> <span class="n">correlationId</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Todo</span><span class="o">();</span>
    <span class="c1">// omitted</span>

    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
    <span class="n">headers</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">JmsHeaders</span><span class="o">.</span><span class="na">CORRELATION_ID</span><span class="o">,</span> <span class="n">correlationId</span><span class="o">);</span><span class="c1">// (1)</span>

    <span class="n">jmsMessagingTemplate</span><span class="o">.</span><span class="na">convertAndSend</span><span class="o">(</span><span class="s">&quot;jms/queue/TodoMessageQueue&quot;</span><span class="o">,</span>
            <span class="n">todo</span><span class="o">,</span> <span class="n">headers</span><span class="o">);</span> <span class="c1">// (2)</span>

  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create header information by configuring header attribute name and its value, for implementation class of <code class="docutils literal"><span class="pre">Map</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Synchronously send the message assigned with header information created in (2) by using <code class="docutils literal"><span class="pre">convertAndSend</span></code> method of <code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>Regarding header attributes that can be edited</strong></p>
<p class="last">Components of header attributes (<code class="docutils literal"><span class="pre">JMSDestination</span></code>, <code class="docutils literal"><span class="pre">JMSDeliveryMode</span></code>, <code class="docutils literal"><span class="pre">JMSExpiration</span></code>, <code class="docutils literal"><span class="pre">JMSMessageID</span></code>, <code class="docutils literal"><span class="pre">JMSPriority</span></code>, <code class="docutils literal"><span class="pre">JMSRedelivered</span></code>and <code class="docutils literal"><span class="pre">JMSTimestamp</span></code>) are handled as read-only while converting messages using <code class="docutils literal"><span class="pre">SimpleMessageConverter</span></code> of Spring Framework.
Hence, even though read-only header attributes are configured as shown in the implementation example, they are not stored in the header of sent messages. (retained as message properties.)
Among read-only header attributes, <code class="docutils literal"><span class="pre">JMSDeliveryMode</span></code> and <code class="docutils literal"><span class="pre">JMSPriority</span></code> can be configured in <code class="docutils literal"><span class="pre">JmsTemplate</span></code> unit.
For details, refer list of attributes of <code class="docutils literal"><span class="pre">JmsTemplate</span></code> of <a class="reference internal" href="#jmshowtousesettingforsyncsend"><span class="std std-ref">Basic synchronous transmission</span></a>.</p>
</div>
</div></blockquote>
</div>
<div class="section" id="transaction-control">
<span id="jmshowtousesettingforsyncsendtransactionmanagement"></span><h4><a class="toc-backref" href="#id22">8.2.2.2.3. Transaction control</a><a class="headerlink" href="#transaction-control" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">When data consistency is required to be guaranteed, a transaction control function is used.</div>
<div class="line">An implementation example wherein “Declaration type transaction control” is used is recommended in this guideline.</div>
<div class="line">For details of “Declaration type transaction control”, refer <a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html#service-transaction-management"><span class="std std-ref">Regarding transaction management</span></a> .</div>
<div class="line"><br /></div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.jms.connection.JmsTransactionManager</span></code> is used to achieve transaction control.</div>
<div class="line">Configuration example is shown at first.</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/resources/META-INF/spring/[projectName]-domain.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sendJmsTransactionManager&quot;</span>
   <span class="na">class=</span><span class="s">&quot;org.springframework.jms.connection.JmsTransactionManager&quot;</span><span class="nt">&gt;</span>
   <span class="c">&lt;!-- (2) --&gt;</span>
   <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;connectionFactory&quot;</span> <span class="na">ref=</span><span class="s">&quot;cachingConnectionFactory&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">Define a Bean for <code class="docutils literal"><span class="pre">JmsTransactionManager</span></code>.</div>
</div>
<div class="last admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Regarding bean name of TransactionManager</strong></p>
<p>When <code class="docutils literal"><span class="pre">&#64;Transactional</span></code> annotation is assigned, a Bean registered by Bean name <code class="docutils literal"><span class="pre">transactionManager</span></code> is used as a default.
(For details, refer <a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html#domainlayerappendixtransactionmanagement"><span class="std std-ref">Settings for using transaction management</span></a> )</p>
<p>In Blank project, since <code class="docutils literal"><span class="pre">DataSourceTransactionManager</span></code> is defined by Bean name called <code class="docutils literal"><span class="pre">transactionManager</span></code>, Bean is defined with an alias in the configuration above.</p>
<p class="last">Hence, when only one <code class="docutils literal"><span class="pre">TransactionManager</span></code> is used in the application, specification of <code class="docutils literal"><span class="pre">transactionManager</span></code> attribute in <code class="docutils literal"><span class="pre">&#64;Transactional</span></code> annotation can be omitted by using <code class="docutils literal"><span class="pre">transactionManager</span></code> as a Bean name.</p>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify <code class="docutils literal"><span class="pre">CachingConnectionFactory</span></code> which controls a transaction.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>An implementation example is shown below wherein <code class="docutils literal"><span class="pre">Todo</span></code> object is synchronously sent to Queue by performing transaction control.</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/java/com/example/domain/service/todo/TodoServiceImpl.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service.todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jms.core.JmsMessagingTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span><span class="o">(</span><span class="s">&quot;sendJmsTransactionManager&quot;</span><span class="o">)</span>  <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>
   <span class="nd">@Inject</span>
   <span class="n">JmsMessagingTemplate</span> <span class="n">jmsMessagingTemplate</span><span class="o">;</span>

   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendMessage</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>

      <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Todo</span><span class="o">();</span>
      <span class="c1">// omitted</span>

      <span class="n">jmsMessagingTemplate</span><span class="o">.</span><span class="na">convertAndSend</span><span class="o">(</span><span class="s">&quot;jms/queue/TodoMessageQueue&quot;</span><span class="o">,</span> <span class="n">todo</span><span class="o">);</span>  <span class="c1">// (2)</span>
   <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Declare transaction boundary by using <code class="docutils literal"><span class="pre">&#64;Transactional</span></code> annotation.</div>
<div class="line">Accordingly, transaction starts while starting each method in the class and transaction is committed while terminating a method.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Send message synchronously to Queue.</div>
<div class="line">However, note that the message is actually sent to Queue within the timing wherein the transaction is committed.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>In the application wherein DB transaction control is performed, a transaction control policy must be determined after reviewing relation between JMS and DB transaction based on business requirements.</p>
<blockquote>
<div><blockquote>
<div><p>A method which uses global transaction by JTA exists for linking JMS and DB transactions, however “Best Effort 1 Phase Commit” is recommended since overheads are likely to occur for performance, among protocol characteristics. Refer below for details.</p>
<div class="line-block">
<div class="line"><a class="reference external" href="http://www.javaworld.com/article/2077963/open-source-tools/distributed-transactions-in-spring--with-and-without-xa.html">Distributed transactions in Spring, with and without XA</a></div>
<div class="line"><a class="reference external" href="http://gharshangupta.blogspot.jp/2015/03/spring-distributed-transactions-using_2.html">Spring Distributed transactions using Best Effort 1 Phase Commit</a></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>When transaction process results are not returned in JMS provider due to issues like loss of connection with JMS provider after receiving a message</strong></p>
<p class="last">When transaction process results are not returned in JMS provider due to issues like loss of connection with JMS provider after receiving a message, transaction handling depends on JMS provider.
Hence, <strong>a design considering loss of received messages</strong> must be carried out.
Especially, when loss of messages is absolutely not permissible, <strong>providing a system to compensate for the loss of messages or using a global transaction etc</strong> must be adopted.</p>
</div>
<div class="line-block">
<div class="line">“Best Effort 1 Phase Commit” can be achieved by using <code class="docutils literal"><span class="pre">org.springframework.data.transaction.ChainedTransactionManager</span></code>.</div>
<div class="line">An implementation example is shown below wherein <code class="docutils literal"><span class="pre">sendJmsTransactionManager</span></code> of <a class="reference internal" href="#jmshowtousesettingforsyncsendtransactionmanagement"><span class="std std-ref">Transaction control</span></a> is used in JMS transaction management whereas <code class="docutils literal"><span class="pre">transactionManager</span></code> defined in default configuration of blank project is used in DB transaction management.</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/resources/META-INF/spring/[projectName]-env.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sendChainedTransactionManager&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.data.transaction.ChainedTransactionManager&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg&gt;</span>
        <span class="nt">&lt;list&gt;</span>
            <span class="c">&lt;!-- (2) --&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;sendJmsTransactionManager&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;transactionManager&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for <code class="docutils literal"><span class="pre">ChainedTransactionManager</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify JMS and DB transaction manager.</div>
<div class="line">Transaction starts in a registered sequence and transaction is committed in the reverse sequence.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>Implementation example using the configuration given above is shown below.</p>
</div></blockquote>
<ul>
<li><p class="first"><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/java/com/example/domain/service/todo/ChainedTransactionalTodoServiceImpl.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service.todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jms.core.JmsMessagingTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span><span class="o">(</span><span class="s">&quot;sendChainedTransactionManager&quot;</span><span class="o">)</span>  <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChainedTransactionalTodoServiceImpl</span> <span class="kd">implements</span> <span class="n">ChainedTransactionalTodoService</span> <span class="o">{</span>
   <span class="nd">@Inject</span>
   <span class="n">JmsMessagingTemplate</span> <span class="n">jmsMessagingTemplate</span><span class="o">;</span>

   <span class="nd">@Inject</span>
   <span class="n">TodoSharedService</span> <span class="n">todoSharedService</span><span class="o">;</span>

   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendMessage</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
       <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Todo</span><span class="o">();</span>
       <span class="c1">// omitted</span>

       <span class="n">jmsMessagingTemplate</span><span class="o">.</span><span class="na">convertAndSend</span><span class="o">(</span><span class="s">&quot;jms/queue/TodoMessageQueue&quot;</span><span class="o">,</span> <span class="n">todo</span><span class="o">);</span> <span class="c1">// (2)</span>

       <span class="c1">// omitted</span>
       <span class="n">todoSharedService</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span> <span class="c1">// (3)</span>
   <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Control JMS and DB transactions by specifying <code class="docutils literal"><span class="pre">sendChainedTransactionManager</span></code> in <code class="docutils literal"><span class="pre">&#64;Transactional</span></code> annotation.</div>
<div class="line">For details of <code class="docutils literal"><span class="pre">&#64;Transactional</span></code> annotation, refer <a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html#service-transaction-management"><span class="std std-ref">Regarding transaction management</span></a> of <a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html"><span class="doc">Domain Layer Implementation</span></a>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Send messages synchronously.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Execute process associated with DB access. In this example, SharedService is executed along with DB update.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If it is necessary to manage multiple transactions together like JMS and DB, for business, a global transaction is considered.
For global transactions, refer “when transaction control (global transaction control) is necessary for multiple DB (multiple resources)” of <a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html#service-enable-transaction-management"><span class="std std-ref">Settings for using transaction management</span></a>.</p>
</div>
</li>
</ul>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="a-method-to-receive-messages-asynchronously">
<span id="jmshowtouseasyncreceivemessage"></span><h3><a class="toc-backref" href="#id23">8.2.2.3. A method to receive messages asynchronously</a><a class="headerlink" href="#a-method-to-receive-messages-asynchronously" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">As described in “message reception method” of <a class="reference internal" href="#jmsoverviewaboutjms"><span class="std std-ref">What is JMS</span></a>, asynchronous reception is generally used for receiving messages.</div>
<div class="line">Asynchronous reception can be achieved by registering a listener method assigned by <code class="docutils literal"><span class="pre">&#64;JmsListener</span></code> annotation for <code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code> responsible for asynchronous reception function</div>
<div class="line">Roles of listener method which perform s processing at the time of asynchronous reception are shown below.</div>
</div>
<ol class="arabic">
<li><div class="first line-block">
<div class="line"><strong>Provide a method to receive messages.</strong></div>
<div class="line">Messages can be received by executing a method assigned by <code class="docutils literal"><span class="pre">&#64;JmsListener</span></code> annotation.</div>
</div>
</li>
<li><div class="first line-block">
<div class="line"><strong>Call business process.</strong></div>
<div class="line">Business process is not implemented by listener method. It is delegated to Service method.</div>
</div>
</li>
<li><div class="first line-block">
<div class="line"><strong>Handle exceptions occurring in business logic.</strong></div>
<div class="line">Business exceptions and library exceptions occurred during normal operations are handled.</div>
</div>
</li>
<li><div class="first line-block">
<div class="line"><strong>Send process results as messages.</strong></div>
<div class="line">In the methods wherein response messages are required to be sent, process results of listener method and business logic should be sent as messages for a specified Destination, by using <code class="docutils literal"><span class="pre">org.springframework.jms.listener.adapter.JmsResponse</span></code>.</div>
</div>
</li>
</ol>
<div class="section" id="basic-asynchronous-reception">
<span id="jmshowtouselistenercontainer"></span><h4><a class="toc-backref" href="#id24">8.2.2.3.1. Basic asynchronous reception</a><a class="headerlink" href="#basic-asynchronous-reception" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">An asynchronous reception method using <code class="docutils literal"><span class="pre">&#64;JmsListener</span></code> annotation is explained.</div>
<div class="line">Following configuration is required for the implementation of asynchronous reception.</div>
</div>
<ul class="simple">
<li>Define JMS Namespace.</li>
<li>Enable <code class="docutils literal"><span class="pre">&#64;JmsListener</span></code> annotation.</li>
<li>Specify <code class="docutils literal"><span class="pre">&#64;JmsListener</span></code> annotation in the method of component managed by DI container.</li>
</ul>
<div class="line-block">
<div class="line">Respective detail implementation methods are described below.</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-web/src/main/resources/META-INF/spring/applicationContext.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xmlns:jms=</span><span class="s">&quot;http://www.springframework.org/schema/jms&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">        http://www.springframework.org/schema/jms http://www.springframework.org/schema/jms/spring-jms.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;jms:annotation-driven</span> <span class="nt">/&gt;</span>


    <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;jms:listener-container</span>
        <span class="na">factory-id=</span><span class="s">&quot;jmsListenerContainerFactory&quot;</span>
        <span class="na">destination-resolver=</span><span class="s">&quot;destinationResolver&quot;</span>
        <span class="na">concurrency=</span><span class="s">&quot;1&quot;</span><span class="nt">/&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="26%" />
<col width="64%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Attribute name</th>
<th class="head">Details</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>xmlns:jms</td>
<td><div class="first last line-block">
<div class="line">Define JMS Namespace.</div>
<div class="line">Specify <code class="docutils literal"><span class="pre">http://www.springframework.org/schema/jms</span></code> as a value.</div>
<div class="line">For details of JMS Namespace, refer <a class="reference external" href="http://docs.spring.io/autorepo/docs/spring-framework/4.3.14.RELEASE/spring-framework-reference/html/jms.html#jms-namespace">JMS Namespace Support</a>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td>xsi:schemaLocation</td>
<td><div class="first last line-block">
<div class="line">Specify URL of schema.</div>
<div class="line">Add <code class="docutils literal"><span class="pre">http://www.springframework.org/schema/jms</span></code> and <code class="docutils literal"><span class="pre">http://www.springframework.org/schema/jms/spring-jms.xsd</span></code> to values.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>-</td>
<td><div class="first last line-block">
<div class="line">Enable JMS related annotation function of <code class="docutils literal"><span class="pre">&#64;JmsListener</span></code> annotation and <code class="docutils literal"><span class="pre">&#64;SendTo</span></code> annotation by using <code class="docutils literal"><span class="pre">&lt;jms:annotation-driven</span> <span class="pre">/&gt;</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>-</td>
<td><div class="first line-block">
<div class="line">Configure <code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code> by assigning parameters to the factory which generate <code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code>, by using <code class="docutils literal"><span class="pre">&lt;jms:listener-container/&gt;</span></code>.</div>
<div class="line"><code class="docutils literal"><span class="pre">connection-factory</span></code> attribute which can specify a Bean of <code class="docutils literal"><span class="pre">ConnectionFactory</span></code> to be used, exists in the <code class="docutils literal"><span class="pre">&lt;jms:listener-container/&gt;</span></code>attribute. Default value of <code class="docutils literal"><span class="pre">connection-factory</span></code> attribute is <code class="docutils literal"><span class="pre">connectionFactory</span></code>.</div>
<div class="line">In this example, since Bean (Bean name is <code class="docutils literal"><span class="pre">connectionFactory</span></code>) of <code class="docutils literal"><span class="pre">ConnectionFactory</span></code> shown in <a class="reference internal" href="#jmshowtouseconnectionfactory"><span class="std std-ref">Configuration of ConnectionFactory</span></a> is used, <code class="docutils literal"><span class="pre">connection-factory</span></code> attribute is omitted.</div>
<div class="line"><code class="docutils literal"><span class="pre">&lt;jms:listener-container/&gt;</span></code> also consists of attributes other than introduced here.</div>
<div class="line">For details, refer <a class="reference external" href="http://docs.spring.io/spring/docs/4.3.14.RELEASE/spring-framework-reference/html/jms.html#jms-namespace-listener-container-tbl">Attributes of the JMS &lt;listener-container&gt; element</a>.</div>
</div>
<div class="last admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Since <code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code> is equipped with an independent cache function, <code class="docutils literal"><span class="pre">CachingConnectionFactory</span></code> should not be used in case of asynchronous receiving.
For details, refer <a class="reference external" href="http://docs.spring.io/autorepo/docs/spring-framework/4.3.14.RELEASE/javadoc-api/org/springframework/jms/listener/DefaultMessageListenerContainer.html">Javadoc of DefaultMessageListenerContainer</a>.
For above, <code class="docutils literal"><span class="pre">ConnectionFactory</span></code> defined in  <a class="reference internal" href="#jmshowtouseconnectionfactory"><span class="std std-ref">Configuration of ConnectionFactory</span></a> should be specified in <code class="docutils literal"><span class="pre">connection-factory</span></code> attribute of <code class="docutils literal"><span class="pre">&lt;jms:listener-container/&gt;</span></code>.</p>
</div>
</td>
</tr>
<tr class="row-even"><td>&#160;</td>
<td><code class="docutils literal"><span class="pre">concurrency</span></code></td>
<td><div class="first line-block">
<div class="line">Specify upper limit for parallel number of each listener method managed by <code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code>.</div>
<div class="line">Default value for <code class="docutils literal"><span class="pre">concurrency</span></code> attribute is 1.</div>
<div class="line">Lower limit and upper limit of parallel numbers can also be specified. For example, specify “5-10” when lower limit is 5 and upper limit is 10.</div>
<div class="line">When the parallel number of listener method has reached specified upper limit, parallel processing is not done and a “waiting” state is reached.</div>
<div class="line">A value should be specified as required.</div>
</div>
<div class="last admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When you want to specify parallel number in listener method unit, <code class="docutils literal"><span class="pre">concurrency</span></code> attribute of <code class="docutils literal"><span class="pre">&#64;JmsListener</span></code> annotation can be used.</p>
</div>
</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td><code class="docutils literal"><span class="pre">destination-resolver</span></code></td>
<td><div class="first last line-block">
<div class="line">Specify Bean name of <code class="docutils literal"><span class="pre">DestinationResolver</span></code> which is used to resolve Destination name at the time of asynchronous reception.</div>
<div class="line">For Bean definition of <code class="docutils literal"><span class="pre">DestinationResolver</span></code>, refer <a class="reference internal" href="#jmshowtousedestinationresolver"><span class="std std-ref">Configuration of DestinationResolver</span></a>.</div>
<div class="line">When <code class="docutils literal"><span class="pre">destination-resolver</span></code> attribute is not specified, <code class="docutils literal"><span class="pre">DynamicDestinationResolver</span></code> generated in <code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code> is used.</div>
</div>
</td>
</tr>
<tr class="row-even"><td>&#160;</td>
<td><code class="docutils literal"><span class="pre">factory-id</span></code></td>
<td><div class="first last line-block">
<div class="line">Specify name of <code class="docutils literal"><span class="pre">DefaultJmsListenerContainerFactory</span></code> which defines a Bean.</div>
<div class="line">Since <code class="docutils literal"><span class="pre">&#64;JmsListener</span></code> annotation refers Bean name <code class="docutils literal"><span class="pre">jmsListenerContainerFactory</span></code> as a default, it is recommended to consider Bean name as <code class="docutils literal"><span class="pre">jmsListenerContainerFactory</span></code> in case of a single <code class="docutils literal"><span class="pre">&lt;jms:listener-container/&gt;</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td><code class="docutils literal"><span class="pre">cache</span></code></td>
<td><div class="first line-block">
<div class="line">Specify cache level to determine cache targets like <code class="docutils literal"><span class="pre">Connection</span></code>, <code class="docutils literal"><span class="pre">Session</span></code> or <code class="docutils literal"><span class="pre">MessageConsumer</span></code> etc.</div>
<div class="line">Select any of the <code class="docutils literal"><span class="pre">connection</span></code>, <code class="docutils literal"><span class="pre">session</span></code>, <code class="docutils literal"><span class="pre">consumer</span></code>, <code class="docutils literal"><span class="pre">none</span></code>(do not cache) and <code class="docutils literal"><span class="pre">auto</span></code>(select automatically).</div>
<div class="line"><code class="docutils literal"><span class="pre">cache</span></code>attribute is omitted since <code class="docutils literal"><span class="pre">auto</span></code>is specified by default.</div>
</div>
<div class="last admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If <code class="docutils literal"><span class="pre">auto</span></code> is specified, the behaviour changes depending on whether the <code class="docutils literal"><span class="pre">transaction-manager</span></code> attribute is specified.
When it is specified, the behaviour is same as when <code class="docutils literal"><span class="pre">none</span></code>is specified. When it is not specified, the behaviour is same as when <code class="docutils literal"><span class="pre">consumer</span></code> is specified.
This is because <code class="docutils literal"><span class="pre">transaction-manager</span></code> attribute is specified only while using JTA transaction.
When <code class="docutils literal"><span class="pre">Connection</span></code> or <code class="docutils literal"><span class="pre">Session</span></code> are not pooled in application server, specifying <code class="docutils literal"><span class="pre">consumer</span></code> should be considered for performance enhancement.</p>
</div>
</td>
</tr>
</tbody>
</table>
<p>Messages can be asynchronously received from specified Destination by specifying <code class="docutils literal"><span class="pre">&#64;JmsListener</span></code> annotation in the component method managed by DI container.
Implementation method is as shown below.</p>
</div></blockquote>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-web/src/main/java/com/example/listener/todo/TodoMessageListener.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.listener.todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.jms.annotation.JmsListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="o">;</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoMessageListener</span> <span class="o">{</span>

   <span class="nd">@JmsListener</span><span class="o">(</span><span class="n">destination</span> <span class="o">=</span> <span class="s">&quot;jms/queue/TodoMessageQueue&quot;</span><span class="o">)</span>   <span class="c1">// (1)</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">receive</span><span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// omitted</span>
   <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify <code class="docutils literal"><span class="pre">&#64;JmsListener</span></code> annotation for a method, for asynchronous reception. Specify Destination name for receiving in <code class="docutils literal"><span class="pre">destination</span></code> attribute.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>A list of main attributes of <code class="docutils literal"><span class="pre">&#64;JmsListener</span></code> annotation is shown below.
For details and other attributes, refer <a class="reference external" href="http://docs.spring.io/spring-framework/docs/4.3.14.RELEASE/javadoc-api/org/springframework/jms/annotation/JmsListener.html#destination--">Javadoc of &#64;JmsListener annotation</a>.</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Fields</th>
<th class="head">Details</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">destination</span></code></td>
<td><div class="first last line-block">
<div class="line">Specify Destination to be received.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">containerFactory</span></code></td>
<td><div class="first last line-block">
<div class="line">Specify Bean name of <code class="docutils literal"><span class="pre">DefaultJmsListenerContainerFactory</span></code>which manages the listener method.</div>
<div class="line">Default is <code class="docutils literal"><span class="pre">jmsListenerContainerFactory</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">selector</span></code></td>
<td><div class="first last line-block">
<div class="line">Specify a message selector which acts as a condition for restricting the message to be received.</div>
<div class="line">When the value is not explicitly specified, default is “”(blank character) and all the messages can be received.</div>
<div class="line">For how to use, refer <a class="reference internal" href="#jmshowtousemessageselectorforasyncreceive"><span class="std std-ref">When messages which are asynchronously received are to be restricted</span></a>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">concurrency</span></code></td>
<td><div class="first last line-block">
<div class="line">Specify upper limit of parallel numbers for listener method.;</div>
<div class="line">Default value for <code class="docutils literal"><span class="pre">concurrency</span></code> attribute is 1.</div>
<div class="line">Lower limit and upper limit of parallel numbers can be specified. For example, specify “5-10” when lower limit is 5 and upper limit is 10.</div>
<div class="line">When the parallel number of listener method has reached specified upper limit, parallel processing is not done and a “waiting” state is reached.</div>
<div class="line">Value should be specified as required.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="fetching-header-information-of-messages">
<span id="jmshowtouselistenercontainergetheader"></span><h4><a class="toc-backref" href="#id25">8.2.2.3.2. Fetching header information of messages</a><a class="headerlink" href="#fetching-header-information-of-messages" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">When the header information of messages is to be used in the listener method such as sending process results of asynchronous reception to the Destination specified on Producer side (Value of header attribute <code class="docutils literal"><span class="pre">JMSReplyTo</span></code>), <code class="docutils literal"><span class="pre">&#64;org.springframework.messaging.handler.annotation.Header</span></code> annotation is used.</div>
<div class="line">Implementation example is shown below.</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-web/src/main/java/com/example/listener/todo/TodoMessageListener.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@JmsListener</span><span class="o">(</span><span class="n">destination</span> <span class="o">=</span> <span class="s">&quot;jms/queue/TodoMessageQueue&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">JmsResponse</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">receiveAndResponse</span><span class="o">(</span>
        <span class="n">Todo</span> <span class="n">todo</span><span class="o">,</span> <span class="nd">@Header</span><span class="o">(</span><span class="s">&quot;jms_replyTo&quot;</span><span class="o">)</span> <span class="n">Destination</span> <span class="n">storeResponseMessageQueue</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (1)</span>

    <span class="c1">// omitted</span>

     <span class="k">return</span> <span class="n">JmsResponse</span><span class="o">.</span><span class="na">forDestination</span><span class="o">(</span><span class="n">todo</span><span class="o">,</span> <span class="n">storeResponseMessageQueue</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify <code class="docutils literal"><span class="pre">&#64;Header</span></code> annotation to fetch value of header attribute <code class="docutils literal"><span class="pre">JMSReplyTo</span></code> of receiving message.</div>
<div class="line">For a key specified while fetching JMS standard header attribute, refer <a class="reference external" href="https://docs.spring.io/spring/docs/4.3.14.RELEASE/javadoc-api/constant-values.html#org.springframework.jms.support.JmsHeaders.CORRELATION_ID">JmsHeaders constants definition</a>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="process-results-after-asynchronous-reception-are-sent-as-messages">
<span id="jmshowtouselistenercontainerresendmessage"></span><h4><a class="toc-backref" href="#id26">8.2.2.3.3. Process results after asynchronous reception are sent as messages</a><a class="headerlink" href="#process-results-after-asynchronous-reception-are-sent-as-messages" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">A method which sends the process results of method defined in <code class="docutils literal"><span class="pre">&#64;JmsListener</span></code> annotation, to Destination as a response message.</div>
<div class="line">Following 2 methods can be listed for specifying transmission destination of process results.</div>
</div>
<ul class="simple">
<li>When transmission destination of process results is specified statically</li>
<li>When transmission destination of process results is specified dynamically</li>
</ul>
<p>Respective descriptions are as below.</p>
<ul>
<li><dl class="first docutils">
<dt><strong>When transmission destination of process results is specified statically</strong></dt>
<dd><div class="first last line-block">
<div class="line">Process results can be sent as messages to a fixed destination by defining <code class="docutils literal"><span class="pre">&#64;SendTo</span></code> annotation which specifies a destination, for a method defined by <code class="docutils literal"><span class="pre">&#64;JmsListener</span></code> annotation.</div>
<div class="line">Implementation example is as shown below.</div>
</div>
</dd>
</dl>
</li>
</ul>
<blockquote>
<div><ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-web/src/main/java/com/example/listener/todo/TodoMessageListener.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@JmsListener</span><span class="o">(</span><span class="n">destination</span> <span class="o">=</span> <span class="s">&quot;jms/queue/TodoMessageQueue&quot;</span><span class="o">)</span>
<span class="nd">@SendTo</span><span class="o">(</span><span class="s">&quot;jms/queue/ResponseMessageQueue&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="n">Todo</span> <span class="nf">receiveMessageAndSendTo</span><span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="o">)</span> <span class="o">{</span>

    <span class="c1">// omitted</span>
    <span class="k">return</span> <span class="n">todo</span><span class="o">;</span> <span class="c1">// (2)</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Default transmission destination of process results can be specified by defining <code class="docutils literal"><span class="pre">&#64;SendTo</span></code> annotation.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Return data to be sent to Destination defined in <code class="docutils literal"><span class="pre">&#64;SendTo</span></code> annotation.</div>
<div class="line">Permissible return value types are the classes which implement <code class="docutils literal"><span class="pre">org.springframework.messaging.Message</span></code>, <code class="docutils literal"><span class="pre">javax.jms.Message</span></code>, <code class="docutils literal"><span class="pre">String</span></code>, <code class="docutils literal"><span class="pre">byte</span></code> array, <code class="docutils literal"><span class="pre">Map</span></code> and <code class="docutils literal"><span class="pre">Serializable</span></code> interface.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div></blockquote>
<ul class="simple">
<li><strong>When transmission destination of process results is changed dynamically</strong></li>
</ul>
<blockquote>
<div><div class="line-block">
<div class="line">When transmission destination is to be changed dynamically, <code class="docutils literal"><span class="pre">forDestination</span></code> or <code class="docutils literal"><span class="pre">forQueue</span></code> methods of <code class="docutils literal"><span class="pre">JmsResponse</span></code> class are used</div>
<div class="line">Process results can be sent to any Destination by dynamically changing Destination for sending or Destination name. Implementation example is as shown below.</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-web/src/main/java/com/example/listener/todo/TodoMessageListener.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@JmsListener</span><span class="o">(</span><span class="n">destination</span> <span class="o">=</span> <span class="s">&quot;jms/queue/TodoMessageQueue&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">JmsResponse</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">receiveMessageJmsResponse</span><span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="o">)</span> <span class="o">{</span>

    <span class="c1">// omitted</span>

    <span class="n">String</span> <span class="n">resQueue</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">todo</span><span class="o">.</span><span class="na">isFinished</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">resQueue</span> <span class="o">=</span> <span class="s">&quot;jms/queue/FinihedTodoMessageQueue&quot;</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">resQueue</span> <span class="o">=</span> <span class="s">&quot;jms/queue/ActiveTodoMessageQueue&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">JmsResponse</span><span class="o">.</span><span class="na">forQueue</span><span class="o">(</span><span class="n">todo</span><span class="o">,</span> <span class="n">resQueue</span><span class="o">);</span> <span class="c1">// (1)</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">When Queue for transmission is to be changed in accordance with the process details, <code class="docutils literal"><span class="pre">forDestination</span></code> or <code class="docutils literal"><span class="pre">forQueue</span></code> methods of <code class="docutils literal"><span class="pre">JmsResponse</span></code> class are used.</div>
<div class="line">In this example, messages are sent from Destination name by using <code class="docutils literal"><span class="pre">forQueue</span></code> method.</div>
</div>
<div class="last admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When <code class="docutils literal"><span class="pre">forQueue</span></code> method of <code class="docutils literal"><span class="pre">JmsResponse</span></code> class is used, Destination name is used as a string.
For resolving destination name, <code class="docutils literal"><span class="pre">DestinationResolver</span></code> specified in <code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code> is used.</p>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>When transmission destination of process results is specified on Producer side</strong></p>
<p>Using the implementation below, messages of process results can be sent to any destination specified on Producer side.</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Implementation location</th>
<th class="head">Implementation details</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">Producer side</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify Destination in header attribute <code class="docutils literal"><span class="pre">JMSReplyTo</span></code> of messages in accordance with JMS standards.</div>
<div class="line">For editing of header attribute, refer <a class="reference internal" href="#jmshowtousesettingforsendwithheader"><span class="std std-ref">When message header is to be edited and sent synchronously</span></a>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">Consumer side</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Return objects which send a message.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p class="last">Header attribute <code class="docutils literal"><span class="pre">JMSReplyTo</span></code> is given priority over the default Destination specified on the Consumer side.
For details, refer <a class="reference external" href="http://docs.spring.io/spring/docs/4.3.14.RELEASE/spring-framework-reference/htmlsingle/#jms-annotated-response">Response management</a>.</p>
</div>
</div>
<div class="section" id="when-messages-which-are-asynchronously-received-are-to-be-restricted">
<span id="jmshowtousemessageselectorforasyncreceive"></span><h4><a class="toc-backref" href="#id27">8.2.2.3.4. When messages which are asynchronously received are to be restricted</a><a class="headerlink" href="#when-messages-which-are-asynchronously-received-are-to-be-restricted" title="Permalink to this headline">¶</a></h4>
<p>The messages to be received can be restricted by specifying a message selector at the time of receiving.</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-web/src/main/java/com/example/listener/todo/TodoMessageListener.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@JmsListener</span><span class="o">(</span><span class="n">destination</span> <span class="o">=</span> <span class="s">&quot;jms/queue/MessageQueue&quot;</span> <span class="o">,</span> <span class="n">selector</span> <span class="o">=</span> <span class="s">&quot;TodoStatus = &#39;deleted&#39;&quot;</span><span class="o">)</span>    <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">receive</span><span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// omitted</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Conditions for receiving can be set by using <code class="docutils literal"><span class="pre">selector</span></code> attribute.</div>
<div class="line"><code class="docutils literal"><span class="pre">TodoStatus</span></code> of header attribute receives only <code class="docutils literal"><span class="pre">deleted</span></code> messages.</div>
<div class="line">Message selector is based on subset of SQL92 conditional expression syntax.</div>
<div class="line">For details, refer <a class="reference external" href="http://docs.oracle.com/javaee/7/api/javax/jms/Message.html">Message Selectors</a>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="input-check-for-the-messages-which-are-received-asynchronously">
<span id="jmshowtousevalidationforasyncreceive"></span><h4><a class="toc-backref" href="#id28">8.2.2.3.5. Input check for the messages which are received asynchronously</a><a class="headerlink" href="#input-check-for-the-messages-which-are-received-asynchronously" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">An input check must be carried out to ensure that the messages which retain invalid data are not processed in the business logic from a security viewpoint.</div>
<div class="line">Input check is implemented in Service method by using Method Validation and the exception at the time of input check error is handled by the listener method.</div>
<div class="line">This is done to avoid the occurrence of unnecessary rollback process for the exception occurring at the time of input check error, while performing transaction control. For transaction control, refer <a class="reference internal" href="#jmshowtousetransactionmanagementforasyncreceive"><span class="std std-ref">Transaction control</span></a>.</div>
<div class="line">For details of how to configure and implement Method Validation, refer <a class="reference internal" href="../WebApplicationDetail/Validation.html#methodvalidation"><span class="std std-ref">Method Validation</span></a> of <a class="reference internal" href="../WebApplicationDetail/Validation.html"><span class="doc">Input Validation</span></a>.</div>
<div class="line">An implementation example is shown below wherein input check is performed for <code class="docutils literal"><span class="pre">Todo</span></code> object shown in <a class="reference internal" href="#jmshowtousesettingforsyncsend"><span class="std std-ref">Basic synchronous transmission</span></a>.</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/java/com/example/domain/service/todo/TodoServiceImpl.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service.todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.Valid</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="o">;</span>

<span class="nd">@Validated</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoService</span> <span class="o">{</span>

    <span class="kt">void</span> <span class="nf">updateTodo</span><span class="o">(</span><span class="nd">@Valid</span> <span class="n">Todo</span> <span class="n">todo</span><span class="o">);</span> <span class="c1">// (2)</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Declare the interface as a target for input check by attaching a <code class="docutils literal"><span class="pre">&#64;Validated</span></code> annotation.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify a constraint annotation of Bean Validation as an argument for the method.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/java/com/example/domain/model/Todo.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.model</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Null</span><span class="o">;</span>

<span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Todo</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1L</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Null</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">description</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">finished</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getDescription</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">description</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDescription</span><span class="o">(</span><span class="n">String</span> <span class="n">description</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isFinished</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">finished</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFinished</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">finished</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">finished</span> <span class="o">=</span> <span class="n">finished</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define input check of JavaBean in Bean Validation.</div>
<div class="line">In this example, <code class="docutils literal"><span class="pre">&#64;Null</span></code> annotation is set as an example.</div>
<div class="line">For details, refer “<a class="reference internal" href="../WebApplicationDetail/Validation.html"><span class="doc">Input Validation</span></a>”.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-web/src/main/java/com/example/listener/todo/TodoMessageListener.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="n">TodoService</span> <span class="n">todoService</span><span class="o">;</span>

<span class="nd">@JmsListener</span><span class="o">(</span><span class="n">destination</span> <span class="o">=</span> <span class="s">&quot;jms/queue/MessageQueue&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">receive</span><span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">todoService</span><span class="o">.</span><span class="na">updateTodo</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span> <span class="c1">// (1)</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ConstraintViolationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (2)</span>
        <span class="c1">// omitted</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Implement Service method which performs input check.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Capture <code class="docutils literal"><span class="pre">ConstraintViolationException</span></code> which occurs at the time of constraint violation.</div>
<div class="line">Any process can be performed after capturing the exception.</div>
<div class="line">For examples of sending messages to another Queue like using a Queue for storing logical error messages, refer <a class="reference internal" href="#jmshowtouseexceptionhandlingforasyncreceive"><span class="std std-ref">Exception handling at the time of asynchronous reception</span></a>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="jmshowtousetransactionmanagementforasyncreceive">
<span id="id1"></span><h4><a class="toc-backref" href="#id29">8.2.2.3.6. Transaction control</a><a class="headerlink" href="#jmshowtousetransactionmanagementforasyncreceive" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">A transaction control function is used when data consistency is required to be guaranteed.</div>
<div class="line"><code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code>of Spring JMS used in asynchronous reception incorporates JMS transaction management system. The function can be switched with <code class="docutils literal"><span class="pre">acknowledge</span></code>attribute of <code class="docutils literal"><span class="pre">listener-container</span></code>. Implementation example while using the same is shown below.</div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When message returns to Queue, it is asynchronously received once again. Since the cause of error is not resolved, the operations of rollback and asynchronous reception are repeated.
A threshold value for number of resends after rollback can be set depending on JMS provider and when resend count exceeds the threshold value, the message is stored in Dead Letter Queue.</p>
</div>
</div></blockquote>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-web/src/main/resources/META-INF/spring/applicationContext.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;jms:listener-container</span>
    <span class="na">factory-id=</span><span class="s">&quot;jmsListenerContainerFactory&quot;</span>
    <span class="na">destination-resolver=</span><span class="s">&quot;destinationResolver&quot;</span>
    <span class="na">concurrency=</span><span class="s">&quot;1&quot;</span>
    <span class="na">error-handler=</span><span class="s">&quot;jmsErrorHandler&quot;</span>
    <span class="na">acknowledge=</span><span class="s">&quot;transacted&quot;</span><span class="nt">/&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="26%" />
<col width="64%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Attribute name</th>
<th class="head">Details</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><code class="docutils literal"><span class="pre">cache</span></code></td>
<td><div class="first last line-block">
<div class="line">Specify cache level to determine cache targets such as <code class="docutils literal"><span class="pre">Connection</span></code>, <code class="docutils literal"><span class="pre">Session</span></code> or <code class="docutils literal"><span class="pre">MessageConsumer</span></code>.</div>
<div class="line">Default is <code class="docutils literal"><span class="pre">auto</span></code>.</div>
<div class="line">As described earlier in <a class="reference internal" href="#jmshowtouselistenercontainer"><span class="std std-ref">Basic asynchronous reception</span></a>, <code class="docutils literal"><span class="pre">consumer</span></code> is specified when connection is not pooled in the application server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td><code class="docutils literal"><span class="pre">acknowledge</span></code></td>
<td><div class="first last line-block">
<div class="line">Specify <code class="docutils literal"><span class="pre">transacted</span></code>in acknowledge mode to enable transaction. Default is <code class="docutils literal"><span class="pre">auto</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Since <code class="docutils literal"><span class="pre">Connection</span></code> or <code class="docutils literal"><span class="pre">Session</span></code> caching in the application is likely to be prohibited depending on the application server, enabling and disabling of cache should be determined in accordance with the specifications of application server to be used.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>When you want to use asynchronous reception and synchronous transmission/reception together, and manage it with a single transaction, <code class="docutils literal"><span class="pre">connection-factory</span></code>attribute of <code class="docutils literal"><span class="pre">jms:listener-container</span></code>and <code class="docutils literal"><span class="pre">ConnectionFactory</span></code>instance specified in <code class="docutils literal"><span class="pre">connectionFactory</span></code>property of <code class="docutils literal"><span class="pre">JmsTemplate</span></code>should be made identical. Accordingly, since Spring shares <code class="docutils literal"><span class="pre">Session</span></code>to be used for asynchronous reception and synchronous transmission/reception, it is considered as a single transaction.
At that time, following options can be considered to enable caching in both <code class="docutils literal"><span class="pre">jms:listener-container</span></code>and <code class="docutils literal"><span class="pre">JmsTemplate</span></code>.</p>
<ul class="simple">
<li>Leave caching of JMS related resource to AP server products and use the object fetched via JNDI lookup for both asynchronous reception and synchronous transmission/reception.</li>
<li>If MOM product has cache function of <code class="docutils literal"><span class="pre">connectionfactory</span></code>, use it as it is for both asynchronous reception and synchronous transmission/reception.</li>
<li>Use <code class="docutils literal"><span class="pre">org.springframework.jms.connection.CachingConnectionFactory</span></code>as it is for both asynchronous reception and synchronous transmission/reception.</li>
</ul>
<p class="last">In either of these cases, <code class="docutils literal"><span class="pre">none</span></code>should be specified in <code class="docutils literal"><span class="pre">cache</span></code>of <code class="docutils literal"><span class="pre">listener-container</span></code>.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>A method which performs exception handling other than roll back process in case of specific exceptions</strong></p>
<p class="last">When transaction control is enabled, the message returns to Queue due to roll back if the exception occurred in input check is thrown without getting captured.
Since listener method asynchronously receives the message again which has returned in Queue, the sequence asynchronous reception Error occurrence Rollback is repeated a number of times for JMS provider configuration.
In case of an error for which the cause of the error is not resolved even after retry, the error handling is done so as not to throw an exception from listener method after capturing, to restrain futile processes mentioned above.
For details, refer <a class="reference internal" href="#jmshowtouseexceptionhandlingforasyncreceive"><span class="std std-ref">Exception handling at the time of asynchronous reception</span></a>.</p>
</div>
<p>In the application wherein DB transaction control is required, a transaction control policy must be determined after reviewing the relation between JMS and DB transactions based on business requirements.
Following methods can be considered for link transactions of JMS and DB by asynchronous reception.</p>
<ol class="arabic simple">
<li>A method which use global transactions by JTA</li>
<li>A method which use “Best Effort 1 Phase Commit”</li>
<li>A method which individually specifies JMS and DB transactions</li>
</ol>
<p>Among these, using “A method to specify JMS and DB transactions separately” should be considered for the reasons described below.
As introduced in transaction management of synchronous transmission (<a class="reference internal" href="#jmshowtousesettingforsyncsendtransactionmanagement"><span class="std std-ref">Transaction control</span></a>) as well, global transaction by JTA requires overheads owing to protocol characteristics. In order to resolve this, a transaction management method was introduced which uses “Best Effort 1 Phase Commit” for synchronous transmission, however, it is not recommended in asynchronous reception since it results in transactions with incorrect framework.
Generally, JMS transaction boundary is positioned on the outer side than using DB transaction boundary from the viewpoint of recovery. <code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code>of Spring consists of its own transaction management system, hence when you attempt to achieve “Best Effort 1 Phase Commit” by using <code class="docutils literal"><span class="pre">transaction-manager</span></code> attribute of <code class="docutils literal"><span class="pre">jms:listener-container</span></code>in the settings of JTA, DB transaction boundary is positioned outside JMS transaction boundary. As a result, DB transaction is likely to be rolled back even though the message received asynchronously is processed normally.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>When transaction process results are not returned to JMS provider like for example when connection with JMS provider is lost after receiving the message</strong></p>
<blockquote class="last">
<div>When transaction process results are not returned to JMS provider like for example when connection with JMS provider is lost after receiving the message, transaction handling depends on JMS provider. Therefore, <strong>design considering loss of received message, reprocessing of message due to rollback etc.</strong>. Particularly, when the loss of message cannot be permitted, it is necessary <strong>to provide a system to compensate for loss of message or to consider the use of global transaction etc.</strong>.</div></blockquote>
</div>
<p>In this guideline, global transaction is not used. It is recommended to leave JMS transactions to transaction management implemented internally by Spring JMS as described above and to manage DB transactions by <code class="docutils literal"><span class="pre">transactionManager</span></code>defined in default settings of blank project. Implementation example is shown below.</p>
<blockquote>
<div><ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-web/src/main/java/com/example/listener/todo/TodoMessageListener.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.listener.todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jms.annotation.JmsListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.service.todo.TodoService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="o">;</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoMessageListener</span> <span class="o">{</span>
    <span class="nd">@Inject</span>
    <span class="n">TodoService</span> <span class="n">todoService</span><span class="o">;</span>

    <span class="nd">@JmsListener</span><span class="o">(</span><span class="n">destination</span> <span class="o">=</span> <span class="s">&quot;TransactedQueue&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">receiveTransactedMessage</span><span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">todoService</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/java/com/example/domain/service/todo/TodoServiceImpl.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service.todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="o">;</span>

<span class="nd">@Transactional</span> <span class="c1">// (2)</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// omitted</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define <code class="docutils literal"><span class="pre">&#64;JmsListener</span></code> annotation and specify <code class="docutils literal"><span class="pre">DefaultJmsListenerContainerFactory</span></code> which enables transaction control of JMS.</div>
<div class="line">Since <code class="docutils literal"><span class="pre">&#64;JmsListener</span></code> annotation refers to Bean name <code class="docutils literal"><span class="pre">jmsListenerContainerFactory</span></code> as a default, <code class="docutils literal"><span class="pre">containerFactory</span></code> attribute is omitted.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define transaction boundary of DB.</div>
<div class="line">Since value is omitted, it refers to Bean name <code class="docutils literal"><span class="pre">transactionManager</span></code>by default. Bean name of <code class="docutils literal"><span class="pre">JmsTransactionManager</span></code>and <code class="docutils literal"><span class="pre">ChainedTransactionManager</span></code> are specified in synchronous transmission however since it is left to Spring in asynchronous reception, it refers to DB transaction manager.</div>
<div class="line">For details of <code class="docutils literal"><span class="pre">&#64;Transactional</span></code> annotation, refer <a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html#service-transaction-management"><span class="std std-ref">Regarding transaction management</span></a> of <a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html"><span class="doc">Domain Layer Implementation</span></a>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Nesting sequence for transaction boundary depends on the business requirements and JMS provider is often used for linking with external systems.
In such a case, JMS transaction boundary is kept outside DB transaction boundary and recovery becomes easier when inward DB transaction is completed earlier.
When DB transaction is committed and JMS transaction is rolled back, the message returns to the Queue. Hence the same message is processed again.
It should be designed so as to allow DB update process to be re-tried at the time of reexecution of business process.</p>
</div>
</div></blockquote>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><p>Behaviour when an application is created in accordance with the configuration and implementation example above is explained.</p>
<ul class="simple">
<li><strong>When processing of listener method is successfully completed</strong></li>
</ul>
<blockquote>
<div><div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code>starts and commits JMS transaction whereas DB transaction manager starts and commits DB transaction.</div>
</div>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../../_images/JMSDBTransactionAllCommit.png"><img alt="JMS/DB Transaction" src="../../_images/JMSDBTransactionAllCommit.png" style="width: 80%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Start JMS transaction.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Start DB transaction.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Commit DB transaction and terminate DB transaction.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Commit listener method successfully.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Commit JMS transaction and terminate JMS transaction.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div></blockquote>
<ul class="simple">
<li><strong>When an unexpected exception occurs in business logic</strong></li>
</ul>
<blockquote>
<div><p>When exception occurs in the service, both JMS transaction and DB transaction are rolled back.</p>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../../_images/JMSDBTransactionAllRollback.png"><img alt="JMS/DB Transaction" src="../../_images/JMSDBTransactionAllRollback.png" style="width: 80%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Start JMS transaction.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Start DB transaction.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">An unexpected exception occurs in the business logic.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Roll back DB transaction and terminate DB transaction.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Roll back JMS transaction and terminate JMS transaction.</div>
<div class="line">Since JMS transaction is rolled back, the message is returned to the Queue.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div></blockquote>
<ul class="simple">
<li><strong>When connection with JMS provider is lost after receiving the message and only DB transaction is committed</strong></li>
</ul>
<blockquote>
<div><p>When the process involving asynchronous reception is not managed by global transaction, DB transaction and JMS transaction will be committed separately,
there is a possibility that inconsistency may occur in JMS and DB state. Specifically, it is applicable to following cases.</p>
<ul class="simple">
<li>When discontinuation of JMS connection is not detected, DB update process is continued and committed</li>
<li>When an exception occurs after committing DB transaction and prior to committing JMS transaction</li>
</ul>
<p>In such a case, same message is likely to get processed again once JMS transaction is rolled back and it may result in sending the message with same contents for multiple times. With this background, even when same message is received multiple times, data integrity must be ensured.
As a countermeasure, a method can be used wherein the information for uniquely identifying a request is recorded, and included in <code class="docutils literal"><span class="pre">JMSMessageID</span></code>, or <code class="docutils literal"><span class="pre">Property</span></code>or <code class="docutils literal"><span class="pre">Body</span></code>.
This means that when the message is received, it is compared with information recorded in the past, and the processing is divided according to process status.
Note that, there are differences in the events that can be handled according to information to be used, as shown below.</p>
<ul class="simple">
<li>When <code class="docutils literal"><span class="pre">JMSMessageID</span></code>is to be recorded, it can be done only for handling duplicate messages when the message is rolled back.</li>
<li>When a part of <code class="docutils literal"><span class="pre">Property</span></code> or <code class="docutils literal"><span class="pre">Body</span></code>is to be recorded, it can handle duplicate messages during an abnormality when a message having same meaning with respect to operations is sent for multiple times, besides when the message is rolled back.</li>
</ul>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../../_images/JMSDBTransactionUnexpectedError.png"><img alt="JMS/DB Transaction" src="../../_images/JMSDBTransactionUnexpectedError.png" style="width: 80%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Start JMS transaction.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Start DB transaction.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Commit DB transaction and terminate DB transaction.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">An unexpected error occurs like loss of connection with JMS provider before committing JMS transaction.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JMS transaction commit fails.</div>
<div class="line">Hence, a system to ensure consistency must be provided for loss of messages etc.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When it is necessary to stringently control multiple transactions like JMS and DB by avoiding events given above, use of global transaction is considered.
For global transaction, refer various product manuals.</p>
</div>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="exception-handling-at-the-time-of-asynchronous-reception">
<span id="jmshowtouseexceptionhandlingforasyncreceive"></span><h4><a class="toc-backref" href="#id30">8.2.2.3.7. Exception handling at the time of asynchronous reception</a><a class="headerlink" href="#exception-handling-at-the-time-of-asynchronous-reception" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">While performing transaction control, exceptions must be handled considering the rollback process.</div>
<div class="line">For details of transaction control, refer <a class="reference internal" href="#jmshowtousetransactionmanagementforasyncreceive"><span class="std std-ref">Transaction control</span></a>.</div>
<div class="line">Exception handling of JMS is classified in 2 patterns given below based on the objective.</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils" id="id5">
<caption><span class="caption-text"><strong>Table-Exception handling patterns</strong></span><a class="headerlink" href="#id5" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="40%" />
<col width="25%" />
<col width="10%" />
<col width="15%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Objective of handling</th>
<th class="head">An example of exception for handling</th>
<th class="head">Handling method</th>
<th class="head">Handling unit</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When exceptions occurring in business layer are to be individually handled</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Business exception like input check error</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Listener method</div>
<div class="line">(try-catch)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Listener method unit</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When the exceptions thrown by listener method are to be handled uniformly</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">System exceptions like input output error etc</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ErrorHandler</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JMSListenerContainer unit</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul>
<li><p class="first"><strong>When exceptions occurred in the business layer are to be handled individually</strong></p>
<div class="line-block">
<div class="line">The exceptions occurring in the business layer like “message contents are invalid” are trapped (try-catch) by listener method and handled by listener method unit.</div>
<div class="line">While performing transaction control, since exceptions must be thrown in <code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code> for the cases which require rollback, the captured exception must be thrown again.</div>
<div class="line">Implementation example is shown below.</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-web/src/main/java/com/example/listener/todo/TodoMessageListener.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="n">TodoService</span> <span class="n">todoService</span><span class="o">;</span>

<span class="nd">@JmsListener</span><span class="o">(</span><span class="n">destination</span> <span class="o">=</span> <span class="s">&quot;jms/queue/TodoMessageQueue&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">JmsResponse</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">receiveTodo</span><span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">todoService</span><span class="o">.</span><span class="na">insertTodo</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">BusinessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">JmsResponse</span><span class="o">.</span><span class="na">forQueue</span><span class="o">(</span><span class="n">todo</span><span class="o">,</span> <span class="s">&quot;jms/queue/ErrorMessageQueue&quot;</span><span class="o">);</span> <span class="c1">// (1)</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// (2)</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">An object can be sent to a Queue for storing a logical error message by using <code class="docutils literal"><span class="pre">forQueue</span></code> method of <code class="docutils literal"><span class="pre">JmsResponse</span></code> class.</div>
<div class="line">In this example, since <code class="docutils literal"><span class="pre">BusinessException</span></code> which outputs the log in AOP is captured, log output process is not described explicitly. However, exceptions must be handled so as not to eliminate the cause of exception.</div>
<div class="line">When the messages are to be processed after roll back, by performing transaction control, the exception thus captured must be thrown.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When the messages are not sent, set return value to <code class="docutils literal"><span class="pre">null</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
<li><p class="first"><strong>When the exceptions thrown by listener method are to be handled uniformly</strong></p>
<div class="line-block">
<div class="line">While commonly handling exceptions, implementation class of <code class="docutils literal"><span class="pre">ErrorHandler</span></code> defined in <code class="docutils literal"><span class="pre">error-handler</span></code> attribute of <code class="docutils literal"><span class="pre">&lt;jms:listener-container/&gt;</span></code> is used.</div>
<div class="line">Configuration method is shown below.</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-web/src/main/resources/META-INF/spring/applicationContext.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;jms:listener-container</span>
    <span class="na">factory-id=</span><span class="s">&quot;jmsListenerContainerFactory&quot;</span>
    <span class="na">destination-resolver=</span><span class="s">&quot;destinationResolver&quot;</span>
    <span class="na">concurrency=</span><span class="s">&quot;1&quot;</span>
    <span class="na">error-handler=</span><span class="s">&quot;jmsErrorHandler&quot;</span>
    <span class="na">cache=</span><span class="s">&quot;consumer&quot;</span>
    <span class="na">acknowledge=</span><span class="s">&quot;transacted&quot;</span><span class="nt">/&gt;</span>

<span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;jmsErrorHandler&quot;</span>
    <span class="na">class=</span><span class="s">&quot;com.example.domain.service.todo.JmsErrorHandler&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean name of error handling class in <code class="docutils literal"><span class="pre">error-handler</span></code> attribute of <code class="docutils literal"><span class="pre">&lt;jms:listener-container/&gt;</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for error handling class.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>Implementation method is as shown below.</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-web/src/main/java/com/example/listener/todo/JmsErrorHandler.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.listener.todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.util.ErrorHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.SystemException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JmsErrorHandler</span> <span class="kd">implements</span> <span class="n">ErrorHandler</span> <span class="o">{</span>  <span class="c1">// (1)</span>

   <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleError</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (2)</span>
        <span class="c1">// omitted</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getCause</span><span class="o">()</span> <span class="k">instanceof</span> <span class="n">SystemException</span><span class="o">)</span> <span class="o">{</span>  <span class="c1">// (3)</span>

            <span class="c1">// omitted system error handling</span>

        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// omitted error handling</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create an error handling class which implements <code class="docutils literal"><span class="pre">ErrorHandler</span></code> interface.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Exception occurring in the listener method is wrapped in <code class="docutils literal"><span class="pre">org.springframework.jms.listener.adapter.ListenerExecutionFailedException</span></code> and passed as an argument.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Determine any exception class and implement error handling associated with the exception.</div>
<div class="line"><code class="docutils literal"><span class="pre">t.getCause()</span></code> must be executed to fetch the exception occurred in the application.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="a-method-wherein-the-messages-are-synchronously-received">
<span id="jmshowtousesyncreceivemessage"></span><h3><a class="toc-backref" href="#id31">8.2.2.4. A method wherein the messages are synchronously received</a><a class="headerlink" href="#a-method-wherein-the-messages-are-synchronously-received" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Synchronous reception in JMS provider is achieved by using <code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>.</div>
<div class="line">Messages can be received within any timing by using synchronous reception.</div>
<div class="line">Architecture should be determined after thoroughly examining the implementation method which does not use synchronous reception.</div>
</div>
<div class="line-block">
<div class="line">Configuration of Bean definition file for synchronous reception is shown below.</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/resources/META-INF/spring/[projectName]-infra.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;cachingConnectionFactory&quot;</span>
   <span class="na">class=</span><span class="s">&quot;org.springframework.jms.connection.CachingConnectionFactory&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
   <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;targetConnectionFactory&quot;</span> <span class="na">ref=</span><span class="s">&quot;connectionFactory&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
   <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;sessionCacheSize&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;jmsTemplate&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.jms.core.JmsTemplate&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;connectionFactory&quot;</span> <span class="na">ref=</span><span class="s">&quot;cachingConnectionFactory&quot;</span> <span class="nt">/&gt;</span>
   <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;destinationResolver&quot;</span> <span class="na">ref=</span><span class="s">&quot;destinationResolver&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- (5) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;jmsMessagingTemplate&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.jms.core.JmsMessagingTemplate&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;jmsTemplate&quot;</span> <span class="na">ref=</span><span class="s">&quot;jmsTemplate&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for <code class="docutils literal"><span class="pre">org.springframework.jms.connection.CachingConnectionFactory</span></code> which performs caching of <code class="docutils literal"><span class="pre">Session</span></code>, <code class="docutils literal"><span class="pre">MessageProducer</span></code> and <code class="docutils literal"><span class="pre">MessageConsumer</span></code>.</div>
<div class="line">Cache function can be used by using JMS provider specific <code class="docutils literal"><span class="pre">ConnectionFactory</span></code> which is looked up in Bean definition or JNDI name,
by wrapping it in <code class="docutils literal"><span class="pre">CachingConnectionFactory</span></code> instead of using it as it is.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify <code class="docutils literal"><span class="pre">ConnectionFactory</span></code>which is wrapped up in Bean definition or JNDI name.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set cache number of <code class="docutils literal"><span class="pre">Session</span></code>. (default value is 1)</div>
<div class="line">Although 1 is specified in this example, cache number should be changed appropriately corresponding to performance requirement.</div>
<div class="line">If a session is required to be continued even after exceeding this cache number, a new session is created and destroyed repeatedly without using a cache.</div>
<div class="line">It is likely to cause reduction in process efficiency resulting in performance degradation.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for <code class="docutils literal"><span class="pre">JmsTemplate</span></code>.</div>
<div class="line"><code class="docutils literal"><span class="pre">JmsTemplate</span></code> alternates for a low level API handling (JMS API calling).</div>
<div class="line">For the attributes that can be configured, refer list of attributes of <code class="docutils literal"><span class="pre">JmsTemplate</span></code> shown below.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for <code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>. Inject <code class="docutils literal"><span class="pre">JmsTemplate</span></code> which alternates as a synchronous reception process.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line">List of attributes of <code class="docutils literal"><span class="pre">JmsTemplate</span></code> related to synchronous reception are shown below.</div>
<div class="line">Configuration must be done as required.</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="5%" />
<col width="20%" />
<col width="50%" />
<col width="15%" />
<col width="10%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Configuration item</th>
<th class="head">Details</th>
<th class="head">Mandatory</th>
<th class="head">Default value</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">connectionFactory</span></code></td>
<td><div class="first last line-block">
<div class="line">Set <code class="docutils literal"><span class="pre">ConnectionFactory</span></code>to be used.</div>
</div>
</td>
<td>○</td>
<td>Nil (since it is mandatory)</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">pubSubDomain</span></code></td>
<td><div class="first last line-block">
<div class="line">Set for messaging model.</div>
<div class="line">Set <code class="docutils literal"><span class="pre">false</span></code>for PTP (Queue) model and <code class="docutils literal"><span class="pre">true</span></code>for Pub/Sub (Topic).</div>
</div>
</td>
<td>-</td>
<td><code class="docutils literal"><span class="pre">false</span></code></td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">sessionTransacted</span></code></td>
<td><div class="first last line-block">
<div class="line">Set whether the transaction is controlled in the session.</div>
<div class="line">In this guideline, since transaction control described later is used, default <code class="docutils literal"><span class="pre">false</span></code> is recommended.</div>
</div>
</td>
<td>-</td>
<td><code class="docutils literal"><span class="pre">false</span></code></td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">sessionAcknowledgeMode</span></code></td>
<td><div class="first line-block">
<div class="line">Set confirmation response mode of session for <code class="docutils literal"><span class="pre">sessionAcknowledgeMode</span></code>.</div>
<div class="line">For details, refer <a class="reference external" href="http://docs.spring.io/spring/docs/4.3.14.RELEASE/javadoc-api/org/springframework/jms/core/JmsTemplate.html">JavaDoc of JMSTemplate</a>.</div>
</div>
<div class="admonition-todo last admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">Details of sessionAcknowledgeMode will be added later.</p>
</div>
</td>
<td>-</td>
<td><div class="first last line-block">
<div class="line">1</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">receiveTimeout</span></code></td>
<td><div class="first last line-block">
<div class="line">Set timeout period (milliseconds) at the time of synchronous reception. If it is not set, wait till the message is received.</div>
<div class="line">If the timeout period is not set, it impacts the subsequent processes, hence an appropriate timeout period must always be set.</div>
</div>
</td>
<td>-</td>
<td><div class="first last line-block">
<div class="line">0</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">messageConverter</span></code></td>
<td><div class="first last line-block">
<div class="line">Set message converter.</div>
<div class="line">Default can be used in the range introduced in the guideline.</div>
</div>
</td>
<td>-</td>
<td><code class="docutils literal"><span class="pre">SimpleMessageConverter</span></code>(*1) is used.</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">destinationResolver</span></code></td>
<td><div class="first last line-block">
<div class="line">Set DestinationResolver.</div>
<div class="line">This guideline recommends setting <code class="docutils literal"><span class="pre">JndiDestinationResolver</span></code> which performs name resolution by JNDI.</div>
</div>
</td>
<td>-</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DynamicDestinationResolver</span></code>(*2) is used.</div>
<div class="line">(If <code class="docutils literal"><span class="pre">DynamicDestinationResolver</span></code> is used, name resolution of Destination is performed by JMS provider.)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="8">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">defaultDestination</span></code></td>
<td><div class="first last line-block">
<div class="line">Specify existing Destination.</div>
<div class="line">When the Destination is not specified explicitly, this Destination is used.</div>
</div>
</td>
<td>-</td>
<td>null(no existing Destination)</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>(*1)<code class="docutils literal"><span class="pre">org.springframework.jms.support.converter.SimpleMessageConverter</span></code></p>
<p>(*2)<code class="docutils literal"><span class="pre">org.springframework.jms.support.destination.DynamicDestinationResolver</span></code></p>
<p>Messages are received synchronously by <code class="docutils literal"><span class="pre">receiveAndConvert</span></code> message of <code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code> class. Implementation example is shown below.</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/java/com/example/domain/service/todo/TodoServiceImpl.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service.todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jms.core.JmsMessagingTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>
    <span class="nd">@Inject</span>
    <span class="n">JmsMessagingTemplate</span> <span class="n">jmsMessagingTemplate</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">receiveTodo</span><span class="o">()</span> <span class="o">{</span>

       <span class="c1">// omitted</span>
       <span class="n">Todo</span> <span class="n">retTodo</span> <span class="o">=</span> <span class="n">jmsMessagingTemplate</span><span class="o">.</span><span class="na">receiveAndConvert</span><span class="o">(</span><span class="s">&quot;jms/queue/TodoMessageQueue&quot;</span><span class="o">,</span> <span class="n">Todo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>   <span class="c1">// (1)</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Receive message from specified Destination using <code class="docutils literal"><span class="pre">receiveAndConvert</span></code> method of <code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>.</div>
<div class="line"><code class="docutils literal"><span class="pre">receiveAndConvert</span></code> method can fetch the class for which type conversion is done, by specifying the class for conversion, in the second argument.</div>
<div class="line">A header item can be fetched by <code class="docutils literal"><span class="pre">Message</span></code> object of Spring Framework, by using <code class="docutils literal"><span class="pre">receive</span></code> method.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="appendix">
<h2><a class="toc-backref" href="#id32">8.2.3. Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this headline">¶</a></h2>
<div class="section" id="jms-provider-dependent-configuration">
<span id="jmsappendixsettingsdependsonjmsprovider"></span><h3><a class="toc-backref" href="#id33">8.2.3.1. JMS provider dependent configuration</a><a class="headerlink" href="#jms-provider-dependent-configuration" title="Permalink to this headline">¶</a></h3>
<p>Configuration varies for each JMS provider.
Configuration for each JMS provider is explained below.</p>
<div class="section" id="while-using-apache-activemq">
<h4><a class="toc-backref" href="#id34">8.2.3.1.1. While using Apache ActiveMQ</a><a class="headerlink" href="#while-using-apache-activemq" title="Permalink to this headline">¶</a></h4>
<p>Configuration while using Apache ActiveMQ is explained.</p>
<ul>
<li><p class="first"><strong>JMS provider specific configuration for application server</strong></p>
<div class="line-block">
<div class="line">JMS provider requires specific configuration.</div>
<div class="line">In Apache ActiveMQ, environment variable must be added to starting variable of application server to ensure that it consists of objects wherein payload of received messages is permissible.</div>
<div class="line">For details, refer <a class="reference external" href="http://activemq.apache.org/objectmessage.html">ObjectMessage</a>.</div>
<div class="line">An example of adding environment variable to startup argument of Apache Tomcat is shown below. Refer <a class="reference external" href="https://access.redhat.com/documentation/en/red-hat-jboss-enterprise-application-platform/7.0/paged/installation-guide/chapter-4-configuring-jboss-eap-to-run-as-a-service">Configuring JBoss EAP to Run as a Service</a> in case of JBoss Enterprise Application Platform 7.0, <a class="reference external" href="https://access.redhat.com/documentation/en-US/JBoss_Enterprise_Application_Platform/6.4/html/Installation_Guide/sect-Service_Configuration.html">Service Configuration</a> in case of JBoss Enterprise Application Platform 6.4 and <a class="reference external" href="http://docs.oracle.com/middleware/1221/wls/START/overview.htm#START120">Starting Managed Servers with a Startup Script</a> in case of Weblogic.</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">$CATALINA_HOME/bin/setenv.sh</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-properties"><div class="highlight"><pre><span></span><span class="c"># omitted</span>
<span class="c"># (1)</span>
<span class="na">-Dorg.apache.activemq.SERIALIZABLE_PACKAGES</span><span class="o">=</span><span class="s">java.lang,java.util,org.apache.activemq,org.fusesource.hawtbuf,com.thoughtworks.xstream.mapper,com.example.domain.model</span>
<span class="c"># omitted</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Add package for an arbitrary object to be allowed. <code class="docutils literal"><span class="pre">java.lang</span></code>,<code class="docutils literal"><span class="pre">java.util</span></code>, <code class="docutils literal"><span class="pre">org.apache.activemq</span></code>, <code class="docutils literal"><span class="pre">org.fusesource.hawtbuf</span></code> and <code class="docutils literal"><span class="pre">com.thoughtworks.xstream.mapper</span></code> are the settings required while using Apache ActiveMQ.</div>
<div class="line">“com.example.domain.model” is added as a required configuration value in this sample.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
<li><p class="first"><strong>Adding a library</strong></p>
<div class="line-block">
<div class="line">JMS API is not included in the <code class="docutils literal"><span class="pre">spring-jms</span></code> library.</div>
<div class="line">Although JMS API is normally included in the JMS provider library, JMS API is added to pom.xml if JMS API is not included in JMS provider library.</div>
</div>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">activemq-client</span></code> is added to pom.xml of domain project and web project as a library for build.</div>
<div class="line">Further, <code class="docutils literal"><span class="pre">activemq-client</span></code> and its dependent libraries are added to the application server.</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/pom.xml</span></code></li>
<li><code class="file docutils literal"><span class="pre">[projectName]-web/pom.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependencies&gt;</span>

    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.activemq<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>activemq-client<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>

<span class="nt">&lt;/dependencies&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Add client library of Apache ActiveMQ to dependencies as a build. Since JMS API is also incorporated in <code class="docutils literal"><span class="pre">activemq-client</span></code> library, it is not necessary to add JMS API as a library.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
</ul>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In the above setting example, since it is assumed that the dependent library version is managed by the parent project terasoluna-gfw-parent , specifying the version in pom.xml is not necessary.
The above dependent library used by terasoluna-gfw-parent is defined by <a class="reference external" href="http://platform.spring.io/platform/">Spring IO Platform</a>.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The version of the library used while establishing a connection with Apache ActiveMQ is defined in <a class="reference external" href="http://platform.spring.io/platform/">Spring IO Platform</a> which is used by TERASOLUNA Server Framework for Java.
Hence, care must be taken while determining Apache ActiveMQ version.
Note that, library and middleware versions are likely to be inconsistent while upgrading the version of TERASOLUNA Server Framework for Java.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul>
<li><p class="first"><strong>JNDI registration to application server</strong></p>
<div class="line-block">
<div class="line">For registration of JNDI to application server, refer <a class="reference external" href="http://activemq.apache.org/tomcat.html">Manually integrating Tomcat and ActiveMQ</a>.</div>
</div>
</li>
<li><p class="first"><strong>Configuration when JNDI is not used.</strong></p>
<div class="line-block">
<div class="line">Although this guideline recommends a method to resolve names using JNDI,</div>
<div class="line">JNDI is not used while connecting to JMS provider during the implementation of a simple test which is not run on the application server.</div>
<div class="line">In such a case, a Bean of implementation class of <code class="docutils literal"><span class="pre">ConnectionFactory</span></code> must be generated.</div>
<div class="line">Further, use of JNDI is also specified for Queue, however, if a Queue specified in the Destination by using a JMS provider function does not exist, a Queue of specified name can be dynamically generated.</div>
<div class="line">Internal Broker of Apache ActiveMQ must be used for establishing a connection without passing through the application server.</div>
<div class="line">For configuration of internal Broker for Apache ActiveMQ, refer <a class="reference external" href="http://activemq.apache.org/how-do-i-embed-a-broker-inside-a-connection.html">How do I embed a Broker inside a Connection</a>.</div>
<div class="line">Following configuration should be added to the context for the testing.</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/resources/META-INF/spring/[projectName]-infra.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;connectionFactory&quot;</span> <span class="na">class=</span><span class="s">&quot;org.apache.activemq.ActiveMQConnectionFactory&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">value=</span><span class="s">&quot;tcp://localhost:61616&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for <code class="docutils literal"><span class="pre">ConnectionFactory</span></code> of Apache ActiveMQ.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify beginning URL of Apache ActiveMQ. Beginning URL sets the value for each environment.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
</ul>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When the configuration method of ConnectionFactory is to be changed by JNDI and bean definition, based on development phase,
configuration should be described in <code class="docutils literal"><span class="pre">[projectName]-env/src/main/resources/META-INF/spring/[projectName]-env.xml</span></code>.</p>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="mass-mailing-of-identical-messages">
<span id="jmsappendixsendmanysamemessages"></span><h3><a class="toc-backref" href="#id35">8.2.3.2. Mass-mailing of identical messages</a><a class="headerlink" href="#mass-mailing-of-identical-messages" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">If <code class="docutils literal"><span class="pre">JmsMessageTemplate</span></code> is to be used for mass mailing of identical message, memory usage is likely to increase.</div>
<div class="line">Hence, a method wherein implementation is done by using <code class="docutils literal"><span class="pre">send</span></code> method of <code class="docutils literal"><span class="pre">JmsTemplate</span></code> class must be considered.</div>
<div class="line">Reason being, an instance of <code class="docutils literal"><span class="pre">org.springframework.jms.core.MessageCreator</span></code> class is generated while sending a message in <code class="docutils literal"><span class="pre">JmsMessageTemplate</span></code>.</div>
<div class="line">In order to prevent the generation of unnecessary instance, the messages are sent by <code class="docutils literal"><span class="pre">send</span></code> method of <code class="docutils literal"><span class="pre">JmsTemplate</span></code> class wherein <code class="docutils literal"><span class="pre">MessageCreator</span></code> instance is not generated during transmission thus reducing the amount of memory used.</div>
<div class="line">An example of code wherein a string is sent 100 times to an identical destination is shown below.</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/java/com/example/domain/service/todo/TodoServiceImpl.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span> <span class="kn">package</span> <span class="nn">com.example.domain.service.todo</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">javax.jms.JMSException</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">javax.jms.Message</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">javax.jms.Session</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">javax.jms.TextMessage</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.jms.core.JmsTemplate</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.jms.core.MessageCreator</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>

 <span class="nd">@Service</span>
 <span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">JmsTemplate</span> <span class="n">jmsTemplate</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendManyMessage</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">messageStr</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">MessageCreator</span> <span class="n">mc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MessageCreator</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// (2)</span>
            <span class="kd">public</span> <span class="n">Message</span> <span class="nf">createMessage</span><span class="o">(</span><span class="n">Session</span> <span class="n">session</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">JMSException</span> <span class="o">{</span>
                <span class="n">TextMessage</span> <span class="n">message</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTextMessage</span><span class="o">();</span> <span class="c1">// (3)</span>
                <span class="n">message</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">messageStr</span><span class="o">);</span>

                <span class="c1">// omitted</span>
                <span class="k">return</span> <span class="n">message</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">jmsTemplate</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="s">&quot;jms/queue/TodoMessageQueue&quot;</span><span class="o">,</span> <span class="n">mc</span><span class="o">);</span> <span class="c1">// (4)</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When <code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code> is used, <code class="docutils literal"><span class="pre">MessageCreater</span></code> is generated at the time of sending. Hence, <code class="docutils literal"><span class="pre">JmsTemplate</span></code> which can define generation of <code class="docutils literal"><span class="pre">MessageCreater</span></code> by isolating it from sending, is used.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Generate instance of <code class="docutils literal"><span class="pre">MessageCreator</span></code> for creating <code class="docutils literal"><span class="pre">Message</span></code> of JMS.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When messages are sent by <code class="docutils literal"><span class="pre">send</span></code> method of <code class="docutils literal"><span class="pre">JmsTemplate</span></code> class, instances of <code class="docutils literal"><span class="pre">MessageCreator</span></code> are no longer generated for each loop
and the amount of memory can be reduced.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="sending-and-receiving-large-size-data">
<span id="jmsappendixsendlargedata"></span><h3><a class="toc-backref" href="#id36">8.2.3.3. Sending and receiving large size data</a><a class="headerlink" href="#sending-and-receiving-large-size-data" title="Permalink to this headline">¶</a></h3>
<p>While handling data of large size like Image data (Data of size 1MB or more as a rough indication), <code class="docutils literal"><span class="pre">OutOfMemoryError</span></code> is likely to occur due to number of concurrent transactions and heap size.
In standard API of JMS, only <code class="docutils literal"><span class="pre">StreamMessage</span></code> which sends primitive type data and <code class="docutils literal"><span class="pre">ByteMessage</span></code> which can send uninterpreted byte stream can handle large size data as a stream.
Hence, a specific API offered for each JMS provider is used instead of JMS API.</p>
<div class="section" id="id4">
<h4><a class="toc-backref" href="#id37">8.2.3.3.1. While using Apache ActiveMQ</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p>A message of large size can be received or sent by using <a class="reference external" href="http://activemq.apache.org/blob-messages.html">Blob Message</a>. Implementation example is shown below.</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since Apache ActiveMQ specific API is used while using <code class="docutils literal"><span class="pre">org.apache.activemq.BlobMessage</span></code>,
<code class="docutils literal"><span class="pre">Message</span></code> and <code class="docutils literal"><span class="pre">CachingConnectionFactory</span></code> offered by Spring Framework cannot be used.
It is recommended to separately define <code class="docutils literal"><span class="pre">JmsTemplate</span></code> for <code class="docutils literal"><span class="pre">BlobMessage</span></code> while using <code class="docutils literal"><span class="pre">BlobMessage</span></code> considering the impact on the performance.</p>
</div>
</div></blockquote>
<ul>
<li><p class="first"><strong>Configuration</strong></p>
<p>While sending a message by using <code class="docutils literal"><span class="pre">BlobMessage</span></code>, the message is stored in the server which is temporarily run by Apache ActiveMQ, instead of heap area.
Definition example for storage destination for the messages is shown below.</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/resources/META-INF/spring/[projectName]-infra.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;connectionFactory&quot;</span>
   <span class="na">class=</span><span class="s">&quot;org.apache.activemq.ActiveMQConnectionFactory&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;brokerURL&quot;</span><span class="nt">&gt;</span>
      <span class="c">&lt;!-- (1) --&gt;</span>
      <span class="nt">&lt;value&gt;</span>tcp://localhost:61616?jms.blobTransferPolicy.uploadUrl=/tmp<span class="nt">&lt;/value&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a directory of Apache ActiveMQ server which temporarily stores messages.</div>
<div class="line"><code class="docutils literal"><span class="pre">http://localhost:8080/uploads/</span></code> is set as a default in <code class="docutils literal"><span class="pre">jms.blobTransferPolicy.uploadUrl</span></code> wherein location for temporary file can be specified by overloading default or <code class="docutils literal"><span class="pre">brokerURL</span></code>.</div>
<div class="line">For example, the file is temporarily stored in <code class="docutils literal"><span class="pre">/tmp</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
<li><p class="first"><strong>Sending</strong></p>
<p>An implementation example of sending class which use <code class="docutils literal"><span class="pre">Blob</span> <span class="pre">Message</span></code> is shown below.</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/java/com/example/domain/service/todo/TodoServiceImpl.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service.todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Path</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.JMSException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.Message</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.Session</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQSession</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.activemq.BlobMessage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jms.core.JmsTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jms.core.MessageCreator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>
    <span class="nd">@Inject</span>
    <span class="n">JmsTemplate</span> <span class="n">jmsTemplate</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendBlobMessage</span><span class="o">(</span><span class="n">String</span> <span class="n">inputFilePath</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>

        <span class="n">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">inputFilePath</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">(</span><span class="kd">final</span> <span class="n">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">newInputStream</span><span class="o">(</span><span class="n">path</span><span class="o">))</span> <span class="o">{</span>

            <span class="n">jmsTemplate</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="s">&quot;jms/queue/TodoMessageQueue&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">MessageCreator</span><span class="o">()</span> <span class="o">{</span>
                <span class="kd">public</span> <span class="n">Message</span> <span class="nf">createMessage</span><span class="o">(</span><span class="n">Session</span> <span class="n">session</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">JMSException</span> <span class="o">{</span>

                    <span class="n">ActiveMQSession</span> <span class="n">activeMQSession</span> <span class="o">=</span> <span class="o">(</span><span class="n">ActiveMQSession</span><span class="o">)</span> <span class="n">session</span><span class="o">;</span>  <span class="c1">// (1)</span>

                    <span class="n">BlobMessage</span> <span class="n">blobMessage</span> <span class="o">=</span> <span class="n">activeMQSession</span><span class="o">.</span><span class="na">createBlobMessage</span><span class="o">(</span><span class="n">inputStream</span><span class="o">);</span>  <span class="c1">// (2)</span>
                    <span class="k">return</span> <span class="n">blobMessage</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use <code class="docutils literal"><span class="pre">org.apache.activemq.ActiveMQSession</span></code> - a Apache ActiveMQ specific API in <code class="docutils literal"><span class="pre">BlobMessage</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Generate <code class="docutils literal"><span class="pre">BlobMessage</span></code> from <code class="docutils literal"><span class="pre">ActiveMQSession</span></code>by specifying sending data.</div>
<div class="line">Arguments of <code class="docutils literal"><span class="pre">createBlobMessage</span></code> method can be specified by <code class="docutils literal"><span class="pre">File</span></code>, <code class="docutils literal"><span class="pre">InputStream</span></code> and <code class="docutils literal"><span class="pre">URL</span></code> class.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
<li><p class="first"><strong>Receiving</strong></p>
<p>An implementation example of receiving class is shown below.</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-web/src/main/java/com/example/listener/todo/TodoMessageListener.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.listener.todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.JMSException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.activemq.BlobMessage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jms.annotation.JmsListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.service.todo.TodoService</span><span class="o">;</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoMessageListener</span> <span class="o">{</span>
    <span class="nd">@Inject</span>
    <span class="n">TodoService</span> <span class="n">todoService</span><span class="o">;</span>
    <span class="nd">@JmsListener</span><span class="o">(</span><span class="n">destination</span> <span class="o">=</span> <span class="s">&quot;jms/queue/TodoMessageQueue&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">receiveBlobMessage</span><span class="o">(</span><span class="n">BlobMessage</span> <span class="n">message</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">JMSException</span> <span class="o">{</span>
     <span class="n">todoService</span><span class="o">.</span><span class="na">fileInputBlobMessage</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
        <span class="c1">// omitted</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/java/com/example/domain/service/todo/TodoServiceImpl.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service.todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Path</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.activemq.BlobMessage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">fileInputBlobMessage</span><span class="o">(</span><span class="n">BlobMessage</span> <span class="n">message</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">try</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">is</span> <span class="o">=</span>  <span class="n">message</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">()){</span>   <span class="c1">// (1)</span>
            <span class="n">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;outputFilePath&quot;</span><span class="o">);</span>
            <span class="n">Files</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">is</span><span class="o">,</span> <span class="n">path</span><span class="o">);</span>
            <span class="c1">// omitted</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="13%" />
<col width="87%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch data from received <code class="docutils literal"><span class="pre">BlobMessage</span></code> as <code class="docutils literal"><span class="pre">InputStream</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
</ul>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../Security/index.html" title="9. Security countermeasures"
             >next</a> |</li>
        <li class="right" >
          <a href="Email.html" title="8.1. Sending E-mail (SMTP)"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.4.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >8. Messaging</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer">
      © Copyright 2013-2018, NTT DATA Corporation. © Copyright 2013-2018, NTT Corporation.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3.Theme is <a href="http://github.com/vimalkvn/solar-theme">Solar</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>

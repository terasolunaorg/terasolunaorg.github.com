<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>8.2. JMS(Java Message Service) &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.7.0.RELEASE documentation</title>
    <link rel="stylesheet" href="../../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '5.7.0.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="9. セキュリティ対策" href="../../Security/index.html" />
    <link rel="prev" title="8.1. E-mail送信(SMTP)" href="Email.html" /><script async src="https://www.googletagmanager.com/gtag/js?id=G-847V2Q99G8"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date()); gtag('config', 'G-847V2Q99G8');
</script>
<script src="../../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../../_static/solarized-dark.css" rel="stylesheet">
<link href="../../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../Security/index.html" title="9. セキュリティ対策"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Email.html" title="8.1. E-mail送信(SMTP)"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.7.0.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">8. メッセージ連携</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">8.2. JMS(Java Message Service)</a><ul>
<li><a class="reference internal" href="#overview">8.2.1. Overview</a><ul>
<li><a class="reference internal" href="#jms">8.2.1.1. JMSとは</a></li>
<li><a class="reference internal" href="#jmsoverviewapi">8.2.1.2. JMSの利用</a></li>
<li><a class="reference internal" href="#spring-frameworkjms">8.2.1.3. Spring Frameworkのコンポーネントを使用したJMSの利用</a><ul>
<li><a class="reference internal" href="#jmsoverviewsyncsend">8.2.1.3.1. メッセージを同期送信する場合</a></li>
<li><a class="reference internal" href="#jmsoverviewasyncreceive">8.2.1.3.2. メッセージを非同期受信する場合</a></li>
<li><a class="reference internal" href="#jmsoverviewsyncreceive">8.2.1.3.3. メッセージを同期受信する場合</a></li>
</ul>
</li>
<li><a class="reference internal" href="#jmsoverviewaboutprojectconfiguration">8.2.1.4. プロジェクト構成について</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">8.2.2. How to use</a><ul>
<li><a class="reference internal" href="#jmshowtouseenviromentsetting">8.2.2.1. メッセージの送受信に共通する設定</a><ul>
<li><a class="reference internal" href="#jmshowtousedependentlibrary">8.2.2.1.1. 依存ライブラリの設定</a></li>
<li><a class="reference internal" href="#connectionfactory">8.2.2.1.2. <code class="docutils literal"><span class="pre">ConnectionFactory</span></code>の設定</a></li>
<li><a class="reference internal" href="#destinationresolver">8.2.2.1.3. <code class="docutils literal"><span class="pre">DestinationResolver</span></code>の設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#jmshowtousesyncsendmessage">8.2.2.2. メッセージを同期送信する方法</a><ul>
<li><a class="reference internal" href="#jmshowtousesettingforsyncsend">8.2.2.2.1. 基本的な同期送信</a></li>
<li><a class="reference internal" href="#jmshowtousesettingforsendwithheader">8.2.2.2.2. メッセージヘッダを編集して同期送信する場合</a></li>
<li><a class="reference internal" href="#jmshowtousesettingforsyncsendtransactionmanagement">8.2.2.2.3. トランザクション管理</a></li>
</ul>
</li>
<li><a class="reference internal" href="#jmshowtouseasyncreceivemessage">8.2.2.3. メッセージを非同期受信する方法</a><ul>
<li><a class="reference internal" href="#jmshowtouselistenercontainer">8.2.2.3.1. 基本的な非同期受信</a></li>
<li><a class="reference internal" href="#jmshowtouselistenercontainergetheader">8.2.2.3.2. メッセージのヘッダ情報を取得する</a></li>
<li><a class="reference internal" href="#jmshowtouselistenercontainerresendmessage">8.2.2.3.3. 非同期受信後の処理結果をメッセージ送信</a></li>
<li><a class="reference internal" href="#jmshowtousemessageselectorforasyncreceive">8.2.2.3.4. 非同期受信するメッセージを限定する場合</a></li>
<li><a class="reference internal" href="#jmshowtousevalidationforasyncreceive">8.2.2.3.5. 非同期受信したメッセージの入力チェック</a></li>
<li><a class="reference internal" href="#jmshowtousetransactionmanagementforasyncreceive">8.2.2.3.6. トランザクション管理</a></li>
<li><a class="reference internal" href="#jmshowtouseexceptionhandlingforasyncreceive">8.2.2.3.7. 非同期受信時の例外ハンドリング</a></li>
</ul>
</li>
<li><a class="reference internal" href="#jmshowtousesyncreceivemessage">8.2.2.4. メッセージを同期受信する方法</a></li>
</ul>
</li>
<li><a class="reference internal" href="#appendix">8.2.3. Appendix</a><ul>
<li><a class="reference internal" href="#jmsappendixsettingsdependsonjmsprovider">8.2.3.1. JMSプロバイダに依存する設定</a><ul>
<li><a class="reference internal" href="#apache-activemq">8.2.3.1.1. Apache ActiveMQを利用する場合</a></li>
</ul>
</li>
<li><a class="reference internal" href="#jmsappendixsendmanysamemessages">8.2.3.2. 同一メッセージの大量送信</a></li>
<li><a class="reference internal" href="#jmsappendixsendlargedata">8.2.3.3. サイズの大きなデータの送受信</a><ul>
<li><a class="reference internal" href="#id25">8.2.3.3.1. Apache ActiveMQを利用する場合</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="Email.html"
                        title="previous chapter">8.1. E-mail送信(SMTP)</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../../Security/index.html"
                        title="next chapter">9. セキュリティ対策</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/ArchitectureInDetail/MessagingDetail/JMS.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="jms-java-message-service">
<h1>8.2. JMS(Java Message Service)<a class="headerlink" href="#jms-java-message-service" title="Permalink to this headline">¶</a></h1>
<div class="admonition caution">
  <p class="first admonition-title">Caution</p>
  <p><strong>本バージョンの内容は既に古くなっています</strong>。最新のガイドラインは<a href="http://terasolunaorg.github.io/guideline/">こちら</a>からご参照ください。</p>
</div>
<div class="contents local topic" id="id1">
<p class="topic-title">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id27">Overview</a><ul>
<li><a class="reference internal" href="#jms" id="id28">JMSとは</a></li>
<li><a class="reference internal" href="#jmsoverviewapi" id="id29">JMSの利用</a></li>
<li><a class="reference internal" href="#spring-frameworkjms" id="id30">Spring Frameworkのコンポーネントを使用したJMSの利用</a><ul>
<li><a class="reference internal" href="#jmsoverviewsyncsend" id="id31">メッセージを同期送信する場合</a></li>
<li><a class="reference internal" href="#jmsoverviewasyncreceive" id="id32">メッセージを非同期受信する場合</a></li>
<li><a class="reference internal" href="#jmsoverviewsyncreceive" id="id33">メッセージを同期受信する場合</a></li>
</ul>
</li>
<li><a class="reference internal" href="#jmsoverviewaboutprojectconfiguration" id="id34">プロジェクト構成について</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use" id="id35">How to use</a><ul>
<li><a class="reference internal" href="#jmshowtouseenviromentsetting" id="id36">メッセージの送受信に共通する設定</a><ul>
<li><a class="reference internal" href="#jmshowtousedependentlibrary" id="id37">依存ライブラリの設定</a></li>
<li><a class="reference internal" href="#connectionfactory" id="id38"><code class="docutils literal"><span class="pre">ConnectionFactory</span></code>の設定</a></li>
<li><a class="reference internal" href="#destinationresolver" id="id39"><code class="docutils literal"><span class="pre">DestinationResolver</span></code>の設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#jmshowtousesyncsendmessage" id="id40">メッセージを同期送信する方法</a><ul>
<li><a class="reference internal" href="#jmshowtousesettingforsyncsend" id="id41">基本的な同期送信</a></li>
<li><a class="reference internal" href="#jmshowtousesettingforsendwithheader" id="id42">メッセージヘッダを編集して同期送信する場合</a></li>
<li><a class="reference internal" href="#jmshowtousesettingforsyncsendtransactionmanagement" id="id43">トランザクション管理</a></li>
</ul>
</li>
<li><a class="reference internal" href="#jmshowtouseasyncreceivemessage" id="id44">メッセージを非同期受信する方法</a><ul>
<li><a class="reference internal" href="#jmshowtouselistenercontainer" id="id45">基本的な非同期受信</a></li>
<li><a class="reference internal" href="#jmshowtouselistenercontainergetheader" id="id46">メッセージのヘッダ情報を取得する</a></li>
<li><a class="reference internal" href="#jmshowtouselistenercontainerresendmessage" id="id47">非同期受信後の処理結果をメッセージ送信</a></li>
<li><a class="reference internal" href="#jmshowtousemessageselectorforasyncreceive" id="id48">非同期受信するメッセージを限定する場合</a></li>
<li><a class="reference internal" href="#jmshowtousevalidationforasyncreceive" id="id49">非同期受信したメッセージの入力チェック</a></li>
<li><a class="reference internal" href="#jmshowtousetransactionmanagementforasyncreceive" id="id50">トランザクション管理</a></li>
<li><a class="reference internal" href="#jmshowtouseexceptionhandlingforasyncreceive" id="id51">非同期受信時の例外ハンドリング</a></li>
</ul>
</li>
<li><a class="reference internal" href="#jmshowtousesyncreceivemessage" id="id52">メッセージを同期受信する方法</a></li>
</ul>
</li>
<li><a class="reference internal" href="#appendix" id="id53">Appendix</a><ul>
<li><a class="reference internal" href="#jmsappendixsettingsdependsonjmsprovider" id="id54">JMSプロバイダに依存する設定</a><ul>
<li><a class="reference internal" href="#apache-activemq" id="id55">Apache ActiveMQを利用する場合</a></li>
</ul>
</li>
<li><a class="reference internal" href="#jmsappendixsendmanysamemessages" id="id56">同一メッセージの大量送信</a></li>
<li><a class="reference internal" href="#jmsappendixsendlargedata" id="id57">サイズの大きなデータの送受信</a><ul>
<li><a class="reference internal" href="#id25" id="id58">Apache ActiveMQを利用する場合</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<span id="jmsoverview"></span><h2><a class="toc-backref" href="#id27">8.2.1. Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>本節では、JMS APIとSpring FrameworkのJMS連携用コンポーネントを使用したメッセージの送受信方法について説明する。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="jms">
<span id="jmsoverviewaboutjms"></span><h3><a class="toc-backref" href="#id28">8.2.1.1. JMSとは</a><a class="headerlink" href="#jms" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">JMSはJavaでMOM（Message Oriented Middleware）を利用するための標準APIである。</div>
<div class="line">JMSのアーキテクチャは、JMSプロバイダを経由してクライアントからクライアントへメッセージを交換する。</div>
<div class="line">JMSは非同期メッセージングをサポートしているため、クライアント間を疎結合にすることができる。</div>
<div class="line">また、後述するPoint-to-Pointモデルを採用することでメッセージをQueueに格納できるため、クライアントの性能に応じたメッセージ受信が可能となる。</div>
<div class="line">その反面、クライアントからクライアントへのメッセージングにはタイムラグが発生しうるので、リアルタイムな応答が求められる処理に向かない傾向がある。</div>
<div class="line">JMSの詳細については、<a class="reference external" href="http://www.oracle.com/technetwork/java/index-jsp-142945.html">Java Message Service (JMS)</a>を参照されたい。</div>
<div class="line"><br /></div>
<div class="line">JMSを使用することで、同期または非同期でのメッセージングが可能となる。</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">本ガイドラインではJMS1.1を使用することを前提としている。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">利用する際には、下記に説明する配信モデルとメッセージ送受信方式を要件に合わせて選択する必要がある。</div>
</div>
<ul class="simple">
<li><strong>配信モデル</strong></li>
</ul>
<blockquote>
<div><div class="line-block">
<div class="line">配信モデルは、Point-to-Point（PTP）と Publisher-Subscriber（Pub/Sub）の2つのモデルが存在する。</div>
<div class="line">2つのモデルの大きな違いは送信者と受信者が1対1であるか、1対多であるかであり、用途によって選択する必要がある。</div>
</div>
<ol class="arabic simple">
<li>Point-To-Point（PTP）モデル</li>
</ol>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../../_images/JMSQueue.png"><img alt="JMS Queue" src="../../_images/JMSQueue.png" style="width: 70%;" /></a>
</div>
<div class="line-block">
<div class="line">PTPモデルとは、2つのクライアント間において、一方のクライアント（Producer）からメッセージを送信し、もう一方のクライアント（Consumer）のみがそのメッセージを受信するモデルである。</div>
<div class="line">PTPモデルにおけるメッセージのあて先（Destination）をQueueと呼ぶ。</div>
<div class="line">ProducerはQueueにメッセージを送信し、ConsumerはQueueからメッセージを取得し、処理を行う。</div>
<div class="line">Consumerからメッセージが取得されるか、メッセージが有効期限に達するとQueueからメッセージが削除される。</div>
<div class="line"><br /></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="2">
<li>Publisher-Subscriber（Pub/Sub）モデル</li>
</ol>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../../_images/JMSTopic.png"><img alt="JMS Topic" src="../../_images/JMSTopic.png" style="width: 70%;" /></a>
</div>
<div class="line-block">
<div class="line">Pub/Subモデルとは、一方のクライアント（Publisher）からメッセージを発行(Publishes)し、他方の複数クライアント（Subscriber）にそのメッセージを配信(Delivers)するモデルである。</div>
<div class="line">Pub/Subモデルにおけるメッセージのあて先（Destination)をTopicと呼ぶ。</div>
<div class="line">SubscriberはTopicに対し購読依頼(Subscribes)を行い、PublisherはTopicにメッセージを発行する。</div>
<div class="line">Topicに購読依頼している全てのSubscriberにメッセージが配信される。</div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><strong>本ガイドラインでは、一般的に利用されることが多いPTPモデルの実装方法について説明する。</strong></div>
</div>
</div></blockquote>
<ul class="simple">
<li><strong>メッセージ送信方式</strong></li>
</ul>
<blockquote>
<div><div class="line-block">
<div class="line">QueueまたはTopicへのメッセージ送信方式には、同期送信方式と非同期送信方式の2通りの処理方式が考えられるが、JMS1.1では同期送信方式のみがサポートされる。</div>
</div>
<ol class="arabic simple">
<li>同期送信方式</li>
</ol>
<blockquote>
<div><div class="line-block">
<div class="line">明示的にメッセージを送信する機能を呼び出すことで、メッセージに対する処理と送信が開始される。</div>
<div class="line">JMSプロバイダからの応答があるまで待機するため、後続処理がブロックされる。</div>
<div class="line"><br /></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="2">
<li>非同期送信方式</li>
</ol>
<blockquote>
<div><div class="line-block">
<div class="line">明示的にメッセージを送信する機能を呼び出すことで、メッセージに対する処理と送信が開始される。</div>
<div class="line">JMSプロバイダからの応答を待たないため、後続処理を続けて実行する。</div>
<div class="line">非同期送信方式の詳細については、<a class="reference external" href="http://download.oracle.com/otndocs/jcp/jms-2_0-fr-eval-spec/">Java Message Service(Version 2.0)</a>の”7.3. Asynchronous send”を参照されたい。</div>
</div>
</div></blockquote>
</div></blockquote>
<ul class="simple">
<li><strong>メッセージ受信方式</strong></li>
</ul>
<blockquote>
<div><div class="line-block">
<div class="line">QueueまたはTopicに受信したメッセージに対する処理を実装する際には、同期受信方式と非同期受信方式の2通りの処理方式を選択することができる。</div>
<div class="line">後述するように、同期受信方式の利用ケースは限定的であるため、一般的には非同期受信方式が利用されることが多い。</div>
</div>
<ol class="arabic simple">
<li>非同期受信方式</li>
</ol>
<blockquote>
<div><div class="line-block">
<div class="line">QueueまたはTopicがメッセージを受信すると、受信したメッセージに対する処理が開始される。</div>
<div class="line">1つのメッセージに対する処理が終了しなくても別のメッセージの処理が開始されるため、並列処理に向いている。</div>
<div class="line"><br /></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="2">
<li>同期受信方式</li>
</ol>
<blockquote>
<div><div class="line-block">
<div class="line">明示的にメッセージを受信する機能を呼び出すことで、受信とメッセージに対する処理が開始される。</div>
<div class="line">メッセージを受信する機能は、QueueまたはTopicにメッセージが存在しない場合、受信するまで待機する。</div>
<div class="line">そのため、タイムアウト値を設定することで、メッセージの待ち時間を指定する必要がある。</div>
</div>
<div class="line-block">
<div class="line">メッセージの同期受信を使用する一例として、WebアプリケーションにおいてQueueに溜まったメッセージを、画面操作時など任意のタイミングで取得・処理したい場合や、
バッチで定期的にメッセージの処理を行いたい場合に使用することができる。</div>
<div class="line"><br /></div>
</div>
</div></blockquote>
</div></blockquote>
<div class="line-block">
<div class="line">JMSではメッセージは以下のパートで構成される。</div>
<div class="line">詳細は<a class="reference external" href="http://download.oracle.com/otndocs/jcp/7195-jms-1.1-fr-spec-oth-JSpec/">Java Message Service(Version 1.1)</a>の”3. JMS Message Model”を参照されたい。</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">構成</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">ヘッダ</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JMSプロバイダやアプリケーションに対して、メッセージのDestinationや識別子などの制御情報やJMSの拡張ヘッダ(JMSX)、JMSプロバイダ独自のヘッダ、アプリケーション独自のヘッダを格納する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">プロパティ</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ヘッダに追加する制御情報を格納する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">ペイロード</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">メッセージ本体を格納する。</div>
<div class="line">データ種別によって、<code class="docutils literal"><span class="pre">javax.jms.BytesMessage</span></code>、<code class="docutils literal"><span class="pre">javax.jms.MapMessage</span></code>、<code class="docutils literal"><span class="pre">javax.jms.ObjectMessage</span></code>、<code class="docutils literal"><span class="pre">javax.jms.StreamMessage</span></code>、<code class="docutils literal"><span class="pre">javax.jms.TextMessage</span></code>の5つのメッセージタイプを提供している。</div>
<div class="line">JavaBeanを送信したい場合は、<code class="docutils literal"><span class="pre">ObjectMessage</span></code>を利用する。</div>
<div class="line">その場合は、JavaBeanをクライアント間で共有する必要がある。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning" id="jmswarningdeserialization">
<p class="first admonition-title">Warning</p>
<p><strong>デシリアライズ時の注意点</strong></p>
<p>Queueに<code class="docutils literal"><span class="pre">ObjectMessage</span></code>が入るとメッセージを取り出す際にデシリアライズが行われる。</p>
<p>デシリアライズ処理は、不正なデータや予期しないデータを使用して業務ロジックの乱用、サービスの拒否、任意のコードの実行が行われる危険があるため、
信頼できない送信元から受信しうるものをデシリアライズしてはならない。
そのため、Queueも(信頼できない送信元を含み得る)不特定多数からのメッセージを受け付ける構成であってはならない。</p>
<p class="last">詳細については<a class="reference external" href="https://www.owasp.org/index.php/Deserialization_of_untrusted_data">Deserialization of untrusted data</a>を参照されたい。</p>
</div>
</div></blockquote>
</div>
<div class="section" id="jmsoverviewapi">
<span id="id2"></span><h3><a class="toc-backref" href="#id29">8.2.1.2. JMSの利用</a><a class="headerlink" href="#jmsoverviewapi" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">JMSを用いた処理を実装する場合、Jakarta EE（Java EE）で定義されたJMS API（以下、JMS API）を使用することで、処理を実現できる。</div>
<div class="line">ただし、本ガイドラインでは、JMS APIをそのまま使用する場合に比べてメリット（記述が容易など）が多い、Spring FrameworkのJMS連携用コンポーネントを利用する前提としている。</div>
<div class="line">そのため、JMS APIの詳細については説明しない。</div>
<div class="line">詳細については<a class="reference external" href="https://jakarta.ee/specifications/platform/8/apidocs/javax/jms/package-summary.html">JMS API</a>を参照されたい。</div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">JMSはJava APIの標準化はしているが、メッセージの物理的なプロトコルの標準化はしていない。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Jakarta EE（Java EE）サーバではJMS実装が標準で組み込まれているためデフォルトで利用可能(Jakarta EE（Java EE）サーバに組み込まれているJMSプロバイダを使う場合に限られる)だが、Apache TomcatなどのようにJMS実装が組み込まれていないJakarta EE（Java EE）サーバでは、別途JMS実装が必要になる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="spring-frameworkjms">
<span id="jmsoverviewspringjms"></span><h3><a class="toc-backref" href="#id30">8.2.1.3. Spring Frameworkのコンポーネントを使用したJMSの利用</a><a class="headerlink" href="#spring-frameworkjms" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Spring Frameworkでは、メッセージ送受信を行うためのライブラリとして以下を提供している。</div>
</div>
<ul>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">spring-jms</span></code></dt>
<dd><div class="first last line-block">
<div class="line">JMSを利用したメッセージングを行うためのコンポーネントを提供する。</div>
<div class="line">このライブラリに含まれるコンポーネントを利用することで、低レベルのJMS API呼び出しが不要となり、実装を簡素化できる。</div>
<div class="line"><code class="docutils literal"><span class="pre">spring-messaging</span></code>を利用することが可能である。</div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">spring-messaging</span></code></dt>
<dd><div class="first last line-block">
<div class="line">メッセージングベースのアプリケーションを作成する際に必要となる基盤機能を抽象化するためのコンポーネントを提供する。</div>
<div class="line">メッセージとそれを処理するメソッドを対応付けるためのアノテーションのセットが含まれている。</div>
<div class="line">このライブラリに含まれるコンポーネントを利用することで、メッセージングの実装スタイルを合わせることができる。</div>
</div>
</dd>
</dl>
</li>
</ul>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">spring-jms</span></code>のみでも実装可能であるが、<code class="docutils literal"><span class="pre">spring-messaging</span></code>を利用することで実装方式を合わせることが可能である。</div>
<div class="line">本ガイドラインでは、<code class="docutils literal"><span class="pre">spring-messaging</span></code>も利用することを推奨している。</div>
</div>
<div class="line-block">
<div class="line">ここでは、具体的な実装方法の説明を行う前に、Spring Frameworkが提供するJMS連携用のコンポーネントがどのようにメッセージを送受信しているかを説明する。</div>
<div class="line">まずは、説明に登場するコンポーネントを紹介する。</div>
<div class="line">Spring Frameworkは、以下にあげるインタフェースやクラスなどを利用してJMS API経由でメッセージ送受信を行う。</div>
</div>
<ul>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">javax.jms.ConnectionFactory</span></code></dt>
<dd><div class="first last line-block">
<div class="line">JMSプロバイダへのコネクション作成用インタフェース。</div>
<div class="line">アプリケーションからJMSプロバイダへの接続を作成する機能を提供する。</div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">javax.jms.Destination</span></code></dt>
<dd><div class="first last line-block">
<div class="line">あて先(QueueやTopic)であることを示すインタフェース。</div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">javax.jms.MessageProducer</span></code></dt>
<dd><div class="first last line-block">
<div class="line">メッセージの送信用インタフェース。</div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">javax.jms.MessageConsumer</span></code></dt>
<dd><div class="first last line-block">
<div class="line">メッセージの受信用インタフェース。</div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">javax.jms.Message</span></code></dt>
<dd><div class="first last line-block">
<div class="line">ヘッダとボディを保持するメッセージであることを示すインタフェース。</div>
<div class="line">送受信はこのインタフェースの実装クラスがやり取りされる。</div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">org.springframework.messaging.Message</span></code></dt>
<dd><div class="first last line-block">
<div class="line">さまざまなメッセージングで扱うメッセージを抽象化したインタフェース。</div>
<div class="line">JMSでも利用可能である。</div>
<div class="line">前述したとおり、メッセージングの実装方式を合わせるため、基本的にはspring-messagingで提供されている<code class="docutils literal"><span class="pre">org.springframework.messaging.Message</span></code>を使用する。</div>
<div class="line">ただし、<code class="docutils literal"><span class="pre">org.springframework.jms.core.JmsTemplate</span></code>を使用したほうがよい場合が存在するので、その場合には<code class="docutils literal"><span class="pre">javax.jms.Message</span></code>を使用する。</div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">org.springframework.jms.core.JmsMessagingTemplate</span></code>および<code class="docutils literal"><span class="pre">org.springframework.jms.core.JmsTemplate</span></code></dt>
<dd><div class="first last line-block">
<div class="line">JMS APIを利用するためのリソースの生成や解放などをテンプレート化したクラス。</div>
<div class="line">メッセージの送信及びメッセージの同期受信機能を行う際に使用することで実装を簡素化できる。</div>
<div class="line">基本的には、<code class="docutils literal"><span class="pre">org.springframework.messaging.Message</span></code>を扱うことができる <code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>を使用する。</div>
<div class="line"><code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>は<code class="docutils literal"><span class="pre">JmsTemplate</span></code>をラップしているため、<code class="docutils literal"><span class="pre">JmsTemplate</span></code>のプロパティを利用することで設定を行うことができる。</div>
<div class="line">ただし、一部<code class="docutils literal"><span class="pre">JmsTemplate</span></code>をそのまま使用したほうがよい場合が存在する。具体的な使用例については後ほど説明する。</div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">org.springframework.jms.listener.DefaultMessageListenerContainer</span></code></dt>
<dd><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code>はQueueからメッセージを受け取り、受け取ったメッセージを処理する<code class="docutils literal"><span class="pre">MessageListener</span></code>を起動させる。</div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">&#64;org.springframework.jms.annotation.JmsListener</span></code></dt>
<dd><div class="first last line-block">
<div class="line">JMSの<code class="docutils literal"><span class="pre">MessageListener</span></code>として扱うメソッドであることを示すマーカアノテーション。</div>
<div class="line">メッセージを受け取った際に処理を行うメソッドに対して<code class="docutils literal"><span class="pre">&#64;JmsListener</span></code>アノテーションを付与する。</div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">org.springframework.jms.connection.JmsTransactionManager</span></code></dt>
<dd><div class="first last line-block">
<div class="line">JMS(<code class="docutils literal"><span class="pre">javax.jms.Connection</span></code>/ <code class="docutils literal"><span class="pre">javax.jms.Session</span></code>)のAPIを呼び出して、トランザクションを管理するための実装クラス。</div>
</div>
</dd>
</dl>
</li>
</ul>
<div class="section" id="jmsoverviewsyncsend">
<span id="id3"></span><h4><a class="toc-backref" href="#id31">8.2.1.3.1. メッセージを同期送信する場合</a><a class="headerlink" href="#jmsoverviewsyncsend" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">メッセージを同期送信する処理の流れについて図を用いて説明する。</div>
</div>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../../_images/JMSSendOverview.png"><img alt="Send of Spring JMS" src="../../_images/JMSSendOverview.png" style="width: 70%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Service内で、<code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>に対して「送信対象のDestination名」と「送信するメッセージのペイロード」を渡して処理を実行する。</div>
<div class="line"><code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>は<code class="docutils literal"><span class="pre">JmsTemplate</span></code>に処理を委譲する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsTemplate</span></code>はJNDI経由で取得された<code class="docutils literal"><span class="pre">ConnectionFactory</span></code>から<code class="docutils literal"><span class="pre">javax.jms.Connection</span></code>を取得する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsTemplate</span></code>は <code class="docutils literal"><span class="pre">MessageProducer</span></code>に<code class="docutils literal"><span class="pre">Destination</span></code>とメッセージを渡す。</div>
<div class="line"><code class="docutils literal"><span class="pre">MessageProducer</span></code>は<code class="docutils literal"><span class="pre">javax.jms.Session</span></code>から生成される。(<code class="docutils literal"><span class="pre">Session</span></code>は(2)で取得した<code class="docutils literal"><span class="pre">Connection</span></code>から生成される。)</div>
<div class="line">また、<code class="docutils literal"><span class="pre">Destination</span></code>は(1)で渡された「送信対象のDestination名」をもとにJNDI経由で取得される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">MessageProducer</span></code>は送信対象の<code class="docutils literal"><span class="pre">Destination</span></code>へメッセージを送信する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="jmsoverviewasyncreceive">
<span id="id4"></span><h4><a class="toc-backref" href="#id32">8.2.1.3.2. メッセージを非同期受信する場合</a><a class="headerlink" href="#jmsoverviewasyncreceive" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">メッセージを非同期受信する処理の流れについて図を用いて説明する。</div>
</div>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../../_images/JMSASyncOverview.png"><img alt="ASync of Spring JMS" src="../../_images/JMSASyncOverview.png" style="width: 70%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JNDI経由で取得された<code class="docutils literal"><span class="pre">ConnectionFactory</span></code>から<code class="docutils literal"><span class="pre">Connection</span></code>を取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code>は<code class="docutils literal"><span class="pre">MessageConsumer</span></code>に<code class="docutils literal"><span class="pre">Destination</span></code>を渡す。</div>
<div class="line"><code class="docutils literal"><span class="pre">MessageConsumer</span></code>は<code class="docutils literal"><span class="pre">Session</span></code>から生成される。(<code class="docutils literal"><span class="pre">Session</span></code>は(1)で取得した<code class="docutils literal"><span class="pre">Connection</span></code>から生成される。)</div>
<div class="line">また、<code class="docutils literal"><span class="pre">Destination</span></code>は<code class="docutils literal"><span class="pre">&#64;JmsListener</span></code>アノテーションで指定された「受信対象のDestination名」をもとにJNDI経由で取得される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">MessageConsumer</span></code>は<code class="docutils literal"><span class="pre">Destination</span></code>からメッセージを受信する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">受信したメッセージを引数として、<code class="docutils literal"><span class="pre">MessageListener</span></code>内の<code class="docutils literal"><span class="pre">&#64;JmsListener</span></code>アノテーションが設定されたメソッド(リスナーメソッド)が呼び出される。リスナーメソッドは<code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code>で管理される。</div>
<div class="line"><br /></div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="jmsoverviewsyncreceive">
<span id="id5"></span><h4><a class="toc-backref" href="#id33">8.2.1.3.3. メッセージを同期受信する場合</a><a class="headerlink" href="#jmsoverviewsyncreceive" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">メッセージを同期受信する処理の流れについて図を用いて説明する。</div>
</div>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../../_images/JMSSyncOverview.png"><img alt="Sync of Spring JMS" src="../../_images/JMSSyncOverview.png" style="width: 70%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Service内で、<code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>に対して、「受信対象のDestination名」を渡す。</div>
<div class="line"><code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>は<code class="docutils literal"><span class="pre">JmsTemplate</span></code>に処理を委譲する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsTemplate</span></code>はJNDI経由で取得された<code class="docutils literal"><span class="pre">ConnectionFactory</span></code>から<code class="docutils literal"><span class="pre">Connection</span></code>を取得する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsTemplate</span></code>は<code class="docutils literal"><span class="pre">MessageConsumer</span></code>に<code class="docutils literal"><span class="pre">Destination</span></code>とメッセージを渡す。</div>
<div class="line"><code class="docutils literal"><span class="pre">MessageConsumer</span></code>は<code class="docutils literal"><span class="pre">Session</span></code>から生成される。(<code class="docutils literal"><span class="pre">Session</span></code>は(2)で取得した<code class="docutils literal"><span class="pre">Connection</span></code>から生成される。)</div>
<div class="line">また、<code class="docutils literal"><span class="pre">Destination</span></code>は(1)で渡された「受信対象のDestination名」をもとにJNDI経由で取得される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">MessageConsumer</span></code>は<code class="docutils literal"><span class="pre">Destination</span></code>からメッセージを受信する。</div>
<div class="line">メッセージは<code class="docutils literal"><span class="pre">JmsTemplate</span></code>や<code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>を経由してServiceに返却される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div>
<div class="section" id="jmsoverviewaboutprojectconfiguration">
<span id="id6"></span><h3><a class="toc-backref" href="#id34">8.2.1.4. プロジェクト構成について</a><a class="headerlink" href="#jmsoverviewaboutprojectconfiguration" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">JMSを利用する場合のプロジェクトの推奨構成について説明する。</div>
<div class="line">シリアライズしたJavaBeanを<code class="docutils literal"><span class="pre">ObjectMessage</span></code>経由で送受信する場合、このJavaBeanを送信側と受信側で共有する必要がある。</div>
<div class="line">この場合、既存のブランクプロジェクトとは別にmodelプロジェクトを追加することを推奨する。</div>
</div>
<ul class="simple">
<li><strong>modelの共有</strong></li>
</ul>
<blockquote>
<div><ul>
<li><p class="first">送信または受信側のクライアントがmodelを提供していない場合</p>
<p>modelプロジェクトを追加して、通信先のクライアントにJarファイルを配布する。</p>
</li>
<li><p class="first">送信または受信側のクライアントがmodelを提供している場合</p>
<p>提供されたmodelをライブラリに追加する。</p>
</li>
</ul>
<div class="line-block">
<div class="line">modelプロジェクト、または、配布されたアーカイブファイルと既存のプロジェクトとの関係は以下のようになる。</div>
</div>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../../_images/ProjectStructure.png"><img alt="Projects" src="../../_images/ProjectStructure.png" style="width: 70%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="30%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">プロジェクト名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">webプロジェクト</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">非同期受信を行うためのリスナークラスを配置する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">domainプロジェクト</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">非同期受信を行うためのリスナークラスから実行されるServiceを配置する。</div>
<div class="line">その他、Repositoryなどは従来と同じである。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">modelプロジェクトもしくはJarファイル</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ドメイン層に属するクラスのうち、クライアント間で共有するクラスを使用する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><div class="line-block">
<div class="line">modelプロジェクトを追加するためには、以下を実施する。</div>
</div>
<blockquote>
<div><ul class="simple">
<li>modelプロジェクトの作成</li>
<li>domainプロジェクトからmodelプロジェクトへの依存関係の追加</li>
</ul>
</div></blockquote>
<div class="line-block">
<div class="line">詳細な追加方法については、同じようにJavaBeanの共有を行っている
<a class="reference internal" href="../WebServiceDetail/SOAP.html"><span class="doc">SOAP Web Service（サーバ/クライアント）</span></a>の<a class="reference internal" href="../WebServiceDetail/SOAP.html#soapappendixaddproject"><span class="std std-ref">SOAPサーバ用にプロジェクトの設定を変更する</span></a> を参照されたい。</div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="how-to-use">
<span id="jmshowtouse"></span><h2><a class="toc-backref" href="#id35">8.2.2. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<div class="section" id="jmshowtouseenviromentsetting">
<span id="id7"></span><h3><a class="toc-backref" href="#id36">8.2.2.1. メッセージの送受信に共通する設定</a><a class="headerlink" href="#jmshowtouseenviromentsetting" title="Permalink to this headline">¶</a></h3>
<p>本節では、メッセージの送受信に必要となる共通的な設定について説明する。</p>
<div class="section" id="jmshowtousedependentlibrary">
<span id="id8"></span><h4><a class="toc-backref" href="#id37">8.2.2.1.1. 依存ライブラリの設定</a><a class="headerlink" href="#jmshowtousedependentlibrary" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Spring FrameworkのJMS連携用コンポーネントを利用するために、domainプロジェクトのpom.xmlにSpring Frameworkの<code class="docutils literal"><span class="pre">spring-jms</span></code>を追加する。</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/pom.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependencies&gt;</span>

     <span class="c">&lt;!-- (1) --&gt;</span>
     <span class="nt">&lt;dependency&gt;</span>
         <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
         <span class="nt">&lt;artifactId&gt;</span>spring-jms<span class="nt">&lt;/artifactId&gt;</span>
     <span class="nt">&lt;/dependency&gt;</span>
     <span class="c">&lt;!-- (2) --&gt;</span>
     <span class="nt">&lt;dependency&gt;</span>
         <span class="nt">&lt;groupId&gt;</span>jakarta.jms<span class="nt">&lt;/groupId&gt;</span>
         <span class="nt">&lt;artifactId&gt;</span>jakarta.jms-api<span class="nt">&lt;/artifactId&gt;</span>
         <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
     <span class="nt">&lt;/dependency&gt;</span>
 <span class="nt">&lt;/dependencies&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">spring-jms</span></code>をdependenciesに追加する。</div>
<div class="line"><code class="docutils literal"><span class="pre">spring-jms</span></code>は<code class="docutils literal"><span class="pre">spring-messaging</span></code>に依存するため、<code class="docutils literal"><span class="pre">spring-messaging</span></code>も推移的に依存ライブラリとして追加される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring Framework 5.0より実行時にJMS 2.0のAPIが必要となるため、実行環境に<code class="docutils literal"><span class="pre">jakarta.jms-api</span></code>が必要となることを<code class="docutils literal"><span class="pre">provided</span></code>スコープで明示する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">spring-jms</span></code>の他に、pom.xmlにJMSプロバイダのライブラリを追加する。</div>
<div class="line">pom.xmlへのライブラリの追加例については、<a class="reference internal" href="#jmsappendixsettingsdependsonjmsprovider"><span class="std std-ref">JMSプロバイダに依存する設定</span></a> を参照されたい。</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">上記設定例は、依存ライブラリのバージョンを親プロジェクトである terasoluna-gfw-parent で管理する前提であるため、pom.xmlでのバージョンの指定は不要である。
上記の依存ライブラリはterasoluna-gfw-parentが依存している<a class="reference external" href="https://docs.spring.io/spring-boot/docs/2.4.1/reference/htmlsingle/#dependency-versions">Spring Boot</a>で管理されている。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Spring Framework 5.0より、JMS 2.0に対応した。
JMS 1.1との後方互換性も維持されているため、JMS 1.1で動作させることも可能である。
ただし、JMS 1.1で動作させる場合でも、JMS 2.0のAPIをクラスパスに追加する必要がある。
詳細は、<a class="reference external" href="https://github.com/spring-projects/spring-framework/issues/18366">spring-projects/spring-framework/issues/#18366</a>を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="connectionfactory">
<span id="jmshowtouseconnectionfactory"></span><h4><a class="toc-backref" href="#id38">8.2.2.1.2. <code class="docutils literal"><span class="pre">ConnectionFactory</span></code>の設定</a><a class="headerlink" href="#connectionfactory" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">ConnectionFactory</span></code>の定義の方法には、アプリケーションサーバで定義する方法と、Bean定義ファイルで定義する方法がある。</div>
<div class="line">特別な理由がない場合、Bean定義ファイルをJMSプロバイダ非依存とするため、アプリケーションサーバで定義する方法を選択する。</div>
<div class="line">本節では、アプリケーションサーバで定義する方法についてのみ説明する。</div>
<div class="line">アプリケーションサーバで定義した<code class="docutils literal"><span class="pre">ConnectionFactory</span></code>を使用するためには、Bean定義ファイルにJNDI経由で取得したJavaBeanを利用するための設定を行う必要がある。</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-env/src/main/resources/META-INF/spring/[projectName]-env.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;jee:jndi-lookup</span> <span class="na">id=</span><span class="s">&quot;connectionFactory&quot;</span> <span class="na">jndi-name=</span><span class="s">&quot;jms/ConnectionFactory&quot;</span><span class="nt">/&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">jndi-name</span></code>属性に、アプリケーションサーバ提供の<code class="docutils literal"><span class="pre">ConnectionFactory</span></code>のJNDI名を指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">resource-ref</span></code>属性がデフォルトで<code class="docutils literal"><span class="pre">true</span></code>のため、JNDI名にプレフィックス(java:comp/env/)がない場合は、自動的に付与される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Bean定義したConnectionFactoryを使用する場合</strong></p>
<p class="last">JNDIを利用しない場合、<code class="docutils literal"><span class="pre">ConnectionFactory</span></code>の実装クラスをBean定義することでも<code class="docutils literal"><span class="pre">ConnectionFactory</span></code>を利用することが可能である。
この場合、<code class="docutils literal"><span class="pre">ConnectionFactory</span></code>の実装クラスはJMSプロバイダ依存となる。詳細については、<a class="reference internal" href="#jmsappendixsettingsdependsonjmsprovider"><span class="std std-ref">JMSプロバイダに依存する設定</span></a> の”JNDIを使用しない場合の設定”を参照されたい。</p>
</div>
</div></blockquote>
</div>
<div class="section" id="destinationresolver">
<span id="jmshowtousedestinationresolver"></span><h4><a class="toc-backref" href="#id39">8.2.2.1.3. <code class="docutils literal"><span class="pre">DestinationResolver</span></code>の設定</a><a class="headerlink" href="#destinationresolver" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Destinationの名前解決には、JNDIによる解決とJMSプロバイダでの解決の二通りの方法がある。</div>
<div class="line">デフォルトではJMSプロバイダでの解決が行われるが、ポータビリティや管理の観点から、特別な理由がない場合はJNDIによる解決を推奨する。</div>
</div>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.jms.support.destination.JndiDestinationResolver</span></code>を使用することで、JNDI名によりDestinationの名前解決を行うことができる。</div>
<div class="line">以下に<code class="docutils literal"><span class="pre">JndiDestinationResolver</span></code>の定義例を示す。</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-env/src/main/resources/META-INF/spring/[projectName]-env.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;destinationResolver&quot;</span>
   <span class="na">class=</span><span class="s">&quot;org.springframework.jms.support.destination.JndiDestinationResolver&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;resourceRef&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JndiDestinationResolver</span></code>をBean定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">JNDI名にプレフィックス(java:comp/env/)がないときに、自動的に付与させる場合は<code class="docutils literal"><span class="pre">true</span></code>を設定する。デフォルトは<code class="docutils literal"><span class="pre">false</span></code>である。</div>
</div>
<div class="last admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><code class="docutils literal"><span class="pre">&lt;jee:jndi-lookup/&gt;</span></code>の<code class="docutils literal"><span class="pre">resource-ref</span></code>属性とはデフォルト値が異なることに注意されたい。</p>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>DynamicDestinationResolverを使用する場合</strong></p>
<p class="last">JNDIを利用せずにJMSプロバイダでDestinationの名前解決する場合、<code class="docutils literal"><span class="pre">DynamicDestinationResolver</span></code>を利用する。
<code class="docutils literal"><span class="pre">DynamicDestinationResolver</span></code>の設定については、<a class="reference internal" href="#jmsappendixsettingsdependsonjmsprovider"><span class="std std-ref">JMSプロバイダに依存する設定</span></a> の”JNDIを使用しない場合の設定”を参照されたい。</p>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="jmshowtousesyncsendmessage">
<span id="id9"></span><h3><a class="toc-backref" href="#id40">8.2.2.2. メッセージを同期送信する方法</a><a class="headerlink" href="#jmshowtousesyncsendmessage" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">PTPモデルにて、クライアント（Producer）からJMSプロバイダへメッセージを同期送信する方法を説明する。</div>
</div>
<div class="section" id="jmshowtousesettingforsyncsend">
<span id="id10"></span><h4><a class="toc-backref" href="#id41">8.2.2.2.1. 基本的な同期送信</a><a class="headerlink" href="#jmshowtousesettingforsyncsend" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>を利用して、JMSプロバイダへの同期送信処理を実現する。</div>
</div>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">Todo</span></code>クラスのオブジェクトをメッセージ同期送信する場合の実装例を示す。</div>
<div class="line">最初に<code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>の設定方法を示す。</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-env/src/main/resources/META-INF/spring/[projectName]-env.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;cachingConnectionFactory&quot;</span>
   <span class="na">class=</span><span class="s">&quot;org.springframework.jms.connection.CachingConnectionFactory&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
   <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;targetConnectionFactory&quot;</span> <span class="na">ref=</span><span class="s">&quot;connectionFactory&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
   <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;sessionCacheSize&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Session</span></code>、<code class="docutils literal"><span class="pre">MessageProducer/Consumer</span></code>のキャッシュを行う<code class="docutils literal"><span class="pre">org.springframework.jms.connection.CachingConnectionFactory</span></code>をBean定義する。</div>
<div class="line">Bean定義もしくはJNDI名でルックアップしたJMSプロバイダ固有の<code class="docutils literal"><span class="pre">ConnectionFactory</span></code>をそのまま使うのではなく、
<code class="docutils literal"><span class="pre">CachingConnectionFactory</span></code>にラップして使用することで、キャッシュ機能を使用することができる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Bean定義もしくはJNDI名でルックアップしたJMSプロバイダ固有の<code class="docutils literal"><span class="pre">ConnectionFactory</span></code>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Session</span></code>のキャッシュ数を設定する。（デフォルト値は1）</div>
<div class="line">この例では1を指定しているが、性能要件に応じて適宜キャッシュ数を変更すること。</div>
<div class="line">このキャッシュ数を超えてセッションが必要になるとキャッシュを使用せず、新しいセッションの作成と破棄を繰り返すことになる。</div>
<div class="line">すると処理効率が下がり、性能劣化の原因になるので注意すること。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/resources/META-INF/spring/[projectName]-infra.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;jmsTemplate&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.jms.core.JmsTemplate&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;connectionFactory&quot;</span> <span class="na">ref=</span><span class="s">&quot;cachingConnectionFactory&quot;</span> <span class="nt">/&gt;</span>
   <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;destinationResolver&quot;</span> <span class="na">ref=</span><span class="s">&quot;destinationResolver&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;jmsMessagingTemplate&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.jms.core.JmsMessagingTemplate&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;jmsTemplate&quot;</span> <span class="na">ref=</span><span class="s">&quot;jmsTemplate&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsTemplate</span></code>をBean定義する。</div>
<div class="line"><code class="docutils literal"><span class="pre">JmsTemplate</span></code>は低レベルのAPIハンドリング（JMS API呼び出し）を代行する。</div>
<div class="line">設定可能な属性に関しては、下記の<code class="docutils literal"><span class="pre">JmsTemplate</span></code>の属性一覧を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>をBean定義する。同期送信処理を代行する<code class="docutils literal"><span class="pre">JmsTemplate</span></code>をインジェクションする。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line">同期送信に関連する<code class="docutils literal"><span class="pre">JmsTemplate</span></code>の属性は以下が存在する。</div>
<div class="line">必要に応じて設定を行う必要がある。</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="5%" />
<col width="20%" />
<col width="50%" />
<col width="15%" />
<col width="10%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">設定項目</th>
<th class="head">内容</th>
<th class="head">必須</th>
<th class="head">デフォルト値</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">connectionFactory</span></code></td>
<td><div class="first last line-block">
<div class="line">使用する<code class="docutils literal"><span class="pre">ConnectionFactory</span></code>を設定する。</div>
</div>
</td>
<td>○</td>
<td>なし（必須であるため）</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">pubSubDomain</span></code></td>
<td><div class="first last line-block">
<div class="line">メッセージングモデルについて設定する。</div>
<div class="line">PTP（Queue）モデルは<code class="docutils literal"><span class="pre">false</span></code>、Pub/Sub（Topic）は<code class="docutils literal"><span class="pre">true</span></code>に設定する。</div>
</div>
</td>
<td>-</td>
<td><code class="docutils literal"><span class="pre">false</span></code></td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">sessionTransacted</span></code></td>
<td><div class="first last line-block">
<div class="line">セッションでのトランザクション管理をするかどうか設定する。</div>
<div class="line">本ガイドラインでは、後述するトランザクション管理を使用するため、デフォルトのままの<code class="docutils literal"><span class="pre">false</span></code>を推奨する。</div>
</div>
</td>
<td>-</td>
<td><code class="docutils literal"><span class="pre">false</span></code></td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">messageConverter</span></code></td>
<td><div class="first last line-block">
<div class="line">メッセージコンバータを設定する。</div>
<div class="line">本ガイドラインで紹介している範囲では、デフォルトのままで問題ない。</div>
</div>
</td>
<td>-</td>
<td><code class="docutils literal"><span class="pre">SimpleMessageConverter</span></code>(*1)が使用される。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">destinationResolver</span></code></td>
<td><div class="first last line-block">
<div class="line">DestinationResolverを設定する。</div>
<div class="line">本ガイドラインでは、JNDIで名前解決を行う、<code class="docutils literal"><span class="pre">JndiDestinationResolver</span></code>を設定することを推奨する。</div>
</div>
</td>
<td>-</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DynamicDestinationResolver</span></code>(*2)が使用される。</div>
<div class="line">(<code class="docutils literal"><span class="pre">DynamicDestinationResolver</span></code>を利用するとJMSプロバイダでDestinationの名前解決が行われる。)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">defaultDestination</span></code></td>
<td><div class="first last line-block">
<div class="line">既定のDestinationを設定する。</div>
<div class="line">Destinationを明示的に指定しない場合、このDestinationが使用される。</div>
</div>
</td>
<td>-</td>
<td>null(既定のDestinationなし)</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">deliveryMode</span></code></td>
<td><div class="first last line-block">
<div class="line">配信モードを1(NON_PERSISTENT)、2(PERSISTENT)から設定する。</div>
<div class="line">2(PERSISTENT)は、メッセージの永続化を行う。</div>
<div class="line">1(NON_PERSISTENT)は、メッセージの永続化を行わない。</div>
<div class="line">そのため、性能は上がるが、JMSプロバイダの再起動などが起こるとメッセージが消失する可能性がある。</div>
<div class="line">本ガイドラインでは、メッセージの消失を避けるため、 2(PERSISTENT)を使用することを推奨する。</div>
<div class="line">この設定を使用する場合、後述する<code class="docutils literal"><span class="pre">explicitQosEnabled</span></code>に<code class="docutils literal"><span class="pre">true</span></code>を設定する必要があるので注意すること。</div>
</div>
</td>
<td>-</td>
<td>2(PERSISTENT)</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="8">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">priority</span></code></td>
<td><div class="first last line-block">
<div class="line">メッセージの優先度を設定する。優先度は0から9まで設定できる。</div>
<div class="line">数値が大きいほど優先度が高くなる。</div>
<div class="line">同期送信時にメッセージがQueueに格納される時点で優先度が評価され、優先度が高いメッセージは低いメッセージより先に取り出されるように格納される。</div>
<div class="line">優先度が同じメッセージはFIFO（First-In First-Out）で扱われる。</div>
<div class="line">この設定を使用する場合、後述する<code class="docutils literal"><span class="pre">explicitQosEnabled</span></code>に<code class="docutils literal"><span class="pre">true</span></code>を設定する必要があるので注意すること。</div>
</div>
</td>
<td>-</td>
<td>4</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="9">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">timeToLive</span></code></td>
<td><div class="first last line-block">
<div class="line">メッセージの有効期限をミリ秒で設定する。</div>
<div class="line">メッセージが有効期限に達すると、JMSプロバイダはQueueからメッセージを削除する。</div>
<div class="line">この設定を使用する場合、後述する<code class="docutils literal"><span class="pre">explicitQosEnabled</span></code>に<code class="docutils literal"><span class="pre">true</span></code>を設定する必要があるので注意すること。</div>
</div>
</td>
<td>-</td>
<td>0（無制限）</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="10">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">explicitQosEnabled</span></code></td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">deliveryMode</span></code>、<code class="docutils literal"><span class="pre">priority</span></code>、<code class="docutils literal"><span class="pre">timeToLive</span></code>を有効にする場合は<code class="docutils literal"><span class="pre">true</span></code>を設定する。</div>
</div>
</td>
<td>-</td>
<td><code class="docutils literal"><span class="pre">false</span></code></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>(*1)<code class="docutils literal"><span class="pre">org.springframework.jms.support.converter.SimpleMessageConverter</span></code></p>
<p>(*2)<code class="docutils literal"><span class="pre">org.springframework.jms.support.destination.DynamicDestinationResolver</span></code></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">次に送信対象のJavaBeanを作成する。</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/java/com/example/domain/model/Todo.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.model</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Todo</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span> <span class="c1">// (1)</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1L</span><span class="p">;</span>

    <span class="c1">// omitted</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">description</span><span class="p">;</span>

    <span class="c1">// omitted</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">finished</span><span class="p">;</span>

    <span class="c1">// omitted</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getDescription</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">description</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDescription</span><span class="p">(</span><span class="n">String</span> <span class="n">description</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">description</span> <span class="o">=</span> <span class="n">description</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isFinished</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">finished</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFinished</span><span class="p">(</span><span class="kt">boolean</span> <span class="n">finished</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">finished</span> <span class="o">=</span> <span class="n">finished</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">基本的には通常のJavaBeanで問題ないが、シリアライズして送信するため、<code class="docutils literal"><span class="pre">java.io.Serializable</span></code>インタフェース を実装する必要がある。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line">最後に実際に同期送信を行う処理を記述する。</div>
<div class="line">以下では、指定したテキストをもつ<code class="docutils literal"><span class="pre">Todo</span></code>オブジェクトをQueueに同期送信する実装例を示す。</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/java/com/example/domain/service/todo/TodoServiceImpl.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jms.core.JmsMessagingTemplate</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">JmsMessagingTemplate</span> <span class="n">jmsMessagingTemplate</span><span class="p">;</span>    <span class="c1">// (1)</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendMessage</span><span class="p">(</span><span class="n">String</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>

       <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Todo</span><span class="p">();</span>
       <span class="c1">// omitted</span>

       <span class="n">jmsMessagingTemplate</span><span class="p">.</span><span class="na">convertAndSend</span><span class="p">(</span><span class="s">&quot;jms/queue/TodoMessageQueue&quot;</span><span class="p">,</span> <span class="n">todo</span><span class="p">);</span>  <span class="c1">// (2)</span>

    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>をインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>の<code class="docutils literal"><span class="pre">convertAndSend</span></code>メソッドを使用して、引数のJavaBeanを<code class="docutils literal"><span class="pre">org.springframework.messaging.Message</span></code>インタフェースの実装クラスに変換し、指定したDestinationに対しメッセージを同期送信する。</div>
<div class="line">デフォルトで変換には、<code class="docutils literal"><span class="pre">org.springframework.jms.support.converter.SimpleMessageConverter</span></code>が使用される。</div>
<div class="line"><code class="docutils literal"><span class="pre">SimpleMessageConverter</span></code>を使用すると、<code class="docutils literal"><span class="pre">javax.jms.Message</span></code>、<code class="docutils literal"><span class="pre">java.lang.String</span></code>、<code class="docutils literal"><span class="pre">byte配列</span></code>、<code class="docutils literal"><span class="pre">java.util.Map</span></code>、<code class="docutils literal"><span class="pre">java.io.Serializable</span></code>インタフェースを実装したクラスを送信可能である。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>業務ロジック内でJMSの例外ハンドリング</strong></p>
<p><a class="reference external" href="https://docs.spring.io/spring/docs/5.3.2/javadoc-api/org/springframework/jms/core/JmsTemplate.html">JMS (Java Message Service)のIntroduction</a>で触れられているように、Spring Frameworkでは検査例外を非検査例外に変換している。
そのため、業務ロジック内でJMSの例外をハンドリングする場合は、非検査例外を扱う必要がある。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="20%" />
<col width="60%" />
<col width="20%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Templateクラス</th>
<th class="head">例外の変換を行うメソッド</th>
<th class="head">変換後の例外</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>の<code class="docutils literal"><span class="pre">convertJmsException</span></code>メソッド</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">MessagingException</span></code>(*1)及びそのサブ例外</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsTemplate</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsAccessor</span></code>の<code class="docutils literal"><span class="pre">convertJmsAccessException</span></code>メソッド</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsException</span></code>(*2)及びそのサブ例外</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>(*1) <code class="docutils literal"><span class="pre">org.springframework.messaging.MessagingException</span></code></p>
<p class="last">(*2) <code class="docutils literal"><span class="pre">org.springframework.jms.JmsException</span></code></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="jmshowtousesettingforsendwithheader">
<span id="id11"></span><h4><a class="toc-backref" href="#id42">8.2.2.2.2. メッセージヘッダを編集して同期送信する場合</a><a class="headerlink" href="#jmshowtousesettingforsendwithheader" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>の<code class="docutils literal"><span class="pre">convertAndSend</span></code>メソッドの引数にKey-Value形式のヘッダ属性と値を指定することで、ヘッダ属性を編集して同期送信することが可能である。
ヘッダの詳細については、<a class="reference external" href="https://jakarta.ee/specifications/platform/8/apidocs/javax/jms/message">javax.jms.Message</a>を参照されたい。
送信、応答メッセージなどを紐づける役割の<code class="docutils literal"><span class="pre">JMSCorrelationID</span></code>を同期送信時に指定する場合の実装例を示す。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/java/com/example/domain/service/todo/TodoServiceImpl.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jms.core.JmsMessagingTemplate</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jms.support.JmsHeaders</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="p">{</span>

<span class="nd">@Inject</span>
<span class="n">JmsMessagingTemplate</span> <span class="n">jmsMessagingTemplate</span><span class="p">;</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendMessageWithCorrelationId</span><span class="p">(</span><span class="n">String</span> <span class="n">correlationId</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Todo</span><span class="p">();</span>
    <span class="c1">// omitted</span>

    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
    <span class="n">headers</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">JmsHeaders</span><span class="p">.</span><span class="na">CORRELATION_ID</span><span class="p">,</span> <span class="n">correlationId</span><span class="p">);</span><span class="c1">// (1)</span>

    <span class="n">jmsMessagingTemplate</span><span class="p">.</span><span class="na">convertAndSend</span><span class="p">(</span><span class="s">&quot;jms/queue/TodoMessageQueue&quot;</span><span class="p">,</span>
            <span class="n">todo</span><span class="p">,</span> <span class="n">headers</span><span class="p">);</span> <span class="c1">// (2)</span>

  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Map</span></code>の実装クラスに対し、ヘッダ属性名とその値を設定してヘッダ情報を作成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>の<code class="docutils literal"><span class="pre">convertAndSend</span></code>メソッドを使用することで、(2)で作成したヘッダ情報を付与したメッセージを同期送信する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>編集可能なヘッダ属性について</strong></p>
<p class="last">Spring Frameworkの<code class="docutils literal"><span class="pre">SimpleMessageConverter</span></code>によるメッセージ変換時には、ヘッダ属性の一部(<code class="docutils literal"><span class="pre">JMSDestination</span></code>、<code class="docutils literal"><span class="pre">JMSDeliveryMode</span></code>、<code class="docutils literal"><span class="pre">JMSExpiration</span></code>、<code class="docutils literal"><span class="pre">JMSMessageID</span></code>、<code class="docutils literal"><span class="pre">JMSPriority</span></code>、<code class="docutils literal"><span class="pre">JMSRedelivered</span></code>と<code class="docutils literal"><span class="pre">JMSTimestamp</span></code>)をread-onlyとして扱っている。
そのため、上記の実装例のようにread-onlyのヘッダ属性を設定しても、送信したメッセージのヘッダには格納されない。（メッセージのプロパティとして保持される。）
read-onlyのヘッダ属性うち、<code class="docutils literal"><span class="pre">JMSDeliveryMode</span></code>や<code class="docutils literal"><span class="pre">JMSPriority</span></code>については、<code class="docutils literal"><span class="pre">JmsTemplate</span></code>単位での設定が可能である。
詳細については、<a class="reference internal" href="#jmshowtousesettingforsyncsend"><span class="std std-ref">基本的な同期送信</span></a> の<code class="docutils literal"><span class="pre">JmsTemplate</span></code>の属性一覧を参照されたい。</p>
</div>
</div></blockquote>
</div>
<div class="section" id="jmshowtousesettingforsyncsendtransactionmanagement">
<span id="id12"></span><h4><a class="toc-backref" href="#id43">8.2.2.2.3. トランザクション管理</a><a class="headerlink" href="#jmshowtousesettingforsyncsendtransactionmanagement" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">データの一貫性を保証する必要がある場合は、トランザクション管理機能を使用する。</div>
<div class="line">本ガイドラインで推奨する「宣言型トランザクション管理」を利用した実装例を以下に示す。</div>
<div class="line">「宣言型トランザクション管理」の詳細は、<a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html#service-transaction-management"><span class="std std-ref">トランザクション管理について</span></a> を参照されたい。</div>
<div class="line"><br /></div>
<div class="line">トランザクション管理を実現するためには、<code class="docutils literal"><span class="pre">org.springframework.jms.connection.JmsTransactionManager</span></code>を利用する。</div>
<div class="line">最初に設定例を示す。</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/resources/META-INF/spring/[projectName]-infra.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sendJmsTransactionManager&quot;</span>
   <span class="na">class=</span><span class="s">&quot;org.springframework.jms.connection.JmsTransactionManager&quot;</span><span class="nt">&gt;</span>
   <span class="c">&lt;!-- (2) --&gt;</span>
   <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;connectionFactory&quot;</span> <span class="na">ref=</span><span class="s">&quot;cachingConnectionFactory&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsTransactionManager</span></code>をBean定義する。</div>
</div>
<div class="last admonition note">
<p class="first admonition-title">Note</p>
<p><strong>TransactionManagerのbean名について</strong></p>
<p><code class="docutils literal"><span class="pre">&#64;Transactional</span></code>アノテーションを付与した場合、デフォルトではBean名<code class="docutils literal"><span class="pre">transactionManager</span></code>で登録されているBeanが使用される。
(詳細は、<a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html#domainlayerappendixtransactionmanagement"><span class="std std-ref">トランザクション管理を使うための設定について</span></a> を参照されたい)</p>
<p>Blankプロジェクトには、<code class="docutils literal"><span class="pre">transactionManager</span></code>というBean名で<code class="docutils literal"><span class="pre">DataSourceTransactionManager</span></code>が定義されているため、上記の設定では別名でBeanを定義している。</p>
<p class="last">そのため、アプリケーション内で、<code class="docutils literal"><span class="pre">TransactionManager</span></code>を1つしか使用しない場合は、bean名を<code class="docutils literal"><span class="pre">transactionManager</span></code>にすることで<code class="docutils literal"><span class="pre">&#64;Transactional</span></code>アノテーションでの<code class="docutils literal"><span class="pre">transactionManager</span></code>属性の指定を省略することができる。</p>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">トランザクションを管理する<code class="docutils literal"><span class="pre">CachingConnectionFactory</span></code>を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>トランザクション管理を行い、<code class="docutils literal"><span class="pre">Todo</span></code>オブジェクトをQueueに同期送信する実装例を以下に示す。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/java/com/example/domain/service/todo/TodoServiceImpl.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jms.core.JmsMessagingTemplate</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span><span class="p">(</span><span class="s">&quot;sendJmsTransactionManager&quot;</span><span class="p">)</span>  <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="p">{</span>
   <span class="nd">@Inject</span>
   <span class="n">JmsMessagingTemplate</span> <span class="n">jmsMessagingTemplate</span><span class="p">;</span>

   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendMessage</span><span class="p">(</span><span class="n">String</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>

      <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Todo</span><span class="p">();</span>
      <span class="c1">// omitted</span>

      <span class="n">jmsMessagingTemplate</span><span class="p">.</span><span class="na">convertAndSend</span><span class="p">(</span><span class="s">&quot;jms/queue/TodoMessageQueue&quot;</span><span class="p">,</span> <span class="n">todo</span><span class="p">);</span>  <span class="c1">// (2)</span>
   <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;Transactional</span></code>アノテーションを利用してトランザクション境界を宣言する。</div>
<div class="line">これにより、クラス内の各メソッドの開始時にトランザクションが開始され、メソッドの終了時にトランザクションがコミットされる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Queueにメッセージを同期送信する。</div>
<div class="line">ただし、実際にメッセージがQueueに送信されるのはトランザクションがコミットされるタイミングとなるので注意すること。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>DBのトランザクション管理を行う必要があるアプリケーションでは、業務の要件をもとにJMSとDBのトランザクションの関連を精査した上でトランザクションの管理方針を決定すること。</p>
<blockquote>
<div><blockquote>
<div><p>JMSとDBのトランザクションの連携にはJTAによるグローバルトランザクションを使用する方法があるが、プロトコルの特性上、性能面のオーバーヘッドがかかるため、”Best Effort 1 Phase Commit”の使用を推奨する。詳細は以下を参照されたい。</p>
<div class="line-block">
<div class="line"><a class="reference external" href="http://www.javaworld.com/article/2077963/open-source-tools/distributed-transactions-in-spring--with-and-without-xa.html">Distributed transactions in Spring, with and without XA</a></div>
<div class="line"><a class="reference external" href="http://gharshangupta.blogspot.jp/2015/03/spring-distributed-transactions-using_2.html">Spring Distributed transactions using Best Effort 1 Phase Commit</a></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>メッセージ受信後にJMSプロバイダとの接続が切れるなどでJMSプロバイダにトランザクションの処理結果が返らない場合</strong></p>
<p class="last">メッセージ受信後にJMSプロバイダとの接続が切れるなどで、JMSプロバイダにトランザクションの処理結果が返らない場合、トランザクションの扱いはJMSプロバイダに依存する。
そのため、<strong>受信したメッセージの消失などを考慮した設計</strong>を行うこと。
特に、メッセージの消失が絶対に許されないような場合には、<strong>メッセージの消失を補う仕組みを用意するか、グローバルトランザクションなどの利用を検討する</strong>必要がある。</p>
</div>
<div class="line-block">
<div class="line">“Best Effort 1 Phase Commit”は<code class="docutils literal"><span class="pre">org.springframework.data.transaction.ChainedTransactionManager</span></code>を利用することで実現する。</div>
<div class="line">以下に、JMSのトランザクション管理に<a class="reference internal" href="#jmshowtousesettingforsyncsendtransactionmanagement"><span class="std std-ref">トランザクション管理</span></a>の<code class="docutils literal"><span class="pre">sendJmsTransactionManager</span></code>を使用し、DBのトランザクション管理にBlankプロジェクトのデフォルトの設定で定義されている<code class="docutils literal"><span class="pre">transactionManager</span></code>を使用する設定例を示す。</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/resources/META-INF/spring/[projectName]-infra.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sendChainedTransactionManager&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.data.transaction.ChainedTransactionManager&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg&gt;</span>
        <span class="nt">&lt;list&gt;</span>
            <span class="c">&lt;!-- (2) --&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;sendJmsTransactionManager&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;transactionManager&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ChainedTransactionManager</span></code>をBean定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JMSとDBのトランザクションマネージャを指定する。</div>
<div class="line">登録した順にトランザクションが開始され、登録した逆順にトランザクションがコミットされる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>上記の設定を利用した実装例を以下に示す。</p>
</div></blockquote>
<ul>
<li><p class="first"><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/java/com/example/domain/service/todo/ChainedTransactionalTodoServiceImpl.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jms.core.JmsMessagingTemplate</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span><span class="p">(</span><span class="s">&quot;sendChainedTransactionManager&quot;</span><span class="p">)</span>  <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChainedTransactionalTodoServiceImpl</span> <span class="kd">implements</span> <span class="n">ChainedTransactionalTodoService</span> <span class="p">{</span>
   <span class="nd">@Inject</span>
   <span class="n">JmsMessagingTemplate</span> <span class="n">jmsMessagingTemplate</span><span class="p">;</span>

   <span class="nd">@Inject</span>
   <span class="n">TodoSharedService</span> <span class="n">todoSharedService</span><span class="p">;</span>

   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendMessage</span><span class="p">(</span><span class="n">String</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Todo</span><span class="p">();</span>
       <span class="c1">// omitted</span>

       <span class="n">jmsMessagingTemplate</span><span class="p">.</span><span class="na">convertAndSend</span><span class="p">(</span><span class="s">&quot;jms/queue/TodoMessageQueue&quot;</span><span class="p">,</span> <span class="n">todo</span><span class="p">);</span> <span class="c1">// (2)</span>

       <span class="c1">// omitted</span>
       <span class="n">todoSharedService</span><span class="p">.</span><span class="na">insert</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span> <span class="c1">// (3)</span>
   <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;Transactional</span></code>アノテーションに<code class="docutils literal"><span class="pre">sendChainedTransactionManager</span></code>を指定することで、JMSとDBのトランザクション管理を行う。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;Transactional</span></code>アノテーションの詳細については、<a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html"><span class="doc">ドメイン層の実装</span></a>の<a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html#service-transaction-management"><span class="std std-ref">トランザクション管理について</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">メッセージの同期送信を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">DBアクセスを伴う処理を実行する。この例では、DBの更新を伴うSharedServiceを実行している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">業務上、JMSとDBなど複数のトランザクションをまとめて管理する必要がある場合、グローバルトランザクションを検討する。
グローバルトランザクションについては、<a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html#service-enable-transaction-management"><span class="std std-ref">トランザクション管理を使うための設定について</span></a>の”複数DB（複数リソース）に対するトランザクション管理（グローバルトランザクションの管理）が必要な場合”を参照されたい。</p>
</div>
</li>
</ul>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="jmshowtouseasyncreceivemessage">
<span id="id13"></span><h3><a class="toc-backref" href="#id44">8.2.2.3. メッセージを非同期受信する方法</a><a class="headerlink" href="#jmshowtouseasyncreceivemessage" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line"><a class="reference internal" href="#jmsoverviewaboutjms"><span class="std std-ref">JMSとは</span></a>の”メッセージ受信方式”で述べたように、一般的に受信処理を行う場合には非同期受信を利用する。</div>
<div class="line">非同期受信機能を司る<code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code>に対し、<code class="docutils literal"><span class="pre">&#64;JmsListener</span></code>アノテーションが付与されたリスナーメソッドを登録することで非同期受信処理を実現する。</div>
<div class="line">非同期受信時の処理を行うリスナーメソッドの役割として、以下が存在する。</div>
</div>
<ol class="arabic">
<li><div class="first line-block">
<div class="line"><strong>メッセージを受け取るためのメソッドを提供する。</strong></div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;JmsListener</span></code>アノテーションが付与されたメソッドを実装することで、メッセージを受け取ることができる。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line"><strong>業務処理の呼び出しを行う。</strong></div>
<div class="line">リスナーメソッドでは業務処理の実装は行わず、Serviceのメソッドに処理を委譲する。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line"><strong>業務ロジックで発生した例外のハンドリングを行う。</strong></div>
<div class="line">ビジネス例外や正常稼働時に発生するライブラリ例外のハンドリングを行う。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line"><strong>処理結果をメッセージ送信する。</strong></div>
<div class="line">応答メッセージなどの送信が必要なメソッドでは、<code class="docutils literal"><span class="pre">org.springframework.jms.listener.adapter.JmsResponse</span></code>を利用することで、指定したDestinationに対してリスナーメソッドや業務ロジックの処理結果をメッセージ送信することができる。</div>
</div>
</li>
</ol>
<div class="section" id="jmshowtouselistenercontainer">
<span id="id14"></span><h4><a class="toc-backref" href="#id45">8.2.2.3.1. 基本的な非同期受信</a><a class="headerlink" href="#jmshowtouselistenercontainer" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;JmsListener</span></code>アノテーションを利用した非同期受信の方法について説明をする。</div>
<div class="line">非同期受信の実装には下記の設定が必要となる。</div>
</div>
<ul class="simple">
<li>JMS Namespaceを定義する。</li>
<li><code class="docutils literal"><span class="pre">&#64;JmsListener</span></code>アノテーションを有効化する。</li>
<li>DIコンテナで管理しているコンポーネントのメソッドに<code class="docutils literal"><span class="pre">&#64;JmsListener</span></code>アノテーションを指定する。</li>
</ul>
<div class="line-block">
<div class="line">それぞれの詳細な実装方法について、以下に記述する。</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-web/src/main/resources/META-INF/spring/applicationContext.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xmlns:jms=</span><span class="s">&quot;http://www.springframework.org/schema/jms&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans https://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">        http://www.springframework.org/schema/jms https://www.springframework.org/schema/jms/spring-jms.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;jms:annotation-driven</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">&quot;com.example.listener&quot;</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!-- (4) --&gt;</span>
    <span class="nt">&lt;jms:listener-container</span>
        <span class="na">factory-id=</span><span class="s">&quot;jmsListenerContainerFactory&quot;</span>
        <span class="na">destination-resolver=</span><span class="s">&quot;destinationResolver&quot;</span>
        <span class="na">concurrency=</span><span class="s">&quot;1&quot;</span><span class="nt">/&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="26%" />
<col width="64%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性名</th>
<th class="head">内容</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>xmlns:jms</td>
<td><div class="first last line-block">
<div class="line">JMS Namespaceを定義する。</div>
<div class="line">値として<code class="docutils literal"><span class="pre">http://www.springframework.org/schema/jms</span></code>を指定する。</div>
<div class="line">JMS Namespaceの詳細については、<a class="reference external" href="https://docs.spring.io/spring-framework/docs/5.3.2/reference/html/integration.html#jms-namespace">Spring Framework Documentation -JMS Namespace Support-</a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td>xsi:schemaLocation</td>
<td><div class="first last line-block">
<div class="line">スキーマのURLを指定する。</div>
<div class="line">値に<code class="docutils literal"><span class="pre">http://www.springframework.org/schema/jms</span></code>と<code class="docutils literal"><span class="pre">https://www.springframework.org/schema/jms/spring-jms.xsd</span></code>を追加する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>-</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;jms:annotation-driven</span> <span class="pre">/&gt;</span></code>を利用して、<code class="docutils literal"><span class="pre">&#64;JmsListener</span></code>アノテーションや<code class="docutils literal"><span class="pre">&#64;SendTo</span></code>アノテーション等のJMS関連のアノテーション機能を有効化する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>-</td>
<td><div class="first last line-block">
<div class="line">リスナークラスを格納するcom.example.listenerパッケージ配下をcomponent-scan対象とする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>-</td>
<td><div class="first line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;jms:listener-container/&gt;</span></code>を利用して<code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code>を生成するファクトリへパラメータを与えることで、<code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code>の設定を行う。</div>
<div class="line"><code class="docutils literal"><span class="pre">&lt;jms:listener-container/&gt;</span></code>の属性には、利用したい<code class="docutils literal"><span class="pre">ConnectionFactory</span></code>のBeanを指定できる<code class="docutils literal"><span class="pre">connection-factory</span></code>属性が存在する。<code class="docutils literal"><span class="pre">connection-factory</span></code>属性のデフォルト値は<code class="docutils literal"><span class="pre">connectionFactory</span></code>である。</div>
<div class="line">この例では、<a class="reference internal" href="#jmshowtouseconnectionfactory"><span class="std std-ref">ConnectionFactoryの設定</span></a>で示した<code class="docutils literal"><span class="pre">ConnectionFactory</span></code>のBean(Bean名は<code class="docutils literal"><span class="pre">connectionFactory</span></code>)を利用するため、<code class="docutils literal"><span class="pre">connection-factory</span></code>属性を省略している。</div>
<div class="line"><code class="docutils literal"><span class="pre">&lt;jms:listener-container/&gt;</span></code>には、ここで紹介した以外の属性も存在する。</div>
<div class="line">詳細については、<a class="reference external" href="https://docs.spring.io/spring-framework/docs/5.3.2/reference/html/integration.html#jms-namespace-listener-container-tbl">Spring Framework Documentation -Attributes of the JMS &lt;listener-container&gt; element-</a>を参照されたい。</div>
</div>
<div class="last admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code>内部には独自のキャッシュ機能が備わっている。一方で、APサーバ製品やMOM製品によって関連リソースをキャッシュする場合もある。両者の管理に不整合が生じないように<code class="docutils literal"><span class="pre">cache</span></code>属性でキャッシュレベルを指定すること。
詳細については、<a class="reference external" href="https://docs.spring.io/spring/docs/5.3.2/javadoc-api/org/springframework/jms/listener/DefaultMessageListenerContainer.html">DefaultMessageListenerContainerのJavadoc</a>を参照されたい。
本ガイドラインでは、<code class="docutils literal"><span class="pre">&lt;jms:listener-container/&gt;</span></code>の<code class="docutils literal"><span class="pre">connection-factory</span></code>属性には、<a class="reference internal" href="#jmshowtouseconnectionfactory"><span class="std std-ref">ConnectionFactoryの設定</span></a>で定義した<code class="docutils literal"><span class="pre">ConnectionFactory</span></code>を指定する。</p>
</div>
</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td><code class="docutils literal"><span class="pre">concurrency</span></code></td>
<td><div class="first line-block">
<div class="line"><code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code>が管理するリスナーメソッドごとの並列数に対する上限を指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">concurrency</span></code>属性のデフォルトは1である。</div>
<div class="line">並列数の下限と上限を指定することも可能である。例えば、下限を5、上限を10とする場合は”5-10”と指定する。</div>
<div class="line">リスナーメソッドの並列数が設定した上限値に達した場合は、並列に処理されず待ち状態となる。</div>
<div class="line">必要に応じて値を設定すること。</div>
</div>
<div class="last admonition note">
<p class="first admonition-title">Note</p>
<p class="last">リスナーメソッド単位で並列数を指定したい場合は、<code class="docutils literal"><span class="pre">&#64;JmsListener</span></code>アノテーションの<code class="docutils literal"><span class="pre">concurrency</span></code>属性を利用することができる。</p>
</div>
</td>
</tr>
<tr class="row-even"><td>&#160;</td>
<td><code class="docutils literal"><span class="pre">destination-resolver</span></code></td>
<td><div class="first last line-block">
<div class="line">非同期受信時のDestination名解決で使用する<code class="docutils literal"><span class="pre">DestinationResolver</span></code>のBean名を設定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">DestinationResolver</span></code>のBean定義については、<a class="reference internal" href="#jmshowtousedestinationresolver"><span class="std std-ref">DestinationResolverの設定</span></a>を参照されたい。</div>
<div class="line"><code class="docutils literal"><span class="pre">destination-resolver</span></code>属性を指定していない場合は<code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code>内で生成された<code class="docutils literal"><span class="pre">DynamicDestinationResolver</span></code>が利用される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td><code class="docutils literal"><span class="pre">factory-id</span></code></td>
<td><div class="first last line-block">
<div class="line">Bean定義を行う<code class="docutils literal"><span class="pre">DefaultJmsListenerContainerFactory</span></code>の名前を設定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;JmsListener</span></code>アノテーションがデフォルトでBean名<code class="docutils literal"><span class="pre">jmsListenerContainerFactory</span></code>を参照するため、<code class="docutils literal"><span class="pre">&lt;jms:listener-container/&gt;</span></code>が一つの場合はBean名を<code class="docutils literal"><span class="pre">jmsListenerContainerFactory</span></code>とすることを推奨する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td>&#160;</td>
<td><code class="docutils literal"><span class="pre">cache</span></code></td>
<td><div class="first line-block">
<div class="line"><code class="docutils literal"><span class="pre">Connection</span></code>、<code class="docutils literal"><span class="pre">Session</span></code>や<code class="docutils literal"><span class="pre">MessageConsumer</span></code>などのキャッシュ対象を決定するために、キャッシュレベルを指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">connection</span></code>, <code class="docutils literal"><span class="pre">session</span></code>, <code class="docutils literal"><span class="pre">consumer</span></code>, <code class="docutils literal"><span class="pre">none</span></code>(キャッシュしない), <code class="docutils literal"><span class="pre">auto</span></code>(自動的に選択)のいずれかより選択する。</div>
<div class="line">ここではデフォルトの<code class="docutils literal"><span class="pre">auto</span></code>を指定するため、<code class="docutils literal"><span class="pre">cache</span></code>属性を省略している。</div>
</div>
<div class="last admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">auto</span></code>を指定した場合、<code class="docutils literal"><span class="pre">transaction-manager</span></code>属性の指定有無によって、挙動が変わる。
指定した場合は <code class="docutils literal"><span class="pre">none</span></code>指定時と同様となり、指定しない場合は <code class="docutils literal"><span class="pre">consumer</span></code>指定時と同様となる。
これは、<code class="docutils literal"><span class="pre">transaction-manager</span></code>属性が、JTAトランザクションを使用する場合にのみ指定することに起因している。
アプリケーションサーバ内で<code class="docutils literal"><span class="pre">Connection</span></code>や <code class="docutils literal"><span class="pre">Session</span></code>などをプールしない場合は、性能向上のため <code class="docutils literal"><span class="pre">consumer</span></code>を指定することを検討すること。</p>
</div>
</td>
</tr>
</tbody>
</table>
<p>DIコンテナで管理しているコンポーネントのメソッドに<code class="docutils literal"><span class="pre">&#64;JmsListener</span></code>アノテーションを指定することで、指定したDestinationより非同期でメッセージを受信する。
実装方法を以下に示す。</p>
</div></blockquote>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-web/src/main/java/com/example/listener/todo/TodoMessageListener.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.listener.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.jms.annotation.JmsListener</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="p">;</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoMessageListener</span> <span class="p">{</span>

   <span class="nd">@JmsListener</span><span class="p">(</span><span class="n">destination</span> <span class="o">=</span> <span class="s">&quot;jms/queue/TodoMessageQueue&quot;</span><span class="p">)</span>   <span class="c1">// (1)</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">receive</span><span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// omitted</span>
   <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">非同期受信用のメソッドに対し<code class="docutils literal"><span class="pre">&#64;JmsListener</span></code>アノテーションを設定する。<code class="docutils literal"><span class="pre">destination</span></code>属性には、受信先のDestination名を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><code class="docutils literal"><span class="pre">&#64;JmsListener</span></code>アノテーションの主な属性の一覧を以下に示す。
詳細やその他の属性については、<a class="reference external" href="https://docs.spring.io/spring/docs/5.3.2/javadoc-api/org/springframework/jms/annotation/JmsListener.html#destination--">&#64;JmsListenerアノテーションのJavadoc</a>を参照されたい。</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">項目</th>
<th class="head">内容</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">destination</span></code></td>
<td><div class="first last line-block">
<div class="line">受信するDestinationを指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">containerFactory</span></code></td>
<td><div class="first last line-block">
<div class="line">リスナーメソッドの管理を行う<code class="docutils literal"><span class="pre">DefaultJmsListenerContainerFactory</span></code>のBean名を指定する。</div>
<div class="line">デフォルトは<code class="docutils literal"><span class="pre">jmsListenerContainerFactory</span></code>である。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">selector</span></code></td>
<td><div class="first last line-block">
<div class="line">受信するメッセージを限定するための条件であるメッセージセレクタを指定する。</div>
<div class="line">明示的に値を指定しない場合、デフォルトは””(空文字)であり、すべてのメッセージが受信対象となる。</div>
<div class="line">利用方法については、<a class="reference internal" href="#jmshowtousemessageselectorforasyncreceive"><span class="std std-ref">非同期受信するメッセージを限定する場合</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">concurrency</span></code></td>
<td><div class="first last line-block">
<div class="line">リスナーメソッドの並列数の上限を指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">concurrency</span></code>属性のデフォルトは1である。</div>
<div class="line">並列数の下限と上限を指定することも可能である。例えば、下限を5、上限を10とする場合は”5-10”と指定する。</div>
<div class="line">リスナーメソッドの並列数が設定した上限値に達した場合は、並列に処理されず待ち状態となる。</div>
<div class="line">必要に応じて値を設定すること。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="jmshowtouselistenercontainergetheader">
<span id="id15"></span><h4><a class="toc-backref" href="#id46">8.2.2.3.2. メッセージのヘッダ情報を取得する</a><a class="headerlink" href="#jmshowtouselistenercontainergetheader" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">非同期受信の処理結果をProducer側で指定したDestination(ヘッダ属性<code class="docutils literal"><span class="pre">JMSReplyTo</span></code>の値)に送信する場合など、メッセージのヘッダ情報をリスナーメソッド内で利用する場合には、<code class="docutils literal"><span class="pre">&#64;org.springframework.messaging.handler.annotation.Header</span></code>アノテーションを利用する。</div>
<div class="line">実装例を以下に示す。</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-web/src/main/java/com/example/listener/todo/TodoMessageListener.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@JmsListener</span><span class="p">(</span><span class="n">destination</span> <span class="o">=</span> <span class="s">&quot;jms/queue/TodoMessageQueue&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">JmsResponse</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">receiveAndResponse</span><span class="p">(</span>
        <span class="n">Todo</span> <span class="n">todo</span><span class="p">,</span> <span class="nd">@Header</span><span class="p">(</span><span class="s">&quot;jms_replyTo&quot;</span><span class="p">)</span> <span class="n">Destination</span> <span class="n">storeResponseMessageQueue</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (1)</span>

    <span class="c1">// omitted</span>

     <span class="k">return</span> <span class="n">JmsResponse</span><span class="p">.</span><span class="na">forDestination</span><span class="p">(</span><span class="n">todo</span><span class="p">,</span> <span class="n">storeResponseMessageQueue</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">受信メッセージのヘッダ属性<code class="docutils literal"><span class="pre">JMSReplyTo</span></code>の値を取得するために、<code class="docutils literal"><span class="pre">&#64;Header</span></code>アノテーションを指定する。</div>
<div class="line">JMSの標準ヘッダ属性を取得する場合に指定するキーの値については、<a class="reference external" href="https://docs.spring.io/spring/docs/5.3.2/javadoc-api/constant-values.html#org.springframework.jms.support.JmsHeaders.CORRELATION_ID">JmsHeadersの定数の定義</a>を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="jmshowtouselistenercontainerresendmessage">
<span id="id16"></span><h4><a class="toc-backref" href="#id47">8.2.2.3.3. 非同期受信後の処理結果をメッセージ送信</a><a class="headerlink" href="#jmshowtouselistenercontainerresendmessage" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;JmsListener</span></code>アノテーションを定義したメソッドの処理結果を、応答メッセージとしてDestinationに送信する方法が用意されている。</div>
<div class="line">処理結果の送信先を指定する方法として、以下の2つが存在する。</div>
</div>
<ul class="simple">
<li>処理結果の送信先を静的に指定する場合</li>
<li>処理結果の送信先を動的に指定する場合</li>
</ul>
<p>それぞれについて、以下に説明する。</p>
<ul>
<li><dl class="first docutils">
<dt><strong>処理結果の送信先を静的に指定する場合</strong></dt>
<dd><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;JmsListener</span></code>アノテーションが定義されているメソッドに対し、Destinationを指定した<code class="docutils literal"><span class="pre">&#64;SendTo</span></code>アノテーションを定義することで、固定のDestinationへの処理結果のメッセージ送信を実現する。</div>
<div class="line">実装例を以下に示す。</div>
</div>
</dd>
</dl>
</li>
</ul>
<blockquote>
<div><ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-web/src/main/java/com/example/listener/todo/TodoMessageListener.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@JmsListener</span><span class="p">(</span><span class="n">destination</span> <span class="o">=</span> <span class="s">&quot;jms/queue/TodoMessageQueue&quot;</span><span class="p">)</span>
<span class="nd">@SendTo</span><span class="p">(</span><span class="s">&quot;jms/queue/ResponseMessageQueue&quot;</span><span class="p">)</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="n">Todo</span> <span class="nf">receiveMessageAndSendTo</span><span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// omitted</span>
    <span class="k">return</span> <span class="n">todo</span><span class="p">;</span> <span class="c1">// (2)</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;SendTo</span></code>アノテーションを定義することで、処理結果の送信先に対するデフォルトのDestinationを指定できる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;SendTo</span></code>アノテーションに定義したDestinationに送信するデータを返却する。</div>
<div class="line">許可されている返却値の型は<code class="docutils literal"><span class="pre">org.springframework.messaging.Message</span></code>、<code class="docutils literal"><span class="pre">javax.jms.Message</span></code>、<code class="docutils literal"><span class="pre">String</span></code>、<code class="docutils literal"><span class="pre">byte</span></code>配列、<code class="docutils literal"><span class="pre">Map</span></code>、<code class="docutils literal"><span class="pre">Serializable</span></code>インタフェースを実装したクラス である。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div></blockquote>
<ul class="simple">
<li><strong>処理結果の送信先を動的に変更する場合</strong></li>
</ul>
<blockquote>
<div><div class="line-block">
<div class="line">動的に送信先のDestinationを変更する場合は<code class="docutils literal"><span class="pre">JmsResponse</span></code>クラスの<code class="docutils literal"><span class="pre">forDestination</span></code>や<code class="docutils literal"><span class="pre">forQueue</span></code>メソッドを用いる。</div>
<div class="line">送信先のDestinationやDestination名を動的に変更することで、任意のDestinationに処理結果を送信することができる。実装例を以下に示す。</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-web/src/main/java/com/example/listener/todo/TodoMessageListener.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@JmsListener</span><span class="p">(</span><span class="n">destination</span> <span class="o">=</span> <span class="s">&quot;jms/queue/TodoMessageQueue&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">JmsResponse</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">receiveMessageJmsResponse</span><span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

    <span class="n">String</span> <span class="n">resQueue</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">todo</span><span class="p">.</span><span class="na">isFinished</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">resQueue</span> <span class="o">=</span> <span class="s">&quot;jms/queue/FinihedTodoMessageQueue&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">resQueue</span> <span class="o">=</span> <span class="s">&quot;jms/queue/ActiveTodoMessageQueue&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">JmsResponse</span><span class="p">.</span><span class="na">forQueue</span><span class="p">(</span><span class="n">todo</span><span class="p">,</span> <span class="n">resQueue</span><span class="p">);</span> <span class="c1">// (1)</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">処理内容に応じて送信先のQueueを変更する場合は<code class="docutils literal"><span class="pre">JmsResponse</span></code>クラスの<code class="docutils literal"><span class="pre">forDestination</span></code>や<code class="docutils literal"><span class="pre">forQueue</span></code>メソッドを使用する。</div>
<div class="line">この例では、<code class="docutils literal"><span class="pre">forQueue</span></code>メソッドを利用して、Destination名から送信を行っている。</div>
</div>
<div class="last admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">JmsResponse</span></code>クラスの<code class="docutils literal"><span class="pre">forQueue</span></code>メソッドを利用する場合は、文字列であるDestination名を利用する。
Destination名の解決には、<code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code>に指定した<code class="docutils literal"><span class="pre">DestinationResolver</span></code>が利用される。</p>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>処理結果の送信先をProducer側で指定する場合</strong></p>
<p>以下のように実装することで、Producer側で指定した任意のDestinationに処理結果のメッセージを送信することができる。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">実装箇所</th>
<th class="head">実装内容</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">Producer側</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JMS標準に則りメッセージのヘッダ属性<code class="docutils literal"><span class="pre">JMSReplyTo</span></code>にDestinationを指定する。</div>
<div class="line">ヘッダ属性の編集については、<a class="reference internal" href="#jmshowtousesettingforsendwithheader"><span class="std std-ref">メッセージヘッダを編集して同期送信する場合</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">Consumer側</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">メッセージ送信するオブジェクトを返却する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p class="last">ヘッダ属性<code class="docutils literal"><span class="pre">JMSReplyTo</span></code>はConsumer側で指定したデフォルトのDestinationよりも優先される。
詳細については、<a class="reference external" href="https://docs.spring.io/spring-framework/docs/5.3.2/reference/html/integration.html#jms-annotated-response">Spring Framework Documentation -Response Management-</a>を参照されたい。</p>
</div>
</div>
<div class="section" id="jmshowtousemessageselectorforasyncreceive">
<span id="id17"></span><h4><a class="toc-backref" href="#id48">8.2.2.3.4. 非同期受信するメッセージを限定する場合</a><a class="headerlink" href="#jmshowtousemessageselectorforasyncreceive" title="Permalink to this headline">¶</a></h4>
<p>受信時にメッセージセレクタを指定することで受信するメッセージを限定することができる。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-web/src/main/java/com/example/listener/todo/TodoMessageListener.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@JmsListener</span><span class="p">(</span><span class="n">destination</span> <span class="o">=</span> <span class="s">&quot;jms/queue/MessageQueue&quot;</span> <span class="p">,</span> <span class="n">selector</span> <span class="o">=</span> <span class="s">&quot;TodoStatus = &#39;deleted&#39;&quot;</span><span class="p">)</span>    <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">receive</span><span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// omitted</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">selector</span></code>属性を利用することで受信対象の条件を設定することができる。</div>
<div class="line">ヘッダ属性の<code class="docutils literal"><span class="pre">TodoStatus</span></code>が<code class="docutils literal"><span class="pre">deleted</span></code>のメッセージのみ受信する。</div>
<div class="line">メッセージセレクタはSQL92条件式構文のサブセットに基づいている。</div>
<div class="line">詳細は<a class="reference external" href="https://jakarta.ee/specifications/platform/8/apidocs/javax/jms/message">Message Selectors</a>を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="jmshowtousevalidationforasyncreceive">
<span id="id18"></span><h4><a class="toc-backref" href="#id49">8.2.2.3.5. 非同期受信したメッセージの入力チェック</a><a class="headerlink" href="#jmshowtousevalidationforasyncreceive" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">セキュリティなどの観点から、不正なデータを保持したメッセージを業務ロジック内で処理しないよう、入力チェックを行うべきである。</div>
<div class="line">Method Validationを利用してServiceのメソッドで入力チェックを実装し、入力チェックエラー時の例外をリスナーメソッドでハンドリングする。</div>
<div class="line">これは、トランザクション管理を行う場合に、入力チェックエラー時の例外によって無用なロールバック処理が起こることを回避するためである。トランザクション管理については、<a class="reference internal" href="#jmshowtousetransactionmanagementforasyncreceive"><span class="std std-ref">トランザクション管理</span></a>を参照されたい。</div>
<div class="line">Method Validationの設定や実装方法の詳細は、<a class="reference internal" href="../WebApplicationDetail/Validation.html"><span class="doc">入力チェック</span></a>の<a class="reference internal" href="../WebApplicationDetail/Validation.html#methodvalidation"><span class="std std-ref">Method Validation</span></a>を参照されたい。</div>
<div class="line"><a class="reference internal" href="#jmshowtousesettingforsyncsend"><span class="std std-ref">基本的な同期送信</span></a>で示した<code class="docutils literal"><span class="pre">Todo</span></code>のオブジェクトに対して入力チェックを行う実装例を以下に示す。</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/java/com/example/domain/service/todo/TodoServiceImpl.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.Valid</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="p">;</span>

<span class="nd">@Validated</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoService</span> <span class="p">{</span>

    <span class="kt">void</span> <span class="nf">updateTodo</span><span class="p">(</span><span class="nd">@Valid</span> <span class="n">Todo</span> <span class="n">todo</span><span class="p">);</span> <span class="c1">// (2)</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;Validated</span></code>アノテーションを付けることで、このインタフェースが入力チェック対象であることを宣言する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Bean Validationの制約アノテーションをメソッドの引数として指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/java/com/example/domain/model/Todo.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.model</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Null</span><span class="p">;</span>

<span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Todo</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1L</span><span class="p">;</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Null</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">description</span><span class="p">;</span>

    <span class="c1">// omitted</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">finished</span><span class="p">;</span>

    <span class="c1">// omitted</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getDescription</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">description</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDescription</span><span class="p">(</span><span class="n">String</span> <span class="n">description</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">description</span> <span class="o">=</span> <span class="n">description</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isFinished</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">finished</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFinished</span><span class="p">(</span><span class="kt">boolean</span> <span class="n">finished</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">finished</span> <span class="o">=</span> <span class="n">finished</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Bean ValidationでJavaBeanの入力チェックを定義する。</div>
<div class="line">この例では一例として<code class="docutils literal"><span class="pre">&#64;Null</span></code>アノテーションを設定している。</div>
<div class="line">詳細は「<a class="reference internal" href="../WebApplicationDetail/Validation.html"><span class="doc">入力チェック</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-web/src/main/java/com/example/listener/todo/TodoMessageListener.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="n">TodoService</span> <span class="n">todoService</span><span class="p">;</span>

<span class="nd">@JmsListener</span><span class="p">(</span><span class="n">destination</span> <span class="o">=</span> <span class="s">&quot;jms/queue/MessageQueue&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">receive</span><span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="n">todoService</span><span class="p">.</span><span class="na">updateTodo</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span> <span class="c1">// (1)</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">ConstraintViolationException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (2)</span>
        <span class="c1">// omitted</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力チェックを行うServiceのメソッドを実行する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">制約違反時に発生する<code class="docutils literal"><span class="pre">ConstraintViolationException</span></code>を捕捉する。</div>
<div class="line">捕捉後には任意の処理を実行可能である。</div>
<div class="line">論理的なエラーメッセージを格納するためのQueueを利用する場合など、別のQueueにメッセージ送信する例については、<a class="reference internal" href="#jmshowtouseexceptionhandlingforasyncreceive"><span class="std std-ref">非同期受信時の例外ハンドリング</span></a>を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="jmshowtousetransactionmanagementforasyncreceive">
<span id="id19"></span><h4><a class="toc-backref" href="#id50">8.2.2.3.6. トランザクション管理</a><a class="headerlink" href="#jmshowtousetransactionmanagementforasyncreceive" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">データの一貫性を保証する必要がある場合は、トランザクション管理機能を使用する。</div>
<div class="line">非同期受信で使用するSpring JMS の <code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code>には、JMSのトランザクション管理の仕組みが組み込まれている。<code class="docutils literal"><span class="pre">listener-container</span></code>の<code class="docutils literal"><span class="pre">acknowledge</span></code>属性でその機能を切り替えられる。それを利用した場合の実装例を以下に示す。</div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">メッセージがQueueに戻されると、そのメッセージが再度非同期受信されるため、エラーの原因が解決していない場合は、ロールバック、非同期受信を繰り返すこととなる。
JMSプロバイダによっては、ロールバック後の再送信回数に閾値を設定でき、再送信された回数が閾値を超えた場合、Dead Letter Queueにメッセージを格納する。</p>
</div>
</div></blockquote>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-web/src/main/resources/META-INF/spring/applicationContext.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;jms:listener-container</span>
    <span class="na">factory-id=</span><span class="s">&quot;jmsListenerContainerFactory&quot;</span>
    <span class="na">destination-resolver=</span><span class="s">&quot;destinationResolver&quot;</span>
    <span class="na">concurrency=</span><span class="s">&quot;1&quot;</span>
    <span class="na">error-handler=</span><span class="s">&quot;jmsErrorHandler&quot;</span>
    <span class="na">acknowledge=</span><span class="s">&quot;transacted&quot;</span><span class="nt">/&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="26%" />
<col width="64%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性名</th>
<th class="head">内容</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><code class="docutils literal"><span class="pre">cache</span></code></td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Connection</span></code>、<code class="docutils literal"><span class="pre">Session</span></code>や<code class="docutils literal"><span class="pre">MessageConsumer</span></code>などのキャッシュ対象を決定するために、キャッシュレベルを指定する。</div>
<div class="line">ここではデフォルトの<code class="docutils literal"><span class="pre">auto</span></code>を指定するため、<code class="docutils literal"><span class="pre">cache</span></code>属性を省略している。</div>
<div class="line"><a class="reference internal" href="#jmshowtouselistenercontainer"><span class="std std-ref">基本的な非同期受信</span></a>の説明を合わせて参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td><code class="docutils literal"><span class="pre">acknowledge</span></code></td>
<td><div class="first last line-block">
<div class="line">トランザクションを有効にするため、確認応答モードに<code class="docutils literal"><span class="pre">transacted</span></code>を指定する。デフォルトは<code class="docutils literal"><span class="pre">auto</span></code>である。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">アプリケーションサーバによっては、アプリケーション内での<code class="docutils literal"><span class="pre">Connection</span></code>や<code class="docutils literal"><span class="pre">Session</span></code>のキャッシュを禁止している場合があるため、使用するアプリケーションサーバの仕様に応じてキャッシュの有効化、無効化を決定すること。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>非同期受信と同期送信・受信を併用し、かつ、単一のトランザクションで管理したい場合、<code class="docutils literal"><span class="pre">jms:listener-container</span></code>の<code class="docutils literal"><span class="pre">connection-factory</span></code>属性と<code class="docutils literal"><span class="pre">JmsTemplate</span></code>の<code class="docutils literal"><span class="pre">connectionFactory</span></code>プロパティで指定する<code class="docutils literal"><span class="pre">ConnectionFactory</span></code>のインスタンスを同一にすること。これによって、Springは非同期受信と同期送受信で利用する<code class="docutils literal"><span class="pre">Session</span></code>を共有するため、単一のトランザクションとなる。
このとき、<code class="docutils literal"><span class="pre">jms:listener-container</span></code>および <code class="docutils literal"><span class="pre">JmsTemplate</span></code>の両方でキャッシュを有効にするには、以下のような手段が候補となる。</p>
<ul class="simple">
<li>JMS関連リソースのキャッシュをAPサーバ製品に任せ、JNDIルックアップ経由で取得したオブジェクトを非同期受信と同期送信・受信の両方でそのまま使用する。</li>
<li>MOM製品が<code class="docutils literal"><span class="pre">connectionfactory</span></code>のcache機能を持っている場合、それを非同期受信と同期送信・受信の両方でそのまま使用する。</li>
<li><code class="docutils literal"><span class="pre">org.springframework.jms.connection.CachingConnectionFactory</span></code>を非同期受信と同期送信・受信の両方でそのまま使用する。</li>
</ul>
<p class="last">いずれの場合も<code class="docutils literal"><span class="pre">listener-container</span></code>の<code class="docutils literal"><span class="pre">cache</span></code>には<code class="docutils literal"><span class="pre">none</span></code>を指定すること。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>特定の例外の場合にロールバック以外の例外ハンドリングを行う方法</strong></p>
<p class="last">トランザクション管理を有効にした場合、入力チェックなどで発生した例外を捕捉せずにthrowすると、ロールバックによってメッセージがQueueに戻される。
リスナーメソッドはQueueに戻されたメッセージを再度非同期受信するため、非同期受信→エラー発生→ロールバックがJMSプロバイダの設定回数分繰り返されることになる。
リトライによってエラーの原因が解消されないような例外の場合は、上記のような無駄な処理を抑えるため、例外を補足してリスナーメソッドからthrowしないようにハンドリングを行う。
詳細については、<a class="reference internal" href="#jmshowtouseexceptionhandlingforasyncreceive"><span class="std std-ref">非同期受信時の例外ハンドリング</span></a>を参照されたい。</p>
</div>
<p>DBのトランザクション管理を行う必要があるアプリケーションでは、業務の要件をもとにJMSとDBのトランザクションの関連を精査した上でトランザクションの管理方針を決定すること。
非同期受信でJMSとDBのトランザクションを連携させるには以下のような方法が考えられる。</p>
<ol class="arabic simple">
<li>JTAによるグローバルトランザクションを使用する方法</li>
<li>”Best Effort 1 Phase Commit”を使用する方法</li>
<li>JMSとDBのトランザクションを個別に指定する方法</li>
</ol>
<p>このうち、以下を理由に「JMSとDBのトランザクションを個別に指定する方法」の利用を検討されたい。
同期送信のトランザクション管理(<a class="reference internal" href="#jmshowtousesettingforsyncsendtransactionmanagement"><span class="std std-ref">トランザクション管理</span></a>)でも紹介したように、
JTAによるグローバルトランザクションはプロトコルの特性上、性能面のオーバヘッドがかかる。
これを解消するため、同期送信では”Best Effort 1 Phase Commit”を使用するトランザクション管理方法を紹介したが、非同期受信ではトランザクションが不適切な構成になるため推奨されない。
一般的にリカバリの観点からDBトランザクション境界よりJMSトランザクション境界を外側に置く構成をとるが、
Springの<code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code>は独自のトランザクション管理機構を持つために、
JTA用の設定である  <code class="docutils literal"><span class="pre">jms:listener-container</span></code>の <code class="docutils literal"><span class="pre">transaction-manager</span></code>属性を活用し”Best Effort 1 Phase Commit”を実現しようとすると、
DBトランザクション境界がJMSトランザクション境界の外側になってしまう。
結果、非同期で受信したメッセージが正常に処理されたにもかかわらずDBトランザクションがロールバックされる可能性が生じる。</p>
<blockquote>
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>メッセージ受信後にJMSプロバイダとの接続が切れた場合などでJMSプロバイダにトランザクションの処理結果が返らない場合</strong></p>
<p class="last">メッセージ受信後にJMSプロバイダとの接続が切れた場合などで、JMSプロバイダにトランザクションの処理結果が返らない場合、トランザクションの扱いはJMSプロバイダに依存する。 そのため、<strong>受信したメッセージの消失や、ロールバックによるメッセージの再処理などを考慮した設計</strong>を行うこと。 特に、メッセージの消失が許されないような場合には、<strong>メッセージの消失を補う仕組みを用意するか、グローバルトランザクションなどの利用を検討する</strong>必要がある。</p>
</div>
</div></blockquote>
<p>本ガイドラインではグローバルトランザクションは使わずに、上記の通りJMSのトランザクションはSpring JMSが内部で実装しているトランザクション管理に委ね、DBのトランザクションをブランクプロジェクトのデフォルトの設定で定義されている<code class="docutils literal"><span class="pre">transactionManager</span></code>で管理する方法を推奨する。その実装例を以下に示す。</p>
<blockquote>
<div><ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-web/src/main/java/com/example/listener/todo/TodoMessageListener.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.listener.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jms.annotation.JmsListener</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.service.todo.TodoService</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="p">;</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoMessageListener</span> <span class="p">{</span>
    <span class="nd">@Inject</span>
    <span class="n">TodoService</span> <span class="n">todoService</span><span class="p">;</span>

    <span class="nd">@JmsListener</span><span class="p">(</span><span class="n">destination</span> <span class="o">=</span> <span class="s">&quot;TransactedQueue&quot;</span><span class="p">)</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">receiveTransactedMessage</span><span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">todoService</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span>

    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/java/com/example/domain/service/todo/TodoServiceImpl.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="p">;</span>

<span class="nd">@Transactional</span> <span class="c1">// (2)</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// omitted</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;JmsListener</span></code>アノテーションを定義し、JMSのトランザクション管理を有効にした<code class="docutils literal"><span class="pre">DefaultJmsListenerContainerFactory</span></code>を指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;JmsListener</span></code>アノテーションはデフォルトでBean名<code class="docutils literal"><span class="pre">jmsListenerContainerFactory</span></code>を参照するため、<code class="docutils literal"><span class="pre">containerFactory</span></code>属性を省略している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">DBのトランザクション境界を定義する。</div>
<div class="line">valueを省略しているため、デフォルトで、Bean名<code class="docutils literal"><span class="pre">transactionManager</span></code>を参照する。同期送信では<code class="docutils literal"><span class="pre">JmsTransactionManager</span></code>や<code class="docutils literal"><span class="pre">ChainedTransactionManager</span></code>のBean名を指定したが、非同期受信ではJMSのトランザクションはSpringに委ねるためDBのトランザクションマネージャを参照させる。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;Transactional</span></code>アノテーションの詳細については、<a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html"><span class="doc">ドメイン層の実装</span></a>の<a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html#service-transaction-management"><span class="std std-ref">トランザクション管理について</span></a>を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">トランザクション境界のネストの順序は業務要件によるが、JMSプロバイダは外部システムとの連携に使用される場合が多い。
その場合はJMSトランザクション境界をDBトランザクション境界の外側に置き、内向きのDBトランザクションを先に完結する方がリカバリは容易である。
DBのトランザクションをコミットし、JMSのトランザクションがロールバックした場合、メッセージがQueueに戻されるため、同じメッセージを再度処理することになる。
設計上の考慮点として、業務処理の再実行時にDB更新処理を再試行しても問題ないように設計する必要がある。</p>
</div>
</div></blockquote>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><p>上記の設定、実装例に従ってアプリケーションを作成した場合の挙動について説明する。</p>
<ul class="simple">
<li><strong>リスナーメソッドの処理が正常に終了した場合</strong></li>
</ul>
<blockquote>
<div><div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code>がJMSトランザクションを開始・コミットし、DBのトランザクションマネージャがDBのトランザクションを開始・コミットする。</div>
</div>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../../_images/JMSDBTransactionAllCommit.png"><img alt="JMS/DB Transaction" src="../../_images/JMSDBTransactionAllCommit.png" style="width: 80%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JMSのトランザクションを開始する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">DBのトランザクションを開始する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">DBのトランザクションをコミットし、DBのトランザクションを終了する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リスナーメソッドが正常終了する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JMSのトランザクションをコミットし、JMSのトランザクションを終了する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div></blockquote>
<ul class="simple">
<li><strong>業務ロジックで予期せぬ例外が発生した場合</strong></li>
</ul>
<blockquote>
<div><p>サービスで例外が発生した場合JMSトランザクションとDBトランザクションの両方をロールバックする。</p>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../../_images/JMSDBTransactionAllRollback.png"><img alt="JMS/DB Transaction" src="../../_images/JMSDBTransactionAllRollback.png" style="width: 80%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JMSのトランザクションを開始する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">DBのトランザクションを開始する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">業務ロジックで予期しない例外が発生する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">DBのトランザクションをロールバックし、DBのトランザクションを終了する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JMSのトランザクションをロールバックし、JMSのトランザクションを終了する。</div>
<div class="line">JMSのトランザクションがロールバックするため、メッセージがQueueに戻される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div></blockquote>
<ul class="simple">
<li><strong>メッセージ受信後にJMSプロバイダとの接続が切れた場合などで、DBのトランザクションのみコミットしてしまう場合</strong></li>
</ul>
<blockquote>
<div><p>非同期受信を伴う処理をグローバルトランザクションで管理しない場合は、DBトランザクションとJMSトランザクションは別々にコミットすることになるため、
JMSとDBの状態に不整合が生じる可能性がある。具体的には以下の様な場合が該当する。</p>
<ul class="simple">
<li>JMSコネクションの切断を検知できずにDBの更新処理を続け、コミットしてしまう場合</li>
<li>DBトランザクションのコミット後でJMSトランザクションをコミットする前に例外が発生した場合</li>
</ul>
<p>そのような場合に、JMSのトランザクションをロールバックした後に再度同じメッセージを処理することもあれば、送信側によって同一内容のメッセージを複数回送信してしまうことがある。そのような背景で同じメッセージを複数受信した場合でもデータの完全性を保障する必要がある。
その対策として、<code class="docutils literal"><span class="pre">JMSMessageID</span></code>、または、<code class="docutils literal"><span class="pre">Property</span></code>や<code class="docutils literal"><span class="pre">Body</span></code>に含まれる、リクエストを一意に特定するための情報を記録する方法がある。
これは、メッセージの受信ごとに過去に記録した情報と比較し、処理の状況に応じて処理し分けることを意味する。
なお、以下のとおり、利用する情報によって対応できる事象に差がある。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">JMSMessageID</span></code>を記録する場合、メッセージがロールバックされた際の二重処理にのみ対応できる。</li>
<li><code class="docutils literal"><span class="pre">Property</span></code>や<code class="docutils literal"><span class="pre">Body</span></code>の一部を記録する場合、メッセージがロールバックされた際に加えて、異常時などに業務上同一の意味をもつメッセージが複数回送信された際の二重処理にも対応できる。</li>
</ul>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../../_images/JMSDBTransactionUnexpectedError.png"><img alt="JMS/DB Transaction" src="../../_images/JMSDBTransactionUnexpectedError.png" style="width: 80%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JMSのトランザクションを開始する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">DBのトランザクションを開始する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">DBのトランザクションをコミットし、DBのトランザクションを終了する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JMSのトランザクションのコミット前にJMSプロバイダとの接続が切れるなどの予期せぬエラーが発生する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JMSのトランザクションのコミットに失敗する。</div>
<div class="line">そのため、メッセージ消失などに備え、整合性を担保するための仕組みを用意する必要がある。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">上記のような事象を避け、JMSとDBなど複数のトランザクションを厳密に管理する必要がある場合には、グローバルトランザクションの利用を検討する。
グローバルトランザクションについては、各種製品マニュアルを参照されたい。</p>
</div>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="jmshowtouseexceptionhandlingforasyncreceive">
<span id="id20"></span><h4><a class="toc-backref" href="#id51">8.2.2.3.7. 非同期受信時の例外ハンドリング</a><a class="headerlink" href="#jmshowtouseexceptionhandlingforasyncreceive" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">トランザクション管理を行う場合には、ロールバック処理を考慮した例外のハンドリングを行う必要がある。</div>
<div class="line">トランザクション管理の詳細については、<a class="reference internal" href="#jmshowtousetransactionmanagementforasyncreceive"><span class="std std-ref">トランザクション管理</span></a>を参照されたい。</div>
<div class="line">JMSの例外ハンドリングは、目的に応じて以下の2種類のパターンに分類される。</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils" id="id26">
<caption><span class="caption-text"><strong>表-例外ハンドリングのパターン</strong></span><a class="headerlink" href="#id26" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="40%" />
<col width="25%" />
<col width="10%" />
<col width="15%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">ハンドリングの目的</th>
<th class="head">ハンドリング対象となり得る例外の例</th>
<th class="head">ハンドリング方法</th>
<th class="head">ハンドリング単位</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ビジネス層で発生した例外を個別にハンドリングする場合</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力チェックエラーなどのビジネス例外</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リスナーメソッド</div>
<div class="line">(try-catch)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リスナーメソッド単位</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リスナーメソッドからthrowされた例外を統一的にハンドリングする場合</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入出力エラーなどのシステム例外</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ErrorHandler</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JMSListenerContainer単位</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul>
<li><p class="first"><strong>ビジネス層で発生した例外を個別にハンドリングする場合</strong></p>
<div class="line-block">
<div class="line">メッセージの内容が不正である場合など、ビジネス層で発生した例外をリスナーメソッドで捕捉(try-catch)し、リスナーメソッド単位でハンドリングを行う。</div>
<div class="line">トランザクション管理を行う場合、ロールバックが必要なケースは例外を<code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code>にthrowする必要があるため、補足した例外をthrowし直すこと。</div>
<div class="line">実装例を以下に示す。</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-web/src/main/java/com/example/listener/todo/TodoMessageListener.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="n">TodoService</span> <span class="n">todoService</span><span class="p">;</span>

<span class="nd">@JmsListener</span><span class="p">(</span><span class="n">destination</span> <span class="o">=</span> <span class="s">&quot;jms/queue/TodoMessageQueue&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">JmsResponse</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">receiveTodo</span><span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="n">todoService</span><span class="p">.</span><span class="na">insertTodo</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">BusinessException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">JmsResponse</span><span class="p">.</span><span class="na">forQueue</span><span class="p">(</span><span class="n">todo</span><span class="p">,</span> <span class="s">&quot;jms/queue/ErrorMessageQueue&quot;</span><span class="p">);</span> <span class="c1">// (1)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// (2)</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsResponse</span></code>クラスの<code class="docutils literal"><span class="pre">forQueue</span></code>メソッドを利用し、任意のオブジェクトを論理的なエラーメッセージを格納するためのQueueに送信することができる。</div>
<div class="line">この例では、AOPでログ出力が行われる<code class="docutils literal"><span class="pre">BusinessException</span></code>を捕捉しているため、明示的にログ出力処理などを記述していないが、例外の原因を消失させないように例外をハンドリングする必要がある。</div>
<div class="line">トランザクション管理を行い、ロールバックしてメッセージの再処理を行いたい場合には、捕捉した例外をthrowする必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">メッセージを送信しない場合は、返り値を<code class="docutils literal"><span class="pre">null</span></code>にする。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
<li><p class="first"><strong>リスナーメソッドからthrowされた例外を統一的にハンドリングする場合</strong></p>
<div class="line-block">
<div class="line">例外ごとに共通的なハンドリングを行う場合には、<code class="docutils literal"><span class="pre">&lt;jms:listener-container/&gt;</span></code>の<code class="docutils literal"><span class="pre">error-handler</span></code>属性に定義した<code class="docutils literal"><span class="pre">ErrorHandler</span></code>の実装クラスを利用する。</div>
<div class="line">設定方法を以下に示す。</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-web/src/main/resources/META-INF/spring/applicationContext.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;jms:listener-container</span>
    <span class="na">factory-id=</span><span class="s">&quot;jmsListenerContainerFactory&quot;</span>
    <span class="na">destination-resolver=</span><span class="s">&quot;destinationResolver&quot;</span>
    <span class="na">concurrency=</span><span class="s">&quot;1&quot;</span>
    <span class="na">error-handler=</span><span class="s">&quot;jmsErrorHandler&quot;</span>
    <span class="na">acknowledge=</span><span class="s">&quot;transacted&quot;</span><span class="nt">/&gt;</span>

<span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;jmsErrorHandler&quot;</span>
    <span class="na">class=</span><span class="s">&quot;com.example.domain.service.todo.JmsErrorHandler&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;jms:listener-container/&gt;</span></code>の<code class="docutils literal"><span class="pre">error-handler</span></code>属性にエラーハンドリングクラスのBean名を定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラーハンドリングクラスをBean定義する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>実装方法を以下に示す。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-web/src/main/java/com/example/listener/todo/JmsErrorHandler.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.listener.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.util.ErrorHandler</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.SystemException</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JmsErrorHandler</span> <span class="kd">implements</span> <span class="n">ErrorHandler</span> <span class="p">{</span>  <span class="c1">// (1)</span>

   <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleError</span><span class="p">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (2)</span>
        <span class="c1">// omitted</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="na">getCause</span><span class="p">()</span> <span class="k">instanceof</span> <span class="n">SystemException</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// (3)</span>

            <span class="c1">// omitted system error handling</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// omitted error handling</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ErrorHandler</span></code>インタフェースを実装したエラーハンドリングクラスを作成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リスナーメソッド内で発生した例外は<code class="docutils literal"><span class="pre">org.springframework.jms.listener.adapter.ListenerExecutionFailedException</span></code>にラップされ、引数として渡される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">任意の例外クラスを判定し、例外に沿ったエラーハンドリングを実施する。</div>
<div class="line">アプリケーション内で発生した例外を取得するには<code class="docutils literal"><span class="pre">t.getCause()</span></code>を実行する必要がある。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="jmshowtousesyncreceivemessage">
<span id="id21"></span><h3><a class="toc-backref" href="#id52">8.2.2.4. メッセージを同期受信する方法</a><a class="headerlink" href="#jmshowtousesyncreceivemessage" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>を利用して、JMSプロバイダへの同期受信処理を実現する。</div>
<div class="line">同期受信を利用することで、任意のタイミングでメッセージの受信が可能である。</div>
<div class="line">同期受信を利用しない実現方法を十分に検討した上で、アーキテクチャを決定すること。</div>
</div>
<div class="line-block">
<div class="line">同期受信のBean定義ファイルの設定を以下に示す。</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-env/src/main/resources/META-INF/spring/[projectName]-env.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;cachingConnectionFactory&quot;</span>
   <span class="na">class=</span><span class="s">&quot;org.springframework.jms.connection.CachingConnectionFactory&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
   <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;targetConnectionFactory&quot;</span> <span class="na">ref=</span><span class="s">&quot;connectionFactory&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
   <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;sessionCacheSize&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Session</span></code>、<code class="docutils literal"><span class="pre">MessageProducer</span></code>, <code class="docutils literal"><span class="pre">MessageConsumer</span></code>のキャッシュを行う<code class="docutils literal"><span class="pre">org.springframework.jms.connection.CachingConnectionFactory</span></code>をBean定義する。</div>
<div class="line">Bean定義もしくはJNDI名でルックアップしたJMSプロバイダ固有の<code class="docutils literal"><span class="pre">ConnectionFactory</span></code>をそのまま使うのではなく、
<code class="docutils literal"><span class="pre">CachingConnectionFactory</span></code>にラップして使用することで、キャッシュ機能を使用することができる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Bean定義もしくはJNDI名でルックアップした<code class="docutils literal"><span class="pre">ConnectionFactory</span></code>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Session</span></code>のキャッシュ数を設定する。（デフォルト値は1）</div>
<div class="line">この例では1を指定しているが、性能要件に応じて適宜キャッシュ数を変更すること。</div>
<div class="line">このキャッシュ数を超えてセッションが必要になるとキャッシュを使用せず、新しいセッションの作成と破棄を繰り返すことになる。</div>
<div class="line">すると処理効率が下がり、性能劣化の原因になるので注意すること。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/resources/META-INF/spring/[projectName]-infra.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;jmsTemplate&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.jms.core.JmsTemplate&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;connectionFactory&quot;</span> <span class="na">ref=</span><span class="s">&quot;cachingConnectionFactory&quot;</span> <span class="nt">/&gt;</span>
   <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;destinationResolver&quot;</span> <span class="na">ref=</span><span class="s">&quot;destinationResolver&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;jmsMessagingTemplate&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.jms.core.JmsMessagingTemplate&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;jmsTemplate&quot;</span> <span class="na">ref=</span><span class="s">&quot;jmsTemplate&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsTemplate</span></code>をBean定義する。</div>
<div class="line"><code class="docutils literal"><span class="pre">JmsTemplate</span></code>は低レベルのAPIハンドリング（JMS API呼び出し）を代行する。</div>
<div class="line">設定可能な属性に関しては、下記の<code class="docutils literal"><span class="pre">JmsTemplate</span></code>の属性一覧を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>をBean定義する。同期受信処理を代行する<code class="docutils literal"><span class="pre">JmsTemplate</span></code>をインジェクションする。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line">同期受信に関連する<code class="docutils literal"><span class="pre">JmsTemplate</span></code>の属性一覧を以下に示す。</div>
<div class="line">必要に応じて設定を行う必要がある。</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="5%" />
<col width="20%" />
<col width="50%" />
<col width="15%" />
<col width="10%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">設定項目</th>
<th class="head">内容</th>
<th class="head">必須</th>
<th class="head">デフォルト値</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">connectionFactory</span></code></td>
<td><div class="first last line-block">
<div class="line">使用する<code class="docutils literal"><span class="pre">ConnectionFactory</span></code>を設定する。</div>
</div>
</td>
<td>○</td>
<td>なし（必須であるため）</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">pubSubDomain</span></code></td>
<td><div class="first last line-block">
<div class="line">メッセージングモデルについて設定する。</div>
<div class="line">PTP（Queue）モデルは<code class="docutils literal"><span class="pre">false</span></code>、Pub/Sub（Topic）は<code class="docutils literal"><span class="pre">true</span></code>に設定する。</div>
</div>
</td>
<td>-</td>
<td><code class="docutils literal"><span class="pre">false</span></code></td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">sessionTransacted</span></code></td>
<td><div class="first last line-block">
<div class="line">セッションでのトランザクション管理をするかどうか設定する。</div>
<div class="line">本ガイドラインでは、後述するトランザクション管理を使用するため、デフォルトのままの<code class="docutils literal"><span class="pre">false</span></code>を推奨する。</div>
</div>
</td>
<td>-</td>
<td><code class="docutils literal"><span class="pre">false</span></code></td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">sessionAcknowledgeMode</span></code></td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">sessionAcknowledgeMode</span></code>はセッションの確認応答モードを設定する。</div>
<div class="line">詳細については<a class="reference external" href="https://docs.spring.io/spring/docs/5.3.2/javadoc-api/org/springframework/jms/core/JmsTemplate.html">JmsTemplateのJavaDoc</a>を参照されたい。</div>
</div>
</td>
<td>-</td>
<td><div class="first last line-block">
<div class="line">1</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">receiveTimeout</span></code></td>
<td><div class="first last line-block">
<div class="line">同期受信時のタイムアウト時間（ミリ秒）を設定する。未設定の場合、メッセージを受信するまで待機する。</div>
<div class="line">未設定の状態だと、後続の処理に影響が出てしまうため、必ず適切なタイムアウト時間を設定すること。</div>
</div>
</td>
<td>-</td>
<td><div class="first last line-block">
<div class="line">0</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">messageConverter</span></code></td>
<td><div class="first last line-block">
<div class="line">メッセージコンバータを設定する。</div>
<div class="line">本ガイドラインで紹介している範囲では、デフォルトのままで問題ない。</div>
</div>
</td>
<td>-</td>
<td><code class="docutils literal"><span class="pre">SimpleMessageConverter</span></code>(*1)が使用される。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">destinationResolver</span></code></td>
<td><div class="first last line-block">
<div class="line">DestinationResolverを設定する。</div>
<div class="line">本ガイドラインでは、JNDIで名前解決を行う、<code class="docutils literal"><span class="pre">JndiDestinationResolver</span></code>を設定することを推奨する。</div>
</div>
</td>
<td>-</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DynamicDestinationResolver</span></code>(*2)が使用される。</div>
<div class="line">(<code class="docutils literal"><span class="pre">DynamicDestinationResolver</span></code>を利用するとJMSプロバイダでDestinationの名前解決が行われる。)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="8">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">defaultDestination</span></code></td>
<td><div class="first last line-block">
<div class="line">既定のDestinationを設定する。</div>
<div class="line">Destinationを明示的に指定しない場合、このDestinationが使用される。</div>
</div>
</td>
<td>-</td>
<td>null(既定のDestinationなし)</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>(*1)<code class="docutils literal"><span class="pre">org.springframework.jms.support.converter.SimpleMessageConverter</span></code></p>
<p>(*2)<code class="docutils literal"><span class="pre">org.springframework.jms.support.destination.DynamicDestinationResolver</span></code></p>
<p><code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>クラスの<code class="docutils literal"><span class="pre">receiveAndConvert</span></code>メソッドにより、メッセージの同期受信を行う。実装例を以下に示す。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/java/com/example/domain/service/todo/TodoServiceImpl.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jms.core.JmsMessagingTemplate</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="p">{</span>
    <span class="nd">@Inject</span>
    <span class="n">JmsMessagingTemplate</span> <span class="n">jmsMessagingTemplate</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">receiveTodo</span><span class="p">()</span> <span class="p">{</span>

       <span class="c1">// omitted</span>
       <span class="n">Todo</span> <span class="n">retTodo</span> <span class="o">=</span> <span class="n">jmsMessagingTemplate</span><span class="p">.</span><span class="na">receiveAndConvert</span><span class="p">(</span><span class="s">&quot;jms/queue/TodoMessageQueue&quot;</span><span class="p">,</span> <span class="n">Todo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>   <span class="c1">// (1)</span>

    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>の<code class="docutils literal"><span class="pre">receiveAndConvert</span></code>メソッドにより、指定したDestinationからメッセージを受信する。</div>
<div class="line"><code class="docutils literal"><span class="pre">receiveAndConvert</span></code>メソッドは、第2引数に変換先のクラスを指定することで型変換したクラスが取得できる。</div>
<div class="line">ヘッダ項目を参照する場合は<code class="docutils literal"><span class="pre">receive</span></code>メソッドを使用することにより、Spring Frameworkの<code class="docutils literal"><span class="pre">Message</span></code>オブジェクトで取得することができる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="appendix">
<h2><a class="toc-backref" href="#id53">8.2.3. Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this headline">¶</a></h2>
<div class="section" id="jmsappendixsettingsdependsonjmsprovider">
<span id="id22"></span><h3><a class="toc-backref" href="#id54">8.2.3.1. JMSプロバイダに依存する設定</a><a class="headerlink" href="#jmsappendixsettingsdependsonjmsprovider" title="Permalink to this headline">¶</a></h3>
<p>JMSプロバイダごとに設定が異なる場合がある。
以下にJMSプロバイダごとの設定について説明する。</p>
<div class="section" id="apache-activemq">
<h4><a class="toc-backref" href="#id55">8.2.3.1.1. Apache ActiveMQを利用する場合</a><a class="headerlink" href="#apache-activemq" title="Permalink to this headline">¶</a></h4>
<p>Apache ActiveMQを利用する場合の設定について説明する。</p>
<ul>
<li><p class="first"><strong>アプリケーションサーバに対するJMSプロバイダ固有の設定</strong></p>
<div class="line-block">
<div class="line">JMSプロバイダによっては、固有の設定が必要な場合がある。</div>
<div class="line">Apache ActiveMQでは、受信するメッセージのペイロードが許可されたオブジェクトで構成されていることを保障するために、環境変数をアプリケーションサーバの起動引数に追加する必要がある。</div>
<div class="line">詳細については、<a class="reference external" href="http://activemq.apache.org/objectmessage.html">ObjectMessage</a>を参照されたい。</div>
<div class="line">環境変数をApache Tomcatの起動引数に追加する例を以下に示す。JBoss Enterprise Application Platform 7.3の場合は<a class="reference external" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.3/html/installation_guide/configuring_jboss_eap_to_run_as_a_service">Configuring JBoss EAP to Run as a Service</a>を、JBoss Enterprise Application Platform 6.4の場合は<a class="reference external" href="https://access.redhat.com/documentation/en-US/JBoss_Enterprise_Application_Platform/6.4/html/Installation_Guide/sect-Service_Configuration.html">Service Configuration</a>を、Weblogicの場合は<a class="reference external" href="https://docs.oracle.com/en/middleware/fusion-middleware/weblogic-server/12.2.1.4/start/overview.html#GUID-F619DA66-1822-4D4D-8E2E-A899ADB28B4F">Starting Managed Servers with a Startup Script</a>を参照されたい。</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">$CATALINA_HOME/bin/setenv.sh</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-properties"><div class="highlight"><pre><span></span><span class="c"># omitted</span>
<span class="c"># (1)</span>
<span class="na">-Dorg.apache.activemq.SERIALIZABLE_PACKAGES</span><span class="o">=</span><span class="s">java.lang,java.util,org.apache.activemq,org.fusesource.hawtbuf,com.thoughtworks.xstream.mapper,com.example.domain.model</span>
<span class="c"># omitted</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">許可する任意のオブジェクトのパッケージを追加する。<code class="docutils literal"><span class="pre">java.lang</span></code>, <code class="docutils literal"><span class="pre">java.util</span></code>, <code class="docutils literal"><span class="pre">org.apache.activemq</span></code>, <code class="docutils literal"><span class="pre">org.fusesource.hawtbuf</span></code>, <code class="docutils literal"><span class="pre">com.thoughtworks.xstream.mapper</span></code>はApache ActiveMQを使用する場合に必要な設定である。</div>
<div class="line">このサンプルで必要な設定値として、”com.example.domain.model”を追加している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
<li><p class="first"><strong>ライブラリの追加</strong></p>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">spring-jms</span></code>ライブラリにはJMS APIが含まれない。</div>
<div class="line">JMSプロバイダのライブラリにはJMS APIを含むことが多いが、JMSプロバイダのライブラリにJMS APIが含まれない場合は、pom.xmlにJMS APIを追加する。</div>
</div>
<div class="line-block">
<div class="line">domainプロジェクトとwebプロジェクトのpom.xmlに<code class="docutils literal"><span class="pre">activemq-client</span></code>をビルド用のライブラリとして追加する。</div>
<div class="line">また、アプリケーションサーバに<code class="docutils literal"><span class="pre">activemq-client</span></code>とその依存ライブラリを追加する。</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/pom.xml</span></code></li>
<li><code class="file docutils literal"><span class="pre">[projectName]-web/pom.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependencies&gt;</span>

    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-jms<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>jakarta.jms<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>jakarta.jms-api<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.activemq<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>activemq-client<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>

<span class="nt">&lt;/dependencies&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Apache ActiveMQのクライアントライブラリをビルド用としてdependenciesに追加する。</div>
<div class="line">なお、本ライブラリの当該バージョンはJMS 1.1で動作するため、依存ライブラリにはJMS API 1.1を含む。</div>
<div class="line">しかし、spring-jms 5.xで必要となるJMS 2.0のAPIを含まないため、実行時はアプリケーションサーバ側で用意する必要がある。</div>
<div class="line">アプリケーションサーバがもともとJMS APIを含まない場合、Spring Bootで管理されるバージョンの<code class="docutils literal"><span class="pre">jakarta.jms-api</span></code>を格納すれば良い。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line">また、アプリケーションサーバがライブラリを参照するため、サーバ内に<code class="docutils literal"><span class="pre">activemq-client</span></code>とその依存ライブラリを追加する。</div>
<div class="line">追加するライブラリは下記になる。</div>
</div>
<ul class="simple">
<li>org.apache.activemq:activemq-client:5.15.11</li>
<li>org.apache.geronimo:specs.geronimo-j2ee-management_1.1_spec:1.0.1</li>
<li>org.apache.geronimo:specs.geronimo-jms_1.1_spec:1.1.1</li>
<li>org.fusesource.hawtbuf:hawtbuf:1.11</li>
<li>org.slf4j:slf4j-api:1.7.25</li>
<li>jakarta.jms:jakarta.jms-api:2.0.3</li>
</ul>
</li>
</ul>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">上記設定例は、依存ライブラリのバージョンを親プロジェクトである terasoluna-gfw-parent で管理する前提であるため、pom.xmlでのバージョンの指定は不要である。
上記の依存ライブラリはterasoluna-gfw-parentが依存している<a class="reference external" href="https://docs.spring.io/spring-boot/docs/2.4.1/reference/htmlsingle/#dependency-versions">Spring Boot</a>で管理されている。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">TERASOLUNA Server Framework for Javaで使用している<a class="reference external" href="https://spring.io/projects/spring-boot">Spring Boot</a>では、Apache ActiveMQと接続などを行う際に使用するライブラリのバージョンを定義している。
そのため、Apache ActiveMQのバージョンを決定する際には注意すること。
また、TERASOLUNA Server Framework for Javaのバージョンアップの際には、ライブラリとミドルウェアのバージョンの整合性が取れなくなる可能性があるので注意すること。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul>
<li><p class="first"><strong>アプリケーションサーバへのJNDI登録</strong></p>
<div class="line-block">
<div class="line">アプリケーションサーバへのJNDI登録については、<a class="reference external" href="http://activemq.apache.org/tomcat.html">Manually integrating Tomcat and ActiveMQ</a>を参照されたい。</div>
</div>
</li>
<li><p class="first"><strong>JNDIを使用しない場合の設定</strong></p>
<div class="line-block">
<div class="line">本ガイドラインではJNDIによる名前解決する方法を推奨しているが、</div>
<div class="line">アプリケーションサーバ上で動かせない単体テストの実施において、JMSプロバイダと接続する場合などには、JNDIを利用しないケースがある。</div>
<div class="line">その場合、<code class="docutils literal"><span class="pre">ConnectionFactory</span></code>の実装クラスのBeanの生成と、JMSプロバイダでDestinationの名前解決を行うために<code class="docutils literal"><span class="pre">DynamicDestinationResolver</span></code>を設定する必要がある。</div>
<div class="line">ただし、<code class="docutils literal"><span class="pre">JmsTemplate</span></code>の<code class="docutils literal"><span class="pre">destinationResolver</span></code>属性や<code class="docutils literal"><span class="pre">DefaultMessageListenerContainer</span></code>の<code class="docutils literal"><span class="pre">destination-resolver</span></code>属性を省略した場合は、内部的に生成された<code class="docutils literal"><span class="pre">DynamicDestinationResolver</span></code>が使用されるため、<code class="docutils literal"><span class="pre">DynamicDestinationResolver</span></code>のBean定義を省略可能である。</div>
<div class="line">また、QueueについてもJNDIを用いて指定していたが、JMSプロバイダーの機能を用いてDestinationに指定したQueueが存在しない場合に、指定した名前のQueueを動的に生成させることができる。</div>
<div class="line">アプリケーションサーバを介さずに接続を行うにはApache ActiveMQの内部Brokerを用いる必要がある。</div>
<div class="line">Apache ActiveMQの内部Brokerの設定については<a class="reference external" href="http://activemq.apache.org/how-do-i-embed-a-broker-inside-a-connection.html">How do I embed a Broker inside a Connection</a>を参照されたい。</div>
<div class="line">テスト用のコンテキストに下記の設定を追加すること。</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-env/src/main/resources/META-INF/spring/[projectName]-env.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;connectionFactory&quot;</span> <span class="na">class=</span><span class="s">&quot;org.apache.activemq.ActiveMQConnectionFactory&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">value=</span><span class="s">&quot;tcp://localhost:61616&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;destinationResolver&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.jms.support.destination.DynamicDestinationResolver&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Apache ActiveMQの<code class="docutils literal"><span class="pre">ConnectionFactory</span></code>をBean定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Apache ActiveMQの起動URLを指定する。起動URLは各環境に沿った値を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DynamicDestinationResolver</span></code>をBean定義する。</div>
<div class="line">Destinationが指定されていない場合には、省略可能である。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
</ul>
</div>
</div>
<div class="section" id="jmsappendixsendmanysamemessages">
<span id="id23"></span><h3><a class="toc-backref" href="#id56">8.2.3.2. 同一メッセージの大量送信</a><a class="headerlink" href="#jmsappendixsendmanysamemessages" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">同一メッセージの大量送信の実装において<code class="docutils literal"><span class="pre">JmsMessageTemplate</span></code>を使用する場合、メモリ使用量が増えてしまう可能性がある。</div>
<div class="line">そのため、<code class="docutils literal"><span class="pre">JmsTemplate</span></code>クラスの<code class="docutils literal"><span class="pre">send</span></code>メソッドを使用して実装を行うことを検討する必要がある。</div>
<div class="line">理由としては、<code class="docutils literal"><span class="pre">JmsMessageTemplate</span></code>ではメッセージ送信処理を行うたびに<code class="docutils literal"><span class="pre">org.springframework.jms.core.MessageCreator</span></code>というクラスのインスタンスが生成されてしまう。</div>
<div class="line">無駄なインスタンスの生成を防ぐために、送信処理時に<code class="docutils literal"><span class="pre">MessageCreator</span></code>のインスタンスが生成されない<code class="docutils literal"><span class="pre">JmsTemplate</span></code>クラスの<code class="docutils literal"><span class="pre">send</span></code>メソッドで送信を行うことでメモリの使用量を削減するようにする。</div>
<div class="line">以下に、ある文字列を同一Destinationに100件送信を行う場合コード例を示す。</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/java/com/example/domain/service/todo/TodoServiceImpl.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span> <span class="kn">package</span> <span class="nn">com.example.domain.service.todo</span><span class="p">;</span>

 <span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
 <span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>
 <span class="kn">import</span> <span class="nn">javax.jms.JMSException</span><span class="p">;</span>
 <span class="kn">import</span> <span class="nn">javax.jms.Message</span><span class="p">;</span>
 <span class="kn">import</span> <span class="nn">javax.jms.Session</span><span class="p">;</span>
 <span class="kn">import</span> <span class="nn">javax.jms.TextMessage</span><span class="p">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.jms.core.JmsTemplate</span><span class="p">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.jms.core.MessageCreator</span><span class="p">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>

 <span class="nd">@Service</span>
 <span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">JmsTemplate</span> <span class="n">jmsTemplate</span><span class="p">;</span> <span class="c1">// (1)</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendManyMessage</span><span class="p">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">messageStr</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="p">{</span>
        <span class="n">MessageCreator</span> <span class="n">mc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MessageCreator</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// (2)</span>
            <span class="kd">public</span> <span class="n">Message</span> <span class="nf">createMessage</span><span class="p">(</span><span class="n">Session</span> <span class="n">session</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">JMSException</span> <span class="p">{</span>
                <span class="n">TextMessage</span> <span class="n">message</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="na">createTextMessage</span><span class="p">();</span> <span class="c1">// (3)</span>
                <span class="n">message</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="n">messageStr</span><span class="p">);</span>

                <span class="c1">// omitted</span>
                <span class="k">return</span> <span class="n">message</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">};</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">jmsTemplate</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="s">&quot;jms/queue/TodoMessageQueue&quot;</span><span class="p">,</span> <span class="n">mc</span><span class="p">);</span> <span class="c1">// (4)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsMessagingTemplate</span></code>を使用すると、送信のたびに<code class="docutils literal"><span class="pre">MessageCreater</span></code>の生成が行われてしまうため、<code class="docutils literal"><span class="pre">MessageCreater</span></code>の生成を送信と分離して定義できる<code class="docutils literal"><span class="pre">JmsTemplate</span></code>を利用する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JMSの<code class="docutils literal"><span class="pre">Message</span></code>を作成するために<code class="docutils literal"><span class="pre">MessageCreator</span></code>のインスタンスを生成する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JmsTemplate</span></code>クラスの<code class="docutils literal"><span class="pre">send</span></code>メソッドでメッセージを送信することで、ループごとに<code class="docutils literal"><span class="pre">MessageCreator</span></code>のインスタンスを生成が行われなくなり、
メモリの使用量を削減させることができるようになる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="jmsappendixsendlargedata">
<span id="id24"></span><h3><a class="toc-backref" href="#id57">8.2.3.3. サイズの大きなデータの送受信</a><a class="headerlink" href="#jmsappendixsendlargedata" title="Permalink to this headline">¶</a></h3>
<p>画像データなどサイズの大きなデータ(目安として1 MB以上)を扱う場合、同時トランザクション数やヒープサイズによっては<code class="docutils literal"><span class="pre">OutOfMemoryError</span></code>が発生する可能性がある。
JMSの標準APIではサイズの大きなデータをストリームとして扱うことができるのはプリミティブ型のデータの送信を行う<code class="docutils literal"><span class="pre">StreamMessage</span></code>と未解釈のバイトストリームの送信を行える<code class="docutils literal"><span class="pre">ByteMessage</span></code>のみである。
そのため、JMS APIではなく、JMSプロバイダベンダ毎に用意している固有のAPIを使用するケースがある。</p>
<div class="section" id="id25">
<h4><a class="toc-backref" href="#id58">8.2.3.3.1. Apache ActiveMQを利用する場合</a><a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="http://activemq.apache.org/blob-messages.html">Blob Message</a>を使用することでサイズの大きなメッセージを送受信することができる。実装例を以下に示す。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">org.apache.activemq.BlobMessage</span></code>を使用する場合、Apache ActiveMQ独自のAPIを使用することになるため、
Spring Frameworkが提供している<code class="docutils literal"><span class="pre">Message</span></code>や<code class="docutils literal"><span class="pre">CachingConnectionFactory</span></code>を使用することはできない。
性能影響を考慮し、<code class="docutils literal"><span class="pre">BlobMessage</span></code>を使用する場合は<code class="docutils literal"><span class="pre">BlobMessage</span></code>用の<code class="docutils literal"><span class="pre">JmsTemplate</span></code>を別途定義することを推奨する。</p>
</div>
</div></blockquote>
<ul>
<li><p class="first"><strong>設定</strong></p>
<p><code class="docutils literal"><span class="pre">BlobMessage</span></code>を用いたメッセージの送信では、メッセージはヒープ領域ではなく、一時的にApache ActiveMQが起動しているサーバに格納される。
メッセージの格納先の定義例を以下に示す。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-env/src/main/resources/META-INF/spring/[projectName]-env.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;connectionFactory&quot;</span>
   <span class="na">class=</span><span class="s">&quot;org.apache.activemq.ActiveMQConnectionFactory&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;brokerURL&quot;</span><span class="nt">&gt;</span>
      <span class="c">&lt;!-- (1) --&gt;</span>
      <span class="nt">&lt;value&gt;</span>tcp://localhost:61616?jms.blobTransferPolicy.uploadUrl=/tmp<span class="nt">&lt;/value&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">一時的にメッセージを格納するApache ActiveMQのサーバのディレクトリを定義する。</div>
<div class="line"><code class="docutils literal"><span class="pre">jms.blobTransferPolicy.uploadUrl</span></code>にはデフォルトで<code class="docutils literal"><span class="pre">http://localhost:8080/uploads/</span></code>が設定されており、デフォルトか<code class="docutils literal"><span class="pre">brokerURL</span></code>をオーバーロードすることで一時ファイルの置き場を指定できる。</div>
<div class="line">例では<code class="docutils literal"><span class="pre">/tmp</span></code>に一時的にファイルを格納している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
<li><p class="first"><strong>送信</strong></p>
<p><code class="docutils literal"><span class="pre">Blob</span> <span class="pre">Message</span></code>を利用した送信クラスの実装例を以下に示す。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/java/com/example/domain/service/todo/TodoServiceImpl.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Path</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.JMSException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.Message</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.Session</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQSession</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.activemq.BlobMessage</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jms.core.JmsTemplate</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jms.core.MessageCreator</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="p">{</span>
    <span class="nd">@Inject</span>
    <span class="n">JmsTemplate</span> <span class="n">jmsTemplate</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendBlobMessage</span><span class="p">(</span><span class="n">String</span> <span class="n">inputFilePath</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="p">{</span>

        <span class="n">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">inputFilePath</span><span class="p">);</span>
        <span class="k">try</span> <span class="p">(</span><span class="kd">final</span> <span class="n">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">Files</span><span class="p">.</span><span class="na">newInputStream</span><span class="p">(</span><span class="n">path</span><span class="p">))</span> <span class="p">{</span>

            <span class="n">jmsTemplate</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="s">&quot;jms/queue/TodoMessageQueue&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="n">MessageCreator</span><span class="p">()</span> <span class="p">{</span>
                <span class="kd">public</span> <span class="n">Message</span> <span class="nf">createMessage</span><span class="p">(</span><span class="n">Session</span> <span class="n">session</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">JMSException</span> <span class="p">{</span>

                    <span class="n">ActiveMQSession</span> <span class="n">activeMQSession</span> <span class="o">=</span> <span class="p">(</span><span class="n">ActiveMQSession</span><span class="p">)</span> <span class="n">session</span><span class="p">;</span>  <span class="c1">// (1)</span>

                    <span class="n">BlobMessage</span> <span class="n">blobMessage</span> <span class="o">=</span> <span class="n">activeMQSession</span><span class="p">.</span><span class="na">createBlobMessage</span><span class="p">(</span><span class="n">inputStream</span><span class="p">);</span>  <span class="c1">// (2)</span>
                    <span class="k">return</span> <span class="n">blobMessage</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">BlobMessage</span></code>を使用するにはApache ActiveMQ独自APIである<code class="docutils literal"><span class="pre">org.apache.activemq.ActiveMQSession</span></code>を使用する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ActiveMQSession</span></code>より、送信データを指定して<code class="docutils literal"><span class="pre">BlobMessage</span></code>を生成する。</div>
<div class="line"><code class="docutils literal"><span class="pre">createBlobMessage</span></code>メソッドの引数は<code class="docutils literal"><span class="pre">File</span></code>、<code class="docutils literal"><span class="pre">InputStream</span></code>、<code class="docutils literal"><span class="pre">URL</span></code>クラスが指定可能である。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
<li><p class="first"><strong>受信</strong></p>
<p>受信クラスの実装例を以下に示す。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-web/src/main/java/com/example/listener/todo/TodoMessageListener.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.listener.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.JMSException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.activemq.BlobMessage</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jms.annotation.JmsListener</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.service.todo.TodoService</span><span class="p">;</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoMessageListener</span> <span class="p">{</span>
    <span class="nd">@Inject</span>
    <span class="n">TodoService</span> <span class="n">todoService</span><span class="p">;</span>
    <span class="nd">@JmsListener</span><span class="p">(</span><span class="n">destination</span> <span class="o">=</span> <span class="s">&quot;jms/queue/TodoMessageQueue&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">receiveBlobMessage</span><span class="p">(</span><span class="n">BlobMessage</span> <span class="n">message</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">,</span> <span class="n">JMSException</span> <span class="p">{</span>
     <span class="n">todoService</span><span class="p">.</span><span class="na">fileInputBlobMessage</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
        <span class="c1">// omitted</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">[projectName]-domain/src/main/java/com/example/domain/service/todo/TodoServiceImpl.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Path</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.activemq.BlobMessage</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">fileInputBlobMessage</span><span class="p">(</span><span class="n">BlobMessage</span> <span class="n">message</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="p">{</span>
        <span class="k">try</span><span class="p">(</span><span class="n">InputStream</span> <span class="n">is</span> <span class="o">=</span>  <span class="n">message</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">()){</span>   <span class="c1">// (1)</span>
            <span class="n">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;outputFilePath&quot;</span><span class="p">);</span>
            <span class="n">Files</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
            <span class="c1">// omitted</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="13%" />
<col width="87%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">受信した<code class="docutils literal"><span class="pre">BlobMessage</span></code>より、<code class="docutils literal"><span class="pre">InputStream</span></code>としてデータを取得する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
</ul>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../Security/index.html" title="9. セキュリティ対策"
             >next</a> |</li>
        <li class="right" >
          <a href="Email.html" title="8.1. E-mail送信(SMTP)"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.7.0.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >8. メッセージ連携</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer">
      © Copyright 2013, NTT DATA Corporation. © Copyright 2013, NTT Corporation.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3.Theme is <a href="http://github.com/vimalkvn/solar-theme">Solar</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>

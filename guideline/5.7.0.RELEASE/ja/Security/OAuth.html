<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>9.9. OAuth &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.7.0.RELEASE documentation</title>
    <link rel="stylesheet" href="../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '5.7.0.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="9.10. 代表的なセキュリティ要件の実装例" href="SecureLoginDemo.html" />
    <link rel="prev" title="9.8. 暗号化" href="Encryption.html" /><script async src="https://www.googletagmanager.com/gtag/js?id=G-847V2Q99G8"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date()); gtag('config', 'G-847V2Q99G8');
</script>
<script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="SecureLoginDemo.html" title="9.10. 代表的なセキュリティ要件の実装例"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Encryption.html" title="9.8. 暗号化"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.7.0.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">9. セキュリティ対策</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">9.9. OAuth</a><ul>
<li><a class="reference internal" href="#overview">9.9.1. Overview</a><ul>
<li><a class="reference internal" href="#oauth-2-0">9.9.1.1. OAuth 2.0とは</a></li>
<li><a class="reference internal" href="#oautharchitecture">9.9.1.2. OAuth 2.0のアーキテクチャ</a><ul>
<li><a class="reference internal" href="#oauthrole">9.9.1.2.1. ロール</a></li>
<li><a class="reference internal" href="#oauthscope">9.9.1.2.2. スコープ</a></li>
<li><a class="reference internal" href="#oauthprotocolflow">9.9.1.2.3. プロトコルフロー</a></li>
<li><a class="reference internal" href="#authorizationgrant">9.9.1.2.4. 認可グラント</a><ul>
<li><a class="reference internal" href="#id8">9.9.1.2.4.1. 認可コードグラント</a></li>
<li><a class="reference internal" href="#id9">9.9.1.2.4.2. インプリシットグラント</a></li>
<li><a class="reference internal" href="#id10">9.9.1.2.4.3. リソースオーナパスワードクレデンシャルグラント</a></li>
<li><a class="reference internal" href="#id11">9.9.1.2.4.4. クライアントクレデンシャルグラント</a></li>
</ul>
</li>
<li><a class="reference internal" href="#accesstokenlifecycle">9.9.1.2.5. アクセストークンのライフサイクル</a></li>
</ul>
</li>
<li><a class="reference internal" href="#spring-security-oauth">9.9.1.3. Spring Security OAuthのアーキテクチャ</a><ul>
<li><a class="reference internal" href="#authorizationserver">9.9.1.3.1. 認可サーバ</a><ul>
<li><a class="reference internal" href="#id14">9.9.1.3.1.1. クライアントの認証</a></li>
<li><a class="reference internal" href="#id15">9.9.1.3.1.2. リソースオーナの認証</a></li>
<li><a class="reference internal" href="#id16">9.9.1.3.1.3. リソースオーナからの認可の取得</a><ul>
<li><a class="reference internal" href="#definitionofbadclienterror">9.9.1.3.1.3.1. 不正クライアントエラー</a></li>
</ul>
</li>
<li><a class="reference internal" href="#issueofaccesstoken">9.9.1.3.1.4. アクセストークンの発行</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resourceserver">9.9.1.3.2. リソースサーバ</a></li>
<li><a class="reference internal" href="#client">9.9.1.3.3. クライアント</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">9.9.2. How to use</a><ul>
<li><a class="reference internal" href="#oauthhowtouseconfiguration">9.9.2.1. How to Useの構成</a></li>
<li><a class="reference internal" href="#oauthsetup">9.9.2.2. Spring Security OAuthのセットアップ</a></li>
<li><a class="reference internal" href="#implementationautorizationcodegrant">9.9.2.3. 認可コードグラントの実装</a><ul>
<li><a class="reference internal" href="#implementationoauthauthorizationserverofautorizationcode">9.9.2.3.1. 認可サーバの実装</a><ul>
<li><a class="reference internal" href="#oauthauthorizationservercreatesettingfile">9.9.2.3.1.1. 設定ファイルの作成（認可サーバ）</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverdefinition">9.9.2.3.1.2. 認可サーバの定義</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverclientauthentication">9.9.2.3.1.3. クライアントの認証</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverresourceownerauthentication">9.9.2.3.1.4. リソースオーナの認証</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtoauthorizebyscope">9.9.2.3.1.5. スコープごとの認可</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtocustomizeauthorizeview">9.9.2.3.1.6. スコープ認可画面のカスタマイズ</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtohandleerror">9.9.2.3.1.7. 認可リクエスト時のエラー画面のカスタマイズ</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtoconfigureaccesstoken">9.9.2.3.1.8. リソースサーバへのアクセストークンの連携方法</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtocanceltoken">9.9.2.3.1.9. トークンの取り消し（認可サーバ）</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtocontrolltarnsaction">9.9.2.3.1.10. トランザクション制御</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementationoauthresourceserverofautorizationcode">9.9.2.3.2. リソースサーバの実装</a><ul>
<li><a class="reference internal" href="#id36">9.9.2.3.2.1. 設定ファイルの作成（リソースサーバ）</a></li>
<li><a class="reference internal" href="#id37">9.9.2.3.2.2. リソースにアクセス可能なスコープの設定</a></li>
<li><a class="reference internal" href="#id38">9.9.2.3.2.3. 認可サーバとのアクセストークンの連携方法</a></li>
<li><a class="reference internal" href="#oauthresourceservergetprincipal">9.9.2.3.2.4. ユーザ情報の取得</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementationoauthclientserverofautorizationcode">9.9.2.3.3. クライアントの実装</a><ul>
<li><a class="reference internal" href="#id41">9.9.2.3.3.1. 設定ファイルの作成（クライアント）</a></li>
<li><a class="reference internal" href="#oauth2clientcontextfilter">9.9.2.3.3.2. OAuth2ClientContextFilterの適用</a></li>
<li><a class="reference internal" href="#oauth2resttemplate">9.9.2.3.3.3. OAuth2RestTemplateの設定</a></li>
<li><a class="reference internal" href="#oauthaccessofresourceserver">9.9.2.3.3.4. リソースサーバへのアクセス</a></li>
<li><a class="reference internal" href="#oauthclientserverhowtocanceltoken">9.9.2.3.3.5. トークンの取り消し（クライアントサーバ）</a></li>
<li><a class="reference internal" href="#oauthclienterrorhandlingwithcode">9.9.2.3.3.6. エラーハンドリング</a><ul>
<li><a class="reference internal" href="#oauthclienthandleerrorwhenaccessingauthorizationendpointwithcode">9.9.2.3.3.6.1. 認可エンドポイントアクセス時のエラーハンドリング</a></li>
<li><a class="reference internal" href="#oauthclienthandleerrorwhenaccessingtokenendpointwithcode">9.9.2.3.3.6.2. トークンエンドポイント及びリソースサーバアクセス時のエラーハンドリング</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#implementationimplicitgrant">9.9.2.4. インプリシットグラントの実装</a><ul>
<li><a class="reference internal" href="#implementationoauthauthorizationserverofimplicit">9.9.2.4.1. 認可サーバの実装</a><ul>
<li><a class="reference internal" href="#id50">9.9.2.4.1.1. 認可サーバの定義</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementationoauthresourceserverofimplicit">9.9.2.4.2. リソースサーバの実装</a></li>
<li><a class="reference internal" href="#implementationoauthclientserverofimplicit">9.9.2.4.3. クライアントの実装</a><ul>
<li><a class="reference internal" href="#javascript">9.9.2.4.3.1. JavaScriptを使用したリソースサーバへのアクセス</a></li>
<li><a class="reference internal" href="#id53">9.9.2.4.3.2. トークンの取り消し(クライアントサーバ)</a></li>
<li><a class="reference internal" href="#oauthclienterrorhandlingwithimplicit">9.9.2.4.3.3. エラーハンドリング</a><ul>
<li><a class="reference internal" href="#oauthclienthandleerrorwhenaccessingauthorizationendpointwithimplicit">9.9.2.4.3.3.1. 認可エンドポイントアクセス時のエラーハンドリング</a></li>
<li><a class="reference internal" href="#oauthclienthandleerrorwhenaccessingtokenendpointwithimplicit">9.9.2.4.3.3.2. リソースサーバアクセス時のエラーハンドリング</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#implementationresourceownerpasswordcredentialsgrant">9.9.2.5. リソースオーナパスワードクレデンシャルグラントの実装</a><ul>
<li><a class="reference internal" href="#implementationoauthauthorizationserverofpassword">9.9.2.5.1. 認可サーバの実装</a><ul>
<li><a class="reference internal" href="#id59">9.9.2.5.1.1. 認可サーバの定義</a></li>
<li><a class="reference internal" href="#id60">9.9.2.5.1.2. クライアントの認証</a></li>
<li><a class="reference internal" href="#id61">9.9.2.5.1.3. トークンの取り消し（認可サーバ）</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementationoauthresourceserverofpassword">9.9.2.5.2. リソースサーバの実装</a></li>
<li><a class="reference internal" href="#implementationoauthclientserverofpassword">9.9.2.5.3. クライアントの実装</a><ul>
<li><a class="reference internal" href="#oauth2resourceownerpasswordcredentialgrantresourcesettings">9.9.2.5.3.1. OAuth2RestTemplateの設定</a></li>
<li><a class="reference internal" href="#oauthclienterrorhandlingwithpassword">9.9.2.5.3.2. エラーハンドリング</a><ul>
<li><a class="reference internal" href="#oauthclienthandleerrorwhenaccessingtokenendpointwithpassword">9.9.2.5.3.2.1. トークンエンドポイント及びリソースサーバアクセス時のエラーハンドリング</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#clientcredentialsgrant">9.9.2.6. クライアントクレデンシャルグラントの実装</a><ul>
<li><a class="reference internal" href="#implementationoauthauthorizationserverofclientcredentials">9.9.2.6.1. 認可サーバの実装</a><ul>
<li><a class="reference internal" href="#id69">9.9.2.6.1.1. 認可サーバの定義</a></li>
<li><a class="reference internal" href="#id70">9.9.2.6.1.2. クライアントの認証</a></li>
<li><a class="reference internal" href="#id71">9.9.2.6.1.3. トークンの取り消し（認可サーバ）</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementationoauthresourceserverofclientcredentials">9.9.2.6.2. リソースサーバの実装</a><ul>
<li><a class="reference internal" href="#id73">9.9.2.6.2.1. ユーザ情報の取得</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementationoauthclientserverofclientcredentials">9.9.2.6.3. クライアントの実装</a><ul>
<li><a class="reference internal" href="#id75">9.9.2.6.3.1. OAuth2RestTemplateの設定</a></li>
<li><a class="reference internal" href="#oauthclienterrorhandlingwithclient">9.9.2.6.3.2. エラーハンドリング</a><ul>
<li><a class="reference internal" href="#oauthclienthandleerrorwhenaccessingtokenendpointwithclient">9.9.2.6.3.2.1. トークンエンドポイント及びリソースサーバアクセス時のエラーハンドリング</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id78">9.9.2.6.3.3. リソースオーナの認証</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend">9.9.3. How to extend</a><ul>
<li><a class="reference internal" href="#orderofauthoraizationserversupportsetting">9.9.3.1. 認可サーバで複数のグラントタイプをサポートする場合</a></li>
<li><a class="reference internal" href="#http">9.9.3.2. HTTPアクセスを介した認可サーバとリソースサーバの連携</a><ul>
<li><a class="reference internal" href="#id80">9.9.3.2.1. 認可サーバの設定</a></li>
<li><a class="reference internal" href="#id81">9.9.3.2.2. リソースサーバの設定</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtogetotherthanusername">9.9.3.2.3. リソースサーバへの独自項目連携方法</a><ul>
<li><a class="reference internal" href="#defaultaccesstokenconverter">9.9.3.2.3.1. DefaultAccessTokenConverterとは</a></li>
<li><a class="reference internal" href="#id83">9.9.3.2.3.2. 認可サーバの実装</a></li>
<li><a class="reference internal" href="#id84">9.9.3.2.3.3. リソースサーバの実装</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id85">9.9.3.3. 認可サーバにおけるパスのカスタマイズ</a><ul>
<li><a class="reference internal" href="#customizableurl">9.9.3.3.1. カスタマイズ可能なパス</a></li>
<li><a class="reference internal" href="#customizepath">9.9.3.3.2. パスのカスタマイズ</a><ul>
<li><a class="reference internal" href="#customizeendpoint">9.9.3.3.2.1. エンドポイントのカスタマイズ</a></li>
<li><a class="reference internal" href="#customizeforward">9.9.3.3.2.2. フォワード先のカスタマイズ</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix">9.9.4. Appendix</a><ul>
<li><a class="reference internal" href="#oauthappendixoccuringerrors">9.9.4.1. クライアントから認可サーバ、リソースサーバアクセス時に発生するエラー</a><ul>
<li><a class="reference internal" href="#id91">9.9.4.1.1. 認可エンドポイントで発生するエラー</a></li>
<li><a class="reference internal" href="#id92">9.9.4.1.2. トークンエンドポイントで発生するエラー</a></li>
<li><a class="reference internal" href="#id93">9.9.4.1.3. リソースサーバで発生するエラー</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id94">9.9.4.2. Spring Security OAuthの拡張について</a><ul>
<li><a class="reference internal" href="#id96">9.9.4.2.1. アクセストークンリクエストとそのレスポンスの拡張</a><ul>
<li><a class="reference internal" href="#oauthappendixclient">9.9.4.2.1.1. クライアント</a></li>
<li><a class="reference internal" href="#oauthappendixauthorizationserver">9.9.4.2.1.2. 認可サーバ</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="Encryption.html"
                        title="previous chapter">9.8. 暗号化</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="SecureLoginDemo.html"
                        title="next chapter">9.10. 代表的なセキュリティ要件の実装例</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/Security/OAuth.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="oauth">
<span id="id1"></span><h1>9.9. OAuth<a class="headerlink" href="#oauth" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="id2">
<p class="topic-title">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id132">Overview</a><ul>
<li><a class="reference internal" href="#oauth-2-0" id="id133">OAuth 2.0とは</a></li>
<li><a class="reference internal" href="#oautharchitecture" id="id134">OAuth 2.0のアーキテクチャ</a><ul>
<li><a class="reference internal" href="#oauthrole" id="id135">ロール</a></li>
<li><a class="reference internal" href="#oauthscope" id="id136">スコープ</a></li>
<li><a class="reference internal" href="#oauthprotocolflow" id="id137">プロトコルフロー</a></li>
<li><a class="reference internal" href="#authorizationgrant" id="id138">認可グラント</a><ul>
<li><a class="reference internal" href="#id8" id="id139">認可コードグラント</a></li>
<li><a class="reference internal" href="#id9" id="id140">インプリシットグラント</a></li>
<li><a class="reference internal" href="#id10" id="id141">リソースオーナパスワードクレデンシャルグラント</a></li>
<li><a class="reference internal" href="#id11" id="id142">クライアントクレデンシャルグラント</a></li>
</ul>
</li>
<li><a class="reference internal" href="#accesstokenlifecycle" id="id143">アクセストークンのライフサイクル</a></li>
</ul>
</li>
<li><a class="reference internal" href="#spring-security-oauth" id="id144">Spring Security OAuthのアーキテクチャ</a><ul>
<li><a class="reference internal" href="#authorizationserver" id="id145">認可サーバ</a><ul>
<li><a class="reference internal" href="#id14" id="id146">クライアントの認証</a></li>
<li><a class="reference internal" href="#id15" id="id147">リソースオーナの認証</a></li>
<li><a class="reference internal" href="#id16" id="id148">リソースオーナからの認可の取得</a><ul>
<li><a class="reference internal" href="#definitionofbadclienterror" id="id149">不正クライアントエラー</a></li>
</ul>
</li>
<li><a class="reference internal" href="#issueofaccesstoken" id="id150">アクセストークンの発行</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resourceserver" id="id151">リソースサーバ</a></li>
<li><a class="reference internal" href="#client" id="id152">クライアント</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use" id="id153">How to use</a><ul>
<li><a class="reference internal" href="#oauthhowtouseconfiguration" id="id154">How to Useの構成</a></li>
<li><a class="reference internal" href="#oauthsetup" id="id155">Spring Security OAuthのセットアップ</a></li>
<li><a class="reference internal" href="#implementationautorizationcodegrant" id="id156">認可コードグラントの実装</a><ul>
<li><a class="reference internal" href="#implementationoauthauthorizationserverofautorizationcode" id="id157">認可サーバの実装</a><ul>
<li><a class="reference internal" href="#oauthauthorizationservercreatesettingfile" id="id158">設定ファイルの作成（認可サーバ）</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverdefinition" id="id159">認可サーバの定義</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverclientauthentication" id="id160">クライアントの認証</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverresourceownerauthentication" id="id161">リソースオーナの認証</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtoauthorizebyscope" id="id162">スコープごとの認可</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtocustomizeauthorizeview" id="id163">スコープ認可画面のカスタマイズ</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtohandleerror" id="id164">認可リクエスト時のエラー画面のカスタマイズ</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtoconfigureaccesstoken" id="id165">リソースサーバへのアクセストークンの連携方法</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtocanceltoken" id="id166">トークンの取り消し（認可サーバ）</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtocontrolltarnsaction" id="id167">トランザクション制御</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementationoauthresourceserverofautorizationcode" id="id168">リソースサーバの実装</a><ul>
<li><a class="reference internal" href="#id36" id="id169">設定ファイルの作成（リソースサーバ）</a></li>
<li><a class="reference internal" href="#id37" id="id170">リソースにアクセス可能なスコープの設定</a></li>
<li><a class="reference internal" href="#id38" id="id171">認可サーバとのアクセストークンの連携方法</a></li>
<li><a class="reference internal" href="#oauthresourceservergetprincipal" id="id172">ユーザ情報の取得</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementationoauthclientserverofautorizationcode" id="id173">クライアントの実装</a><ul>
<li><a class="reference internal" href="#id41" id="id174">設定ファイルの作成（クライアント）</a></li>
<li><a class="reference internal" href="#oauth2clientcontextfilter" id="id175">OAuth2ClientContextFilterの適用</a></li>
<li><a class="reference internal" href="#oauth2resttemplate" id="id176">OAuth2RestTemplateの設定</a></li>
<li><a class="reference internal" href="#oauthaccessofresourceserver" id="id177">リソースサーバへのアクセス</a></li>
<li><a class="reference internal" href="#oauthclientserverhowtocanceltoken" id="id178">トークンの取り消し（クライアントサーバ）</a></li>
<li><a class="reference internal" href="#oauthclienterrorhandlingwithcode" id="id179">エラーハンドリング</a><ul>
<li><a class="reference internal" href="#oauthclienthandleerrorwhenaccessingauthorizationendpointwithcode" id="id180">認可エンドポイントアクセス時のエラーハンドリング</a></li>
<li><a class="reference internal" href="#oauthclienthandleerrorwhenaccessingtokenendpointwithcode" id="id181">トークンエンドポイント及びリソースサーバアクセス時のエラーハンドリング</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#implementationimplicitgrant" id="id182">インプリシットグラントの実装</a><ul>
<li><a class="reference internal" href="#implementationoauthauthorizationserverofimplicit" id="id183">認可サーバの実装</a><ul>
<li><a class="reference internal" href="#id50" id="id184">認可サーバの定義</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementationoauthresourceserverofimplicit" id="id185">リソースサーバの実装</a></li>
<li><a class="reference internal" href="#implementationoauthclientserverofimplicit" id="id186">クライアントの実装</a><ul>
<li><a class="reference internal" href="#javascript" id="id187">JavaScriptを使用したリソースサーバへのアクセス</a></li>
<li><a class="reference internal" href="#id53" id="id188">トークンの取り消し(クライアントサーバ)</a></li>
<li><a class="reference internal" href="#oauthclienterrorhandlingwithimplicit" id="id189">エラーハンドリング</a><ul>
<li><a class="reference internal" href="#oauthclienthandleerrorwhenaccessingauthorizationendpointwithimplicit" id="id190">認可エンドポイントアクセス時のエラーハンドリング</a></li>
<li><a class="reference internal" href="#oauthclienthandleerrorwhenaccessingtokenendpointwithimplicit" id="id191">リソースサーバアクセス時のエラーハンドリング</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#implementationresourceownerpasswordcredentialsgrant" id="id192">リソースオーナパスワードクレデンシャルグラントの実装</a><ul>
<li><a class="reference internal" href="#implementationoauthauthorizationserverofpassword" id="id193">認可サーバの実装</a><ul>
<li><a class="reference internal" href="#id59" id="id194">認可サーバの定義</a></li>
<li><a class="reference internal" href="#id60" id="id195">クライアントの認証</a></li>
<li><a class="reference internal" href="#id61" id="id196">トークンの取り消し（認可サーバ）</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementationoauthresourceserverofpassword" id="id197">リソースサーバの実装</a></li>
<li><a class="reference internal" href="#implementationoauthclientserverofpassword" id="id198">クライアントの実装</a><ul>
<li><a class="reference internal" href="#oauth2resourceownerpasswordcredentialgrantresourcesettings" id="id199">OAuth2RestTemplateの設定</a></li>
<li><a class="reference internal" href="#oauthclienterrorhandlingwithpassword" id="id200">エラーハンドリング</a><ul>
<li><a class="reference internal" href="#oauthclienthandleerrorwhenaccessingtokenendpointwithpassword" id="id201">トークンエンドポイント及びリソースサーバアクセス時のエラーハンドリング</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#clientcredentialsgrant" id="id202">クライアントクレデンシャルグラントの実装</a><ul>
<li><a class="reference internal" href="#implementationoauthauthorizationserverofclientcredentials" id="id203">認可サーバの実装</a><ul>
<li><a class="reference internal" href="#id69" id="id204">認可サーバの定義</a></li>
<li><a class="reference internal" href="#id70" id="id205">クライアントの認証</a></li>
<li><a class="reference internal" href="#id71" id="id206">トークンの取り消し（認可サーバ）</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementationoauthresourceserverofclientcredentials" id="id207">リソースサーバの実装</a><ul>
<li><a class="reference internal" href="#id73" id="id208">ユーザ情報の取得</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementationoauthclientserverofclientcredentials" id="id209">クライアントの実装</a><ul>
<li><a class="reference internal" href="#id75" id="id210">OAuth2RestTemplateの設定</a></li>
<li><a class="reference internal" href="#oauthclienterrorhandlingwithclient" id="id211">エラーハンドリング</a><ul>
<li><a class="reference internal" href="#oauthclienthandleerrorwhenaccessingtokenendpointwithclient" id="id212">トークンエンドポイント及びリソースサーバアクセス時のエラーハンドリング</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id78" id="id213">リソースオーナの認証</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend" id="id214">How to extend</a><ul>
<li><a class="reference internal" href="#orderofauthoraizationserversupportsetting" id="id215">認可サーバで複数のグラントタイプをサポートする場合</a></li>
<li><a class="reference internal" href="#http" id="id216">HTTPアクセスを介した認可サーバとリソースサーバの連携</a><ul>
<li><a class="reference internal" href="#id80" id="id217">認可サーバの設定</a></li>
<li><a class="reference internal" href="#id81" id="id218">リソースサーバの設定</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtogetotherthanusername" id="id219">リソースサーバへの独自項目連携方法</a><ul>
<li><a class="reference internal" href="#defaultaccesstokenconverter" id="id220">DefaultAccessTokenConverterとは</a></li>
<li><a class="reference internal" href="#id83" id="id221">認可サーバの実装</a></li>
<li><a class="reference internal" href="#id84" id="id222">リソースサーバの実装</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id85" id="id223">認可サーバにおけるパスのカスタマイズ</a><ul>
<li><a class="reference internal" href="#customizableurl" id="id224">カスタマイズ可能なパス</a></li>
<li><a class="reference internal" href="#customizepath" id="id225">パスのカスタマイズ</a><ul>
<li><a class="reference internal" href="#customizeendpoint" id="id226">エンドポイントのカスタマイズ</a></li>
<li><a class="reference internal" href="#customizeforward" id="id227">フォワード先のカスタマイズ</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix" id="id228">Appendix</a><ul>
<li><a class="reference internal" href="#oauthappendixoccuringerrors" id="id229">クライアントから認可サーバ、リソースサーバアクセス時に発生するエラー</a><ul>
<li><a class="reference internal" href="#id91" id="id230">認可エンドポイントで発生するエラー</a></li>
<li><a class="reference internal" href="#id92" id="id231">トークンエンドポイントで発生するエラー</a></li>
<li><a class="reference internal" href="#id93" id="id232">リソースサーバで発生するエラー</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id94" id="id233">Spring Security OAuthの拡張について</a><ul>
<li><a class="reference internal" href="#id96" id="id234">アクセストークンリクエストとそのレスポンスの拡張</a><ul>
<li><a class="reference internal" href="#oauthappendixclient" id="id235">クライアント</a></li>
<li><a class="reference internal" href="#oauthappendixauthorizationserver" id="id236">認可サーバ</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<span id="oauthoverview"></span><h2><a class="toc-backref" href="#id132">9.9.1. Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>本節では、OAuth 2.0の概要とSpringプロジェクトの一つである
Spring Security OAuthを使用してOAuth 2.0の仕様に沿った認可制御機能を実装する方法について説明する。</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>Spring Security OAuth のリファレンス</strong></p>
<p class="last">Spring Security OAuthは、本ガイドラインで紹介していない機能も提供している。
Spring Security OAuthについて詳しく知りたい場合は、<a class="reference external" href="https://projects.spring.io/spring-security-oauth/docs/oauth2.html">OAuth 2 Developers Guide</a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="oauth-2-0">
<span id="oauthaboutoauth2-0"></span><h3><a class="toc-backref" href="#id133">9.9.1.1. OAuth 2.0とは</a><a class="headerlink" href="#oauth-2-0" title="Permalink to this headline">¶</a></h3>
<p>OAuth 2.0とは、サードパーティ製アプリケーションがHTTPサービスを利用する際に、
サーバ上の保護されたリソースに対するアクセス範囲の指定を可能にするための認可フレームワークのことである。</p>
<p>OAuth 2.0はRFCとして仕様化されており、関連する複数の技術仕様から構成されている。</p>
<p>以下にOAuth 2.0の主要な仕様を示す。</p>
<table border="1" class="colwidths-given longtable docutils" id="id99">
<caption><span class="caption-text"><strong>OAuth 2.0の主要仕様</strong></span><a class="headerlink" href="#id99" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="15%" />
<col width="30%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">RFC</th>
<th class="head">概要</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">RFC 6749</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="http://tools.ietf.org/html/rfc6749">The OAuth 2.0 Authorization Framework</a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">用語や認可方式などの、OAuth 2.0としてのもっとも基本的な内容が記載されている技術仕様。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">RFC 6750</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="https://tools.ietf.org/html/rfc6750">Bearer Token Usage</a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">RFC 6749に記載されている認可制御を実現する場合に利用する、「署名なしアクセストークン」
（以降、アクセストークンと表す）のサーバ間の受け渡し方法に関する技術仕様。</div>
<div class="line">アクセストークンについては後述する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">RFC 6819</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="https://tools.ietf.org/html/rfc6819">Threat Model and Security Considerations</a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OAuth 2.0を使用するうえで考慮が必要となるセキュリティ要件に関する技術仕様。</div>
<div class="line">本ガイドラインでは検討項目の具体的な説明は割愛する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">RFC 7519</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="https://tools.ietf.org/html/rfc7519">JSON Web Token (JWT)</a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">署名が可能なJSONを含んだトークンであるJSON Web Token (JWT)に関する技術仕様。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">RFC 7523</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="https://tools.ietf.org/html/rfc7523">JSON Web Token (JWT) Profile for OAuth 2.0 Client Authentication and Authorization Grants</a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">RFC 6749に記載されている認可制御の実現する場合に利用するアクセストークンとして、RFC 6819で定められているJWTを利用する方法に関する技術仕様。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">RFC 7009</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="https://tools.ietf.org/html/rfc7009">OAuth 2.0 Token Revocation</a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">トークンの無効化を行う追加エンドポイントに関する技術仕様。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>従来のクライアントサーバ型の認証モデルでは、サードパーティ製アプリケーションはHTTPサービスの
保護されたリソースにアクセスするために、ユーザの認証情報（ユーザ名とパスワードなど）を利用して認証を行う。</p>
<p>つまり、ユーザは、サードパーティ製アプリケーションにリソースへのアクセス権を与えるために
自身の認証情報をサードパーティと共有する必要があるが、
これはサードパーティ製アプリケーションに不具合や悪意のある操作などが存在した場合に、
ユーザの意図しないアクセスや情報漏洩等のリスクにつながる。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_TraditionalAuthenticationModel.png"><img alt="../_images/OAuth_TraditionalAuthenticationModel.png" src="../_images/OAuth_TraditionalAuthenticationModel.png" style="width: 100%;" /></a>
</div>
<p>これに対し、OAuth 2.0ではHTTPサービスとの認証はユーザが直接行い、サードパーティ製アプリケーションには
「アクセストークン」と呼ばれる認証済みリクエストを行うための情報を払い出すことで、
サードパーティに認証情報を共有することなくリソースへアクセスすることが可能となる。</p>
<p>また、アクセストークン発行時にリソースに対するアクセス範囲（スコープ）を指定可能とすることで
従来のクライアントサーバ型の認証モデルと比較してより柔軟なアクセス制御を実現している。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_OAuthAuthenticationModel.png"><img alt="../_images/OAuth_OAuthAuthenticationModel.png" src="../_images/OAuth_OAuthAuthenticationModel.png" style="width: 100%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oautharchitecture">
<span id="id3"></span><h3><a class="toc-backref" href="#id134">9.9.1.2. OAuth 2.0のアーキテクチャ</a><a class="headerlink" href="#oautharchitecture" title="Permalink to this headline">¶</a></h3>
<p>ここではOAuth 2.0が定義するロール、スコープ、認可グラント、及びプロトコルフローについて説明する。
OAuth 2.0ではスコープや認可グラントという概念を定義しており、これらの概念を使用して認可の仕様を定めている。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="oauthrole">
<span id="id4"></span><h4><a class="toc-backref" href="#id135">9.9.1.2.1. ロール</a><a class="headerlink" href="#oauthrole" title="Permalink to this headline">¶</a></h4>
<p>OAuth 2.0ではロールとして以下の4つを定義している。</p>
<table border="1" class="colwidths-given longtable docutils" id="id100">
<caption><span class="caption-text"><strong>OAuth 2.0におけるロール</strong></span><a class="headerlink" href="#id100" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">ロール名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">リソースオーナ</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">保護されたリソースへのアクセスを許可するロール。人（エンドユーザ）など。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">リソースサーバ</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">保護されたリソースを提供するサーバ。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">認可サーバ</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナの認証と、アクセストークン（クライアントがリソースサーバにアクセスするときに必要な情報）の発行を行うサーバ。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">クライアント</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">リソースオーナの認可を得て、リソースオーナの代理として保護されたリソースに対してリクエストを行うロール。Webアプリケーションなど。クライアント情報は事前に認可サーバに登録され、認可サーバ内で一意な情報であるクライアントIDにより管理される。</div>
</div>
<div class="line-block">
<div class="line">OAuth 2.0ではクライアントクレデンシャル（クライアントの認証情報）の機密性を維持できる能力に基づき、クライアントタイプとして以下の2つを定義している。</div>
</div>
<div class="line-block">
<div class="line">(1) コンフィデンシャル</div>
<div class="line-block">
<div class="line">クライアントクレデンシャルの機密性を維持することができるクライアント。</div>
</div>
<div class="line">(2) パブリック</div>
<div class="line-block">
<div class="line">リソースオーナのデバイス上で実行されるクライアントのように、クライアントクレデンシャルの機密性を維持することができず、かつ他の手段を用いたセキュアなクライアント認証が行えないクライアント。</div>
<div class="line"><br /></div>
</div>
<div class="line">また、OAuth 2.0ではクライアントとして以下のような例を考慮して設計されている。</div>
<div class="line">(1) コンフィデンシャル</div>
</div>
<ul>
<li><div class="first line-block">
<div class="line">Webアプリケーション（Web application）</div>
<div class="line">アプリケーションサーバ上で実行されるクライアント。</div>
</div>
</li>
</ul>
<div class="line-block">
<div class="line">(2) パブリック</div>
</div>
<ul class="last">
<li><div class="first line-block">
<div class="line">ユーザエージェントベースアプリケーション（user-agent-based application）</div>
<div class="line">クライアントコードがアプリケーションサーバからダウンロードされリソースオーナのユーザエージェント（ブラウザなど）内で実行されるクライアント。</div>
<div class="line">JavaScriptアプリケーションなど。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">ネイティブアプリケーション（native application）</div>
<div class="line">リソースオーナのデバイス上にインストールされ実行されるクライアント。</div>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ユーザエージェントは、リソースオーナが使用するWebブラウザ等を指す。
本ガイドラインでは、エンドユーザの操作が発生する箇所を明確にするため、リソースオーナ（エンドユーザ）とユーザエージェントを別のものとして解説する。
ガイドラインでリソースオーナと明示している場合に、エンドユーザの操作が発生する。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthscope">
<span id="id5"></span><h4><a class="toc-backref" href="#id136">9.9.1.2.2. スコープ</a><a class="headerlink" href="#oauthscope" title="Permalink to this headline">¶</a></h4>
<p>OAuth 2.0では保護されたリソースに対するアクセスを制御する方法としてスコープという概念を使用している。</p>
<p>認可サーバはクライアントからの要求に対し、認可サーバのポリシーまたはリソースオーナの
指示に基づいてアクセストークンにスコープを含め、保護されたリソースに対する
アクセス権（読み込み権限、書き込み権限など）を指定することが出来る。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthprotocolflow">
<span id="id6"></span><h4><a class="toc-backref" href="#id137">9.9.1.2.3. プロトコルフロー</a><a class="headerlink" href="#oauthprotocolflow" title="Permalink to this headline">¶</a></h4>
<p>OAuth 2.0では、以下のような流れでリソースへのアクセスを行う。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ProtocolFlow.png"><img alt="../_images/OAuth_ProtocolFlow.png" src="../_images/OAuth_ProtocolFlow.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id101">
<caption><span class="caption-text"><strong>OAuth 2.0のプロトコルフロー</strong></span><a class="headerlink" href="#id101" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナに対して認可を要求する。上の図ではクライアントがリソースオーナに</div>
<div class="line">直接要求を行っているが、認可サーバを経由して行うほうが望ましい。</div>
<div class="line">後述するグラントタイプの中では認可コードグラントとインプリシットグラントが</div>
<div class="line">認可サーバを経由してリソースオーナに要求を行うフローになっている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントはリソースオーナからの認可を表すクレデンシャルとして認可グラント（後述）を受け取る。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントは、認可サーバに対して自身の認証情報とリソースオーナが与えた認可グラントを提示することで、アクセス</div>
<div class="line">トークンを要求する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバはクライアントを認証し、認可グラントの正当性を確認する。認可グラントが正当な場合、</div>
<div class="line">アクセストークンを発行する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントはリソースサーバの保護されたリソースへリクエストを行い、発行されたアクセス</div>
<div class="line">トークンにより認証する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースサーバはアクセストークンの正当性を確認し、正当な場合、リクエストを受け入れリソースを応答する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">OAuth 1.0で不評だった署名とトークン交換の複雑な仕組みを簡略化するために、OAuth 2.0ではアクセストークンを扱うリクエストはHTTPS通信で行うことを必須としている。
（HTTPS通信を使用することでアクセストークンの盗聴を防止する）</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="authorizationgrant">
<span id="id7"></span><h4><a class="toc-backref" href="#id138">9.9.1.2.4. 認可グラント</a><a class="headerlink" href="#authorizationgrant" title="Permalink to this headline">¶</a></h4>
<p>認可グラントは、リソースオーナからの認可を表し、クライアントがアクセストークンを取得する際に用いられる。
OAuth 2.0では、グラントタイプとして以下の4つを定義しているが、クレデンシャル項目を追加するなどの独自拡張を行うこともできる。</p>
<p>クライアントはいずれかのグラントタイプを利用して認可サーバへアクセストークンを要求し、取得したアクセストークンでリソースサーバにアクセスする。
認可サーバはサポートするグラントタイプを必ず1つ以上定義しており、その中から使用するグラントタイプをクライアントからの認可リクエストによって決定する。</p>
<table border="1" class="colwidths-given longtable docutils" id="oauthauthorizationgrant">
<caption><span class="caption-text"><strong>OAuth 2.0における認可グラント</strong></span><a class="headerlink" href="#oauthauthorizationgrant" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">グラントタイプ</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">認可コードグラント</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可コードグラントのフローでは、認可サーバがクライアントとリソースオーナの仲介となって認可コードをクライアントへ発行し、クライアントが認可コードを認可サーバに渡すことでアクセストークンを発行する。</div>
<div class="line">認可サーバが発行した認可コードを使用してアクセストークンを発行するため、クライアントへリソースオーナのクレデンシャルを共有する必要がない。</div>
<div class="line">認可コードグラントはWebアプリケーションのように、コンフィデンシャルなクライアントがOAuth 2.0を利用する際に使用する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">インプリシットグラント</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">インプリシットグラントのフローでは、認可コードグラントと同様に認可サーバが仲介するが、認可コードの代わりに直接アクセストークンを発行する。</div>
<div class="line">これにより応答性、効率性が高いため、スクリプト言語を使用してブラウザ上で実行されるクライアントに適している。</div>
<div class="line">しかし、アクセストークンがURL中にエンコードされるため、リソースオーナや同一デバイス上の他のアプリケーションに漏えいする可能性があるほか、
クライアントの認証を行わないことから、他のクライアントに対して発行されたアクセストークンを不正に用いた成りすまし攻撃のリスクがある。</div>
<div class="line">セキュリティ上のリスクがあるため、応答性、効率性が求められるパブリックなクライアントでのみ使用すること。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">リソースオーナパスワードクレデンシャルグラント</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナパスワードクレデンシャルグラントのフローでは、クライアントがリソースオーナの認証情報を認可グラントとして使用して、直接アクセストークンを発行する。</div>
<div class="line">クライアントへリソースオーナのクレデンシャルを共有する必要があるため、クライアントの信頼性が低い場合、クレデンシャルの不正利用や漏洩のリスクがある。</div>
<div class="line">リソースオーナパスワードクレデンシャルグラントはリソースオーナとクライアントの間で高い信頼があり、かつ他のグラントタイプが利用できない場合にのみ使用すること。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">クライアントクレデンシャルグラント</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントクレデンシャルグラントのフローでは、クライアントの認証情報を認可グラントとして使用して、直接アクセストークンを発行する。</div>
<div class="line">クライアントがリソースオーナであるような場合に使用する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><a class="reference internal" href="#oauthauthorizationgrant"><span class="std std-ref">OAuth 2.0における認可グラント</span></a>で解説した通り、認可コードグラント以外のグラントタイプには、セキュリティ上のリスクや、使用上の制約がある。そのため、認可コードグラントの利用を優先して検討されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="id8">
<h5><a class="toc-backref" href="#id139">9.9.1.2.4.1. 認可コードグラント</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h5>
<p>認可コードグラントのフローを以下に示す。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_AuthorizationCodeGrant.png"><img alt="../_images/OAuth_AuthorizationCodeGrant.png" src="../_images/OAuth_AuthorizationCodeGrant.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id102">
<caption><span class="caption-text"><strong>認可コードグラントフロー</strong></span><a class="headerlink" href="#id102" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナは、ユーザエージェント(Webブラウザなど)を介してクライアントが提供するリソースサーバの保護されたリソースにアクセスする。</div>
<div class="line">クライアントはリソースオーナから認可の取得を行うために、リソースオーナが操作するユーザエージェントを認可サーバの認可エンドポイントにリダイレクトさせる。</div>
<div class="line">このとき、クライアントは自身を識別するためのクライアントIDと、オプションとしてリソースに要求するスコープ、認可サーバが認可処理後にユーザエージェントを戻すリダイレクトURI、stateをリクエストパラメータに含める。</div>
<div class="line">stateはユーザエージェントに紐付くランダムな値であり、一連のフローが同じユーザエージェントで実行されたことを保証するために利用される(CSRF対策)。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザエージェントは、クライアントに指示された認可サーバの認可エンドポイントにアクセスする。</div>
<div class="line">認可サーバはユーザエージェント経由でリソースオーナを認証し、リクエストパラメータのクライアントID、スコープ、リダイレクトURIを元に、自身に登録済みのクライアント情報と比較しパラメータの正当性確認を行う。</div>
<div class="line">確認完了後、アクセス要求の許可/拒否をリソースオーナにたずねる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナはアクセス要求の許可/拒否を認可サーバに送信する。</div>
<div class="line">リソースオーナがアクセスを許可した場合、認可サーバは、リクエストパラメータに含まれるリダイレクトURIを用いて、
ユーザエージェントをクライアントにリダイレクトさせる指示を出す。</div>
<div class="line">その際、認可コードをリダイレクトURIのリクエストパラメータとして付与する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザエージェントは認可コードが付与されたリダイレクトURIにアクセスする。</div>
<div class="line">クライアントの処理が完了するとリソースオーナにレスポンスを返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントはアクセストークンを要求するために、認可コードを認可サーバのトークンエンドポイントに送信する。</div>
<div class="line">認可サーバのトークンエンドポイントはクライアントの認証と認可コードの正当性の検証を行い、正当である場合アクセストークンと任意でリフレッシュトークンを発行する。</div>
<div class="line">リフレッシュトークンはアクセストークンが無効化された、または期限切れの際に新しいアクセストークンを発行するために使用される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id9">
<h5><a class="toc-backref" href="#id140">9.9.1.2.4.2. インプリシットグラント</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h5>
<p>インプリシットグラントのフローを以下に示す。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ImplicitGrant.png"><img alt="../_images/OAuth_ImplicitGrant.png" src="../_images/OAuth_ImplicitGrant.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id103">
<caption><span class="caption-text"><strong>インプリシットグラントフロー</strong></span><a class="headerlink" href="#id103" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナは、ユーザエージェントを介してクライアントが提供するリソースサーバの保護されたリソースが必要なページにアクセスする。</div>
<div class="line">クライアントはリソースオーナから認可の取得とアクセストークンの発行を行うために、リソースオーナのユーザエージェントを認可サーバの認可エンドポイントにアクセスさせる。</div>
<div class="line">このとき、クライアントは自身を識別するためのクライアントIDと、オプションとしてリソースに要求するスコープ、認可サーバが認可処理後にユーザエージェントを戻すリダイレクトURI、stateをリクエストパラメータに含める。</div>
<div class="line">stateはユーザエージェントに紐付くランダムな値であり、一連のフローが同じユーザエージェントで実行されたことを保証するために利用される(CSRF対策)。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザエージェントは、クライアントに指示された認可サーバの認可エンドポイントにアクセスする。</div>
<div class="line">認可サーバはユーザエージェント経由でリソースオーナを認証し、リクエストパラメータのクライアントID、スコープ、リダイレクトURIを元に、自身に登録済みのクライアント情報と比較しパラメータの正当性確認を行う。</div>
<div class="line">確認完了後、アクセス要求の許可/拒否をリソースオーナにたずねる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナはアクセス要求の許可/拒否を認可サーバに送信する。</div>
<div class="line">リソースオーナがアクセスを許可した場合、認可サーバの認可エンドポイントはリクエストパラメータのリダイレクトURIを用いて
ユーザエージェントをクライアントリソースにリダイレクトさせる指示を出し、アクセストークンをリダイレクトURIのURLフラグメントに付与する。</div>
<div class="line">ここで「クライアントリソース」とは、クライアントアプリケーションとは別にWebサーバ等にホストしておいた静的リソースを指す。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザエージェントはリダイレクトの指示に従い、クライアントリソースにリクエストを送信する。
このとき、URLフラグメントの情報をローカルで保持し、リダイレクトの際にはURLフラグメントを送信しない。</div>
<div class="line">クライアントリソースにアクセスすると、Webページ（通常は埋め込みスクリプトを含むHTMLドキュメント）が返却される。</div>
<div class="line">ユーザエージェントはWebページに含まれるスクリプトを実行し、ローカルで保持していたURLフラグメントからアクセストークンを抽出する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザエージェントはアクセストークンをクライアントに渡す。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id10">
<h5><a class="toc-backref" href="#id141">9.9.1.2.4.3. リソースオーナパスワードクレデンシャルグラント</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h5>
<p>リソースオーナパスワードクレデンシャルグラントのフローを以下に示す。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ResourceOwnerPasswordCredentialsGrant.png"><img alt="../_images/OAuth_ResourceOwnerPasswordCredentialsGrant.png" src="../_images/OAuth_ResourceOwnerPasswordCredentialsGrant.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id104">
<caption><span class="caption-text"><strong>リソースオーナパスワードクレデンシャルグラントフロー</strong></span><a class="headerlink" href="#id104" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナがクライアントにクレデンシャル（ユーザ名、パスワード）を提供する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントはアクセストークンを要求するために、認可サーバのトークンエンドポイントにアクセスする。</div>
<div class="line">このとき、クライアントはリソースオーナから指定されたクレデンシャルとリソースに要求するスコープをリクエストパラメータに含める。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバのトークンエンドポイントはクライアントを認証し、リソースオーナのクレデンシャルを検証する。正当である場合アクセストークンを発行する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id11">
<h5><a class="toc-backref" href="#id142">9.9.1.2.4.4. クライアントクレデンシャルグラント</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h5>
<p>クライアントクレデンシャルグラントのフローを以下に示す。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ClientCredentialsGrant.png"><img alt="../_images/OAuth_ClientCredentialsGrant.png" src="../_images/OAuth_ClientCredentialsGrant.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id105">
<caption><span class="caption-text"><strong>クライアントクレデンシャルグラントフロー</strong></span><a class="headerlink" href="#id105" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントはアクセストークンを要求するために、認可サーバのトークンエンドポイントにアクセスする。</div>
<div class="line">このとき、クライアントはクライアント自身のクレデンシャルを含めてアクセストークンを要求する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバのトークンエンドポイントはクライアントを認証し、認証に成功した場合アクセストークンを発行する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="accesstokenlifecycle">
<span id="id12"></span><h4><a class="toc-backref" href="#id143">9.9.1.2.5. アクセストークンのライフサイクル</a><a class="headerlink" href="#accesstokenlifecycle" title="Permalink to this headline">¶</a></h4>
<p>アクセストークンはクライアントが提示する認可グラントの正当性を認可サーバが確認することで発行される。
発行されたアクセストークンは、認可サーバのポリシーまたはリソースオーナの指示に基づいたスコープが与えられ、保護されたリソースに対するアクセス権を保持する。
アクセストークンは発行時に有効期限が設定され、有効期限切れとなると保護されたリソースに対するアクセス権を失効される。</p>
<p>アクセストークンの発行から失効までの流れは以下のようになる。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_LifeCycleOfAccessToken.png"><img alt="../_images/OAuth_LifeCycleOfAccessToken.png" src="../_images/OAuth_LifeCycleOfAccessToken.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id106">
<caption><span class="caption-text"><strong>アクセストークンの発行から失効までのフロー</strong></span><a class="headerlink" href="#id106" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントが認可グラントを提示し、アクセストークンを要求する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバはクライアントが提示した認可グラントを確認し、アクセストークンを発行する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントはアクセストークンを提示し、リソースサーバの保護されたリソースを要求する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースサーバはクライアントが提示したアクセストークンの正当性を検証し、正当であればリソースサーバの保護されたリソースに対して処理を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントはアクセストークン（有効期限切れ）を提示し、リソースサーバの保護されたリソースを要求する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースサーバはクライアントが提示したアクセストークンの正当性を検証し、アクセストークンの有効期限が切れている場合はエラーを返却する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">アクセストークンが有効期限切れとなると保護されたリソースに対するアクセス権を失効されるが、アクセストークンが有効期限切れとなる前にアクセストークンを無効化し保護されたリソースに対するアクセス権を失効させることも可能である。</div>
<div class="line">アクセストークンが有効期限切れとなる前に無効化する場合、クライアントより認可サーバにトークンの取り消し依頼を行う。無効化されたアクセストークンは保護されたリソースに対するアクセス権を失効される。</div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">アクセストークンが有効期限切れとなった場合、クライアントがアクセストークンを再取得するためには認可サーバへ認可グラントの再提示を行い、認可サーバによる正当性の再確認が必要になる。
そのため、アクセストークンの有効期限を短く設定した場合はユーザビリティが下がってしまう。一方で、アクセストークンの有効期限を長く設定した場合はアクセストークンの漏洩、漏洩時に悪用されるリスクが高まってしまう。</div>
</div>
<div class="line-block">
<div class="line">ユーザビリティを下げずに漏洩、漏洩時のリスクを下げるためにはリフレッシュトークンが用いられる。
リフレッシュトークンはアクセストークンが無効化されたあるいは期限切れの際、認可グラントの再提示を行うことなく新しいアクセストークンを取得するために利用される。
リフレッシュトークンも発行時に有効期限が設定され、リフレッシュトークンが有効期限切れとなった場合はアクセストークンの再発行ができなくなる。</div>
<div class="line">アクセストークンの有効期限に短い期間を設定し、リフレッシュトークンの有効期限に長い期間を設定することで、短いサイクルでアクセストークンが再発行されユーザビリティを保ちつつアクセストークン漏洩及び漏洩時の悪用のリスクも抑えることができる。</div>
</div>
<div class="line-block">
<div class="line">リフレッシュトークンの発行はオプションであり、認可サーバの判断に委ねられる。</div>
</div>
<p>リフレッシュトークンによるアクセストークンの再発行の流れは以下のようになる。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_LifeCycleOfAccessTokenWithRefreshToken.png"><img alt="../_images/OAuth_LifeCycleOfAccessTokenWithRefreshToken.png" src="../_images/OAuth_LifeCycleOfAccessTokenWithRefreshToken.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id107">
<caption><span class="caption-text"><strong>アクセストークンの発行から再発行までのフロー</strong></span><a class="headerlink" href="#id107" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントが認可グラントを提示し、アクセストークンを要求する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバはクライアントが提示した認可グラントを確認し、アクセストークンとリフレッシュトークンを発行する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントはアクセストークンを提示し、リソースサーバの保護されたリソースを要求する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースサーバはクライアントが提示したアクセストークンの正当性を検証し、正当であればリソースサーバの保護されたリソースに対して処理を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントはアクセストークン（有効期限切れ）を提示し、リソースサーバの保護されたリソースを要求する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースサーバはクライアントが提示したアクセストークンの正当性を検証し、アクセストークンの有効期限が切れている場合はエラーを返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースサーバよりアクセストークンの有効期限切れエラーが返却された場合、
クライアントはリフレッシュトークン（有効期限切れ）を提示することで新しいアクセストークンを要求する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバはクライアントが提示したリフレッシュトークンの正当性を検証し、正当であればアクセストークンとオプションでリフレッシュトークンを発行する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>リフレッシュトークンの有効期限が期限切れとなった場合は認可サーバへ認可グラントの再提示を行う。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_LifeCycleOfRefreshToken.png"><img alt="../_images/OAuth_LifeCycleOfRefreshToken.png" src="../_images/OAuth_LifeCycleOfRefreshToken.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id108">
<caption><span class="caption-text"><strong>リフレッシュトークンの発行から再発行までのフロー</strong></span><a class="headerlink" href="#id108" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントが有効期限切れのアクセストークンを提示し、リソースサーバよりアクセストークンの有効期限切れエラーが返却された場合、</div>
<div class="line">クライアントはリフレッシュトークン（有効期限切れ）を提示することで新しいアクセストークンを要求する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバはクライアントが提示したリフレッシュトークンの正当性を検証し、リフレッシュトークンの有効期限が切れている場合はエラーを返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバよりリフレッシュトークンの有効期限切れエラーが返却された場合、クライアントは認可グラントを再提示し、アクセストークンを要求する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバはクライアントが提示した認可グラントを確認し、アクセストークンとリフレッシュトークンを発行する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="spring-security-oauth">
<span id="springsecurityoautharchitecture"></span><h3><a class="toc-backref" href="#id144">9.9.1.3. Spring Security OAuthのアーキテクチャ</a><a class="headerlink" href="#spring-security-oauth" title="Permalink to this headline">¶</a></h3>
<p>Spring Security OAuthは、OAuth 2.0で定義されているロールのうち、認可サーバ、リソースサーバ、クライアントの3つのロールをSpringアプリケーションとして構築する際に必要となる機能を提供するライブラリである。
Spring Security OAuthは、Spring Framework(Spring MVC)やSpring Securityが提供する機能と連携して動作する仕組みになっており、Spring Security OAuthが提供するデフォルト実装を適切にコンフィギュレーション（Bean定義）するだけで、認可サーバ、リソースサーバ、クライアントを構築することができる。
また、Spring FrameworkやSpring Securityと同様に数多くの拡張ポイントが用意されており、Spring Security OAuthが提供するデフォルト実装で実現できない要件を組み込むことができるようになっている。</p>
<p>なお、各ロール間のリクエストに対する認証・認可にはSpring Securityが提供する機能を利用するため、そちらの詳細は<a class="reference internal" href="Authentication.html"><span class="doc">認証</span></a>及び <a class="reference internal" href="Authorization.html"><span class="doc">認可</span></a>を参照されたい。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>一般的に、OAuth 2.0では全てのアプリケーションを1つのプロバイダが提供するのではなく、プロバイダが認可サーバ、リソースサーバを提供し、それらと連携するクライアントのみを実装するようなケースも多くある。そういった場合に連携するアプリケーションがSpring Security OAuthを使用して実装されているとは限らない。
実装方法の解説では、Spring Security OAuth以外のアーキテクチャで実装されたアプリケーションと連携する方法についても、適宜Note等で補足していく。</p>
<p class="last">連携するアプリケーションの仕様に応じて、適宜本ガイドラインで紹介していている実装方法をカスタマイズして利用されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Spring Security OAuthを使用して認可サーバ、リソースサーバ、クライアントを構築した場合、以下のような流れで処理が行われる。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_OAuth2Architecture.png"><img alt="../_images/OAuth_OAuth2Architecture.png" src="../_images/OAuth_OAuth2Architecture.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id109">
<caption><span class="caption-text"><strong>Spring Security OAuthのフロー</strong></span><a class="headerlink" href="#id109" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナはユーザエージェントを介してクライアントへアクセスする。</div>
<div class="line">クライアントはサービスより<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.client.OAuth2RestTemplate</span></code>の呼び出しを行う。</div>
<div class="line">認可エンドポイントにアクセスする認可グラントの場合、ユーザエージェントへ認可サーバの認可エンドポイントへリダイレクトさせるよう指示する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザエージェントは認可サーバの認可エンドポイント(<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.endpoint.AuthorizationEndpoint</span></code>)へアクセスする。</div>
<div class="line">認可エンドポイントはリソースオーナへ認可を問い合わせる画面を表示した後に、リソースオーナからの</div>
<div class="line">認可リクエストを受け取り認可コードまたはアクセストークンを発行する。</div>
<div class="line">発行した認可コードまたはアクセストークンは、リダイレクトを使用してユーザエージェント経由でクライアントに渡される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントは<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を使用して認可サーバのトークンエンドポイント(<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.endpoint.TokenEndpoint</span></code>)へアクセスする。</div>
<div class="line">トークンエンドポイントは<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.AuthorizationServerTokenServices</span></code>を呼び出し、クライアントが提示した認可グラントの検証及びアクセストークンの発行を行う。</div>
<div class="line">発行したアクセストークンはクライアントへの応答として渡される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントは <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を使用し、認可サーバから取得したアクセストークンをリクエストヘッダに設定してリソースサーバにアクセスする。</div>
<div class="line">リソースサーバは<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.authentication.OAuth2AuthenticationManager</span></code>を呼び出し、<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.ResourceServerTokenServices</span></code>を介してアクセストークンとアクセストークンに紐づく認証情報の検証を行う。</div>
<div class="line">アクセストークンの検証に成功した場合、クライアントからのリクエストに応じたリソースを返却する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>前述のとおり、OAuth 2.0では各エンドポイントにおいてHTTPS通信の使用を前提としているが、HTTPS通信を使用するのがSSLアクセラレータやWebサーバまでの場合や、
ロードバランサを使用して複数のアプリケーションサーバに分散させる場合がある。
リソースオーナによって認可された後にクライアントに認可コードまたは、アクセストークンを連携するためのリダイレクトURIを組み立てる際に、
SSLアクセラレータやWebサーバ、ロードバランサを指し示すリダイレクトURIを組み立てる必要がある。</p>
<p>Spring(Spring Security OAuth)では以下のいずれかのヘッダを使用してリダイレクト用のURLを組み立てる仕組みが提供されている。</p>
<ul class="simple">
<li>Forwardedヘッダ</li>
<li>X-Forwarded-Hostヘッダ、X-Forwarded-Portヘッダ、X-Forwarded-Protoヘッダ</li>
</ul>
<p class="last">SSLアクセラレータやWebサーバ、ロードバランサ側で上記ヘッダを付与するように設定し、Spring(Spring Security OAuth)が正しいリダイレクトURIを生成できるようにする必要がある。
これを行わない場合、認可コードグラントやインプリシットグラントにおいて行うリクエストパラメータ（リダイレクトURI）の検証に失敗する可能性がある。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Spring Security OAuthが提供するエンドポイントはSpring MVCの機能を拡張して実現している。Spring Security OAuthが提供するエンドポイントには<code class="docutils literal"><span class="pre">&#64;FrameworkEndpoint</span></code>アノテーションがクラスに設定されている。
これは<code class="docutils literal"><span class="pre">&#64;Controller</span></code>アノテーションで開発者がコンポーネントとして登録したクラスと競合させないためである。
また、<code class="docutils literal"><span class="pre">&#64;FrameworkEndpoint</span></code>アノテーションでコンポーネントとして登録されたエンドポイントは、<code class="docutils literal"><span class="pre">RequestMappingHandlerMapping</span></code>の拡張クラスである<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.endpoint.FrameworkEndpointHandlerMapping</span></code>がエンドポイントの<code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>アノテーションを読み取り、URLと合致する<code class="docutils literal"><span class="pre">&#64;FrameworkEndpoint</span></code>のメソッドを、ハンドラメソッドとして扱っている。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="authorizationserver">
<span id="id13"></span><h4><a class="toc-backref" href="#id145">9.9.1.3.1. 認可サーバ</a><a class="headerlink" href="#authorizationserver" title="Permalink to this headline">¶</a></h4>
<p>認可サーバでは、リソースオーナの認証、リソースオーナからの認可の取得、およびアクセストークンの発行を行う機能を提供する。
一部のグラントタイプでは、アクセストークンを発行するためにリソースオーナに認可を問い合わせる必要があるため、
リソースオーナの認証と、リソースオーナからの認可の取得を行う機能についても提供している。</p>
<p>認可サーバはクライアント情報（どのクライアントに、どのリソースに対するどのスコープの認可を与えるかの情報）
に基づいて、リソースにどのスコープでのアクセスを認可するかや、アクセストークンを発行してよいかの検証を行う。</p>
<p>なお、クライアント情報は事前に認可サーバに登録しておく必要があるが、
OAuth 2.0の仕様では認可サーバを利用するクライアント情報の登録手順について定められておらず、
Spring Security OAuthにおいてもクライアント情報の登録手続きの機能は提供されていない。
そのため、アプリケーションでクライアント情報を登録するためのインターフェイスを提供したい場合には、独自に実装する必要がある。</p>
<div class="section" id="id14">
<h5><a class="toc-backref" href="#id146">9.9.1.3.1.1. クライアントの認証</a><a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h5>
<p>後述する各エンドポイントでは、認可サーバが管理するクライアント情報に基づき、リクエストに含まれるクライアントの認証を行う機能を提供している。</p>
</div>
<div class="section" id="id15">
<h5><a class="toc-backref" href="#id147">9.9.1.3.1.2. リソースオーナの認証</a><a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h5>
<p>後述するリソースオーナからの認可の取得を行う場合、認可サーバはリソースオーナの認証も行う必要がある。この機能はSpring Securityが提供している認証機能を使用して実現する。</p>
<p>詳細については <a class="reference internal" href="Authentication.html#springsecurityauthentication"><span class="std std-ref">認証</span></a>を参照のこと。</p>
</div>
<div class="section" id="id16">
<h5><a class="toc-backref" href="#id148">9.9.1.3.1.3. リソースオーナからの認可の取得</a><a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h5>
<p>Spring Security OAuthは、認可エンドポイント（<code class="docutils literal"><span class="pre">AuthorizationEndpoint</span></code>）をSpring MVCの機能を利用して提供している。</p>
<p>クライアントは認可リクエスト送信時に利用したいスコープを指定し、リソースオーナが指定されたスコープを認可するか、
認可サーバに事前に登録されている、クライアントに割り当てられたスコープと一致する場合に、認可サーバでクライアントに対してそのスコープを認可する。
クライアントに対して認可を行う際には <a class="reference internal" href="Authorization.html#springsecurityauthorization"><span class="std std-ref">認可</span></a>の節で説明しているSpring Securityのロールによる認可も併用することができる。</p>
<p>以下に認可エンドポイントアクセス時のフローを示す。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_AutohrizationServerAuthArchitecture.png"><img alt="../_images/OAuth_AutohrizationServerAuthArchitecture.png" src="../_images/OAuth_AutohrizationServerAuthArchitecture.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id110">
<caption><span class="caption-text"><strong>認可サーバの動き（認可エンドポイントアクセス時）</strong></span><a class="headerlink" href="#id110" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントからの指示により、ユーザエージェントが認可サーバの認可エンドポイント(<code class="docutils literal"><span class="pre">/oauth/authorize</span></code>)に
アクセスすることで認可サーバの処理が実行される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセス先のURL(<code class="docutils literal"><span class="pre">/oauth/authorize</span></code>)を処理する<code class="docutils literal"><span class="pre">AuthorizationEndpoint</span></code>では、
<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.ClientDetailsService</span></code>のメソッドを呼び出し、事前に登録されているクライアント情報を取得後、リクエストパラメータを検証する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.approval.UserApprovalHandler</span></code>のメソッドを呼び出し、クライアントへスコープに対する認可が登録されているかチェックする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可が未登録である場合、<code class="docutils literal"><span class="pre">UserApprovalHandler</span></code>よりリソースオーナに認可を問い合わせる画面(認可画面)の要素を取得し、
認可画面を表示させるURL(<code class="docutils literal"><span class="pre">/oauth/confirm_access</span></code>)へフォワードさせる。</div>
<div class="line">このとき、問い合わせの対象となるスコープはリクエストパラメータと事前に登録されているクライント情報の積をとり、
Spring MVCの<code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>を利用して連携される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フォワード先のURL(<code class="docutils literal"><span class="pre">/oauth/confirm_access</span></code>)を処理するコントローラでは、
ユーザエージェント経由でリソースオーナに認可画面を表示させる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナの画面操作により認可が行われた場合、再度認可エンドポイント(<code class="docutils literal"><span class="pre">/oauth/authorize</span></code>)にアクセスが行われる。</div>
<div class="line">このとき、リクエストパラメータとして<code class="docutils literal"><span class="pre">user_oauth_approval</span></code>が付与される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthorizationEndpoint</span></code>では<code class="docutils literal"><span class="pre">user_oauth_approval</span></code>パラメータを付与しアクセスされた場合、<code class="docutils literal"><span class="pre">UserApprovalHandler</span></code>の
メソッドを呼び出し認可情報を登録する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UserApprovalHandler</span></code>の実装である<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.approval.ApprovalStoreUserApprovalHandler</span></code>では<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.approval.ApprovalStore</span></code>により認可の状態を管理する。</div>
<div class="line">リソースオーナにより認可が行われた場合、<code class="docutils literal"><span class="pre">ApprovalStore</span></code>のメソッドを呼び出し、指定された情報を登録する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">問い合わせの対象となるスコープは前述のとおり、認可サーバに事前に登録されているスコープと、クライアントが認可リクエスト時にリクエストパラメータで指定したスコープの積となる。
例として、認可サーバでREADとCREATEとDELETEのスコープが割り当てられているクライアントに対して、READとCREATEのスコープをリクエストパラメータで指定した場合は(READ,CREATE,DELETE)と(READ,CREATE)の積である、スコープREAD,CREATEが割り当てられる。
認可サーバでクライアントに割り当てられていないスコープをリクエストパラメータで指定した場合はエラーとなり、アクセスが拒否される。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="definitionofbadclienterror">
<span id="id17"></span><h6><a class="toc-backref" href="#id149">9.9.1.3.1.3.1. 不正クライアントエラー</a><a class="headerlink" href="#definitionofbadclienterror" title="Permalink to this headline">¶</a></h6>
<p>RFC 6749の<a class="reference external" href="https://tools.ietf.org/html/rfc6749#section-4.1.2.1">4.1.2.1. Error Response</a>にあるとおり、
リクエストパラメータの検証でリダイレクトURIもしくはクライアントIDの正当性が確認できない場合、不正なクライアントであるとみなす。
この場合、ユーザエージェントを不正なクライアントへリダイレクトさせず、ユーザエージェントを認可サーバが提供するエラー画面へと遷移させることで、リソースオーナに不正なクライアントであることを通知する。
本ガイドラインでは、上記エラーを<strong>不正クライアントエラー</strong>と呼ぶこととする。</p>
<p>認可エンドポイントで不正クライアントエラーが発生した場合、クライアントにエラー通知を行わず認可サーバのエラー画面へ遷移する。
認可エンドポイントで不正クライアントエラー以外のエラーが発生した場合、認可サーバからクライアントへのリダイレクトによりエラー通知が行われる。
認可エンドポイントでエラーが発生した場合のフローを以下に示す。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_AuthorizationEndpointErrorHandling.png"><img alt="../_images/OAuth_AuthorizationEndpointErrorHandling.png" src="../_images/OAuth_AuthorizationEndpointErrorHandling.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id111">
<caption><span class="caption-text"><strong>認可サーバの動き（不正クライアントエラーのエラーハンドリング）</strong></span><a class="headerlink" href="#id111" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">A-1</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">不正クライアントエラーが発生した場合、エラー画面を表示させるURL(<code class="docutils literal"><span class="pre">/oauth/error</span></code>)へフォワードさせる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">A-2</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フォワード先のURL(<code class="docutils literal"><span class="pre">/oauth/error</span></code>)を処理するコントローラでは、 ユーザエージェント経由でリソースオーナにエラー画面を表示させる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id112">
<caption><span class="caption-text"><strong>認可サーバの動き（不正クライアントエラー以外のエラーハンドリング）</strong></span><a class="headerlink" href="#id112" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">B-1</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">不正クライアントエラー以外のエラーが発生した場合、認可サーバからクライアントへのリダイレクトによりエラー通知が行われる。</div>
<div class="line">リダイレクトURIにリクエストパラメータとしてエラー情報が付与される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">B-2</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を経由して<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.client.token.AccessTokenProviderChain</span></code>にエラー情報が渡される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">B-3</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">渡されたエラー情報を例外に復元して、例外としてスローする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="issueofaccesstoken">
<span id="id18"></span><h5><a class="toc-backref" href="#id150">9.9.1.3.1.4. アクセストークンの発行</a><a class="headerlink" href="#issueofaccesstoken" title="Permalink to this headline">¶</a></h5>
<p>Spring Security OAuthは、トークンエンドポイント（<code class="docutils literal"><span class="pre">TokenEndpoint</span></code>）をSpring MVCの機能を利用して提供している。</p>
<p>トークンエンドポイントはアクセストークンの発行を<code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code>のデフォルト実装である<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.DefaultTokenServices</span></code>によって行っている。
アクセストークンの発行の際には、<code class="docutils literal"><span class="pre">ClientDetailsService</span></code>を介して認可サーバに登録済みのクライアント情報を取得し、アクセストークン発行の可否の検証に使用している。</p>
<p>以下にトークンエンドポイントアクセス時のフローを示す。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_AutohrizationServerTokenArchitecture.png"><img alt="../_images/OAuth_AutohrizationServerTokenArchitecture.png" src="../_images/OAuth_AutohrizationServerTokenArchitecture.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id113">
<caption><span class="caption-text"><strong>認可サーバの動き（トークンエンドポイントアクセス時）</strong></span><a class="headerlink" href="#id113" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントが認可サーバのトークンエンドポイント(<code class="docutils literal"><span class="pre">/oauth/token</span></code>)にアクセスすることでトークンエンドポイントの処理が実行される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ClientDetailsService</span></code>のメソッドを呼び出し、事前に登録されているクライアント情報を取得後、リクエストパラメータのスコープがクライアントに登録済みのものかチェックする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">スコープが登録済みのものであった場合、<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.TokenGranter</span></code>のメソッドを呼び出し、アクセストークンを発行する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">TokenGranter</span></code>の実装である<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.AbstractTokenGranter</span></code>では<code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code>のアクセストークンを発行するメソッドを呼び出す。</div>
<div class="line"><code class="docutils literal"><span class="pre">AbstractTokenGranter</span></code>はグラントタイプ別に実装されている<code class="docutils literal"><span class="pre">TokenGranter</span></code>の基底クラスであり、実際の処理は各クラスに委譲される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code>の実装である<code class="docutils literal"><span class="pre">DefaultTokenServices</span></code>で<code class="docutils literal"><span class="pre">ClientDetailsService</span></code>のメソッドを呼び出し、発行するアクセストークンに設定する有効期限、リフレッシュトークン発行の有無、有効な場合は有効期限を取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DefaultTokenServices</span></code>で<code class="docutils literal"><span class="pre">ClientDetailsService</span></code>から取得した情報を基にアクセストークンを発行する。</div>
<div class="line">発行したアクセストークンは、アクセストークンを管理する<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.TokenStore</span></code>のメソッドにて登録される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="resourceserver">
<span id="id19"></span><h4><a class="toc-backref" href="#id151">9.9.1.3.2. リソースサーバ</a><a class="headerlink" href="#resourceserver" title="Permalink to this headline">¶</a></h4>
<p>リソースサーバでは、アクセストークン自体の妥当性とアクセストークンが保持するスコープ内のリソースへのアクセスであることを検証する機能を提供する。</p>
<p>Spring Security OAuthでは、アクセストークンの検証機能を、Spring Securityの認証・認可の枠組みを利用して実現している。
具体的には、Authentication FilterにSpring Security OAuthが提供する<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.authentication.OAuth2AuthenticationProcessingFilter</span></code>を、
認証処理に<code class="docutils literal"><span class="pre">AuthenticationManager</span></code>の実装クラスである<code class="docutils literal"><span class="pre">OAuth2AuthenticationManager</span></code>を、
認証エラーの応答に<code class="docutils literal"><span class="pre">AuthenticationEntryPoint</span></code>の実装クラスである<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.error.OAuth2AuthenticationEntryPoint</span></code>をそれぞれ使用している。</p>
<p>Spring Securityの詳細については <a class="reference internal" href="Authentication.html#springsecurityauthentication"><span class="std std-ref">認証</span></a>を参照のこと。</p>
<p>以下にリソースサーバの構成を示す</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ResourceServerArchitecture.png"><img alt="../_images/OAuth_ResourceServerArchitecture.png" src="../_images/OAuth_ResourceServerArchitecture.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id114">
<caption><span class="caption-text"><strong>リソースサーバの動き</strong></span><a class="headerlink" href="#id114" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">初めにクライアントがリソースサーバにアクセスすると<code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code>の呼び出しが行われる。</div>
<div class="line"><code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code>ではリクエストよりアクセストークンを抽出する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークンを抽出後、<code class="docutils literal"><span class="pre">AuthenticationManager</span></code>の実装である<code class="docutils literal"><span class="pre">OAuth2AuthenticationManager</span></code>において<code class="docutils literal"><span class="pre">ResourceServerTokenServices</span></code>の
メソッドを呼び出しアクセストークンに紐づく認証情報を取得する。また、認証情報の取得時にアクセストークンを検証する。</div>
<div class="line">アクセストークンに紐づく認証情報の取得方法は、認可サーバに対してHTTPによる問い合わせを行うほか、認可サーバと<code class="docutils literal"><span class="pre">TokenStore</span></code>を共用して取得を行うなどの方法がある。</div>
<div class="line">どのようにして認証情報の取得を行うかについては<code class="docutils literal"><span class="pre">ResourceServerTokenServices</span></code>の実装クラスに依存する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2’)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code>にて認証エラーが発生した場合、<code class="docutils literal"><span class="pre">AuthenticationEntryPoint</span></code>の実装である<code class="docutils literal"><span class="pre">OAuth2AuthenticationEntryPoint</span></code>に処理を委譲し、エラー応答を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code>の処理が完了した場合、次のSecurity Filter(<code class="docutils literal"><span class="pre">ExceptionTranslationFilter</span></code>)の呼び出しが行われる。</div>
<div class="line"><code class="docutils literal"><span class="pre">ExceptionTranslationFilter</span></code>の詳細については <a class="reference internal" href="Authorization.html#authorizationerrorresponse"><span class="std std-ref">認可エラー時のレスポンス</span></a>を参照のこと。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3’)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ExceptionTranslationFilter</span></code>にて例外をキャッチした場合、<code class="docutils literal"><span class="pre">AccessDeniedHandler</span></code>の実装である、<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.error.OAuth2AccessDeniedHandler</span></code>に処理を委譲し、エラー応答を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエストの認証・認可の検証に成功した場合、クライアントからのリクエストに応じたリソースを返却する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="client">
<span id="id20"></span><h4><a class="toc-backref" href="#id152">9.9.1.3.3. クライアント</a><a class="headerlink" href="#client" title="Permalink to this headline">¶</a></h4>
<p>クライアントでは、リソースオーナからの認可を取得するために認可サーバへ誘導（リダイレクト）する機能と、アクセストークンを取得してリソースサーバへアクセスする機能を提供する。</p>
<p>Spring Security OAuthは、アクセストークンを取得してリソースサーバへアクセスするために利用する<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>や<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.client.filter.OAuth2ClientContextFilter</span></code>を提供している。</p>
<p><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>は<code class="docutils literal"><span class="pre">RestTemplate</span></code>を拡張しOAuth 2.0向けの機能を追加したクラスで、リフレッシュトークンを使用してアクセストークンを再取得する仕組みや、アクセストークンを取得する際にリソースオーナから認可が必要な場合に例外（<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.client.resource.UserRedirectRequiredException</span></code>）をスローする仕組みを備えている。
なお、<code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>をサーブレットフィルタに登録することで、<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>で発生した<code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code>をハンドリングして認可サーバへ誘導（リダイレクト）することが可能となる。</p>
<p>また、<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>では<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.client.resource.OAuth2ProtectedResourceDetails</span></code>にて指定されたグラントタイプに沿って認可サーバより取得したアクセストークンを<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.client.OAuth2ClientContext</span></code>の実装である<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.client.DefaultOAuth2ClientContext</span></code>に保持する。
<code class="docutils literal"><span class="pre">DefaultOAuth2ClientContext</span></code>はデフォルトではセッションスコープのBeanとして定義され、複数のリクエスト間でアクセストークンを共有をすることが可能となる。</p>
<p>以下に、クライアント機能として<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を使用した場合の構成を示す。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ClientArchitecture.png"><img alt="../_images/OAuth_ClientArchitecture.png" src="../_images/OAuth_ClientArchitecture.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id115">
<caption><span class="caption-text"><strong>クライアントの動き</strong></span><a class="headerlink" href="#id115" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザエージェントがクライアントの<code class="docutils literal"><span class="pre">Service</span></code>の呼び出しが行われるよう<code class="docutils literal"><span class="pre">Controller</span></code>へアクセスする。</div>
<div class="line">リソースサーバへのアクセスを伴うアクセスに対しては、(5)で発生する可能性がある<code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code>を捕捉するためのサーブレットフィルタ（<code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>）を適用する。</div>
<div class="line">このサーブレットフィルタを適用することで、<code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code>が発生した際に、ユーザエージェントを認可サーバの認可エンドポイントへアクセスさせることができる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Service</span></code>より<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>の呼び出しを行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2ClientContext</span></code>に保持しているアクセストークンを取得する。</div>
<div class="line">有効なアクセストークンを取得できた場合は、(6)の処理に移る。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">初回アクセス時などでアクセストークンを保持していなかった場合、または有効期限が超過していた場合、<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.client.token.AccessTokenProvider</span></code>を呼び出しアクセストークンの取得を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AccessTokenProvider</span></code>では、リソースの詳細情報として<code class="docutils literal"><span class="pre">OAuth2ProtectedResourceDetails</span></code>に定義しているグラントタイプに応じてアクセストークンの取得を行う。</div>
<div class="line">認可コードグラント向けの実装である<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.client.token.grant.code.AuthorizationCodeAccessTokenProvider</span></code>では、認可コードの取得が完了していない場合、<code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code>をスローする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(3)または(5)で取得したアクセストークンを指定して、リソースサーバへのアクセスを行う。</div>
<div class="line">アクセス時にアクセストークンの有効期限切れ（<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.client.http.AccessTokenRequiredException</span></code>）などの例外が発生した場合、保持しているアクセストークンを初期化した後、再度(4)以降の処理を行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">インプリシットグラントは一般的にJavaScriptなどで実装されたクライアントで採用されるため、本ガイドラインでもJavaScriptを用いて実装を行う方法を紹介する。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-use">
<span id="howtouse"></span><h2><a class="toc-backref" href="#id153">9.9.2. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<p>Spring Security OAuthを使用するために必要となるBean定義例や実装方法について説明する。</p>
<div class="section" id="oauthhowtouseconfiguration">
<span id="id21"></span><h3><a class="toc-backref" href="#id154">9.9.2.1. How to Useの構成</a><a class="headerlink" href="#oauthhowtouseconfiguration" title="Permalink to this headline">¶</a></h3>
<p>「<a class="reference internal" href="#authorizationgrant"><span class="std std-ref">認可グラント</span></a>」で示したとおり、OAuth 2.0ではグラントタイプにより認可サーバ、クライアント間のフローが異なる。
そのため、アプリケーションがサポートするグラントタイプに沿った実装を行う必要がある。</p>
<p>本ガイドラインでは、グラントタイプごとに認可サーバ、リソースサーバ、クライアントの実装方法の解説を行う。</p>
<ul class="simple">
<li><dl class="first docutils">
<dt><em>利用するグラントタイプに応じた読み進め方</em></dt>
<dd>グラントタイプごとの実装方法については、まずは認可コードグラントで一通りの実装方法を解説し、その他のグラントタイプでは認可コードグラントからの変更点を解説する形式としている。
<strong>どのグラントタイプを利用する場合も、必ず認可コードグラントでの解説を一読した上で、利用するグラントタイプの解説を読み進められたい。</strong></dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><em>作成するアプリケーションに応じた読み進め方</em></dt>
<dd>認可サーバ、リソースサーバとクライアントの実装は独立しており、すべてのアプリケーションの実装方法を理解する必要はない。
<strong>いずれかのみ実装したい場合は、実装したいアプリケーションの解説のみ読み進められたい。</strong></dd>
</dl>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthsetup">
<span id="id22"></span><h3><a class="toc-backref" href="#id155">9.9.2.2. Spring Security OAuthのセットアップ</a><a class="headerlink" href="#oauthsetup" title="Permalink to this headline">¶</a></h3>
<p>Spring Security OAuthが提供している機能を使用するために、Spring Security OAuthを依存ライブラリとして追加する。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.security.oauth<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-security-oauth2<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring Security OAuthを使用するプロジェクトの <code class="file docutils literal"><span class="pre">pom.xml</span></code> に、Spring Security OAuthを依存ライブラリとして追加する。</div>
<div class="line">リソースサーバ、認可サーバ、クライアントを別プロジェクトとして作成する場合、それぞれについて記述を追加すること。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">上記設定例は、依存ライブラリのバージョンを親プロジェクトである terasoluna-gfw-parent で管理する前提であるため、pom.xmlでのバージョンの指定は不要である。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Spring Security OAuthにおけるオープンリダイレクト脆弱性</strong></p>
<p>Spring Security OAuth 2.3.4, 2.2.3, 2.1.3, 2.0.16以前では、
<a class="reference external" href="https://pivotal.io/security/cve-2019-3778">CVE-2019-3778</a>で報告されているオープンリダイレクト脆弱性が存在した。</p>
<p>具体的には、認可コードグラントを利用した認可サーバにおいて、オープンリダイレクト脆弱性により認可コードが漏洩する危険性があった。</p>
<p class="last">2.3.5, 2.2.4, 2.1.4, 2.0.17で修正されており、脆弱性の影響を受けない。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Spring Security 5よりOAuth2がサポートされ、Spring Security OAuthは非推奨となっている。
Spring Security OAuth 2.4.0より全てのクラスに <code class="docutils literal"><span class="pre">&#64;Deprecated</span></code> が付与されており、本ガイドラインに沿って実装を行なうと大量の警告が出力される点に留意されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="implementationautorizationcodegrant">
<span id="id23"></span><h3><a class="toc-backref" href="#id156">9.9.2.3. 認可コードグラントの実装</a><a class="headerlink" href="#implementationautorizationcodegrant" title="Permalink to this headline">¶</a></h3>
<p>認可コードグラントを利用した認可サーバ、リソースサーバ、クライアントの実装方法について説明する。</p>
<div class="section" id="implementationoauthauthorizationserverofautorizationcode">
<span id="id24"></span><h4><a class="toc-backref" href="#id157">9.9.2.3.1. 認可サーバの実装</a><a class="headerlink" href="#implementationoauthauthorizationserverofautorizationcode" title="Permalink to this headline">¶</a></h4>
<p>認可サーバの実装方法について説明する。</p>
<p>認可サーバでは、「リソースオーナからの認可の取得」「アクセストークンの発行」を行うためのエンドポイントをSpring Security OAuthの機能を使用して提供する。
なお、上記のエンドポイントにアクセスする場合はリソースオーナまたはクライアントの認証が必要であり、本ガイドラインではSpring Securityの認証・認可の仕組みを使用して実現する。</p>
<div class="section" id="oauthauthorizationservercreatesettingfile">
<span id="id25"></span><h5><a class="toc-backref" href="#id158">9.9.2.3.1.1. 設定ファイルの作成（認可サーバ）</a><a class="headerlink" href="#oauthauthorizationservercreatesettingfile" title="Permalink to this headline">¶</a></h5>
<div class="line-block">
<div class="line">認可サーバに関する定義を行うための設定ファイルとして  <code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>を作成する。</div>
<div class="line"><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>では、認可サーバの機能を提供するためのエンドポイントのBean定義およびそれらのエンドポイントに対するセキュリティ設定、認可サーバのサポートするグラントタイプの設定を行う。</div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
       <span class="na">xmlns:oauth2=</span><span class="s">&quot;http://www.springframework.org/schema/security/oauth2&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/security</span>
<span class="s">           https://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">           http://www.springframework.org/schema/security/oauth2</span>
<span class="s">           https://www.springframework.org/schema/security/spring-security-oauth2.xsd</span>
<span class="s">           http://www.springframework.org/schema/beans</span>
<span class="s">           https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>


<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<p>次に、作成した<code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>を読み込むように<code class="docutils literal"><span class="pre">web.xml</span></code>に設定を記述する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">web.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;context-param&gt;</span>
    <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
    <span class="nt">&lt;param-value&gt;</span>
        classpath*:META-INF/spring/applicationContext.xml
        classpath*:META-INF/spring/oauth2-auth.xml  <span class="c">&lt;!-- (1) --&gt;</span>
        classpath*:META-INF/spring/spring-security.xml
    <span class="nt">&lt;/param-value&gt;</span>
<span class="nt">&lt;/context-param&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OAuth 2.0用のBean定義ファイルの指定を行う。<code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>で設定したアクセス制御の対象のURLが<code class="docutils literal"><span class="pre">spring-security.xml</span></code>で設定したアクセス制御の対象のURLに含まれる場合を考慮し、<code class="docutils literal"><span class="pre">spring-security.xml</span></code>より先に記述すること。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthauthorizationserverdefinition">
<span id="id26"></span><h5><a class="toc-backref" href="#id159">9.9.2.3.1.2. 認可サーバの定義</a><a class="headerlink" href="#oauthauthorizationserverdefinition" title="Permalink to this headline">¶</a></h5>
<p>次に、認可サーバの定義を追加する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;oauth2:authorization-code</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;oauth2:authorization-server&gt;</span></code>タグを使用し、認可サーバの定義を行う。</div>
<div class="line"><code class="docutils literal"><span class="pre">&lt;oauth2:authorization-server&gt;</span></code>タグを使用することで、認可を行うための認可エンドポイントと、
アクセストークンを発行するためのトークンエンドポイントがコンポーネントとして登録される。</div>
<div class="line"><br /></div>
<div class="line">各コンポーネントにアクセスするため、以下のパスが設定される。</div>
</div>
<ul class="last simple">
<li>認可エンドポイント(<code class="docutils literal"><span class="pre">/oauth/authorize</span></code>)</li>
<li>トークンエンドポイント(<code class="docutils literal"><span class="pre">/oauth/token</span></code>)</li>
<li>リソースオーナから認可を取得する際のフォワード先(<code class="docutils literal"><span class="pre">/oauth/confirm_access</span></code>)</li>
<li>認可エンドポイントで不正クライアントエラーが発生した場合のフォワード先(<code class="docutils literal"><span class="pre">/oauth/error</span></code>)</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;oauth2:authorization-code</span> <span class="pre">/&gt;</span></code>タグを使用して、認可コードグラントをサポートする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;oauth2:refresh-token</span> <span class="pre">/&gt;</span></code>タグを使用して、リフレッシュトークンをサポートする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><code class="docutils literal"><span class="pre">&lt;oauth2:authorization-code</span> <span class="pre">/&gt;</span></code>タグと<code class="docutils literal"><span class="pre">&lt;oauth2:refresh-token</span> <span class="pre">/&gt;</span></code>タグは上記の順番で設定する必要がある。</p>
<p class="last">詳細は<a class="reference internal" href="#orderofauthoraizationserversupportsetting"><span class="std std-ref">認可サーバで複数のグラントタイプをサポートする場合</span></a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><code class="docutils literal"><span class="pre">&lt;oauth2:authorization-server&gt;</span></code>タグを使用することで登録されるエンドポイント、およびフォワード先のパスは
それぞれカスタマイズすることが可能である。</p>
<p class="last">詳細は<a class="reference internal" href="#customizeendpoint"><span class="std std-ref">エンドポイントのカスタマイズ</span></a>、<a class="reference internal" href="#customizeforward"><span class="std std-ref">フォワード先のカスタマイズ</span></a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">上記の設定ファイルは<code class="docutils literal"><span class="pre">client-details-service-ref</span></code>パラメータの設定を行っていないため、IDEによっては文法誤りによるエラーが検知されることがある。
後述する設定を追加することでエラーは解消される。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>認可コードは、認可コードが発行されてからアクセストークンの発行までの短い期間しか使われないため、デフォルトではインメモリで管理される。
認可サーバが複数台構成の場合は、複数サーバ間で認可コードを共有するためにDBで管理する必要がある。
認可コードをDBで管理する場合は、主キーとなる認可コードを保持するカラムと、認証情報を保持するカラムによって構成された以下のようなテーブルを作成する。以下の例はPostgreSQLを使用した場合のDB定義である。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ERDiagramCode.png"><img alt="../_images/OAuth_ERDiagramCode.png" src="../_images/OAuth_ERDiagramCode.png" style="width: 30%;" /></a>
</div>
<p>認可サーバの設定ファイルには、<code class="docutils literal"><span class="pre">&lt;oauth2:authorization-code</span> <span class="pre">/&gt;</span></code>タグの<code class="docutils literal"><span class="pre">authorization-code-services-ref</span></code>に、認可コードをDB管理する<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.code.JdbcAuthorizationCodeServices</span></code>のBean名を指定する。
<code class="docutils literal"><span class="pre">JdbcAuthorizationCodeServices</span></code>のコンストラクタには、認可コード格納用のテーブルに接続するためのデータソースを指定する。
認可コードをDBにて永続管理する場合の注意点については<a class="reference internal" href="#oauthauthorizationserverhowtocontrolltarnsaction"><span class="std std-ref">トランザクション制御</span></a>を <strong>必ず</strong> 参照のこと。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server&gt;</span>
    <span class="nt">&lt;oauth2:authorization-code</span> <span class="na">authorization-code-services-ref=</span><span class="s">&quot;authorizationCodeServices&quot;</span><span class="nt">/&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;authorizationCodeServices&quot;</span>
      <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.code.JdbcAuthorizationCodeServices&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>Java SE 11環境を利用する場合</strong></p>
<p class="last">Spring Security OAuthの認可エンドポイントはXML電文に対応するため、JAXBに依存したコンポーネントを登録している。
このため、JAXBがクラスパスにない場合、<code class="docutils literal"><span class="pre">OAuth2AuthenticationEntryPoint</span></code>のBean生成で例外となりアプリケーションの起動ができなくなることに注意されたい。
Java SE 11でJAXBを利用するには<a class="reference internal" href="../Appendix/Java11Changes.html#remove-jaxb-from-java11"><span class="std std-ref">JAXBの削除</span></a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthauthorizationserverclientauthentication">
<span id="id27"></span><h5><a class="toc-backref" href="#id160">9.9.2.3.1.3. クライアントの認証</a><a class="headerlink" href="#oauthauthorizationserverclientauthentication" title="Permalink to this headline">¶</a></h5>
<p>エンドポイントに対してアクセスしてきたクライアントについては、登録済みのクライアントか確認するために認証を行う必要がある。
クライアントの認証は、クライアントよりパラメータで渡されたクライアントIDとパスワードを、認可サーバで保持しているクライアント情報をもとに検証することで行う。認証にはBasic認証を用いて行う。</p>
<p>Spring Security OAuthではクライアント情報を取得するためのインタフェースである<code class="docutils literal"><span class="pre">ClientDetailsService</span></code>の実装クラスを提供している。
また、クライアント情報を保持するためのクラスとして<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.ClientDetails</span></code>インタフェースの実装クラスである<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.client.BaseClientDetails</span></code>クラスを提供している。
<code class="docutils literal"><span class="pre">BaseClientDetails</span></code>ではクライアントIDやサポートするグラントタイプなどのOAuth 2.0を利用する上での基本的なパラメータを提供しており、<code class="docutils literal"><span class="pre">BaseClientDetails</span></code>を拡張することで独自のパラメータを追加することも可能である。
ここでは<code class="docutils literal"><span class="pre">BaseClientDetails</span></code>の拡張と<code class="docutils literal"><span class="pre">ClientDetailsService</span></code>の実装クラス作成を行い、独自パラメータとして クライアント名 を追加したクライアント情報をDBを用いて管理、および認証を行う場合の実装方法について説明する。</p>
<p>まず、以下のようなDBを作成する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ERDiagram.png"><img alt="../_images/OAuth_ERDiagram.png" src="../_images/OAuth_ERDiagram.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">クライアント情報を保持するテーブル。client_idを主キーとする。</div>
<div class="line">各カラムの役割は以下のとおりである。</div>
</div>
<ul class="last simple">
<li>client_id：クライアントを識別するIDであるクライアントIDを保持するカラム。</li>
<li>client_secret：クライアントの認証に使用するパスワードを保持するカラム。</li>
<li>client_name：クライアント名を保持する独自カラム。独自カラムであるため必須ではない。</li>
<li>access_token_validity：アクセストークンの有効期間[秒]を保持するカラム。</li>
<li>refresh_token_validity：リフレッシュトークンの有効期間[秒]を保持するカラム。</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">スコープ情報を保持するテーブル。client_idを外部キーとし、クライアント情報と対応付けする。</div>
<div class="line">scopeカラムに、クライアント認可に使用するスコープを保持する。クライアントがもつスコープの数だけレコードを登録する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソース情報を保持するテーブル。client_idを外部キーとし、クライアント情報と対応付けする。</div>
<div class="line">resource_idカラムに、クライアントのアクセス可能なリソースかどうかを、リソースサーバが識別するために使用するリソースIDを保持する。</div>
<div class="line">リソースサーバが保持するリソースに対して定義しているリソースIDがここで登録されているリソースIDに含まれる場合のみ、リソースへのアクセスを許可される。</div>
<div class="line">クライアントがアクセス可能なリソースIDの数だけレコードを登録する。</div>
<div class="line">リソースIDを一件も登録しなかった場合は、全てのリソースに対してアクセス可能となるため、登録しない場合は注意が必要である。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">グラント情報を保持するテーブル。client_idを外部キーとし、クライアント情報と対応付けする。</div>
<div class="line">authorized_grant_typeカラムに、クライアントの使用するグラントを保持する。</div>
<div class="line">クライアントが利用するグラントの数だけレコードを登録する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">リダイレクトURI情報を保持するテーブル。client_idを外部キーとし、クライアント情報と対応付けする。</div>
<div class="line">web_server_redirect_uriカラムに、リソースオーナによる認可後にユーザエージェントをリダイレクトさせるURIを保持する。</div>
<div class="line">保持するリダイレクトURIは、クライアントが認可リクエスト時に申告するリダイレクトURIのホワイトリストチェックで使用される。</div>
<div class="line">クライアントが申告する可能性のあるURIの数だけレコードを登録する。</div>
</div>
<div class="last admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Spring Security OAuth 2.2.2 より、リダイレクトURIのホワイトリストチェックの仕様が変更された。Spring Security OAuth 2.2.1以前では、認可サーバに登録されたリダイレクトURIのパス配下であることを確認していたが、2.2.2ではパスと完全一致することを確認するようになった。これにより、認可サーバにリダイレクトするすべてのパスを指定しなければならなくなったことに注意されたい。</p>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>クライアント情報を保持するモデルを作成する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">Client.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="p">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">clientId</span><span class="p">;</span> <span class="c1">// (1)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">clientSecret</span><span class="p">;</span> <span class="c1">// (2)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">clientName</span><span class="p">;</span> <span class="c1">// (3)</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">accessTokenValidity</span><span class="p">;</span> <span class="c1">// (4)</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">refreshTokenValidity</span><span class="p">;</span> <span class="c1">// (5)</span>
    <span class="c1">// Getters and Setters are omitted</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントを識別するクライアントIDを保持するフィールド。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントの認証に使用するパスワードを保持するフィールド。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring Security OAuthでは提供されていない、クライアント名を保持する拡張フィールド。</div>
<div class="line">拡張フィールドであるため必須ではない。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークンの有効期間[秒]を保持するフィールド。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リフレッシュトークンの有効期間[秒]を保持するフィールド。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">クライアント情報を操作するためのRepositoryクラスを作成する必要があるが、ここでは説明を割愛する。
具体的な実装方法については<a class="reference internal" href="../ImplementationAtEachLayer/DomainLayer.html#repository-label"><span class="std std-ref">Repositoryの実装</span></a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p><code class="docutils literal"><span class="pre">BaseClientDetails</span></code>クラスを継承させたクラスを作成することで、クライアントの詳細情報を簡単に拡張することができる。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">OAuthClientDetails.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuthClientDetails</span> <span class="kd">extends</span> <span class="n">BaseClientDetails</span><span class="p">{</span>
    <span class="kd">private</span> <span class="n">Client</span> <span class="n">client</span><span class="p">;</span>
    <span class="c1">// Getter and Setter are omitted</span>
<span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.ClientDetailsService</span></code>は、認可処理で必要となるクライアント詳細情報をデータストアから取得するためのインタフェースである。
以下では、<code class="docutils literal"><span class="pre">ClientDetailsService</span></code>の実装クラスの作成について説明する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">OAuthClientDetailsService.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Service</span><span class="p">(</span><span class="s">&quot;clientDetailsService&quot;</span><span class="p">)</span> <span class="c1">// (1)</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuthClientDetailsService</span> <span class="kd">implements</span> <span class="n">ClientDetailsService</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ClientRepository</span> <span class="n">clientRepository</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">ClientDetails</span> <span class="nf">loadClientByClientId</span><span class="p">(</span><span class="n">String</span> <span class="n">clientId</span><span class="p">)</span>
            <span class="kd">throws</span> <span class="n">ClientRegistrationException</span> <span class="p">{</span>

        <span class="n">Client</span> <span class="n">client</span> <span class="o">=</span> <span class="n">clientRepository</span><span class="p">.</span><span class="na">findClientByClientId</span><span class="p">(</span><span class="n">clientId</span><span class="p">);</span> <span class="c1">// (2)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">client</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (3)</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="n">NoSuchClientException</span><span class="p">(</span><span class="s">&quot;No client with requested id: &quot;</span> <span class="o">+</span> <span class="n">clientId</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// (4)</span>
        <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">clientScopes</span> <span class="o">=</span> <span class="n">clientRepository</span><span class="p">.</span><span class="na">findClientScopesByClientId</span><span class="p">(</span><span class="n">clientId</span><span class="p">);</span>
        <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">clientResources</span> <span class="o">=</span> <span class="n">clientRepository</span><span class="p">.</span><span class="na">findClientResourcesByClientId</span><span class="p">(</span><span class="n">clientId</span><span class="p">);</span>
        <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">clientGrants</span> <span class="o">=</span> <span class="n">clientRepository</span><span class="p">.</span><span class="na">findClientGrantsByClientId</span><span class="p">(</span><span class="n">clientId</span><span class="p">);</span>
        <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">clientRedirectUris</span> <span class="o">=</span> <span class="n">clientRepository</span><span class="p">.</span><span class="na">findClientRedirectUrisByClientId</span><span class="p">(</span><span class="n">clientId</span><span class="p">);</span>

        <span class="c1">// (5)</span>
        <span class="n">OAuthClientDetails</span> <span class="n">clientDetails</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OAuthClientDetails</span><span class="p">();</span>
        <span class="n">clientDetails</span><span class="p">.</span><span class="na">setClientId</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="na">getClientId</span><span class="p">());</span>
        <span class="n">clientDetails</span><span class="p">.</span><span class="na">setClientSecret</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="na">getClientSecret</span><span class="p">());</span>
        <span class="n">clientDetails</span><span class="p">.</span><span class="na">setAccessTokenValiditySeconds</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="na">getAccessTokenValidity</span><span class="p">());</span>
        <span class="n">clientDetails</span><span class="p">.</span><span class="na">setRefreshTokenValiditySeconds</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="na">getRefreshTokenValidity</span><span class="p">());</span>
        <span class="n">clientDetails</span><span class="p">.</span><span class="na">setResourceIds</span><span class="p">(</span><span class="n">clientResources</span><span class="p">);</span>
        <span class="n">clientDetails</span><span class="p">.</span><span class="na">setScope</span><span class="p">(</span><span class="n">clientScopes</span><span class="p">);</span>
        <span class="n">clientDetails</span><span class="p">.</span><span class="na">setAuthorizedGrantTypes</span><span class="p">(</span><span class="n">clientGrants</span><span class="p">);</span>
        <span class="n">clientDetails</span><span class="p">.</span><span class="na">setRegisteredRedirectUri</span><span class="p">(</span><span class="n">clientRedirectUris</span><span class="p">);</span>
        <span class="n">clientDetails</span><span class="p">.</span><span class="na">setClient</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">clientDetails</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Serviceとしてcomponent-scanの対象とするため、クラスレベルに<code class="docutils literal"><span class="pre">&#64;Service</span></code>アノテーションをつける。</div>
<div class="line">Bean名を<code class="docutils literal"><span class="pre">clientDetailsService</span></code>として指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">DBからクライアント情報を取得する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアント情報が見つからない場合は、Spring Security OAuthの例外である<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.NoSuchClientException</span></code>を発生させる。</div>
<div class="line">なお、認可エンドポイントでもクライアント情報の取得のため本処理が呼び出されるが、<code class="docutils literal"><span class="pre">NoSuchClientException</span></code>が発生した場合は認可エンドポイントによってハンドリングされ、</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.common.exceptions.OAuth2Exception</span></code>のサブクラスである<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.common.exceptions.BadClientCredentialsException</span></code>がスローされる。</div>
<div class="line">認可エンドポイントで<code class="docutils literal"><span class="pre">OAuth2Exception</span></code>が発生した場合のハンドリング方法については<a class="reference internal" href="#oauthauthorizationserverhowtohandleerror"><span class="std std-ref">認可リクエスト時のエラー画面のカスタマイズ</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントに紐付く情報を取得する。</div>
<div class="line">複数回にわけてRepositoryの呼び出しを行うことにより処理性能が落ちるような場合は(2)で一括取得する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得した各種情報を<code class="docutils literal"><span class="pre">OAuthClientDetails</span></code>のフィールドに設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>にクライアント認証に必要な設定を追記する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
     <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;oauth2:authorization-code</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>

<span class="nt">&lt;sec:http</span> <span class="na">pattern=</span><span class="s">&quot;/oauth/*token*/**&quot;</span>
    <span class="na">authentication-manager-ref=</span><span class="s">&quot;clientAuthenticationManager&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;sec:http-basic</span> <span class="na">entry-point-ref=</span><span class="s">&quot;oauthAuthenticationEntryPoint&quot;</span> <span class="nt">/&gt;</span>           <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;sec:csrf</span> <span class="na">disabled=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (4) --&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/**&quot;</span> <span class="na">access=</span><span class="s">&quot;isAuthenticated()&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (5) --&gt;</span>
    <span class="nt">&lt;sec:access-denied-handler</span> <span class="na">ref=</span><span class="s">&quot;oauth2AccessDeniedHandler&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (6) --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>

<span class="nt">&lt;sec:authentication-manager</span> <span class="na">id=</span><span class="s">&quot;clientAuthenticationManager&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (7) --&gt;</span>
    <span class="nt">&lt;sec:authentication-provider</span> <span class="na">user-service-ref=</span><span class="s">&quot;clientDetailsUserService&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (8) --&gt;</span>
<span class="nt">&lt;/sec:authentication-manager&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;oauthAuthenticationEntryPoint&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.error.OAuth2AuthenticationEntryPoint&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;typeName&quot;</span> <span class="na">value=</span><span class="s">&quot;Basic&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (9) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;realmName&quot;</span> <span class="na">value=</span><span class="s">&quot;Realm&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (10) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;oauth2AccessDeniedHandler&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.error.OAuth2AccessDeniedHandler&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (11) --&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;clientDetailsUserService&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.client.ClientDetailsUserDetailsService&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (12) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;clientDetailsService&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (13) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">client-details-service-ref</span></code>属性に<code class="docutils literal"><span class="pre">OAuthClientDetailsService</span></code>のBeanを指定する。</div>
<div class="line">指定するBean名は、<code class="docutils literal"><span class="pre">ClientDetailsService</span></code>の実装クラスで指定したBean名と合わせる必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">アクセストークン操作に関するエンドポイントへのセキュリティ設定を行うために、エンドポイントとして
<code class="docutils literal"><span class="pre">/oauth/*token*/</span></code>配下をアクセス制御の対象として指定する。
Spring Security OAuthにより定義されているエンドポイント、およびそのデフォルト値は以下のとおりである。</div>
</div>
<ul class="simple">
<li>トークン払い出しに使用するトークンエンドポイント(<code class="docutils literal"><span class="pre">/oauth/token</span></code>)</li>
<li>トークンを検証するチェックトークンエンドポイント(<code class="docutils literal"><span class="pre">/oauth/check_token</span></code>)</li>
<li>JWTの署名を公開鍵暗号方式で作成した場合に、公開鍵を取得するために使用するエンドポイント(<code class="docutils literal"><span class="pre">/oauth/token_key</span></code>)</li>
</ul>
<div class="last line-block">
<div class="line"><code class="docutils literal"><span class="pre">authentication-manager-ref</span></code>属性に(7)で定義しているクライアント認証用の<code class="docutils literal"><span class="pre">AuthenticationManager</span></code>のBeanを指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアント認証にBasic認証を適用する。</div>
<div class="line">詳細については<a class="reference external" href="https://docs.spring.io/spring-security/site/docs/5.4.2/reference/html5/#servlet-authentication-basic">Spring Security Reference -Basic Authentication-</a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">/oauth/*token*/**</span></code>へのアクセスに対してCSRF対策機能を無効化する。</div>
<div class="line">Spring Security OAuthでは、OAuth 2.0のCSRF対策として推奨されている、stateパラメータを使用したリクエストの正当性確認を採用している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エンドポイント配下に対して、認証済みユーザのみがアクセスできる権限を付与する設定。</div>
<div class="line">Webリソースに対してアクセスポリシーの指定方法については、<a class="reference internal" href="Authorization.html"><span class="doc">認可</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">access-denied-handler</span></code>には<code class="docutils literal"><span class="pre">OAuth2AccessDeniedHandler</span></code>のBeanを設定する。ここでは(12)で定義している<code class="docutils literal"><span class="pre">oauth2AccessDeniedHandler</span></code>のBeanを指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントを認証するための<code class="docutils literal"><span class="pre">AuthenticationManager</span></code>をBean定義する。</div>
<div class="line">リソースオーナの認証で使用する<code class="docutils literal"><span class="pre">AuthenticationManager</span></code>と別名のBean名を指定する必要がある。</div>
<div class="line">ここでは、<code class="docutils literal"><span class="pre">sec:authentication-manager</span></code>を複数定義する必要があるため、それぞれにid属性を用いてBean名を付与する。</div>
<div class="line">一つのコンテキストに<code class="docutils literal"><span class="pre">sec:authentication-manager</span></code>が一つしかない場合は、alias属性を用いてBean名を付与しても良い。</div>
<div class="line">リソースオーナの認証については<a class="reference internal" href="#oauthauthorizationserverresourceownerauthentication"><span class="std std-ref">リソースオーナの認証</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">sec:authentication-provider</span></code>の<code class="docutils literal"><span class="pre">user-service-ref</span></code>属性に(12)で定義している<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.client.ClientDetailsUserDetailsService</span></code>のBeanを指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントの認証に失敗した場合に、レスポンスヘッダでクライアントに提示するクライアント認証の認証スキームを指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントの認証に失敗した場合に、レスポンスヘッダでクライアントに提示するクライアント認証のレルムを指定する。</div>
<div class="line">クライアント認証のレルムをカスタマイズしたい場合に設定する。</div>
<div class="line">指定しない場合はデフォルト値である<code class="docutils literal"><span class="pre">oauth</span></code>が設定される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring Security OAuthが提供するOAuth 2.0用の<code class="docutils literal"><span class="pre">AccessDeniedHandler</span></code>を定義する。</div>
<div class="line"><code class="docutils literal"><span class="pre">OAuth2AccessDeniedHandler</span></code>は、認可エラー時に発生する例外をハンドリングしてエラー応答を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UserDetailsService</span></code>インタフェースの実装クラスである<code class="docutils literal"><span class="pre">ClientDetailsUserDetailsService</span></code>をBean定義する。</div>
<div class="line">リソースオーナの認証で使用する<code class="docutils literal"><span class="pre">UserDetailsService</span></code>と別名のBean名を指定する必要がある。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(13)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">コンストラクタの引数に、DBからクライアント情報を取得する<code class="docutils literal"><span class="pre">OAuthClientDetailsService</span></code>のBeanを指定する。</div>
<div class="line">指定するBean名は、<code class="docutils literal"><span class="pre">ClientDetailsService</span></code>の実装クラスで指定したBean名と合わせる必要がある。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthauthorizationserverresourceownerauthentication">
<span id="id28"></span><h5><a class="toc-backref" href="#id161">9.9.2.3.1.4. リソースオーナの認証</a><a class="headerlink" href="#oauthauthorizationserverresourceownerauthentication" title="Permalink to this headline">¶</a></h5>
<p>アクセストークンの取得に認可コードグラントを用いる場合、ログイン画面を用意する等、なんらかの方法でリソースオーナを認証する必要がある。</p>
<div class="line-block">
<div class="line">本ガイドラインでは、リソースオーナの認証にSpring Securityを利用する前提とする。</div>
<div class="line">認可の設定には、認証済みユーザのみ認可エンドポイントURLへアクセスできるよう、認可エンドポイントURLを含んだURLをアクセスポリシーとして定義する必要がある。
また、リソースオーナから認可を取得する際のフォワード先と、認可エンドポイントで不正クライアントエラーが発生した場合のフォワード先も同様にアクセスポリシーとして定義する必要がある。</div>
<div class="line">リソースオーナから認可を取得する際のフォワードをハンドリングするコントローラについては <a class="reference internal" href="#oauthauthorizationserverhowtocustomizeauthorizeview"><span class="std std-ref">スコープ認可画面のカスタマイズ</span></a>を、
認可エンドポイントでの不正クライアントエラーをハンドリングするコントローラについては <a class="reference internal" href="#oauthauthorizationserverhowtohandleerror"><span class="std std-ref">認可リクエスト時のエラー画面のカスタマイズ</span></a>を参照されたい。</div>
</div>
<p>Spring Securityの詳細については <a class="reference internal" href="Authentication.html"><span class="doc">認証</span></a>及び <a class="reference internal" href="Authorization.html"><span class="doc">認可</span></a>を参照されたい。</p>
<p>以下に認可エンドポイント、リソースオーナから認可を取得する際のフォワード先、認可エンドポイントで例外が発生した場合のフォワード先を含んだアクセスポリシーの定義例を示す。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">spring-security.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span> <span class="na">authentication-manager-ref=</span><span class="s">&quot;authenticationManager&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;sec:form-login</span> <span class="na">login-page=</span><span class="s">&quot;/login&quot;</span>
        <span class="na">authentication-failure-url=</span><span class="s">&quot;/login?error=true&quot;</span>
        <span class="na">login-processing-url=</span><span class="s">&quot;/login&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:logout</span> <span class="na">logout-url=</span><span class="s">&quot;/logout&quot;</span>
        <span class="na">logout-success-url=</span><span class="s">&quot;/&quot;</span>
        <span class="na">delete-cookies=</span><span class="s">&quot;JSESSIONID&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:access-denied-handler</span> <span class="na">ref=</span><span class="s">&quot;accessDeniedHandler&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:custom-filter</span> <span class="na">ref=</span><span class="s">&quot;userIdMDCPutFilter&quot;</span> <span class="na">after=</span><span class="s">&quot;ANONYMOUS_FILTER&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:session-management</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/login/**&quot;</span> <span class="na">access=</span><span class="s">&quot;permitAll&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/oauth/**&quot;</span> <span class="na">access=</span><span class="s">&quot;isAuthenticated()&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>

 <span class="nt">&lt;sec:authentication-manager</span> <span class="na">id=</span><span class="s">&quot;authenticationManager&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;sec:authentication-provider</span>
        <span class="na">user-service-ref=</span><span class="s">&quot;userDetailsService&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;sec:password-encoder</span> <span class="na">ref=</span><span class="s">&quot;passwordEncoder&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/sec:authentication-provider&gt;</span>
<span class="nt">&lt;/sec:authentication-manager&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;userDetailsService&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.core.userdetails.jdbc.JdbcDaoImpl&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバにフォーム認証を適用し、<code class="docutils literal"><span class="pre">authentication-manager-ref</span></code>属性に(3)で定義している<code class="docutils literal"><span class="pre">authenticationManager</span></code>を指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>でも<code class="docutils literal"><span class="pre">AuthenticationManager</span></code>を定義しているため、別名のBean名を指定する必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">以下を含んだパス(<code class="docutils literal"><span class="pre">/oauth/</span></code>)配下を認証済みユーザのみがアクセスできるよう指定する。</div>
</div>
<ul class="last simple">
<li>認可エンドポイント(<code class="docutils literal"><span class="pre">/oauth/authorize</span></code>)</li>
<li>リソースオーナから認可を取得する際のフォワード先(<code class="docutils literal"><span class="pre">/oauth/confirm_access</span></code>)</li>
<li>認可エンドポイントで不正クライアントエラーが発生した場合のフォワード先(<code class="docutils literal"><span class="pre">/oauth/error</span></code>)</li>
</ul>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナを認証するための<code class="docutils literal"><span class="pre">authenticationManager</span></code>をBean定義する。</div>
<div class="line">ここでは、<code class="docutils literal"><span class="pre">sec:authentication-manager</span></code>を複数定義する必要があるため、それぞれにid属性を用いてBean名を付与する。</div>
<div class="line">一つのコンテキストに<code class="docutils literal"><span class="pre">sec:authentication-manager</span></code>が一つしかない場合は、alias属性を用いてBean名を付与しても良い。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="oauthauthorizationserverhowtoauthorizebyscope">
<span id="id29"></span><h5><a class="toc-backref" href="#id162">9.9.2.3.1.5. スコープごとの認可</a><a class="headerlink" href="#oauthauthorizationserverhowtoauthorizebyscope" title="Permalink to this headline">¶</a></h5>
<p>リソースオーナからの認可の取得時に、要求されたスコープを一括で認可するのではなく、各スコープを個別に認可する場合の設定方法を説明する。</p>
<p>認可サーバを再起動した際に認可情報を失わないよう永続管理するために、また複数台の認可サーバで認可情報を共有するためには、認可情報をDBで管理する必要がある。
スコープごとに認可情報を格納するためのDBとして、以下のDBを作成する。以下の例ではPostgreSQLを使用した場合のDB定義を説明する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ERDiagramApprovals.png"><img alt="../_images/OAuth_ERDiagramApprovals.png" src="../_images/OAuth_ERDiagramApprovals.png" style="width: 50%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">認可情報を保持するテーブル。userId、clientId、scopeを主キーとする。</div>
<div class="line">各カラムの役割は以下のとおりである。</div>
</div>
<ul class="last simple">
<li>userId：認可を行ったリソースオーナのユーザ名を保持するカラム。</li>
<li>clientId：リソースオーナによって認可されたクライアントのクライアントIDを保持するカラム。</li>
<li>scope：リソースオーナに認可されたスコープを保持するカラム。</li>
<li>status：リソースオーナに認可されたかどうかを保持するカラム。認可された場合は<code class="docutils literal"><span class="pre">APPROVED</span></code>、拒否された場合は<code class="docutils literal"><span class="pre">DENIED</span></code>が設定される。</li>
<li>expiresAt：認可情報の有効期限を保持するカラム。</li>
<li>lastModifiedAt：認可情報が最後に更新された日時を保持するカラム。</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>リソースオーナからスコープ毎の認可を取得し、DBに保存して管理するための設定を行う。</p>
<p>実装例は以下のとおりである。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
     <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span>
     <span class="na">user-approval-handler-ref=</span><span class="s">&quot;userApprovalHandler&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

     <span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;/oauth2:authorization-server&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;userApprovalHandler&quot;</span>
      <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.approval.ApprovalStoreUserApprovalHandler&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;clientDetailsService&quot;</span> <span class="na">ref=</span><span class="s">&quot;clientDetailsService&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;approvalStore&quot;</span> <span class="na">ref=</span><span class="s">&quot;approvalStore&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;requestFactory&quot;</span> <span class="na">ref=</span><span class="s">&quot;requestFactory&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;approvalExpiryInSeconds&quot;</span> <span class="na">value=</span><span class="s">&quot;3200&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;approvalStore&quot;</span>
      <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.approval.JdbcApprovalStore&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;requestFactory&quot;</span>
      <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.request.DefaultOAuth2RequestFactory&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;clientDetailsService&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">スコープの認可処理を行う<code class="docutils literal"><span class="pre">UserApprovalHandler</span></code>として、<code class="docutils literal"><span class="pre">user-approval-handler-ref</span></code>に(2)で定義している<code class="docutils literal"><span class="pre">ApprovalStoreUserApprovalHandler</span></code>のBeanを指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">スコープの認可処理を行う<code class="docutils literal"><span class="pre">ApprovalStoreUserApprovalHandler</span></code>をBean定義する。</div>
<div class="line">リソースオーナの認可結果を管理する<code class="docutils literal"><span class="pre">approvalStore</span></code>プロパティには、(3)で定義している<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.approval.JdbcApprovalStore</span></code>のBeanを指定する。</div>
<div class="line">スコープの認可処理に使用するクライアント情報の取得をする<code class="docutils literal"><span class="pre">clientDetailsService</span></code>プロパティには、<code class="docutils literal"><span class="pre">OAuthClientDetailsService</span></code>のBeanを指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">requestFactory</span></code>プロパティには、<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.request.DefaultOAuth2RequestFactory</span></code>のBeanを指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">requestFactory</span></code>プロパティに設定したBeanは<code class="docutils literal"><span class="pre">ApprovalStoreUserApprovalHandler</span></code>によって使用されないが、設定を行っていない場合は<code class="docutils literal"><span class="pre">ApprovalStoreUserApprovalHandler</span></code>のBean生成時にエラーとなるため、<code class="docutils literal"><span class="pre">requestFactory</span></code>プロパティへの設定が必要である。</div>
<div class="line">認可情報の有効期間[秒]を指定する場合は、<code class="docutils literal"><span class="pre">approvalExpiryInSeconds</span></code>プロパティに、有効期間[秒]を設定する。設定を行わない場合は、認可情報は認可から一ヶ月間有効となる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">認可情報をDBで管理する<code class="docutils literal"><span class="pre">JdbcApprovalStore</span></code>をBean定義する。</div>
<div class="line">コンストラクタには、認可情報格納用のテーブルに接続するためのデータソースを指定する。</div>
<div class="line">データソースの設定方法については、<a class="reference internal" href="../ArchitectureInDetail/DataAccessDetail/DataAccessCommon.html#data-access-common-howtouse-datasource"><span class="std std-ref">データソースの設定</span></a>を参照されたい。</div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">認可情報をDBにて永続管理する場合の注意点については<a class="reference internal" href="#oauthauthorizationserverhowtocontrolltarnsaction"><span class="std std-ref">トランザクション制御</span></a>を <strong>必ず</strong> 参照のこと。</p>
</div>
<div class="last admonition note">
<p class="first admonition-title">Note</p>
<p class="last">認可情報を永続管理する必要がなく、DBではなくインメモリで管理したい場合は、<code class="docutils literal"><span class="pre">approvalStore</span></code>として<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.approval.InMemoryApprovalStore</span></code>をBean定義すればよい。</p>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="oauthauthorizationserverhowtocustomizeauthorizeview">
<span id="id30"></span><h5><a class="toc-backref" href="#id163">9.9.2.3.1.6. スコープ認可画面のカスタマイズ</a><a class="headerlink" href="#oauthauthorizationserverhowtocustomizeauthorizeview" title="Permalink to this headline">¶</a></h5>
<p>スコープ認可画面をカスタマイズしたい場合、コントローラとJSPを作成することでカスタマイズできる。以下ではスコープ認可画面のカスタマイズした場合の例を説明する。</p>
<p>リソースオーナからの認可を取得するためにエンドポイントの呼び出しを行う場合、<code class="docutils literal"><span class="pre">/oauth/confirm_access</span></code>にフォワードされる。
<code class="docutils literal"><span class="pre">/oauth/confirm_access</span></code>をハンドリングするコントローラを作成する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">OAuth2ApprovalController.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2ApprovalController</span> <span class="p">{</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;/oauth/confirm_access&quot;</span><span class="p">)</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">confirmAccess</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// omitted</span>
        <span class="k">return</span> <span class="s">&quot;approval/oauthConfirm&quot;</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>アノテーションを使用して、<code class="docutils literal"><span class="pre">/oauth/confirm_access</span></code>へのアクセスに対するメソッドとしてマッピングを行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>次に、スコープ認可画面のJSPを作成する。
認可対象のスコープは<code class="docutils literal"><span class="pre">scopes</span></code>キーとして、リクエストパラメータは<code class="docutils literal"><span class="pre">authorizationRequest</span></code>としてModelに登録されているため、これを利用してスコープ認可画面を表示する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauthConfirm.jsp</span></code></li>
</ul>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="k">&lt;%@</span> <span class="n">taglib</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;sec&quot;</span> <span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://www.springframework.org/security/tags&quot;</span> <span class="k">%&gt;</span>

<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>OAuth Approval<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;p&gt;</span>Do you authorize ${f:h(authorizationRequest.clientId)} to access your protected resources?<span class="nt">&lt;/p&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">&quot;confirmationForm&quot;</span> <span class="na">name=</span><span class="s">&quot;confirmationForm&quot;</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/oauth/authorize&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;c:forEach</span> <span class="na">var=</span><span class="s">&quot;scope&quot;</span> <span class="na">items=</span><span class="s">&quot;${scopes}&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
                <span class="nt">&lt;li&gt;</span>
                    ${f:h(scope.key)}
                    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;radio&quot;</span> <span class="na">name=</span><span class="s">&quot;${f:h(scope.key)}&quot;</span> <span class="na">id=</span><span class="s">&quot;${f:h(scope.key)}_approve&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;${f:h(scope.key)}_approve&quot;</span><span class="nt">&gt;</span>Approve<span class="nt">&lt;/label&gt;</span>
                    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;radio&quot;</span> <span class="na">name=</span><span class="s">&quot;${f:h(scope.key)}&quot;</span> <span class="na">id=</span><span class="s">&quot;${f:h(scope.key)}_deny&quot;</span> <span class="na">value=</span><span class="s">&quot;false&quot;</span><span class="nt">/&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;${f:h(scope.key)}_deny&quot;</span><span class="nt">&gt;</span>Deny<span class="nt">&lt;/label&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;/c:forEach&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name=</span><span class="s">&quot;user_oauth_approval&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
            <span class="nt">&lt;sec:csrfInput</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (4) --&gt;</span>
            <span class="nt">&lt;label&gt;</span>
                <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">id=</span><span class="s">&quot;authorize&quot;</span> <span class="na">value=</span><span class="s">&quot;Authorize&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;/form&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントIDを画面に表示させる。</div>
<div class="line"><code class="docutils literal"><span class="pre">authorizationRequest</span></code>の型は<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.AuthorizationRequest</span></code>であり、クライアントIDは<code class="docutils literal"><span class="pre">authorizationRequest.clientId</span></code>と指定することで出力される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">スコープ毎に認可可否を指定するためのラジオボタンを出力する。対象のスコープは<code class="docutils literal"><span class="pre">scopes</span></code>に含まれるため、<code class="docutils literal"><span class="pre">items</span></code>に<code class="docutils literal"><span class="pre">scopes</span></code>を指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">scopes</span></code>の型は<code class="docutils literal"><span class="pre">LinkedHashMap</span></code>であり、スコープ名をキーとして 、そのスコープに対する認可可否の情報を保持している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">user_oauth_approval</span></code>をhidden項目として埋め込むことで、Spring Security OAuthがリクエストパラメータに<code class="docutils literal"><span class="pre">user_oauth_approval</span></code>を付与する。</div>
<div class="line">リクエストパラメータに付与された<code class="docutils literal"><span class="pre">user_oauth_approval</span></code>は、認可エンドポイントのスコープ認可を行うメソッドを実行するために用いられる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">CSRFトークン値を引き渡すために、HTMLの<code class="docutils literal"><span class="pre">&lt;form&gt;</span></code>属性の中に<code class="docutils literal"><span class="pre">&lt;sec:csrfInput</span> <span class="pre">/&gt;</span></code>属性を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="oauthauthorizationserverhowtohandleerror">
<span id="id31"></span><h5><a class="toc-backref" href="#id164">9.9.2.3.1.7. 認可リクエスト時のエラー画面のカスタマイズ</a><a class="headerlink" href="#oauthauthorizationserverhowtohandleerror" title="Permalink to this headline">¶</a></h5>
<p>認可エンドポイントで不正クライアントエラー（クライアント未存在エラー等のセキュリティに関わるエラーや、リダイレクトURIチェックエラー）が発生した場合、Spring Security OAuthが提供する<code class="docutils literal"><span class="pre">OAuth2Exception</span></code>がスローされ 、リクエストは<code class="docutils literal"><span class="pre">/oauth/error</span></code>にフォワードされる。
そのため<code class="docutils literal"><span class="pre">/oauth/error</span></code>をハンドリングするコントローラを作成する必要がある。
不正クライアントエラーの詳細については<a class="reference internal" href="#definitionofbadclienterror"><span class="std std-ref">不正クライアントエラー</span></a>を参照されたい。</p>
<p>以下にコントローラの実装例を示す。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">OAuth2ErrorController.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2ErrorController</span> <span class="p">{</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;/oauth/error&quot;</span><span class="p">)</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">handleError</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// omitted</span>
        <span class="k">return</span> <span class="s">&quot;common/error/oauthError&quot;</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>アノテーションを使用して、<code class="docutils literal"><span class="pre">/oauth/error</span></code>へのアクセスに対するメソッドとしてマッピングを行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>次に、表示させるエラー画面のJSPを作成する。
認可エンドポイントで発生した例外がModelの属性名<code class="docutils literal"><span class="pre">error</span></code>に登録されているため、例外の内容を画面に表示する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauthError.jsp</span></code></li>
</ul>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;title&gt;</span>OAuth Error!<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;${pageContext.request.contextPath}/resources/app/css/styles.css&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>OAuth Error!<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;c:if</span> <span class="na">test=</span><span class="s">&quot;${not empty error}&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;p&gt;</span>${f:h(error.oAuth2ErrorCode)}<span class="nt">&lt;/p&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
            <span class="nt">&lt;p&gt;</span>${f:h(error.message)}<span class="nt">&lt;/p&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;/c:if&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例外に設定されているOAuth 2.0のエラーコードを出力する。</div>
<div class="line">エラーコードは、<code class="docutils literal"><span class="pre">invalid_request</span></code>、<code class="docutils literal"><span class="pre">invalid_client</span></code>といった値を持つ。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例外に設定されているエラーメッセージを出力する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">認可エンドポイントで発生したエラーが、不正クライアントエラー以外の場合、
クライアントの呼び出し元コントローラにリダイレクトすることでクライアント側にエラー通知を行う。
エラー通知を行う際のエラー情報はリダイレクトURIにリクエストパラメータとして付与される。
エラーハンドリングについては<a class="reference internal" href="#oauthclienthandleerrorwhenaccessingauthorizationendpointwithcode"><span class="std std-ref">認可エンドポイントアクセス時のエラーハンドリング</span></a>を参照されたい。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>アプリケーションでInternet Explorer/Microsoft Edgeをサポートする場合、エラー画面の応答として生成されるHTMLのサイズに注意する必要がある。</p>
<p>Internet Explorer/Microsoft Edgeでは、応答されたHTMLのサイズが規定値以下だと、アプリケーションが用意したエラー画面の代わりに、Internet Explorer/Microsoft Edgeが用意した簡易メッセージが表示されるためである。</p>
<p class="last">参考までに、Internet Explorerでの詳細な条件は、「<a class="reference external" href="https://blogs.msdn.microsoft.com/ieinternals/2010/08/18/friendly-http-error-pages/">Friendly HTTP Error Pages</a>」を参照されたい。</p>
</div>
</div>
<div class="section" id="oauthauthorizationserverhowtoconfigureaccesstoken">
<span id="id32"></span><h5><a class="toc-backref" href="#id165">9.9.2.3.1.8. リソースサーバへのアクセストークンの連携方法</a><a class="headerlink" href="#oauthauthorizationserverhowtoconfigureaccesstoken" title="Permalink to this headline">¶</a></h5>
<p>リソースサーバがアクセストークンを元にリソースへのアクセスに対する認可判定を行えるよう、認可サーバは<code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code>を介してアクセストークンを連携する。
連携方法は以下に示すとおり複数存在する。</p>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">連携方法</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">DBを介した連携</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">共有DBを利用し、アクセストークンを連携する方法。</div>
<div class="line">リソースサーバと認可サーバがDBを共有している場合に利用可能。</div>
<div class="line">認可サーバは<code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code>の実装クラスとして<code class="docutils literal"><span class="pre">DefaultTokenServices</span></code>を、<code class="docutils literal"><span class="pre">TokenStore</span></code>として<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.store.JdbcTokenStore</span></code>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">HTTPアクセスを介した連携</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">HTTPアクセスにより、アクセストークンを連携する方法。</div>
<div class="line">リソースサーバと認可サーバが共有DBを利用できない場合に、この方法を利用する。</div>
<div class="line">リソースサーバはアクセストークンの取得及び検証を認可サーバに依頼するため、認可サーバに負荷がかかる。</div>
<div class="line">認可サーバは<code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code>の実装クラスとして<code class="docutils literal"><span class="pre">DefaultTokenServices</span></code>を指定する。</div>
<div class="line">アクセストークンをDBで管理する場合は<code class="docutils literal"><span class="pre">JdbcTokenStore</span></code>を、メモリで管理する場合は<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.store.InMemoryTokenStore</span></code>を<code class="docutils literal"><span class="pre">TokenStore</span></code>として指定する。</div>
<div class="line">アクセストークンをメモリで管理する実装はサーバ再起動などでアクセストークンが失われるため、テスト用途専用の実装である。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JWTを利用した連携</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JWTを利用し、アクセストークンを連携する方法。</div>
<div class="line">リソースサーバと認可サーバが共有DBを利用できない場合に、この方法を利用する。</div>
<div class="line">HTTPアクセスを介した連携と比べ、認可サーバにアクセストークンの取得を依頼しないため、認可サーバへの負荷がかからない。</div>
<div class="line">認可サーバは<code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code>の実装クラスとして<code class="docutils literal"><span class="pre">DefaultTokenServices</span></code>を、<code class="docutils literal"><span class="pre">TokenStore</span></code>として<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.store.JwtTokenStore</span></code>を指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter</span></code>を利用することでアクセストークンの署名とエンコード、デコードを行う。</div>
<div class="line">アクセストークンの署名とその検証には公開鍵を使用する方法と、共通鍵を使用する方法がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">メモリを介した連携</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">メモリを共有することで、アクセストークンを連携する方法。</div>
<div class="line">リソースサーバと認可サーバが一つのプロセスとなるようアプリケーションを設計している場合に利用可能。</div>
<div class="line">認可サーバは<code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code>の実装クラスとして<code class="docutils literal"><span class="pre">DefaultTokenServices</span></code>を、<code class="docutils literal"><span class="pre">TokenStore</span></code>として<code class="docutils literal"><span class="pre">InMemoryTokenStore</span></code>を指定する。</div>
<div class="line">メモリを介して連携させるため、共有DBやHTTPアクセスによるアクセストークンの連携が不要となる。</div>
<div class="line">メモリを介してアクセストークンを共有する実装はサーバ再起動などでアクセストークンが失われるため、テスト用途専用の実装である。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>ここでは、代表的な連携方法として共有DBを介して連携させる方法を説明する。
HTTPアクセスを介した連携ついては本節のHow To Extendにて説明している。</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="#oauthauthorizationserverhowtocooperatewithhttp"><span class="std std-ref">HTTPアクセスを介した認可サーバとリソースサーバの連携</span></a></li>
</ul>
</div></blockquote>
<p>共有DBを介して連携させる場合、Spring Security OAuthが提供している<code class="docutils literal"><span class="pre">JdbcTokenStore</span></code>を使用する。</p>
<p>実装例は以下のとおりである。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
     <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span>
     <span class="na">user-approval-handler-ref=</span><span class="s">&quot;userApprovalHandler&quot;</span>
     <span class="na">token-services-ref=</span><span class="s">&quot;tokenServices&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;oauth2:authorization-code</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;tokenServices&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.DefaultTokenServices&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;tokenStore&quot;</span> <span class="na">ref=</span><span class="s">&quot;tokenStore&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;clientDetailsService&quot;</span> <span class="na">ref=</span><span class="s">&quot;clientDetailsService&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;supportRefreshToken&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;tokenStore&quot;</span>
  <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.store.JdbcTokenStore&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
  <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバが使用するTokenServiceとして<code class="docutils literal"><span class="pre">token-services-ref</span></code>属性に(2)で定義している<code class="docutils literal"><span class="pre">tokenServices</span></code>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">tokenServices</span></code>のクラスに<code class="docutils literal"><span class="pre">DefaultTokenServices</span></code>を指定する。</div>
<div class="line">アクセストークンを管理するトークンストアとして、<code class="docutils literal"><span class="pre">tokenStore</span></code>プロパティに(4)で定義している<code class="docutils literal"><span class="pre">TokenStore</span></code>を指定する。</div>
<div class="line">共有DBを介してリソースサーバとアクセストークンの連携を行う場合、リソースサーバでも本設定を行うこと。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リフレッシュトークンを有効にする場合は<code class="docutils literal"><span class="pre">supportRefreshToken</span></code>属性に<code class="docutils literal"><span class="pre">true</span></code>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">トークンストアとして <code class="docutils literal"><span class="pre">JdbcTokenStore</span></code>をBean定義する。</div>
<div class="line">コンストラクタには、トークン情報格納用のテーブルに接続するためのデータソースを指定する。</div>
<div class="line">データソースの設定方法については、<a class="reference internal" href="../ArchitectureInDetail/DataAccessDetail/DataAccessCommon.html#data-access-common-howtouse-datasource"><span class="std std-ref">データソースの設定</span></a>を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><code class="docutils literal"><span class="pre">JdbcTokenStore</span></code>がアクセストークンを連携するために、Spring Security OAuthがスキーマ定義している以下のDBを作成する。
以下の例では共有DBとしてPostgreSQLを使用した場合のDB定義を説明する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ERDiagramToken.png"><img alt="../_images/OAuth_ERDiagramToken.png" src="../_images/OAuth_ERDiagramToken.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">アクセストークンを管理するテーブル。認可サーバで発行したアクセストークンの情報をリソースサーバと共有するために使用する。</div>
<div class="line">各カラムの役割は以下のとおりである。</div>
</div>
<ul class="last">
<li><p class="first">authentication_id：認証情報を一意に識別する認証キーを保持するカラム。主キーとする。</p>
</li>
<li><div class="first line-block">
<div class="line">token：トークンの情報をシリアル化してバイナリとして保持するカラム。</div>
<div class="line">保持するトークンの情報としては、アクセストークンの有効期限、スコープ、アクセストークンのトークンID、リフレッシュトークンのトークンID、使用しているトークンの種類を表すトークンタイプを保持する。</div>
</div>
</li>
<li><p class="first">token_id：アクセストークンを一意に識別するトークンIDを保持するカラム。</p>
</li>
<li><p class="first">user_name：認証されたリソースオーナのユーザ名を保持するカラム。</p>
</li>
<li><p class="first">client_id：認証されたクライアントのクライアントIDを保持するカラム。</p>
</li>
<li><p class="first">authentication：リソースオーナとクライアントの認証情報をシリアル化してバイナリとして保持するカラム。</p>
</li>
<li><p class="first">refresh_token：アクセストークンに紐付くリフレッシュトークンのトークンIDを保持するカラム。</p>
</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">アクセストークンに紐付くリフレッシュトークンを管理するテーブル。</div>
<div class="line">各カラムの役割は以下のとおりである。</div>
</div>
<ul class="last">
<li><p class="first">token_id：リフレッシュトークンを一意に識別するトークンIDを保持するカラム。主キーとする。</p>
</li>
<li><p class="first">token：トークンの情報をシリアル化してバイナリとして保持するカラム。リフレッシュトークンの有効期限を保持する。</p>
</li>
<li><div class="first line-block">
<div class="line">authentication：リソースオーナとクライアントの認証情報をシリアル化してバイナリとして保持するカラム。</div>
<div class="line">アクセストークンを管理するテーブルで保持している認証情報と同じ情報を保持する。</div>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">共有DBでトークンを管理する場合、有効期限切れとなったトークンはクライアントがアクセストークンを利用するタイミングに削除される。
そのためトークンが有効期限切れになったとしても、クライアントがアクセストークンを利用しなければ削除されない。
有効期限切れとなったトークンをDBから削除するためには、バッチ処理等で別途パージを行う必要がある。</p>
</div>
</div>
<div class="section" id="oauthauthorizationserverhowtocanceltoken">
<span id="id33"></span><h5><a class="toc-backref" href="#id166">9.9.2.3.1.9. トークンの取り消し（認可サーバ）</a><a class="headerlink" href="#oauthauthorizationserverhowtocanceltoken" title="Permalink to this headline">¶</a></h5>
<p>発行したアクセストークンの取り消しの実装方法について説明する。</p>
<p>アクセストークンの取り消しは、<code class="docutils literal"><span class="pre">ConsumerTokenService</span></code>インタフェースを実装したクラスの
<code class="docutils literal"><span class="pre">revokeToken</span></code>メソッドを呼び出すことで実現できる。
<code class="docutils literal"><span class="pre">DefaultTokenServices</span></code>クラスは<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.ConsumerTokenServices</span></code>インタフェースを実装している。</p>
<p>アクセストークンの取り消し時に認可情報も削除することが可能である。
アクセストークンの取り消し後に認可情報を削除せずに認可リクエストを行うと、前回の認可リクエスト時の認可情報が再利用される場合がある。
前回の認可リクエスト時の認可情報は、認可情報の有効期限が有効であり、認可リクエストしたスコープが全て認可されている場合に再利用される。</p>
<p>以下に、実装例を示す。</p>
<p>トークンの取り消しを行うサービスクラスのインタフェースと実装クラスを作成する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">RevokeTokenService.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RevokeTokenService</span> <span class="p">{</span>

    <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="nf">revokeToken</span><span class="p">(</span><span class="n">String</span> <span class="n">tokenValue</span><span class="p">,</span> <span class="n">String</span> <span class="n">clientId</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">RevokeTokenServiceImpl.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RevokeTokenServiceImpl</span> <span class="kd">implements</span> <span class="n">RevokeTokenService</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ConsumerTokenServices</span> <span class="n">consumerService</span><span class="p">;</span> <span class="c1">// (1)</span>

    <span class="nd">@Inject</span>
    <span class="n">TokenStore</span> <span class="n">tokenStore</span><span class="p">;</span> <span class="c1">// (2)</span>

    <span class="nd">@Inject</span>
    <span class="n">ApprovalStore</span> <span class="n">approvalStore</span><span class="p">;</span> <span class="c1">// (3)</span>

    <span class="nd">@Inject</span>
    <span class="n">JodaTimeDateFactory</span> <span class="n">dateFactory</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">revokeToken</span><span class="p">(</span><span class="n">String</span> <span class="n">tokenValue</span><span class="p">,</span> <span class="n">String</span> <span class="n">clientId</span><span class="p">){</span> <span class="c1">// (4)</span>
        <span class="c1">// (5)</span>
        <span class="n">OAuth2Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="n">tokenStore</span><span class="p">.</span><span class="na">readAuthentication</span><span class="p">(</span><span class="n">tokenValue</span><span class="p">);</span>

        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">authentication</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">clientId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">authentication</span><span class="p">.</span><span class="na">getOAuth2Request</span><span class="p">().</span><span class="na">getClientId</span><span class="p">()))</span> <span class="p">{</span> <span class="c1">// (6)</span>
                <span class="c1">// (7)</span>
                <span class="n">Authentication</span> <span class="n">user</span> <span class="o">=</span> <span class="n">authentication</span><span class="p">.</span><span class="na">getUserAuthentication</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">user</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Approval</span><span class="o">&gt;</span> <span class="n">approvals</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">String</span> <span class="n">scope</span> <span class="p">:</span> <span class="n">authentication</span><span class="p">.</span><span class="na">getOAuth2Request</span><span class="p">().</span><span class="na">getScope</span><span class="p">())</span> <span class="p">{</span>
                        <span class="n">approvals</span><span class="p">.</span><span class="na">add</span><span class="p">(</span>
                                <span class="k">new</span> <span class="n">Approval</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getName</span><span class="p">(),</span> <span class="n">clientId</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">dateFactory</span><span class="p">.</span><span class="na">newDate</span><span class="p">(),</span> <span class="n">ApprovalStatus</span><span class="p">.</span><span class="na">APPROVED</span><span class="p">));</span>
                    <span class="p">}</span>
                    <span class="n">approvalStore</span><span class="p">.</span><span class="na">revokeApprovals</span><span class="p">(</span><span class="n">approvals</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">consumerService</span><span class="p">.</span><span class="na">revokeToken</span><span class="p">(</span><span class="n">tokenValue</span><span class="p">);</span> <span class="c1">// (8)</span>
                <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">().</span><span class="na">body</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>

            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="s">&quot;invalid_client&quot;</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">UNAUTHORIZED</span><span class="p">).</span><span class="na">body</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="s">&quot;invalid_request&quot;</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">badRequest</span><span class="p">().</span><span class="na">body</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークンの取り消しを行う<code class="docutils literal"><span class="pre">ConsumerTokenService</span></code>インタフェースのBeanをインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークン発行時の認証情報を取得するために使用する<code class="docutils literal"><span class="pre">TokenStore</span></code>のBeanをインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークンの発行時の認可情報を取得するために使用する<code class="docutils literal"><span class="pre">ApprovalStore</span></code>のBeanをインジェクションする。</div>
<div class="line">アクセストークンの取り消し時に認可情報を削除しない場合は不要となる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取り消しを行うアクセストークンの値と、クライアントのチェックを行うために使用するクライアントIDをパラメータとして受け取る。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">TokenStore</span></code>の<code class="docutils literal"><span class="pre">readAuthentication</span></code>メソッドを呼び出し、アクセストークンを発行した際の認証情報を取得する。</div>
<div class="line">認証情報が正常に取得できた場合のみ、トークンの削除処理を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証情報より、アクセストークン発行時に使用したクライアントIDを取得し、リクエストパラメータのクライアントIDと一致するかを確認する。</div>
<div class="line">アクセストークン発行時のクライアントIDと一致する場合のみ、アクセストークンの削除を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証情報より、アクセストークン発行時のリソースオーナの認証情報を取得する。</div>
<div class="line">リソースオーナの認証情報が取得できた場合、<code class="docutils literal"><span class="pre">TokenStore</span></code>の<code class="docutils literal"><span class="pre">revokeApprovals</span></code>メソッドを呼び出し、認可情報の削除を行う。</div>
<div class="line">クライアントクレデンシャルグラントを使用している場合はリソースオーナの認証情報が存在しないため、<code class="docutils literal"><span class="pre">revokeApprovals</span></code>メソッドに渡すパラメータが生成できない。</div>
<div class="line">そのため、リソースオーナの認証情報が取得できない場合は認可情報の削除処理は行わない。</div>
<div class="line">アクセストークンの取り消し時に認可情報を削除しない場合、この処理は不要となる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ConsumerTokenService</span></code>の<code class="docutils literal"><span class="pre">revokeToken</span></code>メソッドを呼び出し、アクセストークンとアクセストークンに紐付くリフレッシュトークンの削除を行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>トークンの取り消しリクエストを受けるコントローラを作成する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">TokenRevocationRestController.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;oauth&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TokenRevocationRestController</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">RevokeTokenService</span> <span class="n">revokeTokenService</span><span class="p">;</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;tokens/revoke&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="nf">revoke</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="p">(</span><span class="s">&quot;token&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">tokenValue</span><span class="p">,</span>
        <span class="nd">@AuthenticationPrincipal</span> <span class="n">UserDetails</span> <span class="n">user</span><span class="p">){</span>

        <span class="c1">// (2)</span>
        <span class="n">String</span> <span class="n">clientId</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="na">getUsername</span><span class="p">();</span>
        <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">revokeTokenService</span><span class="p">.</span><span class="na">revokeToken</span><span class="p">(</span><span class="n">tokenValue</span><span class="p">,</span> <span class="n">clientId</span><span class="p">);</span> <span class="c1">// (3)</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>アノテーションを使用して、<code class="docutils literal"><span class="pre">/oauth/tokens/revoke</span></code>へのアクセスに対するメソッドとしてマッピングを行う。</div>
<div class="line">ここで指定するパスは<a class="reference internal" href="#oauthauthorizationserverclientauthentication"><span class="std std-ref">クライアントの認証</span></a>で行った設定と同様に、Basic認証の適用とCSRF対策機能の無効化を行う必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Basic認証で生成された認証情報からトークンの取り消し時のチェックで使用するクライアントIDを取得する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RevokeTokenService</span></code>を呼び出し、トークンの取り消しを行う。</div>
<div class="line">リクエストパラメータとして受け取ったアクセストークンの値と、認証情報から取得したクライアントIDをパラメータとして渡す。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">RFC 7009ではリクエストパラメータとして<code class="docutils literal"><span class="pre">token_type_hint</span></code>を任意で付与してよいことが記載されている。
<code class="docutils literal"><span class="pre">token_type_hint</span></code>は削除対象のトークンがアクセストークンとリフレッシュトークンのどちらであるかを判別するためのヒントである。
Spring Security OAuthが提供する<code class="docutils literal"><span class="pre">ConsumerTokenService</span></code>はアクセストークンを渡すことでアクセストークンとリフレッシュトークンの両方削除するため、上記の実装例では使用していない。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">認可サーバにトークンの取り消しをリクエストしたクライアントは、認可サーバの削除後にクライアントで保持しているトークンも取り消す必要がある。
クライアントサーバのトークンの取り消しについては<a class="reference internal" href="#oauthclientserverhowtocanceltoken"><span class="std std-ref">トークンの取り消し（クライアントサーバ）</span></a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthauthorizationserverhowtocontrolltarnsaction">
<span id="id34"></span><h5><a class="toc-backref" href="#id167">9.9.2.3.1.10. トランザクション制御</a><a class="headerlink" href="#oauthauthorizationserverhowtocontrolltarnsaction" title="Permalink to this headline">¶</a></h5>
<p>認可サーバにおけるトランザクション制御の注意点について説明する。</p>
<p>Spring Security OAuthが取り扱う情報（認可コード、認可情報、トークン）をDBにて管理する場合には、トランザクション管理について考慮する必要がある。</p>
<p>アクセストークンやリフレッシュトークンを発行する<code class="docutils literal"><span class="pre">DefaultTokenServices</span></code>には<code class="docutils literal"><span class="pre">&#64;Transactional</span></code>アノテーションが付与されており、
トランザクション管理が行われるが、認可コードを操作する<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.code.AuthorizationCodeServices</span></code>や認可情報を操作する
<code class="docutils literal"><span class="pre">UserApprovalHandler</span></code>には<code class="docutils literal"><span class="pre">&#64;Transactional</span></code>アノテーションが付与されておらず、トランザクション管理が行われない。</p>
<p>そのため、<code class="docutils literal"><span class="pre">DataSource</span></code>から取得するコネクションの自動コミットが無効となっている場合、管理対象となる情報がDBに登録されないため、トランザクション制御の設定が必須となる。
なお、自動コミットが有効な場合でも、データの一貫性を担保するためにトランザクションを管理する必要がある。</p>
<p>認可コード、認可情報をDBにて管理する場合のトランザクション制御設定例を以下に示す。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;tx:advice</span> <span class="na">id=</span><span class="s">&quot;oauthTransactionAdvice&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;tx:attributes&gt;</span>
        <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">&quot;*&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/tx:attributes&gt;</span>
<span class="nt">&lt;/tx:advice&gt;</span>

<span class="nt">&lt;aop:config&gt;</span>
    <span class="nt">&lt;aop:pointcut</span> <span class="na">id=</span><span class="s">&quot;authorizationOperation&quot;</span>
                  <span class="na">expression=</span><span class="s">&quot;execution(* org.springframework.security.oauth2.provider.code.AuthorizationCodeServices.*(..))&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;aop:pointcut</span> <span class="na">id=</span><span class="s">&quot;approvalOperation&quot;</span>
                  <span class="na">expression=</span><span class="s">&quot;execution(* org.springframework.security.oauth2.provider.approval.UserApprovalHandler.*(..))&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;aop:advisor</span> <span class="na">pointcut-ref=</span><span class="s">&quot;authorizationOperation&quot;</span> <span class="na">advice-ref=</span><span class="s">&quot;oauthTransactionAdvice&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;aop:advisor</span> <span class="na">pointcut-ref=</span><span class="s">&quot;approvalOperation&quot;</span> <span class="na">advice-ref=</span><span class="s">&quot;oauthTransactionAdvice&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/aop:config&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">AOPを利用したトランザクション管理を行なうため、<code class="docutils literal"><span class="pre">tx:advice</span></code>を設定する。</div>
<div class="line">このタグを使用するために<code class="docutils literal"><span class="pre">tx</span></code>のネームスペースとスキーマを追加している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">AOPを使用し、認可コードを操作する各メソッドにトランザクション境界を設定する。</div>
<div class="line">このタグを使用するために<code class="docutils literal"><span class="pre">aop</span></code>のネームスペースとスキーマを追加している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">AOPを使用し、認可情報を操作する各メソッドにトランザクション境界を設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="implementationoauthresourceserverofautorizationcode">
<span id="id35"></span><h4><a class="toc-backref" href="#id168">9.9.2.3.2. リソースサーバの実装</a><a class="headerlink" href="#implementationoauthresourceserverofautorizationcode" title="Permalink to this headline">¶</a></h4>
<p>リソースサーバの実装方法について説明する。</p>
<p>リソースサーバでは、アクセストークンの検証とリソースに対しての認可制御をSpring Security OAuthの機能を使用して提供する。</p>
<p>ここではTODOリソースのREST APIに対して認可制御を実現する方法を説明する。</p>
<div class="section" id="id36">
<h5><a class="toc-backref" href="#id169">9.9.2.3.2.1. 設定ファイルの作成（リソースサーバ）</a><a class="headerlink" href="#id36" title="Permalink to this headline">¶</a></h5>
<p>リソースサーバを実装する際には新たにOAuth 2.0用のBean定義ファイルを作成する。</p>
<p>ここでは <code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code>とする。</p>
<p><code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code>には以下の設定を追加する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xmlns:oauth2=</span><span class="s">&quot;http://www.springframework.org/schema/security/oauth2&quot;</span>
       <span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/security</span>
<span class="s">           https://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">           http://www.springframework.org/schema/security/oauth2</span>
<span class="s">           https://www.springframework.org/schema/security/spring-security-oauth2.xsd</span>
<span class="s">           http://www.springframework.org/schema/beans</span>
<span class="s">           https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;sec:http</span> <span class="na">pattern=</span><span class="s">&quot;/api/v1/todos/**&quot;</span> <span class="na">create-session=</span><span class="s">&quot;stateless&quot;</span>
                   <span class="na">entry-point-ref=</span><span class="s">&quot;oauth2AuthenticationEntryPoint&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;sec:access-denied-handler</span> <span class="na">ref=</span><span class="s">&quot;oauth2AccessDeniedHandler&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;sec:csrf</span> <span class="na">disabled=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
        <span class="nt">&lt;sec:custom-filter</span> <span class="na">ref=</span><span class="s">&quot;oauth2AuthenticationFilter&quot;</span>
                                <span class="na">before=</span><span class="s">&quot;PRE_AUTH_FILTER&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
        <span class="nt">&lt;sec:custom-filter</span> <span class="na">ref=</span><span class="s">&quot;userIdMDCPutFilter&quot;</span> <span class="na">after=</span><span class="s">&quot;ANONYMOUS_FILTER&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/sec:http&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;oauth2AccessDeniedHandler&quot;</span>
              <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.error.OAuth2AccessDeniedHandler&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (5) --&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;oauth2AuthenticationEntryPoint&quot;</span>
              <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.error.OAuth2AuthenticationEntryPoint&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (6) --&gt;</span>

    <span class="nt">&lt;oauth2:resource-server</span> <span class="na">id=</span><span class="s">&quot;oauth2AuthenticationFilter&quot;</span> <span class="na">resource-id=</span><span class="s">&quot;todoResource&quot;</span>
              <span class="na">token-services-ref=</span><span class="s">&quot;tokenServices&quot;</span> <span class="na">entry-point-ref=</span><span class="s">&quot;oauth2AuthenticationEntryPoint&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (7) --&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">pattern</span></code>属性には認可制御の対象とするパスのパターンを指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">entry-point-ref</span></code>には<code class="docutils literal"><span class="pre">OAuth2AuthenticationEntryPoint</span></code>のBeanを指定する。ここでの設定は定義上必要だが指定したBeanは使用されない。
実際に使用されるのは後述する<code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code>に指定している<code class="docutils literal"><span class="pre">OAuth2AuthenticationEntryPoint</span></code>のBeanである。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">access-denied-handler</span></code>には<code class="docutils literal"><span class="pre">OAuth2AccessDeniedHandler</span></code>のBeanを設定する。ここでは(5)で定義している<code class="docutils literal"><span class="pre">oauth2AccessDeniedHandler</span></code>のBeanを指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本実装例ではCSRF対策を無効化する。</div>
<div class="line">CSRF対策については<a class="reference internal" href="../ArchitectureInDetail/WebServiceDetail/REST.html#resthowtousesecuritycsrf"><span class="std std-ref">CSRF対策</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">custom-filter</span></code>にはリソースサーバ用の認証フィルタとして<code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code>を設定する。</div>
<div class="line">ここでは(7)で定義している<code class="docutils literal"><span class="pre">oauth2AuthenticationFilter</span></code>のBeanを指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code>はリクエストに含まれるアクセストークンを利用してPre-Authenticationを行うためのフィルタであるため、
<code class="docutils literal"><span class="pre">before</span></code>に<code class="docutils literal"><span class="pre">PRE_AUTH_FILTER</span></code>を指定し<code class="docutils literal"><span class="pre">PRE_AUTH_FILTER</span></code>の前に<code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code>の処理が実行されるように設定する。</div>
<div class="line">Pre-Authenticationについては<a class="reference external" href="https://docs.spring.io/spring-security/site/docs/5.4.2/reference/html5/#servlet-preauth">Spring Security Reference -Pre-Authentication Scenarios-</a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring Security OAuthが提供するリソースサーバ用の<code class="docutils literal"><span class="pre">AccessDeniedHandler</span></code>を定義する。</div>
<div class="line"><code class="docutils literal"><span class="pre">OAuth2AccessDeniedHandler</span></code>は、認可エラー時に発生する例外をハンドリングしてエラー応答を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OAuth用のエラー応答を行うための<code class="docutils literal"><span class="pre">OAuth2AuthenticationEntryPoint</span></code>をBean定義する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring Security OAuthが提供するリソースサーバ用のServletFilterを定義する。</div>
<div class="line"><code class="docutils literal"><span class="pre">&lt;oauth2:resource-server&gt;</span></code>タグを使用することで、Authentication Filterとして<code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code>が登録される。</div>
<div class="line"><code class="docutils literal"><span class="pre">id</span></code>属性に指定した文字列はBeanのIDとなる。ここでは <code class="docutils literal"><span class="pre">oauth2AuthenticationFilter</span></code>を指定している。</div>
<div class="line"><code class="docutils literal"><span class="pre">resource-id</span></code>属性にはサーバが提供するリソースのIDを指定する。ここでは<code class="docutils literal"><span class="pre">todoResource</span></code>を指定している。</div>
<div class="line">アクセストークンに紐付くクライアント情報のリソースIDに対し、<code class="docutils literal"><span class="pre">resource-id</span></code>属性に指定したリソースIDが含まれているか検証が行われる。</div>
<div class="line">検証の結果、リソースIDが含まれている場合のみリソースに対してのアクセスを許可する。</div>
<div class="line">なお、<code class="docutils literal"><span class="pre">resource-id</span></code>の定義は任意であり、定義しない場合はリソースIDの検証が行われない。</div>
<div class="line"><code class="docutils literal"><span class="pre">token-services-ref</span></code>属性には<code class="docutils literal"><span class="pre">TokenServices</span></code>のIDを指定する。<code class="docutils literal"><span class="pre">TokenServices</span></code>については後述する。</div>
<div class="line"><code class="docutils literal"><span class="pre">entry-point-ref</span></code>属性には<code class="docutils literal"><span class="pre">OAuth2AuthenticationEntryPoint</span></code>のBeanを指定する。ここでは<code class="docutils literal"><span class="pre">oauth2AuthenticationEntryPoint</span></code>を指定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>作成した<code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code>を読み込むように<code class="docutils literal"><span class="pre">web.xml</span></code>に設定を追加する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">web.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;context-param&gt;</span>
    <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
    <span class="nt">&lt;param-value&gt;</span>
        classpath*:META-INF/spring/applicationContext.xml
        classpath*:META-INF/spring/oauth2-resource.xml <span class="c">&lt;!-- (1) --&gt;</span>
        classpath*:META-INF/spring/spring-security.xml
    <span class="nt">&lt;/param-value&gt;</span>
<span class="nt">&lt;/context-param&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code>で設定したパスのパターンを内包するようなパスが<code class="docutils literal"><span class="pre">spring-security.xml</span></code>にアクセス制御対象として設定されている場合を考慮し、先に<code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code>を読み込むようにする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id37">
<h5><a class="toc-backref" href="#id170">9.9.2.3.2.2. リソースにアクセス可能なスコープの設定</a><a class="headerlink" href="#id37" title="Permalink to this headline">¶</a></h5>
<p>リソースごとにアクセス可能なスコープを定義するために、OAuth 2.0用のBean定義ファイルに
スコープの定義とSpEL式をサポートするためのBean定義を追加する。</p>
<p>実装例は以下のとおりである。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xmlns:oauth2=</span><span class="s">&quot;http://www.springframework.org/schema/security/oauth2&quot;</span>
       <span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/security</span>
<span class="s">           https://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">           http://www.springframework.org/schema/security/oauth2</span>
<span class="s">           https://www.springframework.org/schema/security/spring-security-oauth2.xsd</span>
<span class="s">           http://www.springframework.org/schema/beans</span>
<span class="s">           https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;sec:http</span> <span class="na">pattern=</span><span class="s">&quot;/api/v1/todos/**&quot;</span> <span class="na">create-session=</span><span class="s">&quot;stateless&quot;</span>
                   <span class="na">entry-point-ref=</span><span class="s">&quot;oauth2AuthenticationEntryPoint&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;sec:access-denied-handler</span> <span class="na">ref=</span><span class="s">&quot;oauth2AccessDeniedHandler&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;sec:csrf</span> <span class="na">disabled=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;sec:expression-handler</span> <span class="na">ref=</span><span class="s">&quot;oauth2ExpressionHandler&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/**&quot;</span> <span class="na">method=</span><span class="s">&quot;GET&quot;</span>
                                <span class="na">access=</span><span class="s">&quot;#oauth2.hasScope(&#39;READ&#39;)&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/**&quot;</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span>
                                <span class="na">access=</span><span class="s">&quot;#oauth2.hasScope(&#39;CREATE&#39;)&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;sec:custom-filter</span> <span class="na">ref=</span><span class="s">&quot;oauth2AuthenticationFilter&quot;</span>
                                <span class="na">before=</span><span class="s">&quot;PRE_AUTH_FILTER&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;sec:custom-filter</span> <span class="na">ref=</span><span class="s">&quot;userIdMDCPutFilter&quot;</span> <span class="na">after=</span><span class="s">&quot;ANONYMOUS_FILTER&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/sec:http&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;oauth2:web-expression-handler</span> <span class="na">id=</span><span class="s">&quot;oauth2ExpressionHandler&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">expression-handler</span></code>には<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.expression.OAuth2WebSecurityExpressionHandler</span></code>のBeanを指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">intercept-url</span></code>を使用してリソースに対してスコープによるアクセスポリシーを定義する。</div>
<div class="line"><code class="docutils literal"><span class="pre">pattern</span></code>属性には保護したいリソースのパスのパターンを指定する。本実装例では /api/v1/todos/ 配下のリソースが保護される。</div>
<div class="line"><code class="docutils literal"><span class="pre">method</span></code>属性にはリソースのHTTPメソッドを指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">access</span></code>属性にはリソースへのアクセスを認可するscopeを指定する。設定値は大文字、小文字を区別する。</div>
<div class="line">ここではSpEL式を用いて指定を行っている。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2WebSecurityExpressionHandler</span></code>をBean定義する。</div>
<div class="line">このBeanを定義することでSpring Security OAuthが提供する認可制御を行うためのSpELがサポートされる。</div>
<div class="line">なお、<code class="docutils literal"><span class="pre">id</span></code>属性に指定した値がこのbeanのidとなる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Spring Security OAuthが用意している主なExpressionを紹介する。</p>
<p>詳細については<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.expression.OAuth2SecurityExpressionMethods</span></code>の<a class="reference external" href="https://javadoc.io/doc/org.springframework.security.oauth/spring-security-oauth2/2.5.0.RELEASE/org/springframework/security/oauth2/provider/expression/OAuth2SecurityExpressionMethods.html">JavaDoc</a>を参照されたい。</p>
<table border="1" class="colwidths-given longtable docutils" id="id116">
<caption><span class="caption-text"><strong>Spring Security OAuthが用意しているExpression</strong></span><a class="headerlink" href="#id116" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Expression</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">hasScope(String</span> <span class="pre">scope)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントがリソースオーナから認可されているスコープと引数のスコープが一致する場合に<code class="docutils literal"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">hasAnyScope(String...</span> <span class="pre">scopes)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントがリソースオーナから認可されているスコープと引数のスコープのいずれかが一致する場合に<code class="docutils literal"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">hasScopeMatching(String</span> <span class="pre">scopeRegex)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントがリソースオーナから認可されているスコープと引数に指定された正規表現が一致する場合に<code class="docutils literal"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">hasAnyScopeMatching(String...</span> <span class="pre">scopesRegex)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントがリソースオーナから認可されているスコープと引数に指定されたいずれかの正規表現が一致する場合に<code class="docutils literal"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">clientHasRole(String</span> <span class="pre">role)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントが引数に指定されたロールを持っている場合に<code class="docutils literal"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">clientHasAnyRole(String...</span> <span class="pre">roles)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントが引数に指定されたいずれかのロールを持っている場合に<code class="docutils literal"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">denyOAuthClient</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OAuth 2.0でのリクエストを拒否する。リソースオーナのみがリソースにアクセスできるようにするために使用される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">isOAuth</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OAuth 2.0でのリクエストを許可する。クライアントがリソースにアクセスできるようにするために使用される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>SpEL式についてはSpring Securityが提供するSpELを合わせて使用することができる。</p>
<p class="last">Spring Securityが提供するSpELについては <a class="reference internal" href="Authorization.html#id6"><span class="std std-ref">Built-InのWeb Expressions</span></a> を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id38">
<h5><a class="toc-backref" href="#id171">9.9.2.3.2.3. 認可サーバとのアクセストークンの連携方法</a><a class="headerlink" href="#id38" title="Permalink to this headline">¶</a></h5>
<p>認可サーバとリソースサーバはアクセストークンを<code class="docutils literal"><span class="pre">TokenServices</span></code>を介して連携する。</p>
<p>連携方法の種類については<a class="reference internal" href="#oauthauthorizationserverhowtoconfigureaccesstoken"><span class="std std-ref">リソースサーバへのアクセストークンの連携方法</span></a>を参照されたい。</p>
<p>ここではDBを共有する方法で設定を行う。</p>
<p>設定の解説については認可サーバでの<code class="docutils literal"><span class="pre">TokenServices</span></code>の設定と同様なため<a class="reference internal" href="#oauthauthorizationserverhowtoconfigureaccesstoken"><span class="std std-ref">リソースサーバへのアクセストークンの連携方法</span></a>を参照されたい。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;tokenServices&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.DefaultTokenServices&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;tokenStore&quot;</span> <span class="na">ref=</span><span class="s">&quot;tokenStore&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;tokenStore&quot;</span>
  <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.store.JdbcTokenStore&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">認可サーバとリソースサーバを連携させる方法として、Spring Security OAuthで提供されている<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.RemoteTokenServices</span></code>を利用する方法や、
JSON Web Tokenを利用する方法がある。
Spring Security OAuthで提供されている<code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>を利用する方法については<a class="reference internal" href="#oauthauthorizationserverhowtocooperatewithhttp"><span class="std std-ref">HTTPアクセスを介した認可サーバとリソースサーバの連携</span></a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthresourceservergetprincipal">
<span id="id39"></span><h5><a class="toc-backref" href="#id172">9.9.2.3.2.4. ユーザ情報の取得</a><a class="headerlink" href="#oauthresourceservergetprincipal" title="Permalink to this headline">¶</a></h5>
<p>リソースサーバでは、<a class="reference internal" href="Authentication.html#springsecurityauthenticationintegrationwithspringmvc"><span class="std std-ref">認証処理とSpring MVCの連携</span></a>で説明されている認証情報の取得方法と同様に、Controllerクラスのメソッド引数に<code class="docutils literal"><span class="pre">UserDetails</span></code>を指定し<code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>アノテーションを付与することにより認証されたリソースオーナの情報を受け取ることができる。
以下に実装例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;api&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;todos&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">list</span><span class="p">(</span><span class="nd">@AuthenticationPrincipal</span> <span class="n">UserDetails</span> <span class="n">user</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (1)</span>

        <span class="c1">// omitted</span>

    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数 <code class="docutils literal"><span class="pre">user</span></code>にリソースオーナの認証情報が格納される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>クライアントの認証情報を取得したい場合は、Controllerクラスのメソッド引数に<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.OAuth2Authentication</span></code>を指定する。
以下にControllerクラスのメソッド引数に<code class="docutils literal"><span class="pre">OAuth2Authentication</span></code>を指定してクライアントとリソースオーナの認証情報を取得する例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;api&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;todos&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">list</span><span class="p">(</span><span class="n">OAuth2Authentication</span> <span class="n">authentication</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (1)</span>

        <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">authentication</span><span class="p">.</span><span class="na">getUserAuthentication</span><span class="p">().</span><span class="na">getName</span><span class="p">();</span> <span class="c1">// (2)</span>
        <span class="n">String</span> <span class="n">clientId</span> <span class="o">=</span> <span class="n">authentication</span><span class="p">.</span><span class="na">getOAuth2Request</span><span class="p">().</span><span class="na">getClientId</span><span class="p">();</span>  <span class="c1">// (3)</span>

        <span class="c1">// omitted</span>

    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数 <code class="docutils literal"><span class="pre">authentication</span></code>にリソースオーナ、クライアントの認証情報が格納される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">authentication</span></code>よりリソースオーナ名を取得する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">authentication</span></code>よりクライアントIDを取得する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">上記はアプリケーション層で<code class="docutils literal"><span class="pre">OAuth2Authentication</span></code>を使用する場合の実装例である。
<code class="docutils literal"><span class="pre">OAuth2Authentication</span></code>に依存しない実装を行いたい場合<code class="docutils literal"><span class="pre">HandlerMethodArgumentResolver</span></code>を実装することで同様の機能が実現可能である。
具体的な実装方法については、<a class="reference internal" href="../ImplementationAtEachLayer/ApplicationLayer.html#methodargumentresolver"><span class="std std-ref">HandlerMethodArgumentResolverの実装</span></a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="implementationoauthclientserverofautorizationcode">
<span id="id40"></span><h4><a class="toc-backref" href="#id173">9.9.2.3.3. クライアントの実装</a><a class="headerlink" href="#implementationoauthclientserverofautorizationcode" title="Permalink to this headline">¶</a></h4>
<p>クライアントの実装方法について説明する。</p>
<p>ここでは<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を使用して実現する方法を説明する。</p>
<p><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>では、OAuth 2.0独自の機能として、<code class="docutils literal"><span class="pre">AccessTokenProvider</span></code>によるグラントタイプに応じた
アクセストークンの取得や、<code class="docutils literal"><span class="pre">OAuth2ClientContext</span></code>による複数リクエスト間でのアクセストークンの共有、リソースサーバへのアクセス時のエラーハンドリングといった機能を実装している。</p>
<p>クライアントでは、<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を利用し、グラントタイプやスコープなどのアプリケーション用件に沿ったパラメータを定義することで、OAuth 2.0機能を使用したリソースへのアクセスが可能となる。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Spring Security OAuth以外のアーキテクチャで実装されているリソースサーバにアクセスする場合は、REST APIでのアクセスを受け付けているか確認されたい。リソースサーバのAPIが異なる場合は<cite>OAuth2RestTemplate</cite>以外の手段でアクセスする必要がある。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="id41">
<h5><a class="toc-backref" href="#id174">9.9.2.3.3.1. 設定ファイルの作成（クライアント）</a><a class="headerlink" href="#id41" title="Permalink to this headline">¶</a></h5>
<p>まず、OAuth 2.0に関する定義を行うための設定ファイルとして<code class="docutils literal"><span class="pre">oauth2-client.xml</span></code>を作成する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
    <span class="na">xmlns:oauth2=</span><span class="s">&quot;http://www.springframework.org/schema/security/oauth2&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;</span>
<span class="s">        http://www.springframework.org/schema/security https://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">        http://www.springframework.org/schema/beans https://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">        http://www.springframework.org/schema/security/oauth2 https://www.springframework.org/schema/security/spring-security-oauth2.xsd</span>
<span class="s">    &quot;</span><span class="nt">&gt;</span>


<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p><code class="docutils literal"><span class="pre">web.xml</span></code>に、作成した<code class="docutils literal"><span class="pre">oauth2-client.xml</span></code>を読み込む設定を追加する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">web.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;context-param&gt;</span>
    <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
    <span class="nt">&lt;param-value&gt;</span>
        classpath*:META-INF/spring/applicationContext.xml
        classpath*:META-INF/spring/oauth2-client.xml  <span class="c">&lt;!-- (1) --&gt;</span>
        classpath*:META-INF/spring/spring-security.xml
    <span class="nt">&lt;/param-value&gt;</span>
<span class="nt">&lt;/context-param&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code>を読み込むように設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauth2clientcontextfilter">
<h5><a class="toc-backref" href="#id175">9.9.2.3.3.2. OAuth2ClientContextFilterの適用</a><a class="headerlink" href="#oauth2clientcontextfilter" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>をサーブレットフィルタとして登録する。</p>
<p><code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>を登録することでリソースオーナによる認可が取得できていない状態でリソースサーバへのアクセスを試みた場合に
発生する<code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code>を捕捉し、認可サーバが提供するリソースオーナの認可を取得するためのページへリダイレクトする
機能を組み込むことができる。</p>
<p><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code>には以下の設定を追加する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:client</span> <span class="na">id=</span><span class="s">&quot;oauth2ClientContextFilter&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;oauth2:client&gt;</span></code>タグを使用することで、<code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>のBeanが定義される。<code class="docutils literal"><span class="pre">id</span></code>属性に指定した文字列はBeanのIDとして使用される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p><code class="docutils literal"><span class="pre">web.xml</span></code>に、<code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>の設定を追加する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">web.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;filter&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>oauth2ClientContextFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;filter-class&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="nt">&lt;/filter-class&gt;</span>
<span class="nt">&lt;/filter&gt;</span>
<span class="nt">&lt;filter-mapping&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>oauth2ClientContextFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>/oauth/*<span class="nt">&lt;/url-pattern&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/filter-mapping&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DelegatingFilterProxy</span></code>を使用して、フィルタ名(<code class="docutils literal"><span class="pre">&lt;filter-name&gt;</span></code>属性に指定した値)とBean名が一致するBeanをサーブレットフィルタとして登録する。</div>
<div class="line">フィルタ名には<code class="docutils literal"><span class="pre">&lt;oauth2:client&gt;</span></code>の<code class="docutils literal"><span class="pre">id</span></code>属性に指定したBean名と同じ値を設定する。</div>
<div class="line">なお、Spring Security OAuthで発生する例外が意図しない例外ハンドリングが行われないようにするために、<code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>はサーブレットフィルタの定義の一番最後に記述することを推奨する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code>が発生する可能性があるパスに対して<code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>を適用している。</div>
<div class="line">上記例では、すべてのリクエストに対して<code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>を適用している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>は、認可サーバが認可処理後にユーザエージェントを戻すリダイレクトURIの生成をフィルタの前処理で行っているため、
<code class="docutils literal"><span class="pre">/*</span></code>のような広範囲な定義にすると<code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code>が発生しないパスに対して無駄な処理が行われることになる。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>は、認可サーバがリソースオーナの認可を取得した後にリダイレクトさせるURLをリクエストスコープに
<code class="docutils literal"><span class="pre">currentUri</span></code>という属性名で格納する。そのため、クライアントでは<code class="docutils literal"><span class="pre">currentUri</span></code>という属性名を使用することはできない。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>前述のとおり、<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.client.filter.OAuth2ClientContextFilter</span></code>は<code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code>を捕捉し、認可サーバに対してリダイレクトさせるサーブレットフィルタである。</p>
<p>ただし、ブランクプロジェクトで予め設定されている<code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>が先に<code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code>をハンドリングしてしまうと
<code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>は期待した動作にならない。</p>
<p>そのため、<code class="docutils literal"><span class="pre">spring-mvc.xml</span></code>の設定を変更し、<code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>が<code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code>をハンドリングしないようにする必要がある。
<code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>の詳しい解説については<a class="reference internal" href="../ArchitectureInDetail/WebApplicationDetail/ExceptionHandling.html"><span class="doc">例外ハンドリング</span></a>を参照されたい。</p>
<p><code class="docutils literal"><span class="pre">spring-mvc.xml</span></code>に、<code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code>を<code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>の除外対象として追加する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">spring-mvc.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;systemExceptionResolver&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.SystemExceptionResolver&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;excludedExceptions&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;array&gt;</span>
            <span class="c">&lt;!-- (1) --&gt;</span>
            <span class="nt">&lt;value&gt;</span>org.springframework.security.oauth2.client.resource.UserRedirectRequiredException
            <span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/array&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code>を<code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>のハンドリング対象から除外する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauth2resttemplate">
<span id="oauth2resttemplatesettings"></span><h5><a class="toc-backref" href="#id176">9.9.2.3.3.3. OAuth2RestTemplateの設定</a><a class="headerlink" href="#oauth2resttemplate" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>の設定例を示す。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:resource</span> <span class="na">id=</span><span class="s">&quot;todoAuthCodeGrantResource&quot;</span> <span class="na">client-id=</span><span class="s">&quot;firstSec&quot;</span>
                 <span class="na">client-secret=</span><span class="s">&quot;firstSecSecret&quot;</span>
                 <span class="na">type=</span><span class="s">&quot;authorization_code&quot;</span>
                 <span class="na">scope=</span><span class="s">&quot;READ,WRITE&quot;</span>
                 <span class="na">access-token-uri=</span><span class="s">&quot;${auth.serverUrl}/oauth/token&quot;</span>
                 <span class="na">user-authorization-uri=</span><span class="s">&quot;${auth.serverUrl}/oauth/authorize&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

<span class="nt">&lt;oauth2:rest-template</span> <span class="na">id=</span><span class="s">&quot;todoAuthCodeGrantResourceRestTemplate&quot;</span> <span class="na">resource=</span><span class="s">&quot;todoAuthCodeGrantResource&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>が参照する、アクセス対象となるリソースに関する詳細情報を定義する。</div>
<div class="line">各項目の設定値については下記表を参照のこと。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を定義する。</div>
<div class="line"><code class="docutils literal"><span class="pre">id</span></code>には<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>のBean名を指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">resource</span></code>には(1)で定義したBeanの<code class="docutils literal"><span class="pre">id</span></code>を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id117">
<caption><span class="caption-text"><strong>リソース詳細情報</strong></span><a class="headerlink" href="#id117" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項目</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">id</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースのBean名。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">client-id</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバにてクライントを識別するID。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">client-secret</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバにてクライアントの認証に用いるパスワード。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">type</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">グラントタイプ。認可コードグラントの場合<code class="docutils literal"><span class="pre">authorization_code</span></code>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">scope</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可を要求するスコープをカンマ区切りで列挙する。設定値は大文字、小文字を区別する。
省略時は認可サーバにおいてクライアントに対して設定しているスコープを全て要求する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">access-token-uri</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークンの発行を依頼するための認可サーバのエンドポイント。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">user-authorization-uri</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナの認可を得るための認可サーバのエンドポイント。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>本実装例では、実装中に設定する各サーバのコンテキストルートを以下のプレースホルダで表現している。</p>
<blockquote>
<div><table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">プレースホルダのキー</th>
<th class="head">設定値</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub"><code class="docutils literal"><span class="pre">auth.serverUrl</span></code></th>
<td>認可サーバのコンテキストルート</td>
</tr>
<tr class="row-odd"><th class="stub"><code class="docutils literal"><span class="pre">resource.serverUrl</span></code></th>
<td>リソースサーバのコンテキストルート</td>
</tr>
<tr class="row-even"><th class="stub"><code class="docutils literal"><span class="pre">client.serverUrl</span></code></th>
<td>クライアントのコンテキストルート</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p class="last">また、各サーバのエンドポイントの絶対パスを表現する場合は、パスが明示的にわかるよう、<code class="docutils literal"><span class="pre">${auth.serverUrl}/oauth/token</span></code>のように
プレースホルダ以下にパスを指定している。実際にアプリケーションを開発する際には、
例えばエンドポイントが外部システムである場合、外部システム仕様変更時のエンドポイントパス変更に対応するためにパス全体をプレースホルダで表現するなど、要件に応じてパスの指定方法を検討することを推奨する。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><code class="docutils literal"><span class="pre">&lt;oauth2:resource&gt;</span></code>タグでは、アクセストークン取得時のクライアント認証方法を指定する方法として
<code class="docutils literal"><span class="pre">client-authentication-scheme</span></code>属性が用意されている。
<code class="docutils literal"><span class="pre">client-authentication-scheme</span></code>属性に指定可能な値は以下の通り。</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">header</span></code>：Authorizationヘッダを使用したBasic認証（デフォルト値）</li>
<li><code class="docutils literal"><span class="pre">query</span></code>：リクエスト時のURLクエリパラメータを使用した認証</li>
<li><code class="docutils literal"><span class="pre">form</span></code>：リクエスト時のボディパラメータを使用した認証</li>
</ul>
</div></blockquote>
<p class="last">本ガイドラインではクライアントの認証にBasic認証を利用するため上記の設定例では未指定としているが、
アプリケーション要件に沿ったパラメータの指定を行うこと。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Spring Security OAuth以外のアーキテクチャで実装されている認可サーバに対してアクセストークンの発行を依頼する場合は
リクエストパラメータが上記とは異なる可能性があるため注意されたい。
その場合はアーキテクチャの仕様を確認し、必要なリクエストパラメータを設定されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthaccessofresourceserver">
<span id="id42"></span><h5><a class="toc-backref" href="#id177">9.9.2.3.3.4. リソースサーバへのアクセス</a><a class="headerlink" href="#oauthaccessofresourceserver" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を用いてリソースサーバへアクセスする方法を説明する。</p>
<p>認可サーバへのアクセスは<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>と<code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>により隠蔽されるため、開発の際には
認可サーバを意識する必要がなく、リソースサーバが提供するREST APIに対して行う処理を、通常のREST APIへのアクセスと同様に記述する。</p>
<p>以下にServiceクラスの実装例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">org.springframework.web.client.RestOperations</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">RestOperations</span> <span class="n">restOperations</span><span class="p">;</span> <span class="c1">// (1)</span>

    <span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${resource.serverUrl}/api/v1/todos&quot;</span><span class="p">)</span>
    <span class="n">String</span> <span class="n">url</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">getTodoList</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Todo</span><span class="o">[]</span> <span class="n">todoArray</span> <span class="o">=</span> <span class="n">restOperations</span><span class="p">.</span>
            <span class="nf">getForObject</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">Todo</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">);</span> <span class="c1">// (2)</span>
        <span class="k">return</span> <span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="n">todoArray</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RestOperations</span></code>をインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">指定したURLにRESTでメソッドGETでアクセスし結果をリストで受け取る。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を使用してリソースサーバにアクセスしようとした時点でアクセストークンが発行されていない場合、
一度認可サーバにリダイレクトされる。
その後、アクセストークンの発行が完了するとクライアントへリダイレクトされ、再度リソースサーバへのアクセス処理が呼び出される形となる。
この時、クライアントへのリダイレクトはGETにより行われるため、認可サーバからリダイレクトされる可能性のあるControllerはGETを許容する必要がある。</p>
<p class="last">また、リダイレクト前のリソースサーバへのアクセスがPOSTである場合、リダイレクト後のGETではパラメータが失われてしまう。
その場合、POSTパラメータをセッションに保持する等の対処が必要となるため、注意すること。
本ガイドラインでは、具体的な対処方法の説明については割愛する。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Spring Securityを利用している場合、ユーザが認証されていない状態で<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を使用して
アクセストークンを取得しようとすると<code class="docutils literal"><span class="pre">org.springframework.security.authentication.InsufficientAuthenticationException</span></code>が発生するため、<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を使用するパスでは必ずユーザが既に認証されていることを確認されたい。</p>
<p>具体的には、以下のいずれかが実施されていることを確認すれば良い。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を使用するServiceメソッドに対して、<code class="docutils literal"><span class="pre">&#64;PreAuthorize</span></code>により認証済みのチェックをしていること</li>
<li><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を使用するパスに対して、<code class="docutils literal"><span class="pre">&lt;sec:intercept-url&gt;</span></code>により認証済みのチェックをしていること</li>
</ul>
<p>詳細は <a class="reference internal" href="Authorization.html#authorizationtowebresources"><span class="std std-ref">Webリソースへの認可</span></a>及び<a class="reference internal" href="Authorization.html#authorizationtomethod"><span class="std std-ref">メソッドへの認可</span></a>を参照されたい。</p>
<p class="last">なお、クライアントがリソースオーナとなるためリソースオーナの認証を必要としないクライアントクレデンシャルグラントと、
<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を使用しないインプリシットグラントの場合はエラーが発生しない。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthclientserverhowtocanceltoken">
<span id="id43"></span><h5><a class="toc-backref" href="#id178">9.9.2.3.3.5. トークンの取り消し（クライアントサーバ）</a><a class="headerlink" href="#oauthclientserverhowtocanceltoken" title="Permalink to this headline">¶</a></h5>
<p>発行したアクセストークンの取り消しの実装方法について説明する。</p>
<div class="line-block">
<div class="line">アクセストークンの取り消しは、認可サーバにリクエストを行い、<code class="docutils literal"><span class="pre">TokenStore</span></code>からアクセストークンの削除を行う。認可サーバへのリクエスト時はクライアントのBasic認証を行うため、Basic認証用のリクエストヘッダを設定する。</div>
<div class="line">認可サーバのトークンの取り消しについては <a class="reference internal" href="#oauthauthorizationserverhowtocanceltoken"><span class="std std-ref">トークンの取り消し（認可サーバ）</span></a>を参照されたい。</div>
<div class="line">クライアントサーバはアクセストークンの取り消しを認可サーバにリクエスト後、<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>で保持しているアクセストークンを削除する必要がある。</div>
</div>
<p>以下に、実装例を示す。</p>
<p>まず、認可サーバにトークン取り消し要求を行うための<code class="docutils literal"><span class="pre">RestTemplate</span></code>の設定を設定ファイルに追記する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;revokeRestTemplate&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.web.client.RestTemplate&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;interceptors&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;list&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;basicAuthInterceptor&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;basicAuthInterceptor&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.http.client.support.BasicAuthorizationInterceptor&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">value=</span><span class="s">&quot;${api.auth.username}&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span> <span class="na">value=</span><span class="s">&quot;${api.auth.password}&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバにトークン取り消し要求を行うための<code class="docutils literal"><span class="pre">RestTemplate</span></code>をBean定義する。</div>
<div class="line">Basic認証用のリクエストヘッダを設定するため、<code class="docutils literal"><span class="pre">interceptors</span></code>プロパティに<code class="docutils literal"><span class="pre">ClientHttpRequestInterceptor</span></code>の実装クラスである<code class="docutils literal"><span class="pre">BasicAuthorizationInterceptor</span></code>を指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">BasicAuthorizationInterceptor</span></code>の設定については<a class="reference internal" href="../ArchitectureInDetail/WebServiceDetail/RestClient.html#restclientbasicauthorizationinterceptorbeandefinition"><span class="std std-ref">Basic認証用のリクエストヘッダ設定処理</span></a>を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>トークンの取り消しを行うサービスクラスのインタフェースと実装クラスを作成する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">RevokeTokenClientService.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RevokeTokenClientService</span> <span class="p">{</span>

    <span class="n">String</span> <span class="nf">revokeToken</span><span class="p">();</span>

<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">RevokeTokenClientServiceImpl.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RevokeTokenClientServiceImpl</span> <span class="kd">implements</span> <span class="n">RevokeTokenClientService</span> <span class="p">{</span>

    <span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${auth.serverUrl}/api/v1/oauth/tokens/revoke&quot;</span><span class="p">)</span>
    <span class="n">String</span> <span class="n">revokeTokenUrl</span><span class="p">;</span> <span class="c1">// (1)</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="p">(</span><span class="s">&quot;todoAuthCodeGrantResourceRestTemplate&quot;</span><span class="p">)</span>
    <span class="n">OAuth2RestOperations</span> <span class="n">oauth2RestOperations</span><span class="p">;</span> <span class="c1">// (2)</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="p">(</span><span class="s">&quot;revokeRestTemplate&quot;</span><span class="p">)</span>
    <span class="n">RestOperations</span> <span class="n">revokeRestOperations</span><span class="p">;</span> <span class="c1">// (3)</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">revokeToken</span><span class="p">()</span> <span class="p">{</span>

        <span class="n">String</span> <span class="n">tokenValue</span> <span class="o">=</span> <span class="n">getTokenValue</span><span class="p">(</span><span class="n">oauth2RestOperations</span><span class="p">);</span>

        <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">hasLength</span><span class="p">(</span><span class="n">tokenValue</span><span class="p">)){</span>
            <span class="n">HttpHeaders</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="p">();</span>
            <span class="n">headers</span><span class="p">.</span><span class="na">setContentType</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_FORM_URLENCODED</span><span class="p">);</span>
            <span class="n">MultiValueMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">variables</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedMultiValueMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
            <span class="n">variables</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;token&quot;</span><span class="p">,</span> <span class="n">tokenValue</span><span class="p">);</span>

            <span class="k">try</span> <span class="p">{</span>
                <span class="n">revokeRestOperations</span><span class="p">.</span><span class="na">postForObject</span><span class="p">(</span><span class="n">url</span><span class="p">,</span>
                        <span class="k">new</span> <span class="n">HttpEntity</span><span class="o">&lt;</span><span class="n">MultiValueMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">headers</span><span class="p">),</span>
                        <span class="n">Void</span><span class="p">.</span><span class="na">class</span><span class="p">);</span> <span class="c1">// (4)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="s">&quot;success&quot;</span><span class="p">;</span>
                <span class="n">initContextToken</span><span class="p">(</span><span class="n">oauth2RestOperations</span><span class="p">);</span> <span class="c1">// (5)</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">HttpClientErrorException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">result</span> <span class="o">=</span> <span class="s">&quot;invalid request&quot;</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="n">result</span> <span class="o">=</span><span class="s">&quot;token not exist&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (6)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="nf">getTokenValue</span><span class="p">(</span><span class="n">OAuth2RestOperations</span> <span class="n">oauth2RestOperations</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">OAuth2AccessToken</span> <span class="n">token</span> <span class="o">=</span> <span class="n">restOperations</span><span class="p">.</span><span class="na">getOAuth2ClientContext</span><span class="p">()</span>
                <span class="p">.</span><span class="na">getAccessToken</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">token</span><span class="p">.</span><span class="na">getValue</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// (7)</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">initContextToken</span><span class="p">(</span><span class="n">OAuth2RestOperations</span> <span class="n">oauth2RestOperations</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">oauth2RestOperations</span><span class="p">.</span><span class="na">getOAuth2ClientContext</span><span class="p">().</span><span class="na">setAccessToken</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークンの取り消しを認可サーバに依頼する際に使用するURL。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取り消しを行うアクセストークンを保持している<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>をインジェクションする。</div>
<div class="line"><code class="docutils literal"><span class="pre">RestOperations</span></code>の実装が複数存在するため、<code class="docutils literal"><span class="pre">&#64;Named</span></code>でBean名を指定してインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークンの取り消しを行う<code class="docutils literal"><span class="pre">RestTemplate</span></code>をインジェクションする。</div>
<div class="line"><code class="docutils literal"><span class="pre">RestOperations</span></code>の実装が複数存在するため、<code class="docutils literal"><span class="pre">&#64;Named</span></code>でBean名を指定してインジェクションする</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバにアクセストークンの取り消しを行うために、RESTでメソッドPOSTでアクセスする。</div>
<div class="line">取り消しを行うアクセストークンの値を認可サーバに渡すためにリクエストパラメータに設定する。</div>
<div class="line">アクセストークンは(6)で定義している<code class="docutils literal"><span class="pre">getTokenValue</span></code>メソッドに<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.client.OAuth2RestOperations</span></code>を渡して取得する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2RestOperations</span></code>で保持しているアクセストークンを削除する。</div>
<div class="line">アクセストークンの削除は(7)で定義している<code class="docutils literal"><span class="pre">initContextToken</span></code>メソッドにアクセストークンを保持している<code class="docutils literal"><span class="pre">OAuth2RestOperations</span></code>を渡して削除する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2RestOperations</span></code>で保持しているアクセストークンを取得するメソッド。</div>
<div class="line">パラメータとして渡された<code class="docutils literal"><span class="pre">OAuth2RestOperations</span></code>の<code class="docutils literal"><span class="pre">getAccessToken</span></code>メソッドを呼び出すことでアクセストークンを取得し、返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2RestOperations</span></code>で保持しているアクセストークンを削除するメソッド。</div>
<div class="line">パラメータとして渡された<code class="docutils literal"><span class="pre">OAuth2RestOperations</span></code>の<code class="docutils literal"><span class="pre">setAccessToken</span></code>メソッドにnullを渡すことでアクセストークンを削除する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">クライアントは上記で作成したサービスをアクセストークンが不要になったタイミングで呼び出すことでトークンの取り消しを行う。</div>
<div class="line">Spring Security OAuthのデフォルト実装ではセッションスコープでアクセストークンを保持するため、クライアントのユーザがログアウトした場合やセッションタイムアウトによってセッションが破棄されるタイミングでトークンの取り消しを行うことが考えられる。</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Spring Security OAuth以外のアーキテクチャで実装されている認可サーバでは、アクセストークンの削除をREST APIで受け付けていない場合がある。</p>
<p class="last">その場合は認可サーバのアーキテクチャ仕様を確認し、適切に実装する必要がある。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthclienterrorhandlingwithcode">
<span id="id44"></span><h5><a class="toc-backref" href="#id179">9.9.2.3.3.6. エラーハンドリング</a><a class="headerlink" href="#oauthclienterrorhandlingwithcode" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を用いた認可サーバ、リソースサーバへのアクセス時に発生するエラーのハンドリング方法について説明する。</p>
<div class="section" id="oauthclienthandleerrorwhenaccessingauthorizationendpointwithcode">
<span id="id45"></span><h6><a class="toc-backref" href="#id180">9.9.2.3.3.6.1. 認可エンドポイントアクセス時のエラーハンドリング</a><a class="headerlink" href="#oauthclienthandleerrorwhenaccessingauthorizationendpointwithcode" title="Permalink to this headline">¶</a></h6>
<p>認可エンドポイントで発生するエラーは不正アクセスエラーと不正クライアントエラー以外の例外に分類される。
不正クライアントエラーの詳細については、<a class="reference internal" href="#definitionofbadclienterror"><span class="std std-ref">不正クライアントエラー</span></a>を参照されたい。
不正クライアントエラーが発生した場合のエラーハンドリングは、<a class="reference internal" href="#oauthauthorizationserverhowtohandleerror"><span class="std std-ref">認可リクエスト時のエラー画面のカスタマイズ</span></a>を参照されたい。
本節では不正クライアントエラー以外エラーが発生した場合のエラーハンドリングについて説明する。</p>
<p>クライアントに通知されるエラーでハンドリングが必要なものは以下となる。</p>
<table border="1" class="colwidths-given longtable docutils" id="id118">
<caption><span class="caption-text"><strong>認可エンドポイントで発生するエラー</strong></span><a class="headerlink" href="#id118" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">発生するエラー</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナによる認可拒否</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.common.exceptions.UserDeniedAuthorizationException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナがスコープ認可画面で、クライアントが指定したスコープを全て拒否した場合に発生する。</div>
<div class="line">リダイレクトURIのリクエストパラメータに、<code class="docutils literal"><span class="pre">error=access_denied</span></code>と<code class="docutils literal"><span class="pre">error_description=User</span> <span class="pre">denied</span> <span class="pre">access</span></code>が設定される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>エラー時のレスポンスで扱うリクエストパラメータについて</strong></p>
<p class="last">RFC 6749の<a class="reference external" href="https://tools.ietf.org/html/rfc6749#section-4.1.2.1">4.1.2.1. Error Response</a>に定められている通り、
OAuth 2.0ではエラー時のレスポンスにリクエストパラメータ<code class="docutils literal"><span class="pre">error</span></code>および<code class="docutils literal"><span class="pre">error_description</span></code>を含む。
このため業務実装時にこれらの名前のパラメータを使用していると、パラメータ名が競合してしまう場合があることに注意されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>上記の<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>によってスローされる例外に対するハンドリング処理を実装する必要がある。
本ガイドラインでは、以下の要件に沿ってエラーハンドリングの実装を行う。</p>
<ul>
<li><dl class="first docutils">
<dt>リソースオーナの操作に起因する例外かどうか判断して、エラー画面を変更する</dt>
<dd><p class="first">認可サーバで発生する例外は、認可拒否などリソースオーナの操作に起因する例外と、
クライアントが指定したスコープが認可サーバのクライアント情報に存在しないなどのアプリケーションの不備に起因する例外に分類できる。
例外の分類に基づき、以下のように適切にハンドリングする必要がある。</p>
<ul class="last simple">
<li>リソースオーナの操作に起因する例外は「アクセス拒否画面」に遷移し、業務の再実施を促す</li>
<li>アプリケーションの不備に起因しない例外は「システムエラー画面」に遷移し、アプリケーションの設定を見直すよう促す</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>URLへの不要なパラメータの露出を防止するため、エラー画面にリダイレクトする</dt>
<dd><p class="first">認可コードグラントやインプリシットグラントのフローでは、URLパラメータに以下のパラメータを付与するが、フローの途中でエラーが発生した場合、
そのままエラー画面にフォワードするとブラウザのアドレスバーなどにパラメータが露出してしまう。
これを防止するために、エラー画面にリダイレクトする必要がある。</p>
<ul class="simple">
<li><dl class="first docutils">
<dt>認可コード（認可コードグラントのみ）</dt>
<dd>認可コードの発行からアクセストークン発行までの間にエラーが発生した場合</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">state</span></code>パラメータ</dt>
<dd>認可リクエストからリソースオーナの認可完了までにエラーが発生した場合</dd>
</dl>
</li>
</ul>
<p class="last">認可コードグラントやインプリシットグラント以外のグラントタイプでは、上記パラメータを使用しないためリダイレクトではなくフォワードを使用してもよい。</p>
</dd>
</dl>
</li>
</ul>
<p>以下に、リソースオーナの認可拒否による<code class="docutils literal"><span class="pre">UserDeniedAuthorizationException</span></code>をハンドリングしてアクセス拒否画面に遷移する例を示す。</p>
<p>なお、システムエラー画面に遷移するハンドリングも同様に実装する必要がある。
ハンドリング対象の例外については、<a class="reference internal" href="#oauthappendixoccuringerrors"><span class="std std-ref">クライアントから認可サーバ、リソースサーバアクセス時に発生するエラー</span></a>を参照されたい。
また、例では<code class="docutils literal"><span class="pre">UserDeniedAuthorizationException</span></code>をアプリケーション全体で共通的にハンドリングすることを想定して、
<code class="docutils literal"><span class="pre">&#64;ControllerAdvice</span></code>アノテーションを使用している。詳細は<a class="reference internal" href="../ImplementationAtEachLayer/ApplicationLayer.html#application-layer-controller-advice"><span class="std std-ref">&#64;ControllerAdviceの実装</span></a>を参照されたい。</p>
<p>以下に実装例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2ExceptionHandler</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">UserDeniedAuthorizationException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">handleUserDeniedAuthorizationException</span><span class="p">(</span>
            <span class="n">UserDeniedAuthorizationException</span> <span class="n">e</span><span class="p">,</span> <span class="n">RedirectAttributes</span> <span class="n">attributes</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// omitted</span>
        <span class="n">attributes</span><span class="p">.</span><span class="na">addFlashAttribute</span><span class="p">(</span><span class="s">&quot;exception&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
        <span class="k">return</span> <span class="s">&quot;redirect:/oauthAccessDeniedError&quot;</span><span class="p">;</span> <span class="c1">// (2)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">コントローラで発生したエラーをハンドリングする。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></code>のパラメータに指定されている<code class="docutils literal"><span class="pre">UserDeniedAuthorizationException</span></code>が発生した場合に実行される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可コードや<code class="docutils literal"><span class="pre">state</span></code>パラメータを隠蔽するためリダイレクトを行う。</div>
<div class="line">リダイレクト先に例外を引き渡す場合は、<code class="docutils literal"><span class="pre">RedirectAttributes</span></code>の<code class="docutils literal"><span class="pre">addFlashAttribute</span></code>メソッドを使用して引き渡す例外を設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>また、<code class="docutils literal"><span class="pre">OAuth2ExceptionHandler</span></code>の<code class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></code>にてリダイレクトを行うため、
リダイレクト先のパス<code class="docutils literal"><span class="pre">/oauthAccessDeniedError</span></code>に対応するコントローラを定義する必要がある。</p>
<p>以下にコントローラの定義例を示す。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">OAuth2ErrorController.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2ErrorController</span> <span class="p">{</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;/oauthAccessDeniedError&quot;</span><span class="p">)</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">handleAccessDeniedError</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;common/error/accessDeniedError&quot;</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>アノテーションを使用して、<code class="docutils literal"><span class="pre">/oauthAccessDeniedError</span></code>へのアクセスに対するメソッドとしてマッピングを行う。</div>
<div class="line"><code class="docutils literal"><span class="pre">/oauthAccessDeniedError</span></code>が呼び出された場合、アクセス拒否画面を表示する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthclienthandleerrorwhenaccessingtokenendpointwithcode">
<span id="id47"></span><h6><a class="toc-backref" href="#id181">9.9.2.3.3.6.2. トークンエンドポイント及びリソースサーバアクセス時のエラーハンドリング</a><a class="headerlink" href="#oauthclienthandleerrorwhenaccessingtokenendpointwithcode" title="Permalink to this headline">¶</a></h6>
<p>認可コードグラントではトークンエンドポイントおよびリソースサーバで発生するエラーはすべてシステムエラーとして扱えば良い。
発生するエラーについては <a class="reference internal" href="#oauthappendixoccuringerrors"><span class="std std-ref">クライアントから認可サーバ、リソースサーバアクセス時に発生するエラー</span></a>を参照されたい。
また、エラーハンドリングについては<a class="reference internal" href="#oauthclienthandleerrorwhenaccessingauthorizationendpointwithcode"><span class="std std-ref">認可エンドポイントアクセス時のエラーハンドリング</span></a>を参照されたい。</p>
</div>
</div>
</div>
</div>
<div class="section" id="implementationimplicitgrant">
<span id="id48"></span><h3><a class="toc-backref" href="#id182">9.9.2.4. インプリシットグラントの実装</a><a class="headerlink" href="#implementationimplicitgrant" title="Permalink to this headline">¶</a></h3>
<p>インプリシットグラントを利用した認可サーバ、リソースサーバ、クライアントの実装方法について解説する。</p>
<p>解説は認可コードグラントからの変更点のみを対象に行っている。変更点以外の実装、解説については<a class="reference internal" href="#implementationautorizationcodegrant"><span class="std std-ref">認可コードグラントの実装</span></a>を参照されたい。</p>
<p>以下に認可コードグラントの実装から各サーバを実装する際の変更点を示す。</p>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="30%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">サーバ</th>
<th class="head">認可コードグラントからの変更点</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">認可サーバ</th>
<td><a class="reference internal" href="#oauthauthorizationserverdefinition"><span class="std std-ref">認可サーバの定義</span></a></td>
</tr>
<tr class="row-odd"><th class="stub">リソースサーバ</th>
<td>なし</td>
</tr>
<tr class="row-even"><th class="stub">クライアント</th>
<td><a class="reference internal" href="#implementationoauthclientserverofautorizationcode"><span class="std std-ref">クライアントの実装</span></a>の全て</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="implementationoauthauthorizationserverofimplicit">
<span id="id49"></span><h4><a class="toc-backref" href="#id183">9.9.2.4.1. 認可サーバの実装</a><a class="headerlink" href="#implementationoauthauthorizationserverofimplicit" title="Permalink to this headline">¶</a></h4>
<p>認可コードグラントの実装から<code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>を変更する必要がある。</p>
<p><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>以外の実装は<a class="reference internal" href="#implementationoauthauthorizationserverofautorizationcode"><span class="std std-ref">認可サーバの実装</span></a>を参照し作成されたい。</p>
<div class="section" id="id50">
<h5><a class="toc-backref" href="#id184">9.9.2.4.1.1. 認可サーバの定義</a><a class="headerlink" href="#id50" title="Permalink to this headline">¶</a></h5>
<p>認可コードグラントからの<code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>の変更点を以下に示す。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
    <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span>
    <span class="na">user-approval-handler-ref=</span><span class="s">&quot;userApprovalHandler&quot;</span>
    <span class="na">token-services-ref=</span><span class="s">&quot;tokenServices&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;oauth2:implicit</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;oauth2:implicit</span> <span class="pre">/&gt;</span></code>タグを使用して、インプリシットグラントをサポートする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><code class="docutils literal"><span class="pre">&lt;oauth2:implicit</span> <span class="pre">/&gt;</span></code>タグと<code class="docutils literal"><span class="pre">&lt;oauth2:refresh-token</span> <span class="pre">/&gt;</span></code>タグは上記の順番で設定する必要がある。</p>
<p class="last">詳細は<a class="reference internal" href="#orderofauthoraizationserversupportsetting"><span class="std std-ref">認可サーバで複数のグラントタイプをサポートする場合</span></a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="implementationoauthresourceserverofimplicit">
<span id="id51"></span><h4><a class="toc-backref" href="#id185">9.9.2.4.2. リソースサーバの実装</a><a class="headerlink" href="#implementationoauthresourceserverofimplicit" title="Permalink to this headline">¶</a></h4>
<p>認可コードグラントの実装から変更は不要である。</p>
<p>実装は<a class="reference internal" href="#implementationoauthresourceserverofautorizationcode"><span class="std std-ref">リソースサーバの実装</span></a>を参照し作成されたい。</p>
</div>
<div class="section" id="implementationoauthclientserverofimplicit">
<span id="id52"></span><h4><a class="toc-backref" href="#id186">9.9.2.4.3. クライアントの実装</a><a class="headerlink" href="#implementationoauthclientserverofimplicit" title="Permalink to this headline">¶</a></h4>
<p>インプリシットグラントでは一般的にJavaScriptなどで実装されたクライアントが採用される。</p>
<p>Spring Security OAuthではJava以外のライブラリを提供していないため、本ガイドラインではJavaScriptを用いて独自にクライアントを実装する方法について解説する。</p>
<div class="section" id="javascript">
<span id="oauthclientusingjavascript"></span><h5><a class="toc-backref" href="#id187">9.9.2.4.3.1. JavaScriptを使用したリソースサーバへのアクセス</a><a class="headerlink" href="#javascript" title="Permalink to this headline">¶</a></h5>
<p>本ガイドラインでは、インプリシットグラント向けのクライアントの実装として、JavaScriptを使用してリソースサーバから
JSON形式のデータを取得し、画面に表示させる方法を説明する。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">以降に説明する実装例ではJavaScriptライブラリとしてjQuery(バージョン3.1.1)を使用する。
JQueryは<code class="docutils literal"><span class="pre">src/main/webapp/resources/vendor</span></code>に格納し、作成したJavaScriptファイルは、<code class="docutils literal"><span class="pre">src/main/webapp/resources/app/js</span></code>に格納する。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>アクセストークンの格納先</strong></p>
<p>HTML5準拠のブラウザを利用する場合、アクセストークンの格納先の代表的な例として、ローカルストレージとセッションストレージが挙げられる。</p>
<p>以下にローカルストレージとセッションストレージの保持期間、用途を示す。</p>
<blockquote>
<div><table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="15%" />
<col width="20%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">格納先</th>
<th class="head">保持期間</th>
<th class="head">用途</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">ローカルストレージ</th>
<td>明示的にクリアするまで</td>
<td>端末のブラウザを一人のユーザのみが利用する場合で、アクセストークンの発行回数を減らし、サービスの利便性を向上させたい場合</td>
</tr>
<tr class="row-odd"><th class="stub">セッションストレージ</th>
<td>タブやブラウザを閉じるまで</td>
<td>端末のブラウザを複数のユーザが共用で利用する場合で、アクセストークンの不正利用を防止し、セキュリティを強化したい場合</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p class="last">本実装例ではローカルストレージを採用する例を紹介する。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>以下にOAuth 2.0機能を独自に実装したJavaScriptと、それを利用したクライアントの実装例を示す。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2.js</span></code></li>
</ul>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">oauth2Func</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">exp</span><span class="p">,</span> <span class="nx">$</span><span class="p">)</span> <span class="p">{</span>
    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

    <span class="kd">var</span>
        <span class="nx">config</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">DEFAULT_LIFETIME</span> <span class="o">=</span> <span class="mi">3600</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">uuid</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">&quot;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&quot;</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[xy]/g</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">16</span><span class="o">|</span><span class="mi">0</span><span class="p">,</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">c</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span> <span class="o">?</span> <span class="nx">r</span> <span class="o">:</span> <span class="p">(</span><span class="nx">r</span><span class="o">&amp;</span><span class="mh">0x3</span><span class="o">|</span><span class="mh">0x8</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">v</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">encodeURL</span><span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nx">k</span> <span class="k">in</span> <span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">res</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">i</span><span class="o">++</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">?</span> <span class="s2">&quot;?&quot;</span> <span class="o">:</span> <span class="s2">&quot;&amp;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">params</span><span class="p">[</span><span class="nx">k</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">epoch</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span><span class="o">/</span><span class="mf">1000.0</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">parseQueryString</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">qs</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">e</span><span class="p">,</span>
            <span class="nx">a</span> <span class="o">=</span> <span class="sr">/\+/g</span><span class="p">,</span>
            <span class="nx">r</span> <span class="o">=</span> <span class="sr">/([^&amp;;=]+)=?([^&amp;;]*)/g</span><span class="p">,</span>
            <span class="nx">d</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">));</span> <span class="p">},</span>
            <span class="nx">q</span> <span class="o">=</span> <span class="nx">qs</span><span class="p">,</span>
            <span class="nx">urlParams</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="k">while</span> <span class="p">(</span><span class="nx">e</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">q</span><span class="p">))</span> <span class="p">{</span>
           <span class="nx">urlParams</span><span class="p">[</span><span class="nx">d</span><span class="p">(</span><span class="nx">e</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="nx">d</span><span class="p">(</span><span class="nx">e</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">urlParams</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">saveState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s2">&quot;state-&quot;</span> <span class="o">+</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">obj</span><span class="p">));</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">getState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s2">&quot;state-&quot;</span> <span class="o">+</span> <span class="nx">state</span><span class="p">));</span>
        <span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="s2">&quot;state-&quot;</span> <span class="o">+</span> <span class="nx">state</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">hasScope</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">scope</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">token</span><span class="p">.</span><span class="nx">scopes</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">token</span><span class="p">.</span><span class="nx">scopes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">scopes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">scope</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">filterTokens</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tokens</span><span class="p">,</span> <span class="nx">scopes</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (1)</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">scopes</span><span class="p">)</span> <span class="nx">scopes</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">,</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">now</span> <span class="o">=</span> <span class="nx">epoch</span><span class="p">(),</span>
        <span class="nx">usethis</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">usethis</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">tokens</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">expires</span> <span class="o">&amp;&amp;</span> <span class="nx">tokens</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">expires</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">now</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="nx">usethis</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

            <span class="k">for</span><span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">scopes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasScope</span><span class="p">(</span><span class="nx">tokens</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">scopes</span><span class="p">[</span><span class="nx">j</span><span class="p">]))</span> <span class="nx">usethis</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">usethis</span><span class="p">)</span> <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tokens</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">saveTokens</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s2">&quot;tokens-&quot;</span> <span class="o">+</span> <span class="nx">providerId</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">tokens</span><span class="p">));</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">getTokens</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">providerId</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s2">&quot;tokens-&quot;</span> <span class="o">+</span> <span class="nx">providerId</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">tokens</span><span class="p">)</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="k">return</span> <span class="nx">tokens</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">wipeTokens</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">providerId</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="s2">&quot;tokens-&quot;</span> <span class="o">+</span> <span class="nx">providerId</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">saveToken</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">token</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (2)</span>
        <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">getTokens</span><span class="p">(</span><span class="nx">providerId</span><span class="p">);</span>
        <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">filterTokens</span><span class="p">(</span><span class="nx">tokens</span><span class="p">);</span>
        <span class="nx">tokens</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
        <span class="nx">saveTokens</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">getToken</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">scopes</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">getTokens</span><span class="p">(</span><span class="nx">providerId</span><span class="p">);</span>
        <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">filterTokens</span><span class="p">(</span><span class="nx">tokens</span><span class="p">,</span> <span class="nx">scopes</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">tokens</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">sendAuthRequest</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">scopes</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (3)</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">config</span><span class="p">[</span><span class="nx">providerId</span><span class="p">])</span> <span class="k">throw</span> <span class="s2">&quot;Could not find configuration for provider &quot;</span> <span class="o">+</span> <span class="nx">providerId</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">co</span> <span class="o">=</span> <span class="nx">config</span><span class="p">[</span><span class="nx">providerId</span><span class="p">];</span>

        <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">uuid</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;response_type&quot;</span><span class="o">:</span> <span class="s2">&quot;token&quot;</span>
        <span class="p">};</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">state</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">co</span><span class="p">[</span><span class="s2">&quot;redirectUrl&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;redirect_uri&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">co</span><span class="p">[</span><span class="s2">&quot;redirectUrl&quot;</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">co</span><span class="p">[</span><span class="s2">&quot;clientId&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;client_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">co</span><span class="p">[</span><span class="s2">&quot;clientId&quot;</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">scopes</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;scope&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">scopes</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">authurl</span> <span class="o">=</span> <span class="nx">encodeURL</span><span class="p">(</span><span class="nx">co</span><span class="p">.</span><span class="nx">authorization</span><span class="p">,</span> <span class="nx">request</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;restoreHash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;providerId&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">providerId</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">scopes</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;scopes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">scopes</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">saveState</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">request</span><span class="p">);</span>
        <span class="nx">redirect</span><span class="p">(</span><span class="nx">authurl</span><span class="p">);</span>

    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">checkForToken</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">providerId</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (4)</span>
        <span class="kd">var</span> <span class="nx">h</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (5)</span>
            <span class="nx">h</span> <span class="o">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">errorinfo</span> <span class="o">=</span> <span class="nx">parseQueryString</span><span class="p">(</span><span class="nx">h</span><span class="p">);</span>
            <span class="nx">handleError</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">errorinfo</span><span class="p">);</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;access_token&quot;</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">h</span> <span class="o">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">atoken</span> <span class="o">=</span> <span class="nx">parseQueryString</span><span class="p">(</span><span class="nx">h</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">atoken</span><span class="p">.</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">getState</span><span class="p">(</span><span class="nx">atoken</span><span class="p">.</span><span class="nx">state</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">state</span><span class="p">)</span> <span class="k">throw</span> <span class="s2">&quot;Could not retrieve state&quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">state</span><span class="p">.</span><span class="nx">providerId</span><span class="p">)</span> <span class="k">throw</span> <span class="s2">&quot;Could not get providerId from state&quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">config</span><span class="p">[</span><span class="nx">state</span><span class="p">.</span><span class="nx">providerId</span><span class="p">])</span> <span class="k">throw</span> <span class="s2">&quot;Could not retrieve config for this provider.&quot;</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">now</span> <span class="o">=</span> <span class="nx">epoch</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;expires_in&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;expires&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">now</span> <span class="o">+</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;expires_in&quot;</span><span class="p">]);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;expires&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">now</span> <span class="o">+</span> <span class="nx">DEFAULT_LIFETIME</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;scope&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;scopes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;scope&quot;</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">[</span><span class="s2">&quot;scopes&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;scopes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">state</span><span class="p">[</span><span class="s2">&quot;scopes&quot;</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="nx">saveToken</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">atoken</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">restoreHash</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">restoreHash</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">handleError</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">cause</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (6)</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">config</span><span class="p">[</span><span class="nx">providerId</span><span class="p">])</span> <span class="k">throw</span> <span class="s2">&quot;Could not retrieve config for this provider.&quot;</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">co</span> <span class="o">=</span> <span class="nx">config</span><span class="p">[</span><span class="nx">providerId</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">errorDetail</span> <span class="o">=</span> <span class="nx">cause</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">errorDescription</span> <span class="o">=</span> <span class="nx">cause</span><span class="p">[</span><span class="s2">&quot;error_description&quot;</span><span class="p">];</span>

        <span class="c1">// redirect error page</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">co</span><span class="p">[</span><span class="s2">&quot;errRedirectUrl&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">errorDetail</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">errorDetail</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">errorDescription</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;error_description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">errorDescription</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">redirect</span><span class="p">(</span><span class="nx">encodeURL</span><span class="p">(</span><span class="nx">co</span><span class="p">[</span><span class="s2">&quot;errRedirectUrl&quot;</span><span class="p">],</span> <span class="nx">request</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Access Error. cause: &quot;</span> <span class="o">+</span> <span class="nx">errorDetail</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
                    <span class="o">+</span> <span class="nx">errorDescription</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>


    <span class="kd">var</span> <span class="nx">redirect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">initialize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">config</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">providerId</span><span class="p">;</span>
            <span class="k">for</span><span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">providerId</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">checkForToken</span><span class="p">(</span><span class="nx">providerId</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Error when retrieving token from hash: &quot;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">);</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">clearTokens</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (7)</span>
        <span class="kd">var</span> <span class="nx">key</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">wipeTokens</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">oajax</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">settings</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (8)</span>
        <span class="kd">var</span> <span class="nx">providerId</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">providerId</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">scopes</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">scopes</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">getToken</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">scopes</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">sendAuthRequest</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">scopes</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">settings</span><span class="p">.</span><span class="nx">headers</span><span class="p">)</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">headers</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="nx">settings</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;Authorization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Bearer &quot;</span> <span class="o">+</span> <span class="nx">token</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">];</span>

        <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="nx">settings</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">parseFailureJSON</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (9)</span>
        <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">responseJSON</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">error</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">errorDescription</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">error_description</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">co</span> <span class="o">=</span> <span class="nx">config</span><span class="p">[</span><span class="nx">providerId</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span> <span class="o">===</span> <span class="s2">&quot;invalid_token&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">errorDescription</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">getTokens</span><span class="p">(</span><span class="nx">providerId</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">token</span> <span class="k">of</span> <span class="nx">tokens</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">errorDescription</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">token</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">errorDescription</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;Invalid access token&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="c1">// clear expired tokens</span>
                        <span class="nx">wipeTokens</span><span class="p">(</span><span class="nx">providerId</span><span class="p">)</span>

                        <span class="c1">// redirect for get access token</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">co</span><span class="p">[</span><span class="s2">&quot;redirectUrl&quot;</span><span class="p">])</span> <span class="p">{</span>
                            <span class="nx">redirect</span><span class="p">(</span><span class="nx">co</span><span class="p">[</span><span class="s2">&quot;redirectUrl&quot;</span><span class="p">]);</span>
                            <span class="k">return</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">co</span><span class="p">[</span><span class="s2">&quot;errRedirectUrl&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">error</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">errorDescription</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;error_description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">errorDescription</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">redirect</span><span class="p">(</span><span class="nx">encodeURL</span><span class="p">(</span><span class="nx">co</span><span class="p">[</span><span class="s2">&quot;errRedirectUrl&quot;</span><span class="p">],</span> <span class="nx">request</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Access Error. cause: &quot;</span> <span class="o">+</span> <span class="nx">error</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">errorDescription</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">initialize</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="nx">clearTokens</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">clearTokens</span><span class="p">();</span>
        <span class="p">},</span>
        <span class="nx">oajax</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">oajax</span><span class="p">(</span><span class="nx">settings</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="nx">parseFailureJSON</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">parseFailureJSON</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

<span class="p">})(</span><span class="nb">window</span><span class="p">,</span> <span class="nx">jQuery</span><span class="p">);</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントが使用可能なアクセストークンを判別し返却する関数(<code class="docutils literal"><span class="pre">filterTokens</span></code>)。</div>
<div class="line">ローカルストレージに格納されているアクセストークンより、有効期限が超過しておらず、かつパラメータで指定されたスコープと一致するものを返却する。</div>
<div class="line">スコープが指定されていない場合は有効期限が超過していないアクセストークンを返却する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ローカルストレージにアクセストークンを格納する関数(<code class="docutils literal"><span class="pre">saveToken</span></code>)。</div>
<div class="line">後述するコンフィギュレーション情報の<code class="docutils literal"><span class="pre">providerId</span></code>を引数として受け取り、アクセストークンの配列をローカルストレージに格納する際のキーにする。</div>
<div class="line">アクセストークンの配列は<code class="docutils literal"><span class="pre">filterTokens</span></code>から得たアクセストークンに、引数の<code class="docutils literal"><span class="pre">token</span></code>を加えたものである。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバに対して認可を要求する関数(<code class="docutils literal"><span class="pre">sendAuthRequest</span></code>)。</div>
<div class="line">コンフィギュレーション情報より必要パラメータを取得し、リクエストを作成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可の応答よりアクセストークンを取得する関数(<code class="docutils literal"><span class="pre">checkForToken</span></code>)。</div>
<div class="line">URLのハッシュで返却される認可の応答を検証し、正常である場合は<code class="docutils literal"><span class="pre">saveToken</span></code>を用いてローカルストレージに情報を格納する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可の結果、エラーが返却された場合エラー処理として<code class="docutils literal"><span class="pre">handleError</span></code>を呼び出す。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可時のエラーを処理する関数(<code class="docutils literal"><span class="pre">handleError</span></code>)。</div>
<div class="line">本ガイドラインでは、エラー処理の実装例としてコンフィギュレーション情報にて指定されている
エラー時のリダイレクト先URLへのリダイレクトを行っている。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ローカルストレージに格納されているアクセストークンをクリアする関数(<code class="docutils literal"><span class="pre">clearTokens</span></code>)。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースサーバに対してリソースへのアクセスを要求する関数(<code class="docutils literal"><span class="pre">oajax</span></code>)。</div>
<div class="line">ローカルストレージよりアクセストークンを取得し、jQueryの<code class="docutils literal"><span class="pre">ajax</span></code>関数を用いてリソースサーバへリクエストを行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line"><code class="docutils literal"><span class="pre">ajax</span></code>関数でエラーが発生した場合に返却されるJSONを解析して遷移先を決定する関数(<code class="docutils literal"><span class="pre">parseFailureJSON</span></code>)。</div>
<div class="line">アクセストークンが有効期限切れかどうか判断し、有効期限切れの場合はアクセストークンを削除して再度画面表示を行う。</div>
<div class="line">例として、以下の条件で有効期限切れを判断することが可能である。</div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">error</span></code>：<code class="docutils literal"><span class="pre">invalid_token</span></code>であること</li>
<li><code class="docutils literal"><span class="pre">error_description</span></code>：アクセストークンを含み、かつ、<code class="docutils literal"><span class="pre">Invalid</span> <span class="pre">access</span> <span class="pre">token</span></code>を含まないこと</li>
</ul>
<div class="line-block">
<div class="line">有効期限切れでない場合は、エラー時のリダイレクト先URLに<code class="docutils literal"><span class="pre">error</span></code>と<code class="docutils literal"><span class="pre">error_description</span></code>を付与してリダイレクトを行う。</div>
</div>
<div class="last admonition note">
<p class="first admonition-title">Note</p>
<p><strong>判定条件について</strong></p>
<p>上記の判定条件はSpring Security OAuthの仕様で定義されたものではない。
あくまで現状の<code class="docutils literal"><span class="pre">TokenServices</span></code>の実装に基づいたワークアラウンド的な判定条件であり、
今後のSpring Security OAuthの実装変更に合わせて変更が必要となる可能性がある点に留意されたい。</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/spring-projects/spring-security-oauth/blob/2.5.0.RELEASE/spring-security-oauth2/src/main/java/org/springframework/security/oauth2/provider/token/DefaultTokenServices.java#L255">DefaultTokenServices</a>：有効期限切れを示す<code class="docutils literal"><span class="pre">expired</span></code>という文字列とアクセストークンを返却する</li>
<li><a class="reference external" href="https://github.com/spring-projects/spring-security-oauth/blob/2.5.0.RELEASE/spring-security-oauth2/src/main/java/org/springframework/security/oauth2/provider/token/RemoteTokenServices.java#L135">RemoteTokenServices</a>：有効期限切れを明確に判断できる文字列はなくアクセストークンのみ返却する</li>
</ul>
<p>もし、リソースサーバが<code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>を使用しない場合は、以下の条件に緩和することが出来る。</p>
<ul class="last simple">
<li><code class="docutils literal"><span class="pre">error</span></code>：<code class="docutils literal"><span class="pre">invalid_token</span></code>であること</li>
<li><code class="docutils literal"><span class="pre">error_description</span></code>：<code class="docutils literal"><span class="pre">expired</span></code>を含むこと</li>
</ul>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>クライアントの画面を表示するコントローラの実装例を示す。
アクセスする認可サーバやリソースサーバのURLを可変とするため、コントローラでプロパティや環境変数からURLを取得し、画面に連携する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">TodoController.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoListController</span> <span class="p">{</span>

    <span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${client.serverUrl}&quot;</span><span class="p">)</span> <span class="c1">// (1)</span>
    <span class="n">String</span> <span class="n">applicationContextUrl</span><span class="p">;</span>

    <span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${auth.serverUrl}&quot;</span><span class="p">)</span> <span class="c1">// (2)</span>
    <span class="n">String</span> <span class="n">authServerUrl</span><span class="p">;</span>

    <span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${resource.serverUrl}&quot;</span><span class="p">)</span> <span class="c1">// (3)</span>
    <span class="n">String</span> <span class="n">resourceServerUrl</span><span class="p">;</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;todo/get&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTodo</span><span class="p">(</span><span class="n">Model</span> <span class="n">model</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&quot;client.serverUrl&quot;</span><span class="p">,</span> <span class="n">applicationContextUr</span><span class="p">);</span>
        <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&quot;auth.serverUrl&quot;</span><span class="p">,</span> <span class="n">authServerUrl</span><span class="p">);</span>
        <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&quot;resource.serverUrl&quot;</span><span class="p">,</span> <span class="n">resourceServerUrl</span><span class="p">);</span>
        <span class="k">return</span> <span class="s">&quot;todo/todoList&quot;</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントのルートパスを取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバのルートパスを取得する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースサーバのルートパスを取得する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>また、エラー時のリダイレクト先URL(<code class="docutils literal"><span class="pre">/oauth/error</span></code>)のハンドリングを行うコントローラを追加する。
以下にコントローラの実装例を示す。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">OAuth2ErrorController.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;/oauth/error&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2ErrorController</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;error=access_denied&quot;</span><span class="p">,</span>
            <span class="s">&quot;error_description=User denied access&quot;</span> <span class="p">})</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">handleAccessDeniedError</span><span class="p">(</span>
            <span class="nd">@RequestParam</span><span class="p">(</span><span class="s">&quot;error&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">error</span><span class="p">,</span>
            <span class="nd">@RequestParam</span><span class="p">(</span><span class="s">&quot;error_description&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">description</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// omitted</span>

        <span class="k">return</span> <span class="s">&quot;common/error/accessDeniedError&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@RequestMapping</span> <span class="c1">// (2)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">handleError</span><span class="p">(</span>
            <span class="nd">@RequestParam</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="n">String</span> <span class="n">error</span><span class="p">,</span>
            <span class="nd">@RequestParam</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;error_description&quot;</span><span class="p">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="n">String</span> <span class="n">description</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// omitted</span>

        <span class="k">return</span> <span class="s">&quot;common/error/systemError&quot;</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">リクエストパラメータがリソースオーナによる認可拒否を示す以下の条件の場合、アクセス拒否画面に遷移する。</div>
</div>
<ul class="last simple">
<li><code class="docutils literal"><span class="pre">error</span></code>：<code class="docutils literal"><span class="pre">access_denied</span></code></li>
<li><code class="docutils literal"><span class="pre">error_description</span></code>：<code class="docutils literal"><span class="pre">User</span> <span class="pre">denied</span> <span class="pre">access</span></code></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(1)以外の場合、システムエラー画面に遷移する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>クライアントの画面（JSP）の実装例を示す。
JSPでは、前述の独自に実装したJavaScriptを利用して、認可サーバやリソースサーバにアクセスする。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">todoList.jsp</span></code></li>
</ul>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;script</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;${pageContext.request.contextPath}/resources/vendor/jquery/jquery.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;script</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;${pageContext.request.contextPath}/resources/app/js/oauth2.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;script</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
&quot;use strict&quot;;

$(document).ready(function() {
    var result = oauth2Func.initialize({ // (2)
        &quot;todo&quot; : { // (3)
            clientId : &quot;client&quot;, // (4)
            redirectUrl : &quot;${client.serverUrl}/todo/get&quot;, // (5)
            errRedirectUrl : &quot;${client.serverUrl}/oauth/error&quot;, // (6)
            authorization : &quot;${auth.serverUrl}/oauth/authorize&quot; // (7)
        }
    });

    if (result) {
        oauth2Func.oajax({ // (8)
            url : &quot;${resource.serverUrl}/api/v1/todos&quot;, // (9)
            providerId : &quot;todo&quot;,  // (10)
            scopes : [ &quot;READ&quot; ],  // (11)
            dataType : &quot;json&quot;,    // (12)
            type : &quot;GET&quot;  // (13)
        }).done(function(data) {  // (14)
            $(&quot;#message&quot;).text(JSON.stringify(data));
        }).fail(function(data) {  // (15)
            oauth2Func.parseFailureJSON(&quot;todo&quot;, data);
        });
    }
});

<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">&quot;message&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">前述の、jQuery、独自に実装したJavaScriptをそれぞれ格納したパスを指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可要求に使用するコンフィギュレーション情報を定義し、初期化する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアント別にコンフィギュレーション情報を区別するための識別子として一意な値を指定する。</div>
<div class="line">後述するリソースへのアクセス処理では、本項目をキーにコンフィギュレーション情報を管理・取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントを識別するIDを指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバのリソースオーナ認証後にクライアントをリダイレクトさせるURLを指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可応答として認可サーバよりエラーを受信した場合にリダイレクトさせるURLを指定する。</div>
<div class="line">本ガイドラインではエラー受信時の実装例として、クライアントの画面にリダイレクトしエラー画面を
表示させる方法を示す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバの認可エンドポイントを指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースへのアクセスを実行する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースサーバのアクセス先URLを指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">参照するコンフィギュレーション情報の識別子を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可を要求するスコープを指定する。設定値は大文字、小文字を区別する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">レスポンス形式を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(13)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">メソッドGETでリソースサーバへアクセスする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(14)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">処理成功時に行う処理を指定する。<code class="docutils literal"><span class="pre">message</span></code>には処理成功時のレスポンスが格納される。</div>
<div class="line">本ガイドラインではレスポンスをそのまま出力している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(15)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">処理失敗時に行う処理を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>本実装例ではローカルストレージにアクセストークンを格納する際のキーとして固定の値を使用している。</p>
<p>本実装例のようにローカルストレージに固定のキーで情報を格納すると、同一端末のブラウザを複数のユーザが利用する場合に、
あるユーザが格納した情報が別のユーザに意図せず参照されてしまう可能性がある。</p>
<p class="last">同一端末のブラウザを複数のユーザが利用することが想定される場合は、セッションストレージを採用し、
ユーザごとにユニークなキーで格納するなど、意図しない不正利用が起こらない仕組みを実装する必要がある。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Spring Security OAuth以外のアーキテクチャで実装されている認可サーバに対してアクセストークンの発行を依頼する場合は
リクエストパラメータが上記とは異なる可能性があるため注意されたい。
その場合はアーキテクチャの仕様を確認し、必要なリクエストパラメータを設定されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id53">
<h5><a class="toc-backref" href="#id188">9.9.2.4.3.2. トークンの取り消し(クライアントサーバ)</a><a class="headerlink" href="#id53" title="Permalink to this headline">¶</a></h5>
<p>発行したアクセストークンの取り消しについて説明する。</p>
<p>認可サーバからアクセストークンを削除する方法については<a class="reference internal" href="#oauthauthorizationserverhowtocanceltoken"><span class="std std-ref">トークンの取り消し（認可サーバ）</span></a>を参照されたい。</p>
<p>クライアントではアクセストークンが不要になったタイミングで<code class="docutils literal"><span class="pre">oauth2.js</span></code>の<code class="docutils literal"><span class="pre">clearTokens</span></code>を呼び出すことでローカルストレージに格納したアクセストークンを削除できる。</p>
<p>以下に実装例を示す。</p>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">oauth2Func</span><span class="p">.</span><span class="nx">clearTokens</span><span class="p">({</span> <span class="c1">// (1)</span>
        <span class="s2">&quot;todo&quot;</span> <span class="o">:</span> <span class="p">{}</span> <span class="c1">// (2)</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ローカルストレージからアクセストークンを削除する<code class="docutils literal"><span class="pre">clearTokens</span></code>関数を呼び出す。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークンを参照するキーとして<code class="docutils literal"><span class="pre">initialize</span></code>で設定した一意な値と同じ値を設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">ローカルストレージからアクセストークンを削除しても、<a class="reference internal" href="#oauthauthorizationserverhowtocanceltoken"><span class="std std-ref">トークンの取り消し（認可サーバ）</span></a>で説明しているように、リソースオーナに対する認可の要求を行わずにアクセストークンを再取得できるケースがある。
クライアントからアクセストークンを削除するだけではセキュリティ面での対処としては不十分であることに注意されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">アクセストークンの削除を行うタイミングによっては、ブラウザの終了などでJavaScriptが実行されない場合がある。
セキュリティ要件上アクセストークンを削除する必要がある場合は、ユーザがブラウザを終了してしまうことも考慮し、
ユースケース上必ず実行されるポイントでアクセストークンの削除を行う必要があることに注意されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthclienterrorhandlingwithimplicit">
<span id="id54"></span><h5><a class="toc-backref" href="#id189">9.9.2.4.3.3. エラーハンドリング</a><a class="headerlink" href="#oauthclienterrorhandlingwithimplicit" title="Permalink to this headline">¶</a></h5>
<p>インプリシットグラントにおける認可サーバ、リソースサーバへのアクセス時に発生するエラーのハンドリング方法について説明する。</p>
<div class="section" id="oauthclienthandleerrorwhenaccessingauthorizationendpointwithimplicit">
<span id="id55"></span><h6><a class="toc-backref" href="#id190">9.9.2.4.3.3.1. 認可エンドポイントアクセス時のエラーハンドリング</a><a class="headerlink" href="#oauthclienthandleerrorwhenaccessingauthorizationendpointwithimplicit" title="Permalink to this headline">¶</a></h6>
<p>認可エンドポイントで発生するエラーでハンドリングするエラーは認可コードグラントと同様であるため<a class="reference internal" href="#oauthclienthandleerrorwhenaccessingauthorizationendpointwithcode"><span class="std std-ref">認可エンドポイントアクセス時のエラーハンドリング</span></a>を参照されたい。
エラーハンドリングについては<a class="reference internal" href="#oauthclientusingjavascript"><span class="std std-ref">JavaScriptを使用したリソースサーバへのアクセス</span></a>を参照されたい。</p>
</div>
<div class="section" id="oauthclienthandleerrorwhenaccessingtokenendpointwithimplicit">
<span id="id56"></span><h6><a class="toc-backref" href="#id191">9.9.2.4.3.3.2. リソースサーバアクセス時のエラーハンドリング</a><a class="headerlink" href="#oauthclienthandleerrorwhenaccessingtokenendpointwithimplicit" title="Permalink to this headline">¶</a></h6>
<p>リソースサーバへアクセス時のエラーでハンドリングが必要なものは以下となる。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id119">
<caption><span class="caption-text"><strong>リソースサーバで発生するエラー</strong></span><a class="headerlink" href="#id119" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">発生するエラー</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークン検証エラー</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.common.exceptions.InvalidTokenException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースサーバが受け取ったアクセストークンの正当性を確認出来ない場合（異常系）や、アクセストークンの有効期限が切れている場合（正常系）に発生する。</div>
<div class="line"><br /></div>
<div class="line">アクセストークン検証エラーは正常系と異常系が混在しているため、インプリシットグラント等<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を利用しない場合にこのエラーを受け取った場合、アクセストークンの有効期限切れかどうか判定する必要がある。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>エラーハンドリングについては<a class="reference internal" href="#oauthclientusingjavascript"><span class="std std-ref">JavaScriptを使用したリソースサーバへのアクセス</span></a>を参照されたい。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">上記ではリソースオーナの操作により発生するエラーのハンドリングのみ紹介しているが、システムエラーもハンドリングする必要がある。
発生するエラーについては <a class="reference internal" href="#oauthappendixoccuringerrors"><span class="std std-ref">クライアントから認可サーバ、リソースサーバアクセス時に発生するエラー</span></a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="implementationresourceownerpasswordcredentialsgrant">
<span id="id57"></span><h3><a class="toc-backref" href="#id192">9.9.2.5. リソースオーナパスワードクレデンシャルグラントの実装</a><a class="headerlink" href="#implementationresourceownerpasswordcredentialsgrant" title="Permalink to this headline">¶</a></h3>
<p>リソースオーナパスワードクレデンシャルグラントを利用した認可サーバ、リソースサーバ、クライアントの実装方法について説明する。</p>
<p>解説は認可コードグラントからの変更点のみを対象に行っている。変更点以外の実装、解説については<a class="reference internal" href="#implementationautorizationcodegrant"><span class="std std-ref">認可コードグラントの実装</span></a>を参照されたい。</p>
<p>以下に認可コードグラントの実装から各サーバを実装する際の変更点を示す。</p>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="30%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">サーバ</th>
<th class="head">認可コードグラントからの変更点</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">認可サーバ</th>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#oauthauthorizationserverdefinition"><span class="std std-ref">認可サーバの定義</span></a></div>
<div class="line"><a class="reference internal" href="#oauthauthorizationserverclientauthentication"><span class="std std-ref">クライアントの認証</span></a></div>
<div class="line"><a class="reference internal" href="#oauthauthorizationserverhowtocanceltoken"><span class="std std-ref">トークンの取り消し（認可サーバ）</span></a></div>
</div>
</td>
</tr>
<tr class="row-odd"><th class="stub">リソースサーバ</th>
<td>なし</td>
</tr>
<tr class="row-even"><th class="stub">クライアント</th>
<td><a class="reference internal" href="#oauth2resttemplatesettings"><span class="std std-ref">OAuth2RestTemplateの設定</span></a></td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="implementationoauthauthorizationserverofpassword">
<span id="id58"></span><h4><a class="toc-backref" href="#id193">9.9.2.5.1. 認可サーバの実装</a><a class="headerlink" href="#implementationoauthauthorizationserverofpassword" title="Permalink to this headline">¶</a></h4>
<p>認可コードグラントの実装から<code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>を変更し、DB及びServiceクラスから不要な定義を削除する必要がある。</p>
<p><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>以外の実装は<a class="reference internal" href="#implementationoauthauthorizationserverofautorizationcode"><span class="std std-ref">認可サーバの実装</span></a>を参照し作成されたい。</p>
<div class="section" id="id59">
<h5><a class="toc-backref" href="#id194">9.9.2.5.1.1. 認可サーバの定義</a><a class="headerlink" href="#id59" title="Permalink to this headline">¶</a></h5>
<p>認可コードグラントからの<code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>の変更点を以下に示す。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
    <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span>
    <span class="na">user-approval-handler-ref=</span><span class="s">&quot;userApprovalHandler&quot;</span>
    <span class="na">token-services-ref=</span><span class="s">&quot;tokenServices&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:password</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;oauth2:password</span> <span class="pre">/&gt;</span></code>タグを使用して、リソースオーナパスワードクレデンシャルグラントをサポートする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><code class="docutils literal"><span class="pre">&lt;oauth2:password</span> <span class="pre">/&gt;</span></code>タグと<code class="docutils literal"><span class="pre">&lt;oauth2:refresh-token</span> <span class="pre">/&gt;</span></code>タグは上記の順番で設定する必要がある。</p>
<p class="last">詳細は<a class="reference internal" href="#orderofauthoraizationserversupportsetting"><span class="std std-ref">認可サーバで複数のグラントタイプをサポートする場合</span></a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id60">
<h5><a class="toc-backref" href="#id195">9.9.2.5.1.2. クライアントの認証</a><a class="headerlink" href="#id60" title="Permalink to this headline">¶</a></h5>
<p>リソースオーナパスワードクレデンシャルグラントでは<a class="reference internal" href="#authorizationgrant"><span class="std std-ref">認可グラント</span></a>で説明したとおりアクセストークンを直接発行する。
そのため、リソースオーナに対して認可の要求は行われず、ユーザエージェントのリダイレクトは発生しない。</p>
<p>認可コードグラントの<a class="reference internal" href="#oauthauthorizationserverclientauthentication"><span class="std std-ref">クライアントの認証</span></a>で定義したテーブル、<code class="docutils literal"><span class="pre">web_server_redirect_uris</span></code>は不要となるため削除する。</p>
</div>
<div class="section" id="id61">
<h5><a class="toc-backref" href="#id196">9.9.2.5.1.3. トークンの取り消し（認可サーバ）</a><a class="headerlink" href="#id61" title="Permalink to this headline">¶</a></h5>
<p>認可コードグラントの実装では、<code class="docutils literal"><span class="pre">RevokeTokenServiceImpl.java</span></code>にて認可サーバのトークンの取り消しに合わせて、認可情報の取り消しを行っている。</p>
<p>リソースオーナに対して認可の要求を行わないリソースオーナパスワードクレデンシャルグラントでは認可情報の取り消しが不要であるため、この処理を削除する。</p>
<p>以下に、認可情報の取り消しをコメントアウトした<code class="docutils literal"><span class="pre">RevokeTokenServiceImpl.java</span></code>を示す。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">RevokeTokenServiceImpl.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RevokeTokenServiceImpl</span> <span class="kd">implements</span> <span class="n">RevokeTokenService</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ConsumerTokenServices</span> <span class="n">consumerService</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">TokenStore</span> <span class="n">tokenStore</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">ApprovalStore</span> <span class="n">approvalStore</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">JodaTimeDateFactory</span> <span class="n">dateFactory</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">revokeToken</span><span class="p">(</span><span class="n">String</span> <span class="n">tokenValue</span><span class="p">,</span> <span class="n">String</span> <span class="n">clientId</span><span class="p">){</span>

        <span class="n">OAuth2Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="n">tokenStore</span><span class="p">.</span><span class="na">readAuthentication</span><span class="p">(</span><span class="n">tokenValue</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">authentication</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">clientId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">authentication</span><span class="p">.</span><span class="na">getOAuth2Request</span><span class="p">().</span><span class="na">getClientId</span><span class="p">()))</span> <span class="p">{</span>
                <span class="cm">/* Authentication user = authentication.getUserAuthentication();</span>
<span class="cm">                if (user != null) {</span>
<span class="cm">                    Collection&lt;Approval&gt; approvals = new ArrayList&lt;&gt;();</span>
<span class="cm">                    for (String scope : authentication.getOAuth2Request().getScope()) {</span>
<span class="cm">                        approvals.add(</span>
<span class="cm">                                new Approval(user.getName(), clientId, scope, dateFactory.newDate(), ApprovalStatus.APPROVED));</span>
<span class="cm">                    }</span>
<span class="cm">                    approvalStore.revokeApprovals(approvals);</span>
<span class="cm">                } */</span>
                <span class="n">consumerService</span><span class="p">.</span><span class="na">revokeToken</span><span class="p">(</span><span class="n">tokenValue</span><span class="p">);</span>
                <span class="k">return</span> <span class="s">&quot;success&quot;</span><span class="p">;</span>

            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="s">&quot;invalid client&quot;</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s">&quot;invalid token&quot;</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="implementationoauthresourceserverofpassword">
<span id="id62"></span><h4><a class="toc-backref" href="#id197">9.9.2.5.2. リソースサーバの実装</a><a class="headerlink" href="#implementationoauthresourceserverofpassword" title="Permalink to this headline">¶</a></h4>
<p>認可コードグラントの実装から変更は不要である。</p>
<p>実装は<a class="reference internal" href="#implementationoauthresourceserverofautorizationcode"><span class="std std-ref">リソースサーバの実装</span></a>を参照し作成されたい。</p>
</div>
<div class="section" id="implementationoauthclientserverofpassword">
<span id="id63"></span><h4><a class="toc-backref" href="#id198">9.9.2.5.3. クライアントの実装</a><a class="headerlink" href="#implementationoauthclientserverofpassword" title="Permalink to this headline">¶</a></h4>
<p>認可コードグラントの実装から<code class="docutils literal"><span class="pre">oauth2-client.xml</span></code>を変更する必要がある。</p>
<p><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code>以外の実装は<a class="reference internal" href="#implementationoauthclientserverofautorizationcode"><span class="std std-ref">クライアントの実装</span></a>を参照し作成されたい。</p>
<div class="section" id="oauth2resourceownerpasswordcredentialgrantresourcesettings">
<span id="id64"></span><h5><a class="toc-backref" href="#id199">9.9.2.5.3.1. OAuth2RestTemplateの設定</a><a class="headerlink" href="#oauth2resourceownerpasswordcredentialgrantresourcesettings" title="Permalink to this headline">¶</a></h5>
<div class="line-block">
<div class="line">リソースオーナパスワードクレデンシャルグラントでは、クライアントがリソースオーナのユーザ名およびパスワードを使用してアクセストークンの発行を依頼する。</div>
<div class="line"><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>にはリソースオーナのユーザ名およびパスワードをそれぞれパラメータとして設定する必要があるが、
複数のリソースオーナが同じクライアントを利用する場合、リソースオーナ毎に設定内容を切り替える考慮が必要となる。</div>
<div class="line">ここでは、<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>のリソースをSessionスコープのBeanで設定し、そのBeanにリソースオーナの情報を格納することによって、
リソースオーナ毎の設定内容の切り替えを実現する方法を説明する。</div>
<div class="line">リソースとして通常使用する<code class="docutils literal"><span class="pre">&lt;oauth2:resource&gt;</span></code>タグはSingletonスコープのBeanとなるため、Sessionスコープに変更する場合は独自にBean定義する必要がある。</div>
</div>
<p><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>の設定例を以下に示す。</p>
<p>リソースオーナ毎に設定内容を切り替えられるよう、<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.client.token.grant.password.ResourceOwnerPasswordResourceDetails</span></code>をSessionスコープで定義し、<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>への設定を行う。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;todoPasswordGrantResource&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.client.token.grant.password.ResourceOwnerPasswordResourceDetails&quot;</span>
    <span class="na">scope=</span><span class="s">&quot;session&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;aop:scoped-proxy</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;clientId&quot;</span> <span class="na">value=</span><span class="s">&quot;firstSec&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;clientSecret&quot;</span> <span class="na">value=</span><span class="s">&quot;firstSecSecret&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;accessTokenUri&quot;</span> <span class="na">value=</span><span class="s">&quot;${auth.serverUrl}/oauth/token&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;scope&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;list&gt;</span>
            <span class="nt">&lt;value&gt;</span>READ<span class="nt">&lt;/value&gt;</span>
            <span class="nt">&lt;value&gt;</span>WRITE<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

<span class="nt">&lt;oauth2:rest-template</span> <span class="na">id=</span><span class="s">&quot;todoPasswordGrantResourceRestTemplate&quot;</span> <span class="na">resource=</span><span class="s">&quot;todoPasswordGrantResource&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>が参照する、アクセス対象となるリソースに関する詳細情報を定義する。</div>
<div class="line">各項目の設定値については下記表を参照のこと。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を定義する。</div>
<div class="line"><code class="docutils literal"><span class="pre">id</span></code>には<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>のBean名を指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">resource</span></code>には(1)で定義したBeanの<code class="docutils literal"><span class="pre">id</span></code>を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項目</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">class</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>のリソースとするBeanを指定する。ここでは<code class="docutils literal"><span class="pre">ResourceOwnerPasswordResourceDetails</span></code>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">scope</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">sessionを指定し、スコープ範囲をHTTPSessionとする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;aop:scoped-proxy</span> <span class="pre">/&gt;</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SessionスコープのBeanをSingletonのBeanである<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>にインジェクションするため設定する。</div>
<div class="line">これは、SessionスコープのBeanよりSingletonのBeanの方がライフサイクルが長いため必要になる設定である。</div>
<div class="line">このタグを使用するために<code class="docutils literal"><span class="pre">aop</span></code>のネームスペースとスキーマを追加している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">clientId</span></code>プロパティ</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Beanの<code class="docutils literal"><span class="pre">clientId</span></code>に対して認可サーバにてクライントを識別するIDを設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">clientSecret</span></code>プロパティ</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Beanの<code class="docutils literal"><span class="pre">clientSecret</span></code>に対して認可サーバにてクライアントの認証に用いるパスワードを設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">accessTokenUri</span></code>プロパティ</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークンの発行を依頼するための認可サーバのエンドポイントを指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">scope</span></code>プロパティ</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Beanの<code class="docutils literal"><span class="pre">scope</span></code>に対して認可を要求するスコープの一覧を設定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">&lt;oauth2:resource&gt;</span></code>タグを使用する場合とは異なり、<code class="docutils literal"><span class="pre">scope</span></code>をリスト形式で指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Spring Security OAuth以外のアーキテクチャで実装されている認可サーバに対してアクセストークンの発行を依頼する場合は
リクエストパラメータが上記とは異なる可能性があるため注意されたい。
その場合はアーキテクチャの仕様を確認し、必要なリクエストパラメータを設定されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">リソースオーナのユーザ名、パスワードの取得は、アクセスが必要となったタイミングでクライアントの画面等でリソースオーナから入力され、Beanに格納することを想定している。
本ガイドラインでは、ユーザ名、パスワードの具体的な取得方法については説明を割愛する。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">本ガイドラインで説明している認可サーバでは、認証に使用するパスワードに対してハッシュ化の後比較検証を行うため、<code class="docutils literal"><span class="pre">ResourceOwnerPasswordResourceDetails</span></code>に設定するパスワードは平文である必要がある。
クライアントがリソースオーナのパスワードを平文で扱うことによるリスクが高いため、リソースオーナパスワードクレデンシャルグラントは
クライアント-リソースオーナ間で高い信頼関係があり、かつクライアントがセキュアな環境に配置されているなどの非常に限定的な状況でのみ利用すること。
認可サーバにおけるハッシュ化の設定については <a class="reference internal" href="#oauthauthorizationserverclientauthentication"><span class="std std-ref">クライアントの認証</span></a>を参照のこと。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthclienterrorhandlingwithpassword">
<span id="id65"></span><h5><a class="toc-backref" href="#id200">9.9.2.5.3.2. エラーハンドリング</a><a class="headerlink" href="#oauthclienterrorhandlingwithpassword" title="Permalink to this headline">¶</a></h5>
<p>リソースオーナパスワードクレデンシャルグラントにおける認可サーバ、リソースサーバへのアクセス時に発生するエラーのハンドリング方法について説明する。</p>
<div class="section" id="oauthclienthandleerrorwhenaccessingtokenendpointwithpassword">
<span id="id66"></span><h6><a class="toc-backref" href="#id201">9.9.2.5.3.2.1. トークンエンドポイント及びリソースサーバアクセス時のエラーハンドリング</a><a class="headerlink" href="#oauthclienthandleerrorwhenaccessingtokenendpointwithpassword" title="Permalink to this headline">¶</a></h6>
<p>リソースサーバで発生するエラーでハンドリングする必要のあるエラー及びエラーハンドリングについては認可コードグラントと同様であるため<a class="reference internal" href="#oauthclienthandleerrorwhenaccessingtokenendpointwithcode"><span class="std std-ref">トークンエンドポイント及びリソースサーバアクセス時のエラーハンドリング</span></a>を参照されたい。</p>
<p>トークンエンドポイントで発生する例外は、クライアントの<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>で<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.client.resource.OAuth2AccessDeniedException</span></code>にラップされる。
<code class="docutils literal"><span class="pre">OAuth2AccessDeniedException</span></code>でラップされるエラーでハンドリングが必要なものは以下となる。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id120">
<caption><span class="caption-text"><strong>トークンエンドポイントで発生するエラー</strong></span><a class="headerlink" href="#id120" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">発生するエラー</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナ認証エラー</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.common.exceptions.InvalidGrantException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナパスワードクレデンシャルグラント使用時に提示したリソースオーナの認証情報に誤りがある場合に発生する。</div>
<div class="line">エラー発生時には例外クラスとして<code class="docutils literal"><span class="pre">InvalidGrantException</span></code>が認可サーバでハンドリングされる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>上記の<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>によってスローされる例外に対するハンドリング処理を実装する必要がある。
以下に実装例を示す。
実装例で使用している<code class="docutils literal"><span class="pre">&#64;ControllerAdvice</span></code>アノテーションについては <a class="reference internal" href="../ImplementationAtEachLayer/ApplicationLayer.html#application-layer-controller-advice"><span class="std std-ref">&#64;ControllerAdviceの実装</span></a>を参照されたい。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2ExceptionHandler</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">OAuth2AccessDeniedException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">handleOAuth2AccessDeniedException</span><span class="p">(</span><span class="n">OAuth2AccessDeniedException</span> <span class="n">e</span><span class="p">,</span>
            <span class="n">Model</span> <span class="n">model</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// omitted</span>

        <span class="c1">// (2)</span>
        <span class="n">Throwable</span> <span class="n">cause</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="na">getCause</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="k">instanceof</span> <span class="n">InvalidGrantException</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">handleInvalidGrantException</span><span class="p">(((</span><span class="n">InvalidGrantException</span><span class="p">)</span> <span class="n">cause</span><span class="p">),</span>
                    <span class="n">model</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&quot;exception&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>

        <span class="k">return</span> <span class="s">&quot;common/error/systemError&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="nf">handleInvalidGrantException</span><span class="p">(</span><span class="n">InvalidGrantException</span> <span class="n">e</span><span class="p">,</span>
            <span class="n">Model</span> <span class="n">model</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&quot;exception&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>

        <span class="k">return</span> <span class="s">&quot;common/error/accessDeniedError&quot;</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">コントローラで発生したエラーをハンドリングする。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></code>のパラメータに指定されている<code class="docutils literal"><span class="pre">OAuth2AccessDeniedException</span></code>が発生した場合に実行される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">発生したエラーの原因により遷移先画面を決定する。</div>
<div class="line">エラーの原因が<code class="docutils literal"><span class="pre">InvalidGrantException</span></code>の場合はアクセス拒否画面に遷移する。</div>
<div class="line">上記以外の場合はシステムエラー画面に遷移する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">上記では上記ではリソースオーナの操作により発生するエラーのハンドリングのみ紹介しているが、システムエラーもハンドリングする必要がある。
発生するエラーについては <a class="reference internal" href="#oauthappendixoccuringerrors"><span class="std std-ref">クライアントから認可サーバ、リソースサーバアクセス時に発生するエラー</span></a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="clientcredentialsgrant">
<span id="id67"></span><h3><a class="toc-backref" href="#id202">9.9.2.6. クライアントクレデンシャルグラントの実装</a><a class="headerlink" href="#clientcredentialsgrant" title="Permalink to this headline">¶</a></h3>
<p>クライアントクレデンシャルグラントを利用した認可サーバ、リソースサーバ、クライアントの実装方法について説明する。</p>
<p>解説は認可コードグラントからの変更点のみを対象に行っている。変更点以外の実装、解説については<a class="reference internal" href="#implementationautorizationcodegrant"><span class="std std-ref">認可コードグラントの実装</span></a>を参照されたい。</p>
<p>以下に認可コードグラントの実装から各サーバを実装する際の変更点を示す。</p>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="30%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">サーバ</th>
<th class="head">認可コードグラントからの変更点</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">認可サーバ</th>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#oauthauthorizationserverdefinition"><span class="std std-ref">認可サーバの定義</span></a></div>
<div class="line"><a class="reference internal" href="#oauthauthorizationserverclientauthentication"><span class="std std-ref">クライアントの認証</span></a></div>
<div class="line"><a class="reference internal" href="#oauthauthorizationserverhowtocanceltoken"><span class="std std-ref">トークンの取り消し（認可サーバ）</span></a></div>
</div>
</td>
</tr>
<tr class="row-odd"><th class="stub">リソースサーバ</th>
<td><a class="reference internal" href="#oauthresourceservergetprincipal"><span class="std std-ref">ユーザ情報の取得</span></a></td>
</tr>
<tr class="row-even"><th class="stub">クライアント</th>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#oauth2resttemplatesettings"><span class="std std-ref">OAuth2RestTemplateの設定</span></a></div>
<div class="line"><a class="reference internal" href="#oauthaccessofresourceserver"><span class="std std-ref">リソースサーバへのアクセス</span></a></div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="implementationoauthauthorizationserverofclientcredentials">
<span id="id68"></span><h4><a class="toc-backref" href="#id203">9.9.2.6.1. 認可サーバの実装</a><a class="headerlink" href="#implementationoauthauthorizationserverofclientcredentials" title="Permalink to this headline">¶</a></h4>
<p>認可コードグラントの実装から<code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>を変更し、DB及びServiceクラスから不要な定義を削除する必要がある。</p>
<p><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>以外の実装は<a class="reference internal" href="#implementationoauthauthorizationserverofautorizationcode"><span class="std std-ref">認可サーバの実装</span></a>を参照し作成されたい。</p>
<div class="section" id="id69">
<h5><a class="toc-backref" href="#id204">9.9.2.6.1.1. 認可サーバの定義</a><a class="headerlink" href="#id69" title="Permalink to this headline">¶</a></h5>
<p>認可コードグラントからの<code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>の変更点を以下に示す。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
    <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span>
    <span class="na">token-endpoint-url=</span><span class="s">&quot;/oauth/token&quot;</span>
    <span class="na">token-services-ref=</span><span class="s">&quot;tokenServices&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:client-credentials</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;oauth2:client-credentials</span> <span class="pre">/&gt;</span></code>タグを使用して、クライアントクレデンシャルグラントをサポートする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><code class="docutils literal"><span class="pre">&lt;oauth2:client-credentials</span> <span class="pre">/&gt;</span></code>タグと<code class="docutils literal"><span class="pre">&lt;oauth2:refresh-token</span> <span class="pre">/&gt;</span></code>タグは上記の順番で設定する必要がある。</p>
<p class="last">詳細は<a class="reference internal" href="#orderofauthoraizationserversupportsetting"><span class="std std-ref">認可サーバで複数のグラントタイプをサポートする場合</span></a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id70">
<h5><a class="toc-backref" href="#id205">9.9.2.6.1.2. クライアントの認証</a><a class="headerlink" href="#id70" title="Permalink to this headline">¶</a></h5>
<p>クライアントクレデンシャルグラントでは<a class="reference internal" href="#authorizationgrant"><span class="std std-ref">認可グラント</span></a>で説明したとおりアクセストークンを直接発行する。
そのため、リソースオーナに対して認可の要求は行われず、ユーザエージェントのリダイレクトは発生しない。</p>
<p>認可コードグラントの<a class="reference internal" href="#oauthauthorizationserverclientauthentication"><span class="std std-ref">クライアントの認証</span></a>で定義したテーブル、<code class="docutils literal"><span class="pre">web_server_redirect_uris</span></code>は不要となるため削除する。</p>
</div>
<div class="section" id="id71">
<h5><a class="toc-backref" href="#id206">9.9.2.6.1.3. トークンの取り消し（認可サーバ）</a><a class="headerlink" href="#id71" title="Permalink to this headline">¶</a></h5>
<p>認可コードグラントの実装では、<code class="docutils literal"><span class="pre">RevokeTokenServiceImpl.java</span></code>にて認可サーバのトークンの取り消しに合わせて、認可情報の取り消しを行っている。</p>
<p>リソースオーナに対して認可の要求を行わないクライアントクレデンシャルグラントでは認可情報の取り消しが不要であるため、この処理を削除する。</p>
<p>以下に、認可情報の取り消しをコメントアウトした<code class="docutils literal"><span class="pre">RevokeTokenServiceImpl.java</span></code>を示す。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">RevokeTokenServiceImpl.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RevokeTokenServiceImpl</span> <span class="kd">implements</span> <span class="n">RevokeTokenService</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ConsumerTokenServices</span> <span class="n">consumerService</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">TokenStore</span> <span class="n">tokenStore</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">ApprovalStore</span> <span class="n">approvalStore</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">JodaTimeDateFactory</span> <span class="n">dateFactory</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">revokeToken</span><span class="p">(</span><span class="n">String</span> <span class="n">tokenValue</span><span class="p">,</span> <span class="n">String</span> <span class="n">clientId</span><span class="p">){</span>

        <span class="n">OAuth2Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="n">tokenStore</span><span class="p">.</span><span class="na">readAuthentication</span><span class="p">(</span><span class="n">tokenValue</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">authentication</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">clientId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">authentication</span><span class="p">.</span><span class="na">getOAuth2Request</span><span class="p">().</span><span class="na">getClientId</span><span class="p">()))</span> <span class="p">{</span>
                <span class="cm">/* Authentication user = authentication.getUserAuthentication();</span>
<span class="cm">                if (user != null) {</span>
<span class="cm">                    Collection&lt;Approval&gt; approvals = new ArrayList&lt;&gt;();</span>
<span class="cm">                    for (String scope : authentication.getOAuth2Request().getScope()) {</span>
<span class="cm">                        approvals.add(</span>
<span class="cm">                                new Approval(user.getName(), clientId, scope, dateFactory.newDate(), ApprovalStatus.APPROVED));</span>
<span class="cm">                    }</span>
<span class="cm">                    approvalStore.revokeApprovals(approvals);</span>
<span class="cm">                } */</span>
                <span class="n">consumerService</span><span class="p">.</span><span class="na">revokeToken</span><span class="p">(</span><span class="n">tokenValue</span><span class="p">);</span>
                <span class="k">return</span> <span class="s">&quot;success&quot;</span><span class="p">;</span>

            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="s">&quot;invalid client&quot;</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s">&quot;invalid token&quot;</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="implementationoauthresourceserverofclientcredentials">
<span id="id72"></span><h4><a class="toc-backref" href="#id207">9.9.2.6.2. リソースサーバの実装</a><a class="headerlink" href="#implementationoauthresourceserverofclientcredentials" title="Permalink to this headline">¶</a></h4>
<p>認可コードグラントの実装から<a class="reference internal" href="#oauthresourceservergetprincipal"><span class="std std-ref">ユーザ情報の取得</span></a>について変更する必要がある。</p>
<p><a class="reference internal" href="#oauthresourceservergetprincipal"><span class="std std-ref">ユーザ情報の取得</span></a>以外の実装は<a class="reference internal" href="#implementationoauthresourceserverofautorizationcode"><span class="std std-ref">リソースサーバの実装</span></a>を参照されたい。</p>
<div class="section" id="id73">
<h5><a class="toc-backref" href="#id208">9.9.2.6.2.1. ユーザ情報の取得</a><a class="headerlink" href="#id73" title="Permalink to this headline">¶</a></h5>
<p>ユーザの認証が行われないクライアントクレデンシャルグラントではリソースオーナの情報がSpring Securityに保持されない。</p>
<p>このため認可コードグラントでの実装のように、Controllerクラスの引数として<code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>アノテーションを付与した<code class="docutils literal"><span class="pre">UserDetails</span></code>や<code class="docutils literal"><span class="pre">OAuth2Authentication</span></code>を指定してもリソースオーナの情報を受け取ることはできない。</p>
<p>代わりに、クライアント情報を保持しているため、Controllerのメソッド引数に<code class="docutils literal"><span class="pre">String</span></code>を指定し<code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>アノテーションを付与することによりクライアントIDを取得することができる。</p>
<p>認可コードグラントからの変更点を以下に示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;api&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;todos&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">list</span><span class="p">(</span><span class="nd">@AuthenticationPrincipal</span> <span class="n">String</span> <span class="n">clientId</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (1)</span>

        <span class="c1">// omitted</span>

    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数 <code class="docutils literal"><span class="pre">clientId</span></code>にクライアントIDが格納される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="implementationoauthclientserverofclientcredentials">
<span id="id74"></span><h4><a class="toc-backref" href="#id209">9.9.2.6.3. クライアントの実装</a><a class="headerlink" href="#implementationoauthclientserverofclientcredentials" title="Permalink to this headline">¶</a></h4>
<p>認可コードグラントの実装から<code class="docutils literal"><span class="pre">oauth2-client.xml</span></code>を変更する必要がある。</p>
<p><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code>以外の実装は<a class="reference internal" href="#implementationoauthclientserverofautorizationcode"><span class="std std-ref">クライアントの実装</span></a>を参照し作成されたい。</p>
<div class="section" id="id75">
<h5><a class="toc-backref" href="#id210">9.9.2.6.3.1. OAuth2RestTemplateの設定</a><a class="headerlink" href="#id75" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>の設定例を以下に示す。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:resource</span> <span class="na">id=</span><span class="s">&quot;todoClientGrantResource&quot;</span> <span class="na">client-id=</span><span class="s">&quot;firstSecClient&quot;</span>
                <span class="na">client-secret=</span><span class="s">&quot;firstSecSecret&quot;</span>
                <span class="na">type=</span><span class="s">&quot;client_credentials&quot;</span>
                <span class="na">access-token-uri=</span><span class="s">&quot;${auth.serverUrl}/oauth/token&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

<span class="nt">&lt;oauth2:rest-template</span> <span class="na">id=</span><span class="s">&quot;todoClientGrantResourceRestTemplate&quot;</span> <span class="na">resource=</span><span class="s">&quot;todoClientGrantResource&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">type</span></code>属性にはグラントタイプを指定する。クライアントクレデンシャルグラントの場合<code class="docutils literal"><span class="pre">client_credentials</span></code>を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Spring Security OAuth以外のアーキテクチャで実装されている認可サーバに対してアクセストークンの発行を依頼する場合は
リクエストパラメータが上記とは異なる可能性があるため注意されたい。
その場合はアーキテクチャの仕様を確認し、必要なリクエストパラメータを設定されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthclienterrorhandlingwithclient">
<span id="id76"></span><h5><a class="toc-backref" href="#id211">9.9.2.6.3.2. エラーハンドリング</a><a class="headerlink" href="#oauthclienterrorhandlingwithclient" title="Permalink to this headline">¶</a></h5>
<div class="section" id="oauthclienthandleerrorwhenaccessingtokenendpointwithclient">
<span id="id77"></span><h6><a class="toc-backref" href="#id212">9.9.2.6.3.2.1. トークンエンドポイント及びリソースサーバアクセス時のエラーハンドリング</a><a class="headerlink" href="#oauthclienthandleerrorwhenaccessingtokenendpointwithclient" title="Permalink to this headline">¶</a></h6>
<p>クライアントクレデンシャルグラントではトークンエンドポイントおよびリソースサーバで発生するエラーはすべてシステムエラーとして扱えば良い。
発生するエラーについては <a class="reference internal" href="#oauthappendixoccuringerrors"><span class="std std-ref">クライアントから認可サーバ、リソースサーバアクセス時に発生するエラー</span></a>を参照されたい。</p>
</div>
</div>
<div class="section" id="id78">
<h5><a class="toc-backref" href="#id213">9.9.2.6.3.3. リソースオーナの認証</a><a class="headerlink" href="#id78" title="Permalink to this headline">¶</a></h5>
<p>クライアントクレデンシャルグラントではクライアントがリソースオーナとなるため、<a class="reference internal" href="#oauthauthorizationserverresourceownerauthentication"><span class="std std-ref">リソースオーナの認証</span></a>で説明したようなリソースオーナの認証を必要としない。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-extend">
<span id="oauthhowtoextend"></span><h2><a class="toc-backref" href="#id214">9.9.3. How to extend</a><a class="headerlink" href="#how-to-extend" title="Permalink to this headline">¶</a></h2>
<div class="section" id="orderofauthoraizationserversupportsetting">
<span id="id79"></span><h3><a class="toc-backref" href="#id215">9.9.3.1. 認可サーバで複数のグラントタイプをサポートする場合</a><a class="headerlink" href="#orderofauthoraizationserversupportsetting" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="#authorizationgrant"><span class="std std-ref">認可グラント</span></a>で紹介したように認可サーバは複数のグラントタイプをサポートすることができる。</p>
<p>グラントタイプを複数指定する場合、タグの順番はXMLスキーマで定められているため以下の表の番号順に設定する必要がある。</p>
<p>番号順に設定を行わないと、アプリケーション起動時にXML解釈の失敗により<code class="docutils literal"><span class="pre">org.springframework.beans.factory.xml.XmlBeanDefinitionStoreException</span></code>が発生する。</p>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">順番</th>
<th class="head">タグ</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">1</th>
<td><cite>&lt;oauth2:authorization-code /&gt;</cite></td>
</tr>
<tr class="row-odd"><th class="stub">2</th>
<td><cite>&lt;oauth2:implicit /&gt;</cite></td>
</tr>
<tr class="row-even"><th class="stub">3</th>
<td><cite>&lt;oauth2:refresh-token /&gt;</cite></td>
</tr>
<tr class="row-odd"><th class="stub">4</th>
<td><cite>&lt;oauth2:client-credentials /&gt;</cite></td>
</tr>
<tr class="row-even"><th class="stub">5</th>
<td><cite>&lt;oauth2:password /&gt;</cite></td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>例として、認可コードグラント、リソースオーナパスワードクレデンシャルグラントおよびリフレッシュトークンをサポートする場合の設定例を以下に示す。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server&gt;</span>
    <span class="nt">&lt;oauth2:authorization-code</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;oauth2:password</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><cite>&lt;oauth2:authorization-code /&gt;</cite>タグを使用して、認可コードグラントをサポートする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><cite>&lt;oauth2:refresh-token /&gt;</cite>タグを使用して、リフレッシュトークンをサポートする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><cite>&lt;oauth2:password /&gt;</cite>タグを使用して、リソースオーナパスワードクレデンシャルグラントをサポートする。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="http">
<span id="oauthauthorizationserverhowtocooperatewithhttp"></span><h3><a class="toc-backref" href="#id216">9.9.3.2. HTTPアクセスを介した認可サーバとリソースサーバの連携</a><a class="headerlink" href="#http" title="Permalink to this headline">¶</a></h3>
<p>リソースサーバと認可サーバは、認可サーバのチェックトークンエンドポイントにリソースサーバからHTTPアクセスを行うことで連携が可能である。</p>
<p>チェックトークンエンドポイントは、リソースサーバからアクセストークンの値を受け取り、リソースサーバの代わりにトークンの検証を行うエンドポイントである。
チェックトークンエンドポイントは<code class="docutils literal"><span class="pre">TokenServices</span></code>を用いてアクセストークンの取得、検証を行い、検証に問題がなければアクセストークンに紐づく情報をリソースサーバに渡す。</p>
<p>なお、チェックトークンエンドポイントはRFCに定義されていないSpring Security OAuth独自の機能であるが、
本ガイドラインでは、RFCに定義されている他のエンドポイントと同様の形式でレスポンスを行うように設定する。</p>
<p>リソースサーバが認可サーバのチェックトークンエンドポイントにアクセスするためには<code class="docutils literal"><span class="pre">TokenServices</span></code>の実装クラスである<code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>を使用する。
<code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>は<code class="docutils literal"><span class="pre">RestTemplate</span></code>を用いてチェックトークンエンドポイントへHTTPアクセスを行い、アクセストークンに紐づく情報を取得する。
アクセストークンの検証はチェックトークンエンドポイントが行うため、<code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>では行わない。</p>
<p>以下に、実装例を示す。</p>
<div class="section" id="id80">
<h4><a class="toc-backref" href="#id217">9.9.3.2.1. 認可サーバの設定</a><a class="headerlink" href="#id80" title="Permalink to this headline">¶</a></h4>
<p>まず、認可サーバにトークンを検証するための<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.endpoint.CheckTokenEndpoint</span></code>クラスをコンポーネントとして登録する設定を行う。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span> <span class="na">pattern=</span><span class="s">&quot;/oauth/*token*/**&quot;</span>
    <span class="na">authentication-manager-ref=</span><span class="s">&quot;clientAuthenticationManager&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;sec:http-basic</span> <span class="na">entry-point-ref=</span><span class="s">&quot;oauthAuthenticationEntryPoint&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:csrf</span> <span class="na">disabled=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/**&quot;</span> <span class="na">access=</span><span class="s">&quot;isAuthenticated()&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>

<span class="nt">&lt;oauth2:authorization-server</span>
     <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span>
     <span class="na">user-approval-handler-ref=</span><span class="s">&quot;userApprovalHandler&quot;</span>
     <span class="na">token-services-ref=</span><span class="s">&quot;tokenServices&quot;</span>
     <span class="na">check-token-enabled=</span><span class="s">&quot;true&quot;</span>
     <span class="na">check-token-endpoint-url=</span><span class="s">&quot;/oauth/check_token&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;oauth2:authorization-code</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:implicit</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:client-credentials</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:password</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">チェックトークンエンドポイントへのセキュリティ設定を行うために、エンドポイントとして
<code class="docutils literal"><span class="pre">/oauth/*token*/</span></code>配下をアクセス制御の対象として指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;oauth2:authorization-server&gt;</span></code>タグの<code class="docutils literal"><span class="pre">check-token-enabled</span></code>属性に<code class="docutils literal"><span class="pre">true</span></code>を指定することで<code class="docutils literal"><span class="pre">CheckTokenEndpoint</span></code>がコンポーネントとして登録される。</div>
<div class="line">チェックトークンエンドポイントとして、<code class="docutils literal"><span class="pre">/oauth/check_token</span></code>が設定される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>チェックトークンエンドポイントのセキュリティ対策</strong></p>
<p class="last">認可サーバのチェックトークンエンドポイントは、リソースサーバのみアクセス可能とし、リソースサーバ以外が利用できないように制限する必要がある。
本ガイドラインではチェックトークンエンドポイントに対してBasic認証にてアクセス制限を行っているが、可能であればネットワークにて特定URLに対するIP制限など、より上位のアクセス制限を行うことを推奨する。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">TokenServices</span></code>は、共有DBを介して連携させる場合と同様に<code class="docutils literal"><span class="pre">DefaultTokenServices</span></code>を使用する。
<code class="docutils literal"><span class="pre">TokenServices</span></code>が参照する<code class="docutils literal"><span class="pre">TokenStore</span></code>はアプリケーションの要件に合ったインタフェースの実装クラスを使用する。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id81">
<h4><a class="toc-backref" href="#id218">9.9.3.2.2. リソースサーバの設定</a><a class="headerlink" href="#id81" title="Permalink to this headline">¶</a></h4>
<p>リソースサーバの設定ファイルに<code class="docutils literal"><span class="pre">TokenServices</span></code>として<code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>を使用する設定を行う。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;tokenServices&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.RemoteTokenServices&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;checkTokenEndpointUrl&quot;</span> <span class="na">value=</span><span class="s">&quot;${auth.serverUrl}/oauth/check_token&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;clientId&quot;</span> <span class="na">value=</span><span class="s">&quot;${resource.clientId}&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;clientSecret&quot;</span> <span class="na">value=</span><span class="s">&quot;${resource.clientSecret}&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバのチェックトークンエンドポイントにアクセスしてアクセストークンに紐付く情報を取得できるよう、<code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>をBean定義する。</div>
<div class="line">チェックトークンエンドポイントにアクセスするためのURLを<code class="docutils literal"><span class="pre">checkTokenEndpointUrl</span></code>プロパティに設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">clientId</span></code>プロパティに、認可サーバにてリソースサーバを識別するIDを設定する。</div>
<div class="line">設定したIDはチェックトークンエンドポイントにアクセスする際にBasic認証のユーザ名として使用される。</div>
<div class="line">設定するクライアントIDは、認可サーバのクライアント情報に登録しておく必要がある。クライアント情報の登録については<a class="reference internal" href="#oauthauthorizationserverclientauthentication"><span class="std std-ref">クライアントの認証</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">clientSecret</span></code>プロパティに、認可サーバにてリソースサーバの認証に用いるパスワードを設定する。</div>
<div class="line">設定したパスワードは、チェックトークンエンドポイントにアクセスする際にBasic認証のパスワードとして使用される。</div>
<div class="line">設定するパスワードは、認可サーバのクライアント情報に登録されているパスワードと一致する必要がある。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">チェックトークンエンドポイントでアクセストークンの検証エラーが発生した場合、<code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>にHTTPステータスコード400(Bad Request)が返却される。
<code class="docutils literal"><span class="pre">RestTemplate</span></code>のデフォルト実装ではHTTPステータスコード400(Bad Request)が返却された場合、エラーハンドリングを行い<code class="docutils literal"><span class="pre">HttpClientErrorException</span></code>を発生させる。
<code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>がデフォルトで使用する<code class="docutils literal"><span class="pre">RestTemplate</span></code>はアクセストークンの検証エラーをクライアントサーバに連携するために、レスポンスのHTTPステータスコードが400の場合はエラーハンドリングしないよう拡張されている。
<code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>に<code class="docutils literal"><span class="pre">RestTemplate</span></code>をインジェクションした場合、この拡張が適用されなくなるため注意が必要である。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p><code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>をリソースサーバで使用した場合、ハンドラメソッドで<code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>アノテーションを<code class="docutils literal"><span class="pre">String</span></code>に引数アノテーションとして指定することでリソースオーナのユーザ名が取得できる。</p>
<p>実装例は以下のようになる。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;api&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;todos&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">list</span><span class="p">(</span><span class="nd">@AuthenticationPrincipal</span> <span class="n">String</span> <span class="n">userName</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (1)</span>

        <span class="c1">// omitted</span>

    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数 <code class="docutils literal"><span class="pre">userName</span></code>にリソースオーナのユーザ名が格納される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthauthorizationserverhowtogetotherthanusername">
<span id="id82"></span><h4><a class="toc-backref" href="#id219">9.9.3.2.3. リソースサーバへの独自項目連携方法</a><a class="headerlink" href="#oauthauthorizationserverhowtogetotherthanusername" title="Permalink to this headline">¶</a></h4>
<p>認可サーバとリソースサーバ間でDBを共有しない構成の場合でも、ユーザ情報に付随する項目を認可サーバからリソースサーバに連携したいというケースはありうるが、
リソースサーバの使用する<code class="docutils literal"><span class="pre">TokenServices</span></code>として<code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>を使用する場合、リソースサーバのハンドラメソッド引数の<code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>アノテーションではユーザ名以外の情報を取得することができない。</p>
<p>そこで、ここでは<code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>を使用してアクセストークンを連携するときに使用するクラスである<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.DefaultAccessTokenConverter</span></code>を拡張し、
ユーザ名以外の情報をリソースサーバに連携する例を示す。</p>
<div class="section" id="defaultaccesstokenconverter">
<h5><a class="toc-backref" href="#id220">9.9.3.2.3.1. DefaultAccessTokenConverterとは</a><a class="headerlink" href="#defaultaccesstokenconverter" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>を使用したアクセストークンの連携では、<code class="docutils literal"><span class="pre">RestTemplate</span></code>を使用してリソースサーバから認可サーバに対してアクセストークン値に紐づくリソースオーナ、クライアントの認証情報を要求し、結果を<code class="docutils literal"><span class="pre">Map</span></code>として取得する。
このとき、<code class="docutils literal"><span class="pre">DefaultAccessTokenConverter</span></code>は、認可サーバでは認証情報から<code class="docutils literal"><span class="pre">Map</span></code>へ、リソースサーバでは<code class="docutils literal"><span class="pre">Map</span></code>から認証情報へ変換するためのコンバーターとしての役割を持つ。</p>
<p>これを利用し、認可サーバからの返却値を<code class="docutils literal"><span class="pre">Map</span></code>に追加するよう<code class="docutils literal"><span class="pre">DefaultAccessTokenConverter</span></code>の拡張を行うことで、認可サーバ、リソースサーバ間で連携するパラメータをカスタマイズすることが出来るようになる。</p>
<p>以下の説明では、認可サーバ側で<code class="docutils literal"><span class="pre">DefaultAccessTokenConverter</span></code>と、そのプロパティである<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.DefaultUserAuthenticationConverter</span></code>をそれぞれカスタマイズすることで、ユーザ情報に関連した独自項目と、それ以外の独自項目を連携する例を示す。</p>
</div>
<div class="section" id="id83">
<h5><a class="toc-backref" href="#id221">9.9.3.2.3.2. 認可サーバの実装</a><a class="headerlink" href="#id83" title="Permalink to this headline">¶</a></h5>
<p>認可サーバ側の実装方法について説明する。</p>
<p>まず、ユーザ情報に関連した独自項目を追加するため、<code class="docutils literal"><span class="pre">DefaultUserAuthenticationConverter</span></code>を拡張する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">CustomUserAuthenticationConverter.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomUserAuthenticationConverter</span> <span class="kd">extends</span> <span class="n">DefaultUserAuthenticationConverter</span> <span class="p">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="o">?&gt;</span> <span class="n">convertUserAuthentication</span><span class="p">(</span>
            <span class="n">Authentication</span> <span class="n">authentication</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="n">response</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">USERNAME</span><span class="p">,</span> <span class="n">authentication</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">authentication</span><span class="p">.</span><span class="na">getAuthorities</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                <span class="o">!</span><span class="n">authentication</span><span class="p">.</span><span class="na">getAuthorities</span><span class="p">().</span><span class="na">isEmpty</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">response</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">AUTHORITIES</span><span class="p">,</span> <span class="n">AuthorityUtils</span><span class="p">.</span><span class="na">authorityListToSet</span><span class="p">(</span>
                    <span class="n">authentication</span><span class="p">.</span><span class="na">getAuthorities</span><span class="p">()));</span>
        <span class="p">}</span>
        <span class="n">response</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;company_id&quot;</span><span class="p">,</span> <span class="s">&quot;COMZZZ&quot;</span><span class="p">);</span> <span class="c1">// (1)</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースサーバに引き渡す情報を独自項目<code class="docutils literal"><span class="pre">company_id</span></code>として定義し、<code class="docutils literal"><span class="pre">response</span></code>に設定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">response</span></code>に設定した情報は、チェックトークンエンドポイントのトークン検証時にレスポンスBODYとしてJSON形式でリソースサーバへ返却される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>次に、ユーザ情報以外の独自項目を追加するため、<code class="docutils literal"><span class="pre">DefaultAccessTokenConverter</span></code>を拡張する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">CustomAccessTokenConverter.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomAccessTokenConverter</span> <span class="kd">extends</span> <span class="n">DefaultAccessTokenConverter</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="o">?&gt;</span> <span class="n">convertAccessToken</span><span class="p">(</span><span class="n">OAuth2AccessToken</span> <span class="n">token</span><span class="p">,</span> <span class="n">OAuth2Authentication</span> <span class="n">authentication</span><span class="p">)</span> <span class="p">{</span>

        <span class="nd">@SuppressWarnings</span><span class="p">(</span><span class="s">&quot;unchecked&quot;</span><span class="p">)</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span><span class="p">)</span> <span class="kd">super</span><span class="p">.</span><span class="na">convertAccessToken</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">authentication</span><span class="p">);</span>
        <span class="n">response</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;business_id&quot;</span><span class="p">,</span><span class="s">&quot;BIDXXX&quot;</span><span class="p">);</span> <span class="c1">// (1)</span>
        <span class="c1">// omitted</span>

        <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースサーバに引き渡す情報を独自項目<code class="docutils literal"><span class="pre">business_id</span></code>として定義し、<code class="docutils literal"><span class="pre">response</span></code>に設定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">response</span></code>に設定した情報は、チェックトークンエンドポイントのトークン検証時にレスポンスBODYとしてJSON形式でリソースサーバへ返却される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>認可サーバの設定ファイルに、作成した<code class="docutils literal"><span class="pre">CustomUserAuthenticationConverter</span></code>、<code class="docutils literal"><span class="pre">CustomAccessTokenConverter</span></code>の設定を行う。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
     <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span>
     <span class="na">user-approval-handler-ref=</span><span class="s">&quot;userApprovalHandler&quot;</span>
     <span class="na">token-services-ref=</span><span class="s">&quot;tokenServices&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;oauth2:authorization-code</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:implicit</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:client-credentials</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:password</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;checkTokenEndpoint&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.endpoint.CheckTokenEndpoint&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;tokenServices&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;accessTokenConverter&quot;</span> <span class="na">ref=</span><span class="s">&quot;accessTokenConverter&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;accessTokenConverter&quot;</span>
    <span class="na">class=</span><span class="s">&quot;com.example.oauth2.auth.converter.CustomAccessTokenConverter&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;userTokenConverter&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;bean</span>
            <span class="na">class=</span><span class="s">&quot;com.example.oauth2.auth.converter.CustomUserAuthenticationConverter&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">CheckTokenEndpoint</span></code>のBean定義を(2)で独自で行っているため、<code class="docutils literal"><span class="pre">&lt;oauth2:authorization-server&gt;タグ</span></code>の<code class="docutils literal"><span class="pre">check-token-enabled</span></code>属性は指定しない。</div>
<div class="line">トークンチェックエンドポイントとして、<code class="docutils literal"><span class="pre">/oauth/check_token</span></code>が設定される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">CheckTokenEndpoint</span></code>をBean定義する。</div>
<div class="line"><code class="docutils literal"><span class="pre">accessTokenConverter</span></code>プロパティに(3)で定義している<code class="docutils literal"><span class="pre">CustomAccessTokenConverter</span></code>のBeanを指定することで<code class="docutils literal"><span class="pre">CustomAccessTokenConverter</span></code>と<code class="docutils literal"><span class="pre">CustomUserAuthenticationConverter</span></code>に追加した独自項目をリソースサーバに連携するようになる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DefaultAccessTokenConverter</span></code>を拡張した<code class="docutils literal"><span class="pre">CustomAccessTokenConverter</span></code>をBean定義する。</div>
<div class="line"><code class="docutils literal"><span class="pre">userTokenConverter</span></code>プロパティに<code class="docutils literal"><span class="pre">DefaultUserAuthenticationConverter</span></code>を拡張した<code class="docutils literal"><span class="pre">CustomUserAuthenticationConverter</span></code>のBeanを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id84">
<h5><a class="toc-backref" href="#id222">9.9.3.2.3.3. リソースサーバの実装</a><a class="headerlink" href="#id84" title="Permalink to this headline">¶</a></h5>
<p>リソースサーバに、認可サーバから連携された情報をハンドラメソッド引数の<code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>アノテーションで取得できるよう機能の追加を行う。
まず、<code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>アノテーションで取得する情報を保持する<code class="docutils literal"><span class="pre">OauthUser</span></code>クラスを作成する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">ResourceOwner.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OauthUser</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">companyId</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">businessId</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">clientId</span><span class="p">;</span>

    <span class="c1">// omitted</span>

    <span class="kd">public</span> <span class="nf">OauthUser</span><span class="p">(</span><span class="n">String</span> <span class="n">username</span><span class="p">,</span> <span class="n">String</span> <span class="n">companyId</span><span class="p">,</span> <span class="n">String</span> <span class="n">businessId</span><span class="p">,</span> <span class="n">String</span> <span class="n">clientId</span><span class="p">){</span>
        <span class="k">this</span><span class="p">.</span><span class="na">username</span> <span class="o">=</span> <span class="n">username</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="na">companyId</span> <span class="o">=</span> <span class="n">companyId</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="na">businessId</span> <span class="o">=</span> <span class="n">businessId</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="na">clientId</span> <span class="o">=</span> <span class="n">clientId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Getters and Setters are omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>アノテーションでユーザ情報が取得できるように設定を行う<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.DefaultAccessTokenConverter</span></code>を拡張し、ユーザ名以外の情報も取得できるよう機能の追加を行う。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">CustomUserAuthenticationConverter.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomUserAuthenticationConverter</span> <span class="kd">extends</span> <span class="n">DefaultUserAuthenticationConverter</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">userClaimName</span> <span class="o">=</span> <span class="n">USERNAME</span><span class="p">;</span> <span class="c1">// (1)</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUserClaimName</span><span class="p">(</span><span class="n">String</span> <span class="n">claimName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">userClaimName</span> <span class="o">=</span> <span class="n">claimName</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="o">?&gt;</span> <span class="n">convertUserAuthentication</span><span class="p">(</span>
            <span class="n">Authentication</span> <span class="n">authentication</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span><span class="p">();</span>
        <span class="n">response</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">userClaimName</span><span class="p">,</span> <span class="n">authentication</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">authentication</span><span class="p">.</span><span class="na">getAuthorities</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">authentication</span><span class="p">.</span><span class="na">getAuthorities</span><span class="p">().</span><span class="na">isEmpty</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">response</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">AUTHORITIES</span><span class="p">,</span> <span class="n">AuthorityUtils</span><span class="p">.</span><span class="na">authorityListToSet</span><span class="p">(</span><span class="n">authentication</span><span class="p">.</span><span class="na">getAuthorities</span><span class="p">()));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (2)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Authentication</span> <span class="nf">extractAuthentication</span><span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="o">?&gt;</span> <span class="n">map</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="n">userClaimName</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span> <span class="o">=</span> <span class="n">getAuthorities</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
            <span class="n">OauthUser</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OauthUser</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="n">map</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">userClaimName</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="n">map</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;company_id&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="n">map</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;business_id&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="n">map</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;client_id&quot;</span><span class="p">));</span> <span class="c1">// (3)</span>

            <span class="c1">// omitted</span>

            <span class="k">return</span> <span class="k">new</span> <span class="n">UsernamePasswordAuthenticationToken</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s">&quot;N/A&quot;</span><span class="p">,</span> <span class="n">authorities</span><span class="p">);</span> <span class="c1">// (4)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(2)で拡張したいメソッドで利用する<code class="docutils literal"><span class="pre">DefaultUserAuthenticationConverter</span></code>の<code class="docutils literal"><span class="pre">userClaimName</span></code>フィールドがprivateで定義されているため、<code class="docutils literal"><span class="pre">userClaimName</span></code>と使用する<code class="docutils literal"><span class="pre">setUserClaimName</span></code>と<code class="docutils literal"><span class="pre">convertUserAuthentication</span></code>メソッドを拡張する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバから連携された情報から認証情報を抽出するメソッド。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバから連携された情報を<code class="docutils literal"><span class="pre">OauthUser</span></code>クラスに設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UsernamePasswordAuthenticationToken</span></code>の第一引数に<code class="docutils literal"><span class="pre">OauthUser</span></code>を設定することで、認可サーバから連携された情報を<code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>アノテーションで取得できるようになる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>リソースサーバの設定ファイルに、<code class="docutils literal"><span class="pre">CustomUserAuthenticationConverter</span></code>の設定を行う。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;tokenServices&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.RemoteTokenServices&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;checkTokenEndpointUrl&quot;</span> <span class="na">value=</span><span class="s">&quot;${auth.serverUrl}/oauth/check_token&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;accessTokenConverter&quot;</span> <span class="na">ref=</span><span class="s">&quot;accessTokenConverter&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;accessTokenConverter&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.DefaultAccessTokenConverter&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;userTokenConverter&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;com.example.oauth2.resource.converter.CustomUserAuthenticationConverter&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DefaultAccessTokenConverter</span></code>をBean定義する。ユーザ名以外の情報を<code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>アノテーションで取得できるようにするため、<code class="docutils literal"><span class="pre">userTokenConverter</span></code>プロパティに<code class="docutils literal"><span class="pre">CustomUserAuthenticationConverter</span></code>クラスを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="section" id="id85">
<h3><a class="toc-backref" href="#id223">9.9.3.3. 認可サーバにおけるパスのカスタマイズ</a><a class="headerlink" href="#id85" title="Permalink to this headline">¶</a></h3>
<p>認可サーバではエンドポイントと、特定の状況が起きたときのフォワード先についてパスを変更することができる。
本節では、認可サーバにおけるパス、および関連箇所の設定変更方法を説明する。</p>
<div class="section" id="customizableurl">
<span id="id86"></span><h4><a class="toc-backref" href="#id224">9.9.3.3.1. カスタマイズ可能なパス</a><a class="headerlink" href="#customizableurl" title="Permalink to this headline">¶</a></h4>
<p>How to useにて説明したとおり、認可サーバでは<code class="docutils literal"><span class="pre">&lt;oauth2:authorization-server&gt;</span></code>タグによる定義を行うことで、
RFCに準拠したエンドポイントや、認可サーバ内でフォワードされたリクエストを処理するためのControllerがコンポーネントとして登録される。
また、認可サーバがクライアントやリソースサーバに公開するエンドポイントは、&lt;oauth2:authorization-server&gt;タグの
属性値を変更することにより、カスタマイズが可能である。</p>
<p>以下に、コンポーネントとして登録されるエンドポイント、およびフォワード先のデフォルトパスと、
エンドポイントのカスタマイズ時に変更する&lt;oauth2:authorization-server&gt;タグの属性値を示す。</p>
<table border="1" class="colwidths-given longtable docutils" id="id121">
<caption><span class="caption-text"><strong>エンドポイント</strong></span><a class="headerlink" href="#id121" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="20%" />
<col width="20%" />
<col width="20%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">名前</th>
<th class="head">属性値</th>
<th class="head">デフォルトパス</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">認可エンドポイント</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">authorization-endpoint-url</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">/oauth/authorized</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントがリソースオーナから認可を得るために利用するエンドポイント。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">トークンエンドポイント</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">token-endpoint-url</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">/oauth/token</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントがアクセストークンを発行するために利用するエンドポイント。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">チェックトークンエンドポイント</div>
<div class="line">(<a class="reference internal" href="#oauthauthorizationserverhowtocooperatewithhttp"><span class="std std-ref">HTTPアクセスを介した認可サーバとリソースサーバの連携</span></a>の実装を行っている場合のみ設定する。)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">check-token-endpoint-url</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">/oauth/check_token</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースサーバがアクセストークンを検証するために利用するエンドポイント。</div>
<div class="line">HTTPアクセスを介してアクセストークンの連携を行う場合に利用する。なお、本エンドポイントは、</div>
<div class="line">RFCの定めるエンドポイントではなく、Spring Security OAuthが独自に拡張したエンドポイントである。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id122">
<caption><span class="caption-text"><strong>フォワード先</strong></span><a class="headerlink" href="#id122" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="20%" />
<col width="20%" />
<col width="20%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">名前</th>
<th class="head">属性値</th>
<th class="head">デフォルトパス</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">認可取得時のフォワード先</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">user-approval-page</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">/oauth/confirm_access</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナに認可画面を返却するために利用するフォワード先。</div>
<div class="line">認可サーバの処理内で利用するパスであり、クライアントやリソースサーバには公開しない。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">不正クライアントエラー発生時のフォワード先</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">error-page</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">/oauth/error</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナに認可エンドポイントにおけるエラーを通知するために利用するフォワード先。</div>
<div class="line">認可サーバの処理内で利用するパスであり、クライアントやリソースサーバには公開しない。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>これらのパスは認可サーバ側の設定を変更することにより、カスタマイズが可能である。
具体的な設定方法を以降に示す。</p>
</div>
<div class="section" id="customizepath">
<span id="id87"></span><h4><a class="toc-backref" href="#id225">9.9.3.3.2. パスのカスタマイズ</a><a class="headerlink" href="#customizepath" title="Permalink to this headline">¶</a></h4>
<div class="section" id="customizeendpoint">
<span id="id88"></span><h5><a class="toc-backref" href="#id226">9.9.3.3.2.1. エンドポイントのカスタマイズ</a><a class="headerlink" href="#customizeendpoint" title="Permalink to this headline">¶</a></h5>
<p>前述のとおり、各エンドポイントは、&lt;oauth2:authorization-server&gt;タグの属性値を変更することにより、カスタマイズが可能である。</p>
<p>エンドポイントを変更する際の実装例を以下に示す。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
    <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span>
    <span class="na">user-approval-handler-ref=</span><span class="s">&quot;userApprovalHandler&quot;</span>
    <span class="na">token-services-ref=</span><span class="s">&quot;tokenServices&quot;</span>
    <span class="na">token-endpoint-url=</span><span class="s">&quot;/api/token&quot;</span>
    <span class="na">authorization-endpoint-url=</span><span class="s">&quot;/api/authorize&quot;</span>
    <span class="na">check-token-endpoint-url=</span><span class="s">&quot;/api/check_token&quot;</span>
    <span class="na">check-token-enabled=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>

<span class="nt">&lt;sec:http</span> <span class="na">pattern=</span><span class="s">&quot;/api/*token*/**&quot;</span>
    <span class="na">authentication-manager-ref=</span><span class="s">&quot;clientAuthenticationManager&quot;</span> <span class="na">realm=</span><span class="s">&quot;Realm&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;oauth2:authorization-server&gt;</span></code>タグの変更したいエンドポイントに対する属性値（<code class="docutils literal"><span class="pre">authorization-endpoint-url</span></code>、
<code class="docutils literal"><span class="pre">token-endpoint-url</span></code>、<code class="docutils literal"><span class="pre">check-token-endpoint-url</span></code>）にURLを設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークン操作に関するエンドポイントのURLを含むように、アクセス制御の対象を変更する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>変更したエンドポイントに合わせて、エンドポイントを参照する設定を変更する必要がある。
認可サーバでは、<a class="reference internal" href="#oauthauthorizationserverresourceownerauthentication"><span class="std std-ref">リソースオーナの認証</span></a>の<code class="docutils literal"><span class="pre">spring-security.xml</span></code>と
<a class="reference internal" href="#oauthauthorizationserverhowtocustomizeauthorizeview"><span class="std std-ref">スコープ認可画面のカスタマイズ</span></a>の<code class="docutils literal"><span class="pre">oauthConfirm.jsp</span></code>のエンドポイント設定を参照されたい。</p>
<p>また、クライアントの実装を行っている場合は、認可リクエストの設定として認可サーバのエンドポイントを設定しているため、
<a class="reference internal" href="#oauth2resttemplatesettings"><span class="std std-ref">OAuth2RestTemplateの設定</span></a>の<code class="docutils literal"><span class="pre">oauth2-client.xml</span></code>も参照されたい。</p>
</div>
<div class="section" id="customizeforward">
<span id="id89"></span><h5><a class="toc-backref" href="#id227">9.9.3.3.2.2. フォワード先のカスタマイズ</a><a class="headerlink" href="#customizeforward" title="Permalink to this headline">¶</a></h5>
<p>リソースオーナからの認可の取得時に、デフォルト設定では<code class="docutils literal"><span class="pre">/oauth/confirm_access</span></code>にフォワードされる。
また、認可エンドポイントで不正クライアントエラーが発生した際には、デフォルト設定では<code class="docutils literal"><span class="pre">/oauth/error</span></code>にフォワードされる。
これらのフォワード先は変更が可能である。</p>
<p>フォワード先を変更する際の実装例を以下に示す。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
    <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span>
    <span class="na">user-approval-handler-ref=</span><span class="s">&quot;userApprovalHandler&quot;</span>
    <span class="na">token-services-ref=</span><span class="s">&quot;tokenServices&quot;</span>
    <span class="na">error-page=</span><span class="s">&quot;forward:/api/error&quot;</span>
    <span class="na">user-approval-page=</span><span class="s">&quot;forward:/api/confirm_access&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;oauth2:authorization-server&gt;</span></code>タグの変更したいフォワード先に対する属性値（<code class="docutils literal"><span class="pre">error-page</span></code>または<code class="docutils literal"><span class="pre">user-approval-page</span></code>）にURLを設定する。
設定するURLは先頭に<code class="docutils literal"><span class="pre">forward:</span></code>を付ける必要がある。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>フォワード先を変更した際は対応するコントローラについても変更する必要があるため注意されたい。
本実装例では以下を参照されたい。</p>
<ul class="simple">
<li><a class="reference internal" href="#oauthauthorizationserverhowtocustomizeauthorizeview"><span class="std std-ref">スコープ認可画面のカスタマイズ</span></a>の<code class="docutils literal"><span class="pre">OAuth2ApprovalController.java</span></code></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtohandleerror"><span class="std std-ref">認可リクエスト時のエラー画面のカスタマイズ</span></a>の<code class="docutils literal"><span class="pre">OAuth2ErrorController.java</span></code></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="appendix">
<span id="oauthappendix"></span><h2><a class="toc-backref" href="#id228">9.9.4. Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this headline">¶</a></h2>
<div class="section" id="oauthappendixoccuringerrors">
<span id="id90"></span><h3><a class="toc-backref" href="#id229">9.9.4.1. クライアントから認可サーバ、リソースサーバアクセス時に発生するエラー</a><a class="headerlink" href="#oauthappendixoccuringerrors" title="Permalink to this headline">¶</a></h3>
<p>本ガイドラインではクライアントから認可サーバ、リソースサーバアクセス時に発生するエラーについて、リソースオーナの操作によって発生するエラーのハンドリング方法を記載している。
リソースオーナの操作起因以外のエラーも含め、発生するエラーについて以下に説明する。</p>
<div class="section" id="id91">
<h4><a class="toc-backref" href="#id230">9.9.4.1.1. 認可エンドポイントで発生するエラー</a><a class="headerlink" href="#id91" title="Permalink to this headline">¶</a></h4>
<p>認可エンドポイントで発生するエラーは不正クライアントエラーとそれ以外に分類され、不正クライアントエラーの場合は認可サーバでエラー画面にフォワードされることでエラー通知される。
不正クライアントエラーの詳細については<a class="reference internal" href="#definitionofbadclienterror"><span class="std std-ref">不正クライアントエラー</span></a>を参照されたい。
認可エンドポイントで発生する不正クライアントエラーについて以下で説明する。</p>
<table border="1" class="colwidths-given longtable docutils" id="id123">
<caption><span class="caption-text"><strong>認可エンドポイントで発生する不正クライアントエラー</strong></span><a class="headerlink" href="#id123" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">発生するエラー</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアント未存在エラー</div>
<div class="line"><code class="docutils literal"><span class="pre">NoSuchClientException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザエージェントを認可サーバへアクセスさせたクライアントが、認可サーバの保持するクライアント情報に登録されていない場合に発生する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リダイレクトURI不一致エラー</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.common.exceptions.RedirectMismatchException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントがパラメータとして認可サーバに渡したリダイレクトURIのホストとルートパスが、認可サーバに登録されているリダイレクトURIと一致しない場合に発生する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>発生したエラーが不正クライアントエラー以外の場合はクライアントにリクエストパラメータとしてエラー情報（<code class="docutils literal"><span class="pre">error</span></code>、<code class="docutils literal"><span class="pre">error_description</span></code>）が通知され、<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>にて例外に復元されスローされる。
認可エンドポイントで発生する不正クライアントエラー以外のエラーについて以下で説明する。</p>
<table border="1" class="colwidths-given longtable docutils" id="id124">
<caption><span class="caption-text"><strong>認可エンドポイントで発生する不正クライアントエラー以外のエラー</strong></span><a class="headerlink" href="#id124" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">発生するエラー</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">スコープ検証エラー</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.common.exceptions.InvalidScopeException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントが指定したスコープが、認可サーバの保持するクライアント情報に存在しない場合に発生する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエスト検証エラー</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.common.exceptions.InvalidRequestException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可後の遷移先を示すリダイレクトURIが設定されていない場合や認可画面を表示せずに認可が行われた場合に発生する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">レスポンスタイプエラー</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.common.exceptions.UnsupportedResponseTypeException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントが指定した<code class="docutils literal"><span class="pre">response_type</span></code>パラメータを認可サーバがサポートしない場合に発生する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">グラントタイプエラー</div>
<div class="line"><code class="docutils literal"><span class="pre">InvalidGrantException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントが使用できるグラントタイプがない場合や、認可コードグラント、インプリシットグラント以外のリダイレクトURIを使用出来ないグラントタイプが指定された場合に発生する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナによる認可拒否</div>
<div class="line"><code class="docutils literal"><span class="pre">UserDeniedAuthorizationException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナがスコープ認可画面で、クライアントが指定したスコープを全て拒否した場合に発生する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナ未認証エラー</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.authentication.InsufficientAuthenticationException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可エンドポイントへアクセス時にリソースオーナがユーザ認証を行っていない場合に発生する。認可サーバで適切なセキュリティ設定を行っていれば発生しない。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id92">
<h4><a class="toc-backref" href="#id231">9.9.4.1.2. トークンエンドポイントで発生するエラー</a><a class="headerlink" href="#id92" title="Permalink to this headline">¶</a></h4>
<p>トークンエンドポイントでエラーが発生した場合、クライアントの<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>で<code class="docutils literal"><span class="pre">OAuth2AccessDeniedException</span></code>にラップされる。
トークンエンドポイントで発生するエラーについて以下で説明する。</p>
<table border="1" class="colwidths-given longtable docutils" id="id125">
<caption><span class="caption-text"><strong>トークンエンドポイントで発生するエラー</strong></span><a class="headerlink" href="#id125" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">発生するエラー</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Basic認証エラー</div>
<div class="line"><code class="docutils literal"><span class="pre">HttpClientErrorException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントのBasic認証に失敗した場合に発生する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアント未認証エラー</div>
<div class="line"><code class="docutils literal"><span class="pre">InsufficientAuthenticationException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">トークンエンドポイントの処理前に認証が行われていない場合に発生する。認可サーバで適切なセキュリティ設定を行っていれば発生しない。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">スコープ検証エラー</div>
<div class="line"><code class="docutils literal"><span class="pre">InvalidScopeException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントが指定したスコープが、認可サーバの保持するクライアント情報に存在しない場合に発生する。</div>
<div class="line">認可コードグラント使用時は認可エンドポイントでエラーとなるため<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を使用していれば発生しない。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナ認証エラー</div>
<div class="line"><code class="docutils literal"><span class="pre">InvalidGrantException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナパスワードクレデンシャルグラント使用時に提示したリソースオーナの認証情報に誤りがある場合に発生する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可コード未存在エラー</div>
<div class="line"><code class="docutils literal"><span class="pre">InvalidGrantException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可コードグラント使用時に、クライアントから認可サーバに渡した認可コードが認可サーバに存在しない場合に発生する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>本ガイドラインでは、クライアントとしてSpring Security OAuthの<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を利用する前提であり、
<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>が自動的に管理している設定に関してエラーが発生しない構造となっている。
Spring Security OAuthを使用せずにクライアントを開発する場合のために、Spring Security OAuthの<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を使用しない場合に発生するエラーについて以下で説明する。</p>
<table border="1" class="colwidths-given longtable docutils" id="id126">
<caption><span class="caption-text"><strong>【参考】トークンエンドポイントで発生するエラー（OAuth2RestTemplateを使用しない場合）</strong></span><a class="headerlink" href="#id126" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">発生するエラー</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアント検証エラー</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.common.exceptions.InvalidClientException</span></code></div>
</div>
</td>
<td><div class="first line-block">
<div class="line">認証済みクライアントとリクエストパラメータに設定されているクライアントが不一致の場合に発生する。</div>
<div class="line">具体的にはトークンエンドポイントで認証したクライアントのクライアントIDと以下のクライアントIDが一致しない場合に発生する。</div>
</div>
<ul class="last simple">
<li>認可リクエストのリクエストパラメータに設定されているクライアントID</li>
<li>アクセストークンリクエストのリクエストパラメータに設定されているクライアントID</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">グラントタイプエラー</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.common.exceptions.UnsupportedGrantTypeException</span></code></div>
</div>
</td>
<td><div class="first line-block">
<div class="line">トークンエンドポイントへのリクエストに指定した<code class="docutils literal"><span class="pre">grant_type</span></code>パラメータに誤りがある場合に発生する。</div>
</div>
<ul class="last simple">
<li>クライアントが指定したグラントタイプが認可サーバがサポートしていないグラントタイプの場合</li>
<li>リフレッシュトークンをサポートしていない認可サーバにリフレッシュトークンを使用した場合</li>
</ul>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエスト検証エラー</div>
<div class="line"><code class="docutils literal"><span class="pre">InvalidRequestException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">トークンエンドポイントへのリクエストに<code class="docutils literal"><span class="pre">grant_type</span></code>パラメータが存在しない場合に発生する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リダイレクトURI検証エラー</div>
<div class="line"><code class="docutils literal"><span class="pre">RedirectMismatchException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可エンドポイントアクセス時に使用したリダイレクトURIと、トークンエンドポイントアクセス時にパラメータに設定したリダイレクトURIが一致しない場合に発生する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id93">
<h4><a class="toc-backref" href="#id232">9.9.4.1.3. リソースサーバで発生するエラー</a><a class="headerlink" href="#id93" title="Permalink to this headline">¶</a></h4>
<p>リソースサーバでエラーが発生した場合、クライアントの<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>の処理は発生したエラーによって異なる。
リソースサーバで発生するエラーについて以下で説明する。</p>
<table border="1" class="colwidths-given longtable docutils" id="id127">
<caption><span class="caption-text"><strong>リソースサーバで発生するエラー</strong></span><a class="headerlink" href="#id127" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">発生するエラー</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">スコープ検証エラー</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.common.exceptions.InsufficientScopeException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">保護されたリソースへのアクセスに必要なスコープが、アクセストークンが保持するスコープに存在しなかった場合に発生する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースID検証エラー</div>
<div class="line"><code class="docutils literal"><span class="pre">UserDeniedAuthorizationException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">保護されたリソースへのアクセスに必要なリソースIDが、アクセストークンに紐付くクライアント情報のリソースIDに存在しなかった場合に発生する。</div>
<div class="line">クライアントの<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>で<code class="docutils literal"><span class="pre">OAuth2AccessDeniedException</span></code>にラップされる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークン検証エラー</div>
<div class="line"><code class="docutils literal"><span class="pre">InvalidTokenException</span></code></div>
</div>
</td>
<td><div class="first line-block">
<div class="line">リソースサーバが受け取ったアクセストークンの正当性を確認出来ない場合（異常系）や、アクセストークンの有効期限が切れている場合（正常系）に発生する。</div>
<div class="line"><br /></div>
<div class="line">アクセストークン検証エラーは正常系と異常系が混在しているため、インプリシットグラント等<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を利用しない場合にこのエラーを受け取った場合、アクセストークンの有効期限切れかどうか判定する必要がある。</div>
<div class="line">具体的な実装例については、<a class="reference internal" href="#oauthclientusingjavascript"><span class="std std-ref">JavaScriptを使用したリソースサーバへのアクセス</span></a>を参照されたい。</div>
</div>
<div class="last admonition note">
<p class="first admonition-title">Note</p>
<p class="last">本ガイドラインにおいてインプリシットグラント以外のグラントタイプでは<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を利用している。
<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>は、リソースサーバへのアクセス前にアクセストークンの有効期限チェックを行い、有効期限が切れていた場合にはアクセストークンの再発行を行っているため、
通常はリソースサーバでアクセストークンの有効期限切れは発生しない。
<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>はアクセストークン取得後すぐにリソースにアクセスする構造のため、アクセストークンの取得直後に<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>では有効期限内にも関わらず、
リソースサーバで有効期限切れととなる状態は、アクセストークンの発行に何らかの問題があることになる。この場合、<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>で<code class="docutils literal"><span class="pre">AccessTokenRequiredException</span></code>がスローされる。</p>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">チェックトークンエンドポイントBasic認証エラー</div>
<div class="line"><code class="docutils literal"><span class="pre">HttpClientErrorException</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#oauthauthorizationserverhowtocooperatewithhttp"><span class="std std-ref">HTTPアクセスを介した認可サーバとリソースサーバの連携</span></a>において、チェックトークンエンドポイントへアクセス時にBasic認証に失敗した場合に発生する。</div>
<div class="line">クライアントでエラーハンドリングを行う場合は、リソースサーバからクライアントに適切なエラーを返却するようリソースサーバでエラーハンドリングを行う必要がある。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="id94">
<h3><a class="toc-backref" href="#id233">9.9.4.2. Spring Security OAuthの拡張について</a><a class="headerlink" href="#id94" title="Permalink to this headline">¶</a></h3>
<p>RFC 6749の <a class="reference external" href="https://tools.ietf.org/html/rfc6749#section-8">8. Extensibility</a>にはOAuth 2.0の拡張仕様が定められいる。
OAuth 2.0による認可機能を提供するアプリケーションではこれに沿ってカスタマイズすることが可能である。</p>
<p>Spring Security OAuthでは、前述のRFC 6749に規定された拡張ポイントに対してどのようにサポートしているかは明示的に公表されていないが、
以下の拡張ポイントがサポートされていると考えられる。</p>
<ul class="simple">
<li><a class="reference external" href="https://tools.ietf.org/html/rfc6749#section-8.1">8.1 Defining Access Token Types</a></li>
<li><a class="reference external" href="https://tools.ietf.org/html/rfc6749#section-8.2">8.2 Defining New Endpoint Parameters</a></li>
<li><a class="reference external" href="https://tools.ietf.org/html/rfc6749#section-8.3">8.3 Defining New Authorization Grant Types</a></li>
</ul>
<p>本節では、特に<a class="reference external" href="https://tools.ietf.org/html/rfc6749#section-8.2">8.2 Defining New Endpoint Parameters</a>に関連するアクセストークンリクエストとそのレスポンスの拡張ポイントについて主要なコンポーネントと処理の流れを解説する。</p>
<div class="section" id="id96">
<h4><a class="toc-backref" href="#id234">9.9.4.2.1. アクセストークンリクエストとそのレスポンスの拡張</a><a class="headerlink" href="#id96" title="Permalink to this headline">¶</a></h4>
<p>アクセストークンリクエストとそのレスポンスの拡張ポイントとして、
任意のパラメータやヘッダをリクエストやレスポンスに付与することができる。</p>
<p>ただし、認可リクエストには前述したような拡張ポイントが設けられていない。
そのため、例えば認可リクエストに独自のパラメータを追加したい場合には、
Spring Security OAuthのAPI自体を改修する必要があり、比較的大きな改修が必要となることに注意されたい。</p>
<div class="section" id="oauthappendixclient">
<span id="id97"></span><h5><a class="toc-backref" href="#id235">9.9.4.2.1.1. クライアント</a><a class="headerlink" href="#oauthappendixclient" title="Permalink to this headline">¶</a></h5>
<p>クライアントでは、アクセストークンリクエストの拡張ポイントとして、
<code class="docutils literal"><span class="pre">RequestEnhancer</span></code>インタフェースが用意されている。
以下に拡張ポイントに関連する主要なコンポーネント、およびその関連図を示す。</p>
<table border="1" class="colwidths-given longtable docutils" id="id128">
<caption><span class="caption-text"><strong>クライアントの主要なコンポーネント</strong></span><a class="headerlink" href="#id128" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">クラス・インタフェース名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RestTemplate</span></code>を拡張しOAuth 2.0向けの機能を追加したクラス。</div>
<div class="line">グラントタイプに応じたアクセストークンの取得など、OAuth 2.0独自の機能を持つ。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2ProtectedResourceDetails</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースサーバが保持するリソースにアクセスするための詳細情報のインタフェース。</div>
<div class="line">グラントタイプに応じたパラメータを保持するために派生クラスが提供されており、認可コードグラントの場合は<code class="docutils literal"><span class="pre">AuthorizationCodeResourceDetails</span></code>が実装クラスとなる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AccessTokenProvider</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバよりアクセストークンを取得するための機能を提供するインタフェース。</div>
<div class="line">グラントタイプに応じた派生クラスが提供されており、グラントタイプごとのプロバイダは必ず
<code class="docutils literal"><span class="pre">AccessTokenProvider</span></code>を実装して<code class="docutils literal"><span class="pre">OAuth2AccessTokenSupport</span></code>を継承している。</div>
<div class="line">認可コードグラントの場合は<code class="docutils literal"><span class="pre">AuthorizationCodeAccessTokenProvider</span></code>が実装クラスとなる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2AccessTokenSupport</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバよりアクセストークンを取得するための機能を提供する基底クラス。</div>
<div class="line">グラントタイプ共通の処理として、認可サーバに対してアクセストークンリクエストを送信する機能を提供している。</div>
<div class="line">アクセストークンリクエストの生成には、後述する<code class="docutils literal"><span class="pre">ClientAuthenticationHandler</span></code>と<code class="docutils literal"><span class="pre">RequestEnhancer</span></code>を使用している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthorizationCodeAccessTokenProvider</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可コードグラントにてアクセストークンを取得するための機能を提供するクラス。</div>
<div class="line">認可コードグラント独自の処理として、認可リクエストを作成する機能を提供している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ClientAuthenticationHandler</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2ProtectedResourceDetails</span></code>をもとにヘッダ、またはフォームにクライアント認証情報を設定するための
機能を提供するインタフェース。<code class="docutils literal"><span class="pre">DefaultClientAuthenticationHandler</span></code>がデフォルトの実装クラスとなる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RequestEnhancer</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークンリクエストおよび<code class="docutils literal"><span class="pre">OAuth2ProtectedResourceDetails</span></code>をもとにヘッダ、またはフォームに
パラメータを設定するための機能を提供するインタフェース。
<code class="docutils literal"><span class="pre">DefaultRequestEnhancer</span></code>がデフォルトの実装クラスとなる。</div>
<div class="line"><strong>アクセストークンリクエストにおける拡張ポイントの一つ。</strong></div>
<div class="line"><br /></div>
<div class="line">なお、リクエストパラメータに独自の項目を追加したい場合は、デフォルトで使用される<code class="docutils literal"><span class="pre">DefaultRequestEnhancer</span></code>の
Bean定義を変更するだけで良く、独自に<code class="docutils literal"><span class="pre">RequestEnhancer</span></code>の実装クラスを作成する必要はない。</div>
<div class="line"><br /></div>
<div class="line">具体的には、以下のようにBean定義すれば良い。</div>
<div class="line"><br /></div>
<div class="line">(1) <code class="docutils literal"><span class="pre">DefaultRequestEnhancer</span></code></div>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">parameterIncludes</span></code>属性に追加するパラメータのキー値を設定する</div>
</div>
<div class="line">(2) <code class="docutils literal"><span class="pre">AuthorizationCodeAccessTokenProvider</span></code></div>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">tokenRequestEnhancer</span></code>属性に(1)の<code class="docutils literal"><span class="pre">DefaultRequestEnhancer</span></code>を設定する</div>
</div>
<div class="line">(3) <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code></div>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">access-token-provider</span></code>属性に(2)の<code class="docutils literal"><span class="pre">AuthorizationCodeAccessTokenProvider</span></code>を設定する</div>
</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>例として、認可コードグラントにおける、クライアントからリソースにアクセスする時のフローを以下に示す。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ClientAccessTokenRequest.png"><img alt="../_images/OAuth_ClientAccessTokenRequest.png" src="../_images/OAuth_ClientAccessTokenRequest.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id129">
<caption><span class="caption-text"><strong>クライアントの動き（アクセストークンリクエスト）</strong></span><a class="headerlink" href="#id129" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースサーバが保持しているリソースにアクセスする際、<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>の呼び出しが行われることでクライアント側の処理が開始される。</div>
<div class="line">認可コード発行までのクライアント側のフローについては、<a class="reference internal" href="#client"><span class="std std-ref">クライアント</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可コード発行後、認可サーバのリダイレクトにより再度<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>の呼び出しが行われる。
このとき、認可コードはセッション(<code class="docutils literal"><span class="pre">OAuth2ClientContext</span></code>)に保持される。</div>
<div class="line"><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>では、<code class="docutils literal"><span class="pre">OAuth2ProtectedResourceDetails</span></code>に定義しているグラントタイプに応じて<code class="docutils literal"><span class="pre">AccessTokenProvider</span></code>の呼び出しを行う。</div>
<div class="line"><code class="docutils literal"><span class="pre">AuthorizationCodeAccessTokenProvider</span></code>が<code class="docutils literal"><span class="pre">AccessTokenProvider</span></code>の実装クラスとして呼び出される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthorizationCodeAccessTokenProvider</span></code>では、<code class="docutils literal"><span class="pre">OAuth2AccessTokenSupport</span></code>が保持する<code class="docutils literal"><span class="pre">ClientAuthenticationHandler</span></code>からはクライアント認証情報を、
<code class="docutils literal"><span class="pre">RequestEnhancer</span></code>からはリクエストパラメータをヘッダ、またはフォームに設定し、アクセストークンリクエストを作成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2AccessTokenSupport</span></code>は(3)にて作成したリクエストを使用し、認可サーバに対してアクセストークンリクエストを送信する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバでは、クライアントを認証し認可グラントの正当性を確認する。</div>
<div class="line">認可グラントが正当な場合、アクセストークンを発行する。</div>
<div class="line">アクセストークン発行のフローについては、<a class="reference internal" href="#issueofaccesstoken"><span class="std std-ref">アクセストークンの発行</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AccessTokenProvider</span></code>は取得したアクセストークンを<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>に返却する。</div>
<div class="line"><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>では、セッション(<code class="docutils literal"><span class="pre">OAuth2ClientContext</span></code>)にアクセストークンを保持し、それを用いてリソースサーバに対してリクエストを送信する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthappendixauthorizationserver">
<span id="id98"></span><h5><a class="toc-backref" href="#id236">9.9.4.2.1.2. 認可サーバ</a><a class="headerlink" href="#oauthappendixauthorizationserver" title="Permalink to this headline">¶</a></h5>
<p>認可サーバでは、アクセストークンレスポンスの拡張ポイントとして、
<code class="docutils literal"><span class="pre">TokenEnhancer</span></code>インタフェースが用意されている。
以下に拡張ポイントに関連する主要なコンポーネント、およびその関連図を示す</p>
<table border="1" class="colwidths-given longtable docutils" id="id130">
<caption><span class="caption-text"><strong>認可サーバの主要なコンポーネント</strong></span><a class="headerlink" href="#id130" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">クラス・インタフェース名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AbstractEndpoint</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバにおいて、クライアントからのリクエストを受けるエンドポイントの共通的な機能を提供する基底クラス。
<code class="docutils literal"><span class="pre">TokenEndpoint</span></code>が実装クラスとなる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">TokenEndpoint</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントからのリクエストに対し、アクセストークンを発行するためのエンドポイントの機能を提供するクラス。</div>
<div class="line">クライアントや、リクエストパラメータに含まれるパラメータを検証する機能を持つ。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ClientDetailsService</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OAuth 2.0機能を利用するクライアントを検証するための機能を提供するインタフェース。</div>
<div class="line">クライアント情報を管理する媒体ごとに派生クラスが提供されており、<code class="docutils literal"><span class="pre">JdbcClientDetailsService</span></code>、<code class="docutils literal"><span class="pre">InMemoryClientDetailsService</span></code>が実装クラスとなる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">TokenGranter</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークンを発行するための機能を提供するインタフェース。</div>
<div class="line">グラントタイプに応じた派生クラスが提供されており、グラントタイプごとのプロバイダは必ず<code class="docutils literal"><span class="pre">TokenGranter</span></code>を実装して<code class="docutils literal"><span class="pre">AbstractTokenGranter</span></code>を継承している。</div>
<div class="line">認可コードグラントの場合は<code class="docutils literal"><span class="pre">AuthorizationCodeTokenGranter</span></code>が実装クラスとなる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AbstractTokenGranter</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークンを発行するための機能を提供する基底クラス。</div>
<div class="line">リクエストパラメータからクライアント情報を取得し、グラントタイプの検証と固有処理の呼び出しを行う機能を持つ。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthorizationCodeTokenGranter</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可コードグラントにてアクセストークンを発行するための機能を提供するクラス。</div>
<div class="line">認可コードグラント独自の処理として、アクセストークンリクエストに含まれる認可コードやリダイレクトURIを検証する機能を提供している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthorizationCodeServices</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可コードグラントにて認可コードの発行、および管理をするための機能を提供するインタフェース。</div>
<div class="line">認可コードを管理する媒体ごとに派生クラスが提供されており、<code class="docutils literal"><span class="pre">JdbcAuthorizationServerTokenServices</span></code>、<code class="docutils literal"><span class="pre">InMemoryAuthorizationServerTokenServices</span></code>が実装クラスとなる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバとして必要となる、アクセストークンやリフレッシュトークンを発行するための機能を提供するインタフェース。<code class="docutils literal"><span class="pre">DefaultTokenServices</span></code>がデフォルトの実装クラスとなる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">TokenEnhancer</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code>によって生成されたトークンに追加情報等を付与するための機能を提供するインタフェース。</div>
<div class="line">本インタフェースを拡張することでアクセストークンとして管理する情報、およびクライアントに返却する情報に独自パラメータを付与することが出来る。</div>
<div class="line"><strong>アクセストークンレスポンスにおける拡張ポイントの一つ。</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">TokenStore</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークンを管理するための機能を提供するインタフェース。</div>
<div class="line">アクセストークンを管理する媒体ごとに派生クラスが提供されており、<code class="docutils literal"><span class="pre">JdbcTokenStore</span></code>、<code class="docutils literal"><span class="pre">InMemoryTokenStore</span></code>などが実装クラスとなる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>例として、認可コードグラントにおける、認可サーバのトークンエンドポイントアクセス時のフローを以下に示す。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_AutohrizationServerAccessTokenResponse.png"><img alt="../_images/OAuth_AutohrizationServerAccessTokenResponse.png" src="../_images/OAuth_AutohrizationServerAccessTokenResponse.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id131">
<caption><span class="caption-text"><strong>認可サーバの動き（アクセストークンレスポンス）</strong></span><a class="headerlink" href="#id131" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">TokenEndpoint</span></code>の呼び出しが行われることで認可サーバ側の処理が開始される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">TokenEndpoint</span></code>では、<code class="docutils literal"><span class="pre">AbstractEndpoint</span></code>が保持する<code class="docutils literal"><span class="pre">ClientDetailsService</span></code>の呼び出しを行いアクセストークンリクエストに含まれる
クライアント情報やパラメータの検証後、<code class="docutils literal"><span class="pre">TokenGranter</span></code>の呼び出しを行う。</div>
<div class="line"><code class="docutils literal"><span class="pre">AuthorizationCodeTokenGranter</span></code>が<code class="docutils literal"><span class="pre">TokenGranter</span></code>の実装クラスとなる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">TokenGranter</span></code>では、まず基底クラスである<code class="docutils literal"><span class="pre">AbstractTokenGranter</span></code>の処理が行われる。</div>
<div class="line"><code class="docutils literal"><span class="pre">AbstractTokenGranter</span></code>では、<code class="docutils literal"><span class="pre">ClientDetailsService</span></code>の呼び出しを行うことでリクエストパラメータに指定されたクライアント情報を取得し、
グラントタイプの検証後、グラントタイプ固有の処理（<code class="docutils literal"><span class="pre">AuthorizationCodeTokenGranter</span></code>）の呼び出しを行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthorizationCodeTokenGranter</span></code>では、リクエストパラメータから取得した認可コードを指定して<code class="docutils literal"><span class="pre">AuthorizationCodeServices</span></code>の呼び出しを行い、発行済み認可コードの削除を行うとともに認可リクエスト時の情報を取得する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthorizationCodeServices</span></code>では、認可コードグラントのアクセストークンリクエストパラメータとして指定されたクライアントID、リダイレクトURIと(4)にて取得した認可リクエストの内容を比較し、アクセストークンリクエストの妥当性の検証を行う。</div>
<div class="line">検証結果に問題がない場合、リクエストパラメータと認可リクエスト時に取得したリソースオーナの認証情報（ユーザ名など）より、認証情報を作成し呼び出し元に返却する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AbstractTokenGranter</span></code>では、<code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code>のアクセストークン取得処理の呼び出しを行う。</div>
<div class="line"><code class="docutils literal"><span class="pre">DefaultTokenServices</span></code>が<code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code>の実装クラスとなる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DefaultTokenServices</span></code>ではアクセストークンを作成する。</div>
<div class="line"><code class="docutils literal"><span class="pre">TokenEnhancer</span></code>が指定されている場合、アクセストークンを拡張し、追加パラメータなどを付与することが出来る。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">TokenStore</span></code>の呼び出しを行い、(5)にて作成した認証情報とともに(7)で作成したアクセストークンを登録し、アクセストークンを呼び出し元の<code class="docutils literal"><span class="pre">TokenEndpoint</span></code>に返却する。</div>
<div class="line"><code class="docutils literal"><span class="pre">TokenEndpoint</span></code>では(7)で作成したアクセストークンをもとにレスポンスを作成し、リクエストの応答を行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="SecureLoginDemo.html" title="9.10. 代表的なセキュリティ要件の実装例"
             >next</a> |</li>
        <li class="right" >
          <a href="Encryption.html" title="9.8. 暗号化"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.7.0.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >9. セキュリティ対策</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer">
      © Copyright 2013, NTT DATA Corporation. © Copyright 2013, NTT Corporation.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3.Theme is <a href="http://github.com/vimalkvn/solar-theme">Solar</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>
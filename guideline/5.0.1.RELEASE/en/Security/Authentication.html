<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>6.3. Authentication &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.0.1.RELEASE documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/solar.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="6.4. Password Hashing" href="PasswordHashing.html" />
    <link rel="prev" title="6.2. Spring Security Tutorial" href="Tutorial.html" /><script async src="https://www.googletagmanager.com/gtag/js?id=G-847V2Q99G8"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date()); gtag('config', 'G-847V2Q99G8');
</script>
<script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="PasswordHashing.html" title="6.4. Password Hashing"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Tutorial.html" title="6.2. Spring Security Tutorial"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.0.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U"><span class="section-number">6. </span>Security for TERASOLUNA Server Framework for Java (5.x)</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">6.3. </span>Authentication</a></li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">6.3. Authentication</a><ul>
<li><a class="reference internal" href="#overview">6.3.1. Overview</a><ul>
<li><a class="reference internal" href="#login">6.3.1.1. Login</a></li>
<li><a class="reference internal" href="#logout">6.3.1.2. Logout</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">6.3.2. How to use</a><ul>
<li><a class="reference internal" href="#setting-sec-http-element">6.3.2.1. Setting <code class="docutils literal notranslate"><span class="pre">&lt;sec:http&gt;</span></code> element</a></li>
<li><a class="reference internal" href="#setting-sec-form-login-element">6.3.2.2. Setting <code class="docutils literal notranslate"><span class="pre">&lt;sec:form-login&gt;</span></code> element</a><ul>
<li><a class="reference internal" href="#creating-login-form">6.3.2.2.1. Creating login form</a></li>
<li><a class="reference internal" href="#changing-attribute-name-of-login-form">6.3.2.2.2. Changing attribute name of login form</a></li>
</ul>
</li>
<li><a class="reference internal" href="#setting-authentication-process">6.3.2.3. Setting authentication process</a><ul>
<li><a class="reference internal" href="#authenticationprovider-class-settings">6.3.2.3.1. <code class="docutils literal notranslate"><span class="pre">AuthenticationProvider</span></code> class settings</a></li>
<li><a class="reference internal" href="#userdetailsservice-class-settings">6.3.2.3.2. <code class="docutils literal notranslate"><span class="pre">UserDetailsService</span></code> class settings</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use-userdetails-class">6.3.2.4. How to use <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> class</a><ul>
<li><a class="reference internal" href="#using-userdetails-object-in-java-class">6.3.2.4.1. Using <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> object in Java class</a></li>
<li><a class="reference internal" href="#accessing-userdetails-in-jsp">6.3.2.4.2. Accessing <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> in JSP</a></li>
</ul>
</li>
<li><a class="reference internal" href="#session-management-in-spring-security">6.3.2.5. Session management in Spring Security</a><ul>
<li><a class="reference internal" href="#detecting-session-time-out">6.3.2.5.1. Detecting session time-out</a></li>
<li><a class="reference internal" href="#settings-of-concurrent-session-control">6.3.2.5.2. Settings of Concurrent Session Control</a></li>
<li><a class="reference internal" href="#setting-sec-concurrency-control">6.3.2.5.3. Setting <code class="docutils literal notranslate"><span class="pre">&lt;sec:concurrency-control&gt;</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#setting-the-handler-class-in-case-of-authentication-error">6.3.2.6. Setting the handler class in case of authentication error</a></li>
<li><a class="reference internal" href="#setting-sec-logout-element">6.3.2.7. Setting <code class="docutils literal notranslate"><span class="pre">&lt;sec:logout&gt;</span></code> element</a></li>
<li><a class="reference internal" href="#setting-sec-remember-me-element">6.3.2.8. Setting <code class="docutils literal notranslate"><span class="pre">&lt;sec:remember-me&gt;</span></code> element</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend">6.3.3. How to extend</a><ul>
<li><a class="reference internal" href="#extending-userdetailsservice">6.3.3.1. Extending <code class="docutils literal notranslate"><span class="pre">UserDetailsService</span></code></a><ul>
<li><a class="reference internal" href="#extending-userdetails">6.3.3.1.1. Extending <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code></a></li>
<li><a class="reference internal" href="#implementing-an-independent-userdetailsservice">6.3.3.1.2. Implementing an independent <code class="docutils literal notranslate"><span class="pre">UserDetailsService</span></code></a></li>
<li><a class="reference internal" href="#id3">6.3.3.1.3. How to use</a></li>
</ul>
</li>
<li><a class="reference internal" href="#extending-authenticationprovider">6.3.3.2. Extending <code class="docutils literal notranslate"><span class="pre">AuthenticationProvider</span></code></a><ul>
<li><a class="reference internal" href="#extending-usernamepasswordauthenticationtoken">6.3.3.2.1. Extending <code class="docutils literal notranslate"><span class="pre">UsernamePasswordAuthenticationToken</span></code></a></li>
<li><a class="reference internal" href="#extending-daoauthenticationprovide">6.3.3.2.2. Extending <code class="docutils literal notranslate"><span class="pre">DaoAuthenticationProvide</span></code></a></li>
<li><a class="reference internal" href="#extending-usernamepasswordauthenticationfilter">6.3.3.2.3. Extending <code class="docutils literal notranslate"><span class="pre">UsernamePasswordAuthenticationFilter</span></code></a></li>
<li><a class="reference internal" href="#application-of-extended-authentication-process">6.3.3.2.4. Application of extended authentication process</a></li>
<li><a class="reference internal" href="#id5">6.3.3.2.5. Creating login form</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix">6.3.4. Appendix</a><ul>
<li><a class="reference internal" href="#authentication-success-handler-for-which-destination-can-be-specified">6.3.4.1. Authentication Success handler for which destination can be specified</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="Tutorial.html"
                          title="previous chapter"><span class="section-number">6.2. </span>Spring Security Tutorial</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="PasswordHashing.html"
                          title="next chapter"><span class="section-number">6.4. </span>Password Hashing</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/Security/Authentication.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="authentication">
<h1><span class="section-number">6.3. </span>Authentication<a class="headerlink" href="#authentication" title="Permalink to this heading">¶</a></h1>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">Table of contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id7">Overview</a></p>
<ul>
<li><p><a class="reference internal" href="#login" id="id8">Login</a></p></li>
<li><p><a class="reference internal" href="#logout" id="id9">Logout</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#how-to-use" id="id10">How to use</a></p>
<ul>
<li><p><a class="reference internal" href="#setting-sec-http-element" id="id11">Setting <code class="docutils literal notranslate"><span class="pre">&lt;sec:http&gt;</span></code> element</a></p></li>
<li><p><a class="reference internal" href="#setting-sec-form-login-element" id="id12">Setting <code class="docutils literal notranslate"><span class="pre">&lt;sec:form-login&gt;</span></code> element</a></p>
<ul>
<li><p><a class="reference internal" href="#creating-login-form" id="id13">Creating login form</a></p></li>
<li><p><a class="reference internal" href="#changing-attribute-name-of-login-form" id="id14">Changing attribute name of login form</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#setting-authentication-process" id="id15">Setting authentication process</a></p>
<ul>
<li><p><a class="reference internal" href="#authenticationprovider-class-settings" id="id16"><code class="docutils literal notranslate"><span class="pre">AuthenticationProvider</span></code> class settings</a></p></li>
<li><p><a class="reference internal" href="#userdetailsservice-class-settings" id="id17"><code class="docutils literal notranslate"><span class="pre">UserDetailsService</span></code> class settings</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#how-to-use-userdetails-class" id="id18">How to use <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> class</a></p>
<ul>
<li><p><a class="reference internal" href="#using-userdetails-object-in-java-class" id="id19">Using <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> object in Java class</a></p></li>
<li><p><a class="reference internal" href="#accessing-userdetails-in-jsp" id="id20">Accessing <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> in JSP</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#session-management-in-spring-security" id="id21">Session management in Spring Security</a></p>
<ul>
<li><p><a class="reference internal" href="#detecting-session-time-out" id="id22">Detecting session time-out</a></p></li>
<li><p><a class="reference internal" href="#settings-of-concurrent-session-control" id="id23">Settings of Concurrent Session Control</a></p></li>
<li><p><a class="reference internal" href="#setting-sec-concurrency-control" id="id24">Setting <code class="docutils literal notranslate"><span class="pre">&lt;sec:concurrency-control&gt;</span></code></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#setting-the-handler-class-in-case-of-authentication-error" id="id25">Setting the handler class in case of authentication error</a></p></li>
<li><p><a class="reference internal" href="#setting-sec-logout-element" id="id26">Setting <code class="docutils literal notranslate"><span class="pre">&lt;sec:logout&gt;</span></code> element</a></p></li>
<li><p><a class="reference internal" href="#setting-sec-remember-me-element" id="id27">Setting <code class="docutils literal notranslate"><span class="pre">&lt;sec:remember-me&gt;</span></code> element</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#how-to-extend" id="id28">How to extend</a></p>
<ul>
<li><p><a class="reference internal" href="#extending-userdetailsservice" id="id29">Extending <code class="docutils literal notranslate"><span class="pre">UserDetailsService</span></code></a></p>
<ul>
<li><p><a class="reference internal" href="#extending-userdetails" id="id30">Extending <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code></a></p></li>
<li><p><a class="reference internal" href="#implementing-an-independent-userdetailsservice" id="id31">Implementing an independent <code class="docutils literal notranslate"><span class="pre">UserDetailsService</span></code></a></p></li>
<li><p><a class="reference internal" href="#id3" id="id32">How to use</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#extending-authenticationprovider" id="id33">Extending <code class="docutils literal notranslate"><span class="pre">AuthenticationProvider</span></code></a></p>
<ul>
<li><p><a class="reference internal" href="#extending-usernamepasswordauthenticationtoken" id="id34">Extending <code class="docutils literal notranslate"><span class="pre">UsernamePasswordAuthenticationToken</span></code></a></p></li>
<li><p><a class="reference internal" href="#extending-daoauthenticationprovide" id="id35">Extending <code class="docutils literal notranslate"><span class="pre">DaoAuthenticationProvide</span></code></a></p></li>
<li><p><a class="reference internal" href="#extending-usernamepasswordauthenticationfilter" id="id36">Extending <code class="docutils literal notranslate"><span class="pre">UsernamePasswordAuthenticationFilter</span></code></a></p></li>
<li><p><a class="reference internal" href="#application-of-extended-authentication-process" id="id37">Application of extended authentication process</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id38">Creating login form</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#appendix" id="id39">Appendix</a></p>
<ul>
<li><p><a class="reference internal" href="#authentication-success-handler-for-which-destination-can-be-specified" id="id40">Authentication Success handler for which destination can be specified</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="overview">
<h2><a class="toc-backref" href="#id7" role="doc-backlink"><span class="section-number">6.3.1. </span>Overview</a><a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h2>
<div class="line-block">
<div class="line">This chapter explains about Authentication functionality provided by Spring Security.</div>
</div>
<p>In Spring Security, user authentication can be implemented by just performing configuration file settings.
DB authentication, LDAP authentication, CAS authentication, JAAS authentication, X509 authentication and Basic authentication are the authentication methods provided by Spring Security. However, only DB authentication is described in this guideline.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<blockquote>
<div><p>For details of authentication types other than DB authentication, refer to the official document of each authentication method.</p>
</div></blockquote>
<ul class="simple">
<li><p><a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.7.RELEASE/reference/htmlsingle/#ldap">LDAP Authentication</a></p></li>
<li><p><a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.7.RELEASE/reference/htmlsingle/#cas">CAS Authentication</a></p></li>
<li><p><a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.7.RELEASE/reference/htmlsingle/#jaas">Java Authentication and Authorization Service (JAAS) Provider</a></p></li>
<li><p><a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.7.RELEASE/reference/htmlsingle/#x509">X.509 Authentication</a></p></li>
<li><p><a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.7.RELEASE/reference/htmlsingle/#basic">Basic and Digest Authentication</a></p></li>
</ul>
</div>
<section id="login">
<h3><a class="toc-backref" href="#id8" role="doc-backlink"><span class="section-number">6.3.1.1. </span>Login</a><a class="headerlink" href="#login" title="Permalink to this heading">¶</a></h3>
<p>Flow of Spring Security login process is as follows:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../_images/Authentication_Login_overview.png"><img alt="Authentication(Login)" src="../_images/Authentication_Login_overview.png" style="width: 80%;" /></a>
</figure>
<ol class="arabic simple">
<li><p>Authentication filter is activated on receiving the request specifying authentication.</p></li>
<li><p>Authentication filter extracts username and password from the request and generates authentication information.
The  generated authentication information is used as a parameter to execute authentication process of authentication manager.</p></li>
<li><p>Authentication manager executes authentication process of the specified authentication provider.
Authentication provider acquires user information from datasource (DB or LDAP) and performs user authentication such as password verification.
When authentication is successful, authentication information that holds the authenticated information is created and returned to the authentication manager.
When authentication fails, the authentication manager raises authentication failure exception.</p></li>
<li><p>Authentication manager returns the received authentication information to authentication filter.</p></li>
<li><p>Authentication filter stores the received authentication information (authenticated) in session.</p></li>
<li><p>When authentication is successful, it initializes the session information before authentication and creates new session information.</p></li>
<li><p>It redirects to the specified path of successful/failed  authentication and returns session ID to client.</p></li>
</ol>
</section>
<section id="logout">
<h3><a class="toc-backref" href="#id9" role="doc-backlink"><span class="section-number">6.3.1.2. </span>Logout</a><a class="headerlink" href="#logout" title="Permalink to this heading">¶</a></h3>
<p>Flow of Spring Security logout process is as follows:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../_images/Authentication_Logout_overview.png"><img alt="Authentication(Logout)" src="../_images/Authentication_Logout_overview.png" style="width: 80%;" /></a>
</figure>
<ol class="arabic simple">
<li><p>Logout filter gets activated on receiving request for logout.</p></li>
<li><p>It discards the session information.
It sets a response such that client cookie (Cookie in figure) is discarded.</p></li>
<li><p>It redirects to the specified logout path.</p></li>
</ol>
<dl>
<dt></dt><dd><div class="admonition note">
<p class="admonition-title">Note</p>
<p>The session information that remains after logout can be used by a third party. Hence, in order to prevent such spoofing,
session information is discarded at the time of logout using <code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.session.ConcurrentSessionFilter</span></code>.</p>
</div>
</dd>
</dl>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="how-to-use">
<h2><a class="toc-backref" href="#id10" role="doc-backlink"><span class="section-number">6.3.2. </span>How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this heading">¶</a></h2>
<div class="line-block">
<div class="line">Settings to be performed in Spring Security configuration file so as to use authentication functionality, are as follows:</div>
<div class="line">For basic settings, refer to <a class="reference internal" href="SpringSecurity.html"><span class="doc">Spring Security Overview</span></a>.</div>
</div>
<section id="setting-sec-http-element">
<h3><a class="toc-backref" href="#id11" role="doc-backlink"><span class="section-number">6.3.2.1. </span>Setting <code class="docutils literal notranslate"><span class="pre">&lt;sec:http&gt;</span></code> element</a><a class="headerlink" href="#setting-sec-http-element" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">As shown in the following example, basic settings for authentication functionality of</div>
<div class="line">Spring Security can be omitted by setting the <code class="docutils literal notranslate"><span class="pre">auto-config</span></code> attribute of <code class="docutils literal notranslate"><span class="pre">&lt;http&gt;</span></code> element in spring-security.xml to <code class="docutils literal notranslate"><span class="pre">true</span></code>.</div>
</div>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;beans</span><span class="w"> </span><span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
<span class="w">    </span><span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
<span class="w">    </span><span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
<span class="w">    </span><span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
<span class="w">    </span><span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/security</span>
<span class="s">        http://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">        http://www.springframework.org/schema/beans</span>
<span class="s">        http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">        http://www.springframework.org/schema/context</span>
<span class="s">        http://www.springframework.org/schema/context/spring-context.xsd&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">auto-config=</span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="na">use-expressions=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">      </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="w">    </span><span class="nt">&lt;/sec:http&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">By setting <code class="docutils literal notranslate"><span class="pre">auto-config=&quot;true&quot;</span></code>,</div>
<div class="line">it is enabled even if <code class="docutils literal notranslate"><span class="pre">&lt;form-login&gt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;http-basic&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">&lt;logout&gt;</span></code> elements are not set.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">&lt;form-login&gt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;http-basic&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">&lt;logout&gt;</span></code> elements are explained here.</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 15%" />
<col style="width: 85%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Element name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&lt;form-login&gt;</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter</span></code> is enabled.</div>
<div class="line">UsernamePasswordAuthenticationFilter is the Filter that performs authentication by extracting username and password from the request at the time of POST method.</div>
<div class="line">For details, refer to <a class="reference internal" href="#form-login"><span class="std std-ref">Setting &lt;sec:form-login&gt; element</span></a>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&lt;http-basic&gt;</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.authentication.www.BasicAuthenticationFilter</span></code> is enabled.</div>
<div class="line">BasicAuthenticationFilter is the filter that executes Basic authentication process according to RFC1945.</div>
<div class="line">For details on how to use, refer to <a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.7.RELEASE/apidocs/org/springframework/security/web/authentication/www/BasicAuthenticationFilter.html">BasicAuthenticationFilter JavaDoc</a>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&lt;logout&gt;</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.authentication.logout.LogoutFilter</span></code>,</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.authentication.logout.SecurityContextLogoutHandler</span></code> is enabled.</div>
<div class="line">LogoutFilter is the Filter called at the time of Logout.</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.authentication.rememberme.TokenBasedRememberMeServices</span></code> (deleting Cookie) and,</div>
<div class="line">SecurityContextLogoutHandler(disabling  session) is called.</div>
<div class="line">For details, refer to <a class="reference internal" href="#form-logout"><span class="std std-ref">Setting &lt;sec:logout&gt; element</span></a>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</section>
<section id="setting-sec-form-login-element">
<span id="form-login"></span><h3><a class="toc-backref" href="#id12" role="doc-backlink"><span class="section-number">6.3.2.2. </span>Setting <code class="docutils literal notranslate"><span class="pre">&lt;sec:form-login&gt;</span></code> element</a><a class="headerlink" href="#setting-sec-form-login-element" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">How to set <code class="docutils literal notranslate"><span class="pre">&lt;sec:form-login&gt;</span></code> element is described in this section.</div>
<div class="line"><br /></div>
<div class="line">Attributes of form-login element are as shown below.</div>
</div>
<p>spring-security.xml</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;beans</span><span class="w"> </span><span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
<span class="w">    </span><span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
<span class="w">    </span><span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
<span class="w">    </span><span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
<span class="w">    </span><span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/security</span>
<span class="s">        http://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">        http://www.springframework.org/schema/beans</span>
<span class="s">        http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">        http://www.springframework.org/schema/context</span>
<span class="s">        http://www.springframework.org/schema/context/spring-context.xsd&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">auto-config=</span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="na">use-expressions=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:form-login</span><span class="w"> </span><span class="na">login-page=</span><span class="s">&quot;/login&quot;</span>
<span class="w">        </span><span class="na">default-target-url=</span><span class="s">&quot;/&quot;</span>
<span class="w">        </span><span class="na">login-processing-url=</span><span class="s">&quot;/authentication&quot;</span>
<span class="w">        </span><span class="na">always-use-default-target=</span><span class="s">&quot;false&quot;</span>
<span class="w">        </span><span class="na">authentication-failure-url=</span><span class="s">&quot;/login?error=true&quot;</span>
<span class="w">        </span><span class="na">authentication-failure-handler-ref=</span><span class="s">&quot;authenticationFailureHandler&quot;</span>
<span class="w">        </span><span class="na">authentication-success-handler-ref=</span><span class="s">&quot;authenticationSuccessHandler&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- Perform steps (1) - (7) in the specified attribute order--&gt;</span>
<span class="w">  </span><span class="nt">&lt;/sec:http&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify the login form screen path in <code class="docutils literal notranslate"><span class="pre">login-page</span></code> attribute.</div>
<div class="line">When not specified, “/spring_security_login” will be default path and Login screen provided by Spring Security is used.</div>
<div class="line">When an “Unauthenticated user” accesses a page that can only be accessed by an “Authenticated user”, the unauthenticated user is redirected to this path.</div>
</div>
<div class="line-block">
<div class="line"><strong>This guideline recommends changing to a system specific value rather than using the default value “/spring_security_login”, mentioned above.</strong>In this example, “/login” is specified.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">In <code class="docutils literal notranslate"><span class="pre">default-target-url</span></code> attribute, specify the destination path when authentication is successful.</div>
<div class="line">When not specified, “/” will be the default path.</div>
</div>
<div class="line-block">
<div class="line">When <code class="docutils literal notranslate"><span class="pre">authentication-success-handler-ref</span></code> attribute is specified, this setting is not used.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify the path for performing authentication process in <code class="docutils literal notranslate"><span class="pre">login-processing-url</span></code> attribute.</div>
<div class="line">When not specified, “j_spring_security_check” will be the default path.</div>
</div>
<div class="line-block">
<div class="line"><strong>This guideline recommends changing to a system specific value rather than using the default value  “j_spring_security_check”, mentioned above.</strong> In this example, “/authentication” is specified.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">In <code class="docutils literal notranslate"><span class="pre">always-use-default-target</span></code> attribute, specify whether it should always transit to the path specified in <code class="docutils literal notranslate"><span class="pre">default-target-url</span></code> after a successful login.</div>
<div class="line">When it is set as <code class="docutils literal notranslate"><span class="pre">true</span></code>, it always transits to the path specified in <code class="docutils literal notranslate"><span class="pre">default-target-url</span></code>.</div>
<div class="line">When it is set as <code class="docutils literal notranslate"><span class="pre">false</span></code> (default), it transits either to the “path for displaying secure page which somebody has tried accessing before the login” or “path specified in <code class="docutils literal notranslate"><span class="pre">default-target-url</span></code>“.</div>
</div>
<div class="line-block">
<div class="line">When <code class="docutils literal notranslate"><span class="pre">authentication-success-handler-ref</span></code> attribute is specified, this setting is not used.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">In <code class="docutils literal notranslate"><span class="pre">authentication-failure-url</span></code>, specify the destination when authentication fails.</div>
<div class="line">When not specified, the path specified in  <code class="docutils literal notranslate"><span class="pre">login-page</span></code> attribute is applicable.</div>
</div>
<div class="line-block">
<div class="line">When <code class="docutils literal notranslate"><span class="pre">authentication-failure-handler-ref</span></code> attribute is specified, this setting is not used.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify the handler class to be called in case of a failed authentication, in <code class="docutils literal notranslate"><span class="pre">authentication-failure-handler-ref</span></code> attribute.</div>
<div class="line">For details, refer to <a class="reference internal" href="#authentication-failure-handler-ref"><span class="std std-ref">Setting the handler class in case of authentication error</span></a>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify the handler class to be called in case of a successful authentication, in <code class="docutils literal notranslate"><span class="pre">authentication-success-handler-ref</span></code> attribute.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>For attributes other than those mentioned above, refer to <a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.7.RELEASE/reference/htmlsingle/#nsa-form-login">Spring Security manual</a>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>Why it is not recommended to use Spring Security default values “/spring_security_login, /j_spring_security_check”.</strong></p>
<p>If default value is used, the fact that the application is using Spring Security is revealed.
As a result, if any Spring Security related vulnerability is detected, there is a higher risk of receiving an attack due to the vulnerability.
In order to prevent these risks, it is recommended to avoid using default value.</p>
</div>
<section id="creating-login-form">
<span id="form-login-jsp"></span><h4><a class="toc-backref" href="#id13" role="doc-backlink"><span class="section-number">6.3.2.2.1. </span>Creating login form</a><a class="headerlink" href="#creating-login-form" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">Create the login form to be used at the time of authentication in JSP.</div>
</div>
<ul>
<li><p>src/main/webapp/WEB-INF/views/login.jsp</p>
<div class="highlight-jsp notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;form:form</span><span class="w"> </span><span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/authentication&quot;</span><span class="w"> </span><span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="w">    </span><span class="nt">&lt;input</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;text&quot;</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;username&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;j_username&quot;</span><span class="nt">&gt;</span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;input</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;password&quot;</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;password&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;j_password&quot;</span><span class="nt">&gt;</span><span class="cm">&lt;!-- (5) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;input</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;Login&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form:form&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify the destination for performing authentication process, in the action attribute of form.</div>
<div class="line">/authentication specified in the login-processing-url, should be specified as the destination path.</div>
<div class="line">Authentication process is executed by accessing ${pageContext.request.contextPath}/authentication.</div>
<div class="line">“POST” should be specified as the HTTP method.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Element handled as “User ID” in authentication process.</div>
<div class="line">Spring Security default value namely, “j_username”, should be specified in the name attribute.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Element handled as “Password” in authentication process.</div>
<div class="line">Spring Security default value namely, “j_password”, should be specified in the name attribute.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Following code is added to display the authentication error message.</p>
<div class="highlight-jsp notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;c:if</span><span class="w"> </span><span class="na">test=</span><span class="s">&quot;${param.error}&quot;</span><span class="nt">&gt;</span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;t:messagesPanel</span>
<span class="w">        </span><span class="na">messagesAttributeName=</span><span class="s">&quot;SPRING_SECURITY_LAST_EXCEPTION&quot;</span><span class="nt">/&gt;</span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/c:if&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Determine the error message set in request parameter.</div>
<div class="line">Please note that the determination process needs to be changed according to</div>
<div class="line">the value set in the authentication-failure-url attribute of form-login element or the value set in “defaultFailureUrl” of authentication error handler.</div>
<div class="line">This example is shown with the setting as authentication-failure-url=”/login?error=true”.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Output the exception message that is to be output at the time of authentication error.</div>
<div class="line">It is recommended to output this message by specifying <code class="docutils literal notranslate"><span class="pre">org.terasoluna.gfw.web.message.MessagesPanelTag</span></code> provided by common library.</div>
<div class="line">For details of “<code class="docutils literal notranslate"><span class="pre">&lt;t:messagesPanel&gt;</span></code>&quot; tag, refer to <a class="reference internal" href="../ArchitectureInDetail/MessageManagement.html"><span class="doc">Message Management</span></a>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Settings required while accessing exception object of authentication error from JSP</strong></p>
<p>Exception object of authentication error is stored in session scope with the attribute name <code class="docutils literal notranslate"><span class="pre">&quot;SPRING_SECURITY_LAST_EXCEPTION&quot;</span></code>.
<code class="docutils literal notranslate"><span class="pre">session</span></code> attribute of JSP <code class="docutils literal notranslate"><span class="pre">page</span></code> directive should be set to <code class="docutils literal notranslate"><span class="pre">true</span></code> for accessing the object stored in session scope from JSP.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">src/main/webapp/WEB-INF/views/common/include.jsp</span></code></p></li>
</ul>
<blockquote>
<div><div class="highlight-jsp notranslate"><div class="highlight"><pre><span></span><span class="k">&lt;%@</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">session</span><span class="o">=</span><span class="s">&quot;true&quot;</span><span class="k">%&gt;</span>
</pre></div>
</div>
</div></blockquote>
<p>Default settings of blank project are such that session scope cannot be accessed from JSP.
This is to ensure that the session is not used easily.</p>
</div>
</div></blockquote>
<ul>
<li><p>spring-mvc.xml</p>
<p>Define the Controller that displays login form.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;mvc:view-controller</span><span class="w"> </span><span class="na">path=</span><span class="s">&quot;/login&quot;</span><span class="w"> </span><span class="na">view-name=</span><span class="s">&quot;login&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="cm">&lt;!-- (1) --&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">If “/login” is accessed, define the controller that returns only “login” as the view name. src/main/webapp/WEB-INF/views/login.jsp is output by <code class="docutils literal notranslate"><span class="pre">InternalResourceViewResolver</span></code>.</div>
<div class="line">This simple controller need not be implemented in Java.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Above settings are identical with next controller.</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;/login&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LoginController</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@RequestMapping</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">index</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;login&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>If the Controller with a single method that returns only the view name is necessary, it is better to use <code class="docutils literal notranslate"><span class="pre">&lt;mvc:view-controller&gt;</span></code> .</p>
</div>
</li>
</ul>
</section>
<section id="changing-attribute-name-of-login-form">
<h4><a class="toc-backref" href="#id14" role="doc-backlink"><span class="section-number">6.3.2.2.2. </span>Changing attribute name of login form</a><a class="headerlink" href="#changing-attribute-name-of-login-form" title="Permalink to this heading">¶</a></h4>
<p>“j_username” and “j_password” are the Spring Security default values. They can be changed to any value by using <code class="docutils literal notranslate"><span class="pre">&lt;form-login&gt;</span></code> element settings.</p>
<ul>
<li><p>spring-security.xml</p>
<p>Attributes of <code class="docutils literal notranslate"><span class="pre">username</span></code> and <code class="docutils literal notranslate"><span class="pre">password</span></code></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">auto-config=</span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="na">use-expressions=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;sec:form-login</span>
<span class="w">      </span><span class="na">username-parameter=</span><span class="s">&quot;username&quot;</span>
<span class="w">      </span><span class="na">password-parameter=</span><span class="s">&quot;password&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- Perform steps (1) and (2) in the specified attribute order --&gt;</span>
<span class="w">  </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">In <code class="docutils literal notranslate"><span class="pre">username-parameter</span></code> attribute, <code class="docutils literal notranslate"><span class="pre">name</span></code> attribute of input field <code class="docutils literal notranslate"><span class="pre">username</span></code> is changed to “username”.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">In <code class="docutils literal notranslate"><span class="pre">password-parameter</span></code> attribute, <code class="docutils literal notranslate"><span class="pre">name</span></code> attribute of input field  <code class="docutils literal notranslate"><span class="pre">password</span></code> is changed to “password”.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</section>
</section>
<section id="setting-authentication-process">
<span id="authenticationproviderconfiguration"></span><h3><a class="toc-backref" href="#id15" role="doc-backlink"><span class="section-number">6.3.2.3. </span>Setting authentication process</a><a class="headerlink" href="#setting-authentication-process" title="Permalink to this heading">¶</a></h3>
<p>Define <code class="docutils literal notranslate"><span class="pre">AuthenticationProvider</span></code> and <code class="docutils literal notranslate"><span class="pre">UserDetailsService</span></code> in order to set the authentication process in Spring Security.</p>
<p><code class="docutils literal notranslate"><span class="pre">AuthenticationProvider</span></code> plays the following roles.</p>
<ul class="simple">
<li><p>Returning authenticated user information in case of successful authentication</p></li>
<li><p>Throwing an exception in case of authentication failure.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">UserDetailsService</span></code> fetches authenticated user information from the persistence layer.</p>
<p>These classes may each be used as default or may be used by extending individually.
They may also be combined.</p>
<section id="authenticationprovider-class-settings">
<h4><a class="toc-backref" href="#id16" role="doc-backlink"><span class="section-number">6.3.2.3.1. </span><code class="docutils literal notranslate"><span class="pre">AuthenticationProvider</span></code> class settings</a><a class="headerlink" href="#authenticationprovider-class-settings" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">As <code class="docutils literal notranslate"><span class="pre">AuthenticationProvider</span></code> implementation, how to use the provider, <code class="docutils literal notranslate"><span class="pre">org.springframework.security.authentication.dao.DaoAuthenticationProvider</span></code> that performs DB authentication, is explained here.</div>
</div>
<ul>
<li><p>spring-security.xml</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:authentication-manager&gt;</span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:authentication-provider</span><span class="w"> </span><span class="na">user-service-ref=</span><span class="s">&quot;userDetailsService&quot;</span><span class="nt">&gt;</span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">        </span><span class="nt">&lt;sec:password-encoder</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;passwordEncoder&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;/sec:authentication-provider&gt;</span>
<span class="nt">&lt;/sec:authentication-manager&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Define <code class="docutils literal notranslate"><span class="pre">&lt;sec:authentication-provider&gt;</span></code> element in <code class="docutils literal notranslate"><span class="pre">&lt;sec:authentication-manager&gt;</span></code> element. Authentication methods can be combined by specifying multiple elements. However it is not explained here.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Define <code class="docutils literal notranslate"><span class="pre">AuthenticationProvider</span></code> in <code class="docutils literal notranslate"><span class="pre">&lt;sec:authentication-provider&gt;</span></code> element. <code class="docutils literal notranslate"><span class="pre">DaoAuthenticationProvider</span></code> is enabled by default. To specify <code class="docutils literal notranslate"><span class="pre">AuthenticationProvider</span></code> other than this, specify the Bean ID of target AuthenticationProvider, in `ref attribute &lt;<a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.7.RELEASE/reference/htmlsingle/#nsa-authentication-provider">http://docs.spring.io/spring-security/site/docs/3.2.7.RELEASE/reference/htmlsingle/#nsa-authentication-provider</a>&gt;`_.</div>
<div class="line"><br /></div>
<div class="line">Specify the Bean Id of <code class="docutils literal notranslate"><span class="pre">UserDetailsService</span></code> that fetches authenticated user information, in <code class="docutils literal notranslate"><span class="pre">user-service-ref</span></code> attribute. This setting is mandatory when using <code class="docutils literal notranslate"><span class="pre">DaoAuthenticationProvider</span></code>.</div>
<div class="line">For details, refer to <a class="reference internal" href="#userdetailsservice"><span class="std std-ref">UserDetailsService class settings</span></a>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify the Bean ID of the class that encodes the password entered from Form, at the time of password verification.</div>
<div class="line">When it is not specified, password is handled in “Plain Text”. For details, refer to <a class="reference internal" href="PasswordHashing.html"><span class="doc">Password Hashing</span></a>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<div class="line-block">
<div class="line">If the requirement is to perform authentication by fetching data from persistence layer using only the “User ID” and “Password”, this <code class="docutils literal notranslate"><span class="pre">DaoAuthenticationProvider</span></code> may be used.</div>
<div class="line">Which method is to be used to fetch data from persistence layer, is determined using the <code class="docutils literal notranslate"><span class="pre">UserDetailsService</span></code> explained below.</div>
</div>
</section>
<section id="userdetailsservice-class-settings">
<span id="userdetailsservice"></span><h4><a class="toc-backref" href="#id17" role="doc-backlink"><span class="section-number">6.3.2.3.2. </span><code class="docutils literal notranslate"><span class="pre">UserDetailsService</span></code> class settings</a><a class="headerlink" href="#userdetailsservice-class-settings" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">Set the Bean specified in <code class="docutils literal notranslate"><span class="pre">userDetailsService</span></code> property of <code class="docutils literal notranslate"><span class="pre">AuthenticationProvider</span></code>.</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">UserDetailsService</span></code> is the interface that includes the next method.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">UserDetails</span><span class="w"> </span><span class="nf">loadUserByUsername</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">UsernameNotFoundException</span>
</pre></div>
</div>
<p>By executing this interface, authenticated user information can be fetched from any storage location.</p>
<p>Here, <code class="docutils literal notranslate"><span class="pre">org.springframework.security.core.userdetails.jdbc.JdbcDaoImpl</span></code> that fetches user information from DB using JDBC, is explained.</p>
<p>In order to use <code class="docutils literal notranslate"><span class="pre">JdbcDaoImpl</span></code>, it is advisable to perform following Bean definitions in spring-security.xml.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;userDetailsService&quot;</span>
<span class="w">  </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.core.userdetails.jdbc.JdbcDaoImpl&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;dataSource&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">It is assumed that <code class="docutils literal notranslate"><span class="pre">JdbcDaoImpl</span></code> defines the default SQL for fetching authenticated user information and authorization information and provides tables corresponding to these. For definitions of assumed tables, refer to <a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.7.RELEASE/reference/htmlsingle/#appendix-schema">Spring Security manual</a>.</div>
<div class="line">To fetch user information and authorization information from existing tables, the SQL to be executed should be modified according to existing tables.</div>
<div class="line">Following 3 SQLs are used.</div>
</div>
<ul class="simple">
<li><p><a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.7.RELEASE/apidocs/constant-values.html#org.springframework.security.core.userdetails.jdbc.JdbcDaoImpl.DEF_USERS_BY_USERNAME_QUERY">User information acquisition query</a></p></li>
</ul>
<blockquote>
<div><div class="line-block">
<div class="line">By creating a table matching with the query that fetches user information, need of specifying the query to configuration file described later, is eliminated.</div>
<div class="line">Fields namely, “username”, “password” and “enabled” are mandatory</div>
<div class="line">Also, by specifying the query to the configuration file described later and by assigning an alias to the query, there is no issue even if table name and column name do not match.</div>
<div class="line">For example, while setting the following SQL, “email” column can be used as “username” wherein, “enabled” field is always <code class="docutils literal notranslate"><span class="pre">true</span></code>.</div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">pwd</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">password</span><span class="p">,</span><span class="w"> </span><span class="k">true</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">enabled</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">customer</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">“User ID” described earlier in <a class="reference internal" href="#form-login-jsp"><span class="std std-ref">Creating login form</span></a>, is specified in query parameter.</div>
</div>
</div></blockquote>
<ul>
<li><p><a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.7.RELEASE/apidocs/constant-values.html#org.springframework.security.core.userdetails.jdbc.JdbcDaoImpl.DEF_AUTHORITIES_BY_USERNAME_QUERY">User authorities acquisition query</a></p>
<div class="line-block">
<div class="line">This query fetches authorization information for a user.</div>
</div>
</li>
<li><p><a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.7.RELEASE/apidocs/constant-values.html#org.springframework.security.core.userdetails.jdbc.JdbcDaoImpl.DEF_GROUP_AUTHORITIES_BY_USERNAME_QUERY">Group authorities acquisition query</a></p>
<div class="line-block">
<div class="line">This query fetches authorization information of the group, to which the user belongs. ‘Group authorities’ is disabled by default and is also out of this guideline’s scope.</div>
</div>
</li>
</ul>
<div class="line-block">
<div class="line">DB definition example and example of Spring Security configuration file are shown below.</div>
</div>
<div class="line-block">
<div class="line">Table definitions</div>
<div class="line">Define the required table when implementing DB authentication process.</div>
<div class="line">This table matches with the default query that fetches user information, mentioned earlier</div>
<div class="line">Therefore, following are the definitions of the minimum necessary tables. (with tentative physical name)</div>
</div>
<p>Table name: account</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 15%" />
<col style="width: 15%" />
<col style="width: 10%" />
<col style="width: 60%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Logical name</p></th>
<th class="head"><p>Physical name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>User ID</p></td>
<td><p>username</p></td>
<td><p>String</p></td>
<td><p>User ID for uniquely identifying the user.</p></td>
</tr>
<tr class="row-odd"><td><p>Password</p></td>
<td><p>password</p></td>
<td><p>String</p></td>
<td><p>User password. Stored in hashed status.</p></td>
</tr>
<tr class="row-even"><td><p>Enabled flag</p></td>
<td><p>enabled</p></td>
<td><p>Boolean value</p></td>
<td><p>Flag indicating invalid user and valid user. The user set to “false” is an invalid user, thus results in throwing an authentication error.</p></td>
</tr>
<tr class="row-odd"><td><p>Authority name</p></td>
<td><p>authority</p></td>
<td><p>String</p></td>
<td><p>Not required when authorization functionality is unnecessary.</p></td>
</tr>
</tbody>
</table>
<p>Following is the example wherein, <code class="docutils literal notranslate"><span class="pre">JdbcDaoImpl</span></code> is set through customization.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;userDetailsService&quot;</span>
<span class="w">  </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.core.userdetails.jdbc.JdbcDaoImpl&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;rolePrefix&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;ROLE_&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">  </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;dataSource&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;enableGroups&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;false&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">  </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;usersByUsernameQuery&quot;</span>
<span class="w">    </span><span class="na">value=</span><span class="s">&quot;SELECT username, password, enabled FROM account WHERE username = ?&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="w">  </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;authoritiesByUsernameQuery&quot;</span>
<span class="w">    </span><span class="na">value=</span><span class="s">&quot;SELECT username, authority FROM account WHERE username = ?&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="cm">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify the prefix of authorization name. When the authorization name stored on DB is “USER”, this authenticated user object has the authorization name as “ROLE_USER”.</div>
<div class="line">It is necessary to set the naming conventions and authorization functionality by combining them. For details of authorization functionality, refer to <a class="reference internal" href="Authorization.html"><span class="doc">Authorization</span></a>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify this when the concept of “Group authorities” is to be used in authorization functionality.</div>
<div class="line">Not handled in this guideline.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Set the query for fetching user information. Data should be fetched in the order, “User ID”, “Password” and “Enabled flag”.</div>
<div class="line">When authentication is not decided by “Enabled flag”, SELECT result of “Enabled flag” is fixed to “true”.</div>
<div class="line">The query that can uniquely acquire a user, should be described. When multiple records are fetched, the first record is used as user.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Set the query that fetches user authority. Data should be acquired in the order, “User ID” and “Authority ID”.</div>
<div class="line">When authorization functionality is not used, “Authority ID” can be any fixed value.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Authentication that cannot be implemented just by changing query, is necessary to be implemented by extending <code class="docutils literal notranslate"><span class="pre">UserDetailsService</span></code>.
For extension methods, refer to <a class="reference internal" href="#extendsuserdetailsservice"><span class="std std-ref">Extending UserDetailsService</span></a>.</p>
</div>
</section>
</section>
<section id="how-to-use-userdetails-class">
<h3><a class="toc-backref" href="#id18" role="doc-backlink"><span class="section-number">6.3.2.4. </span>How to use <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> class</a><a class="headerlink" href="#how-to-use-userdetails-class" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">How to use <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> created by <code class="docutils literal notranslate"><span class="pre">UserDetailsService</span></code> after successful authentication is explained.</div>
</div>
<section id="using-userdetails-object-in-java-class">
<h4><a class="toc-backref" href="#id19" role="doc-backlink"><span class="section-number">6.3.2.4.1. </span>Using <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> object in Java class</a><a class="headerlink" href="#using-userdetails-object-in-java-class" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">After a successful authentication, <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> class</div>
<div class="line">is stored in <code class="docutils literal notranslate"><span class="pre">org.springframework.security.core.context.SecurityContextHolder</span></code>.</div>
</div>
<p>Example of fetching <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> from <code class="docutils literal notranslate"><span class="pre">SecurityContextHolder</span></code> is shown below.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getUsername</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Authentication</span><span class="w"> </span><span class="n">authentication</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SecurityContextHolder</span><span class="p">.</span><span class="na">getContext</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">getAuthentication</span><span class="p">();</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">authentication</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">principal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authentication</span><span class="p">.</span><span class="na">getPrincipal</span><span class="p">();</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">principal</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">UserDetails</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="n">UserDetails</span><span class="p">)</span><span class="w"> </span><span class="n">principal</span><span class="p">).</span><span class="na">getUsername</span><span class="p">();</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">principal</span><span class="p">.</span><span class="na">toString</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Fetch <code class="docutils literal notranslate"><span class="pre">org.springframework.security.core.Authentication</span></code> object from <code class="docutils literal notranslate"><span class="pre">SecurityContextHolder</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Fetch <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> object from <code class="docutils literal notranslate"><span class="pre">Authentication</span></code> object.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Fetch user name from <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> object.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>While the method for fetching <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> object from <code class="docutils literal notranslate"><span class="pre">SecurityContextHolder</span></code> is convenient as it can be used from anywhere by static method,
it ends up increasing module coupling. Testing is also difficult to execute.</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> object can be fetched using <code class="docutils literal notranslate"><span class="pre">&#64;AuthenticationPrincipal</span></code>.</div>
<div class="line">To use <code class="docutils literal notranslate"><span class="pre">&#64;AuthenticationPrincipal</span></code>, it is necessary to set <code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.bind.support.AuthenticationPrincipalArgumentResolver</span></code> in <code class="docutils literal notranslate"><span class="pre">&lt;mvc:argument-resolvers&gt;</span></code>.</div>
</div>
<ul class="simple">
<li><p><code class="file docutils literal notranslate"><span class="pre">spring-mvc.xml</span></code></p></li>
</ul>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="nt">&lt;mvc:annotation-driven&gt;</span>
<span class="w">     </span><span class="nt">&lt;mvc:argument-resolvers&gt;</span>
<span class="w">         </span><span class="nt">&lt;bean</span>
<span class="w">             </span><span class="na">class=</span><span class="s">&quot;org.springframework.data.web.PageableHandlerMethodArgumentResolver&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="hll"><span class="w">         </span><span class="nt">&lt;bean</span>
</span><span class="hll"><span class="w">             </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.bind.support.AuthenticationPrincipalArgumentResolver&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
</span><span class="w">     </span><span class="nt">&lt;/mvc:argument-resolvers&gt;</span>
<span class="w"> </span><span class="nt">&lt;/mvc:annotation-driven&gt;</span>
</pre></div>
</div>
<p>As shown below, <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> object can be fetched in Spring MVC Controller without using <code class="docutils literal notranslate"><span class="pre">SecurityContextHolder</span></code>.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">view</span><span class="p">(</span><span class="nd">@AuthenticationPrincipal</span><span class="w"> </span><span class="n">SampleUserDetails</span><span class="w"> </span><span class="n">userDetails</span><span class="p">,</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">        </span><span class="n">Model</span><span class="w"> </span><span class="n">model</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// get account object</span>
<span class="w">    </span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userDetails</span><span class="p">.</span><span class="na">getAccount</span><span class="p">();</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="n">account</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;account/view&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Fetch information of logged-in user using <code class="docutils literal notranslate"><span class="pre">&#64;AuthenticationPrincipal</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Fetch account information from <code class="docutils literal notranslate"><span class="pre">SampleUserDetails</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The type of argument attached with <code class="docutils literal notranslate"><span class="pre">&#64;AuthenticationPrincipal</span></code> annotation, needs to be a class that inherits <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> type.
Usually, it is better to use <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> inheritance class that is created using <a class="reference internal" href="#extendsuserdetailsservice"><span class="std std-ref">Extending UserDetailsService</span></a>.</p>
<p><code class="docutils literal notranslate"><span class="pre">SampleUserDetails</span></code> class is a class created using <a class="reference internal" href="Tutorial.html"><span class="doc">Spring Security Tutorial</span></a>. For details, refer to <a class="reference internal" href="Tutorial.html#tutorial-createauthservice"><span class="std std-ref">Creating Authentication Service</span></a>.</p>
</div>
<p><strong>This method is recommended when accessing UserDetails object in Controller</strong>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is recommended to use the <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> object information fetched from Controller in Service class rather than using <code class="docutils literal notranslate"><span class="pre">SecurityContextHolder</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">SecurityContextHolder</span></code> should be used only in those methods where <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> object is not passed as argument.</p>
</div>
</section>
<section id="accessing-userdetails-in-jsp">
<h4><a class="toc-backref" href="#id20" role="doc-backlink"><span class="section-number">6.3.2.4.2. </span>Accessing <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> in JSP</a><a class="headerlink" href="#accessing-userdetails-in-jsp" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">Spring Security provides JSP taglib as a feature that enables using authentication information in JSP. Following declaration is necessary in order to use taglib.</div>
</div>
<div class="highlight-jsp notranslate"><div class="highlight"><pre><span></span><span class="k">&lt;%@</span><span class="w"> </span><span class="n">taglib</span><span class="w"> </span><span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://www.springframework.org/security/tags&quot;</span><span class="w"> </span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;sec&quot;</span><span class="k">%&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is already set in WEB-INF/views/common/include.jsp when using <a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw-web-blank">TERASOLUNA Server Framework for Java (5.x) template</a>.</p>
</div>
<div class="line-block">
<div class="line">An example of using JSP for displaying authentication is as follows:</div>
</div>
<div class="highlight-jsp notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:authentication</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;principal.username&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="cm">&lt;!-- (1) --&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">Authentication</span></code> object can be accessed using <code class="docutils literal notranslate"><span class="pre">&lt;sec:authentication&gt;</span></code>  tag and the property specified in <code class="docutils literal notranslate"><span class="pre">property</span></code> attribute can be accessed. In this example, result of <code class="docutils literal notranslate"><span class="pre">getPrincipal().getUsername()</span></code> is output.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-jsp notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:authentication</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;principal&quot;</span><span class="w"> </span><span class="na">var=</span><span class="s">&quot;userDetails&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>

${f:h(userDetails.username)}<span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Property specified in <code class="docutils literal notranslate"><span class="pre">property</span></code> attribute can be stored in variable, by changing it to a  <code class="docutils literal notranslate"><span class="pre">var</span></code> attribute name.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> can be accessed in JSP once it is stored in variable by step (1).</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> can also be fetched in Controller and added to <code class="docutils literal notranslate"><span class="pre">Model</span></code>. However, it is advisable to use JSP tag when displaying it in JSP.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> created by <code class="docutils literal notranslate"><span class="pre">JdbcDaoImpl</span></code> which is explained in <a class="reference internal" href="#userdetailsservice"><span class="std std-ref">UserDetailsService class settings</span></a>, stores only the minimum required information such as “User ID” and “Authority”.</p>
<p>When other information related to the user such as “User name” etc. is required to be displayed as screen fields, it is necessary to extend <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> and  <code class="docutils literal notranslate"><span class="pre">UserDetailsService</span></code>.
For extension methods, refer to <a class="reference internal" href="#extendsuserdetailsservice"><span class="std std-ref">Extending UserDetailsService</span></a>.</p>
</div>
</section>
</section>
<section id="session-management-in-spring-security">
<span id="authentication-spring-security-how-to-use-sessionmanagement"></span><h3><a class="toc-backref" href="#id21" role="doc-backlink"><span class="section-number">6.3.2.5. </span>Session management in Spring Security</a><a class="headerlink" href="#session-management-in-spring-security" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">How to create session information at login and how to perform the settings when an exception occurs, is explained here.</div>
<div class="line">Session management method can be customized by specifying <code class="docutils literal notranslate"><span class="pre">&lt;session-management&gt;</span></code> tag.</div>
</div>
<div class="line-block">
<div class="line">Following is the configuration example of spring-security.xml</div>
</div>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">auto-config=</span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="na">create-session=</span><span class="s">&quot;ifRequired&quot;</span><span class="w"> </span><span class="nt">&gt;</span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">  </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="w">  </span><span class="nt">&lt;sec:session-management</span>
<span class="w">    </span><span class="na">invalid-session-url=</span><span class="s">&quot;/&quot;</span>
<span class="w">    </span><span class="na">session-authentication-error-url=</span><span class="s">&quot;/&quot;</span>
<span class="w">    </span><span class="na">session-fixation-protection=</span><span class="s">&quot;migrateSession&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="cm">&lt;!-- Steps (2) to (4) in the specified order of attribute --&gt;</span>
<span class="w">  </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify the policy for creating session in <code class="docutils literal notranslate"><span class="pre">create-session</span></code> attribute of <code class="docutils literal notranslate"><span class="pre">&lt;http&gt;</span></code> tag.</div>
<div class="line">Following values can be specified.</div>
</div>
<ul>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">always</span></code>:</div>
<div class="line">Spring Security creates a new session in case there is no existing session and it reuses a session if it already exists.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ifRequired</span></code> : (default)</div>
<div class="line">Spring Security creates a session if required. It reuses the session instead of creating a new one, if it already exists.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">never</span></code>:</div>
<div class="line">Spring Security does not create a session but reuses an existing session if any.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">stateless</span></code>:</div>
<div class="line">Spring Security neither creates a session nor uses an existing one if any. As a result, authentication is required each time.</div>
</div>
</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify the transition path when an invalid session ID is requested (session time-out) in <code class="docutils literal notranslate"><span class="pre">invalid-session-url</span></code> attribute.</div>
<div class="line">When not specified, a subsequent process is called without executing session existence check.</div>
<div class="line">For details, refer to “<a class="reference internal" href="#authentication-session-timeout"><span class="std std-ref">Detecting session time-out</span></a>”.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">When an exception occurs in <code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.authentication.session.SessionAuthenticationStrategy</span></code>, specify the transition path in <code class="docutils literal notranslate"><span class="pre">session-authentication-error-url</span></code> attribute.</div>
<div class="line">When not specified, “401 Unauthorized” is set in response code and error response is sent.</div>
<div class="line"><br /></div>
<div class="line">This setting is not used when authentication is performed using <code class="docutils literal notranslate"><span class="pre">&lt;form-login&gt;</span></code> tag. An exception occurred in <code class="docutils literal notranslate"><span class="pre">SessionAuthenticationStrategy</span></code> is handled according to the definition of <code class="docutils literal notranslate"><span class="pre">authentication-failure-handler-ref</span></code> attribute or <code class="docutils literal notranslate"><span class="pre">authentication-failure-url</span></code> attribute of <code class="docutils literal notranslate"><span class="pre">&lt;form-login&gt;</span></code> tag.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify the session management system of successful authentication in <code class="docutils literal notranslate"><span class="pre">session-fixation-protection</span></code> attribute.</div>
<div class="line">Following values can be specified.</div>
</div>
<ul>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">none</span></code>:</div>
<div class="line">It uses the session before login as it is.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">migrateSession</span></code>: (default on container prior to Servlet 3.0)</div>
<div class="line">It discards the session before login and creates a new one. It inherits the session information before login.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">changeSessionId</span></code>: (default on container on Servlet 3.1 and subsequent versions)</div>
<div class="line">It changes the session ID using <code class="docutils literal notranslate"><span class="pre">javax.servlet.http.HttpServletRequest#changeSessionId()</span></code> method added from Servlet 3.1.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">newSession</span></code>:</div>
<div class="line">It discards the session before login and creates a new one. It does not inherit the session information before login.</div>
</div>
</li>
</ul>
<div class="line-block">
<div class="line">The objective of this functionality is to prevent <a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.7.RELEASE/reference/htmlsingle/#ns-session-fixation">Session fixation attack</a> by allocating a new session ID for each login. Therefore, it is recommended to use this default setting unless there are other clear reasons for not using it.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="detecting-session-time-out">
<span id="authentication-session-timeout"></span><h4><a class="toc-backref" href="#id22" role="doc-backlink"><span class="section-number">6.3.2.5.1. </span>Detecting session time-out</a><a class="headerlink" href="#detecting-session-time-out" title="Permalink to this heading">¶</a></h4>
<p>When session time-out is to be detected,
it is advisable to specify the transition path when session time-out occurs, in <code class="docutils literal notranslate"><span class="pre">invalid-session-url</span></code> attribute .</p>
<p>When <code class="docutils literal notranslate"><span class="pre">invalid-session-url</span></code> attribute is specified,
the session existence check (existence check for requested session ID) is performed for all the requests that match with
the path pattern specified in <code class="docutils literal notranslate"><span class="pre">pattern</span></code> attribute of <code class="docutils literal notranslate"><span class="pre">http</span></code> element.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When a path that detects session time-out and a path that does not detect session time-out are mixed, <code class="docutils literal notranslate"><span class="pre">http</span></code> element needs to be defined multiple times.
When <code class="docutils literal notranslate"><span class="pre">http</span></code> element is defined multiple times, care needs to be taken as the setting becomes redundant reducing maintainability.</p>
<p>When setting to detect session time-out becomes redundant, create a custom filter that can specify an applicable path or an exception path.
To create a custom filter, it is advisable to refer to or to use the following classes provided by Spring Security.</p>
<ul>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.session.SessionManagementFilter</span></code></div>
<div class="line">Process to perform session existence check (existence check of requested session ID) is implemented.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.session.SimpleRedirectInvalidSessionStrategy</span></code></div>
<div class="line">Process after detecting session time-out (invalid session ID) is implemented.</div>
<div class="line">By default, it is redirected to the path specified after the session is created.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.util.matcher.RequestMatcher</span></code></div>
<div class="line">It is an interface to determine whether it matches with the request and it can be used in the processes of determining an applicable path or an exception path.</div>
<div class="line">Some useful implementation classes have been provided in the same package.</div>
</div>
</li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When <a class="reference internal" href="CSRF.html"><span class="doc">CSRF Countermeasures</span></a> is performed by specifying <code class="docutils literal notranslate"><span class="pre">&lt;csrf&gt;</span></code> element, sometimes the session time-out can be detected using “CSRF measures” functionality.</p>
<p>Following are the conditions for detecting session time-out using “CSRF measures” functionality.</p>
<ul class="simple">
<li><p>Destination to store CSRF token is HTTP session (default).</p></li>
<li><p>CSRF token cannot be fetched from HTTP session.</p></li>
<li><p>It is <a class="reference internal" href="CSRF.html#csrf-default-add-token-method"><span class="std std-ref">Request for CSRF token check</span></a>.</p></li>
</ul>
<p>When session time-out is detected using “CSRF measures” functionality, any of the following operations is performed.</p>
<ul class="simple">
<li><p>When <code class="docutils literal notranslate"><span class="pre">invalid-session-url</span></code> attribute is specified, it is redirected to the path specified in <code class="docutils literal notranslate"><span class="pre">invalid-session-url</span></code> after the session is created.</p></li>
<li><p>When <code class="docutils literal notranslate"><span class="pre">invalid-session-url</span></code> attribute is not specified, it is handled according to the definition of <code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.access.AccessDeniedHandler</span></code> specified in  <code class="docutils literal notranslate"><span class="pre">&lt;access-denied-handler&gt;</span></code> element.</p></li>
</ul>
<p>Refer to “<a class="reference internal" href="CSRF.html#csrf-spring-security-setting"><span class="std std-ref">spring-security.xml settings</span></a>” for the method to define <code class="docutils literal notranslate"><span class="pre">AccessDeniedHandler</span></code>.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="settings-of-concurrent-session-control">
<span id="authentication-control-user-samatime-session"></span><h4><a class="toc-backref" href="#id23" role="doc-backlink"><span class="section-number">6.3.2.5.2. </span>Settings of Concurrent Session Control</a><a class="headerlink" href="#settings-of-concurrent-session-control" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">Spring Security provides (<a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.7.RELEASE/reference/htmlsingle/#concurrent-sessions">Concurrent Session Control</a>) a functionality that controls the number of concurrent sessions that a user can log in to.</div>
<div class="line">The user mentioned here is the authentication user object fetched by <code class="docutils literal notranslate"><span class="pre">Authentication.getPrincipal()</span></code>.</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This functionality is valid when single application server is configured, or, session replication is implemented using session server or cluster (i.e. all applications are using the same session area)
When multiple servers or multiple instances are configured leading to the existence of different session areas, a care should be taken as concurrent login cannot be controlled using this functionality.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">For the control method when it exceeds the maximum number of sessions, following patterns are available. They should be suitably used as per business requirements.</div>
</div>
<ol class="arabic simple">
<li><p>When a user exceeds the number of maximum sessions, the user having least usage is disabled. (after win)</p></li>
<li><p>When a user exceeds the number of maximum sessions, new login request is not accepted.(first win)</p></li>
</ol>
<p>In both cases, following settings need to be added to web.xml, to enable this functionality.</p>
<div class="highlight-xml notranslate" id="httpsessioneventpublisher-ref"><div class="highlight"><pre><span></span><span class="nt">&lt;listener&gt;</span>
<span class="w">  </span><span class="nt">&lt;listener-class&gt;</span>org.springframework.security.web.session.HttpSessionEventPublisher<span class="nt">&lt;/listener-class&gt;</span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;/listener&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">When using Concurrent Session Control, it is necessary to define <code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.session.HttpSessionEventPublisher</span></code> in listener.</div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
<section id="setting-sec-concurrency-control">
<span id="authentication-concurrency-control"></span><h4><a class="toc-backref" href="#id24" role="doc-backlink"><span class="section-number">6.3.2.5.3. </span>Setting <code class="docutils literal notranslate"><span class="pre">&lt;sec:concurrency-control&gt;</span></code></a><a class="headerlink" href="#setting-sec-concurrency-control" title="Permalink to this heading">¶</a></h4>
<p>When using Concurrent Session Control,
specify <a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.7.RELEASE/reference/htmlsingle/#ns-concurrent-sessions">&lt;sec:concurrency-control&gt;</a> element as a child element of <code class="docutils literal notranslate"><span class="pre">&lt;sec:session-management&gt;</span></code> element.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">auto-config=</span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;sec:session-management&gt;</span>
<span class="w">      </span><span class="nt">&lt;sec:concurrency-control</span>
<span class="w">          </span><span class="na">error-if-maximum-exceeded=</span><span class="s">&quot;true&quot;</span>
<span class="w">          </span><span class="na">max-sessions=</span><span class="s">&quot;2&quot;</span>
<span class="w">          </span><span class="na">expired-url=</span><span class="s">&quot;/expiredSessionError.jsp&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="cm">&lt;!-- Steps (1) to (3) in the specified order of attribute --&gt;</span>
<span class="w">  </span><span class="nt">&lt;/sec:session-management&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 20%" />
<col style="width: 30%" />
<col style="width: 10%" />
<col style="width: 30%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Attribute name</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Default values</p></th>
<th class="head"><p>Description of default values</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">error-if-maximum-exceeded</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify behavior if there is a login request in a state where it exceeds maximum number of sessions that a user can log in to.</div>
<div class="line">When set to <code class="docutils literal notranslate"><span class="pre">true</span></code>, generate authentication error so that a new login is not accepted. (first win)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">false</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Login is possible, but a session which is not frequently used is invalidated (session with oldest last access time). When a request is sent by the client using invalidated session, it is transited to the URL specified in <code class="docutils literal notranslate"><span class="pre">expired-url</span></code> attribute. (after win)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">max-sessions</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify maximum number of sessions that a single user can log in to.</div>
<div class="line">When 2 is set, same user can login with 2 sessions.</div>
</div>
</td>
<td><div class="line-block">
<div class="line">1</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Default is 1 session only</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">expired-url</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">URL to be transited to when a request is sent by the client using invalidated session.</div>
</div>
</td>
<td><div class="line-block">
<div class="line">None</div>
</div>
</td>
<td><div class="line-block">
<div class="line">A fixed message to notify that session is invalidated is sent as response.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note" id="authentication-session-authentication-strategy-ref">
<p class="admonition-title">Note</p>
<p>When a filter (FORM_LOGIN_FILTER) for authentication is to be customized,
it is necessary to disable the following 2 <code class="docutils literal notranslate"><span class="pre">SessionAuthenticationStrategy</span></code> classes, apart from specifying <code class="docutils literal notranslate"><span class="pre">&lt;sec:concurrency-control&gt;</span></code> element.</p>
<ul>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.authentication.session.ConcurrentSessionControlAuthenticationStrategy</span></code></div>
<div class="line">A class to check number of sessions for each logged in user after successful authentication.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.authentication.session.RegisterSessionAuthenticationStrategy</span></code></div>
<div class="line">A class to register a session with successful authentication, in session management area.</div>
</div>
</li>
</ul>
<p>In version 1.0.x.RELEASE dependent Spring Security 3.1, <code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.authentication.session.ConcurrentSessionControlStrategy</span></code> class is provided; however,
it is deprecated API from Spring Security 3.2.
When upgrading version from Spring Security 3.1 to Spring Security 3.2 or later versions, changes need to be made so that it can be used with combination of following classes.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ConcurrentSessionControlAuthenticationStrategy</span></code> (added in Spring Security 3.2)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RegisterSessionAuthenticationStrategy</span></code> (added in Spring Security 3.2)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.authentication.session.SessionFixationProtectionStrategy</span></code></p></li>
</ul>
<p>For specific methods of definition,
refer to sample code of <a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.7.RELEASE/reference/htmlsingle/#concurrent-sessions">Spring Security Reference -Web Application Security (Concurrency Control)-</a>.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="setting-the-handler-class-in-case-of-authentication-error">
<span id="authentication-failure-handler-ref"></span><h3><a class="toc-backref" href="#id25" role="doc-backlink"><span class="section-number">6.3.2.6. </span>Setting the handler class in case of authentication error</a><a class="headerlink" href="#setting-the-handler-class-in-case-of-authentication-error" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">By performing the settings for <code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.authentication.ExceptionMappingAuthenticationFailureHandler</span></code> class in</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">authentication-failure-handler-ref</span></code> attribute of <code class="docutils literal notranslate"><span class="pre">&lt;sec:form-login&gt;</span></code> element,</div>
<div class="line">exception thrown at the time of authentication error and its corresponding destination, can be specified.</div>
<div class="line">The specified destination is accessible to unauthenticated user.</div>
</div>
<p>spring-security.xml</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">auto-config=</span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="na">use-expressions=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;sec:form-login</span><span class="w"> </span><span class="na">login-page=</span><span class="s">&quot;/login&quot;</span>
<span class="w">      </span><span class="na">authentication-failure-handler-ref=</span><span class="s">&quot;authenticationFailureHandler&quot;</span>
<span class="w">      </span><span class="na">authentication-success-handler-ref=</span><span class="s">&quot;authenticationSuccessHandler&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>

<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;authenticationFailureHandler&quot;</span>
<span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.ExceptionMappingAuthenticationFailureHandler&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;defaultFailureUrl&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;/login/defaultError&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">  </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;exceptionMappings&quot;</span><span class="nt">&gt;</span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;props&gt;</span>
<span class="w">      </span><span class="nt">&lt;prop</span><span class="w"> </span><span class="na">key=</span>
<span class="w">        </span><span class="s">&quot;org.springframework.security.authentication.BadCredentialsException&quot;</span><span class="nt">&gt;</span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="w">          </span>/login/badCredentials
<span class="w">      </span><span class="nt">&lt;/prop&gt;</span>
<span class="w">      </span><span class="nt">&lt;prop</span><span class="w"> </span><span class="na">key=</span>
<span class="w">        </span><span class="s">&quot;org.springframework.security.core.userdetails.UsernameNotFoundException&quot;</span><span class="nt">&gt;</span><span class="cm">&lt;!-- (4) --&gt;</span>
<span class="w">          </span>/login/usernameNotFound
<span class="w">      </span><span class="nt">&lt;/prop&gt;</span>
<span class="w">      </span><span class="nt">&lt;prop</span><span class="w"> </span><span class="na">key=</span>
<span class="w">        </span><span class="s">&quot;org.springframework.security.authentication.DisabledException&quot;</span><span class="nt">&gt;</span><span class="cm">&lt;!-- (5) --&gt;</span>
<span class="w">          </span>/login/disabled
<span class="w">      </span><span class="nt">&lt;/prop&gt;</span>
<span class="w">      </span><span class="nt">&lt;prop</span><span class="w"> </span><span class="na">key=</span>
<span class="w">        </span><span class="s">&quot;org.springframework.security.authentication.ProviderNotFoundException&quot;</span><span class="nt">&gt;</span><span class="cm">&lt;!-- (6) --&gt;</span>
<span class="w">          </span>/login/providerNotFound
<span class="w">      </span><span class="nt">&lt;/prop&gt;</span>
<span class="w">      </span><span class="nt">&lt;prop</span><span class="w"> </span><span class="na">key=</span>
<span class="w">        </span><span class="s">&quot;org.springframework.security.authentication.AuthenticationServiceException&quot;</span><span class="nt">&gt;</span><span class="cm">&lt;!-- (7) --&gt;</span>
<span class="w">          </span>/login/authenticationService
<span class="w">      </span><span class="nt">&lt;/prop&gt;</span>
<span class="w">      </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="w">    </span><span class="nt">&lt;/props&gt;</span>
<span class="w">  </span><span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify the default destination path in case of an error.</div>
<div class="line">If an exception not defined in the <code class="docutils literal notranslate"><span class="pre">exceptionMappings</span></code> property that will be described later occurs, it transits to the destination specified by this property.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify the exceptions to be caught and their corresponding destinations in a list format.</div>
<div class="line">Set the exception class in key and destination in value.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If an exception defined into the <code class="docutils literal notranslate"><span class="pre">exceptionMappings</span></code> property is occurred, the <code class="docutils literal notranslate"><span class="pre">ExceptionMappingAuthenticationFailureHandler</span></code> redirects the request to the transition destination mapped to a occurred exception.
However a message generated by Spring Security does not display on the screen because the exception object is not stored in the session scope.</p>
<p>Therefore, the message shown on the error screen needs to be created at the processing of redirect destination(controller’s method or view).</p>
<p>In addition, changing of following properties is ignored because the processing which refers those properties are not called in this case.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">useForward</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">allowSessionCreation</span></code></p></li>
</ul>
</div>
<p id="springsecurity-exception">A typical exception thrown by Spring Security is shown below.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 25%" />
<col style="width: 65%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Error type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">BadCredentialsException</span></code></p></td>
<td><p>It is thrown when authentication error occurs due to failure in password verification.</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">UsernameNotFoundException</span></code></p></td>
<td><div class="line-block">
<div class="line">It is thrown when authentication error occurs due to an invalid user ID (non-existent user ID).</div>
<div class="line">When specifying the class that inherits <code class="docutils literal notranslate"><span class="pre">org.springframework.security.authentication.dao.AbstractUserDetailsAuthenticationProvider</span></code> in authentication provider,</div>
<div class="line">if <code class="docutils literal notranslate"><span class="pre">hideUserNotFoundExceptions</span></code> is not changed to <code class="docutils literal notranslate"><span class="pre">false</span></code>, the above exception is changed to <code class="docutils literal notranslate"><span class="pre">BadCredentialsException</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">DisabledException</span></code></p></td>
<td><p>It is thrown when an authentication error occurs due to invalid user ID.</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">ProviderNotFoundException</span></code></p></td>
<td><div class="line-block">
<div class="line">It is thrown at the time of undetected error of authentication provider class.</div>
<div class="line">Exception occurs when authentication provider class is invalid due to reasons such as a setting error etc.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">AuthenticationServiceException</span></code></p></td>
<td><div class="line-block">
<div class="line">It is thrown at the time of authentication service error.</div>
<div class="line">It is thrown when certain errors such as DB connection error etc. occur in authentication service.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>In this example, transition is made by handling <code class="docutils literal notranslate"><span class="pre">UsernameNotFoundException</span></code>.
However, if the user is informed that user ID does not exist, presence and absence of specific IDs may be revealed, which is not desirable from the security perspective.
Therefore, it is recommended that the screen transition and notification message to the user is set such that it does not reveal type of exception.</p>
</div>
</section>
<section id="setting-sec-logout-element">
<span id="form-logout"></span><h3><a class="toc-backref" href="#id26" role="doc-backlink"><span class="section-number">6.3.2.7. </span>Setting <code class="docutils literal notranslate"><span class="pre">&lt;sec:logout&gt;</span></code> element</a><a class="headerlink" href="#setting-sec-logout-element" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">How to set the <code class="docutils literal notranslate"><span class="pre">&lt;sec:logout&gt;</span></code> element, is explained in this section.</div>
</div>
<p>spring-security.xml</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">auto-config=</span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="na">use-expressions=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="w">  </span><span class="nt">&lt;sec:logout</span>
<span class="w">      </span><span class="na">logout-url=</span><span class="s">&quot;/logout&quot;</span>
<span class="w">      </span><span class="na">logout-success-url=</span><span class="s">&quot;/&quot;</span>
<span class="w">      </span><span class="na">invalidate-session=</span><span class="s">&quot;true&quot;</span>
<span class="w">      </span><span class="na">delete-cookies=</span><span class="s">&quot;JSESSIONID&quot;</span>
<span class="w">      </span><span class="na">success-handler-ref=</span><span class="s">&quot;logoutSuccessHandler&quot;</span>
<span class="w">    </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- Perform steps (1) to (5) in the specified attribute order --&gt;</span>
<span class="w">  </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify the path for executing logout process in <code class="docutils literal notranslate"><span class="pre">logout-url</span></code> attribute.</div>
<div class="line">When not specified, “/j_spring_security_logout” will be default path.</div>
</div>
<div class="line-block">
<div class="line"><strong>In this guideline, it is recommended to change it to system specific value instead of using the above default value “/j_spring_security_logout”.</strong> In this example, “/logout” is specified.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify the destination path after logout in <code class="docutils literal notranslate"><span class="pre">logout-success-url</span></code> attribute.</div>
<div class="line">When not specified, “/” will be default path.</div>
</div>
<div class="line-block">
<div class="line">If <code class="docutils literal notranslate"><span class="pre">success-handler-ref</span></code> attribute is to be specified while this attribute is specified, error will occur during startup process.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">In <code class="docutils literal notranslate"><span class="pre">invalidate-session</span></code> attribute, set whether to discard the session when logging out.</div>
<div class="line">By default, it is set to <code class="docutils literal notranslate"><span class="pre">true</span></code>.</div>
<div class="line">In case of <code class="docutils literal notranslate"><span class="pre">true</span></code>, the session is discarded at the time of logout.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">In <code class="docutils literal notranslate"><span class="pre">delete-cookies</span></code> attribute, mention the cookie names to be deleted at the time of logout.</div>
<div class="line">When multiple cookies are mentioned, use “,” to separate them.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify the handler class to be called after a successful logout, in <code class="docutils literal notranslate"><span class="pre">success-handler-ref</span></code> attribute.</div>
</div>
<div class="line-block">
<div class="line">If <code class="docutils literal notranslate"><span class="pre">logout-success-url</span></code> attribute is to be specified while this attribute is specified, error will occur during startup process.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>Why it is not recommended to use Spring Security default value, “/j_spring_security_logout”</strong></p>
<p>If default value is used, the fact that the application is using Spring Security is revealed.
As a result, if any Spring Security related vulnerability is detected, there is a higher risk of receiving an attack due to the vulnerability.
In order to prevent these risks, it is recommended to avoid using default value.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>CSRF token check is performed when  <code class="docutils literal notranslate"><span class="pre">&lt;sec:csrf&gt;</span></code> explained in <a class="reference internal" href="CSRF.html"><span class="doc">CSRF Countermeasures</span></a> is used. Therefore, <strong>it is necessary to send logout request using POST as well as to send the CSRF token.</strong>.
How to embed CSRF token is described below.</p>
<ul>
<li><p><a class="reference internal" href="CSRF.html#csrf-formformtag-use"><span class="std std-ref">How to insert CSRF token automatically</span></a></p>
<blockquote>
<div><div class="highlight-jsp notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="w"> </span><span class="nt">&lt;form:form</span><span class="w"> </span><span class="na">method=</span><span class="s">&quot;POST&quot;</span>
</span><span class="w">   </span><span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/logout&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span><span class="nt">&lt;input</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;Logout&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="hll"><span class="w"> </span><span class="nt">&lt;/form:form&gt;</span>
</span></pre></div>
</div>
<p>Following HTML is output in such cases. CSRF token is set as hidden.</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;command&quot;</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;/your-context-path/logout&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;POST&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Logout&quot;</span> <span class="p">/&gt;</span>
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;_csrf&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;5826038f-0a84-495b-a851-c363e501b73b&quot;</span> <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p><a class="reference internal" href="CSRF.html#csrf-formtag-use"><span class="std std-ref">How to explicitly insert CSRF token</span></a></p>
<blockquote>
<div><div class="highlight-jsp notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="nt">&lt;form</span><span class="w">  </span><span class="na">method=</span><span class="s">&quot;POST&quot;</span>
<span class="w">   </span><span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/logout&quot;</span><span class="nt">&gt;</span>
<span class="hll"><span class="w">   </span><span class="nt">&lt;sec:csrfInput/&gt;</span>
</span><span class="w">   </span><span class="nt">&lt;input</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;Logout&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
<p>In this case as well, following HTML is output as before. CSRF token is set as hidden.</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span>  <span class="na">method</span><span class="o">=</span><span class="s">&quot;POST&quot;</span>
  <span class="na">action</span><span class="o">=</span><span class="s">&quot;/your-context-path/logout&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;_csrf&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;5826038f-0a84-495b-a851-c363e501b73b&quot;</span> <span class="p">/&gt;</span>
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Logout&quot;</span> <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div>
</section>
<section id="setting-sec-remember-me-element">
<h3><a class="toc-backref" href="#id27" role="doc-backlink"><span class="section-number">6.3.2.8. </span>Setting <code class="docutils literal notranslate"><span class="pre">&lt;sec:remember-me&gt;</span></code> element</a><a class="headerlink" href="#setting-sec-remember-me-element" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">“<a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.7.RELEASE/reference/htmlsingle/#remember-me">Remember Me</a> ” functionality enhances convenience of the frequent users of the website and,</div>
<div class="line">is the functionality that stores the login status.</div>
<div class="line">This functionality stores login information in a cookie, if user has given permission, even after the browser is closed</div>
<div class="line">and enables the user to login without re-entering the user name and password.</div>
</div>
<div class="line-block">
<div class="line">The attributes of <code class="docutils literal notranslate"><span class="pre">&lt;sec:remember-me&gt;</span></code> elements are shown below.</div>
</div>
<p>spring-security.xml</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">auto-config=</span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="na">use-expressions=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="w">  </span><span class="nt">&lt;sec:remember-me</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;terasoluna-tourreservation-km/ylnHv&quot;</span>
<span class="w">          </span><span class="na">token-validity-seconds=</span><span class="s">&quot;#{30 * 24 * 60 * 60}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w">  </span><span class="cm">&lt;!-- Perform steps (1) to (2) in the specified attribute order--&gt;</span>
<span class="w">  </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify the unique key that stores the cookie for Remember Me functionality in <code class="docutils literal notranslate"><span class="pre">key</span></code> attribute.</div>
<div class="line">When not specified, it is recommended to specify it in cases where improvement in start-up time has been considered as the unique key is generated at the time of start-up.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify the validity of the cookie for Remember Me functionality in seconds, in <code class="docutils literal notranslate"><span class="pre">token-validity-seconds</span></code> attribute. In this example it is set as 30 days.</div>
<div class="line">When not specified, it is valid for 14 days by default.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>For attributes other than the above, refer to <a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.7.RELEASE/reference/htmlsingle/#nsa-remember-me">Spring Security manual</a>.</p>
<p>Following flag that enables “Remember Me” functionality needs to be provided in login form.</p>
<div class="highlight-jsp notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;form</span><span class="w"> </span><span class="na">method=</span><span class="s">&quot;post&quot;</span>
<span class="w">  </span><span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/authentication&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="w">    </span><span class="nt">&lt;label</span><span class="w"> </span><span class="na">for=</span><span class="s">&quot;_spring_security_remember_me&quot;</span><span class="nt">&gt;</span>Remember<span class="w"> </span>Me<span class="w"> </span>:<span class="w"> </span><span class="nt">&lt;/label&gt;</span>
<span class="w">    </span><span class="nt">&lt;input</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;_spring_security_remember_me&quot;</span>
<span class="w">      </span><span class="na">id=</span><span class="s">&quot;_spring_security_remember_me&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;checkbox&quot;</span>
<span class="hll"><span class="w">      </span><span class="na">checked=</span><span class="s">&quot;checked&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
</span><span class="hll"><span class="w">    </span><span class="nt">&lt;input</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;LOGIN&quot;</span><span class="nt">&gt;</span>
</span><span class="hll"><span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
</span><span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">When requested as <code class="docutils literal notranslate"><span class="pre">true</span></code>, next authentication can be avoided</div>
<div class="line">by setting <code class="docutils literal notranslate"><span class="pre">_spring_security_remember_me</span></code> in HTTP parameter.</div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="how-to-extend">
<h2><a class="toc-backref" href="#id28" role="doc-backlink"><span class="section-number">6.3.3. </span>How to extend</a><a class="headerlink" href="#how-to-extend" title="Permalink to this heading">¶</a></h2>
<section id="extending-userdetailsservice">
<span id="extendsuserdetailsservice"></span><h3><a class="toc-backref" href="#id29" role="doc-backlink"><span class="section-number">6.3.3.1. </span>Extending <code class="docutils literal notranslate"><span class="pre">UserDetailsService</span></code></a><a class="headerlink" href="#extending-userdetailsservice" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">When information other than user ID and password needs to be fetched at the time of authentication,</div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">org.springframework.security.core.userdetails.UserDetails</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">org.springframework.security.core.userdetails.userDetailsService</span></code></p></li>
</ul>
<p>need to be implemented.</p>
<p>When attached information such as login user’s name and division etc. need to be displayed at all times on screen header, fetching it for each request from DB hampers the efficiency.
This extension is necessary to enable its access from <code class="docutils literal notranslate"><span class="pre">SecurityContext</span></code> or <code class="docutils literal notranslate"><span class="pre">&lt;sec:authentication&gt;</span></code> tags, by storing it in <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> object.</p>
<section id="extending-userdetails">
<h4><a class="toc-backref" href="#id30" role="doc-backlink"><span class="section-number">6.3.3.1.1. </span>Extending <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code></a><a class="headerlink" href="#extending-userdetails" title="Permalink to this heading">¶</a></h4>
<p>Creating <code class="docutils literal notranslate"><span class="pre">ReservationUserDetails</span></code> class that also stores customer information other than authentication information.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ReservationUserDetails</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="c1">// omitted</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Customer</span><span class="w"> </span><span class="n">customer</span><span class="p">;</span><span class="w"> </span><span class="c1">// (2)</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">GrantedAuthority</span><span class="o">&gt;</span><span class="w"> </span><span class="n">DEFAULT_AUTHORITIES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Collections</span>
<span class="w">            </span><span class="p">.</span><span class="na">singletonList</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">SimpleGrantedAuthority</span><span class="p">(</span><span class="s">&quot;ROLE_USER&quot;</span><span class="p">));</span><span class="w">         </span><span class="c1">// (3)</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">ReservationUserDetails</span><span class="p">(</span><span class="n">Customer</span><span class="w"> </span><span class="n">customer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="n">customer</span><span class="p">.</span><span class="na">getCustomerCode</span><span class="p">(),</span>
<span class="w">                </span><span class="n">customer</span><span class="p">.</span><span class="na">getCustomerPassword</span><span class="p">(),</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">DEFAULT_AUTHORITIES</span><span class="p">);</span><span class="w"> </span><span class="c1">// (4)</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">customer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">customer</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Customer</span><span class="w"> </span><span class="nf">getCustomer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (5)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">customer</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Inherit <code class="docutils literal notranslate"><span class="pre">org.springframework.security.core.userdetails.User</span></code> class which is the default class of <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Store the DomainObject class containing authentication information and customer information.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Create authorization information using constructor of <code class="docutils literal notranslate"><span class="pre">org.springframework.security.core.authority.SimpleGrantedAuthority</span></code>. Here the authority named “ROLE_USER” is provided.</div>
<div class="line"><br /></div>
<div class="line">This is a simple implementation wherein the authorization information should essentially be fetched from another table in the DB.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Set the user ID and password contained in DomainObject, in the constructor of super class.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Method to access customer information via <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When the business requirement cannot be implemented just by inheriting <code class="docutils literal notranslate"><span class="pre">User</span></code> class, <code class="docutils literal notranslate"><span class="pre">UserDetails</span></code> interface may be implemented.</p>
</div>
</section>
<section id="implementing-an-independent-userdetailsservice">
<h4><a class="toc-backref" href="#id31" role="doc-backlink"><span class="section-number">6.3.3.1.2. </span>Implementing an independent <code class="docutils literal notranslate"><span class="pre">UserDetailsService</span></code></a><a class="headerlink" href="#implementing-an-independent-userdetailsservice" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">Create ReservationUserDetailsService class that implements <code class="docutils literal notranslate"><span class="pre">UserDetailsService</span></code>.</div>
<div class="line">In this example, customer information is fetched from DB by injecting  <code class="docutils literal notranslate"><span class="pre">CustomerSharedService</span></code> class that implements the process to fetch <code class="docutils literal notranslate"><span class="pre">Customer</span></code> object.</div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ReservationUserDetailsService</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">UserDetailsService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Inject</span>
<span class="w">    </span><span class="n">CustomerSharedService</span><span class="w"> </span><span class="n">customerSharedService</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">UserDetails</span><span class="w"> </span><span class="nf">loadUserByUsername</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">UsernameNotFoundException</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Customer</span><span class="w"> </span><span class="n">customer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">customerSharedService</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">username</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// omitted</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReservationUserDetails</span><span class="p">(</span><span class="n">customer</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id3">
<h4><a class="toc-backref" href="#id32" role="doc-backlink"><span class="section-number">6.3.3.1.3. </span>How to use</a><a class="headerlink" href="#id3" title="Permalink to this heading">¶</a></h4>
<p>How to use the created <code class="docutils literal notranslate"><span class="pre">ReservationUserDetailsService</span></code> and <code class="docutils literal notranslate"><span class="pre">ReservationUserDetails</span></code>, is described here.</p>
<ul>
<li><p>spring-security.xml</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:authentication-manager&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:authentication-provider</span><span class="w"> </span><span class="na">user-service-ref=</span><span class="s">&quot;userDetailsService&quot;</span><span class="nt">&gt;</span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">        </span><span class="nt">&lt;sec:password-encoder</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;passwordEncoder&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/sec:authentication-provider&gt;</span>
<span class="nt">&lt;/sec:authentication-manager&gt;</span>

<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;userDetailsService&quot;</span>
<span class="w">    </span><span class="na">class=</span><span class="s">&quot;com.example.domain.service.userdetails.ReservationUserDetailsService&quot;</span><span class="nt">&gt;</span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="cm">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Define the Bean ID of <code class="docutils literal notranslate"><span class="pre">ReservationUserDetailsService</span></code> in ref attribute.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Perform Bean definition for <code class="docutils literal notranslate"><span class="pre">ReservationUserDetailsService</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p>JSP</p>
<blockquote>
<div><p>Access <code class="docutils literal notranslate"><span class="pre">Customer</span></code> object by using <code class="docutils literal notranslate"><span class="pre">&lt;sec:authentication&gt;</span></code> tag.</p>
</div></blockquote>
<div class="highlight-jsp notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:authentication</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;principal.customer&quot;</span><span class="w"> </span><span class="na">var=</span><span class="s">&quot;customer&quot;</span><span class="nt">/&gt;</span><span class="cm">&lt;!-- (1) --&gt;</span>
${f:h(customer.customerName)}<span class="cm">&lt;!-- (1) --&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">Customer</span></code> object contained in <code class="docutils literal notranslate"><span class="pre">ReservationUserDetails</span></code> is stored in variable.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Display the optional property of <code class="docutils literal notranslate"><span class="pre">Customer</span></code> object stored in variable.</div>
<div class="line">For <code class="docutils literal notranslate"><span class="pre">f:h()</span></code>, refer to <a class="reference internal" href="XSS.html"><span class="doc">XSS Countermeasures</span></a>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p>Controller</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">view</span><span class="p">(</span><span class="nd">@AuthenticationPrincipal</span><span class="w"> </span><span class="n">ReservationUserDetails</span><span class="w"> </span><span class="n">userDetails</span><span class="p">,</span><span class="w"> </span><span class="n">Model</span><span class="w"> </span><span class="n">model</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// get Customer</span>
<span class="w">    </span><span class="n">Customer</span><span class="w"> </span><span class="n">customer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userDetails</span><span class="p">.</span><span class="na">getCustomer</span><span class="p">();</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="c1">// omitted ...</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Fetch the logged-in <code class="docutils literal notranslate"><span class="pre">Customer</span></code> object from <code class="docutils literal notranslate"><span class="pre">ReservationUserDetails</span></code>.</div>
<div class="line">Perform business process by passing this object to Service class.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When customer information is changed, <code class="docutils literal notranslate"><span class="pre">Customer</span></code> object contained in <code class="docutils literal notranslate"><span class="pre">ReservationUserDetails</span></code> is not changed unless logout is carried out once.</p>
<p>It is recommended not to store the information that may undergo frequent changes or the information which is changed by a user other than the login user (administrator etc.).</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="extending-authenticationprovider">
<h3><a class="toc-backref" href="#id33" role="doc-backlink"><span class="section-number">6.3.3.2. </span>Extending <code class="docutils literal notranslate"><span class="pre">AuthenticationProvider</span></code></a><a class="headerlink" href="#extending-authenticationprovider" title="Permalink to this heading">¶</a></h3>
<p>In case of business requirements that cannot be supported by Spring Security’s <a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.7.RELEASE/apidocs/org/springframework/security/authentication/AuthenticationProvider.html">authentication provider</a>,
it is necessary to create a class that implements <code class="docutils literal notranslate"><span class="pre">org.springframework.security.authentication.AuthenticationProvider</span></code> interface.</p>
<p>Here, the extended example of DB authentication using 3 parameters such as user name, password and <strong>Company identifier (independent authentication parameter)</strong> is given below.</p>
<figure class="align-default">
<a class="reference internal image-reference" href="../_images/Authentication_HowToExtends_LoginForm.png"><img alt="Authentication_HowToExtends_LoginForm" src="../_images/Authentication_HowToExtends_LoginForm.png" style="width: 50%;" /></a>
</figure>
<p>To implement the above requirements, it is necessary to create a class given below.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>Implementation class of <code class="docutils literal notranslate"><span class="pre">org.springframework.security.core.Authentication</span></code> interface to store user name, password and company identifier (independent authentication parameter).</p>
<p>Here, it is created by inheriting <code class="docutils literal notranslate"><span class="pre">org.springframework.security.authentication.UsernamePasswordAuthenticationToken</span></code> class.</p>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p>Implementation class of <code class="docutils literal notranslate"><span class="pre">org.springframework.security.authentication.AuthenticationProvider</span></code> to perform DB authentication using user name, password and company identifier (independent authentication parameter).</p>
<p>Here, it is created by inheriting <code class="docutils literal notranslate"><span class="pre">org.springframework.security.authentication.dao.DaoAuthenticationProvider</span></code> class.</p>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p>Servlet filter class to create <code class="docutils literal notranslate"><span class="pre">Authentication</span></code> for fetching user name, password and company identifier (independent authentication parameter) from request parameter and passing them to <code class="docutils literal notranslate"><span class="pre">AuthenticationManager</span></code> (<code class="docutils literal notranslate"><span class="pre">AuthenticationProvider</span></code>).</p>
<p>Here, it is created by inheriting <code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter</span></code> class.</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Here, as the example considers addition of independent parameter as an authentication parameter,
it is necessary to extend servlet filter class to generate <code class="docutils literal notranslate"><span class="pre">Authentication</span></code> and implementation class of <code class="docutils literal notranslate"><span class="pre">Authentication</span></code> interface.</p>
<p>To authenticate only by user name and password, the authentication process can be extended
only by creating implementation class of <code class="docutils literal notranslate"><span class="pre">AuthenticationProvider</span></code> interface.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="extending-usernamepasswordauthenticationtoken">
<h4><a class="toc-backref" href="#id34" role="doc-backlink"><span class="section-number">6.3.3.2.1. </span>Extending <code class="docutils literal notranslate"><span class="pre">UsernamePasswordAuthenticationToken</span></code></a><a class="headerlink" href="#extending-usernamepasswordauthenticationtoken" title="Permalink to this heading">¶</a></h4>
<p>Here, by inheriting <code class="docutils literal notranslate"><span class="pre">UsernamePasswordAuthenticationToken</span></code> class,
create a class that stores company identifier (independent authentication parameter) in addition to user name and password.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// import omitted</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CompanyIdUsernamePasswordAuthenticationToken</span><span class="w"> </span><span class="kd">extends</span>
<span class="w">    </span><span class="n">UsernamePasswordAuthenticationToken</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">serialVersionUID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SpringSecurityCoreVersion</span><span class="p">.</span><span class="na">SERIAL_VERSION_UID</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">companyId</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">CompanyIdUsernamePasswordAuthenticationToken</span><span class="p">(</span>
<span class="w">            </span><span class="n">Object</span><span class="w"> </span><span class="n">principal</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">credentials</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">companyId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="n">principal</span><span class="p">,</span><span class="w"> </span><span class="n">credentials</span><span class="p">);</span>

<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">companyId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">companyId</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// (3)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">CompanyIdUsernamePasswordAuthenticationToken</span><span class="p">(</span>
<span class="w">            </span><span class="n">Object</span><span class="w"> </span><span class="n">principal</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">credentials</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">companyId</span><span class="p">,</span>
<span class="w">            </span><span class="n">Collection</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">GrantedAuthority</span><span class="o">&gt;</span><span class="w"> </span><span class="n">authorities</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="n">principal</span><span class="p">,</span><span class="w"> </span><span class="n">credentials</span><span class="p">,</span><span class="w"> </span><span class="n">authorities</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">companyId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">companyId</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getCompanyId</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">companyId</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>Create a field to store company identifier.</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p>Create a constructor to be used while creating instances for storing the information (information specified in request parameter) before authentication.</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Create a constructor to be used while creating instances for storing the authenticated information.</div>
<div class="line">Authentication completion status is reached by passing authorization information to the constructor argument of parent class.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="extending-daoauthenticationprovide">
<h4><a class="toc-backref" href="#id35" role="doc-backlink"><span class="section-number">6.3.3.2.2. </span>Extending <code class="docutils literal notranslate"><span class="pre">DaoAuthenticationProvide</span></code></a><a class="headerlink" href="#extending-daoauthenticationprovide" title="Permalink to this heading">¶</a></h4>
<p>Here, by inheriting <code class="docutils literal notranslate"><span class="pre">DaoAuthenticationProvider</span></code> class,
create a class that performs DB authentication using user name, password and company identifier.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// import omitted</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CompanyIdUsernamePasswordAuthenticationProvider</span><span class="w"> </span><span class="kd">extends</span>
<span class="w">    </span><span class="n">DaoAuthenticationProvider</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="c1">// omitted</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">additionalAuthenticationChecks</span><span class="p">(</span><span class="n">UserDetails</span><span class="w"> </span><span class="n">userDetails</span><span class="p">,</span>
<span class="w">            </span><span class="n">UsernamePasswordAuthenticationToken</span><span class="w"> </span><span class="n">authentication</span><span class="p">)</span>
<span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">AuthenticationException</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="c1">// (1)</span>
<span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">additionalAuthenticationChecks</span><span class="p">(</span><span class="n">userDetails</span><span class="p">,</span><span class="w"> </span><span class="n">authentication</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// (2)</span>
<span class="w">        </span><span class="n">CompanyIdUsernamePasswordAuthenticationToken</span><span class="w"> </span><span class="n">companyIdUsernamePasswordAuthentication</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="p">(</span><span class="n">CompanyIdUsernamePasswordAuthenticationToken</span><span class="p">)</span><span class="w"> </span><span class="n">authentication</span><span class="p">;</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">requestedCompanyId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">companyIdUsernamePasswordAuthentication</span><span class="p">.</span><span class="na">getCompanyId</span><span class="p">();</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">companyId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">SampleUserDetails</span><span class="p">)</span><span class="w"> </span><span class="n">userDetails</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">getAccount</span><span class="p">().</span><span class="na">getCompanyId</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">companyId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">requestedCompanyId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BadCredentialsException</span><span class="p">(</span><span class="n">messages</span><span class="p">.</span><span class="na">getMessage</span><span class="p">(</span>
<span class="w">                    </span><span class="s">&quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="s">&quot;Bad credentials&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">Authentication</span><span class="w"> </span><span class="nf">createSuccessAuthentication</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">principal</span><span class="p">,</span>
<span class="w">            </span><span class="n">Authentication</span><span class="w"> </span><span class="n">authentication</span><span class="p">,</span><span class="w"> </span><span class="n">UserDetails</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">companyId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">SampleUserDetails</span><span class="p">)</span><span class="w"> </span><span class="n">user</span><span class="p">).</span><span class="na">getAccount</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">getCompanyId</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// (3)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CompanyIdUsernamePasswordAuthenticationToken</span><span class="p">(</span><span class="n">user</span><span class="p">,</span>
<span class="w">                </span><span class="n">authentication</span><span class="p">.</span><span class="na">getCredentials</span><span class="p">(),</span><span class="w"> </span><span class="n">companyId</span><span class="p">,</span>
<span class="w">                </span><span class="n">user</span><span class="p">.</span><span class="na">getAuthorities</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">supports</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">authentication</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// (4)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">CompanyIdUsernamePasswordAuthenticationToken</span><span class="p">.</span><span class="na">class</span>
<span class="w">                </span><span class="p">.</span><span class="na">isAssignableFrom</span><span class="p">(</span><span class="n">authentication</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>Call parent class method and execute check process provided by Spring Security.</p>
<p>Password authentication is performed at this time.</p>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p>When password authentication is successful, validate company identifier (independent authentication parameter).</p>
<p>In the above example, it is checked whether requested company identifier matches with the company identifier stored in the table.</p>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p>When password authentication and independent authentication is successful, create and return authenticated <code class="docutils literal notranslate"><span class="pre">CompanyIdUsernamePasswordAuthenticationToken</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p>When <code class="docutils literal notranslate"><span class="pre">Authentication</span></code>that can be casted is specified in <code class="docutils literal notranslate"><span class="pre">CompanyIdUsernamePasswordAuthenticationToken</span></code>,
perform the authentication process using this class.</p></td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>User existence check, user status check (check for invalid users, locked users, validity expired users, etc.),
are performed as processes of parent class before the <code class="docutils literal notranslate"><span class="pre">additionalAuthenticationChecks</span></code> method is called.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="extending-usernamepasswordauthenticationfilter">
<span id="authentication-custom-usernamepasswordauthenticationfilter"></span><h4><a class="toc-backref" href="#id36" role="doc-backlink"><span class="section-number">6.3.3.2.3. </span>Extending <code class="docutils literal notranslate"><span class="pre">UsernamePasswordAuthenticationFilter</span></code></a><a class="headerlink" href="#extending-usernamepasswordauthenticationfilter" title="Permalink to this heading">¶</a></h4>
<p>Here, by inheriting <code class="docutils literal notranslate"><span class="pre">UsernamePasswordAuthenticationFilter</span></code> class,
create a servlet filter class to pass the authentication information (user name, password, company identifier) to <code class="docutils literal notranslate"><span class="pre">AuthenticationProvider</span></code>.</p>
<p>Implementation of <code class="docutils literal notranslate"><span class="pre">attemptAuthentication</span></code> method is customized by copying <code class="docutils literal notranslate"><span class="pre">UsernamePasswordAuthenticationFilter</span></code>class method.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// import omitted</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CompanyIdUsernamePasswordAuthenticationFilter</span><span class="w"> </span><span class="kd">extends</span>
<span class="w">    </span><span class="n">UsernamePasswordAuthenticationFilter</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Authentication</span><span class="w"> </span><span class="nf">attemptAuthentication</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span>
<span class="w">            </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">AuthenticationException</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">request</span><span class="p">.</span><span class="na">getMethod</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;POST&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AuthenticationServiceException</span><span class="p">(</span><span class="s">&quot;Authentication method not supported: &quot;</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getMethod</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// (1)</span>
<span class="w">        </span><span class="c1">// Obtain UserName, Password, CompanyId</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">super</span><span class="p">.</span><span class="na">obtainUsername</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">super</span><span class="p">.</span><span class="na">obtainPassword</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">companyId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obtainCompanyId</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">username</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">username</span><span class="p">.</span><span class="na">trim</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">password</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">CompanyIdUsernamePasswordAuthenticationToken</span><span class="w"> </span><span class="n">authRequest</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">CompanyIdUsernamePasswordAuthenticationToken</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="p">,</span><span class="w"> </span><span class="n">companyId</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Allow subclasses to set the &quot;details&quot; property</span>
<span class="w">        </span><span class="n">setDetails</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">authRequest</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">getAuthenticationManager</span><span class="p">().</span><span class="na">authenticate</span><span class="p">(</span><span class="n">authRequest</span><span class="p">);</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// (3)</span>
<span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">obtainCompanyId</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&quot;companyid&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>Create an instance of <code class="docutils literal notranslate"><span class="pre">CompanyIdUsernamePasswordAuthenticationToken</span></code> from authentication information (user name, password, company identifier) fetched from request parameter.</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p>Call <code class="docutils literal notranslate"><span class="pre">authenticate</span></code> method of <code class="docutils literal notranslate"><span class="pre">org.springframework.security.authentication.AuthenticationManager</span></code> by specifying
authentication information (<code class="docutils literal notranslate"><span class="pre">CompanyIdUsernamePasswordAuthenticationToken</span></code> instances) specified in request parameter.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">AuthenticationManager</span></code> method is called, authentication process of <code class="docutils literal notranslate"><span class="pre">AuthenticationProvider</span></code> is called.</p>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p>Company identifier is fetched from the request parameter called <code class="docutils literal notranslate"><span class="pre">&quot;companyid&quot;</span></code>.</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Authentication information input check</strong></p>
<p>Sometimes, a check needs to be performed in advance for the obvious input errors that occur due to load reduction on DB server.
In such cases, input check process can be performed by extending <code class="docutils literal notranslate"><span class="pre">UsernamePasswordAuthenticationFilter</span></code>, similar to
<a class="reference internal" href="#authentication-custom-usernamepasswordauthenticationfilter"><span class="std std-ref">Extending UsernamePasswordAuthenticationFilter</span></a>.</p>
<p>Input check is not performed in the above mentioned example.</p>
</div>
<div class="admonition-todo admonition" id="id4">
<p class="admonition-title">Todo</p>
<p>Input check of authentication information can also be performed using Bean Validation by handling the request in Controller class.</p>
<p>Input check method using Bean Validation will be added later.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="application-of-extended-authentication-process">
<h4><a class="toc-backref" href="#id37" role="doc-backlink"><span class="section-number">6.3.3.2.4. </span>Application of extended authentication process</a><a class="headerlink" href="#application-of-extended-authentication-process" title="Permalink to this heading">¶</a></h4>
<p>Apply the DB authentication function using user name, password, company identifier (independent authentication parameter) in Spring Security.</p>
<p><code class="docutils literal notranslate"><span class="pre">spring-security.xml</span></code></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- omitted --&gt;</span>

<span class="cm">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;sec:http</span>
<span class="w">    </span><span class="na">auto-config=</span><span class="s">&quot;false&quot;</span>
<span class="w">    </span><span class="na">use-expressions=</span><span class="s">&quot;true&quot;</span>
<span class="w">    </span><span class="na">entry-point-ref=</span><span class="s">&quot;loginUrlAuthenticationEntryPoint&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:custom-filter</span>
<span class="w">        </span><span class="na">position=</span><span class="s">&quot;FORM_LOGIN_FILTER&quot;</span>
<span class="w">        </span><span class="na">ref=</span><span class="s">&quot;companyIdUsernamePasswordAuthenticationFilter&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>

<span class="w">    </span><span class="nt">&lt;sec:csrf</span><span class="w"> </span><span class="na">token-repository-ref=</span><span class="s">&quot;csrfTokenRepository&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>

<span class="w">    </span><span class="nt">&lt;sec:logout</span>
<span class="w">        </span><span class="na">logout-url=</span><span class="s">&quot;/logout&quot;</span>
<span class="w">        </span><span class="na">logout-success-url=</span><span class="s">&quot;/login&quot;</span>
<span class="w">        </span><span class="na">delete-cookies=</span><span class="s">&quot;JSESSIONID&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>

<span class="w">    </span><span class="nt">&lt;sec:intercept-url</span><span class="w"> </span><span class="na">pattern=</span><span class="s">&quot;/login&quot;</span><span class="w"> </span><span class="na">access=</span><span class="s">&quot;permitAll&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:intercept-url</span><span class="w"> </span><span class="na">pattern=</span><span class="s">&quot;/**&quot;</span><span class="w"> </span><span class="na">access=</span><span class="s">&quot;isAuthenticated()&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;/sec:http&gt;</span>

<span class="cm">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;loginUrlAuthenticationEntryPoint&quot;</span>
<span class="w">    </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;/login&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="cm">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;companyIdUsernamePasswordAuthenticationFilter&quot;</span>
<span class="w">    </span><span class="na">class=</span><span class="s">&quot;com.example.app.common.security.CompanyIdUsernamePasswordAuthenticationFilter&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- (5) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;requiresAuthenticationRequestMatcher&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.util.matcher.AntPathRequestMatcher&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">index=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;/authentication&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">index=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;POST&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/bean&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- (6) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;authenticationManager&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;authenticationManager&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- (7) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;sessionAuthenticationStrategy&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;sessionAuthenticationStrategy&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- (8) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;authenticationFailureHandler&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.SimpleUrlAuthenticationFailureHandler&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;/login?error=true&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/bean&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- (9) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;authenticationSuccessHandler&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.SimpleUrlAuthenticationSuccessHandler&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="cm">&lt;!-- (6&#39;) --&gt;</span>
<span class="nt">&lt;sec:authentication-manager</span><span class="w"> </span><span class="na">alias=</span><span class="s">&quot;authenticationManager&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:authentication-provider</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;companyIdUsernamePasswordAuthenticationProvider&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/sec:authentication-manager&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;companyIdUsernamePasswordAuthenticationProvider&quot;</span>
<span class="w">    </span><span class="na">class=</span><span class="s">&quot;com.example.app.common.security.CompanyIdUsernamePasswordAuthenticationProvider&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;userDetailsService&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;sampleUserDetailsService&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;passwordEncoder&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;passwordEncoder&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="cm">&lt;!-- (7&#39;) --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;sessionAuthenticationStrategy&quot;</span>
<span class="w">    </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.session.CompositeSessionAuthenticationStrategy&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;constructor-arg&gt;</span>
<span class="w">        </span><span class="nt">&lt;util:list&gt;</span>
<span class="w">            </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.csrf.CsrfAuthenticationStrategy&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;csrfTokenRepository&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;/bean&gt;</span>
<span class="w">            </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.session.SessionFixationProtectionStrategy&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/util:list&gt;</span>
<span class="w">    </span><span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;csrfTokenRepository&quot;</span>
<span class="w">    </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.csrf.HttpSessionCsrfTokenRepository&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>


<span class="cm">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>To replace “FORM_LOGIN_FILTER” using <code class="docutils literal notranslate"><span class="pre">custom-filter</span></code>element, it is necessary to perform the following settings in attributes of <code class="docutils literal notranslate"><span class="pre">http</span></code> element.</p>
<ul class="simple">
<li><p>Since it is not possible to use auto configuration, either set <code class="docutils literal notranslate"><span class="pre">auto-config=&quot;false&quot;</span></code> or delete <code class="docutils literal notranslate"><span class="pre">auto-config</span></code> attribute.</p></li>
<li><p>Since it is not possible to use <code class="docutils literal notranslate"><span class="pre">form-login</span></code> element, explicitly specify <code class="docutils literal notranslate"><span class="pre">AuthenticationEntryPoint</span></code> to be used by using <code class="docutils literal notranslate"><span class="pre">entry-point-ref</span></code> attribute.</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p>Replace “FORM_LOGIN_FILTER” by using <code class="docutils literal notranslate"><span class="pre">custom-filter</span></code> element.</p>
<p>Specify <code class="docutils literal notranslate"><span class="pre">&quot;FORM_LOGIN_FILTER&quot;</span></code> in <code class="docutils literal notranslate"><span class="pre">position</span></code> attribute of <code class="docutils literal notranslate"><span class="pre">custom-filter</span></code> element, and specify servlet filter bean ID extended in <code class="docutils literal notranslate"><span class="pre">ref</span></code> attribute.</p>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p>Define bean of <code class="docutils literal notranslate"><span class="pre">AuthenticationEntryPoint</span></code> to be specified in <code class="docutils literal notranslate"><span class="pre">entry-point-ref</span></code> attributes of <code class="docutils literal notranslate"><span class="pre">http</span></code>element.</p>
<p>Here, bean of <code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint</span></code> class used while specifying <code class="docutils literal notranslate"><span class="pre">form-login</span></code> element, is defined.</p>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p>Define bean of servlet filter to be used as “FORM_LOGIN_FILTER”.</p>
<p>Here, bean of extended servlet filter class (<code class="docutils literal notranslate"><span class="pre">CompanyIdUsernamePasswordAuthenticationFilter</span></code>) is defined.</p>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><p>Specify <code class="docutils literal notranslate"><span class="pre">RequestMatcher</span></code> instance for detecting request to perform authentication process, in <code class="docutils literal notranslate"><span class="pre">requiresAuthenticationRequestMatcher</span></code> property.</p>
<p>Here, if there is a request in <code class="docutils literal notranslate"><span class="pre">/authentication</span></code> path, authentication process is performed.
This is similar to specifying <code class="docutils literal notranslate"><span class="pre">&quot;/authentication&quot;</span></code> in <code class="docutils literal notranslate"><span class="pre">login-processing-url</span></code> attribute of <code class="docutils literal notranslate"><span class="pre">form-login</span></code> element.</p>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><p>Specify the value which was set in <code class="docutils literal notranslate"><span class="pre">alias</span></code> attribute of <code class="docutils literal notranslate"><span class="pre">authentication-manager</span></code> element, in <code class="docutils literal notranslate"><span class="pre">authenticationManager</span></code> property.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">alias</span></code> attribute of <code class="docutils literal notranslate"><span class="pre">authentication-manager</span></code>element is specified,
it is possible to inject dependency (DI) of <code class="docutils literal notranslate"><span class="pre">AuthenticationManager</span></code> bean generated by Spring Security, to other bean.</p>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(6’)</div>
</div>
</td>
<td><p>Set extended <code class="docutils literal notranslate"><span class="pre">AuthenticationProvider</span></code> (<code class="docutils literal notranslate"><span class="pre">CompanyIdUsernamePasswordAuthenticationProvider</span></code>) to <code class="docutils literal notranslate"><span class="pre">AuthenticationManager</span></code> generated by Spring Security.</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><p>Specify bean of component (<code class="docutils literal notranslate"><span class="pre">SessionAuthenticationStrategy</span></code>) to control the session handling at the time of successful authentication, in <code class="docutils literal notranslate"><span class="pre">sessionAuthenticationStrategy</span></code> property.</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7’)</div>
</div>
</td>
<td><p>Define bean of component (<code class="docutils literal notranslate"><span class="pre">SessionAuthenticationStrategy</span></code>) to control the session handling at the time of successful authentication.</p>
<p>Here, the following features provided by Spring Security are enabled.</p>
<ul class="simple">
<li><p>Component to re-create CSRF token (<code class="docutils literal notranslate"><span class="pre">CsrfAuthenticationStrategy</span></code>)</p></li>
<li><p>Component to generate new session to prevent session fixation attack (<code class="docutils literal notranslate"><span class="pre">SessionFixationProtectionStrategy</span></code>)</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify handler class, called at the time of authentication failure, in <code class="docutils literal notranslate"><span class="pre">authenticationFailureHandler</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify handler class, called at the time of successful authentication, in <code class="docutils literal notranslate"><span class="pre">authenticationSuccessHandler</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When <code class="docutils literal notranslate"><span class="pre">auto-config=&quot;false&quot;</span></code> is specified, <code class="docutils literal notranslate"><span class="pre">&lt;sec:http-basic&gt;</span></code> element and <code class="docutils literal notranslate"><span class="pre">&lt;sec:logout&gt;</span></code> element will not be enabled if not defined explicitly.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id5">
<h4><a class="toc-backref" href="#id38" role="doc-backlink"><span class="section-number">6.3.3.2.5. </span>Creating login form</a><a class="headerlink" href="#id5" title="Permalink to this heading">¶</a></h4>
<p>Here, add company identifier for the screen (JSP), introduced in <a class="reference internal" href="#form-login-jsp"><span class="std std-ref">Creating login form</span></a>.</p>
<div class="highlight-jsp notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;form:form</span><span class="w"> </span><span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/authentication&quot;</span><span class="w"> </span><span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="w">    </span><span class="nt">&lt;span&gt;</span>User<span class="w"> </span>Id<span class="nt">&lt;/span&gt;&lt;br&gt;</span>
<span class="w">    </span><span class="nt">&lt;input</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;text&quot;</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;username&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;j_username&quot;</span><span class="nt">&gt;&lt;br&gt;</span>
<span class="hll"><span class="w">    </span><span class="nt">&lt;span&gt;</span>Company<span class="w"> </span>Id<span class="nt">&lt;/span&gt;&lt;br&gt;</span>
</span><span class="hll"><span class="w">    </span><span class="nt">&lt;input</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;text&quot;</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;companyid&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;companyid&quot;</span><span class="nt">&gt;&lt;br&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (1) --&gt;</span>
</span><span class="w">    </span><span class="nt">&lt;span&gt;</span>Password<span class="nt">&lt;/span&gt;&lt;br&gt;</span>
<span class="w">    </span><span class="nt">&lt;input</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;password&quot;</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;password&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;j_password&quot;</span><span class="nt">&gt;&lt;br&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/form:form&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify <code class="docutils literal notranslate"><span class="pre">&quot;companyid&quot;</span></code> in the input field name of company identifier.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
</section>
<section id="appendix">
<h2><a class="toc-backref" href="#id39" role="doc-backlink"><span class="section-number">6.3.4. </span>Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this heading">¶</a></h2>
<section id="authentication-success-handler-for-which-destination-can-be-specified">
<h3><a class="toc-backref" href="#id40" role="doc-backlink"><span class="section-number">6.3.4.1. </span>Authentication Success handler for which destination can be specified</a><a class="headerlink" href="#authentication-success-handler-for-which-destination-can-be-specified" title="Permalink to this heading">¶</a></h3>
<p>In case of authentication using Spring Security, user is transited to the following two paths if authentication is successful.</p>
<ul class="simple">
<li><p>Path described in bean definition file (<code class="docutils literal notranslate"><span class="pre">spring-security.xml</span></code>) (path specified in <code class="docutils literal notranslate"><span class="pre">default-target-url</span></code> attribute of <code class="docutils literal notranslate"><span class="pre">&lt;form-login&gt;</span></code> element)</p></li>
<li><p>Path for displaying “Secure page for which authentication is necessary” which is accessed before the login.</p></li>
</ul>
<p>In common library, in addition to the functionality provided by Spring Security,
a class (<code class="docutils literal notranslate"><span class="pre">org.terasoluna.gfw.security.web.RedirectAuthenticationHandler</span></code>) is provided which can specify the destination path in request parameter.</p>
<p><code class="docutils literal notranslate"><span class="pre">RedirectAuthenticationHandler</span></code> is a class, created for implementing the mechanism given below.</p>
<ul class="simple">
<li><p>For performing login for page display</p></li>
<li><p>For specifying destination page after login at JSP side (source JSP)</p></li>
</ul>
<figure class="align-center" id="id6">
<a class="reference internal image-reference" href="../_images/Authentication_Appendix_ScreenFlow.png"><img alt="Authentication_Appendix_Screen_Flow" src="../_images/Authentication_Appendix_ScreenFlow.png" style="width: 70%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>Picture - Screen_Flow</strong></span><a class="headerlink" href="#id6" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<div class="line-block">
<div class="line">Example of using <code class="docutils literal notranslate"><span class="pre">RedirectAuthenticationHandler</span></code> is shown below.</div>
</div>
<p><strong>Description example of source screen JSP</strong></p>
<div class="highlight-jsp notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;form:form</span><span class="w"> </span><span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/login&quot;</span><span class="w"> </span><span class="na">method=</span><span class="s">&quot;get&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="w">  </span><span class="nt">&lt;input</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;hidden&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;redirectTo&quot;</span>
<span class="w">    </span><span class="na">value=</span><span class="s">&quot;${pageContext.request.contextPath}/reservetour/read?</span>
<span class="s">    ${f:query(reserveTourForm)}&amp;page.page=${f:h(param[&#39;page.page&#39;])}</span>
<span class="s">    &amp;page.size=${f:h(param[&#39;page.size&#39;])}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;/form:form&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">As hidden field, set the “URL of destination page after successful login”.</div>
<div class="line">Specify “<code class="docutils literal notranslate"><span class="pre">redirectTo</span></code> ” as hidden field name (request parameter name).</div>
<div class="line"><br /></div>
<div class="line">Field name (request parameter name) should match with <code class="docutils literal notranslate"><span class="pre">targetUrlParameter</span></code>  property value of <code class="docutils literal notranslate"><span class="pre">RedirectAuthenticationHandler</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>Description example of login screen JSP</strong></p>
<div class="highlight-jsp notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;form:form</span><span class="w"> </span><span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/authentication&quot;</span><span class="w"> </span><span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
<span class="w">     </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="w">     </span><span class="nt">&lt;input</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;submit&quot;</span>
<span class="w">       </span><span class="na">value=</span><span class="s">&quot;Login&quot;</span><span class="nt">&gt;</span>
<span class="w">     </span><span class="nt">&lt;input</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;hidden&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;redirectTo&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${f:h(param.redirectTo)}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">     </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/form:form&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">As hidden field, set the “URL of destination page after successful login”, passed by request parameter from source screen.</div>
<div class="line">Specify “<code class="docutils literal notranslate"><span class="pre">redirectTo</span></code> ” as hidden field name (request parameter name).</div>
<div class="line"><br /></div>
<div class="line">Field name (request parameter name) should match with <code class="docutils literal notranslate"><span class="pre">targetUrlParameter</span></code> property value of <code class="docutils literal notranslate"><span class="pre">RedirectAuthenticationHandler</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>Spring Security configuration file</strong></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">auto-config=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:form-login</span>
<span class="w">        </span><span class="na">login-page=</span><span class="s">&quot;/login&quot;</span>
<span class="w">        </span><span class="na">login-processing-url=</span><span class="s">&quot;/authentication&quot;</span>
<span class="w">        </span><span class="na">authentication-failure-handler-ref=</span><span class="s">&quot;authenticationFailureHandler&quot;</span>
<span class="w">        </span><span class="na">authentication-success-handler-ref=</span><span class="s">&quot;authenticationSuccessHandler&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>

<span class="cm">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;authenticationSuccessHandler&quot;</span>
<span class="w">    </span><span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.security.web.RedirectAuthenticationHandler&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="cm">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;authenticationFailureHandler&quot;</span>
<span class="w">    </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.ExceptionMappingAuthenticationFailureHandler&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;defaultFailureUrl&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;/login?error=true&quot;</span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (4) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;useForward&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (5) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify BeanId of <code class="docutils literal notranslate"><span class="pre">authentication-failure-handler-ref</span></code> (handler setting at the time of authentication error) and <code class="docutils literal notranslate"><span class="pre">authentication-success-handler-ref</span></code> (handler setting in case of successful authentication).</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Define <code class="docutils literal notranslate"><span class="pre">org.terasoluna.gfw.security.web.RedirectAuthenticationHandler</span></code>as a bean referred from <code class="docutils literal notranslate"><span class="pre">authentication-success-handler-ref</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Define <code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.authentication.ExceptionMappingAuthenticationFailureHandler</span></code> as a bean referred from <code class="docutils literal notranslate"><span class="pre">authentication-failure-handler-ref</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify destination path at the time of authentication failure.</div>
<div class="line">In above example, login screen path and the query (<code class="docutils literal notranslate"><span class="pre">error=true</span></code>) to indicate transition after authentication error, is set.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><strong>To use this functionality, useForward should be set to true.</strong></div>
<div class="line">By setting it to <code class="docutils literal notranslate"><span class="pre">true</span></code>, Forward is used instead of Redirect, at the time of transiting to the screen (login screen) which would be displayed in case of authentication failure.</div>
</div>
<div class="line-block">
<div class="line">This is because “URL of destination page after successful login” needs to be included in the request parameter of authentication request.</div>
<div class="line">By using Redirect, if authentication error screen is displayed, “URL of destination page after successful login” cannot be inherited from request parameter. Hence, it is not possible to transit to the specified screen even after login is successful.</div>
<div class="line">To avoid this, it is necessary to ensure that “URL of destination page after successful login” is inherited from request parameter using Forward.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Measures against Open Redirector vulnerability are implemented in <code class="docutils literal notranslate"><span class="pre">RedirectAuthenticationHandler</span></code>.
Therefore, user cannot transit to external sites such as “<a class="reference external" href="http://google.com">http://google.com</a>”.
In order to transit to an external site, it is necessary to create a class that implements <code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.RedirectStrategy</span></code>,
and it is to be injected to <code class="docutils literal notranslate"><span class="pre">targetUrlParameterRedirectStrategy</span></code> property of <code class="docutils literal notranslate"><span class="pre">RedirectAuthenticationHandler</span></code>.</p>
<p>As a precaution while extending, it is necessary to have a structure that does not pose any problems even if <code class="docutils literal notranslate"><span class="pre">redirectTo</span></code>value is tampered with.
For example, the measures given below can be considered.</p>
<ul class="simple">
<li><p>Specifying the ID of page number etc. instead of directly specifying the destination URL and redirecting to the URL corresponding to that ID.</p></li>
<li><p>Checking the destination URL, and redirecting only the URL that matches with white list.</p></li>
</ul>
</div>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="PasswordHashing.html" title="6.4. Password Hashing"
             >next</a> |</li>
        <li class="right" >
          <a href="Tutorial.html" title="6.2. Spring Security Tutorial"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.0.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" ><span class="section-number">6. </span>Security for TERASOLUNA Server Framework for Java (5.x)</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">6.3. </span>Authentication</a></li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013-2015, NTT DATA.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 5.3.0.Theme by <a href="http://github.com/vkvn">vkvn</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>
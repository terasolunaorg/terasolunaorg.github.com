<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>6.7. CSRF Countermeasures &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.0.1.RELEASE documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/solar.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="7. Appendix" href="../Appendix/index.html" />
    <link rel="prev" title="6.6. XSS Countermeasures" href="XSS.html" /><script async src="https://www.googletagmanager.com/gtag/js?id=G-847V2Q99G8"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date()); gtag('config', 'G-847V2Q99G8');
</script>
<script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../Appendix/index.html" title="7. Appendix"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="XSS.html" title="6.6. XSS Countermeasures"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.0.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U"><span class="section-number">6. </span>Security for TERASOLUNA Server Framework for Java (5.x)</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">6.7. </span>CSRF Countermeasures</a></li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">6.7. CSRF Countermeasures</a><ul>
<li><a class="reference internal" href="#overview">6.7.1. Overview</a></li>
<li><a class="reference internal" href="#how-to-use">6.7.2. How to use</a><ul>
<li><a class="reference internal" href="#spring-security-settings">6.7.2.1. Spring Security settings</a><ul>
<li><a class="reference internal" href="#spring-security-xml-settings">6.7.2.1.1. spring-security.xml settings</a></li>
<li><a class="reference internal" href="#spring-mvc-xml-settings">6.7.2.1.2. spring-mvc.xml settings</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sending-csrf-token-using-form">6.7.2.2. Sending CSRF token using form</a><ul>
<li><a class="reference internal" href="#how-to-insert-csrf-token-automatically">6.7.2.2.1. How to insert CSRF token automatically</a></li>
<li><a class="reference internal" href="#how-to-explicitly-insert-csrf-token">6.7.2.2.2. How to explicitly insert CSRF token</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sending-csrf-token-using-ajax">6.7.2.3. Sending CSRF token using Ajax</a></li>
<li><a class="reference internal" href="#considerations-at-the-time-of-multipart-request-file-upload">6.7.2.4. Considerations at the time of multipart request (file upload)</a><ul>
<li><a class="reference internal" href="#how-to-use-multipartfilter">6.7.2.4.1. How to use MultipartFilter</a></li>
<li><a class="reference internal" href="#how-to-send-csrf-token-using-query-parameter">6.7.2.4.2. How to send CSRF token using query parameter</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="XSS.html"
                          title="previous chapter"><span class="section-number">6.6. </span>XSS Countermeasures</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="../Appendix/index.html"
                          title="next chapter"><span class="section-number">7. </span>Appendix</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/Security/CSRF.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="csrf-countermeasures">
<h1><span class="section-number">6.7. </span>CSRF Countermeasures<a class="headerlink" href="#csrf-countermeasures" title="Permalink to this heading">¶</a></h1>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">Table of contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id4">Overview</a></p></li>
<li><p><a class="reference internal" href="#how-to-use" id="id5">How to use</a></p>
<ul>
<li><p><a class="reference internal" href="#spring-security-settings" id="id6">Spring Security settings</a></p>
<ul>
<li><p><a class="reference internal" href="#spring-security-xml-settings" id="id7">spring-security.xml settings</a></p></li>
<li><p><a class="reference internal" href="#spring-mvc-xml-settings" id="id8">spring-mvc.xml settings</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#sending-csrf-token-using-form" id="id9">Sending CSRF token using form</a></p>
<ul>
<li><p><a class="reference internal" href="#how-to-insert-csrf-token-automatically" id="id10">How to insert CSRF token automatically</a></p></li>
<li><p><a class="reference internal" href="#how-to-explicitly-insert-csrf-token" id="id11">How to explicitly insert CSRF token</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#sending-csrf-token-using-ajax" id="id12">Sending CSRF token using Ajax</a></p></li>
<li><p><a class="reference internal" href="#considerations-at-the-time-of-multipart-request-file-upload" id="id13">Considerations at the time of multipart request (file upload)</a></p>
<ul>
<li><p><a class="reference internal" href="#how-to-use-multipartfilter" id="id14">How to use MultipartFilter</a></p></li>
<li><p><a class="reference internal" href="#how-to-send-csrf-token-using-query-parameter" id="id15">How to send CSRF token using query parameter</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
<section id="overview">
<h2><a class="toc-backref" href="#id4" role="doc-backlink"><span class="section-number">6.7.1. </span>Overview</a><a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h2>
<div class="line-block">
<div class="line">Cross-Site Request Forgery (hereinafter CSRF) is an attack that forces a user to perform unwanted actions on a different website in which the user is authenticated.</div>
<div class="line">This is usually carried out by executing a script or by automatic transfer (HTTP redirect).</div>
</div>
<div class="line-block">
<div class="line">Following are the methods to prevent server side CSRF attack.</div>
</div>
<ul class="simple">
<li><p>Embedding confidential information (token)</p></li>
<li><p>Re-entering password</p></li>
<li><p>‘Refer’ check</p></li>
</ul>
<div class="line-block">
<div class="line">In OWASP, the method to use token pattern is <a class="reference external" href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet#General_Recommendation:_Synchronizer_Token_Pattern">recommended</a>.</div>
</div>
<figure class="align-center" id="id2">
<a class="reference internal image-reference" href="../_images/csrf_check_other_site.png"><img alt="csrf check other site" src="../_images/csrf_check_other_site.png" style="width: 60%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>Picture - csrf check other site</strong></span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>About OWASP</strong></p>
<p>Open Web Application Security Project (OWASP) is not-for-profit international organization dedicated to
enable organizations to develop and maintain applications that can be trusted. It advocates measures such as effective approach etc. with respect to security.</p>
<blockquote>
<div><p><a class="reference external" href="https://www.owasp.org/index.php/Main_Page">https://www.owasp.org/index.php/Main_Page</a></p>
</div></blockquote>
</div>
<div class="line-block">
<div class="line">As mentioned earlier, there are multiple ways to avoid CSRF. However, Spring Security provides a library that uses fixed tokens.</div>
<div class="line">In this, one fixed token is used for each session and the same value is used for all requests.</div>
</div>
<div class="line-block">
<div class="line">When the default HTTP method is other than GET, HEAD, TRACE and OPTIONS,</div>
<div class="line">CSRF token included in the request is checked and if the values do not match, an error (HTTP Status: 403 [Forbidden]) is thrown.</div>
</div>
<figure class="align-center">
<a class="reference internal image-reference" href="../_images/csrf_check_kind.png"><img alt="csrf check other kind" src="../_images/csrf_check_kind.png" style="width: 50%;" /></a>
</figure>
<p><strong>Picture - csrf check other kind</strong></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>CSRF token check is the check that verifies an invalid update request from a different site and throws an error.
To check and enforce users to maintain the order (series of business flows), refer <a class="reference internal" href="../ArchitectureInDetail/DoubleSubmitProtection.html#double-submit-transactiontokencheck"><span class="std std-ref">Transaction Token Check</span></a>.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="how-to-use">
<h2><a class="toc-backref" href="#id5" role="doc-backlink"><span class="section-number">6.7.2. </span>How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this heading">¶</a></h2>
<section id="spring-security-settings">
<h3><a class="toc-backref" href="#id6" role="doc-backlink"><span class="section-number">6.7.2.1. </span>Spring Security settings</a><a class="headerlink" href="#spring-security-settings" title="Permalink to this heading">¶</a></h3>
<p>Settings to use the CSRF functionality provided by Spring Security, are explained here.
Use of web.xml configured using <a class="reference internal" href="SpringSecurity.html#howtouse-springsecurity"><span class="std std-ref">Spring Security’s How to use</span></a>, is assumed.</p>
<section id="spring-security-xml-settings">
<span id="csrf-spring-security-setting"></span><h4><a class="toc-backref" href="#id7" role="doc-backlink"><span class="section-number">6.7.2.1.1. </span>spring-security.xml settings</a><a class="headerlink" href="#spring-security-xml-settings" title="Permalink to this heading">¶</a></h4>
<p>The locations where additional settings are required, are highlighted.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">auto-config=</span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="na">use-expressions=</span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="nt">&gt;</span>
<span class="w">     </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="hll"><span class="w">     </span><span class="nt">&lt;sec:csrf</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (1) --&gt;</span>
</span><span class="hll"><span class="w">     </span><span class="nt">&lt;sec:access-denied-handler</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;accessDeniedHandler&quot;</span><span class="nt">/&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (2) --&gt;</span>
</span><span class="w">     </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="w"> </span><span class="nt">&lt;/sec:http&gt;</span>

<span class="hll"><span class="w"> </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;accessDeniedHandler&quot;</span>
</span><span class="hll"><span class="w">     </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.access.DelegatingAccessDeniedHandler&quot;</span><span class="nt">&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (3) --&gt;</span>
</span><span class="hll"><span class="w">     </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">index=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (4) --&gt;</span>
</span><span class="hll"><span class="w">         </span><span class="nt">&lt;map&gt;</span>
</span><span class="hll"><span class="w">             </span><span class="nt">&lt;entry</span>
</span><span class="hll"><span class="w">                 </span><span class="na">key=</span><span class="s">&quot;org.springframework.security.web.csrf.InvalidCsrfTokenException&quot;</span><span class="nt">&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (5) --&gt;</span>
</span><span class="hll"><span class="w">                 </span><span class="nt">&lt;bean</span>
</span><span class="hll"><span class="w">                     </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.access.AccessDeniedHandlerImpl&quot;</span><span class="nt">&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (5) --&gt;</span>
</span><span class="hll"><span class="w">                     </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;errorPage&quot;</span>
</span><span class="hll"><span class="w">                         </span><span class="na">value=</span><span class="s">&quot;/WEB-INF/views/common/error/invalidCsrfTokenError.jsp&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (5) --&gt;</span>
</span><span class="hll"><span class="w">                 </span><span class="nt">&lt;/bean&gt;</span>
</span><span class="hll"><span class="w">             </span><span class="nt">&lt;/entry&gt;</span>
</span><span class="hll"><span class="w">             </span><span class="nt">&lt;entry</span>
</span><span class="hll"><span class="w">                 </span><span class="na">key=</span><span class="s">&quot;org.springframework.security.web.csrf.MissingCsrfTokenException&quot;</span><span class="nt">&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (6) --&gt;</span>
</span><span class="hll"><span class="w">                 </span><span class="nt">&lt;bean</span>
</span><span class="hll"><span class="w">                     </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.access.AccessDeniedHandlerImpl&quot;</span><span class="nt">&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (6) --&gt;</span>
</span><span class="hll"><span class="w">                     </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;errorPage&quot;</span>
</span><span class="hll"><span class="w">                         </span><span class="na">value=</span><span class="s">&quot;/WEB-INF/views/common/error/missingCsrfTokenError.jsp&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (6) --&gt;</span>
</span><span class="hll"><span class="w">                 </span><span class="nt">&lt;/bean&gt;</span>
</span><span class="hll"><span class="w">             </span><span class="nt">&lt;/entry&gt;</span>
</span><span class="hll"><span class="w">         </span><span class="nt">&lt;/map&gt;</span>
</span><span class="hll"><span class="w">     </span><span class="nt">&lt;/constructor-arg&gt;</span>
</span><span class="hll"><span class="w">     </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">index=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (7) --&gt;</span>
</span><span class="hll"><span class="w">         </span><span class="nt">&lt;bean</span>
</span><span class="hll"><span class="w">             </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.access.AccessDeniedHandlerImpl&quot;</span><span class="nt">&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (8) --&gt;</span>
</span><span class="hll"><span class="w">             </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;errorPage&quot;</span>
</span><span class="hll"><span class="w">                 </span><span class="na">value=</span><span class="s">&quot;/WEB-INF/views/common/error/accessDeniedError.jsp&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (8) --&gt;</span>
</span><span class="hll"><span class="w">         </span><span class="nt">&lt;/bean&gt;</span>
</span><span class="hll"><span class="w">     </span><span class="nt">&lt;/constructor-arg&gt;</span>
</span><span class="hll"><span class="w"> </span><span class="nt">&lt;/bean&gt;</span>
</span></pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Spring Security’s CSRF token check functionality can be used by defining <code class="docutils literal notranslate"><span class="pre">&lt;sec:csrf&gt;</span></code> element in <code class="docutils literal notranslate"><span class="pre">&lt;sec:http&gt;</span></code> element.</div>
<div class="line">For HTTP methods that are checked by default, refer to <a class="reference internal" href="#csrf-default-add-token-method"><span class="std std-ref">Here</span></a>.</div>
<div class="line">For details, refer to <a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.7.RELEASE/reference/htmlsingle/#csrf-configure">Spring Security Reference Document</a>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Define Handler that changes the view to be displayed according to each type of exception when the exception inheriting <code class="docutils literal notranslate"><span class="pre">AccessDeniedException</span></code> occurs.</div>
<div class="line">It is possible to display all the exceptions on the same screen by specifying the destination jsp in <code class="docutils literal notranslate"><span class="pre">error-page</span></code> attribute.</div>
<div class="line">Refer to <a class="reference internal" href="#csrf-403-webxml-setting"><span class="std std-ref">Here</span></a> when the exceptions are not handled by Spring Security functionality.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">To change error page, specify <code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.access.DelegatingAccessDeniedHandler</span></code> in class of the Handler provided by Spring Security.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Using the first argument of constructor, set the screen that changes the display with each type of exception other than the default exceptions (exception that inherits <code class="docutils literal notranslate"><span class="pre">AccessDeniedException</span></code>) in Map format.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify the exception that inherits  <code class="docutils literal notranslate"><span class="pre">AccessDeniedException</span></code>, in key.</div>
<div class="line">Specify <code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.access.AccessDeniedHandlerImpl</span></code> provided by Spring Security as the implementation class.</div>
<div class="line">Specify the view to be displayed in value, by specifying errorPage in property name.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Define the change in display if the exception type differs from (5).</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify the default view (exception that inherits <code class="docutils literal notranslate"><span class="pre">AccessDeniedException</span></code> and which is not specified by the first argument of constructor and <code class="docutils literal notranslate"><span class="pre">AccessDeniedException</span></code>) using second argument of constructor.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify <code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.access.AccessDeniedHandlerImpl</span></code> provided by Spring Security, as the implementation class.</div>
<div class="line">Specify the view to be displayed in value, by specifying errorPage in property name.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<table class="docutils align-default" id="id3">
<caption><span class="caption-text">Type of exception occurred due to CSRF countermeasure, with inherited <code class="docutils literal notranslate"><span class="pre">AccessDeniedException</span></code>.</span><a class="headerlink" href="#id3" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 40%" />
<col style="width: 60%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Exception</p></th>
<th class="head"><p>Reason</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">org.springframework.security.web.csrf.</div>
<div class="line">InvalidCsrfTokenException</div>
</div>
</td>
<td><div class="line-block">
<div class="line">It occurs when the CSRF token requested from client does not match with the CSRF token stored at server side.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">org.springframework.security.web.csrf.</div>
<div class="line">MissingCsrfTokenException</div>
</div>
</td>
<td><div class="line-block">
<div class="line">It occurs when the CSRF token does not exist at server side.</div>
<div class="line">As per default setting, since the token is stored in HTTP session, having no CSRF token implies that the HTTP session is discarded (session timed out).</div>
<div class="line"><br /></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">MissingCsrfTokenException</span></code> occurs when storage location of CSRF token is changed to cache server or DB using <code class="docutils literal notranslate"><span class="pre">token-repository-ref</span></code> attribute of <code class="docutils literal notranslate"><span class="pre">&lt;sec:csrf&gt;</span></code> element, and when CSRF token is deleted from the storage location.</div>
<div class="line">It implies that when token is not stored in HTTP session, session timeout cannot be detected using this functionality.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When HTTP session is to be used as storage location of CSRF token,
the session timeout can be detected for the request of CSRF token check.</p>
<p>The operation after detecting session timeout differs depending on the specifications of <code class="docutils literal notranslate"><span class="pre">invalid-session-url</span></code> attribute of <code class="docutils literal notranslate"><span class="pre">&lt;session-management&gt;</span></code> element.</p>
<ul class="simple">
<li><p>When <code class="docutils literal notranslate"><span class="pre">invalid-session-url</span></code> attribute is specified, it is redirected to the path specified in <code class="docutils literal notranslate"><span class="pre">invalid-session-url</span></code> once the session is created.</p></li>
<li><p>When <code class="docutils literal notranslate"><span class="pre">invalid-session-url</span></code> attribute is not specified, it is handled according to the definition of <code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.access.AccessDeniedHandler</span></code> specified in <code class="docutils literal notranslate"><span class="pre">&lt;access-denied-handler&gt;</span></code> element.</p></li>
</ul>
<p>When session timeout needs to be detected for the request which does not fall under CSRF token check,
it is advisable to detect it by specifying <code class="docutils literal notranslate"><span class="pre">invalid-session-url</span></code> attribute of <code class="docutils literal notranslate"><span class="pre">&lt;session-management&gt;</span></code> element.
For details, refer to “<a class="reference internal" href="Authentication.html#authentication-session-timeout"><span class="std std-ref">Detecting session time-out</span></a>”.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note" id="csrf-403-webxml-setting">
<p class="admonition-title">Note</p>
<p><strong>Error handling when &lt;sec:access-denied-handler&gt; settings are omitted</strong></p>
<p>It is possible to transit to any page by performing the following settings in web.xml.</p>
<p><strong>web.xml</strong></p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;error-page&gt;</span>
<span class="w">    </span><span class="nt">&lt;error-code&gt;</span>403<span class="nt">&lt;/error-code&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;location&gt;</span>/WEB-INF/views/common/error/accessDeniedError.jsp<span class="nt">&lt;/location&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/error-page&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Set status code 403 in error-code element.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Set transition path in location element.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="admonition note" id="csrf-change-httpstatus403">
<p class="admonition-title">Note</p>
<p><strong>When status code other than 403 is to be returned</strong></p>
<p>If status code other than 403 is to be returned when the CSRF token in request does not match, it is necessary to create an independent AccessDeniedHandler
that implements  <code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.access.AccessDeniedHandler</span></code> interface.</p>
</div>
</section>
<section id="spring-mvc-xml-settings">
<span id="csrf-spring-mvc-setting"></span><h4><a class="toc-backref" href="#id8" role="doc-backlink"><span class="section-number">6.7.2.1.2. </span>spring-mvc.xml settings</a><a class="headerlink" href="#spring-mvc-xml-settings" title="Permalink to this heading">¶</a></h4>
<p>By using the <code class="docutils literal notranslate"><span class="pre">RequestDataValueProcessor</span></code> implementation class for CSRF token, the token can be automatically inserted as ‘hidden’ field using <code class="docutils literal notranslate"><span class="pre">&lt;form:form&gt;</span></code> tag of Spring tag library.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="w"> </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;requestDataValueProcessor&quot;</span>
</span><span class="hll"><span class="w">     </span><span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.mvc.support.CompositeRequestDataValueProcessor&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1)  --&gt;</span>
</span><span class="w">     </span><span class="nt">&lt;constructor-arg&gt;</span>
<span class="w">         </span><span class="nt">&lt;util:list&gt;</span>
<span class="hll"><span class="w">             </span><span class="nt">&lt;bean</span>
</span><span class="hll"><span class="w">                 </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.servlet.support.csrf.CsrfRequestDataValueProcessor&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2)  --&gt;</span>
</span><span class="w">             </span><span class="nt">&lt;bean</span>
<span class="w">                 </span><span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.token.transaction.TransactionTokenRequestDataValueProcessor&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">         </span><span class="nt">&lt;/util:list&gt;</span>
<span class="w">     </span><span class="nt">&lt;/constructor-arg&gt;</span>
<span class="w"> </span><span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Perform bean definition for <code class="docutils literal notranslate"><span class="pre">org.terasoluna.gfw.web.mvc.support.CompositeRequestDataValueProcessor</span></code> for which multiple</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.terasoluna.gfw.web.mvc.support.RequestDataValueProcessor</span></code>can be defined.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Set the bean definition <code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.servlet.support.csrf.CsrfRequestDataValueProcessor</span></code> as the first argument of constructor.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>CSRF token is created and checked by ``CsrfFilter`` which is enabled by setting <code class="docutils literal notranslate"><span class="pre">&lt;sec:csrf</span> <span class="pre">/&gt;</span></code>. Therefore, the developer need not be particularly aware of the CSRF measures in Controller.</p>
</div>
</section>
</section>
<section id="sending-csrf-token-using-form">
<span id="csrf-form-tag-token-send"></span><h3><a class="toc-backref" href="#id9" role="doc-backlink"><span class="section-number">6.7.2.2. </span>Sending CSRF token using form</a><a class="headerlink" href="#sending-csrf-token-using-form" title="Permalink to this heading">¶</a></h3>
<p>To send CSRF token using form in JSP, any one of the following processes need to be performed.</p>
<ul class="simple">
<li><p>Automatically adding <code class="docutils literal notranslate"><span class="pre">&lt;input</span> <span class="pre">type=&quot;hidden&quot;&gt;</span></code> tag with inserted CSRF token, using <code class="docutils literal notranslate"><span class="pre">&lt;form:form&gt;</span></code> tag.</p></li>
<li><p>Explicitly adding <code class="docutils literal notranslate"><span class="pre">&lt;input</span> <span class="pre">type=&quot;hidden&quot;&gt;</span></code> tag with inserted CSRF token, using <code class="docutils literal notranslate"><span class="pre">&lt;sec:csrfInput/&gt;</span></code> tag.</p></li>
</ul>
<section id="how-to-insert-csrf-token-automatically">
<span id="csrf-formformtag-use"></span><h4><a class="toc-backref" href="#id10" role="doc-backlink"><span class="section-number">6.7.2.2.1. </span>How to insert CSRF token automatically</a><a class="headerlink" href="#how-to-insert-csrf-token-automatically" title="Permalink to this heading">¶</a></h4>
<p>When <code class="docutils literal notranslate"><span class="pre">CsrfRequestDataValueProcessor</span></code> is defined as per <a class="reference internal" href="#csrf-spring-mvc-setting"><span class="std std-ref">spring-mvc.xml settings</span></a>,
<code class="docutils literal notranslate"><span class="pre">&lt;input</span> <span class="pre">type=&quot;hidden&quot;&gt;</span></code> tag with CSRF token is automatically added using <code class="docutils literal notranslate"><span class="pre">&lt;form:form&gt;</span></code> tag.</p>
<p>CSRF token need not be considered in JSP implementation.</p>
<div class="highlight-jsp notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;form:form</span><span class="w"> </span><span class="na">method=</span><span class="s">&quot;POST&quot;</span>
<span class="w">  </span><span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/csrfTokenCheckExample&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;input</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;second&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;second&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/form:form&gt;</span>
</pre></div>
</div>
<p>Following HTML is output.</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;/terasoluna/csrfTokenCheckExample&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;POST&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;second&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;second&quot;</span> <span class="p">/&gt;</span>
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;_csrf&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;dea86ae8-58ea-4310-bde1-59805352dec7&quot;</span> <span class="p">/&gt;</span> <span class="cm">&lt;!-- (1) --&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">In Spring Security default implementation, CSRF token is inserted by adding <code class="docutils literal notranslate"><span class="pre">&lt;input</span> <span class="pre">type=&quot;hidden&quot;&gt;</span></code> tag where <code class="docutils literal notranslate"><span class="pre">_csrf</span></code> is set in <code class="docutils literal notranslate"><span class="pre">name</span></code> attribute.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>CSRF token is created at login.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If <code class="docutils literal notranslate"><span class="pre">CsrfRequestDataValueProcessor</span></code> is used in Spring 4,
CSRF token inserted <code class="docutils literal notranslate"><span class="pre">&lt;input</span> <span class="pre">type=&quot;hidden&quot;&gt;</span></code> tag is output,
only if the value specified in <code class="docutils literal notranslate"><span class="pre">method</span></code> attribute of <code class="docutils literal notranslate"><span class="pre">&lt;form:form&gt;</span></code> tag matches with HTTP methods (HTTP methods other than GET, HEAD, TRACE, OPTIONS in Spring Security default implementation) of CSRF token check.</p>
<p>For example, when GET method is specified in <code class="docutils literal notranslate"><span class="pre">method</span></code> attribute as shown below,
CSRF token inserted <code class="docutils literal notranslate"><span class="pre">&lt;input</span> <span class="pre">type=&quot;hidden&quot;&gt;</span></code> tag is not output.</p>
<blockquote>
<div><div class="highlight-jsp notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;form:form</span><span class="w"> </span><span class="na">method=</span><span class="s">&quot;GET&quot;</span><span class="w"> </span><span class="na">modelAttribute=</span><span class="s">&quot;xxxForm&quot;</span><span class="w"> </span><span class="na">action=</span><span class="s">&quot;...&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="k">&lt;%-</span><span class="o">-</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="o">--</span><span class="k">%&gt;</span>
<span class="nt">&lt;/form:form&gt;</span>
</pre></div>
</div>
</div></blockquote>
<p>This is as per the following description</p>
<blockquote>
<div><p>The unique token can also be included in the URL itself, or a URL parameter. However, such placement runs a greater risk that the URL will be exposed to an attacker, thus compromising the secret token.</p>
</div></blockquote>
<p>in <a class="reference external" href="https://code.google.com/p/owasptop10/">OWASP Top 10</a> and it helps in building a secure Web application.</p>
</div>
</section>
<section id="how-to-explicitly-insert-csrf-token">
<span id="csrf-formtag-use"></span><h4><a class="toc-backref" href="#id11" role="doc-backlink"><span class="section-number">6.7.2.2.2. </span>How to explicitly insert CSRF token</a><a class="headerlink" href="#how-to-explicitly-insert-csrf-token" title="Permalink to this heading">¶</a></h4>
<p>When <code class="docutils literal notranslate"><span class="pre">&lt;form:form&gt;</span></code> tag is not to be used, <code class="docutils literal notranslate"><span class="pre">&lt;sec:csrfInput/&gt;</span></code> tag needs to be added explicitly.</p>
<p>When using <code class="docutils literal notranslate"><span class="pre">&lt;sec:csrfInput/&gt;</span></code> tag, CSRF token inserted <code class="docutils literal notranslate"><span class="pre">&lt;input</span> <span class="pre">type=&quot;hidden&quot;&gt;</span></code> tag is output.</p>
<div class="highlight-jsp notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;form</span><span class="w"> </span><span class="na">method=</span><span class="s">&quot;POST&quot;</span>
<span class="w">  </span><span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/csrfTokenCheckExample&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;input</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;second&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;second&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:csrfInput/&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
<p>Following HTML is output.</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;/terasoluna/csrfTokenCheckExample&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;POST&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;second&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;second&quot;</span> <span class="p">/&gt;</span>
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;_csrf&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;dea86ae8-58ea-4310-bde1-59805352dec7&quot;</span><span class="p">/&gt;</span>  <span class="cm">&lt;!-- (2) --&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify <code class="docutils literal notranslate"><span class="pre">&lt;sec:csrfInput/&gt;</span></code> tag to output CSRF token inserted <code class="docutils literal notranslate"><span class="pre">&lt;input</span> <span class="pre">type=&quot;hidden&quot;&gt;</span></code> tag.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">In spring Security default implementation, CSRF token is inserted by adding <code class="docutils literal notranslate"><span class="pre">&lt;input</span> <span class="pre">type=&quot;hidden&quot;&gt;</span></code> tag where <code class="docutils literal notranslate"><span class="pre">_csrf</span></code> is set in <code class="docutils literal notranslate"><span class="pre">name</span></code> attribute.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note" id="csrf-default-add-token-method">
<p class="admonition-title">Note</p>
<p>When there is no CSRF token in the CSRF token check request (when HTTP default method is other than GET, HEAD, TRACE and OPTIONS) or
when the token value stored on server is different than the token value sent, access denial process is performed using <code class="docutils literal notranslate"><span class="pre">AccessDeniedHandler</span></code> and HttpStatus 403 is returned.
The specified error page is displayed when <a class="reference internal" href="#csrf-spring-security-setting"><span class="std std-ref">spring-security.xml settings</span></a> are described.</p>
</div>
</section>
</section>
<section id="sending-csrf-token-using-ajax">
<span id="csrf-ajax-token-setting"></span><h3><a class="toc-backref" href="#id12" role="doc-backlink"><span class="section-number">6.7.2.3. </span>Sending CSRF token using Ajax</a><a class="headerlink" href="#sending-csrf-token-using-ajax" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">CsrfFilter</span></code> which is enabled by setting <code class="docutils literal notranslate"><span class="pre">&lt;sec:csrf</span> <span class="pre">/&gt;</span></code>, fetches CSRF token not only from request parameter but also from</div>
<div class="line">the HTTP request header.</div>
<div class="line">When Ajax is used, it is recommended to set CSRF token in HTTP header. Even if request is sent in JSON format, it supports CSRF token check.</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When CSRF token is sent from both the HTTP header and request parameter, HTTP header value is given priority.</p>
</div>
<div class="line-block">
<div class="line">It is explained by using an example in <a class="reference internal" href="../ArchitectureInDetail/Ajax.html"><span class="doc">Ajax</span></a>. The locations for which additional setting is required are highlighted.</div>
</div>
<p><strong>jsp implementation</strong></p>
<div class="highlight-jsp notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="w"> </span><span class="nt">&lt;head&gt;</span>
<span class="hll"><span class="w">   </span><span class="nt">&lt;sec:csrfMetaTags</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (1) --&gt;</span>
</span><span class="hll">
</span><span class="w">   </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="w"> </span><span class="nt">&lt;/head&gt;</span>
<span class="w"> </span><span class="cm">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<div class="highlight-jsp notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="nt">&lt;script</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
<span class="w"> </span>var<span class="w"> </span>contextPath<span class="w"> </span>=<span class="w"> </span>&quot;${pageContext.request.contextPath}&quot;;
<span class="hll"><span class="w"> </span>var<span class="w"> </span>token<span class="w"> </span>=<span class="w"> </span>$(&quot;meta[name=&#39;_csrf&#39;]&quot;).attr(&quot;content&quot;);<span class="w">  </span><span class="cm">&lt;!-- (2) --&gt;</span>
</span><span class="hll"><span class="w"> </span>var<span class="w"> </span>header<span class="w"> </span>=<span class="w"> </span>$(&quot;meta[name=&#39;_csrf_header&#39;]&quot;).attr(&quot;content&quot;);<span class="w">  </span><span class="cm">&lt;!-- (3) --&gt;</span>
</span><span class="hll"><span class="w"> </span>$(document).ajaxSend(function(e,<span class="w"> </span>xhr,<span class="w"> </span>options)<span class="w"> </span>{
</span><span class="hll"><span class="w">     </span>xhr.setRequestHeader(header,<span class="w"> </span>token);<span class="w">  </span><span class="cm">&lt;!-- (4) --&gt;</span>
</span><span class="hll"><span class="w"> </span>});
</span>
<span class="w"> </span>$(function()<span class="w"> </span>{
<span class="w">     </span>$(&#39;#calcButton&#39;).on(&#39;click&#39;,<span class="w"> </span>function()<span class="w"> </span>{
<span class="w">         </span>var<span class="w"> </span>$form<span class="w"> </span>=<span class="w"> </span>$(&#39;#calcForm&#39;),
<span class="w">              </span>$result<span class="w"> </span>=<span class="w"> </span>$(&#39;#result&#39;);
<span class="w">         </span>$.ajax({
<span class="w">             </span>url<span class="w"> </span>:<span class="w"> </span>contextPath<span class="w"> </span>+<span class="w"> </span>&#39;/sample/calc&#39;,
<span class="w">             </span>type<span class="w"> </span>:<span class="w"> </span>&#39;POST&#39;,
<span class="w">             </span>data:<span class="w"> </span>$form.serialize(),
<span class="w">         </span>}).done(function(data)<span class="w"> </span>{
<span class="w">             </span>$result.html(&#39;add:<span class="w"> </span>&#39;<span class="w"> </span>+<span class="w"> </span>data.addResult<span class="w"> </span>+<span class="w"> </span>&#39;<span class="nt">&lt;br&gt;</span>&#39;
<span class="w">                          </span>+<span class="w"> </span>&#39;subtract:<span class="w"> </span>&#39;<span class="w"> </span>+<span class="w"> </span>data.subtractResult<span class="w"> </span>+<span class="w"> </span>&#39;<span class="nt">&lt;br&gt;</span>&#39;
<span class="w">                          </span>+<span class="w"> </span>&#39;multiply:<span class="w"> </span>&#39;<span class="w"> </span>+<span class="w"> </span>data.multipyResult<span class="w"> </span>+<span class="w"> </span>&#39;<span class="nt">&lt;br&gt;</span>&#39;
<span class="w">                          </span>+<span class="w"> </span>&#39;divide:<span class="w"> </span>&#39;<span class="w"> </span>+<span class="w"> </span>data.divideResult<span class="w"> </span>+<span class="w"> </span>&#39;<span class="nt">&lt;br&gt;</span>&#39;);<span class="w"> </span>//<span class="w"> </span>(5)
<span class="w">         </span>}).fail(function(data)<span class="w"> </span>{
<span class="w">             </span>//<span class="w"> </span>error<span class="w"> </span>handling
<span class="w">             </span>alert(data.statusText);
<span class="w">         </span>});
<span class="w">     </span>});
<span class="w"> </span>});
<span class="w"> </span><span class="nt">&lt;/script&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">By setting <code class="docutils literal notranslate"><span class="pre">&lt;sec:csrfMetaTags</span> <span class="pre">/&gt;</span></code> tag, the following <code class="docutils literal notranslate"><span class="pre">meta</span></code> tags are output by default.</div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;meta</span> <span class="pre">name=&quot;_csrf_parameter&quot;</span> <span class="pre">content=&quot;_csrf&quot;</span> <span class="pre">/&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;meta</span> <span class="pre">name=&quot;_csrf_header&quot;</span> <span class="pre">content=&quot;X-CSRF-TOKEN&quot;</span> <span class="pre">/&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;meta</span> <span class="pre">name=&quot;_csrf&quot;</span> <span class="pre">content=&quot;dea86ae8-58ea-4310-bde1-59805352dec7&quot;</span> <span class="pre">/&gt;</span></code>(random UUID is set as a value of <code class="docutils literal notranslate"><span class="pre">content</span></code> attribute)</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Fetch CSRF token set in <code class="docutils literal notranslate"><span class="pre">&lt;meta</span> <span class="pre">name=&quot;_csrf</span> <span class="pre">...&gt;</span></code> tag.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Fetch CSRF header name set in <code class="docutils literal notranslate"><span class="pre">&lt;meta</span> <span class="pre">name=&quot;_csrf_header&quot;</span> <span class="pre">...&gt;</span></code> tag.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Set the header name (default:X-CSRF-TOKEN) fetched from <code class="docutils literal notranslate"><span class="pre">&lt;meta&gt;</span></code> tag and CSRF token value, in request header.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">As this code may cause XSS attack, care should be taken while actually writing the JavaScript code.</div>
<div class="line">In this example, there is no issue as all the fields namely <code class="docutils literal notranslate"><span class="pre">data.addResult</span></code>, <code class="docutils literal notranslate"><span class="pre">data.subtractResult</span></code>, <code class="docutils literal notranslate"><span class="pre">data.multipyResult</span></code> and <code class="docutils literal notranslate"><span class="pre">data.divideResult</span></code> are numerical.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>When sending a request in JSON format, it is advisable to set HTTP header in the same way.</p>
<div class="admonition-todo admonition" id="id1">
<p class="admonition-title">Todo</p>
<p>It needs to be modified since <a class="reference internal" href="../ArchitectureInDetail/Ajax.html"><span class="doc">Ajax</span></a> example is missing.</p>
</div>
</section>
<section id="considerations-at-the-time-of-multipart-request-file-upload">
<h3><a class="toc-backref" href="#id13" role="doc-backlink"><span class="section-number">6.7.2.4. </span>Considerations at the time of multipart request (file upload)</a><a class="headerlink" href="#considerations-at-the-time-of-multipart-request-file-upload" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">Generally, when a multipart request such as file upload is sent, the value sent by form cannot be fetched in <code class="docutils literal notranslate"><span class="pre">Filter</span></code>.</div>
<div class="line">Therefore, just by the explanation so far, <code class="docutils literal notranslate"><span class="pre">CsrfFilter</span></code> is unable to fetch CSRF token at the time of multipart request and thus it is considered as an invalid request.</div>
</div>
<p>Hence, countermeasures need to be implemented using any one of the following methods.</p>
<ul class="simple">
<li><p>Using <code class="docutils literal notranslate"><span class="pre">org.springframework.web.multipart.support.MultipartFilter</span></code>.</p></li>
<li><p>Sending CSRF token using query parameter</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Since there are merits and demerits respectively, determine the countermeasure method to be used considering system requirements.</p>
</div>
<p>For file upload details, refer to <a class="reference internal" href="../ArchitectureInDetail/FileUpload.html"><span class="doc">FileUpload</span></a>.</p>
<section id="how-to-use-multipartfilter">
<span id="csrf-use-multipart-filter"></span><h4><a class="toc-backref" href="#id14" role="doc-backlink"><span class="section-number">6.7.2.4.1. </span>How to use MultipartFilter</a><a class="headerlink" href="#how-to-use-multipartfilter" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">In case of multipart request, normally the value sent from form cannot be fetched in <code class="docutils literal notranslate"><span class="pre">Filter</span></code>.</div>
<div class="line">By using <code class="docutils literal notranslate"><span class="pre">org.springframework.web.multipart.support.MultipartFilter</span></code>, the value sent by form</div>
<div class="line">can be fetched in <code class="docutils literal notranslate"><span class="pre">Filter</span></code> even for a multipart request.</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>When <code class="docutils literal notranslate"><span class="pre">MultipartFilter</span></code> is used, the upload process is carried out before performing authentication/authorization using <code class="docutils literal notranslate"><span class="pre">springSecurityFilterChain</span></code>,
thereby allowing unauthenticated/unauthorized user to carry out the uploading (temporary file creation).</p>
</div>
<p>To use <code class="docutils literal notranslate"><span class="pre">MultipartFilter</span></code>, following settings are recommended.</p>
<p><strong>web.xml settings</strong></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;filter&gt;</span>
<span class="w">    </span><span class="nt">&lt;filter-name&gt;</span>MultipartFilter<span class="nt">&lt;/filter-name&gt;</span>
<span class="w">    </span><span class="nt">&lt;filter-class&gt;</span>org.springframework.web.multipart.support.MultipartFilter<span class="nt">&lt;/filter-class&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;/filter&gt;</span>
<span class="nt">&lt;filter&gt;</span>
<span class="w">    </span><span class="nt">&lt;filter-name&gt;</span>springSecurityFilterChain<span class="nt">&lt;/filter-name&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;filter-class&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="nt">&lt;/filter-class&gt;</span>
<span class="nt">&lt;/filter&gt;</span>
<span class="nt">&lt;filter-mapping&gt;</span>
<span class="w">    </span><span class="nt">&lt;filter-name&gt;</span>MultipartFilter<span class="nt">&lt;/filter-name&gt;</span>
<span class="w">    </span><span class="nt">&lt;servlet-name&gt;</span>/*<span class="nt">&lt;/servlet-name&gt;</span>
<span class="nt">&lt;/filter-mapping&gt;</span>
<span class="nt">&lt;filter-mapping&gt;</span>
<span class="w">    </span><span class="nt">&lt;filter-name&gt;</span>springSecurityFilterChain<span class="nt">&lt;/filter-name&gt;</span>
<span class="w">    </span><span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
<span class="nt">&lt;/filter-mapping&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Define <code class="docutils literal notranslate"><span class="pre">org.springframework.web.multipart.support.MultipartFilter</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">MultipartFilter</span></code> should be defined before <code class="docutils literal notranslate"><span class="pre">springSecurityFilterChain</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>JSP implementation</strong></p>
<div class="highlight-jsp notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;form:form</span><span class="w"> </span><span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/fileupload&quot;</span>
<span class="w">    </span><span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="w"> </span><span class="na">modelAttribute=</span><span class="s">&quot;fileUploadForm&quot;</span><span class="w"> </span><span class="na">enctype=</span><span class="s">&quot;multipart/form-data&quot;</span><span class="nt">&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;table&gt;</span>
<span class="w">        </span><span class="nt">&lt;tr&gt;</span>
<span class="w">            </span><span class="nt">&lt;td</span><span class="w"> </span><span class="na">width=</span><span class="s">&quot;65%&quot;</span><span class="nt">&gt;&lt;form:input</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;file&quot;</span><span class="w"> </span><span class="na">path=</span><span class="s">&quot;uploadFile&quot;</span><span class="w"> </span><span class="nt">/&gt;&lt;/td&gt;</span>
<span class="w">        </span><span class="nt">&lt;/tr&gt;</span>
<span class="w">        </span><span class="nt">&lt;tr&gt;</span>
<span class="w">            </span><span class="nt">&lt;td&gt;&lt;input</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;Upload&quot;</span><span class="w"> </span><span class="nt">/&gt;&lt;/td&gt;</span>
<span class="w">        </span><span class="nt">&lt;/tr&gt;</span>
<span class="w">    </span><span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/form:form&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">When <code class="docutils literal notranslate"><span class="pre">CsrfRequestDataValueProcessor</span></code> is defined as per spring-mvc.xml settings,</div>
<div class="line">by using <code class="docutils literal notranslate"><span class="pre">&lt;form:form&gt;</span></code> tag, <code class="docutils literal notranslate"><span class="pre">&lt;input</span> <span class="pre">type=&quot;hidden&quot;&gt;</span></code> tag with CSRF token is added automatically.</div>
<div class="line">Therefore, CSRF token need not be considered in JSP implementation.</div>
<div class="line"><br /></div>
<div class="line"><strong>When using &lt;form&gt; tag</strong></div>
<div class="line">CSRF token should be set by <a class="reference internal" href="#csrf-formtag-use"><span class="std std-ref">How to explicitly insert CSRF token</span></a>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
<section id="how-to-send-csrf-token-using-query-parameter">
<h4><a class="toc-backref" href="#id15" role="doc-backlink"><span class="section-number">6.7.2.4.2. </span>How to send CSRF token using query parameter</a><a class="headerlink" href="#how-to-send-csrf-token-using-query-parameter" title="Permalink to this heading">¶</a></h4>
<p>To avoid uploading (temporary file creation) by unauthorized/unauthenticated user,
CSRF token should be sent using query parameter instead of using <code class="docutils literal notranslate"><span class="pre">MultipartFilter</span></code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>When CSRF token is sent using this method,</p>
<ul class="simple">
<li><p>CSRF token is displayed in browser address bar</p></li>
<li><p>When bookmarked, CSRF token is registered in bookmark</p></li>
<li><p>CSRF token is registered in access log of Web server</p></li>
</ul>
<p>Therefore, risk of misusing CSRF token by attacker is higher as compared to the method using <code class="docutils literal notranslate"><span class="pre">MultipartFilter</span></code>.</p>
<p>As per default implementation of Spring Security, random UUID is generated as CSRF token value,
therefore, session would not be hijacked even though CSRF token is leaked.</p>
</div>
<p>Example of implementation where CSRF token is sent as query parameter is given below.</p>
<p><strong>JSP implementation</strong></p>
<div class="highlight-jsp notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;form:form</span><span class="w"> </span><span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/fileupload?${f:h(_csrf.parameterName)}=${f:h(_csrf.token)}&quot;</span>
<span class="w">    </span><span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="w"> </span><span class="na">modelAttribute=</span><span class="s">&quot;fileUploadForm&quot;</span><span class="w"> </span><span class="na">enctype=</span><span class="s">&quot;multipart/form-data&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;table&gt;</span>
<span class="w">        </span><span class="nt">&lt;tr&gt;</span>
<span class="w">            </span><span class="nt">&lt;td</span><span class="w"> </span><span class="na">width=</span><span class="s">&quot;65%&quot;</span><span class="nt">&gt;&lt;form:input</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;file&quot;</span><span class="w"> </span><span class="na">path=</span><span class="s">&quot;uploadFile&quot;</span><span class="w"> </span><span class="nt">/&gt;&lt;/td&gt;</span>
<span class="w">        </span><span class="nt">&lt;/tr&gt;</span>
<span class="w">        </span><span class="nt">&lt;tr&gt;</span>
<span class="w">            </span><span class="nt">&lt;td&gt;&lt;input</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;Upload&quot;</span><span class="w"> </span><span class="nt">/&gt;&lt;/td&gt;</span>
<span class="w">        </span><span class="nt">&lt;/tr&gt;</span>
<span class="w">    </span><span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/form:form&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Following query needs to be assigned to the action attribute of <code class="docutils literal notranslate"><span class="pre">&lt;form:form&gt;</span></code> tag.</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">?${f:h(_csrf.parameterName)}=${f:h(_csrf.token)}</span></code></div>
<div class="line">Same setting is required even when using <code class="docutils literal notranslate"><span class="pre">&lt;form&gt;</span></code> tag.</div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../Appendix/index.html" title="7. Appendix"
             >next</a> |</li>
        <li class="right" >
          <a href="XSS.html" title="6.6. XSS Countermeasures"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.0.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" ><span class="section-number">6. </span>Security for TERASOLUNA Server Framework for Java (5.x)</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">6.7. </span>CSRF Countermeasures</a></li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013-2015, NTT DATA.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 5.3.0.Theme by <a href="http://github.com/vkvn">vkvn</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>
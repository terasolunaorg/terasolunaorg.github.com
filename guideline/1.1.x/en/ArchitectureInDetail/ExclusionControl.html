<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>5.5. Exclusive Control &mdash; TERASOLUNA Global Framework Development Guideline 1.1.0-SNAPSHOT documentation</title>
    
    <link rel="stylesheet" href="../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.1.0-SNAPSHOT',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="TERASOLUNA Global Framework Development Guideline 1.1.0-SNAPSHOT documentation" href="../index.html" />
    <link rel="up" title="5. Architecture in Detail - TERASOLUNA Global Framework" href="index.html" />
    <link rel="next" title="5.6. Input Validation" href="Validation.html" />
    <link rel="prev" title="5.4. Database access (Mybatis2)" href="DataAccessMybatis2.html" /><script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="Validation.html" title="5.6. Input Validation"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="DataAccessMybatis2.html" title="5.4. Database access (Mybatis2)"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">TERASOLUNA Global Framework Development Guideline 1.1.0-SNAPSHOT documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">5. Architecture in Detail - TERASOLUNA Global Framework</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">5.5. Exclusive Control</a><ul>
<li><a class="reference internal" href="#overview">5.5.1. Overview</a><ul>
<li><a class="reference internal" href="#necessity-of-exclusive-control">5.5.1.1. Necessity of exclusive control</a><ul>
<li><a class="reference internal" href="#problem-1">5.5.1.1.1. Problem 1</a></li>
<li><a class="reference internal" href="#problem-2">5.5.1.1.2. Problem 2</a></li>
<li><a class="reference internal" href="#problem-3">5.5.1.1.3. Problem 3</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exclusive-control-according-to-the-isolation-level-of-transaction">5.5.1.2. Exclusive control according to the isolation level of transaction</a></li>
<li><a class="reference internal" href="#exclusive-control-using-database-locking">5.5.1.3. Exclusive control using database locking</a><ul>
<li><a class="reference internal" href="#exclusive-control-using-row-lock-function-of-the-database">5.5.1.3.1. Exclusive control using row lock function of the database</a></li>
<li><a class="reference internal" href="#exclusive-control-using-optimistic-locking">5.5.1.3.2. Exclusive control using optimistic locking</a></li>
<li><a class="reference internal" href="#exclusive-control-using-pessimistic-locking">5.5.1.3.3. Exclusive control using pessimistic locking</a></li>
</ul>
</li>
<li><a class="reference internal" href="#prevention-of-deadlock">5.5.1.4. Prevention of deadlock</a><ul>
<li><a class="reference internal" href="#deadlock-in-table">5.5.1.4.1. Deadlock in table</a></li>
<li><a class="reference internal" href="#deadlock-between-tables">5.5.1.4.2. Deadlock between tables</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">5.5.2. How to use</a><ul>
<li><a class="reference internal" href="#how-to-implement-while-using-jpa-spring-data-jpa">5.5.2.1. How to implement while using JPA (Spring Data JPA)</a><ul>
<li><a class="reference internal" href="#row-lock-function-of-rdbms">5.5.2.1.1. Row lock function of RDBMS</a></li>
<li><a class="reference internal" href="#optimistic-locking">5.5.2.1.2. Optimistic locking</a></li>
<li><a class="reference internal" href="#pessimistic-locking">5.5.2.1.3. Pessimistic locking</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-method-when-using-mybatis">5.5.2.2. Implementation method when using Mybatis</a><ul>
<li><a class="reference internal" href="#id1">5.5.2.2.1. Row lock function of RDBMS</a></li>
<li><a class="reference internal" href="#id2">5.5.2.2.2. Optimistic locking</a></li>
<li><a class="reference internal" href="#id7">5.5.2.2.3. Pessimistic locking</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-handle-an-exclusive-error">5.5.2.3. How to handle an exclusive error</a><ul>
<li><a class="reference internal" href="#error-handling-in-case-of-optimistic-locking-failure">5.5.2.3.1. Error handling in case of optimistic locking failure</a></li>
<li><a class="reference internal" href="#error-handling-in-case-of-pessimistic-locking-failure">5.5.2.3.2. Error handling in case of pessimistic locking failure</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="DataAccessMybatis2.html"
                        title="previous chapter">5.4. Database access (Mybatis2)</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="Validation.html"
                        title="next chapter">5.6. Input Validation</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/ArchitectureInDetail/ExclusionControl.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="exclusive-control">
<h1>5.5. Exclusive Control<a class="headerlink" href="#exclusive-control" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id8">Overview</a><ul>
<li><a class="reference internal" href="#necessity-of-exclusive-control" id="id9">Necessity of exclusive control</a><ul>
<li><a class="reference internal" href="#problem-1" id="id10">Problem 1</a></li>
<li><a class="reference internal" href="#problem-2" id="id11">Problem 2</a></li>
<li><a class="reference internal" href="#problem-3" id="id12">Problem 3</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exclusive-control-according-to-the-isolation-level-of-transaction" id="id13">Exclusive control according to the isolation level of transaction</a></li>
<li><a class="reference internal" href="#exclusive-control-using-database-locking" id="id14">Exclusive control using database locking</a><ul>
<li><a class="reference internal" href="#exclusive-control-using-row-lock-function-of-the-database" id="id15">Exclusive control using row lock function of the database</a></li>
<li><a class="reference internal" href="#exclusive-control-using-optimistic-locking" id="id16">Exclusive control using optimistic locking</a></li>
<li><a class="reference internal" href="#exclusive-control-using-pessimistic-locking" id="id17">Exclusive control using pessimistic locking</a></li>
</ul>
</li>
<li><a class="reference internal" href="#prevention-of-deadlock" id="id18">Prevention of deadlock</a><ul>
<li><a class="reference internal" href="#deadlock-in-table" id="id19">Deadlock in table</a></li>
<li><a class="reference internal" href="#deadlock-between-tables" id="id20">Deadlock between tables</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use" id="id21">How to use</a><ul>
<li><a class="reference internal" href="#how-to-implement-while-using-jpa-spring-data-jpa" id="id22">How to implement while using JPA (Spring Data JPA)</a><ul>
<li><a class="reference internal" href="#row-lock-function-of-rdbms" id="id23">Row lock function of RDBMS</a></li>
<li><a class="reference internal" href="#optimistic-locking" id="id24">Optimistic locking</a></li>
<li><a class="reference internal" href="#pessimistic-locking" id="id25">Pessimistic locking</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-method-when-using-mybatis" id="id26">Implementation method when using Mybatis</a><ul>
<li><a class="reference internal" href="#id1" id="id27">Row lock function of RDBMS</a></li>
<li><a class="reference internal" href="#id2" id="id28">Optimistic locking</a></li>
<li><a class="reference internal" href="#id7" id="id29">Pessimistic locking</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-handle-an-exclusive-error" id="id30">How to handle an exclusive error</a><ul>
<li><a class="reference internal" href="#error-handling-in-case-of-optimistic-locking-failure" id="id31">Error handling in case of optimistic locking failure</a></li>
<li><a class="reference internal" href="#error-handling-in-case-of-pessimistic-locking-failure" id="id32">Error handling in case of pessimistic locking failure</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id8">5.5.1. Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Exclusive control is a process to maintain data consistency when same data is to be updated simultaneously by multiple transactions.</p>
<p>Exclusive control should be performed when same data is likely to get updated simultaneously by multiple transactions.
These transactions are not necessarily restricted to database transactions only; they also include long transactions.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Long transactions</strong></p>
<p>Long transactions are the transactions where data fetch and data update are performed as separate database transactions.</p>
<p class="last">To illustrate a specific example, the transactions are observed in an application where the fetched data is displayed on the Edit screen and the value edited on the screen is updated in database.</p>
</div>
<div class="line-block">
<div class="line">This chapter explains about exclusive control for the data stored in the database.</div>
<div class="line">However, it should also be performed in a similar way for the data stored in data-store apart from database (such as memory, files etc.).</div>
</div>
<div class="section" id="necessity-of-exclusive-control">
<span id="exclusioncontrol-necessity"></span><h3><a class="toc-backref" href="#id9">5.5.1.1. Necessity of exclusive control</a><a class="headerlink" href="#necessity-of-exclusive-control" title="Permalink to this headline">¶</a></h3>
<p>To understand why exclusive control is necessary, let us first see the issues that occur in the absence of exclusive control using the examples given below.</p>
<div class="section" id="problem-1">
<h4><a class="toc-backref" href="#id10">5.5.1.1.1. Problem 1</a><a class="headerlink" href="#problem-1" title="Permalink to this headline">¶</a></h4>
<p>See the example below of receiving an order for Tea from users on a shopping site.</p>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/ExclusionControl-problem1.png"><img alt="Exclusive Control problem1" src="../_images/ExclusionControl-problem1.png" style="width: 90%;" /></a>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="5%" />
<col width="5%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">UserA</th>
<th class="head">UserB</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>〇</td>
<td>-</td>
<td>User A confirms that the quantity of Tea on Product screen is 5nos.</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>-</td>
<td>〇</td>
<td>User B confirms that the quantity of Tea on Product screen is 5nos.</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>-</td>
<td>〇</td>
<td>User B orders 5nos. of Tea. Stock of Tea in the DB reduces by 5 and becomes 0.</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>〇</td>
<td>-</td>
<td>User A orders 5nos. of Tea. Stock of Tea in the DB reduces by 5 and becomes -5.</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><strong>Order from User A is accepted however an apology is conveyed due to non-availability of actual stock.</strong></div>
<div class="line"><strong>The stock quantity of Tea stored in the table also shows a value (minus value) different from actual stock quantity of Tea.</strong></div>
</div>
</div></blockquote>
</div>
<div class="section" id="problem-2">
<h4><a class="toc-backref" href="#id11">5.5.1.1.2. Problem 2</a><a class="headerlink" href="#problem-2" title="Permalink to this headline">¶</a></h4>
<p>See the example below wherein the staff that manages the stock quantity of Tea on shopping site, displays the stock quantity of Tea, calculates the added stock quantity at Client side and updates the stock quantity of Tea.</p>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/ExclusionControl-problem2.png"><img alt="Exclusive Control problem2" src="../_images/ExclusionControl-problem2.png" style="width: 90%;" /></a>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="5%" />
<col width="5%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">UserA</th>
<th class="head">UserB</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>〇</td>
<td>-</td>
<td>Staff A confirms that the quantity of Tea is 5nos.</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>-</td>
<td>〇</td>
<td>Staff B confirms that the quantity of Tea is 5nos.</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>-</td>
<td>〇</td>
<td>Staff B adds stock of 10nos. of Tea and updates the stock quantity on Client side as 5+10=15.</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>〇</td>
<td>-</td>
<td>Staff A adds stock of 20nos. of Tea and updates the stock quantity on Client side as 5+20=25.</td>
</tr>
</tbody>
</table>
<p><strong>The stock of tea 10nos. added in process 3 is lost and there is a mismatch in actual stock quantity (35nos.).</strong></p>
</div></blockquote>
</div>
<div class="section" id="problem-3">
<h4><a class="toc-backref" href="#id12">5.5.1.1.3. Problem 3</a><a class="headerlink" href="#problem-3" title="Permalink to this headline">¶</a></h4>
<p>See the example below wherein the data locked by batch processing is updated by online processing.</p>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/ExclusionControl-problem4.png"><img alt="Exclusive Control problem4" src="../_images/ExclusionControl-problem4.png" style="width: 90%;" /></a>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="5%" />
<col width="5%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">UserA</th>
<th class="head">Batch</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>-</td>
<td>〇</td>
<td>Batch locks the table row (temporarily all rows) to be updated and does not allow the update by other processes.</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>〇</td>
<td>-</td>
<td>User A searches the updated information. Since batch is not committed at this point, the information prior to batch update can be fetched.</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>〇</td>
<td>-</td>
<td>User A requests for update and waits as it is locked in batch.</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>-</td>
<td>〇</td>
<td>Batch terminates the process to release the lock.</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>〇</td>
<td>-</td>
<td>The update process for which user A was waiting can now be executed.</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><strong>User A executes update process after waiting for the batch to release the lock. However, data fetched by User A prior to waiting is the data before batch update and batch processing may overwrite the data with the updated data.</strong></div>
<div class="line"><strong>Batch takes a longer time as compared to online processing and user has to wait longer.</strong></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="exclusive-control-according-to-the-isolation-level-of-transaction">
<h3><a class="toc-backref" href="#id13">5.5.1.2. Exclusive control according to the isolation level of transaction</a><a class="headerlink" href="#exclusive-control-according-to-the-isolation-level-of-transaction" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">The easiest way to resolve all the 3 problems given in <a class="reference internal" href="#exclusioncontrol-necessity"><em>Necessity of exclusive control</em></a> is to sequentially execute the database processes.</div>
<div class="line">When the processes are sequentially executed, there is no effect on transactions.</div>
<div class="line">However, when the processes are sequentially executed, the number of transactions  that can be executed in a unit of time shows reduction resulting in deterioration in the performance.</div>
</div>
<p>In ANSI/ISO SQL standards, the guidelines indicating the isolation level (extent of impact by each transaction) are defined.
The 4 isolation levels of transaction are given below. Events that occur at each isolation level are explained below.</p>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="22%" />
<col width="22%" />
<col width="22%" />
<col width="22%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">Sr. No.</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">Isolation levels</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line"><br /></div>
<div class="line">DIRTY READ</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line"><br /></div>
<div class="line">NON-REPEATABLE READ</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line"><br /></div>
<div class="line">PHANTOM READ</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">1.</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">READ UNCOMMITTED</div>
</div>
</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">2.</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">READ COMMITTED</div>
</div>
</td>
<td>No</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">3.</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">REPEATABLE READ</div>
</div>
</td>
<td>No</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">4.</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SERIALIZABLE</div>
</div>
</td>
<td>No</td>
<td>No</td>
<td>No</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>DIRTY READ</strong></p>
<p class="last">Dirty Read occurs when the data written by uncommitted transaction is read by other transaction.</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>NON-REPEATABLE READ</strong></p>
<p class="last">When the same record is likely to be read twice in the same transaction, if other transaction is committed during the first read and second read, the details read at first time and those at second time may differ.
The multiple data readings may vary based on commit timing of other transaction.</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>PHANTOM READ</strong></p>
<p class="last">In Phantom Read, when a same record is being read twice in the same transaction, if other transaction adds or deletes the record, it causes difference in the number of records (details) fetched during the first read and second read.</p>
</div>
<div class="line-block">
<div class="line">The isolation level defined in above table gets higher as we go down.</div>
<div class="line">If the isolation level is high, the data can be protected; however it increases the locking overhead resulting in deterioration of the performance.</div>
<div class="line">It is not desirable to select SERIALIZABLE unless the access frequency is fairly low.</div>
<div class="line">This is because all the data is accessed sequentially one by one including SELECT.</div>
</div>
<div class="line-block">
<div class="line">The relationship between level of isolation and degree of concurrency between transactions is a Trade-off relationship.</div>
<div class="line">In other words, high isolation level leads to reduction in concurrency and vice versa.</div>
<div class="line">Thus, it is necessary to balance the level of isolation and degree of concurrency of transactions in accordance with application requirements.</div>
</div>
<div class="line-block">
<div class="line">The supported isolation level differs depending on the database to be used, it is necessary to understand the characteristics of the database to be used.</div>
<div class="line">Isolation levels supported by each database and their default values are shown below.</div>
</div>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="22%" />
<col width="17%" />
<col width="17%" />
<col width="17%" />
<col width="17%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">Sr. No.</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">Database</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">READ UNCOMMITTED</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">READ COMMITTED</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">REPEATABLE READ</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">SERIALIZABLE</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">1.</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Oracle</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">×</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">〇 (default)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">×</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">〇</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">2.</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">PostgreSQL</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">×</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">〇 (default)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">×</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">〇</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">3.</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">DB2</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">〇</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">〇 (default)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">〇</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">〇</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">4.</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">MySQL InnoDB</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">〇</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">〇</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">〇 (default)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">〇</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><strong>When a balance is to be maintained between isolation and concurrency while maintaining data consistency, it is necessary to perform exclusive control using Database Locking which is described below.</strong></p>
</div>
<div class="section" id="exclusive-control-using-database-locking">
<h3><a class="toc-backref" href="#id14">5.5.1.3. Exclusive control using database locking</a><a class="headerlink" href="#exclusive-control-using-database-locking" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">It is necessary to lock the data to be updated using an appropriate method due to the following reasons:</div>
</div>
<ul class="simple">
<li>To maintain consistency of data stored in the database</li>
<li>To prevent conflicts in update process</li>
</ul>
<div class="line-block">
<div class="line">The three types of methods to lock the data stored in the database are as follows:</div>
<div class="line">The Architect should adequately understand the characteristics of such locking and use the appropriate locking method in accordance with the characteristics of application.</div>
</div>
<blockquote>
<div><table border="1" class="docutils">
<caption>Types of locking</caption>
<colgroup>
<col width="10%" />
<col width="15%" />
<col width="40%" />
<col width="35%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Types of locking</th>
<th class="head">Applicable cases</th>
<th class="head">Characteristics</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>Automatic locking by RDBMS</td>
<td><ul class="first last simple">
<li>When the conditions necessary to ensure data consistency can be specified as update conditions for data.</li>
<li>When concurrency for the same data is less and update process also takes less time.</li>
</ul>
</td>
<td><ul class="first last simple">
<li>Effective since check and update process are executed using single SQL.</li>
<li>Conditions for ensuring data consistency need to be analyzed separately as compared to optimistic locking.</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>Optimistic locking</td>
<td><ul class="first last simple">
<li>When the already fetched data is being updated by other transaction and if the updated contents need to be verified.</li>
<li>When concurrency for the same data is less and update process also takes less time.</li>
</ul>
</td>
<td><ul class="first last simple">
<li>Ensures that the fetched data is not updated by other transaction.</li>
<li>Column to manage versions needs to be defined in the table.</li>
</ul>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>Pessimistic locking</td>
<td><ul class="first last simple">
<li>When the data that is likely to remain in locked state for a longer period is updated.</li>
<li>When data consistency check needs to be carried out since optimistic locking cannot be used (column cannot be defined to manage versions).</li>
<li>When concurrency for the same data is more and update process takes longer time.</li>
</ul>
</td>
<td><ul class="first last simple">
<li>Possibility of a process failure due to process results of other transaction is eliminated.</li>
<li>Costly since it is necessary to execute SELECT statement for obtaining pessimistic lock.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Standards for adopting types of locking</strong></p>
<p>The Architect should decide the type of locking to be used based on the functional and performance requirements.</p>
<ul class="last simple">
<li>Optimistic locking is necessary to ensure that the database transactions such as returning and changing the data on screen are cut off and the data remains unchanged in subsequent transaction.</li>
<li>When locking is needed in a single transaction, both pessimistic and optimistic locking can be implemented; however when pessimistic locking is used, lock is implemented at database level thus resulting in the possible increase in database processing cost. It is always preferable to use optimistic locking unless there are any specific issues.</li>
<li>If optimistic locking is used in a process with higher update frequency wherein multiple tables are to be updated in a single transaction, the waiting time for obtaining a lock can be minimized. However the possibility of error occurrences increases since an exclusive error may occur in between the process.
If pessimistic locking is used, the waiting time for obtaining a lock is likely to increase; however since exclusive error does not occur once lock is obtained, it reduces the possibility of error occurrences.</li>
</ul>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>Business transaction</strong></p>
<p>In actual application development, there could also be cases where exclusive control is necessary for the transactions at business flow level.
A typical example of business flow level transactions could be an application used at a travel agency for making reservations while talking to the customer.</p>
<p>While making travel reservations, means of transport such as railway, accommodation facilities and additional scheme, etc. are discussed.
At this point, the reserved accommodation and additional scheme should remain unavailable for other users.
In such a case, the status of table should be updated from &#8216;Temporarily Reserved&#8217; to &#8216;Reserved&#8217;. Even if the reservation is in process, other users should not be able to make the corresponding reservation.</p>
<p class="last">Description of exclusive control for business transaction is skipped in this chapter since it should be analyzed and designed under business process design or functional design.</p>
</div>
<div class="section" id="exclusive-control-using-row-lock-function-of-the-database">
<h4><a class="toc-backref" href="#id15">5.5.1.3.1. Exclusive control using row lock function of the database</a><a class="headerlink" href="#exclusive-control-using-row-lock-function-of-the-database" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">In most databases, when a record is updated (UPDATE, DELETE), a row lock is obtained to prevent updates by other transactions till the primary transaction is committed or rolled back.</div>
<div class="line">Thus, if the number of updated records is as anticipated, the data consistency can be ensured.</div>
</div>
<div class="line-block">
<div class="line">Exclusive control can be performed by using this characteristic and specifying the conditions to ensure data consistency for WHERE clause at the time of update.</div>
<div class="line">The support status of row lock at the time of update for each database is shown below.</div>
</div>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="22%" />
<col width="11%" />
<col width="17%" />
<col width="39%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Database</th>
<th class="head">Version</th>
<th class="head">Default setting lock</th>
<th class="head">Remarks</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>Oracle</td>
<td>11</td>
<td>Row lock</td>
<td>Increased memory usage due to locking.</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>PostgreSQL</td>
<td>9</td>
<td>Row lock</td>
<td>There is no maximum limit on the number of rows that can be locked simultaneously since information for the modified rows is not stored in the memory. However, it is necessary to perform VACUUM periodically to write to the table.</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>DB2</td>
<td>9</td>
<td>Row lock</td>
<td>Increased memory usage due to locking.</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>MySQL InnoDB</td>
<td>5</td>
<td>Row lock</td>
<td>Increased memory usage due to locking.</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line">Exclusive control using row lock function of database can be used when it is not necessary to verify the contents updated by other transaction.</div>
<div class="line">For example, it can be used in the purchase process of a shopping site wherein the purchased product quantity is deducted from the records that manage product stock quantity.</div>
<div class="line">Exclusive control is not recommended in the processes used for status management since the earlier status is important in such processes.</div>
</div>
<p>See the example below illustrating a specific scenario.</p>
<ul class="simple">
<li>On a shopping site, both User A and User B are displayed a purchase screen of the same product at the same time.
A stock quantity fetched from Stock Table is also displayed at the same time.</li>
<li>5 products were purchased at the same time; but since User A clicked &#8220;Purchase&#8221; button a bit earlier, User A buys the product first and then User B.</li>
</ul>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/update-for-db-line-lock.png"><img alt="update for db line lock" src="../_images/update-for-db-line-lock.png" style="width: 90%;" /></a>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="5%" />
<col width="5%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">UserA</th>
<th class="head">UserB</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>〇</td>
<td>-</td>
<td><p class="first">User A displays a purchase screen of the product. A stock quantity of 100nos. is displayed on the screen.</p>
<div class="last highlight-sql"><div class="highlight"><pre><span class="k">select</span> <span class="n">quantity</span> <span class="k">from</span> <span class="n">Stock</span> <span class="k">where</span> <span class="n">ItemId</span> <span class="o">=</span> <span class="s1">&#39;01&#39;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>-</td>
<td>〇</td>
<td><p class="first">User B displays a purchase screen of the product. A stock quantity of 100nos. is displayed on the screen.</p>
<div class="last highlight-sql"><div class="highlight"><pre><span class="k">select</span> <span class="n">quantity</span> <span class="k">from</span> <span class="n">Stock</span> <span class="k">where</span> <span class="n">ItemId</span> <span class="o">=</span> <span class="s1">&#39;01&#39;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>〇</td>
<td>-</td>
<td><p class="first">User A purchases 5 products of ItemId=01. 5nos. are deducted from Stock Table.</p>
<div class="last highlight-sql"><div class="highlight"><pre><span class="k">Update</span> <span class="k">from</span> <span class="n">Stock</span> <span class="k">set</span> <span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span> <span class="o">-</span> <span class="mi">5</span>
                      <span class="k">where</span> <span class="n">ItemId</span><span class="o">=</span><span class="s1">&#39;01&#39;</span> <span class="k">and</span> <span class="n">quantity</span> <span class="o">&gt;=</span> <span class="mi">5</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>-</td>
<td>〇</td>
<td>User B purchases 5 products of ItemId=01. The system tries to deduct 5 products from Stock Table; however since transaction of User A is not yet completed, the purchase process of User B is kept on hold.</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>〇</td>
<td>-</td>
<td>Transaction of user A is committed.</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>-</td>
<td>〇</td>
<td><div class="first line-block">
<div class="line">The transaction of user A is now committed, hence purchase for User B which was kept on hold in step 4 is now resumed.</div>
<div class="line">If a stock screen is viewed at this point, the stock quantity is now 95 instead of 100. However, since the balance stock quantity is more than the purchase quantity (in the above example, 5),  5 is deducted from Stock Table.</div>
</div>
<div class="last highlight-sql"><div class="highlight"><pre><span class="k">Update</span> <span class="k">from</span> <span class="n">Stock</span> <span class="k">set</span> <span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span> <span class="o">-</span> <span class="mi">5</span>
                      <span class="k">where</span> <span class="n">ItemId</span><span class="o">=</span><span class="s1">&#39;01&#39;</span> <span class="k">and</span> <span class="n">quantity</span> <span class="o">&gt;=</span> <span class="mi">5</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td>-</td>
<td>〇</td>
<td>Transaction of user B is committed.</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Important</strong></p>
<p class="last">It is important to specify the deduction ( <tt class="docutils literal"><span class="pre">&quot;quantity</span> <span class="pre">-</span> <span class="pre">5&quot;</span></tt> ) and update condition ( <tt class="docutils literal"><span class="pre">&quot;and</span> <span class="pre">quantity</span> <span class="pre">&gt;=</span> <span class="pre">5&quot;</span></tt> ) in SQL.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">In the similar scenario as above, if the stock quantity when a product purchase screen is displayed is 9, the stock quantity when the User B resumes update process becomes 4. As it does not satisfy <tt class="docutils literal"><span class="pre">quantity</span> <span class="pre">&gt;=</span> <span class="pre">5</span></tt>condition, update count becomes 0.</div>
<div class="line">If the update count in the application is 0, purchase is rolled back and User B is prompted for re-execution.</div>
</div>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/update-for-db-line-lock-not-enough.png"><img alt="update for db line lock not enough" src="../_images/update-for-db-line-lock-not-enough.png" style="width: 90%;" /></a>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Important</strong></p>
<p class="last">It is important to verify the update count in the application and an error should occur if it is different from the expected count and transaction should be rolled back.</p>
</div>
</div></blockquote>
<p><strong>When this method is used for locking, the process can be continued depending on conditions even if there is a change in the referred information and data consistency can be ensured by using database function.</strong></p>
</div>
<div class="section" id="exclusive-control-using-optimistic-locking">
<h4><a class="toc-backref" href="#id16">5.5.1.3.2. Exclusive control using optimistic locking</a><a class="headerlink" href="#exclusive-control-using-optimistic-locking" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Optimistic locking is a method for ensuring data consistency wherein the data is not locked for transaction and is updated only after checking whether it is same as fetched data.</div>
<div class="line">When optimistic locking is to be used, a Version column for managing versions is created to determine if the data to be updated is same as fetched data.</div>
<div class="line">Data consistency can be ensured by keeping both the versions at the time of data fetch and data update same as a condition for update.</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Version column</strong></p>
<p class="last">This column is used in optimistic locking for managing the update count of a record. It is set to 0 when a record is inserted and then it is incremented with each successful update.
The Version column can be also be substituted with the latest update timestamp in place of a number.
However, when timestamp is used, uniqueness when processes are executed simultaneously cannot be ensured.
Hence, in order to ensure uniqueness, it is necessary to use a number in Version column.</p>
</div>
<div class="line-block">
<div class="line">Exclusive control with optimistic locking is used when it is necessary to verify the contents updated by other transaction.</div>
<div class="line">For example, consider a case of workflow application wherein an applicant and an approver perform concurrent operations (withdrawal and approval).</div>
<div class="line">In this case, using exclusive control with optimistic locking, it is possible to notify the applicant and the approver that the operation is yet to be completed since the status before and after the operation are different.</div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">When an optimistic locking is to be performed, it is not appropriate to update/delete the record by adding conditions other than ID and Version.
This is because when the data cannot be updated, it is difficult to determine whether the reason for update failure is version mismatch or condition mismatch.
When the conditions for update are different, it is necessary to check whether previous process meets all the conditions.</p>
</div>
<p>See the example below illustrating a specific scenario.</p>
<ul class="simple">
<li>Staff (Staff A, Staff B) who manage the stock quantity of shopping site add the product stock. Let us assume that Staff A adds 5nos. and Staff B adds 15nos.</li>
<li>A stock management screen is displayed in order to reflect the added stock in the stock management system. The stock quantity being stored in Stock Management System is then displayed.</li>
<li>Against the displayed stock quantity, the value calculated by summing up the quantity added by the staff is entered in the Update form and the total stock is updated.</li>
</ul>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/Optimistic-lock-flow.png"><img alt="Optimistic lock flow" src="../_images/Optimistic-lock-flow.png" style="width: 90%;" /></a>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="5%" />
<col width="5%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">StaffA</th>
<th class="head">StaffB</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>〇</td>
<td>-</td>
<td>Staff A displays stock management screen of the product. The stock quantity of 10nos. is displayed on the screen. Version of the referred data is <tt class="docutils literal"><span class="pre">1</span></tt>.</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>-</td>
<td>〇</td>
<td>Staff B displays stock management screen of the product. The stock quantity of 10nos. is displayed on the screen. Version of the referred data is <tt class="docutils literal"><span class="pre">1</span></tt>.</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>〇</td>
<td>-</td>
<td><p class="first">Staff A adds the stock of 5 nos. against the stock quantity of 10 nos. displayed on the screen and updates stock quantity as 15nos. Version of the referred data is included as an update condition.</p>
<div class="last highlight-sql"><div class="highlight"><pre><span class="k">UPDATE</span> <span class="n">Stock</span> <span class="k">SET</span> <span class="n">quantity</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="k">version</span> <span class="o">=</span> <span class="k">version</span> <span class="o">+</span> <span class="mi">1</span>
             <span class="k">WHERE</span> <span class="n">itemId</span> <span class="o">=</span> <span class="s1">&#39;01&#39;</span> <span class="k">and</span> <span class="k">version</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>-</td>
<td>〇</td>
<td>Although Staff B adds 15nos. to the stock quantity of 10 nos. displayed on the screen and attempts to update the stock quantity to 25 nos.; however the transaction is kept on hold since the transaction of Staff A is not completed yet. Version of the referred data is included as an update condition.</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>〇</td>
<td>-</td>
<td>Transaction of Staff A is committed. <strong>Version becomes 2 at this point.</strong></td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>〇</td>
<td>-</td>
<td><p class="first">Update process of Staff B which was kept on hold in step 4 is now resumed since the transaction of Staff A is committed. At this time, since the version of Stock Table data is <tt class="docutils literal"><span class="pre">2</span></tt>, update result is 0 records. When the update result is 0 records, an exclusive error occurs.</p>
<div class="last highlight-sql"><div class="highlight"><pre><span class="k">UPDATE</span> <span class="n">Stock</span> <span class="k">SET</span> <span class="n">quantity</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span> <span class="k">version</span> <span class="o">=</span> <span class="k">version</span> <span class="o">+</span> <span class="mi">1</span>
             <span class="k">WHERE</span> <span class="n">itemId</span> <span class="o">=</span> <span class="s1">&#39;01&#39;</span> <span class="k">and</span> <span class="k">version</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td>〇</td>
<td>-</td>
<td>The transaction of Staff B is rolled back.</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Points</strong></p>
<p class="last">Version (<tt class="docutils literal"><span class="pre">&quot;version</span> <span class="pre">+</span> <span class="pre">1&quot;</span></tt>) should be incremented and update condition (<tt class="docutils literal"><span class="pre">&quot;and</span> <span class="pre">version</span> <span class="pre">=</span> <span class="pre">1&quot;</span></tt>) should be specified in SQL.</p>
</div>
</div>
<div class="section" id="exclusive-control-using-pessimistic-locking">
<h4><a class="toc-backref" href="#id17">5.5.1.3.3. Exclusive control using pessimistic locking</a><a class="headerlink" href="#exclusive-control-using-pessimistic-locking" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Pessimistic locking is a method to lock the data to be updated at the time of fetching so that it is not updated by other transaction.</div>
<div class="line">When pessimistic locking is to be used, lock is obtained for the record to be updated immediately after starting a transaction.</div>
<div class="line">Since the locked record is not updated by other transaction till the transaction is committed or rolled back, data consistency can be ensured.</div>
</div>
<table border="1" class="docutils">
<caption>RDBMS-wise pessimistic lock acquisition method</caption>
<colgroup>
<col width="18%" />
<col width="27%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Database</th>
<th class="head">Pessimistic locking method</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>Oracle</td>
<td>FOR UPDATE</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>PostgreSQL</td>
<td>FOR UPDATE</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>DB2</td>
<td>FOR UPDATE WITH</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>MySQL</td>
<td>FOR UPDATE</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>About pessimistic locking timeout</strong></p>
<p>At the time of obtaining a pessimistic lock, if a lock is obtained by some other transaction, then the expected behavior is specified as an option in some cases.
In case of Oracle,</p>
<ul class="simple">
<li>Default value is <tt class="docutils literal"><span class="pre">select</span> <span class="pre">for</span> <span class="pre">update</span> <span class="pre">[wait]</span></tt>, and it waits till lock is released.</li>
<li>If set to <tt class="docutils literal"><span class="pre">select</span> <span class="pre">for</span> <span class="pre">update</span> <span class="pre">nowait</span></tt>, it immediately gives a resource busy error, if locked by other transaction.</li>
<li>If set to <tt class="docutils literal"><span class="pre">select</span> <span class="pre">for</span> <span class="pre">update</span> <span class="pre">wait</span> <span class="pre">5</span></tt>, it waits for 5 seconds, and gives a resource busy error, if the lock is not released within 5 seconds.</li>
</ul>
<p class="last">Although there are variations in the functions as per DB, it is necessary to analyze the method to be used when using pessimistic locking.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>When using JPA (Hibernate)</strong></p>
<p class="last">Although the method of fetching a pessimistic lock varies for each database, such differences are absorbed by JPA (Hibernate).
Refer to <a class="reference external" href="http://docs.jboss.org/hibernate/orm/4.2/devguide/en-US/html_single/#d5e233">Hibernate Developer Guide</a> for RDBMS that supports Hibernate.</p>
</div>
<p>Exclusive control with pessimistic locking is used when it is applicable to any of the 3 cases given below.</p>
<ol class="arabic">
<li><div class="first line-block">
<div class="line">Data to be updated is managed by dividing it in multiple tables.</div>
<div class="line">When the data to be updated is divided into multiple tables, it is necessary to ensure that there are no updates by other transaction, till the update of each table is completed.</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Status of the fetched data needs to be checked before performing update.</div>
<div class="line">After completing the checks, it is necessary to ensure that there are no updates by other transaction.</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Online processing may be executed during batch execution.</div>
<div class="line">In batch processing, locks are collectively obtained for the data to be updated so as to ensure that exclusive error does not occur in between the execution.</div>
<div class="line">In case of locks which are obtained collectively, the locking period for online processing may be longer. In such a case, it is advisable to use pessimistic locking by specifying a timeout period.</div>
</div>
</li>
</ol>
<p>See the example below illustrating specific scenario.</p>
<ul class="simple">
<li>Batch processing has already started execution, and data to be updated online is locked by pessimistic locking.</li>
<li>Timeout period of 10 seconds is specified for the online processing and lock is obtained for the data to be updated.</li>
<li>Batch processing is terminated after 5 seconds (before timeout).</li>
</ul>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/Pessimistic-lock.png"><img alt="Pessimistic lock" src="../_images/Pessimistic-lock.png" style="width: 90%;" /></a>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="5%" />
<col width="5%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Online</th>
<th class="head">Batch</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>-</td>
<td>〇</td>
<td>Batch processing obtains the pessimistic lock for the data to be updated in online processing.</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>〇</td>
<td>-</td>
<td><p class="first">Online processing tries to perform pessimistic locking for the data to be updated; however it is kept on hold since the pessimistic locking is performed by the transaction of batch processing.</p>
<div class="last highlight-sql"><div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">Stock</span> <span class="k">WHERE</span> <span class="n">quantity</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="k">FOR</span> <span class="k">UPDATE</span> <span class="n">WAIT</span> <span class="mi">10</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>-</td>
<td>〇</td>
<td>Batch processing updates data.</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>-</td>
<td>〇</td>
<td>Batch processing transaction is committed.</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>〇</td>
<td>-</td>
<td>Since the batch processing transaction is committed, online processing is resumed. As the fetched data reflects the update results of batch processing, data inconsistency does not occur.</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>〇</td>
<td>-</td>
<td>Online processing updates data.</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td>〇</td>
<td>-</td>
<td>Online processing transaction is committed.</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line">The flow at the time of timeout is given below.</div>
<div class="line">Exclusive error occurs without waiting for the batch processing to end.</div>
</div>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/Pessimistic-lock-timeout.png"><img alt="Pessimistic lock" src="../_images/Pessimistic-lock-timeout.png" style="width: 90%;" /></a>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">The flow given below illustrates a case wherein pessimistic lock is being obtained by other transaction in case of &#8220;pessimistic lock no wait&#8221; setting.</div>
<div class="line">An exclusive error occurs immediately without waiting for the release of pessimistic lock.</div>
</div>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/Pessimistic-lock-nowait.png"><img alt="Pessimistic lock" src="../_images/Pessimistic-lock-nowait.png" style="width: 90%;" /></a>
</div>
</div></blockquote>
<p><strong>When there is a possibility of conflict between batch processing and online processing and if batch processing is going to take longer time, it is recommended to specify timeout period of pessimistic exclusive locking.</strong>
<strong>The timeout period should be determined based on the online processing requirements.</strong></p>
</div>
</div>
<div class="section" id="prevention-of-deadlock">
<h3><a class="toc-backref" href="#id18">5.5.1.4. Prevention of deadlock</a><a class="headerlink" href="#prevention-of-deadlock" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">When using database locks, it should be noted that if multiple records are updated in same transaction, 2 deadlocks shown below are likely to occur.</div>
</div>
<ul class="simple">
<li><a class="reference internal" href="#dead-lock-record"><em>Deadlock in table</em></a></li>
<li><a class="reference internal" href="#dead-lock-table"><em>Deadlock between tables</em></a></li>
</ul>
<div class="section" id="deadlock-in-table">
<span id="dead-lock-record"></span><h4><a class="toc-backref" href="#id19">5.5.1.4.1. Deadlock in table</a><a class="headerlink" href="#deadlock-in-table" title="Permalink to this headline">¶</a></h4>
<p>This deadlock occurs when the records of the same table are locked by multiple transactions as shown in the flow of (1)-(5) below.</p>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/Dead-Lock-Record.png"><img alt="Dead Lock Record" src="../_images/Dead-Lock-Record.png" style="width: 90%;" /></a>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="5%" />
<col width="5%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Program A</th>
<th class="head">Program B</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>〇</td>
<td>-</td>
<td>Program A obtains the lock for Record X.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>〇</td>
<td>-</td>
<td>Program B obtains the lock for Record Y.</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>〇</td>
<td>-</td>
<td>Program A tries to obtain the lock for Record Y that is locked by the transaction of Program B, however since lock of (2) is not released, the status is changed to &#8220;Waiting for release&#8221;.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>-</td>
<td>〇</td>
<td>Program B tries to obtain the lock for Record X that is locked by the transaction of Program A, however since lock of (1) is not released, the status is changed to &#8220;Waiting for release&#8221;.</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>-</td>
<td>-</td>
<td>Since Program A and Program B both have the &#8220;Waiting for release&#8221; status for each other, it results into a deadlock. When a deadlock occurs, it is detected by the database and error is thrown.</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>How to resolve a deadlock</strong></p>
<p>The deadlock can be resolved by timeout or retry; however, it is important to determine the rules for the update sequence of records in the same table.
When rows are to be updated one by one, the rules such as updating in ascending order of PK (PRIMARY KEY) should be set.</p>
<p class="last">Let us say if both Program A and Program B follow the rule of starting the update from Record X, the deadlock shown in figure <a class="reference internal" href="#dead-lock-record"><em>Deadlock in table</em></a> above no longer occurs.</p>
</div>
</div></blockquote>
</div>
<div class="section" id="deadlock-between-tables">
<span id="dead-lock-table"></span><h4><a class="toc-backref" href="#id20">5.5.1.4.2. Deadlock between tables</a><a class="headerlink" href="#deadlock-between-tables" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">This deadlock occurs when records of different tables are locked by multiple transactions as shown in the flow of (1)-(5) below.</div>
<div class="line">The basic concept is same as <a class="reference internal" href="#dead-lock-record"><em>Deadlock in table</em></a>.</div>
</div>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/Dead-Lock-Table.png"><img alt="Dead Lock Table" src="../_images/Dead-Lock-Table.png" style="width: 90%;" /></a>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="5%" />
<col width="5%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Program A</th>
<th class="head">Program B</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>〇</td>
<td>-</td>
<td>Program A obtains the lock for Record X of Table A.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>〇</td>
<td>-</td>
<td>Program B obtains the lock for Record Y of Table B.</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>〇</td>
<td>-</td>
<td>Program A tries to obtain the lock for Record Y of Table B that is locked by the transaction of Program B, however since lock of (2) is not released, the status is changed to &#8220;Waiting for release&#8221;.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>-</td>
<td>〇</td>
<td>Program B tries to obtain the lock of Record X of Table A that is locked by the transaction of Program A, however since lock of (1) is not released, the status is changed to &#8220;Waiting for release&#8221;.</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>-</td>
<td>-</td>
<td>Since Program A and Program B both have the &#8220;Waiting for release&#8221; status for each other, it results into a deadlock. When a deadlock occurs, it is detected by the database and error is thrown.</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>How to resolve a deadlock</strong></p>
<blockquote>
<div>Although deadlocks can be resolved by a timeout or retry; it is important to define rules for update sequence across the tables.</div></blockquote>
<p class="last">Let us say if both Program A and Program B follow the rule of starting the update from Table A, the deadlock shown in figure <a class="reference internal" href="#dead-lock-table"><em>Deadlock between tables</em></a> above no longer occurs.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">A deadlock might still occur due to sequence of locking records even after adopting either of the methods as a precaution.
The rules should be defined for the lock sequence of tables and records.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-use">
<h2><a class="toc-backref" href="#id21">5.5.2. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<div class="section" id="how-to-implement-while-using-jpa-spring-data-jpa">
<h3><a class="toc-backref" href="#id22">5.5.2.1. How to implement while using JPA (Spring Data JPA)</a><a class="headerlink" href="#how-to-implement-while-using-jpa-spring-data-jpa" title="Permalink to this headline">¶</a></h3>
<div class="section" id="row-lock-function-of-rdbms">
<h4><a class="toc-backref" href="#id23">5.5.2.1.1. Row lock function of RDBMS</a><a class="headerlink" href="#row-lock-function-of-rdbms" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">When exclusive control is to be performed using a row lock function of RDBMS, Query method is added to Repository interface for implementation.</div>
<div class="line">For Query method, refer to <a class="reference internal" href="DataAccessJpa.html#data-access-jpa-how-to-use-querymethod"><em>Adding query method</em></a> and <a class="reference internal" href="DataAccessJpa.html#data-access-jpa-howtouse-querymethod-modifying"><em>Operating the entities of Persistence Layer directly</em></a>.</div>
</div>
<ul class="simple">
<li>Repository interface</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre>  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">StockRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Stock</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>

     <span class="nd">@Modifying</span>
     <span class="nd">@Query</span><span class="o">(</span><span class="s">&quot;UPDATE Stock s&quot;</span>
<span class="hll">             <span class="o">+</span> <span class="s">&quot; SET s.quantity = s.quantity - :quantity&quot;</span>
</span>             <span class="o">+</span> <span class="s">&quot; WHERE s.itemCode = :itemCode&quot;</span>
<span class="hll">             <span class="o">+</span> <span class="s">&quot; AND :quantity &lt;= s.quantity&quot;</span><span class="o">)</span>  <span class="c1">// (1)</span>
</span>     <span class="kd">public</span> <span class="kt">int</span> <span class="nf">decrementQuantity</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;itemCode&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">itemCode</span><span class="o">,</span>
             <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;quantity&quot;</span><span class="o">)</span> <span class="kt">int</span> <span class="n">quantity</span><span class="o">);</span>

 <span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When the stock quantity is equal to or more than the order quantity, JPQL is specified in Query method to reduce stock quantity.</div>
<div class="line">Since it is necessary to check the update count, <tt class="docutils literal"><span class="pre">int</span></tt> is specified as the return value of Query method.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Service</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="n">String</span> <span class="n">itemCodeOfOrder</span> <span class="o">=</span> <span class="s">&quot;ITM0000001&quot;</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">quantityOfOrder</span> <span class="o">=</span> <span class="mi">31</span><span class="o">;</span>

<span class="kt">int</span> <span class="n">updateCount</span> <span class="o">=</span> <span class="n">stockRepository</span><span class="o">.</span><span class="na">decrementQuantity</span><span class="o">(</span><span class="n">itemCodeOfOrder</span><span class="o">,</span> <span class="n">quantityOfOrder</span><span class="o">);</span> <span class="c1">// (2)</span>
<span class="k">if</span> <span class="o">(</span><span class="n">updateCount</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (3)</span>
    <span class="n">ResultMessages</span> <span class="n">message</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">();</span>
    <span class="n">message</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ResultMessage</span>
            <span class="o">.</span><span class="na">fromText</span><span class="o">(</span><span class="s">&quot;Not enough stock. Please, change quantity.&quot;</span><span class="o">));</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">BusinessException</span><span class="o">(</span><span class="n">message</span><span class="o">);</span> <span class="c1">// (4)</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">update</span> <span class="n">m_stock</span> <span class="k">set</span> <span class="n">quantity</span><span class="o">=</span><span class="n">quantity</span><span class="o">-</span><span class="mi">31</span>
               <span class="k">where</span> <span class="n">item_code</span><span class="o">=</span><span class="s1">&#39;ITM0000001&#39;</span> <span class="k">and</span> <span class="mi">31</span><span class="o">&lt;=</span><span class="n">quantity</span> <span class="c1">-- (5)</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>Query method is called.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>Call results of Query method are determined. Since update conditions are not satisfied in case of <tt class="docutils literal"><span class="pre">0</span></tt>, the stock quantity becomes inadequate.</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">The message notifying &#8220;No stock&#8221; or &#8220;Not enough stock&#8221; is stored and a business error is generated.</div>
<div class="line">The generated error must be handled appropriately in Controller as per the requirements.</div>
<div class="line">In the above example, only business rules are checked along with exclusive control; hence when update conditions are not satisfied, it is treated as business error and not exclusive error.</div>
<div class="line">For error handling methods, refer to <em class="xref std std-ref">exception-handling-how-to-use-codingpoint-contoller-label</em>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>SQL that is executed while calling the Query method.</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="optimistic-locking">
<h4><a class="toc-backref" href="#id24">5.5.2.1.2. Optimistic locking</a><a class="headerlink" href="#optimistic-locking" title="Permalink to this headline">¶</a></h4>
<p>In JPA, optimistic locking can be performed by specifying <tt class="docutils literal"><span class="pre">&#64;javax.persistence.Version</span></tt>annotation in property for version control.</p>
<ul class="simple">
<li>Entity</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre> <span class="nd">@Entity</span>
 <span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;m_stock&quot;</span><span class="o">)</span>
 <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Stock</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

     <span class="nd">@Id</span>
     <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;item_code&quot;</span><span class="o">)</span>
     <span class="kd">private</span> <span class="n">String</span> <span class="n">itemCode</span><span class="o">;</span>

     <span class="kd">private</span> <span class="kt">int</span> <span class="n">quantity</span><span class="o">;</span>

<span class="hll">     <span class="nd">@Version</span> <span class="c1">// (1)</span>
</span>     <span class="kd">private</span> <span class="kt">long</span> <span class="n">version</span><span class="o">;</span>

     <span class="c1">// ...</span>

 <span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><tt class="docutils literal"><span class="pre">&#64;Version</span></tt> annotation is specified in property for version control.</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Service</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="n">String</span> <span class="n">itemCode</span> <span class="o">=</span> <span class="s">&quot;ITM0000001&quot;</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">newQuantity</span> <span class="o">=</span> <span class="mi">30</span><span class="o">;</span>

<span class="n">Stock</span> <span class="n">stock</span> <span class="o">=</span> <span class="n">stockRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">itemCode</span><span class="o">);</span> <span class="c1">// (2)</span>

<span class="n">stock</span><span class="o">.</span><span class="na">setQuantity</span><span class="o">(</span><span class="n">newQuantity</span><span class="o">);</span> <span class="c1">// (3)</span>

<span class="n">stockRepository</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span> <span class="c1">// (4)</span>
</pre></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">update</span> <span class="n">m_stock</span> <span class="k">set</span> <span class="n">quantity</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="k">version</span><span class="o">=</span><span class="mi">7</span>
               <span class="k">where</span> <span class="n">item_code</span><span class="o">=</span><span class="s1">&#39;ITM0000001&#39;</span> <span class="k">and</span> <span class="k">version</span><span class="o">=</span><span class="mi">6</span> <span class="c1">-- ( 5)</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>findOne method of Repository interface is called and entity is fetched.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>Value to be updated is specified for the entity fetched in step (2).</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">The modification details of (3) are reflected in the persistence layer (DB). This process is usually not required since it is performed for the description purpose.</div>
<div class="line">Normally, it is reflected automatically when the transaction is committed.</div>
<div class="line">In the above example, when the version held by the entity fetched in step (2) and the version stored in persistence layer (DB) do not match, optimistic locking error (<tt class="docutils literal"><span class="pre">org.springframework.dao.OptimisticLockingFailureException</span></tt>) occurs.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>SQL that is executed while reflecting to persistence layer (DB) of step (4).</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>It is important to note the following points while performing optimistic locking for long transactions.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">It is not sufficient to simply assign  <tt class="docutils literal"><span class="pre">&#64;Version</span></tt> annotation for optimistic locking which is to be performed for long transactions.
When optimistic locking is to be performed for long transactions, version check should also be carried out while fetching the data to be updated, in addition to the check at the time of update performed using JPA function.</p>
</div>
<p>An implementation example is given below.</p>
<ul class="simple">
<li>Service</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kt">long</span> <span class="n">version</span> <span class="o">=</span> <span class="mi">12</span><span class="o">;</span>
<span class="n">String</span> <span class="n">itemCode</span> <span class="o">=</span> <span class="s">&quot;ITM0000001&quot;</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">newQuantity</span> <span class="o">=</span> <span class="mi">30</span><span class="o">;</span>

<span class="n">Stock</span> <span class="n">stock</span> <span class="o">=</span> <span class="n">stockRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">itemCode</span><span class="o">);</span> <span class="c1">// (1)</span>
<span class="k">if</span> <span class="o">(</span><span class="n">stock</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">stock</span><span class="o">.</span><span class="na">getVersion</span><span class="o">()</span> <span class="o">!=</span> <span class="n">version</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (2)</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">ObjectOptimisticLockingFailureException</span><span class="o">(</span><span class="n">Stock</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">itemCode</span><span class="o">);</span> <span class="c1">// (3)</span>
<span class="o">}</span>

<span class="n">stock</span><span class="o">.</span><span class="na">setQuantity</span><span class="o">(</span><span class="n">newQuantity</span><span class="o">);</span>

<span class="n">stockRepository</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>An entity is fetched from persistence layer (DB).</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Version of the entity fetched by a different database transaction in advance is compared with the latest version of persistence layer (DB) fetched in step (1).</div>
<div class="line">If versions match, optimistic locking which uses <tt class="docutils literal"><span class="pre">&#64;Version</span></tt> annotation becomes valid in subsequent processes.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>If the versions are different, optimistic locking error (<tt class="docutils literal"><span class="pre">org.springframework.dao.ObjectOptimisticLockingFailureException</span></tt>) is generated.</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>Setting a value in property for Version control</strong></p>
<p>Entity fetched using Repository interface is called &#8220;Managed entity&#8221;.</p>
<blockquote>
<div><strong>For &#8220;Managed entity&#8221;, it should be noted that a value cannot be set in a process for the property for Version control.</strong></div></blockquote>
<p>Even if a process as shown below is carried out, the value of version that is set to &#8220;Managed entity&#8221; is not reflected. Hence it is not used to fetch an optimistic lock. The version when a value is fetched using findOne method is used for optimistic locking.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kt">long</span> <span class="n">version</span> <span class="o">=</span> <span class="mi">12</span><span class="o">;</span>
<span class="n">String</span> <span class="n">itemCode</span> <span class="o">=</span> <span class="s">&quot;ITM0000001&quot;</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">newQuantity</span> <span class="o">=</span> <span class="mi">30</span><span class="o">;</span>

<span class="n">Stock</span> <span class="n">stock</span> <span class="o">=</span> <span class="n">stockRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">itemCode</span><span class="o">);</span>
<span class="hll"><span class="n">stock</span><span class="o">.</span><span class="na">setVersion</span><span class="o">(</span><span class="n">version</span><span class="o">);</span> <span class="c1">// ★ Invalid Processing</span>
</span><span class="n">stock</span><span class="o">.</span><span class="na">setQuantity</span><span class="o">(</span><span class="n">newQuantity</span><span class="o">);</span>

<span class="n">stockRepository</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
</pre></div>
</div>
</div></blockquote>
<p class="last">For example, even if the value of the version sent from the screen is overwritten, it is not reflected in entity. Hence the exclusive control can no longer be appropriately performed.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Standardization of optimistic locking for long transactions</strong></p>
<p class="last">When optimistic locking for long transactions becomes necessary in multiple processes, it is desirable to standardize the processes of (1) ~ (3) described above.
For standardization method, refer to <a class="reference internal" href="DataAccessJpa.html#data-access-jpa-how-to-extends-custommethod"><em>How to add custom method</em></a> .</p>
</div>
<p>It is important to note the following points when both row lock function of RDBMS and optimistic locking function are to be used.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>Version must always be updated</strong> in Query method that uses row lock function of RDBMS
in case of applications wherein a process performing exclusive control using a row lock function of RDBMS
and a process performing exclusive control using optimistic locking function co-exist, for the same data.</p>
<p class="last">If version is not updated in Query method that performs exclusive control using row lock function of RDBMS,
the contents updated by Query method may be overwritten by the process of a different transaction. Hence, the exclusive control is not performed properly.</p>
</div>
<p>An implementation example is given below.</p>
<ul class="simple">
<li>Repository interface</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre> <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">StockRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Stock</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>

     <span class="nd">@Modifying</span>
     <span class="nd">@Query</span><span class="o">(</span><span class="s">&quot;UPDATE Stock s SET s.quantity = s.quantity - :quantity&quot;</span>
<span class="hll">             <span class="o">+</span> <span class="s">&quot;, s.version = s.version + 1&quot;</span> <span class="c1">// (1)</span>
</span>             <span class="o">+</span> <span class="s">&quot; WHERE s.itemCode = :itemCode&quot;</span>
             <span class="o">+</span> <span class="s">&quot; AND :quantity &lt;= s.quantity&quot;</span><span class="o">)</span>
     <span class="kd">public</span> <span class="kt">int</span> <span class="nf">decrementQuantity</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;itemCode&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">itemCode</span><span class="o">,</span>
             <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;quantity&quot;</span><span class="o">)</span> <span class="kt">int</span> <span class="n">quantity</span><span class="o">);</span>

 <span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Version needs to be updated (<tt class="docutils literal"><span class="pre">s.version</span> <span class="pre">=</span> <span class="pre">s.version</span> <span class="pre">+</span> <span class="pre">1</span></tt>).</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="pessimistic-locking">
<h4><a class="toc-backref" href="#id25">5.5.2.1.3. Pessimistic locking</a><a class="headerlink" href="#pessimistic-locking" title="Permalink to this headline">¶</a></h4>
<p>In Spring Data JPA, the pessimistic lock can be performed by specifying <tt class="docutils literal"><span class="pre">&#64;org.springframework.data.jpa.repository.Lock</span></tt> annotation.</p>
<ul class="simple">
<li>Repository interface</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">StockRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Stock</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Lock</span><span class="o">(</span><span class="n">LockModeType</span><span class="o">.</span><span class="na">PESSIMISTIC_WRITE</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="nd">@Query</span><span class="o">(</span><span class="s">&quot;SELECT s FROM Stock s WHERE s.itemCode = :itemCode&quot;</span><span class="o">)</span>
    <span class="n">Stock</span> <span class="nf">findOneForUpdate</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;itemCode&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">itemCode</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- (2)</span>
<span class="k">SELECT</span>
        <span class="n">stock0_</span><span class="p">.</span><span class="n">item_code</span> <span class="k">AS</span> <span class="n">item1_5_</span>
        <span class="p">,</span><span class="n">stock0_</span><span class="p">.</span><span class="n">quantity</span> <span class="k">AS</span> <span class="n">quantity2_5_</span>
        <span class="p">,</span><span class="n">stock0_</span><span class="p">.</span><span class="k">version</span> <span class="k">AS</span> <span class="n">version3_5_</span>
    <span class="k">FROM</span>
        <span class="n">m_stock</span> <span class="n">stock0_</span>
    <span class="k">WHERE</span>
        <span class="n">stock0_</span><span class="p">.</span><span class="n">item_code</span> <span class="o">=</span> <span class="s1">&#39;ITM0000001&#39;</span>
    <span class="k">FOR</span> <span class="k">UPDATE</span><span class="p">;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><tt class="docutils literal"><span class="pre">&#64;Lock</span></tt> annotation is specified in Query method.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>Executed SQL. In the above example, the SQL executed while using PostgreSQL is given.</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>The types of pessimistic locking that can be specified using <tt class="docutils literal"><span class="pre">&#64;Lock</span></tt> annotation are as given below.</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="25%" />
<col width="45%" />
<col width="20%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">LockModeType</th>
<th class="head">Description</th>
<th class="head">Issued SQL</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>PESSIMISTIC_READ</td>
<td><div class="first last line-block">
<div class="line">Pessimistic lock for read is obtained. It acts as a shared lock rather than an exclusive lock depending on the database.</div>
<div class="line">Lock is released at the time of commit or rollback</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">select ... for update / select ... for share</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>PESSIMISTIC_WRITE</td>
<td><div class="first last line-block">
<div class="line">Pessimistic lock for update is obtained and an exclusive lock is applied.</div>
<div class="line">In case of exclusive lock, if a lock has already been applied, the entity is fetched after waiting for the lock to be released.</div>
<div class="line">Lock is released at the time of commit or rollback</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">select ... for update</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>PESSIMISTIC_FORCE_INCREMENT</td>
<td><div class="first last line-block">
<div class="line">Exclusive lock is applied to the target data when entity is fetched. Version is forcibly updated immediately after fetching the entity.</div>
<div class="line">Lock is released at the time of commit or rollback</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">select ... for update + update</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Lock timeout period</strong></p>
<p class="last">Timeout period can be specified by specifying <tt class="docutils literal"><span class="pre">&quot;javax.persistence.lock.timeout&quot;</span></tt> as JPA (<tt class="docutils literal"><span class="pre">EntityManager</span></tt>) settings or Query hint.</p>
</div>
</div></blockquote>
<p>There are 2 methods for specifying the locking timeout period: 1. Method wherein it is specified for the entire process 2. Method wherein it is specified for each Query.</p>
<p>Method wherein it is specified for the entire process is as follows:</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">xxx-infra.xml</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;entityManagerFactory&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;packagesToScan&quot;</span> <span class="na">value=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;jpaVendorAdapter&quot;</span> <span class="na">ref=</span><span class="s">&quot;jpaVendorAdapter&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;jpaPropertyMap&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:map&gt;</span>
            <span class="c">&lt;!-- ... --&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;javax.persistence.lock.timeout&quot;</span> <span class="na">value=</span><span class="s">&quot;1000&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;/util:map&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>The timeout is specified in milliseconds. If <tt class="docutils literal"><span class="pre">1000</span></tt> is specified, it equals 1 second.</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>nowait support</strong></p>
<p class="last">When <tt class="docutils literal"><span class="pre">0</span></tt> is specified for Oracle and PostgreSQL, <tt class="docutils literal"><span class="pre">nowait</span></tt>is added, and when locked by another transaction, an exclusive error occurs without waiting for release of lock.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>Restrictions of PostgreSQL</strong></p>
<p class="last">Although nowait can be specified in PostgreSQL, it is not possible to specify waiting time.
Therefore, the measures such as separately providing timeout for Query etc. should be implemented.</p>
</div>
</div></blockquote>
<p>Method wherein it is specified for each Query is as follows:</p>
<ul class="simple">
<li>Repository interface</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="nd">@Lock</span><span class="o">(</span><span class="n">LockModeType</span><span class="o">.</span><span class="na">PESSIMISTIC_WRITE</span><span class="o">)</span>
<span class="nd">@QueryHints</span><span class="o">(</span><span class="nd">@QueryHint</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;javax.persistence.lock.timeout&quot;</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;2000&quot;</span><span class="o">))</span> <span class="c1">// (1)</span>
<span class="nd">@Query</span><span class="o">(</span><span class="s">&quot;SELECT s FROM Stock s WHERE s.itemCode = :itemCode&quot;</span><span class="o">)</span>
<span class="n">Stock</span> <span class="nf">findOneForUpdate</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;itemCode&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">itemCode</span><span class="o">);</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">The timeout is specified in milliseconds. If <tt class="docutils literal"><span class="pre">2000</span></tt> is specified, it equals 2 seconds.</div>
<div class="line">All the specified values are overwritten.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div>
<div class="section" id="implementation-method-when-using-mybatis">
<h3><a class="toc-backref" href="#id26">5.5.2.2. Implementation method when using Mybatis</a><a class="headerlink" href="#implementation-method-when-using-mybatis" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id1">
<h4><a class="toc-backref" href="#id27">5.5.2.2.1. Row lock function of RDBMS</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>When exclusive control is performed using the row lock function of RDBMS, it is implemented by adding SQL definition to sqlmap file.</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">xxx-sqlmap.xml</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre> <span class="nt">&lt;update</span> <span class="na">id=</span><span class="s">&quot;decrementQuantity&quot;</span> <span class="na">parameterClass=</span><span class="s">&quot;OrderItem&quot;</span><span class="nt">&gt;</span>

     UPDATE m_stock SET
<span class="hll">         quantity = quantity - #quantity#
</span>     WHERE item_code = #itemCode#
<span class="hll">     AND #quantity# <span class="cp">&lt;![CDATA[ &lt;= ]]&gt;</span> quantity <span class="c">&lt;!-- (1) --&gt;</span>
</span>
 <span class="nt">&lt;/update&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>When the stock quantity is equal to or more than the order quantity, an SQL to reduce the stock quantity is specified in sqlmap file.</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Repository(RepositoryImpl)</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre> <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">StockRepository</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="nf">decrementQuantity</span><span class="o">(</span><span class="n">String</span> <span class="n">itemCode</span><span class="o">,</span> <span class="kt">int</span> <span class="n">quantity</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StockRepositoryImpl</span> <span class="kd">implements</span> <span class="n">StockRepository</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">decrementQuantity</span><span class="o">(</span><span class="n">String</span> <span class="n">itemCode</span><span class="o">,</span> <span class="kt">int</span> <span class="n">quantity</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (2)</span>
        <span class="n">OrderItem</span> <span class="n">orderItem</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OrderItem</span><span class="o">();</span>
        <span class="n">orderItem</span><span class="o">.</span><span class="na">setItemCode</span><span class="o">(</span><span class="n">itemCode</span><span class="o">);</span>
        <span class="n">orderItem</span><span class="o">.</span><span class="na">setQuantity</span><span class="o">(</span><span class="n">quantity</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">updateDAO</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">&quot;stock.decrementQuantity&quot;</span><span class="o">,</span> <span class="n">orderItem</span><span class="o">);</span> <span class="c1">// (3)</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>Method is added to Repository.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>Parameters necessary for SQL execution are generated and SQL is called.</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>When Repository is not created</strong></p>
<p class="last">When Repository is not created, the process described above is implemented in Service.</p>
</div>
</div></blockquote>
<ul class="simple">
<li>Service</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="n">String</span> <span class="n">itemCodeOfOrder</span> <span class="o">=</span> <span class="s">&quot;ITM0000001&quot;</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">quantityOfOrder</span> <span class="o">=</span> <span class="mi">31</span><span class="o">;</span>

<span class="kt">int</span> <span class="n">updateCount</span> <span class="o">=</span> <span class="n">stockRepository</span><span class="o">.</span><span class="na">decrementQuantity</span><span class="o">(</span><span class="n">itemCodeOfOrder</span><span class="o">,</span> <span class="n">quantityOfOrder</span><span class="o">);</span> <span class="c1">// (4)</span>
<span class="k">if</span> <span class="o">(</span><span class="n">updateCount</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (5)</span>
    <span class="n">ResultMessages</span> <span class="n">message</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">();</span>
    <span class="n">message</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ResultMessage</span>
            <span class="o">.</span><span class="na">fromText</span><span class="o">(</span><span class="s">&quot;Not enough stock. Please, change quantity.&quot;</span><span class="o">));</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">BusinessException</span><span class="o">(</span><span class="n">message</span><span class="o">);</span> <span class="c1">// (6)</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>Query method is called.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>Call results of Query method are determined. Since update conditions are not satisfied in case of <tt class="docutils literal"><span class="pre">0</span></tt>, the stock quantity becomes inadequate.</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">The message notifying &#8220;No stock&#8221; or &#8220;Not enough stock&#8221; is stored and a business error is generated.</div>
<div class="line">The generated error must be handled appropriately in Controller as per the requirements.</div>
<div class="line">In the above example, only business rules are checked along with exclusive control; hence when update conditions are not satisfied, it is treated as business error and not exclusive error.</div>
<div class="line">For error handling methods, refer to <em class="xref std std-ref">exception-handling-how-to-use-codingpoint-contoller-label</em>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id2">
<h4><a class="toc-backref" href="#id28">5.5.2.2.2. Optimistic locking</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Mybatis does not provide a library with a mechanism to perform optimistic locking.</div>
<div class="line">Therefore, &#8216;version&#8217; needs to be specified in SQL to perform optimistic locking.</div>
</div>
<ul class="simple">
<li>Entity</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Stock</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

     <span class="kd">private</span> <span class="n">String</span> <span class="n">itemCode</span><span class="o">;</span>
     <span class="kd">private</span> <span class="kt">int</span> <span class="n">quantity</span><span class="o">;</span>
     <span class="kd">private</span> <span class="kt">long</span> <span class="n">version</span><span class="o">;</span> <span class="c1">// (1)</span>

     <span class="c1">// ...</span>

 <span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>A property for version control is created.</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">xxx-sqlmap.xml</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;stockResultMap&quot;</span> <span class="na">class=</span><span class="s">&quot;Stock&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;itemCode&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;quantity&quot;</span> <span class="na">column=</span><span class="s">&quot;quantity&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;version&quot;</span> <span class="na">column=</span><span class="s">&quot;version&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>

<span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterClass=</span><span class="s">&quot;java.lang.String&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;stockResultMap&quot;</span><span class="nt">&gt;</span>
    SELECT * FROM m_stock WHERE item_code = #itemCode#
<span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;update</span> <span class="na">id=</span><span class="s">&quot;update&quot;</span> <span class="na">parameterClass=</span><span class="s">&quot;Stock&quot;</span><span class="nt">&gt;</span>
    UPDATE m_stock SET
        quantity = quantity
        ,version = version + 1   <span class="c">&lt;!-- (3) --&gt;</span>
    WHERE item_code = #itemCode#
    AND version = #version#      <span class="c">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;/update&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Value set in column for version control is fetched using SQL that retrieves the data to be updated.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Version is incremented at the time of update.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">&#8220;Version should match&#8221; is added as an update condition.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Repository(RepositoryImpl)</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre> <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">StockRepository</span> <span class="o">{</span>
    <span class="n">Stock</span> <span class="nf">findOne</span><span class="o">(</span><span class="n">String</span> <span class="n">itemCode</span><span class="o">);</span>
    <span class="n">Stock</span> <span class="nf">save</span><span class="o">(</span><span class="n">Stock</span> <span class="n">stock</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StockRepositoryImpl</span> <span class="kd">implements</span> <span class="n">StockRepository</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="n">Stock</span> <span class="nf">findOne</span><span class="o">(</span><span class="n">String</span> <span class="n">itemCode</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">queryDAO</span><span class="o">.</span><span class="na">executeForObject</span><span class="o">(</span><span class="s">&quot;stock.findOne&quot;</span><span class="o">,</span> <span class="n">itemCode</span><span class="o">,</span> <span class="n">Stock</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Stock</span> <span class="nf">save</span><span class="o">(</span><span class="n">Stock</span> <span class="n">stock</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">exists</span><span class="o">(</span><span class="n">stock</span><span class="o">.</span><span class="na">getItemCode</span><span class="o">())){</span>
            <span class="kt">int</span> <span class="n">updateCount</span> <span class="o">=</span> <span class="n">updateDAO</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">&quot;stock.update&quot;</span><span class="o">,</span> <span class="n">stock</span><span class="o">);</span>
            <span class="k">if</span><span class="o">(</span><span class="n">updateCount</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ObjectOptimisticLockingFailureException</span><span class="o">(</span><span class="n">Stock</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">itemCode</span><span class="o">);</span> <span class="c1">// (5)</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">updateDAO</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">&quot;stock.insert&quot;</span><span class="o">,</span> <span class="n">stock</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">stock</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>When update result is <tt class="docutils literal"><span class="pre">0</span></tt>, since it will be treated as update by other transaction; optimistic locking error (<tt class="docutils literal"><span class="pre">org.springframework.orm.ObjectOptimisticLockingFailureException</span></tt>) is generated.</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>When Repository is not created</strong></p>
<p class="last">When Repository is not created, the process described above should be implemented in Service.</p>
</div>
</div></blockquote>
<ul class="simple">
<li>Service</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="n">String</span> <span class="n">itemCode</span> <span class="o">=</span> <span class="s">&quot;ITM0000001&quot;</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">newQuantity</span> <span class="o">=</span> <span class="mi">30</span><span class="o">;</span>

<span class="n">Stock</span> <span class="n">stock</span> <span class="o">=</span> <span class="n">stockRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">itemCode</span><span class="o">);</span> <span class="c1">// (2)</span>

<span class="n">stock</span><span class="o">.</span><span class="na">setQuantity</span><span class="o">(</span><span class="n">newQuantity</span><span class="o">);</span> <span class="c1">// (3)</span>

<span class="n">stock</span> <span class="o">=</span> <span class="n">stockRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">stock</span><span class="o">);</span> <span class="c1">// (4)</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>findOne method of Repository interface is called and entity is fetched.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>Value to be updated is specified for the entity fetched in step (2).</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">The modification details of (3) are reflected in persistence layer (DB).</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>It is important to note the following points while performing optimistic locking for long transactions.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">When performing optimistic locking for long transactions, version check in addition to the check at the time of update, should also be carried out while fetching the data.</p>
</div>
<p>An implementation example is given below.</p>
<ul class="simple">
<li>Service</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kt">long</span> <span class="n">version</span> <span class="o">=</span> <span class="mi">12</span><span class="o">;</span>
<span class="n">String</span> <span class="n">itemCode</span> <span class="o">=</span> <span class="s">&quot;ITM0000001&quot;</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">newQuantity</span> <span class="o">=</span> <span class="mi">30</span><span class="o">;</span>

<span class="n">Stock</span> <span class="n">stock</span> <span class="o">=</span> <span class="n">stockRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">itemCode</span><span class="o">);</span> <span class="c1">// (1)</span>
<span class="k">if</span> <span class="o">(</span><span class="n">stock</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">stock</span><span class="o">.</span><span class="na">getVersion</span><span class="o">()</span> <span class="o">!=</span> <span class="n">version</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (2)</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">ObjectOptimisticLockingFailureException</span><span class="o">(</span><span class="n">Stock</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">itemCode</span><span class="o">);</span> <span class="c1">// (3)</span>
<span class="o">}</span>

<span class="n">stock</span><span class="o">.</span><span class="na">setQuantity</span><span class="o">(</span><span class="n">newQuantity</span><span class="o">);</span>

<span class="n">stock</span> <span class="o">=</span> <span class="n">stockRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">stock</span><span class="o">);</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">An entity is fetched from persistence layer (DB).</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Version of the entity fetched by a different database transaction in advance is compared with the latest version of persistence layer (DB) fetched in step (1).</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">If the versions are different, optimistic locking error (<tt class="docutils literal"><span class="pre">org.springframework.dao.ObjectOptimisticLockingFailureException</span></tt>) is generated.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>It is important to note the following points when using both row lock function of RDBMS and optimistic locking function.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><a href="#id3"><span class="problematic" id="id4">**</span></a>Version must always be updated <a href="#id5"><span class="problematic" id="id6">**</span></a>in SQL that uses the row lock function of RDBMS in case of applications
wherein a process performing exclusive control by using a row lock function of RDBMS and a process performing exclusive control by using an optimistic lock function co-exist, for the same data.</p>
<p class="last">If Version is not updated in row SQL that performs exclusive control using row lock function of RDBMS,
the contents updated by Query method may be overwritten by the process of a different transaction. Hence, the exclusive control is not performed properly.</p>
</div>
<p>An implementation example is given below.</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">xxx-sqlmap.xml</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre> <span class="nt">&lt;update</span> <span class="na">id=</span><span class="s">&quot;decrementQuantity&quot;</span> <span class="na">parameterClass=</span><span class="s">&quot;OrderItem&quot;</span><span class="nt">&gt;</span>

     UPDATE m_stock SET
         quantity = quantity - #quantity#
<span class="hll">         ,version = version + 1 <span class="c">&lt;!-- (1) --&gt;</span>
</span>     WHERE item_code = #itemCode#
     AND #quantity# <span class="cp">&lt;![CDATA[ &lt;= ]]&gt;</span> quantity

 <span class="nt">&lt;/update&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Version needs to be updated (<tt class="docutils literal"><span class="pre">version</span> <span class="pre">=</span> <span class="pre">version</span> <span class="pre">+</span> <span class="pre">1</span></tt>).</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id7">
<h4><a class="toc-backref" href="#id29">5.5.2.2.3. Pessimistic locking</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Mybatis does not provide a library with a mechanism to perform pessimistic locking.</div>
<div class="line">Therefore, a keyword for obtaining lock needs to be specified in SQL to perform pessimistic locking.</div>
</div>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">xxx-sqlmap.xml</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOneForUpdate&quot;</span> <span class="na">parameterClass=</span><span class="s">&quot;java.lang.String&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;stockResultMap&quot;</span><span class="nt">&gt;</span>
    SELECT * FROM m_stock
    WHERE item_code = #itemCode#
    FOR UPDATE <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A keyword for obtaining pessimistic lock is specified  for the SQL  which requires pessimistic locking.</div>
<div class="line">Keyword varies with the database.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div>
<div class="section" id="how-to-handle-an-exclusive-error">
<h3><a class="toc-backref" href="#id30">5.5.2.3. How to handle an exclusive error</a><a class="headerlink" href="#how-to-handle-an-exclusive-error" title="Permalink to this headline">¶</a></h3>
<div class="section" id="error-handling-in-case-of-optimistic-locking-failure">
<h4><a class="toc-backref" href="#id31">5.5.2.3.1. Error handling in case of optimistic locking failure</a><a class="headerlink" href="#error-handling-in-case-of-optimistic-locking-failure" title="Permalink to this headline">¶</a></h4>
<p>When optimistic locking fails, <tt class="docutils literal"><span class="pre">org.springframework.dao.OptimisticLockingFailureException</span></tt>occurs;
hence it is necessary to handle it appropriately in Controller.</p>
<div class="line-block">
<div class="line">The handling method varies with the operation specifications of application when optimistic locking error occurs.</div>
</div>
<p>When there is no need to change the operation at request level, it is handled by using <tt class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></tt> annotation.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="n">OptimisticLockingFailureException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">handleOptimisticLockingFailureException</span><span class="o">(</span>
        <span class="n">OptimisticLockingFailureException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// (2)</span>
    <span class="n">ExtendedModelMap</span> <span class="n">modelMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ExtendedModelMap</span><span class="o">();</span>
    <span class="n">ResultMessages</span> <span class="n">resultMessages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="o">.</span><span class="na">warn</span><span class="o">();</span>
    <span class="n">resultMessages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ResultMessage</span><span class="o">.</span><span class="na">fromText</span><span class="o">(</span><span class="s">&quot;Other user updated!!&quot;</span><span class="o">));</span>
    <span class="n">modelMap</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">setUpForm</span><span class="o">());</span>
    <span class="n">String</span> <span class="n">viewName</span> <span class="o">=</span> <span class="n">top</span><span class="o">(</span><span class="n">modelMap</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ModelAndView</span><span class="o">(</span><span class="n">viewName</span><span class="o">,</span> <span class="n">modelMap</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><tt class="docutils literal"><span class="pre">OptimisticLockingFailureException.class</span></tt> is specified in the value attribute of <tt class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></tt> annotation.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Error handling is performed. The message to notify error and information required for screen display (form or other model) are generated and <tt class="docutils literal"><span class="pre">ModelAndView</span></tt> that specifies a destination is returned.</div>
<div class="line">For details of error handling, refer to <em class="xref std std-ref">exception-handling-how-to-use-codingpoint-contoller-usecase-label</em>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>If there is a need to change the operation at request level, it is handled by using <tt class="docutils literal"><span class="pre">try</span> <span class="pre">-</span> <span class="pre">catch</span></tt> in the processing method of Controller.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;{itemId}/update&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">update</span><span class="o">(</span><span class="n">StockForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">,</span> <span class="n">RedirectAttributes</span> <span class="n">attributes</span><span class="o">){</span>

    <span class="c1">// ...</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="n">stockService</span><span class="o">.</span><span class="na">update</span><span class="o">(...);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">OptimisticLockingFailureException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (1)</span>
        <span class="c1">// (2)</span>
        <span class="n">ResultMessages</span> <span class="n">resultMessages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="o">.</span><span class="na">warn</span><span class="o">();</span>
        <span class="n">resultMessages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ResultMessage</span><span class="o">.</span><span class="na">fromText</span><span class="o">(</span><span class="s">&quot;Other user updated!!&quot;</span><span class="o">));</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">resultMessages</span><span class="o">);</span>
        <span class="k">return</span> <span class="nf">updateRedo</span><span class="o">(</span><span class="n">modelMap</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><tt class="docutils literal"><span class="pre">OptimisticLockingFailureException</span></tt> is caught.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Error handling is performed. The message to notify error and information required for screen display (form or other model) are generated and a destination view name is returned.</div>
<div class="line">For details of error handling, refer to <em class="xref std std-ref">exception-handling-how-to-use-codingpoint-contoller-usecase-label</em>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="error-handling-in-case-of-pessimistic-locking-failure">
<h4><a class="toc-backref" href="#id32">5.5.2.3.2. Error handling in case of pessimistic locking failure</a><a class="headerlink" href="#error-handling-in-case-of-pessimistic-locking-failure" title="Permalink to this headline">¶</a></h4>
<p>When pessimistic locking fails, <tt class="docutils literal"><span class="pre">org.springframework.dao.PessimisticLockingFailureException</span></tt> occurs; hence it is necessary to handle it appropriately in Controller.</p>
<p>The handling method varies with the operation specifications of the application when pessimistic locking error occurs.</p>
<p>If there is no need to change the operation at request level, it is handled using <tt class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></tt> annotation.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="n">PessimisticLockingFailureException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">handlePessimisticLockingFailureException</span><span class="o">(</span>
        <span class="n">PessimisticLockingFailureException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// (2)</span>
    <span class="n">ExtendedModelMap</span> <span class="n">modelMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ExtendedModelMap</span><span class="o">();</span>
    <span class="n">ResultMessages</span> <span class="n">resultMessages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="o">.</span><span class="na">warn</span><span class="o">();</span>
    <span class="n">resultMessages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ResultMessage</span><span class="o">.</span><span class="na">fromText</span><span class="o">(</span><span class="s">&quot;Other user updated!!&quot;</span><span class="o">));</span>
    <span class="n">modelMap</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">setUpForm</span><span class="o">());</span>
    <span class="n">String</span> <span class="n">viewName</span> <span class="o">=</span> <span class="n">top</span><span class="o">(</span><span class="n">modelMap</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ModelAndView</span><span class="o">(</span><span class="n">viewName</span><span class="o">,</span> <span class="n">modelMap</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">SR. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><tt class="docutils literal"><span class="pre">PessimisticLockingFailureException</span> <span class="pre">.class</span></tt> is specified in value attribute of <tt class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></tt> annotation.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Error handling is performed. The message to notify error and information required for screen display (form or other model) are generated and <tt class="docutils literal"><span class="pre">ModelAndView</span></tt> that specifies a destination is returned.</div>
<div class="line">For details of error handling, refer to <em class="xref std std-ref">exception-handling-how-to-use-codingpoint-contoller-usecase-label</em>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>If there is need to change the operation at request level, it is handled using <tt class="docutils literal"><span class="pre">try</span> <span class="pre">-</span> <span class="pre">catch</span></tt> in the processing method of Controller.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;{itemId}/update&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">update</span><span class="o">(</span><span class="n">StockForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">,</span> <span class="n">RedirectAttributes</span> <span class="n">attributes</span><span class="o">){</span>

    <span class="c1">// ...</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="n">stockService</span><span class="o">.</span><span class="na">update</span><span class="o">(...);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">PessimisticLockingFailureException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (1)</span>
        <span class="c1">// (2)</span>
        <span class="n">ResultMessages</span> <span class="n">resultMessages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="o">.</span><span class="na">warn</span><span class="o">();</span>
        <span class="n">resultMessages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ResultMessage</span><span class="o">.</span><span class="na">fromText</span><span class="o">(</span><span class="s">&quot;Other user updated!!&quot;</span><span class="o">));</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">resultMessages</span><span class="o">);</span>
        <span class="k">return</span> <span class="nf">updateRedo</span><span class="o">(</span><span class="n">modelMap</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><tt class="docutils literal"><span class="pre">PessimisticLockingFailureException</span></tt> is caught.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Error handling is performed. The message to notify error and information required for screen display (form or other model) are generated and destination view name is returned.</div>
<div class="line">For details of error handling, refer to <em class="xref std std-ref">exception-handling-how-to-use-codingpoint-contoller-usecase-label</em>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p><strong>It has been found that an unexpected error occurs if JPA (Hibernate) is used.</strong></p>
<ul class="simple">
<li>When pessimistic locking fails, child class of <tt class="docutils literal"><span class="pre">org.springframework.dao.UncategorizedDataAccessException</span></tt> is generated instead of <tt class="docutils literal"><span class="pre">PessimisticLockingFailureException</span></tt>.</li>
</ul>
<p><tt class="docutils literal"><span class="pre">UncategorizedDataAccessException</span></tt> generated at the time of pessimistic error, is classified as system error,
hence handling it in the application is not recommended. However, there might be cases wherein this exception may need to be handled.
This exception can be handled since an exception notifying the occurrence of pessimistic locking error is saved as cause of exception.</p>
<p>⇒ Further analysis</p>
<p><strong>The current behavior is as follows:</strong></p>
<ul class="last simple">
<li>PostgreSQL + for update nowait<ul>
<li>org.springframework.orm.hibernate3.HibernateJdbcException</li>
<li>Caused by: org.hibernate.PessimisticLockException</li>
</ul>
</li>
<li>Oracle + for update<ul>
<li>org.springframework.orm.hibernate3.HibernateSystemException</li>
<li>Caused by: Caused by: org.hibernate.dialect.lock.PessimisticEntityLockException</li>
<li>Caused by: org.hibernate.exception.LockTimeoutException</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="Validation.html" title="5.6. Input Validation"
             >next</a> |</li>
        <li class="right" >
          <a href="DataAccessMybatis2.html" title="5.4. Database access (Mybatis2)"
             >previous</a> |</li>
        <li><a href="../index.html">TERASOLUNA Global Framework Development Guideline 1.1.0-SNAPSHOT documentation</a> &raquo;</li>
          <li><a href="index.html" >5. Architecture in Detail - TERASOLUNA Global Framework</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013-2014, NTT DATA.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.Theme by <a href="http://github.com/vkvn">vkvn</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>
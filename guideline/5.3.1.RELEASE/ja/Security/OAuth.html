<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>9.9. OAuth &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.3.1.RELEASE documentation</title>
    <link rel="stylesheet" href="../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '5.3.1.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="9.10. 代表的なセキュリティ要件の実装例" href="SecureLoginDemo.html" />
    <link rel="prev" title="9.8. 暗号化" href="Encryption.html" /><script async src="https://www.googletagmanager.com/gtag/js?id=G-847V2Q99G8"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date()); gtag('config', 'G-847V2Q99G8');
</script>
<script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="SecureLoginDemo.html" title="9.10. 代表的なセキュリティ要件の実装例"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Encryption.html" title="9.8. 暗号化"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.3.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">9. セキュリティ対策</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">9.9. OAuth</a><ul>
<li><a class="reference internal" href="#overview">9.9.1. Overview</a><ul>
<li><a class="reference internal" href="#oauth-2-0">9.9.1.1. OAuth 2.0とは</a></li>
<li><a class="reference internal" href="#oautharchitecture">9.9.1.2. OAuth 2.0のアーキテクチャ</a><ul>
<li><a class="reference internal" href="#oauthrole">9.9.1.2.1. ロール</a></li>
<li><a class="reference internal" href="#oauthscope">9.9.1.2.2. スコープ</a></li>
<li><a class="reference internal" href="#oauthprotocolflow">9.9.1.2.3. プロトコルフロー</a></li>
<li><a class="reference internal" href="#authorizationgrant">9.9.1.2.4. 認可グラント</a></li>
<li><a class="reference internal" href="#accesstokenlifecycle">9.9.1.2.5. アクセストークンのライフサイクル</a></li>
</ul>
</li>
<li><a class="reference internal" href="#spring-security-oauth">9.9.1.3. Spring Security OAuthのアーキテクチャ</a><ul>
<li><a class="reference internal" href="#authorizationserver">9.9.1.3.1. 認可サーバ</a></li>
<li><a class="reference internal" href="#resourceserver">9.9.1.3.2. リソースサーバ</a></li>
<li><a class="reference internal" href="#client">9.9.1.3.3. クライアント</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">9.9.2. How to use</a><ul>
<li><a class="reference internal" href="#oauthsetup">9.9.2.1. Spring Security OAuthのセットアップ</a></li>
<li><a class="reference internal" href="#oauthhowtouseapplicationsettings">9.9.2.2. アプリケーションの設定</a></li>
<li><a class="reference internal" href="#implementationoauthauthorizationserver">9.9.2.3. 認可サーバの実装</a><ul>
<li><a class="reference internal" href="#oauthauthorizationservercreatesettingfile">9.9.2.3.1. 設定ファイルの作成（認可サーバ）</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverdefinition">9.9.2.3.2. 認可サーバの定義</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverclientauthentication">9.9.2.3.3. クライアントの認証</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverresourceownerauthentication">9.9.2.3.4. リソースオーナの認証</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtoauthorizebyscope">9.9.2.3.5. スコープごとの認可</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtocustomizeauthorizeview">9.9.2.3.6. スコープ認可画面のカスタマイズ</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtohandleerror">9.9.2.3.7. 認可リクエスト時のエラーハンドリング</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtoconfigureaccesstoken">9.9.2.3.8. リソースサーバとのアクセストークン共有方法</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtocanceltoken">9.9.2.3.9. トークンの取り消し（認可サーバ）</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtocontrolltarnsaction">9.9.2.3.10. トランザクション制御</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id25">9.9.2.4. リソースサーバの実装</a><ul>
<li><a class="reference internal" href="#id26">9.9.2.4.1. 設定ファイルの作成（リソースサーバ）</a></li>
<li><a class="reference internal" href="#id28">9.9.2.4.2. リソースにアクセス可能なスコープの設定</a></li>
<li><a class="reference internal" href="#id29">9.9.2.4.3. アクセストークンに関する設定（リソースサーバ）</a></li>
<li><a class="reference internal" href="#id30">9.9.2.4.4. ユーザ情報の取得</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id31">9.9.2.5. クライアントの実装</a><ul>
<li><a class="reference internal" href="#oauth2resttemplate">9.9.2.5.1. OAuth2RestTemplateを使用したリソースへのアクセス</a><ul>
<li><a class="reference internal" href="#id32">9.9.2.5.1.1. 設定ファイルの作成（クライアント）</a></li>
<li><a class="reference internal" href="#oauth2clientcontextfilter">9.9.2.5.1.2. OAuth2ClientContextFilterの適用</a></li>
<li><a class="reference internal" href="#oauth2resttemplatesettings">9.9.2.5.1.3. OAuth2RestTemplateの設定</a><ul>
<li><a class="reference internal" href="#id34">9.9.2.5.1.3.1. 認可コードグラント使用時のリソースの設定</a></li>
<li><a class="reference internal" href="#oauth2resourceownerpasswordcredentialgrantresourcesettings">9.9.2.5.1.3.2. リソースオーナパスワードクレデンシャルグラント使用時のリソースの設定</a></li>
<li><a class="reference internal" href="#id36">9.9.2.5.1.3.3. クライアントクレデンシャルグラント使用時のリソースの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id37">9.9.2.5.1.4. リソースサーバへのアクセス</a></li>
</ul>
</li>
<li><a class="reference internal" href="#javascript">9.9.2.5.2. JavaScriptを使用したリソースへのアクセス</a></li>
<li><a class="reference internal" href="#oauthclientserverhowtocanceltoken">9.9.2.5.3. トークンの取り消し（クライアントサーバ）</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend">9.9.3. How to extend</a><ul>
<li><a class="reference internal" href="#id39">9.9.3.1. エンドポイントを介した認可サーバとリソースサーバの連携</a><ul>
<li><a class="reference internal" href="#http">9.9.3.1.1. HTTPアクセスを介した連携</a></li>
<li><a class="reference internal" href="#defaultaccesstokenconverter">9.9.3.1.2. DefaultAccessTokenConverterの拡張</a><ul>
<li><a class="reference internal" href="#id40">9.9.3.1.2.1. DefaultAccessTokenConverterとは</a></li>
<li><a class="reference internal" href="#id41">9.9.3.1.2.2. 認可サーバの実装</a></li>
<li><a class="reference internal" href="#id42">9.9.3.1.2.3. リソースサーバの実装</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="Encryption.html"
                        title="previous chapter">9.8. 暗号化</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="SecureLoginDemo.html"
                        title="next chapter">9.10. 代表的なセキュリティ要件の実装例</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/Security/OAuth.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="oauth">
<span id="id1"></span><h1>9.9. OAuth<a class="headerlink" href="#oauth" title="Permalink to this headline">¶</a></h1>
<div class="admonition caution">
  <p class="first admonition-title">Caution</p>
  <p><strong>本バージョンの内容は既に古くなっています</strong>。最新のガイドラインは<a href="http://terasolunaorg.github.io/guideline/">こちら</a>からご参照ください。</p>
</div>
<div class="contents local topic" id="id2">
<p class="topic-title">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id60">Overview</a><ul>
<li><a class="reference internal" href="#oauth-2-0" id="id61">OAuth 2.0とは</a></li>
<li><a class="reference internal" href="#oautharchitecture" id="id62">OAuth 2.0のアーキテクチャ</a><ul>
<li><a class="reference internal" href="#oauthrole" id="id63">ロール</a></li>
<li><a class="reference internal" href="#oauthscope" id="id64">スコープ</a></li>
<li><a class="reference internal" href="#oauthprotocolflow" id="id65">プロトコルフロー</a></li>
<li><a class="reference internal" href="#authorizationgrant" id="id66">認可グラント</a></li>
<li><a class="reference internal" href="#accesstokenlifecycle" id="id67">アクセストークンのライフサイクル</a></li>
</ul>
</li>
<li><a class="reference internal" href="#spring-security-oauth" id="id68">Spring Security OAuthのアーキテクチャ</a><ul>
<li><a class="reference internal" href="#authorizationserver" id="id69">認可サーバ</a></li>
<li><a class="reference internal" href="#resourceserver" id="id70">リソースサーバ</a></li>
<li><a class="reference internal" href="#client" id="id71">クライアント</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use" id="id72">How to use</a><ul>
<li><a class="reference internal" href="#oauthsetup" id="id73">Spring Security OAuthのセットアップ</a></li>
<li><a class="reference internal" href="#oauthhowtouseapplicationsettings" id="id74">アプリケーションの設定</a></li>
<li><a class="reference internal" href="#implementationoauthauthorizationserver" id="id75">認可サーバの実装</a><ul>
<li><a class="reference internal" href="#oauthauthorizationservercreatesettingfile" id="id76">設定ファイルの作成（認可サーバ）</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverdefinition" id="id77">認可サーバの定義</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverclientauthentication" id="id78">クライアントの認証</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverresourceownerauthentication" id="id79">リソースオーナの認証</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtoauthorizebyscope" id="id80">スコープごとの認可</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtocustomizeauthorizeview" id="id81">スコープ認可画面のカスタマイズ</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtohandleerror" id="id82">認可リクエスト時のエラーハンドリング</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtoconfigureaccesstoken" id="id83">リソースサーバとのアクセストークン共有方法</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtocanceltoken" id="id84">トークンの取り消し（認可サーバ）</a></li>
<li><a class="reference internal" href="#oauthauthorizationserverhowtocontrolltarnsaction" id="id85">トランザクション制御</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id25" id="id86">リソースサーバの実装</a><ul>
<li><a class="reference internal" href="#id26" id="id87">設定ファイルの作成（リソースサーバ）</a></li>
<li><a class="reference internal" href="#id28" id="id88">リソースにアクセス可能なスコープの設定</a></li>
<li><a class="reference internal" href="#id29" id="id89">アクセストークンに関する設定（リソースサーバ）</a></li>
<li><a class="reference internal" href="#id30" id="id90">ユーザ情報の取得</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id31" id="id91">クライアントの実装</a><ul>
<li><a class="reference internal" href="#oauth2resttemplate" id="id92">OAuth2RestTemplateを使用したリソースへのアクセス</a><ul>
<li><a class="reference internal" href="#id32" id="id93">設定ファイルの作成（クライアント）</a></li>
<li><a class="reference internal" href="#oauth2clientcontextfilter" id="id94">OAuth2ClientContextFilterの適用</a></li>
<li><a class="reference internal" href="#oauth2resttemplatesettings" id="id95">OAuth2RestTemplateの設定</a><ul>
<li><a class="reference internal" href="#id34" id="id96">認可コードグラント使用時のリソースの設定</a></li>
<li><a class="reference internal" href="#oauth2resourceownerpasswordcredentialgrantresourcesettings" id="id97">リソースオーナパスワードクレデンシャルグラント使用時のリソースの設定</a></li>
<li><a class="reference internal" href="#id36" id="id98">クライアントクレデンシャルグラント使用時のリソースの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id37" id="id99">リソースサーバへのアクセス</a></li>
</ul>
</li>
<li><a class="reference internal" href="#javascript" id="id100">JavaScriptを使用したリソースへのアクセス</a></li>
<li><a class="reference internal" href="#oauthclientserverhowtocanceltoken" id="id101">トークンの取り消し（クライアントサーバ）</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend" id="id102">How to extend</a><ul>
<li><a class="reference internal" href="#id39" id="id103">エンドポイントを介した認可サーバとリソースサーバの連携</a><ul>
<li><a class="reference internal" href="#http" id="id104">HTTPアクセスを介した連携</a></li>
<li><a class="reference internal" href="#defaultaccesstokenconverter" id="id105">DefaultAccessTokenConverterの拡張</a><ul>
<li><a class="reference internal" href="#id40" id="id106">DefaultAccessTokenConverterとは</a></li>
<li><a class="reference internal" href="#id41" id="id107">認可サーバの実装</a></li>
<li><a class="reference internal" href="#id42" id="id108">リソースサーバの実装</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<span id="oauthoverview"></span><h2><a class="toc-backref" href="#id60">9.9.1. Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>本節では、OAuth 2.0の概要とSpringプロジェクトの一つである
Spring Security OAuthを使用してOAuth 2.0の仕様に沿った認可制御機能を実装する方法について説明する。</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>Spring Security OAuth のリファレンス</strong></p>
<p class="last">Spring Security OAuthは、本ガイドラインで紹介していない機能も提供している。
Spring Security OAuthについて詳しく知りたい場合は、<a class="reference external" href="https://projects.spring.io/spring-security-oauth/docs/oauth2.html">OAuth 2 Developers Guide</a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="oauth-2-0">
<span id="oauthaboutoauth2-0"></span><h3><a class="toc-backref" href="#id61">9.9.1.1. OAuth 2.0とは</a><a class="headerlink" href="#oauth-2-0" title="Permalink to this headline">¶</a></h3>
<p>OAuth 2.0とは、サードパーティー製アプリケーションがHTTPサービスを利用する際に、
サーバ上の保護されたリソースに対するアクセス範囲の指定を可能にするための認可フレームワークのことである。</p>
<p>OAuth 2.0はRFCとして仕様化されており、関連する複数の技術仕様から構成されている。</p>
<p>以下にOAuth 2.0の主要な仕様を示す。</p>
<table border="1" class="colwidths-given docutils" id="id43">
<caption><span class="caption-text"><strong>OAuth 2.0の主要仕様</strong></span><a class="headerlink" href="#id43" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="15%" />
<col width="30%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">RFC</th>
<th class="head">概要</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">RFC 6749</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="http://tools.ietf.org/html/rfc6749">The OAuth 2.0 Authorization Framework</a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">用語や認可方式などの、OAuth 2.0としてのもっとも基本的な内容が記載されている技術仕様。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">RFC 6750</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="https://tools.ietf.org/html/rfc6750">Bearer Token Usage</a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">RFC 6749に記載されている認可制御を実現する場合に利用する、「署名なしアクセストークン」
（以降、アクセストークンと表す）のサーバ間の受け渡し方法に関する技術仕様。</div>
<div class="line">アクセストークンについては後述する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">RFC 6819</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="https://tools.ietf.org/html/rfc6819">Threat Model and Security Considerations</a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OAuth 2.0を使用するうえで考慮が必要となるセキュリティ要件に関する技術仕様。</div>
<div class="line">本ガイドラインでは検討項目の具体的な説明は割愛する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">RFC 7519</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="https://tools.ietf.org/html/rfc7519">JSON Web Token (JWT)</a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">署名が可能なJSONを含んだトークンであるJSON Web Token (JWT)に関する技術仕様。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">RFC 7523</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="https://tools.ietf.org/html/rfc7523">JSON Web Token (JWT) Profile for OAuth 2.0 Client Authentication and Authorization Grants</a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">RFC 6749に記載されている認可制御の実現する場合に利用するアクセストークンとして、RFC 6819で定められているJWTを利用する方法に関する技術仕様。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">RFC 7009</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="https://tools.ietf.org/html/rfc7009">OAuth 2.0 Token Revocation</a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">トークンの無効化を行う追加エンドポイントに関する技術仕様。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>従来のクライアントサーバ型の認証モデルでは、サードパーティー製アプリケーションはサーバ上の
保護されたリソースにアクセスするために、ユーザーの認証情報（ユーザー名とパスワードなど）を利用して認証を行う。</p>
<p>つまり、ユーザーは、サードパーティー製アプリケーションにリソースへのアクセス権を与えるために
自身の認証情報をサードパーティと共有する必要があるが、
これはサードパーティー製アプリケーションに不具合や悪意のある操作などが存在した場合に、
ユーザの意図しないアクセスや情報漏洩等のリスクにつながる。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_TraditionalAuthenticationModel.png"><img alt="../_images/OAuth_TraditionalAuthenticationModel.png" src="../_images/OAuth_TraditionalAuthenticationModel.png" style="width: 100%;" /></a>
</div>
<p>これに対し、OAuth 2.0では認証はユーザが直接行い、サードパーティー製アプリケーションには
「アクセストークン」と呼ばれる認証済みリクエストを行うための情報を払い出すことで、
サードパーティーに認証情報を共有することなくリソースへアクセスすることが可能となる。</p>
<p>また、アクセストークン発行時にリソースに対するアクセス範囲（スコープ）を指定可能とすることで
従来のクライアントサーバ型の認証モデルと比較してより柔軟なアクセス制御を実現している。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_OAuthAuthenticationModel.png"><img alt="../_images/OAuth_OAuthAuthenticationModel.png" src="../_images/OAuth_OAuthAuthenticationModel.png" style="width: 100%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oautharchitecture">
<span id="id3"></span><h3><a class="toc-backref" href="#id62">9.9.1.2. OAuth 2.0のアーキテクチャ</a><a class="headerlink" href="#oautharchitecture" title="Permalink to this headline">¶</a></h3>
<p>ここではOAuth 2.0が定義するロール、スコープ、認可グラント、及びプロトコルフローについて説明する。
OAuth 2.0ではスコープや認可グラントという概念を定義しており、これらの概念を使用して認可の仕様を定めている。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="oauthrole">
<span id="id4"></span><h4><a class="toc-backref" href="#id63">9.9.1.2.1. ロール</a><a class="headerlink" href="#oauthrole" title="Permalink to this headline">¶</a></h4>
<p>OAuth 2.0ではロールとして以下の4つを定義している。</p>
<table border="1" class="colwidths-given longtable docutils" id="id44">
<caption><span class="caption-text"><strong>OAuth 2.0におけるロール</strong></span><a class="headerlink" href="#id44" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">ロール名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">リソースオーナ</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">保護されたリソースへのアクセスを許可するロール。人（エンドユーザ）など。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">リソースサーバ</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">保護されたリソースを提供するロール。Webサーバ。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">認可サーバ</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナの認証と、アクセストークン（クライアントがリソースサーバにアクセスするときに必要な情報）の発行を行うロール。Webサーバ。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">クライアント</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナの認可を得て、リソースオーナの代理として保護されたリソースに対してリクエストを行うロール。Webアプリケーションなど。クライアントの情報は事前に認可サーバに登録され、認可サーバ内で一意な情報であるクライアントIDにより管理される。</div>
<div class="line">OAuth 2.0ではクライアントクレデンシャル（クライアントの認証情報）の機密性を維持できる能力に基づき、クライアントタイプとして以下の2つを定義している。</div>
<div class="line">(1) コンフィデンシャル</div>
<div class="line-block">
<div class="line">クライアントクレデンシャルの機密性を維持することができるクライアント。</div>
</div>
<div class="line">(2) パブリック</div>
<div class="line-block">
<div class="line">リソースオーナのデバイス上で実行されるクライアントのように、クライアントクレデンシャルの機密性を維持することができず、かつ他の手段を用いたセキュアなクライアント認証が行えないクライアント。</div>
<div class="line"><br /></div>
</div>
<div class="line">また、OAuth 2.0ではクライアントとして以下のような例を考慮して設計されている</div>
<div class="line">(1) Webアプリケーション（web application）</div>
<div class="line-block">
<div class="line">Webサーバー上で実行されるクライアント（コンフィデンシャル）。</div>
</div>
<div class="line">(2) ユーザエージェントベースアプリケーション（user-agent-based application）</div>
<div class="line-block">
<div class="line">クライアントコードがWebサーバーからダウンロードされリソースオーナのユーザエージェント内で実行されるクライアント（パブリック）。Javascriptアプリケーションなど。</div>
</div>
<div class="line">(3) ネイティブアプリケーション（native application）</div>
<div class="line-block">
<div class="line">リソースオーナのデバイス上にインストールされ実行されるクライアント（パブリック）。</div>
</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthscope">
<span id="id5"></span><h4><a class="toc-backref" href="#id64">9.9.1.2.2. スコープ</a><a class="headerlink" href="#oauthscope" title="Permalink to this headline">¶</a></h4>
<p>OAuth 2.0では保護されたリソースに対するアクセスを制御する方法としてスコープという概念を使用している。</p>
<p>認可サーバはクライアントからの要求に対し、認可サーバのポリシーまたはリソースオーナの
指示に基づいてアクセストークンにスコープを含め、保護されたリソースに対する
アクセス権（読み込み権限、書き込み権限など）を指定することが出来る。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthprotocolflow">
<span id="id6"></span><h4><a class="toc-backref" href="#id65">9.9.1.2.3. プロトコルフロー</a><a class="headerlink" href="#oauthprotocolflow" title="Permalink to this headline">¶</a></h4>
<p>OAuth 2.0では、以下のような流れでリソースへのアクセスを行う。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ProtocolFlow.png"><img alt="../_images/OAuth_ProtocolFlow.png" src="../_images/OAuth_ProtocolFlow.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given docutils" id="id45">
<caption><span class="caption-text"><strong>OAuth 2.0のプロトコルフロー</strong></span><a class="headerlink" href="#id45" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントはリソースオーナに対して認可を要求する。上の図ではリソースオーナに</div>
<div class="line">直接要求を行ってるが、認可サーバを経由して行うほうが望ましい。</div>
<div class="line">後述するグラントタイプの中では認可コードグラントとインプリシットグラントが</div>
<div class="line">認可サーバを経由してリソースオーナに要求を行うフローになっている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントはリソースオーナからの認可を表すクレデンシャルとして認可グラント（後述）を受け取る。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントは、認可サーバーに対して自身の認証情報とリソースオーナが与えた認可グラントを提示することで、アクセス</div>
<div class="line">トークンを要求する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバはクライアントを認証し、認可グラントの正当性を確認する。認可グラントが正当な場合、</div>
<div class="line">アクセストークンを発行する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントはリソースサーバの保護されたリソースへリクエストを行い、発行されたアクセス</div>
<div class="line">トークンにより認証する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースサーバはアクセストークンの正当性を確認し、正当な場合、リクエストを受け入れる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">OAuth 1.0で不評だった署名とトークン交換の複雑な仕組みを簡略化するために、OAuth 2.0ではアクセストークンを扱うリクエストはHTTPS通信で行うことを必須としている。
（HTTPS通信を使用することでアクセストークンの盗聴を防止する）</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="authorizationgrant">
<span id="id7"></span><h4><a class="toc-backref" href="#id66">9.9.1.2.4. 認可グラント</a><a class="headerlink" href="#authorizationgrant" title="Permalink to this headline">¶</a></h4>
<p>認可グラントは、リソースオーナからの認可を表し、クライアントがアクセストークンを取得する際に用いられる。
OAuth 2.0では、グラントタイプとして以下の4つを定義しているが、クレデンシャル項目を追加するなどの独自拡張を行うこともできる。</p>
<p>クライアントは4つのグラントタイプのいずれかにより、認可サーバへアクセストークンを要求し、取得したアクセストークンでリソースサーバにアクセスする。
認可サーバはサポートするグラントタイプを必ず1つ以上定義しており、その中から使用するグラントタイプをクライアントからの認可リクエストによって決定する。</p>
<table border="1" class="colwidths-given docutils" id="id46">
<caption><span class="caption-text"><strong>OAuth 2.0における認可グラント</strong></span><a class="headerlink" href="#id46" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">グラントタイプ</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">認可コードグラント</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可コードグラントのフローでは、認可サーバがクライアントとリソースオーナの仲介となって認可コードをクライアントへ発行し、クライアントが認可コードを認可サーバに渡すことでアクセストークンを発行する。</div>
<div class="line">認可サーバが発行した認可コードを使用してアクセストークンを発行するため、クライアントへリソースオーナのクレデンシャルを共有する必要がない。</div>
<div class="line">認可コードグラントはWebアプリケーションのように、コンフィデンシャルなクライアントがOAuth 2.0を利用する際に使用する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">インプリシットグラント</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">インプリシットグラントのフローでは、認可コードグラントと同様に認可サーバが仲介するが、認可コードの代わりに直接アクセストークンを発行する。</div>
<div class="line">アクセストークンはURL中にエンコードされるため、リソースオーナや同一デバイス上の他のアプリケーションに漏えいする可能性があるほか、
クライアントの認証を行わないことから、他のクライアントに対して発行されたアクセストークンを不正に用いた成りすまし攻撃のリスクがある。</div>
<div class="line">インプリシットグラントはJavascriptで実装されたクライアントなどの、クライアントタイプがパブリックである場合のみ使用すること。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">リソースオーナパスワードクレデンシャルグラント</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナパスワードクレデンシャルグラントのフローでは、クライアントがリソースオーナの認証情報を認可グラントとして使用して、直接アクセストークンを発行する。</div>
<div class="line">クライアントへリソースオーナのクレデンシャルを共有する必要があるため、クライアントの信頼性が低い場合、クレデンシャルの不正利用や漏洩のリスクがある。</div>
<div class="line">リソースオーナパスワードクレデンシャルグラントはリソースオーナとクライアントの間で高い信頼があり、かつ他のグラントタイプが利用できない場合にのみ使用すること。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">クライアントクレデンシャルグラント</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントクレデンシャルグラントのフローでは、クライアントの認証情報を認可グラントとして使用して、直接アクセストークンを発行する。</div>
<div class="line">クライアントがリソースオーナであるような場合に使用する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>認可コードグラントのフローを以下に示す。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_AuthorizationCodeGrant.png"><img alt="../_images/OAuth_AuthorizationCodeGrant.png" src="../_images/OAuth_AuthorizationCodeGrant.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id47">
<caption><span class="caption-text"><strong>認可コードグラントフロー</strong></span><a class="headerlink" href="#id47" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナは、ユーザエージェントを介してクライアントが提供するリソースサーバの保護されたリソースが必要なページにアクセスする。</div>
<div class="line">クライアントはリソースオーナから認可の取得を行うために、リソースオーナのユーザエージェントを認可サーバの認可エンドポイントにアクセスさせる。</div>
<div class="line">このとき、クライアントは自身を識別するためのクライアントIDと、オプションとしてリソースに要求するスコープ、認可サーバが認可処理後にユーザエージェントを戻すリダイレクトURL、stateをリクエストパラメータに含める。</div>
<div class="line">stateはユーザエージェントに紐付くランダムな値であり、一連のフローが同じユーザエージェントで実行されたことを保証するために利用される(CSRF対策)。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザエージェントは、クライアントに指示された認可サーバの認可エンドポイントにアクセスする。</div>
<div class="line">認可サーバはユーザエージェント経由でリソースオーナを認証し、リクエストパラメータのクライアントID、スコープ、リダイレクトURLを元に、自身に登録済みのクライアント情報と比較しパラメータの正当性確認を行う。</div>
<div class="line">確認完了後、アクセス要求の許可/拒否をリソースオーナにたずねる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナはアクセス要求の許可/拒否を認可サーバに送信する。</div>
<div class="line">リソースオーナがアクセスを許可した場合、認可サーバの認可エンドポイントは認可コードを発行し、リクエストパラメータのリダイレクトURLを用いてユーザエージェントをクライアントにリダイレクトさせる指示を出す。</div>
<div class="line">その際、リダイレクトURLのリクエストパラメータとして、認可コードをリダイレクトURLに付与する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザエージェントは認可コードが付与されたリダイレクトURLにアクセスする。</div>
<div class="line">クライアントの処理が完了するとリソースオーナにレスポンスを返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントはアクセストークンを要求するために、認可コードを認可サーバのトークンエンドポイントに送信する。</div>
<div class="line">認可サーバのトークンエンドポイントはクライアントの認証と認可コードの正当性の検証を行い、正当である場合アクセストークンと任意でリフレッシュトークンを発行する。</div>
<div class="line">リフレッシュトークンはアクセストークンが無効化された、または期限切れの際に新しいアクセストークンを発行するために使用される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントは取得したアクセストークンでリソースサーバにアクセスする。</div>
<div class="line">リソースサーバはアクセストークンの正当性を確認し、正当な場合、リクエストを処理してレスポンスをクライアントに返却する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>インプリシットグラントのフローを以下に示す。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ImplicitGrant.png"><img alt="../_images/OAuth_ImplicitGrant.png" src="../_images/OAuth_ImplicitGrant.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id48">
<caption><span class="caption-text"><strong>インプリシットグラントフロー</strong></span><a class="headerlink" href="#id48" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナは、ユーザエージェントを介してクライアントが提供するリソースサーバの保護されたリソースが必要なページにアクセスする。</div>
<div class="line">クライアントはリソースオーナから認可の取得とアクセストークンの発行を行うために、リソースオーナのユーザエージェントを認可サーバの認可エンドポイントにアクセスさせる。</div>
<div class="line">このとき、クライアントは自身を識別するためのクライアントIDと、オプションとしてリソースに要求するスコープ、認可サーバが認可処理後にユーザエージェントを戻すリダイレクトURL、stateをリクエストパラメータに含める。</div>
<div class="line">stateはユーザエージェントに紐付くランダムな値であり、一連のフローが同じユーザエージェントで実行されたことを保証するために利用される(CSRF対策)。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザエージェントは、クライアントに指示された認可サーバの認可エンドポイントにアクセスする。</div>
<div class="line">認可サーバはユーザエージェント経由でリソースオーナを認証し、リクエストパラメータのクライアントID、スコープ、リダイレクトURLを元に、自身に登録済みのクライアント情報と比較しパラメータの正当性確認を行う。</div>
<div class="line">確認完了後、アクセス要求の許可/拒否をリソースオーナにたずねる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナはアクセス要求の許可/拒否を認可サーバに送信する。</div>
<div class="line">リソースオーナがアクセスを許可した場合、認可サーバの認可エンドポイントはリクエストパラメータのリダイレクトURLを用いてユーザエージェントをクライアントリソースにリダイレクトさせる指示を出す。その際、アクセストークンをリダイレクトURLのURLフラグメントに付与する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザエージェントはリダイレクトの指示に従い、クライアントリソースにリクエストを送信する。このとき、URLフラグメントの情報をローカルで保持し、リダイレクトの際にはURLフラグメントを送信しない。</div>
<div class="line">クライアントリソースにアクセスすると、Webページ（通常は埋め込みスクリプトを含むHTMLドキュメント）が返却される。</div>
<div class="line">ユーザエージェントはWebページに含まれるスクリプトを実行し、ローカルで保持していたURLフラグメントからアクセストークンを抽出する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザエージェントはアクセストークンをクライアントに渡す。</div>
<div class="line">クライアントの処理が完了するとリソースオーナにレスポンスを返却する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントは取得したアクセストークンでリソースサーバにアクセスする。</div>
<div class="line">リソースサーバはアクセストークンの正当性を確認し、正当な場合、リクエストを処理してレスポンスをクライアントに返却する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>リソースオーナパスワードクレデンシャルグラントのフローを以下に示す。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ResourceOwnerPasswordCredentialsGrant.png"><img alt="../_images/OAuth_ResourceOwnerPasswordCredentialsGrant.png" src="../_images/OAuth_ResourceOwnerPasswordCredentialsGrant.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given docutils" id="id49">
<caption><span class="caption-text"><strong>リソースオーナパスワードクレデンシャルグラントフロー</strong></span><a class="headerlink" href="#id49" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナがクライアントにクレデンシャル（ユーザー名、パスワード）を提供する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントはアクセストークンを要求するために、認可サーバのトークンエンドポイントにアクセスする。</div>
<div class="line">このとき、クライアントはリソースオーナから指定されたクレデンシャルとリソースに要求するスコープをリクエストパラメータに含める。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバのトークンエンドポイントはクライアントを認証し、リソースオーナのクレデンシャルを検証する。正当である場合アクセストークンを発行する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>クライアントクレデンシャルグラントのフローを以下に示す。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ClientCredentialsGrant.png"><img alt="../_images/OAuth_ClientCredentialsGrant.png" src="../_images/OAuth_ClientCredentialsGrant.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given docutils" id="id50">
<caption><span class="caption-text"><strong>クライアントクレデンシャルグラントフロー</strong></span><a class="headerlink" href="#id50" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントはアクセストークンを要求するために、認可サーバのトークンエンドポイントにアクセスする。</div>
<div class="line">このとき、クライアントはクライアント自身のクレデンシャルを含めてアクセストークンを要求する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバのトークンエンドポイントはクライアントを認証し、認証に成功した場合アクセストークンを発行する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="accesstokenlifecycle">
<span id="id8"></span><h4><a class="toc-backref" href="#id67">9.9.1.2.5. アクセストークンのライフサイクル</a><a class="headerlink" href="#accesstokenlifecycle" title="Permalink to this headline">¶</a></h4>
<p>アクセストークンはクライアントが提示する認可グラントの正当性を認可サーバが確認することで発行される。
発行されたアクセストークンは、認可サーバのポリシーまたはリソースオーナの指示に基づいたスコープが与えられ、保護されたリソースに対するアクセス権を得る。
アクセストークンは発行時に有効期限が設定され、有効期限切れとなると保護されたリソースに対するアクセス権を失効される。</p>
<p>アクセストークンの発行から失効までの流れは以下のようになる。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_LifeCycleOfAccessToken.png"><img alt="../_images/OAuth_LifeCycleOfAccessToken.png" src="../_images/OAuth_LifeCycleOfAccessToken.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id51">
<caption><span class="caption-text"><strong>アクセストークンの発行から失効までのフロー</strong></span><a class="headerlink" href="#id51" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントが認可グラントを提示し、アクセストークンを要求する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバはクライアントが提示した認可グラントを確認し、アクセストークンを発行する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントはアクセストークンを提示し、リソースサーバの保護されたリソースを要求する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースサーバはクライアントが提示したアクセストークンの正当性を検証し、正当であればリソースサーバの保護されたリソースに対して処理を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントはアクセストークン（有効期限切れ）を提示し、リソースサーバの保護されたリソースを要求する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースサーバはクライアントが提示したアクセストークンの正当性を検証し、アクセストークンの有効期限が切れている場合はエラーを返却する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">アクセストークンが有効期限切れとなると保護されたリソースに対するアクセス権を失効されるが、アクセストークンが有効期限切れとなる前にアクセストークンを無効化し保護されたリソースに対するアクセス権を失効させることも可能である。</div>
<div class="line">アクセストークンが有効期限切れとなる前に無効化する場合、クライアントより認可サーバにトークンの取り消し依頼を行う。無効化されたアクセストークンは保護されたリソースに対するアクセス権を失効される。</div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">アクセストークンが有効期限切れとなった場合、クライアントがアクセストークンを再取得するためには認可サーバへ認可グラントの再提示を行い、認可サーバによる正当性の再確認が必要になる。
そのため、アクセストークンの有効期限を短く設定した場合はユーザビリティが下がってしまう。一方で、アクセストークンの有効期限を長く設定した場合はアクセストークンの漏洩、漏洩時に悪用されるリスクが高まってしまう。</div>
</div>
<div class="line-block">
<div class="line">ユーザビリティを下げずに漏洩、漏洩時のリスクを下げるためにはリフレッシュトークンが用いられる。
リフレッシュトークンはアクセストークンが無効化されたあるいは期限切れの際、認可グラントの再提示を行うことなく新しいアクセストークンを取得するために利用される。
リフレッシュトークンも発行時に有効期限が設定され、リフレッシュトークンが有効期限切れとなった場合はアクセストークンの再発行ができなくなる。</div>
<div class="line">アクセストークンの有効期限に短い期間を設定し、リフレッシュトークンの有効期限に長い期間を設定することで、短いサイクルでアクセストークンが再発行されユーザビリティを保ちつつアクセストークン漏洩及び漏洩時の悪用のリスクも抑えることができる。</div>
</div>
<div class="line-block">
<div class="line">リフレッシュトークンの発行はオプションであり、認可サーバーの判断に委ねられる。</div>
</div>
<p>リフレッシュトークンによるアクセストークンの再発行の流れは以下のようになる。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_LifeCycleOfAccessTokenWithRefreshToken.png"><img alt="../_images/OAuth_LifeCycleOfAccessTokenWithRefreshToken.png" src="../_images/OAuth_LifeCycleOfAccessTokenWithRefreshToken.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given docutils" id="id52">
<caption><span class="caption-text"><strong>アクセストークンの発行から再発行までのフロー</strong></span><a class="headerlink" href="#id52" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントが認可グラントを提示し、アクセストークンを要求する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバはクライアントが提示した認可グラントを確認し、アクセストークンとリフレッシュトークンを発行する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントはアクセストークンを提示し、リソースサーバの保護されたリソースを要求する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースサーバはクライアントが提示したアクセストークンの正当性を検証し、正当であればリソースサーバの保護されたリソースに対して処理を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントはアクセストークン（有効期限切れ）を提示し、リソースサーバの保護されたリソースを要求する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースサーバはクライアントが提示したアクセストークンの正当性を検証し、アクセストークンの有効期限が切れている場合はエラーを返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースサーバよりアクセストークンの有効期限切れエラーが返却された場合、クライアントはリフレッシュトークンを提示することで新しいアクセストークンを要求する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバはクライアントが提示しリフレッシュトークンの正当性を検証し、正当であればアクセストークンとオプションでリフレッシュトークンを発行する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="spring-security-oauth">
<span id="springsecurityoautharchitecture"></span><h3><a class="toc-backref" href="#id68">9.9.1.3. Spring Security OAuthのアーキテクチャ</a><a class="headerlink" href="#spring-security-oauth" title="Permalink to this headline">¶</a></h3>
<p>Spring Security OAuthは、OAuth 2.0で定義されているロールのうち、認可サーバ、リソースサーバ、クライアントの3つのロールをSpringアプリケーションとして構築する際に必要となる機能を提供するライブラリである。
Spring Security OAuthは、Spring Framework(Spring MVC)やSpring Securityが提供する機能と連携して動作する仕組みになっており、Spring Security OAuthが提供するデフォルト実装を適切にコンフィギュレーション（Bean定義）するだけで、認可サーバ、リソースサーバ、クライアントを構築することができる。
また、Spring FrameworkやSpring Securityと同様に数多くの拡張ポイントが用意されており、Spring Security OAuthが提供するするデフォルト実装で実現できない要件を組み込むことができるようになっている。</p>
<p>なお、各ロール間のリクエストに対する認証・認可にはSpring Securityが提供する機能を利用するため、そちらの詳細は<a class="reference internal" href="Authentication.html"><span class="doc">認証</span></a>及び <a class="reference internal" href="Authorization.html"><span class="doc">認可</span></a>を参照されたい。</p>
<p>Spring Security OAuthを使用して認可サーバ、リソースサーバ、クライアントを構築した場合、以下のような流れで処理が行われる。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_OAuth2Architecture.png"><img alt="../_images/OAuth_OAuth2Architecture.png" src="../_images/OAuth_OAuth2Architecture.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given docutils" id="id53">
<caption><span class="caption-text"><strong>Spring Security OAuthのフロー</strong></span><a class="headerlink" href="#id53" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナはユーザエージェントを介してクライアントへアクセスする。</div>
<div class="line">クライアントはサービスより<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>の呼び出しを行う。</div>
<div class="line">認可エンドポイントにアクセスする認可グラントの場合、ユーザエージェントへ認可サーバの認可エンドポイントへリダイレクトさせるよう指示する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザエージェントは認可サーバの認可エンドポイントである<code class="docutils literal"><span class="pre">AuthorizationEndpoint</span></code>へアクセスする。</div>
<div class="line"><code class="docutils literal"><span class="pre">AuthorizationEndpoint</span></code>はリソースオーナへ認可を問い合わせる画面を表示させる。</div>
<div class="line">リソースオーナはクライアントにスコープに対して認可を行い、<code class="docutils literal"><span class="pre">AuthorizationEndpoint</span></code>へアクセスする。</div>
<div class="line"><code class="docutils literal"><span class="pre">AuthorizationEndpoint</span></code>は、認可グラントが認可コードグラントである場合は認可コードを、インプリシットグラントである場合はアクセストークンを発行する。</div>
<div class="line">発行した認可コードまたはアクセストークンは、リダイレクトを使用してユーザエージェント経由でクライアントに渡される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントは<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>より認可サーバのトークンエンドポイントである<code class="docutils literal"><span class="pre">TokenEndpoint</span></code>へアクセスする。</div>
<div class="line"><code class="docutils literal"><span class="pre">TokenEndpoint</span></code>は<code class="docutils literal"><span class="pre">AuthorizationServerTokenService</span></code>を呼び出しアクセストークンを発行する。発行したアクセストークンはクライアントへの応答として渡される。</div>
<div class="line">認可グラントが認可コードグラントである場合は認可コードを認可サーバに提示する。アクセストークン発行前に<code class="docutils literal"><span class="pre">TokenEndpoint</span></code>で認可コードの正当性を検証される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントは(2)または(3)で取得したアクセストークンを指定して <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>よりリソースサーバにアクセスする。</div>
<div class="line">リソースサーバは<code class="docutils literal"><span class="pre">OAuth2AuthenticationManager</span></code>を呼び出し、<code class="docutils literal"><span class="pre">ResourceServerTokenServices</span></code>を介してアクセストークンに紐づく認証情報を取得する。また、認証情報の取得時にアクセストークンを検証する。</div>
<div class="line">アクセストークンの検証に成功した場合、クライアントからのリクエストに応じたリソースを返却する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>前述のとおり、OAuth 2.0では各エンドポイントにおいてHTTPS通信の使用を前提としているが、HTTPS通信を使用するのがSSLアクセラレータやWebサーバまでの場合や、
ロードバランサを使用して複数のAPサーバに分散させる場合がある。
リソースオーナによって認可された後にクライアントに認可コードまたは、アクセストークンを連携するためのリダイレクトURLを組み立てる際に、
SSLアクセラレータやWebサーバ、ロードバランサを指し示すリダイレクトURLを組み立てる必要がある。</p>
<p>Spring(Spring Security OAuth)では以下のいずれかのヘッダを使用してリダイレクト用のURLを組み立てる仕組みが提供されている。</p>
<ul class="simple">
<li>Forwardedヘッダ</li>
<li>X-Forwarded-Hostヘッダ、X-Forwarded-Portヘッダ、X-Forwarded-Protoヘッダ</li>
</ul>
<p class="last">SSLアクセラレータやWebサーバ、ロードバランサ側で上記ヘッダを付与するように設定し、Spring(Spring Security OAuth)が正しいリダイレクトURLを生成できるようにする必要がある。
これを行わない場合、認可コードグラントやインプリシットグラントにおいて行うリクエストパラメータ（リダイレクトURL）の検証に失敗する可能性がある。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Spring Security OAuthが提供するエンドポイントはSpring MVCの機能を拡張して実現している。Spring Security OAuthが提供するエンドポイントには<code class="docutils literal"><span class="pre">&#64;FrameworkEndpoint</span></code>アノテーションがクラスに設定されている。
これは<code class="docutils literal"><span class="pre">&#64;Controller</span></code>アノテーションで開発者がコンポーネントとして登録したクラスと競合させないためである。
また、<code class="docutils literal"><span class="pre">&#64;FrameworkEndpoint</span></code>アノテーションでコンポーネントとして登録されたエンドポイントは、<code class="docutils literal"><span class="pre">RequestMappingHandlerMapping</span></code>の拡張クラスである<code class="docutils literal"><span class="pre">FrameworkEndpointHandlerMapping</span></code>がエンドポイントの<code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>アノテーションを読み取り、URLと合致する<code class="docutils literal"><span class="pre">&#64;FrameworkEndpoint</span></code>のメソッドを、Handlerクラスとして扱っている。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="authorizationserver">
<span id="id9"></span><h4><a class="toc-backref" href="#id69">9.9.1.3.1. 認可サーバ</a><a class="headerlink" href="#authorizationserver" title="Permalink to this headline">¶</a></h4>
<p>認可サーバは、リソースオーナの認証と、認証後のリソースオーナからの認可の取得、およびアクセストークンの発行を行う。</p>
<p>OAuth 2.0ではアクセス範囲を指定する表現としてスコープという概念をサポートしている。
クライアントは認可リクエスト送信時にスコープを指定し、リソースオーナが指定されたスコープを認可するか、認可サーバに事前に登録されたスコープと一致する場合に、認可サーバでクライアントに対してそのスコープを認可する。
クライアントに対してのスコープの認可と <a class="reference internal" href="Authorization.html#springsecurityauthorization"><span class="std std-ref">認可</span></a>の節で説明しているSpring Securiyのロールによる認可は併用可能である。</p>
<p>Spring Security OAuthでは、<code class="docutils literal"><span class="pre">AuthorizationEndpoint</span></code>においてリソースオーナからの認可の取得機能を提供し、
<code class="docutils literal"><span class="pre">AuthorizationEndpoint</span></code>または<code class="docutils literal"><span class="pre">TokenEndpoint</span></code>においてクライアントに対してのアクセストークンの発行機能を提供している。
<code class="docutils literal"><span class="pre">AuthorizationEndpoint</span></code>と<code class="docutils literal"><span class="pre">TokenEndpoint</span></code>はアクセストークンの発行を<code class="docutils literal"><span class="pre">AuthorizationServerTokenService</span></code>の
デフォルト実装である<code class="docutils literal"><span class="pre">DefaultTokenServices</span></code>によって行っている。
アクセストークンの発行の際には、<code class="docutils literal"><span class="pre">ClientDetailsService</span></code>を介して認可サーバに登録済みのクライアント情報を取得し、アクセストークン発行の可否の検証に使用している。</p>
<p>なお、OAuth 2.0の仕様では認可サーバを利用するクライアントの登録手順については定められておらず、Spring Security OAuthにおいても
クライアント登録手続きはサポートされていない。
そのため、アプリケーションでクライアント登録のインターフェイスを提供したい場合には、独自に実装する必要がある。</p>
<p>リソースオーナの認証にはSpring Securityの認証機能を利用する。
詳細については <a class="reference internal" href="Authentication.html#springsecurityauthentication"><span class="std std-ref">認証</span></a>を参照のこと。</p>
<p>以下に認可サーバの構成を示す。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_AutohrizationServerAuthArchitecture.png"><img alt="../_images/OAuth_AutohrizationServerAuthArchitecture.png" src="../_images/OAuth_AutohrizationServerAuthArchitecture.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given docutils" id="id54">
<caption><span class="caption-text"><strong>認可サーバの動き（認可エンドポイントアクセス時）</strong></span><a class="headerlink" href="#id54" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザエージェントが認可サーバの認可エンドポイント(/oauth/authorize)にアクセスすることで<code class="docutils literal"><span class="pre">AuthorizationEndpoint</span></code>の処理が実行される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ClientDetailsService</span></code>のメソッドを呼び出し、事前に登録されているクライアント情報を取得後、リクエストパラメータを検証する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UserApprovalHandler</span></code>のメソッドを呼び出し、クライアントへスコープに対する認可が登録されているかチェックする。</div>
<div class="line">認可が未登録である場合、ユーザエージェント経由でリソースオーナへ認可を問い合わせる画面(/oauth/confirm_access)を表示させる。</div>
<div class="line">このとき、問い合わせの対象となるスコープはリクエストパラメータと事前に登録されているクライント情報の積をとり、Spring MVCの<code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>を利用して連携される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UserApprovalHandler</span></code>の実装である<code class="docutils literal"><span class="pre">ApprovalStoreUserApprovalHandler</span></code>では<code class="docutils literal"><span class="pre">ApprovalStore</span></code>により認可の状態を管理する。</div>
<div class="line">リソースオーナにより認可が行われた場合、<code class="docutils literal"><span class="pre">ApprovalStore</span></code>のメソッドを呼び出し、指定された情報を登録する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">問い合わせの対象となるスコープは前述のとおり、認可サーバに事前に登録されているスコープと、クライアントが認可リクエスト時にリクエストパラメータで指定したスコープの積となる。
例として、認可サーバでREADとCREATEとDELETEのスコープが割り当てられているクライアントに対して、READとCREATEのスコープをリクエストパラメータで指定した場合は(READ,CREATE,DELETE)と(READ,CREATE)の積である、スコープREAD,CREATEが割り当てられる。
認可サーバでクライアントに割り当てられていないスコープをリクエストパラメータで指定した場合はエラーとなり、アクセスが拒否される。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_AutohrizationServerTokenArchitecture.png"><img alt="../_images/OAuth_AutohrizationServerTokenArchitecture.png" src="../_images/OAuth_AutohrizationServerTokenArchitecture.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given docutils" id="id55">
<caption><span class="caption-text"><strong>認可サーバの動き（トークンエンドポイントアクセス時）</strong></span><a class="headerlink" href="#id55" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントが認可サーバのトークンエンドポイント(/oauth/token)にアクセスすることで<code class="docutils literal"><span class="pre">TokenEndpoint</span></code>の処理が実行される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ClientDetailsService</span></code>のメソッドを呼び出し、事前に登録されているクライアント情報を取得後、リクエストパラメータのスコープがクライアントに登録済みのものかチェックする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">スコープが登録済みのものであった場合、<code class="docutils literal"><span class="pre">TokenGranter</span></code>のメソッドを呼び出し、アクセストークンを発行する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">TokenGranter</span></code>の実装である<code class="docutils literal"><span class="pre">AbstractTokenGranter</span></code>では<code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code>のメソッドを呼び出し、アクセストークンを発行する。</div>
<div class="line"><code class="docutils literal"><span class="pre">AbstractTokenGranter</span></code>はグラントタイプ別に実装されている<code class="docutils literal"><span class="pre">TokenGranter</span></code>の基底クラスであり、実際の処理は各クラスに委譲される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code>の実装である<code class="docutils literal"><span class="pre">DefaultTokenServices</span></code>では<code class="docutils literal"><span class="pre">TokenStore</span></code>のメソッドを呼び出し、アクセストークンの状態を管理する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="resourceserver">
<span id="id10"></span><h4><a class="toc-backref" href="#id70">9.9.1.3.2. リソースサーバ</a><a class="headerlink" href="#resourceserver" title="Permalink to this headline">¶</a></h4>
<p>リソースサーバは、クライアントからの保護されたリソースに対するアクセス要求を処理し、レスポンスを返す。
リソースサーバは、クライアントからのリクエストに付加されるアクセストークンについて、有効期限内であることを検証し、アクセストークンに紐づく認証情報を取得する。
認証情報の取得後は、要求されたリソースが当該アクセストークンのスコープ範囲内であることを検証する。
アクセストークン検証後の処理は、通常のアプリケーションと同様に実装を行うことができる。</p>
<p>Spring Security OAuthでは、アクセストークンの検証機能を、Spring Securityの認証・認可の枠組みを利用して実現している。
具体的には、<code class="docutils literal"><span class="pre">ServletFilter</span></code>にSpring Security OAuthが提供する<code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code>を使用し、
<code class="docutils literal"><span class="pre">AuthenticationEntryPoint</span></code>インタフェース として<code class="docutils literal"><span class="pre">OAuth2AuthenticationEntryPoint</span></code>を、<code class="docutils literal"><span class="pre">AuthenticationManager</span></code>として<code class="docutils literal"><span class="pre">OAuth2AuthenticationManager</span></code>をそれぞれ使用している。
Spring Securityの詳細については <a class="reference internal" href="Authentication.html#springsecurityauthentication"><span class="std std-ref">認証</span></a>を参照のこと。</p>
<p>以下にリソースサーバの構成を示す</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ResourceServerArchitecture.png"><img alt="../_images/OAuth_ResourceServerArchitecture.png" src="../_images/OAuth_ResourceServerArchitecture.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given docutils" id="id56">
<caption><span class="caption-text"><strong>リソースサーバの動き</strong></span><a class="headerlink" href="#id56" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">初めにクライアントがリソースサーバにアクセスすると<code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code>の</div>
<div class="line">呼び出しが行われる。</div>
<div class="line"><code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code>ではアクセストークンの抽出を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークンを抽出後、<code class="docutils literal"><span class="pre">AuthenticationManager</span></code>の実装である<code class="docutils literal"><span class="pre">OAuth2AuthenticationManager</span></code>において<code class="docutils literal"><span class="pre">ResourceServerTokenServices</span></code>を</div>
<div class="line">介してアクセストークンに紐づく認証情報を取得する。また、認証情報の取得時にアクセストークンを検証する。</div>
<div class="line">アクセストークンに紐づく認証情報の取得方法には、認可サーバに対してHTTPによる問い合わせを行うほか、認可サーバと</div>
<div class="line"><code class="docutils literal"><span class="pre">TokenStore</span></code>を共用して取得を行うなどの方法がある。</div>
<div class="line">どのようにして認証情報の取得を行うかについては<code class="docutils literal"><span class="pre">ResourceServerTokenServices</span></code>の実装に依存する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークンの検証に成功した場合、クライアントからのリクエストに応じたリソースを返却する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証エラー時に発生する例外は、<code class="docutils literal"><span class="pre">OAuth2AuthenticationEntryPoint</span></code>を使用してハンドリングし、エラー応答を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可エラー時に発生する例外は、<code class="docutils literal"><span class="pre">OAuth2AccessDeniedHandler</span></code>を使用してハンドリングし、エラー応答を行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="client">
<span id="id11"></span><h4><a class="toc-backref" href="#id71">9.9.1.3.3. クライアント</a><a class="headerlink" href="#client" title="Permalink to this headline">¶</a></h4>
<p>クライアントは、リソースオーナの認可とアクセストークンを取得し、リソースオーナの代理としてリソースサーバの保護されたリソースに対してアクセスを行う。
その際、リソースへのリクエストには認可サーバから発行されたアクセストークンを付加する。</p>
<p>Spring Security OAuthでは、クライアントの基本的な機能の実現方法として<code class="docutils literal"><span class="pre">RestOperations</span></code>のOAuth 2.0向けの実装である<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を提供している。</p>
<p><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>では、アクセストークンの発行やリフレッシュトークンを使用したアクセストークンの再発行、また、アクセストークンを使用したリソースサーバへのアクセスといった機能のほか、
サーブレットフィルタとして<code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>を利用することで、認可コードグラントなどで必要となる認可の機能を実現している。</p>
<p>また、<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>では<code class="docutils literal"><span class="pre">OAuth2ProtectedResourceDetails</span></code>にて指定されたグラントタイプに沿って認可サーバより取得したアクセストークンを<code class="docutils literal"><span class="pre">OAuth2ClientContext</span></code>の実装である<code class="docutils literal"><span class="pre">DefaultOAuth2ClientContext</span></code>に保持する。
<code class="docutils literal"><span class="pre">DefaultOAuth2ClientContext</span></code>はデフォルトではセッションスコープのBeanとして定義され、複数のリクエスト間でアクセストークンを共有をすることが可能となる。</p>
<p>リソースサーバへのアクセス機能の開発をする際は、<code class="docutils literal"><span class="pre">RestOperations</span></code>の実装としてSpring Webが提供する<code class="docutils literal"><span class="pre">RestTemplate</span></code>の代わりにSpring Security OAuthが提供する<code class="docutils literal"><span class="pre">OAuth2RestTemplateを</span></code>使用する以外は、通常のRESTクライアントの開発と同様の実装をする。</p>
<p>以下に、クライアント機能として<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を使用した場合の構成を示す。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ClientArchitecture.png"><img alt="../_images/OAuth_ClientArchitecture.png" src="../_images/OAuth_ClientArchitecture.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id57">
<caption><span class="caption-text"><strong>クライアントの動き</strong></span><a class="headerlink" href="#id57" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザエージェントがクライアントの<code class="docutils literal"><span class="pre">Service</span></code>の呼び出しが行われるよう<code class="docutils literal"><span class="pre">Controller</span></code>へアクセスを行う。</div>
<div class="line">リソースサーバへのアクセスを伴うアクセスに対しては、(5)で発生する可能性がある<code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code>を捕捉するためのサーブレットフィルタ（<code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>）を適用する。</div>
<div class="line">このサーブレットフィルタを適用することで、<code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code>が発生した際に、ユーザエージェントを認可サーバの認可エンドポイントへアクセスさせることができる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Service</span></code>より<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>の呼び出しを行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースサーバへアクセスする前に、メンバとして保持している<code class="docutils literal"><span class="pre">DefaultOAuth2ClientContext</span></code>よりアクセストークンを保持しているか確認を行う。</div>
<div class="line">アクセストークンを保持しており、かつ有効期限内である場合、<code class="docutils literal"><span class="pre">DefaultOAuth2ClientContext</span></code>より取得したアクセストークンを指定してリソースサーバへのアクセスを行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">初回アクセス時などでアクセストークンを保持していなかった場合、または有効期限が超過していた場合、<code class="docutils literal"><span class="pre">AccessTokenProvider</span></code>を呼び出しアクセストークンの取得を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AccessTokenProvider</span></code>では、リソースの詳細情報として<code class="docutils literal"><span class="pre">OAuth2ProtectedResourceDetails</span></code>に定義しているグラントタイプに応じてアクセストークンの取得を行う。</div>
<div class="line">認可コードグラント向けの実装である<code class="docutils literal"><span class="pre">AuthorizationCodeAccessTokenProvider</span></code>では、認可コードの取得が完了していない場合、<code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code>をthrowする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(3)または(5)で取得したアクセストークンを指定して、リソースサーバへのアクセスを行う。</div>
<div class="line">アクセス時にアクセストークンの有効期限切れ（<code class="docutils literal"><span class="pre">AccessTokenRequiredException</span></code>）などのエラーが発生した場合、保持しているアクセストークンを初期化した後、再度(4)以降の処理を行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-use">
<span id="howtouse"></span><h2><a class="toc-backref" href="#id72">9.9.2. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<p>Spring Security OAuthを使用するために必要となるBean定義例や実装方法について説明する。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="oauthsetup">
<span id="id12"></span><h3><a class="toc-backref" href="#id73">9.9.2.1. Spring Security OAuthのセットアップ</a><a class="headerlink" href="#oauthsetup" title="Permalink to this headline">¶</a></h3>
<p>Spring Security OAuthが提供しているクラスを使用するために、Spring Security OAuthを依存ライブラリとして追加する。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.security.oauth<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-security-oauth2<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring Security OAuthを使用するプロジェクトの <code class="file docutils literal"><span class="pre">pom.xml</span></code> に、Spring Security OAuthを依存ライブラリとして追加する。</div>
<div class="line">リソースサーバ、認可サーバ、クライアントを別プロジェクトとして作成する場合、それぞれについて記述を追加すること。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">上記設定例は、依存ライブラリのバージョンを親プロジェクトである terasoluna-gfw-parent で管理する前提であるため、pom.xmlでのバージョンの指定は不要である。
上記の依存ライブラリはterasoluna-gfw-parentが利用している<a class="reference external" href="http://platform.spring.io/platform/">Spring IO Platform</a>で定義済みである。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthhowtouseapplicationsettings">
<span id="id13"></span><h3><a class="toc-backref" href="#id74">9.9.2.2. アプリケーションの設定</a><a class="headerlink" href="#oauthhowtouseapplicationsettings" title="Permalink to this headline">¶</a></h3>
<p>Spring Security OAuthを使用するアプリケーションの設定について説明する。</p>
<p>「<a class="reference internal" href="#authorizationgrant"><span class="std std-ref">認可グラント</span></a>」にて示したとおり、OAuth 2.0ではグラントタイプにより認可サーバ、クライアント間のフローが異なる。
そのため、Spring Security OAuthを使用するアプリケーションでは、アプリケーションがサポートするグラントタイプに沿った設定を行う必要がある。
グラントタイプ別の設定内容については各ロールの実装を参照。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="implementationoauthauthorizationserver">
<span id="id14"></span><h3><a class="toc-backref" href="#id75">9.9.2.3. 認可サーバの実装</a><a class="headerlink" href="#implementationoauthauthorizationserver" title="Permalink to this headline">¶</a></h3>
<p>認可サーバの実装方法について説明する。</p>
<p>認可サーバでは、「リソースオーナからの認可の取得」「アクセストークンの発行」を行うためのエンドポイントをSpring Security OAuthの機能を使用して提供する。
なお、上記のエンドポイントにアクセスする場合はリソースオーナまたはクライアントの認証が必要であり、本ガイドラインではSpring Securityの認証・認可の仕組みを使用して実現する。</p>
<div class="section" id="oauthauthorizationservercreatesettingfile">
<span id="id15"></span><h4><a class="toc-backref" href="#id76">9.9.2.3.1. 設定ファイルの作成（認可サーバ）</a><a class="headerlink" href="#oauthauthorizationservercreatesettingfile" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">認可サーバに関する定義を行うための設定ファイルとして  <code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>を作成する。</div>
<div class="line"><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>では、認可サーバの機能を提供するためのエンドポイントのBean定義およびそれらのエンドポイントに対するセキュリティ設定、認可サーバのサポートするグラントタイプの設定を行う。</div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
       <span class="na">xmlns:oauth2=</span><span class="s">&quot;http://www.springframework.org/schema/security/oauth2&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/security</span>
<span class="s">           http://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">           http://www.springframework.org/schema/security/oauth2</span>
<span class="s">           http://www.springframework.org/schema/security/spring-security-oauth2.xsd</span>
<span class="s">           http://www.springframework.org/schema/beans</span>
<span class="s">           http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>


<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<p>次に、作成した<code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>を読み込むように<code class="docutils literal"><span class="pre">web.xml</span></code>に設定を記述する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">web.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;context-param&gt;</span>
    <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
    <span class="nt">&lt;param-value&gt;</span>
        classpath*:META-INF/spring/applicationContext.xml
        classpath*:META-INF/spring/oauth2-auth.xml  <span class="c">&lt;!-- (1) --&gt;</span>
        classpath*:META-INF/spring/spring-security.xml
    <span class="nt">&lt;/param-value&gt;</span>
<span class="nt">&lt;/context-param&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OAuth 2.0用のBean定義ファイルの指定を行う。<code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>で設定したアクセス制御の対象のURLが<code class="docutils literal"><span class="pre">spring-security.xml</span></code>で設定したアクセス制御の対象のURLに含まれる場合を考慮し、<code class="docutils literal"><span class="pre">spring-security.xml</span></code>より先に記述すること。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthauthorizationserverdefinition">
<span id="id16"></span><h4><a class="toc-backref" href="#id77">9.9.2.3.2. 認可サーバの定義</a><a class="headerlink" href="#oauthauthorizationserverdefinition" title="Permalink to this headline">¶</a></h4>
<p>次に、認可サーバの定義を追加する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
     <span class="na">token-endpoint-url=</span><span class="s">&quot;/oth2/token&quot;</span>
     <span class="na">authorization-endpoint-url=</span><span class="s">&quot;/oth2/authorize&quot;</span> <span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;oauth2:authorization-code</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;oauth2:implicit</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (4) --&gt;</span>
    <span class="nt">&lt;oauth2:client-credentials</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (5) --&gt;</span>
    <span class="nt">&lt;oauth2:password</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (6) --&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;oauth2:authorization-server&gt;</span></code>タグを使用し、認可サーバの設定を定義を行う。</div>
<div class="line"><code class="docutils literal"><span class="pre">&lt;oauth2:authorization-server&gt;</span></code>タグを使用することで、認可を行うための認可エンドポイントと、アクセストークンを発行するためのトークンエンドポイントがコンポーネントとして登録される。</div>
<div class="line"><code class="docutils literal"><span class="pre">token-endpoint-url</span></code>属性にトークンエンドポイントのURLを指定する。指定しない場合はデフォルト値である “/oauth/token” が指定される。</div>
<div class="line"><code class="docutils literal"><span class="pre">authorization-endpoint-url</span></code>属性に認可エンドポイントのURLを指定する。指定しない場合はデフォルト値である “/oauth/authorize” が指定される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;oauth2:authorization-code&gt;</span></code>タグを使用して、認可コードグラントをサポートする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;oauth2:implicit&gt;</span></code>タグを使用して、インプリシットグラントをサポートする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;oauth2:refresh-token&gt;</span></code>タグを使用して、リフレッシュトークンをサポートする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;oauth2:client-credentials&gt;</span></code>タグを使用して、クライアントクレデンシャルグラントをサポートする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;oauth2:password&gt;</span></code>タグを使用して、リソースオーナパスワードクレデンシャルグラントをサポートする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">サポートするグラントタイプを複数指定する場合は上記の順番で指定する必要がある。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>認可コードは、認可コードが発行されてからアクセストークンの発行までの短い期間しか使われないため、デフォルトではインメモリで管理される。
認可サーバが複数台構成の場合は、複数サーバ間で認可コードを共有するためにDBで管理する必要がある。
認可コードをDBで管理する場合は、主キーとなる認可コードを保持するカラムと、認証情報を保持するカラムによって構成された以下のようなテーブルを作成する。以下の例ではPostgreSQLを使用した場合のDB定義を説明する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ERDiagramCode.png"><img alt="../_images/OAuth_ERDiagramCode.png" src="../_images/OAuth_ERDiagramCode.png" style="width: 30%;" /></a>
</div>
<p>認可サーバの設定ファイルには、<code class="docutils literal"><span class="pre">&lt;oauth2:authorization-code&gt;</span></code>タグの<code class="docutils literal"><span class="pre">authorization-code-services-ref</span></code>に、認可コードをDB管理する<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.code.JdbcAuthorizationCodeServices</span></code>のBean IDを指定する。
<code class="docutils literal"><span class="pre">JdbcAuthorizationCodeServices</span></code>のコンストラクタには、認可コード格納用のテーブルに接続するためのデータソースを指定する。
認可コードをDBにて永続管理する場合の注意点については<a class="reference internal" href="#oauthauthorizationserverhowtocontrolltarnsaction"><span class="std std-ref">トランザクション制御</span></a>を <strong>必ず</strong> 参照のこと。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
     <span class="na">token-endpoint-url=</span><span class="s">&quot;/oth2/token&quot;</span>
     <span class="na">authorization-endpoint-url=</span><span class="s">&quot;/oth2/authorize&quot;</span> <span class="nt">&gt;</span>
    <span class="nt">&lt;oauth2:authorization-code</span> <span class="na">authorization-code-services-ref=</span><span class="s">&quot;authorizationCodeServices&quot;</span><span class="nt">/&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;authorizationCodeServices&quot;</span>
      <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.code.JdbcAuthorizationCodeServices&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;codeDataSource&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthauthorizationserverclientauthentication">
<span id="id17"></span><h4><a class="toc-backref" href="#id78">9.9.2.3.3. クライアントの認証</a><a class="headerlink" href="#oauthauthorizationserverclientauthentication" title="Permalink to this headline">¶</a></h4>
<p>エンドポイントに対してアクセスしてきたクライアントについては、登録済みのクライアントか確認するために認証を行う必要がある。
クライアントの認証は、クライアントよりパラメータで渡されたクライアントIDとパスワードを、認可サーバで保持しているクライアント情報をもとに検証することで行う。認証にはBasic認証を用いて行う。</p>
<p>Spring Security OAuthではクライアント情報を取得するためのインタフェースである<code class="docutils literal"><span class="pre">oorg.springframework.security.oauth2.provider.ClientDetailsService</span></code>の実装クラスを提供している。
また、クライアントの情報を保持するためのクラスとして<code class="docutils literal"><span class="pre">ClientDetails</span></code>インタフェースの実装クラスである<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.client.BaseClientDetails</span></code>クラスを提供している。
<code class="docutils literal"><span class="pre">BaseClientDetails</span></code>ではクライアントIDやサポートするグラントタイプなどのOAuth 2.0を利用する上での基本的なパラメータを提供しており、<code class="docutils literal"><span class="pre">BaseClientDetails</span></code>を拡張することで独自のパラメータを追加することも可能である。
ここでは<code class="docutils literal"><span class="pre">BaseClientDetails</span></code>の拡張と<code class="docutils literal"><span class="pre">ClientDetailsService</span></code>の実装クラス作成を行い、独自パラメータとして クライアント名 を追加したクライアント情報をDBを用いて管理、および認証を行う場合の実装方法について説明する。</p>
<p>まず、以下のようなDBを作成する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ERDiagram.png"><img alt="../_images/OAuth_ERDiagram.png" src="../_images/OAuth_ERDiagram.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアント情報を保持するテーブル。client_idを主キーとする。</div>
<div class="line">各カラムの役割は以下のとおりである。</div>
<div class="line-block">
<div class="line">・client_id：クライアントを識別するIDであるクライアントIDを保持するカラム。</div>
<div class="line">・client_secret：クライアントの認証に使用するパスワードを保持するカラム。</div>
<div class="line">・client_name：クライアント名を保持する独自カラム。独自カラムであるため必須ではない。</div>
<div class="line">・access_token_validity：アクセストークンの有効期間[秒]を保持するカラム。</div>
<div class="line">・refresh_token_validity：リフレッシュトークンの有効期間[秒]を保持するカラム。</div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">スコープ情報を保持するテーブル。client_idを外部キーとし、クライアント情報と対応付けする。</div>
<div class="line">scopeカラムに、クライアント認可に使用するスコープを保持する。クライアントがもつスコープの数だけレコードを登録する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソース情報を保持するテーブル。client_idを外部キーとし、クライアント情報と対応付けする。</div>
<div class="line">resource_idカラムに、クライアントのアクセス可能なリソースかどうかを、リソースサーバが識別するために使用するリソースIDを保持する。</div>
<div class="line">リソースサーバが保持するリソースに対して定義しているリソースIDがここで登録されているリソースIDに含まれる場合のみ、リソースへのアクセスを許可される。</div>
<div class="line">クライアントがアクセス可能なリソースIDの数だけレコードを登録する。</div>
<div class="line">リソースIDを一件も登録しなかった場合は、全てのリソースに対してアクセス可能となるため、登録しない場合は注意が必要である。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">グラント情報を保持するテーブル。client_idを外部キーとし、クライアント情報と対応付けする。</div>
<div class="line">authorized_grant_typeカラムに、クライアントの使用するグラントを保持する。</div>
<div class="line">クライアントが利用するグラントの数だけレコードを登録する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リダイレクトURL情報を保持するテーブル。client_idを外部キーとし、クライアント情報と対応付けする。</div>
<div class="line">web_server_redirect_uriカラムに、リソースオーナによる認可後にユーザエージェントをリダイレクトさせるURLを保持する。</div>
<div class="line">リダイレクトURLは認可コードグラント、インプリシットグラントの場合のみ使用される。</div>
<div class="line">認可コードグラント、インプリシットグラント以外のグラントタイプを使用する場合はテーブル自体が不要となる。</div>
<div class="line">クライアントが認可リクエスト時に申告するURLと、ホストとルートパスが一致するリダイレクトURLがない場合はエラーとなる。</div>
<div class="line">クライアントが申告する可能性のあるURLの数だけレコードを登録する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>クライアント情報を保持するモデルを作成する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">Client.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="p">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">clientId</span><span class="p">;</span> <span class="c1">// (1)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">clientSecret</span><span class="p">;</span> <span class="c1">// (2)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">clientName</span><span class="p">;</span> <span class="c1">// (3)</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">accessTokenValidity</span><span class="p">;</span> <span class="c1">// (4)</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">refreshTokenValidity</span><span class="p">;</span> <span class="c1">// (5)</span>
    <span class="c1">// Getters and Setters are omitted</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントを識別するクライアントIDを保持するフィールド。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントの認証に使用するパスワードを保持するフィールド。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring Security OAuthでは提供されていない、クライアント名を保持する拡張フィールド。</div>
<div class="line">拡張フィールドであるため必須ではない。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークンの有効期間[秒]を保持するフィールド。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リフレッシュトークンの有効期間[秒]を保持するフィールド。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><code class="docutils literal"><span class="pre">BaseClientDetails</span></code>クラスを継承させたクラスを作成することで、クライアントの詳細情報を簡単に拡張することができる。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">OAuthClientDetails.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuthClientDetails</span> <span class="kd">extends</span> <span class="n">BaseClientDetails</span><span class="p">{</span>
    <span class="kd">private</span> <span class="n">Client</span> <span class="n">client</span><span class="p">;</span>
    <span class="c1">// Getter and Setter are omitted</span>
<span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.ClientDetailsService</span></code>は、認可処理で必要となるクライアント詳細情報をデータストアから取得するためのインタフェースである。
以下では、<code class="docutils literal"><span class="pre">ClientDetailsService</span></code>の実装クラスの作成について説明する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">OAuthClientDetailsService.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Service</span><span class="p">(</span><span class="s">&quot;clientDetailsService&quot;</span><span class="p">)</span> <span class="c1">// (1)</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuthClientDetailsService</span> <span class="kd">implements</span> <span class="n">ClientDetailsService</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ClientRepository</span> <span class="n">clientRepository</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">ClientDetails</span> <span class="nf">loadClientByClientId</span><span class="p">(</span><span class="n">String</span> <span class="n">clientId</span><span class="p">)</span>
            <span class="kd">throws</span> <span class="n">ClientRegistrationException</span> <span class="p">{</span>

        <span class="n">Client</span> <span class="n">client</span> <span class="o">=</span> <span class="n">clientRepository</span><span class="p">.</span><span class="na">findClientByClientId</span><span class="p">(</span><span class="n">clientId</span><span class="p">);</span> <span class="c1">// (2)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">client</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (3)</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="n">NoSuchClientException</span><span class="p">(</span><span class="s">&quot;No client with requested id: &quot;</span> <span class="o">+</span> <span class="n">clientId</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// (4)</span>
        <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">clientScopes</span> <span class="o">=</span> <span class="n">clientRepository</span><span class="p">.</span><span class="na">findClientScopesByClientId</span><span class="p">(</span><span class="n">clientId</span><span class="p">);</span>
        <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">clientResources</span> <span class="o">=</span> <span class="n">clientRepository</span><span class="p">.</span><span class="na">findClientResourcesByClientId</span><span class="p">(</span><span class="n">clientId</span><span class="p">);</span>
        <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">clientGrants</span> <span class="o">=</span> <span class="n">clientRepository</span><span class="p">.</span><span class="na">findClientGrantsByClientId</span><span class="p">(</span><span class="n">clientId</span><span class="p">);</span>
        <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">clientRedirectUris</span> <span class="o">=</span> <span class="n">clientRepository</span><span class="p">.</span><span class="na">findClientRedirectUrisByClientId</span><span class="p">(</span><span class="n">clientId</span><span class="p">);</span>


         <span class="c1">// (5)</span>
        <span class="n">OAuthClientDetails</span> <span class="n">clientDetails</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OAuthClientDetails</span><span class="p">();</span>
        <span class="n">clientDetails</span><span class="p">.</span><span class="na">setClientId</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="na">getClientId</span><span class="p">());</span>
        <span class="n">clientDetails</span><span class="p">.</span><span class="na">setClientSecret</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="na">getClientSecret</span><span class="p">());</span>
        <span class="n">clientDetails</span><span class="p">.</span><span class="na">setAccessTokenValiditySeconds</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="na">getAccessTokenValidity</span><span class="p">());</span>
        <span class="n">clientDetails</span><span class="p">.</span><span class="na">setRefreshTokenValiditySeconds</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="na">getRefreshTokenValidity</span><span class="p">());</span>
        <span class="n">clientDetails</span><span class="p">.</span><span class="na">setResourceIds</span><span class="p">(</span><span class="n">clientResources</span><span class="p">);</span>
        <span class="n">clientDetails</span><span class="p">.</span><span class="na">setScope</span><span class="p">(</span><span class="n">clientScopes</span><span class="p">);</span>
        <span class="n">clientDetails</span><span class="p">.</span><span class="na">setAuthorizedGrantTypes</span><span class="p">(</span><span class="n">clientGrants</span><span class="p">);</span>
        <span class="n">clientDetails</span><span class="p">.</span><span class="na">setRegisteredRedirectUri</span><span class="p">(</span><span class="n">clientRedirectUris</span><span class="p">);</span>
        <span class="n">clientDetails</span><span class="p">.</span><span class="na">setClient</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">clientDetails</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Serviceとしてcomponent-scanの対象とするため、クラスレベルに<code class="docutils literal"><span class="pre">&#64;Service</span></code>アノテーションをつける。</div>
<div class="line">Bean名を<code class="docutils literal"><span class="pre">clientDetailsService</span></code>として指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">データベースから取得したクライアント情報をClientモデルに保持させる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアント情報が見つからない場合は、Spring Security OAuthの例外である<code class="docutils literal"><span class="pre">NoSuchClientException</span></code>を発生させる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントに紐付く情報を取得する。</div>
<div class="line">複数回にわけてRepositoryの呼び出しを行うことにより処理性能が落ちるような場合は(2)で一括取得する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得した各種情報を<code class="docutils literal"><span class="pre">OAuthClientDetails</span></code>のフィールドに設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>にクライアント認証に必要な設定を追記する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span> <span class="na">pattern=</span><span class="s">&quot;/oth2/*token*/**&quot;</span>
    <span class="na">authentication-manager-ref=</span><span class="s">&quot;clientAuthenticationManager&quot;</span> <span class="na">realm=</span><span class="s">&quot;Realm&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;sec:http-basic</span> <span class="nt">/&gt;</span>           <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;sec:csrf</span> <span class="na">disabled=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/**&quot;</span> <span class="na">access=</span><span class="s">&quot;isAuthenticated()&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>

<span class="nt">&lt;oauth2:authorization-server</span>
     <span class="na">token-endpoint-url=</span><span class="s">&quot;/oth2/token&quot;</span>
     <span class="na">authorization-endpoint-url=</span><span class="s">&quot;/oth2/authorize&quot;</span>
     <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (5) --&gt;</span>
    <span class="nt">&lt;oauth2:authorization-code</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:implicit</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:client-credentials</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:password</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>

<span class="nt">&lt;sec:authentication-manager</span> <span class="na">id=</span><span class="s">&quot;clientAuthenticationManager&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (6) --&gt;</span>
    <span class="nt">&lt;sec:authentication-provider</span> <span class="na">user-service-ref=</span><span class="s">&quot;clientDetailsUserService&quot;</span> <span class="nt">&gt;</span>  <span class="c">&lt;!-- (7) --&gt;</span>
        <span class="nt">&lt;sec:password-encoder</span> <span class="na">ref=</span><span class="s">&quot;passwordEncoder&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (8) --&gt;</span>
    <span class="nt">&lt;/sec:authentication-provider&gt;</span>
<span class="nt">&lt;/sec:authentication-manager&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;clientDetailsUserService&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.client.ClientDetailsUserDetailsService&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (9) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;clientDetailsService&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (10) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークン操作に関するエンドポイントへのセキュリティ設定を行うために、エンドポイントURLとして
<code class="docutils literal"><span class="pre">/oth2/*token*/</span></code>配下をアクセス制御の対象として指定する。</div>
<div class="line">ここでは、アクセス制御対象となるエンドポイントURLを <code class="docutils literal"><span class="pre">/oth2/</span></code>から始まる値としているが、
Spring Security OAuthにより定義されているエンドポイントURL、およびそのデフォルト値は以下のとおりである。</div>
<div class="line-block">
<div class="line">・トークン払い出しに使用するエンドポイントのエンドポイントURLである<code class="docutils literal"><span class="pre">/oauth/token</span></code></div>
<div class="line">・トークンを検証するエンドポイントのエンドポイントURLである<code class="docutils literal"><span class="pre">/oauth/check_token</span></code></div>
<div class="line">・JWTの署名を公開鍵暗号方式で作成した場合に、公開鍵を取得するために使用するエンドポイントのエンドポイントURLである<code class="docutils literal"><span class="pre">/oauth/token_key</span></code></div>
</div>
<div class="line"><code class="docutils literal"><span class="pre">authentication-manager-ref</span></code>属性に(5)で定義しているクライアント認証用の<code class="docutils literal"><span class="pre">AuthenticationManager</span></code>のBeanを指定する。</div>
<div class="line">また、(2)のようにXML NamespaceでBasic認証を有効にした場合、Basic認証のRealm名が <code class="docutils literal"><span class="pre">&quot;Spring</span> <span class="pre">Security</span> <span class="pre">Application&quot;</span></code>となり、</div>
<div class="line">アプリケーションの内部情報が露呈してしまうため、<code class="docutils literal"><span class="pre">realm</span></code>属性に適切な値を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアント認証にBasic認証を適用する。</div>
<div class="line">詳細については <a class="reference external" href="http://docs.spring.io/spring-security/site/docs/4.1.4.RELEASE/reference/html/basic.html">http://docs.spring.io/spring-security/site/docs/4.1.4.RELEASE/reference/html/basic.html</a> を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">/oth2/*token*/**</span></code>へのアクセスに対してCSRF対策機能を無効化する。</div>
<div class="line">Spring Security OAuthでは、OAuth 2.0のCSRF対策として推奨されている、stateパラメータを使用したリクエストの正当性確認を採用している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エンドポイントURLの配下に対して、認証済みユーザーのみがアクセスできる権限を付与する設定。</div>
<div class="line">Webリソースに対してアクセスポリシーの指定方法については、<a class="reference internal" href="Authorization.html"><span class="doc">認可</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">client-details-service-ref</span></code>属性に<code class="docutils literal"><span class="pre">OAuthClientDetailsService</span></code>のBeanを指定する。</div>
<div class="line">指定するBeanIDは、<code class="docutils literal"><span class="pre">ClientDetailsService</span></code>の実装クラスで指定したBeanIDと合わせる必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントを認証するための<code class="docutils literal"><span class="pre">AuthenticationManager</span></code>をBean定義する。</div>
<div class="line">リソースオーナの認証で使用する<code class="docutils literal"><span class="pre">AuthenticationManager</span></code>と別名のBean IDを指定する必要がある。</div>
<div class="line">リソースオーナの認証については<a class="reference internal" href="#oauthauthorizationserverresourceownerauthentication"><span class="std std-ref">リソースオーナの認証</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">sec:authentication-provider</span></code>の<code class="docutils literal"><span class="pre">user-service-ref</span></code>属性に(9)で定義している<code class="docutils literal"><span class="pre">ClientDetailsUserDetailsService</span></code>のBeanを指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントの認証に使用するパスワードのハッシュ化に使用する<code class="docutils literal"><span class="pre">PasswordEncoder</span></code>のBeanを指定する。</div>
<div class="line">パスワードハッシュ化の詳細については <a class="reference internal" href="Authentication.html#springsecurityauthenticationpasswordhashing"><span class="std std-ref">パスワードのハッシュ化</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UserDetailsService</span></code>インタフェースの実装クラスである<code class="docutils literal"><span class="pre">ClientDetailsUserDetailsService</span></code>をBean定義する。</div>
<div class="line">リソースオーナの認証で使用する<code class="docutils literal"><span class="pre">UserDetailsService</span></code>と別名のBean IDを指定する必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">コンストラクタの引数に、データベースからクライアント情報を取得する<code class="docutils literal"><span class="pre">OAuthClientDetailsService</span></code>のBeanを指定する。</div>
<div class="line">指定するBean IDは、<code class="docutils literal"><span class="pre">ClientDetailsService</span></code>の実装クラスで指定したBean IDと合わせる必要がある。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthauthorizationserverresourceownerauthentication">
<span id="id18"></span><h4><a class="toc-backref" href="#id79">9.9.2.3.4. リソースオーナの認証</a><a class="headerlink" href="#oauthauthorizationserverresourceownerauthentication" title="Permalink to this headline">¶</a></h4>
<p>アクセストークンの取得に認可コードグラントを用いる場合、ログイン画面を用意する等、なんらかの方法でリソースオーナを認証する必要がある。</p>
<div class="line-block">
<div class="line">本ガイドラインでは、リソースオーナの認証にSpring Securityを利用する前提とする。</div>
<div class="line">認可の設定には、認証済みユーザーのみ認可エンドポイントURLへアクセスできるよう、認可エンドポイントURLを含んだURLをアクセスポリシーとして定義する必要がある。
また、認可画面の表示を行うコントローラのURLと、認可エンドポイントでの例外をハンドリングするコントローラのURLも同様にアクセスポリシーとして定義する必要がある。</div>
<div class="line">認可画面の表示を行うコントローラについては <a class="reference internal" href="#oauthauthorizationserverhowtocustomizeauthorizeview"><span class="std std-ref">スコープ認可画面のカスタマイズ</span></a>を、認可エンドポイントでの例外をハンドリングするコントローラについては <a class="reference internal" href="#oauthauthorizationserverhowtohandleerror"><span class="std std-ref">認可リクエスト時のエラーハンドリング</span></a>を参照されたい。</div>
</div>
<p>Spring Securityの詳細については <a class="reference internal" href="Authentication.html"><span class="doc">認証</span></a>及び <a class="reference internal" href="Authorization.html"><span class="doc">認可</span></a>を参照されたい。</p>
<p>以下に認可エンドポイントURL、認可画面の表示を行うコントローラのURL、認可エンドポイントのエラーハンドリングを行うコントローラのURLを含んだアクセスポリシーの定義例を示す。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">spring-security.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span> <span class="na">authentication-manager-ref=</span><span class="s">&quot;userLoginManager&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;sec:form-login</span> <span class="na">login-page=</span><span class="s">&quot;/login&quot;</span>
        <span class="na">authentication-failure-url=</span><span class="s">&quot;/login?error=true&quot;</span>
        <span class="na">login-processing-url=</span><span class="s">&quot;/login&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:logout</span> <span class="na">logout-url=</span><span class="s">&quot;/logout&quot;</span>
        <span class="na">logout-success-url=</span><span class="s">&quot;/&quot;</span>
        <span class="na">delete-cookies=</span><span class="s">&quot;JSESSIONID&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:access-denied-handler</span> <span class="na">ref=</span><span class="s">&quot;accessDeniedHandler&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:custom-filter</span> <span class="na">ref=</span><span class="s">&quot;userIdMDCPutFilter&quot;</span> <span class="na">after=</span><span class="s">&quot;ANONYMOUS_FILTER&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:session-management</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/login/**&quot;</span> <span class="na">access=</span><span class="s">&quot;permitAll&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/oth2/**&quot;</span> <span class="na">access=</span><span class="s">&quot;isAuthenticated()&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>

 <span class="nt">&lt;sec:authentication-manager</span> <span class="na">id=</span><span class="s">&quot;userLoginManager&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;sec:authentication-provider</span>
        <span class="na">user-service-ref=</span><span class="s">&quot;userDetailsService&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;sec:password-encoder</span> <span class="na">ref=</span><span class="s">&quot;passwordEncoder&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/sec:authentication-provider&gt;</span>
<span class="nt">&lt;/sec:authentication-manager&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;userDetailsService&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.core.userdetails.jdbc.JdbcDaoImpl&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可エンドポイントURLである<code class="docutils literal"><span class="pre">/oth2/authorize</span></code>、認可画面の表示を行うコントローラのURLである<code class="docutils literal"><span class="pre">/oauth/confirm_access</span></code>、認可エンドポイントのエラーハンドリングを行うコントローラのURLである<code class="docutils literal"><span class="pre">/oauth/error</span></code>を含んだルート(“<code class="docutils literal"><span class="pre">/</span></code>”)配下をアクセス制御の対象として指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可エンドポイントURLである<code class="docutils literal"><span class="pre">/oth2/authorize</span></code>、認可画面の表示を行うコントローラのURLである<code class="docutils literal"><span class="pre">/oauth/confirm_access</span></code>、認可エンドポイントのエラーハンドリングを行うコントローラのURLである<code class="docutils literal"><span class="pre">/oauth/error</span></code>を含んだルート(“<code class="docutils literal"><span class="pre">/oth2/</span></code>”)配下を認証済みユーザーのみがアクセスできるよう指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナを認証するための<code class="docutils literal"><span class="pre">AuthenticationManager</span></code>をBean定義する。</div>
<div class="line">クライアントの認証で使用する<code class="docutils literal"><span class="pre">AuthenticationManager</span></code>と別名のBean IDを指定する必要がある。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="oauthauthorizationserverhowtoauthorizebyscope">
<span id="id19"></span><h4><a class="toc-backref" href="#id80">9.9.2.3.5. スコープごとの認可</a><a class="headerlink" href="#oauthauthorizationserverhowtoauthorizebyscope" title="Permalink to this headline">¶</a></h4>
<p>リソースオーナに認可を求める際に、要求されたスコープを一括で認可するのではなく、各スコープを個別に認可する場合の設定方法を説明する。</p>
<p>認可サーバを再起動した際に認可情報を失わないよう永続管理するために、また複数台の認可サーバで認可情報を共有するためには、認可情報をDBで管理する必要がある。
スコープごとに認可情報を格納するためのDBとして、以下のDBを作成する。以下の例ではPostgreSQLを使用した場合のDB定義を説明する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ERDiagramApprovals.png"><img alt="../_images/OAuth_ERDiagramApprovals.png" src="../_images/OAuth_ERDiagramApprovals.png" style="width: 50%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可情報を保持するテーブル。userId、clientId、scopeを主キーとする。</div>
<div class="line">各カラムの役割は以下のとおりである。</div>
<div class="line-block">
<div class="line">・userId：認可を行ったリソースオーナのユーザ名を保持するカラム。</div>
<div class="line">・clientId：リソースオーナによって認可されたクライアントのクライアントIDを保持するカラム。</div>
<div class="line">・scope：リソースオーナに認可されたスコープを保持するカラム。</div>
<div class="line">・status：リソースオーナに認可されたかどうかを保持するカラム。認可された場合は<code class="docutils literal"><span class="pre">APPROVED</span></code>、拒否された場合は<code class="docutils literal"><span class="pre">DENIED</span></code>が設定される。</div>
<div class="line">・expiresAt：認可情報の有効期限を保持するカラム。</div>
<div class="line">・lastModifiedAt：認可情報が最後に更新された日時を保持するカラム。</div>
</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>リソースオーナからスコープ毎の認可を取得し、DBに保存して管理するための設定を行う。</p>
<p>実装例は以下のとおりである。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
     <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span>
     <span class="na">token-endpoint-url=</span><span class="s">&quot;/oth2/token&quot;</span>
     <span class="na">authorization-endpoint-url=</span><span class="s">&quot;/oth2/authorize&quot;</span>
     <span class="na">user-approval-handler-ref=</span><span class="s">&quot;userApprovalHandler&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

     <span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;/oauth2:authorization-server&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;userApprovalHandler&quot;</span>
      <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.approval.ApprovalStoreUserApprovalHandler&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;clientDetailsService&quot;</span> <span class="na">ref=</span><span class="s">&quot;clientDetailsService&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;approvalStore&quot;</span> <span class="na">ref=</span><span class="s">&quot;approvalStore&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;requestFactory&quot;</span> <span class="na">ref=</span><span class="s">&quot;requestFactory&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;approvalExpiryInSeconds&quot;</span> <span class="na">value=</span><span class="s">&quot;3200&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;approvalStore&quot;</span>
      <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.approval.JdbcApprovalStore&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;approvalDataSource&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;requestFactory&quot;</span>
      <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.request.DefaultOAuth2RequestFactory&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;clientDetailsService&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">スコープの認可処理を行う<code class="docutils literal"><span class="pre">UserApprovalHandler</span></code>として、<code class="docutils literal"><span class="pre">user-approval-handler-ref</span></code>に(2)で定義している<code class="docutils literal"><span class="pre">ApprovalStoreUserApprovalHandler</span></code>のBeanを指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">スコープの認可処理を行う<code class="docutils literal"><span class="pre">ApprovalStoreUserApprovalHandler</span></code>をBean定義する。</div>
<div class="line">リソースオーナの認可結果を管理する<code class="docutils literal"><span class="pre">approvalStore</span></code>プロパティには、(3)で定義している<code class="docutils literal"><span class="pre">JdbcApprovalStore</span></code>のBeanを指定する。</div>
<div class="line">スコープの認可処理に使用するクライアント情報の取得をする<code class="docutils literal"><span class="pre">clientDetailsService</span></code>プロパティには、<code class="docutils literal"><span class="pre">OAuthClientDetailsService</span></code>のBeanを指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">requestFactory</span></code>プロパティには、<code class="docutils literal"><span class="pre">DefaultOAuth2RequestFactory</span></code>のBeanを指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">requestFactory</span></code>プロパティに設定したBeanは<code class="docutils literal"><span class="pre">ApprovalStoreUserApprovalHandler</span></code>によって使用されないが、設定を行っていない場合は<code class="docutils literal"><span class="pre">ApprovalStoreUserApprovalHandler</span></code>のBean生成時にエラーとなるため、<code class="docutils literal"><span class="pre">requestFactory</span></code>プロパティへの設定が必要である。</div>
<div class="line">認可情報の有効期間[秒]を指定する場合は、<code class="docutils literal"><span class="pre">approvalExpiryInSeconds</span></code>プロパティに、有効期間[秒]を設定する。設定を行わない場合は、認可情報は認可から一ヶ月間有効となる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可情報をDBで管理する<code class="docutils literal"><span class="pre">JdbcApprovalStore</span></code>をBean定義する。</div>
<div class="line">コンストラクタには、認可情報格納用のテーブルに接続するためのデータソースを指定する。</div>
<div class="line">認可情報をDBにて永続管理する場合の注意点については<a class="reference internal" href="#oauthauthorizationserverhowtocontrolltarnsaction"><span class="std std-ref">トランザクション制御</span></a>を <strong>必ず</strong> 参照のこと。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">認可情報を永続管理する必要がなく、DBではなくインメモリで管理したい場合は、<code class="docutils literal"><span class="pre">approvalStore</span></code>として<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.approval.InMemoryApprovalStore</span></code>をBean定義すればよい。</p>
</div>
</div>
<div class="section" id="oauthauthorizationserverhowtocustomizeauthorizeview">
<span id="id20"></span><h4><a class="toc-backref" href="#id81">9.9.2.3.6. スコープ認可画面のカスタマイズ</a><a class="headerlink" href="#oauthauthorizationserverhowtocustomizeauthorizeview" title="Permalink to this headline">¶</a></h4>
<p>スコープ認可画面をカスタマイズしたい場合、コントローラとJSPを作成することでカスタマイズできる。以下ではスコープ認可画面のカスタマイズした場合の例を説明する。</p>
<p>リソースオーナに認可を求めるエンドポイントの呼び出しを行う場合、(コンテキストパス)/oauth/confirm_accessにフォワードされる。
(コンテキストパス)/oauth/confirm_accessをハンドリングするコントローラを作成する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">OAuth2ApprovalController.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2ApprovalController</span> <span class="p">{</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;/oauth/confirm_access&quot;</span><span class="p">)</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">confirmAccess</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// omitted</span>
        <span class="k">return</span> <span class="s">&quot;approval/oauthConfirm&quot;</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>アノテーションを使用して、<code class="docutils literal"><span class="pre">&quot;/oauth/confirm_access&quot;</span></code>へのアクセスに対するメソッドとしてマッピングを行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>次に、スコープ認可画面のJSPを作成する。
認可対象のスコープは<code class="docutils literal"><span class="pre">scopes</span></code>キーでModelに登録されているため、これを利用してスコープ認可画面を表示する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauthConfirm.jsp</span></code></li>
</ul>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="k">&lt;%@</span> <span class="n">taglib</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;sec&quot;</span> <span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://www.springframework.org/security/tags&quot;</span> <span class="k">%&gt;</span>

<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>OAuth Approval<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;p&gt;</span>Do you authorize &#39;${f:h(authorizationRequest.clientId)}&#39; to access your protected resources?<span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">&#39;confirmationForm&#39;</span> <span class="na">name=</span><span class="s">&#39;confirmationForm&#39;</span> <span class="na">action=</span><span class="s">&#39;${pageContext.request.contextPath}/oth2/authorize&#39;</span> <span class="na">method=</span><span class="s">&#39;post&#39;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;c:forEach</span> <span class="na">var=</span><span class="s">&quot;scope&quot;</span> <span class="na">items=</span><span class="s">&quot;${scopes}&quot;</span> <span class="na">varStatus=</span><span class="s">&quot;status&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
                <span class="nt">&lt;li&gt;</span>
                    ${f:h(scope.key)}  <span class="c">&lt;!-- (2) --&gt;</span>
                    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&#39;radio&#39;</span> <span class="na">name=</span><span class="s">&quot;${f:h(scope.key)}&quot;</span> <span class="na">value=</span><span class="s">&#39;true&#39;</span><span class="nt">/&gt;</span>Approve
                    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&#39;radio&#39;</span> <span class="na">name=</span><span class="s">&quot;${f:h(scope.key)}&quot;</span> <span class="na">value=</span><span class="s">&#39;false&#39;</span><span class="nt">/&gt;</span>Deny
                <span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;/c:forEach&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&#39;user_oauth_approval&#39;</span> <span class="na">value=</span><span class="s">&#39;true&#39;</span> <span class="na">type=</span><span class="s">&#39;hidden&#39;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
            <span class="nt">&lt;sec:csrfInput</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (4) --&gt;</span>
            <span class="nt">&lt;label&gt;</span>
                <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&#39;authorize&#39;</span> <span class="na">value=</span><span class="s">&#39;Authorize&#39;</span> <span class="na">type=</span><span class="s">&#39;submit&#39;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;/form&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">スコープ毎に認可を指定するためのラジオボタンを出力する。対象のスコープは<code class="docutils literal"><span class="pre">scopes</span></code>リストに含まれるため、<code class="docutils literal"><span class="pre">items</span></code>に<code class="docutils literal"><span class="pre">scopes</span></code>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">scopes</span></code>リストが保持する要素のキー名が、それぞれのスコープ名となっているため、キー名を画面表示する。</div>
<div class="line">許可、拒否を選ぶために、Approve、Denyのラジオボタンの出力設定を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">user_oauth_approval</span></code>をhidden項目として埋め込むことで、Spring Security OAuthがリクエストパラメータに<code class="docutils literal"><span class="pre">user_oauth_approval</span></code>を付与する。</div>
<div class="line">リクエストパラメータに付与された<code class="docutils literal"><span class="pre">user_oauth_approval</span></code>は、認可エンドポイントのスコープ認可を行うメソッドを実行するために用いられる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">CSRFを引き渡すために、HTMLの<code class="docutils literal"><span class="pre">&lt;form&gt;</span></code>要素の中に<code class="docutils literal"><span class="pre">&lt;sec:csrfInput&gt;</span></code>要素を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="oauthauthorizationserverhowtohandleerror">
<span id="id21"></span><h4><a class="toc-backref" href="#id82">9.9.2.3.7. 認可リクエスト時のエラーハンドリング</a><a class="headerlink" href="#oauthauthorizationserverhowtohandleerror" title="Permalink to this headline">¶</a></h4>
<p>認可エンドポイントで認可エラー（クライアント未存在エラー等のセキュリティに関わるエラーや、リダイレクトURLチェックエラー）が発生した場合、Spring Security OAuthが提供する<code class="docutils literal"><span class="pre">OAuth2Exception</span></code>が<code class="docutils literal"><span class="pre">throw</span></code>され 、リクエストは(コンテキストパス)/oauth/errorにフォワードされる。
そのため認可エンドポイントでの例外をハンドリングする場合は(コンテキストパス)/oauth/errorをハンドリングするコントローラを作成する必要がある。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">OAuth2ErrorController.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2ErrorController</span> <span class="p">{</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;/oauth/error&quot;</span><span class="p">)</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">handleError</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// omitted</span>
        <span class="k">return</span> <span class="s">&quot;common/error/oauthError&quot;</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>アノテーションを使用して、<code class="docutils literal"><span class="pre">&quot;/oauth/error&quot;</span></code>へのアクセスに対するメソッドとしてマッピングを行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>次に、表示させるエラー画面のJSPを作成する。
認可エンドポイントで発生したエラー内容は<code class="docutils literal"><span class="pre">error</span></code>キーでModelに登録されているため、これを利用してエラー内容を画面表示する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauthError.jsp</span></code></li>
</ul>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;title&gt;</span>OAuth Error!<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span>
    <span class="na">href=</span><span class="s">&quot;${pageContext.request.contextPath}/resources/app/css/styles.css&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>OAuth Error!<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;p&gt;</span>${f:h(error.OAuth2ErrorCode)}<span class="nt">&lt;/p&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;p&gt;</span>${f:h(error.message)}<span class="nt">&lt;/p&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">error</span></code>に含まれるエラーレスポンスを出力する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">error</span></code>に含まれるエラーメッセージを出力する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">認可エンドポイントで発生したエラーが、認可エラー（クライアント未存在エラー等のセキュリティに関わるエラーや、リダイレクトURLチェックエラー）以外の場合、
リダイレクトすることでクライアント側にエラー通知を行う。</p>
</div>
</div>
<div class="section" id="oauthauthorizationserverhowtoconfigureaccesstoken">
<span id="id22"></span><h4><a class="toc-backref" href="#id83">9.9.2.3.8. リソースサーバとのアクセストークン共有方法</a><a class="headerlink" href="#oauthauthorizationserverhowtoconfigureaccesstoken" title="Permalink to this headline">¶</a></h4>
<p>リソースサーバがアクセストークンを元にリソースへのアクセスに対する認可判定を行えるよう、認可サーバは<code class="docutils literal"><span class="pre">TokenServices</span></code>を介してアクセストークンを連携する。
連携方法は以下に示すとおり複数存在する。</p>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">連携方法</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">DBを介した連携</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">共有DBを利用し、アクセストークンを連携する方法。</div>
<div class="line">リソースサーバと認可サーバがDBを共有している場合に利用可能。</div>
<div class="line">認可サーバはTokenServiceの実装として<code class="docutils literal"><span class="pre">DefaultTokenServices</span></code>を、TokenStoreの実装として<code class="docutils literal"><span class="pre">JdbcTokenStore</span></code>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">HTTPアクセスを介した連携</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">HTTPアクセスにより、アクセストークンを連携する方法。</div>
<div class="line">リソースサーバと認可サーバが共有DBを利用できない場合に、この方法を利用する。</div>
<div class="line">リソースサーバはアクセストークンの取得及び検証を認可サーバに依頼するため、認可サーバに負荷がかかる。</div>
<div class="line">認可サーバはTokenServiceの実装として<code class="docutils literal"><span class="pre">DefaultTokenServices</span></code>を指定する。</div>
<div class="line">アクセストークンをDBで管理する場合は<code class="docutils literal"><span class="pre">JdbcTokenStore</span></code>を、メモリで管理する場合は<code class="docutils literal"><span class="pre">InMemoryTokenStore</span></code>をTokenStoreの実装として指定する。</div>
<div class="line">アクセストークンをメモリで管理する実装はサーバ再起動などでアクセストークンが失われるため、テスト用途専用の実装である。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JWTを利用した連携</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JWTを利用し、アクセストークンを連携する方法。</div>
<div class="line">リソースサーバと認可サーバが共有DBを利用できない場合に、この方法を利用する。</div>
<div class="line">HTTPアクセスを介した連携と比べ、認可サーバにアクセストークンの取得を依頼しないため、認可サーバへの負荷がかからない。</div>
<div class="line">認可サーバはTokenServiceの実装として<code class="docutils literal"><span class="pre">DefaultTokenServices</span></code>を、TokenStoreの実装として<code class="docutils literal"><span class="pre">JwtTokenStore</span></code>を指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter</span></code>を利用することでアクセストークンの署名とエンコード、デコードを行う。</div>
<div class="line">アクセストークンの署名とその検証には公開鍵を使用する方法と、共通鍵を使用する方法がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">メモリを介した連携</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">メモリを共有することで、アクセストークンを連携する方法。</div>
<div class="line">リソースサーバと認可サーバが一つのプロセスとなるようアプリケーションを設計している場合に利用可能。</div>
<div class="line">認可サーバはTokenServiceの実装として<code class="docutils literal"><span class="pre">DefaultTokenServices</span></code>を、TokenStoreの実装として<code class="docutils literal"><span class="pre">InMemoryTokenStore</span></code>を指定する。</div>
<div class="line">メモリを介して連携させるため、共有DBやHTTPアクセスによるアクセストークンの連携が不要となる。</div>
<div class="line">メモリを介してアクセストークンを共有する実装はサーバ再起動などでアクセストークンが失われるため、テスト用途専用の実装である。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p class="last">JWTを利用した連携の実装方法については、次版以降で詳細化する予定である。</p>
</div>
<p>ここでは、代表的な連携方法として共有DBを介して連携させる方法を説明する。
HTTPアクセスを介した連携ついては本節のHow To Extendにて説明している。</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="#oauthauthorizationserverhowtocooperatewithhttp"><span class="std std-ref">HTTPアクセスを介した連携</span></a></li>
</ul>
</div></blockquote>
<p>共有DBを介して連携させる場合、Spring Security OAuthが提供している<code class="docutils literal"><span class="pre">JdbcTokenStore</span></code>を使用する。</p>
<p>実装例は以下のとおりである。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
     <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span>
     <span class="na">token-endpoint-url=</span><span class="s">&quot;/oth2/token&quot;</span>
     <span class="na">authorization-endpoint-url=</span><span class="s">&quot;/oth2/authorize&quot;</span>
     <span class="na">user-approval-handler-ref=</span><span class="s">&quot;userApprovalHandler&quot;</span>
     <span class="na">token-services-ref=</span><span class="s">&quot;tokenServices&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;oauth2:authorization-code</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:implicit</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:client-credentials</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:password</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;tokenServices&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.DefaultTokenServices&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;tokenStore&quot;</span> <span class="na">ref=</span><span class="s">&quot;tokenStore&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;clientDetailsService&quot;</span> <span class="na">ref=</span><span class="s">&quot;clientDetailsService&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;supportRefreshToken&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;tokenStore&quot;</span>
  <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.store.JdbcTokenStore&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
  <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;tokenDataSource&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバが使用するTokenServiceとして<code class="docutils literal"><span class="pre">token-services-ref</span></code>属性に(2)で定義している<code class="docutils literal"><span class="pre">tokenServices</span></code>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">tokenServices</span></code>のクラスに<code class="docutils literal"><span class="pre">DefaultTokenServices</span></code>を指定する。</div>
<div class="line">アクセストークンを管理するトークンストアとして、<code class="docutils literal"><span class="pre">tokenStore</span></code>プロパティに(4)で定義している<code class="docutils literal"><span class="pre">TokenStore</span></code>を指定する。</div>
<div class="line">共有DBを介してリソースサーバとアクセストークンの連携を行う場合、リソースサーバでも本設定を行うこと。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リフレッシュトークンを有効にする場合は<code class="docutils literal"><span class="pre">supportRefreshToken</span></code>属性に<code class="docutils literal"><span class="pre">true</span></code>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">トークンストアとして <code class="docutils literal"><span class="pre">JdbcTokenStore</span></code>をBean定義する。</div>
<div class="line">コンストラクタには、トークン情報格納用のテーブルに接続するためのデータソースを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><code class="docutils literal"><span class="pre">JdbcTokenStore</span></code>がアクセストークンを連携するために、Spring Security OAuthがスキーマ定義している以下のDBを作成する。
以下の例では共有DBとしてPostgreSQLを使用した場合のDB定義を説明する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ERDiagramToken.png"><img alt="../_images/OAuth_ERDiagramToken.png" src="../_images/OAuth_ERDiagramToken.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークンを管理するテーブル。認可サーバで発行したアクセストークンの情報をリソースサーバと共有するために使用する。</div>
<div class="line">各カラムの役割は以下のとおりである。</div>
<div class="line-block">
<div class="line">・authentication_id：認証情報を一意に識別する認証キーを保持するカラム。主キーとする。</div>
<div class="line">・token：トークンの情報をシリアル化してバイナリとして保持するカラム。保持するトークンの情報としては、アクセストークンの有効期限、スコープ、アクセストークンのトークンID、リフレッシュトークンのトークンID、使用しているトークンの種類を表すトークンタイプを保持する。</div>
<div class="line">・token_id：アクセストークンを一意に識別するトークンIDを保持するカラム。</div>
<div class="line">・user_name：認証されたリソースオーナのユーザ名を保持するカラム。</div>
<div class="line">・client_id：認証されたクライアントのクライアントIDを保持するカラム。</div>
<div class="line">・authentication：リソースオーナとクライアントの認証情報をシリアル化してバイナリとして保持するカラム。</div>
<div class="line">・refresh_token：アクセストークンに紐付くリフレッシュトークンのトークンIDを保持するカラム。</div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークンに紐付くリフレッシュトークンを管理するテーブル。</div>
<div class="line">各カラムの役割は以下のとおりである。</div>
<div class="line-block">
<div class="line">・token_id：リフレッシュトークンを一意に識別するトークンIDを保持するカラム。主キーとする。</div>
<div class="line">・token：トークンの情報をシリアル化してバイナリとして保持するカラム。リフレッシュトークンの有効期限を保持する。</div>
<div class="line">・authentication：リソースオーナとクライアントの認証情報をシリアル化してバイナリとして保持するカラム。アクセストークンを管理するテーブルで保持している認証情報と同じ情報を保持する。</div>
</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">共有DBでトークンを管理する場合、有効期限切れとなったトークンはクライアントがアクセストークンを利用するタイミングに削除される。
そのためトークンが有効期限切れになったとしても、クライアントがアクセストークンを利用しなければ削除されない。
有効期限切れとなったトークンをDBから削除するためには、バッチ処理等で別途パージを行う必要がある。</p>
</div>
</div>
<div class="section" id="oauthauthorizationserverhowtocanceltoken">
<span id="id23"></span><h4><a class="toc-backref" href="#id84">9.9.2.3.9. トークンの取り消し（認可サーバ）</a><a class="headerlink" href="#oauthauthorizationserverhowtocanceltoken" title="Permalink to this headline">¶</a></h4>
<p>発行したアクセストークンの取り消しの実装方法について説明する。</p>
<p>アクセストークンの取り消しは、インタフェース<code class="docutils literal"><span class="pre">ConsumerTokenService</span></code>を実装したクラスの
<code class="docutils literal"><span class="pre">revokeToken</span></code>メソッドを呼び出すことで実現できる。
クラス <code class="docutils literal"><span class="pre">DefaultTokenService</span></code>はインタフェース<code class="docutils literal"><span class="pre">ConsumerTokenService</span></code>を実装している。</p>
<p>アクセストークンの取り消し時に認可情報も削除することが可能である。
認可コードグラントやインプリシットグラントを使用している場合に、アクセストークンの取り消し後に認可情報を削除せずに認可リクエストを行うと、前回の認可リクエスト時の認可情報が再利用される場合がある。
前回の認可リクエスト時の認可情報は、認可情報の有効期限が有効であり、認可リクエストしたスコープが全て認可されている場合に再利用される。</p>
<p>以下に、実装例を示す。</p>
<p>トークンの取り消しを行うサービスクラスのインタフェースと実装クラスを作成する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">RevokeTokenService.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RevokeTokenService</span> <span class="p">{</span>

    <span class="n">String</span> <span class="nf">revokeToken</span><span class="p">(</span><span class="n">String</span> <span class="n">tokenValue</span><span class="p">,</span> <span class="n">String</span> <span class="n">clientId</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">RevokeTokenServiceImpl.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RevokeTokenServiceImpl</span> <span class="kd">implements</span> <span class="n">RevokeTokenService</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ConsumerTokenServices</span> <span class="n">consumerService</span><span class="p">;</span> <span class="c1">// (1)</span>

    <span class="nd">@Inject</span>
    <span class="n">TokenStore</span> <span class="n">tokenStore</span><span class="p">;</span> <span class="c1">// (2)</span>

    <span class="nd">@Inject</span>
    <span class="n">ApprovalStore</span> <span class="n">approvalStore</span><span class="p">;</span> <span class="c1">// (3)</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">revokeToken</span><span class="p">(</span><span class="n">String</span> <span class="n">tokenValue</span><span class="p">,</span> <span class="n">String</span> <span class="n">clientId</span><span class="p">){</span> <span class="c1">// (4)</span>
        <span class="c1">// (5)</span>
        <span class="n">OAuth2Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="n">tokenStore</span><span class="p">.</span><span class="na">readAuthentication</span><span class="p">(</span><span class="n">tokenValue</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">authentication</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">clientId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">authentication</span><span class="p">.</span><span class="na">getOAuth2Request</span><span class="p">().</span><span class="na">getClientId</span><span class="p">()))</span> <span class="p">{</span> <span class="c1">// (6)</span>
                <span class="c1">// (7)</span>
                <span class="n">Authentication</span> <span class="n">user</span> <span class="o">=</span> <span class="n">authentication</span><span class="p">.</span><span class="na">getUserAuthentication</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">user</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Approval</span><span class="o">&gt;</span> <span class="n">approvals</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Approval</span><span class="o">&gt;</span><span class="p">();</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">String</span> <span class="n">scope</span> <span class="p">:</span> <span class="n">authentication</span><span class="p">.</span><span class="na">getOAuth2Request</span><span class="p">().</span><span class="na">getScope</span><span class="p">())</span> <span class="p">{</span>
                        <span class="n">approvals</span><span class="p">.</span><span class="na">add</span><span class="p">(</span>
                                <span class="k">new</span> <span class="n">Approval</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getName</span><span class="p">(),</span> <span class="n">clientId</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="k">new</span> <span class="n">Date</span><span class="p">(),</span> <span class="n">ApprovalStatus</span><span class="p">.</span><span class="na">APPROVED</span><span class="p">));</span>
                    <span class="p">}</span>
                    <span class="n">approvalStore</span><span class="p">.</span><span class="na">revokeApprovals</span><span class="p">(</span><span class="n">approvals</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">consumerService</span><span class="p">.</span><span class="na">revokeToken</span><span class="p">(</span><span class="n">tokenValue</span><span class="p">);</span> <span class="c1">// (8)</span>
                <span class="k">return</span> <span class="s">&quot;success&quot;</span><span class="p">;</span>

            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="s">&quot;invalid client&quot;</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s">&quot;invalid token&quot;</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークンの取り消しを行うインタフェース<code class="docutils literal"><span class="pre">ConsumerTokenService</span></code>の実装クラスをインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークン発行時の認証情報を取得するために使用する<code class="docutils literal"><span class="pre">TokenStore</span></code>の実装クラスをインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークンの発行時の認可情報を取得するために使用する<code class="docutils literal"><span class="pre">ApprovalStore</span></code>の実装クラスをインジェクションする。</div>
<div class="line">アクセストークンの取り消し時に認可情報を削除しない場合は不要となる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取り消しを行うアクセストークンの値と、クライアントのチェックを行うために使用するクライアントIDをパラメータとして受け取る。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">TokenStore</span></code>の実装クラスの<code class="docutils literal"><span class="pre">readAuthentication</span></code>メソッドを呼び出し、アクセストークンを発行した際の認証情報を取得する。</div>
<div class="line">認証情報が正常に取得できた場合のみ、トークンの削除処理を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証情報より、アクセストークン発行時に使用したクライアントIDを取得し、リクエストパラメータのクライアントIDと一致するかを確認する。</div>
<div class="line">アクセストークン発行時のクライアントIDと一致する場合のみ、アクセストークンの削除を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証情報より、アクセストークン発行時のリソースオーナの認証情報を取得する。</div>
<div class="line">リソースオーナの認証情報が取得できた場合、<code class="docutils literal"><span class="pre">TokenStore</span></code>の実装クラスの<code class="docutils literal"><span class="pre">revokeApprovals</span></code>メソッドを呼び出し、認可情報の削除を行う。</div>
<div class="line">クライアントクレデンシャルグラントを使用している場合はリソースオーナの認証情報が存在しないため、<code class="docutils literal"><span class="pre">revokeApprovals</span></code>メソッドに渡すパラメータが生成できない。</div>
<div class="line">そのため、リソースオーナの認証情報が取得できない場合は認可情報の削除処理は行わない。</div>
<div class="line">アクセストークンの取り消し時に認可情報を削除しない場合、この処理は不要となる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ConsumerTokenService</span></code>の実装クラスの<code class="docutils literal"><span class="pre">revokeToken</span></code>メソッドを呼び出し、アクセストークンとアクセストークンに紐付くリフレッシュトークンの削除を行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>トークンの取り消しリクエストを受けるコントローラを作成する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">TokenRevocationRestController.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;oth2&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TokenRevocationRestController</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">RevokeTokenService</span> <span class="n">revokeTokenService</span><span class="p">;</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;tokens/revoke&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span> <span class="c1">// (1)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">revoke</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="p">(</span><span class="s">&quot;token&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">token</span><span class="p">,</span>
        <span class="nd">@AuthenticationPrincipal</span> <span class="n">UserDetails</span> <span class="n">user</span><span class="p">){</span>

        <span class="c1">// (2)</span>
        <span class="n">String</span> <span class="n">clientId</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="na">getUsername</span><span class="p">();</span>
        <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">revokeTokenService</span><span class="p">.</span><span class="na">revokeToken</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">clientId</span><span class="p">);</span> <span class="c1">// (3)</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>アノテーションを使用して、<code class="docutils literal"><span class="pre">&quot;/oth2/tokens/revoke&quot;</span></code>へのアクセスに対するメソッドとしてマッピングを行う。</div>
<div class="line">ここで指定するパスは<a class="reference internal" href="#oauthauthorizationserverclientauthentication"><span class="std std-ref">クライアントの認証</span></a>で行った設定と同様に、Basic認証の適用とCSRF対策機能の無効化を行う必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Basic認証で生成された認証情報からトークンの取り消し時のチェックで使用するクライアントIDを取得する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RevokeTokenService</span></code>を呼び出し、トークンの取り消しを行う。</div>
<div class="line">リクエストパラメータとして受け取ったアクセストークンの値と、認証情報から取得したクライアントIDをパラメータとして渡す。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">RFC 7009ではリクエストパラメータとして<code class="docutils literal"><span class="pre">token_type_hint</span></code>を任意で付与してよいことが記載されている。
<code class="docutils literal"><span class="pre">token_type_hint</span></code>は削除対象のトークンがアクセストークンとリフレッシュトークンのどちらであるかを判別するためのヒントである。
Spring Security OAuthが提供する<code class="docutils literal"><span class="pre">ConsumerTokenService</span></code>はアクセストークンを渡すことでアクセストークンとリフレッシュトークンの両方削除するため、上記の実装例では使用していない。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">認可サーバにトークンの取り消しをリクエストしたクライアントは、認可サーバの削除後にクライアントで保持しているトークンも取り消す必要がある。
クライアントサーバのトークンの取り消しについては<a class="reference internal" href="#oauthclientserverhowtocanceltoken"><span class="std std-ref">トークンの取り消し（クライアントサーバ）</span></a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauthauthorizationserverhowtocontrolltarnsaction">
<span id="id24"></span><h4><a class="toc-backref" href="#id85">9.9.2.3.10. トランザクション制御</a><a class="headerlink" href="#oauthauthorizationserverhowtocontrolltarnsaction" title="Permalink to this headline">¶</a></h4>
<p>認可サーバにおけるトランザクション制御の注意点について説明する。</p>
<p>認可サーバにおいてSpring Security OAuthが取り扱う情報（認可コード、認可情報、トークン）をDBにて管理する場合には、トランザクション制御の考慮が必要となる。</p>
<p><code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code>のデフォルト実装である<code class="docutils literal"><span class="pre">DefaultTokenServices</span></code>ではアクセストークン、リフレッシュトークンを発行するメソッドである
<code class="docutils literal"><span class="pre">createAccessToken</span></code>、<code class="docutils literal"><span class="pre">refreshAccessToken</span></code>にそれぞれ<code class="docutils literal"><span class="pre">&#64;Transactional</span></code>が付与されていることでトランザクション管理下で呼び出しが行われるが、それ以外は非トランザクション管理となる。</p>
<p>そのため、<code class="docutils literal"><span class="pre">DataSource</span></code>から取得する<code class="docutils literal"><span class="pre">Connection</span></code>の設定が<code class="docutils literal"><span class="pre">autoCommit=false</span></code>となっている場合、管理対象となる情報がDBに登録されないためトランザクション管理が必須である。
また、<code class="docutils literal"><span class="pre">autoCommit=true</span></code>の場合は必須ではないが、データの一貫性を担保するためのトランザクション管理の考慮が必要となるため、注意すること。</p>
<p>認可コード、認可情報をDBにて管理する場合のトランザクション制御設定例を以下に示す。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;tx:advice</span> <span class="na">id=</span><span class="s">&quot;oauthTransactionAdvice&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;tx:attributes&gt;</span>
        <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">&quot;*&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/tx:attributes&gt;</span>
<span class="nt">&lt;/tx:advice&gt;</span>

<span class="nt">&lt;aop:config&gt;</span>
    <span class="nt">&lt;aop:pointcut</span> <span class="na">id=</span><span class="s">&quot;authorizationOperation&quot;</span>
                  <span class="na">expression=</span><span class="s">&quot;execution(* org.springframework.security.oauth2.provider.code.AuthorizationCodeServices.*(..))&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;aop:pointcut</span> <span class="na">id=</span><span class="s">&quot;approvalOperation&quot;</span>
                  <span class="na">expression=</span><span class="s">&quot;execution(* org.springframework.security.oauth2.provider.approval.UserApprovalHandler.*(..))&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;aop:advisor</span> <span class="na">pointcut-ref=</span><span class="s">&quot;authorizationOperation&quot;</span> <span class="na">advice-ref=</span><span class="s">&quot;oauthTransactionAdvice&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;aop:advisor</span> <span class="na">pointcut-ref=</span><span class="s">&quot;approvalOperation&quot;</span> <span class="na">advice-ref=</span><span class="s">&quot;oauthTransactionAdvice&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/aop:config&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">AOPを使用し、認可コードを操作する各メソッドにトランザクション境界を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">AOPを使用し、認可情報を操作する各メソッドにトランザクション境界を設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id25">
<h3><a class="toc-backref" href="#id86">9.9.2.4. リソースサーバの実装</a><a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h3>
<p>ここではTODOリソースのREST APIに対して認可設定を行う実装例を用いて、リソースサーバの実装方法について説明する。</p>
<div class="section" id="id26">
<h4><a class="toc-backref" href="#id87">9.9.2.4.1. 設定ファイルの作成（リソースサーバ）</a><a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h4>
<p>リソースサーバを実装する際には新たにOAuth 2.0用のBean定義ファイルを作成する。</p>
<p>ここでは <code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code>とする。</p>
<p><code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code>には以下の設定を追加する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xmlns:oauth2=</span><span class="s">&quot;http://www.springframework.org/schema/security/oauth2&quot;</span>
       <span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/security</span>
<span class="s">           http://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">           http://www.springframework.org/schema/security/oauth2</span>
<span class="s">           http://www.springframework.org/schema/security/spring-security-oauth2.xsd</span>
<span class="s">           http://www.springframework.org/schema/beans</span>
<span class="s">           http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;sec:http</span> <span class="na">pattern=</span><span class="s">&quot;/api/v1/todos/**&quot;</span> <span class="na">create-session=</span><span class="s">&quot;stateless&quot;</span>
                   <span class="na">entry-point-ref=</span><span class="s">&quot;oauth2AuthenticationEntryPoint&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;sec:access-denied-handler</span> <span class="na">ref=</span><span class="s">&quot;oauth2AccessDeniedHandler&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;sec:csrf</span> <span class="na">disabled=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
        <span class="nt">&lt;sec:custom-filter</span> <span class="na">ref=</span><span class="s">&quot;oauth2AuthenticationFilter&quot;</span>
                                <span class="na">before=</span><span class="s">&quot;PRE_AUTH_FILTER&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
    <span class="nt">&lt;/sec:http&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;oauth2AccessDeniedHandler&quot;</span>
              <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.error.OAuth2AccessDeniedHandler&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (5) --&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;oauth2AuthenticationEntryPoint&quot;</span>
              <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.error.OAuth2AuthenticationEntryPoint&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (6) --&gt;</span>

    <span class="nt">&lt;oauth2:resource-server</span> <span class="na">id=</span><span class="s">&quot;oauth2AuthenticationFilter&quot;</span> <span class="na">resource-id=</span><span class="s">&quot;todoResource&quot;</span>
              <span class="na">token-services-ref=</span><span class="s">&quot;tokenServices&quot;</span> <span class="na">entry-point-ref=</span><span class="s">&quot;oauth2AuthenticationEntryPoint&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (7) --&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">pattern</span></code>属性にはOAuth 2.0の認可設定の対象とするパスのパターンを指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">entry-point-ref</span></code>には<code class="docutils literal"><span class="pre">OAuth2AuthenticationEntryPoint</span></code>のBeanを指定する。ここでの設定は定義上必要だが指定したBeanは使用されない。
実際に使用されるのは後述する<code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code>に指定している<code class="docutils literal"><span class="pre">OAuth2AuthenticationEntryPoint</span></code>のBeanである。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">access-denied-handler</span></code>には<code class="docutils literal"><span class="pre">OAuth2AccessDeniedHandler</span></code>のBeanを設定する。ここでは後述する<code class="docutils literal"><span class="pre">oauth2AccessDeniedHandler</span></code>を指定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">CSRFトークンチェックによってPOST、PUT、DELETEといったリクエストを受けると必ずエラーになるため、CSRFを無効にする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">custom-filter</span></code>にはリソースサーバ用の認証フィルタを指定する。ここでは後述する<code class="docutils literal"><span class="pre">oauth2AuthenticationFilter</span></code>を指定している。</div>
<div class="line">この指定により<code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code>が設定される。</div>
<div class="line"><code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code>はリクエストに含まれるアクセストークンを利用してPre-Authenticationを行うためのフィルタであるため、</div>
<div class="line"><code class="docutils literal"><span class="pre">before</span></code>に<code class="docutils literal"><span class="pre">PRE_AUTH_FILTER</span></code>を指定し<code class="docutils literal"><span class="pre">PRE_AUTH_FILTER</span></code>の前に<code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code>の処理が実行されるように設定する。</div>
<div class="line">Pre-Authenticationについては<a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.0.x/reference/preauth.html">こちら</a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring Security OAuthが提供するリソースサーバ用の<code class="docutils literal"><span class="pre">AccessDeniedHandler</span></code>を定義する。</div>
<div class="line"><code class="docutils literal"><span class="pre">OAuth2AccessDeniedHandler</span></code>は、認可エラー時に発生する例外をハンドリングしてエラー応答を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OAuth用のエラー応答を行うための<code class="docutils literal"><span class="pre">OAuth2AuthenticationEntryPoint</span></code>をBean定義する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring Security OAuthが提供するリソースサーバ用のServletFilterを定義する。</div>
<div class="line"><code class="docutils literal"><span class="pre">id</span></code>属性に指定した文字列はBeanのIDとなる。ここでは <code class="docutils literal"><span class="pre">oauth2AuthenticationFilter</span></code>を指定している。</div>
<div class="line"><code class="docutils literal"><span class="pre">resource-id</span></code>属性にはサーバが提供するリソースのIDを指定する。ここでは<code class="docutils literal"><span class="pre">todoResource</span></code>を指定している。</div>
<div class="line">アクセストークンに紐付くクライアント情報のリソースIDに対し、<code class="docutils literal"><span class="pre">resource-id</span></code>属性に指定したリソースIDが含まれているか検証が行われる。</div>
<div class="line">検証の結果、リソースIDが含まれている場合のみリソースに対してのアクセスを許可する。</div>
<div class="line">なお、<code class="docutils literal"><span class="pre">resource-id</span></code>の定義は任意であり、定義しない場合はリソースIDの検証が行われない。</div>
<div class="line"><code class="docutils literal"><span class="pre">token-services-ref</span></code>属性には<code class="docutils literal"><span class="pre">TokenServices</span></code>のIDを指定する。<code class="docutils literal"><span class="pre">TokenServices</span></code>については後述する。</div>
<div class="line"><code class="docutils literal"><span class="pre">entry-point-reff</span></code>属性には<code class="docutils literal"><span class="pre">OAuth2AuthenticationEntryPoint</span></code>のBeanを指定する。ここでは<code class="docutils literal"><span class="pre">oauth2AuthenticationEntryPoint</span></code>を指定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>作成した<code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code>を読み込むように<code class="docutils literal"><span class="pre">web.xml</span></code>に設定を追加する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">web.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;context-param&gt;</span>
    <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
    <span class="nt">&lt;param-value&gt;</span>
        classpath*:META-INF/spring/applicationContext.xml
        classpath*:META-INF/spring/oauth2-resource.xml <span class="c">&lt;!-- (1) --&gt;</span>
        classpath*:META-INF/spring/spring-security.xml
    <span class="nt">&lt;/param-value&gt;</span>
<span class="nt">&lt;/context-param&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">oauth2-resource.xmlで設定したパスのパターンを内包するようなパスが <code class="docutils literal"><span class="pre">spring-security.xml</span></code>にアクセス制御対象として設定されている場合を考慮し、先にoauth2-resource.xmlを読み込むようにする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id28">
<h4><a class="toc-backref" href="#id88">9.9.2.4.2. リソースにアクセス可能なスコープの設定</a><a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h4>
<p>リソースごとにアクセス可能なスコープを定義するために、OAuth 2.0用のBean定義ファイルに
スコープの定義とSpEL式をサポートするためのBean定義を追加する。</p>
<p>実装例は以下のとおりである。
なお、認可サーバ、リソース間でセキュリティが担保されていることを前提としているため、アクセス制御の設定において、クライアントに対するBasic認証は行っていない。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xmlns:oauth2=</span><span class="s">&quot;http://www.springframework.org/schema/security/oauth2&quot;</span>
       <span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/security</span>
<span class="s">           http://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">           http://www.springframework.org/schema/security/oauth2</span>
<span class="s">           http://www.springframework.org/schema/security/spring-security-oauth2.xsd</span>
<span class="s">           http://www.springframework.org/schema/beans</span>
<span class="s">           http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;sec:http</span> <span class="na">pattern=</span><span class="s">&quot;/api/v1/todos/**&quot;</span> <span class="na">create-session=</span><span class="s">&quot;stateless&quot;</span>
                   <span class="na">entry-point-ref=</span><span class="s">&quot;oauth2AuthenticationEntryPoint&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;sec:access-denied-handler</span> <span class="na">ref=</span><span class="s">&quot;oauth2AccessDeniedHandler&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;sec:csrf</span> <span class="na">disabled=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;sec:expression-handler</span> <span class="na">ref=</span><span class="s">&quot;oauth2ExpressionHandler&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/**&quot;</span> <span class="na">method=</span><span class="s">&quot;GET&quot;</span>
                                <span class="na">access=</span><span class="s">&quot;#oauth2.hasScope(&#39;READ&#39;)&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/**&quot;</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span>
                                <span class="na">access=</span><span class="s">&quot;#oauth2.hasScope(&#39;CREATE&#39;)&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;sec:custom-filter</span> <span class="na">ref=</span><span class="s">&quot;oauth2ProviderFilter&quot;</span>
                                <span class="na">before=</span><span class="s">&quot;PRE_AUTH_FILTER&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/sec:http&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;oauth2:web-expression-handler</span> <span class="na">id=</span><span class="s">&quot;oauth2ExpressionHandler&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">expression-handler</span></code>には<code class="docutils literal"><span class="pre">OAuth2WebSecurityExpressionHandler</span></code>のBeanを指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">intercept-url</span></code>を使用してリソースに対してスコープによるアクセスポリシーを定義する。</div>
<div class="line"><code class="docutils literal"><span class="pre">pattern</span></code>属性には保護したいリソースのパスのパターンを指定する。本実装例では /api/v1/todos/ 配下のリソースが保護される。</div>
<div class="line"><code class="docutils literal"><span class="pre">method</span></code>属性にはリソースのHTTPメソッドを指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">access</span></code>属性にはリソースへのアクセスを認可するscopeを指定する。設定値は大文字、小文字を区別する。</div>
<div class="line">ここではSpEL式を用いて指定を行っている。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2WebSecurityExpressionHandler</span></code>をBean定義する。</div>
<div class="line">このBeanを定義することでSpring Security OAuthが提供するOAuth 2.0の認可設定を行うためのSpELがサポートされる。</div>
<div class="line">なお、<code class="docutils literal"><span class="pre">id</span></code>属性に指定した値がこのbeanのidとなる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Spring Security OAuthが用意している主なExpressionを紹介する。</p>
<p>詳細については<code class="docutils literal"><span class="pre">OAuth2SecurityExpressionMethods</span></code>の<a class="reference external" href="http://docs.spring.io/spring-security/oauth/apidocs/org/springframework/security/oauth2/provider/expression/OAuth2SecurityExpressionMethods.html">JavaDoc</a>を参照されたい。</p>
<table border="1" class="colwidths-given docutils" id="id58">
<caption><span class="caption-text"><strong>Spring Security OAuthが用意しているExpression</strong></span><a class="headerlink" href="#id58" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Expression</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">clientHasRole(String</span> <span class="pre">role)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントが引数に指定されたロールを持っている場合に<code class="docutils literal"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">clientHasAnyRole(String...</span> <span class="pre">roles)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントが引数に指定されたいずれかのロールを持っている場合に<code class="docutils literal"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">hasScope(String</span> <span class="pre">scope)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントがリソースオーナから認可されているスコープと引数のスコープが一致する場合に<code class="docutils literal"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">hasAnyScope(String...</span> <span class="pre">scopes)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントがリソースオーナから認可されているスコープと引数のスコープのいずれかが一致する場合に<code class="docutils literal"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">hasScopeMatching(String</span> <span class="pre">scopeRegex)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントがリソースオーナから認可されているスコープと引数に指定された正規表現が一致する場合に<code class="docutils literal"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">hasAnyScopeMatching(String...</span> <span class="pre">scopesRegex)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントがリソースオーナから認可されているスコープと引数に指定されたいずれかの正規表現が一致する場合に<code class="docutils literal"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">denyOAuthClient</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OAuth 2.0でのリクエストを拒否する。リソースオーナのみがリソースにアクセスできるようにするために使用される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">isOAuth</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OAuth 2.0でのリクエストを許可する。クライアントがリソースにアクセスできるようにするために使用される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>SpEL式についてはSpring Securityが提供するSpELを合わせて使用することができる。</p>
<p class="last">Spring Securityが提供するSpELについては <a class="reference internal" href="Authorization.html#id6"><span class="std std-ref">Built-InのWeb Expressions</span></a> を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id29">
<h4><a class="toc-backref" href="#id89">9.9.2.4.3. アクセストークンに関する設定（リソースサーバ）</a><a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h4>
<p>認可サーバとリソースサーバはアクセストークンを<code class="docutils literal"><span class="pre">TokenServices</span></code>を介して連携する。</p>
<p>連携方法の種類については<a class="reference internal" href="#oauthauthorizationserverhowtoconfigureaccesstoken"><span class="std std-ref">リソースサーバとのアクセストークン共有方法</span></a>を参照されたい。</p>
<p>ここではデータベースを共有する方法で設定を行う。</p>
<p>設定の解説については認可サーバでの<code class="docutils literal"><span class="pre">TokenServices</span></code>の設定と同様なため<a class="reference internal" href="#oauthauthorizationserverhowtoconfigureaccesstoken"><span class="std std-ref">リソースサーバとのアクセストークン共有方法</span></a>を参照されたい。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;tokenServices&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.DefaultTokenServices&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;tokenStore&quot;</span> <span class="na">ref=</span><span class="s">&quot;tokenStore&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;tokenStore&quot;</span>
  <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.store.JdbcTokenStore&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;tokenDataSource&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">認可サーバとリソースサーバを連携させる方法として、Spring Security OAuthで提供されている<code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>を利用する方法や、
JSON Web Tokenを利用する方法がある。
Spring Security OAuthで提供されている<code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>を利用する方法については<a class="reference internal" href="#oauthauthorizationserverhowtocooperatewithhttp"><span class="std std-ref">HTTPアクセスを介した連携</span></a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id30">
<h4><a class="toc-backref" href="#id90">9.9.2.4.4. ユーザ情報の取得</a><a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h4>
<p>リソースサーバでは、<a class="reference internal" href="Authentication.html#springsecurityauthenticationintegrationwithspringmvc"><span class="std std-ref">認証処理とSpring MVCの連携</span></a>で説明されている認証情報の取得方法と同様に、Controllerクラスのメソッド引数に<code class="docutils literal"><span class="pre">UserDetails</span></code>を指定し<code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>アノテーションを付与することにより認証されたリソースオーナの情報を受け取ることができる。
以下に実装例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;api&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;todos&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">list</span><span class="p">(</span><span class="nd">@AuthenticationPrincipal</span> <span class="n">UserDetails</span> <span class="n">user</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (1)</span>

        <span class="c1">// omitted</span>

    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数 <code class="docutils literal"><span class="pre">user</span></code>にリソースオーナの認証情報が格納される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><code class="docutils literal"><span class="pre">UserDetails</span></code>を指定した実装の場合、認証処理が行われないクライアントクレデンシャルグラントでは意図した情報が取得できないため注意が必要である。
クライアントクレデンシャルグラントを使用する場合は、Controllerのメソッド引数として<code class="docutils literal"><span class="pre">String</span></code>を指定し<code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>アノテーションを付与することによりクライアントIDを取得することができる。</p>
<p>また、<code class="docutils literal"><span class="pre">UserDetails</span></code>を指定した実装の場合、クライアントID等のクライアントの認証情報は取得できない。
クライアントの認証情報を取得する場合は、Controllerクラスのメソッド引数に<code class="docutils literal"><span class="pre">OAuth2Authentication</span></code>を指定することで可能である。
以下にControllerクラスのメソッド引数に<code class="docutils literal"><span class="pre">OAuth2Authentication</span></code>を指定してクライアントとリソースオーナの認証情報を取得する例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;api&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;todos&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">list</span><span class="p">(</span><span class="n">OAuth2Authentication</span> <span class="n">authentication</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (1)</span>

        <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">authentication</span><span class="p">.</span><span class="na">getUserAuthentication</span><span class="p">().</span><span class="na">getName</span><span class="p">();</span> <span class="c1">// (2)</span>
        <span class="n">String</span> <span class="n">clientId</span> <span class="o">=</span> <span class="n">authentication</span><span class="p">.</span><span class="na">getOAuth2Request</span><span class="p">().</span><span class="na">getClientId</span><span class="p">();</span>  <span class="c1">// (3)</span>

        <span class="c1">// omitted</span>

    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数 <code class="docutils literal"><span class="pre">authentication</span></code>にリソースオーナ、クライアントの認証情報が格納される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">authentication</span></code>よりリソースオーナ名を取得する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">authentication</span></code>よりクライアントIDを取得する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">上記はアプリケーション層で<code class="docutils literal"><span class="pre">OAuth2Authentication</span></code>を使用する場合の実装例である。
<code class="docutils literal"><span class="pre">OAuth2Authentication</span></code>に依存しない実装を行いたい場合<code class="docutils literal"><span class="pre">HandlerMethodArgumentResolver</span></code>を実装することで同様の機能が実現可能である。
具体的な実装方法については、<a class="reference internal" href="../ImplementationAtEachLayer/ApplicationLayer.html#methodargumentresolver"><span class="std std-ref">HandlerMethodArgumentResolverの実装</span></a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id31">
<h3><a class="toc-backref" href="#id91">9.9.2.5. クライアントの実装</a><a class="headerlink" href="#id31" title="Permalink to this headline">¶</a></h3>
<p>クライアントの実装方法は、使用するグラントタイプにより、大きく以下の２つに分類される。</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">実装方法</th>
<th class="head">グラントタイプ</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">OAuth2RestTemplate</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可コードグラント</div>
<div class="line">リソースオーナパスワードクレデンシャルグラント</div>
<div class="line">クライアントクレデンシャルグラント</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">Javascript</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">インプリシットグラント</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>本ガイドラインでは、上記の分類にて<a class="reference internal" href="#oauthclientusingoauth2resttemplate"><span class="std std-ref">OAuth2RestTemplateを使用したリソースへのアクセス</span></a>、<a class="reference internal" href="#oauthclientusingjavascript"><span class="std std-ref">JavaScriptを使用したリソースへのアクセス</span></a>をそれぞれ説明する。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="oauth2resttemplate">
<span id="oauthclientusingoauth2resttemplate"></span><h4><a class="toc-backref" href="#id92">9.9.2.5.1. OAuth2RestTemplateを使用したリソースへのアクセス</a><a class="headerlink" href="#oauth2resttemplate" title="Permalink to this headline">¶</a></h4>
<p>認可コードグラント、リソースオーナパスワードクレデンシャルグラント、クライアントクレデンシャルグラント向けの
クライアントの実装として、<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を使用してリソースへのアクセスを実現する方法を説明する。</p>
<p>Spring Security OAuthでは、<code class="docutils literal"><span class="pre">RestOperations</span></code>のOAuth 2.0向けの実装として<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を提供している。</p>
<p><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>では、OAuth 2.0独自の機能として、<code class="docutils literal"><span class="pre">AccessTokenProvider</span></code>によるグラントタイプに応じた
アクセストークンの取得や、<code class="docutils literal"><span class="pre">OAuth2ClientContext</span></code>による複数リクエスト間でのアクセストークンの共有、リソースサーバへのアクセス時のエラーハンドリングといった機能を実装している。</p>
<p>クライアントでは、<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を利用し、グラントタイプやスコープなどのアプリケーション要件に沿った
パラメータを定義することで、OAuth 2.0機能を使用したリソースへのアクセスが可能となる。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="id32">
<h5><a class="toc-backref" href="#id93">9.9.2.5.1.1. 設定ファイルの作成（クライアント）</a><a class="headerlink" href="#id32" title="Permalink to this headline">¶</a></h5>
<p>まず、OAuth 2.0に関する定義を行うための設定ファイルとして<code class="docutils literal"><span class="pre">oauth2-client.xml</span></code>を作成する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
    <span class="na">xmlns:oauth2=</span><span class="s">&quot;http://www.springframework.org/schema/security/oauth2&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;</span>
<span class="s">        http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">        http://www.springframework.org/schema/security/oauth2 http://www.springframework.org/schema/security/spring-security-oauth2.xsd</span>
<span class="s">    &quot;</span><span class="nt">&gt;</span>


<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p><code class="docutils literal"><span class="pre">web.xml</span></code>に、作成した<code class="docutils literal"><span class="pre">oauth2-client.xml</span></code>を読み込む設定を追加する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">web.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;context-param&gt;</span>
    <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
    <span class="nt">&lt;param-value&gt;</span>
        classpath*:META-INF/spring/applicationContext.xml
        classpath*:META-INF/spring/oauth2-client.xml  <span class="c">&lt;!-- (1) --&gt;</span>
        classpath*:META-INF/spring/spring-security.xml
    <span class="nt">&lt;/param-value&gt;</span>
<span class="nt">&lt;/context-param&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code>を読み込むように設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauth2clientcontextfilter">
<h5><a class="toc-backref" href="#id94">9.9.2.5.1.2. OAuth2ClientContextFilterの適用</a><a class="headerlink" href="#oauth2clientcontextfilter" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>をサーブレットフィルタとして登録する。</p>
<p><code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>を登録することでリソースオーナによる認可が取得できていない状態でリソースサーバへのアクセスを試みた場合に
発生する<code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code>を捕捉し、認可サーバが提供するリソースオーナの認可を取得するためのページへリダイレクトする
機能を組み込むことができる。</p>
<p><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code>には以下の設定を追加する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:client</span> <span class="na">id=</span><span class="s">&quot;oauth2ClientContextFilter&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;oauth2:client&gt;</span></code>タグを使用することで、<code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>のBeanが定義される。<code class="docutils literal"><span class="pre">id</span></code>属性に指定した文字列はBeanのIDとして使用される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p><code class="docutils literal"><span class="pre">web.xml</span></code>に、<code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>の設定を追加する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">web.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;filter&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>oauth2ClientContextFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;filter-class&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="nt">&lt;/filter-class&gt;</span>
<span class="nt">&lt;/filter&gt;</span>
<span class="nt">&lt;filter-mapping&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>oauth2ClientContextFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/filter-mapping&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DelegatingFilterProxy</span></code>を使用して、フィルタ名(<code class="docutils literal"><span class="pre">&lt;filter-name&gt;</span></code>要素に指定した値)とBean IDが一致するBeanをサーブレットフィルタとして登録する。</div>
<div class="line">フィルタ名には<code class="docutils literal"><span class="pre">&lt;oauth2:client&gt;</span></code>の<code class="docutils literal"><span class="pre">id</span></code>属性に指定したBean IDと同じ値を設定する。</div>
<div class="line">なお、Spring Security OAuthで発生する例外が意図しない例外ハンドリングが行われないようにするために、<code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>はサーブレットフィルタの定義の一番最後に記述することを推奨する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code>が発生する可能性があるパスに対して<code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>を適用している。</div>
<div class="line">上記例では、すべてのリクエストに対して<code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>を適用している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>は、認可サーバが認可処理後にユーザエージェントを戻すリダイレクトURLの生成をフィルタの前処理で行っているため、
<code class="docutils literal"><span class="pre">/*</span></code>のような広範囲な定義にすると<code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code>が発生しないパスに対して無駄な処理が行われることになる。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>は、認可サーバがリソースオーナの認可を取得した後にリダイレクトさせるURLをリクエストスコープに
<code class="docutils literal"><span class="pre">currentUri</span></code>という属性名で格納する。そのため、クライアントでは<code class="docutils literal"><span class="pre">currentUri</span></code>という属性名を使用することはできない。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>前述のとおり、<code class="docutils literal"><span class="pre">Oauth2ClientContextFilter</span></code>は<code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code>を捕捉し、認可サーバに対してリダイレクトさせるサーブレットフィルタである。</p>
<p>ただし、ブランクプロジェクトで予め設定されている<code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>が先に<code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code>をハンドリングしてしまうと
<code class="docutils literal"><span class="pre">Oauth2ClientContextFilter</span></code>は期待した動作にならない。</p>
<p>そのため、<code class="docutils literal"><span class="pre">spring-mvc.xm</span></code>の設定を変更し、<code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>が<code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code>をハンドリングしないようにする必要がある。
<code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>の詳しい解説については<a class="reference internal" href="../ArchitectureInDetail/WebApplicationDetail/ExceptionHandling.html"><span class="doc">例外ハンドリング</span></a>を参照されたい。</p>
<p><code class="docutils literal"><span class="pre">spring-mvc.xml</span></code>に、<code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code>を<code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>の除外対象として追加する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">spring-mvc.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;systemExceptionResolver&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.SystemExceptionResolver&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;excludedExceptions&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;array&gt;</span>
            <span class="c">&lt;!-- (1) --&gt;</span>
            <span class="nt">&lt;value&gt;</span>org.springframework.security.oauth2.client.resource.UserRedirectRequiredException
            <span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/array&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code>を<code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>のハンドリング対象から除外する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="oauth2resttemplatesettings">
<span id="id33"></span><h5><a class="toc-backref" href="#id95">9.9.2.5.1.3. OAuth2RestTemplateの設定</a><a class="headerlink" href="#oauth2resttemplatesettings" title="Permalink to this headline">¶</a></h5>
<p>各グラントタイプごとの<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>の設定方法を説明する。</p>
<div class="section" id="id34">
<h6><a class="toc-backref" href="#id96">9.9.2.5.1.3.1. 認可コードグラント使用時のリソースの設定</a><a class="headerlink" href="#id34" title="Permalink to this headline">¶</a></h6>
<p>認可コードグラントでアクセスする場合の<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>の設定例を示す。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:resource</span> <span class="na">id=</span><span class="s">&quot;todoAuthCodeGrantResource&quot;</span> <span class="na">client-id=</span><span class="s">&quot;firstSec&quot;</span>
                 <span class="na">client-secret=</span><span class="s">&quot;firstSecSecret&quot;</span>
                 <span class="na">type=</span><span class="s">&quot;authorization_code&quot;</span>
                 <span class="na">scope=</span><span class="s">&quot;READ,WRITE&quot;</span>
                 <span class="na">access-token-uri=</span><span class="s">&quot;${auth.serverUrl}/oth2/token&quot;</span>
                 <span class="na">user-authorization-uri=</span><span class="s">&quot;${auth.serverUrl}/oth2/authorize&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

<span class="nt">&lt;oauth2:rest-template</span> <span class="na">id=</span><span class="s">&quot;todoAuthCodeGrantResourceRestTemplate&quot;</span> <span class="na">resource=</span><span class="s">&quot;todoAuthCodeGrantResource&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>が参照する、アクセス対象となるリソースに関する詳細情報を定義する。</div>
<div class="line">各項目の設定値については下記表を参照のこと。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を定義する。</div>
<div class="line"><code class="docutils literal"><span class="pre">id</span></code>には<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>のBean IDを指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">resource</span></code>には(1)で定義したBeanの<code class="docutils literal"><span class="pre">id</span></code>を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils" id="id59">
<caption><span class="caption-text"><strong>リソース詳細情報</strong></span><a class="headerlink" href="#id59" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項目</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">id</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースのBean ID。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">client-id</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバにてクライントを識別するID。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">client-secret</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバにてクライアントの認証に用いるパスワード。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">type</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">グラントタイプ。認可コードグラントの場合<code class="docutils literal"><span class="pre">authorization_code</span></code>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">scope</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可を要求するスコープをカンマ区切りで列挙する。設定値は大文字、小文字を区別する。</div>
<div class="line">省略時は認可サーバにおいてクライアントに対して設定しているスコープを全て要求する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">access-token-uri</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークンの発行を依頼するための認可サーバのエンドポイントのURL。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">user-authorization-uri</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースオーナの認可を得るための認可サーバのエンドポイントのURL。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><code class="docutils literal"><span class="pre">&lt;oauth2:resource&gt;</span></code>タグでは、アクセストークン取得時のクライアント認証方法を指定する方法として
<code class="docutils literal"><span class="pre">client-authentication-scheme</span></code>パラメータが用意されている。
<code class="docutils literal"><span class="pre">client-authentication-scheme</span></code>パラメータに指定可能な値は以下の通り。</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">header</span></code>: Authorizationヘッダを使用したBasic認証。デフォルト値。</li>
<li><code class="docutils literal"><span class="pre">query</span></code> : リクエスト時のURLクエリパラメータを使用した認証。</li>
<li><code class="docutils literal"><span class="pre">form</span></code>  : リクエスト時のボディパラメータを使用した認証。</li>
</ul>
</div></blockquote>
<p>本ガイドラインではクライアントの認証にBasic認証を利用するため上記の設定例では未指定としているが、
アプリケーション要件に沿ったパラメータの指定を行うこと。</p>
<blockquote class="last">
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:resource</span> <span class="na">id=</span><span class="s">&quot;todoAuthCodeGrantResource&quot;</span> <span class="na">client-id=</span><span class="s">&quot;firstSec&quot;</span>
                 <span class="na">client-secret=</span><span class="s">&quot;firstSecSecret&quot;</span>
                 <span class="na">type=</span><span class="s">&quot;authorization_code&quot;</span>
                 <span class="na">scope=</span><span class="s">&quot;READ,WRITE&quot;</span>
                 <span class="na">access-token-uri=</span><span class="s">&quot;${auth.serverUrl}/oth2/token&quot;</span>
                 <span class="na">user-authorization-uri=</span><span class="s">&quot;${auth.serverUrl}/oth2/authorize&quot;</span>
                 <span class="na">client-authentication-scheme=</span><span class="s">&quot;form&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="oauth2resourceownerpasswordcredentialgrantresourcesettings">
<span id="id35"></span><h6><a class="toc-backref" href="#id97">9.9.2.5.1.3.2. リソースオーナパスワードクレデンシャルグラント使用時のリソースの設定</a><a class="headerlink" href="#oauth2resourceownerpasswordcredentialgrantresourcesettings" title="Permalink to this headline">¶</a></h6>
<div class="line-block">
<div class="line">リソースオーナパスワードクレデンシャルグラントでは、クライアントがリソースオーナのユーザ名およびパスワードを使用してアクセストークンの発行を依頼する。</div>
<div class="line"><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>にはリソースオーナのユーザ名およびパスワードをそれぞれパラメータとして設定する必要があるが、
複数のリソースオーナが同じクライアントを利用する場合、リソースオーナ毎に設定内容を切り替える考慮が必要となる。</div>
<div class="line">ここでは、<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>のリソースをSessionスコープのBeanで設定し、そのBeanにリソースオーナの情報を格納することによって、
リソースオーナ毎の設定内容の切り替えを実現する方法を説明する。</div>
</div>
<p>リソースオーナパスワードクレデンシャルグラントでアクセスする場合の<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>の設定例を示す。</p>
<p>リソースオーナ毎に設定内容を切り替えられるよう、<code class="docutils literal"><span class="pre">ResourceOwnerPasswordResourceDetails</span></code>をSessionスコープで定義し、<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>への設定を行う。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
    <span class="na">xmlns:oauth2=</span><span class="s">&quot;http://www.springframework.org/schema/security/oauth2&quot;</span>
    <span class="na">xmlns:aop=</span><span class="s">&quot;http://www.springframework.org/schema/aop&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;</span>
<span class="s">        http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">        http://www.springframework.org/schema/security/oauth2 http://www.springframework.org/schema/security/spring-security-oauth2.xsd</span>
<span class="s">        http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd</span>
<span class="s">    &quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;todoPasswordGrantResource&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.client.token.grant.password.ResourceOwnerPasswordResourceDetails&quot;</span>
        <span class="na">scope=</span><span class="s">&quot;session&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;aop:scoped-proxy&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;clientId&quot;</span> <span class="na">value=</span><span class="s">&quot;firstSec&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;clientSecret&quot;</span> <span class="na">value=</span><span class="s">&quot;firstSecSecret&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;accessTokenUri&quot;</span> <span class="na">value=</span><span class="s">&quot;${auth.serverUrl}/oth2/token&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;scope&quot;</span> <span class="na">value=</span><span class="s">&quot;READ,WRITE&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

    <span class="nt">&lt;oauth2:rest-template</span> <span class="na">id=</span><span class="s">&quot;todoPasswordGrantResourceRestTemplate&quot;</span> <span class="na">resource=</span><span class="s">&quot;todoPasswordGrantResource&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>が参照する、アクセス対象となるリソースに関する詳細情報を定義する。</div>
<div class="line">各項目の設定値については下記表を参照のこと。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を定義する。</div>
<div class="line"><code class="docutils literal"><span class="pre">id</span></code>には<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>のBean IDを指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">resource</span></code>には(1)で定義したBeanの<code class="docutils literal"><span class="pre">id</span></code>を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項目</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">class</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>のリソースとするBeanを指定する。ここでは<code class="docutils literal"><span class="pre">ResourceOwnerPasswordResourceDetails</span></code>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">scope</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">sessionを指定し、スコープ範囲をHTTPSessionとする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;aop:scoped-proxy&gt;</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SessionスコープのBeanをSingletonのBeanである<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>にインジェクションするため設定する。</div>
<div class="line">これは、SessionスコープのBeanよりSingletonのBeanの方がライフサイクルが長いため必要になる設定である。</div>
<div class="line">このタグを使用するために<code class="docutils literal"><span class="pre">aop</span></code>のネームスペースとスキーマを追加している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">clientId</span></code>プロパティ</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Beanの<code class="docutils literal"><span class="pre">clientId</span></code>に対して認可サーバにてクライントを識別するIDを設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">clientSecret</span></code>プロパティ</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Beanの<code class="docutils literal"><span class="pre">clientSecrett</span></code>に対して認可サーバにてクライアントの認証に用いるパスワードを設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">accessTokenUri</span></code>プロパティ</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークンの発行を依頼するための認可サーバのエンドポイントのURLを指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">scope</span></code>プロパティ</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Beanの<code class="docutils literal"><span class="pre">scope</span></code>に対して認可を要求するスコープの一覧を設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">リソースオーナのユーザ名、パスワードの取得は、アクセスが必要となったタイミングでクライアントの画面等でリソースオーナから入力され、Beanに格納することを想定している。
本ガイドラインでは、ユーザ名、パスワードの具体的な取得方法については説明を割愛する。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">本ガイドラインで説明している認可サーバでは、認証に使用するパスワードに対してハッシュ化の後比較検証を行うため、<code class="docutils literal"><span class="pre">ResourceOwnerPasswordResourceDetails</span></code>に設定するパスワードは平文である必要がある。
クライアントがリソースオーナのパスワードを平文で扱うことによるリスクが高いため、リソースオーナパスワードクレデンシャルグラントは
クライアント-リソースオーナ間で高い信頼関係があり、かつクライアントがセキュアな環境に配置されているなどの非常に限定的な状況でのみ利用すること。
認可サーバにおけるハッシュ化の設定については <a class="reference internal" href="#oauthauthorizationserverclientauthentication"><span class="std std-ref">クライアントの認証</span></a>を参照のこと。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id36">
<h6><a class="toc-backref" href="#id98">9.9.2.5.1.3.3. クライアントクレデンシャルグラント使用時のリソースの設定</a><a class="headerlink" href="#id36" title="Permalink to this headline">¶</a></h6>
<p>クライアントクレデンシャルグラントでアクセスする場合の<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>の設定例を示す。</p>
<p>なお、認可コードグラントと共通する設定についての解説は割愛する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:resource</span> <span class="na">id=</span><span class="s">&quot;todoClientGrantResource&quot;</span> <span class="na">client-id=</span><span class="s">&quot;firstSecClient&quot;</span>
                <span class="na">client-secret=</span><span class="s">&quot;firstSecSecret&quot;</span>
                <span class="na">type=</span><span class="s">&quot;client_credentials&quot;</span>
                <span class="na">access-token-uri=</span><span class="s">&quot;${auth.serverUrl}/oth2/token&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

<span class="nt">&lt;oauth2:rest-template</span> <span class="na">resource=</span><span class="s">id=&quot;todoClientGrantResourceRestTemplate&quot;</span> <span class="na">resource=</span><span class="s">&quot;todoClientGrantResource&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">type</span></code>属性にはグラントタイプを指定する。クライアントクレデンシャルグラントの場合<code class="docutils literal"><span class="pre">client_credentials</span></code>を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="id37">
<h5><a class="toc-backref" href="#id99">9.9.2.5.1.4. リソースサーバへのアクセス</a><a class="headerlink" href="#id37" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を用いてリソースサーバへアクセスする方法を説明する。</p>
<p>認可サーバへのアクセスは<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>と<code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>により隠蔽されるため、開発の際には
認可サーバを意識する必要がなく、リソースサーバが提供するREST APIに対して行う処理を、通常のREST APIへのアクセスと同様に記述する。</p>
<p>以下にServiceクラスの実装例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">org.springframework.web.client.RestOperations</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="p">(</span><span class="s">&quot;todoAuthCodeGrantResourceRestTemplate&quot;</span><span class="p">)</span>
    <span class="n">RestOperations</span> <span class="n">restOperations</span><span class="p">;</span> <span class="c1">// (1)</span>

    <span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${resource.serverUrl}/api/v1/todos&quot;</span><span class="p">)</span>
    <span class="n">String</span> <span class="n">uri</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">getTodoList</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Todo</span><span class="o">[]</span> <span class="n">todoArray</span> <span class="o">=</span> <span class="n">restOperations</span><span class="p">.</span>
            <span class="nf">getForObject</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">Todo</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">);</span> <span class="c1">// (2)</span>
        <span class="k">return</span> <span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="n">todoArray</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RestOperations</span></code>をInejectする。</div>
<div class="line">上記例では、Bean IDが<code class="docutils literal"><span class="pre">todoAuthCodeGrantResourceRestTemplate</span></code>であるBeanをInjectしている。<code class="docutils literal"><span class="pre">&#64;Named</span></code>の指定は<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>が複数定義されている場合に必要となる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">指定したURLにRESTでメソッドGETでアクセスし結果をリストで受け取る。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>を使用してリソースサーバにアクセスしようとした時点でアクセストークンが発行されていない場合、
一度認可サーバにリダイレクトされる。
その後、アクセストークンの発行が完了するとクライアントへリダイレクトされ、再度リソースサーバへのアクセス処理が呼び出される形となる。
この時、クライアントへのリダイレクトはGETにより行われるため、認可サーバからリダイレクトされる可能性のあるControllerはGETを許容する必要がある。</p>
<p class="last">また、リダイレクト前のリソースサーバへのアクセスがPOSTである場合、リダイレクト後のGETではパラメータが失われてしまう。
その場合、POSTパラメータをセッションに保持する等の対処が必要となるため、注意すること。
本ガイドラインでは、具体的な対処方法の説明については割愛する。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="javascript">
<span id="oauthclientusingjavascript"></span><h4><a class="toc-backref" href="#id100">9.9.2.5.2. JavaScriptを使用したリソースへのアクセス</a><a class="headerlink" href="#javascript" title="Permalink to this headline">¶</a></h4>
<p>インプリシットグラントでは、Webブラウザなどのユーザエージェントが認可サーバに対して認可の要求を行う。</p>
<p>そのため、通常、インプリシットグラントはWebブラウザ上で動作するJavaScriptなどで利用されるが、
Spring Security OAuthではJavaScriptライブラリを提供していないため、インプリシットグラントを使用する場合は
独自にクライアントを実装する必要がある。</p>
<p>本ガイドラインでは、インプリシットグラント向けのクライアントの実装として、JavaScriptを使用してリソースサーバから
JSON形式のデータを取得し、画面に表示させる方法を説明する。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">以降に説明する実装例ではJavaScriptライブラリとしてjQueryを使用する。
jsファイルと合わせて <code class="docutils literal"><span class="pre">src/main/webapp</span></code> 配下に格納されていることを想定している。</p>
</div>
<p>OAuth 2.0機能を独自に実装したAPI例を示す。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2.js</span></code></li>
</ul>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">oauth2Func</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">exp</span><span class="p">,</span> <span class="nx">$</span><span class="p">)</span> <span class="p">{</span>
    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

    <span class="kd">var</span>
        <span class="nx">config</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">DEFAULT_LIFETIME</span> <span class="o">=</span> <span class="mi">3600</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">uuid</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">&quot;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&quot;</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[xy]/g</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">16</span><span class="o">|</span><span class="mi">0</span><span class="p">,</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">c</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span> <span class="o">?</span> <span class="nx">r</span> <span class="o">:</span> <span class="p">(</span><span class="nx">r</span><span class="o">&amp;</span><span class="mh">0x3</span><span class="o">|</span><span class="mh">0x8</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">v</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">encodeURL</span><span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nx">k</span> <span class="k">in</span> <span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">res</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">i</span><span class="o">++</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">?</span> <span class="s2">&quot;?&quot;</span> <span class="o">:</span> <span class="s2">&quot;&amp;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">params</span><span class="p">[</span><span class="nx">k</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">epoch</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span><span class="o">/</span><span class="mf">1000.0</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">parseQueryString</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">qs</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">e</span><span class="p">,</span>
            <span class="nx">a</span> <span class="o">=</span> <span class="sr">/\+/g</span><span class="p">,</span>
            <span class="nx">r</span> <span class="o">=</span> <span class="sr">/([^&amp;;=]+)=?([^&amp;;]*)/g</span><span class="p">,</span>
            <span class="nx">d</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">));</span> <span class="p">},</span>
            <span class="nx">q</span> <span class="o">=</span> <span class="nx">qs</span><span class="p">,</span>
            <span class="nx">urlParams</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="k">while</span> <span class="p">(</span><span class="nx">e</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">q</span><span class="p">))</span> <span class="p">{</span>
           <span class="nx">urlParams</span><span class="p">[</span><span class="nx">d</span><span class="p">(</span><span class="nx">e</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="nx">d</span><span class="p">(</span><span class="nx">e</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">urlParams</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">saveState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s2">&quot;state-&quot;</span> <span class="o">+</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">obj</span><span class="p">));</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">getState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s2">&quot;state-&quot;</span> <span class="o">+</span> <span class="nx">state</span><span class="p">));</span>
        <span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="s2">&quot;state-&quot;</span> <span class="o">+</span> <span class="nx">state</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">hasScope</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">scope</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">token</span><span class="p">.</span><span class="nx">scopes</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">token</span><span class="p">.</span><span class="nx">scopes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">scopes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">scope</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">filterTokens</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tokens</span><span class="p">,</span> <span class="nx">scopes</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (1)</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">scopes</span><span class="p">)</span> <span class="nx">scopes</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">,</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">now</span> <span class="o">=</span> <span class="nx">epoch</span><span class="p">(),</span>
        <span class="nx">usethis</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">usethis</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">tokens</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">expires</span> <span class="o">&amp;&amp;</span> <span class="nx">tokens</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">expires</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">now</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="nx">usethis</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

            <span class="k">for</span><span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">scopes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasScope</span><span class="p">(</span><span class="nx">tokens</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">scopes</span><span class="p">[</span><span class="nx">j</span><span class="p">]))</span> <span class="nx">usethis</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">usethis</span><span class="p">)</span> <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tokens</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">saveTokens</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">provider</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s2">&quot;tokens-&quot;</span> <span class="o">+</span> <span class="nx">provider</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">tokens</span><span class="p">));</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">getTokens</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">provider</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s2">&quot;tokens-&quot;</span> <span class="o">+</span> <span class="nx">provider</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">tokens</span><span class="p">)</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="k">return</span> <span class="nx">tokens</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">wipeTokens</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">provider</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="s2">&quot;tokens-&quot;</span> <span class="o">+</span> <span class="nx">provider</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">saveToken</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">provider</span><span class="p">,</span> <span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">getTokens</span><span class="p">(</span><span class="nx">provider</span><span class="p">);</span>
        <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">filterTokens</span><span class="p">(</span><span class="nx">tokens</span><span class="p">);</span>
        <span class="nx">tokens</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
        <span class="nx">saveTokens</span><span class="p">(</span><span class="nx">provider</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">getToken</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">provider</span><span class="p">,</span> <span class="nx">scopes</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">getTokens</span><span class="p">(</span><span class="nx">provider</span><span class="p">);</span>
        <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">filterTokens</span><span class="p">(</span><span class="nx">tokens</span><span class="p">,</span> <span class="nx">scopes</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">tokens</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">sendAuthRequest</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">scopes</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (2)</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">config</span><span class="p">[</span><span class="nx">providerId</span><span class="p">])</span> <span class="k">throw</span> <span class="s2">&quot;Could not find configuration for provider &quot;</span> <span class="o">+</span> <span class="nx">providerId</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">co</span> <span class="o">=</span> <span class="nx">config</span><span class="p">[</span><span class="nx">providerId</span><span class="p">];</span>

        <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">uuid</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;response_type&quot;</span><span class="o">:</span> <span class="s2">&quot;token&quot;</span>
        <span class="p">};</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">state</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">co</span><span class="p">[</span><span class="s2">&quot;redirectUrl&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;redirect_uri&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">co</span><span class="p">[</span><span class="s2">&quot;redirectUrl&quot;</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">co</span><span class="p">[</span><span class="s2">&quot;clientId&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;client_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">co</span><span class="p">[</span><span class="s2">&quot;clientId&quot;</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">scopes</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;scope&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">scopes</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">authurl</span> <span class="o">=</span> <span class="nx">encodeURL</span><span class="p">(</span><span class="nx">co</span><span class="p">.</span><span class="nx">authorization</span><span class="p">,</span> <span class="nx">request</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;restoreHash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;providerId&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">providerId</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">scopes</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;scopes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">scopes</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">saveState</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">request</span><span class="p">);</span>
        <span class="nx">redirect</span><span class="p">(</span><span class="nx">authurl</span><span class="p">);</span>

    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">checkForToken</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">providerId</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (3)</span>
        <span class="kd">var</span> <span class="nx">h</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (4)</span>
            <span class="nx">h</span> <span class="o">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">errorinfo</span> <span class="o">=</span> <span class="nx">parseQueryString</span><span class="p">(</span><span class="nx">h</span><span class="p">);</span>
            <span class="nx">handleError</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">errorinfo</span><span class="p">);</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;access_token&quot;</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">h</span> <span class="o">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">atoken</span> <span class="o">=</span> <span class="nx">parseQueryString</span><span class="p">(</span><span class="nx">h</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">atoken</span><span class="p">.</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">getState</span><span class="p">(</span><span class="nx">atoken</span><span class="p">.</span><span class="nx">state</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">state</span><span class="p">)</span> <span class="k">throw</span> <span class="s2">&quot;Could not retrieve state&quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">state</span><span class="p">.</span><span class="nx">providerId</span><span class="p">)</span> <span class="k">throw</span> <span class="s2">&quot;Could not get providerId from state&quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">config</span><span class="p">[</span><span class="nx">state</span><span class="p">.</span><span class="nx">providerId</span><span class="p">])</span> <span class="k">throw</span> <span class="s2">&quot;Could not retrieve config for this provider.&quot;</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">now</span> <span class="o">=</span> <span class="nx">epoch</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;expires_in&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;expires&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">now</span> <span class="o">+</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;expires_in&quot;</span><span class="p">]);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;expires&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">now</span> <span class="o">+</span> <span class="nx">DEFAULT_LIFETIME</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;scope&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;scopes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;scope&quot;</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">[</span><span class="s2">&quot;scopes&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;scopes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">state</span><span class="p">[</span><span class="s2">&quot;scopes&quot;</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="nx">saveToken</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">atoken</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">restoreHash</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">restoreHash</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">handleError</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">cause</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (5)</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">config</span><span class="p">[</span><span class="nx">providerId</span><span class="p">])</span> <span class="k">throw</span> <span class="s2">&quot;Could not retrieve config for this provider.&quot;</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">co</span> <span class="o">=</span> <span class="nx">config</span><span class="p">[</span><span class="nx">providerId</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">errorDetail</span> <span class="o">=</span> <span class="nx">cause</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">];</span>

        <span class="c1">// redirect error page</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">co</span><span class="p">[</span><span class="s2">&quot;errRedirectUrl&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">redirect</span><span class="p">(</span><span class="nx">co</span><span class="p">[</span><span class="s2">&quot;errRedirectUrl&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">errorDetail</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Access Error. cause: &quot;</span> <span class="o">+</span> <span class="nx">errorDetail</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>


    <span class="kd">var</span> <span class="nx">redirect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">initialize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">config</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">providerId</span><span class="p">;</span>
            <span class="k">for</span><span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">providerId</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">checkForToken</span><span class="p">(</span><span class="nx">providerId</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Error when retrieving token from hash: &quot;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">);</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">clearTokens</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">key</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">wipeTokens</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">oajax</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">settings</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (6)</span>
        <span class="kd">var</span> <span class="nx">providerId</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">providerId</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">scopes</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">scopes</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">getToken</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">scopes</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">sendAuthRequest</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">scopes</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">settings</span><span class="p">.</span><span class="nx">headers</span><span class="p">)</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">headers</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="nx">settings</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;Authorization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Bearer &quot;</span> <span class="o">+</span> <span class="nx">token</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">];</span>

        <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="nx">settings</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">initialize</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="nx">clearTokens</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">clearTokens</span><span class="p">();</span>
        <span class="p">},</span>
        <span class="nx">oajax</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">oajax</span><span class="p">(</span><span class="nx">settings</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

<span class="p">})(</span><span class="nb">window</span><span class="p">,</span> <span class="nx">jQuery</span><span class="p">);</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークンの有効期限とスコープの可否をチェックする関数。</div>
<div class="line">クライントが使用可能なアクセストークンを返却する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバに対して認可を要求する関数。</div>
<div class="line">コンフィギュレーション情報より必要パラメータを取得し、リクエストを作成する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可の応答よりアクセストークンを取得する関数。</div>
<div class="line">アクセストークンが取得できた場合、ローカルストレージに情報を格納する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可の結果、エラーが返却された場合エラー処理として<code class="docutils literal"><span class="pre">handleError</span></code>を呼び出す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可時のエラーを処理する関数。</div>
<div class="line">本ガイドラインでは、エラー処理の実装例としてコンフィギュレーション情報にて指定されている
エラー時のリダイレクト先URLへのリダイレクトを行っている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースサーバに対してリソースへのアクセスを要求する関数。</div>
<div class="line">ローカルストレージよりアクセストークンを取得し、jQueryのajax関数を用いてリソースサーバへリクエストを行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>以下にクライアントの実装例を示す。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">todoList.jsp</span></code></li>
</ul>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;script</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;${pageContext.request.contextPath}/resources/vendor/jquery/jquery.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;script</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;${pageContext.request.contextPath}/resources/app/js/oth2-implicit.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;script</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
&quot;use strict&quot;;

$(document).ready(function() {
    var result = oauth2Func.initialize({ // (2)
        &quot;todo&quot; : { // (3)
            clientId : &quot;client&quot;, // (4)
            redirectUrl : &quot;${client.serverUrl}/oth2/api&quot;, // (5)
            errRedirectUrl : &quot;${client.serverUrl}/oth2/error&quot;, // (6)
            authorization : &quot;${auth.serverUrl}/oth2/authorize&quot; // (7)
        }
    });

    if (result) {
        oauth2Func.oajax({ // (8)
            url : &quot;${resource.serverUrl}/api/v1/todos&quot;, // (9)
            providerId : &quot;todo&quot;,  // (10)
            scopes : [ &quot;READ&quot; ],  // (11)
            dataType : &quot;json&quot;,    // (12)
            type : &quot;GET&quot;,  // (13)
            success : function(data) { // (14)
                $(&quot;#message&quot;).text(JSON.stringify(data));
            },
            error : function() {
                oauth2Func.clearTokens();
            }
        });
    } else {
        oauth2Func.clearTokens(); // (15)
    }


};

<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">&quot;message&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">後述する、OAuth 2.0機能を独自に実装したjsファイル、jQueryをそれぞれ格納したパスを指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可要求に使用するコンフィギュレーション情報を定義し、初期化する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアント別にコンフィギュレーション情報を区別するための識別子として一意な値を指定する。</div>
<div class="line">後述するリソースへのアクセス処理では、本項目をキーにコンフィギュレーション情報を管理・取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントを識別するIDを指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバのリソースオーナ認証後にクライアントをリダイレクトさせるURLを指定する。</div>
<div class="line">本実装例ではURLのパラメータをControllerから受け取ることを想定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可応答として認可サーバよりエラーを受信した場合にリダイレクトさせるURLを指定する。</div>
<div class="line">本実装例ではURLのパラメータをControllerから受け取ることを想定している。</div>
<div class="line">本ガイドラインではエラー受信時の実装例として、クライアントの画面にリダイレクトしエラー画面を
表示させる方法を示す。なお、クライアントのControllerについては説明を割愛する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバの認可エンドポイントURLを指定する。</div>
<div class="line">本実装例ではURLのパラメータをControllerから受け取ることを想定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースへのアクセスを実行する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースサーバのアクセス先URLを指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">参照するコンフィギュレーション情報の識別子を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースへ要求するスコープを指定する。設定値は大文字、小文字を区別する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">レスポンスの型を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(13)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">メソッドGETでリソースサーバへアクセスする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(14)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">処理成功時に行う処理を指定する。<code class="docutils literal"><span class="pre">message</span></code>には処理成功時のレスポンスが格納される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(15)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークンをクリアする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><div class="admonition-todo admonition" id="index-1">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p>JavaScriptで作られたクライアントから同一ドメインでない認可サーバやリソースサーバへのアクセスを行う場合、認可サーバやリソースサーバで<code class="docutils literal"><span class="pre">Cross-Origin</span> <span class="pre">Resource</span> <span class="pre">Sharing</span></code>のサポートが必要になる。</p>
<p class="last">詳細については、次版以降に記載する予定である。</p>
</div>
</div></blockquote>
</div>
<div class="section" id="oauthclientserverhowtocanceltoken">
<span id="id38"></span><h4><a class="toc-backref" href="#id101">9.9.2.5.3. トークンの取り消し（クライアントサーバ）</a><a class="headerlink" href="#oauthclientserverhowtocanceltoken" title="Permalink to this headline">¶</a></h4>
<p>発行したアクセストークンの取り消しの実装方法について説明する。</p>
<div class="line-block">
<div class="line">アクセストークンの取り消しは、認可サーバにリクエストを行い、<code class="docutils literal"><span class="pre">TokenStore</span></code>からアクセストークンの削除を行う。認可サーバへのリクエスト時はクライアントのBasic認証を行うため、Basic認証用のリクエストヘッダを設定する。</div>
<div class="line">認可サーバのトークンの取り消しについては <a class="reference internal" href="#oauthauthorizationserverhowtocanceltoken"><span class="std std-ref">トークンの取り消し（認可サーバ）</span></a>を参照されたい。</div>
<div class="line">クライアントサーバはアクセストークンの取り消しを認可サーバにリクエスト後、<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>で保持しているアクセストークンを削除する必要がある。</div>
</div>
<p>以下に、実装例を示す。</p>
<p>まず、認可サーバにトークン取り消し要求を行うための<code class="docutils literal"><span class="pre">RestTemplate</span></code>の設定を設定ファイルに追記する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;revokeRestTemplate&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.web.client.RestTemplate&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;interceptors&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;list&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;basicAuthInterceptor&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;basicAuthInterceptor&quot;</span> <span class="na">class=</span><span class="s">&quot;com.example.oauth2.client.restclient.BasicAuthInterceptor&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバにトークン取り消し要求を行うための<code class="docutils literal"><span class="pre">RestTemplate</span></code>をBean定義する。</div>
<div class="line">Basic認証用のリクエストヘッダを設定するため、<code class="docutils literal"><span class="pre">interceptors</span></code>プロパティに<code class="docutils literal"><span class="pre">ClientHttpRequestInterceptor</span></code>の実装クラスを指定する。</div>
<div class="line">Basic認証用のリクエストヘッダを設定する<code class="docutils literal"><span class="pre">ClientHttpRequestInterceptor</span></code>の実装クラスの実装方法については<a class="reference internal" href="../ArchitectureInDetail/WebServiceDetail/RestClient.html#restclienthowtoextendclienthttprequestinterceptorbasicauthentication"><span class="std std-ref">Basic認証用のリクエストヘッダ設定処理</span></a>を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>トークンの取り消しを行うサービスクラスのインタフェースと実装クラスを作成する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">RevokeTokenClientService.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RevokeTokenClientService</span> <span class="p">{</span>

    <span class="n">String</span> <span class="nf">revokeToken</span><span class="p">();</span>

<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">RevokeTokenClientServiceImpl.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RevokeTokenClientServiceImpl</span> <span class="kd">implements</span> <span class="n">RevokeTokenClientService</span> <span class="p">{</span>

    <span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${auth.serverUrl}/api/v1/oth2/tokens/revoke&quot;</span><span class="p">)</span>
    <span class="n">String</span> <span class="n">revokeTokenUrl</span><span class="p">;</span> <span class="c1">// (1)</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="p">(</span><span class="s">&quot;todoAuthCodeGrantResourceRestTemplate&quot;</span><span class="p">)</span>
    <span class="n">OAuth2RestOperations</span> <span class="n">oauth2RestOperations</span><span class="p">;</span> <span class="c1">// (2)</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="p">(</span><span class="s">&quot;revokeRestTemplate&quot;</span><span class="p">)</span>
    <span class="n">RestOperations</span> <span class="n">revokeRestOperations</span><span class="p">;</span> <span class="c1">// (3)</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">revokeToken</span><span class="p">()</span> <span class="p">{</span>

        <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">getTokenValue</span><span class="p">(</span><span class="n">oauth2RestOperations</span><span class="p">);</span>
        <span class="n">HttpHeaders</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="p">();</span>
        <span class="n">headers</span><span class="p">.</span><span class="na">setContentType</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_FORM_URLENCODED</span><span class="p">);</span>
        <span class="n">MultiValueMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">variables</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedMultiValueMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span><span class="p">();</span>
        <span class="n">variables</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;token&quot;</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>

        <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">revokeRestOperations</span><span class="p">.</span><span class="na">postForObject</span><span class="p">(</span><span class="n">revokeTokenUrl</span><span class="p">,</span>
            <span class="k">new</span> <span class="n">HttpEntity</span><span class="o">&lt;</span><span class="n">MultiValueMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">headers</span><span class="p">),</span>
            <span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">);</span> <span class="c1">// (4)</span>
        <span class="c1">// (5)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">&quot;success&quot;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">result</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">initContextToken</span><span class="p">(</span><span class="n">oauth2RestOperations</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (6)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="nf">getTokenValue</span><span class="p">(</span><span class="n">OAuth2RestOperations</span> <span class="n">oauth2RestOperations</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">tokenValue</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
        <span class="n">OAuth2AccessToken</span> <span class="n">token</span> <span class="o">=</span> <span class="n">oauth2RestOperations</span><span class="p">.</span><span class="na">getAccessToken</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">tokenValue</span> <span class="o">=</span> <span class="n">token</span><span class="p">.</span><span class="na">getValue</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">tokenValue</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (7)</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">initContextToken</span><span class="p">(</span><span class="n">OAuth2RestOperations</span> <span class="n">oauth2RestOperations</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">oauth2RestOperations</span><span class="p">.</span><span class="na">getOAuth2ClientContext</span><span class="p">().</span><span class="na">setAccessToken</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークンの取り消しを認可サーバに依頼する際に使用するURL。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取り消しを行うアクセストークンを保持している<code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>をインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセストークンの取り消しを行う<code class="docutils literal"><span class="pre">RestTemplate</span></code>をインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバにアクセストークンの取り消しを行うために、RESTでメソッドPOSTでアクセスする。</div>
<div class="line">取り消しを行うアクセストークンの値を認可サーバに渡すためにリクエストパラメータに設定する。</div>
<div class="line">アクセストークンは(5)で定義している<code class="docutils literal"><span class="pre">getTokenValue</span></code>メソッドに<code class="docutils literal"><span class="pre">OAuth2RestOperations</span></code>を渡して取得する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバの処理結果を判定し、正常の場合のみ<code class="docutils literal"><span class="pre">OAuth2RestOperations</span></code>で保持しているアクセストークンを削除する。</div>
<div class="line">アクセストークンの削除は(6)で定義している<code class="docutils literal"><span class="pre">initContextToken</span></code>メソッドにアクセストークンを保持している<code class="docutils literal"><span class="pre">OAuth2RestOperations</span></code>を渡して削除する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2RestOperations</span></code>で保持しているアクセストークンを取得するメソッド。</div>
<div class="line">パラメータとして渡された<code class="docutils literal"><span class="pre">OAuth2RestOperations</span></code>の<code class="docutils literal"><span class="pre">getAccessToken</span></code>メソッドを呼び出すことでアクセストークンを取得し、返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">OAuth2RestOperations</span></code>で保持しているアクセストークンを削除するメソッド。</div>
<div class="line">パラメータとして渡された<code class="docutils literal"><span class="pre">OAuth2RestOperations</span></code>の<code class="docutils literal"><span class="pre">setAccessToken</span></code>メソッドにnullを渡すことでアクセストークンを削除する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">クライアントは上記で作成したサービスをアクセストークンが不要になったタイミングで呼び出すことでトークンの取り消しを行う。</div>
<div class="line">Spring Security OAuthのデフォルト実装ではセッションスコープでアクセストークンを保持するため、クライアントのユーザがログアウトした場合やセッションタイムアウトによってセッションが破棄されるタイミングでトークンの取り消しを行うことが考えられる。</div>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-extend">
<span id="oauthhowtoextend"></span><h2><a class="toc-backref" href="#id102">9.9.3. How to extend</a><a class="headerlink" href="#how-to-extend" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id39">
<h3><a class="toc-backref" href="#id103">9.9.3.1. エンドポイントを介した認可サーバとリソースサーバの連携</a><a class="headerlink" href="#id39" title="Permalink to this headline">¶</a></h3>
<p>リソースサーバと認可サーバは、認可サーバのチェックトークンエンドポイントにリソースサーバからHTTPアクセスを行うことで連携が可能である。</p>
<p>チェックトークンエンドポイントは、リソースサーバからアクセストークンの値を受け取り、リソースサーバの代わりにトークンの検証を行うエンドポイントである。
チェックトークンエンドポイントは<code class="docutils literal"><span class="pre">TokenServices</span></code>を用いてアクセストークンの取得、検証を行い、検証に問題がなければアクセストークンに紐づく情報をリソースサーバに渡す。</p>
<div class="section" id="http">
<span id="oauthauthorizationserverhowtocooperatewithhttp"></span><h4><a class="toc-backref" href="#id104">9.9.3.1.1. HTTPアクセスを介した連携</a><a class="headerlink" href="#http" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">リソースサーバが認可サーバのチェックトークンエンドポイントにアクセスするためには<code class="docutils literal"><span class="pre">TokenServices</span></code>の実装クラスである<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.RemoteTokenServices</span></code>を使用する。</div>
<div class="line"><code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>は<code class="docutils literal"><span class="pre">org.springframework.web.client.RestTemplate</span></code>を用いてチェックトークンエンドポイントへHTTPアクセスを行い、アクセストークンに紐づく情報を取得する。</div>
<div class="line">アクセストークンの検証はチェックトークンエンドポイントが行うため、<code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>では行わない。</div>
</div>
<p>以下に、実装例を示す。</p>
<p>まず、認可サーバにトークンを検証するための<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.endpoint.CheckTokenEndpoint</span></code>クラスをコンポーネントとして登録する設定を行う。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span> <span class="na">pattern=</span><span class="s">&quot;/oth2/check-token&quot;</span> <span class="na">security=</span><span class="s">&quot;none&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>

<span class="nt">&lt;oauth2:authorization-server</span>
     <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span>
     <span class="na">token-endpoint-url=</span><span class="s">&quot;/oth2/token&quot;</span>
     <span class="na">authorization-endpoint-url=</span><span class="s">&quot;/oth2/authorize&quot;</span>
     <span class="na">user-approval-handler-ref=</span><span class="s">&quot;userApprovalHandler&quot;</span>
     <span class="na">token-services-ref=</span><span class="s">&quot;tokenServices&quot;</span>
     <span class="na">check-token-enabled=</span><span class="s">&quot;true&quot;</span>
     <span class="na">check-token-endpoint-url=</span><span class="s">&quot;/oth2/check-token&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;oauth2:authorization-code</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:implicit</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:client-credentials</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:password</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本ガイドラインでは、チェックトークンエンドポイントへのアクセスはリソースサーバのみ許可するネットワーク構成になっていることを前提とし、Spring Securityのセキュリティ機能(Security Filter)の適用対象外とする。</div>
<div class="line">他のセキュリティ設定よりも先に評価されるように、設定ファイルの先頭に記載する必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;oauth2:authorization-server&gt;タグ</span></code>の<code class="docutils literal"><span class="pre">check-token-enabled</span></code>属性に<code class="docutils literal"><span class="pre">true</span></code>を指定することで<code class="docutils literal"><span class="pre">CheckTokenEndpoint</span></code>がコンポーネントとして登録される。</div>
<div class="line"><code class="docutils literal"><span class="pre">&lt;oauth2:authorization-server&gt;タグ</span></code>の<code class="docutils literal"><span class="pre">check-token-endpoint-url</span></code>属性に<code class="docutils literal"><span class="pre">CheckTokenEndpoint</span></code>のURLを指定する。指定しない場合はデフォルト値である “/oauth/check_token” が指定される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>チェックトークンエンドポイントのセキュリティ対策</strong></p>
<ul class="last simple">
<li>チェックトークンエンドポイントは、認可サーバとリソースサーバ間のみアクセス可能とし、オープンなネットワークからアクセスできないようにする。
チェックトークンエンドポイントを公開する場合は、適切なセキュリティ対策を行う必要がある。</li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Spring Security OAuthのバージョン2.0.12以前を使用する場合、<code class="docutils literal"><span class="pre">check-token-endpoint-url</span></code>は、<code class="docutils literal"><span class="pre">authorization-endpoint-url</span></code>または<code class="docutils literal"><span class="pre">token-endpoint-url</span></code>を指定していない場合は反映されないため注意が必要である。
これは以下のissueで取り上げられており、バージョン2.0.13で改修される予定である。</p>
<p class="last"><a class="reference external" href="https://github.com/spring-projects/spring-security-oauth/issues/897">https://github.com/spring-projects/spring-security-oauth/issues/897</a></p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">TokenServices</span></code>は、共有DBを介して連携させる場合と同様に<code class="docutils literal"><span class="pre">DefaultTokenServices</span></code>を使用する。
<code class="docutils literal"><span class="pre">TokenServices</span></code>が参照する<code class="docutils literal"><span class="pre">TokenStore</span></code>はアプリケーションの要件に合ったインタフェースの実装クラスを使用する。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>リソースサーバの設定ファイルに<code class="docutils literal"><span class="pre">TokenServices</span></code>として<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.RemoteTokenServices</span></code>を使用する設定を行う。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;tokenServices&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.RemoteTokenServices&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;checkTokenEndpointUrl&quot;</span> <span class="na">value=</span><span class="s">&quot;${auth.serverUrl}/oth2/check-token&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバのチェックトークンエンドポイントにアクセスしてアクセストークンに紐付く情報を取得できるよう、<code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>をBean定義する。</div>
<div class="line">チェックトークンエンドポイントにアクセスするためのURLを<code class="docutils literal"><span class="pre">checkTokenEndpointUrl</span></code>プロパティに設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">チェックトークンエンドポイントでアクセストークンの検証エラーが発生した場合、<code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>にHTTPステータスコード400(Bad Request)が返却される。
<code class="docutils literal"><span class="pre">RestTemplate</span></code>のデフォルト実装ではHTTPステータスコード400(Bad Request)が返却された場合、エラーハンドリングを行いクライアントエラー例外を発生させる。
<code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>がデフォルトで使用する<code class="docutils literal"><span class="pre">RestTemplate</span></code>はアクセストークンの検証エラーをクライアントサーバに連携するために、レスポンスのHTTPステータスコードが400の場合はエラーハンドリングしないよう拡張されている。
<code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>に<code class="docutils literal"><span class="pre">RestTemplate</span></code>をインジェクションした場合、この拡張が適用されなくなるため注意が必要である。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p><code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>をリソースサーバで使用した場合、ハンドラメソッドでアノテーション<code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>を<code class="docutils literal"><span class="pre">String</span></code>に引数アノテーションとして指定することでリソースオーナのユーザ名が取得できる。</p>
<p>実装例は以下のようになる。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;api&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;todos&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">list</span><span class="p">(</span><span class="nd">@AuthenticationPrincipal</span> <span class="n">String</span> <span class="n">userName</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (1)</span>

        <span class="c1">// omitted</span>

    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数 <code class="docutils literal"><span class="pre">userName</span></code>にリソースオーナのユーザ名が格納される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="defaultaccesstokenconverter">
<span id="oauthauthorizationserverhowtogetotherthanusername"></span><h4><a class="toc-backref" href="#id105">9.9.3.1.2. DefaultAccessTokenConverterの拡張</a><a class="headerlink" href="#defaultaccesstokenconverter" title="Permalink to this headline">¶</a></h4>
<p>認可サーバとリソースサーバ間でDBを共有しない構成の場合でも、ユーザ情報に付随する項目を認可サーバからリソースサーバに連携したいというケースはありうるが、
リソースサーバの使用する<code class="docutils literal"><span class="pre">TokenServices</span></code>として<code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>を使用する場合、リソースサーバのハンドラメソッド引数のアノテーション<code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>ではユーザ名以外の情報を取得することができない。</p>
<p>そこで、ここでは<code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>を使用してアクセストークンを連携するときに使用するクラスである<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.DefaultAccessTokenConverter</span></code>を拡張し、
ユーザ名以外の情報をリソースサーバに連携する例を示す。</p>
<div class="section" id="id40">
<h5><a class="toc-backref" href="#id106">9.9.3.1.2.1. DefaultAccessTokenConverterとは</a><a class="headerlink" href="#id40" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>を使用したアクセストークンの連携では、<code class="docutils literal"><span class="pre">RestTemplate</span></code>を使用してリソースサーバから認可サーバに対してアクセストークン値に紐づくリソースオーナ、クライアントの認証情報を要求し、結果をMapとして取得する。
このとき、<code class="docutils literal"><span class="pre">DefaultAccessTokenConverter</span></code>は、認可サーバでは認証情報からMapへ、リソースサーバではMapから認証情報へ変換するためのコンバーターとしての役割を持つ。</p>
<p>これを利用し、認可サーバからの返却値をMapに追加するよう<code class="docutils literal"><span class="pre">DefaultAccessTokenConverter</span></code>の拡張を行うことで、認可サーバ、リソースサーバ間で連携するパラメータをカスタマイズすることが出来るようになる。</p>
<p>以下の説明では、認可サーバ側で<code class="docutils literal"><span class="pre">DefaultAccessTokenConverter</span></code>と、そのプロパティである<code class="docutils literal"><span class="pre">DefaultUserAuthenticationConverter</span></code>をそれぞれカスタマイズすることで、ユーザ情報に関連した独自項目と、それ以外の独自項目を連携する例を示す。</p>
</div>
<div class="section" id="id41">
<h5><a class="toc-backref" href="#id107">9.9.3.1.2.2. 認可サーバの実装</a><a class="headerlink" href="#id41" title="Permalink to this headline">¶</a></h5>
<p>認可サーバ側の実装方法について説明する。</p>
<p>まず、ユーザ情報に関連した独自項目を追加するため、<code class="docutils literal"><span class="pre">DefaultUserAuthenticationConverter</span></code>を拡張する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">AuthCustomUserTokenConverter.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomUserTokenConverter</span> <span class="kd">extends</span> <span class="n">DefaultUserAuthenticationConverter</span> <span class="p">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="o">?&gt;</span> <span class="n">convertUserAuthentication</span><span class="p">(</span>
            <span class="n">Authentication</span> <span class="n">authentication</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span><span class="p">();</span>
        <span class="n">response</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">USERNAME</span><span class="p">,</span> <span class="n">authentication</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">authentication</span><span class="p">.</span><span class="na">getAuthorities</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                <span class="o">!</span><span class="n">authentication</span><span class="p">.</span><span class="na">getAuthorities</span><span class="p">().</span><span class="na">isEmpty</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">response</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">AUTHORITIES</span><span class="p">,</span> <span class="n">AuthorityUtils</span><span class="p">.</span><span class="na">authorityListToSet</span><span class="p">(</span>
                    <span class="n">authentication</span><span class="p">.</span><span class="na">getAuthorities</span><span class="p">()));</span>
        <span class="p">}</span>
        <span class="n">response</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;user_additional_key&quot;</span><span class="p">,</span> <span class="s">&quot;user_additional_value&quot;</span><span class="p">);</span> <span class="c1">// (1)</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースサーバに引き渡す情報を独自項目<code class="docutils literal"><span class="pre">user_additional_key</span></code>として定義し、<code class="docutils literal"><span class="pre">response</span></code>に設定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">response</span></code>に設定した情報は、チェックトークンエンドポイントのトークン検証時にレスポンスBODYとしてJSON形式でリソースサーバへ返却される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>次に、ユーザ情報以外の独自項目を追加するため、<code class="docutils literal"><span class="pre">DefaultAccessTokenConverter</span></code>を拡張する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">CustomAccessTokenConverter.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomAccessTokenConverter</span> <span class="kd">extends</span> <span class="n">DefaultAccessTokenConverter</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="o">?&gt;</span> <span class="n">convertAccessToken</span><span class="p">(</span><span class="n">OAuth2AccessToken</span> <span class="n">token</span><span class="p">,</span> <span class="n">OAuth2Authentication</span> <span class="n">authentication</span><span class="p">)</span> <span class="p">{</span>

        <span class="nd">@SuppressWarnings</span><span class="p">(</span><span class="s">&quot;unchecked&quot;</span><span class="p">)</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span><span class="p">)</span> <span class="kd">super</span><span class="p">.</span><span class="na">convertAccessToken</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">authentication</span><span class="p">);</span>
        <span class="n">response</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;client_additional_key&quot;</span><span class="p">,</span><span class="s">&quot;client_additional_value&quot;</span><span class="p">);</span> <span class="c1">// (1)</span>
        <span class="c1">// omitted</span>

        <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースサーバに引き渡す情報を独自項目<code class="docutils literal"><span class="pre">client_additional_key</span></code>として定義し、<code class="docutils literal"><span class="pre">response</span></code>に設定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">response</span></code>に設定した情報は、チェックトークンエンドポイントのトークン検証時にレスポンスBODYとしてJSON形式でリソースサーバへ返却される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>認可サーバの設定ファイルに、作成した<code class="docutils literal"><span class="pre">CustomUserTokenConverter</span></code>、<code class="docutils literal"><span class="pre">CustomAccessTokenConverter</span></code>の設定を行う。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
     <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span>
     <span class="na">token-endpoint-url=</span><span class="s">&quot;/oth2/token&quot;</span>
     <span class="na">authorization-endpoint-url=</span><span class="s">&quot;/oth2/authorize&quot;</span>
     <span class="na">user-approval-handler-ref=</span><span class="s">&quot;userApprovalHandler&quot;</span>
     <span class="na">token-services-ref=</span><span class="s">&quot;tokenServices&quot;</span>
     <span class="na">check-token-endpoint-url=</span><span class="s">&quot;/oth2/check-token&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;oauth2:authorization-code</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:implicit</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:client-credentials</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:password</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;checkTokenEndpoint&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.endpoint.CheckTokenEndpoint&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;tokenServices&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;accessTokenConverter&quot;</span> <span class="na">ref=</span><span class="s">&quot;accessTokenConverter&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;accessTokenConverter&quot;</span>
    <span class="na">class=</span><span class="s">&quot;com.example.oauth2.auth.converter.CustomAccessTokenConverter&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;userTokenConverter&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;bean</span>
            <span class="na">class=</span><span class="s">&quot;com.example.oauth2.auth.converter.CustomUserTokenConverter&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;oauth2:authorization-server&gt;タグ</span></code>の<code class="docutils literal"><span class="pre">check-token-endpoint-url</span></code>属性に(2)で定義している<code class="docutils literal"><span class="pre">CheckTokenEndpoint</span></code>のURLを指定する。指定しない場合はデフォルト値である “/oauth/check_token” が指定される。</div>
<div class="line"><code class="docutils literal"><span class="pre">CheckTokenEndpoint</span></code>のBean定義を(2)で独自で行っているため、<code class="docutils literal"><span class="pre">&lt;oauth2:authorization-server&gt;タグ</span></code>の<code class="docutils literal"><span class="pre">check-token-enabled</span></code>属性は指定しない。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">CheckTokenEndpoint</span></code>をBean定義する。</div>
<div class="line"><code class="docutils literal"><span class="pre">accessTokenConverter</span></code>プロパティに(2)で定義している<code class="docutils literal"><span class="pre">CustomAccessTokenConverter</span></code>のBeanを指定することで<code class="docutils literal"><span class="pre">CustomAccessTokenConverter</span></code>と<code class="docutils literal"><span class="pre">CustomUserTokenConverter</span></code>に追加した独自項目をリソースサーバに連携するようになる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DefaultAccessTokenConverter</span></code>を拡張した<code class="docutils literal"><span class="pre">CustomAccessTokenConverter</span></code>をBean定義する。</div>
<div class="line"><code class="docutils literal"><span class="pre">userTokenConverter</span></code>プロパティに<code class="docutils literal"><span class="pre">DefaultUserAuthenticationConverter</span></code>を拡張した<code class="docutils literal"><span class="pre">CustomUserTokenConverter</span></code>のBeanを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id42">
<h5><a class="toc-backref" href="#id108">9.9.3.1.2.3. リソースサーバの実装</a><a class="headerlink" href="#id42" title="Permalink to this headline">¶</a></h5>
<p>リソースサーバに、認可サーバから連携された情報をハンドラメソッド引数のアノテーション<code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>で取得できるよう機能の追加を行う。
まず、アノテーション<code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>で取得する情報を保持する<code class="docutils literal"><span class="pre">OauthUser</span></code>クラスを作成する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">OauthUser.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OauthUser</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">userAdditionalValue</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">clientAdditionalValue</span><span class="p">;</span>

    <span class="c1">// omitted</span>

    <span class="kd">public</span> <span class="nf">User</span><span class="p">(</span><span class="n">String</span> <span class="n">username</span><span class="p">,</span> <span class="n">String</span> <span class="n">additionalValue</span><span class="p">){</span>
        <span class="k">this</span><span class="p">.</span><span class="na">username</span> <span class="o">=</span> <span class="n">username</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="na">additionalValue</span> <span class="o">=</span> <span class="n">additionalValue</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Getters and Setters are omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<p>アノテーション<code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>でユーザ情報が取得できるように設定を行う<code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.DefaultAccessTokenConverter</span></code>を拡張し、ユーザ名以外の情報も取得できるよう機能の追加を行う。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">CustomUserTokenConverter.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomUserTokenConverter</span> <span class="kd">extends</span> <span class="n">DefaultUserAuthenticationConverter</span><span class="p">{</span>

    <span class="kd">private</span> <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">defaultAuthorities</span><span class="p">;</span> <span class="c1">// (1)</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDefaultAuthorities</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">defaultAuthorities</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">defaultAuthorities</span> <span class="o">=</span> <span class="n">AuthorityUtils</span><span class="p">.</span><span class="na">commaSeparatedStringToAuthorityList</span><span class="p">(</span><span class="n">StringUtils</span>
                <span class="p">.</span><span class="na">arrayToCommaDelimitedString</span><span class="p">(</span><span class="n">defaultAuthorities</span><span class="p">));</span>
    <span class="p">}</span>

     <span class="c1">// (2)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Authentication</span> <span class="nf">extractAuthentication</span><span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="o">?&gt;</span> <span class="n">map</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="n">USERNAME</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span> <span class="o">=</span> <span class="n">getAuthorities</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
            <span class="n">OauthUser</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OauthUser</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="n">map</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">USERNAME</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="n">map</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;user_additional_key&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="n">map</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;client_additional_key&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="n">map</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;client_id&quot;</span><span class="p">));</span> <span class="c1">// (3)</span>

            <span class="c1">// omitted</span>

            <span class="k">return</span> <span class="k">new</span> <span class="n">UsernamePasswordAuthenticationToken</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s">&quot;N/A&quot;</span><span class="p">,</span> <span class="n">authorities</span><span class="p">);</span> <span class="c1">// (4)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="o">?&gt;</span> <span class="n">map</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="n">AUTHORITIES</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">defaultAuthorities</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">Object</span> <span class="n">authorities</span> <span class="o">=</span> <span class="n">map</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">AUTHORITIES</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">authorities</span> <span class="k">instanceof</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">AuthorityUtils</span><span class="p">.</span><span class="na">commaSeparatedStringToAuthorityList</span><span class="p">((</span><span class="n">String</span><span class="p">)</span> <span class="n">authorities</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">authorities</span> <span class="k">instanceof</span> <span class="n">Collection</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">AuthorityUtils</span><span class="p">.</span><span class="na">commaSeparatedStringToAuthorityList</span><span class="p">(</span><span class="n">StringUtils</span>
                    <span class="p">.</span><span class="na">collectionToCommaDelimitedString</span><span class="p">((</span><span class="n">Collection</span><span class="o">&lt;?&gt;</span><span class="p">)</span> <span class="n">authorities</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&quot;Authorities must be either a String or a Collection&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DefaultUserAuthenticationConverter</span></code>に実装されている<code class="docutils literal"><span class="pre">getAuthorities</span></code>メソッドがprivateで定義されているため、<code class="docutils literal"><span class="pre">getAuthorities</span></code>メソッドで使用される<code class="docutils literal"><span class="pre">defaultAuthorities</span></code>と<code class="docutils literal"><span class="pre">getAuthorities</span></code>メソッドを実装する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバから連携された情報から認証情報を抽出するメソッド。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可サーバから連携された情報を<code class="docutils literal"><span class="pre">OauthUser</span></code>クラスに設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UsernamePasswordAuthenticationToken</span></code>の第一引数に<code class="docutils literal"><span class="pre">OauthUser</span></code>を設定することで、認可サーバから連携された情報をアノテーション<code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>で取得できるようになる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>リソースサーバの設定ファイルに、<code class="docutils literal"><span class="pre">CustomUserTokenConverter</span></code>の設定を行う。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;tokenServices&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.RemoteTokenServices&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;checkTokenEndpointUrl&quot;</span> <span class="na">value=</span><span class="s">&quot;${auth.serverUrl}/oth2/check-token&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;accessTokenConverter&quot;</span> <span class="na">ref=</span><span class="s">&quot;accessTokenConverter&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;accessTokenConverter&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.DefaultAccessTokenConverter&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;userTokenConverter&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;com.example.oauth2.resource.converter.CustomUserTokenConverter&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">accessTokenConverter</span></code>の<code class="docutils literal"><span class="pre">userTokenConverter</span></code>プロパティに<code class="docutils literal"><span class="pre">CustomUserTokenConverter</span></code>クラスを指定することで、ユーザ名以外の情報をアノテーション<code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>で取得できるようになる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="SecureLoginDemo.html" title="9.10. 代表的なセキュリティ要件の実装例"
             >next</a> |</li>
        <li class="right" >
          <a href="Encryption.html" title="9.8. 暗号化"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.3.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >9. セキュリティ対策</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer">
      © Copyright 2013-2017, NTT DATA Corporation. © Copyright 2017, NTT Corporation.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3.Theme by <a href="http://github.com/vkvn">vkvn</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>

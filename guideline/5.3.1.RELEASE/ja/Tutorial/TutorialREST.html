<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>10.2. チュートリアル(Todoアプリケーション REST編) &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.3.1.RELEASE documentation</title>
    <link rel="stylesheet" href="../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '5.3.1.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="10.3. セッションチュートリアル" href="TutorialSession.html" />
    <link rel="prev" title="10.1. チュートリアル(Todoアプリケーション)" href="TutorialTodo.html" /><script async src="https://www.googletagmanager.com/gtag/js?id=G-847V2Q99G8"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date()); gtag('config', 'G-847V2Q99G8');
</script>
<script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="TutorialSession.html" title="10.3. セッションチュートリアル"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="TutorialTodo.html" title="10.1. チュートリアル(Todoアプリケーション)"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.3.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">10. チュートリアル</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">10.2. チュートリアル(Todoアプリケーション REST編)</a><ul>
<li><a class="reference internal" href="#id2">10.2.1. はじめに</a><ul>
<li><a class="reference internal" href="#id3">10.2.1.1. このチュートリアルで学ぶこと</a></li>
<li><a class="reference internal" href="#id4">10.2.1.2. 対象読者</a></li>
<li><a class="reference internal" href="#id5">10.2.1.3. 検証環境</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6">10.2.2. 環境構築</a><ul>
<li><a class="reference internal" href="#dhc">10.2.2.1. DHCのインストール</a></li>
<li><a class="reference internal" href="#id7">10.2.2.2. プロジェクト作成</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rest-api">10.2.3. REST APIの作成</a><ul>
<li><a class="reference internal" href="#api">10.2.3.1. API仕様</a><ul>
<li><a class="reference internal" href="#get-todos">10.2.3.1.1. GET Todos</a></li>
<li><a class="reference internal" href="#post-todos">10.2.3.1.2. POST Todos</a></li>
<li><a class="reference internal" href="#get-todo">10.2.3.1.3. GET Todo</a></li>
<li><a class="reference internal" href="#put-todo">10.2.3.1.4. PUT Todo</a></li>
<li><a class="reference internal" href="#delete-todo">10.2.3.1.5. DELETE Todo</a></li>
<li><a class="reference internal" href="#id8">10.2.3.1.6. エラー応答</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rest-apidispatcherservlet">10.2.3.2. REST API用のDispatcherServletを用意</a><ul>
<li><a class="reference internal" href="#web-xml">10.2.3.2.1. web.xmlの修正</a></li>
<li><a class="reference internal" href="#spring-mvc-rest-xml">10.2.3.2.2. spring-mvc-rest.xmlの作成</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rest-apispring-security">10.2.3.3. REST API用のSpring Securityの定義追加</a></li>
<li><a class="reference internal" href="#id9">10.2.3.4. REST API用パッケージの作成</a></li>
<li><a class="reference internal" href="#resource">10.2.3.5. Resourceクラスの作成</a></li>
<li><a class="reference internal" href="#controller">10.2.3.6. Controllerクラスの作成</a><ul>
<li><a class="reference internal" href="#id10">10.2.3.6.1. GET Todosの実装</a></li>
<li><a class="reference internal" href="#id11">10.2.3.6.2. POST Todosの実装</a></li>
<li><a class="reference internal" href="#id12">10.2.3.6.3. GET Todoの実装</a></li>
<li><a class="reference internal" href="#id13">10.2.3.6.4. PUT Todoの実装</a></li>
<li><a class="reference internal" href="#id14">10.2.3.6.5. DELETE Todoの実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id15">10.2.3.7. 例外ハンドリングの実装</a><ul>
<li><a class="reference internal" href="#id16">10.2.3.7.1. ドメイン層の実装を変更</a></li>
<li><a class="reference internal" href="#id17">10.2.3.7.2. エラーメッセージの定義</a></li>
<li><a class="reference internal" href="#id18">10.2.3.7.3. エラーハンドリング用のクラスを格納するパッケージの作成</a></li>
<li><a class="reference internal" href="#id19">10.2.3.7.4. REST APIのエラーハンドリングを行うクラスの作成</a></li>
<li><a class="reference internal" href="#rest-apijavabean">10.2.3.7.5. REST APIのエラー情報を保持するJavaBeanの作成</a></li>
<li><a class="reference internal" href="#httpbody">10.2.3.7.6. HTTPレスポンスBODYにエラー情報を出力するための実装</a></li>
<li><a class="reference internal" href="#id20">10.2.3.7.7. 入力エラーのエラーハンドリングの実装</a></li>
<li><a class="reference internal" href="#id21">10.2.3.7.8. 業務例外のエラーハンドリングの実装</a></li>
<li><a class="reference internal" href="#id22">10.2.3.7.9. リソース未検出例外のエラーハンドリングの実装</a></li>
<li><a class="reference internal" href="#id23">10.2.3.7.10. システム例外のエラーハンドリングの実装</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id24">10.2.4. おわりに</a></li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="TutorialTodo.html"
                        title="previous chapter">10.1. チュートリアル(Todoアプリケーション)</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="TutorialSession.html"
                        title="next chapter">10.3. セッションチュートリアル</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/Tutorial/TutorialREST.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="todo-rest">
<h1>10.2. チュートリアル(Todoアプリケーション REST編)<a class="headerlink" href="#todo-rest" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="id1">
<p class="topic-title">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#id2" id="id25">はじめに</a><ul>
<li><a class="reference internal" href="#id3" id="id26">このチュートリアルで学ぶこと</a></li>
<li><a class="reference internal" href="#id4" id="id27">対象読者</a></li>
<li><a class="reference internal" href="#id5" id="id28">検証環境</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6" id="id29">環境構築</a><ul>
<li><a class="reference internal" href="#dhc" id="id30">DHCのインストール</a></li>
<li><a class="reference internal" href="#id7" id="id31">プロジェクト作成</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rest-api" id="id32">REST APIの作成</a><ul>
<li><a class="reference internal" href="#api" id="id33">API仕様</a><ul>
<li><a class="reference internal" href="#get-todos" id="id34">GET Todos</a></li>
<li><a class="reference internal" href="#post-todos" id="id35">POST Todos</a></li>
<li><a class="reference internal" href="#get-todo" id="id36">GET Todo</a></li>
<li><a class="reference internal" href="#put-todo" id="id37">PUT Todo</a></li>
<li><a class="reference internal" href="#delete-todo" id="id38">DELETE Todo</a></li>
<li><a class="reference internal" href="#id8" id="id39">エラー応答</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rest-apidispatcherservlet" id="id40">REST API用のDispatcherServletを用意</a><ul>
<li><a class="reference internal" href="#web-xml" id="id41">web.xmlの修正</a></li>
<li><a class="reference internal" href="#spring-mvc-rest-xml" id="id42">spring-mvc-rest.xmlの作成</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rest-apispring-security" id="id43">REST API用のSpring Securityの定義追加</a></li>
<li><a class="reference internal" href="#id9" id="id44">REST API用パッケージの作成</a></li>
<li><a class="reference internal" href="#resource" id="id45">Resourceクラスの作成</a></li>
<li><a class="reference internal" href="#controller" id="id46">Controllerクラスの作成</a><ul>
<li><a class="reference internal" href="#id10" id="id47">GET Todosの実装</a></li>
<li><a class="reference internal" href="#id11" id="id48">POST Todosの実装</a></li>
<li><a class="reference internal" href="#id12" id="id49">GET Todoの実装</a></li>
<li><a class="reference internal" href="#id13" id="id50">PUT Todoの実装</a></li>
<li><a class="reference internal" href="#id14" id="id51">DELETE Todoの実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id15" id="id52">例外ハンドリングの実装</a><ul>
<li><a class="reference internal" href="#id16" id="id53">ドメイン層の実装を変更</a></li>
<li><a class="reference internal" href="#id17" id="id54">エラーメッセージの定義</a></li>
<li><a class="reference internal" href="#id18" id="id55">エラーハンドリング用のクラスを格納するパッケージの作成</a></li>
<li><a class="reference internal" href="#id19" id="id56">REST APIのエラーハンドリングを行うクラスの作成</a></li>
<li><a class="reference internal" href="#rest-apijavabean" id="id57">REST APIのエラー情報を保持するJavaBeanの作成</a></li>
<li><a class="reference internal" href="#httpbody" id="id58">HTTPレスポンスBODYにエラー情報を出力するための実装</a></li>
<li><a class="reference internal" href="#id20" id="id59">入力エラーのエラーハンドリングの実装</a></li>
<li><a class="reference internal" href="#id21" id="id60">業務例外のエラーハンドリングの実装</a></li>
<li><a class="reference internal" href="#id22" id="id61">リソース未検出例外のエラーハンドリングの実装</a></li>
<li><a class="reference internal" href="#id23" id="id62">システム例外のエラーハンドリングの実装</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id24" id="id63">おわりに</a></li>
</ul>
</div>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id25">10.2.1. はじめに</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id26">10.2.1.1. このチュートリアルで学ぶこと</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>TERASOLUNA Server Framework for Java (5.x)による基本的なRESTful Webサービスの構築方法</li>
</ul>
</div>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id27">10.2.1.2. 対象読者</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference internal" href="TutorialTodo.html"><span class="doc">チュートリアル(Todoアプリケーション)</span></a>を実施している。</li>
</ul>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id28">10.2.1.3. 検証環境</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">本チュートリアルは以下の環境で動作確認している。</div>
<div class="line">REST Clientとして、Google Chromeの拡張機能を使用するため、Web BrowserはGoogle Chromeを使用する。</div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="30%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">種別</th>
<th class="head">プロダクト</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>REST Client</td>
<td><a class="reference external" href="https://chrome.google.com/webstore/detail/dhc-resthttp-api-client/aejoelaoggembcahagimdiliamlcdmfm">DHC REST Client</a> 1.2.3</td>
</tr>
<tr class="row-odd"><td>上記以外のプロダクト</td>
<td><a class="reference internal" href="TutorialTodo.html"><span class="doc">チュートリアル(Todoアプリケーション)</span></a>と同様</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id6">
<h2><a class="toc-backref" href="#id29">10.2.2. 環境構築</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<p>Java, STS, Maven, Google Chromeについては、﻿<a class="reference internal" href="TutorialTodo.html"><span class="doc">チュートリアル(Todoアプリケーション)</span></a>を実施する事でインストール済みの状態である事を前提とする。</p>
<div class="section" id="dhc">
<h3><a class="toc-backref" href="#id30">10.2.2.1. DHCのインストール</a><a class="headerlink" href="#dhc" title="Permalink to this headline">¶</a></h3>
<p>RESTクライアントして、Chromeの拡張機能である「DHC」をインストールする。</p>
<p>Chromeの「Tools」→「Extensions」を選択する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/install-dev-http-client1.png"><img alt="../_images/install-dev-http-client1.png" src="../_images/install-dev-http-client1.png" style="width: 80%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>「Get more extensions」のリンクを押下する。</p>
<div class="figure">
<img alt="../_images/install-dev-http-client2.png" src="../_images/install-dev-http-client2.png" />
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>検索フォームに「dev http client」を入力して検索する。</p>
<div class="figure">
<img alt="../_images/install-dev-http-client3.png" src="../_images/install-dev-http-client3.png" />
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>DHC REST Clientの「+ ADD TO CHROME」ボタンを押下する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/install-dev-http-client4.png"><img alt="../_images/install-dev-http-client4.png" src="../_images/install-dev-http-client4.png" style="width: 80%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>「Add app」ボタンを押下する。</p>
<div class="figure">
<img alt="../_images/install-dev-http-client5.png" src="../_images/install-dev-http-client5.png" />
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Chromeのアプリケーション一覧を開く(ブラウザのアドレスバーに「chrome://apps/」を指定して開く)と、DHCが追加されている。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/install-dev-http-client6.png"><img alt="../_images/install-dev-http-client6.png" src="../_images/install-dev-http-client6.png" style="width: 40%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">DHCをクリックする。</div>
<div class="line">以下の画面が表示されれば、インストール完了となる。</div>
<div class="line">この画面は、ブラウザのアドレスバーに「chrome-extension://aejoelaoggembcahagimdiliamlcdmfm/dhc.html」を入力する事で開く事もできる。</div>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../_images/install-dev-http-client7.png"><img alt="../_images/install-dev-http-client7.png" src="../_images/install-dev-http-client7.png" style="width: 80%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id7">
<h3><a class="toc-backref" href="#id31">10.2.2.2. プロジェクト作成</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>本チュートリアルでは、「<a class="reference internal" href="TutorialTodo.html"><span class="doc">チュートリアル(Todoアプリケーション)</span></a>」で作成したプロジェクトに対して、
RESTful Webサービスを追加する手順となっている。</p>
<p>そのため、「<a class="reference internal" href="TutorialTodo.html"><span class="doc">チュートリアル(Todoアプリケーション)</span></a>」で作成したプロジェクトが残っていない場合は、
再度「<a class="reference internal" href="TutorialTodo.html"><span class="doc">チュートリアル(Todoアプリケーション)</span></a>」を実施してプロジェクトを作成してほしい。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">再度「<a class="reference internal" href="TutorialTodo.html"><span class="doc">チュートリアル(Todoアプリケーション)</span></a>」を実施する場合は、
ドメイン層の作成まで行えば本チュートリアルを進める事ができる。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="rest-api">
<h2><a class="toc-backref" href="#id32">10.2.3. REST APIの作成</a><a class="headerlink" href="#rest-api" title="Permalink to this headline">¶</a></h2>
<p>本チュートリアルでは、todoテーブルで管理しているデータ(以降、「Todoリソース」呼ぶ)をWeb上に公開するためのREST APIを作成する。</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="20%" />
<col width="10%" />
<col width="30%" />
<col width="15%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">API名</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">HTTP</div>
<div class="line">メソッド</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">パス</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">ステータス</div>
<div class="line">コード</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">GET Todos</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">/api/v1/todos</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">200</div>
<div class="line">(OK)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Todoリソースを全件取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">POST Todos</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">POST</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">/api/v1/todos</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">201</div>
<div class="line">(Created)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Todoリソースを新規作成する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">GET Todo</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">/api/v1/todos/{todoId}</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">200</div>
<div class="line">(OK)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Todoリソースを一件取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">PUT Todo</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">PUT</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">/api/v1/todos/{todoId}</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">200</div>
<div class="line">(OK)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Todoリソースを完了状態に更新する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">DELETE Todo</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">DELETE</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">/api/v1/todos/{todoId}</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">204</div>
<div class="line">(No Content)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Todoリソースを削除する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>パス内に含まれている<code class="docutils literal"><span class="pre">{todoId}</span></code>は、パス変数と呼ばれ、任意の可変値を扱う事ができる。
パス変数を使用する事で、<code class="docutils literal"><span class="pre">GET</span> <span class="pre">/api/v1/todos/123</span></code>と<code class="docutils literal"><span class="pre">GET</span> <span class="pre">/api/v1/todos/456</span></code>を同じAPIで扱う事ができる。</p>
<p class="last">本チュートリアルでは、Todoを一意に識別するためのID(Todo ID)をパス変数として扱っている。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="api">
<h3><a class="toc-backref" href="#id33">10.2.3.1. API仕様</a><a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">HTTPリクエストとレスポンスの具体例を用いて、本チュートリアルで作成するREST APIのインタフェース仕様を示す。</div>
<div class="line">本質的ではないHTTPヘッダー等は例から除いている。</div>
</div>
<div class="section" id="get-todos">
<h4><a class="toc-backref" href="#id34">10.2.3.1.1. GET Todos</a><a class="headerlink" href="#get-todos" title="Permalink to this headline">¶</a></h4>
<p><strong>[リクエスト]</strong></p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>&gt; GET /todo/api/v1/todos HTTP/1.1
</pre></div>
</div>
<p><strong>[レスポンス]</strong></p>
<p>作成済みのTodoリソースのリストをJSON形式で返却する。</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>&lt; HTTP/1.1 <span class="m">200</span> OK
&lt; Content-Type: application/json<span class="p">;</span><span class="nv">charset</span><span class="o">=</span>UTF-8
&lt;
<span class="o">[{</span><span class="s2">&quot;todoId&quot;</span>:<span class="s2">&quot;9aef3ee3-30d4-4a7c-be4a-bc184ca1d558&quot;</span>,<span class="s2">&quot;todoTitle&quot;</span>:<span class="s2">&quot;Hello World!&quot;</span>,<span class="s2">&quot;finished&quot;</span>:false,<span class="s2">&quot;createdAt&quot;</span>:<span class="s2">&quot;2014-02-25T02:21:48.493+0000&quot;</span><span class="o">}]</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="post-todos">
<h4><a class="toc-backref" href="#id35">10.2.3.1.2. POST Todos</a><a class="headerlink" href="#post-todos" title="Permalink to this headline">¶</a></h4>
<p><strong>[リクエスト]</strong></p>
<p>新規作成するTodoリソースの内容(タイトル)をJSON形式で指定する。</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>&gt; POST /todo/api/v1/todos HTTP/1.1
&gt; Content-Type: application/json
&gt; Content-Length: <span class="m">29</span>
&gt;
<span class="o">{</span><span class="s2">&quot;todoTitle&quot;</span>: <span class="s2">&quot;Study Spring&quot;</span><span class="o">}</span>
</pre></div>
</div>
<p><strong>[レスポンス]</strong></p>
<p>作成したTodoリソースをJSON形式で返却する。</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>&lt; HTTP/1.1 <span class="m">201</span> Created
&lt; Content-Type: application/json<span class="p">;</span><span class="nv">charset</span><span class="o">=</span>UTF-8
&lt;
<span class="o">{</span><span class="s2">&quot;todoId&quot;</span>:<span class="s2">&quot;d6101d61-b22c-48ee-9110-e106af6a1404&quot;</span>,<span class="s2">&quot;todoTitle&quot;</span>:<span class="s2">&quot;Study Spring&quot;</span>,<span class="s2">&quot;finished&quot;</span>:false,<span class="s2">&quot;createdAt&quot;</span>:<span class="s2">&quot;2014-02-25T04:05:58.752+0000&quot;</span><span class="o">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="get-todo">
<h4><a class="toc-backref" href="#id36">10.2.3.1.3. GET Todo</a><a class="headerlink" href="#get-todo" title="Permalink to this headline">¶</a></h4>
<p><strong>[リクエスト]</strong></p>
<div class="line-block">
<div class="line">パス変数「<code class="docutils literal"><span class="pre">todoId</span></code>」に、取得対象のTodoリソースのIDを指定する。</div>
<div class="line">下記例では、パス変数「<code class="docutils literal"><span class="pre">todoId</span></code>」に<code class="docutils literal"><span class="pre">9aef3ee3-30d4-4a7c-be4a-bc184ca1d558</span></code>を指定している。</div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span></span>&gt; GET /todo/api/v1/todos/9aef3ee3-30d4-4a7c-be4a-bc184ca1d558 HTTP/1.1
</pre></div>
</div>
<p><strong>[レスポンス]</strong></p>
<p>パス変数「<code class="docutils literal"><span class="pre">todoId</span></code>」に一致するTodoリソースをJSON形式で返却する。</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>&lt; HTTP/1.1 <span class="m">200</span> OK
&lt; Content-Type: application/json<span class="p">;</span><span class="nv">charset</span><span class="o">=</span>UTF-8
&lt;
<span class="o">{</span><span class="s2">&quot;todoId&quot;</span>:<span class="s2">&quot;9aef3ee3-30d4-4a7c-be4a-bc184ca1d558&quot;</span>,<span class="s2">&quot;todoTitle&quot;</span>:<span class="s2">&quot;Hello World!&quot;</span>,<span class="s2">&quot;finished&quot;</span>:false,<span class="s2">&quot;createdAt&quot;</span>:<span class="s2">&quot;2014-02-25T02:21:48.493+0000&quot;</span><span class="o">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="put-todo">
<h4><a class="toc-backref" href="#id37">10.2.3.1.4. PUT Todo</a><a class="headerlink" href="#put-todo" title="Permalink to this headline">¶</a></h4>
<p><strong>[リクエスト]</strong></p>
<div class="line-block">
<div class="line">パス変数「<code class="docutils literal"><span class="pre">todoId</span></code>」に、更新対象のTodoのIDを指定する。</div>
<div class="line">PUT Todoでは、Todoリソースを完了状態に更新するだけなので、リクエストBODYを受け取らないインタフェース仕様にしている。</div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span></span>&gt; PUT /todo/api/v1/todos/9aef3ee3-30d4-4a7c-be4a-bc184ca1d558 HTTP/1.1
</pre></div>
</div>
<p><strong>[レスポンス]</strong></p>
<p>パス変数「<code class="docutils literal"><span class="pre">todoId</span></code>」に一致するTodoリソースを完了状態(<code class="docutils literal"><span class="pre">finished</span></code>フィールドを<code class="docutils literal"><span class="pre">true</span></code>)に更新し、JSON形式で返却する。</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>&lt; HTTP/1.1 <span class="m">200</span> OK
&lt; Content-Type: application/json<span class="p">;</span><span class="nv">charset</span><span class="o">=</span>UTF-8
&lt;
<span class="o">{</span><span class="s2">&quot;todoId&quot;</span>:<span class="s2">&quot;9aef3ee3-30d4-4a7c-be4a-bc184ca1d558&quot;</span>,<span class="s2">&quot;todoTitle&quot;</span>:<span class="s2">&quot;Hello World!&quot;</span>,<span class="s2">&quot;finished&quot;</span>:true,<span class="s2">&quot;createdAt&quot;</span>:<span class="s2">&quot;2014-02-25T02:21:48.493+0000&quot;</span><span class="o">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="delete-todo">
<h4><a class="toc-backref" href="#id38">10.2.3.1.5. DELETE Todo</a><a class="headerlink" href="#delete-todo" title="Permalink to this headline">¶</a></h4>
<p><strong>[リクエスト]</strong></p>
<p>パス変数「<code class="docutils literal"><span class="pre">todoId</span></code>」に、削除対象のTodoリソースのIDを指定する。</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>&gt; DELETE /todo/api/v1/todos/9aef3ee3-30d4-4a7c-be4a-bc184ca1d558 HTTP/1.1
</pre></div>
</div>
<p><strong>[レスポンス]</strong></p>
<p>DELETE Todoでは、Todoリソースの削除が完了した事で返却するリソースが存在しなくなった事を示すために、レスポンスBODYを返却しないインタフェース仕様にしている。</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>&lt; HTTP/1.1 <span class="m">204</span> No Content
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id8">
<h4><a class="toc-backref" href="#id39">10.2.3.1.6. エラー応答</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">REST APIでエラーが発生した場合は、JSON形式でエラー内容を返却する。</div>
<div class="line">以下に代表的なエラー発生時のレスポンス仕様について記載する。</div>
<div class="line">下記以外のエラーパターンもあるが、本チュートリアルでは説明は割愛する。</div>
</div>
<p>﻿<a class="reference internal" href="TutorialTodo.html"><span class="doc">チュートリアル(Todoアプリケーション)</span></a>では、エラーメッセージはプログラムの中でハードコーディングしていたが、本チュートリアルでは、エラーメッセージはエラーコードをキーにプロパティファイルから取得するように修正する。</p>
<p><strong>[入力チェックエラー発生時のレスポンス仕様]</strong></p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>&lt; HTTP/1.1 <span class="m">400</span> Bad Request
&lt; Content-Type: application/json<span class="p">;</span><span class="nv">charset</span><span class="o">=</span>UTF-8
&lt;
<span class="o">{</span><span class="s2">&quot;code&quot;</span>:<span class="s2">&quot;E400&quot;</span>,<span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;[E400] The requested Todo contains invalid values.&quot;</span>,<span class="s2">&quot;details&quot;</span>:<span class="o">[{</span><span class="s2">&quot;code&quot;</span>:<span class="s2">&quot;NotNull&quot;</span>,<span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;todoTitle may not be null.&quot;</span>,target:<span class="s2">&quot;todoTitle&quot;</span><span class="o">}]}</span>
</pre></div>
</div>
<p><strong>[業務エラー発生時のレスポンス仕様]</strong></p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>&lt; HTTP/1.1 <span class="m">409</span> Conflict
&lt; Content-Type: application/json<span class="p">;</span><span class="nv">charset</span><span class="o">=</span>UTF-8
&lt;
<span class="o">{</span><span class="s2">&quot;code&quot;</span>:<span class="s2">&quot;E002&quot;</span>,<span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;[E002] The requested Todo is already finished. (id=353fb5db-151a-4696-9b4a-b958358a5ab3)&quot;</span><span class="o">}</span>
</pre></div>
</div>
<p><strong>[リソース未検出時のレスポンス仕様]</strong></p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>&lt; HTTP/1.1 <span class="m">404</span> Not Found
&lt; Content-Type: application/json<span class="p">;</span><span class="nv">charset</span><span class="o">=</span>UTF-8
&lt;
<span class="o">{</span><span class="s2">&quot;code&quot;</span>:<span class="s2">&quot;E404&quot;</span>,<span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;[E404] The requested Todo is not found. (id=353fb5db-151a-4696-9b4a-b958358a5ab2)&quot;</span><span class="o">}</span>
</pre></div>
</div>
<p><strong>[システムエラー発生時のレスポンス仕様]</strong></p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>&lt; HTTP/1.1 <span class="m">500</span> Internal Server Error
&lt; Content-Type: application/json<span class="p">;</span><span class="nv">charset</span><span class="o">=</span>UTF-8
&lt;
<span class="o">{</span><span class="s2">&quot;code&quot;</span>:<span class="s2">&quot;E500&quot;</span>,<span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;[E500] System error occurred.&quot;</span><span class="o">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="rest-apidispatcherservlet">
<h3><a class="toc-backref" href="#id40">10.2.3.2. REST API用のDispatcherServletを用意</a><a class="headerlink" href="#rest-apidispatcherservlet" title="Permalink to this headline">¶</a></h3>
<p>まず、REST API用のリクエストを処理するための<code class="docutils literal"><span class="pre">DispatcherServlet</span></code>の定義を追加する。</p>
<div class="section" id="web-xml">
<h4><a class="toc-backref" href="#id41">10.2.3.2.1. web.xmlの修正</a><a class="headerlink" href="#web-xml" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">REST API用の設定を追加する。</div>
<div class="line"><code class="docutils literal"><span class="pre">src/main/webapp/WEB-INF/web.xml</span></code></div>
</div>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;web-app</span> <span class="na">xmlns=</span><span class="s">&quot;http://java.sun.com/xml/ns/javaee&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span>
    <span class="na">version=</span><span class="s">&quot;3.0&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;listener&gt;</span>
        <span class="nt">&lt;listener-class&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="nt">&lt;/listener-class&gt;</span>
    <span class="nt">&lt;/listener&gt;</span>
    <span class="nt">&lt;context-param&gt;</span>
        <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
        <span class="c">&lt;!-- Root ApplicationContext --&gt;</span>
        <span class="nt">&lt;param-value&gt;</span>
            classpath*:META-INF/spring/applicationContext.xml
            classpath*:META-INF/spring/spring-security.xml
        <span class="nt">&lt;/param-value&gt;</span>
    <span class="nt">&lt;/context-param&gt;</span>

    <span class="nt">&lt;listener&gt;</span>
        <span class="nt">&lt;listener-class&gt;</span>org.terasoluna.gfw.web.logging.HttpSessionEventLoggingListener<span class="nt">&lt;/listener-class&gt;</span>
    <span class="nt">&lt;/listener&gt;</span>

    <span class="nt">&lt;filter&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>MDCClearFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;filter-class&gt;</span>org.terasoluna.gfw.web.logging.mdc.MDCClearFilter<span class="nt">&lt;/filter-class&gt;</span>
    <span class="nt">&lt;/filter&gt;</span>
    <span class="nt">&lt;filter-mapping&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>MDCClearFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/filter-mapping&gt;</span>

    <span class="nt">&lt;filter&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>exceptionLoggingFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;filter-class&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="nt">&lt;/filter-class&gt;</span>
    <span class="nt">&lt;/filter&gt;</span>
    <span class="nt">&lt;filter-mapping&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>exceptionLoggingFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/filter-mapping&gt;</span>

    <span class="nt">&lt;filter&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>XTrackMDCPutFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;filter-class&gt;</span>org.terasoluna.gfw.web.logging.mdc.XTrackMDCPutFilter<span class="nt">&lt;/filter-class&gt;</span>
    <span class="nt">&lt;/filter&gt;</span>
    <span class="nt">&lt;filter-mapping&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>XTrackMDCPutFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/filter-mapping&gt;</span>

    <span class="nt">&lt;filter&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>CharacterEncodingFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;filter-class&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="nt">&lt;/filter-class&gt;</span>
        <span class="nt">&lt;init-param&gt;</span>
            <span class="nt">&lt;param-name&gt;</span>encoding<span class="nt">&lt;/param-name&gt;</span>
            <span class="nt">&lt;param-value&gt;</span>UTF-8<span class="nt">&lt;/param-value&gt;</span>
        <span class="nt">&lt;/init-param&gt;</span>
        <span class="nt">&lt;init-param&gt;</span>
            <span class="nt">&lt;param-name&gt;</span>forceEncoding<span class="nt">&lt;/param-name&gt;</span>
            <span class="nt">&lt;param-value&gt;</span>true<span class="nt">&lt;/param-value&gt;</span>
        <span class="nt">&lt;/init-param&gt;</span>
    <span class="nt">&lt;/filter&gt;</span>
    <span class="nt">&lt;filter-mapping&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>CharacterEncodingFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/filter-mapping&gt;</span>

    <span class="nt">&lt;filter&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>springSecurityFilterChain<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;filter-class&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="nt">&lt;/filter-class&gt;</span>
    <span class="nt">&lt;/filter&gt;</span>
    <span class="nt">&lt;filter-mapping&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>springSecurityFilterChain<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/filter-mapping&gt;</span>

<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;servlet&gt;</span>
</span><span class="hll">        <span class="nt">&lt;servlet-name&gt;</span>restApiServlet<span class="nt">&lt;/servlet-name&gt;</span>
</span><span class="hll">        <span class="nt">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="nt">&lt;/servlet-class&gt;</span>
</span><span class="hll">        <span class="nt">&lt;init-param&gt;</span>
</span><span class="hll">            <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
</span><span class="hll">            <span class="c">&lt;!-- ApplicationContext for Spring MVC (REST) --&gt;</span>
</span><span class="hll">            <span class="nt">&lt;param-value&gt;</span>classpath*:META-INF/spring/spring-mvc-rest.xml<span class="nt">&lt;/param-value&gt;</span>
</span><span class="hll">        <span class="nt">&lt;/init-param&gt;</span>
</span><span class="hll">        <span class="nt">&lt;load-on-startup&gt;</span>1<span class="nt">&lt;/load-on-startup&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/servlet&gt;</span>
</span>
<span class="hll">    <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;servlet-mapping&gt;</span>
</span><span class="hll">        <span class="nt">&lt;servlet-name&gt;</span>restApiServlet<span class="nt">&lt;/servlet-name&gt;</span>
</span><span class="hll">        <span class="nt">&lt;url-pattern&gt;</span>/api/v1/*<span class="nt">&lt;/url-pattern&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/servlet-mapping&gt;</span>
</span>
    <span class="nt">&lt;servlet&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>appServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="nt">&lt;/servlet-class&gt;</span>
        <span class="nt">&lt;init-param&gt;</span>
            <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
            <span class="c">&lt;!-- ApplicationContext for Spring MVC --&gt;</span>
            <span class="nt">&lt;param-value&gt;</span>classpath*:META-INF/spring/spring-mvc.xml<span class="nt">&lt;/param-value&gt;</span>
        <span class="nt">&lt;/init-param&gt;</span>
        <span class="nt">&lt;load-on-startup&gt;</span>1<span class="nt">&lt;/load-on-startup&gt;</span>
    <span class="nt">&lt;/servlet&gt;</span>
    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>appServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>

    <span class="nt">&lt;jsp-config&gt;</span>
        <span class="nt">&lt;jsp-property-group&gt;</span>
            <span class="nt">&lt;url-pattern&gt;</span>*.jsp<span class="nt">&lt;/url-pattern&gt;</span>
            <span class="nt">&lt;el-ignored&gt;</span>false<span class="nt">&lt;/el-ignored&gt;</span>
            <span class="nt">&lt;page-encoding&gt;</span>UTF-8<span class="nt">&lt;/page-encoding&gt;</span>
            <span class="nt">&lt;scripting-invalid&gt;</span>false<span class="nt">&lt;/scripting-invalid&gt;</span>
            <span class="nt">&lt;include-prelude&gt;</span>/WEB-INF/views/common/include.jsp<span class="nt">&lt;/include-prelude&gt;</span>
        <span class="nt">&lt;/jsp-property-group&gt;</span>
    <span class="nt">&lt;/jsp-config&gt;</span>

    <span class="nt">&lt;error-page&gt;</span>
        <span class="nt">&lt;error-code&gt;</span>500<span class="nt">&lt;/error-code&gt;</span>
        <span class="nt">&lt;location&gt;</span>/WEB-INF/views/common/error/systemError.jsp<span class="nt">&lt;/location&gt;</span>
    <span class="nt">&lt;/error-page&gt;</span>

    <span class="nt">&lt;error-page&gt;</span>
        <span class="nt">&lt;error-code&gt;</span>404<span class="nt">&lt;/error-code&gt;</span>
        <span class="nt">&lt;location&gt;</span>/WEB-INF/views/common/error/resourceNotFoundError.jsp<span class="nt">&lt;/location&gt;</span>
    <span class="nt">&lt;/error-page&gt;</span>

    <span class="nt">&lt;error-page&gt;</span>
        <span class="nt">&lt;exception-type&gt;</span>java.lang.Exception<span class="nt">&lt;/exception-type&gt;</span>
        <span class="nt">&lt;location&gt;</span>/WEB-INF/views/common/error/unhandledSystemError.html<span class="nt">&lt;/location&gt;</span>
    <span class="nt">&lt;/error-page&gt;</span>

    <span class="nt">&lt;session-config&gt;</span>
        <span class="c">&lt;!-- 30min --&gt;</span>
        <span class="nt">&lt;session-timeout&gt;</span>30<span class="nt">&lt;/session-timeout&gt;</span>
        <span class="nt">&lt;cookie-config&gt;</span>
            <span class="nt">&lt;http-only&gt;</span>true<span class="nt">&lt;/http-only&gt;</span>
            <span class="c">&lt;!-- &lt;secure&gt;true&lt;/secure&gt; --&gt;</span>
        <span class="nt">&lt;/cookie-config&gt;</span>
        <span class="nt">&lt;tracking-mode&gt;</span>COOKIE<span class="nt">&lt;/tracking-mode&gt;</span>
    <span class="nt">&lt;/session-config&gt;</span>

<span class="nt">&lt;/web-app&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">初期化パラメータ「<code class="docutils literal"><span class="pre">contextConfigLocation</span></code>」に、REST用のSpringMVC設定ファイルを指定する。</div>
<div class="line">本チュートリアルでは、クラスパス上にある「<code class="file docutils literal"><span class="pre">META-INF/spring/spring-mvc-rest.xml</span></code>」を指定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;url-pattern&gt;</span></code>要素に、REST API用の<code class="docutils literal"><span class="pre">DispatcherServlet</span></code>にマッピングするURLのパターンを指定する。</div>
<div class="line">本チュートリアルでは、<code class="docutils literal"><span class="pre">/api/v1/</span></code>から始まる場合はリクエストをREST APIへのリクエストとしてREST API用の<code class="docutils literal"><span class="pre">DispatcherServlet</span></code>へマッピングしている。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="spring-mvc-rest-xml">
<h4><a class="toc-backref" href="#id42">10.2.3.2.2. spring-mvc-rest.xmlの作成</a><a class="headerlink" href="#spring-mvc-rest-xml" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="file docutils literal"><span class="pre">src/main/resources/META-INF/spring/spring-mvc.xml</span></code>をコピーして、REST用のSpring MVC設定ファイルを作成する。</div>
<div class="line">REST用のSpringMVC設定ファイルは以下のような定義となる。</div>
</div>
<div class="figure">
<img alt="../_images/add-spring-mvc-rest.png" src="../_images/add-spring-mvc-rest.png" />
</div>
<p><code class="docutils literal"><span class="pre">src/main/resources/META-INF/spring/spring-mvc-rest.xml</span></code></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
    <span class="na">xmlns:mvc=</span><span class="s">&quot;http://www.springframework.org/schema/mvc&quot;</span>
    <span class="na">xmlns:util=</span><span class="s">&quot;http://www.springframework.org/schema/util&quot;</span>
    <span class="na">xmlns:aop=</span><span class="s">&quot;http://www.springframework.org/schema/aop&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd</span>
<span class="s">        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">        http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd</span>
<span class="s">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
<span class="s">        http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd</span>
<span class="s">    &quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;context:property-placeholder</span>
        <span class="na">location=</span><span class="s">&quot;classpath*:/META-INF/spring/*.properties&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;mvc:annotation-driven&gt;</span>
        <span class="nt">&lt;mvc:argument-resolvers&gt;</span>
            <span class="nt">&lt;bean</span>
                <span class="na">class=</span><span class="s">&quot;org.springframework.data.web.PageableHandlerMethodArgumentResolver&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;bean</span>
                <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.method.annotation.AuthenticationPrincipalArgumentResolver&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/mvc:argument-resolvers&gt;</span>
        <span class="c">&lt;!-- workaround to CVE-2016-5007. --&gt;</span>
        <span class="nt">&lt;mvc:path-matching</span> <span class="na">path-matcher=</span><span class="s">&quot;pathMatcher&quot;</span> <span class="nt">/&gt;</span>
<span class="hll">        <span class="nt">&lt;mvc:message-converters</span> <span class="na">register-defaults=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">            <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">            <span class="nt">&lt;bean</span>
</span><span class="hll">                <span class="na">class=</span><span class="s">&quot;org.springframework.http.converter.json.MappingJackson2HttpMessageConverter&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">                <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">                <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;objectMapper&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">                    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;com.fasterxml.jackson.databind.ObjectMapper&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">                        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dateFormat&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">                            <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">                            <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;com.fasterxml.jackson.databind.util.StdDateFormat&quot;</span><span class="nt">/&gt;</span>
</span><span class="hll">                        <span class="nt">&lt;/property&gt;</span>
</span><span class="hll">                    <span class="nt">&lt;/bean&gt;</span>
</span><span class="hll">                <span class="nt">&lt;/property&gt;</span>
</span><span class="hll">            <span class="nt">&lt;/bean&gt;</span>
</span><span class="hll">        <span class="nt">&lt;/mvc:message-converters&gt;</span>
</span>    <span class="nt">&lt;/mvc:annotation-driven&gt;</span>

    <span class="nt">&lt;mvc:default-servlet-handler</span> <span class="nt">/&gt;</span>

<span class="hll">    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">&quot;todo.api&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
</span>
    <span class="nt">&lt;mvc:interceptors&gt;</span>
        <span class="nt">&lt;mvc:interceptor&gt;</span>
            <span class="nt">&lt;mvc:mapping</span> <span class="na">path=</span><span class="s">&quot;/**&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/resources/**&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/**/*.html&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;bean</span>
                <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.logging.TraceLoggingInterceptor&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/mvc:interceptor&gt;</span>
        <span class="nt">&lt;mvc:interceptor&gt;</span>
            <span class="nt">&lt;mvc:mapping</span> <span class="na">path=</span><span class="s">&quot;/**&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/resources/**&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/**/*.html&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;bean</span>
                <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.token.transaction.TransactionTokenInterceptor&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/mvc:interceptor&gt;</span>
        <span class="nt">&lt;mvc:interceptor&gt;</span>
            <span class="nt">&lt;mvc:mapping</span> <span class="na">path=</span><span class="s">&quot;/**&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/resources/**&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/**/*.html&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.codelist.CodeListInterceptor&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;codeListIdPattern&quot;</span> <span class="na">value=</span><span class="s">&quot;CL_.+&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/bean&gt;</span>
        <span class="nt">&lt;/mvc:interceptor&gt;</span>
        <span class="c">&lt;!--  REMOVE THIS LINE IF YOU USE JPA</span>
<span class="c">        &lt;mvc:interceptor&gt;</span>
<span class="c">            &lt;mvc:mapping path=&quot;/**&quot; /&gt;</span>
<span class="c">            &lt;mvc:exclude-mapping path=&quot;/resources/**&quot; /&gt;</span>
<span class="c">            &lt;mvc:exclude-mapping path=&quot;/**/*.html&quot; /&gt;</span>
<span class="c">            &lt;bean</span>
<span class="c">                class=&quot;org.springframework.orm.jpa.support.OpenEntityManagerInViewInterceptor&quot; /&gt;</span>
<span class="c">        &lt;/mvc:interceptor&gt;</span>
<span class="c">            REMOVE THIS LINE IF YOU USE JPA  --&gt;</span>
    <span class="nt">&lt;/mvc:interceptors&gt;</span>

    <span class="c">&lt;!-- Settings View Resolver. --&gt;</span>
    <span class="nt">&lt;mvc:view-resolvers&gt;</span>
        <span class="nt">&lt;mvc:jsp</span> <span class="na">prefix=</span><span class="s">&quot;/WEB-INF/views/&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/mvc:view-resolvers&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;requestDataValueProcessor&quot;</span>
        <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.mvc.support.CompositeRequestDataValueProcessor&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg&gt;</span>
            <span class="nt">&lt;util:list&gt;</span>
                <span class="nt">&lt;bean</span>
                    <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.servlet.support.csrf.CsrfRequestDataValueProcessor&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;bean</span>
                    <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.token.transaction.TransactionTokenRequestDataValueProcessor&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/util:list&gt;</span>
        <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!-- Setting Exception Handling. --&gt;</span>
    <span class="c">&lt;!-- Exception Resolver. --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;systemExceptionResolver&quot;</span>
        <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.SystemExceptionResolver&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionCodeResolver&quot;</span> <span class="na">ref=</span><span class="s">&quot;exceptionCodeResolver&quot;</span> <span class="nt">/&gt;</span>
        <span class="c">&lt;!-- Setting and Customization by project. --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;order&quot;</span> <span class="na">value=</span><span class="s">&quot;3&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionMappings&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;map&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;ResourceNotFoundException&quot;</span> <span class="na">value=</span><span class="s">&quot;common/error/resourceNotFoundError&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;BusinessException&quot;</span> <span class="na">value=</span><span class="s">&quot;common/error/businessError&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;InvalidTransactionTokenException&quot;</span> <span class="na">value=</span><span class="s">&quot;common/error/transactionTokenError&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;.DataAccessException&quot;</span> <span class="na">value=</span><span class="s">&quot;common/error/dataAccessError&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/map&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;statusCodes&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;map&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;common/error/resourceNotFoundError&quot;</span> <span class="na">value=</span><span class="s">&quot;404&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;common/error/businessError&quot;</span> <span class="na">value=</span><span class="s">&quot;409&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;common/error/transactionTokenError&quot;</span> <span class="na">value=</span><span class="s">&quot;409&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;common/error/dataAccessError&quot;</span> <span class="na">value=</span><span class="s">&quot;500&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/map&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultErrorView&quot;</span> <span class="na">value=</span><span class="s">&quot;common/error/systemError&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultStatusCode&quot;</span> <span class="na">value=</span><span class="s">&quot;500&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
    <span class="c">&lt;!-- Setting AOP. --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;handlerExceptionResolverLoggingInterceptor&quot;</span>
        <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.HandlerExceptionResolverLoggingInterceptor&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionLogger&quot;</span> <span class="na">ref=</span><span class="s">&quot;exceptionLogger&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;aop:config&gt;</span>
        <span class="nt">&lt;aop:advisor</span> <span class="na">advice-ref=</span><span class="s">&quot;handlerExceptionResolverLoggingInterceptor&quot;</span>
            <span class="na">pointcut=</span><span class="s">&quot;execution(* org.springframework.web.servlet.HandlerExceptionResolver.resolveException(..))&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/aop:config&gt;</span>

    <span class="c">&lt;!-- Setting PathMatcher. --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;pathMatcher&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.util.AntPathMatcher&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;trimTokens&quot;</span> <span class="na">value=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">&lt;mvc:message-converters&gt;</span></code>に、Controllerの引数と返り値で扱うJavaBeanをシリアライズ/デシリアライズするためのクラス(<code class="docutils literal"><span class="pre">org.springframework.http.converter.HttpMessageConverter</span></code>)を設定する。</p>
<p class="last"><code class="docutils literal"><span class="pre">HttpMessageConverter</span></code>は複数設定する事ができるが、本チュートリアルではJSONしか使用しないため、<code class="docutils literal"><span class="pre">MappingJackson2HttpMessageConverter</span></code>のみ指定している。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">MappingJackson2HttpMessageConverter</span></code>の<code class="docutils literal"><span class="pre">objectMapper</span></code>プロパティに、Jacksonより提供されている<code class="docutils literal"><span class="pre">ObjectMapper</span></code>(「JSON &lt;-&gt; JavaBean」の変換を行うためのコンポーネント)を指定する。</p>
<p class="last">本チュートリアルでは、日時型のフォーマットをカスタマイズした<code class="docutils literal"><span class="pre">ObjectMapper</span></code>を指定している。
カスタマイズする必要がない場合は<code class="docutils literal"><span class="pre">objectMapper</span></code>プロパティは省略可能である。</p>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">ObjectMapper</span></code>の<code class="docutils literal"><span class="pre">dateFormat</span></code>プロパティに、日時型フィールドの形式を指定する。</p>
<p class="last">本チュートリアルでは、<code class="docutils literal"><span class="pre">java.util.Date</span></code>オブジェクトをシリアライズする際にISO-8601形式とする。
<code class="docutils literal"><span class="pre">Date</span></code>オブジェクトをシリアライズする際にISO-8601形式にする場合は、<code class="docutils literal"><span class="pre">com.fasterxml.jackson.databind.util.StdDateFormat</span></code>を設定する事で実現する事ができる。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p class="first">REST API用のパッケージ配下のコンポーネントをスキャンする。</p>
<p class="last">本チュートリアルでは、REST API用のパッケージを<code class="docutils literal"><span class="pre">todo.api</span></code>にしている。
画面遷移用のControllerは、<code class="docutils literal"><span class="pre">app</span></code>パッケージ配下に格納していたが、REST API用のControllerは、<code class="docutils literal"><span class="pre">api</span></code>パッケージ配下に格納する事を推奨する。</p>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="rest-apispring-security">
<h3><a class="toc-backref" href="#id43">10.2.3.3. REST API用のSpring Securityの定義追加</a><a class="headerlink" href="#rest-apispring-security" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">ブランクプロジェクトでは、CSRF対策といった、Spring Securityのセキュリティ対策機能が有効になっている。</div>
<div class="line">REST APIを使って構築するWebアプリケーションでも、セキュリティ対策機能は必要である。ただし、本チュートリアルの目的として、</div>
<div class="line">セキュリティ対策の話題は本質的ではないため、機能を無効化し、説明も割愛する。</div>
</div>
<div class="line-block">
<div class="line">以下の設定を追加する事で、Spring Securityのセキュリティ対策機能を無効化することができる。</div>
<div class="line"><code class="docutils literal"><span class="pre">src/main/resources/META-INF/spring/spring-security.xml</span></code></div>
</div>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;</span>
<span class="s">        http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">    &quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;sec:http</span> <span class="na">pattern=</span><span class="s">&quot;/resources/**&quot;</span> <span class="na">security=</span><span class="s">&quot;none&quot;</span><span class="nt">/&gt;</span>

<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;sec:http</span> <span class="na">pattern=</span><span class="s">&quot;/api/v1/**&quot;</span> <span class="na">security=</span><span class="s">&quot;none&quot;</span><span class="nt">/&gt;</span>
</span>
    <span class="nt">&lt;sec:http&gt;</span>
        <span class="nt">&lt;sec:form-login/&gt;</span>
        <span class="nt">&lt;sec:logout/&gt;</span>
        <span class="nt">&lt;sec:access-denied-handler</span> <span class="na">ref=</span><span class="s">&quot;accessDeniedHandler&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;sec:custom-filter</span> <span class="na">ref=</span><span class="s">&quot;userIdMDCPutFilter&quot;</span> <span class="na">after=</span><span class="s">&quot;ANONYMOUS_FILTER&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;sec:session-management</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/sec:http&gt;</span>

    <span class="nt">&lt;sec:authentication-manager</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!-- CSRF Protection --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;accessDeniedHandler&quot;</span>
        <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.access.DelegatingAccessDeniedHandler&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;map&gt;</span>
                <span class="nt">&lt;entry</span>
                    <span class="na">key=</span><span class="s">&quot;org.springframework.security.web.csrf.InvalidCsrfTokenException&quot;</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;bean</span>
                        <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.access.AccessDeniedHandlerImpl&quot;</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;errorPage&quot;</span>
                            <span class="na">value=</span><span class="s">&quot;/WEB-INF/views/common/error/invalidCsrfTokenError.jsp&quot;</span> <span class="nt">/&gt;</span>
                    <span class="nt">&lt;/bean&gt;</span>
                <span class="nt">&lt;/entry&gt;</span>
                <span class="nt">&lt;entry</span>
                    <span class="na">key=</span><span class="s">&quot;org.springframework.security.web.csrf.MissingCsrfTokenException&quot;</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;bean</span>
                        <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.access.AccessDeniedHandlerImpl&quot;</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;errorPage&quot;</span>
                            <span class="na">value=</span><span class="s">&quot;/WEB-INF/views/common/error/missingCsrfTokenError.jsp&quot;</span> <span class="nt">/&gt;</span>
                    <span class="nt">&lt;/bean&gt;</span>
                <span class="nt">&lt;/entry&gt;</span>
            <span class="nt">&lt;/map&gt;</span>
        <span class="nt">&lt;/constructor-arg&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;bean</span>
                <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.access.AccessDeniedHandlerImpl&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;errorPage&quot;</span>
                    <span class="na">value=</span><span class="s">&quot;/WEB-INF/views/common/error/accessDeniedError.jsp&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/bean&gt;</span>
        <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!-- Put UserID into MDC --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;userIdMDCPutFilter&quot;</span> <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.security.web.logging.UserIdMDCPutFilter&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">REST API用のSpring Securityのセキュリティ機能を無効にする定義を追加する。</div>
<div class="line"><code class="docutils literal"><span class="pre">&lt;sec:http&gt;</span></code>要素の<code class="docutils literal"><span class="pre">pattern</span></code>属性に、REST API用のリクエストパスのURLパターンを指定している。</div>
<div class="line">本チュートリアルでは<code class="docutils literal"><span class="pre">/api/v1/</span></code>で始まるリクエストパスをREST API用のリクエストパスとして扱う。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id9">
<h3><a class="toc-backref" href="#id44">10.2.3.4. REST API用パッケージの作成</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>REST API用のクラスを格納するパッケージを作成する。</p>
<div class="line-block">
<div class="line">REST API用のクラスを格納するルートパッケージのパッケージ名は<code class="docutils literal"><span class="pre">api</span></code>として、配下にリソース毎のパッケージ(リソース名の小文字)を作成する事を推奨する。</div>
<div class="line">本チュートリアルで扱うリソースのリソース名はTodoなので、<code class="docutils literal"><span class="pre">todo.api.todo</span></code>パッケージを作成する。</div>
</div>
<div class="figure">
<img alt="../_images/make-package-for-rest.png" src="../_images/make-package-for-rest.png" />
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>作成したパッケージに格納するクラスは、通常以下の３種類となる。
作成するクラスのクラス名は、以下のネーミングルールとする事を推奨する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">[リソース名]Resource</span></code></li>
<li><code class="docutils literal"><span class="pre">[リソース名]RestController</span></code></li>
<li><code class="docutils literal"><span class="pre">[リソース名]Helper</span></code> (必要に応じて)</li>
</ul>
<p>本チュートリアルで扱うリソースのリソース名がTodoなので、</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">TodoResource</span></code></li>
<li><code class="docutils literal"><span class="pre">TodoRestController</span></code></li>
</ul>
<p>を作成する。</p>
<p class="last">本チュートリアルでは、<code class="docutils literal"><span class="pre">TodoRestHelper</span></code>は作成しない。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="resource">
<h3><a class="toc-backref" href="#id45">10.2.3.5. Resourceクラスの作成</a><a class="headerlink" href="#resource" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Todoリソースを表現する<code class="docutils literal"><span class="pre">TodoResource</span></code>クラスを作成する。</div>
<div class="line">本ガイドラインでは、REST APIの入出力となるJSON(またはXML)を表現するJava Beanを<strong>Resourceクラス</strong>と呼ぶ。</div>
</div>
<p><code class="docutils literal"><span class="pre">src/main/java/todo/api/todo/TodoResource.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">todo.api.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoResource</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">todoId</span><span class="p">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="p">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">todoTitle</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">finished</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">Date</span> <span class="n">createdAt</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTodoId</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">todoId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTodoId</span><span class="p">(</span><span class="n">String</span> <span class="n">todoId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">todoId</span> <span class="o">=</span> <span class="n">todoId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTodoTitle</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">todoTitle</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTodoTitle</span><span class="p">(</span><span class="n">String</span> <span class="n">todoTitle</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">todoTitle</span> <span class="o">=</span> <span class="n">todoTitle</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isFinished</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">finished</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFinished</span><span class="p">(</span><span class="kt">boolean</span> <span class="n">finished</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">finished</span> <span class="o">=</span> <span class="n">finished</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">Date</span> <span class="nf">getCreatedAt</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">createdAt</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCreatedAt</span><span class="p">(</span><span class="n">Date</span> <span class="n">createdAt</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">createdAt</span> <span class="o">=</span> <span class="n">createdAt</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>DomainObjectクラス(本チュートリアルでは<code class="docutils literal"><span class="pre">Todo</span></code>クラス)があるにも関わらず、Resourceクラスを作成する理由は、
クライアントとの入出力で使用するインタフェース上の情報と、業務処理で扱う情報は必ずしも一致しないためである。</p>
<p>これらを混同して使用すると、アプリケーション層の影響がドメイン層におよび、保守性を低下させる。
DomainObjectとResourceクラスは別々に作成し、Dozer等のBeanMapperを利用してデータ変換を行うことを推奨する。</p>
<p>ResourceクラスはFormクラスと役割が似ているが、FormクラスはHTMLの<code class="docutils literal"><span class="pre">&lt;form&gt;</span></code> タグをJavaBeanで表現したもの、
ResourceクラスはREST APIの入出力をJavaBeanで表現したものであり、本質的には異なるものである。</p>
<p class="last">ただし、実体としてはBean Validationのアノテーションを付与したJavaBeanであり、Controllerクラスと同じパッケージに格納することから、
Formクラスとほぼ同じである。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="controller">
<h3><a class="toc-backref" href="#id46">10.2.3.6. Controllerクラスの作成</a><a class="headerlink" href="#controller" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">TodoResource</span></code>のREST APIを提供する<code class="docutils literal"><span class="pre">TodoRestController</span></code>クラスを作成する。</p>
<p><code class="docutils literal"><span class="pre">src/main/java/todo/api/todo/TodoRestController.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">todo.api.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span>

<span class="nd">@RestController</span> <span class="c1">// (1)</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;todos&quot;</span><span class="p">)</span> <span class="c1">// (2)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="p">{</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;RestController</span></code>を指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;RestController</span></code>の詳細については、 <a class="reference internal" href="../ArchitectureInDetail/WebServiceDetail/REST.html#resthowtousecontrollerclass"><span class="std std-ref">RestControllerクラスの作成</span></a> を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースのパスを指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">/api/v1/</span></code>の部分はweb.xmlに定義しているため、この設定を行うことで<code class="docutils literal"><span class="pre">/&lt;contextPath&gt;/api/v1/todos</span></code>というパスにマッピングされる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="id10">
<h4><a class="toc-backref" href="#id47">10.2.3.6.1. GET Todosの実装</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<p>作成済みのTodoリソースを全件取得するAPI(GET Todos)の処理を、<code class="docutils literal"><span class="pre">TodoRestController</span></code>の<code class="docutils literal"><span class="pre">getTodos</span></code>メソッドに実装する。</p>
<p><code class="docutils literal"><span class="pre">src/main/java/todo/api/todo/TodoRestController.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">todo.api.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.dozer.Mapper</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ResponseStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">todo.domain.service.todo.TodoService</span><span class="p">;</span>

<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;todos&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="p">{</span>

<span class="hll">    <span class="nd">@Inject</span>
</span><span class="hll">    <span class="n">TodoService</span> <span class="n">todoService</span><span class="p">;</span>
</span><span class="hll">    <span class="nd">@Inject</span>
</span><span class="hll">    <span class="n">Mapper</span> <span class="n">beanMapper</span><span class="p">;</span>
</span><span class="hll">
</span><span class="hll">    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span> <span class="c1">// (1)</span>
</span><span class="hll">    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span> <span class="c1">// (2)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">TodoResource</span><span class="o">&gt;</span> <span class="nf">getTodos</span><span class="p">()</span> <span class="p">{</span>
</span><span class="hll">        <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span> <span class="o">=</span> <span class="n">todoService</span><span class="p">.</span><span class="na">findAll</span><span class="p">();</span>
</span><span class="hll">        <span class="n">List</span><span class="o">&lt;</span><span class="n">TodoResource</span><span class="o">&gt;</span> <span class="n">todoResources</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span class="hll">        <span class="k">for</span> <span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span> <span class="p">:</span> <span class="n">todos</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">            <span class="n">todoResources</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">todo</span><span class="p">,</span> <span class="n">TodoResource</span><span class="p">.</span><span class="na">class</span><span class="p">));</span> <span class="c1">// (3)</span>
</span><span class="hll">        <span class="p">}</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">todoResources</span><span class="p">;</span> <span class="c1">// (4)</span>
</span><span class="hll">    <span class="p">}</span>
</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">メソッドがGETのリクエストを処理するために、<code class="docutils literal"><span class="pre">method</span></code>属性に<code class="docutils literal"><span class="pre">RequestMethod.GET</span></code>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">応答するHTTPステータスコードを<code class="docutils literal"><span class="pre">&#64;ResponseStatus</span></code>アノテーションに指定する。</div>
<div class="line">HTTPステータスとして、”200 OK”を設定するため、<code class="docutils literal"><span class="pre">value</span></code>属性には<code class="docutils literal"><span class="pre">HttpStatus.OK</span></code>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">TodoService</span></code>の<code class="docutils literal"><span class="pre">findAll</span></code>メソッドから返却された<code class="docutils literal"><span class="pre">Todo</span></code>オブジェクトを、応答するJSONを表現する<code class="docutils literal"><span class="pre">TodoResource</span></code>型のオブジェクトに変換する。</div>
<div class="line"><code class="docutils literal"><span class="pre">Todo</span></code>と<code class="docutils literal"><span class="pre">TodoResource</span></code>の変換処理は、Dozerの<code class="docutils literal"><span class="pre">org.dozer.Mapper</span></code>インタフェースを使うと便利である。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">List&lt;TodoResource&gt;</span></code>オブジェクトを返却することで、<code class="docutils literal"><span class="pre">spring-mvc-rest.xml</span></code>に定義した<code class="docutils literal"><span class="pre">MappingJackson2HttpMessageConverter</span></code>によってJSONにシリアライズされる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Application Serverを起動し、実装したAPIの動作確認を行う。</p>
<div class="line-block">
<div class="line">REST API(Get Todos)にアクセスする。</div>
<div class="line">DHCを開いてURLに<code class="docutils literal"><span class="pre">&quot;localhost:8080/todo/api/v1/todos&quot;</span></code>を入力し、メソッドにGETを指定して、”Send”ボタンをクリックする。</div>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../_images/get-todos1.png"><img alt="../_images/get-todos1.png" src="../_images/get-todos1.png" style="width: 100%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">以下のように「RESPONSE」の「BODY」に実行結果のJSONが表示される。</div>
<div class="line">現時点ではデータが何も登録されていないため、空配列である<code class="docutils literal"><span class="pre">[]</span></code>が返却される。</div>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../_images/get-todos2.png"><img alt="../_images/get-todos2.png" src="../_images/get-todos2.png" style="width: 100%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id11">
<h4><a class="toc-backref" href="#id48">10.2.3.6.2. POST Todosの実装</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<p>Todoリソースを新規作成するAPI(POST Todos)の処理を、<code class="docutils literal"><span class="pre">TodoRestController</span></code>の<code class="docutils literal"><span class="pre">postTodos</span></code>メソッドに実装する。</p>
<p><code class="docutils literal"><span class="pre">src/main/java/todo/api/todo/TodoRestController.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">todo.api.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.dozer.Mapper</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestBody</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ResponseStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">todo.domain.service.todo.TodoService</span><span class="p">;</span>

<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;todos&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">TodoService</span> <span class="n">todoService</span><span class="p">;</span>
    <span class="nd">@Inject</span>
    <span class="n">Mapper</span> <span class="n">beanMapper</span><span class="p">;</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">TodoResource</span><span class="o">&gt;</span> <span class="nf">getTodos</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span> <span class="o">=</span> <span class="n">todoService</span><span class="p">.</span><span class="na">findAll</span><span class="p">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">TodoResource</span><span class="o">&gt;</span> <span class="n">todoResources</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span> <span class="p">:</span> <span class="n">todos</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">todoResources</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">todo</span><span class="p">,</span> <span class="n">TodoResource</span><span class="p">.</span><span class="na">class</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">todoResources</span><span class="p">;</span>
    <span class="p">}</span>

<span class="hll">    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span> <span class="c1">// (1)</span>
</span><span class="hll">    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">CREATED</span><span class="p">)</span> <span class="c1">// (2)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">TodoResource</span> <span class="nf">postTodos</span><span class="p">(</span><span class="nd">@RequestBody</span> <span class="nd">@Validated</span> <span class="n">TodoResource</span> <span class="n">todoResource</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (3)</span>
</span><span class="hll">        <span class="n">Todo</span> <span class="n">createdTodo</span> <span class="o">=</span> <span class="n">todoService</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">todoResource</span><span class="p">,</span> <span class="n">Todo</span><span class="p">.</span><span class="na">class</span><span class="p">));</span> <span class="c1">// (4)</span>
</span><span class="hll">        <span class="n">TodoResource</span> <span class="n">createdTodoResponse</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">createdTodo</span><span class="p">,</span> <span class="n">TodoResource</span><span class="p">.</span><span class="na">class</span><span class="p">);</span> <span class="c1">// (5)</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">createdTodoResponse</span><span class="p">;</span> <span class="c1">// (6)</span>
</span><span class="hll">    <span class="p">}</span>
</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">メソッドがPOSTのリクエストを処理するために、<code class="docutils literal"><span class="pre">method</span></code>属性に<code class="docutils literal"><span class="pre">RequestMethod.POST</span></code>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">応答するHTTPステータスコードを<code class="docutils literal"><span class="pre">&#64;ResponseStatus</span></code>アノテーションに指定する。</div>
<div class="line">HTTPステータスとして、”201 Created”を設定するため、<code class="docutils literal"><span class="pre">value</span></code>属性には<code class="docutils literal"><span class="pre">HttpStatus.CREATED</span></code>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">HTTPリクエストのBody(JSON)をJavaBeanにマッピングするために、<code class="docutils literal"><span class="pre">&#64;RequestBody</span></code>アノテーションをマッピング対象の<code class="docutils literal"><span class="pre">TodoResource</span></code>クラスに付与する。</div>
<div class="line">また、入力チェックするために<code class="docutils literal"><span class="pre">&#64;Validated</span></code>も付与する。例外ハンドリングは別途行う必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">TodoResource</span></code>を<code class="docutils literal"><span class="pre">Todo</span></code>クラスに変換後、<code class="docutils literal"><span class="pre">TodoService</span></code>の<code class="docutils literal"><span class="pre">create</span></code>メソッドを実行し、Todoリソースを新規作成する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">TodoService</span></code>の<code class="docutils literal"><span class="pre">create</span></code>メソッドによって新規作成された<code class="docutils literal"><span class="pre">Todo</span></code>オブジェクトを、応答するJSONを表現する<code class="docutils literal"><span class="pre">TodoResource</span></code>型に変換する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">TodoResource</span></code>オブジェクトを返却することで、<code class="docutils literal"><span class="pre">spring-mvc-rest.xml</span></code>に定義した<code class="docutils literal"><span class="pre">MappingJackson2HttpMessageConverter</span></code>によってJSONにシリアライズされる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">DHCを使用して、実装したAPIの動作確認を行う。</div>
<div class="line">DHCを開いてURLに<code class="docutils literal"><span class="pre">&quot;localhost:8080/todo/api/v1/todos&quot;</span></code>を入力し、メソッドにPOSTを指定する。</div>
<div class="line">「REQUEST」の「BODY」に以下のJSONを入力する。</div>
</div>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;todoTitle&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello World!&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>また、「REQUEST」の「HEADERS」の「+」ボタンでHTTPヘッダーを追加し、「<code class="docutils literal"><span class="pre">Content-Type</span></code>」に「<code class="docutils literal"><span class="pre">application/json</span></code>」を設定後、”Send”ボタンをクリックする。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/post-todos1.png"><img alt="../_images/post-todos1.png" src="../_images/post-todos1.png" style="width: 100%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>“201 Created”のHTTPステータスが返却され、「RESPONSE」の「Body」に新規作成されたTodoリソースのJSONが表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/post-todos2.png"><img alt="../_images/post-todos2.png" src="../_images/post-todos2.png" style="width: 100%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>この状態で再びGET Todosを実行すると、作成したTodoリソースを含む配列が返却される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/get-todos3.png"><img alt="../_images/get-todos3.png" src="../_images/get-todos3.png" style="width: 100%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id12">
<h4><a class="toc-backref" href="#id49">10.2.3.6.3. GET Todoの実装</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<p>﻿<a class="reference internal" href="TutorialTodo.html"><span class="doc">チュートリアル(Todoアプリケーション)</span></a>では、<code class="docutils literal"><span class="pre">TodoService</span></code>に一件取得用のメソッド(<code class="docutils literal"><span class="pre">findOne</span></code>)を作成しなかったため、
<code class="docutils literal"><span class="pre">TodoService</span></code>と<code class="docutils literal"><span class="pre">TodoServiceImpl</span></code>に以下のハイライト部を追加する。</p>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">findOne</span></code>メソッドの定義を追加する。</div>
<div class="line"><code class="docutils literal"><span class="pre">src/main/java/todo/domain/service/todo/TodoService.java</span></code></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">todo.domain.service.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoService</span> <span class="p">{</span>
    <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="p">();</span>

<span class="hll">    <span class="n">Todo</span> <span class="nf">findOne</span><span class="p">(</span><span class="n">String</span> <span class="n">todoId</span><span class="p">);</span>
</span>
    <span class="n">Todo</span> <span class="nf">create</span><span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="p">);</span>

    <span class="n">Todo</span> <span class="nf">finish</span><span class="p">(</span><span class="n">String</span> <span class="n">todoId</span><span class="p">);</span>

    <span class="kt">void</span> <span class="nf">delete</span><span class="p">(</span><span class="n">String</span> <span class="n">todoId</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">findOne</span></code>メソッド呼び出し時に開始されるトランザクションを読み取り専用に設定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">src/main/java/todo/domain/service/todo/TodoServiceImpl.java</span></code></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">todo.domain.service.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.UUID</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.BusinessException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.ResourceNotFoundException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessage</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessages</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">todo.domain.repository.todo.TodoRepository</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">MAX_UNFINISHED_COUNT</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">TodoRepository</span> <span class="n">todoRepository</span><span class="p">;</span>

    <span class="nd">@Override</span>
<span class="hll">    <span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="p">)</span>
</span>    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">findOne</span><span class="p">(</span><span class="n">String</span> <span class="n">todoId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">todoId</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">todo</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ResultMessages</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="p">.</span><span class="na">error</span><span class="p">();</span>
            <span class="n">messages</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">ResultMessage</span>
                    <span class="p">.</span><span class="na">fromText</span><span class="p">(</span><span class="s">&quot;[E404] The requested Todo is not found. (id=&quot;</span>
                            <span class="o">+</span> <span class="n">todoId</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="p">));</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">ResourceNotFoundException</span><span class="p">(</span><span class="n">messages</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">todo</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">todoRepository</span><span class="p">.</span><span class="na">findAll</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">create</span><span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">long</span> <span class="n">unfinishedCount</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="p">.</span><span class="na">countByFinished</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">unfinishedCount</span> <span class="o">&gt;=</span> <span class="n">MAX_UNFINISHED_COUNT</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ResultMessages</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="p">.</span><span class="na">error</span><span class="p">();</span>
            <span class="n">messages</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">ResultMessage</span>
                    <span class="p">.</span><span class="na">fromText</span><span class="p">(</span><span class="s">&quot;[E001] The count of un-finished Todo must not be over &quot;</span>
                            <span class="o">+</span> <span class="n">MAX_UNFINISHED_COUNT</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span><span class="p">));</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="p">(</span><span class="n">messages</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">String</span> <span class="n">todoId</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">();</span>
        <span class="n">Date</span> <span class="n">createdAt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="p">();</span>

        <span class="n">todo</span><span class="p">.</span><span class="na">setTodoId</span><span class="p">(</span><span class="n">todoId</span><span class="p">);</span>
        <span class="n">todo</span><span class="p">.</span><span class="na">setCreatedAt</span><span class="p">(</span><span class="n">createdAt</span><span class="p">);</span>
        <span class="n">todo</span><span class="p">.</span><span class="na">setFinished</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

        <span class="n">todoRepository</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span>
        <span class="cm">/* REMOVE THIS LINE IF YOU USE JPA</span>
<span class="cm">            todoRepository.save(todo);</span>
<span class="cm">           REMOVE THIS LINE IF YOU USE JPA */</span>

        <span class="k">return</span> <span class="n">todo</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">finish</span><span class="p">(</span><span class="n">String</span> <span class="n">todoId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">findOne</span><span class="p">(</span><span class="n">todoId</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">todo</span><span class="p">.</span><span class="na">isFinished</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">ResultMessages</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="p">.</span><span class="na">error</span><span class="p">();</span>
            <span class="n">messages</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">ResultMessage</span>
                    <span class="p">.</span><span class="na">fromText</span><span class="p">(</span><span class="s">&quot;[E002] The requested Todo is already finished. (id=&quot;</span>
                            <span class="o">+</span> <span class="n">todoId</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="p">));</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="p">(</span><span class="n">messages</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">todo</span><span class="p">.</span><span class="na">setFinished</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
        <span class="n">todoRepository</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span>
        <span class="cm">/* REMOVE THIS LINE IF YOU USE JPA</span>
<span class="cm">            todoRepository.save(todo);</span>
<span class="cm">           REMOVE THIS LINE IF YOU USE JPA */</span>
        <span class="k">return</span> <span class="n">todo</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="p">(</span><span class="n">String</span> <span class="n">todoId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">findOne</span><span class="p">(</span><span class="n">todoId</span><span class="p">);</span>
        <span class="n">todoRepository</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">Todoリソースを一件取得するAPI(GET Todo)の処理を、<code class="docutils literal"><span class="pre">TodoRestController</span></code>の<code class="docutils literal"><span class="pre">getTodo</span></code>メソッドに実装する。</div>
<div class="line"><code class="docutils literal"><span class="pre">src/main/java/todo/api/todo/TodoRestController.java</span></code></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">todo.api.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.dozer.Mapper</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PathVariable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestBody</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ResponseStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">todo.domain.service.todo.TodoService</span><span class="p">;</span>

<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;todos&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">TodoService</span> <span class="n">todoService</span><span class="p">;</span>
    <span class="nd">@Inject</span>
    <span class="n">Mapper</span> <span class="n">beanMapper</span><span class="p">;</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">TodoResource</span><span class="o">&gt;</span> <span class="nf">getTodos</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span> <span class="o">=</span> <span class="n">todoService</span><span class="p">.</span><span class="na">findAll</span><span class="p">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">TodoResource</span><span class="o">&gt;</span> <span class="n">todoResources</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span> <span class="p">:</span> <span class="n">todos</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">todoResources</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">todo</span><span class="p">,</span> <span class="n">TodoResource</span><span class="p">.</span><span class="na">class</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">todoResources</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">CREATED</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">TodoResource</span> <span class="nf">postTodos</span><span class="p">(</span><span class="nd">@RequestBody</span> <span class="nd">@Validated</span> <span class="n">TodoResource</span> <span class="n">todoResource</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Todo</span> <span class="n">createdTodo</span> <span class="o">=</span> <span class="n">todoService</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">todoResource</span><span class="p">,</span> <span class="n">Todo</span><span class="p">.</span><span class="na">class</span><span class="p">));</span>
        <span class="n">TodoResource</span> <span class="n">createdTodoResponse</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">createdTodo</span><span class="p">,</span> <span class="n">TodoResource</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">createdTodoResponse</span><span class="p">;</span>
    <span class="p">}</span>

<span class="hll">    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s">&quot;{todoId}&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span> <span class="c1">// (1)</span>
</span><span class="hll">    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">TodoResource</span> <span class="nf">getTodo</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;todoId&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">todoId</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (2)</span>
</span><span class="hll">        <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">todoService</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">todoId</span><span class="p">);</span> <span class="c1">// (3)</span>
</span><span class="hll">        <span class="n">TodoResource</span> <span class="n">todoResource</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">todo</span><span class="p">,</span> <span class="n">TodoResource</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">todoResource</span><span class="p">;</span>
</span><span class="hll">    <span class="p">}</span>
</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスから<code class="docutils literal"><span class="pre">todoId</span></code>を取得するために、<code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>アノテーションの<code class="docutils literal"><span class="pre">value</span></code>属性にパス変数を指定する。</div>
<div class="line">メソッドがGETのリクエストを処理するために、<code class="docutils literal"><span class="pre">method</span></code>属性に<code class="docutils literal"><span class="pre">RequestMethod.GET</span></code>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;PathVariable</span></code>アノテーションの<code class="docutils literal"><span class="pre">value</span></code>属性に、<code class="docutils literal"><span class="pre">todoId</span></code>を取得するためのパス変数名を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パス変数から取得した<code class="docutils literal"><span class="pre">todoId</span></code>を使用して、Todoリソースを一件を取得する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">DHCを使用して、実装したAPIの動作確認を行う。</div>
<div class="line">DHCを開いてURLに<code class="docutils literal"><span class="pre">&quot;localhost:8080/todo/api/v1/todos/{todoId}&quot;</span></code>を入力し、メソッドにGETを指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">{todoId}</span></code>の部分は実際のIDを入れる必要があるので、POST TodosまたはGET Todosを実行してResponse中の<code class="docutils literal"><span class="pre">todoId</span></code>をコピーして貼り付けてから、”Send”ボタンをクリックする。</div>
</div>
<p>“200 OK”のHTTPステータスが返却され、「RESPONSE」の「Body」に指定したTodoリソースのJSONが表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/get-todo1.png"><img alt="../_images/get-todo1.png" src="../_images/get-todo1.png" style="width: 100%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id13">
<h4><a class="toc-backref" href="#id50">10.2.3.6.4. PUT Todoの実装</a><a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h4>
<p>Todoリソースを一件更新(完了状態へ更新)するAPI(PUT Todo)の処理を、<code class="docutils literal"><span class="pre">TodoRestController</span></code>の<code class="docutils literal"><span class="pre">putTodo</span></code>メソッドに実装する。</p>
<p><code class="docutils literal"><span class="pre">src/main/java/todo/api/todo/TodoRestController.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">todo.api.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.dozer.Mapper</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PathVariable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestBody</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ResponseStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">todo.domain.service.todo.TodoService</span><span class="p">;</span>

<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;todos&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">TodoService</span> <span class="n">todoService</span><span class="p">;</span>
    <span class="nd">@Inject</span>
    <span class="n">Mapper</span> <span class="n">beanMapper</span><span class="p">;</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">TodoResource</span><span class="o">&gt;</span> <span class="nf">getTodos</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span> <span class="o">=</span> <span class="n">todoService</span><span class="p">.</span><span class="na">findAll</span><span class="p">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">TodoResource</span><span class="o">&gt;</span> <span class="n">todoResources</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span> <span class="p">:</span> <span class="n">todos</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">todoResources</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">todo</span><span class="p">,</span> <span class="n">TodoResource</span><span class="p">.</span><span class="na">class</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">todoResources</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">CREATED</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">TodoResource</span> <span class="nf">postTodos</span><span class="p">(</span><span class="nd">@RequestBody</span> <span class="nd">@Validated</span> <span class="n">TodoResource</span> <span class="n">todoResource</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Todo</span> <span class="n">createdTodo</span> <span class="o">=</span> <span class="n">todoService</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">todoResource</span><span class="p">,</span> <span class="n">Todo</span><span class="p">.</span><span class="na">class</span><span class="p">));</span>
        <span class="n">TodoResource</span> <span class="n">createdTodoResponse</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">createdTodo</span><span class="p">,</span> <span class="n">TodoResource</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">createdTodoResponse</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s">&quot;{todoId}&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">TodoResource</span> <span class="nf">getTodo</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;todoId&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">todoId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">todoService</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">todoId</span><span class="p">);</span>
        <span class="n">TodoResource</span> <span class="n">todoResource</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">todo</span><span class="p">,</span> <span class="n">TodoResource</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">todoResource</span><span class="p">;</span>
    <span class="p">}</span>

<span class="hll">    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s">&quot;{todoId}&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">PUT</span><span class="p">)</span> <span class="c1">// (1)</span>
</span><span class="hll">    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">TodoResource</span> <span class="nf">putTodo</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;todoId&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">todoId</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (2)</span>
</span><span class="hll">        <span class="n">Todo</span> <span class="n">finishedTodo</span> <span class="o">=</span> <span class="n">todoService</span><span class="p">.</span><span class="na">finish</span><span class="p">(</span><span class="n">todoId</span><span class="p">);</span> <span class="c1">// (3)</span>
</span><span class="hll">        <span class="n">TodoResource</span> <span class="n">finishedTodoResource</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">finishedTodo</span><span class="p">,</span> <span class="n">TodoResource</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">finishedTodoResource</span><span class="p">;</span>
</span><span class="hll">    <span class="p">}</span>
</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスから<code class="docutils literal"><span class="pre">todoId</span></code>を取得するために、<code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>アノテーションの<code class="docutils literal"><span class="pre">value</span></code>属性にパス変数を指定する。</div>
<div class="line">メソッドがPUTのリクエストを処理するために、<code class="docutils literal"><span class="pre">method</span></code>属性に<code class="docutils literal"><span class="pre">RequestMethod.PUT</span></code>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;PathVariable</span></code>アノテーションの<code class="docutils literal"><span class="pre">value</span></code>属性に、<code class="docutils literal"><span class="pre">todoId</span></code>を取得するためのパス変数名を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パス変数から取得した<code class="docutils literal"><span class="pre">todoId</span></code>を使用して、Todoリソースを完了状態へ更新する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">DHCを使用して、実装したAPIの動作確認を行う。</div>
<div class="line">DHCを開いてURLに<code class="docutils literal"><span class="pre">&quot;localhost:8080/todo/api/v1/todos/{todoId}&quot;</span></code>を入力し、メソッドにPUTを指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">{todoId}</span></code>の部分は実際のIDを入れる必要があるので、POST TodosまたはGET Todosを実行してResponse中の<code class="docutils literal"><span class="pre">todoId</span></code>をコピーして貼り付けてから、”Send”ボタンをクリックする。</div>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../_images/put-todo1.png"><img alt="../_images/put-todo1.png" src="../_images/put-todo1.png" style="width: 100%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">“200 OK”のHTTPステータスが返却され、「RESPONSE」の「Body」に更新されたTodoリソースのJSONが表示される。</div>
<div class="line"><code class="docutils literal"><span class="pre">finished</span></code>が<code class="docutils literal"><span class="pre">true</span></code>に更新されている。</div>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../_images/put-todo2.png"><img alt="../_images/put-todo2.png" src="../_images/put-todo2.png" style="width: 100%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id14">
<h4><a class="toc-backref" href="#id51">10.2.3.6.5. DELETE Todoの実装</a><a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h4>
<p>最後に、Todoリソースを一件削除するAPI(DELETE Todo)の処理を、<code class="docutils literal"><span class="pre">TodoRestController</span></code>の<code class="docutils literal"><span class="pre">deleteTodo</span></code>メソッドに実装する。</p>
<p><code class="docutils literal"><span class="pre">src/main/java/todo/api/todo/TodoRestController.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">todo.api.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.dozer.Mapper</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PathVariable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestBody</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ResponseStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">todo.domain.service.todo.TodoService</span><span class="p">;</span>

<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;todos&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">TodoService</span> <span class="n">todoService</span><span class="p">;</span>
    <span class="nd">@Inject</span>
    <span class="n">Mapper</span> <span class="n">beanMapper</span><span class="p">;</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">TodoResource</span><span class="o">&gt;</span> <span class="nf">getTodos</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span> <span class="o">=</span> <span class="n">todoService</span><span class="p">.</span><span class="na">findAll</span><span class="p">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">TodoResource</span><span class="o">&gt;</span> <span class="n">todoResources</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span> <span class="p">:</span> <span class="n">todos</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">todoResources</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">todo</span><span class="p">,</span> <span class="n">TodoResource</span><span class="p">.</span><span class="na">class</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">todoResources</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">CREATED</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">TodoResource</span> <span class="nf">postTodos</span><span class="p">(</span><span class="nd">@RequestBody</span> <span class="nd">@Validated</span> <span class="n">TodoResource</span> <span class="n">todoResource</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Todo</span> <span class="n">createdTodo</span> <span class="o">=</span> <span class="n">todoService</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">todoResource</span><span class="p">,</span> <span class="n">Todo</span><span class="p">.</span><span class="na">class</span><span class="p">));</span>
        <span class="n">TodoResource</span> <span class="n">createdTodoResponse</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">createdTodo</span><span class="p">,</span> <span class="n">TodoResource</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">createdTodoResponse</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s">&quot;{todoId}&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">TodoResource</span> <span class="nf">getTodo</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;todoId&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">todoId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">todoService</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">todoId</span><span class="p">);</span>
        <span class="n">TodoResource</span> <span class="n">todoResource</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">todo</span><span class="p">,</span> <span class="n">TodoResource</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">todoResource</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s">&quot;{todoId}&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">PUT</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">TodoResource</span> <span class="nf">putTodo</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;todoId&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">todoId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Todo</span> <span class="n">finishedTodo</span> <span class="o">=</span> <span class="n">todoService</span><span class="p">.</span><span class="na">finish</span><span class="p">(</span><span class="n">todoId</span><span class="p">);</span>
        <span class="n">TodoResource</span> <span class="n">finishedTodoResource</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">finishedTodo</span><span class="p">,</span> <span class="n">TodoResource</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">finishedTodoResource</span><span class="p">;</span>
    <span class="p">}</span>

<span class="hll">    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s">&quot;{todoId}&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">DELETE</span><span class="p">)</span> <span class="c1">// (1)</span>
</span><span class="hll">    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">NO_CONTENT</span><span class="p">)</span> <span class="c1">// (2)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteTodo</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;todoId&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">todoId</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (3)</span>
</span><span class="hll">        <span class="n">todoService</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">todoId</span><span class="p">);</span> <span class="c1">// (4)</span>
</span><span class="hll">    <span class="p">}</span>
</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスから<code class="docutils literal"><span class="pre">todoId</span></code>を取得するために、<code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>アノテーションの<code class="docutils literal"><span class="pre">value</span></code>属性にパス変数を指定する。</div>
<div class="line">メソッドがDELETEのリクエストを処理するために、<code class="docutils literal"><span class="pre">method</span></code>属性に<code class="docutils literal"><span class="pre">RequestMethod.DELETE</span></code>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">応答するHTTPステータスコードを<code class="docutils literal"><span class="pre">&#64;ResponseStatus</span></code>アノテーションに指定する。</div>
<div class="line">HTTPステータスとして、”204 No Content”を設定するため、<code class="docutils literal"><span class="pre">value</span></code>属性には<code class="docutils literal"><span class="pre">HttpStatus.NO_CONTENT</span></code>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">DELETEの場合は返却するコンテンツがないため、返り値の型を<code class="docutils literal"><span class="pre">void</span></code>とする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パス変数から取得した<code class="docutils literal"><span class="pre">todoId</span></code>を使用して、Todoリソースを削除する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">DHCを使用して、実装したAPIの動作確認を行う。</div>
<div class="line">DHCを開いてURLに<code class="docutils literal"><span class="pre">&quot;localhost:8080/todo/api/v1/todos/{todoId}&quot;</span></code>を入力し、メソッドにDELETEを指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">{todoId}</span></code>の部分は実際のIDを入れる必要があるので、POST TodosまたはGET Todosを実行してResponse中の<code class="docutils literal"><span class="pre">todoId</span></code>をコピーして貼り付けてから、”Send”ボタンをクリックする。</div>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../_images/delete-todo1.png"><img alt="../_images/delete-todo1.png" src="../_images/delete-todo1.png" style="width: 100%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>“204 No Content”のHTTPステータスが返却され、「RESPONSE」の「Body」は空である。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/delete-todo2.png"><img alt="../_images/delete-todo2.png" src="../_images/delete-todo2.png" style="width: 100%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">DHCのURLに<code class="docutils literal"><span class="pre">&quot;localhost:8080/todo/api/v1/todos&quot;</span></code>を入力し、メソッドにGETを指定してから”Send”ボタンをクリックする。</div>
<div class="line">Todoリソースが削除されている事が確認できる。</div>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../_images/delete-todo3.png"><img alt="../_images/delete-todo3.png" src="../_images/delete-todo3.png" style="width: 100%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id15">
<h3><a class="toc-backref" href="#id52">10.2.3.7. 例外ハンドリングの実装</a><a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">本チュートリアルでは、例外ハンドリングの実装方法をイメージしやすくするため、本ガイドラインで推奨している実装よりシンプルな実装にしてある。</div>
<div class="line">実際の例外ハンドリングは、<a class="reference internal" href="../ArchitectureInDetail/WebServiceDetail/REST.html"><span class="doc">RESTful Web Service</span></a>で<strong>説明されている方法でハンドリングを行うことを強く推奨する</strong>。</div>
</div>
<div class="section" id="id16">
<h4><a class="toc-backref" href="#id53">10.2.3.7.1. ドメイン層の実装を変更</a><a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">本チュートリアルでは、エラーコードをキーにプロパティファイルからエラーメッセージを取得する。</div>
<div class="line">そのため、例外ハンドリングの実装を行う前に、<a class="reference internal" href="TutorialTodo.html"><span class="doc">チュートリアル(Todoアプリケーション)</span></a>で作成したServiceクラスの実装を以下のように変更する。</div>
</div>
<div class="line-block">
<div class="line">ハードコーディングされていたエラーメッセージの代わりに、エラーコードを指定するように変更する。</div>
<div class="line"><code class="docutils literal"><span class="pre">src/main/java/todo/domain/service/todo/TodoServiceImpl.java</span></code></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">todo.domain.service.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.UUID</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.BusinessException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.ResourceNotFoundException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessages</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">todo.domain.repository.todo.TodoRepository</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">MAX_UNFINISHED_COUNT</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">TodoRepository</span> <span class="n">todoRepository</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">findOne</span><span class="p">(</span><span class="n">String</span> <span class="n">todoId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">todoId</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">todo</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ResultMessages</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="p">.</span><span class="na">error</span><span class="p">();</span>
<span class="hll">            <span class="n">messages</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;E404&quot;</span><span class="p">,</span> <span class="n">todoId</span><span class="p">);</span>
</span>            <span class="k">throw</span> <span class="k">new</span> <span class="n">ResourceNotFoundException</span><span class="p">(</span><span class="n">messages</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">todo</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">todoRepository</span><span class="p">.</span><span class="na">findAll</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">create</span><span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">long</span> <span class="n">unfinishedCount</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="p">.</span><span class="na">countByFinished</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">unfinishedCount</span> <span class="o">&gt;=</span> <span class="n">MAX_UNFINISHED_COUNT</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ResultMessages</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="p">.</span><span class="na">error</span><span class="p">();</span>
<span class="hll">            <span class="n">messages</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;E001&quot;</span><span class="p">,</span> <span class="n">MAX_UNFINISHED_COUNT</span><span class="p">);</span>
</span>            <span class="k">throw</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="p">(</span><span class="n">messages</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">String</span> <span class="n">todoId</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">();</span>
        <span class="n">Date</span> <span class="n">createdAt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="p">();</span>

        <span class="n">todo</span><span class="p">.</span><span class="na">setTodoId</span><span class="p">(</span><span class="n">todoId</span><span class="p">);</span>
        <span class="n">todo</span><span class="p">.</span><span class="na">setCreatedAt</span><span class="p">(</span><span class="n">createdAt</span><span class="p">);</span>
        <span class="n">todo</span><span class="p">.</span><span class="na">setFinished</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

        <span class="n">todoRepository</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span>
        <span class="cm">/* REMOVE THIS LINE IF YOU USE JPA</span>
<span class="cm">            todoRepository.save(todo);</span>
<span class="cm">           REMOVE THIS LINE IF YOU USE JPA */</span>

        <span class="k">return</span> <span class="n">todo</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">finish</span><span class="p">(</span><span class="n">String</span> <span class="n">todoId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">findOne</span><span class="p">(</span><span class="n">todoId</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">todo</span><span class="p">.</span><span class="na">isFinished</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">ResultMessages</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="p">.</span><span class="na">error</span><span class="p">();</span>
<span class="hll">            <span class="n">messages</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;E002&quot;</span><span class="p">,</span> <span class="n">todoId</span><span class="p">);</span>
</span>            <span class="k">throw</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="p">(</span><span class="n">messages</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">todo</span><span class="p">.</span><span class="na">setFinished</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
        <span class="n">todoRepository</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span>
        <span class="cm">/* REMOVE THIS LINE IF YOU USE JPA</span>
<span class="cm">            todoRepository.save(todo);</span>
<span class="cm">           REMOVE THIS LINE IF YOU USE JPA */</span>
        <span class="k">return</span> <span class="n">todo</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="p">(</span><span class="n">String</span> <span class="n">todoId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">findOne</span><span class="p">(</span><span class="n">todoId</span><span class="p">);</span>
        <span class="n">todoRepository</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id17">
<h4><a class="toc-backref" href="#id54">10.2.3.7.2. エラーメッセージの定義</a><a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">本チュートリアルでは、エラーコードをキーにプロパティファイルからエラーメッセージを取得する。</div>
<div class="line">そのため、例外ハンドリングの実装を行う前に、エラーコードに対応するエラーメッセージを、メッセージ用のプロパティファイルに定義する。</div>
</div>
<p>処理結果用のエラーコードに対応するエラーメッセージを、メッセージ用のプロパティファイルに定義する。</p>
<div class="figure">
<img alt="../_images/application-messages.png" src="../_images/application-messages.png" />
</div>
<p><code class="docutils literal"><span class="pre">src/main/resources/i18n/application-messages.properties</span></code></p>
<div class="highlight-properties"><div class="highlight"><pre><span></span><span class="na">e.xx.fw.5001</span> <span class="o">=</span> <span class="s">Resource not found.</span>

<span class="na">e.xx.fw.7001</span> <span class="o">=</span> <span class="s">Illegal screen flow detected!</span>
<span class="na">e.xx.fw.7002</span> <span class="o">=</span> <span class="s">CSRF attack detected!</span>
<span class="na">e.xx.fw.7003</span> <span class="o">=</span> <span class="s">Access Denied detected!</span>
<span class="na">e.xx.fw.7004</span> <span class="o">=</span> <span class="s">Missing CSRF detected!</span>

<span class="na">e.xx.fw.8001</span> <span class="o">=</span> <span class="s">Business error occurred!</span>

<span class="na">e.xx.fw.9001</span> <span class="o">=</span> <span class="s">System error occurred!</span>
<span class="na">e.xx.fw.9002</span> <span class="o">=</span> <span class="s">Data Access error!</span>

<span class="c"># typemismatch</span>
<span class="na">typeMismatch</span><span class="o">=</span><span class="s">&quot;{0}&quot; is invalid.</span>
<span class="na">typeMismatch.int</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be an integer.</span>
<span class="na">typeMismatch.double</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be a double.</span>
<span class="na">typeMismatch.float</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be a float.</span>
<span class="na">typeMismatch.long</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be a long.</span>
<span class="na">typeMismatch.short</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be a short.</span>
<span class="na">typeMismatch.boolean</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be a boolean.</span>
<span class="na">typeMismatch.java.lang.Integer</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be an integer.</span>
<span class="na">typeMismatch.java.lang.Double</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be a double.</span>
<span class="na">typeMismatch.java.lang.Float</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be a float.</span>
<span class="na">typeMismatch.java.lang.Long</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be a long.</span>
<span class="na">typeMismatch.java.lang.Short</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be a short.</span>
<span class="na">typeMismatch.java.lang.Boolean</span><span class="o">=</span><span class="s">&quot;{0}&quot; is not a boolean.</span>
<span class="na">typeMismatch.java.util.Date</span><span class="o">=</span><span class="s">&quot;{0}&quot; is not a date.</span>
<span class="na">typeMismatch.java.lang.Enum</span><span class="o">=</span><span class="s">&quot;{0}&quot; is not a valid value.</span>

<span class="hll"><span class="c"># For this tutorial</span>
</span><span class="hll"><span class="na">E001</span> <span class="o">=</span> <span class="s">[E001] The count of un-finished Todo must not be over {0}.</span>
</span><span class="hll"><span class="na">E002</span> <span class="o">=</span> <span class="s">[E002] The requested Todo is already finished. (id={0})</span>
</span><span class="hll"><span class="na">E400</span> <span class="o">=</span> <span class="s">[E400] The requested Todo contains invalid values.</span>
</span><span class="hll"><span class="na">E404</span> <span class="o">=</span> <span class="s">[E404] The requested Todo is not found. (id={0})</span>
</span><span class="hll"><span class="na">E500</span> <span class="o">=</span> <span class="s">[E500] System error occurred.</span>
</span><span class="hll"><span class="na">E999</span> <span class="o">=</span> <span class="s">[E999] Error occurred. Caused by : {0}</span>
</span></pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">入力チェック用のエラーコードに対応するエラーメッセージを、Bean Validationのメッセージ用のプロパティファイルに定義する。</div>
</div>
<div class="line-block">
<div class="line">デフォルトのメッセージは、メッセージの中に項目名が含まれないため、デフォルトのメッセージ定義を変更する。</div>
<div class="line">本チュートリアルでは、<code class="docutils literal"><span class="pre">TodoResource</span></code>クラスで使用しているルール(<code class="docutils literal"><span class="pre">&#64;NotNull</span></code>と<code class="docutils literal"><span class="pre">&#64;Size</span></code>)に対応するメッセージのみ定義する。</div>
</div>
<div class="figure">
<img alt="../_images/validation-messages.png" src="../_images/validation-messages.png" />
</div>
<p><code class="docutils literal"><span class="pre">src/main/resources/ValidationMessages.properties</span></code></p>
<div class="highlight-properties"><div class="highlight"><pre><span></span><span class="na">javax.validation.constraints.NotNull.message</span> <span class="o">=</span> <span class="s">{0} may not be null.</span>
<span class="na">javax.validation.constraints.Size.message</span>    <span class="o">=</span> <span class="s">{0} size must be between {min} and {max}.</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id18">
<h4><a class="toc-backref" href="#id55">10.2.3.7.3. エラーハンドリング用のクラスを格納するパッケージの作成</a><a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">エラーハンドリング用のクラスを格納するためのパッケージを作成する。</div>
<div class="line">本チュートリアルでは、<code class="docutils literal"><span class="pre">todo.api.common.error</span></code>をエラーハンドリング用のクラスを格納するためのパッケージとする。</div>
</div>
<div class="figure">
<img alt="../_images/exception-package.png" src="../_images/exception-package.png" />
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id19">
<h4><a class="toc-backref" href="#id56">10.2.3.7.4. REST APIのエラーハンドリングを行うクラスの作成</a><a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">REST APIのエラーハンドリングは、Spring MVCから提供されている<code class="docutils literal"><span class="pre">org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler</span></code>を継承したクラスを作成し、<code class="docutils literal"><span class="pre">&#64;ControllerAdvice</span></code>アノテーションを付与する方法でハンドリングし、REST APIに関わる処理に限定するために <code class="docutils literal"><span class="pre">(annotations</span> <span class="pre">=</span> <span class="pre">RestController.class)</span></code> の属性を付与する事を推奨する。</div>
<div class="line">以下に、<code class="docutils literal"><span class="pre">ResponseEntityExceptionHandler</span></code>を継承した<code class="docutils literal"><span class="pre">todo.api.common.error.RestGlobalExceptionHandler</span></code>クラスを作成する。</div>
</div>
<div class="figure">
<img alt="../_images/exception-handlingclass.png" src="../_images/exception-handlingclass.png" />
</div>
<p><code class="docutils literal"><span class="pre">src/main/java/todo/api/common/error/RestGlobalExceptionHandler.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">todo.api.common.error</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ControllerAdvice</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler</span><span class="p">;</span>

<span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RestGlobalExceptionHandler</span> <span class="kd">extends</span> <span class="n">ResponseEntityExceptionHandler</span> <span class="p">{</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="rest-apijavabean">
<h4><a class="toc-backref" href="#id57">10.2.3.7.5. REST APIのエラー情報を保持するJavaBeanの作成</a><a class="headerlink" href="#rest-apijavabean" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">REST APIで発生したエラー情報を保持するクラスとして、<code class="docutils literal"><span class="pre">ApiError</span></code>クラスを<code class="docutils literal"><span class="pre">todo.api.common.error</span></code>パッケージに作成する。</div>
<div class="line"><code class="docutils literal"><span class="pre">ApiError</span></code>クラスがJSONに変換されて、クライアントに応答される。</div>
</div>
<div class="figure">
<img alt="../_images/exception-apierror.png" src="../_images/exception-apierror.png" />
</div>
<p><code class="docutils literal"><span class="pre">src/main/java/todo/api/common/error/ApiError.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">todo.api.common.error</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.annotation.JsonInclude</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiError</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">code</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">message</span><span class="p">;</span>

    <span class="nd">@JsonInclude</span><span class="p">(</span><span class="n">JsonInclude</span><span class="p">.</span><span class="na">Include</span><span class="p">.</span><span class="na">NON_EMPTY</span><span class="p">)</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">target</span><span class="p">;</span>

    <span class="nd">@JsonInclude</span><span class="p">(</span><span class="n">JsonInclude</span><span class="p">.</span><span class="na">Include</span><span class="p">.</span><span class="na">NON_EMPTY</span><span class="p">)</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ApiError</span><span class="o">&gt;</span> <span class="n">details</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>

    <span class="kd">public</span> <span class="nf">ApiError</span><span class="p">(</span><span class="n">String</span> <span class="n">code</span><span class="p">,</span> <span class="n">String</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="nf">ApiError</span><span class="p">(</span><span class="n">String</span> <span class="n">code</span><span class="p">,</span> <span class="n">String</span> <span class="n">message</span><span class="p">,</span> <span class="n">String</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">code</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="na">message</span> <span class="o">=</span> <span class="n">message</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="na">target</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getCode</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">code</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getMessage</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">message</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTarget</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">target</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ApiError</span><span class="o">&gt;</span> <span class="nf">getDetails</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">details</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addDetail</span><span class="p">(</span><span class="n">ApiError</span> <span class="n">detail</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">details</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">detail</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="httpbody">
<h4><a class="toc-backref" href="#id58">10.2.3.7.6. HTTPレスポンスBODYにエラー情報を出力するための実装</a><a class="headerlink" href="#httpbody" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">ResponseEntityExceptionHandler</span></code>はデフォルトではHTTPステータス(400や500など)の設定のみを行い、HTTPレスポンスのBODYは設定しない。
そのため、<code class="docutils literal"><span class="pre">handleExceptionInternal</span></code>メソッドを以下のようにオーバーライドして、BODYを出力するように実装する。</p>
<p><code class="docutils literal"><span class="pre">src/main/java/todo/api/common/error/RestGlobalExceptionHandler.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">todo.api.common.error</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.context.MessageSource</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpHeaders</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.ResponseEntity</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ControllerAdvice</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.context.request.WebRequest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler</span><span class="p">;</span>

<span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RestGlobalExceptionHandler</span> <span class="kd">extends</span> <span class="n">ResponseEntityExceptionHandler</span> <span class="p">{</span>

<span class="hll">    <span class="nd">@Inject</span>
</span><span class="hll">    <span class="n">MessageSource</span> <span class="n">messageSource</span><span class="p">;</span>
</span>
<span class="hll">    <span class="nd">@Override</span>
</span><span class="hll">    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleExceptionInternal</span><span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">,</span>
</span><span class="hll">            <span class="n">Object</span> <span class="n">body</span><span class="p">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="p">,</span> <span class="n">HttpStatus</span> <span class="n">status</span><span class="p">,</span>
</span><span class="hll">            <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">        <span class="n">Object</span> <span class="n">responseBody</span> <span class="o">=</span> <span class="n">body</span><span class="p">;</span>
</span><span class="hll">        <span class="k">if</span> <span class="p">(</span><span class="n">body</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">            <span class="n">responseBody</span> <span class="o">=</span> <span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&quot;E999&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
</span><span class="hll">        <span class="p">}</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">status</span><span class="p">).</span><span class="na">headers</span><span class="p">(</span><span class="n">headers</span><span class="p">).</span><span class="na">body</span><span class="p">(</span><span class="n">responseBody</span><span class="p">);</span>
</span><span class="hll">    <span class="p">}</span>
</span>
<span class="hll">    <span class="kd">private</span> <span class="n">ApiError</span> <span class="nf">createApiError</span><span class="p">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="p">,</span> <span class="n">String</span> <span class="n">errorCode</span><span class="p">,</span>
</span><span class="hll">            <span class="n">Object</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">        <span class="k">return</span> <span class="k">new</span> <span class="n">ApiError</span><span class="p">(</span><span class="n">errorCode</span><span class="p">,</span> <span class="n">messageSource</span><span class="p">.</span><span class="na">getMessage</span><span class="p">(</span><span class="n">errorCode</span><span class="p">,</span>
</span><span class="hll">                <span class="n">args</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="na">getLocale</span><span class="p">()));</span>
</span><span class="hll">    <span class="p">}</span>
</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">上記実装を行う事で、<code class="docutils literal"><span class="pre">ResponseEntityExceptionHandler</span></code>でハンドリングされる例外については、HTTPレスポンスBODYにエラー情報が出力される。</div>
<div class="line"><code class="docutils literal"><span class="pre">ResponseEntityExceptionHandler</span></code>でハンドリングされる例外については、<a class="reference internal" href="../ArchitectureInDetail/WebApplicationDetail/ExceptionHandling.html#exception-handling-appendix-defaulthandlerexceptionresolver-label"><span class="std std-ref">DefaultHandlerExceptionResolverで設定されるHTTPレスポンスコードについて</span></a>を参照されたい。</div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">DHCを使用して、実装したエラーハンドリングの動作確認を行う。</div>
<div class="line">DHCを開いてURLに<code class="docutils literal"><span class="pre">&quot;localhost:8080/todo/api/v1/todos&quot;</span></code>を入力し、メソッドにPUTを指定してから、”Send”ボタンをクリックする。</div>
</div>
<p>“405 Method Not Allowed”のHTTPステータスが返却され、「RESPONSE」の「Body」には、エラー情報のJSONが表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/exception-genericerror.png"><img alt="../_images/exception-genericerror.png" src="../_images/exception-genericerror.png" style="width: 100%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id20">
<h4><a class="toc-backref" href="#id59">10.2.3.7.7. 入力エラーのエラーハンドリングの実装</a><a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h4>
<p>入力エラーの種類は、</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">org.springframework.web.bind.MethodArgumentNotValidException</span></code></li>
<li><code class="docutils literal"><span class="pre">org.springframework.validation.BindException</span></code></li>
<li><code class="docutils literal"><span class="pre">org.springframework.http.converter.HttpMessageNotReadableException</span></code></li>
<li><code class="docutils literal"><span class="pre">org.springframework.beans.TypeMismatchException</span></code></li>
</ul>
<p>となる。</p>
<div class="line-block">
<div class="line">本チュートリアルでは、<code class="docutils literal"><span class="pre">MethodArgumentNotValidException</span></code>のエラーハンドリングの実装を行う。</div>
<div class="line"><code class="docutils literal"><span class="pre">MethodArgumentNotValidException</span></code>は、HTTPリクエストBODYに格納されているデータに入力エラーがあった場合に発生する例外である。</div>
</div>
<p><code class="docutils literal"><span class="pre">src/main/java/todo/api/common/error/RestGlobalExceptionHandler.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">todo.api.common.error</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.context.MessageSource</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.support.DefaultMessageSourceResolvable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpHeaders</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.ResponseEntity</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.FieldError</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.ObjectError</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.MethodArgumentNotValidException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ControllerAdvice</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.context.request.WebRequest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler</span><span class="p">;</span>

<span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RestGlobalExceptionHandler</span> <span class="kd">extends</span> <span class="n">ResponseEntityExceptionHandler</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">MessageSource</span> <span class="n">messageSource</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleExceptionInternal</span><span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">,</span>
            <span class="n">Object</span> <span class="n">body</span><span class="p">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="p">,</span> <span class="n">HttpStatus</span> <span class="n">status</span><span class="p">,</span>
            <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Object</span> <span class="n">responseBody</span> <span class="o">=</span> <span class="n">body</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">body</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">responseBody</span> <span class="o">=</span> <span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&quot;E999&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">status</span><span class="p">).</span><span class="na">headers</span><span class="p">(</span><span class="n">headers</span><span class="p">).</span><span class="na">body</span><span class="p">(</span><span class="n">responseBody</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="n">ApiError</span> <span class="nf">createApiError</span><span class="p">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="p">,</span> <span class="n">String</span> <span class="n">errorCode</span><span class="p">,</span>
            <span class="n">Object</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ApiError</span><span class="p">(</span><span class="n">errorCode</span><span class="p">,</span> <span class="n">messageSource</span><span class="p">.</span><span class="na">getMessage</span><span class="p">(</span><span class="n">errorCode</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="na">getLocale</span><span class="p">()));</span>
    <span class="p">}</span>

<span class="hll">    <span class="nd">@Override</span>
</span><span class="hll">    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleMethodArgumentNotValid</span><span class="p">(</span>
</span><span class="hll">            <span class="n">MethodArgumentNotValidException</span> <span class="n">ex</span><span class="p">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="p">,</span>
</span><span class="hll">            <span class="n">HttpStatus</span> <span class="n">status</span><span class="p">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">        <span class="n">ApiError</span> <span class="n">apiError</span> <span class="o">=</span> <span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&quot;E400&quot;</span><span class="p">);</span>
</span><span class="hll">        <span class="k">for</span> <span class="p">(</span><span class="n">FieldError</span> <span class="n">fieldError</span> <span class="p">:</span> <span class="n">ex</span><span class="p">.</span><span class="na">getBindingResult</span><span class="p">().</span><span class="na">getFieldErrors</span><span class="p">())</span> <span class="p">{</span>
</span><span class="hll">            <span class="n">apiError</span><span class="p">.</span><span class="na">addDetail</span><span class="p">(</span><span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">fieldError</span><span class="p">,</span> <span class="n">fieldError</span>
</span><span class="hll">                    <span class="p">.</span><span class="na">getField</span><span class="p">()));</span>
</span><span class="hll">        <span class="p">}</span>
</span><span class="hll">        <span class="k">for</span> <span class="p">(</span><span class="n">ObjectError</span> <span class="n">objectError</span> <span class="p">:</span> <span class="n">ex</span><span class="p">.</span><span class="na">getBindingResult</span><span class="p">().</span><span class="na">getGlobalErrors</span><span class="p">())</span> <span class="p">{</span>
</span><span class="hll">            <span class="n">apiError</span><span class="p">.</span><span class="na">addDetail</span><span class="p">(</span><span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">objectError</span><span class="p">,</span> <span class="n">objectError</span>
</span><span class="hll">                    <span class="p">.</span><span class="na">getObjectName</span><span class="p">()));</span>
</span><span class="hll">        <span class="p">}</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">handleExceptionInternal</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">apiError</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
</span><span class="hll">    <span class="p">}</span>
</span>
<span class="hll">    <span class="kd">private</span> <span class="n">ApiError</span> <span class="nf">createApiError</span><span class="p">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="p">,</span>
</span><span class="hll">            <span class="n">DefaultMessageSourceResolvable</span> <span class="n">messageSourceResolvable</span><span class="p">,</span>
</span><span class="hll">            <span class="n">String</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">        <span class="k">return</span> <span class="k">new</span> <span class="n">ApiError</span><span class="p">(</span><span class="n">messageSourceResolvable</span><span class="p">.</span><span class="na">getCode</span><span class="p">(),</span> <span class="n">messageSource</span>
</span><span class="hll">                <span class="p">.</span><span class="na">getMessage</span><span class="p">(</span><span class="n">messageSourceResolvable</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="na">getLocale</span><span class="p">()),</span> <span class="n">target</span><span class="p">);</span>
</span><span class="hll">    <span class="p">}</span>
</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">DHCを使用して、実装したエラーハンドリングの動作確認を行う。</div>
<div class="line">DHCを開いてURLに<code class="docutils literal"><span class="pre">&quot;localhost:8080/todo/api/v1/todos&quot;</span></code>を入力し、メソッドにPOSTを指定する。</div>
<div class="line">「REQUEST」の「BODY」に以下のJSONを入力する。</div>
</div>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;todoTitle&quot;</span><span class="p">:</span> <span class="kc">null</span>
<span class="p">}</span>
</pre></div>
</div>
<p>また、「REQUEST」の「HEADERS」の「+」ボタンでHTTPヘッダーを追加し、「<code class="docutils literal"><span class="pre">Content-Type</span></code>」に「<code class="docutils literal"><span class="pre">application/json</span></code>」を設定後、”Send”ボタンをクリックする。</p>
<div class="line-block">
<div class="line">“400 Bad Request”のHTTPステータスが返却され、「RESPONSE」の「Body」には、エラー情報のJSONが表示される。</div>
<div class="line"><code class="docutils literal"><span class="pre">todoTitle</span></code>は必須項目なので、必須エラーが発生している。</div>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../_images/exception-inputerror.png"><img alt="../_images/exception-inputerror.png" src="../_images/exception-inputerror.png" style="width: 100%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id21">
<h4><a class="toc-backref" href="#id60">10.2.3.7.8. 業務例外のエラーハンドリングの実装</a><a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">RestGlobalExceptionHandler</span></code>に<code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.exception.BusinessException</span></code>をハンドリングするメソッドを追加して、業務例外をハンドリングする。</p>
<p>業務例外が発生した場合は、”409 Conflict”のHTTPステータスを設定する。</p>
<p><code class="docutils literal"><span class="pre">src/main/java/todo/api/common/error/RestGlobalExceptionHandler.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">todo.api.common.error</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.context.MessageSource</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.support.DefaultMessageSourceResolvable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpHeaders</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.ResponseEntity</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.FieldError</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.ObjectError</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.MethodArgumentNotValidException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ControllerAdvice</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ExceptionHandler</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.context.request.WebRequest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.BusinessException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.ResultMessagesNotificationException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessage</span><span class="p">;</span>

<span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RestGlobalExceptionHandler</span> <span class="kd">extends</span> <span class="n">ResponseEntityExceptionHandler</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">MessageSource</span> <span class="n">messageSource</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleExceptionInternal</span><span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">,</span>
            <span class="n">Object</span> <span class="n">body</span><span class="p">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="p">,</span> <span class="n">HttpStatus</span> <span class="n">status</span><span class="p">,</span>
            <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Object</span> <span class="n">responseBody</span> <span class="o">=</span> <span class="n">body</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">body</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">responseBody</span> <span class="o">=</span> <span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&quot;E999&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">status</span><span class="p">).</span><span class="na">headers</span><span class="p">(</span><span class="n">headers</span><span class="p">).</span><span class="na">body</span><span class="p">(</span><span class="n">responseBody</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="n">ApiError</span> <span class="nf">createApiError</span><span class="p">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="p">,</span> <span class="n">String</span> <span class="n">errorCode</span><span class="p">,</span>
            <span class="n">Object</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ApiError</span><span class="p">(</span><span class="n">errorCode</span><span class="p">,</span> <span class="n">messageSource</span><span class="p">.</span><span class="na">getMessage</span><span class="p">(</span><span class="n">errorCode</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="na">getLocale</span><span class="p">()));</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleMethodArgumentNotValid</span><span class="p">(</span>
            <span class="n">MethodArgumentNotValidException</span> <span class="n">ex</span><span class="p">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="p">,</span>
            <span class="n">HttpStatus</span> <span class="n">status</span><span class="p">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ApiError</span> <span class="n">apiError</span> <span class="o">=</span> <span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&quot;E400&quot;</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">FieldError</span> <span class="n">fieldError</span> <span class="p">:</span> <span class="n">ex</span><span class="p">.</span><span class="na">getBindingResult</span><span class="p">().</span><span class="na">getFieldErrors</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">apiError</span><span class="p">.</span><span class="na">addDetail</span><span class="p">(</span><span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">fieldError</span><span class="p">,</span> <span class="n">fieldError</span>
                    <span class="p">.</span><span class="na">getField</span><span class="p">()));</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ObjectError</span> <span class="n">objectError</span> <span class="p">:</span> <span class="n">ex</span><span class="p">.</span><span class="na">getBindingResult</span><span class="p">().</span><span class="na">getGlobalErrors</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">apiError</span><span class="p">.</span><span class="na">addDetail</span><span class="p">(</span><span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">objectError</span><span class="p">,</span> <span class="n">objectError</span>
                    <span class="p">.</span><span class="na">getObjectName</span><span class="p">()));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">handleExceptionInternal</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">apiError</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="n">ApiError</span> <span class="nf">createApiError</span><span class="p">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="p">,</span>
            <span class="n">DefaultMessageSourceResolvable</span> <span class="n">messageSourceResolvable</span><span class="p">,</span>
            <span class="n">String</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ApiError</span><span class="p">(</span><span class="n">messageSourceResolvable</span><span class="p">.</span><span class="na">getCode</span><span class="p">(),</span> <span class="n">messageSource</span>
                <span class="p">.</span><span class="na">getMessage</span><span class="p">(</span><span class="n">messageSourceResolvable</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="na">getLocale</span><span class="p">()),</span> <span class="n">target</span><span class="p">);</span>
    <span class="p">}</span>

<span class="hll">    <span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">BusinessException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleBusinessException</span><span class="p">(</span><span class="n">BusinessException</span> <span class="n">ex</span><span class="p">,</span>
</span><span class="hll">            <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">handleResultMessagesNotificationException</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="p">(),</span>
</span><span class="hll">                <span class="n">HttpStatus</span><span class="p">.</span><span class="na">CONFLICT</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
</span><span class="hll">    <span class="p">}</span>
</span>
<span class="hll">    <span class="kd">private</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleResultMessagesNotificationException</span><span class="p">(</span>
</span><span class="hll">            <span class="n">ResultMessagesNotificationException</span> <span class="n">ex</span><span class="p">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="p">,</span>
</span><span class="hll">            <span class="n">HttpStatus</span> <span class="n">status</span><span class="p">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">        <span class="n">ResultMessage</span> <span class="n">message</span> <span class="o">=</span> <span class="n">ex</span><span class="p">.</span><span class="na">getResultMessages</span><span class="p">().</span><span class="na">iterator</span><span class="p">().</span><span class="na">next</span><span class="p">();</span>
</span><span class="hll">        <span class="n">ApiError</span> <span class="n">apiError</span> <span class="o">=</span> <span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="na">getCode</span><span class="p">(),</span> <span class="n">message</span>
</span><span class="hll">                <span class="p">.</span><span class="na">getArgs</span><span class="p">());</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">handleExceptionInternal</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">apiError</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
</span><span class="hll">    <span class="p">}</span>
</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">DHCを使用して、実装したエラーハンドリングの動作確認を行う。</div>
<div class="line">DHCを開いてURLに<code class="docutils literal"><span class="pre">&quot;localhost:8080/todo/api/v1/todos/{todoId}&quot;</span></code>を入力し、メソッドにPUTを指定する。</div>
<div class="line">{todoId}の部分は実際のIDを入れる必要があるので、POST TodosまたはGET Todosを実行してResponse中の<code class="docutils literal"><span class="pre">todoId</span></code>をコピーして貼り付けてから、”Send”ボタンを2回クリックする。</div>
<div class="line">未完了状態のTodoの<code class="docutils literal"><span class="pre">todoId</span></code>を指定すること。</div>
</div>
<p>2回目のリクエストに対するレスポンスとして、”409 Conflict”のHTTPステータスが返却され、「RESPONSE」の「Body」には、エラー情報のJSONが表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/exception-businesserror.png"><img alt="../_images/exception-businesserror.png" src="../_images/exception-businesserror.png" style="width: 100%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id22">
<h4><a class="toc-backref" href="#id61">10.2.3.7.9. リソース未検出例外のエラーハンドリングの実装</a><a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">RestGlobalExceptionHandler</span></code>に<code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.exception.ResourceNotFoundException</span></code>をハンドリングするメソッドを追加して、リソース未検出例外をハンドリングする。</p>
<p>リソース未検出例外が発生した場合、”404 NotFound”のHTTPステータスを設定する。</p>
<p><code class="docutils literal"><span class="pre">src/main/java/todo/api/common/error/RestGlobalExceptionHandler.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">todo.api.common.error</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.context.MessageSource</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.support.DefaultMessageSourceResolvable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpHeaders</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.ResponseEntity</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.FieldError</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.ObjectError</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.MethodArgumentNotValidException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ControllerAdvice</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ExceptionHandler</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.context.request.WebRequest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.BusinessException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.ResourceNotFoundException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.ResultMessagesNotificationException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessage</span><span class="p">;</span>

<span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RestGlobalExceptionHandler</span> <span class="kd">extends</span> <span class="n">ResponseEntityExceptionHandler</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">MessageSource</span> <span class="n">messageSource</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleExceptionInternal</span><span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">,</span>
            <span class="n">Object</span> <span class="n">body</span><span class="p">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="p">,</span> <span class="n">HttpStatus</span> <span class="n">status</span><span class="p">,</span>
            <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Object</span> <span class="n">responseBody</span> <span class="o">=</span> <span class="n">body</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">body</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">responseBody</span> <span class="o">=</span> <span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&quot;E999&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">status</span><span class="p">).</span><span class="na">headers</span><span class="p">(</span><span class="n">headers</span><span class="p">).</span><span class="na">body</span><span class="p">(</span><span class="n">responseBody</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="n">ApiError</span> <span class="nf">createApiError</span><span class="p">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="p">,</span> <span class="n">String</span> <span class="n">errorCode</span><span class="p">,</span>
            <span class="n">Object</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ApiError</span><span class="p">(</span><span class="n">errorCode</span><span class="p">,</span> <span class="n">messageSource</span><span class="p">.</span><span class="na">getMessage</span><span class="p">(</span><span class="n">errorCode</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="na">getLocale</span><span class="p">()));</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleMethodArgumentNotValid</span><span class="p">(</span>
            <span class="n">MethodArgumentNotValidException</span> <span class="n">ex</span><span class="p">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="p">,</span>
            <span class="n">HttpStatus</span> <span class="n">status</span><span class="p">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ApiError</span> <span class="n">apiError</span> <span class="o">=</span> <span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&quot;E400&quot;</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">FieldError</span> <span class="n">fieldError</span> <span class="p">:</span> <span class="n">ex</span><span class="p">.</span><span class="na">getBindingResult</span><span class="p">().</span><span class="na">getFieldErrors</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">apiError</span><span class="p">.</span><span class="na">addDetail</span><span class="p">(</span><span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">fieldError</span><span class="p">,</span> <span class="n">fieldError</span>
                    <span class="p">.</span><span class="na">getField</span><span class="p">()));</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ObjectError</span> <span class="n">objectError</span> <span class="p">:</span> <span class="n">ex</span><span class="p">.</span><span class="na">getBindingResult</span><span class="p">().</span><span class="na">getGlobalErrors</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">apiError</span><span class="p">.</span><span class="na">addDetail</span><span class="p">(</span><span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">objectError</span><span class="p">,</span> <span class="n">objectError</span>
                    <span class="p">.</span><span class="na">getObjectName</span><span class="p">()));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">handleExceptionInternal</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">apiError</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="n">ApiError</span> <span class="nf">createApiError</span><span class="p">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="p">,</span>
            <span class="n">DefaultMessageSourceResolvable</span> <span class="n">messageSourceResolvable</span><span class="p">,</span>
            <span class="n">String</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ApiError</span><span class="p">(</span><span class="n">messageSourceResolvable</span><span class="p">.</span><span class="na">getCode</span><span class="p">(),</span> <span class="n">messageSource</span>
                <span class="p">.</span><span class="na">getMessage</span><span class="p">(</span><span class="n">messageSourceResolvable</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="na">getLocale</span><span class="p">()),</span> <span class="n">target</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">BusinessException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleBusinessException</span><span class="p">(</span><span class="n">BusinessException</span> <span class="n">ex</span><span class="p">,</span>
            <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">handleResultMessagesNotificationException</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="p">(),</span>
                <span class="n">HttpStatus</span><span class="p">.</span><span class="na">CONFLICT</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleResultMessagesNotificationException</span><span class="p">(</span>
            <span class="n">ResultMessagesNotificationException</span> <span class="n">ex</span><span class="p">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="p">,</span>
            <span class="n">HttpStatus</span> <span class="n">status</span><span class="p">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ResultMessage</span> <span class="n">message</span> <span class="o">=</span> <span class="n">ex</span><span class="p">.</span><span class="na">getResultMessages</span><span class="p">().</span><span class="na">iterator</span><span class="p">().</span><span class="na">next</span><span class="p">();</span>
        <span class="n">ApiError</span> <span class="n">apiError</span> <span class="o">=</span> <span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="na">getCode</span><span class="p">(),</span> <span class="n">message</span>
                <span class="p">.</span><span class="na">getArgs</span><span class="p">());</span>
        <span class="k">return</span> <span class="n">handleExceptionInternal</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">apiError</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
    <span class="p">}</span>

<span class="hll">    <span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">ResourceNotFoundException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleResourceNotFoundException</span><span class="p">(</span>
</span><span class="hll">            <span class="n">ResourceNotFoundException</span> <span class="n">ex</span><span class="p">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">handleResultMessagesNotificationException</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="p">(),</span>
</span><span class="hll">                <span class="n">HttpStatus</span><span class="p">.</span><span class="na">NOT_FOUND</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
</span><span class="hll">    <span class="p">}</span>
</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">DHCを使用して、実装したエラーハンドリングの動作確認を行う。</div>
<div class="line">DHCを開いてURLに<code class="docutils literal"><span class="pre">&quot;localhost:8080/todo/api/v1/todos/{todoId}&quot;</span></code>を入力し、メソッドにGETを指定する。</div>
<div class="line">{todoId}の部分には存在しないIDを指定して、”Send”ボタンをクリックする。</div>
</div>
<p>“404 Not Found”のHTTPステータスが返却され、「RESPONSE」の「Body」には、エラー情報のJSONが表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/exception-notfound.png"><img alt="../_images/exception-notfound.png" src="../_images/exception-notfound.png" style="width: 100%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id23">
<h4><a class="toc-backref" href="#id62">10.2.3.7.10. システム例外のエラーハンドリングの実装</a><a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h4>
<p>最後に、<code class="docutils literal"><span class="pre">RestGlobalExceptionHandler</span></code>に<code class="docutils literal"><span class="pre">java.lang.Exception</span></code>をハンドリングするメソッドを追加して、システム例外をハンドリングする。</p>
<p>システム例外が発生した場合、”500 InternalServerError”のHTTPステータスを設定する。</p>
<p><code class="docutils literal"><span class="pre">src/main/java/todo/api/common/error/RestGlobalExceptionHandler.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">todo.api.common.error</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.context.MessageSource</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.support.DefaultMessageSourceResolvable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpHeaders</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.ResponseEntity</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.FieldError</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.ObjectError</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.MethodArgumentNotValidException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ControllerAdvice</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ExceptionHandler</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.context.request.WebRequest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.BusinessException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.ResourceNotFoundException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.ResultMessagesNotificationException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessage</span><span class="p">;</span>

<span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RestGlobalExceptionHandler</span> <span class="kd">extends</span> <span class="n">ResponseEntityExceptionHandler</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">MessageSource</span> <span class="n">messageSource</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleExceptionInternal</span><span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">,</span>
            <span class="n">Object</span> <span class="n">body</span><span class="p">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="p">,</span> <span class="n">HttpStatus</span> <span class="n">status</span><span class="p">,</span>
            <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Object</span> <span class="n">responseBody</span> <span class="o">=</span> <span class="n">body</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">body</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">responseBody</span> <span class="o">=</span> <span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&quot;E999&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">status</span><span class="p">).</span><span class="na">headers</span><span class="p">(</span><span class="n">headers</span><span class="p">).</span><span class="na">body</span><span class="p">(</span><span class="n">responseBody</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="n">ApiError</span> <span class="nf">createApiError</span><span class="p">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="p">,</span> <span class="n">String</span> <span class="n">errorCode</span><span class="p">,</span>
            <span class="n">Object</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ApiError</span><span class="p">(</span><span class="n">errorCode</span><span class="p">,</span> <span class="n">messageSource</span><span class="p">.</span><span class="na">getMessage</span><span class="p">(</span><span class="n">errorCode</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="na">getLocale</span><span class="p">()));</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleMethodArgumentNotValid</span><span class="p">(</span>
            <span class="n">MethodArgumentNotValidException</span> <span class="n">ex</span><span class="p">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="p">,</span>
            <span class="n">HttpStatus</span> <span class="n">status</span><span class="p">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ApiError</span> <span class="n">apiError</span> <span class="o">=</span> <span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&quot;E400&quot;</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">FieldError</span> <span class="n">fieldError</span> <span class="p">:</span> <span class="n">ex</span><span class="p">.</span><span class="na">getBindingResult</span><span class="p">().</span><span class="na">getFieldErrors</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">apiError</span><span class="p">.</span><span class="na">addDetail</span><span class="p">(</span><span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">fieldError</span><span class="p">,</span> <span class="n">fieldError</span>
                    <span class="p">.</span><span class="na">getField</span><span class="p">()));</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ObjectError</span> <span class="n">objectError</span> <span class="p">:</span> <span class="n">ex</span><span class="p">.</span><span class="na">getBindingResult</span><span class="p">().</span><span class="na">getGlobalErrors</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">apiError</span><span class="p">.</span><span class="na">addDetail</span><span class="p">(</span><span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">objectError</span><span class="p">,</span> <span class="n">objectError</span>
                    <span class="p">.</span><span class="na">getObjectName</span><span class="p">()));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">handleExceptionInternal</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">apiError</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="n">ApiError</span> <span class="nf">createApiError</span><span class="p">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="p">,</span>
            <span class="n">DefaultMessageSourceResolvable</span> <span class="n">messageSourceResolvable</span><span class="p">,</span>
            <span class="n">String</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ApiError</span><span class="p">(</span><span class="n">messageSourceResolvable</span><span class="p">.</span><span class="na">getCode</span><span class="p">(),</span> <span class="n">messageSource</span>
                <span class="p">.</span><span class="na">getMessage</span><span class="p">(</span><span class="n">messageSourceResolvable</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="na">getLocale</span><span class="p">()),</span> <span class="n">target</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">BusinessException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleBusinessException</span><span class="p">(</span><span class="n">BusinessException</span> <span class="n">ex</span><span class="p">,</span>
            <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">handleResultMessagesNotificationException</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="p">(),</span>
                <span class="n">HttpStatus</span><span class="p">.</span><span class="na">CONFLICT</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleResultMessagesNotificationException</span><span class="p">(</span>
            <span class="n">ResultMessagesNotificationException</span> <span class="n">ex</span><span class="p">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="p">,</span>
            <span class="n">HttpStatus</span> <span class="n">status</span><span class="p">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ResultMessage</span> <span class="n">message</span> <span class="o">=</span> <span class="n">ex</span><span class="p">.</span><span class="na">getResultMessages</span><span class="p">().</span><span class="na">iterator</span><span class="p">().</span><span class="na">next</span><span class="p">();</span>
        <span class="n">ApiError</span> <span class="n">apiError</span> <span class="o">=</span> <span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="na">getCode</span><span class="p">(),</span> <span class="n">message</span>
                <span class="p">.</span><span class="na">getArgs</span><span class="p">());</span>
        <span class="k">return</span> <span class="n">handleExceptionInternal</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">apiError</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">ResourceNotFoundException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleResourceNotFoundException</span><span class="p">(</span>
            <span class="n">ResourceNotFoundException</span> <span class="n">ex</span><span class="p">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">handleResultMessagesNotificationException</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="p">(),</span>
                <span class="n">HttpStatus</span><span class="p">.</span><span class="na">NOT_FOUND</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
    <span class="p">}</span>

<span class="hll">    <span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">Exception</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleSystemError</span><span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">,</span>
</span><span class="hll">            <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">        <span class="n">ApiError</span> <span class="n">apiError</span> <span class="o">=</span> <span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&quot;E500&quot;</span><span class="p">);</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">handleExceptionInternal</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">apiError</span><span class="p">,</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="p">(),</span>
</span><span class="hll">                <span class="n">HttpStatus</span><span class="p">.</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
</span><span class="hll">    <span class="p">}</span>
</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">DHCを使用して、実装したエラーハンドリングの動作確認を行う。</div>
<div class="line">システムエラーを発生させるために、テーブルを未作成の状態でアプリケーションを起動させる。</div>
</div>
<p><code class="docutils literal"><span class="pre">src/main/resources/META-INF/spring/todo-infra.properties</span></code></p>
<div class="highlight-properties"><div class="highlight"><pre><span></span><span class="na">database</span><span class="o">=</span><span class="s">H2</span>
<span class="c">#database.url=jdbc:h2:mem:todo;DB_CLOSE_DELAY=-1;INIT=create table if not exists todo(todo_id varchar(36) primary key, todo_title varchar(30), finished boolean, created_at timestamp)</span>
<span class="hll"><span class="na">database.url</span><span class="o">=</span><span class="s">jdbc:h2:mem:todo;DB_CLOSE_DELAY=-1</span>
</span><span class="na">database.username</span><span class="o">=</span><span class="s">sa</span>
<span class="na">database.password</span><span class="o">=</span>
<span class="na">database.driverClassName</span><span class="o">=</span><span class="s">org.h2.Driver</span>
<span class="c"># connection pool</span>
<span class="na">cp.maxActive</span><span class="o">=</span><span class="s">96</span>
<span class="na">cp.maxIdle</span><span class="o">=</span><span class="s">16</span>
<span class="na">cp.minIdle</span><span class="o">=</span><span class="s">0</span>
<span class="na">cp.maxWait</span><span class="o">=</span><span class="s">60000</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>DHCを開いてURLに<code class="docutils literal"><span class="pre">&quot;localhost:8080/todo/api/v1/todos&quot;</span></code>を入力し、メソッドにGETを指定して、”Send”ボタンをクリックする。</p>
<p>“500 Internal Server Error”のHTTPステータスが返却され、「RESPONSE」の「Body」には、エラー情報のJSONが表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/exception-systemerror.png"><img alt="../_images/exception-systemerror.png" src="../_images/exception-systemerror.png" style="width: 100%;" /></a>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>システムエラーが発生した場合、クライアントへ返却するメッセージは、エラー原因が特定されないシンプルなエラーメッセージを設定することを推奨する。
エラー原因が特定できるメッセージを設定してしまうと、システムの脆弱性をクライアントに公開する可能性があり、セキュリティー上問題がある。</p>
<p>エラー原因は、エラー解析用にログに出力すればよい。
Blankプロジェクトのデフォルトの設定では、共通ライブラリから提供している<code class="docutils literal"><span class="pre">ExceptionLogger</span></code>によってログが出力されるようなっているため、ログを出力するための設定や実装は不要である。</p>
<p><code class="docutils literal"><span class="pre">ExceptionLogger</span></code>によって出力されるログは以下の通りである。
Todoテーブルが存在しない事が原因でシステムエラーが発生している事がわかる。</p>
<blockquote class="last">
<div><div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">date:2015-01-19 02:08:47        thread:tomcat-http--4   X-Track:aadf5822205d423c95a6531f2f76036f        level:ERROR     logger:o.t.gfw.common.exception.ExceptionLogger         message:[e.xx.fw.9002]</span>
<span class="hll"><span class="gp">#</span><span class="c1">## Error querying database.  Cause: org.h2.jdbc.JdbcSQLException: Table &quot;TODO&quot; not found; SQL statement:</span>
</span><span class="go">SELECT</span>
<span class="go">            todo_id,</span>
<span class="go">            todo_title,</span>
<span class="go">            finished,</span>
<span class="go">            created_at</span>
<span class="go">        FROM</span>
<span class="go">            todo [42102-182]</span>
<span class="gp">#</span><span class="c1">## The error may exist in todo/domain/repository/todo/TodoRepository.xml</span>
<span class="gp">#</span><span class="c1">## The error may involve todo.domain.repository.todo.TodoRepository.findAll</span>
<span class="gp">#</span><span class="c1">## The error occurred while executing a query</span>

<span class="go">... (omitted)</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="id24">
<h2><a class="toc-backref" href="#id63">10.2.4. おわりに</a><a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h2>
<p>このチュートリアルでは、以下の内容を学習した。</p>
<ul class="simple">
<li>TERASOLUNA Server Framework for Java (5.x)による基本的なRESTful Webサービスの構築方法</li>
<li>REST API(GET, POST, PUT, DELETE)を提供するControllerクラスの実装</li>
<li>JavaBeanとJSONの相互変換方法</li>
<li>エラーメッセージの定義方法</li>
<li>Spring MVCを使用した各種例外のハンドリング方法</li>
</ul>
<p>ここでは、基本的なRESTful Webサービスの実装法について示した。
考え方の元となるアーキテクチャ・設計指針等について理解を深める為には、「<a class="reference internal" href="../ArchitectureInDetail/WebServiceDetail/REST.html"><span class="doc">RESTful Web Service</span></a>」 を参照されたい。</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="TutorialSession.html" title="10.3. セッションチュートリアル"
             >next</a> |</li>
        <li class="right" >
          <a href="TutorialTodo.html" title="10.1. チュートリアル(Todoアプリケーション)"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.3.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >10. チュートリアル</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer">
      © Copyright 2013-2017, NTT DATA Corporation. © Copyright 2017, NTT Corporation.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3.Theme by <a href="http://github.com/vkvn">vkvn</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>
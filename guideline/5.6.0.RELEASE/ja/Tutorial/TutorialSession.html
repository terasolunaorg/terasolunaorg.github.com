<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>11.3. セッションチュートリアル &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.6.0.RELEASE documentation</title>
    <link rel="stylesheet" href="../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '5.6.0.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="11.4. Spring Securityチュートリアル" href="TutorialSecurity.html" />
    <link rel="prev" title="11.2. チュートリアル(Todoアプリケーション REST編)" href="TutorialREST.html" /><script async src="https://www.googletagmanager.com/gtag/js?id=G-847V2Q99G8"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date()); gtag('config', 'G-847V2Q99G8');
</script>
<script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="TutorialSecurity.html" title="11.4. Spring Securityチュートリアル"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="TutorialREST.html" title="11.2. チュートリアル(Todoアプリケーション REST編)"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.6.0.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">11. チュートリアル</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">11.3. セッションチュートリアル</a><ul>
<li><a class="reference internal" href="#id3">11.3.1. 始めに</a><ul>
<li><a class="reference internal" href="#id4">11.3.1.1. 学習の流れ</a></li>
<li><a class="reference internal" href="#id5">11.3.1.2. このチュートリアルで学ぶこと</a></li>
<li><a class="reference internal" href="#id6">11.3.1.3. 対象読者</a></li>
<li><a class="reference internal" href="#id7">11.3.1.4. 検証環境</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id8">11.3.2. アプリケーションの概要と要件</a><ul>
<li><a class="reference internal" href="#id9">11.3.2.1. 概要</a></li>
<li><a class="reference internal" href="#id10">11.3.2.2. 要件</a><ul>
<li><a class="reference internal" href="#id11">11.3.2.2.1. 機能要件</a></li>
<li><a class="reference internal" href="#id12">11.3.2.2.2. 非機能要件</a></li>
<li><a class="reference internal" href="#id13">11.3.2.2.3. 基盤構成</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#development-policy">11.3.3. アプリケーションの設計</a><ul>
<li><a class="reference internal" href="#id15">11.3.3.1. 画面定義</a></li>
<li><a class="reference internal" href="#url">11.3.3.2. URLの抽出</a></li>
<li><a class="reference internal" href="#id16">11.3.3.3. 入出力データの設計</a><ul>
<li><a class="reference internal" href="#id17">11.3.3.3.1. データの抽出</a></li>
<li><a class="reference internal" href="#id18">11.3.3.3.2. ライフサイクルの定義</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id19">11.3.3.4. セッション利用有無の判断</a></li>
<li><a class="reference internal" href="#id20">11.3.3.5. セッション中のデータを利用するための実装方法</a></li>
<li><a class="reference internal" href="#id21">11.3.3.6. セッションを利用する際の考慮事項</a><ul>
<li><a class="reference internal" href="#id22">11.3.3.6.1. セッションの同期化</a></li>
<li><a class="reference internal" href="#id23">11.3.3.6.2. セッションタイムアウト</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id24">11.3.3.7. アプリケーション設計の全体</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id25">11.3.4. プロジェクトの構成</a><ul>
<li><a class="reference internal" href="#id26">11.3.4.1. プロジェクトの作成</a></li>
<li><a class="reference internal" href="#id27">11.3.4.2. プロジェクトの構成</a></li>
<li><a class="reference internal" href="#id28">11.3.4.3. 動作確認</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ec">11.3.5. 簡易ECサイトアプリケーションの作成</a><ul>
<li><a class="reference internal" href="#id29">11.3.5.1. アカウント情報変更機能を作成する</a><ul>
<li><a class="reference internal" href="#id30">11.3.5.1.1. フォームオブジェクトの作成</a></li>
<li><a class="reference internal" href="#controller">11.3.5.1.2. Controllerの作成</a></li>
<li><a class="reference internal" href="#jsp">11.3.5.1.3. JSPの作成</a></li>
<li><a class="reference internal" href="#id31">11.3.5.1.4. 動作確認</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id32">11.3.5.2. カートアイテム登録機能を作成する</a><ul>
<li><a class="reference internal" href="#bean">11.3.5.2.1. セッションスコープBeanを定義</a></li>
<li><a class="reference internal" href="#id33">11.3.5.2.2. フォームオブジェクトの作成</a></li>
<li><a class="reference internal" href="#id34">11.3.5.2.3. Controllerの作成</a></li>
<li><a class="reference internal" href="#id35">11.3.5.2.4. JSPの作成</a></li>
<li><a class="reference internal" href="#id36">11.3.5.2.5. 動作確認</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id37">11.3.5.3. 商品検索情報を保持する仕組みを作成する</a><ul>
<li><a class="reference internal" href="#id38">11.3.5.3.1. セッションスコープBeanを作成</a></li>
<li><a class="reference internal" href="#id39">11.3.5.3.2. Controllerの修正</a></li>
<li><a class="reference internal" href="#id40">11.3.5.3.3. 動作確認</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id41">11.3.5.4. カートアイテム削除機能を作成する</a><ul>
<li><a class="reference internal" href="#id42">11.3.5.4.1. フォームオブジェクトの作成</a></li>
<li><a class="reference internal" href="#id43">11.3.5.4.2. Controllerの作成</a></li>
<li><a class="reference internal" href="#id44">11.3.5.4.3. JSPの作成</a></li>
<li><a class="reference internal" href="#id45">11.3.5.4.4. 動作確認</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id46">11.3.5.5. 商品注文機能を作成する</a><ul>
<li><a class="reference internal" href="#id47">11.3.5.5.1. Controllerの作成</a></li>
<li><a class="reference internal" href="#id48">11.3.5.5.2. JSPの作成</a></li>
<li><a class="reference internal" href="#id49">11.3.5.5.3. 動作確認</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id50">11.3.5.6. セッションの同期化とタイムアウトの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id51">11.3.6. 終わりに</a></li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="TutorialREST.html"
                        title="previous chapter">11.2. チュートリアル(Todoアプリケーション REST編)</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="TutorialSecurity.html"
                        title="next chapter">11.4. Spring Securityチュートリアル</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/Tutorial/TutorialSession.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="id1">
<h1>11.3. セッションチュートリアル<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<div class="admonition caution">
  <p class="first admonition-title">Caution</p>
  <p><strong>本バージョンの内容は既に古くなっています</strong>。最新のガイドラインは<a href="http://terasolunaorg.github.io/guideline/">こちら</a>からご参照ください。</p>
</div>
<div class="contents local topic" id="id2">
<p class="topic-title">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#id3" id="id52">始めに</a><ul>
<li><a class="reference internal" href="#id4" id="id53">学習の流れ</a></li>
<li><a class="reference internal" href="#id5" id="id54">このチュートリアルで学ぶこと</a></li>
<li><a class="reference internal" href="#id6" id="id55">対象読者</a></li>
<li><a class="reference internal" href="#id7" id="id56">検証環境</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id8" id="id57">アプリケーションの概要と要件</a><ul>
<li><a class="reference internal" href="#id9" id="id58">概要</a></li>
<li><a class="reference internal" href="#id10" id="id59">要件</a><ul>
<li><a class="reference internal" href="#id11" id="id60">機能要件</a></li>
<li><a class="reference internal" href="#id12" id="id61">非機能要件</a></li>
<li><a class="reference internal" href="#id13" id="id62">基盤構成</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#development-policy" id="id63">アプリケーションの設計</a><ul>
<li><a class="reference internal" href="#id15" id="id64">画面定義</a></li>
<li><a class="reference internal" href="#url" id="id65">URLの抽出</a></li>
<li><a class="reference internal" href="#id16" id="id66">入出力データの設計</a><ul>
<li><a class="reference internal" href="#id17" id="id67">データの抽出</a></li>
<li><a class="reference internal" href="#id18" id="id68">ライフサイクルの定義</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id19" id="id69">セッション利用有無の判断</a></li>
<li><a class="reference internal" href="#id20" id="id70">セッション中のデータを利用するための実装方法</a></li>
<li><a class="reference internal" href="#id21" id="id71">セッションを利用する際の考慮事項</a><ul>
<li><a class="reference internal" href="#id22" id="id72">セッションの同期化</a></li>
<li><a class="reference internal" href="#id23" id="id73">セッションタイムアウト</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id24" id="id74">アプリケーション設計の全体</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id25" id="id75">プロジェクトの構成</a><ul>
<li><a class="reference internal" href="#id26" id="id76">プロジェクトの作成</a></li>
<li><a class="reference internal" href="#id27" id="id77">プロジェクトの構成</a></li>
<li><a class="reference internal" href="#id28" id="id78">動作確認</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ec" id="id79">簡易ECサイトアプリケーションの作成</a><ul>
<li><a class="reference internal" href="#id29" id="id80">アカウント情報変更機能を作成する</a><ul>
<li><a class="reference internal" href="#id30" id="id81">フォームオブジェクトの作成</a></li>
<li><a class="reference internal" href="#controller" id="id82">Controllerの作成</a></li>
<li><a class="reference internal" href="#jsp" id="id83">JSPの作成</a></li>
<li><a class="reference internal" href="#id31" id="id84">動作確認</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id32" id="id85">カートアイテム登録機能を作成する</a><ul>
<li><a class="reference internal" href="#bean" id="id86">セッションスコープBeanを定義</a></li>
<li><a class="reference internal" href="#id33" id="id87">フォームオブジェクトの作成</a></li>
<li><a class="reference internal" href="#id34" id="id88">Controllerの作成</a></li>
<li><a class="reference internal" href="#id35" id="id89">JSPの作成</a></li>
<li><a class="reference internal" href="#id36" id="id90">動作確認</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id37" id="id91">商品検索情報を保持する仕組みを作成する</a><ul>
<li><a class="reference internal" href="#id38" id="id92">セッションスコープBeanを作成</a></li>
<li><a class="reference internal" href="#id39" id="id93">Controllerの修正</a></li>
<li><a class="reference internal" href="#id40" id="id94">動作確認</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id41" id="id95">カートアイテム削除機能を作成する</a><ul>
<li><a class="reference internal" href="#id42" id="id96">フォームオブジェクトの作成</a></li>
<li><a class="reference internal" href="#id43" id="id97">Controllerの作成</a></li>
<li><a class="reference internal" href="#id44" id="id98">JSPの作成</a></li>
<li><a class="reference internal" href="#id45" id="id99">動作確認</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id46" id="id100">商品注文機能を作成する</a><ul>
<li><a class="reference internal" href="#id47" id="id101">Controllerの作成</a></li>
<li><a class="reference internal" href="#id48" id="id102">JSPの作成</a></li>
<li><a class="reference internal" href="#id49" id="id103">動作確認</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id50" id="id104">セッションの同期化とタイムアウトの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id51" id="id105">終わりに</a></li>
</ul>
</div>
<div class="section" id="id3">
<h2><a class="toc-backref" href="#id52">11.3.1. 始めに</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id53">11.3.1.1. 学習の流れ</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>このチュートリアルでは、簡易webアプリケーションの作成を通じてセッション管理対象となるデータの設計方法やセッションを利用するための具体的な実装方法を学習する。
本チュートリアルは以下の流れで実施する。</p>
<ol class="arabic simple">
<li>作成するwebアプリケーションの要件を確認する</li>
<li>要件を満たすようなControllerの実装方法とデータの設計を行う手順を確認する</li>
<li>設計情報をもとに実装する</li>
</ol>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id54">11.3.1.2. このチュートリアルで学ぶこと</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><dl class="first docutils">
<dt>セッション管理対象となるデータの設計方法</dt>
<dd><ul class="first last">
<li>セッションに格納するデータの選択</li>
<li>セッション中のデータの破棄</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>本FWにおけるセッションの具体的な利用方法</dt>
<dd><ul class="first last">
<li><code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code> を使用する方法</li>
<li>セッションスコープのBeanを使用する方法</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="id6">
<h3><a class="toc-backref" href="#id55">11.3.1.3. 対象読者</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>チュートリアル：Todoアプリケーションを実施している</li>
<li>チュートリアル：Spring Securityを実施している</li>
</ul>
</div>
<div class="section" id="id7">
<h3><a class="toc-backref" href="#id56">11.3.1.4. 検証環境</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>本チュートリアルは以下の環境で動作確認している。</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="30%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">種別</th>
<th class="head">プロダクト</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>OS</td>
<td>Windows 7</td>
</tr>
<tr class="row-odd"><td>JVM</td>
<td><a class="reference external" href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">Java</a> 1.8</td>
</tr>
<tr class="row-even"><td>IDE</td>
<td><a class="reference external" href="http://spring.io/tools/sts/all">Spring Tool Suite</a> 3.6.4.RELEASE (以降「STS」と呼ぶ)</td>
</tr>
<tr class="row-odd"><td>Build Tool</td>
<td><a class="reference external" href="http://maven.apache.org/download.cgi">Apache Maven</a> 3.3.3 (以降「Maven」と呼ぶ)</td>
</tr>
<tr class="row-even"><td>Application Server</td>
<td><a class="reference external" href="https://network.pivotal.io/products/pivotal-tcserver">Pivotal tc Server</a> Developer Edition v3.1 (STSに同封)</td>
</tr>
<tr class="row-odd"><td>Web Browser</td>
<td><a class="reference external" href="https://www.google.co.jp/chrome/browser/desktop/index.html">Google Chrome</a> 42.0.2311.90 m</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">本ガイドラインではSTS 4.xではなく、3.xの利用を推奨している。詳細は <a class="reference internal" href="../Overview/FirstApplication.html#warning-sts-4"><span class="std std-ref">STS 4.x について</span></a> を参照されたい。</p>
</div>
</div>
</div>
<div class="section" id="id8">
<h2><a class="toc-backref" href="#id57">11.3.2. アプリケーションの概要と要件</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id9">
<h3><a class="toc-backref" href="#id58">11.3.2.1. 概要</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>簡易ECサイトを作成する。
ECサイトにおいて、ユーザは以下が行える。</p>
<ul class="simple">
<li>アカウントでログインできる</li>
<li>アカウントを作成する</li>
<li>作成したアカウント情報を変更する</li>
<li>ECサイトで扱っている商品一覧を見る</li>
<li>商品の詳細を見る</li>
<li>購入したい商品をカートに登録する</li>
<li>カートに登録した商品をカートから削除する</li>
<li>カート内の商品を注文する</li>
</ul>
<p>アプリケーションの概要を以下の図に示す。図中のXxxPagesは画面群を表している。
本チュートリアルでは、1つの画面群で行われるシステムとユーザとのやり取りを1つのユースケースとして扱う。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/materialSessionTutorialOverview.png"><img alt="overview" src="../_images/materialSessionTutorialOverview.png" style="width: 95%;" /></a>
</div>
</div>
<div class="section" id="id10">
<h3><a class="toc-backref" href="#id59">11.3.2.2. 要件</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id11">
<h4><a class="toc-backref" href="#id60">11.3.2.2.1. 機能要件</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<p>本アプリケーションでは、前述の各画面(ユースケース)に対して以下の機能を実装する。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">画面(ユースケース)</th>
<th class="head">機能</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">Login Pages</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ログイン機能 <strong>(作成済み)</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">Account Create Pages</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウント作成機能 <strong>(作成済み)</strong></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">Account Update Pages</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウント情報変更機能</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">Item View Pages</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">商品一覧表示機能 <strong>(作成済み)</strong></div>
<div class="line">商品詳細表示機能 <strong>(作成済み)</strong></div>
<div class="line">カートアイテム登録機能</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">Cart View Pages</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">カートアイテム削除機能</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">Order Pages</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">商品注文機能</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>本チュートリアルの初期資材として提供されるプロジェクトでは、あらかじめ一部の機能が作成されている。
これは、セッション管理に直接関連しない部分を作成するコストを削減することを目的としている。</p>
<p>本チュートリアルでは、未完成の機能を作成する。
また、未完成の機能においても、ドメイン層・インフラストラクチャ層の実装は作成済みである。
したがって、本チュートリアルでは、未完成機能の画面とアプリケーション層の作成を行う。</p>
</div>
<div class="section" id="id12">
<h4><a class="toc-backref" href="#id61">11.3.2.2.2. 非機能要件</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<p>実際のアプリケーションを作成する際には、そのシステムに求められている非機能要件を考慮して設計、実装する必要がある。
本チュートリアルでは以下のような非機能要件があることを仮定して設計・作成を行う。
以下で示されている各要件の具体的な数値は学習のための仮想的な値である。
本チュートリアルで作成したアプリケーションが実際に要件を満たすことを保証できないので注意されたい。</p>
<p>可用性</p>
<ul class="simple">
<li>運用期間：24時間</li>
<li>年に数日の計画停止日あり</li>
<li>1時間ほどの停止は許容</li>
<li>障害復帰は1営業日以内を目標とする</li>
<li>稼働率：99%</li>
</ul>
<p>使用性</p>
<ul class="simple">
<li>複数ブラウザ及びタブ上での動作保証はしない</li>
</ul>
<p>性能</p>
<ul class="simple">
<li>ユーザ数：10,000人</li>
<li>同時アクセス数：200人</li>
<li>オンライン処理件数：10,000件 / 月</li>
<li>ユーザ数・同時アクセス数・オンライン処理件数ともに1年で1.2倍の増大が見込まれる</li>
</ul>
<p>セッション管理の設計をするうえで、以下の項目を検討する際に上記要件を考慮する必要がある。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="15%" />
<col width="85%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">要件</th>
<th class="head">検討項目</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">可用性</div>
</div>
</td>
<td><ul class="first last simple">
<li>複数サーバ運用におけるレプリケーションの有無</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">使用性</div>
</div>
</td>
<td><ul class="first last simple">
<li>データの整合性の保持</li>
</ul>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">性能</div>
</div>
</td>
<td><ul class="first last simple">
<li>複数サーバ運用におけるレプリケーションの有無</li>
<li>メモリ使用量</li>
</ul>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>また、上記以外にも個人情報・クレジットカード情報といった重要情報の持ち回りもセッション管理の設計の中で考慮すべきである。</p>
</div>
<div class="section" id="id13">
<h4><a class="toc-backref" href="#id62">11.3.2.2.3. 基盤構成</a><a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h4>
<p>本チュートリアルで作成するアプリケーションは以下の基盤上で動作させるものとする。
以下で示されている構成の具体的な数値は学習のための仮想的な値である。</p>
<ul class="simple">
<li>Web・AP・DBの各サーバは2台構成とする。</li>
<li>APサーバのメモリ搭載量は8GB、2つ空きスロットあり</li>
</ul>
<p>セッション管理の設計をするうえで、メモリ使用量やレプリケーションの有無を検討する際に上記構成を考慮する必要がある。</p>
</div>
</div>
</div>
<div class="section" id="development-policy">
<span id="id14"></span><h2><a class="toc-backref" href="#id63">11.3.3. アプリケーションの設計</a><a class="headerlink" href="#development-policy" title="Permalink to this headline">¶</a></h2>
<p>前述の要件をもとに、アプリケーションの作成方針を決定する。
本チュートリアルではドメイン層・インフラストラクチャ層は作成済みであるため、
アプリケーション層に関連する項目のみを対象とする。
また、本チュートリアルはセッションの利用方法を学習することを目的としているため、
セッション管理に直接関連しない項目は記載を省略する。</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">本章では、セッションを利用するプロセスの一例を示しているという点に留意する。
実際の開発では、案件ごとにある作業要領・作業手順に従う必要がある。</p>
</div>
<div class="section" id="id15">
<h3><a class="toc-backref" href="#id64">11.3.3.1. 画面定義</a><a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h3>
<p>要件をもとにアプリケーションが表示する画面を定義する。
画面定義プロセスの詳細は省略する。</p>
<p>最終的に定義した本チュートリアルで作成する画面のイメージは以下のとおりである。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/materialSessionTutorialSpecificationOfUpdateAccountPages.png"><img alt="specification of Account Update Pages" src="../_images/materialSessionTutorialSpecificationOfUpdateAccountPages.png" style="width: 95%;" /></a>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../_images/materialSessionTutorialSpecificationsOfMainFlowPages.png"><img alt="specification of Main Flow Pages" src="../_images/materialSessionTutorialSpecificationsOfMainFlowPages.png" style="width: 95%;" /></a>
</div>
<p>上記の図では省略されているが、他に以下の遷移が存在する。</p>
<ul class="simple">
<li>ログイン画面からログインすると、⑤の画面に遷移する</li>
<li>Account Update Pagesの各画面で「Home」ボタンを押すと、⑤の画面に遷移する</li>
<li>Item View Pages、Cart View Pages、Order Pagesの各画面で「Update Account」ボタンを押すと、①の画面に遷移する</li>
<li>Item View Pages、Cart View Pages、Order Pagesの各画面で「Logout」ボタンを押すと、ログイン画面に遷移する</li>
</ul>
</div>
<div class="section" id="url">
<h3><a class="toc-backref" href="#id65">11.3.3.2. URLの抽出</a><a class="headerlink" href="#url" title="Permalink to this headline">¶</a></h3>
<p>画面イメージをもとに、アプリケーションが処理をするURLを決定する。</p>
<p>画面から発生するイベントごとにURLとパラメータを設定する。
それぞれ、次の規約通りに名称を付与する。</p>
<ul class="simple">
<li>URL：/&lt;ユースケース名&gt;</li>
<li>パラメータ：?&lt;処理名&gt;</li>
</ul>
<p>本アプリケーションではアカウント作成と更新でユースケースが分かれるため、
それぞれ /account/create, /account/update というURLとする。</p>
<p>また、各URLを処理するControllerも決定する。
基本的に１つのユースケースを1つのControllerで処理させる。</p>
<p>最終的に、抽出されたURLは以下のように整理できる。
作成済みと書かれているControllerは、初期資材として提供されるプロジェクトに存在している。
また、作成済みと書かれているパスは、そのパスにアクセスした際の処理が前述の作成済みController内に既に書かれている。</p>
<blockquote>
<div><table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="5%" />
<col width="20%" />
<col width="10%" />
<col width="20%" />
<col width="25%" />
<col width="20%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">処理名</th>
<th class="head">HTTPメソッド</th>
<th class="head">パス</th>
<th class="head">Controller名</th>
<th class="head">画面</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウント情報変更画面1表示処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/update?form1</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">AccountUpdateController</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/updateForm1</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウント情報変更画面2表示処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">POST</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/update?form2</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">AccountUpdateController</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/updateForm2</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウント情報変更確認画面表示処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">POST</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/update?confirm</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">AccountUpdateController</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/updateConfirm</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウント情報変更処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">POST</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/update</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">AccountUpdateController</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウント情報変更完了画面表示処理へリダイレクト</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウント情報変更完了画面表示処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/update?finish</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">AccountUpdateController</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/updateFinish</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウント情報変更画面1に戻る処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">POST</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/update?redoform1</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">AccountUpdateController</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/updateForm1</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウント情報変更画面2に戻る処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">POST</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/update?redoform2</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">AccountUpdateController</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/updateForm2</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ホームに戻る処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/update?home</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">AccountUpdateController</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">商品一覧画面表示処理にリダイレクト</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">商品一覧画面表示処理(デフォルト)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/goods <strong>(作成済み)</strong></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GoodsController <strong>(作成済み)</strong></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/goods/showGoods</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">商品一覧画面表示処理(カテゴリ選択時)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/goods?categoryId <strong>(作成済み)</strong></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GoodsController <strong>(作成済み)</strong></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/goods/showGoods</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">商品一覧画面表示処理(ページ選択時)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/goods?page <strong>(作成済み)</strong></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GoodsController <strong>(作成済み)</strong></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/goods/showGoods</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">商品詳細画面表示処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/goods?{goodsId} <strong>(作成済み)</strong></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GoodsController <strong>(作成済み)</strong></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/goods/showGoodsDetail</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(13)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">商品をカートへ追加処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/addToCart</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GoodsController <strong>(作成済み)</strong></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">商品一覧画面表示処理へリダイレクト</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(14)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">カート画面表示処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/cart</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">CartController</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">cart/viewCart</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(15)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">商品をカートから削除処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">POST</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/cart</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">CartController</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">カート画面表示処理へリダイレクト</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(16)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">注文確認画面表示処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/order?confirm</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OrderController</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">order/confirm</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(17)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">注文処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">POST</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/order</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OrderController</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">注文完了画面表示処理へリダイレクト</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(18)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">注文完了画面表示処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/order?finish</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OrderController</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">order/finish</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id16">
<h3><a class="toc-backref" href="#id66">11.3.3.3. 入出力データの設計</a><a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h3>
<p>画面イメージをもとに、アプリケーションが扱う入出力データを設計する。</p>
<div class="section" id="id17">
<h4><a class="toc-backref" href="#id67">11.3.3.3.1. データの抽出</a><a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h4>
<p>アプリケーションの画面で扱う入出データを抽出する。
前述の画面イメージをもとに以下のデータが抽出できる。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="5%" />
<col width="25%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">データ項目名</th>
<th class="head">データの要素</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウント更新情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウント名、メールアドレス、誕生日、郵便番号、住所、カード番号、有効期限、セキュリティコード</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウント情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウント名、メールアドレス、パスワード、誕生日、郵便番号、住所、カード番号、有効期限、セキュリティコード</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">商品検索情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">選択カテゴリ、ページ番号</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">商品情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">商品名、単価、説明、(商品ID)</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">カート登録情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">数量、(商品ID)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">カート情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">商品名、単価、数量、(商品ID)</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">カート削除情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">商品IDリスト</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">注文情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">注文ID、注文日時、(アカウントID)、商品名、単価、数量</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id18">
<h4><a class="toc-backref" href="#id68">11.3.3.3.2. ライフサイクルの定義</a><a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h4>
<p>前項で抽出したデータのライフサイクルを定義する。
ライフサイクルの定義では、データがいつ生成されていつ破棄されるかを決定する。</p>
<p>複数画面にわたって保持する必要があるデータは、以下のように破棄のタイミングが複数あるので注意する必要がある。</p>
<ul class="simple">
<li>業務が通常のフローで終了する</li>
<li>業務の途中でその業務を中止する</li>
</ul>
<p>上記注意事項を考慮すると、前項で抽出したデータのライフサイクルを以下のように定義できる。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="5%" />
<col width="25%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">データ項目名</th>
<th class="head">ライフサイクル</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウント更新情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">画面①からの入力によって生成し、①～③を遷移する間は保持する。画面①～③以外に遷移した場合に破棄する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウント情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ログイン時に生成し、ログアウト時に破棄する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">商品検索情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">画面⑤に遷移した際に生成し、①～⑧を遷移する間は保持する。画面⑨に遷移した場合に破棄する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">商品情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">画面⑤または⑥に遷移する際に生成し、そのリクエスト間のみ保持する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">カート登録情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">画面⑤または⑥からの入力によって生成し、そのリクエスト間のみ保持する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">カート情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">画面⑤に遷移する際に空のオブジェクトを生成し、①～⑧を遷移する間は保持する。画面⑨に遷移した場合に破棄する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">カート削除情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">画面⑦からの入力によって生成し、そのリクエスト間のみ保持する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">注文情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">画面⑨に遷移する際に生成し、そのリクエスト間のみ保持する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div>
<div class="section" id="id19">
<h3><a class="toc-backref" href="#id69">11.3.3.4. セッション利用有無の判断</a><a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h3>
<p>複数画面にわたって情報を保持する必要がある場合、セッションを利用することで実現が容易となる。一方で、セッションを利用する場合、そのデメリットも考慮する必要がある。
本チュートリアルでは、ガイドラインの <a class="reference internal" href="../ArchitectureInDetail/WebApplicationDetail/SessionManagement.html"><span class="doc">セッション管理</span></a>
を参考にセッションを利用するか否かを判断する。</p>
<p>ガイドラインには、まずセッションを使わない方針で検討して本当に必要なデータのみセッションに格納することを推奨するとの記述がある。
本チュートリアルでもセッションを使わない方針で検討を行う。</p>
<blockquote>
<div><table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="15%" />
<col width="85%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">データ項目</th>
<th class="head">検討内容</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">アカウント更新情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウント更新情報は3画面にまたがって保持されるため、hiddenを用いたデータの持ち回りが必要となる。しかし、アカウント更新情報にはカード番号等の重要情報が含まれる。hiddenを用いた持ち回りでは、重要情報がマスクされずHTMLのソースに書かれてしまうため、セキュリティ上問題となる。そのため、本チュートリアルではセッションを利用することを検討する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">アカウント情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ログイン後のすべての画面で保持されるため、hiddenを用いたデータの持ち回りが必要となる。この場合、作成するほぼすべての画面でデータ持ち回りの処理を記述しなければならない。そのため、画面の実装コストを抑えるためにも、本チュートリアルではセッションを利用することを検討する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">商品検索情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">商品検索情報は8画面にまたがって保持されるため、hiddenを用いたデータの持ち回りが必要となる。この場合、作成するほぼすべての画面でデータ持ち回りの処理を記述しなければならない。そのため、画面の実装コストを抑えるためにも、本チュートリアルではセッションを利用することを検討する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">商品情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">商品情報は1画面でのみ利用されるため、リクエストスコープでデータを扱えばよい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">カート登録情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">カート登録情報は1画面でのみ利用されるため、リクエストスコープでデータを扱えばよい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">カート情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">カート情報は8画面にまたがって保持されるため、hiddenを用いたデータの持ち回りが必要となる。この場合、作成するほぼすべての画面でデータ持ち回りの処理を記述しなければならない。そのため、画面の実装コストを抑えるためにも、本チュートリアルではセッションを利用することを検討する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">カート削除情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">カート削除情報は1画面でのみ利用されるため、リクエストスコープでデータを扱えばよい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">注文情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">注文情報は1画面でのみ利用されるため、リクエストスコープでデータを扱えばよい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>以上から、アカウント更新情報、アカウント情報、カート情報、商品検索情報の4つについて、セッションを利用することを検討する。</p>
<p>次に、セッションを利用することのデメリットを検証する。
この検証によって、デメリットの影響が無視できないと判断される場合はセッションを利用しない。</p>
<p>セッション利用によるデメリットとして大きく以下の3点が挙げられる。</p>
<ul class="simple">
<li>複数タブ、複数ブラウザで利用した場合、互いの操作によってデータの整合性が失われる可能性がある(ことを考慮する必要がある)。</li>
<li>メモリ上で管理されるため、管理するデータのサイズによってはメモリ枯渇の恐れがある。</li>
<li>スケールアウトの実施や高い可用性の獲得を目的としてAPサーバを多重化した際に、セッションのレプリケーションを考慮する必要がある。その際、大量のデータをセッションで扱っていると、性能等に影響する可能性がある。</li>
</ul>
<p>上記の観点について、それぞれ該当するリスクにどう対処するかやリスクを許容するかを検討する。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="15%" />
<col width="85%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">観点</th>
<th class="head">検討内容</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">データの整合性</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本アプリケーションでは、複数ブラウザ及びタブ上での動作保証はしない。そのため、データの整合性を担保する対策は不要である。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">メモリ使用量</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">セッションの利用を検討しているデータのサイズを見積もる。文字列要素は最大100文字240バイト(4文字8バイト+初期40バイト)、日付要素は24バイト、数値要素は16バイトとして推定する。また、ログイン認証時にセッションへ格納される認証情報<code class="docutils literal"><span class="pre">UserDetails</span></code>のサイズも含める。<code class="docutils literal"><span class="pre">UserDetails</span></code>には大きく、ID、パスワード、ユーザの権限が含まれる。ユーザの権限は複数指定できるが、ここでは1つとして推定を行う。各項目の推定結果は、以下のようになる。</div>
</div>
<ul class="simple">
<li>アカウント情報(文字列：7項目、日付：2項目)： 最大1.7Kバイト</li>
<li>アカウント変更情報(文字列：8項目、日付：2項目)： 最大2.0Kバイト</li>
<li>カート情報(最大19商品×(文字列:3項目、数値：3項目))： 最大14.6Kバイト</li>
<li>商品検索情報(数値：2項目)：32バイト</li>
<li><code class="docutils literal"><span class="pre">UserDetails</span></code>：(文字列：3項目)：0.7Kバイト</li>
</ul>
<div class="last line-block">
<div class="line">1ユーザで最大合計19KB使用する。安全率を10%と考慮すると1ユーザ約21KB使用する。同時接続人数1万人を考慮しても使用量は約210MBであり、その他のメモリ使用量を考えてもメモリ搭載量8GBを大幅に下回るため、メモリ枯渇が発生する可能性は小さい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">APサーバの多重化</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本アプリケーションでは高い可用性は求められていないため、障害発生時におけるユースケースの継続は不要で、再ログインによるユースケースのやり直しを許容している。そのため、同一セッション内で発生するリクエストを全て同じAPサーバに振り分けるようにロードバランサを設定する対処のみとし、セッションのAPサーバ間でのレプリケーションを実現しない。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">オブジェクトのサイズを推定するには、オブジェクトのサイズを計測するためのツール(例えばSizeOfなど)を用いる必要がある。本チュートリアルの計算式はSizeOfでの実測値の傾向を参考にしているが、あくまで仮の値であることに注意する。実際のシステム開発でのサイジングの際にはどのように算出するかを個別に検討すること。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">メモリ枯渇を防ぐために、セッションに格納するデータは基本的に入力データに限る。検索結果等の出力データはサイズが大きくなりやすい一方、画面操作で編集することができない読み取り専用であることが多いため、セッションに格納するには向いていない。</p>
</div>
<p>上記以外にも、セッションキーの管理コストの増加も考慮点の1つではある。
しかし、今回作成するアプリケーションではセッションに格納するデータ数が多くないため、セッションキーの管理コストは限定的なものであるといえる。</p>
<p>この結果から、セッションを利用することで発生するデメリットの影響は大きくないといえる。
最終的にセッションに格納するデータは以下のとおりである。</p>
<ul class="simple">
<li>アカウント変更情報</li>
<li>アカウント情報</li>
<li>商品検索情報</li>
<li>カート情報</li>
</ul>
<p>本チュートリアルでは、セッションを利用してデータの持ち回りを実現するという判断を下した。
しかし、検討の結果、セッションを利用しないという判断を下すことも考えられる。
セッションを利用しない場合は、一例としてhiddenを利用してデータの持ち回りを実現する。</p>
<p>また、セッションを利用する際にデータの整合性を保つ方式やレプリケーションの設定が必要になることがある。</p>
<p>ガイドラインではトランザクショントークンチェックを使用して回避する方法を挙げている。ただし、この場合ユーザビリティの低いアプリケーションとなることに注意する。具体的な実現方法は ﻿<a class="reference internal" href="../ArchitectureInDetail/WebApplicationDetail/DoubleSubmitProtection.html"><span class="doc">二重送信防止</span></a> を参照されたい。</p>
<p>レプリケーションの設定はAPサーバに依存するため、レプリケーションを考慮する必要がある場合は、APサーバの設定を確認する必要がある。</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>ここで判断したデータ以外にもセッションに格納されるデータが存在する場合がある。
ガイドラインにある項目のうち、以下の項目を利用する場合にセッションが使用される。</p>
<ul class="last simple">
<li>Spring Securityを利用した認証・認可・CSRF対策を利用している</li>
<li>二重送信防止のためのトランザクショントークンチェックを利用している</li>
</ul>
</div>
</div>
<div class="section" id="id20">
<h3><a class="toc-backref" href="#id70">11.3.3.5. セッション中のデータを利用するための実装方法</a><a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h3>
<p>本項では、各データに対してセッション中のデータを利用するための実装方法を決定する。</p>
<p>ガイドラインでは、データの利用場所に応じて2種類の実装方法を提供している。
<a class="reference internal" href="../ArchitectureInDetail/WebApplicationDetail/SessionManagement.html"><span class="doc">セッション管理</span></a> では、1つのController内で完結するデータかどうかによって利用方法を区別している。
したがって、セッションに格納するデータのライフサイクルとURLマッピングを考慮して実装方法を決める必要がある。
また、認証情報に紐づくデータである場合は、Spring Securityの機能によってセッション管理を実現することが望ましい。</p>
<p>これらを考慮して、セッションで扱うデータを整理した最終的な結果が以下である。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="30%" />
<col width="30%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">データ</th>
<th class="head">特性</th>
<th class="head">セッション中のデータ利用方法</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">アカウント変更情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">1つのController内でのみ利用される</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code> アノテーションを用いた方法</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">アカウント情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">複数のController間で利用される</div>
<div class="line">認証処理で使用される</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring Securityの機能を用いた方法</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">商品検索情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">複数のController間で利用される</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SpringのセッションスコープのBeanを用いた方法</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">カート情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">複数のController間で利用される</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SpringのセッションスコープのBeanを用いた方法</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>アカウント情報は初期資材として提供されるプロジェクトですでに作成済みであり、
Spring Securityの機能を利用して管理されている。
そのため、本チュートリアルでは具体的な利用方法の説明は行わない。
具体的な利用方法については <a class="reference internal" href="../Security/Authentication.html"><span class="doc">認証</span></a> を参照されたい。</p>
</div>
<div class="section" id="id21">
<h3><a class="toc-backref" href="#id71">11.3.3.6. セッションを利用する際の考慮事項</a><a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h3>
<p>セッションを利用することが決まった場合、以降に挙げる項目を考慮する必要がある。
それぞれの項目を検討する。</p>
<div class="section" id="id22">
<h4><a class="toc-backref" href="#id72">11.3.3.6.1. セッションの同期化</a><a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h4>
<p>同一ユーザの複数のリクエストによって、セッションに格納されているオブジェクトに同時にアクセスする可能性がある。
そのため、セッションの同期化を行わない場合、想定外のエラーや、動作を引き起こす原因になりうる。</p>
<p>ガイドラインでは、 <a class="reference internal" href="../ArchitectureInDetail/WebApplicationDetail/SessionManagement.html"><span class="doc">セッション管理</span></a> にてBeanProcessorを利用した同期化の実現方法が挙げられているため、本チュートリアルではこれを利用する。</p>
</div>
<div class="section" id="id23">
<h4><a class="toc-backref" href="#id73">11.3.3.6.2. セッションタイムアウト</a><a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h4>
<p>セッションを利用する場合、セッションのタイムアウト時間を設定する必要がある。
タイムアウト時間が長すぎれば、不要なリソースをメモリ上に持ち続けることになり、
タイムアウト時間が短すぎれば、ユーザの利便性が低下する。
そのため、要件に合わせて適切な時間を設定する必要がある。</p>
<p>本チュートリアルでは、メモリリソースが十分に用意されていることもあり、APサーバのデフォルト値30分に設定する。</p>
<p>また、セッションタイムアウト後のリクエストに対する処理も検討する必要がある。
ガイドラインでは、  <a class="reference internal" href="../ArchitectureInDetail/WebApplicationDetail/SessionManagement.html"><span class="doc">セッション管理</span></a> にてセッションタイムアウト後のリクエストを処理する方法が挙げられている。</p>
<p>本チュートリアルでは、タイムアウト後はログイン画面に遷移するように設定する。</p>
</div>
</div>
<div class="section" id="id24">
<h3><a class="toc-backref" href="#id74">11.3.3.7. アプリケーション設計の全体</a><a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h3>
<p>最終的なアプリケーション設計の全体イメージ図を以下に示す。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/materialSessionTutorialDesignOverview.png"><img alt="overview of design" src="../_images/materialSessionTutorialDesignOverview.png" style="width: 95%;" /></a>
</div>
</div>
</div>
<div class="section" id="id25">
<h2><a class="toc-backref" href="#id75">11.3.4. プロジェクトの構成</a><a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id26">
<h3><a class="toc-backref" href="#id76">11.3.4.1. プロジェクトの作成</a><a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h3>
<p>すでに述べているように、本チュートリアルは一部機能が作成された状態からスタートする。
そのため、すでに作成済みのプロジェクトを用いて開発を進める。</p>
<p>作成済みのプロジェクトは次の手順で取得することができる。</p>
<ol class="arabic simple">
<li><a class="reference external" href="https://github.com/terasolunaorg/tutorial-apps">tutorial-apps</a> にアクセスする。</li>
<li>「Branch」ボタン押下して必要なバージョンのBranchを選択し、「Download ZIP」ボタンを押下してzipファイルをダウンロードする</li>
<li>zipファイルを展開し、中のプロジェクトをインポートする。</li>
</ol>
<p>なお、プロジェクトのインポート方法は、 <a class="reference internal" href="TutorialTodo.html"><span class="doc">チュートリアル(Todoアプリケーション)</span></a>
で説明済みのため、本チュートリアルでは説明を割愛する。</p>
</div>
<div class="section" id="id27">
<h3><a class="toc-backref" href="#id77">11.3.4.2. プロジェクトの構成</a><a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h3>
<p>gitで取得した初期プロジェクトの構成について述べる。
取得したプロジェクトとブランクプロジェクトとの差分のみを以下に示す。</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">session-tutorial-init-domain</span>
<span class="go">    └── src</span>
<span class="go">        └── main</span>
<span class="go">             ├── java</span>
<span class="go">             │   └── com</span>
<span class="go">             │       └── example</span>
<span class="go">             │           └── session</span>
<span class="go">             │               └── domain</span>
<span class="go">             │                   ├── model  ... (1)</span>
<span class="go">             │                   │  ├── Account.java  ... (2)</span>
<span class="go">             │                   │  ├── Cart.java  ... (3)</span>
<span class="go">             │                   │  ├── CartItem.java  ... (3)</span>
<span class="go">             │                   │  ├── Goods.java</span>
<span class="go">             │                   │  ├── Order.java  ... (4)</span>
<span class="go">             │                   │  └── OrderLine.java  ... (4)</span>
<span class="go">             │                   ├── repository  ... (5)</span>
<span class="go">             │                   │  ├── account</span>
<span class="go">             │                   │  │  └── AccountRepository.java</span>
<span class="go">             │                   │  ├── goods</span>
<span class="go">             │                   │  │  └── GoodsRepository.java</span>
<span class="go">             │                   │  └── order</span>
<span class="go">             │                   │      └── OrderRepository.java</span>
<span class="go">             │                   └── service  ... (6)</span>
<span class="go">             │                       ├── account</span>
<span class="go">             │                       │  ├── AccountService.java</span>
<span class="go">             │                       │  └── AccountServiceImpl.java</span>
<span class="go">             │                       ├── goods</span>
<span class="go">             │                       │  ├── GoodsService.java</span>
<span class="go">             │                       │  └── GoodsServiceImpl.java</span>
<span class="go">             │                       ├── order</span>
<span class="go">             │                       │  ├── EmptyCartOrderException.java</span>
<span class="go">             │                       │  ├── InvalidCartOrderException.java</span>
<span class="go">             │                       │  ├── OrderService.java</span>
<span class="go">             │                       │  └── OrderServiceImpl.java</span>
<span class="go">             │                       └── userdetails</span>
<span class="go">             │                           ├── AccountDetails.java</span>
<span class="go">             │                           └── AccountDetailsService.java</span>
<span class="go">             └── resources</span>
<span class="go">                  ├── com</span>
<span class="go">                  │  └── example</span>
<span class="go">                  │      └── session</span>
<span class="go">                  │          └── domain</span>
<span class="go">                  │              └── repository  ... (7)</span>
<span class="go">                  │                  ├── account</span>
<span class="go">                  │                  │  └── AccountRepository.xml</span>
<span class="go">                  │                  ├── goods</span>
<span class="go">                  │                  │  └── GoodsRepository.xml</span>
<span class="go">                  │                  └── order</span>
<span class="go">                  │                      └── OrderRepository.xml</span>
<span class="go">                  └── META-INF</span>
<span class="go">                       ├── dozer</span>
<span class="go">                       │  └── order-mapping.xml  ... (8)</span>
<span class="go">                       └── spring</span>
<span class="go">                           └── session-tutorial-init-codelist.xml  ... (9)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本アプリケーションで使用するmodelを扱うパッケージ。</div>
<div class="line">チュートリアルを進める上で理解しておく必要があるmodelは以下で詳しく説明する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザアカウント情報を保持するクラス。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザがカートに登録した商品の情報を保持するクラス。</div>
<div class="line">全体を <cite>Cart</cite> が管理し、個別の商品を <cite>CartItem</cite> が管理する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザが注文した商品の情報を保持するクラス。</div>
<div class="line">全体を <cite>Order</cite> が管理し、個別の商品を <cite>OrderLine</cite> が管理する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本アプリケーションで使用するrepositoryを扱うパッケージ。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本アプリケーションで使用するserviceを扱うパッケージ。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">repositoryで使用するマッピングファイルを格納するディレクトリ。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Dozer(Bean Mapper)のマッピング定義ファイル。</div>
<div class="line"><cite>Cart</cite> から <cite>Order</cite> への変換が定義されている。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本アプリケーションで使用するコードリストを定義したBean定義ファイル。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">session-tutorial-init-env</span>
<span class="go">    └── src</span>
<span class="go">        └── main</span>
<span class="go">             └── resources</span>
<span class="go">                 └── database  ... (1)</span>
<span class="go">                     ├── H2-dataload.sql</span>
<span class="go">                     └── H2-schema.sql</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">ファイル名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本アプリケーションでインメモリデータベース(H2 Database)をセットアップするためのSQLを格納するディレクトリ。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">session-tutorial-init-web</span>
<span class="go">    └── src</span>
<span class="go">        └── main</span>
<span class="go">             ├── java</span>
<span class="go">             │   └── com</span>
<span class="go">             │       └── example</span>
<span class="go">             │           └── session</span>
<span class="go">             │               └── app  ... (1)</span>
<span class="go">             │                   ├── account</span>
<span class="go">             │                   │  ├── AccountCreateController.java</span>
<span class="go">             │                   │  ├── AccountCreateForm.java</span>
<span class="go">             │                   │  ├── IlleagalOperationException.java</span>
<span class="go">             │                   │  └── IlleagalOperationExceptionHandler.java</span>
<span class="go">             │                   ├── goods</span>
<span class="go">             │                   │  ├── GoodsController.java</span>
<span class="go">             │                   │  └── GoodsViewForm.java</span>
<span class="go">             │                   └── validation</span>
<span class="go">             │                       ├── Confirm.java</span>
<span class="go">             │                       └── ConfirmValidator.java</span>
<span class="go">             ├── resources</span>
<span class="go">             │   ├── i18n</span>
<span class="go">             │   │  └── application-messages.properties  ... (2)</span>
<span class="go">             │   ├── META-INF</span>
<span class="go">             │   │   └── spring  ... (3)</span>
<span class="go">             │   │       ├── spring-mvc.xml</span>
<span class="go">             │   │       └── spring-security.xml</span>
<span class="go">             │   └── ValidationMessages.properties  ... (2)</span>
<span class="go">             └── webapp</span>
<span class="go">                  ├── resources  ... (4)</span>
<span class="go">                  │  ├── app</span>
<span class="go">                  │  │  └── css</span>
<span class="go">                  │  │      └── styles.css</span>
<span class="go">                  │  └── vendor</span>
<span class="go">                  │      └── bootstrap-3.0.0</span>
<span class="go">                  │          └── css</span>
<span class="go">                  │              └── bootstrap.css</span>
<span class="go">                  └── WEB-INF</span>
<span class="go">                      └── views  ... (5)</span>
<span class="go">                          ├── account</span>
<span class="go">                          │  ├── createConfirm.jsp</span>
<span class="go">                          │  ├── createFinish.jsp</span>
<span class="go">                          │  └── createForm.jsp</span>
<span class="go">                          ├── common</span>
<span class="go">                          │  ├── error</span>
<span class="go">                          │  │  └── illegalOperationError.jsp</span>
<span class="go">                          │  └── include.jsp</span>
<span class="go">                          ├── layout</span>
<span class="go">                          │  └── template.jsp</span>
<span class="go">                          ├── goods</span>
<span class="go">                          │  ├── showGoods.jsp</span>
<span class="go">                          │  └── showGoodsDetails.jsp</span>
<span class="go">                          └── login</span>
<span class="go">                              └── loginForm.jsp</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本アプリケーションで使用するアプリケーション層のクラスを格納するためのパッケージ。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本アプリケーションで使用するメッセージが定義されているプロパティファイル</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本アプリケーションで使用するコンポーネントが定義されているBean定義ファイル</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本アプリケーションで使用する静的リソースファイル</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本アプリケーションで使用するjspが格納されているディレクトリ</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id28">
<h3><a class="toc-backref" href="#id78">11.3.4.3. 動作確認</a><a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h3>
<p>アプリケーション開発を行う前に、取得したプロジェクトの動作確認を行う。
STSにインポートしたプロジェクトを対象として、アプリケーションサーバを起動する
アプリケーションサーバの起動方法は、  <a class="reference internal" href="TutorialTodo.html"><span class="doc">チュートリアル(Todoアプリケーション)</span></a>
で説明済みのため、本チュートリアルでは説明を割愛する。</p>
<p>アプリケーションサーバ起動後、 <a class="reference external" href="http://localhost:8080/session-tutorial-init-web/loginForm">http://localhost:8080/session-tutorial-init-web/loginForm</a> にアクセスすると以下の画面が表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/materialSessionTutorialLoginPage.png"><img alt="Login Page" src="../_images/materialSessionTutorialLoginPage.png" style="width: 40%;" /></a>
</div>
<p>ログイン画面上にある”here”のリンクを選択すると、アカウント作成を行うことができる。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/materialSessionTutorialCreateAccountPages.png"><img alt="Account Create Pages" src="../_images/materialSessionTutorialCreateAccountPages.png" style="width: 95%;" /></a>
</div>
<p>ログイン画面にて、(E-mail=”<a class="reference external" href="mailto:a&#37;&#52;&#48;b&#46;com">a<span>&#64;</span>b<span>&#46;</span>com</a>”、Password=”demo”)をフォーム入力するとログインすることができる。
ログイン後は商品一覧が表示される。
商品名を選択すると商品詳細を表示できる。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/materialSessionTutorialViewItemPages.png"><img alt="Item View Pages" src="../_images/materialSessionTutorialViewItemPages.png" style="width: 65%;" /></a>
</div>
</div>
</div>
<div class="section" id="ec">
<h2><a class="toc-backref" href="#id79">11.3.5. 簡易ECサイトアプリケーションの作成</a><a class="headerlink" href="#ec" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id29">
<h3><a class="toc-backref" href="#id80">11.3.5.1. アカウント情報変更機能を作成する</a><a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h3>
<p>ユーザに情報を入力させてアカウント情報を更新する機能を作成する。</p>
<p><a class="reference internal" href="#development-policy"><span class="std std-ref">アプリケーションの設計</span></a> で説明したとおり、アカウント変更情報は <code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code> アノテーションを利用して管理する。</p>
<p>以下にアカウント情報変更機能で実装する画面の情報を示す。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="30%" />
<col width="15%" />
<col width="25%" />
<col width="30%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">処理名</th>
<th class="head">HTTPメソッド</th>
<th class="head">パス</th>
<th class="head">画面</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">アカウント情報変更画面1表示処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/update?form1</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/updateForm1</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">アカウント情報変更画面2表示処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/update?form2</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/updateForm2</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">アカウント情報変更確認画面表示処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/update?confirm</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/updateConfirm</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">アカウント情報変更処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">POST</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/update</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウント情報変更完了画面表示処理へリダイレクト</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">アカウント情報変更完了画面表示処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/update?finish</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/updateFinish</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">アカウント情報変更画面1に戻る処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/update?redoform1</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/updateForm1</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">アカウント情報変更画面2に戻る処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/update?redoform2</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/updateForm2</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">ホームに戻る処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/account/update?home</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ホーム画面表示処理にリダイレクト</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="section" id="id30">
<h4><a class="toc-backref" href="#id81">11.3.5.1.1. フォームオブジェクトの作成</a><a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h4>
<p>アカウント変更情報を保持するクラスを作成する。</p>
<p><code class="docutils literal"><span class="pre">/session-tutorial-init-web/src/main/java/com/example/session/app/account/AccountUpdateForm.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.session.app.account</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.constraints.Email</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.format.annotation.DateTimeFormat</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountUpdateForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>  <span class="c1">// (1)</span>

    <span class="cm">/**</span>
<span class="cm">     *</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">id</span><span class="p">;</span>

    <span class="c1">// (2)</span>
    <span class="nd">@NotNull</span><span class="p">(</span><span class="n">groups</span> <span class="o">=</span> <span class="p">{</span> <span class="n">Wizard1</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span>
    <span class="nd">@Size</span><span class="p">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">255</span><span class="p">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="p">{</span> <span class="n">Wizard1</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="p">;</span>

    <span class="nd">@NotNull</span><span class="p">(</span><span class="n">groups</span> <span class="o">=</span> <span class="p">{</span> <span class="n">Wizard1</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span>
    <span class="nd">@Size</span><span class="p">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">255</span><span class="p">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="p">{</span> <span class="n">Wizard1</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span>
    <span class="nd">@Email</span><span class="p">(</span><span class="n">groups</span> <span class="o">=</span> <span class="p">{</span> <span class="n">Wizard1</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="p">;</span>

    <span class="nd">@NotNull</span><span class="p">(</span><span class="n">groups</span> <span class="o">=</span> <span class="p">{</span> <span class="n">Wizard1</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span>
    <span class="nd">@DateTimeFormat</span><span class="p">(</span><span class="n">iso</span> <span class="o">=</span> <span class="n">DateTimeFormat</span><span class="p">.</span><span class="na">ISO</span><span class="p">.</span><span class="na">DATE</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">birthday</span><span class="p">;</span>

    <span class="nd">@NotNull</span><span class="p">(</span><span class="n">groups</span> <span class="o">=</span> <span class="p">{</span> <span class="n">Wizard1</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span>
    <span class="nd">@Size</span><span class="p">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="p">{</span> <span class="n">Wizard1</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">zip</span><span class="p">;</span>

    <span class="nd">@NotNull</span><span class="p">(</span><span class="n">groups</span> <span class="o">=</span> <span class="p">{</span> <span class="n">Wizard1</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span>
    <span class="nd">@Size</span><span class="p">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">255</span><span class="p">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="p">{</span> <span class="n">Wizard1</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">address</span><span class="p">;</span>

    <span class="nd">@Size</span><span class="p">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="p">{</span> <span class="n">Wizard2</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">cardNumber</span><span class="p">;</span>

    <span class="nd">@DateTimeFormat</span><span class="p">(</span><span class="n">pattern</span> <span class="o">=</span> <span class="s">&quot;yyyy-MM&quot;</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">cardExpirationDate</span><span class="p">;</span>

    <span class="nd">@Size</span><span class="p">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">255</span><span class="p">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="p">{</span> <span class="n">Wizard2</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">cardSecurityCode</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getId</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="p">(</span><span class="n">String</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getEmail</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">email</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEmail</span><span class="p">(</span><span class="n">String</span> <span class="n">email</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">email</span> <span class="o">=</span> <span class="n">email</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">Date</span> <span class="nf">getBirthday</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">birthday</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setBirthday</span><span class="p">(</span><span class="n">Date</span> <span class="n">birthday</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">birthday</span> <span class="o">=</span> <span class="n">birthday</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getZip</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">zip</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setZip</span><span class="p">(</span><span class="n">String</span> <span class="n">zip</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">zip</span> <span class="o">=</span> <span class="n">zip</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getAddress</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">address</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAddress</span><span class="p">(</span><span class="n">String</span> <span class="n">address</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">address</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getCardNumber</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">cardNumber</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCardNumber</span><span class="p">(</span><span class="n">String</span> <span class="n">cardNumber</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">cardNumber</span> <span class="o">=</span> <span class="n">cardNumber</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">Date</span> <span class="nf">getCardExpirationDate</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">cardExpirationDate</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCardExpirationDate</span><span class="p">(</span><span class="n">Date</span> <span class="n">cardExpirationDate</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">cardExpirationDate</span> <span class="o">=</span> <span class="n">cardExpirationDate</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getCardSecurityCode</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">cardSecurityCode</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCardSecurityCode</span><span class="p">(</span><span class="n">String</span> <span class="n">cardSecurityCode</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">cardSecurityCode</span> <span class="o">=</span> <span class="n">cardSecurityCode</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getLastFourOfCardNumber</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cardNumber</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">cardNumber</span><span class="p">.</span><span class="na">substring</span><span class="p">(</span><span class="n">cardNumber</span><span class="p">.</span><span class="na">length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">Wizard1</span> <span class="p">{</span>

    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">Wizard2</span> <span class="p">{</span>

    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">このクラスのインスタンスをセッションに格納するため、 <code class="docutils literal"><span class="pre">Serializable</span></code> を実装しておく。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">画面遷移ごとに入力チェックの対象を指定するために、バリデーションのグループ化を行う。</div>
<div class="line">上記例では、1ページ目の入力項目と2ページ目の入力項目にそれぞれに対応した入力チェックを実現するために、2つのグループを作成している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="controller">
<h4><a class="toc-backref" href="#id82">11.3.5.1.2. Controllerの作成</a><a class="headerlink" href="#controller" title="Permalink to this headline">¶</a></h4>
<p>Controllerを作成する。
Controllerでは、入力情報を受け取るフォームを <code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code> アノテーションで管理させる記述が必要である。</p>
<p><code class="docutils literal"><span class="pre">/session-tutorial-init-web/src/main/java/com/example/session/app/account/AccountUpdateController.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.session.app.account</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.github.dozermapper.core.Mapper</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.propertyeditors.StringTrimmerEditor</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.annotation.AuthenticationPrincipal</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.BindingResult</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.WebDataBinder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.InitBinder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ModelAttribute</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PostMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.SessionAttributes</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.support.SessionStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.support.RedirectAttributes</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessages</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.example.session.app.account.AccountUpdateForm.Wizard1</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.session.app.account.AccountUpdateForm.Wizard2</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.session.domain.model.Account</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.session.domain.service.account.AccountService</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.session.domain.service.userdetails.AccountDetails</span><span class="p">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;account/update&quot;</span><span class="p">)</span>
<span class="nd">@SessionAttributes</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;accountUpdateForm&quot;</span> <span class="p">})</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountUpdateController</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">AccountService</span> <span class="n">accountService</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">Mapper</span> <span class="n">beanMapper</span><span class="p">;</span>

    <span class="nd">@InitBinder</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initBinder</span><span class="p">(</span><span class="n">WebDataBinder</span> <span class="n">binder</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">binder</span><span class="p">.</span><span class="na">registerCustomEditor</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="k">new</span> <span class="n">StringTrimmerEditor</span><span class="p">(</span><span class="kc">true</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="nd">@ModelAttribute</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;accountUpdateForm&quot;</span><span class="p">)</span> <span class="c1">// (2)</span>
    <span class="kd">public</span> <span class="n">AccountUpdateForm</span> <span class="nf">setUpAccountForm</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">AccountUpdateForm</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nd">@GetMapping</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form1&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">showUpdateForm1</span><span class="p">(</span>
            <span class="nd">@AuthenticationPrincipal</span> <span class="n">AccountDetails</span> <span class="n">userDetails</span><span class="p">,</span>
            <span class="n">AccountUpdateForm</span> <span class="n">form</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (3)</span>

        <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">accountService</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">userDetails</span><span class="p">.</span><span class="na">getAccount</span><span class="p">()</span>
                <span class="p">.</span><span class="na">getEmail</span><span class="p">());</span>
        <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">form</span><span class="p">);</span>

        <span class="k">return</span> <span class="s">&quot;account/updateForm1&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@PostMapping</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form2&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">showUpdateForm2</span><span class="p">(</span>
            <span class="nd">@Validated</span><span class="p">(</span><span class="n">Wizard1</span><span class="p">.</span><span class="na">class</span><span class="p">)</span> <span class="n">AccountUpdateForm</span> <span class="n">form</span><span class="p">,</span>
            <span class="n">BindingResult</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">hasErrors</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s">&quot;account/updateForm1&quot;</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="s">&quot;account/updateForm2&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@PostMapping</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="s">&quot;redoForm1&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">redoUpdateForm1</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;account/updateForm1&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@PostMapping</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="s">&quot;confirm&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">confirmUpdate</span><span class="p">(</span>
            <span class="nd">@Validated</span><span class="p">(</span><span class="n">Wizard2</span><span class="p">.</span><span class="na">class</span><span class="p">)</span> <span class="n">AccountUpdateForm</span> <span class="n">form</span><span class="p">,</span>
            <span class="n">BindingResult</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">hasErrors</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s">&quot;account/updateForm2&quot;</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="s">&quot;account/updateConfirm&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@PostMapping</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="s">&quot;redoForm2&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">redoUpdateForm2</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;account/updateForm2&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@PostMapping</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">update</span><span class="p">(</span>
            <span class="nd">@AuthenticationPrincipal</span> <span class="n">AccountDetails</span> <span class="n">userDetails</span><span class="p">,</span>
            <span class="nd">@Validated</span><span class="p">({</span> <span class="n">Wizard1</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">Wizard2</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span> <span class="n">AccountUpdateForm</span> <span class="n">form</span><span class="p">,</span>
            <span class="n">BindingResult</span> <span class="n">result</span><span class="p">,</span> <span class="n">RedirectAttributes</span> <span class="n">attributes</span><span class="p">,</span> <span class="n">SessionStatus</span> <span class="n">sessionStatus</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">hasErrors</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">ResultMessages</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="p">.</span><span class="na">error</span><span class="p">();</span>
            <span class="n">messages</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;e.st.ac.5001&quot;</span><span class="p">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalOperationException</span><span class="p">(</span><span class="n">messages</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">Account</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="n">accountService</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">account</span><span class="p">);</span>
        <span class="n">userDetails</span><span class="p">.</span><span class="na">setAccount</span><span class="p">(</span><span class="n">account</span><span class="p">);</span>
        <span class="n">attributes</span><span class="p">.</span><span class="na">addFlashAttribute</span><span class="p">(</span><span class="s">&quot;account&quot;</span><span class="p">,</span> <span class="n">account</span><span class="p">);</span>
        <span class="n">sessionStatus</span><span class="p">.</span><span class="na">setComplete</span><span class="p">();</span>  <span class="c1">// (4)</span>

        <span class="k">return</span> <span class="s">&quot;redirect:/account/update?finish&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@GetMapping</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="s">&quot;finish&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">finishUpdate</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;account/updateFinish&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@GetMapping</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="s">&quot;home&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">home</span><span class="p">(</span><span class="n">SessionStatus</span> <span class="n">sessionStatus</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sessionStatus</span><span class="p">.</span><span class="na">setComplete</span><span class="p">();</span>
        <span class="k">return</span> <span class="s">&quot;redirect:/goods&quot;</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code> アノテーションの <code class="docutils literal"><span class="pre">value</span></code> 属性に、セッションに格納するオブジェクトの属性名を指定する。</div>
<div class="line">上記例は、属性名が <code class="docutils literal"><span class="pre">accountUpdateForm</span></code> のオブジェクトが、セッションに格納される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Model</span></code> オブジェクトに格納する属性名を、 <code class="docutils literal"><span class="pre">value</span></code> 属性に指定する。</div>
<div class="line">上記例では、返却したオブジェクトが、 <code class="docutils literal"><span class="pre">accountUpdateForm</span></code> という属性名でセッションに格納される。</div>
<div class="line"><code class="docutils literal"><span class="pre">value</span></code> 属性を指定した場合、セッションにオブジェクトを格納した後のリクエストで、 <code class="docutils literal"><span class="pre">&#64;ModelAttribute</span></code> アノテーションの付与されたメソッドが呼び出されなくなるため、無駄なオブジェクトの生成が行われないというメリットがある。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code> アノテーションによって管理されたオブジェクトを利用するには、そのオブジェクトを受け取れるようメソッドに引数を追加する。</div>
<div class="line">入力チェックが必要であれば <code class="docutils literal"><span class="pre">&#64;Validated</span></code> アノテーションを利用する。</div>
<div class="line">上記例では、 <code class="docutils literal"><span class="pre">AccountUpdateForm</span></code> のデフォルトの属性名である <code class="docutils literal"><span class="pre">accountUpdateForm</span></code> を属性名にもつオブジェクトが引数として渡される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">SessionStatus</span></code> オブジェクトの <code class="docutils literal"><span class="pre">setComplete</span></code> メソッドを呼び出し、オブジェクトをセッションから削除する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code> アノテーションで管理しているオブジェクトは、明示的に削除を行わない限りセッション中に残り続ける。
そのため、Controllerが扱う画面外に遷移して再度戻ってきた場合にも保持していたデータを参照できる。
メモリの枯渇を防ぐために、不要になったデータは必ず削除すること。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">ブラウザのボタンでバックされたり、URLを直接入力して画面遷移した場合は、<code class="docutils literal"><span class="pre">setComplete</span></code> メソッドが呼ばれず、セッションがクリアされずに残ってしまう点に留意する必要がある。</p>
</div>
</div>
<div class="section" id="jsp">
<h4><a class="toc-backref" href="#id83">11.3.5.1.3. JSPの作成</a><a class="headerlink" href="#jsp" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code> アノテーションで管理しているフォームオブジェクトにデータの受け渡しをする画面を作成する。</p>
<p>1ページ目の入力画面</p>
<p><code class="docutils literal"><span class="pre">/session-tutorial-init-web/src/main/webapp/WEB-INF/views/account/updateForm1.jsp</span></code></p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;div&gt;</span>
    <span class="k">&lt;%-</span><span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">--</span><span class="k">%&gt;</span>
    <span class="nt">&lt;form:form</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/account/update&quot;</span>
        <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">modelAttribute=</span><span class="s">&quot;accountUpdateForm&quot;</span><span class="nt">&gt;</span>

        <span class="nt">&lt;h2&gt;</span>Account Update Page 1/2<span class="nt">&lt;/h2&gt;</span>
        <span class="nt">&lt;table&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td&gt;&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>name<span class="nt">&lt;/form:label&gt;&lt;/td&gt;</span>
                <span class="k">&lt;%-</span><span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">--</span><span class="k">%&gt;</span>
                <span class="nt">&lt;td&gt;&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
                    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td&gt;&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>e-mail<span class="nt">&lt;/form:label&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;td&gt;&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
                    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td&gt;&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;birthday&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>birthday<span class="nt">&lt;/form:label&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;td&gt;&lt;fmt:formatDate</span> <span class="na">value=</span><span class="s">&quot;${accountUpdateForm.birthday}&quot;</span> <span class="na">pattern=</span><span class="s">&quot;yyyy-MM-dd&quot;</span> <span class="na">var=</span><span class="s">&quot;formattedBirthday&quot;</span> <span class="nt">/&gt;</span>
                    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;date&quot;</span> <span class="na">id=</span><span class="s">&quot;birthday&quot;</span> <span class="na">name=</span><span class="s">&quot;birthday&quot;</span> <span class="na">value=</span><span class="s">&quot;${formattedBirthday}&quot;</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;birthday&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td&gt;&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;zip&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>zip<span class="nt">&lt;/form:label&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;td&gt;&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;zip&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
                    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;zip&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td&gt;&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;address&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>address<span class="nt">&lt;/form:label&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;td&gt;&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;address&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
                    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;address&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td&gt;</span><span class="ni">&amp;nbsp;</span><span class="nt">&lt;/td&gt;</span>
                <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;form2&quot;</span> <span class="na">id=</span><span class="s">&quot;next&quot;</span> <span class="na">value=</span><span class="s">&quot;next&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;/table&gt;</span>
    <span class="nt">&lt;/form:form&gt;</span>

    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;get&quot;</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/account/update&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;home&quot;</span> <span class="na">id=</span><span class="s">&quot;home&quot;</span> <span class="na">value=</span><span class="s">&quot;home&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力データを受け取るフォームオブジェクトの属性名を <code class="docutils literal"><span class="pre">modelAttribute</span></code> 属性に指定する。</div>
<div class="line">上記例は、属性名が <code class="docutils literal"><span class="pre">accountUpdateForm</span></code> のオブジェクトが入力データを受け取る。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">form:input</span></code> タグの <code class="docutils literal"><span class="pre">path</span></code> 属性に入力データを格納するオブジェクトの要素名を指定する。</div>
<div class="line">この方法を利用すると、指定したオブジェクトの要素名にすでにデータがある場合、その値が入力フォームのデフォルト値となる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>2ページ目の入力画面</p>
<p><code class="docutils literal"><span class="pre">/session-tutorial-init-web/src/main/webapp/WEB-INF/views/account/updateForm2.jsp</span></code></p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;div&gt;</span>

    <span class="nt">&lt;form:form</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/account/update&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">modelAttribute=</span><span class="s">&quot;accountUpdateForm&quot;</span><span class="nt">&gt;</span>

        <span class="nt">&lt;h2&gt;</span>Account Update Page 2/2<span class="nt">&lt;/h2&gt;</span>
        <span class="nt">&lt;table&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td&gt;&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;cardNumber&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>your card number<span class="nt">&lt;/form:label&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;td&gt;&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;cardNumber&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
                    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;cardNumber&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td&gt;&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;cardExpirationDate&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>expiration date of your card<span class="nt">&lt;/form:label&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;td&gt;&lt;fmt:formatDate</span> <span class="na">value=</span><span class="s">&quot;${accountUpdateForm.cardExpirationDate}&quot;</span> <span class="na">pattern=</span><span class="s">&quot;yyyy-MM&quot;</span> <span class="na">var=</span><span class="s">&quot;formattedCardExpirationDate&quot;</span> <span class="nt">/&gt;</span>
                    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;month&quot;</span> <span class="na">name=</span><span class="s">&quot;cardExpirationDate&quot;</span> <span class="na">id=</span><span class="s">&quot;cardExpirationDate&quot;</span> <span class="na">value=</span><span class="s">&quot;${formattedCardExpirationDate}&quot;</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;cardExpirationDate&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td&gt;&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;cardSecurityCode&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>security code of your card<span class="nt">&lt;/form:label&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;td&gt;&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;cardSecurityCode&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
                    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;cardSecurityCode&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td&gt;</span><span class="ni">&amp;nbsp;</span><span class="nt">&lt;/td&gt;</span>
                <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;redoForm1&quot;</span> <span class="na">id=</span><span class="s">&quot;back&quot;</span> <span class="na">value=</span><span class="s">&quot;back&quot;</span> <span class="nt">/&gt;</span>
                    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;confirm&quot;</span> <span class="na">id=</span><span class="s">&quot;confirm&quot;</span> <span class="na">value=</span><span class="s">&quot;confirm&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;/table&gt;</span>
    <span class="nt">&lt;/form:form&gt;</span>

    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;get&quot;</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/account/update&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;home&quot;</span> <span class="na">id=</span><span class="s">&quot;home&quot;</span> <span class="na">value=</span><span class="s">&quot;home&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<p>確認画面</p>
<p><code class="docutils literal"><span class="pre">/session-tutorial-init-web/src/main/webapp/WEB-INF/views/account/updateConfirm.jsp</span></code></p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;div&gt;</span>

    <span class="nt">&lt;form:form</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/account/update&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>

        <span class="nt">&lt;h3&gt;</span>Your account will be updated with below information. Please push &quot;update&quot; button if it&#39;s OK.<span class="nt">&lt;/h3&gt;</span>
        <span class="nt">&lt;table&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>name<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>${f:h(accountUpdateForm.name)}<span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;email&quot;</span><span class="nt">&gt;</span>e-mail<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;email&quot;</span><span class="nt">&gt;</span>${f:h(accountUpdateForm.email)}<span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;birthday&quot;</span><span class="nt">&gt;</span>birthday<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;birthday&quot;</span><span class="nt">&gt;&lt;fmt:formatDate</span> <span class="na">value=</span><span class="s">&quot;${accountUpdateForm.birthday}&quot;</span> <span class="na">pattern=</span><span class="s">&quot;yyyy-MM-dd&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;zip&quot;</span><span class="nt">&gt;</span>zip<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;zip&quot;</span><span class="nt">&gt;</span>${f:h(accountUpdateForm.zip)}<span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;address&quot;</span><span class="nt">&gt;</span>address<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;address&quot;</span><span class="nt">&gt;</span>${f:h(accountUpdateForm.address)}<span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;cardNumber&quot;</span><span class="nt">&gt;</span>your card number<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;cardNumber&quot;</span><span class="nt">&gt;</span>****-****-****-${f:h(accountUpdateForm.lastFourOfCardNumber)}<span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;cardExpirationDate&quot;</span><span class="nt">&gt;</span>expiration date of your card<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;cardExpirationDate&quot;</span><span class="nt">&gt;&lt;fmt:formatDate</span> <span class="na">value=</span><span class="s">&quot;${accountUpdateForm.cardExpirationDate}&quot;</span> <span class="na">pattern=</span><span class="s">&quot;yyyy-MM&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;cardSecurityCode&quot;</span><span class="nt">&gt;</span>security code of your card<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;cardSecurityCode&quot;</span><span class="nt">&gt;</span>${f:h(accountUpdateForm.cardSecurityCode)}<span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td&gt;</span><span class="ni">&amp;nbsp;</span><span class="nt">&lt;/td&gt;</span>
                <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;redoForm2&quot;</span> <span class="na">id=</span><span class="s">&quot;back&quot;</span> <span class="na">value=</span><span class="s">&quot;back&quot;</span> <span class="nt">/&gt;</span>
                    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">id=</span><span class="s">&quot;update&quot;</span> <span class="na">value=</span><span class="s">&quot;update&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;/table&gt;</span>
    <span class="nt">&lt;/form:form&gt;</span>

    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;get&quot;</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/account/update&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;home&quot;</span> <span class="na">id=</span><span class="s">&quot;home&quot;</span> <span class="na">value=</span><span class="s">&quot;home&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<p>完了画面</p>
<p><code class="docutils literal"><span class="pre">/session-tutorial-init-web/src/main/webapp/WEB-INF/views/account/updateFinish.jsp</span></code></p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;div&gt;</span>

    <span class="nt">&lt;h3&gt;</span>Your account has updated.<span class="nt">&lt;/h3&gt;</span>
    <span class="nt">&lt;table&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>name<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>${f:h(account.name)}<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;email&quot;</span><span class="nt">&gt;</span>e-mail<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;email&quot;</span><span class="nt">&gt;</span>${f:h(account.email)}<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;birthday&quot;</span><span class="nt">&gt;</span>birthday<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;birthday&quot;</span><span class="nt">&gt;&lt;fmt:formatDate</span> <span class="na">value=</span><span class="s">&quot;${account.birthday}&quot;</span> <span class="na">pattern=</span><span class="s">&quot;yyyy-MM-dd&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;zip&quot;</span><span class="nt">&gt;</span>zip<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;zip&quot;</span><span class="nt">&gt;</span>${f:h(account.zip)}<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;address&quot;</span><span class="nt">&gt;</span>address<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;address&quot;</span><span class="nt">&gt;</span>${f:h(account.address)}<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;cardNumber&quot;</span><span class="nt">&gt;</span>your card number<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;cardNumber&quot;</span><span class="nt">&gt;</span>****-****-****-${f:h(account.lastFourOfCardNumber)}<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;cardExpirationDate&quot;</span><span class="nt">&gt;</span>expiration date of your card<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;cardExpirationDate&quot;</span><span class="nt">&gt;&lt;fmt:formatDate</span> <span class="na">value=</span><span class="s">&quot;${account.cardExpirationDate}&quot;</span> <span class="na">pattern=</span><span class="s">&quot;yyyy-MM&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;cardSecurityCode&quot;</span><span class="nt">&gt;</span>security code of your card<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;cardSecurityCode&quot;</span><span class="nt">&gt;</span>${f:h(account.cardSecurityCode)}<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;/table&gt;</span>

    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;get&quot;</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/account/update&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;home&quot;</span> <span class="na">id=</span><span class="s">&quot;home&quot;</span> <span class="na">value=</span><span class="s">&quot;home&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id31">
<h4><a class="toc-backref" href="#id84">11.3.5.1.4. 動作確認</a><a class="headerlink" href="#id31" title="Permalink to this headline">¶</a></h4>
<p>ここまでの実装でアカウント情報更新を行うことができるようになっている。
商品一覧表示画面の上部にある「Account Update」のボタンを押下することでアカウント情報更新画面に遷移する。
現在、ログインしているアカウントの情報が初期値としてフォームに表示される。
フォームの値を変更して次の画面に進んでいくことで、最終的にアカウントの情報が更新される。</p>
<p>ここまでの実装で入力値を受け取るフォームをセッションに格納しているため、
データの持ち回りが簡単に実現できる。
また、「home」ボタンを押した際にセッションが破棄されるため、
「home」ボタンを押した後にアカウント情報更新画面に遷移すると、変更情報がリセットされる。</p>
</div>
</div>
<div class="section" id="id32">
<h3><a class="toc-backref" href="#id85">11.3.5.2. カートアイテム登録機能を作成する</a><a class="headerlink" href="#id32" title="Permalink to this headline">¶</a></h3>
<p>指定した数量で商品をカートに登録する機能を作成する。</p>
<p><a class="reference internal" href="#development-policy"><span class="std std-ref">アプリケーションの設計</span></a> で説明したとおり、カート情報はセッションスコープのBeanとして管理する。</p>
<p>以下にカートアイテム登録機能で実装する画面の情報を示す。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="30%" />
<col width="15%" />
<col width="25%" />
<col width="30%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">処理名</th>
<th class="head">HTTPメソッド</th>
<th class="head">パス</th>
<th class="head">画面</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">商品をカートへ追加処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">POST</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/addToCart</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">商品一覧画面表示処理へリダイレクト</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="section" id="bean">
<h4><a class="toc-backref" href="#id86">11.3.5.2.1. セッションスコープBeanを定義</a><a class="headerlink" href="#bean" title="Permalink to this headline">¶</a></h4>
<p>カート情報を保持するオブジェクトは、 <code class="docutils literal"><span class="pre">Cart.java</span></code> としてすでに作成済みである。
そのため、このオブジェクトをセッションスコープのBeanとして扱えるように設定を加える。</p>
<p>セッションスコープのBeanを使用する方法として、 <a class="reference internal" href="../ArchitectureInDetail/WebApplicationDetail/SessionManagement.html"><span class="doc">セッション管理</span></a> に2種類の設定方法が記載されている。
本チュートリアルでは、component-scanを使用してbeanを定義する。</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">セッションスコープのBeanとして登録するためには対象のオブジェクトが <cite>Serializable</cite> である必要がある</p>
</div>
<p>component-scanを用いてセッションスコープのBeanを定義するには、
Beanとして登録したいクラスに以下のアノテーションを追加すればよい。</p>
<p><code class="docutils literal"><span class="pre">/session-tutorial-init-domain/src/main/java/com/example/session/domain/model/Cart.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.session.domain.model</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.security.MessageDigest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.security.NoSuchAlgorithmException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Base64</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.LinkedHashMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Scope</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.ScopedProxyMode</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.SerializationUtils</span><span class="p">;</span>

<span class="hll"><span class="nd">@Component</span> <span class="c1">// (1)</span>
</span><span class="hll"><span class="nd">@Scope</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;session&quot;</span><span class="p">,</span> <span class="n">proxyMode</span> <span class="o">=</span> <span class="n">ScopedProxyMode</span><span class="p">.</span><span class="na">TARGET_CLASS</span><span class="p">)</span> <span class="c1">// (2)</span>
</span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Cart</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">component-scanの対象となるように<code class="docutils literal"><span class="pre">&#64;Component</span></code>アノテーションを指定する</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Beanのスコープを<code class="docutils literal"><span class="pre">session</span></code>にする。また、 <code class="docutils literal"><span class="pre">proxyMode</span></code> 属性で<code class="docutils literal"><span class="pre">ScopedProxyMode.TARGET_CLASS</span></code>を指定し、scoped-proxyを有効にする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>また、component-scanの対象となるbase-packageをBean定義ファイルに指定する必要がある。
しかし、本チュートリアルでは作成済みのBean定義ファイルにすでに以下の記述があるため、新たに記述を追加する必要はない。</p>
<p><code class="docutils literal"><span class="pre">/session-tutorial-init-domain/src/main/resources/META-INF/spring/session-tutorial-init-domain.xml</span></code></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">&quot;com.example.session.domain&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">component-scanの対象となるパッケージを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id33">
<h4><a class="toc-backref" href="#id87">11.3.5.2.2. フォームオブジェクトの作成</a><a class="headerlink" href="#id33" title="Permalink to this headline">¶</a></h4>
<p>注文する商品の情報を保持するクラスを作成する。</p>
<p><code class="docutils literal"><span class="pre">/session-tutorial-init-web/src/main/java/com/example/session/app/goods/GoodAddForm.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.session.app.goods</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.constraints.Min</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GoodAddForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="cm">/**</span>
<span class="cm">     *</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">goodsId</span><span class="p">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Min</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">quantity</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getGoodsId</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">goodsId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setGoodsId</span><span class="p">(</span><span class="n">String</span> <span class="n">goodsId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">goodsId</span> <span class="o">=</span> <span class="n">goodsId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getQuantity</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">quantity</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setQuantity</span><span class="p">(</span><span class="kt">int</span> <span class="n">quantity</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">quantity</span> <span class="o">=</span> <span class="n">quantity</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id34">
<h4><a class="toc-backref" href="#id88">11.3.5.2.3. Controllerの作成</a><a class="headerlink" href="#id34" title="Permalink to this headline">¶</a></h4>
<p>Controllerを作成する。</p>
<p>一部リクエストを処理するためにすでに作成されているため、以下のコードを追加する。</p>
<p><code class="docutils literal"><span class="pre">/session-tutorial-init-web/src/main/java/com/example/session/app/goods/GoodsController.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.session.app.goods</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.domain.Page</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.domain.Pageable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.ui.Model</span><span class="p">;</span>
<span class="hll"><span class="kn">import</span> <span class="nn">org.springframework.validation.BindingResult</span><span class="p">;</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="p">;</span>
</span><span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ModelAttribute</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PathVariable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PostMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span>
<span class="hll"><span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.support.RedirectAttributes</span><span class="p">;</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessages</span><span class="p">;</span>
</span>
<span class="hll"><span class="kn">import</span> <span class="nn">com.example.session.domain.model.Cart</span><span class="p">;</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">com.example.session.domain.model.CartItem</span><span class="p">;</span>
</span><span class="kn">import</span> <span class="nn">com.example.session.domain.model.Goods</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.session.domain.service.goods.GoodsService</span><span class="p">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;goods&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GoodsController</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">GoodsService</span> <span class="n">goodsService</span><span class="p">;</span>

<span class="hll">    <span class="c1">// (1)</span>
</span><span class="hll">    <span class="nd">@Inject</span>
</span><span class="hll">    <span class="n">Cart</span> <span class="n">cart</span><span class="p">;</span>
</span>
    <span class="nd">@ModelAttribute</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;goodViewForm&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">GoodViewForm</span> <span class="nf">setUpCategoryId</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">GoodViewForm</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nd">@GetMapping</span>
    <span class="n">String</span> <span class="nf">showGoods</span><span class="p">(</span><span class="n">GoodViewForm</span> <span class="n">form</span><span class="p">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="p">,</span> <span class="n">Model</span> <span class="n">model</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">Page</span><span class="o">&lt;</span><span class="n">Goods</span><span class="o">&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">goodsService</span><span class="p">.</span><span class="na">findByCategoryId</span><span class="p">(</span><span class="n">form</span><span class="p">.</span><span class="na">getCategoryId</span><span class="p">(),</span>
                <span class="n">pageable</span><span class="p">);</span>
        <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&quot;page&quot;</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
        <span class="k">return</span> <span class="s">&quot;goods/showGoods&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/{goodsId}&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">showGoodsDetail</span><span class="p">(</span><span class="nd">@PathVariable</span> <span class="n">String</span> <span class="n">goodsId</span><span class="p">,</span> <span class="n">Model</span> <span class="n">model</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">Goods</span> <span class="n">goods</span> <span class="o">=</span> <span class="n">goodsService</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">goodsId</span><span class="p">);</span>
        <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="n">goods</span><span class="p">);</span>

        <span class="k">return</span> <span class="s">&quot;goods/showGoodsDetail&quot;</span><span class="p">;</span>
    <span class="p">}</span>

<span class="hll">    <span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/addToCart&quot;</span><span class="p">)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">addToCart</span><span class="p">(</span><span class="nd">@Validated</span> <span class="n">GoodAddForm</span> <span class="n">form</span><span class="p">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="p">,</span>
</span><span class="hll">            <span class="n">RedirectAttributes</span> <span class="n">attributes</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">
</span><span class="hll">        <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">hasErrors</span><span class="p">())</span> <span class="p">{</span>
</span><span class="hll">            <span class="n">ResultMessages</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="p">.</span><span class="na">error</span><span class="p">()</span>
</span><span class="hll">                    <span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;e.st.go.5001&quot;</span><span class="p">);</span>
</span><span class="hll">            <span class="n">attributes</span><span class="p">.</span><span class="na">addFlashAttribute</span><span class="p">(</span><span class="n">messages</span><span class="p">);</span>
</span><span class="hll">            <span class="k">return</span> <span class="s">&quot;redirect:/goods&quot;</span><span class="p">;</span>
</span><span class="hll">        <span class="p">}</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">Goods</span> <span class="n">goods</span> <span class="o">=</span> <span class="n">goodsService</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">form</span><span class="p">.</span><span class="na">getGoodsId</span><span class="p">());</span>
</span><span class="hll">        <span class="n">CartItem</span> <span class="n">cartItem</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CartItem</span><span class="p">();</span>
</span><span class="hll">        <span class="n">cartItem</span><span class="p">.</span><span class="na">setGoods</span><span class="p">(</span><span class="n">goods</span><span class="p">);</span>
</span><span class="hll">        <span class="n">cartItem</span><span class="p">.</span><span class="na">setQuantity</span><span class="p">(</span><span class="n">form</span><span class="p">.</span><span class="na">getQuantity</span><span class="p">());</span>
</span><span class="hll">        <span class="n">cart</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">cartItem</span><span class="p">);</span> <span class="c1">// (2)</span>
</span><span class="hll">
</span><span class="hll">        <span class="k">return</span> <span class="s">&quot;redirect:/goods&quot;</span><span class="p">;</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">セッションスコープのBeanをDIコンテナから取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">セッションスコープのBeanにデータを追加する。</div>
<div class="line">画面に情報を表示させるために、オブジェクトをModelに追加する必要はない。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id35">
<h4><a class="toc-backref" href="#id89">11.3.5.2.4. JSPの作成</a><a class="headerlink" href="#id35" title="Permalink to this headline">¶</a></h4>
<p>カートの中身を表示するためのJSPを作成する。</p>
<p>JSPもすでに作成されているため、以下に示すコードをbodyタグの最後に追加する。</p>
<p><code class="docutils literal"><span class="pre">/session-tutorial-init-web/src/main/webapp/WEB-INF/views/goods/showGoods.jsp</span></code></p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:authentication</span> <span class="na">property=</span><span class="s">&quot;principal&quot;</span> <span class="na">var=</span><span class="s">&quot;userDetails&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">&quot;display: inline-flex&quot;</span><span class="nt">&gt;</span>
    welcome<span class="ni">&amp;nbsp;&amp;nbsp;</span> <span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">&quot;userName&quot;</span><span class="nt">&gt;</span>${f:h(userDetails.account.name)}<span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/logout&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">id=</span><span class="s">&quot;logout&quot;</span> <span class="na">value=</span><span class="s">&quot;logout&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;sec:csrfInput</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;get&quot;</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/account/update&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;form1&quot;</span> <span class="na">id=</span><span class="s">&quot;updateAccount&quot;</span> <span class="na">value=</span><span class="s">&quot;Account Update&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;br&gt;</span>
<span class="nt">&lt;br&gt;</span>

<span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;p&gt;</span>select a category<span class="nt">&lt;/p&gt;</span>

    <span class="nt">&lt;form:form</span> <span class="na">method=</span><span class="s">&quot;get&quot;</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/goods/&quot;</span> <span class="na">modelAttribute=</span><span class="s">&quot;goodViewForm&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;form:select</span> <span class="na">path=</span><span class="s">&quot;categoryId&quot;</span> <span class="na">items=</span><span class="s">&quot;${CL_CATEGORIES}&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">id=</span><span class="s">&quot;update&quot;</span> <span class="na">value=</span><span class="s">&quot;update&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form:form&gt;</span>
    <span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;t:messagesPanel</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;table&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;th&gt;</span>Name<span class="nt">&lt;/th&gt;</span>
            <span class="nt">&lt;th&gt;</span>Price<span class="nt">&lt;/th&gt;</span>
<span class="hll">            <span class="nt">&lt;th&gt;</span>Quantity<span class="nt">&lt;/th&gt;</span>
</span>        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;c:forEach</span> <span class="na">items=</span><span class="s">&quot;${page.content}&quot;</span> <span class="na">var=</span><span class="s">&quot;goods&quot;</span> <span class="na">varStatus=</span><span class="s">&quot;status&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td&gt;&lt;a</span> <span class="na">id=</span><span class="s">&quot;${f:h(goods.name)}&quot;</span> <span class="na">href=</span><span class="s">&quot;${pageContext.request.contextPath}/goods/${f:h(goods.id)}&quot;</span><span class="nt">&gt;</span>${f:h(goods.name)}<span class="nt">&lt;/a&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;td&gt;&lt;fmt:formatNumber</span> <span class="na">value=</span><span class="s">&quot;${f:h(goods.price)}&quot;</span> <span class="na">type=</span><span class="s">&quot;CURRENCY&quot;</span> <span class="na">currencySymbol=</span><span class="s">&quot;&amp;yen;&quot;</span> <span class="na">maxFractionDigits=</span><span class="s">&quot;0&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
<span class="hll">                <span class="nt">&lt;td&gt;&lt;form:form</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span>
</span><span class="hll">                        <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/goods/addToCart&quot;</span>
</span><span class="hll">                        <span class="na">modelAttribute=</span><span class="s">&quot;goodAddForm&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">                        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;quantity&quot;</span> <span class="na">id=</span><span class="s">&quot;quantity${status.index}&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">                        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name=</span><span class="s">&quot;goodsId&quot;</span> <span class="na">value=</span><span class="s">&quot;${f:h(goods.id)}&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">                        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">id=</span><span class="s">&quot;add${status.index}&quot;</span> <span class="na">value=</span><span class="s">&quot;add&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">                    <span class="nt">&lt;/form:form&gt;</span>
</span><span class="hll">                <span class="nt">&lt;/td&gt;</span>
</span>            <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;/c:forEach&gt;</span>
    <span class="nt">&lt;/table&gt;</span>
    <span class="nt">&lt;t:pagination</span> <span class="na">page=</span><span class="s">&quot;${page}&quot;</span> <span class="na">outerElementClass=</span><span class="s">&quot;pagination&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;p&gt;</span>
        <span class="nt">&lt;fmt:formatNumber</span> <span class="na">value=</span><span class="s">&quot;${page.totalElements}&quot;</span> <span class="nt">/&gt;</span> results <span class="nt">&lt;br&gt;</span>
        ${f:h(page.number + 1) } / ${f:h(page.totalPages)} Pages
    <span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="hll"><span class="nt">&lt;div&gt;</span>
</span><span class="hll">    <span class="k">&lt;%-</span><span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">--</span><span class="k">%&gt;</span>
</span><span class="hll">    <span class="nt">&lt;spring:eval</span> <span class="na">var=</span><span class="s">&quot;cart&quot;</span> <span class="na">expression=</span><span class="s">&quot;@cart&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;get&quot;</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/cart&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">id=</span><span class="s">&quot;viewCart&quot;</span> <span class="na">value=</span><span class="s">&quot;view cart&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/form&gt;</span>
</span><span class="hll">    <span class="nt">&lt;table&gt;</span>
</span><span class="hll">        <span class="k">&lt;%-</span><span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">--</span><span class="k">%&gt;</span>
</span><span class="hll">        <span class="nt">&lt;c:forEach</span> <span class="na">items=</span><span class="s">&quot;${cart.cartItems}&quot;</span> <span class="na">var=</span><span class="s">&quot;cartItem&quot;</span> <span class="na">varStatus=</span><span class="s">&quot;status&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">            <span class="nt">&lt;tr&gt;</span>
</span><span class="hll">                <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;itemName${status.index}&quot;</span><span class="nt">&gt;</span>${f:h(cartItem.goods.name)}<span class="nt">&lt;/td&gt;</span>
</span><span class="hll">                <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;itemPrice${status.index}&quot;</span><span class="nt">&gt;&lt;fmt:formatNumber</span> <span class="na">value=</span><span class="s">&quot;${cartItem.goods.price}&quot;</span> <span class="na">type=</span><span class="s">&quot;CURRENCY&quot;</span> <span class="na">currencySymbol=</span><span class="s">&quot;&amp;yen;&quot;</span> <span class="na">maxFractionDigits=</span><span class="s">&quot;0&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class="hll">                <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;itemQuantity${status.index}&quot;</span><span class="nt">&gt;</span>${f:h(cartItem.quantity)}<span class="nt">&lt;/td&gt;</span>
</span><span class="hll">            <span class="nt">&lt;/tr&gt;</span>
</span><span class="hll">        <span class="nt">&lt;/c:forEach&gt;</span>
</span><span class="hll">        <span class="nt">&lt;tr&gt;</span>
</span><span class="hll">            <span class="nt">&lt;td&gt;</span>Total<span class="nt">&lt;/td&gt;</span>
</span><span class="hll">            <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;totalPrice&quot;</span><span class="nt">&gt;&lt;fmt:formatNumber</span> <span class="na">value=</span><span class="s">&quot;${f:h(cart.totalAmount)}&quot;</span> <span class="na">type=</span><span class="s">&quot;CURRENCY&quot;</span> <span class="na">currencySymbol=</span><span class="s">&quot;&amp;yen;&quot;</span> <span class="na">maxFractionDigits=</span><span class="s">&quot;0&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class="hll">            <span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class="hll">        <span class="nt">&lt;/tr&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/table&gt;</span>
</span><span class="hll"><span class="nt">&lt;/div&gt;</span>
</span></pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">セッションスコープのBeanの中身を画面に表示させるために、Beanを変数に格納する。</div>
<div class="line">上記例では、セッションスコープにあるCartオブジェクトを変数cartに格納している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(1)で作成した変数を通して、セッションスコープのBeanの中身を参照する。</div>
<div class="line">上記例では、変数cartを通してセッションスコープのBeanの中身を参照している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">変数に格納せず単にBeanの中身を表示させるだけであればvar属性は不要である。
上記例では、 <code class="docutils literal"><span class="pre">&lt;spring:eval</span> <span class="pre">expression=&quot;&#64;cart&quot;</span> <span class="pre">/&gt;</span></code> で表示できる。</p>
</div>
<p><code class="docutils literal"><span class="pre">/session-tutorial-init-web/src/main/webapp/WEB-INF/views/goods/showGoodsDetail.jsp</span></code></p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:authentication</span> <span class="na">property=</span><span class="s">&quot;principal&quot;</span> <span class="na">var=</span><span class="s">&quot;userDetails&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">&quot;display: inline-flex&quot;</span><span class="nt">&gt;</span>
    welcome<span class="ni">&amp;nbsp;&amp;nbsp;</span> <span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">&quot;userName&quot;</span><span class="nt">&gt;</span>${f:h(userDetails.account.name)}<span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;form:form</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/logout&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">id=</span><span class="s">&quot;logout&quot;</span> <span class="na">value=</span><span class="s">&quot;logout&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form:form&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;get&quot;</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/account/update&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;form1&quot;</span> <span class="na">id=</span><span class="s">&quot;updateAccount&quot;</span> <span class="na">value=</span><span class="s">&quot;Account Update&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;br&gt;</span>
<span class="nt">&lt;br&gt;</span>

<span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;table&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;th&gt;</span>Name<span class="nt">&lt;/th&gt;</span>
            <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>${f:h(goods.name)}<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;th&gt;</span>Price<span class="nt">&lt;/th&gt;</span>
            <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;price&quot;</span><span class="nt">&gt;&lt;fmt:formatNumber</span> <span class="na">value=</span><span class="s">&quot;${f:h(goods.price)}&quot;</span> <span class="na">type=</span><span class="s">&quot;CURRENCY&quot;</span> <span class="na">currencySymbol=</span><span class="s">&quot;&amp;yen;&quot;</span> <span class="na">maxFractionDigits=</span><span class="s">&quot;0&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;th&gt;</span>Description<span class="nt">&lt;/th&gt;</span>
            <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;description&quot;</span><span class="nt">&gt;</span>${f:h(goods.description)}<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;/table&gt;</span>
<span class="hll">    <span class="nt">&lt;form:form</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span>
</span><span class="hll">        <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/goods/addToCart&quot;</span>
</span><span class="hll">        <span class="na">modelAttribute=</span><span class="s">&quot;AddToCartForm&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">        Quantity<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">id=</span><span class="s">&quot;quantity&quot;</span> <span class="na">name=</span><span class="s">&quot;quantity&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name=</span><span class="s">&quot;goodsId&quot;</span> <span class="na">value=</span><span class="s">&quot;${f:h(goods.id)}&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">id=</span><span class="s">&quot;add&quot;</span> <span class="na">value=</span><span class="s">&quot;add&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/form:form&gt;</span>
</span>
    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;get&quot;</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/goods&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">id=</span><span class="s">&quot;home&quot;</span> <span class="na">value=</span><span class="s">&quot;home&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="hll"><span class="nt">&lt;div&gt;</span>
</span><span class="hll">    <span class="nt">&lt;spring:eval</span> <span class="na">var=</span><span class="s">&quot;cart&quot;</span> <span class="na">expression=</span><span class="s">&quot;@cart&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;get&quot;</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/cart&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;view cart&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/form&gt;</span>
</span><span class="hll">    <span class="nt">&lt;table&gt;</span>
</span><span class="hll">        <span class="nt">&lt;c:forEach</span> <span class="na">items=</span><span class="s">&quot;${cart.cartItems}&quot;</span> <span class="na">var=</span><span class="s">&quot;cartItem&quot;</span> <span class="na">varStatus=</span><span class="s">&quot;status&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">            <span class="nt">&lt;tr&gt;</span>
</span><span class="hll">                <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;itemName${status.index}&quot;</span><span class="nt">&gt;</span>${f:h(cartItem.goods.name)}<span class="nt">&lt;/td&gt;</span>
</span><span class="hll">                <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;itemPrice${status.index}&quot;</span><span class="nt">&gt;&lt;fmt:formatNumber</span> <span class="na">value=</span><span class="s">&quot;${cartItem.goods.price}&quot;</span> <span class="na">type=</span><span class="s">&quot;CURRENCY&quot;</span> <span class="na">currencySymbol=</span><span class="s">&quot;&amp;yen;&quot;</span> <span class="na">maxFractionDigits=</span><span class="s">&quot;0&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class="hll">                <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;itemQuantity${status.index}&quot;</span><span class="nt">&gt;</span>${f:h(cartItem.quantity)}<span class="nt">&lt;/td&gt;</span>
</span><span class="hll">            <span class="nt">&lt;/tr&gt;</span>
</span><span class="hll">        <span class="nt">&lt;/c:forEach&gt;</span>
</span><span class="hll">        <span class="nt">&lt;tr&gt;</span>
</span><span class="hll">            <span class="nt">&lt;td&gt;</span>Total<span class="nt">&lt;/td&gt;</span>
</span><span class="hll">            <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;totalPrice&quot;</span><span class="nt">&gt;&lt;fmt:formatNumber</span> <span class="na">value=</span><span class="s">&quot;${f:h(cart.totalAmount)}&quot;</span> <span class="na">type=</span><span class="s">&quot;CURRENCY&quot;</span> <span class="na">currencySymbol=</span><span class="s">&quot;&amp;yen;&quot;</span> <span class="na">maxFractionDigits=</span><span class="s">&quot;0&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class="hll">            <span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class="hll">        <span class="nt">&lt;/tr&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/table&gt;</span>
</span><span class="hll"><span class="nt">&lt;/div&gt;</span>
</span></pre></div>
</div>
</div>
<div class="section" id="id36">
<h4><a class="toc-backref" href="#id90">11.3.5.2.5. 動作確認</a><a class="headerlink" href="#id36" title="Permalink to this headline">¶</a></h4>
<p>ここまでの実装でカートに商品を登録することができるようになっている。
商品一覧表示画面で、ある商品の「add」のボタンを押下することで、同ページカートの中身が表示されるようになる。</p>
<p>ここまでの実装でカートオブジェクトをセッションに格納しているため、
アカウント情報更新画面に遷移して戻ってきてもカートの情報は保存されている。</p>
</div>
</div>
<div class="section" id="id37">
<h3><a class="toc-backref" href="#id91">11.3.5.3. 商品検索情報を保持する仕組みを作成する</a><a class="headerlink" href="#id37" title="Permalink to this headline">¶</a></h3>
<p>ここまでの実装で商品をカートに追加することはできるようになった。
しかし、商品追加後に遷移する画面は、常に「book」カテゴリの1ページ目となっている。</p>
<p>本チュートリアルでは、選択カテゴリやページ番号といった商品検索情報は注文が完了するまで保持する仕様となっている。
そのため、商品追加後やアカウント更新画面から戻ってきたときに前の状態に遷移するように実装を修正する。</p>
<p><a class="reference internal" href="#development-policy"><span class="std std-ref">アプリケーションの設計</span></a> で説明したとおり、商品検索情報はセッションスコープのBeanとして管理する。</p>
<p>以下に修正する画面の情報を示す。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="30%" />
<col width="15%" />
<col width="25%" />
<col width="30%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">処理名</th>
<th class="head">HTTPメソッド</th>
<th class="head">パス</th>
<th class="head">画面</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">商品一覧画面表示処理(デフォルト)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/goods <strong>(作成済み)</strong></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/goods/showGoods</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">商品一覧画面表示処理(カテゴリ選択時)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/goods?categoryId <strong>(作成済み)</strong></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/goods/showGoods</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">商品一覧画面表示処理(ページ選択時)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/goods?page <strong>(作成済み)</strong></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/goods/showGoods</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="section" id="id38">
<h4><a class="toc-backref" href="#id92">11.3.5.3.1. セッションスコープBeanを作成</a><a class="headerlink" href="#id38" title="Permalink to this headline">¶</a></h4>
<p>商品検索情報を保持するセッションスコープBeanを作成する。
カート情報と同様にcomponent-scanを使用してbeanを定義する。</p>
<p><code class="docutils literal"><span class="pre">/session-tutorial-init-web/src/main/java/com/example/session/app/goods/GoodsSearchCriteria.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.session.app.goods</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Scope</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.ScopedProxyMode</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="p">;</span>

<span class="nd">@Component</span> <span class="c1">// (1)</span>
<span class="nd">@Scope</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;session&quot;</span><span class="p">,</span> <span class="n">proxyMode</span> <span class="o">=</span> <span class="n">ScopedProxyMode</span><span class="p">.</span><span class="na">TARGET_CLASS</span><span class="p">)</span> <span class="c1">// (2)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GoodsSearchCriteria</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="cm">/**</span>
<span class="cm">     *</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">categoryId</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getCategoryId</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">categoryId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCategoryId</span><span class="p">(</span><span class="kt">int</span> <span class="n">categoryId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">categoryId</span> <span class="o">=</span> <span class="n">categoryId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getPage</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">page</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPage</span><span class="p">(</span><span class="kt">int</span> <span class="n">page</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">clear</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">categoryId</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">component-scanの対象となるように<code class="docutils literal"><span class="pre">&#64;Component</span></code>アノテーションを指定する</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Beanのスコープを<code class="docutils literal"><span class="pre">session</span></code>にする。また、proxyMode 属性で<code class="docutils literal"><span class="pre">ScopedProxyMode.TARGET_CLASS</span></code>を指定し、scoped-proxyを有効にする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>また、component-scanの対象となるbase-packageをBean定義ファイルに指定する必要がある。 しかし、本チュートリアルでは作成済みのBean定義ファイルにすでに以下の記述があるため、新たに記述を追加する必要はない。</p>
<p><code class="docutils literal"><span class="pre">/session-tutorial-init-web/src/main/resources/META-INF/spring/spring-mvc.xml</span></code></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">&quot;com.example.session.app&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">component-scanの対象となるパッケージを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id39">
<h4><a class="toc-backref" href="#id93">11.3.5.3.2. Controllerの修正</a><a class="headerlink" href="#id39" title="Permalink to this headline">¶</a></h4>
<p>商品検索情報をセッションで保持する、また、セッションで保持されている商品検索情報を利用するようにControllerを修正する。</p>
<p><code class="docutils literal"><span class="pre">/session-tutorial-init-web/src/main/java/com/example/session/app/goods/GoodsController.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.session.app.goods</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.domain.Page</span><span class="p">;</span>
<span class="hll"><span class="kn">import</span> <span class="nn">org.springframework.data.domain.PageRequest</span><span class="p">;</span>
</span><span class="kn">import</span> <span class="nn">org.springframework.data.domain.Pageable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.ui.Model</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.BindingResult</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ModelAttribute</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PathVariable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PostMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.support.RedirectAttributes</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessages</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.example.session.domain.model.Cart</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.session.domain.model.CartItem</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.session.domain.model.Goods</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.session.domain.service.goods.GoodsService</span><span class="p">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;goods&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GoodsController</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">GoodsService</span> <span class="n">goodsService</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">Cart</span> <span class="n">cart</span><span class="p">;</span>

<span class="hll">    <span class="c1">// (1)</span>
</span><span class="hll">    <span class="nd">@Inject</span>
</span><span class="hll">    <span class="n">GoodsSearchCriteria</span> <span class="n">criteria</span><span class="p">;</span>
</span>
    <span class="nd">@ModelAttribute</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;goodViewForm&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">GoodViewForm</span> <span class="nf">setUpCategoryId</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">GoodViewForm</span><span class="p">();</span>
    <span class="p">}</span>

<span class="hll">    <span class="c1">// (2)</span>
</span><span class="hll">    <span class="nd">@GetMapping</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">showGoods</span><span class="p">(</span><span class="n">GoodViewForm</span> <span class="n">form</span><span class="p">,</span> <span class="n">Model</span> <span class="n">model</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">        <span class="n">Pageable</span> <span class="n">pageable</span> <span class="o">=</span> <span class="n">PageRequest</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">criteria</span><span class="p">.</span><span class="na">getPage</span><span class="p">(),</span> <span class="mi">3</span><span class="p">);</span>
</span><span class="hll">        <span class="n">form</span><span class="p">.</span><span class="na">setCategoryId</span><span class="p">(</span><span class="n">criteria</span><span class="p">.</span><span class="na">getCategoryId</span><span class="p">());</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">showGoods</span><span class="p">(</span><span class="n">pageable</span><span class="p">,</span> <span class="n">model</span><span class="p">);</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1">// (3)</span>
</span><span class="hll">    <span class="nd">@GetMapping</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="s">&quot;categoryId&quot;</span><span class="p">)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">changeCategoryId</span><span class="p">(</span><span class="n">GoodViewForm</span> <span class="n">form</span><span class="p">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="p">,</span> <span class="n">Model</span> <span class="n">model</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">        <span class="n">criteria</span><span class="p">.</span><span class="na">setPage</span><span class="p">(</span><span class="n">pageable</span><span class="p">.</span><span class="na">getPageNumber</span><span class="p">());</span>
</span><span class="hll">        <span class="n">criteria</span><span class="p">.</span><span class="na">setCategoryId</span><span class="p">(</span><span class="n">form</span><span class="p">.</span><span class="na">getCategoryId</span><span class="p">());</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">showGoods</span><span class="p">(</span><span class="n">pageable</span><span class="p">,</span> <span class="n">model</span><span class="p">);</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1">// (4)</span>
</span><span class="hll">    <span class="nd">@GetMapping</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="s">&quot;page&quot;</span><span class="p">)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">changePage</span><span class="p">(</span><span class="n">GoodViewForm</span> <span class="n">form</span><span class="p">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="p">,</span> <span class="n">Model</span> <span class="n">model</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">        <span class="n">criteria</span><span class="p">.</span><span class="na">setPage</span><span class="p">(</span><span class="n">pageable</span><span class="p">.</span><span class="na">getPageNumber</span><span class="p">());</span>
</span><span class="hll">        <span class="n">form</span><span class="p">.</span><span class="na">setCategoryId</span><span class="p">(</span><span class="n">criteria</span><span class="p">.</span><span class="na">getCategoryId</span><span class="p">());</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">showGoods</span><span class="p">(</span><span class="n">pageable</span><span class="p">,</span> <span class="n">model</span><span class="p">);</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1">// (5)</span>
</span><span class="hll">    <span class="n">String</span> <span class="nf">showGoods</span><span class="p">(</span><span class="n">Pageable</span> <span class="n">pageable</span><span class="p">,</span> <span class="n">Model</span> <span class="n">model</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">        <span class="n">Page</span><span class="o">&lt;</span><span class="n">Goods</span><span class="o">&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">goodsService</span><span class="p">.</span><span class="na">findByCategoryId</span><span class="p">(</span>
</span><span class="hll">                <span class="n">criteria</span><span class="p">.</span><span class="na">getCategoryId</span><span class="p">(),</span> <span class="n">pageable</span><span class="p">);</span>
</span><span class="hll">        <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&quot;page&quot;</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
</span><span class="hll">        <span class="k">return</span> <span class="s">&quot;goods/showGoods&quot;</span><span class="p">;</span>
</span><span class="hll">    <span class="p">}</span>
</span>
    <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/{goodsId}&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">showGoodsDetail</span><span class="p">(</span><span class="nd">@PathVariable</span> <span class="n">String</span> <span class="n">goodsId</span><span class="p">,</span> <span class="n">Model</span> <span class="n">model</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">Goods</span> <span class="n">goods</span> <span class="o">=</span> <span class="n">goodsService</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">goodsId</span><span class="p">);</span>
        <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="n">goods</span><span class="p">);</span>

        <span class="k">return</span> <span class="s">&quot;/goods/showGoodsDetail&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/addToCart&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">addToCart</span><span class="p">(</span><span class="nd">@Validated</span> <span class="n">GoodAddForm</span> <span class="n">form</span><span class="p">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="p">,</span>
            <span class="n">RedirectAttributes</span> <span class="n">attributes</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">hasErrors</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">ResultMessages</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="p">.</span><span class="na">error</span><span class="p">()</span>
                    <span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;e.st.go.5001&quot;</span><span class="p">);</span>
            <span class="n">attributes</span><span class="p">.</span><span class="na">addFlashAttribute</span><span class="p">(</span><span class="n">messages</span><span class="p">);</span>
            <span class="k">return</span> <span class="s">&quot;redirect:/goods&quot;</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">Goods</span> <span class="n">goods</span> <span class="o">=</span> <span class="n">goodsService</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">form</span><span class="p">.</span><span class="na">getGoodsId</span><span class="p">());</span>
        <span class="n">CartItem</span> <span class="n">cartItem</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CartItem</span><span class="p">();</span>
        <span class="n">cartItem</span><span class="p">.</span><span class="na">setGoods</span><span class="p">(</span><span class="n">goods</span><span class="p">);</span>
        <span class="n">cartItem</span><span class="p">.</span><span class="na">setQuantity</span><span class="p">(</span><span class="n">form</span><span class="p">.</span><span class="na">getQuantity</span><span class="p">());</span>
        <span class="n">cart</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">cartItem</span><span class="p">);</span>

        <span class="k">return</span> <span class="s">&quot;redirect:/goods&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">セッションスコープのBeanをDIコンテナから取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">通常の商品一覧画面表示処理の前処理を行う。セッションに格納されている商品カテゴリをフォームに、ページ番号を<code class="docutils literal"><span class="pre">pageable</span></code>に設定する。商品カテゴリをフォームに設定するのは、セレクトボックスで表示される商品カテゴリを指定するためである。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">カテゴリが変更された時の商品一覧画面表示処理の前処理を行う。入力された商品カテゴリをセッションに格納する。ページ番号はデフォルトの1ページ目を<code class="docutils literal"><span class="pre">pageable</span></code>に指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ページが変更された時の商品一覧画面表示処理の前処理を行う。入力されたページ番号をセッションに格納する。セッションに格納されている商品カテゴリをフォームに設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">共通部分を扱う。セッションで管理されている商品カテゴリ、前処理で取得した<code class="docutils literal"><span class="pre">pageable</span></code>をもとに商品を検索する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id40">
<h4><a class="toc-backref" href="#id94">11.3.5.3.3. 動作確認</a><a class="headerlink" href="#id40" title="Permalink to this headline">¶</a></h4>
<p>ここまでの実装で、商品検索情報を保持することができるようになっている。
例えば、「music」カテゴリの2ページ目で商品をカートに追加した際の遷移先がもとの「music」カテゴリの2ページ目のままとなる。
また、同画面から「Account Update」ボタンを押してアカウント更新画面に遷移し、アカウント更新画面の「home」ボタンを押して戻ってきた際の遷移先がもとの「music」カテゴリの2ページ目のままとなる。</p>
</div>
</div>
<div class="section" id="id41">
<h3><a class="toc-backref" href="#id95">11.3.5.4. カートアイテム削除機能を作成する</a><a class="headerlink" href="#id41" title="Permalink to this headline">¶</a></h3>
<p>指定した商品をカートから削除する機能を作成する。</p>
<p>削除する商品を指定するために、チェックボックスを利用する。</p>
<p>以下にカートアイテム削除機能で実装する画面の情報を示す。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="30%" />
<col width="15%" />
<col width="25%" />
<col width="30%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">処理名</th>
<th class="head">HTTPメソッド</th>
<th class="head">パス</th>
<th class="head">画面</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">カート画面表示処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/cart</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">cart/viewCart</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">商品をカートから削除処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">POST</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/cart</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">カート画面表示処理へリダイレクト</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="section" id="id42">
<h4><a class="toc-backref" href="#id96">11.3.5.4.1. フォームオブジェクトの作成</a><a class="headerlink" href="#id42" title="Permalink to this headline">¶</a></h4>
<p>削除対象となる商品のIDを保持するクラスを作成する。</p>
<p><code class="docutils literal"><span class="pre">/session-tutorial-init-web/src/main/java/com/example/session/app/cart/CartForm.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.session.app.cart</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotEmpty</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CartForm</span> <span class="p">{</span>

    <span class="nd">@NotEmpty</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">removedItemsIds</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getRemovedItemsIds</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">removedItemsIds</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setRemovedItemsIds</span><span class="p">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">removedItemsIds</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">removedItemsIds</span> <span class="o">=</span> <span class="n">removedItemsIds</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id43">
<h4><a class="toc-backref" href="#id97">11.3.5.4.2. Controllerの作成</a><a class="headerlink" href="#id43" title="Permalink to this headline">¶</a></h4>
<p>Controllerを作成する。</p>
<p><code class="docutils literal"><span class="pre">/session-tutorial-init-web/src/main/java/com/example/session/app/cart/CartController.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.session.app.cart</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.ui.Model</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.BindingResult</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ModelAttribute</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PostMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessages</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.example.session.domain.model.Cart</span><span class="p">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;cart&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CartController</span> <span class="p">{</span>

    <span class="c1">// (1)</span>
    <span class="nd">@Inject</span>
    <span class="n">Cart</span> <span class="n">cart</span><span class="p">;</span>

    <span class="nd">@ModelAttribute</span>
    <span class="n">CartForm</span> <span class="nf">setUpForm</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">CartForm</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nd">@GetMapping</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">viewCart</span><span class="p">(</span><span class="n">Model</span> <span class="n">model</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;cart/viewCart&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@PostMapping</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">removeFromCart</span><span class="p">(</span><span class="nd">@Validated</span> <span class="n">CartForm</span> <span class="n">cartForm</span><span class="p">,</span>
            <span class="n">BindingResult</span> <span class="n">bindingResult</span><span class="p">,</span> <span class="n">Model</span> <span class="n">model</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bindingResult</span><span class="p">.</span><span class="na">hasErrors</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">ResultMessages</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="p">.</span><span class="na">error</span><span class="p">()</span>
                    <span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;e.st.ca.5001&quot;</span><span class="p">);</span>
            <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="n">messages</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">viewCart</span><span class="p">(</span><span class="n">model</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">cart</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">cartForm</span><span class="p">.</span><span class="na">getRemovedItemsIds</span><span class="p">());</span> <span class="c1">// (2)</span>
        <span class="k">return</span> <span class="s">&quot;redirect:/cart&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">セッションスコープのBeanをDIコンテナから取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">セッションスコープのBeanのデータを削除する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id44">
<h4><a class="toc-backref" href="#id98">11.3.5.4.3. JSPの作成</a><a class="headerlink" href="#id44" title="Permalink to this headline">¶</a></h4>
<p>カート一覧を表示し、削除したい商品を選択するためのJSPを作成する。
この画面から商品注文が行える。</p>
<p><code class="docutils literal"><span class="pre">/session-tutorial-init-web/src/main/webapp/WEB-INF/views/cart/viewCart.jsp</span></code></p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:authentication</span> <span class="na">property=</span><span class="s">&quot;principal&quot;</span> <span class="na">var=</span><span class="s">&quot;userDetails&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">&quot;display: inline-flex&quot;</span><span class="nt">&gt;</span>
    welcome<span class="ni">&amp;nbsp;&amp;nbsp;</span> <span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">&quot;userName&quot;</span><span class="nt">&gt;</span>${f:h(userDetails.account.name)}<span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;form:form</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/logout&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">id=</span><span class="s">&quot;logout&quot;</span> <span class="na">value=</span><span class="s">&quot;logout&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form:form&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;get&quot;</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/account/update&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;form1&quot;</span> <span class="na">id=</span><span class="s">&quot;updateAccount&quot;</span> <span class="na">value=</span><span class="s">&quot;Account Update&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;br&gt;</span>
<span class="nt">&lt;br&gt;</span>

<span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;spring:eval</span> <span class="na">var=</span><span class="s">&quot;cart&quot;</span> <span class="na">expression=</span><span class="s">&quot;@cart&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;form:form</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span>
        <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/cart&quot;</span>
        <span class="na">modelAttribute=</span><span class="s">&quot;cartForm&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;removedItemsIds&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;t:messagesPanel</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;table&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;th&gt;</span>Name<span class="nt">&lt;/th&gt;</span>
                <span class="nt">&lt;th&gt;</span>Price<span class="nt">&lt;/th&gt;</span>
                <span class="nt">&lt;th&gt;</span>Quantity<span class="nt">&lt;/th&gt;</span>
                <span class="nt">&lt;th&gt;</span>Remove<span class="nt">&lt;/th&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;c:forEach</span> <span class="na">items=</span><span class="s">&quot;${cart.cartItems}&quot;</span> <span class="na">var=</span><span class="s">&quot;cartItem&quot;</span> <span class="na">varStatus=</span><span class="s">&quot;status&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;tr&gt;</span>
                    <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;itemName${status.index}&quot;</span><span class="nt">&gt;</span>${f:h(cartItem.goods.name)}<span class="nt">&lt;/td&gt;</span>
                    <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;itemPrice${status.index}&quot;</span><span class="nt">&gt;&lt;fmt:formatNumber</span> <span class="na">value=</span><span class="s">&quot;${cartItem.goods.price}&quot;</span> <span class="na">type=</span><span class="s">&quot;CURRENCY&quot;</span> <span class="na">currencySymbol=</span><span class="s">&quot;&amp;yen;&quot;</span> <span class="na">maxFractionDigits=</span><span class="s">&quot;0&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
                    <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;itemQuantity${status.index}&quot;</span><span class="nt">&gt;</span>${f:h(cartItem.quantity)}<span class="nt">&lt;/td&gt;</span>
                    <span class="k">&lt;%-</span><span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">--</span><span class="k">%&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;checkbox&quot;</span> <span class="na">name=</span><span class="s">&quot;removedItemsIds&quot;</span> <span class="na">id=</span><span class="s">&quot;removedItemsIds${status.index}&quot;</span> <span class="na">value=</span><span class="s">&quot;${f:h(cartItem.goods.id)}&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;/c:forEach&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td&gt;</span>Total<span class="nt">&lt;/td&gt;</span>
                <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;totalPrice&quot;</span><span class="nt">&gt;&lt;fmt:formatNumber</span> <span class="na">value=</span><span class="s">&quot;${f:h(cart.totalAmount)}&quot;</span> <span class="na">type=</span><span class="s">&quot;CURRENCY&quot;</span> <span class="na">currencySymbol=</span><span class="s">&quot;&amp;yen;&quot;</span> <span class="na">maxFractionDigits=</span><span class="s">&quot;0&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;td&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;td&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;/table&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">id=</span><span class="s">&quot;remove&quot;</span> <span class="na">value=</span><span class="s">&quot;remove&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form:form&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">&quot;display: inline-flex&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;get&quot;</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/order&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">id=</span><span class="s">&quot;confirm&quot;</span> <span class="na">name=</span><span class="s">&quot;confirm&quot;</span> <span class="na">value=</span><span class="s">&quot;confirm your order&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;get&quot;</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/goods&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">id=</span><span class="s">&quot;home&quot;</span> <span class="na">value=</span><span class="s">&quot;home&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">チェックボックスを利用して、削除する商品を指定する。</div>
<div class="line">チェックボックスが選択された状態で削除ボタンが押されると、該当商品のIDがサーバに送信される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id45">
<h4><a class="toc-backref" href="#id99">11.3.5.4.4. 動作確認</a><a class="headerlink" href="#id45" title="Permalink to this headline">¶</a></h4>
<p>ここまでの実装でカートに登録された商品を削除することができるようになっている。
商品一覧表示画面で「viewCart」ボタンを押下することでカート表示画面に遷移する。
カート表示画面で削除したい商品をチェックして「remove」ボタンを押すことで、商品をカートから削除できる。</p>
</div>
</div>
<div class="section" id="id46">
<h3><a class="toc-backref" href="#id100">11.3.5.5. 商品注文機能を作成する</a><a class="headerlink" href="#id46" title="Permalink to this headline">¶</a></h3>
<p>カートに登録されている商品を注文する機能を作成する。</p>
<p>注文完了後カートの中身は空になる。</p>
<p>以下に商品注文機能で実装する画面の情報を示す。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="30%" />
<col width="15%" />
<col width="25%" />
<col width="30%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">処理名</th>
<th class="head">HTTPメソッド</th>
<th class="head">パス</th>
<th class="head">画面</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">注文確認画面表示処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/order?confirm</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">order/confirm</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">注文処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">POST</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/order</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">注文完了画面表示処理へリダイレクト</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">注文完了画面表示処理</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/order?finish</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">order/finish</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="section" id="id47">
<h4><a class="toc-backref" href="#id101">11.3.5.5.1. Controllerの作成</a><a class="headerlink" href="#id47" title="Permalink to this headline">¶</a></h4>
<p>Controllerを作成する。</p>
<p><code class="docutils literal"><span class="pre">/session-tutorial-init-web/src/main/java/com/example/session/app/order/OrderController.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.session.app.order</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.annotation.AuthenticationPrincipal</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.ui.Model</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ExceptionHandler</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PostMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestParam</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ResponseStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.ModelAndView</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.support.RedirectAttributes</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.BusinessException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessages</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.example.session.app.goods.GoodsSearchCriteria</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.session.domain.model.Cart</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.session.domain.model.Order</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.session.domain.service.order.EmptyCartOrderException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.session.domain.service.order.InvalidCartOrderException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.session.domain.service.order.OrderService</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.session.domain.service.userdetails.AccountDetails</span><span class="p">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;order&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderController</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">OrderService</span> <span class="n">orderService</span><span class="p">;</span>

    <span class="c1">// (1)</span>
    <span class="nd">@Inject</span>
    <span class="n">Cart</span> <span class="n">cart</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">GoodsSearchCriteria</span> <span class="n">criteria</span><span class="p">;</span>

    <span class="nd">@GetMapping</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="s">&quot;confirm&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">confirm</span><span class="p">(</span><span class="nd">@AuthenticationPrincipal</span> <span class="n">AccountDetails</span> <span class="n">userDetails</span><span class="p">,</span>
            <span class="n">Model</span> <span class="n">model</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cart</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">ResultMessages</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="p">.</span><span class="na">error</span><span class="p">()</span>
                    <span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;e.st.od.5001&quot;</span><span class="p">);</span>
            <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="n">messages</span><span class="p">);</span>
            <span class="k">return</span> <span class="s">&quot;cart/viewCart&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&quot;account&quot;</span><span class="p">,</span> <span class="n">userDetails</span><span class="p">.</span><span class="na">getAccount</span><span class="p">());</span>
        <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&quot;signature&quot;</span><span class="p">,</span> <span class="n">cart</span><span class="p">.</span><span class="na">calcSignature</span><span class="p">());</span>
        <span class="k">return</span> <span class="s">&quot;order/confirm&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@PostMapping</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">order</span><span class="p">(</span><span class="nd">@AuthenticationPrincipal</span> <span class="n">AccountDetails</span> <span class="n">userDetails</span><span class="p">,</span>
            <span class="nd">@RequestParam</span> <span class="n">String</span> <span class="n">signature</span><span class="p">,</span> <span class="n">RedirectAttributes</span> <span class="n">attributes</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">orderService</span><span class="p">.</span><span class="na">purchase</span><span class="p">(</span><span class="n">userDetails</span><span class="p">.</span><span class="na">getAccount</span><span class="p">(),</span> <span class="n">cart</span><span class="p">,</span>
                <span class="n">signature</span><span class="p">);</span> <span class="c1">// (2)</span>
        <span class="n">attributes</span><span class="p">.</span><span class="na">addFlashAttribute</span><span class="p">(</span><span class="n">order</span><span class="p">);</span>
        <span class="n">criteria</span><span class="p">.</span><span class="na">clear</span><span class="p">();</span> <span class="c1">// (3)</span>
        <span class="k">return</span> <span class="s">&quot;redirect:/order?finish&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@GetMapping</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="s">&quot;finish&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">finish</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;order/finish&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (4)</span>
    <span class="nd">@ExceptionHandler</span><span class="p">({</span> <span class="n">EmptyCartOrderException</span><span class="p">.</span><span class="na">class</span><span class="p">,</span>
            <span class="n">InvalidCartOrderException</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">CONFLICT</span><span class="p">)</span>
    <span class="n">ModelAndView</span> <span class="nf">handleOrderException</span><span class="p">(</span><span class="n">BusinessException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ModelAndView</span><span class="p">(</span><span class="s">&quot;common/error/businessError&quot;</span><span class="p">).</span><span class="na">addObject</span><span class="p">(</span><span class="n">e</span>
                <span class="p">.</span><span class="na">getResultMessages</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">セッションスコープのBeanをDIコンテナから取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ドメイン層にあるServiceのメソッドにて、セッションスコープのBeanの中身を空にしている。</div>
<div class="line">これによりセッションスコープのBeanの破棄が行われたことになる。</div>
<div class="line">また、今回のアプリケーションでは、セッションスコープのBeanにある情報をBean破棄後に遷移する画面で使用する。</div>
<div class="line">そのため、セッションスコープのBeanにあった情報を別のオブジェクトに入れなおしてフラッシュスコープに追加している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">商品検索情報をデフォルト状態に戻している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ServiceのメソッドでBusiness例外が発生する可能性があるため、このメソッドでエラーハンドリングを行っている。</div>
<div class="line">これにより、Business例外が発生した場合、指定したエラー画面に遷移することになる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">セッションスコープのBeanの破棄を行う方法は <code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code> で管理させるオブジェクトの破棄方法とは異なる。
セッションスコープBeanの破棄はDIコンテナに任せるべきであり、アプリケーションから破棄すべきでない。
そのため、セッションスコープのBeanの破棄を行うには、セッションスコープBeanのフィールドをリセットするだけで良い。
セッションタイムアウト時またはログアウト時にBean自体が破棄される。</p>
</div>
</div>
<div class="section" id="id48">
<h4><a class="toc-backref" href="#id102">11.3.5.5.2. JSPの作成</a><a class="headerlink" href="#id48" title="Permalink to this headline">¶</a></h4>
<p>注文内容と支払情報を表示するJSPを作成する。</p>
<p><code class="docutils literal"><span class="pre">/session-tutorial-init-web/src/main/webapp/WEB-INF/views/order/confirm.jsp</span></code></p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:authentication</span> <span class="na">property=</span><span class="s">&quot;principal&quot;</span> <span class="na">var=</span><span class="s">&quot;userDetails&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">&quot;display: inline-flex&quot;</span><span class="nt">&gt;</span>
    welcome<span class="ni">&amp;nbsp;&amp;nbsp;</span> <span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">&quot;userName&quot;</span><span class="nt">&gt;</span>${f:h(userDetails.account.name)}<span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;form:form</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span>
        <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/logout&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">id=</span><span class="s">&quot;logout&quot;</span> <span class="na">value=</span><span class="s">&quot;logout&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form:form&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;get&quot;</span>
        <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/account/update&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;form1&quot;</span> <span class="na">id=</span><span class="s">&quot;updateAccount&quot;</span>
            <span class="na">value=</span><span class="s">&quot;Account Update&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;br&gt;</span>
<span class="nt">&lt;br&gt;</span>

<span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;spring:eval</span> <span class="na">var=</span><span class="s">&quot;cart&quot;</span> <span class="na">expression=</span><span class="s">&quot;@cart&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;h3&gt;</span>Below items will be ordered. Please push &quot;order&quot; button if it&#39;s OK.<span class="nt">&lt;/h3&gt;</span>
    <span class="nt">&lt;table&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;th&gt;</span>Name<span class="nt">&lt;/th&gt;</span>
            <span class="nt">&lt;th&gt;</span>Price<span class="nt">&lt;/th&gt;</span>
            <span class="nt">&lt;th&gt;</span>Quantity<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;c:forEach</span> <span class="na">items=</span><span class="s">&quot;${cart.cartItems}&quot;</span> <span class="na">var=</span><span class="s">&quot;cartItem&quot;</span> <span class="na">varStatus=</span><span class="s">&quot;status&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;itemName${status.index}&quot;</span><span class="nt">&gt;</span>${f:h(cartItem.goods.name)}<span class="nt">&lt;/td&gt;</span>
                <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;itemPrice${status.index}&quot;</span><span class="nt">&gt;&lt;fmt:formatNumber</span> <span class="na">value=</span><span class="s">&quot;${cartItem.goods.price}&quot;</span> <span class="na">type=</span><span class="s">&quot;CURRENCY&quot;</span> <span class="na">currencySymbol=</span><span class="s">&quot;&amp;yen;&quot;</span> <span class="na">maxFractionDigits=</span><span class="s">&quot;0&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;itemQuantity${status.index}&quot;</span><span class="nt">&gt;</span>${f:h(cartItem.quantity)}<span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;/c:forEach&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;</span>Total<span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;totalPrice&quot;</span><span class="nt">&gt;&lt;fmt:formatNumber</span> <span class="na">value=</span><span class="s">&quot;${f:h(cart.totalAmount)}&quot;</span> <span class="na">type=</span><span class="s">&quot;CURRENCY&quot;</span> <span class="na">currencySymbol=</span><span class="s">&quot;&amp;yen;&quot;</span> <span class="na">maxFractionDigits=</span><span class="s">&quot;0&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;/table&gt;</span>

    <span class="nt">&lt;table&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>name<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>${f:h(account.name)}<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;email&quot;</span><span class="nt">&gt;</span>e-mail<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;email&quot;</span><span class="nt">&gt;</span>${f:h(account.email)}<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;zip&quot;</span><span class="nt">&gt;</span>zip<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;zip&quot;</span><span class="nt">&gt;</span>${f:h(account.zip)}<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;address&quot;</span><span class="nt">&gt;</span>address<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;address&quot;</span><span class="nt">&gt;</span>${f:h(account.address)}<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="k">&lt;%-</span><span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">--</span><span class="k">%&gt;</span>
            <span class="nt">&lt;td&gt;</span>payment<span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;payment&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;c:choose&gt;</span>
                    <span class="nt">&lt;c:when</span> <span class="na">test=</span><span class="s">&quot;${empty account.cardNumber}&quot;</span><span class="nt">&gt;</span>cash<span class="nt">&lt;/c:when&gt;</span>
                    <span class="nt">&lt;c:otherwise&gt;</span>card (card number : ****-****-****-${f:h(account.lastFourOfCardNumber)})<span class="nt">&lt;/c:otherwise&gt;</span>
                <span class="nt">&lt;/c:choose&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">&quot;display: inline-flex&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;form:form</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/order&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name=</span><span class="s">&quot;signature&quot;</span> <span class="na">value=</span><span class="s">&quot;${f:h(signature)}&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">id=</span><span class="s">&quot;order&quot;</span> <span class="na">value=</span><span class="s">&quot;order&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form:form&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;get&quot;</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/cart&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">id=</span><span class="s">&quot;back&quot;</span> <span class="na">value=</span><span class="s">&quot;back&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;get&quot;</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/goods&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">id=</span><span class="s">&quot;home&quot;</span> <span class="na">value=</span><span class="s">&quot;home&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウント情報としてカード番号が登録されている場合支払方法がカード払いとなる。</div>
<div class="line">登録されていない場合は現金払いとなる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>注文確定後の情報を表示するJSPを作成する。</p>
<p><code class="docutils literal"><span class="pre">/session-tutorial-init-web/src/main/webapp/WEB-INF/views/order/finish.jsp</span></code></p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:authentication</span> <span class="na">property=</span><span class="s">&quot;principal&quot;</span> <span class="na">var=</span><span class="s">&quot;userDetails&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">&quot;display: inline-flex&quot;</span><span class="nt">&gt;</span>
    welcome<span class="ni">&amp;nbsp;&amp;nbsp;</span> <span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">&quot;userName&quot;</span><span class="nt">&gt;</span>${f:h(userDetails.account.name)}<span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;form:form</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/logout&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">id=</span><span class="s">&quot;logout&quot;</span> <span class="na">value=</span><span class="s">&quot;logout&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form:form&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;get&quot;</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/account/update&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;form1&quot;</span> <span class="na">id=</span><span class="s">&quot;updateAccount&quot;</span> <span class="na">value=</span><span class="s">&quot;Account Update&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;br&gt;</span>
<span class="nt">&lt;br&gt;</span>

<span class="nt">&lt;div&gt;</span>

    <span class="nt">&lt;h3&gt;</span>Your order has been accepted<span class="nt">&lt;/h3&gt;</span>
    <span class="nt">&lt;table&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;orderNumber&quot;</span><span class="nt">&gt;</span>order number<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;orderNumber&quot;</span><span class="nt">&gt;</span>${f:h(order.id)}<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;orderDate&quot;</span><span class="nt">&gt;</span>order date<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;orderDate&quot;</span><span class="nt">&gt;&lt;fmt:formatDate</span> <span class="na">value=</span><span class="s">&quot;${order.orderDate}&quot;</span> <span class="na">pattern=</span><span class="s">&quot;yyyy-MM-dd　hh:mm:ss&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;/table&gt;</span>
    <span class="nt">&lt;table&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;th&gt;</span>Name<span class="nt">&lt;/th&gt;</span>
            <span class="nt">&lt;th&gt;</span>Price<span class="nt">&lt;/th&gt;</span>
            <span class="nt">&lt;th&gt;</span>Quantity<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;c:forEach</span> <span class="na">items=</span><span class="s">&quot;${order.orderLines}&quot;</span> <span class="na">var=</span><span class="s">&quot;orderLine&quot;</span> <span class="na">varStatus=</span><span class="s">&quot;status&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;itemName${status.index}&quot;</span><span class="nt">&gt;</span>${f:h(orderLine.goods.name)}<span class="nt">&lt;/td&gt;</span>
                <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;itemPrice${status.index}&quot;</span><span class="nt">&gt;&lt;fmt:formatNumber</span> <span class="na">value=</span><span class="s">&quot;${orderLine.goods.price}&quot;</span> <span class="na">type=</span><span class="s">&quot;CURRENCY&quot;</span> <span class="na">currencySymbol=</span><span class="s">&quot;&amp;yen;&quot;</span> <span class="na">maxFractionDigits=</span><span class="s">&quot;0&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;itemQuantity${status.index}&quot;</span><span class="nt">&gt;</span>${f:h(orderLine.quantity)}<span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;/c:forEach&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;</span>Total<span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;totalPrice&quot;</span><span class="nt">&gt;&lt;fmt:formatNumber</span> <span class="na">value=</span><span class="s">&quot;${f:h(order.totalAmount)}&quot;</span> <span class="na">type=</span><span class="s">&quot;CURRENCY&quot;</span> <span class="na">currencySymbol=</span><span class="s">&quot;&amp;yen;&quot;</span> <span class="na">maxFractionDigits=</span><span class="s">&quot;0&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;get&quot;</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/goods&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">id=</span><span class="s">&quot;home&quot;</span> <span class="na">value=</span><span class="s">&quot;home&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id49">
<h4><a class="toc-backref" href="#id103">11.3.5.5.3. 動作確認</a><a class="headerlink" href="#id49" title="Permalink to this headline">¶</a></h4>
<p>ここまでの実装でカートに登録された商品を注文することができるようになっている。
カート表示画面で「confirm your order」ボタンを押下することで注文確認画面に遷移する。
注文確認画面で「order」ボタンを押下することで、注文が完了する。</p>
<p>ここまでの実装で、注文完了時にセッションにあるカートオブジェクトが削除される。
そのため、注文完了後に商品一覧画面に戻るとカートの中身がクリアされている。</p>
</div>
</div>
<div class="section" id="id50">
<h3><a class="toc-backref" href="#id104">11.3.5.6. セッションの同期化とタイムアウトの設定</a><a class="headerlink" href="#id50" title="Permalink to this headline">¶</a></h3>
<p>最後にセッション同期化とタイムアウトの設定を行う。</p>
<p>セッションの同期化はBeanProcessorを利用して実現する。</p>
<p><code class="docutils literal"><span class="pre">/session-tutorial-init-web/src/main/java/com/example/session/app/config/EnableSynchronizeOnSessionPostProcessor.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.session.app.config</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.BeansException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.config.BeanPostProcessor</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EnableSynchronizeOnSessionPostProcessor</span> <span class="kd">implements</span>
        <span class="n">BeanPostProcessor</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">postProcessBeforeInitialization</span><span class="p">(</span><span class="n">Object</span> <span class="n">bean</span><span class="p">,</span> <span class="n">String</span> <span class="n">beanName</span><span class="p">)</span>
            <span class="kd">throws</span> <span class="n">BeansException</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">bean</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">postProcessAfterInitialization</span><span class="p">(</span><span class="n">Object</span> <span class="n">bean</span><span class="p">,</span> <span class="n">String</span> <span class="n">beanName</span><span class="p">)</span>
            <span class="kd">throws</span> <span class="n">BeansException</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bean</span> <span class="k">instanceof</span> <span class="n">RequestMappingHandlerAdapter</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">RequestMappingHandlerAdapter</span> <span class="n">adapter</span> <span class="o">=</span> <span class="p">(</span><span class="n">RequestMappingHandlerAdapter</span><span class="p">)</span> <span class="n">bean</span><span class="p">;</span>
            <span class="n">adapter</span><span class="p">.</span><span class="na">setSynchronizeOnSession</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span> <span class="c1">// (1)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">bean</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">setSynchronizeOnSessionメソッドの引数にtrueを指定することで、同一セッション内でのリクエストが同期化される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><code class="docutils literal"><span class="pre">/session-tutorial-init-web/src/main/resources/META-INF/spring/spring-mvc.xml</span></code></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- Bean Processor --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;com.example.session.app.config.EnableSynchronizeOnSessionPostProcessor&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<p>タイムアウト時間はweb.xmlで設定する。
デフォルト値の30分を採用する。</p>
<p><code class="docutils literal"><span class="pre">/session-tutorial-init-web/src/main/webapp/WEB-INF/web.xml</span></code> (デフォルトで設定済み)</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;session-config&gt;</span>
    <span class="c">&lt;!-- 30min --&gt;</span>
    <span class="nt">&lt;session-timeout&gt;</span>30<span class="nt">&lt;/session-timeout&gt;</span>
    <span class="nt">&lt;cookie-config&gt;</span>
        <span class="nt">&lt;http-only&gt;</span>true<span class="nt">&lt;/http-only&gt;</span>
        <span class="c">&lt;!-- &lt;secure&gt;true&lt;/secure&gt; --&gt;</span>
    <span class="nt">&lt;/cookie-config&gt;</span>
    <span class="nt">&lt;tracking-mode&gt;</span>COOKIE<span class="nt">&lt;/tracking-mode&gt;</span>
<span class="nt">&lt;/session-config&gt;</span>
</pre></div>
</div>
<p>タイムアウト後のリクエスト検知はSpring Securityの機能を利用する。</p>
<p><code class="docutils literal"><span class="pre">/session-tutorial-init-web/src/main/resources/META-INF/spring/spring-security.xml</span></code></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;sec:session-management</span> <span class="na">invalid-session-url=</span><span class="s">&quot;/loginForm&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">sec:session-management</span></code> タグの <code class="docutils literal"><span class="pre">invalid-session-url</span></code> 属性にタイムアウト後のリクエストを検知した際の遷移先を記述する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="id51">
<h2><a class="toc-backref" href="#id105">11.3.6. 終わりに</a><a class="headerlink" href="#id51" title="Permalink to this headline">¶</a></h2>
<p>本チュートリアルでは以下の内容を学習した。</p>
<ul class="simple">
<li><dl class="first docutils">
<dt>セッション管理対象となるデータの設計方法</dt>
<dd><ul class="first last">
<li>セッションに格納するデータの選択</li>
<li>セッションを利用するか否かの判断フローの一例</li>
<li>セッション中のデータの破棄</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>本FWにおけるセッションの具体的な利用方法</dt>
<dd><ul class="first last">
<li><code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code> を使用する方法</li>
<li>セッションスコープのBeanを使用する方法</li>
<li>各利用方法におけるセッション内データの参照方法</li>
<li>各利用方法におけるセッションの破棄方法</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="TutorialSecurity.html" title="11.4. Spring Securityチュートリアル"
             >next</a> |</li>
        <li class="right" >
          <a href="TutorialREST.html" title="11.2. チュートリアル(Todoアプリケーション REST編)"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.6.0.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >11. チュートリアル</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer">
      © Copyright 2013, NTT DATA Corporation. © Copyright 2013, NTT Corporation.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3.Theme is <a href="http://github.com/vimalkvn/solar-theme">Solar</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>

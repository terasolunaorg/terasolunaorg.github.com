<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>4.2. 例外ハンドリング &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.6.2.SP1.RELEASE documentation</title>
    <link rel="stylesheet" href="../../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '5.6.2.SP1.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="4.3. セッション管理" href="SessionManagement.html" />
    <link rel="prev" title="4.1. 入力チェック" href="Validation.html" /><script async src="https://www.googletagmanager.com/gtag/js?id=G-847V2Q99G8"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date()); gtag('config', 'G-847V2Q99G8');
</script>
<script src="../../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../../_static/solarized-dark.css" rel="stylesheet">
<link href="../../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="SessionManagement.html" title="4.3. セッション管理"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Validation.html" title="4.1. 入力チェック"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.6.2.SP1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">4. Webアプリ開発機能</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">4.2. 例外ハンドリング</a><ul>
<li><a class="reference internal" href="#overview">4.2.1. Overview</a><ul>
<li><a class="reference internal" href="#exception-handling-class-label">4.2.1.1. 例外の分類</a></li>
<li><a class="reference internal" href="#exception-handling-method-label">4.2.1.2. 例外のハンドリング方法</a></li>
</ul>
</li>
<li><a class="reference internal" href="#detail">4.2.2. Detail</a><ul>
<li><a class="reference internal" href="#exception-handling-exception-type-label">4.2.2.1. 例外の種類</a><ul>
<li><a class="reference internal" href="#exception-handling-exception-type-businessexception-label">4.2.2.1.1. ビジネス例外</a></li>
<li><a class="reference internal" href="#exception-handling-exception-type-libraryexception-label">4.2.2.1.2. 正常稼働時に発生するライブラリ例外</a></li>
<li><a class="reference internal" href="#exception-handling-exception-type-systemexception-label">4.2.2.1.3. システム例外</a></li>
<li><a class="reference internal" href="#exception-handling-exception-type-unexpectedexception-label">4.2.2.1.4. 予期しないシステム例外</a></li>
<li><a class="reference internal" href="#exception-handling-exception-type-error-label">4.2.2.1.5. 致命的なエラー</a></li>
<li><a class="reference internal" href="#exception-handling-exception-type-request-label">4.2.2.1.6. リクエスト不正時に発生するフレームワーク例外</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exception-handling-pattern-label">4.2.2.2. 例外ハンドリングのパターン</a><ul>
<li><a class="reference internal" href="#exception-handling-class-from-middle-label">4.2.2.2.1. ユースケースの一部やり直し(途中からのやり直し)を促す場合</a></li>
<li><a class="reference internal" href="#exception-handling-class-from-first-label">4.2.2.2.2. ユースケースのやり直し(先頭からのやり直し)を促す場合</a></li>
<li><a class="reference internal" href="#exception-handling-class-systemerror-label">4.2.2.2.3. システム、またはアプリケーションが、正常な状態でない事を通知する場合</a></li>
<li><a class="reference internal" href="#exception-handling-class-requesterror-label">4.2.2.2.4. リクエスト内容が、不正であることを通知する場合</a></li>
<li><a class="reference internal" href="#exception-handling-class-fatalerror-label">4.2.2.2.5. 致命的なエラーが発生したことを検知する場合</a></li>
<li><a class="reference internal" href="#jsp">4.2.2.2.6. プレゼンテーション層(JSPなど)で、例外が発生したことを通知する場合</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exception-handling-basic-flow-label">4.2.2.3. 例外ハンドリングの基本フロー</a><ul>
<li><a class="reference internal" href="#controller">4.2.2.3.1. リクエスト単位でControllerクラスがハンドリングする場合の基本フロー</a></li>
<li><a class="reference internal" href="#exception-handling-basic-flow-annotation-label">4.2.2.3.2. ユースケース単位でControllerクラスがハンドリングする場合の基本フロー</a></li>
<li><a class="reference internal" href="#exception-handling-basic-flow-resolver-label">4.2.2.3.3. サーブレット単位でフレームワークがハンドリングする場合の基本フロー</a></li>
<li><a class="reference internal" href="#web">4.2.2.3.4. Webアプリケーション単位でサーブレットコンテナがハンドリングする場合の基本フロー</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">4.2.3. How to use</a><ul>
<li><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-label">4.2.3.1. アプリケーションの設定</a><ul>
<li><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-common-label">4.2.3.1.1. 共通設定</a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-domain-label">4.2.3.1.2. ドメイン層の設定</a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-app-label">4.2.3.1.3. アプリケーション層の設定</a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-container-label">4.2.3.1.4. サーブレットコンテナの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#service">4.2.3.2. コーディングポイント（Service編）</a><ul>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-service-business-label">4.2.3.2.1. ビジネス例外を発生させる</a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-service-system-label">4.2.3.2.2. システム例外を発生させる</a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-service-continue-label">4.2.3.2.3. 例外をキャッチして、処理を継続させる</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-controller-label">4.2.3.3. コーディングポイント（Controller編）</a><ul>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-controller-request-label">4.2.3.3.1. リクエスト単位で例外をハンドリングする方法</a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-controller-usecase-label">4.2.3.3.2. ユースケース単位で例外をハンドリングする方法</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-jsp-label">4.2.3.4. コーディングポイント（JSP編）</a><ul>
<li><a class="reference internal" href="#messagespaneltag">4.2.3.4.1. MessagesPanelTagを使用して、メッセージを画面表示する方法</a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-view-exceptioncode-label">4.2.3.4.2. システム例外の例外コードを、画面表示する方法</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use-ajax">4.2.4. How to use (Ajax)</a></li>
<li><a class="reference internal" href="#appendix">4.2.5. Appendix</a><ul>
<li><a class="reference internal" href="#exception-handling-about-classes-of-library-label">4.2.5.1. 共通ライブラリから提供している例外ハンドリング用のクラスについて</a></li>
<li><a class="reference internal" href="#systemexceptionresolver">4.2.5.2. SystemExceptionResolverの設定項目について</a><ul>
<li><a class="reference internal" href="#id35">4.2.5.2.1. 結果メッセージの属性名</a></li>
<li><a class="reference internal" href="#id">4.2.5.2.2. 例外コード(メッセージID)の属性名</a></li>
<li><a class="reference internal" href="#id36">4.2.5.2.3. 例外コード(メッセージID)のヘッダ名</a></li>
<li><a class="reference internal" href="#id37">4.2.5.2.4. 例外オブジェクトの属性名</a></li>
<li><a class="reference internal" href="#http">4.2.5.2.5. HTTPレスポンスのキャッシュ制御有無</a></li>
</ul>
</li>
<li><a class="reference internal" href="#handlerexceptionresolverlogginginterceptor">4.2.5.3. HandlerExceptionResolverLoggingInterceptorの設定項目について</a><ul>
<li><a class="reference internal" href="#id38">4.2.5.3.1. ログ出力対象から除外する例外クラスの一覧</a></li>
</ul>
</li>
<li><a class="reference internal" href="#defaulthandlerexceptionresolverhttp">4.2.5.4. DefaultHandlerExceptionResolverで設定されるHTTPレスポンスコードについて</a></li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="Validation.html"
                        title="previous chapter">4.1. 入力チェック</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="SessionManagement.html"
                        title="next chapter">4.3. セッション管理</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/ArchitectureInDetail/WebApplicationDetail/ExceptionHandling.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="id1">
<h1>4.2. 例外ハンドリング<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="id2">
<p class="topic-title">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id59">Overview</a><ul>
<li><a class="reference internal" href="#exception-handling-class-label" id="id60">例外の分類</a></li>
<li><a class="reference internal" href="#exception-handling-method-label" id="id61">例外のハンドリング方法</a></li>
</ul>
</li>
<li><a class="reference internal" href="#detail" id="id62">Detail</a><ul>
<li><a class="reference internal" href="#exception-handling-exception-type-label" id="id63">例外の種類</a><ul>
<li><a class="reference internal" href="#exception-handling-exception-type-businessexception-label" id="id64">ビジネス例外</a></li>
<li><a class="reference internal" href="#exception-handling-exception-type-libraryexception-label" id="id65">正常稼働時に発生するライブラリ例外</a></li>
<li><a class="reference internal" href="#exception-handling-exception-type-systemexception-label" id="id66">システム例外</a></li>
<li><a class="reference internal" href="#exception-handling-exception-type-unexpectedexception-label" id="id67">予期しないシステム例外</a></li>
<li><a class="reference internal" href="#exception-handling-exception-type-error-label" id="id68">致命的なエラー</a></li>
<li><a class="reference internal" href="#exception-handling-exception-type-request-label" id="id69">リクエスト不正時に発生するフレームワーク例外</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exception-handling-pattern-label" id="id70">例外ハンドリングのパターン</a><ul>
<li><a class="reference internal" href="#exception-handling-class-from-middle-label" id="id71">ユースケースの一部やり直し(途中からのやり直し)を促す場合</a></li>
<li><a class="reference internal" href="#exception-handling-class-from-first-label" id="id72">ユースケースのやり直し(先頭からのやり直し)を促す場合</a></li>
<li><a class="reference internal" href="#exception-handling-class-systemerror-label" id="id73">システム、またはアプリケーションが、正常な状態でない事を通知する場合</a></li>
<li><a class="reference internal" href="#exception-handling-class-requesterror-label" id="id74">リクエスト内容が、不正であることを通知する場合</a></li>
<li><a class="reference internal" href="#exception-handling-class-fatalerror-label" id="id75">致命的なエラーが発生したことを検知する場合</a></li>
<li><a class="reference internal" href="#jsp" id="id76">プレゼンテーション層(JSPなど)で、例外が発生したことを通知する場合</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exception-handling-basic-flow-label" id="id77">例外ハンドリングの基本フロー</a><ul>
<li><a class="reference internal" href="#controller" id="id78">リクエスト単位でControllerクラスがハンドリングする場合の基本フロー</a></li>
<li><a class="reference internal" href="#exception-handling-basic-flow-annotation-label" id="id79">ユースケース単位でControllerクラスがハンドリングする場合の基本フロー</a></li>
<li><a class="reference internal" href="#exception-handling-basic-flow-resolver-label" id="id80">サーブレット単位でフレームワークがハンドリングする場合の基本フロー</a></li>
<li><a class="reference internal" href="#web" id="id81">Webアプリケーション単位でサーブレットコンテナがハンドリングする場合の基本フロー</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use" id="id82">How to use</a><ul>
<li><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-label" id="id83">アプリケーションの設定</a><ul>
<li><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-common-label" id="id84">共通設定</a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-domain-label" id="id85">ドメイン層の設定</a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-app-label" id="id86">アプリケーション層の設定</a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-container-label" id="id87">サーブレットコンテナの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#service" id="id88">コーディングポイント（Service編）</a><ul>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-service-business-label" id="id89">ビジネス例外を発生させる</a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-service-system-label" id="id90">システム例外を発生させる</a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-service-continue-label" id="id91">例外をキャッチして、処理を継続させる</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-controller-label" id="id92">コーディングポイント（Controller編）</a><ul>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-controller-request-label" id="id93">リクエスト単位で例外をハンドリングする方法</a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-controller-usecase-label" id="id94">ユースケース単位で例外をハンドリングする方法</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-jsp-label" id="id95">コーディングポイント（JSP編）</a><ul>
<li><a class="reference internal" href="#messagespaneltag" id="id96">MessagesPanelTagを使用して、メッセージを画面表示する方法</a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-view-exceptioncode-label" id="id97">システム例外の例外コードを、画面表示する方法</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use-ajax" id="id98">How to use (Ajax)</a></li>
<li><a class="reference internal" href="#appendix" id="id99">Appendix</a><ul>
<li><a class="reference internal" href="#exception-handling-about-classes-of-library-label" id="id100">共通ライブラリから提供している例外ハンドリング用のクラスについて</a></li>
<li><a class="reference internal" href="#systemexceptionresolver" id="id101">SystemExceptionResolverの設定項目について</a><ul>
<li><a class="reference internal" href="#id35" id="id102">結果メッセージの属性名</a></li>
<li><a class="reference internal" href="#id" id="id103">例外コード(メッセージID)の属性名</a></li>
<li><a class="reference internal" href="#id36" id="id104">例外コード(メッセージID)のヘッダ名</a></li>
<li><a class="reference internal" href="#id37" id="id105">例外オブジェクトの属性名</a></li>
<li><a class="reference internal" href="#http" id="id106">HTTPレスポンスのキャッシュ制御有無</a></li>
</ul>
</li>
<li><a class="reference internal" href="#handlerexceptionresolverlogginginterceptor" id="id107">HandlerExceptionResolverLoggingInterceptorの設定項目について</a><ul>
<li><a class="reference internal" href="#id38" id="id108">ログ出力対象から除外する例外クラスの一覧</a></li>
</ul>
</li>
<li><a class="reference internal" href="#defaulthandlerexceptionresolverhttp" id="id109">DefaultHandlerExceptionResolverで設定されるHTTPレスポンスコードについて</a></li>
</ul>
</li>
</ul>
</div>
<p>本ガイドラインで作成する、Webアプリケーションの例外ハンドリング指針について説明する。</p>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id59">4.2.1. Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>本節では、Spring MVC配下の処理で発生する例外のハンドリングについて説明する。説明対象は、以下の通りである。</p>
<div class="figure align-center" id="id39">
<a class="reference internal image-reference" href="../../_images/exception-handling-description-target.png"><img alt="description target" src="../../_images/exception-handling-description-target.png" style="width: 80%;" /></a>
<p class="caption"><span class="caption-text"><strong>図-説明対象</strong></span></p>
</div>
<ol class="arabic simple">
<li><a class="reference internal" href="#exception-handling-class-label"><span class="std std-ref">例外の分類</span></a></li>
<li><a class="reference internal" href="#exception-handling-method-label"><span class="std std-ref">例外のハンドリング方法</span></a></li>
</ol>
<div class="section" id="exception-handling-class-label">
<span id="id3"></span><h3><a class="toc-backref" href="#id60">4.2.1.1. 例外の分類</a><a class="headerlink" href="#exception-handling-class-label" title="Permalink to this headline">¶</a></h3>
<p>アプリケーション実行時に発生する例外は、以下3つに分類される。</p>
<table border="1" class="colwidths-given docutils" id="id40">
<caption><span class="caption-text"><strong>表-アプリケーション実行時に発生する例外の分類</strong></span><a class="headerlink" href="#id40" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="30%" />
<col width="30%" />
<col width="30%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">分類</th>
<th class="head">説明</th>
<th class="head"><a class="reference internal" href="#exception-handling-exception-type-label"><span class="std std-ref">例外の種類</span></a></th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">オペレータの再操作(入力値の変更など)によって、発生原因が解消できる例外</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">オペレータの再操作によって、発生原因が解消できる例外は、アプリケーションコードで例外をハンドリングし、例外処理を行う。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">1. <a class="reference internal" href="#exception-handling-exception-type-businessexception-label"><span class="std std-ref">ビジネス例外</span></a></div>
<div class="line">2. <a class="reference internal" href="#exception-handling-exception-type-libraryexception-label"><span class="std std-ref">正常稼働時に発生するライブラリ例外</span></a></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">オペレータの再操作によって、発生原因が解消できない例外</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">オペレータの再操作によって、発生原因が解消できない例外は、フレームワークで例外をハンドリングし、例外処理を行う。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">1. <a class="reference internal" href="#exception-handling-exception-type-systemexception-label"><span class="std std-ref">システム例外</span></a></div>
<div class="line">2. <a class="reference internal" href="#exception-handling-exception-type-unexpectedexception-label"><span class="std std-ref">予期しないシステム例外</span></a></div>
<div class="line">3. <a class="reference internal" href="#exception-handling-exception-type-error-label"><span class="std std-ref">致命的なエラー</span></a></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントからの不正リクエストにより発生する例外</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントからの不正リクエストにより発生する例外は、フレームワークで例外をハンドリングし、例外処理を行う。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">1. <a class="reference internal" href="#exception-handling-exception-type-request-label"><span class="std std-ref">リクエスト不正時に発生するフレームワーク例外</span></a></div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>誰が、例外を意識する必要があるのか？</strong></p>
<ul class="last simple">
<li>(1)はアプリケーション開発者が意識する例外となる。</li>
<li>(2)と(3)はアプリケーションアーキテクトが意識する例外となる。</li>
</ul>
</div>
</div>
<div class="section" id="exception-handling-method-label">
<span id="id4"></span><h3><a class="toc-backref" href="#id61">4.2.1.2. 例外のハンドリング方法</a><a class="headerlink" href="#exception-handling-method-label" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">アプリケーション実行時に発生する例外は、以下4つの方法でハンドリングを行う。</div>
<div class="line">ハンドリング方法毎のハンドリングフローの詳細は、<a class="reference internal" href="#exception-handling-basic-flow-label"><span class="std std-ref">例外ハンドリングの基本フロー</span></a>を参照されたい。</div>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id41">
<caption><span class="caption-text"><strong>表-例外のハンドリング方法</strong></span><a class="headerlink" href="#id41" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="30%" />
<col width="35%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">ハンドリング方法</th>
<th class="head">説明</th>
<th class="head"><a class="reference internal" href="#exception-handling-pattern-label"><span class="std std-ref">例外ハンドリングのパターン</span></a></th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アプリケーションコードにて、<code class="docutils literal"><span class="pre">try-catch</span></code>を使い、例外ハンドリングを行う。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエスト(Controllerのメソッド)単位に、例外をハンドリングする場合に使用する。</div>
<div class="line">詳細は、<a class="reference internal" href="#exception-handling-basic-flow-catch-label"><span class="std std-ref">リクエスト単位でControllerクラスがハンドリングする場合の基本フロー</span></a>を参照されたい。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">1. <a class="reference internal" href="#exception-handling-class-from-middle-label"><span class="std std-ref">ユースケースの一部やり直し(途中からのやり直し)を促す場合</span></a></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></code>アノテーションを使い、アプリケーションコードで例外ハンドリングを行う。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユースケース(Controller)単位に、例外をハンドリングする場合に使用する。</div>
<div class="line">詳細は、<a class="reference internal" href="#exception-handling-basic-flow-annotation-label"><span class="std std-ref">ユースケース単位でControllerクラスがハンドリングする場合の基本フロー</span></a>を参照されたい。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">1. <a class="reference internal" href="#exception-handling-class-from-first-label"><span class="std std-ref">ユースケースのやり直し(先頭からのやり直し)を促す場合</span></a></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フレームワークから提供されているHandlerExceptionResolverの仕組みを使い、例外ハンドリングを行う。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">サーブレット単位に、例外をハンドリングする場合に使用する。</div>
<div class="line">HandlerExceptionResolverは、<code class="docutils literal"><span class="pre">&lt;mvc:annotation-driven&gt;</span></code>を指定した際に、自動的に、<a class="reference internal" href="#exceptionhandling-annotation-driven"><span class="std std-ref">登録されるクラス</span></a>と、共通ライブラリから提供している<code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>を使用する。</div>
<div class="line">詳細は、<a class="reference internal" href="#exception-handling-basic-flow-resolver-label"><span class="std std-ref">サーブレット単位でフレームワークがハンドリングする場合の基本フロー</span></a>を参照されたい。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">1. <a class="reference internal" href="#exception-handling-class-systemerror-label"><span class="std std-ref">システム、またはアプリケーションが、正常な状態でない事を通知する場合</span></a></div>
<div class="line"><br /></div>
<div class="line">2. <a class="reference internal" href="#exception-handling-class-requesterror-label"><span class="std std-ref">リクエスト内容が、不正であることを通知する場合</span></a></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">サーブレットコンテナのerror-page機能を使い、例外ハンドリングを行う。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">致命的なエラー、Spring MVC管理外で発生する例外をハンドリングする場合に使用する。</div>
<div class="line">詳細は、<a class="reference internal" href="#exception-handling-basic-flow-container-label"><span class="std std-ref">Webアプリケーション単位でサーブレットコンテナがハンドリングする場合の基本フロー</span></a>を参照されたい。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">1. <a class="reference internal" href="#exception-handling-class-fatalerror-label"><span class="std std-ref">致命的なエラーが発生したことを検知する場合</span></a></div>
<div class="line"><br /></div>
<div class="line">2. <a class="reference internal" href="#exception-handling-class-viewerror-label"><span class="std std-ref">プレゼンテーション層(JSPなど)で、例外が発生したことを通知する場合</span></a></div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="figure align-center" id="id42">
<a class="reference internal image-reference" href="../../_images/exception-handling-method.png"><img alt="handling method" src="../../_images/exception-handling-method.png" style="width: 80%;" /></a>
<p class="caption"><span class="caption-text"><strong>図-例外のハンドリング方法</strong></span></p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>誰が例外ハンドリングを行うのか？</strong></p>
<ul class="last simple">
<li>(1)と(2)はアプリケーション開発者が設計・実装する。</li>
<li>(3)と(4)はアプリケーションアーキテクトが設計・設定する。</li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>自動的に登録されるHandlerExceptionResolverについて</strong></p>
<p>&lt;mvc:annotation-driven&gt; を指定した際に、自動的に登録されるHandlerExceptionResolverの役割は、以下の通りである。</p>
<p>優先順は、以下の並び順の通りとなる。</p>
<blockquote class="last" id="exceptionhandling-annotation-driven">
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="32%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">クラス(優先順位)</th>
<th class="head">役割</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ExceptionHandlerExceptionResolver</div>
<div class="line">(order=0)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></code>アノテーションが付与されているControllerクラスのメソッドを呼び出し、例外ハンドリングを行うためのクラス。</div>
<div class="line">No.2のハンドリング方法を実現するために必要なクラス。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ResponseStatusExceptionResolver</div>
<div class="line">(order=1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クラスアノテーションとして、<code class="docutils literal"><span class="pre">&#64;ResponseStatus</span></code>が付与されている例外をハンドリングするためのクラス。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;ResponseStatus</span></code>に指定されている値で、<code class="docutils literal"><span class="pre">HttpServletResponse#sendError(int</span> <span class="pre">sc,</span> <span class="pre">String</span> <span class="pre">msg)</span></code>が呼び出される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">DefaultHandlerExceptionResolver</div>
<div class="line">(order=2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring MVC内で発生するフレームワーク例外を、ハンドリングするためのクラス。</div>
<div class="line">フレームワーク例外に対応するHTTPレスポンスコードの値で、<code class="docutils literal"><span class="pre">HttpServletResponse#sendError(int</span> <span class="pre">sc)</span></code>が呼び出される。</div>
<div class="line">設定されるHTTPレスポンスコードの詳細は、<a class="reference internal" href="#exception-handling-appendix-defaulthandlerexceptionresolver-label"><span class="std std-ref">DefaultHandlerExceptionResolverで設定されるHTTPレスポンスコードについて</span></a>を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>共通ライブラリから提供している SystemExceptionResolver の役割は？</strong></p>
<p class="last">&lt;mvc:annotation-driven&gt; を指定した際に、自動的に登録されるHandlerExceptionResolverによって、
ハンドリングされない例外をハンドリングするためのクラスである。
そのため優先順は、DefaultHandlerExceptionResolverの後になるように設定する。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Spring Framework 3.2 より追加された&#64;ControllerAdviceアノテーションについて</strong></p>
<p><code class="docutils literal"><span class="pre">&#64;ControllerAdvice</span></code>の登場により、サーブレット単位で、<code class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></code>を使った例外ハンドリングを行えるようになった。
<code class="docutils literal"><span class="pre">&#64;ControllerAdvice</span></code>アノテーションが付与されたクラスで、<code class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></code>アノテーションを付与したメソッドを定義すると、サーブレット内のすべてのControllerに適用される。
以前のバージョンで同じことを実現する場合、<code class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></code>アノテーションが付与されたメソッドを、Controllerのベースクラスのメソッドとして定義し、
各Controllerでベースクラスを継承する必要があった。</p>
<p><strong>Spring Framework 4.0 より追加された&#64;ControllerAdviceアノテーションの属性について</strong></p>
<p class="last"><code class="docutils literal"><span class="pre">&#64;ControllerAdvice</span></code>アノテーションの属性を指定することで、
<code class="docutils literal"><span class="pre">&#64;ControllerAdvice</span></code>が付与されたクラスで実装したメソッドを適用するControllerを柔軟に指定できるように改善されている。
属性の詳細については、<a class="reference internal" href="../../ImplementationAtEachLayer/ApplicationLayer.html#application-layer-controller-advice-attribute"><span class="std std-ref">&#64;ControllerAdviceの属性</span></a>を参照されたい。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>&#64;ControllerAdviceアノテーションの使いどころ</strong></p>
<ol class="last arabic simple">
<li>サーブレット単位で行う例外ハンドリングに対して、View名と、HTTPレスポンスコードの解決以外の処理が必要な場合。
（View名とHTTPレスポンスコードの解決のみでよい場合は、<code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>で対応できる ）</li>
<li>サーブレット単位で行う例外ハンドリングに対して、エラー応答用のレスポンスデータをJSPなどのテンプレートエンジンを使わずに、
エラー用のモデル（JavaBeans）を、JSONやXML形式にシリアライズして生成したい場合
（AJAXや、REST用のControllerを作成する際の、エラーハンドリングとして使用する）。</li>
</ol>
</div>
</div>
</div>
<div class="section" id="detail">
<h2><a class="toc-backref" href="#id62">4.2.2. Detail</a><a class="headerlink" href="#detail" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><a class="reference internal" href="#exception-handling-exception-type-label"><span class="std std-ref">例外の種類</span></a></li>
<li><a class="reference internal" href="#exception-handling-pattern-label"><span class="std std-ref">例外ハンドリングのパターン</span></a></li>
<li><a class="reference internal" href="#exception-handling-basic-flow-label"><span class="std std-ref">例外ハンドリングの基本フロー</span></a></li>
</ol>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="exception-handling-exception-type-label">
<span id="id5"></span><h3><a class="toc-backref" href="#id63">4.2.2.1. 例外の種類</a><a class="headerlink" href="#exception-handling-exception-type-label" title="Permalink to this headline">¶</a></h3>
<p>アプリケーション実行時に発生する例外は、以下6種類に分類される。</p>
<table border="1" class="colwidths-given docutils" id="id43">
<caption><span class="caption-text"><strong>表-例外の種類</strong></span><a class="headerlink" href="#id43" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="17%" />
<col width="33%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">例外の種類</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#exception-handling-exception-type-businessexception-label"><span class="std std-ref">ビジネス例外</span></a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ビジネスルールの違反を検知したことを通知する例外</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#exception-handling-exception-type-libraryexception-label"><span class="std std-ref">正常稼働時に発生するライブラリ例外</span></a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フレームワーク、およびライブラリ内で発生する例外のうち、システムが、正常稼働している時に発生する可能性のある例外</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#exception-handling-exception-type-systemexception-label"><span class="std std-ref">システム例外</span></a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">システムが、正常稼働している時に、発生してはいけない状態を検知したことを通知する例外</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#exception-handling-exception-type-unexpectedexception-label"><span class="std std-ref">予期しないシステム例外</span></a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">システムが、正常稼働している時には発生しない非検査例外</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#exception-handling-exception-type-error-label"><span class="std std-ref">致命的なエラー</span></a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">システム(アプリケーション)全体に影響を及ぼす、致命的な問題が発生していることを通知するエラー</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#exception-handling-exception-type-request-label"><span class="std std-ref">リクエスト不正時に発生するフレームワーク例外</span></a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フレームワークが、リクエスト内容の不正を検知したことを通知する例外</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="section" id="exception-handling-exception-type-businessexception-label">
<span id="id6"></span><h4><a class="toc-backref" href="#id64">4.2.2.1.1. ビジネス例外</a><a class="headerlink" href="#exception-handling-exception-type-businessexception-label" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><strong>ビジネスルールの違反を検知したことを通知する例外</strong> 。</div>
<div class="line">本例外は、ドメイン層のロジック内で発生させる。</div>
<div class="line">アプリケーションとして想定される状態なので、システム運用者による対処は、不要である。</div>
</div>
<ul class="simple">
<li>旅行を予約する際に予約日が期限を過ぎている場合</li>
<li>商品を注文する際に在庫切れの場合</li>
<li>etc …</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>該当する例外クラス</strong></p>
<ul class="last simple">
<li><code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.exception.BusinessException</span></code> (共通ライブラリから提供しているクラス)。</li>
<li>細かくハンドリングする必要がある場合は、BusinessExceptionを継承した例外クラスを作成すること。</li>
<li>共通ライブラリで用意しているビジネス例外クラスで、要件を満たせない場合は、プロジェクト毎にビジネス例外クラスを作成すること。</li>
</ul>
</div>
</div>
<div class="section" id="exception-handling-exception-type-libraryexception-label">
<span id="id7"></span><h4><a class="toc-backref" href="#id65">4.2.2.1.2. 正常稼働時に発生するライブラリ例外</a><a class="headerlink" href="#exception-handling-exception-type-libraryexception-label" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">フレームワーク、およびライブラリ内で発生する例外のうち、 <strong>システムが、正常稼働している時に発生する可能性のある例外。</strong></div>
<div class="line">フレームワーク、およびライブラリ内で発生する例外とは、Spring Frameworkや、その他のライブラリ内で発生する例外クラスを対象とする。</div>
<div class="line">アプリケーションとして想定される状態なので、システム運用者による対処は、不要である。</div>
</div>
<ul class="simple">
<li>複数のオペレータによって、同じデータを同時に更新しようとした場合に、発生する楽観排他例外や、悲観排他例外。</li>
<li>複数のオペレータによって、同じデータを同時に登録しようとした場合に、発生する一意制約違反例外。</li>
<li>etc …</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>該当する例外クラスの例</strong></p>
<ul class="last simple">
<li><code class="docutils literal"><span class="pre">org.springframework.dao.OptimisticLockingFailureException</span></code> (楽観排他でエラーが発生した場合に発生する例外)。</li>
<li><code class="docutils literal"><span class="pre">org.springframework.dao.PessimisticLockingFailureException</span></code> (悲観排他でエラーが発生した場合に発生する例外)。</li>
<li><code class="docutils literal"><span class="pre">org.springframework.dao.DuplicateKeyException</span></code> (一意制約違反となった場合に発生する例外)。</li>
<li>etc …</li>
</ul>
</div>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p><strong>JPA(Hibernate)を使用すると、現状意図しないエラーとなることが発覚している。</strong></p>
<ul class="last simple">
<li>一意制約違反が発生した場合、<code class="docutils literal"><span class="pre">DuplicateKeyException</span></code>ではなく、<code class="docutils literal"><span class="pre">org.springframework.dao.DataIntegrityViolationException</span></code>が発生する。</li>
</ul>
</div>
</div>
<div class="section" id="exception-handling-exception-type-systemexception-label">
<span id="id8"></span><h4><a class="toc-backref" href="#id66">4.2.2.1.3. システム例外</a><a class="headerlink" href="#exception-handling-exception-type-systemexception-label" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><strong>システムが、正常稼働している時に、発生してはいけない状態を検知したことを通知する例外</strong> 。</div>
<div class="line">本例外は、アプリケーション層、およびドメイン層のロジックで発生させる。</div>
<div class="line">システム運用者による対処が必要となる。</div>
</div>
<ul class="simple">
<li>事前に存在しているはずのマスタデータ、ディレクトリ、ファイルなどが存在しない場合。</li>
<li>フレームワーク、ライブラリ内で発生する検査例外のうち、システム異常に分類される例外を捕捉した場合(ファイル操作時のIOExceptionなど)。</li>
<li>etc …</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>該当する例外クラス</strong></p>
<ul class="last simple">
<li><code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.exception.SystemException</span></code> (共通ライブラリから提供しているクラス)。</li>
<li>遷移先のエラー画面や、HTTPレスポンスコードを細かく分ける場合は、SystemExceptionを継承した例外クラスを作成すること。</li>
<li>共通ライブラリで用意しているシステム例外クラスだと要件を満たせない場合は、プロジェクト毎にシステム例外クラスを作成すること。</li>
</ul>
</div>
</div>
<div class="section" id="exception-handling-exception-type-unexpectedexception-label">
<span id="id9"></span><h4><a class="toc-backref" href="#id67">4.2.2.1.4. 予期しないシステム例外</a><a class="headerlink" href="#exception-handling-exception-type-unexpectedexception-label" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><strong>システムが、正常稼働している時には発生しない非検査例外。</strong></div>
<div class="line">システム運用者による対処、またはシステム開発者による解析が必要となる。</div>
<div class="line"><strong>予期しないシステム例外は、アプリケーションコードでハンドリング(try-catch)すべきでない。</strong></div>
</div>
<ul class="simple">
<li>アプリケーション、フレームワーク、ライブラリにバグが潜んでいる場合。</li>
<li>DBサーバなどがダウンしている場合。</li>
<li>etc …</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>該当する例外クラスの例</strong></p>
<ul class="last simple">
<li><code class="docutils literal"><span class="pre">java.lang.NullPointerException</span></code>(バグ起因で発生する例外)。</li>
<li><code class="docutils literal"><span class="pre">org.springframework.dao.DataAccessResourceFailureException</span></code>(DBサーバがダウンしている場合に発生する例外)。</li>
<li>etc …</li>
</ul>
</div>
</div>
<div class="section" id="exception-handling-exception-type-error-label">
<span id="id10"></span><h4><a class="toc-backref" href="#id68">4.2.2.1.5. 致命的なエラー</a><a class="headerlink" href="#exception-handling-exception-type-error-label" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><strong>システム(アプリケーション)全体に影響を及ぼす、致命的な問題が発生している事を通知するエラー</strong> 。</div>
<div class="line">システム運用者、またはシステム開発者による対処・リカバリが必要となる。</div>
<div class="line"><strong>致命的なエラー（java.lang.Errorを継承しているエラーオブジェクト）は、アプリケーションコードでハンドリング(try-catch)してはいけない。</strong></div>
</div>
<ul class="simple">
<li>Java仮想マシンで使用できるメモリが不足している場合。</li>
<li>etc …</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>該当するエラークラスの例</strong></p>
<ul class="last simple">
<li><code class="docutils literal"><span class="pre">java.lang.OutOfMemoryError</span></code>(メモリ不足時に発生するエラー)。</li>
<li>etc …</li>
</ul>
</div>
</div>
<div class="section" id="exception-handling-exception-type-request-label">
<span id="id11"></span><h4><a class="toc-backref" href="#id69">4.2.2.1.6. リクエスト不正時に発生するフレームワーク例外</a><a class="headerlink" href="#exception-handling-exception-type-request-label" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><strong>フレームワークが、リクエスト内容の不正を検知したことを通知する例外</strong> 。</div>
<div class="line">本例外は、フレームワーク(Spring MVC)内で発生する。</div>
<div class="line">原因は、クライアント側に存在するため、システム運用者による対処は、不要である。</div>
</div>
<ul class="simple">
<li>POSTメソッドのみ許容しているリクエストパスに対して、GETメソッドでアクセスした場合に発生する例外。</li>
<li><code class="docutils literal"><span class="pre">&#64;PathVariable</span></code>アノテーションを使って、URIから値を抽出する際に、URIに型変換できない値が、指定された場合に発生する例外。</li>
<li>etc …</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>該当する例外クラスの例</strong></p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">org.springframework.web.HttpRequestMethodNotSupportedException</span></code>(サポート外のメソッドでアクセスされた場合に発生する例外)。</li>
<li><code class="docutils literal"><span class="pre">org.springframework.beans.TypeMismatchException</span></code>(URIに型変換できない値が指定された場合に発生する例外)。</li>
<li>etc …</li>
</ul>
</div></blockquote>
<p class="last"><a class="reference internal" href="#exception-handling-appendix-defaulthandlerexceptionresolver-label"><span class="std std-ref">DefaultHandlerExceptionResolverで設定されるHTTPレスポンスコードについて</span></a>の中の、HTTPステータスコードが「4XX」の例外が該当するクラス。</p>
</div>
</div>
</div>
<div class="section" id="exception-handling-pattern-label">
<span id="id12"></span><h3><a class="toc-backref" href="#id70">4.2.2.2. 例外ハンドリングのパターン</a><a class="headerlink" href="#exception-handling-pattern-label" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">例外ハンドリングは、目的に応じて、以下6種類のパターンに分類される。</div>
<div class="line">(1)-(2)はユースケース毎、(3)-(6)はシステム(アプリケーション)全体でハンドリングを行う。</div>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id44">
<caption><span class="caption-text"><strong>表-例外ハンドリングのパターン</strong></span><a class="headerlink" href="#id44" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="40%" />
<col width="25%" />
<col width="10%" />
<col width="15%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">ハンドリングの目的</th>
<th class="head">ハンドリング対象となり得る例外</th>
<th class="head">ハンドリング方法</th>
<th class="head">ハンドリング単位</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#exception-handling-class-from-middle-label"><span class="std std-ref">ユースケースの一部やり直し(途中からのやり直し)を促す場合</span></a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">1. <a class="reference internal" href="#exception-handling-exception-type-businessexception-label"><span class="std std-ref">ビジネス例外</span></a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アプリケーションコード</div>
<div class="line">(try-catch)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエスト</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#exception-handling-class-from-first-label"><span class="std std-ref">ユースケースのやり直し(先頭からのやり直し)を促す場合</span></a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">1. <a class="reference internal" href="#exception-handling-exception-type-businessexception-label"><span class="std std-ref">ビジネス例外</span></a></div>
<div class="line">2. <a class="reference internal" href="#exception-handling-exception-type-libraryexception-label"><span class="std std-ref">正常稼働時に発生するライブラリ例外</span></a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アプリケーションコード</div>
<div class="line">(&#64;ExceptionHandler)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユースケース</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#exception-handling-class-systemerror-label"><span class="std std-ref">システム、またはアプリケーションが、正常な状態でない事を通知する場合</span></a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">1. <a class="reference internal" href="#exception-handling-exception-type-systemexception-label"><span class="std std-ref">システム例外</span></a></div>
<div class="line">2. <a class="reference internal" href="#exception-handling-exception-type-unexpectedexception-label"><span class="std std-ref">予期しないシステム例外</span></a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フレームワーク</div>
<div class="line">(ハンドリングルールを、<code class="docutils literal"><span class="pre">spring-mvc.xml</span></code>に指定する)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">サーブレット</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#exception-handling-class-requesterror-label"><span class="std std-ref">リクエスト内容が、不正であることを通知する場合</span></a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">1. <a class="reference internal" href="#exception-handling-exception-type-request-label"><span class="std std-ref">リクエスト不正時に発生するフレームワーク例外</span></a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フレームワーク</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">サーブレット</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#exception-handling-class-fatalerror-label"><span class="std std-ref">致命的なエラーが発生したことを検知する場合</span></a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">1. <a class="reference internal" href="#exception-handling-exception-type-error-label"><span class="std std-ref">致命的なエラー</span></a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">サーブレットコンテナ</div>
<div class="line">(ハンドリングルールを、<code class="docutils literal"><span class="pre">web.xml</span></code>に指定する)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Webアプリケーション</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#exception-handling-class-viewerror-label"><span class="std std-ref">プレゼンテーション層(JSPなど)で、例外が発生したことを通知する場合</span></a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">1. プレゼンテーション層で発生する全ての例外及びエラー</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">サーブレットコンテナ</div>
<div class="line">(ハンドリングルールを、<code class="docutils literal"><span class="pre">web.xml</span></code>に指定する)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Webアプリケーション</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="section" id="exception-handling-class-from-middle-label">
<span id="id13"></span><h4><a class="toc-backref" href="#id71">4.2.2.2.1. ユースケースの一部やり直し(途中からのやり直し)を促す場合</a><a class="headerlink" href="#exception-handling-class-from-middle-label" title="Permalink to this headline">¶</a></h4>
<p>ユースケースの一部やり直し(途中からのやり直し)を促す場合は、Controllerクラスのアプリケーションコードで捕捉(try-catch)し、リクエスト単位で例外処理を行う。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>ユースケースの一部やり直しを促す場合の例</strong></p>
<ul class="last">
<li><div class="first line-block">
<div class="line">ショッピングサイトで注文処理を行った際に、在庫不足を通知するビジネス例外が発生する場合。</div>
<div class="line">このケースの場合、個数を減らせば注文処理が行えるため、個数が変更できる画面に遷移し、個数変更を促すメッセージを表示する。</div>
</div>
</li>
<li><p class="first">etc …</p>
</li>
</ul>
</div>
<div class="figure align-center" id="id45">
<a class="reference internal image-reference" href="../../_images/exception-handling-class-again-from-middle.png"><img alt="class of exception handling for again from middle" src="../../_images/exception-handling-class-again-from-middle.png" style="width: 80%;" /></a>
<p class="caption"><span class="caption-text"><strong>図-ユースケースの一部やり直し(途中からのやり直し)を促す場合のハンドリング方法</strong></span></p>
</div>
</div>
<div class="section" id="exception-handling-class-from-first-label">
<span id="id14"></span><h4><a class="toc-backref" href="#id72">4.2.2.2.2. ユースケースのやり直し(先頭からのやり直し)を促す場合</a><a class="headerlink" href="#exception-handling-class-from-first-label" title="Permalink to this headline">¶</a></h4>
<p>ユースケースのやり直し(先頭からのやり直し)を促す場合は、<code class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></code>を使って捕捉し、ユースケース単位で例外処理を行う。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>ユースケースのやり直し（先頭からのやり直し）を促す場合の例</strong></p>
<ul class="last">
<li><div class="first line-block">
<div class="line">ショッピングサイト(管理者向けサイト)で商品マスタの変更を行った際に、変更対象の商品マスタが他のオペレータによって変更されていた場合（楽観排他例外が発生した場合）。</div>
<div class="line">このケースの場合、他のユーザが行った変更内容を確認してから操作してもらう必要があるため、ユースケースの先頭画面（例えば商品マスタの検索画面）に遷移し、再操作を促すメッセージを表示する。</div>
</div>
</li>
<li><p class="first">etc …</p>
</li>
</ul>
</div>
<div class="figure align-center" id="id46">
<a class="reference internal image-reference" href="../../_images/exception-handling-class-again-from-first.png"><img alt="class of exception handling for again from first" src="../../_images/exception-handling-class-again-from-first.png" style="width: 80%;" /></a>
<p class="caption"><span class="caption-text"><strong>図-ユースケースのやり直し(先頭からのやり直し)を促す場合のハンドリング方法</strong></span></p>
</div>
</div>
<div class="section" id="exception-handling-class-systemerror-label">
<span id="id15"></span><h4><a class="toc-backref" href="#id73">4.2.2.2.3. システム、またはアプリケーションが、正常な状態でない事を通知する場合</a><a class="headerlink" href="#exception-handling-class-systemerror-label" title="Permalink to this headline">¶</a></h4>
<p>システム、またはアプリケーションが、正常な状態でないことを通知する例外を検知する場合は、SystemExceptionResolverで捕捉し、サーブレット単位で例外処理を行う。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>システム、またはアプリケーションが正常な状態でないことを通知する場合の例</strong></p>
<ul class="last">
<li><div class="first line-block">
<div class="line">外部システムとの接続を行うユースケースにて、外部システムが、閉塞中であることを通知する例外が発生した場合。</div>
<div class="line">このケースの場合、外部システムが開局するまで実行できないため、エラー画面に遷移し、外部システムが開局するまでユースケースが実行できない旨を通知する。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">アプリケーションで指定した値を、条件にマスタ情報の検索を行った際に、該当するマスタ情報が存在しない場合。</div>
<div class="line">このケースの場合、マスタメンテナンス機能のバグ又はシステム運用者によるデータ投入ミス(リリースミス)の可能性があるため、システムエラー画面に遷移し、システム異常が発生した旨を通知する。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">ファイル操作時にAPIからIOExceptionが発生した場合。</div>
<div class="line">このケースの場合、ディスク異常などが考えられるため、システムエラー画面に遷移し、システム異常が発生した旨を通知する。</div>
</div>
</li>
<li><p class="first">etc …</p>
</li>
</ul>
</div>
<div class="figure align-center" id="id47">
<a class="reference internal image-reference" href="../../_images/exception-handling-class-systemerror.png"><img alt="class of exception handling for system error" src="../../_images/exception-handling-class-systemerror.png" style="width: 80%;" /></a>
<p class="caption"><span class="caption-text"><strong>図-システム、またはアプリケーションが、正常な状態でないことを通知する例外を検知する場合のハンドリング方法</strong></span></p>
</div>
</div>
<div class="section" id="exception-handling-class-requesterror-label">
<span id="id16"></span><h4><a class="toc-backref" href="#id74">4.2.2.2.4. リクエスト内容が、不正であることを通知する場合</a><a class="headerlink" href="#exception-handling-class-requesterror-label" title="Permalink to this headline">¶</a></h4>
<p>フレームワークによって、検知されたリクエスト不正を通知する場合は、DefaultHandlerExceptionResolverで捕捉し、サーブレット単位で例外処理を行う。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>リクエスト内容が不正であることを通知する場合の例</strong></p>
<ul class="last">
<li><div class="first line-block">
<div class="line">POSTメソッドのみ許可されているURIで、GETメソッドを使ってアクセスした場合。</div>
<div class="line">このケースの場合、ブラウザのお気に入り機能などを使って直接アクセスしている事が考えられるため、エラー画面に遷移し、リクエスト内容が不正であることを通知する。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;PathVariable</span></code> アノテーションを使ってURIから値を抽出する際に、URIから値を抽出できなかった場合。</div>
<div class="line">このケースの場合、ブラウザのアドレスバーの値を書き換えて、直接アクセスしている事が考えられるため、エラー画面に遷移し、リクエスト内容が不正であることを通知する。</div>
</div>
</li>
<li><p class="first">etc …</p>
</li>
</ul>
</div>
<div class="figure align-center" id="id48">
<a class="reference internal image-reference" href="../../_images/exception-handling-class-requesterror.png"><img alt="class of exception handling for request error" src="../../_images/exception-handling-class-requesterror.png" style="width: 80%;" /></a>
<p class="caption"><span class="caption-text"><strong>図-リクエスト内容が不正であることを通知する場合のハンドリング方法</strong></span></p>
</div>
</div>
<div class="section" id="exception-handling-class-fatalerror-label">
<span id="id17"></span><h4><a class="toc-backref" href="#id75">4.2.2.2.5. 致命的なエラーが発生したことを検知する場合</a><a class="headerlink" href="#exception-handling-class-fatalerror-label" title="Permalink to this headline">¶</a></h4>
<p>致命的なエラーが発生したことを検知する場合、サーブレットコンテナで捕捉し、Webアプリケーション単位で例外処理を行う。</p>
<div class="figure align-center" id="id49">
<a class="reference internal image-reference" href="../../_images/exception-handling-class-fatalerror.png"><img alt="class of exception handling for fatal error" src="../../_images/exception-handling-class-fatalerror.png" style="width: 80%;" /></a>
<p class="caption"><span class="caption-text"><strong>図-致命的なエラーが発生したことを検知する場合のハンドリング方法</strong></span></p>
</div>
<div class="admonition warning" id="exception-handling-class-fatalerror-warning">
<p class="first admonition-title">Warning</p>
<p><strong>&#64;ExceptionHandlerとSystemExceptionResolverによる致命的なエラーのハンドリングついて</strong></p>
<p>Spring Framework 4.3 より、致命的なエラー(<code class="docutils literal"><span class="pre">java.lang.Error</span></code>及びそのサブクラス)や<code class="docutils literal"><span class="pre">java.lang.Throwable</span></code>がラップされた<code class="docutils literal"><span class="pre">org.springframework.web.util.NestedServletException</span></code>を、
Spring MVCの例外ハンドラ(<code class="docutils literal"><span class="pre">HandlerExceptionResolver</span></code>)を使用して捕捉できるようになった。
この変更に伴い、致命的なエラーや<code class="docutils literal"><span class="pre">Throwable</span></code>を意図せず 共通ライブラリが提供する<code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>(<code class="docutils literal"><span class="pre">HandlerExceptionResolver</span></code>を継承)や<code class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></code>を付与したメソッド(<code class="docutils literal"><span class="pre">HandlerExceptionResolver</span></code>の仕組み上で動作)によって捕捉してしまう可能性がある。</p>
<p>致命的なエラーをサーブレットコンテナで捕捉するためには、<code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>と<code class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></code>を付与したメソッドで<code class="docutils literal"><span class="pre">NestedServletException</span></code>をハンドリングせず、サーブレットコンテナに通知する必要がある。
<code class="docutils literal"><span class="pre">NestedServletException</span></code>をハンドリングしない方法については、How to useで解説している。</p>
<ul class="last simple">
<li><code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>については、<a class="reference internal" href="#exception-handling-how-to-use-application-configuration-app-label"><span class="std std-ref">アプリケーション層の設定</span></a>を参照されたい。</li>
<li><code class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></code>については、<a class="reference internal" href="#exception-handling-how-to-use-codingpoint-controller-usecase-label"><span class="std std-ref">ユースケース単位で例外をハンドリングする方法</span></a>を参照されたい。</li>
</ul>
</div>
</div>
<div class="section" id="jsp">
<span id="exception-handling-class-viewerror-label"></span><h4><a class="toc-backref" href="#id76">4.2.2.2.6. プレゼンテーション層(JSPなど)で、例外が発生したことを通知する場合</a><a class="headerlink" href="#jsp" title="Permalink to this headline">¶</a></h4>
<p>プレゼンテーション層(JSPなど)で、例外が発生したことを通知する場合、サーブレットコンテナで捕捉し、Webアプリケーション単位で例外処理を行う。</p>
<div class="figure align-center" id="id50">
<a class="reference internal image-reference" href="../../_images/exception-handling-class-jsperror.png"><img alt="class of exception handling for fatal error" src="../../_images/exception-handling-class-jsperror.png" style="width: 80%;" /></a>
<p class="caption"><span class="caption-text"><strong>図-プレゼンテーション層(JSPなど)で例外が発生した事を通知する場合のハンドリング方法</strong></span></p>
</div>
</div>
</div>
<div class="section" id="exception-handling-basic-flow-label">
<span id="id18"></span><h3><a class="toc-backref" href="#id77">4.2.2.3. 例外ハンドリングの基本フロー</a><a class="headerlink" href="#exception-handling-basic-flow-label" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">例外処理の基本フローを示す。</div>
<div class="line">共通ライブラリから提供しているクラスの概要については、<a class="reference internal" href="#exception-handling-about-classes-of-library-label"><span class="std std-ref">共通ライブラリから提供している例外ハンドリング用のクラスについて</span></a>を参照されたい。</div>
<div class="line"><strong>アプリケーションコードで行う処理(実装が必要な処理)についての説明は、太字で表現している。</strong></div>
<div class="line">例外メッセージ、およびスタックトレースのログ出力は、共通ライブラリから提供しているクラス（FilterやInterceptorクラス）で行う。</div>
<div class="line">例外メッセージ、およびスタックトレース以外の情報を、ログ出力する必要がある場合は、各ロジックで個別にログを出力すること。</div>
<div class="line">例外ハンドリングのフロー説明であるため、Serviceクラスを呼び出すまでのフローに関する説明は、省略する。</div>
</div>
<ol class="arabic simple">
<li><a class="reference internal" href="#exception-handling-basic-flow-catch-label"><span class="std std-ref">リクエスト単位でControllerクラスがハンドリングする場合の基本フロー</span></a></li>
<li><a class="reference internal" href="#exception-handling-basic-flow-annotation-label"><span class="std std-ref">ユースケース単位でControllerクラスがハンドリングする場合の基本フロー</span></a></li>
<li><a class="reference internal" href="#exception-handling-basic-flow-resolver-label"><span class="std std-ref">サーブレット単位でフレームワークがハンドリングする場合の基本フロー</span></a></li>
<li><a class="reference internal" href="#exception-handling-basic-flow-container-label"><span class="std std-ref">Webアプリケーション単位でサーブレットコンテナがハンドリングする場合の基本フロー</span></a></li>
</ol>
<div class="section" id="controller">
<span id="exception-handling-basic-flow-catch-label"></span><h4><a class="toc-backref" href="#id78">4.2.2.3.1. リクエスト単位でControllerクラスがハンドリングする場合の基本フロー</a><a class="headerlink" href="#controller" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">例外をリクエスト単位でハンドリングする場合、Controllerクラスのアプリケーションコードで捕捉(try-catch)し、例外処理を行う。</div>
<div class="line">基本フローは、以下の通りである。</div>
<div class="line">下記の図は、 共通ライブラリから提供しているビジネス例外(<code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.exception.BusinessException</span></code>)をハンドリングする場合の基本フローである。</div>
<div class="line">ログは、結果メッセージを保持している例外が発生したことを記録するインタセプタ(<code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.exception.ResultMessagesLoggingInterceptor</span></code>)を使用して、出力する。</div>
</div>
<div class="figure align-center" id="id51">
<a class="reference internal image-reference" href="../../_images/exception-handling-flow-catch.png"><img alt="flow of exception handling using catch" src="../../_images/exception-handling-flow-catch.png" style="width: 80%;" /></a>
<p class="caption"><span class="caption-text"><strong>図-リクエスト単位でControllerクラスがハンドリングする場合の基本フロー</strong></span></p>
</div>
<ol class="arabic simple" start="4">
<li>Serviceクラスにて、 BusinessExceptionを生成し、スローする。</li>
<li>ResultMessagesLoggingInterceptorは、 ExceptionLoggerを呼び出し、warnレベルのログ(監視ログとアプリケーションログ)を出力する。
ResultMessagesLoggingInterceptorはResultMessagesNotificationExceptionのサブ例外(BusinessException/ResourceNotFoundException)が発生した場合のみ、ログを出力するクラスである。</li>
<li><strong>Controllerクラスは、 BusinessExceptionを捕捉し、 BusinessExceptionに設定されているメッセージ情報(ResultMessage)を画面表示用にModelに設定する(6’)。</strong></li>
<li><strong>Controllerクラスは、遷移先のView名を返却する。</strong></li>
<li>DispatcherServletは、返却されたView名に対応するJSPを呼び出す。</li>
<li><strong>JSPは、MessagesPanelTagを使用して、メッセージ情報(ResultMessage)を取得し、メッセージ表示用のHTMLコードを生成する。</strong></li>
<li>JSPで生成されたレスポンスが表示される。</li>
</ol>
</div>
<div class="section" id="exception-handling-basic-flow-annotation-label">
<span id="id19"></span><h4><a class="toc-backref" href="#id79">4.2.2.3.2. ユースケース単位でControllerクラスがハンドリングする場合の基本フロー</a><a class="headerlink" href="#exception-handling-basic-flow-annotation-label" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">例外をユースケース単位でハンドリングする場合、Controllerクラスの<code class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></code>を使って捕捉し、例外処理を行う。</div>
<div class="line">基本フローは、以下の通りである。</div>
<div class="line">下記の図は、 任意の例外(<code class="docutils literal"><span class="pre">XxxException</span></code>)をハンドリングする場合の、基本フローである。</div>
<div class="line">ログは、HandlerExceptionResolverによって、例外ハンドリングすることを記録するインタセプタ(<code class="docutils literal"><span class="pre">org.terasoluna.gfw.web.exception.HandlerExceptionResolverLoggingInterceptor</span></code>)を使用して、出力する。</div>
</div>
<div class="figure align-center" id="id52">
<a class="reference internal image-reference" href="../../_images/exception-handling-flow-annotation.png"><img alt="flow of exception handling using annotation" src="../../_images/exception-handling-flow-annotation.png" style="width: 80%;" /></a>
<p class="caption"><span class="caption-text"><strong>図-ユースケース単位で、Controllerクラスがハンドリングする場合の基本フロー</strong></span></p>
</div>
<ol class="arabic simple" start="3">
<li>Controllerクラスから呼び出されたServiceクラスにて、例外(XxxException)が発生する。</li>
<li>DispatcherServletは、XxxExceptionを捕捉し、ExceptionHandlerExceptionResolverを呼び出す。</li>
<li>ExceptionHandlerExceptionResolverは、Controllerクラスに用意されている例外ハンドリングメソッドを呼び出す。</li>
<li><strong>Controllerクラスは、メッセージ情報(ResultMessage)を生成し、画面表示用としてModelに設定する。</strong></li>
<li><strong>Controllerクラスは、遷移先のView名を返却する。</strong></li>
<li>ExceptionHandlerExceptionResolverは、Controllerより返却されたView名を返却する。</li>
<li>HandlerExceptionResolverLoggingInterceptorは、ExceptionLoggerを呼び出し、HTTPステータスコードに対応するレベル(info, warn, error)のログ(監視ログとアプリケーションログ)を出力する。</li>
<li>HandlerExceptionResolverLoggingInterceptorは、ExceptionHandlerExceptionResolverより返却されたView名を返却する。</li>
<li>DispatcherServletは、返却されたView名に対応するJSPを呼び出す。</li>
<li><strong>JSPは、MessagesPanelTagを使用して、メッセージ情報(ResultMessage)を取得し、メッセージ表示用のHTMLコードを生成する。</strong></li>
<li>JSPで生成されたレスポンスが表示される。</li>
</ol>
</div>
<div class="section" id="exception-handling-basic-flow-resolver-label">
<span id="id20"></span><h4><a class="toc-backref" href="#id80">4.2.2.3.3. サーブレット単位でフレームワークがハンドリングする場合の基本フロー</a><a class="headerlink" href="#exception-handling-basic-flow-resolver-label" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">例外をフレームワーク(サーブレット単位)でハンドリングする場合、SystemExceptionResolverで捕捉し例外処理を行う。</div>
<div class="line">基本フローは、以下の通りである。</div>
<div class="line">下記の図は、 共通ライブラリから提供しているシステム例外(<code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.exception.SystemException</span></code>)を、<code class="docutils literal"><span class="pre">org.terasoluna.gfw.web.exception.SystemExceptionResolver</span></code>を使ってハンドリングする場合の基本フローである。</div>
<div class="line">ログは、例外ハンドリングメソッドの引数に指定された例外を記録するインタセプタ(<code class="docutils literal"><span class="pre">org.terasoluna.gfw.web.exception.HandlerExceptionResolverLoggingInterceptor</span></code>)を使用して、出力する。</div>
</div>
<div class="figure align-center" id="id53">
<a class="reference internal image-reference" href="../../_images/exception-handling-flow-resolver.png"><img alt="flow of exception handling using resolver" src="../../_images/exception-handling-flow-resolver.png" style="width: 80%;" /></a>
<p class="caption"><span class="caption-text"><strong>図-サーブレット単位でフレームワークがハンドリングする場合の基本フロー</strong></span></p>
</div>
<ol class="arabic simple" start="4">
<li>Serviceクラスにて、システム例外に該当する状態を検知したため、SystemExceptionを発生させる。</li>
<li>DispatcherServletは、SystemExceptionを捕捉し、SystemExceptionResolverを呼び出す。</li>
<li>SystemExceptionResolverは、SystemExceptionから例外コードを取得し、画面表示用にHttpServletRequestに設定する(6’)。</li>
<li>SystemExceptionResolverは、SystemException発生時の遷移先のView名を返却する。</li>
<li>HandlerExceptionResolverLoggingInterceptorは、ExceptionLoggerを呼び出し、HTTPステータスコードに対応するレベル(info, warn, error)のログ(監視ログとアプリケーションログ)を出力する。</li>
<li>HandlerExceptionResolverLoggingInterceptorは、SystemExceptionResolverより返却されたView名を返却する。</li>
<li>DispatcherServletは、返却されたView名に対応するJSPを呼び出す。</li>
<li><strong>JSPは、HttpServletRequestより例外コードを取得し、メッセージ表示用のHTMLコードに埋め込む。</strong></li>
<li>JSPで生成されたレスポンスが表示される。</li>
</ol>
</div>
<div class="section" id="web">
<span id="exception-handling-basic-flow-container-label"></span><h4><a class="toc-backref" href="#id81">4.2.2.3.4. Webアプリケーション単位でサーブレットコンテナがハンドリングする場合の基本フロー</a><a class="headerlink" href="#web" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">例外をWebアプリケーション単位でハンドリングする場合、サーブレットコンテナで捕捉し、例外処理を行う。</div>
<div class="line">致命的なエラー、フレームワークでハンドリング対象となっていない例外(JSP内で発生した例外など)、Filterで発生した例外をハンドリングする。</div>
<div class="line">基本フローは以下の通りである。</div>
<div class="line">下記フローは、java.lang.Exceptionを、”error page”でハンドリングする場合のフローである。</div>
<div class="line">ログ出力は、ハンドリングされていない例外が発生したことを記録するサーブレットフィルタ(<code class="docutils literal"><span class="pre">org.terasoluna.gfw.web.exception.ExceptionLoggingFilter</span></code>)を使用して、出力する。</div>
</div>
<div class="figure align-center" id="id54">
<a class="reference internal image-reference" href="../../_images/exception-handling-flow-container.png"><img alt="flow of exception handling using container" src="../../_images/exception-handling-flow-container.png" style="width: 80%;" /></a>
<p class="caption"><span class="caption-text"><strong>図-Webアプリケーション単位でサーブレットコンテナがハンドリングする場合の基本フロー</strong></span></p>
</div>
<ol class="arabic simple" start="4">
<li>DispatcherServletは、XxxErrorを捕捉し、ServletExceptionにラップしてスローする。</li>
<li>ExceptionLoggingFilterは、ServletExceptionを捕捉し、ExceptionLoggerを呼び出す。ExceptionLoggerは、errorレベルのログ(監視ログとアプリケーションログ)を出力する。ExceptionLoggingFilterは、ServletExceptionを再スローする。</li>
<li>ServletContainerは、ServletExceptionを捕捉し、サーバログにログを出力する。ログのレベルは、アプリケーションサーバによって異なる。</li>
<li>ServletContainerは、<code class="docutils literal"><span class="pre">web.xml</span></code> に定義されている遷移先(HTMLなど)を呼び出す。</li>
<li>呼び出された遷移先で生成されたレスポンスが表示される。</li>
</ol>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-use">
<span id="exception-handling-how-to-use-label"></span><h2><a class="toc-backref" href="#id82">4.2.3. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<p>例外ハンドリング機能の使用方法について説明する。</p>
<p>共通ライブラリから提供している例外ハンドリング用のクラスについては、<a class="reference internal" href="#exception-handling-about-classes-of-library-label"><span class="std std-ref">共通ライブラリから提供している例外ハンドリング用のクラスについて</span></a>を参照されたい。</p>
<ol class="arabic simple">
<li><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-label"><span class="std std-ref">アプリケーションの設定</span></a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-service-label"><span class="std std-ref">コーディングポイント（Service編）</span></a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-controller-label"><span class="std std-ref">コーディングポイント（Controller編）</span></a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-jsp-label"><span class="std std-ref">コーディングポイント（JSP編）</span></a></li>
</ol>
<div class="section" id="exception-handling-how-to-use-application-configuration-label">
<span id="id21"></span><h3><a class="toc-backref" href="#id83">4.2.3.1. アプリケーションの設定</a><a class="headerlink" href="#exception-handling-how-to-use-application-configuration-label" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">例外ハンドリングを使用する際に、必要なアプリケーション設定を、以下に示す。</div>
<div class="line">なお、ブランクプロジェクトは、既に設定済みの状態になっているので、<strong>【プロジェクト毎にカスタマイズする箇所】</strong>の部分を変更すればよい。</div>
</div>
<ol class="arabic simple">
<li><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-common-label"><span class="std std-ref">共通設定</span></a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-domain-label"><span class="std std-ref">ドメイン層の設定</span></a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-app-label"><span class="std std-ref">アプリケーション層の設定</span></a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-container-label"><span class="std std-ref">サーブレットコンテナの設定</span></a></li>
</ol>
<div class="section" id="exception-handling-how-to-use-application-configuration-common-label">
<span id="id22"></span><h4><a class="toc-backref" href="#id84">4.2.3.1.1. 共通設定</a><a class="headerlink" href="#exception-handling-how-to-use-application-configuration-common-label" title="Permalink to this headline">¶</a></h4>
<p>１． 例外のログ出力を行うロガークラス（<code class="docutils literal"><span class="pre">ExceptionLogger</span></code>）を、bean定義に追加する。</p>
<ul class="simple">
<li><strong>applicationContext.xml</strong></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- Exception Code Resolver. --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;exceptionCodeResolver&quot;</span>
<span class="hll">    <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.common.exception.SimpleMappingExceptionCodeResolver&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
</span>    <span class="c">&lt;!-- Setting and Customization by project. --&gt;</span>
<span class="hll">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionMappings&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
</span>        <span class="nt">&lt;map&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;ResourceNotFoundException&quot;</span> <span class="na">value=</span><span class="s">&quot;e.xx.fw.5001&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;BusinessException&quot;</span> <span class="na">value=</span><span class="s">&quot;e.xx.fw.8001&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/map&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="hll">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultExceptionCode&quot;</span> <span class="na">value=</span><span class="s">&quot;e.xx.fw.9001&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- Exception Logger. --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;exceptionLogger&quot;</span>
<span class="hll">    <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.common.exception.ExceptionLogger&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionCodeResolver&quot;</span> <span class="na">ref=</span><span class="s">&quot;exceptionCodeResolver&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (5) --&gt;</span>
</span><span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ExceptionCodeResolver</span></code>を、bean定義に追加する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">ハンドリング対象とする例外名と、適用する「例外コード(メッセージID)」のマッピングを指定する。</div>
<div class="line">上記の設定例では、例外クラス(又は親クラス)のクラス名に、”BusinessException”が含まれている場合は、”e.xx.fw.8001”、 “ResourceNotFoundException”が含まれている場合は、”e.xx.fw.5001”が「例外コード(メッセージID)」となる。</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>例外コード(メッセージID)について</strong></p>
<p class="last">ここでは、”BusinessException”に、メッセージIDが指定されなかった場合の対応で定義をしているが、
後述の”BusinessException”を発生させる実装側で、メッセージIDを指定することを推奨する。
“BusinessException”に対する「例外コード(メッセージID)」の指定は、”BusinessException”発生時に指定されなかった場合の救済策である。</p>
</div>
<div class="last line-block">
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">デフォルトの「例外コード(メッセージID)」を指定する。</div>
<div class="line">上記の設定例では、例外クラス(または親クラス)のクラス名に”BusinessException”、または”ResourceNotFoundException”が含まれない場合、”e.xx.fw.9001”が例外コード(メッセージID)」となる。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
<div class="last admonition note">
<p class="first admonition-title">Note</p>
<p><strong>例外コード(メッセージID)について</strong></p>
<p class="last">例外コードは、ExceptionLoggerによりログに出力される。（画面での取得も可能である。View(JSP)から例外コードを参照する方法については、<a class="reference internal" href="#exception-handling-how-to-use-codingpoint-view-exceptioncode-label"><span class="std std-ref">システム例外の例外コードを、画面表示する方法</span></a>を参照されたい。）
またコード体系については、プロパティに定義している形式でなくともよい。
例えば、MA7001等</p>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ExceptionLogger</span></code>を、bean定義に追加する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ExceptionCodeResolver</span></code>をDIする。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>２． ログ定義を追加する。</p>
<ul class="simple">
<li><strong>logback.xml</strong></li>
</ul>
<blockquote>
<div><p>監視ログ用のログ定義を追加する。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="hll"><span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">&quot;MONITORING_LOG_FILE&quot;</span> <span class="na">class=</span><span class="s">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
</span>    <span class="nt">&lt;file&gt;</span>${app.log.dir:-log}/projectName-monitoring.log<span class="nt">&lt;/file&gt;</span>
    <span class="nt">&lt;rollingPolicy</span> <span class="na">class=</span><span class="s">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;fileNamePattern&gt;</span>${app.log.dir:-log}/projectName-monitoring-%d{yyyyMMdd}.log<span class="nt">&lt;/fileNamePattern&gt;</span>
        <span class="nt">&lt;maxHistory&gt;</span>7<span class="nt">&lt;/maxHistory&gt;</span>
    <span class="nt">&lt;/rollingPolicy&gt;</span>
    <span class="nt">&lt;encoder&gt;</span>
        <span class="nt">&lt;charset&gt;</span>UTF-8<span class="nt">&lt;/charset&gt;</span>
        <span class="nt">&lt;pattern&gt;</span><span class="cp">&lt;![CDATA[date:%d{yyyy-MM-dd HH:mm:ss}\tX-Track:%X{X-Track}\tlevel:%-5level\tmessage:%msg%n]]&gt;</span><span class="nt">&lt;/pattern&gt;</span>
    <span class="nt">&lt;/encoder&gt;</span>
<span class="nt">&lt;/appender&gt;</span>

<span class="hll"><span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;org.terasoluna.gfw.common.exception.ExceptionLogger.Monitoring&quot;</span> <span class="na">additivity=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;error&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">&quot;MONITORING_LOG_FILE&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
</span><span class="nt">&lt;/logger&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">監視ログを出力するための、appender定義を指定する。上記の設定例では、ファイルに出力するappenderとしているが、システム要件に一致するappenderを使うこと。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">監視ログ用の、ロガー定義を指定する。ExceptionLoggerを作成する際に、任意のロガー名を指定していない場合は、上記設定のままでよい。</div>
</div>
<div class="last admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>additivityの設定値について</strong></p>
<p class="last"><code class="docutils literal"><span class="pre">false</span></code>を指定すること。<code class="docutils literal"><span class="pre">true</span></code>を指定すると、上位のロガー(例えば、root)によって、同じログが出力されてしまう。</p>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">出力レベルを指定する。ExceptionLoggerではinfo, warn, errorの3種類のログを出力しているが、システム要件にあったレベルを指定すること。errorレベルを推奨する。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">出力先となるappenderを指定する。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
</td>
</tr>
</tbody>
</table>
<p>アプリケーションログ用のログ定義を追加する。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="hll"><span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">&quot;APPLICATION_LOG_FILE&quot;</span> <span class="na">class=</span><span class="s">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
</span>    <span class="nt">&lt;file&gt;</span>${app.log.dir:-log}/projectName-application.log<span class="nt">&lt;/file&gt;</span>
    <span class="nt">&lt;rollingPolicy</span> <span class="na">class=</span><span class="s">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;fileNamePattern&gt;</span>${app.log.dir:-log}/projectName-application-%d{yyyyMMdd}.log<span class="nt">&lt;/fileNamePattern&gt;</span>
        <span class="nt">&lt;maxHistory&gt;</span>7<span class="nt">&lt;/maxHistory&gt;</span>
    <span class="nt">&lt;/rollingPolicy&gt;</span>
    <span class="nt">&lt;encoder&gt;</span>
        <span class="nt">&lt;charset&gt;</span>UTF-8<span class="nt">&lt;/charset&gt;</span>
        <span class="nt">&lt;pattern&gt;</span><span class="cp">&lt;![CDATA[date:%d{yyyy-MM-dd HH:mm:ss}\tthread:%thread\tX-Track:%X{X-Track}\tlevel:%-5level\tlogger:%-48logger{48}\tmessage:%msg%n]]&gt;</span><span class="nt">&lt;/pattern&gt;</span>
    <span class="nt">&lt;/encoder&gt;</span>
<span class="nt">&lt;/appender&gt;</span>

<span class="hll"><span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;org.terasoluna.gfw.common.exception.ExceptionLogger&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
</span>    <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;info&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/logger&gt;</span>

<span class="nt">&lt;root</span> <span class="na">level=</span><span class="s">&quot;warn&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">&quot;STDOUT&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">&quot;APPLICATION_LOG_FILE&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;/root&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アプリケーションログを出力するための、appender定義を指定する。上記の設定例では、ファイルに出力するappenderとしているが、システム要件に一致するappenderを使うこと。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">アプリケーションログ用の、ロガー定義を指定する。ExceptionLoggerを作成する際に、任意のロガー名を指定していない場合は、上記設定のままでよい。</div>
</div>
<div class="last admonition note">
<p class="first admonition-title">Note</p>
<p><strong>アプリケーションログ出力用のappender定義について</strong></p>
<p class="last">アプリケーションログ用のappenderは、例外出力用に個別に定義するのではなく、フレームワークや、アプリケーションコードで出力するログ用のappenderと、同じものを使うことを推奨する。
同じ出力先にすることで、例外が発生するまでの過程が追いやすくなる。</p>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">出力レベルを指定する。ExceptionLoggerでは、info, warn, errorの3種類のログを出力しているが、システム要件にあったレベルを指定すること。本ガイドラインでは、infoレベルを推奨する。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(2)で設定したロガーは、appenderを指定していないので、rootに流れる。そのため、出力先となるappenderを指定する。ここでは、”STDOUT”と”APPLICATION_LOG_FILE”に出力される。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="exception-handling-how-to-use-application-configuration-domain-label">
<span id="id23"></span><h4><a class="toc-backref" href="#id85">4.2.3.1.2. ドメイン層の設定</a><a class="headerlink" href="#exception-handling-how-to-use-application-configuration-domain-label" title="Permalink to this headline">¶</a></h4>
<p>ResultMessagesを保持する例外(BisinessException,ResourceNotFoundException)が発生した際に、ログを出力するためのインタセプタクラス（<code class="docutils literal"><span class="pre">ResultMessagesLoggingInterceptor</span></code>）と、AOPの設定を、bean定義に追加する。</p>
<ul class="simple">
<li><strong>xxx-domain.xml</strong></li>
</ul>
<blockquote id="exception-handling-how-to-use-service-pointcut-aop-label">
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- interceptor bean. --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;resultMessagesLoggingInterceptor&quot;</span>
<span class="hll">      <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.common.exception.ResultMessagesLoggingInterceptor&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">      <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionLogger&quot;</span> <span class="na">ref=</span><span class="s">&quot;exceptionLogger&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- setting AOP. --&gt;</span>
<span class="nt">&lt;aop:config&gt;</span>
    <span class="nt">&lt;aop:advisor</span> <span class="na">advice-ref=</span><span class="s">&quot;resultMessagesLoggingInterceptor&quot;</span>
<span class="hll">                 <span class="na">pointcut=</span><span class="s">&quot;@within(org.springframework.stereotype.Service)&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="nt">&lt;/aop:config&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ResultMessagesLoggingInterceptor</span></code>を、bean定義に追加する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例外のログ出力を行うロガーオブジェクトをDIする。<code class="docutils literal"><span class="pre">applicationContext.xml</span></code>に定義している “exceptionLogger” を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Serviceクラス(<code class="docutils literal"><span class="pre">&#64;Service</span></code>アノテーションが付いているクラス)のメソッドに対して、ResultMessagesLoggingInterceptorを適用する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="exception-handling-how-to-use-application-configuration-app-label">
<span id="id24"></span><h4><a class="toc-backref" href="#id86">4.2.3.1.3. アプリケーション層の設定</a><a class="headerlink" href="#exception-handling-how-to-use-application-configuration-app-label" title="Permalink to this headline">¶</a></h4>
<p>&lt;mvc:annotation-driven&gt; を指定した際に、自動的に登録されるHandlerExceptionResolverによって、ハンドリングされない例外をハンドリングするためのクラス（<code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>）を、bean定義に追加する。</p>
<ul class="simple">
<li><strong>spring-mvc.xml</strong></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- Setting Exception Handling. --&gt;</span>
<span class="c">&lt;!-- Exception Resolver. --&gt;</span>
<span class="hll"><span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.SystemExceptionResolver&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionCodeResolver&quot;</span> <span class="na">ref=</span><span class="s">&quot;exceptionCodeResolver&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
</span>    <span class="c">&lt;!-- Setting and Customization by project. --&gt;</span>
<span class="hll">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;order&quot;</span> <span class="na">value=</span><span class="s">&quot;3&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionMappings&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
</span>        <span class="nt">&lt;map&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;ResourceNotFoundException&quot;</span> <span class="na">value=</span><span class="s">&quot;common/error/resourceNotFoundError&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;BusinessException&quot;</span> <span class="na">value=</span><span class="s">&quot;common/error/businessError&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;InvalidTransactionTokenException&quot;</span> <span class="na">value=</span><span class="s">&quot;common/error/transactionTokenError&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;.DataAccessException&quot;</span> <span class="na">value=</span><span class="s">&quot;common/error/dataAccessError&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/map&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="hll">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;statusCodes&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (5) --&gt;</span>
</span>        <span class="nt">&lt;map&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;common/error/resourceNotFoundError&quot;</span> <span class="na">value=</span><span class="s">&quot;404&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;common/error/businessError&quot;</span> <span class="na">value=</span><span class="s">&quot;409&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;common/error/transactionTokenError&quot;</span> <span class="na">value=</span><span class="s">&quot;409&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;common/error/dataAccessError&quot;</span> <span class="na">value=</span><span class="s">&quot;500&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/map&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="hll">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;excludedExceptions&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (6) --&gt;</span>
</span>        <span class="nt">&lt;array&gt;</span>
            <span class="nt">&lt;value&gt;</span>org.springframework.web.util.NestedServletException<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/array&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="hll">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultErrorView&quot;</span> <span class="na">value=</span><span class="s">&quot;common/error/systemError&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (7) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultStatusCode&quot;</span> <span class="na">value=</span><span class="s">&quot;500&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (8) --&gt;</span>
</span><span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- Settings View Resolver. --&gt;</span>
<span class="nt">&lt;mvc:view-resolvers&gt;</span>
<span class="hll">    <span class="nt">&lt;mvc:jsp</span> <span class="na">prefix=</span><span class="s">&quot;/WEB-INF/views/&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (9) --&gt;</span>
</span><span class="nt">&lt;/mvc:view-resolvers&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>を、bean定義に追加する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例外コード(メッセージID)を解決するオブジェクトをDIする。<code class="docutils literal"><span class="pre">applicationContext.xml</span></code>に定義している、”exceptionCodeResolver”を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">ハンドリングの優先順位を指定する。値は、基本的に「3」で良い。<code class="docutils literal"><span class="pre">&lt;mvc:annotation-driven&gt;</span></code>を指定した際に、自動的に、<a class="reference internal" href="#exceptionhandling-annotation-driven"><span class="std std-ref">登録されるクラス</span></a>の方が、優先順位が上となる。</div>
</div>
<div class="last admonition hint">
<p class="first admonition-title">Hint</p>
<p><strong>DefaultHandlerExceptionResolverで行われる例外ハンドリングを無効化する方法</strong></p>
<p class="last"><code class="docutils literal"><span class="pre">DefaultHandlerExceptionResolver</span></code>で例外ハンドリングされた場合、HTTPレスポンスコードは設定されるが、Viewの解決がされないため、Viewの解決は、<code class="docutils literal"><span class="pre">web.xml</span></code>のError Pageで行う必要がある。
Viewの解決を<code class="docutils literal"><span class="pre">web.xml</span></code>ではなく、<code class="docutils literal"><span class="pre">HandlerExceptionResolver</span></code>で行いたい場合は、<code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>の優先順位を「1」にすると、<code class="docutils literal"><span class="pre">DefaultHandlerExceptionResolver</span></code>より前にハンドリング処理を実行することができる。
<code class="docutils literal"><span class="pre">DefaultHandlerExceptionResolver</span></code>でハンドリングされた場合の、HTTPレスポンスコードのマッピングについては、<a class="reference internal" href="#exception-handling-appendix-defaulthandlerexceptionresolver-label"><span class="std std-ref">DefaultHandlerExceptionResolverで設定されるHTTPレスポンスコードについて</span></a>を参照されたい。</p>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ハンドリング対象とする例外名と、遷移先となるView名のマッピングを指定する。</div>
<div class="line">上記の設定では、例外クラス(または親クラス)のクラス名に”.DataAccessException”が含まれている場合、”common/error/dataAccessError”が、遷移先のView名となる。</div>
<div class="line">例外クラスが”ResourceNotFoundException”の場合、”common/error/resourceNotFoundError”が、遷移先のView名となる。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">遷移先となるView名と、HTTPステータスコードのマッピングを指定する。</div>
<div class="line">上記の設定では、View名が”common/error/resourceNotFoundError”の場合に、”404(Not Found)”がHTTPステータスコードとなる。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ハンドリング対象外とする例外クラスを指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>で致命的なエラーをハンドリングせず、サーブレットコンテナに通知するため、<code class="docutils literal"><span class="pre">org.springframework.web.util.NestedServletException</span></code>をハンドリング対象外とする。</div>
<div class="line">ハンドリング対象外にする理由は、<a class="reference internal" href="#exception-handling-class-fatalerror-warning"><span class="std std-ref">「&#64;ExceptionHandlerとSystemExceptionResolverによる致命的なエラーのハンドリングついて」</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">遷移するデフォルトのView名を、指定する。</div>
<div class="line">上記の設定では、例外クラスに”ResourceNotFoundException”、”BusinessException”、”InvalidTransactionTokenException”や例外クラス(または親クラス)のクラス名に、”.DataAccessException”が含まれない場合、”common/error/systemError”が、遷移先のView名となる。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">レスポンスヘッダに設定するHTTPステータスコードのデフォルト値を指定する。 <strong>“500”(Internal Server Error)</strong> を設定することを推奨する。</div>
</div>
<div class="last admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>指定を省略した場合の挙動</strong></p>
<p class="last"><strong>“200”(OK)</strong>扱いになるので、注意すること。</p>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><p class="first">実際に遷移する<code class="docutils literal"><span class="pre">View</span></code>は、<code class="docutils literal"><span class="pre">ViewResolver</span></code>の設定に依存する。</p>
<p>上記の設定では、</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">/WEB-INF/views/common/error/systemError.jsp</span></code></li>
<li><code class="docutils literal"><span class="pre">/WEB-INF/views/common/error/resourceNotFoundError.jsp</span></code></li>
<li><code class="docutils literal"><span class="pre">/WEB-INF/views/common/error/businessError.jsp</span></code></li>
<li><code class="docutils literal"><span class="pre">/WEB-INF/views/common/error/transactionTokenError.jsp</span></code></li>
<li><code class="docutils literal"><span class="pre">/WEB-INF/views/common/error/dataAccessError.jsp</span></code></li>
</ul>
<p class="last">が遷移先となる。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><code class="docutils literal"><span class="pre">HandlerExceptionResolver</span></code>でハンドリングされた例外を、ログに出力するためのインタセプタクラス（<code class="docutils literal"><span class="pre">HandlerExceptionResolverLoggingInterceptor</span></code>）と、AOPの設定を、bean定義に追加する。</p>
<ul class="simple">
<li><strong>spring-mvc.xml</strong></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- Setting AOP. --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;handlerExceptionResolverLoggingInterceptor&quot;</span>
<span class="hll">    <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.HandlerExceptionResolverLoggingInterceptor&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionLogger&quot;</span> <span class="na">ref=</span><span class="s">&quot;exceptionLogger&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;aop:config&gt;</span>
    <span class="nt">&lt;aop:advisor</span> <span class="na">advice-ref=</span><span class="s">&quot;handlerExceptionResolverLoggingInterceptor&quot;</span>
<span class="hll">        <span class="na">pointcut=</span><span class="s">&quot;execution(* org.springframework.web.servlet.HandlerExceptionResolver.resolveException(..))&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="nt">&lt;/aop:config&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">HandlerExceptionResolverLoggingInterceptor</span></code>を、bean定義に追加する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例外のログ出力を行うロガーオブジェクトを、DIする。<code class="docutils literal"><span class="pre">applicationContext.xml</span></code>に定義している”exceptionLogger”を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">HandlerExceptionResolver</span></code>インタフェースのresolveExceptionメソッドに対して、<code class="docutils literal"><span class="pre">HandlerExceptionResolverLoggingInterceptor</span></code>を適用する。</div>
<div class="line"><br /></div>
<div class="line">デフォルトの設定では、共通ライブラリから提供している <code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.exception.ResultMessagesNotificationException</span></code> のサブクラスの例外は、このクラスで行われるログ出力の対象外となっている。</div>
<div class="line"><code class="docutils literal"><span class="pre">ResultMessagesNotificationException</span></code> のサブクラスの例外をログ出力対象外としている理由は、 <code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.exception.ResultMessagesLoggingInterceptor</span></code> によってログ出力されるためである。</div>
<div class="line">デフォルトの設定を変更する必要がある場合は、 <a class="reference internal" href="#exception-handling-about-handlerexceptionresolverlogginginterceptor"><span class="std std-ref">HandlerExceptionResolverLoggingInterceptorの設定項目について</span></a> を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>致命的なエラー、Spring MVC管理外で発生する例外を、ログに出力するためのFilterクラス（<code class="docutils literal"><span class="pre">ExceptionLoggingFilter</span></code>）を、bean定義と<code class="docutils literal"><span class="pre">web.xml</span></code>に追加する。</p>
<ul class="simple">
<li><strong>applicationContext.xml</strong></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- Filter. --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;exceptionLoggingFilter&quot;</span>
<span class="hll">    <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.ExceptionLoggingFilter&quot;</span> <span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionLogger&quot;</span> <span class="na">ref=</span><span class="s">&quot;exceptionLogger&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ExceptionLoggingFilter</span></code>を、bean定義に追加する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例外のログ出力を行うロガーオブジェクトを、DIする。<code class="docutils literal"><span class="pre">applicationContext.xml</span></code>に定義している”exceptionLogger”を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><strong>web.xml</strong></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;filter&gt;</span>
<span class="hll">    <span class="nt">&lt;filter-name&gt;</span>exceptionLoggingFilter<span class="nt">&lt;/filter-name&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;filter-class&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="nt">&lt;/filter-class&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="nt">&lt;/filter&gt;</span>
<span class="nt">&lt;filter-mapping&gt;</span>
<span class="hll">    <span class="nt">&lt;filter-name&gt;</span>exceptionLoggingFilter<span class="nt">&lt;/filter-name&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
</span><span class="nt">&lt;/filter-mapping&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フィルター名を指定する。<code class="docutils literal"><span class="pre">applicationContext.xml</span></code>に定義した<code class="docutils literal"><span class="pre">ExceptionLoggingFilter</span></code>のbean名と、一致させる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フィルタークラスを指定する。<code class="docutils literal"><span class="pre">org.springframework.web.filter.DelegatingFilterProxy</span></code>固定。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">マッピングするフィルターのフィルター名を指定する。(1)で指定した値。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フィルターを適用するURLパターンを指定する。致命的なエラー、Spring MVC管理外をログ出力するため、<code class="docutils literal"><span class="pre">/*</span></code>を推奨する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>出力ログ</li>
</ul>
<blockquote>
<div><div class="highlight-text"><div class="highlight"><pre><span></span>date:2013-09-25 19:51:52    thread:tomcat-http--3   X-Track:f94de92148f1489b9ceeac3b2f17c969        level:ERROR     logger:o.t.gfw.common.exception.ExceptionLogger         message:[e.xx.fw.9001] An exception occurred processing JSP page /WEB-INF/views/exampleJSPException.jsp at line 13
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="exception-handling-how-to-use-application-configuration-container-label">
<span id="id25"></span><h4><a class="toc-backref" href="#id87">4.2.3.1.4. サーブレットコンテナの設定</a><a class="headerlink" href="#exception-handling-how-to-use-application-configuration-container-label" title="Permalink to this headline">¶</a></h4>
<p>Spring MVCの、デフォルトの例外ハンドリング機能によって行われるエラー応答（HttpServletResponse#sendError）、致命的なエラー、Spring MVC管理外で発生する例外をハンドリングするために、サーブレットコンテナのError Page定義を追加する。</p>
<ul class="simple">
<li><strong>web.xml</strong></li>
</ul>
<blockquote>
<div><p>Spring MVCの、デフォルトの例外ハンドリング機能によって行われるエラー応答（HttpServletResponse#sendError）を、ハンドリングするための定義を追加する。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;error-page&gt;</span>
    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;error-code&gt;</span>404<span class="nt">&lt;/error-code&gt;</span>
    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;location&gt;</span>/WEB-INF/views/common/error/resourceNotFoundError.jsp<span class="nt">&lt;/location&gt;</span>
<span class="nt">&lt;/error-page&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ハンドリング対象とする <strong>HTTPレスポンスコード</strong> を指定する。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
<div class="line">Spring MVCの、デフォルトの例外ハンドリング機能で応答されるHTTPレスポンスコードについては、<a class="reference internal" href="#exception-handling-appendix-defaulthandlerexceptionresolver-label"><span class="std std-ref">DefaultHandlerExceptionResolverで設定されるHTTPレスポンスコードについて</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">遷移するファイル名を指定する。Webアプリケーションルートからのパスで、指定する。上記の設定では、”${WebAppRoot}/WEB-INF/views/common/error/resourceNotFoundError.jsp”が、遷移先のファイルとなる。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
</td>
</tr>
</tbody>
</table>
<p>致命的なエラー、Spring MVC管理外で発生する例外をハンドリングするための定義を追加する。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;error-page&gt;</span>
    <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;location&gt;</span>/WEB-INF/views/common/error/unhandledSystemError.html<span class="nt">&lt;/location&gt;</span>
<span class="nt">&lt;/error-page&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">遷移するファイル名を指定する。Webアプリケーションルートからのパスで指定する。上記の設定では、”${WebAppRoot}/WEB-INF/views/common/error/unhandledSystemError.html”が、遷移先のファイルとなる。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>locationに指定するパスについて</strong></p>
<p class="last">動的コンテンツのパスを指定した場合、致命的なエラーが発生していた場合に、別のエラーが発生する可能性が高くなるため、
locationには、JSPなどの動的コンテンツでなく、 <strong>HTMLなどの静的コンテンツへのパスを指定することを推奨する。</strong></p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>開発中に原因が特定できないエラーが発生した場合</strong></p>
<p>上記の設定が行われている状態で想定外のエラー応答（HttpServletResponse#sendError）が発生した場合、どのようなエラー応答が発生したのか特定できないケースがある。</p>
<p>locationタグに指定したエラー画面が表示されるが、ログなどからエラーの原因を特定できない場合は、
上記設定をコメントアウトして動かすことで、発生したエラー応答(HTTPレスポンスコード)を、画面で確認することできる。</p>
<p>Spring MVC管理外で発生する例外を、個別にハンドリングする必要がある場合は、例外毎の定義を追加する。</p>
<blockquote class="last">
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;error-page&gt;</span>
    <span class="c">&lt;!-- (4) --&gt;</span>
    <span class="nt">&lt;exception-type&gt;</span>java.io.IOException<span class="nt">&lt;/exception-type&gt;</span>
    <span class="c">&lt;!-- (5) --&gt;</span>
    <span class="nt">&lt;location&gt;</span>/WEB-INF/views/common/error/systemError.jsp<span class="nt">&lt;/location&gt;</span>
<span class="nt">&lt;/error-page&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ハンドリング対象とする <strong>例外クラス名(FQCN)</strong> を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">遷移するファイル名を指定する。Webアプリケーションルートからのパスで指定する。上記の設定では、”${WebAppRoot}/WEB-INF/views/common/error/systemError.jsp”が遷移先のファイルとなる。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div>
</div>
<div class="section" id="service">
<span id="exception-handling-how-to-use-codingpoint-service-label"></span><h3><a class="toc-backref" href="#id88">4.2.3.2. コーディングポイント（Service編）</a><a class="headerlink" href="#service" title="Permalink to this headline">¶</a></h3>
<p>例外ハンドリングを行う際の、Serviceでのコーディングポイントを、以下に示す。</p>
<ol class="arabic simple">
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-service-business-label"><span class="std std-ref">ビジネス例外を発生させる</span></a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-service-system-label"><span class="std std-ref">システム例外を発生させる</span></a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-service-continue-label"><span class="std std-ref">例外をキャッチして、処理を継続させる</span></a></li>
</ol>
<div class="section" id="exception-handling-how-to-use-codingpoint-service-business-label">
<span id="id26"></span><h4><a class="toc-backref" href="#id89">4.2.3.2.1. ビジネス例外を発生させる</a><a class="headerlink" href="#exception-handling-how-to-use-codingpoint-service-business-label" title="Permalink to this headline">¶</a></h4>
<p>ビジネス例外(BusinessException)の発生方法を、以下に示す。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>ビジネス例外の発生方法に関する注意事項</strong></p>
<ul class="last">
<li><div class="first line-block">
<div class="line">基本的には、ロジックでビジネスルールの違反を検知して、ビジネス例外を発生させる方法を推奨する。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">既存資材や、基盤機能(FWや共通機能)のAPI仕様として、ビジネスルールの違反が、例外によって通知される場合のみ、例外を捕捉してビジネス例外を発生させてもよい。</div>
<div class="line">例外を、処理フローを制御するために使用すると、処理全体の見通しが悪くなり、保守性を低下させる可能性がある。</div>
</div>
</li>
</ul>
</div>
<div class="line-block">
<div class="line">ロジックでビジネスルールの違反を検知して、ビジネス例外を発生させる。</div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<ul class="last simple">
<li>デフォルトでは、ビジネス例外は、Serviceで発生させることを想定している。<a class="reference internal" href="#exception-handling-how-to-use-service-pointcut-aop-label"><span class="std std-ref">AOPの設定</span></a>で、
<code class="docutils literal"><span class="pre">&#64;Service</span></code>アノテーションを付与したクラスで発生したビジネス例外のログを出力としている。
Controllerなどでビジネス例外は、ログを出力しない。プロジェクトでの考えがある場合は変更すること。</li>
</ul>
</div>
<ul class="simple">
<li>xxxService.java</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="p">...</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExampleExceptionServiceImpl</span> <span class="kd">implements</span> <span class="n">ExampleExceptionService</span> <span class="p">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">throwBisinessException</span><span class="p">(</span><span class="n">String</span> <span class="n">test</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="c1">// int stockQuantity = 5;</span>
        <span class="c1">// int orderQuantity = 6;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">stockQuantity</span> <span class="o">&lt;</span> <span class="n">orderQuantity</span><span class="p">)</span> <span class="p">{</span>                  <span class="c1">// (1)</span>
            <span class="n">ResultMessages</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="p">.</span><span class="na">error</span><span class="p">();</span> <span class="c1">// (2)</span>
            <span class="n">messages</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;e.ad.od.5001&quot;</span><span class="p">,</span> <span class="n">stockQuantity</span><span class="p">);</span>      <span class="c1">// (3)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="p">(</span><span class="n">messages</span><span class="p">);</span>            <span class="c1">// (4)</span>
        <span class="p">}</span>
        <span class="p">...</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ビジネスルールの違反がないか、チェックを行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">違反している場合、ResultMessagesを生成する。上記の実装例では、errorレベルのResultMessagesを生成している。</div>
<div class="line">ResultMessagesの生成方法の詳細については、<a class="reference internal" href="MessageManagement.html"><span class="doc">メッセージ管理</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ResultMessagesに、ResultMessageを追加する。第1引数(必須)にメッセージIDを、第2引数(任意)にメッセージ埋め込み値を指定する。</div>
<div class="line">メッセージ埋め込み値は、可変長パラメータなので、複数指定することができる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ResultMessagesを指定して、BusinessExceptionを発生させる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>上記の <code class="docutils literal"><span class="pre">xxxService.java</span></code> は説明用に(2)-(4)に分けて処理をしているが、1ステップで実装することができる。</p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="k">throw</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="p">(</span><span class="n">ResultMessages</span><span class="p">.</span><span class="na">error</span><span class="p">().</span><span class="na">add</span><span class="p">(</span>
     <span class="s">&quot;e.ad.od.5001&quot;</span><span class="p">,</span> <span class="n">stockQuantity</span><span class="p">));</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div></blockquote>
<ul>
<li><p class="first">xxx.properties</p>
<p>参考としてプロパティの設定を記述する。</p>
<div class="highlight-properties"><div class="highlight"><pre><span></span><span class="na">e.ad.od.5001</span> <span class="o">=</span> <span class="s">Order number is higher than the stock quantity={0}. Change the order number.</span>
</pre></div>
</div>
</li>
</ul>
<p>下記のようなアプリケーションログが出力される。</p>
<blockquote>
<div><div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">date:2013-09-17 22:25:55    thread:tomcat-http--8   X-Track:6cfb0b378c124b918e40ac0c32a1fac7        level:WARN      logger:o.t.gfw.common.exception.ExceptionLogger         message:[e.xx.fw.8001] ResultMessages [type=error, list=[ResultMessage [code=e.ad.od.5001, args=[5], text=null]]]</span>
<span class="go">org.terasoluna.gfw.common.exception.BusinessException: ResultMessages [type=error, list=[ResultMessage [code=e.ad.od.5001, args=[5], text=null]]]</span>

<span class="go">// stackTarace omitted</span>
<span class="go">...</span>

<span class="go">date:2013-09-17 22:25:55    thread:tomcat-http--8   X-Track:6cfb0b378c124b918e40ac0c32a1fac7        level:DEBUG     logger:o.t.gfw.web.exception.SystemExceptionResolver    message:Resolving exception from handler [public java.lang.String org.terasoluna.exception.app.example.ExampleExceptionController.home(java.util.Locale,org.springframework.ui.Model)]: org.terasoluna.gfw.common.exception.BusinessException: ResultMessages [type=error, list=[ResultMessage [code=e.ad.od.5001, args=[5], text=null]]]</span>
<span class="go">date:2013-09-17 22:25:55    thread:tomcat-http--8   X-Track:6cfb0b378c124b918e40ac0c32a1fac7        level:DEBUG     logger:o.t.gfw.web.exception.SystemExceptionResolver    message:Resolving to view &#39;common/error/businessError&#39; for exception of type [org.terasoluna.gfw.common.exception.BusinessException], based on exception mapping [BusinessException]</span>
<span class="go">date:2013-09-17 22:25:55    thread:tomcat-http--8   X-Track:6cfb0b378c124b918e40ac0c32a1fac7        level:DEBUG     logger:o.t.gfw.web.exception.SystemExceptionResolver    message:Applying HTTP status code 409</span>
<span class="go">date:2013-09-17 22:25:55    thread:tomcat-http--8   X-Track:6cfb0b378c124b918e40ac0c32a1fac7        level:DEBUG     logger:o.t.gfw.web.exception.SystemExceptionResolver    message:Exposing Exception as model attribute &#39;exception&#39;</span>
</pre></div>
</div>
</div></blockquote>
<p>表示される画面</p>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../../_images/exception-handling-screen-businessexception.png"><img alt="screen business exception" src="../../_images/exception-handling-screen-businessexception.png" style="width: 50%;" /></a>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">ビジネス例外は、Controllerでハンドリングし、各業務画面でメッセージを表示させることを推奨する。
上記例は、Controllerでハンドリングしなかった場合に、表示される画面となる。</p>
</div>
</div></blockquote>
<p>例外を捕捉して、ビジネス例外を発生させる</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="k">try</span> <span class="p">{</span>
    <span class="n">order</span><span class="p">(</span><span class="n">orderQuantity</span><span class="p">,</span> <span class="n">itemId</span> <span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">StockNotEnoughException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>                  <span class="c1">// (1)</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="p">(</span><span class="n">ResultMessages</span><span class="p">.</span><span class="na">error</span><span class="p">().</span><span class="na">add</span><span class="p">(</span>
            <span class="s">&quot;e.ad.od.5001&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="na">getStockQuantity</span><span class="p">()),</span> <span class="n">e</span><span class="p">);</span> <span class="c1">// (2)</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ビジネスルールに違反した際に、発生する例外を捕捉する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ResultMessagesと、<strong>原因例外(e)</strong>を指定して、BusinessExceptionを発生させる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="exception-handling-how-to-use-codingpoint-service-system-label">
<span id="id27"></span><h4><a class="toc-backref" href="#id90">4.2.3.2.2. システム例外を発生させる</a><a class="headerlink" href="#exception-handling-how-to-use-codingpoint-service-system-label" title="Permalink to this headline">¶</a></h4>
<p>システム例外(SystemException)の発生方法を、以下に示す。</p>
<p>ロジックで、システム異常を検知し、システム例外を発生させる。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">itemEntity</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>                                      <span class="c1">// (1)</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="n">SystemException</span><span class="p">(</span><span class="s">&quot;e.ad.od.9012&quot;</span><span class="p">,</span>
        <span class="s">&quot;not found item entity. item code [&quot;</span> <span class="o">+</span> <span class="n">itemId</span> <span class="o">+</span> <span class="s">&quot;].&quot;</span><span class="p">);</span> <span class="c1">// (2)</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">システムが、正常な状態であることをチェックする。</div>
<div class="line">ここでは、例として、リクエストされた商品コード（itemId）が、商品マスタ（Item Mastar）上に存在するかチェックし、</div>
<div class="line">存在しない場合、システムで用意するべきリソースがないと判断して、システムエラーにしている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">システムが異常な状態の場合、第1引数に例外コード(メッセージID)を指定する。第2引数に例外メッセージを指定して、SystemExceptionを発生させる。</div>
<div class="line">上記の実装例では、メッセージ本文に、変数”itemId”の値を埋め込んでいる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>下記のような、アプリケーションログが出力される。</p>
<blockquote>
<div><div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">date:2013-09-19 21:03:06      thread:tomcat-http--3   X-Track:c19eec546b054d54a13658f94292b24f        level:DEBUG     logger:o.t.gfw.web.exception.SystemExceptionResolver    message:Resolving exception from handler [public java.lang.String org.terasoluna.exception.app.example.ExampleExceptionController.home(java.util.Locale,org.springframework.ui.Model)]: org.terasoluna.gfw.common.exception.SystemException: not found item entity. item code [10-123456].</span>
<span class="go">date:2013-09-19 21:03:06      thread:tomcat-http--3   X-Track:c19eec546b054d54a13658f94292b24f        level:DEBUG     logger:o.t.gfw.web.exception.SystemExceptionResolver    message:Resolving to default view &#39;common/error/systemError&#39; for exception of type [org.terasoluna.gfw.common.exception.SystemException]</span>
<span class="go">date:2013-09-19 21:03:06      thread:tomcat-http--3   X-Track:c19eec546b054d54a13658f94292b24f        level:DEBUG     logger:o.t.gfw.web.exception.SystemExceptionResolver    message:Applying HTTP status code 500</span>
<span class="go">date:2013-09-19 21:03:06      thread:tomcat-http--3   X-Track:c19eec546b054d54a13658f94292b24f        level:DEBUG     logger:o.t.gfw.web.exception.SystemExceptionResolver    message:Exposing Exception as model attribute &#39;exception&#39;</span>
<span class="go">date:2013-09-19 21:03:06      thread:tomcat-http--3   X-Track:c19eec546b054d54a13658f94292b24f        level:ERROR     logger:o.t.gfw.common.exception.ExceptionLogger         message:[e.ad.od.9012] not found item entity. item code [10-123456].</span>
<span class="go">org.terasoluna.gfw.common.exception.SystemException: not found item entity. item code [10-123456].</span>
<span class="go">      at org.terasoluna.exception.domain.service.ExampleExceptionServiceImpl.throwSystemException(ExampleExceptionServiceImpl.java:14) ~[ExampleExceptionServiceImpl.class:na]</span>
<span class="go">...</span>
<span class="go">// stackTarace omitted</span>
</pre></div>
</div>
</div></blockquote>
<p>表示される画面</p>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../../_images/exception-handling-screen-systemexception.png"><img alt="screen system exception" src="../../_images/exception-handling-screen-systemexception.png" style="width: 60%;" /></a>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>システムエラー画面は、個別に用意せず、共通的に決めることを推奨する。</p>
<p class="last">本ガイドラインの画面では、システムエラーのためのメッセージID（業務毎）を表示し、文言は固定にしている。
その理由は、オペレータに対して、エラーの細かい内容を知らせる必要がなく、システムに異常があることだけを伝えればよいためである。
そこで、開発側では、解析を簡易にするために、キーとなるメッセージIDを画面に表示して、システム異常の問い合わせに対するレスポンスを向上しようとしている。
表示される画面については、各プロジェクトでUI規約に従い、用意すること。</p>
</div>
</div></blockquote>
<p>例外を捕捉して、システム例外を発生させる</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="k">try</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">File</span><span class="p">(</span><span class="n">preUploadDir</span><span class="p">.</span><span class="na">getFile</span><span class="p">(),</span> <span class="n">key</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">FileNotFoundException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (1)</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="n">SystemException</span><span class="p">(</span><span class="s">&quot;e.ad.od.9007&quot;</span><span class="p">,</span>
        <span class="s">&quot;not found upload file. file is [&quot;</span> <span class="o">+</span> <span class="n">preUploadDir</span><span class="p">.</span><span class="na">getDescription</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;].&quot;</span>
        <span class="n">e</span><span class="p">);</span> <span class="c1">// (2)</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">システム異常に分類される検査例外を捕捉する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例外コード(メッセージID)、メッセージ、<strong>原因例外(e)</strong>を指定して、SystemExceptionを発生させる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="exception-handling-how-to-use-codingpoint-service-continue-label">
<span id="id28"></span><h4><a class="toc-backref" href="#id91">4.2.3.2.3. 例外をキャッチして、処理を継続させる</a><a class="headerlink" href="#exception-handling-how-to-use-codingpoint-service-continue-label" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">例外をキャッチして、処理を継続させる必要がある場合、発生した例外をログに出力してから、処理を継続するようにする。</div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>監視ログの出力について</strong></p>
<p class="last">発生した例外をログに出力する際には、例外の種類に応じて監視ログを出力する事を検討する。
共通ライブラリでは、アプリケーションログと監視ログを同時に出力する機能を持つ<code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.exception.ExceptionLogger</span></code>を提供している。
アプリケーションログと合わせて、監視ログの出力も必要となる場合には、<code class="docutils literal"><span class="pre">ExceptionLogger</span></code>を使用する事を推奨する。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">下記は、外部システムから、顧客対応履歴の取得に失敗した場合に、顧客対応履歴以外の情報を取得する処理を、継続する場合の例である。</div>
<div class="line">この例では、顧客対応履歴の情報が取得できなくても、業務は継続できるため、処理を継続している。</div>
</div>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="n">ExceptionLogger</span> <span class="n">exceptionLogger</span><span class="p">;</span> <span class="c1">// (1)</span>

<span class="c1">// ...</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">InteractionHistory</span> <span class="n">interactionHistory</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="k">try</span> <span class="p">{</span>
    <span class="n">interactionHistory</span> <span class="o">=</span> <span class="n">restTemplete</span><span class="p">.</span><span class="na">getForObject</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">InteractionHistory</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">customerId</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">RestClientException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (2)</span>
    <span class="n">exceptionLogger</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="n">e</span><span class="p">);</span> <span class="c1">// (3)</span>
<span class="p">}</span>

<span class="c1">// (4)</span>
<span class="n">Customer</span> <span class="n">customer</span> <span class="o">=</span> <span class="n">customerRepository</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">customerId</span><span class="p">);</span>

<span class="c1">// ...</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ログ出力のため、共通ライブラリで提供している<code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.exception.ExceptionLogger</span></code>をDIする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ハンドリング対象の例外をキャッチする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ExceptionLogger</span></code>を利用して、キャッチした例外をログに出力する。例では、例外コードに応じた出力レベルでログ出力するためlogメソッドを呼び出しているが、出力レベルが決まっており、</div>
<div class="line">後に変更する可能性がない場合は、info、warn、errorメソッドを直接呼び出してもよい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(3)でログを出力したのみで、処理を継続する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line">上記例の場合、以下のような、アプリケーションログ、及び監視ログが出力される。</div>
<div class="line">なお、この挙動は、<code class="docutils literal"><span class="pre">ExceptionCodeResolver</span></code>の設定がデフォルトの場合を前提としている。</div>
<div class="line"><code class="docutils literal"><span class="pre">ExceptionCodeResolver</span></code>については、<a class="reference internal" href="#exception-handling-about-classes-of-library-label"><span class="std std-ref">共通ライブラリから提供している例外ハンドリング用のクラスについて</span></a>を参照されたい。</div>
</div>
<ul class="simple">
<li>アプリケーションログ</li>
</ul>
<blockquote>
<div><div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">date:2013-09-19 21:31:47      thread:tomcat-http--3   X-Track:df5271ece2304b12a2c59ff494806397        level:ERROR     logger:o.t.gfw.common.exception.ExceptionLogger         message:[e.xx.fw.9001] Test example exception</span>
<span class="go">org.springframework.web.client.RestClientException: Test example exception</span>
<span class="go">...</span>
<span class="go">// stackTarace omitted</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>監視ログ</li>
</ul>
<blockquote>
<div><div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">date:2013-09-19 21:31:47  X-Track:df5271ece2304b12a2c59ff494806397        level:ERROR     message:[e.xx.fw.9001] Test example exception</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">ExceptionLogger</span></code>を利用してログ出力する場合、デフォルトの設定では、errorレベルのログが監視ログに出力される。</div>
<div class="line">その為、処理を継続させて問題ない場合など、<code class="docutils literal"><span class="pre">ExceptionLogger</span></code>を利用してログ出力する際に監視ログへの出力対象外にするには、error以外のログレベルで出力すれば良い。</div>
<div class="line">これには、以下のいずれかの方法を取れば良い。</div>
</div>
<ul class="simple">
<li>infoまたはwarnメソッドでログ出力する。</li>
<li><code class="docutils literal"><span class="pre">ExceptionCodeResolver</span></code>で該当する例外の例外コードの先頭をe（error）以外に設定し、logメソッドでログ出力する。</li>
<li>ログ出力する例外が<code class="docutils literal"><span class="pre">SystemException</span></code>である場合には、セットする例外コードの先頭をe（error）以外に設定し、logメソッドでログ出力する。</li>
</ul>
<p>次の例では、infoメソッドでログ出力する例を示す。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">RestClientException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">exceptionLogger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>上記例の場合は、以下のようにアプリケーションログのみが出力される。</p>
<blockquote>
<div><div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">date:2013-09-19 22:17:53    thread:tomcat-http--3   X-Track:999725b111b4445b8d10b4ea44639c61        level:INFO      logger:o.t.gfw.common.exception.ExceptionLogger         message:[e.xx.fw.9001] Test example exception</span>
<span class="go">org.springframework.web.client.RestClientException: Test example exception</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="exception-handling-how-to-use-codingpoint-controller-label">
<span id="id29"></span><h3><a class="toc-backref" href="#id92">4.2.3.3. コーディングポイント（Controller編）</a><a class="headerlink" href="#exception-handling-how-to-use-codingpoint-controller-label" title="Permalink to this headline">¶</a></h3>
<p>例外ハンドリングを行う際の、Controllerでのコーディングポイントを、以下に示す。</p>
<ol class="arabic simple">
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-controller-request-label"><span class="std std-ref">リクエスト単位で例外をハンドリングする方法</span></a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-controller-usecase-label"><span class="std std-ref">ユースケース単位で例外をハンドリングする方法</span></a></li>
</ol>
<div class="section" id="exception-handling-how-to-use-codingpoint-controller-request-label">
<span id="id30"></span><h4><a class="toc-backref" href="#id93">4.2.3.3.1. リクエスト単位で例外をハンドリングする方法</a><a class="headerlink" href="#exception-handling-how-to-use-codingpoint-controller-request-label" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">例外をリクエスト単位でハンドリングし、引き継ぎ情報（メッセージ情報）を、Modelに設定する。</div>
<div class="line">その後、遷移する画面を表示するためのメソッドを呼び出すことで、遷移先で必要なモデルを生成し、View名を決定する。</div>
</div>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;change&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">change</span><span class="p">(</span><span class="nd">@Validated</span> <span class="n">UserForm</span> <span class="n">userForm</span><span class="p">,</span>
                     <span class="n">BindingResult</span> <span class="n">result</span><span class="p">,</span>
                     <span class="n">RedirectAttributes</span> <span class="n">redirectAttributes</span><span class="p">,</span>
                     <span class="n">Model</span> <span class="n">model</span><span class="p">)</span> <span class="p">{</span>         <span class="c1">// (1)</span>

    <span class="c1">// omitted</span>

    <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userHelper</span><span class="p">.</span><span class="na">convertToUser</span><span class="p">(</span><span class="n">userForm</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="n">userService</span><span class="p">.</span><span class="na">change</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">BusinessException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>                                   <span class="c1">// (2)</span>
        <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getResultMessages</span><span class="p">());</span>                    <span class="c1">// (3)</span>
        <span class="k">return</span> <span class="n">viewChangeForm</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span> <span class="n">model</span><span class="p">);</span>               <span class="c1">// (4)</span>
    <span class="p">}</span>

    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラー情報を、Viewと連携するためのオブジェクトとして、Modelを引数に定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ハンドリング対象となる例外を、アプリケーションコードで捕捉する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ResultMessagesオブジェクトを、Modelに追加する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラー時の遷移先を表示するためのメソッドを呼び出し、View表示に必要なモデルと、View名を取得した後に、表示するView名を返却する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="exception-handling-how-to-use-codingpoint-controller-usecase-label">
<span id="id31"></span><h4><a class="toc-backref" href="#id94">4.2.3.3.2. ユースケース単位で例外をハンドリングする方法</a><a class="headerlink" href="#exception-handling-how-to-use-codingpoint-controller-usecase-label" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">例外を、ユースケース単位でハンドリングし、引き継ぎ情報（メッセージ情報など）が格納されたModelMap（ExtendedModelMap）を生成する。</div>
<div class="line">その後、遷移する画面を表示するためのメソッドを呼び出すことで、遷移先で必要なモデルを生成し、View名を決定する。</div>
</div>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">BusinessException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span> <span class="c1">// (1)</span>
<span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">CONFLICT</span><span class="p">)</span> <span class="c1">// (2)</span>
<span class="kd">public</span> <span class="n">ModelAndView</span> <span class="nf">handleBusinessException</span><span class="p">(</span><span class="n">BusinessException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ExtendedModelMap</span> <span class="n">modelMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ExtendedModelMap</span><span class="p">();</span>                 <span class="c1">// (3)</span>
    <span class="n">modelMap</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getResultMessages</span><span class="p">());</span>                       <span class="c1">// (4)</span>
    <span class="n">String</span> <span class="n">viewName</span> <span class="o">=</span> <span class="n">top</span><span class="p">(</span><span class="n">modelMap</span><span class="p">);</span>                                    <span class="c1">// (5)</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">ModelAndView</span><span class="p">(</span><span class="n">viewName</span><span class="p">,</span> <span class="n">modelMap</span><span class="p">);</span>                        <span class="c1">// (6)</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></code>アノテーションのvalue属性に、ハンドリング対象とする例外クラスを指定する。ハンドリング対象とする例外は、複数指定することもできる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;ResponseStatus</span></code>アノテーションの、value属性に返却するHTTPステータスコードを指定する。例では、「409:Conflict」を指定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラー情報と、モデル情報を、Viewと連携するためのオブジェクトとして、ExtendedModelMapを生成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ResultMessagesオブジェクトを、ExtendedModelMapに追加する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラー時の遷移先を表示するためのメソッドを呼び出し、View表示に必要なモデルと、View名を取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(3)-(5)の処理で取得したView名と、Modelが格納されているModelAndViewを生成し、返却する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><code class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></code>を付与したメソッドで<code class="docutils literal"><span class="pre">java.lang.Exception</span></code>や<code class="docutils literal"><span class="pre">javax.servlet.ServletException</span></code>をハンドリングしている場合は、
致命的なエラーをラップしている<code class="docutils literal"><span class="pre">NestedServletException</span></code>を意図せずハンドリングしてしまうため、サーブレットコンテナに致命的なエラーを通知することができない。
詳細は、<a class="reference internal" href="#exception-handling-class-fatalerror-warning"><span class="std std-ref">「&#64;ExceptionHandlerとSystemExceptionResolverによる致命的なエラーのハンドリングついて」</span></a>を参照されたい。</p>
<p>このようなケースで致命的なエラーをサーブレットコンテナに通知するためには、<a class="reference internal" href="#exception-handling-how-to-use-application-configuration-app-label"><span class="std std-ref">SystemExceptionResolverでNestedServletExceptionをハンドリング対象外とする</span></a>ことに加えて、
<code class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></code>を付与したメソッドで<code class="docutils literal"><span class="pre">NestedServletException</span></code>をハンドリングし、再スローするように実装すればよい。
以下に実装例を示す。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">NestedServletException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleNestedServletException</span><span class="p">(</span><span class="n">NestedServletException</span> <span class="n">e</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">NestedServletException</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="n">e</span><span class="p">;</span> <span class="c1">// (2)</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></code>アノテーションを付与し、<code class="docutils literal"><span class="pre">NestedServletException.class</span></code>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ハンドリングした<code class="docutils literal"><span class="pre">NestedServletException</span></code>を再スローする。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><strong>複数のControllerでExceptionやServletExceptionを捕捉している場合について</strong></p>
<p class="last">複数のControllerで<code class="docutils literal"><span class="pre">NestedServletException</span></code>を再スローする<code class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></code>を記述する必要がある場合は、<code class="docutils literal"><span class="pre">&#64;ControllerAdvice</span></code>の使用を検討した方がよい。
<code class="docutils literal"><span class="pre">&#64;ControllerAdvice</span></code>の詳細は、<a class="reference internal" href="../../ImplementationAtEachLayer/ApplicationLayer.html#application-layer-controller-advice"><span class="std std-ref">&#64;ControllerAdviceの実装</span></a>を参照されたい。</p>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="exception-handling-how-to-use-codingpoint-jsp-label">
<span id="id32"></span><h3><a class="toc-backref" href="#id95">4.2.3.4. コーディングポイント（JSP編）</a><a class="headerlink" href="#exception-handling-how-to-use-codingpoint-jsp-label" title="Permalink to this headline">¶</a></h3>
<p>例外ハンドリングを行う際の、JSPでのコーディングポイントを、以下に示す。</p>
<ol class="arabic simple">
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-jsp-panel-label"><span class="std std-ref">MessagesPanelTagを使用して、メッセージを画面表示する方法</span></a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-view-exceptioncode-label"><span class="std std-ref">システム例外の例外コードを、画面表示する方法</span></a></li>
</ol>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>アプリケーションでInternet Explorer/Microsoft Edgeをサポートする場合、エラー画面の応答として生成されるHTMLのサイズに注意する必要がある。</p>
<p>Internet Explorer/Microsoft Edgeでは、応答されたHTMLのサイズが規定値以下だと、アプリケーションが用意したエラー画面の代わりに、Internet Explorer/Microsoft Edgeが用意した簡易メッセージが表示されるためである。</p>
<p class="last">参考までに、Internet Explorerでの詳細な条件は、「<a class="reference external" href="https://blogs.msdn.microsoft.com/ieinternals/2010/08/18/friendly-http-error-pages/">Friendly HTTP Error Pages</a>」を参照されたい。</p>
</div>
<div class="section" id="messagespaneltag">
<span id="exception-handling-how-to-use-codingpoint-jsp-panel-label"></span><h4><a class="toc-backref" href="#id96">4.2.3.4.1. MessagesPanelTagを使用して、メッセージを画面表示する方法</a><a class="headerlink" href="#messagespaneltag" title="Permalink to this headline">¶</a></h4>
<p>任意の場所に、ResultMessagesを出力する際の実装例を、以下に示す。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;t:messagesPanel</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>メッセージを出力したい場所に、&lt;t:messagesPanel&gt;タグを指定する。 &lt;t:messagesPanel&gt;タグの使用方法の詳細については、<a class="reference internal" href="MessageManagement.html"><span class="doc">メッセージ管理</span></a>を参照されたい。</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="exception-handling-how-to-use-codingpoint-view-exceptioncode-label">
<span id="id33"></span><h4><a class="toc-backref" href="#id97">4.2.3.4.2. システム例外の例外コードを、画面表示する方法</a><a class="headerlink" href="#exception-handling-how-to-use-codingpoint-view-exceptioncode-label" title="Permalink to this headline">¶</a></h4>
<p>任意の場所に、例外コード(メッセージID)と、固定メッセージを表示する際の実装例を、以下に示す。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;p&gt;</span>
    <span class="nt">&lt;c:if</span> <span class="na">test=</span><span class="s">&quot;${!empty exceptionCode}&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
        [${f:h(exceptionCode)}]            <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;/c:if&gt;</span>
    <span class="nt">&lt;spring:message</span> <span class="na">code=</span><span class="s">&quot;e.cm.fw.9999&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例外コード(メッセージID)の存在チェックを行う。上記の実装例のように、記号などで例外コード(メッセージID)を囲む場合は、存在チェックを行うこと。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例外コード(メッセージID)を出力する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">メッセージ定義より取得した、固定メッセージを出力する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>出力画面（exceptionCode有り）</li>
</ul>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../../_images/exception-handling-screen-systemexception-messagecode.png"><img alt="screen system exception messagecode" src="../../_images/exception-handling-screen-systemexception-messagecode.png" style="width: 40%;" /></a>
</div>
</div></blockquote>
<ul class="simple">
<li>出力画面（exceptionCode無し）</li>
</ul>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../../_images/exception-handling-screen-systemexceptionbyjspexception.png"><img alt="screen system exception no messagecode" src="../../_images/exception-handling-screen-systemexceptionbyjspexception.png" style="width: 40%;" /></a>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>システム例外時に出力するメッセージについて</strong></p>
<ul class="last simple">
<li>システム例外が発生した場合、エラー原因が特定できる、または推測できる詳細メッセージを出力せず、システム例外が発生したことだけを伝えるメッセージを表示することを推奨する。</li>
<li>エラー原因が特定できる、または推測できる詳細メッセージを表示した場合、システムの脆弱性を公開してしまう可能性がある。</li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>例外コード(メッセージID)について</strong></p>
<ul class="last simple">
<li>システム例外が発生した場合、詳細メッセージの代わりに、例外コード(メッセージID)を出力することを推奨する。</li>
<li>例外コード(メッセージID)を出力することで、システム利用者からの問い合わせに、素早く対応することができる。</li>
<li>例外コード(メッセージID)からエラー原因を特定できるのは、システム管理者だけなので、システムの脆弱性を公開する危険性は少なくなる。</li>
</ul>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-use-ajax">
<h2><a class="toc-backref" href="#id98">4.2.4. How to use (Ajax)</a><a class="headerlink" href="#how-to-use-ajax" title="Permalink to this headline">¶</a></h2>
<p>Ajaxの例外ハンドリングについては、<a class="reference internal" href="Ajax.html"><span class="doc">Ajax</span></a>を参照されたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="appendix">
<h2><a class="toc-backref" href="#id99">4.2.5. Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><a class="reference internal" href="#exception-handling-about-classes-of-library-label"><span class="std std-ref">共通ライブラリから提供している例外ハンドリング用のクラスについて</span></a></li>
<li><a class="reference internal" href="#exception-handling-about-systemexceptionresolver-label"><span class="std std-ref">SystemExceptionResolverの設定項目について</span></a></li>
<li><a class="reference internal" href="#exception-handling-appendix-defaulthandlerexceptionresolver-label"><span class="std std-ref">DefaultHandlerExceptionResolverで設定されるHTTPレスポンスコードについて</span></a></li>
</ol>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="exception-handling-about-classes-of-library-label">
<span id="id34"></span><h3><a class="toc-backref" href="#id100">4.2.5.1. 共通ライブラリから提供している例外ハンドリング用のクラスについて</a><a class="headerlink" href="#exception-handling-about-classes-of-library-label" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Spring MVCが提供しているクラスとは別に、共通ライブラリより例外ハンドリングを行うためのクラスを提供している。</div>
<div class="line">クラスの役割は、以下の通りである。</div>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id55">
<caption><span class="caption-text"><strong>表- org.terasoluna.gfw.common.exception パッケージ配下のクラス</strong></span><a class="headerlink" href="#id55" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="11%" />
<col width="21%" />
<col width="68%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">クラス</th>
<th class="head">役割</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ExceptionCode</div>
<div class="line">Resolver</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例外クラスに対応する例外コード（メッセージID）を解決するためのインタフェース。</div>
<div class="line">例外コードとは、どのような例外が発生したのかを識別するためのコードで、システムエラー画面や、ログに出力することを想定している。</div>
<div class="line"><code class="docutils literal"><span class="pre">ExceptionLogger</span></code>、<code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>などから参照される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SimpleMapping</div>
<div class="line">ExceptionCode</div>
<div class="line">Resolver</div>
</div>
</td>
<td><div class="first line-block">
<div class="line"><code class="docutils literal"><span class="pre">ExceptionCodeResolver</span></code>の実装クラスで、例外クラスの名前と、例外コードのマッピングを保持することで、例外コードの解決を実現する。</div>
<div class="line">例外クラスの名前は、FQCNではなく、FQCNの一部や、親クラスの名前でもよい。</div>
</div>
<blockquote class="last">
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<ul class="last simple">
<li>FQCNの一部を指定した場合、場合によっては想定していなかったクラスとマッチしてしまうことがあるので注意が必要である。</li>
<li>親クラスの名前を指定した場合、全ての子クラスがマッチするので注意が必要である。</li>
</ul>
</div>
</div></blockquote>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">enums.</div>
<div class="line">ExceptionLevel</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例外クラスに対応する例外レベルを表現するenum。</div>
<div class="line">INFO, WARN, ERRORが定義されている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ExceptionLevel</div>
<div class="line">Resolver</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例外クラスに対応する例外レベル（ログレベル）を解決するためのインタフェース。</div>
<div class="line">例外レベルとは、どのようなレベルの例外が発生したのかを識別するためのコードで、ログの出力レベルを切り替えるために使われる。</div>
<div class="line"><code class="docutils literal"><span class="pre">ExceptionLogger</span></code> から参照される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">DefaultException</div>
<div class="line">LevelResolver</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ExceptionLevelResolver</span></code> の実装クラスで、例外コードの先頭１文字で、例外レベルを解決している。</div>
<div class="line">先頭の１文字目（case insensitive）が、</div>
<div class="line-block">
<div class="line">1. “i”の場合は <code class="docutils literal"><span class="pre">ExceptionLevel.INFO</span></code></div>
<div class="line">2. “w”の場合は <code class="docutils literal"><span class="pre">ExceptionLevel.WARN</span></code></div>
<div class="line">3. “e”の場合は <code class="docutils literal"><span class="pre">ExceptionLevel.ERROR</span></code></div>
<div class="line">4. 上記以外の場合は <code class="docutils literal"><span class="pre">ExceptionLevel.ERROR</span></code></div>
</div>
<div class="line">レベルとして扱う。</div>
<div class="line">本クラスは、<a class="reference internal" href="MessageManagement.html"><span class="doc">メッセージ</span></a>のガイドラインに記載されている、メッセージIDのルールに則った実装となっている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ExceptionLogger</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例外をログ出力するためのクラス。</div>
<div class="line">監視ログ(メッセージのみ)と、アプリケーションログ(メッセージと、スタックトレースの両方)を出力することができる。</div>
<div class="line">本クラスは、フレームワークより提供しているFilterや、Interceptorクラスから使用されている。</div>
<div class="line">アプリケーションコードで、例外をハンドリングして処理を継続する場合、本クラスを用いて、ログを出力すること。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ResultMessages</div>
<div class="line">LoggingInterceptor</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ResultMessages</span></code>を保持している例外(<code class="docutils literal"><span class="pre">ResultMessagesNotificationException</span></code>のサブ例外 )が発生した事をログに出力するためのInterceptorクラス。</div>
<div class="line">ログは全てWARNレベルで出力する。</div>
<div class="line">本Interceptorは、 <code class="docutils literal"><span class="pre">&#64;Service</span></code> アノテーションが付与されているクラスのメソッドに対して適用することを想定している。</div>
<div class="line">ログは、<code class="docutils literal"><span class="pre">ExceptionLogger</span></code>を使用して出力している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">BusinessException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ビジネスルールの違反を検知したことを通知するための例外クラスで、ドメイン層のロジックで発生させる例外である。</div>
<div class="line"><code class="docutils literal"><span class="pre">java.lang.RuntimeException</span></code>を継承しているため、デフォルトの動作として、トランザクションは、ロールバックされる。</div>
<div class="line">トランザクションをコミットしたい場合は、<code class="docutils literal"><span class="pre">&#64;Transactional</span></code>アノテーションの noRollbackFor 、または noRollbackForClassName に、本例外クラスを指定する必要がある。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource</div>
<div class="line">NotFoundException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">指定されたリソース（データ）が、システム内に存在しないことを通知するための例外クラスで、主に、ドメイン層のロジックで発生させる例外である。</div>
<div class="line"><code class="docutils literal"><span class="pre">java.lang.RuntimeException</span></code> を継承しているため、デフォルトの動作として、トランザクションは、ロールバックされる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ResultMessages</div>
<div class="line">Notification</div>
<div class="line">Exception</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">結果メッセージ（<code class="docutils literal"><span class="pre">ResultMessages</span></code>）を保持している例外であることを通知するための抽象例外クラスで、共通ライブラリでは、<code class="docutils literal"><span class="pre">BusinessException</span></code>と、<code class="docutils literal"><span class="pre">ResourceNotFoundException</span></code>が継承している。</div>
<div class="line"><code class="docutils literal"><span class="pre">java.lang.RuntimeException</span></code>を継承しているため、デフォルトの動作としてトランザクションはロールバックされる。</div>
<div class="line">本例外クラスを継承すると、<code class="docutils literal"><span class="pre">ResultMessagesLoggingInterceptor</span></code>によって、warnレベルのログが出力される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SystemException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">システム又はアプリケーションの異常を検知した事を通知するための例外クラスで、アプリケーション層又はドメイン層のロジックで発生させる例外である。</div>
<div class="line"><code class="docutils literal"><span class="pre">java.lang.RuntimeException</span></code>を継承しているため、デフォルトの動作として、トランザクションは、ロールバックされる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ExceptionCodeProvider</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例外コードを保持する役割があることを示すインタフェースで、共通ライブラリでは、<code class="docutils literal"><span class="pre">SystemException</span></code>が実装している。</div>
<div class="line">本インタフェースを実装した例外クラスを作成すると、共通ライブラリから提供している例外ハンドリング処理にて、例外で保持している例外コードで、そのまま使われる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-given docutils" id="id56">
<caption><span class="caption-text"><strong>表- org.terasoluna.gfw.web.exception パッケージ配下のクラス</strong></span><a class="headerlink" href="#id56" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="11%" />
<col width="21%" />
<col width="68%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">クラス</th>
<th class="head">役割</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(13)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SystemException</div>
<div class="line">Resolver</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;mvc:annotation-driven&gt;</span></code>を指定した際に、自動的に登録される<code class="docutils literal"><span class="pre">HandlerExceptionResolver</span></code>によって、ハンドリングされない例外をハンドリングするためのクラス。</div>
<div class="line">Spring MVCより提供されている<code class="docutils literal"><span class="pre">SimpleMappingExceptionResolver</span></code>を継承し、例外コード及びResultMessagesを、Viewから参照できるように機能追加を行っている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(14)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">HandlerException</div>
<div class="line">ResolverLogging</div>
<div class="line">Interceptor</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">HandlerExceptionResolver</span></code>でハンドリングされた例外を、ログに出力するためのInterceptorクラス。</div>
<div class="line">本Interceptorクラスでは、<code class="docutils literal"><span class="pre">HandlerExceptionResolver</span></code>で解決されたHTTPレスポンスコードの分類に応じて、ログの出力レベルを切り替えている。</div>
<div class="line-block">
<div class="line">1. “100-399”の場合は、 INFOレベルで出力する。</div>
<div class="line">2. “400-499”の場合は、 WARNレベルで出力する。</div>
<div class="line">3. “500-“の場合は ERRORレベルで出力する。</div>
<div class="line">4. “-99”の場合は ログ出力しない。</div>
</div>
<div class="line">本Interceptorを使用することで、Spring MVC管理下で発生する全ての例外を、ログに出力することができる。</div>
<div class="line">ログは、<code class="docutils literal"><span class="pre">ExceptionLogger</span></code>を使用して出力している。</div>
<div class="line">プロジェクトの要件に応じて<code class="docutils literal"><span class="pre">log</span></code>メソッドを拡張することで、デフォルトの挙動を変更してログ出力することが可能である。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(15)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ExceptionLogging</div>
<div class="line">Filter</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">致命的なエラー、Spring MVC管理外で発生する例外を、ログに出力するためのFilterクラス。</div>
<div class="line">ログは、すべてERRORレベルで出力する。</div>
<div class="line">本Filterを使用した場合、致命的なエラー、およびSpring MVC管理外で発生するすべての例外を、ログに出力することができる。</div>
<div class="line">ログは、<code class="docutils literal"><span class="pre">ExceptionLogger</span></code>を使用して出力している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="systemexceptionresolver">
<span id="exception-handling-about-systemexceptionresolver-label"></span><h3><a class="toc-backref" href="#id101">4.2.5.2. SystemExceptionResolverの設定項目について</a><a class="headerlink" href="#systemexceptionresolver" title="Permalink to this headline">¶</a></h3>
<p>本編で説明していない設定項目について、説明する。
要件に応じて、設定を行うこと。</p>
<table border="1" class="colwidths-given longtable docutils" id="id57">
<caption><span class="caption-text"><strong>本編で説明していない設定項目一覧</strong></span><a class="headerlink" href="#id57" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="5%" />
<col width="15%" />
<col width="15%" />
<col width="45%" />
<col width="20%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">項目名</th>
<th class="head">プロパティ名</th>
<th class="head">説明</th>
<th class="head">デフォルト値</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">結果メッセージの属性名</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">resultMessagesAttribute</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ビジネス例外に設定されているメッセージ情報として、モデルに設定する際の属性名(String)を指定する。</div>
<div class="line">View(JSP)から結果メッセージにアクセスする際の、属性名となる。</div>
</div>
</td>
<td>resultMessages</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例外コード(メッセージID)の属性名</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">exceptionCode</div>
<div class="line">Attribute</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例外コード(メッセージID)として、HttpServletRequestに設定する際の属性名(String)を指定する。</div>
<div class="line">View(JSP)から例外コード(メッセージID)にアクセスする際の属性名となる。</div>
</div>
</td>
<td>exceptionCode</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例外コード(メッセージID)のヘッダ名</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">exceptionCode</div>
<div class="line">Header</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例外コード(メッセージID)として、HttpServletResponseのレスポンスヘッダに設定する際のヘッダ名(String)を指定する。</div>
</div>
</td>
<td>X-Exception-Code</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例外オブジェクトの属性名</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">exceptionAttribute</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ハンドリングした例外オブジェクトとして、モデルに設定する際の属性名(String)を指定する。</div>
<div class="line">View(JSP)から例外オブジェクトにアクセスする際の属性名となる。</div>
</div>
</td>
<td>exception</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本ExceptionResolverとして、使用するハンドラー(Controller)のオブジェクト一覧</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">mappedHandlers</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本ExceptionResolverを使用するハンドラーの、オブジェクト一覧(Set)を指定する。</div>
<div class="line">指定したハンドラーオブジェクトで発生した例外のみ、ハンドリングが行われる。</div>
<div class="line"><strong>この設定項目は指定してはいけない。</strong></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">指定なし</div>
<div class="line"><br /></div>
<div class="line"><strong>指定した場合の動作は、保証しない。</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本ExceptionResolverを使用するハンドラー(Controller)のクラス一覧</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">mappedHandlerClasses</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本ExceptionResolverを使用するハンドラーのクラス一覧(Class[])を指定する。</div>
<div class="line">指定したハンドラークラスで発生した例外のみハンドリングが行われる。</div>
<div class="line"><strong>この設定項目は指定してはいけない。</strong></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">指定なし</div>
<div class="line"><br /></div>
<div class="line"><strong>指定した場合の動作は、保証しない。</strong></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">HTTPレスポンスのキャッシュ制御有無</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">preventResponseCaching</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">HTTPレスポンス時のキャッシュ制御の有無(true:有 false:無)を指定する。</div>
<div class="line">true:有を指定すると、キャッシュを無効にするためのHTTPレスポンスヘッダが追加される。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">false:無</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">(1)-(3)は、<code class="docutils literal"><span class="pre">org.terasoluna.gfw.web.exception.SystemExceptionResolver</span></code>の設定項目。</div>
<div class="line">(4)は、<code class="docutils literal"><span class="pre">org.springframework.web.servlet.handler.SimpleMappingExceptionResolver</span></code>の設定項目。</div>
<div class="line">(5)-(7)は、<code class="docutils literal"><span class="pre">org.springframework.web.servlet.handler.AbstractHandlerExceptionResolver</span></code>の設定項目。</div>
</div>
<div class="section" id="id35">
<h4><a class="toc-backref" href="#id102">4.2.5.2.1. 結果メッセージの属性名</a><a class="headerlink" href="#id35" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">SystemExceptionResolverでハンドリングして設定したメッセージと、アプリケーションコードでハンドリングして設定したメッセージを、View(JSP)で別のmessagesPanelとして出力したい場合は、SystemExceptionResolver専用の属性名を指定する。</div>
<div class="line">下記に示す例は、デフォルト値から「resultMessagesForExceptionResolver」に変更する場合の、設定&amp;実装例である。</div>
</div>
<ul>
<li><p class="first"><strong>spring-mvc.xml</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.SystemExceptionResolver&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;resultMessagesAttribute&quot;</span> <span class="na">value=</span><span class="s">&quot;resultMessagesForExceptionResolver&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first"><strong>jsp</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;t:messagesPanel</span> <span class="na">messagesAttributeName=</span><span class="s">&quot;resultMessagesForExceptionResolver&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
</pre></div>
</div>
</li>
</ul>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">結果メッセージの属性名(resultMessagesAttribute)に、”resultMessagesForExceptionResolver”を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">メッセージ属性名(messagesAttributeName)に、SystemExceptionResolverで設定した属性名を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id">
<h4><a class="toc-backref" href="#id103">4.2.5.2.2. 例外コード(メッセージID)の属性名</a><a class="headerlink" href="#id" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">デフォルトの属性名をアプリケーションコードで使用している場合は、重複を避けるために、別の値を設定すること。重複がない場合は、デフォルト値を変更する必要はない。</div>
<div class="line">下記は、デフォルト値から、「exceptionCodeForExceptionResolver」に変更する場合の、設定&amp;実装例である。</div>
</div>
<ul>
<li><p class="first"><strong>spring-mvc.xml</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.SystemExceptionResolver&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionCodeAttribute&quot;</span> <span class="na">value=</span><span class="s">&quot;exceptionCodeForExceptionResolver&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first"><strong>jsp</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;p&gt;</span>
    <span class="nt">&lt;c:if</span> <span class="na">test=</span><span class="s">&quot;${!empty exceptionCodeForExceptionResolver}&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
        [${f:h(exceptionCodeForExceptionResolver)}]            <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;/c:if&gt;</span>
    <span class="nt">&lt;spring:message</span> <span class="na">code=</span><span class="s">&quot;e.cm.fw.9999&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div>
</li>
</ul>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例外コード(メッセージID)の属性名(exceptionCodeAttribute)に、”exceptionCodeForExceptionResolver”を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SystemExceptionResolverに設定した値(exceptionCodeForExceptionResolver)を、テスト対象(空チェック対応)の変数名として指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SystemExceptionResolverに設定した値(exceptionCodeForExceptionResolver)を、出力対象の変数名として指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id36">
<h4><a class="toc-backref" href="#id104">4.2.5.2.3. 例外コード(メッセージID)のヘッダ名</a><a class="headerlink" href="#id36" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">デフォルトのヘッダ名が使用されている場合、重複を避けるために、別の値を設定すること。重複がない場合は、デフォルト値を変更する必要はない。</div>
<div class="line">下記は、デフォルト値から「X-Exception-Code-ForExceptionResolver」に変更する場合の、設定&amp;実装例である。</div>
</div>
<ul>
<li><p class="first"><strong>spring-mvc.xml</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.SystemExceptionResolver&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionCodeHeader&quot;</span> <span class="na">value=</span><span class="s">&quot;X-Exception-Code-ForExceptionResolver&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
</li>
</ul>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例外コード(メッセージID)のヘッダ名(exceptionCodeHeader)に、”X-Exception-Code-ForExceptionResolver”を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id37">
<h4><a class="toc-backref" href="#id105">4.2.5.2.4. 例外オブジェクトの属性名</a><a class="headerlink" href="#id37" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">デフォルトの属性名をアプリケーションコードで使用している場合は、重複を避けるために、別の値を設定すること。重複がない場合は、デフォルト値を変更する必要はない。</div>
<div class="line">下記は、デフォルト値から「exceptionForExceptionResolver」に変更する場合の、設定&amp;実装例である。</div>
</div>
<ul>
<li><p class="first"><strong>spring-mvc.xml</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.SystemExceptionResolver&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionAttribute&quot;</span> <span class="na">value=</span><span class="s">&quot;exceptionForExceptionResolver&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first"><strong>jsp</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;p&gt;</span>[Exception Message]<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;p&gt;</span>${f:h(exceptionForExceptionResolver.message)}<span class="nt">&lt;/p&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
</pre></div>
</div>
</li>
</ul>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例外オブジェクトの属性名(exceptionAttribute)に、”exceptionForExceptionResolver”を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SystemExceptionResolverに設定した値(exceptionForExceptionResolver)を、例外オブジェクトからメッセージを取得するための変数名として、指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="http">
<span id="exception-handling-http-response-cache"></span><h4><a class="toc-backref" href="#id106">4.2.5.2.5. HTTPレスポンスのキャッシュ制御有無</a><a class="headerlink" href="#http" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">HTTPレスポンスに、キャッシュ制御用のヘッダを追加したい場合は、true:有を指定する。</div>
</div>
<ul>
<li><p class="first"><strong>spring-mvc.xml</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.SystemExceptionResolver&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;preventResponseCaching&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
</li>
</ul>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">HTTPレスポンスのキャッシュ制御有無(preventResponseCaching)に、true:有を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>有を指定した場合のHTTPレスポンスヘッダ</strong></p>
<p>HTTPレスポンスのキャッシュ制御有無を有にすると、以下のHTTPレスポンスヘッダが出力される。</p>
<blockquote>
<div><div class="line-block">
<div class="line">Cache-Control:no-store</div>
</div>
</div></blockquote>
<p class="last"><code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>によるキャッシュ制御用のヘッダ追加はブラウザキャッシュによる意図しないエラー画面の表示を抑止するためのオプションであるが、Spring Securityの機能を使用してセキュリティの観点からキャッシュ制御用のヘッダを追加することも可能である。
Spring Securityの機能については、<a class="reference internal" href="../../Security/LinkageWithBrowser.html#springsecuritylinkagewithbrowser"><span class="std std-ref">ブラウザのセキュリティ対策機能との連携</span></a>を参照されたい。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>SpringSecurityのCache-Controlヘッダを利用する場合の注意点</strong></p>
<p class="last"><code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>のキャッシュ制御とSpring SecurityのCache-Controlヘッダを有効にした場合、<code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>のキャッシュ制御が優先される。
これにより、正常時はSpring Securityでは<code class="docutils literal"><span class="pre">no-store</span></code>以外も付与されるが、例外時は<code class="docutils literal"><span class="pre">no-store</span></code>のみ付与されるため、意図したとおりにキャッシュを制御できない恐れがあることに注意されたい。</p>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="handlerexceptionresolverlogginginterceptor">
<span id="exception-handling-about-handlerexceptionresolverlogginginterceptor"></span><h3><a class="toc-backref" href="#id107">4.2.5.3. HandlerExceptionResolverLoggingInterceptorの設定項目について</a><a class="headerlink" href="#handlerexceptionresolverlogginginterceptor" title="Permalink to this headline">¶</a></h3>
<p>本編で説明していない設定項目について、説明する。
要件に応じて、設定を行うこと。</p>
<table border="1" class="colwidths-given docutils" id="id58">
<caption><span class="caption-text"><strong>本編で説明していない設定項目一覧</strong></span><a class="headerlink" href="#id58" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="5%" />
<col width="15%" />
<col width="15%" />
<col width="45%" />
<col width="20%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">項目名</th>
<th class="head">プロパティ名</th>
<th class="head">説明</th>
<th class="head">デフォルト値</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ログ出力対象から除外する例外クラスの一覧</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ignoreExceptions</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">HandlerExceptionResolver</span></code> によってハンドリングされた例外のうち、ログ出力しない例外クラスをリスト形式で指定する。</div>
<div class="line">指定した例外クラス及びサブクラスの例外が発生した場合、 本クラスでログの出力は行われない。</div>
<div class="line">本項目に指定する例外クラスは、別の場所(別の仕組み)でログ出力される例外のみ指定すること。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ResultMessagesNotificationException.class</span></code></div>
<div class="line"><br /></div>
<div class="line"><code class="docutils literal"><span class="pre">ResultMessagesNotificationException.class</span></code> 及びサブクラスの例外は、 <code class="docutils literal"><span class="pre">ResultMessagesLoggingInterceptor</span></code> でログ出力されるため、デフォルト設定として除外している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="section" id="id38">
<h4><a class="toc-backref" href="#id108">4.2.5.3.1. ログ出力対象から除外する例外クラスの一覧</a><a class="headerlink" href="#id38" title="Permalink to this headline">¶</a></h4>
<p>プロジェクトで用意した例外クラスをログ出力対象から除外したい場合は、以下のような設定となる。</p>
<ul class="simple">
<li><strong>spring-mvc.xml</strong></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;handlerExceptionResolverLoggingInterceptor&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.HandlerExceptionResolverLoggingInterceptor&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionLogger&quot;</span> <span class="na">ref=</span><span class="s">&quot;exceptionLogger&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;ignoreExceptions&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;set&gt;</span>
            <span class="c">&lt;!-- (1) --&gt;</span>
            <span class="nt">&lt;value&gt;</span>org.terasoluna.gfw.common.exception.ResultMessagesNotificationException<span class="nt">&lt;/value&gt;</span>
            <span class="c">&lt;!-- (2) --&gt;</span>
            <span class="nt">&lt;value&gt;</span>com.example.common.XxxException<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/set&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">共通ライブラリのデフォルト設定で指定されている <code class="docutils literal"><span class="pre">ResultMessagesNotificationException</span></code> を除外対象に指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">プロジェクトで用意した例外クラスを除外対象に指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>全ての例外クラスをログ出力対象とする場合は、以下のような設定となる。</p>
<ul class="simple">
<li><strong>spring-mvc.xml</strong></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;handlerExceptionResolverLoggingInterceptor&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.HandlerExceptionResolverLoggingInterceptor&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionLogger&quot;</span> <span class="na">ref=</span><span class="s">&quot;exceptionLogger&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;ignoreExceptions&quot;</span><span class="nt">&gt;&lt;null</span> <span class="nt">/&gt;&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ignoreExceptionsプロパティに <code class="docutils literal"><span class="pre">null</span></code> を指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">null</span></code> を指定すると、全ての例外クラスがログ出力対象となる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div>
<div class="section" id="defaulthandlerexceptionresolverhttp">
<span id="exception-handling-appendix-defaulthandlerexceptionresolver-label"></span><h3><a class="toc-backref" href="#id109">4.2.5.4. DefaultHandlerExceptionResolverで設定されるHTTPレスポンスコードについて</a><a class="headerlink" href="#defaulthandlerexceptionresolverhttp" title="Permalink to this headline">¶</a></h3>
<p>DefaultHandlerExceptionResolverでハンドリングされるフレームワーク例外と、HTTPステータスコードのマッピングを、以下に記載する。</p>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="11%" />
<col width="67%" />
<col width="22%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">ハンドリングされるフレームワーク例外</th>
<th class="head">HTTPステータスコード</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.web.HttpRequestMethodNotSupportedException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">405</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.web.HttpMediaTypeNotSupportedException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">415</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.web.HttpMediaTypeNotAcceptableException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">406</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.web.bind.MissingPathVariableException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">500</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.web.bind.MissingServletRequestParameterException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">400</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.web.bind.ServletRequestBindingException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">400</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.beans.ConversionNotSupportedException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">500</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.beans.TypeMismatchException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">400</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.http.converter.HttpMessageNotReadableException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">400</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.http.converter.HttpMessageNotWritableException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">500</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.web.bind.MethodArgumentNotValidException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">400</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.web.multipart.support.MissingServletRequestPartException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">400</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(13)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.validation.BindException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">400</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(14)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.web.servlet.NoHandlerFoundException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">404</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(15)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.web.context.request.async.AsyncRequestTimeoutException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">503</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="SessionManagement.html" title="4.3. セッション管理"
             >next</a> |</li>
        <li class="right" >
          <a href="Validation.html" title="4.1. 入力チェック"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.6.2.SP1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >4. Webアプリ開発機能</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer">
      © Copyright 2013, NTT DATA Corporation. © Copyright 2013, NTT Corporation.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3.Theme is <a href="http://github.com/vimalkvn/solar-theme">Solar</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>
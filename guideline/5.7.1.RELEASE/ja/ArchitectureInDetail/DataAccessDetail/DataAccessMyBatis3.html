<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>6.2. データベースアクセス（MyBatis3編） &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.7.1.RELEASE documentation</title>
    <link rel="stylesheet" href="../../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '5.7.1.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="6.3. データベースアクセス（JPA編）" href="DataAccessJpa.html" />
    <link rel="prev" title="6.1. データベースアクセス（共通編）" href="DataAccessCommon.html" /><script async src="https://www.googletagmanager.com/gtag/js?id=G-847V2Q99G8"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date()); gtag('config', 'G-847V2Q99G8');
</script>
<script src="../../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../../_static/solarized-dark.css" rel="stylesheet">
<link href="../../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="DataAccessJpa.html" title="6.3. データベースアクセス（JPA編）"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="DataAccessCommon.html" title="6.1. データベースアクセス（共通編）"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.7.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">6. データアクセス</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">6.2. データベースアクセス（MyBatis3編）</a><ul>
<li><a class="reference internal" href="#overview">6.2.1. Overview</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3overviewaboutmybatis3">6.2.1.1. MyBatis3について</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3overviewaboutcomponentconstitutionofmybatis3">6.2.1.1.1. MyBatis3のコンポーネント構成について</a></li>
</ul>
</li>
<li><a class="reference internal" href="#mybatis3spring">6.2.1.2. MyBatis3とSpringの連携について</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3overviewaboutcomponentconstitutionofmybatisspring">6.2.1.2.1. MyBatis-Springのコンポーネント構成について</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">6.2.2. How to use</a><ul>
<li><a class="reference internal" href="#pom-xml">6.2.2.1. pom.xmlの設定</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesettingscooperatewithmybatis3andspring">6.2.2.2. MyBatis3とSpringを連携するための設定</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesettingsdatasource">6.2.2.2.1. データソースの設定</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesettingstransactionmanager">6.2.2.2.2. トランザクション管理の設定</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesettingsmybatis-spring">6.2.2.2.3. MyBatis-Springの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesettingsmybatis3">6.2.2.3. MyBatis3の設定</a><ul>
<li><a class="reference internal" href="#fetchsize">6.2.2.3.1. <code class="docutils literal"><span class="pre">fetchSize</span></code>の設定</a></li>
<li><a class="reference internal" href="#sql">6.2.2.3.2. SQL実行モードの設定</a></li>
<li><a class="reference internal" href="#typealias">6.2.2.3.3. TypeAliasの設定</a></li>
<li><a class="reference internal" href="#nulljdbc">6.2.2.3.4. NULL値とJDBC型のマッピング設定</a></li>
<li><a class="reference internal" href="#typehandler">6.2.2.3.5. TypeHandlerの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtodababaseaccess">6.2.2.4. データベースアクセス処理の実装</a><ul>
<li><a class="reference internal" href="#repository">6.2.2.4.1. Repositoryインタフェースの作成</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtodababaseaccesscreatemappingfile">6.2.2.4.2. マッピングファイルの作成</a></li>
<li><a class="reference internal" href="#crud">6.2.2.4.3. CRUD処理の実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#javabean">6.2.2.5. 検索結果とJavaBeanのマッピング方法</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtouseresultmappingbyauto">6.2.2.5.1. 検索結果の自動マッピング</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtouseresultmappingbymanual">6.2.2.5.2. 検索結果の手動マッピング</a></li>
</ul>
</li>
<li><a class="reference internal" href="#entity">6.2.2.6. Entityの検索処理</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtousefindone">6.2.2.6.1. 単一キーのEntityの取得</a></li>
<li><a class="reference internal" href="#id26">6.2.2.6.2. 複合キーのEntityの取得</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousefindmultiple">6.2.2.6.3. Entityの検索</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousecount">6.2.2.6.4. Entityの件数の取得</a></li>
<li><a class="reference internal" href="#entity-mybatis3">6.2.2.6.5. Entityのページネーション検索(MyBatis3標準方式)</a></li>
<li><a class="reference internal" href="#entity-sql">6.2.2.6.6. Entityのページネーション検索(SQL絞り込み方式)</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousefindpageusingsort">6.2.2.6.7. Entityのページネーション検索(検索結果のソート)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousecreate">6.2.2.7. Entityの登録処理</a><ul>
<li><a class="reference internal" href="#entity1">6.2.2.7.1. Entityの1件登録</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousegenid">6.2.2.7.2. キーの生成</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousecreatemultiple">6.2.2.7.3. Entityの一括登録</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtouseupdate">6.2.2.8. Entityの更新処理</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtouseupdateone">6.2.2.8.1. Entityの1件更新</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtouseupdatemultiple">6.2.2.8.2. Entityの一括更新</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousedelete">6.2.2.9. Entityの削除処理</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtousedeleteone">6.2.2.9.1. Entityの1件削除</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousedeletemultiple">6.2.2.9.2. Entityの一括削除</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousedynamicsql">6.2.2.10. 動的SQLの実装</a><ul>
<li><a class="reference internal" href="#if">6.2.2.10.1. if要素の実装</a></li>
<li><a class="reference internal" href="#choose">6.2.2.10.2. choose要素の実装</a></li>
<li><a class="reference internal" href="#where">6.2.2.10.3. where要素の実装</a></li>
<li><a class="reference internal" href="#set">6.2.2.10.4. set要素の実装例</a></li>
<li><a class="reference internal" href="#foreach">6.2.2.10.5. foreach要素の実装例</a></li>
<li><a class="reference internal" href="#bind">6.2.2.10.6. bind要素の実装例</a></li>
</ul>
</li>
<li><a class="reference internal" href="#like">6.2.2.11. LIKE検索時のエスケープ</a></li>
<li><a class="reference internal" href="#sql-injection">6.2.2.12. SQL Injection対策</a><ul>
<li><a class="reference internal" href="#id45">6.2.2.12.1. バインド変数を使って埋め込む方法</a></li>
<li><a class="reference internal" href="#id46">6.2.2.12.2. 置換変数を使って埋め込む方法</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend">6.2.3. How to extend</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendsqlshare">6.2.3.1. SQL文の共有</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendtypehandler">6.2.3.2. TypeHandlerの実装</a><ul>
<li><a class="reference internal" href="#joda-timetypehandler">6.2.3.2.1. Joda-Time用のTypeHandlerの実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resulthandler">6.2.3.3. ResultHandlerの実装</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortype">6.2.3.4. SQL実行モードの利用</a><ul>
<li><a class="reference internal" href="#preparedstatement">6.2.3.4.1. PreparedStatement再利用モードの利用</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatch">6.2.3.4.2. バッチモードの利用</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchindividualsetting">6.2.3.4.2.1. 個別にバッチモードのRepositoryを作成するための設定</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchbulksetting">6.2.3.4.2.2. 一括でバッチモードのRepositoryを作成するための設定</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchusage">6.2.3.4.2.3. バッチモードのRepositoryの使用例</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchnotes">6.2.3.4.3. バッチモードのRepository利用時の注意点</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchnotesupdateresult">6.2.3.4.3.1. 更新結果の判定</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchnotesduplicate">6.2.3.4.3.2. 一意制約違反の検知方法</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchnotesmethodcallorder">6.2.3.4.3.3. Repositoryのメソッドの呼び出し順番</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendstoredprocedure">6.2.3.5. ストアドプロシージャの実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#appendix">6.2.4. Appendix</a><ul>
<li><a class="reference internal" href="#mapper">6.2.4.1. Mapperインタフェースの仕組みについて</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3appendixsettingstypealias">6.2.4.2. TypeAliasの設定</a><ul>
<li><a class="reference internal" href="#id61">6.2.4.2.1. TypeAliasをクラス単位に設定</a></li>
<li><a class="reference internal" href="#id62">6.2.4.2.2. デフォルトで付与されるエイリアス名の上書き</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3appendixswitchingsqlbydatabase">6.2.4.3. データベースによるSQL切り替えについて</a></li>
<li><a class="reference internal" href="#entity1sql">6.2.4.4. 関連Entityを１回のSQLで取得する方法について</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3appendixacquirerelatedobjectsatoncetable">6.2.4.4.1. テーブルレイアウトとデータ</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3appendixacquirerelatedobjectsatonceentity">6.2.4.4.2. Entityのクラス図</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3appendixacquirerelatedobjectsatoncerepository">6.2.4.4.3. Repositoryインタフェースの実装</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3appendixacquirerelatedobjectsatoncesql">6.2.4.4.4. SQLの実装</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3appendixacquirerelatedobjectsatoncemapping">6.2.4.4.5. マッピングの実装</a><ul>
<li><a class="reference internal" href="#order">6.2.4.4.5.1. Orderオブジェクトへのマッピングの実装</a></li>
<li><a class="reference internal" href="#orderstatus">6.2.4.4.5.2. OrderStatusオブジェクトへのマッピングの実装</a></li>
<li><a class="reference internal" href="#orderitem">6.2.4.4.5.3. OrderItemオブジェクトへのマッピングの実装</a></li>
<li><a class="reference internal" href="#item">6.2.4.4.5.4. Itemオブジェクトへのマッピングの実装</a></li>
<li><a class="reference internal" href="#category">6.2.4.4.5.5. Categoryオブジェクトへのマッピングの実装</a></li>
<li><a class="reference internal" href="#ordercoupon">6.2.4.4.5.6. OrderCouponオブジェクトへのマッピングの実装</a></li>
<li><a class="reference internal" href="#coupon">6.2.4.4.5.7. Couponオブジェクトへのマッピングの実装</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3appendixacquirerelatedobjectsatonceobject">6.2.4.4.5.8. マッピング後のオブジェクト図</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#entitysql">6.2.4.5. 関連EntityをネストしたSQLを使用して取得する方法について</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3appendixnestedselectmapping">6.2.4.5.1. 関連EntityをネストしたSQLを使用して取得する実装例</a></li>
<li><a class="reference internal" href="#entitylazy-load">6.2.4.5.2. 関連EntityをLazy Loadするための設定</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3appendixnestedselectlazysettinglibrary">6.2.4.5.2.1. バイトコード操作ライブラリの追加</a></li>
<li><a class="reference internal" href="#lazy-loadmybatis">6.2.4.5.2.2. Lazy Loadを使用するためのMyBatisの設定</a></li>
<li><a class="reference internal" href="#lazy-load">6.2.4.5.2.3. Lazy Loadの実行タイミングを制御するための設定</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="DataAccessCommon.html"
                        title="previous chapter">6.1. データベースアクセス（共通編）</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="DataAccessJpa.html"
                        title="next chapter">6.3. データベースアクセス（JPA編）</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/ArchitectureInDetail/DataAccessDetail/DataAccessMyBatis3.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="mybatis3">
<h1>6.2. データベースアクセス（MyBatis3編）<a class="headerlink" href="#mybatis3" title="Permalink to this headline">¶</a></h1>
<div class="admonition caution">
  <p class="first admonition-title">Caution</p>
  <p><strong>本バージョンの内容は既に古くなっています</strong>。最新のガイドラインは<a href="http://terasolunaorg.github.io/guideline/">こちら</a>からご参照ください。</p>
</div>
<div class="contents local topic" id="id1">
<p class="topic-title">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id91">Overview</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3overviewaboutmybatis3" id="id92">MyBatis3について</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3overviewaboutcomponentconstitutionofmybatis3" id="id93">MyBatis3のコンポーネント構成について</a></li>
</ul>
</li>
<li><a class="reference internal" href="#mybatis3spring" id="id94">MyBatis3とSpringの連携について</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3overviewaboutcomponentconstitutionofmybatisspring" id="id95">MyBatis-Springのコンポーネント構成について</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use" id="id96">How to use</a><ul>
<li><a class="reference internal" href="#pom-xml" id="id97">pom.xmlの設定</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesettingscooperatewithmybatis3andspring" id="id98">MyBatis3とSpringを連携するための設定</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesettingsdatasource" id="id99">データソースの設定</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesettingstransactionmanager" id="id100">トランザクション管理の設定</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesettingsmybatis-spring" id="id101">MyBatis-Springの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesettingsmybatis3" id="id102">MyBatis3の設定</a><ul>
<li><a class="reference internal" href="#fetchsize" id="id103"><code class="docutils literal"><span class="pre">fetchSize</span></code>の設定</a></li>
<li><a class="reference internal" href="#sql" id="id104">SQL実行モードの設定</a></li>
<li><a class="reference internal" href="#typealias" id="id105">TypeAliasの設定</a></li>
<li><a class="reference internal" href="#nulljdbc" id="id106">NULL値とJDBC型のマッピング設定</a></li>
<li><a class="reference internal" href="#typehandler" id="id107">TypeHandlerの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtodababaseaccess" id="id108">データベースアクセス処理の実装</a><ul>
<li><a class="reference internal" href="#repository" id="id109">Repositoryインタフェースの作成</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtodababaseaccesscreatemappingfile" id="id110">マッピングファイルの作成</a></li>
<li><a class="reference internal" href="#crud" id="id111">CRUD処理の実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#javabean" id="id112">検索結果とJavaBeanのマッピング方法</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtouseresultmappingbyauto" id="id113">検索結果の自動マッピング</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtouseresultmappingbymanual" id="id114">検索結果の手動マッピング</a></li>
</ul>
</li>
<li><a class="reference internal" href="#entity" id="id115">Entityの検索処理</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtousefindone" id="id116">単一キーのEntityの取得</a></li>
<li><a class="reference internal" href="#id26" id="id117">複合キーのEntityの取得</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousefindmultiple" id="id118">Entityの検索</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousecount" id="id119">Entityの件数の取得</a></li>
<li><a class="reference internal" href="#entity-mybatis3" id="id120">Entityのページネーション検索(MyBatis3標準方式)</a></li>
<li><a class="reference internal" href="#entity-sql" id="id121">Entityのページネーション検索(SQL絞り込み方式)</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousefindpageusingsort" id="id122">Entityのページネーション検索(検索結果のソート)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousecreate" id="id123">Entityの登録処理</a><ul>
<li><a class="reference internal" href="#entity1" id="id124">Entityの1件登録</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousegenid" id="id125">キーの生成</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousecreatemultiple" id="id126">Entityの一括登録</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtouseupdate" id="id127">Entityの更新処理</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtouseupdateone" id="id128">Entityの1件更新</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtouseupdatemultiple" id="id129">Entityの一括更新</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousedelete" id="id130">Entityの削除処理</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtousedeleteone" id="id131">Entityの1件削除</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousedeletemultiple" id="id132">Entityの一括削除</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousedynamicsql" id="id133">動的SQLの実装</a><ul>
<li><a class="reference internal" href="#if" id="id134">if要素の実装</a></li>
<li><a class="reference internal" href="#choose" id="id135">choose要素の実装</a></li>
<li><a class="reference internal" href="#where" id="id136">where要素の実装</a></li>
<li><a class="reference internal" href="#set" id="id137">set要素の実装例</a></li>
<li><a class="reference internal" href="#foreach" id="id138">foreach要素の実装例</a></li>
<li><a class="reference internal" href="#bind" id="id139">bind要素の実装例</a></li>
</ul>
</li>
<li><a class="reference internal" href="#like" id="id140">LIKE検索時のエスケープ</a></li>
<li><a class="reference internal" href="#sql-injection" id="id141">SQL Injection対策</a><ul>
<li><a class="reference internal" href="#id45" id="id142">バインド変数を使って埋め込む方法</a></li>
<li><a class="reference internal" href="#id46" id="id143">置換変数を使って埋め込む方法</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend" id="id144">How to extend</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendsqlshare" id="id145">SQL文の共有</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendtypehandler" id="id146">TypeHandlerの実装</a><ul>
<li><a class="reference internal" href="#joda-timetypehandler" id="id147">Joda-Time用のTypeHandlerの実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resulthandler" id="id148">ResultHandlerの実装</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortype" id="id149">SQL実行モードの利用</a><ul>
<li><a class="reference internal" href="#preparedstatement" id="id150">PreparedStatement再利用モードの利用</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatch" id="id151">バッチモードの利用</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchnotes" id="id152">バッチモードのRepository利用時の注意点</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendstoredprocedure" id="id153">ストアドプロシージャの実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#appendix" id="id154">Appendix</a><ul>
<li><a class="reference internal" href="#mapper" id="id155">Mapperインタフェースの仕組みについて</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3appendixsettingstypealias" id="id156">TypeAliasの設定</a><ul>
<li><a class="reference internal" href="#id61" id="id157">TypeAliasをクラス単位に設定</a></li>
<li><a class="reference internal" href="#id62" id="id158">デフォルトで付与されるエイリアス名の上書き</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3appendixswitchingsqlbydatabase" id="id159">データベースによるSQL切り替えについて</a></li>
<li><a class="reference internal" href="#entity1sql" id="id160">関連Entityを１回のSQLで取得する方法について</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3appendixacquirerelatedobjectsatoncetable" id="id161">テーブルレイアウトとデータ</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3appendixacquirerelatedobjectsatonceentity" id="id162">Entityのクラス図</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3appendixacquirerelatedobjectsatoncerepository" id="id163">Repositoryインタフェースの実装</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3appendixacquirerelatedobjectsatoncesql" id="id164">SQLの実装</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3appendixacquirerelatedobjectsatoncemapping" id="id165">マッピングの実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#entitysql" id="id166">関連EntityをネストしたSQLを使用して取得する方法について</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3appendixnestedselectmapping" id="id167">関連EntityをネストしたSQLを使用して取得する実装例</a></li>
<li><a class="reference internal" href="#entitylazy-load" id="id168">関連EntityをLazy Loadするための設定</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<span id="dataaccessmybatis3overview"></span><h2><a class="toc-backref" href="#id91">6.2.1. Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>本節では、<a class="reference external" href="https://mybatis.org/mybatis-3/">MyBatis3</a>を使用してデータベースにアクセスする方法について説明する。</p>
<p>本ガイドラインでは、MyBatis3のMapperインタフェースをRepositoryインタフェースとして使用することを前提としている。
Repositoryインタフェースについては、「<a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html#repository-label"><span class="std std-ref">Repositoryの実装</span></a>」を参照されたい。</p>
<div class="line-block">
<div class="line">Overviewでは、MyBatis3とMyBatis-Springを使用してデータベースアクセスする際のアーキテクチャについて説明を行う。</div>
<div class="line">実際の使用方法については、「<a class="reference internal" href="#dataaccessmybatis3howtouse"><span class="std std-ref">How to use</span></a>」を参照されたい。</div>
</div>
<blockquote>
<div><div class="figure align-center" id="id75">
<a class="reference internal image-reference" href="../../_images/DataAccessMyBatis3Scope.png"><img alt="Scope of description" src="../../_images/DataAccessMyBatis3Scope.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Scope of description</strong></span></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="dataaccessmybatis3overviewaboutmybatis3">
<span id="id3"></span><h3><a class="toc-backref" href="#id92">6.2.1.1. MyBatis3について</a><a class="headerlink" href="#dataaccessmybatis3overviewaboutmybatis3" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">MyBatis3は、O/R Mapperの一つだが、データベースで管理されているレコードとオブジェクトをマッピングするという考え方ではなく、
SQLとオブジェクトをマッピングするという考え方で開発されたO/R Mapperである。</div>
<div class="line">そのため、正規化されていないデータベースへアクセスする場合や、発行するSQLをO/R Mapperに任せずに、
アプリケーション側で完全に制御したい場合に有効なO/R Mapperである。</div>
</div>
<p>本ガイドラインでは、MyBatis3から追加されたMapperインタフェースを使用して、EntityのCRUD操作を行う。
Mapperインタフェースの詳細については、「<a class="reference internal" href="#dataaccessmybatis3appendixaboutmappermechanism"><span class="std std-ref">Mapperインタフェースの仕組みについて</span></a>」を参照されたい。</p>
<p>本ガイドラインでは、MyBatis3の全ての機能の使用方法について説明を行うわけではないため、
「<a class="reference external" href="https://mybatis.org/mybatis-3/">MyBatis 3 REFERENCE DOCUMENTATION</a> 」も合わせて参照して頂きたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="dataaccessmybatis3overviewaboutcomponentconstitutionofmybatis3">
<span id="id4"></span><h4><a class="toc-backref" href="#id93">6.2.1.1.1. MyBatis3のコンポーネント構成について</a><a class="headerlink" href="#dataaccessmybatis3overviewaboutcomponentconstitutionofmybatis3" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">MyBatis3の主要なコンポーネント(設定ファイル)について説明する。</div>
<div class="line">MyBatis3では、設定ファイルの定義に基づき、以下のコンポーネントが互いに連携する事によって、SQLの実行及びO/Rマッピングを実現している。</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="22%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">コンポーネント/設定ファイル</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>MyBatis設定ファイル</td>
<td><p class="first">MyBatis3の動作設定を記載するXMLファイル。</p>
<p class="last">データベースの接続先、マッピングファイルのパス、MyBatisの動作設定などを記載するファイルである。
Springと連携して使用する場合は、データベースの接続先やマッピングファイルのパスの設定を本設定ファイルに指定する必要がないため、
MyBatis3のデフォルトの動作を変更又は拡張する際に、設定を行う事になる。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">org.apache.ibatis.session.</span></code>
<code class="docutils literal"><span class="pre">SqlSessionFactoryBuilder</span></code></td>
<td><p class="first">MyBatis設定ファイルを読込み、<code class="docutils literal"><span class="pre">SqlSessionFactory</span></code> を生成するためのコンポーネント。</p>
<p class="last">Springと連携して使用する場合は、アプリケーションのクラスから本コンポーネントを直接扱うことはない。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">org.apache.ibatis.session.</span></code>
<code class="docutils literal"><span class="pre">SqlSessionFactory</span></code></td>
<td><p class="first"><code class="docutils literal"><span class="pre">SqlSession</span></code> を生成するためのコンポーネント。</p>
<p class="last">Springと連携して使用する場合は、アプリケーションのクラスから本コンポーネントを直接扱うことはない。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">org.apache.ibatis.session.</span></code>
<code class="docutils literal"><span class="pre">SqlSession</span></code></td>
<td><p class="first">SQLの発行やトランザクション制御のAPIを提供するコンポーネント。</p>
<p>MyBatis3を使ってデータベースにアクセスする際に、もっとも重要な役割を果たすコンポーネントである。</p>
<p class="last">Springと連携して使用する場合は、アプリケーションのクラスから本コンポーネントを直接扱うことは、基本的にはない。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>Mapperインタフェース</td>
<td><p class="first">マッピングファイルに定義したSQLをタイプセーフに呼び出すためのインタフェース。</p>
<p class="last">Mapperインターフェースに対する実装クラスは、MyBatis3が自動で生成するため、開発者はインターフェースのみ作成すればよい。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>マッピングファイル</td>
<td>SQLとO/Rマッピングの設定を記載するXMLファイル。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">以下に、MyBatis3の主要コンポーネントが、どのような流れでデータベースにアクセスしているのかを説明する。</div>
<div class="line">データベースにアクセスするための処理は、大きく２つにわける事ができる。</div>
</div>
<ul class="simple">
<li>アプリケーションの起動時に行う処理。下記(1)～(3)の処理が、これに該当する。</li>
<li>クライアントからのリクエスト毎に行う処理。下記(4)～(10)の処理が、これに該当する。</li>
</ul>
<blockquote>
<div><div class="figure align-center" id="id76">
<a class="reference internal image-reference" href="../../_images/DataAccessMyBatis3RelationshipOfComponents.png"><img alt="Relationship of MyBatis3 components" src="../../_images/DataAccessMyBatis3RelationshipOfComponents.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Relationship of MyBatis3 components</strong></span></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">アプリケーションの起動時に行う処理は、以下の流れで実行する。</div>
<div class="line">Springと連携時の流れについては、「<a class="reference internal" href="#dataaccessmybatis3overviewaboutcomponentconstitutionofmybatisspring"><span class="std std-ref">MyBatis-Springのコンポーネント構成について</span></a>」を参照されたい。</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>アプリケーションは、<code class="docutils literal"><span class="pre">SqlSessionFactoryBuilder</span></code> に対して <code class="docutils literal"><span class="pre">SqlSessionFactory</span></code> の構築を依頼する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">SqlSessionFactoryBuilder</span></code> は、 <code class="docutils literal"><span class="pre">SqlSessionFactory</span></code> を生成するためにMyBatis設定ファイルを読込む。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">SqlSessionFactoryBuilder</span></code> は、MyBatis設定ファイルの定義に基づき <code class="docutils literal"><span class="pre">SqlSessionFactory</span></code> を生成する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">クライアントからのリクエスト毎に行う処理は、以下の流れで実行する。</div>
<div class="line">Springと連携時の流れについては、「<a class="reference internal" href="#dataaccessmybatis3overviewaboutcomponentconstitutionofmybatisspring"><span class="std std-ref">MyBatis-Springのコンポーネント構成について</span></a>」を参照されたい。</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>クライアントは、アプリケーションに対して処理を依頼する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>アプリケーションは、 <code class="docutils literal"><span class="pre">SqlSessionFactoryBuilder</span></code> によって構築された <code class="docutils literal"><span class="pre">SqlSessionFactory</span></code> から <code class="docutils literal"><span class="pre">SqlSession</span></code> を取得する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">SqlSessionFactory</span></code> は、<code class="docutils literal"><span class="pre">SqlSession</span></code> を生成しアプリケーションに返却する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td>アプリケーションは、 <code class="docutils literal"><span class="pre">SqlSession</span></code> からMapperインタフェースの実装オブジェクトを取得する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="8">
<li></li>
</ol>
</td>
<td><p class="first">アプリケーションは、Mapperインタフェースのメソッドを呼び出す。</p>
<p class="last">Mapperインタフェースの仕組みについては、「<a class="reference internal" href="#dataaccessmybatis3appendixaboutmappermechanism"><span class="std std-ref">Mapperインタフェースの仕組みについて</span></a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="9">
<li></li>
</ol>
</td>
<td>Mapperインタフェースの実装オブジェクトは、 <code class="docutils literal"><span class="pre">SqlSession</span></code> のメソッドを呼び出して、SQLの実行を依頼する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="10">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">SqlSession</span></code> は、マッピングファイルから実行するSQLを取得し、SQLを実行する。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>トランザクション制御について</strong></p>
<p>上記フローには記載していないが、トランザクションのコミット及びロールバックは、
アプリケーションのコードから<code class="docutils literal"><span class="pre">SqlSession</span></code> のAPIを直接呼び出して行う。</p>
<p class="last">ただし、Springと連携する場合は、Springのトランザクション管理機能がコミット及びロールバックを行うため、
アプリケーションのクラスから<code class="docutils literal"><span class="pre">SqlSession</span></code> のトランザクションを制御するためのAPIを直接呼び出すことはない。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="mybatis3spring">
<span id="dataaccessmybatis3overviewaboutmybatisspring"></span><h3><a class="toc-backref" href="#id94">6.2.1.2. MyBatis3とSpringの連携について</a><a class="headerlink" href="#mybatis3spring" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">MyBatis3とSpringを連携させるライブラリとして、MyBatisから<a class="reference external" href="http://mybatis.org/spring/">MyBatis-Spring</a> というライブラリが提供されている。</div>
<div class="line">このライブラリを使用することで、MyBatis3のコンポーネントをSpringのDIコンテナ上で管理する事ができる。</div>
</div>
<p>MyBatis-Springを使用すると、</p>
<ul class="simple">
<li>MyBatis3のSQLの実行をSpringが管理しているトランザクション内で行う事ができるため、MyBatis3のAPIに依存したトランザクション制御を行う必要がない。</li>
<li>MyBatis3の例外は、Springが用意している汎用的な例外(<code class="docutils literal"><span class="pre">org.springframework.dao.DataAccessException</span></code> )へ変換されるため、MyBatis3のAPIに依存しない例外処理を実装する事ができる。</li>
<li>MyBatis3を使用するための初期化処理は、すべてMyBatis-SpringのAPIが行ってくれるため、基本的にはMyBatis3のAPIを直接使用する必要がない。</li>
<li>スレッドセーフなMapperオブジェクトの生成が行えるため、シングルトンのServiceクラスにMapperオブジェクトを注入する事ができる。</li>
</ul>
<p>等のメリットがある。
本ガイドラインでは、MyBatis-Springを使用することを前提とする。</p>
<p>本ガイドラインでは、MyBatis-Springの全ての機能の使用方法について説明を行うわけではないため、
「<a class="reference external" href="http://mybatis.org/spring/">Mybatis-Spring REFERENCE DOCUMENTATION</a> 」も合わせて参照して頂きたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="dataaccessmybatis3overviewaboutcomponentconstitutionofmybatisspring">
<span id="id5"></span><h4><a class="toc-backref" href="#id95">6.2.1.2.1. MyBatis-Springのコンポーネント構成について</a><a class="headerlink" href="#dataaccessmybatis3overviewaboutcomponentconstitutionofmybatisspring" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">MyBatis-Springの主要なコンポーネントについて説明する。</div>
<div class="line">MyBatis-Springでは、以下のコンポーネントが連携する事によって、MyBatis3とSpringの連携を実現している。</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="22%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">コンポーネント/設定ファイル</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">org.mybatis.spring.</span></code>
<code class="docutils literal"><span class="pre">SqlSessionFactoryBean</span></code></td>
<td><p class="first"><code class="docutils literal"><span class="pre">SqlSessionFactory</span></code> を構築し、SpringのDIコンテナ上にオブジェクトを格納するためのコンポーネント。</p>
<p class="last">MyBatis3標準では、MyBatis設定ファイルに定義されている情報を基に<code class="docutils literal"><span class="pre">SqlSessionFactory</span></code> を構築するが、
<code class="docutils literal"><span class="pre">SqlSessionFactoryBean</span></code> を使用すると、MyBatis設定ファイルがなくても<code class="docutils literal"><span class="pre">SqlSessionFactory</span></code> を構築することができる。
もちろん、併用することも可能である。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">org.mybatis.spring.mapper.</span></code>
<code class="docutils literal"><span class="pre">MapperFactoryBean</span></code></td>
<td><p class="first">シングルトンのMapperオブジェクトを構築し、SpringのDIコンテナ上にオブジェクトを格納するためのコンポーネント。</p>
<p class="last">MyBatis3標準の仕組みで生成されるMapperオブジェクトはスレッドセーフではないため、
スレッド毎にインスタンスを割り当てる必要があった。
MyBatis-Springのコンポーネントで作成されたMapperオブジェクトは、
スレッドセーフなMapperオブジェクトを生成する事ができるため、ServiceなどのシングルトンのコンポーネントにDIすることが可能となる。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">org.mybatis.spring.</span></code>
<code class="docutils literal"><span class="pre">SqlSessionTemplate</span></code></td>
<td><p class="first"><code class="docutils literal"><span class="pre">SqlSession</span></code> インターフェースを実装したシングルトン版の<code class="docutils literal"><span class="pre">SqlSession</span></code> コンポーネント。</p>
<p>MyBatis3標準の仕組みで生成される<code class="docutils literal"><span class="pre">SqlSession</span></code> オブジェクトはスレッドセーフではないため、
スレッド毎にインスタンスを割り当てる必要があった。
MyBatis-Springのコンポーネントで作成された<code class="docutils literal"><span class="pre">SqlSession</span></code> オブジェクトは、
スレッドセーフな<code class="docutils literal"><span class="pre">SqlSession</span></code> オブジェクトが生成されるため、ServiceなどのシングルトンのコンポーネントにDIすることが可能になる。</p>
<p class="last">ただし、本ガイドラインでは、<code class="docutils literal"><span class="pre">SqlSession</span></code> を直接扱う事は想定していない。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>以下に、MyBatis-Springの主要コンポーネントが、どのような流れでデータベースにアクセスしているのかを説明する。
データベースにアクセスするための処理は、大きく２つにわける事ができる。</p>
<ul class="simple">
<li>アプリケーションの起動時に行う処理。下記(1)～(4)の処理が、これに該当する。</li>
<li>クライアントからのリクエスト毎に行う処理。下記(5)～(11)の処理が、これに該当する。</li>
</ul>
<blockquote>
<div><div class="figure align-center" id="id77">
<a class="reference internal image-reference" href="../../_images/DataAccessMyBatisSpringRelationshipOfComponents.png"><img alt="Relationship of MyBatis-Spring components" src="../../_images/DataAccessMyBatisSpringRelationshipOfComponents.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Relationship of MyBatis-Spring components</strong></span></p>
</div>
</div></blockquote>
<p>アプリケーションの起動時に行う処理は、以下の流れで実行される。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">SqlSessionFactoryBean</span></code> は、<code class="docutils literal"><span class="pre">SqlSessionFactoryBuilder</span></code> に対して <code class="docutils literal"><span class="pre">SqlSessionFactory</span></code> の構築を依頼する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">SqlSessionFactoryBuilder</span></code> は、 <code class="docutils literal"><span class="pre">SqlSessionFactory</span></code> を生成するためにMyBatis設定ファイルを読込む。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">SqlSessionFactoryBuilder</span></code> は、MyBatis設定ファイルの定義に基づき <code class="docutils literal"><span class="pre">SqlSessionFactory</span></code> を生成する。</p>
<p class="last">生成された<code class="docutils literal"><span class="pre">SqlSessionFactory</span></code> は、SpringのDIコンテナによって管理される。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">MapperFactoryBean</span></code> は、スレッドセーフな<code class="docutils literal"><span class="pre">SqlSession</span></code> (<code class="docutils literal"><span class="pre">SqlSessionTemplate</span></code> )と、
スレッドセーフなMapperオブジェクト(MapperインタフェースのProxyオブジェクト)を生成する。</p>
<p class="last">生成されたMapperオブジェクトは、SpringのDIコンテナによって管理され、ServiceクラスなどにDIされる。
Mapperオブジェクトは、スレッドセーフな<code class="docutils literal"><span class="pre">SqlSession</span></code> (<code class="docutils literal"><span class="pre">SqlSessionTemplate</span></code> )を利用することで、スレッドセーフな実装を提供している。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>クライアントからのリクエスト毎に行う処理は、以下の流れで実行される。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>クライアントは、アプリケーションに対して処理を依頼する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td><p class="first">アプリケーション(Service)は、 DIコンテナによって注入されたMapperオブジェクト(Mapperインターフェースを実装したProxyオブジェクト)のメソッドを呼び出す。</p>
<p class="last">Mapperインタフェースの仕組みについては、 「<a class="reference internal" href="#dataaccessmybatis3appendixaboutmappermechanism"><span class="std std-ref">Mapperインタフェースの仕組みについて</span></a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td>Mapperオブジェクトは、呼び出されたメソッドに対応する<code class="docutils literal"><span class="pre">SqlSession</span></code> (<code class="docutils literal"><span class="pre">SqlSessionTemplate</span></code> )のメソッドを呼び出す。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="8">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">SqlSession</span></code> (<code class="docutils literal"><span class="pre">SqlSessionTemplate</span></code> )は、Proxy化されたスレッドセーフな<code class="docutils literal"><span class="pre">SqlSession</span></code> のメソッドを呼び出す。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="9">
<li></li>
</ol>
</td>
<td><p class="first">Proxy化されたスレッドセーフな<code class="docutils literal"><span class="pre">SqlSession</span></code> は、トランザクションに割り当てられているMyBatis3標準の<code class="docutils literal"><span class="pre">SqlSession</span></code> を使用する。</p>
<p class="last">トランザクションに割り当てられている<code class="docutils literal"><span class="pre">SqlSession</span></code> が存在しない場合は、MyBatis3標準の<code class="docutils literal"><span class="pre">SqlSession</span></code> を取得するために、
<code class="docutils literal"><span class="pre">SqlSessionFactory</span></code> のメソッドを呼び出す。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="10">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">SqlSessionFactory</span></code> は、MyBatis3標準の<code class="docutils literal"><span class="pre">SqlSession</span></code> を返却する。</p>
<p class="last">返却されたMyBatis3標準の<code class="docutils literal"><span class="pre">SqlSession</span></code> はトランザクションに割り当てられるため、同一トランザクション内であれば、新たに生成されることはなく、
同じ<code class="docutils literal"><span class="pre">SqlSession</span></code> が使用される仕組みになっている。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="11">
<li></li>
</ol>
</td>
<td>MyBatis3標準の<code class="docutils literal"><span class="pre">SqlSession</span></code> は、マッピングファイルから実行するSQLを取得し、SQLを実行する。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>トランザクション制御について</strong></p>
<p>上記フローには記載していないが、トランザクションのコミット及びロールバックは、Springのトランザクション管理機能が行う。</p>
<p class="last">Springのトランザクション管理機能を使用したトランザクション管理方法については、
「<a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html#service-transaction-management"><span class="std std-ref">トランザクション管理について</span></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-use">
<span id="dataaccessmybatis3howtouse"></span><h2><a class="toc-backref" href="#id96">6.2.2. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<p>ここからは、実際にMyBatis3を使用して、データベースにアクセスするための設定及び実装方法について、説明する。</p>
<p>以降の説明は、大きく以下に分類する事ができる。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="22%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">分類</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>アプリケーション全体の設定</td>
<td><p class="first">MyBatis3をアプリケーションで使用するための設定方法や、
MyBatis3の動作を変更するための設定方法について記載している。</p>
<p>ここに記載している内容は、<strong>プロジェクト立ち上げ時にアプリケーションアーキテクトが設定を行う時に必要となる。</strong>そのため、基本的にはアプリケーション開発者が個々に意識する必要はない部分である。</p>
<p>以下のセクションが、この分類に該当する。</p>
<ul class="simple">
<li><a class="reference internal" href="#dataaccessmybatis3howtousesettingspomxml"><span class="std std-ref">pom.xmlの設定</span></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesettingscooperatewithmybatis3andspring"><span class="std std-ref">MyBatis3とSpringを連携するための設定</span></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesettingsmybatis3"><span class="std std-ref">MyBatis3の設定</span></a></li>
</ul>
<p class="last"><a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw-web-multi-blank/tree/5.7.1.RELEASE#multi-blank-project-with-mybatis3">MyBatis3用のブランクプロジェクト</a> からプロジェクトを生成した場合は、
上記で説明している設定の多くが既に設定済みの状態となっているため、アプリケーションアーキテクトは、
プロジェクト特性を判断し、必要に応じて設定の追加及び変更を行うことになる。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>データアクセス処理の実装方法</td>
<td><p class="first">MyBatis3を使った基本的なデータアクセス処理の実装方法について記載している。</p>
<p>ここに記載している内容は、<strong>アプリケーション開発者が実装時に必要となる。</strong></p>
<p>以下のセクションが、この分類に該当する。</p>
<ul class="last simple">
<li><a class="reference internal" href="#dataaccessmybatis3howtodababaseaccess"><span class="std std-ref">データベースアクセス処理の実装</span></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtouseresultsetmapping"><span class="std std-ref">検索結果とJavaBeanのマッピング方法</span></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousefind"><span class="std std-ref">Entityの検索処理</span></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousecreate"><span class="std std-ref">Entityの登録処理</span></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtouseupdate"><span class="std std-ref">Entityの更新処理</span></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousedelete"><span class="std std-ref">Entityの削除処理</span></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousedynamicsql"><span class="std std-ref">動的SQLの実装</span></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtouselikeescape"><span class="std std-ref">LIKE検索時のエスケープ</span></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesqlinjectioncountermeasure"><span class="std std-ref">SQL Injection対策</span></a></li>
</ul>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="pom-xml">
<span id="dataaccessmybatis3howtousesettingspomxml"></span><h3><a class="toc-backref" href="#id97">6.2.2.1. pom.xmlの設定</a><a class="headerlink" href="#pom-xml" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">インフラストラクチャ層にMyBatis3を使用する場合は、<code class="file docutils literal"><span class="pre">pom.xml</span></code>にterasoluna-gfw-mybatis3-dependenciesへの依存関係を追加する。</div>
<div class="line">マルチプロジェクト構成の場合は、domainプロジェクトの<code class="file docutils literal"><span class="pre">pom.xml</span></code>(<code class="file docutils literal"><span class="pre">projectName-domain/pom.xml</span></code>)に追加する。</div>
</div>
<p><a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw-web-multi-blank/tree/5.7.1.RELEASE#multi-blank-project-with-mybatis3">MyBatis3用のブランクプロジェクト</a> からプロジェクトを生成した場合は、terasoluna-gfw-mybatis3-dependenciesへの依存関係は、設定済みの状態である。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0</span>
<span class="s">        http://maven.apache.org/maven-v4_0_0.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>projectName-domain<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;packaging&gt;</span>jar<span class="nt">&lt;/packaging&gt;</span>

    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.example<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>mybatis3-example-app<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;relativePath&gt;</span>../pom.xml<span class="nt">&lt;/relativePath&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>

    <span class="nt">&lt;dependencies&gt;</span>

        <span class="c">&lt;!-- omitted --&gt;</span>

<span class="hll">        <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;dependency&gt;</span>
</span><span class="hll">            <span class="nt">&lt;groupId&gt;</span>org.terasoluna.gfw<span class="nt">&lt;/groupId&gt;</span>
</span><span class="hll">            <span class="nt">&lt;artifactId&gt;</span>terasoluna-gfw-mybatis3-dependencies<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="hll">            <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
</span><span class="hll">        <span class="nt">&lt;/dependency&gt;</span>
</span>
        <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;/dependencies&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;/project&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>terasoluna-gfw-mybatis3をdependenciesに追加する。
terasoluna-gfw-mybatis3には、MyBatis3及びMyBatis-Springへの依存関係が定義されている。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">上記設定例は、依存ライブラリのバージョンを親プロジェクトである terasoluna-gfw-parent で管理する前提であるため、pom.xmlでのバージョンの指定は不要である。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtousesettingscooperatewithmybatis3andspring">
<span id="id8"></span><h3><a class="toc-backref" href="#id98">6.2.2.2. MyBatis3とSpringを連携するための設定</a><a class="headerlink" href="#dataaccessmybatis3howtousesettingscooperatewithmybatis3andspring" title="Permalink to this headline">¶</a></h3>
<div class="section" id="dataaccessmybatis3howtousesettingsdatasource">
<span id="id9"></span><h4><a class="toc-backref" href="#id99">6.2.2.2.1. データソースの設定</a><a class="headerlink" href="#dataaccessmybatis3howtousesettingsdatasource" title="Permalink to this headline">¶</a></h4>
<p>MyBatis3とSpringを連携する場合、データソースはSpringのDIコンテナで管理しているデータソースを使用する必要がある。</p>
<p><a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw-web-multi-blank/tree/5.7.1.RELEASE#multi-blank-project-with-mybatis3">MyBatis3用のブランクプロジェクト</a> からプロジェクトを生成した場合は、Apache Commons DBCPのデータソースが設定済みの状態であるため、
プロジェクトの要件に合わせて設定を変更すること。</p>
<p>データソースの設定方法については、共通編の「<a class="reference internal" href="DataAccessCommon.html#data-access-common-howtouse-datasource"><span class="std std-ref">データソースの設定</span></a> 」を参照されたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtousesettingstransactionmanager">
<span id="id11"></span><h4><a class="toc-backref" href="#id100">6.2.2.2.2. トランザクション管理の設定</a><a class="headerlink" href="#dataaccessmybatis3howtousesettingstransactionmanager" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">MyBatis3とSpringを連携する場合、
トランザクション管理はSpringのDIコンテナで管理している<code class="docutils literal"><span class="pre">PlatformTransactionManager</span></code> を使用する必要がある。</div>
</div>
<p>ローカルトランザクションを使用する場合は、JDBCのAPIを呼び出してトランザクション制御を行う<code class="docutils literal"><span class="pre">DataSourceTransactionManager</span></code> を使用する。</p>
<p><a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw-web-multi-blank/tree/5.7.1.RELEASE#multi-blank-project-with-mybatis3">MyBatis3用のブランクプロジェクト</a> からプロジェクトを生成した場合は、<code class="docutils literal"><span class="pre">DataSourceTransactionManager</span></code> が設定済みの状態である。</p>
<p>設定例は以下の通り。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">projectName-env/src/main/resources/META-INF/spring/projectName-env.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xmlns:jee=</span><span class="s">&quot;http://www.springframework.org/schema/jee&quot;</span>
    <span class="na">xmlns:jdbc=</span><span class="s">&quot;http://www.springframework.org/schema/jdbc&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/jdbc</span>
<span class="s">        https://www.springframework.org/schema/jdbc/spring-jdbc.xsd</span>
<span class="s">        http://www.springframework.org/schema/jee</span>
<span class="s">        https://www.springframework.org/schema/jee/spring-jee.xsd</span>
<span class="s">        http://www.springframework.org/schema/beans</span>
<span class="s">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;transactionManager&quot;</span>
</span><span class="hll">        <span class="na">class=</span><span class="s">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;rollbackOnCommitFailure&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/bean&gt;</span>
</span>
    <span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">PlatformTransactionManager</span></code> として、<code class="docutils literal"><span class="pre">org.springframework.jdbc.datasource.DataSourceTransactionManager</span></code> を指定する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">dataSource</span></code> プロパティに、設定済みのデータソースのbeanを指定する。</p>
<p class="last">トランザクション内でSQLを実行する際は、ここで指定したデータソースからコネクションが取得される。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first">コミット時にエラーが発生した場合にロールバック処理が呼び出される様にする。</p>
<p class="last">この設定を追加することで、「未確定状態の操作を持つコネクションがコネクションプールに戻ることで発生する意図しないコミット（コネクション再利用時のコミット、コネクションクローズ時の暗黙コミットなど）」が発生するリスクを下げることができる。
ただし、ロールバック処理時にエラーが発生する可能性もあるため、意図しないコミットが発生するリスクがなくなるわけではない点に留意されたい。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>PlatformTransactionManagerのbean IDについて</strong></p>
<p>id属性には、<code class="docutils literal"><span class="pre">transactionManager</span></code> を指定することを推奨する。</p>
<p class="last"><code class="docutils literal"><span class="pre">transactionManager</span></code> 以外の値を指定すると、
<code class="docutils literal"><span class="pre">&lt;tx:annotation-driven&gt;</span></code> タグのtransaction-manager属性に同じ値を設定する必要がある。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>アプリケーションサーバから提供されているトランザクションマネージャを使用する場合は、JTAのAPIを呼び出してトランザクション制御を行う
<code class="docutils literal"><span class="pre">org.springframework.transaction.jta.JtaTransactionManager</span></code> を使用する。</p>
<p>設定例は以下の通り。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">projectName-env/src/main/resources/META-INF/spring/projectName-env.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xmlns:jee=</span><span class="s">&quot;http://www.springframework.org/schema/jee&quot;</span>
    <span class="na">xmlns:jdbc=</span><span class="s">&quot;http://www.springframework.org/schema/jdbc&quot;</span>
<span class="hll">    <span class="na">xmlns:tx=</span><span class="s">&quot;http://www.springframework.org/schema/tx&quot;</span>
</span>    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/jdbc</span>
<span class="s">        https://www.springframework.org/schema/jdbc/spring-jdbc.xsd</span>
<span class="s">        http://www.springframework.org/schema/jee</span>
<span class="s">        https://www.springframework.org/schema/jee/spring-jee.xsd</span>
<span class="s">        http://www.springframework.org/schema/beans</span>
<span class="s">        https://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="hll"><span class="s">        http://www.springframework.org/schema/tx</span>
</span><span class="hll"><span class="s">        https://www.springframework.org/schema/tx/spring-tx.xsd&quot;</span><span class="nt">&gt;</span>
</span>
    <span class="c">&lt;!-- omitted --&gt;</span>

<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;tx:jta-transaction-manager</span> <span class="nt">/&gt;</span>
</span>
    <span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">&lt;tx:jta-transaction-manager</span> <span class="pre">/&gt;</span></code> を指定すると、
アプリケーションサーバに対して最適な <code class="docutils literal"><span class="pre">JtaTransactionManager</span></code> がbean定義される。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtousesettingsmybatis-spring">
<span id="id13"></span><h4><a class="toc-backref" href="#id101">6.2.2.2.3. MyBatis-Springの設定</a><a class="headerlink" href="#dataaccessmybatis3howtousesettingsmybatis-spring" title="Permalink to this headline">¶</a></h4>
<p>MyBatis3とSpringを連携する場合、MyBatis-Springのコンポーネントを使用して、</p>
<ul class="simple">
<li>MyBatis3とSpringを連携するために必要となる処理がカスタマイズされた<code class="docutils literal"><span class="pre">SqlSessionFactory</span></code>の生成</li>
<li>スレッドセーフなMapperオブジェクト(MapperインタフェースのProxyオブジェクト)の生成</li>
</ul>
<p>を行う必要がある。</p>
<p><a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw-web-multi-blank/tree/5.7.1.RELEASE#multi-blank-project-with-mybatis3">MyBatis3用のブランクプロジェクト</a> からプロジェクトを生成した場合は、MyBatis3とSpringを連携するための設定は、
設定済みの状態である。</p>
<p>設定例は以下の通り。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/spring/projectName-infra.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
<span class="hll">    <span class="na">xmlns:mybatis=</span><span class="s">&quot;http://mybatis.org/schema/mybatis-spring&quot;</span>
</span>    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans</span>
<span class="s">        https://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="hll"><span class="s">        http://mybatis.org/schema/mybatis-spring</span>
</span><span class="hll"><span class="s">        http://mybatis.org/schema/mybatis-spring.xsd&quot;</span><span class="nt">&gt;</span>
</span>
    <span class="nt">&lt;import</span> <span class="na">resource=</span><span class="s">&quot;classpath:/META-INF/spring/projectName-env.xml&quot;</span> <span class="nt">/&gt;</span>

<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sqlSessionFactory&quot;</span>
</span><span class="hll">        <span class="na">class=</span><span class="s">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;configLocation&quot;</span>
</span><span class="hll">            <span class="na">value=</span><span class="s">&quot;classpath:/META-INF/mybatis/mybatis-config.xml&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/bean&gt;</span>
</span>
<span class="hll">    <span class="c">&lt;!-- (4) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;mybatis:scan</span> <span class="na">base-package=</span><span class="s">&quot;com.example.domain.repository&quot;</span> <span class="nt">/&gt;</span>
</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">SqlSessionFactory</span></code> を生成するためのコンポーネントとして、<code class="docutils literal"><span class="pre">SqlSessionFactoryBean</span></code> をbean定義する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">dataSource</span></code> プロパティに、設定済みのデータソースのbeanを指定する。</p>
<p class="last">MyBatis3の処理の中でSQLを発行する際は、ここで指定したデータソースからコネクションが取得される。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">configLocation</span></code> プロパティに、MyBatis設定ファイルのパスを指定する。</p>
<p class="last">ここで指定したファイルが<code class="docutils literal"><span class="pre">SqlSessionFactory</span></code> を生成する時に読み込まれる。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p class="first">Mapperインタフェースをスキャンするために<code class="docutils literal"><span class="pre">&lt;mybatis:scan&gt;</span></code> を定義し、<code class="docutils literal"><span class="pre">base-package</span></code> 属性には、
Mapperインタフェースが格納されている基底パッケージを指定する。</p>
<p>指定されたパッケージ配下に格納されている Mapperインタフェースがスキャンされ、
スレッドセーフなMapperオブジェクト(MapperインタフェースのProxyオブジェクト)が自動的に生成される。</p>
<p class="last"><strong>【指定するパッケージは、各プロジェクトで決められたパッケージにすること】</strong></p>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>MyBatis3の設定方法について</strong></p>
<p class="last"><code class="docutils literal"><span class="pre">SqlSessionFactoryBean</span></code> を使用する場合、MyBatis3の設定は、
MyBatis設定ファイルではなくbeanのプロパティに直接指定することもできるが、
本ガイドラインでは、MyBatis3自体の設定はMyBatis標準の設定ファイルに指定する方法を推奨する。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtousesettingsmybatis3">
<span id="id15"></span><h3><a class="toc-backref" href="#id102">6.2.2.3. MyBatis3の設定</a><a class="headerlink" href="#dataaccessmybatis3howtousesettingsmybatis3" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">MyBatis3では、MyBatis3の動作をカスタマイズするための仕組みが用意されている。</div>
<div class="line">MyBatis3の動作をカスタマイズする場合は、MyBatis設定ファイルに設定値を追加する事で実現可能である。</div>
</div>
<div class="line-block">
<div class="line">ここでは、アプリケーションの特性に依存しない設定項目についてのみ、説明を行う。</div>
<div class="line">その他の設定項目に関しては、
「<a class="reference external" href="https://mybatis.org/mybatis-3/configuration.html">MyBatis 3 REFERENCE DOCUMENTATION(Configuration XML)</a> 」を参照し、
アプリケーションの特性にあった設定を行うこと。</div>
<div class="line">基本的にはデフォルト値のままでも問題ないが、アプリケーションの特性を考慮し、必要に応じて設定を変更すること。</div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>MyBatis設定ファイルの格納場所について</strong></p>
<p>本ガイドラインでは、MyBatis設定ファイルは、
<code class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/mybatis/mybatis-config.xml</span></code>に格納することを推奨している。</p>
<p class="last"><a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw-web-multi-blank/tree/5.7.1.RELEASE#multi-blank-project-with-mybatis3">MyBatis3用のブランクプロジェクト</a> からプロジェクトを生成した場合は、上記ファイルは格納済みの状態である。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="fetchsize">
<span id="dataaccessmybatis3howtousesettingsdefaultfetchsize"></span><h4><a class="toc-backref" href="#id103">6.2.2.3.1. <code class="docutils literal"><span class="pre">fetchSize</span></code>の設定</a><a class="headerlink" href="#fetchsize" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">大量のデータを返すようなクエリを記述する場合は、JDBCドライバに対して適切な<code class="docutils literal"><span class="pre">fetchSize</span></code>を指定する必要がある。</div>
<div class="line"><code class="docutils literal"><span class="pre">fetchSize</span></code>は、JDBCドライバとデータベース間の１回の通信で取得するデータの件数を設定するパラメータである。</div>
</div>
<p><code class="docutils literal"><span class="pre">fetchSize</span></code>を指定しないとJDBCドライバのデフォルト値が利用されるため、
使用するJDBCドライバによっては以下の問題を引き起こす可能性がある。</p>
<ul class="simple">
<li>デフォルト値が小さいJDBCドライバの場合は「性能の劣化」</li>
<li>デフォルト値が大きい又は制限がないJDBCドライバの場合は「メモリの枯渇」</li>
</ul>
<p>これらの問題が発生しないように制御するために、MyBatis3は以下の２つの方法で<code class="docutils literal"><span class="pre">fetchSize</span></code>を指定することができる。</p>
<ul class="simple">
<li>全てのクエリに対して適用する「デフォルトの<code class="docutils literal"><span class="pre">fetchSize</span></code>」の指定</li>
<li>特定のクエリに対して適用する「クエリ単位の<code class="docutils literal"><span class="pre">fetchSize</span></code>」の指定</li>
</ul>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>「デフォルトのfetchSize」について</strong></p>
<p class="last">「デフォルトの<code class="docutils literal"><span class="pre">fetchSize</span></code>」は、MyBatis 3.3.0以降のバージョンで利用することができる。</p>
</div>
</div></blockquote>
<p>以下に、「デフォルトの<code class="docutils literal"><span class="pre">fetchSize</span></code>」を指定する方法を示す。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/mybatis/mybatis-config.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE configuration PUBLIC &quot;-//mybatis.org/DTD Config 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span>
<span class="nt">&lt;configuration&gt;</span>

    <span class="nt">&lt;settings&gt;</span>
        <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;setting</span> <span class="na">name=</span><span class="s">&quot;defaultFetchSize&quot;</span> <span class="na">value=</span><span class="s">&quot;100&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/settings&gt;</span>

<span class="nt">&lt;/configuration&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">defaultFetchSize</span></code>に、１回の通信で取得するデータの件数を指定する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p></p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>「クエリ単位のfetchSize」の指定方法</strong></p>
<p class="last"><code class="docutils literal"><span class="pre">fetchSize</span></code>をクエリ単位に指定する必要がある場合は、
検索用のSQLを記述するためのXML要素(<code class="docutils literal"><span class="pre">&lt;select&gt;</span></code>要素)の<code class="docutils literal"><span class="pre">fetchSize</span></code>属性に値を指定すればよい。</p>
</div>
</div></blockquote>
<p>なお、大量のデータを返すようなクエリを記述する場合は、
「<a class="reference internal" href="#dataaccessmybatis3howtoextendresulthandler"><span class="std std-ref">ResultHandlerの実装</span></a>」の利用も検討すること。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="sql">
<span id="dataaccessmybatis3howtousesettingsexecutortype"></span><h4><a class="toc-backref" href="#id104">6.2.2.3.2. SQL実行モードの設定</a><a class="headerlink" href="#sql" title="Permalink to this headline">¶</a></h4>
<p>MyBatis3では、SQLを実行するモードとして以下の3種類を用意している。</p>
<div class="line-block">
<div class="line">どのモードを使用するかは、各モードの特性と制約、及び性能要件を考慮して決定して頂きたい。</div>
<div class="line">実行モードの設定方法などについては、「<a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortype"><span class="std std-ref">SQL実行モードの利用</span></a>」を参照されたい。</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="17%" />
<col width="72%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">モード</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>SIMPLE</td>
<td><p class="first">SQL実行毎に新しい<code class="docutils literal"><span class="pre">java.sql.PreparedStatement</span></code>を作成する。</p>
<p class="last">MyBatisのデフォルトの動作であり、<a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw-web-multi-blank/tree/5.7.1.RELEASE#multi-blank-project-with-mybatis3">MyBatis3用のブランクプロジェクト</a> も<code class="docutils literal"><span class="pre">SIMPLE</span></code>モードとなっている。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>REUSE</td>
<td><p class="first"><code class="docutils literal"><span class="pre">PreparedStatement</span></code>をキャッシュし再利用する。</p>
<p>同一トランザクション内で同じSQLを複数回実行する場合は、
<code class="docutils literal"><span class="pre">REUSE</span></code>モードで実行すると、<code class="docutils literal"><span class="pre">SIMPLE</span></code>モードと比較して性能向上が期待できる。</p>
<p class="last">これは、SQLを解析して<code class="docutils literal"><span class="pre">PreparedStatement</span></code>を生成する処理の実行回数を減らす事ができるためである。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>BATCH</td>
<td><p class="first">更新系のSQLをバッチ実行する。(<code class="docutils literal"><span class="pre">java.sql.Statement#executeBatch()</span></code>を使ってSQLを実行する)。</p>
<p>同一トランザクション内で更新系のSQLを連続して大量に実行する場合は、<code class="docutils literal"><span class="pre">BATCH</span></code>モードで実行すると、
<code class="docutils literal"><span class="pre">SIMPLE</span></code>モードや<code class="docutils literal"><span class="pre">REUSE</span></code>モードと比較して性能向上が期待できる。</p>
<p>これは、</p>
<ul class="simple">
<li>SQLを解析して<code class="docutils literal"><span class="pre">PreparedStatement</span></code>を生成する処理の実行回数</li>
<li>サーバと通信する回数</li>
</ul>
<p>を減らす事ができるためである。</p>
<p class="last">ただし、<code class="docutils literal"><span class="pre">BATCH</span></code>モードを使用する場合は、MyBatisの動きが<code class="docutils literal"><span class="pre">SIMPLE</span></code>モードや<code class="docutils literal"><span class="pre">SIMPLE</span></code>モードと異なる部分がある。
具体的な違いと注意点については、「<a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchnotes"><span class="std std-ref">バッチモードのRepository利用時の注意点</span></a>」を参照されたい。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="typealias">
<span id="dataaccessmybatis3howtousesettingstypealias"></span><h4><a class="toc-backref" href="#id105">6.2.2.3.3. TypeAliasの設定</a><a class="headerlink" href="#typealias" title="Permalink to this headline">¶</a></h4>
<p>TypeAliasを使用すると、マッピングファイルで指定するJavaクラスに対して、エイリアス名(短縮名)を割り当てる事ができる。</p>
<p>TypeAliasを使用しない場合、マッピングファイルで指定する<code class="docutils literal"><span class="pre">type</span></code> 属性、<code class="docutils literal"><span class="pre">parameterType</span></code> 属性、<code class="docutils literal"><span class="pre">resultType</span></code> 属性などには、
Javaクラスの完全修飾クラス名(FQCN)を指定する必要があるため、マッピングファイルの記述効率の低下、記述ミスの増加などが懸念される。</p>
<p>本ガイドラインでは、記述効率の向上、記述ミスの削減、マッピングファイルの可読性向上などを目的として、TypeAliasを使用することを推奨する。</p>
<p><a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw-web-multi-blank/tree/5.7.1.RELEASE#multi-blank-project-with-mybatis3">MyBatis3用のブランクプロジェクト</a> からプロジェクトを生成した場合は、
Entityを格納するパッケージ(<code class="docutils literal"><span class="pre">${projectPackage}.domain.model</span></code>)配下に格納されるクラスがTypeAliasの対象となっている。
必要に応じて、設定を追加されたい。</p>
<p>TypeAliasの設定方法は以下の通り。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/mybatis/mybatis-config.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE configuration</span>
<span class="cp">  PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span>
<span class="cp">  &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
    <span class="nt">&lt;typeAliases&gt;</span>
<span class="hll">        <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;package</span> <span class="na">name=</span><span class="s">&quot;com.example.domain.model&quot;</span> <span class="nt">/&gt;</span>
</span>    <span class="nt">&lt;/typeAliases&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">package</span></code> 要素の<code class="docutils literal"><span class="pre">name</span></code> 属性に、エイリアスを設定するクラスが格納されているパッケージ名を指定する。</p>
<p>指定したパッケージ配下に格納されているクラスは、パッケージの部分が除去された部分が、エイリアス名となる。
上記例だと、<code class="docutils literal"><span class="pre">com.example.domain.model.Account</span></code> クラスのエイリアス名は、<code class="docutils literal"><span class="pre">Account</span></code> となる。</p>
<p class="last"><strong>【指定するパッケージは、各プロジェクトで決められたパッケージにすること】</strong></p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>クラス単位にType Aliasを設定する方法について</strong></p>
<p class="last">Type Aliasの設定には、クラス単位に設定する方法やエイリアス名を明示的に指定する方法が用意されている。
詳細は、Appendixの「<a class="reference internal" href="#dataaccessmybatis3appendixsettingstypealias"><span class="std std-ref">TypeAliasの設定</span></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>TypeAliasを使用した際の、マッピングファイルの記述例は以下の通り。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>

<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.account.AccountRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;accountResultMap&quot;</span>
<span class="hll">        <span class="na">type=</span><span class="s">&quot;Account&quot;</span><span class="nt">&gt;</span>
</span>        <span class="c">&lt;!-- omitted --&gt;</span>
    <span class="nt">&lt;/resultMap&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span>
<span class="hll">        <span class="na">parameterType=</span><span class="s">&quot;string&quot;</span>
</span>        <span class="na">resultMap=</span><span class="s">&quot;accountResultMap&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- omitted --&gt;</span>
    <span class="nt">&lt;/select&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findByCriteria&quot;</span>
<span class="hll">        <span class="na">parameterType=</span><span class="s">&quot;AccountSearchCriteria&quot;</span>
</span>        <span class="na">resultMap=</span><span class="s">&quot;accountResultMap&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- omitted --&gt;</span>
    <span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>MyBatis3標準のエイリアス名について</strong></p>
<p>プリミティブ型やプリミティブラッパ型などの一般的なJavaクラスについては、予めエイリアス名が設定されている。</p>
<p class="last">予め設定されるエイリアス名については、
「<a class="reference external" href="https://mybatis.org/mybatis-3/configuration.html#typeAliases">MyBatis 3 REFERENCE DOCUMENTATION(Configuration XML-typeAliases-)</a> 」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="nulljdbc">
<span id="dataaccessmybatis3howtousesettingsmappingnullandjdbctype"></span><h4><a class="toc-backref" href="#id106">6.2.2.3.4. NULL値とJDBC型のマッピング設定</a><a class="headerlink" href="#nulljdbc" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">使用しているデータベース(JDBCドライバ)によっては、カラム値をnullに設定する際に、エラーが発生する場合がある。</div>
<div class="line">この事象は、JDBCドライバが<code class="docutils literal"><span class="pre">null</span></code>値の設定と認識できるJDBC型を指定する事で、解決する事ができる。</div>
</div>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">null</span></code>値を設定した際に、以下の様なスタックトレースを伴うエラーが発生した場合は、<code class="docutils literal"><span class="pre">null</span></code>値とJDBC型のマッピングが必要となる。</div>
<div class="line">MyBatis3のデフォルトでは、<code class="docutils literal"><span class="pre">OTHER</span></code>と呼ばれる汎用的なJDBC型が指定されるが、<code class="docutils literal"><span class="pre">OTHER</span></code>だとエラーとなるJDBCドライバもある。</div>
</div>
<blockquote>
<div><div class="highlight-text"><div class="highlight"><pre><span></span><span class="hll">java.sql.SQLException: Invalid column type: 1111
</span>    at oracle.jdbc.driver.OracleStatement.getInternalType(OracleStatement.java:3916) ~[ojdbc6-11.2.0.2.0.jar:11.2.0.2.0]
    at oracle.jdbc.driver.OraclePreparedStatement.setNullCritical(OraclePreparedStatement.java:4541) ~[ojdbc6-11.2.0.2.0.jar:11.2.0.2.0]
    at oracle.jdbc.driver.OraclePreparedStatement.setNull(OraclePreparedStatement.java:4523) ~[ojdbc6-11.2.0.2.0.jar:11.2.0.2.0]
    ...
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Oracle使用時の動作について</strong></p>
<p>Oracle JDBC ドライバはJDBC型の<code class="docutils literal"><span class="pre">OTHER</span></code>をサポートしていないため、デフォルト設定のままだとエラーが発生することが確認されている。</p>
<p class="last">OracleではJDBC型の<code class="docutils literal"><span class="pre">NULL</span></code> 型を指定すれば、<code class="docutils literal"><span class="pre">null</span></code>値を正常にマッピングすることが可能となる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>以下に、MyBatis3のデフォルトの動作を変更する方法を示す。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/mybatis/mybatis-config.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE configuration PUBLIC &quot;-//mybatis.org/DTD Config 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span>
<span class="nt">&lt;configuration&gt;</span>

    <span class="nt">&lt;settings&gt;</span>
        <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;setting</span> <span class="na">name=</span><span class="s">&quot;jdbcTypeForNull&quot;</span> <span class="na">value=</span><span class="s">&quot;NULL&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/settings&gt;</span>

<span class="nt">&lt;/configuration&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">jdbcTypeForNullに、JDBC型を指定する。</p>
<p class="last">上記例では、<code class="docutils literal"><span class="pre">null</span></code>値のJDBC型として<code class="docutils literal"><span class="pre">NULL</span></code>型を指定している。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>項目単位で解決する方法について</strong></p>
<p>別の解決方法として、<code class="docutils literal"><span class="pre">null</span></code>値が設定される可能性があるプロパティのインラインパラメータに、
Java型に対応する適切なJDBC型を個別に指定する方法もある。</p>
<p class="last">ただし、インラインパラメータで個別に指定した場合、マッピングファイルの記述量及び指定ミスが発生する可能性が増えることが予想されるため、
本ガイドラインとしては、全体の設定でエラーを解決することを推奨している。
全体の設定を変更してもエラーが解決しない場合は、エラーが発生するプロパティについてのみ、個別に設定を行えばよい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="typehandler">
<span id="dataaccessmybatis3howtousesettingstypehandler"></span><h4><a class="toc-backref" href="#id107">6.2.2.3.5. TypeHandlerの設定</a><a class="headerlink" href="#typehandler" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">TypeHandler</span></code> は、JavaクラスとJDBC型をマッピングする時に使用される。</p>
<p>具体的には、</p>
<ul class="simple">
<li>SQLを発行する際に、Javaクラスのオブジェクトを<code class="docutils literal"><span class="pre">java.sql.PreparedStatement</span></code> のバインドパラメータとして設定する</li>
<li>SQLの発行結果として取得した<code class="docutils literal"><span class="pre">java.sql.ResultSet</span></code> から値を取得する</li>
</ul>
<p>際に、使用される。</p>
<p>プリミティブ型やプリミティブラッパ型などの一般的なJavaクラスについては、MyBatis3から<code class="docutils literal"><span class="pre">TypeHandler</span></code> が提供されており、
特別な設定を行う必要はない。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>BLOB用とCLOB用の実装について</strong></p>
<p>MyBatis 3.4で追加された<code class="docutils literal"><span class="pre">TypeHandler</span></code> は、JDBC 4.0 (Java 1.6)で追加されたAPIを使用することで、BLOBと<code class="docutils literal"><span class="pre">java.io.InputStream</span></code> 、
CLOBと<code class="docutils literal"><span class="pre">java.io.Reader</span></code> の変換を実現している。JDBC 4.0サポートのJDBCドライバーであれば、BLOB⇔<code class="docutils literal"><span class="pre">InputStream</span></code> 、CLOB⇔<code class="docutils literal"><span class="pre">Reader</span></code> 変換用のタイプハンドラーがデフォルトで有効になるため、<code class="docutils literal"><span class="pre">TypeHandler</span></code> を新たに実装する必要はない。</p>
<p>JDBC 4.0との互換性のないJDBCドライバを使う場合は、利用するJDBCドライバの互換バージョンを意識した<code class="docutils literal"><span class="pre">TypeHandler</span></code> を作成する必要がある。</p>
<p class="last">例えば、PostgreSQL用のJDBCドライバ(<code class="docutils literal"><span class="pre">postgresql-42.2.9.jar</span></code>)では、JDBC 4.0から追加されたメソッドの一部が、未実装の状態である。</p>
</div>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">mybatis-typehandlers-jsr310</span></code> で提供されていたJSR-310 Date and Time API用の<code class="docutils literal"><span class="pre">TypeHandler</span></code> が、MyBatis 3.4.5からコアモジュールに統合された。
これにより、依存ライブラリとして別途<code class="docutils literal"><span class="pre">mybatis-typehandlers-jsr310</span></code> を追加する必要はなくなった。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">MyBatis3から提供されている<code class="docutils literal"><span class="pre">TypeHandler</span></code> については、
「<a class="reference external" href="https://mybatis.org/mybatis-3/configuration.html#typeHandlers">MyBatis 3 REFERENCE DOCUMENTATION(Configuration XML-typeHandlers-)</a> 」を参照されたい。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>Enum型のマッピングについて</strong></p>
<p>MyBatis3のデフォルトの動作では、Enum型はEnumの定数名(文字列)とマッピングされる。</p>
<p>下記のようなEnum型の場合は、
<code class="docutils literal"><span class="pre">WAITING_FOR_ACTIVE</span></code> , <code class="docutils literal"><span class="pre">ACTIVE</span></code> , <code class="docutils literal"><span class="pre">EXPIRED</span></code> , <code class="docutils literal"><span class="pre">LOCKED</span></code> という文字列とマッピングされてテーブルに格納される。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.model</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">enum</span> <span class="n">AccountStatus</span> <span class="p">{</span>
    <span class="n">WAITING_FOR_ACTIVE</span><span class="p">,</span> <span class="n">ACTIVE</span><span class="p">,</span> <span class="n">EXPIRED</span><span class="p">,</span> <span class="n">LOCKED</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p class="last">MyBatisでは、Enum型を数値(定数の定義順)とマッピングする事もできる。数値とマッピングする方法については、
「<a class="reference external" href="https://mybatis.org/mybatis-3/configuration.html#Handling_Enums">MyBatis 3 REFERENCE DOCUMENTATION(Configuration XML-Handling Enums-)</a> 」を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p><code class="docutils literal"><span class="pre">TypeHandler</span></code> の作成が必要になるケースは、MyBatis3でサポートしていないJoda-TimeのクラスとJDBC型をマッピングする場合である。</p>
<p>具体的には、本ガイドラインで利用を推奨している「<a class="reference internal" href="../GeneralFuncDetail/JodaTime.html"><span class="doc">日付操作(Joda Time)</span></a>」の<code class="docutils literal"><span class="pre">org.joda.time.DateTime</span></code> 型と、JDBC型の<code class="docutils literal"><span class="pre">TIMESTAMP</span></code> 型をマッピングする場合に、<code class="docutils literal"><span class="pre">TypeHandler</span></code> の作成が必要となる。</p>
<p>Joda-TimeのクラスとJDBC型をマッピングする<code class="docutils literal"><span class="pre">TypeHandler</span></code> の作成例については、
「<a class="reference internal" href="#dataaccessmybatis3howtoextendtypehandler"><span class="std std-ref">TypeHandlerの実装</span></a>」を参照されたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>ここでは、作成した<code class="docutils literal"><span class="pre">TypeHandler</span></code> をMyBatisに適用する方法について説明を行う。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/mybatis/mybatis-config.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE configuration PUBLIC &quot;-//mybatis.org/DTD Config 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span>
<span class="nt">&lt;configuration&gt;</span>

    <span class="nt">&lt;typeHandlers&gt;</span>
        <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;package</span> <span class="na">name=</span><span class="s">&quot;com.example.infra.mybatis.typehandler&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/typeHandlers&gt;</span>

<span class="nt">&lt;/configuration&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">MyBatis設定ファイルに<code class="docutils literal"><span class="pre">TypeHandler</span></code> の設定を行う。</p>
<p class="last"><code class="docutils literal"><span class="pre">package</span></code>要素のname 属性に、作成した<code class="docutils literal"><span class="pre">TypeHandler</span></code> が格納されているパッケージ名を指定する。
指定したパッケージ配下に格納されている<code class="docutils literal"><span class="pre">TypeHandler</span></code> が、MyBatisによって自動検出される。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>上記例では、指定したパッケージ配下に格納されている<code class="docutils literal"><span class="pre">TypeHandler</span></code> をMyBatisによって自動検出させているが、
クラス単位に設定する事もできる。</p>
<p>クラス単位に<code class="docutils literal"><span class="pre">TypeHandler</span></code> を設定する場合は、<code class="docutils literal"><span class="pre">typeHandler</span></code>要素を使用する。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/mybatis/mybatis-config.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;typeHandlers&gt;</span>
<span class="hll">    <span class="nt">&lt;typeHandler</span> <span class="na">handler=</span><span class="s">&quot;xxx.yyy.zzz.CustomTypeHandler&quot;</span> <span class="nt">/&gt;</span>
</span>    <span class="nt">&lt;package</span> <span class="na">name=</span><span class="s">&quot;com.example.infra.mybatis.typehandler&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/typeHandlers&gt;</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>更に、<code class="docutils literal"><span class="pre">TypeHandler</span></code> の中でDIコンテナが管理しているbeanを使用したい場合は、
bean定義ファイル内で<code class="docutils literal"><span class="pre">TypeHandler</span></code> を指定すればよい。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/spring/projectName-infra.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:tx=</span><span class="s">&quot;http://www.springframework.org/schema/tx&quot;</span> <span class="na">xmlns:mybatis=</span><span class="s">&quot;http://mybatis.org/schema/mybatis-spring&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans</span>
<span class="s">    https://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">    http://www.springframework.org/schema/tx</span>
<span class="s">    https://www.springframework.org/schema/tx/spring-tx.xsd</span>
<span class="s">    http://mybatis.org/schema/mybatis-spring</span>
<span class="s">    http://mybatis.org/schema/mybatis-spring.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sqlSessionFactory&quot;</span> <span class="na">class=</span><span class="s">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;oracleDataSource&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;configLocation&quot;</span>
            <span class="na">value=</span><span class="s">&quot;classpath:/META-INF/mybatis/mybatis-config.xml&quot;</span> <span class="nt">/&gt;</span>
<span class="hll">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;typeHandlers&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">            <span class="nt">&lt;list&gt;</span>
</span><span class="hll">                <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;xxx.yyy.zzz.CustomTypeHandler&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">            <span class="nt">&lt;/list&gt;</span>
</span><span class="hll">        <span class="nt">&lt;/property&gt;</span>
</span>    <span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p><code class="docutils literal"><span class="pre">TypeHandler</span></code> を適用するJavaクラスとJDBC型のマッピングの指定は、</p>
<ul class="simple">
<li>MyBatis設定ファイル内の<code class="docutils literal"><span class="pre">typeHandler</span></code>要素の属性値として指定</li>
<li><code class="docutils literal"><span class="pre">&#64;org.apache.ibatis.type.MappedTypes</span></code>アノテーションと<code class="docutils literal"><span class="pre">&#64;org.apache.ibatis.type.MappedJdbcTypes</span></code>アノテーションに指定</li>
<li>MyBatis3から提供されている<code class="docutils literal"><span class="pre">TypeHandler</span></code> の基底クラス(<code class="docutils literal"><span class="pre">org.apache.ibatis.type.BaseTypeHandler</span></code>)を継承することで指定</li>
</ul>
<p>する方法がある。</p>
<p class="last">詳しくは、「<a class="reference external" href="https://mybatis.org/mybatis-3/configuration.html#typeHandlers">MyBatis 3 REFERENCE DOCUMENTATION(Configuration XML-typeHandlers-)</a> 」を参照されたい。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>上記の設定例は、いずれもアプリケーション全体に適用するための設定方法であったが、
フィールド毎に個別の<code class="docutils literal"><span class="pre">TypeHandler</span></code> を指定する事も可能である。
これは、アプリケーション全体に適用している<code class="docutils literal"><span class="pre">TypeHandler</span></code> を上書きする際に使用する。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot; &gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.image.ImageRepository&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;resultMapImage&quot;</span> <span class="na">type=</span><span class="s">&quot;Image&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;id&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span> <span class="nt">/&gt;</span>
<span class="hll">        <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;imageData&quot;</span> <span class="na">column=</span><span class="s">&quot;image_data&quot;</span> <span class="na">typeHandler=</span><span class="s">&quot;XxxBlobInputStreamTypeHandler&quot;</span> <span class="nt">/&gt;</span>
</span>        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;createdAt&quot;</span> <span class="na">column=</span><span class="s">&quot;created_at&quot;</span>  <span class="nt">/&gt;</span>
    <span class="nt">&lt;/resultMap&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;string&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;resultMapImage&quot;</span><span class="nt">&gt;</span>
        SELECT
            id
            ,image_data
            ,created_at
        FROM
            t_image
        WHERE
            id = #{id}
    <span class="nt">&lt;/select&gt;</span>
    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;create&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;Image&quot;</span><span class="nt">&gt;</span>
        INSERT INTO
            t_image
        (
            id
            ,image_data
            ,created_at
        )
        VALUES
        (
            #{id}
<span class="hll">            /* (3) */
</span><span class="hll">            ,#{imageData,typeHandler=XxxBlobInputStreamTypeHandler}
</span>            ,#{createdAt}
        )
    <span class="nt">&lt;/insert&gt;</span>
<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>検索結果(<code class="docutils literal"><span class="pre">ResultSet</span></code>)から値を取得する際は、
<code class="docutils literal"><span class="pre">id</span></code>又は<code class="docutils literal"><span class="pre">result</span></code>要素の<code class="docutils literal"><span class="pre">typeHandler</span></code>属性に適用する<code class="docutils literal"><span class="pre">TypeHandler</span></code> を指定する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">PreparedStatement</span></code>に値を設定する際は、
インラインパラメータの<code class="docutils literal"><span class="pre">typeHandler</span></code>属性に適用する<code class="docutils literal"><span class="pre">TypeHandler</span></code> を指定する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p class="last"><code class="docutils literal"><span class="pre">TypeHandler</span></code> をフィールド毎に個別に指定する場合は、<code class="docutils literal"><span class="pre">TypeHandler</span></code> のクラスにTypeAliasを設けることを推奨する。
TypeAliasの設定方法については、「<a class="reference internal" href="#dataaccessmybatis3howtousesettingstypealias"><span class="std std-ref">TypeAliasの設定</span></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtodababaseaccess">
<span id="id20"></span><h3><a class="toc-backref" href="#id108">6.2.2.4. データベースアクセス処理の実装</a><a class="headerlink" href="#dataaccessmybatis3howtodababaseaccess" title="Permalink to this headline">¶</a></h3>
<p>MyBatis3の機能を使用してデータベースにアクセスするための、具体的な実装方法について説明する。</p>
<div class="section" id="repository">
<span id="dataaccessmybatis3howtodababaseaccesscreaterepository"></span><h4><a class="toc-backref" href="#id109">6.2.2.4.1. Repositoryインタフェースの作成</a><a class="headerlink" href="#repository" title="Permalink to this headline">¶</a></h4>
<p>Entity毎にRepositoryインタフェースを作成する。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.repository.todo</span><span class="p">;</span>

<span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="p">{</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">JavaのインタフェースとしてRepositoryインタフェースを作成する。</p>
<p class="last">上記例では、<code class="docutils literal"><span class="pre">Todo</span></code>というEntityに対するRepositoryインタフェースを作成している。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtodababaseaccesscreatemappingfile">
<span id="id21"></span><h4><a class="toc-backref" href="#id110">6.2.2.4.2. マッピングファイルの作成</a><a class="headerlink" href="#dataaccessmybatis3howtodababaseaccesscreatemappingfile" title="Permalink to this headline">¶</a></h4>
<p>Repositoryインタフェース毎にマッピングファイルを作成する。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="c">&lt;!-- (1)  --&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">mapper</span></code>要素の<code class="docutils literal"><span class="pre">namespace</span></code>属性に、Repositoryインタフェースの完全修飾クラス名(FQCN)を指定する。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>マッピングファイルの格納先について</strong></p>
<p>マッピングファイルの格納先は、</p>
<ul class="simple">
<li>MyBatis3が自動的にマッピングファイルを読み込むために定めたルールに則ったディレクトリ</li>
<li>任意のディレクトリ</li>
</ul>
<p>のどちらかを選択することができる。</p>
<p><strong>本ガイドラインでは、MyBatis3が定めたルールに則ったディレクトリに格納し、マッピングファイルを自動的に読み込む仕組みを利用することを推奨する。</strong></p>
<p>マッピングファイルを自動的に読み込ませるためには、
Repositoryインタフェースのパッケージ階層と同じ階層で、マッピングファイルをクラスパス上に格納する必要がある。</p>
<p class="last">具体的には、
<code class="docutils literal"><span class="pre">com.example.domain.repository.todo.TodoRepository</span></code>というRepositoryインターフェースに対するマッピングファイル(<code class="file docutils literal"><span class="pre">TodoRepository.xml</span></code>)は、
<code class="docutils literal"><span class="pre">projectName-domain/src/main/resources/com/example/domain/repository/todo</span></code>ディレクトリに格納すればよい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="crud">
<span id="dataaccessmybatis3howtodababaseaccesscrud"></span><h4><a class="toc-backref" href="#id111">6.2.2.4.3. CRUD処理の実装</a><a class="headerlink" href="#crud" title="Permalink to this headline">¶</a></h4>
<p>ここからは、基本的なCRUD処理の実装方法と、SQL実装時の考慮点について説明を行う。</p>
<p>基本的なCRUD処理として、以下の処理の実装方法について説明を行う。</p>
<ul class="simple">
<li><a class="reference internal" href="#dataaccessmybatis3howtouseresultsetmapping"><span class="std std-ref">検索結果とJavaBeanのマッピング方法</span></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousefind"><span class="std std-ref">Entityの検索処理</span></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousecreate"><span class="std std-ref">Entityの登録処理</span></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtouseupdate"><span class="std std-ref">Entityの更新処理</span></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousedelete"><span class="std std-ref">Entityの削除処理</span></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousedynamicsql"><span class="std std-ref">動的SQLの実装</span></a></li>
</ul>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>MyBatis3を使用してCRUD処理を実装する際は、
検索したEntityがローカルキャッシュと呼ばれる領域にキャッシュされる仕組みになっている点を意識しておく必要がある。</p>
<p>MyBatis3が提供するローカルキャッシュのデフォルトの動作は以下の通りである。</p>
<ul class="simple">
<li>ローカルキャッシュは、トランザクション単位で管理する。</li>
<li>Entityのキャッシュは、「ステートメントID + 組み立てられたSQLのパターン + 組み立てられたSQLにバインドするパラメータ値 + ページ位置(取得範囲)」毎に行う。</li>
</ul>
<p>つまり、同一トランザクション内の処理において、
MyBatisが提供している検索APIを全て同じパラメータで呼び出すと、
2回目以降はSQLを発行せずに、キャッシュされているEntityのインスタンスが返却される。</p>
<p class="last">ここでは、 <strong>MyBatisのAPIが返却するEntityとローカルキャッシュで管理しているEntityが同じインスタンス</strong> という点を意識しておいてほしい。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">ローカルキャッシュは、ステートメント単位で管理するように変更する事もできる。
ローカルキャッシュをステートメント単位で管理する場合、MyBatisは毎回SQLを実行して最新のEntityを取得する。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>SQL実装時の考慮点として、以下の点について説明を行う。</p>
<ul class="simple">
<li><a class="reference internal" href="#dataaccessmybatis3howtouselikeescape"><span class="std std-ref">LIKE検索時のエスケープ</span></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesqlinjectioncountermeasure"><span class="std std-ref">SQL Injection対策</span></a></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>具体的な実装方法の説明を行う前に、以降の説明で登場するコンポーネントについて、簡単に説明しておく。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="28%" />
<col width="61%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">コンポーネント</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>Entity</td>
<td><p class="first">アプリケーションで扱う業務データを保持するJavaBeanクラス。</p>
<p class="last">Entityの詳細については、「<a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html#domainlayer-entity"><span class="std std-ref">Entityの実装</span></a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>Repositoryインタフェース</td>
<td><p class="first">EntityのCRUD操作を行うためのメソッドを定義するインタフェース。</p>
<p class="last">Repositoryの詳細については、「<a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html#repository-label"><span class="std std-ref">Repositoryの実装</span></a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>Serviceクラス</td>
<td><p class="first">業務ロジックを実行するためのクラス。</p>
<p class="last">Serviceの詳細については、「<a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html#service-label"><span class="std std-ref">Serviceの実装</span></a>」を参照されたい。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">本ガイドラインでは、アーキテクチャ上の用語を統一するために、
MyBatis3のMapperインタフェースの事をRepositoryインタフェースと呼んでいる。</p>
</div>
</div></blockquote>
<p>以降の説明では、「<a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html#domainlayer-entity"><span class="std std-ref">Entityの実装</span></a>」「<a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html#repository-label"><span class="std std-ref">Repositoryの実装</span></a>」「<a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html#service-label"><span class="std std-ref">Serviceの実装</span></a>」を読んでいる前提で説明を行う。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="javabean">
<span id="dataaccessmybatis3howtouseresultsetmapping"></span><h3><a class="toc-backref" href="#id112">6.2.2.5. 検索結果とJavaBeanのマッピング方法</a><a class="headerlink" href="#javabean" title="Permalink to this headline">¶</a></h3>
<p>Entityの検索処理の説明を行う前に、検索結果とJavaBeanのマッピング方法について説明を行う。</p>
<p>MyBatis3では、検索結果(<code class="docutils literal"><span class="pre">ResultSet</span></code>)をJavaBean(Entity)にマッピングする方法として、
自動マッピング と手動マッピングの2つの方法が用意されている。
それぞれ特徴があるので、<strong>プロジェクトの特性やアプリケーションで実行するSQLの特性などを考慮して、使用するマッピング方法を決めて頂きたい。</strong></p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>使用するマッピング方法について</strong></p>
<p>本ガイドラインでは、</p>
<ul class="simple">
<li>シンプルなマッピング(単一オブジェクトへのマッピング)の場合は自動マッピングを使用し、高度なマッピング(関連オブジェクトへのマッピング)が必要な場合は手動マッピングを使用する。</li>
<li>一律手動マッピングを使用する</li>
</ul>
<p>の、２つの案を提示する。これは、上記2案のどちらかを選択する事を強制するものではなく、あくまで選択肢のひとつと考えて頂きたい。</p>
<p class="last"><strong>アーキテクトは、自動マッピングと手動マッピングを使うケースの判断基準をプログラマに対して明確に示すことで、
アプリケーション全体として統一されたマッピング方法が使用されるように心がけてほしい。</strong></p>
</div>
</div></blockquote>
<p>以下に、自動マッピングと手動マッピングに対して、それぞれの特徴と使用例を説明する。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="dataaccessmybatis3howtouseresultmappingbyauto">
<span id="id22"></span><h4><a class="toc-backref" href="#id113">6.2.2.5.1. 検索結果の自動マッピング</a><a class="headerlink" href="#dataaccessmybatis3howtouseresultmappingbyauto" title="Permalink to this headline">¶</a></h4>
<p>MyBatis3では、検索結果(<code class="docutils literal"><span class="pre">ResultSet</span></code>)のカラムとJavaBeanのプロパティをマッピングする方法として、
カラム名とプロパティ名を一致させることで、自動的に解決する仕組みを提供している。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>自動マッピングの特徴について</strong></p>
<p>自動マッピングを使用すると、マッピングファイルには実行するSQLのみ記述すればよいため、
マッピングファイルの記述量を減らすことができる点が特徴である。</p>
<p>記述量が減ることで、単純ミスの削減や、カラム名やプロパティ名変更時の修正箇所の削減といった効果も期待できる。</p>
<p class="last">ただし、自動マッピングが行えるのは、単一オブジェクトに対するマッピングのみである。
ネストした関連オブジェクトに対してマッピングを行いたい場合は、手動マッピングを使用する必要がある。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>カラム名について</strong></p>
<p class="last">ここで言うカラム名とは、テーブルの物理的なカラム名ではなく、
SQLを発行して取得した検索結果(<code class="docutils literal"><span class="pre">ResultSet</span></code>)がもつカラム名の事である。
そのため、AS句を使うことで、物理的なカラム名とJavaBeanのプロパティ名を一致させることは、
比較的容易に行うことができる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>以下に、自動マッピングを使用して検索結果をJavaBeanにマッピングする実装例を示す。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/com/example/domain/repository/todo/TodoRepository.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;string&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
        SELECT
<span class="hll">            todo_id AS &quot;todoId&quot;, /* (1) */
</span>            todo_title AS &quot;todoTitle&quot;,
<span class="hll">            finished, /* (2) */
</span>            created_at AS &quot;createdAt&quot;,
            version
        FROM
            t_todo
        WHERE
            todo_id = #{todoId}
    <span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>テーブルの物理カラム名とJavaBeanのプロパティ名が異なる場合は、AS句を使用して一致させることで、自動マッピング対象にすることができる。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>テーブルの物理カラム名とJavaBeanのプロパティ名が一致している場合は、AS句を指定する必要はない。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>JavaBean</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.model</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Todo</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">todoId</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">todoTitle</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">finished</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">Date</span> <span class="n">createdAt</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kt">long</span> <span class="n">version</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTodoId</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">todoId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTodoId</span><span class="p">(</span><span class="n">String</span> <span class="n">todoId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">todoId</span> <span class="o">=</span> <span class="n">todoId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTodoTitle</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">todoTitle</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTodoTitle</span><span class="p">(</span><span class="n">String</span> <span class="n">todoTitle</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">todoTitle</span> <span class="o">=</span> <span class="n">todoTitle</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isFinished</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">finished</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFinished</span><span class="p">(</span><span class="kt">boolean</span> <span class="n">finished</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">finished</span> <span class="o">=</span> <span class="n">finished</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">Date</span> <span class="nf">getCreatedAt</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">createdAt</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCreatedAt</span><span class="p">(</span><span class="n">Date</span> <span class="n">createdAt</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">createdAt</span> <span class="o">=</span> <span class="n">createdAt</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getVersion</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">version</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setVersion</span><span class="p">(</span><span class="kt">long</span> <span class="n">version</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">version</span> <span class="o">=</span> <span class="n">version</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>アンダースコア区切りのカラム名とキャメルケース形式のプロパティ名のマッピング方法について</strong></p>
<p class="last">上記例では、アンダースコア区切りのカラム名とキャメルケース形式のプロパティ名の違いについてAS句を使って吸収しているが、
アンダースコア区切りのカラム名とキャメルケース形式のプロパティ名の違いを吸収するだけならば、
MyBatis3の設定を変更する事で実現可能である。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>テーブルの物理カラム名をアンダースコア区切りにしている場合は、
MyBatis設定ファイル(<code class="file docutils literal"><span class="pre">mybatis-config.xml</span></code>)に以下の設定を追加することで、
キャメルケースのJavaBeanのプロパティに自動マッピングする事ができる。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/mybatis/mybatis-config.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE configuration</span>
<span class="cp">  PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span>
<span class="cp">  &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span>
<span class="nt">&lt;configuration&gt;</span>

    <span class="nt">&lt;settings&gt;</span>
<span class="hll">        <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;setting</span> <span class="na">name=</span><span class="s">&quot;mapUnderscoreToCamelCase&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
</span>    <span class="nt">&lt;/settings&gt;</span>

<span class="nt">&lt;/configuration&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">mapUnderscoreToCamelCase</span></code> を<cite>true</cite>にする設定を追加する。</p>
<p class="last">設定を<cite>true</cite>にすると、アンダースコア区切りのカラム名がキャメルケース形式に自動変換される。
具体例としては、カラム名が<code class="docutils literal"><span class="pre">todo_id</span></code>の場合、<code class="docutils literal"><span class="pre">todoId</span></code>に変換されてマッピングが行われる。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/com/example/domain/repository/todo/TodoRepository.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;string&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
        SELECT
<span class="hll">            todo_id, /* (4) */
</span><span class="hll">            todo_title,
</span><span class="hll">            finished,
</span><span class="hll">            created_at,
</span><span class="hll">            version
</span>        FROM
            t_todo
        WHERE
            todo_id = #{todoId}
    <span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>アンダースコア区切りのカラム名とキャメルケース形式のプロパティ名の違いを吸収するために、AS句の指定が不要になるため、よりシンプルなSQLとなる。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtouseresultmappingbymanual">
<span id="id23"></span><h4><a class="toc-backref" href="#id114">6.2.2.5.2. 検索結果の手動マッピング</a><a class="headerlink" href="#dataaccessmybatis3howtouseresultmappingbymanual" title="Permalink to this headline">¶</a></h4>
<p>MyBatis3では、検索結果(<code class="docutils literal"><span class="pre">ResultSet</span></code>)のカラムとJavaBeanのプロパティの対応付けを、
マッピングファイルに定義する事で、手動で解決する仕組みを用意している。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>手動マッピングの特徴について</strong></p>
<p>手動マッピングを使用すると、検索結果(<code class="docutils literal"><span class="pre">ResultSet</span></code>)のカラムとJavaBeanのプロパティの対応付けを、
マッピングファイルに１項目ずつ定義することになる。
そのため、マッピングの柔軟性が非常に高く、より複雑なマッピングを実現する事ができる点が特徴である。</p>
<p>手動マッピングは、</p>
<blockquote>
<div><ul class="simple">
<li>アプリケーションが扱うデータモデル(JavaBean)と物理テーブルのレイアウトが一致しない</li>
<li>JavaBeanがネスト構造になっている(別のJavaBeanをネストしている)</li>
</ul>
</div></blockquote>
<p>といったケースにおいて、検索結果(<code class="docutils literal"><span class="pre">ResultSet</span></code>)のカラムとJavaBeanのプロパティをマッピングする際に力を発揮するマッピング方法である。</p>
<p class="last">また、自動マッピングに比べて効率的にマッピングを行う事ができる。
処理の効率性を優先するアプリケーションの場合は、自動マッピングの代わりに手動マッピングを使用した方がよい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">以下に、手動マッピングを使用して検索結果をJavaBeanにマッピングする実装例を示す。</div>
<div class="line">ここでは、手動マッピングの使用方法を示す事が目的なので、自動マッピングでもマッピング可能なもっともシンプルなパターンを例に、説明を行う。</div>
</div>
<p>実践的なマッピングの実装例については、</p>
<ul class="simple">
<li>「<a class="reference external" href="https://mybatis.org/mybatis-3/sqlmap-xml.html#Advanced_Result_Maps">MyBatis 3 REFERENCE DOCUMENTATION(Mapper XML Files-Advanced Result Maps-)</a> 」</li>
<li>「<a class="reference internal" href="#dataaccessmybatis3appendixacquirerelatedobjectsatonce"><span class="std std-ref">関連Entityを１回のSQLで取得する方法について</span></a>」</li>
<li>「<a class="reference internal" href="#dataaccessmybatis3appendixnestedselect"><span class="std std-ref">関連EntityをネストしたSQLを使用して取得する方法について</span></a>」</li>
</ul>
<p>を参照されたい。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/com/example/domain/repository/todo/TodoRepository.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;todoResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;id</span> <span class="na">column=</span><span class="s">&quot;todo_id&quot;</span> <span class="na">property=</span><span class="s">&quot;todoId&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;result</span> <span class="na">column=</span><span class="s">&quot;todo_title&quot;</span> <span class="na">property=</span><span class="s">&quot;todoTitle&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">        <span class="nt">&lt;result</span> <span class="na">column=</span><span class="s">&quot;finished&quot;</span> <span class="na">property=</span><span class="s">&quot;finished&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">        <span class="nt">&lt;result</span> <span class="na">column=</span><span class="s">&quot;created_at&quot;</span> <span class="na">property=</span><span class="s">&quot;createdAt&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">        <span class="nt">&lt;result</span> <span class="na">column=</span><span class="s">&quot;version&quot;</span> <span class="na">property=</span><span class="s">&quot;version&quot;</span> <span class="nt">/&gt;</span>
</span>    <span class="nt">&lt;/resultMap&gt;</span>

<span class="hll">    <span class="c">&lt;!-- (4) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;string&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;todoResultMap&quot;</span><span class="nt">&gt;</span>
</span>        SELECT
            todo_id,
            todo_title,
            finished,
            created_at,
            version
        FROM
            t_todo
        WHERE
            todo_id = #{todoId}
    <span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">&lt;resultMap&gt;</span></code>要素に、検索結果(<code class="docutils literal"><span class="pre">ResultSet</span></code>)とJavaBeanのマッピング定義を行う。</p>
<p><code class="docutils literal"><span class="pre">id</span></code>属性にマッピングを識別するためのIDを、<code class="docutils literal"><span class="pre">type</span></code>属性にマッピングするJavaBeanのクラス名(又はエイリアス名)を指定する。</p>
<p class="last"><code class="docutils literal"><span class="pre">&lt;resultMap&gt;</span></code>要素の詳細は、「<a class="reference external" href="https://mybatis.org/mybatis-3/sqlmap-xml.html#resultMap">MyBatis 3 REFERENCE DOCUMENTATION(Mapper XML Files-resultMap-)</a> 」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">検索結果(<code class="docutils literal"><span class="pre">ResultSet</span></code>)のID(PK)のカラムとJavaBeanのプロパティのマッピングを行う。</p>
<p>ID(PK)のマッピングは、<code class="docutils literal"><span class="pre">&lt;id&gt;</span></code>要素を使って指定する。
<code class="docutils literal"><span class="pre">column</span></code>属性には検索結果(<code class="docutils literal"><span class="pre">ResultSet</span></code>)のカラム名、<code class="docutils literal"><span class="pre">property</span></code>属性にはJavaBeanのプロパティ名を指定する。</p>
<p class="last"><code class="docutils literal"><span class="pre">&lt;id&gt;</span></code>要素の詳細は、「<a class="reference external" href="https://mybatis.org/mybatis-3/sqlmap-xml.html#id__result">MyBatis 3 REFERENCE DOCUMENTATION(Mapper XML Files-id &amp; result-)</a> 」を参照されたい。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first">検索結果(<code class="docutils literal"><span class="pre">ResultSet</span></code>)のID(PK)以外のカラムとJavaBeanのプロパティのマッピングを行う。</p>
<p>ID(PK)以外のマッピングは、<code class="docutils literal"><span class="pre">&lt;result&gt;</span></code>要素を使って指定する。
<code class="docutils literal"><span class="pre">column</span></code>属性には検索結果(<code class="docutils literal"><span class="pre">ResultSet</span></code>)のカラム名、<code class="docutils literal"><span class="pre">property</span></code>属性にはJavaBeanのプロパティ名を指定する。</p>
<p class="last"><code class="docutils literal"><span class="pre">&lt;result&gt;</span></code>要素の詳細は、「<a class="reference external" href="https://mybatis.org/mybatis-3/sqlmap-xml.html#id__result">MyBatis 3 REFERENCE DOCUMENTATION(Mapper XML Files-id &amp; result-)</a> 」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">&lt;select&gt;</span></code>要素の<code class="docutils literal"><span class="pre">resultMap</span></code>属性に、適用するマッピング定義のIDを指定する。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>id要素とresult要素の使い分けについて</strong></p>
<p><code class="docutils literal"><span class="pre">&lt;id&gt;</span></code>要素と<code class="docutils literal"><span class="pre">&lt;result&gt;</span></code>要素は、
どちらも検索結果(<code class="docutils literal"><span class="pre">ResultSet</span></code>)のカラムとJavaBeanのプロパティをマッピングするための要素であるが、
ID(PK)カラムに対してマッピングは、<code class="docutils literal"><span class="pre">&lt;id&gt;</span></code>要素を使うことを推奨する。</p>
<p class="last">理由は、ID(PK)カラムに対して<code class="docutils literal"><span class="pre">&lt;id&gt;</span></code>要素を使用してマッピングを行うと、MyBatis3が提供しているオブジェクトのキャッシュ制御の処理や、
関連オブジェクトへのマッピングの処理のパフォーマンスを、全体的に向上させることが出来るためである。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="entity">
<span id="dataaccessmybatis3howtousefind"></span><h3><a class="toc-backref" href="#id115">6.2.2.6. Entityの検索処理</a><a class="headerlink" href="#entity" title="Permalink to this headline">¶</a></h3>
<p>Entityの検索処理の実装方法について、目的別に説明を行う。</p>
<p>Entityの検索処理の実装方法に対する説明を読む前に、「<a class="reference internal" href="#dataaccessmybatis3howtouseresultsetmapping"><span class="std std-ref">検索結果とJavaBeanのマッピング方法</span></a>」を一読して頂きたい。</p>
<p>以降の説明では、アンダースコア区切りのカラム名をキャメルケース形式のプロパティ名に自動でマッピングする設定を有効にした場合の実装例となる。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/mybatis/mybatis-config.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE configuration</span>
<span class="cp">  PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span>
<span class="cp">  &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span>
<span class="nt">&lt;configuration&gt;</span>

    <span class="nt">&lt;settings&gt;</span>
        <span class="nt">&lt;setting</span> <span class="na">name=</span><span class="s">&quot;mapUnderscoreToCamelCase&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/settings&gt;</span>

<span class="nt">&lt;/configuration&gt;</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="dataaccessmybatis3howtousefindone">
<span id="id25"></span><h4><a class="toc-backref" href="#id116">6.2.2.6.1. 単一キーのEntityの取得</a><a class="headerlink" href="#dataaccessmybatis3howtousefindone" title="Permalink to this headline">¶</a></h4>
<p>PKが単一カラムで構成されるテーブルより、PKを指定してEntityを1件取得する際の実装例を以下に示す。</p>
<ul class="simple">
<li>Repositoryインタフェースにメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.repository.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="p">{</span>

    <span class="c1">// (1)</span>
    <span class="n">Todo</span> <span class="nf">findOne</span><span class="p">(</span><span class="n">String</span> <span class="n">todoId</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>上記例では、引数に指定された<code class="docutils literal"><span class="pre">todoId</span></code>(PK)に一致するTodoオブジェクトを1件取得するためのメソッドとして、
<code class="docutils literal"><span class="pre">findOne</span></code>メソッドを定義している。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>マッピングファイルにSQLを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;string&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
        /* (3) */
        SELECT
            todo_id,
            todo_title,
            finished,
            created_at,
            version
        FROM
            t_todo
        /* (4) */
        WHERE
            todo_id = #{todoId}
    <span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="11%" />
<col width="78%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>-</td>
<td><p class="first"><code class="docutils literal"><span class="pre">select</span></code>要素の中に、検索結果が0～1件となるSQLを実装する。</p>
<p>上記例では、ID(PK)が一致するレコードを取得するSQLを実装している。</p>
<p class="last"><code class="docutils literal"><span class="pre">select</span></code>要素の詳細については、
「<a class="reference external" href="https://mybatis.org/mybatis-3/sqlmap-xml.html#select">MyBatis3 REFERENCE DOCUMENTATION (Mapper XML Files-select-)</a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td>id</td>
<td>Repositoryインタフェースに定義したメソッドのメソッド名を指定する。</td>
</tr>
<tr class="row-even"><td>&#160;</td>
<td>parameterType</td>
<td>パラメータ完全修飾クラス名(又はエイリアス名)を指定する。</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td>resultType</td>
<td><p class="first">検索結果(<code class="docutils literal"><span class="pre">ResultSet</span></code>)をマッピングするJavaBeanの完全修飾クラス名(又はエイリアス名)を指定する。</p>
<p class="last">手動マッピングを使用する場合は、<code class="docutils literal"><span class="pre">resultType</span></code>属性の代わりに<code class="docutils literal"><span class="pre">resultMap</span></code>属性を使用して、
適用するマッピング定義を指定する。
手動マッピングについては、「<a class="reference internal" href="#dataaccessmybatis3howtouseresultmappingbymanual"><span class="std std-ref">検索結果の手動マッピング</span></a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>-</td>
<td><p class="first">取得対象のカラムを指定する。</p>
<p class="last">上記例では、検索結果(<code class="docutils literal"><span class="pre">ResultSet</span></code>)をJavaBeanへマッピングする方法として、自動マッピングを使用している。
自動マッピングについては、「<a class="reference internal" href="#dataaccessmybatis3howtouseresultmappingbyauto"><span class="std std-ref">検索結果の自動マッピング</span></a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>-</td>
<td><p class="first">WHERE句に検索条件を指定する。</p>
<p>検索条件にバインドする値は、<code class="docutils literal"><span class="pre">#{variableName}</span></code>形式のバインド変数として指定する。上記例では、
<code class="docutils literal"><span class="pre">#{todoId}</span></code>がバインド変数となる。</p>
<p class="last">Repositoryインタフェースの引数の型が<code class="docutils literal"><span class="pre">String</span></code>のような単純型の場合は、
バインド変数名は任意の名前でよいが、引数の型がJavaBeanの場合は、
バインド変数名にはJavaBeanのプロパティ名を指定する必要がある。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>単純型のバインド変数名について</strong></p>
<p class="last"><code class="docutils literal"><span class="pre">String</span></code>のような単純型の場合は、バインド変数名に制約はないが、メソッドの引数名と同じ値にしておくことを推奨する。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>ServiceクラスにRepositoryをDIし、Repositoryインターフェースのメソッドを呼び出す。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.repository.todo.TodoRepository</span><span class="p">;</span>

<span class="nd">@Transactional</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="p">{</span>

    <span class="c1">// (5)</span>
    <span class="nd">@Inject</span>
    <span class="n">TodoRepository</span> <span class="n">todoRepository</span><span class="p">;</span>

    <span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="p">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">getTodo</span><span class="p">(</span><span class="n">String</span> <span class="n">todoId</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// (6)</span>
        <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">todoId</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">todo</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (7)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">ResourceNotFoundException</span><span class="p">(</span><span class="n">ResultMessages</span><span class="p">.</span><span class="na">error</span><span class="p">().</span><span class="na">add</span><span class="p">(</span>
                    <span class="s">&quot;e.ex.td.5001&quot;</span><span class="p">,</span> <span class="n">todoId</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">todo</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>ServiceクラスにRepositoryインターフェースをDIする。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>Repositoryインターフェースのメソッドを呼び出し、Entityを1件取得する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td><p class="first">検索結果が0件の場合は<code class="docutils literal"><span class="pre">null</span></code>が返却されるため、
必要に応じてEntityが取得できなかった時の処理を実装する。</p>
<p class="last">上記例では、Entityが取得できなかった場合は、リソース未検出エラーを発生させている。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id26">
<h4><a class="toc-backref" href="#id117">6.2.2.6.2. 複合キーのEntityの取得</a><a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">PKが複数カラムで構成されるテーブルより、PKを指定してEntityを1件取得する際の実装例を以下に示す。</div>
<div class="line">基本的な構成は、PKが単一カラムで構成される場合と同じであるが、Repositoryインタフェースのメソッド引数の指定方法が異なる。</div>
</div>
<ul class="simple">
<li>Repositoryインタフェースにメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.repository.order</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Param</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.OrderHistory</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderHistoryRepository</span> <span class="p">{</span>

   <span class="c1">// (1)</span>
   <span class="n">OrderHistory</span> <span class="nf">findOne</span><span class="p">(</span><span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;orderId&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">orderId</span><span class="p">,</span>
           <span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;historyId&quot;</span><span class="p">)</span> <span class="kt">int</span> <span class="n">historyId</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">PKを構成するカラムに対応する引数を、メソッドに定義する。</p>
<p class="last">上記例では、受注の変更履歴を管理するテーブルのPKとして、<code class="docutils literal"><span class="pre">orderId</span></code>と<code class="docutils literal"><span class="pre">historyId</span></code>を引数に定義している。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>メソッド引数を複数指定する場合のバインド変数名について</strong></p>
<p>Repositoryインタフェースのメソッド引数を複数指定する場合は、引数に<code class="docutils literal"><span class="pre">&#64;org.apache.ibatis.annotations.Param</span></code>アノテーションを指定することを推奨する。
<code class="docutils literal"><span class="pre">&#64;Param</span></code>アノテーションの<code class="docutils literal"><span class="pre">value</span></code>属性には、マッピングファイルから値を参照する際に指定する「バインド変数名」を指定する。</p>
<p>上記例だと、マッピングファイルから<code class="docutils literal"><span class="pre">#{orderId}</span></code>及び<code class="docutils literal"><span class="pre">#{historyId}</span></code>と指定することで、引数に指定された値をSQLにバインドする事ができる。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.order.OrderHistoryRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">resultType=</span><span class="s">&quot;OrderHistory&quot;</span><span class="nt">&gt;</span>
        SELECT
            order_id,
            history_id,
            order_name,
            operation_type,
            created_at&quot;
        FROM
            t_order_history
        WHERE
            order_id = #{orderId}
        AND
            history_id = #{historyId}
    <span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
</div></blockquote>
<p><code class="docutils literal"><span class="pre">&#64;Param</span></code>アノテーションの指定は必須ではないが、
指定しないと以下に示すような機械的なバインド変数名を指定する必要がある。
<code class="docutils literal"><span class="pre">&#64;Param</span></code>アノテーションの指定しない場合のバインド変数名は、「”param” + 引数の宣言位置(1から開始)」という名前になるため、
ソースコードのメンテナンス性及び可読性を損なう要因となる。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

WHERE
    order_id = #{param1}
AND
    history_id = #{param2}

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
</div></blockquote>
<p class="last">MyBatis 3.4.1以降では、JDK 8 から追加されたコンパイルオプション(<code class="docutils literal"><span class="pre">-parameters</span></code>)を使用することで、<code class="docutils literal"><span class="pre">&#64;Param</span></code>アノテーションを省略する事ができる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtousefindmultiple">
<span id="id27"></span><h4><a class="toc-backref" href="#id118">6.2.2.6.3. Entityの検索</a><a class="headerlink" href="#dataaccessmybatis3howtousefindmultiple" title="Permalink to this headline">¶</a></h4>
<p>検索結果が0～N件となるSQLを発行し、Entityを複数件取得する際の実装例を以下に示す。</p>
<blockquote>
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">検索結果が大量のデータになる可能性がある場合は、「<a class="reference internal" href="#dataaccessmybatis3howtoextendresulthandler"><span class="std std-ref">ResultHandlerの実装</span></a>」の利用を検討すること。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Entityを複数件取得するためのメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.repository.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="p">{</span>

    <span class="c1">// (1)</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">findAllByCriteria</span><span class="p">(</span><span class="n">TodoCriteria</span> <span class="n">criteria</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>上記例では、検索条件を保持するJavaBean(<code class="docutils literal"><span class="pre">TodoCriteria</span></code>)に一致するTodoオブジェクトをリスト形式で複数件取得するためのメソッドとして、
<code class="docutils literal"><span class="pre">findAllByCriteria</span></code>メソッドを定義している。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>上記例では、メソッドの返り値に<code class="docutils literal"><span class="pre">java.util.List</span></code>を指定しているが、
検索結果を<code class="docutils literal"><span class="pre">java.util.Map</span></code>として受け取る事も出来る。</p>
<p><code class="docutils literal"><span class="pre">Map</span></code>で受け取る場合は、</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">Map</span></code>の<code class="docutils literal"><span class="pre">key</span></code>にはPKの値</li>
<li><code class="docutils literal"><span class="pre">Map</span></code>の<code class="docutils literal"><span class="pre">value</span></code>にはEntityオブジェクト</li>
</ul>
<p>を格納する事になる。</p>
<p>検索結果を<code class="docutils literal"><span class="pre">Map</span></code>で受け取る場合、<code class="docutils literal"><span class="pre">java.util.HashMap</span></code>のインスタンスが返却されるため、
<code class="docutils literal"><span class="pre">Map</span></code>の並び順は保証されないという点に注意すること。</p>
<p>以下に、実装例を示す。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.repository.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.MapKey</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="p">{</span>

    <span class="nd">@MapKey</span><span class="p">(</span><span class="s">&quot;todoId&quot;</span><span class="p">)</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">findAllByCriteria</span><span class="p">(</span><span class="n">TodoCriteria</span> <span class="n">criteria</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p class="last">検索結果を<code class="docutils literal"><span class="pre">Map</span></code>で受け取る場合は、<code class="docutils literal"><span class="pre">&#64;org.apache.ibatis.annotations.MapKey</span></code>アノテーションをメソッドに指定する。
アノテーションの<code class="docutils literal"><span class="pre">value</span></code>属性には、<code class="docutils literal"><span class="pre">Map</span></code>の<code class="docutils literal"><span class="pre">key</span></code>として扱うプロパティ名を指定する。
上記例では、TodoオブジェクトのPK(<code class="docutils literal"><span class="pre">todoId</span></code>)を指定している。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>検索条件を保持するJavaBeanを作成する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.repository.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoCriteria</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">title</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">Date</span> <span class="n">createdAt</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTitle</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">title</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTitle</span><span class="p">(</span><span class="n">String</span> <span class="n">title</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">title</span> <span class="o">=</span> <span class="n">title</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">Date</span> <span class="nf">getCreatedAt</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">createdAt</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCreatedAt</span><span class="p">(</span><span class="n">Date</span> <span class="n">createdAt</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">createdAt</span> <span class="o">=</span> <span class="n">createdAt</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>検索条件を保持するためのJavaBeanの作成について</strong></p>
<p>検索条件を保持するためのJavaBeanの作成は必須ではないが、格納されている値の役割が明確になるため、
JavaBeanを作成することを推奨する。ただし、JavaBeanを作成しない方法で実装してもよい。</p>
<p><strong>アーキテクトは、JavaBeanを作成するケースと作成しないケースの判断基準をプログラマに対して明確に示すことで、
アプリケーション全体として統一された作りになるようにすること。</strong></p>
<p>JavaBeanを作成しない場合の実装例を以下に示す。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.repository.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="p">{</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">findAllByCriteria</span><span class="p">(</span><span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;title&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">title</span><span class="p">,</span>
            <span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;createdAt&quot;</span><span class="p">)</span> <span class="n">Date</span> <span class="n">createdAt</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p class="last">JavaBeanを作成しない場合は、検索条件を1項目ずつ引数に宣言し、
<code class="docutils literal"><span class="pre">&#64;Param</span></code>アノテーションの<code class="docutils literal"><span class="pre">value</span></code>属性に「バインド変数名」を指定する。
上記のようなメソッドを定義することで、複数の検索条件をSQLに引き渡すことができる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>マッピングファイルにSQLを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAllByCriteria&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;TodoCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
        <span class="cp">&lt;![CDATA[</span>
<span class="cp">        SELECT</span>
<span class="cp">            todo_id,</span>
<span class="cp">            todo_title,</span>
<span class="cp">            finished,</span>
<span class="cp">            created_at,</span>
<span class="cp">            version</span>
<span class="cp">        FROM</span>
<span class="cp">            t_todo</span>
<span class="cp">        WHERE</span>
<span class="cp">            todo_title LIKE #{title} || &#39;%&#39; ESCAPE &#39;~&#39;</span>
<span class="cp">        AND</span>
<span class="cp">            created_at &lt; #{createdAt}</span>
<span class="cp">        /* (3) */</span>
<span class="cp">        ORDER BY</span>
<span class="cp">            todo_id</span>
<span class="cp">        ]]&gt;</span>
    <span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">select</span></code>要素の中に、検索結果が0～N件となるSQLを実装する。</p>
<p class="last">上記例では、<code class="docutils literal"><span class="pre">todo_title</span></code>と<code class="docutils literal"><span class="pre">created_at</span></code>が指定した条件に一致するTodoレコードを取得する実装している。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first">ソート条件を指定する。</p>
<p class="last">複数件のレコードを取得する場合は、ソート条件を指定する。
特に画面に表示するレコードを取得するSQLでは、ソート条件の指定は必須である。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>CDATAセクションの活用方法について</strong></p>
<p>SQL内にXMLのエスケープが必要な文字(“<code class="docutils literal"><span class="pre">&lt;</span></code>”や”<code class="docutils literal"><span class="pre">&gt;</span></code>”など)を指定する場合は、
CDATAセクションを使用すると、SQLの可読性を保つことができる。
CDATAセクションを使用しない場合は、<code class="docutils literal"><span class="pre">&amp;lt;</span></code>や<code class="docutils literal"><span class="pre">&amp;gt;</span></code>といったエンティティ参照文字を指定する必要があり、
SQLの可読性を損なう要因となる。</p>
<p class="last">上記例では、<code class="docutils literal"><span class="pre">created_at</span></code>に対する条件として”<code class="docutils literal"><span class="pre">&lt;</span></code>”を使用しているため、CDATAセクションを指定している。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtousecount">
<span id="id28"></span><h4><a class="toc-backref" href="#id119">6.2.2.6.4. Entityの件数の取得</a><a class="headerlink" href="#dataaccessmybatis3howtousecount" title="Permalink to this headline">¶</a></h4>
<p>検索条件に一致するEntityの件数を取得する際の実装例を以下に示す。</p>
<ul class="simple">
<li>検索条件に一致するEntityの件数を取得するためのメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.repository.todo</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="p">{</span>

    <span class="c1">// (1)</span>
    <span class="kt">long</span> <span class="nf">countByFinished</span><span class="p">(</span><span class="kt">boolean</span> <span class="n">finished</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">件数を取得ためのメソッドの返り値は、数値型(<code class="docutils literal"><span class="pre">int</span></code>や<code class="docutils literal"><span class="pre">long</span></code>など)を指定する。</p>
<p class="last">上記例では、<code class="docutils literal"><span class="pre">long</span></code>を指定している。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>マッピングファイルにSQLを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;countByFinished&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;_boolean&quot;</span> <span class="na">resultType=</span><span class="s">&quot;_long&quot;</span><span class="nt">&gt;</span>
        SELECT
            COUNT(*)
        FROM
            t_todo
        WHERE
            finished = #{finished}
    <span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">件数を取得するSQLを実行する。</p>
<p><code class="docutils literal"><span class="pre">resultType</span></code>属性には、返り値の型を指定する。</p>
<p class="last">上記例では、プリミティブ型の<code class="docutils literal"><span class="pre">long</span></code>を指定するためのエイリアス名を指定している。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>プリミティブ型のエイリアス名について</strong></p>
<p class="last">プリミティブ型のエイリアス名は、先頭に”<code class="docutils literal"><span class="pre">_</span></code>”(アンダースコア)を指定する必要がある。
“<code class="docutils literal"><span class="pre">_</span></code>”(アンダースコア)を指定しない場合は、プリミティブのラッパ型(<code class="docutils literal"><span class="pre">java.lang.Long</span></code>など)として扱われる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="entity-mybatis3">
<span id="dataaccessmybatis3howtousefindpageusingmybatisfunction"></span><h4><a class="toc-backref" href="#id120">6.2.2.6.5. Entityのページネーション検索(MyBatis3標準方式)</a><a class="headerlink" href="#entity-mybatis3" title="Permalink to this headline">¶</a></h4>
<p>MyBatis3の取得範囲指定機能を使用してEntityを検索する際の実装例を以下に示す。</p>
<p>MyBatisでは取得範囲を指定するクラスとして<code class="docutils literal"><span class="pre">org.apache.ibatis.session.RowBounds</span></code>クラスが用意されており、
SQLに取得範囲の条件を記述する必要がない。</p>
<blockquote>
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>検索条件に一致するデータ件数が多くなる場合の注意点について</strong></p>
<p>MyBatis3標準の方式は、検索結果(<code class="docutils literal"><span class="pre">ResultSet</span></code>)のカーソルを移動することで、取得範囲外のデータをスキップする方式である。
そのため、検索条件に一致するデータ件数に比例して、メモリ枯渇やカーソル移動処理の性能劣化が発生する可能性が高くなる。</p>
<p>カーソルの移動処理は、JDBCの結果セット型に応じて以下の２種類がサポートされており、デフォルトの動作は、
JDBCドライバのデフォルトの結果セット型に依存する。</p>
<ul class="simple">
<li>結果セット型が<code class="docutils literal"><span class="pre">FORWARD_ONLY</span></code>の場合は、<code class="docutils literal"><span class="pre">ResultSet#next()</span></code>を繰り返し呼び出して取得範囲外のデータをスキップする。</li>
<li>結果セット型が<code class="docutils literal"><span class="pre">SCROLL_SENSITIVE</span></code>又は<code class="docutils literal"><span class="pre">SCROLL_INSENSITIVE</span></code>の場合は、<code class="docutils literal"><span class="pre">ResultSet#absolute(int)</span></code>を呼び出して取得範囲外のデータをスキップする。</li>
</ul>
<p><code class="docutils literal"><span class="pre">ResultSet#absolute(int)</span></code>を使用することで、性能劣化を最小限に抑える事ができる可能性はあるが、
JDBCドライバの実装次第であり、内部で<code class="docutils literal"><span class="pre">ResultSet#next()</span></code>と同等の処理が行われている場合は、
メモリ枯渇や性能劣化が発生する可能性を抑える事はできない。</p>
<p class="last"><strong>検索条件に一致するデータ件数が多くなる可能性がある場合は、MyBatis3標準方式のページネーション検索ではなく、
SQL絞り込み方式の採用を検討した方がよい。</strong></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Entityのページネーション検索を行うためのメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">ackage</span> <span class="n">com</span><span class="p">.</span><span class="na">example</span><span class="p">.</span><span class="na">domain</span><span class="p">.</span><span class="na">repository</span><span class="p">.</span><span class="na">todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.apache.ibatis.session.RowBounds</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="p">{</span>

    <span class="c1">// (1)</span>
    <span class="kt">long</span> <span class="nf">countByCriteria</span><span class="p">(</span><span class="n">TodoCriteria</span> <span class="n">criteria</span><span class="p">);</span>

    <span class="c1">// (2)</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">findPageByCriteria</span><span class="p">(</span><span class="n">TodoCriteria</span> <span class="n">criteria</span><span class="p">,</span>
        <span class="n">RowBounds</span> <span class="n">rowBounds</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>検索条件に一致するEntityの総件数を取得するメソッドを定義する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">検索条件に一致するEntityの中から、取得範囲のEntityを抽出するメソッドを定義する。</p>
<p class="last">定義したメソッドの引数として、取得範囲の情報(offsetとlimit)を保持する<code class="docutils literal"><span class="pre">RowBounds</span></code>を指定する。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul>
<li><p class="first">マッピングファイルにSQLを定義する。</p>
<p>検索結果から該当範囲のレコードを抽出する処理は、MyBatis3が行うため、SQLで取得範囲のレコードを絞り込む必要がない。</p>
</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;countByCriteria&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;TodoCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;_long&quot;</span><span class="nt">&gt;</span>
        <span class="cp">&lt;![CDATA[</span>
<span class="cp">        SELECT</span>
<span class="cp">            COUNT(*)</span>
<span class="cp">        FROM</span>
<span class="cp">            t_todo</span>
<span class="cp">        WHERE</span>
<span class="cp">            todo_title LIKE #{title} || &#39;%&#39; ESCAPE &#39;~&#39;</span>
<span class="cp">        AND</span>
<span class="cp">            created_at &lt; #{createdAt}</span>
<span class="cp">        ]]&gt;</span>
    <span class="nt">&lt;/select&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findPageByCriteria&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;TodoCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
        <span class="cp">&lt;![CDATA[</span>
<span class="cp">        SELECT</span>
<span class="cp">            todo_id,</span>
<span class="cp">            todo_title,</span>
<span class="cp">            finished,</span>
<span class="cp">            created_at,</span>
<span class="cp">            version</span>
<span class="cp">        FROM</span>
<span class="cp">            t_todo</span>
<span class="cp">        WHERE</span>
<span class="cp">            todo_title LIKE #{title} || &#39;%&#39; ESCAPE &#39;~&#39;</span>
<span class="cp">        AND</span>
<span class="cp">            created_at &lt; #{createdAt}</span>
<span class="cp">        ORDER BY</span>
<span class="cp">            todo_id</span>
<span class="cp">        ]]&gt;</span>
    <span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>WHERE句の共通化について</strong></p>
<p>ページネーション検索を実現する場合、「検索条件に一致するEntityの総件数を取得するSQL」と
「 検索条件に一致するEntityのリストを取得するSQL」で指定するWHERE句は、
MyBatis3のinclude機能を使って共通化することを推奨する。</p>
<p>上記SQLのWHERE句を共通化した場合、以下のような定義となる。
詳細は、「<a class="reference internal" href="#dataaccessmybatis3howtoextendsqlshare"><span class="std std-ref">SQL文の共有</span></a>」を参照されたい。</p>
<blockquote class="last">
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="hll"><span class="nt">&lt;sql</span> <span class="na">id=</span><span class="s">&quot;findPageByCriteriaWherePhrase&quot;</span><span class="nt">&gt;</span>
</span>    <span class="cp">&lt;![CDATA[</span>
<span class="cp">    WHERE</span>
<span class="cp">        todo_title LIKE #{title} || &#39;%&#39; ESCAPE &#39;~&#39;</span>
<span class="cp">    AND</span>
<span class="cp">        created_at &lt; #{createdAt}</span>
<span class="cp">    ]]&gt;</span>
<span class="nt">&lt;/sql&gt;</span>

<span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;countByCriteria&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;TodoCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;_long&quot;</span><span class="nt">&gt;</span>
    SELECT
        COUNT(*)
    FROM
        t_todo
<span class="hll">    <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">&quot;findPageByCriteriaWherePhrase&quot;</span><span class="nt">/&gt;</span>
</span><span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findPageByCriteria&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;TodoCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    SELECT
        todo_id,
        todo_title,
        finished,
        created_at,
        version
    FROM
        t_todo
<span class="hll">    <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">&quot;findPageByCriteriaWherePhrase&quot;</span><span class="nt">/&gt;</span>
</span>    ORDER BY
        todo_id
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>結果セット型を明示的に指定する方法について</strong></p>
<p>結果セット型を明示的に指定する場合は、<code class="docutils literal"><span class="pre">resultType</span></code>属性に結果セット型を指定する。
JDBCドライバのデフォルトの結果セット型が、<code class="docutils literal"><span class="pre">FORWARD_ONLY</span></code>の場合は、<code class="docutils literal"><span class="pre">SCROLL_INSENSITIVE</span></code>を指定することを推奨する。</p>
<blockquote class="last">
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findPageByCriteria&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;TodoCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span>
<span class="hll">    <span class="na">resultSetType=</span><span class="s">&quot;SCROLL_INSENSITIVE&quot;</span><span class="nt">&gt;</span>
</span>    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Serviceクラスにページネーション検索処理を実装する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// omitted</span>

<span class="nd">@Transactional</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">TodoRepository</span> <span class="n">todoRepository</span><span class="p">;</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="p">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Page</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">searchTodos</span><span class="p">(</span><span class="n">TodoCriteria</span> <span class="n">criteria</span><span class="p">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// (3)</span>
        <span class="kt">long</span> <span class="n">total</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="p">.</span><span class="na">countByCriteria</span><span class="p">(</span><span class="n">criteria</span><span class="p">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">total</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// (4)</span>
            <span class="n">RowBounds</span> <span class="n">rowBounds</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RowBounds</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">pageable</span><span class="p">.</span><span class="na">getOffset</span><span class="p">(),</span>
                <span class="n">pageable</span><span class="p">.</span><span class="na">getPageSize</span><span class="p">());</span>
            <span class="c1">// (5)</span>
            <span class="n">todos</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="p">.</span><span class="na">findPageByCriteria</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="n">rowBounds</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// (6)</span>
            <span class="n">todos</span> <span class="o">=</span> <span class="n">Collections</span><span class="p">.</span><span class="na">emptyList</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="c1">// (7)</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">PageImpl</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">todos</span><span class="p">,</span> <span class="n">pageable</span><span class="p">,</span> <span class="n">total</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>まず、検索条件に一致するEntityの総件数を取得する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p class="first">検索条件に一致するEntityが存在する場合は、ページネーション検索の取得範囲を指定する<code class="docutils literal"><span class="pre">RowBounds</span></code>オブジェクトを生成する。</p>
<p><code class="docutils literal"><span class="pre">RowBounds</span></code>の第1引数(<code class="docutils literal"><span class="pre">offset</span></code>)には「スキップ件数」、
第２引数(<code class="docutils literal"><span class="pre">limit</span></code>)には「最大取得件数」を指定する。
引数に指定する値、Spring Data Commonsから提供されている<code class="docutils literal"><span class="pre">Pageable</span></code>オブジェクトの
<code class="docutils literal"><span class="pre">getOffset</span></code>メソッドと<code class="docutils literal"><span class="pre">getPageSize</span></code>メソッドを呼び出して取得した値を指定すればよい。</p>
<p>具体的には、</p>
<ul class="simple">
<li>offsetに”<code class="docutils literal"><span class="pre">0</span></code>”、limitに<code class="docutils literal"><span class="pre">20</span></code>を指定した場合、1～20件目</li>
<li>offsetに<code class="docutils literal"><span class="pre">20</span></code>、limitに<code class="docutils literal"><span class="pre">20</span></code>を指定した場合、21～40件目</li>
</ul>
<p class="last">が取得範囲となる。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>Repositoryのメソッドを呼び出し、検索条件に一致した取得範囲のEntityを取得する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>検索条件に一致するEntityが存在しない場合は、空のリストを検索結果に設定する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td>ページ情報(<code class="docutils literal"><span class="pre">org.springframework.data.domain.PageImpl</span></code>)を作成し返却する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="entity-sql">
<span id="dataaccessmybatis3howtousefindpageusingsqlfilter"></span><h4><a class="toc-backref" href="#id121">6.2.2.6.6. Entityのページネーション検索(SQL絞り込み方式)</a><a class="headerlink" href="#entity-sql" title="Permalink to this headline">¶</a></h4>
<p>データベースから提供されている範囲検索の仕組みを使用してEntityを検索する際の実装例を以下に示す。</p>
<p>SQL絞り込み方式は、データベースから提供されている範囲検索の仕組みを使用するため、
MyBatis3標準方式に比べて効率的に取得範囲のEntityを取得することができる。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><strong>検索条件に一致するデータ件数が大量にある場合は、SQL絞り込み方式を採用する事を推奨する。</strong></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Entityのページネーション検索を行うためのメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.repository.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Param</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.domain.Pageable</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="p">{</span>

    <span class="c1">// (1)</span>
    <span class="kt">long</span> <span class="nf">countByCriteria</span><span class="p">(</span>
            <span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;criteria&quot;</span><span class="p">)</span> <span class="n">TodoCriteria</span> <span class="n">criteria</span><span class="p">);</span>

    <span class="c1">// (2)</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">findPageByCriteria</span><span class="p">(</span>
            <span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;criteria&quot;</span><span class="p">)</span> <span class="n">TodoCriteria</span> <span class="n">criteria</span><span class="p">,</span>
            <span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;pageable&quot;</span><span class="p">)</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>検索条件に一致するEntityの総件数を取得するメソッドを定義する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">検索条件に一致するEntityの中から、取得範囲のEntityを抽出するメソッドを定義する。</p>
<p class="last">定義したメソッドの引数として、取得範囲の情報(offsetとlimit)を保持する<code class="docutils literal"><span class="pre">org.springframework.data.domain.Pageable</span></code>を指定する。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>引数が1つのメソッドに&#64;Paramアノテーションを指定する理由について</strong></p>
<p>上記例では、引数が1つのメソッド(<code class="docutils literal"><span class="pre">countByCriteria</span></code>)に対して<code class="docutils literal"><span class="pre">&#64;Param</span></code>アノテーションを指定している。
これは、<code class="docutils literal"><span class="pre">findPageByCriteria</span></code>メソッド呼び出し時に実行されるSQLとWHERE句を共通化するためである。</p>
<p><code class="docutils literal"><span class="pre">&#64;Param</span></code>アノテーションを使用して引数にバインド変数名を指定することで、
SQL内で指定するバインド変数名のネスト構造を合わせている。</p>
<p class="last">具体的なSQLの実装例については、次に示す。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul>
<li><p class="first">マッピングファイルにSQLを定義する。</p>
<p>SQLで取得範囲のレコードを絞り込む。</p>
</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;sql</span> <span class="na">id=</span><span class="s">&quot;findPageByCriteriaWherePhrase&quot;</span><span class="nt">&gt;</span>
        <span class="cp">&lt;![CDATA[</span>
<span class="hll"><span class="cp">        /* (3) */</span>
</span><span class="cp">        WHERE</span>
<span class="cp">            todo_title LIKE #{criteria.title} || &#39;%&#39; ESCAPE &#39;~&#39;</span>
<span class="cp">        AND</span>
<span class="cp">            created_at &lt; #{criteria.createdAt}</span>
<span class="cp">        ]]&gt;</span>
    <span class="nt">&lt;/sql&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;countByCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;_long&quot;</span><span class="nt">&gt;</span>
        SELECT
            COUNT(*)
        FROM
            t_todo
        <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">&quot;findPageByCriteriaWherePhrase&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/select&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findPageByCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
        SELECT
            todo_id,
            todo_title,
            finished,
            created_at,
            version
        FROM
            t_todo
        <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">&quot;findPageByCriteriaWherePhrase&quot;</span> <span class="nt">/&gt;</span>
        ORDER BY
            todo_id
<span class="hll">        LIMIT
</span><span class="hll">            #{pageable.pageSize} /* (4) */
</span><span class="hll">        OFFSET
</span><span class="hll">            #{pageable.offset}  /* (4) */
</span>    <span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">countByCriteria</span></code>と<code class="docutils literal"><span class="pre">findPageByCriteria</span></code>メソッドの引数に<code class="docutils literal"><span class="pre">&#64;Param(&quot;criteria&quot;)</span></code>を指定しているため、
SQL内で指定するバインド変数名は<code class="docutils literal"><span class="pre">criteria.フィールド名</span></code>の形式となる。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p class="first">データベースから提供されている範囲検索の仕組みを使用して、必要なレコードのみ抽出する。</p>
<p><code class="docutils literal"><span class="pre">Pageable</span></code>オブジェクトの<code class="docutils literal"><span class="pre">offset</span></code>には「スキップ件数」、
<code class="docutils literal"><span class="pre">pageSize</span></code>には「最大取得件数」が格納されている。</p>
<p class="last">上記例は、データベースとしてH2 Databaseを使用した際の実装例である。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Serviceクラスにページネーション検索処理を実装する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// omitted</span>

<span class="nd">@Transactional</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">TodoRepository</span> <span class="n">todoRepository</span><span class="p">;</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="p">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Page</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">searchTodos</span><span class="p">(</span><span class="n">TodoCriteria</span> <span class="n">criteria</span><span class="p">,</span>
            <span class="n">Pageable</span> <span class="n">pageable</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">long</span> <span class="n">total</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="p">.</span><span class="na">countByCriteria</span><span class="p">(</span><span class="n">criteria</span><span class="p">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">total</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// (5)</span>
            <span class="n">todos</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="p">.</span><span class="na">findPageByCriteria</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span>
                    <span class="n">pageable</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">todos</span> <span class="o">=</span> <span class="n">Collections</span><span class="p">.</span><span class="na">emptyList</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">PageImpl</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">todos</span><span class="p">,</span> <span class="n">pageable</span><span class="p">,</span> <span class="n">total</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><p class="first">Repositoryのメソッドを呼び出し、検索条件に一致した取得範囲のEntityを取得する。</p>
<p class="last">Repositoryのメソッドを呼び出す際は、引数で受け取った<code class="docutils literal"><span class="pre">Pageable</span></code>オブジェクトをそのまま渡せばよい。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtousefindpageusingsort">
<span id="id29"></span><h4><a class="toc-backref" href="#id122">6.2.2.6.7. Entityのページネーション検索(検索結果のソート)</a><a class="headerlink" href="#dataaccessmybatis3howtousefindpageusingsort" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">Pageable</span></code>オブジェクトの<code class="docutils literal"><span class="pre">sort</span></code>プロパティを利用して、SQLで検索結果をソートする実装例を以下に示す。</p>
<p>RepositoryおよびServiceについては、前述の<a class="reference internal" href="#dataaccessmybatis3howtousefindpageusingsqlfilter"><span class="std std-ref">Entityのページネーション検索(SQL絞り込み方式)</span></a>と同様とし、実装例を省略する。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul>
<li><p class="first">マッピングファイルにSQLを定義する。</p>
<p>SQLで検索結果に対してソートをかける。</p>
</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findPageByCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
        SELECT
            todo_id,
            todo_title,
            finished,
            created_at,
            version
        FROM
            t_todo
        WHERE
            todo_title LIKE #{criteria.title} || &#39;%&#39; ESCAPE &#39;~&#39;
        AND
        <span class="cp">&lt;![CDATA[</span>
<span class="cp">            created_at &lt; #{criteria.createdAt}</span>
<span class="cp">        ]]&gt;</span>
        <span class="nt">&lt;choose&gt;</span>
<span class="hll">            <span class="c">&lt;!-- (1)  --&gt;</span>
</span>            <span class="nt">&lt;when</span> <span class="na">test=</span><span class="s">&quot;!pageable.sort.isEmpty()&quot;</span><span class="nt">&gt;</span>
                ORDER BY
<span class="hll">                <span class="c">&lt;!-- (2)  --&gt;</span>
</span>                <span class="nt">&lt;foreach</span> <span class="na">item=</span><span class="s">&quot;order&quot;</span> <span class="na">collection=</span><span class="s">&quot;pageable.sort&quot;</span> <span class="na">separator=</span><span class="s">&quot;,&quot;</span><span class="nt">&gt;</span>
                    ${order.property}
                    ${order.direction}
                <span class="nt">&lt;/foreach&gt;</span>
            <span class="nt">&lt;/when&gt;</span>
<span class="hll">            <span class="c">&lt;!-- (3)  --&gt;</span>
</span>            <span class="nt">&lt;otherwise&gt;</span>
                ORDER BY todo_id
            <span class="nt">&lt;/otherwise&gt;</span>
        <span class="nt">&lt;/choose&gt;</span>
        LIMIT
            #{pageable.pageSize}
        OFFSET
            #{pageable.offset}
    <span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">Pageable</span></code>オブジェクトの<code class="docutils literal"><span class="pre">sort</span></code>プロパティが空でない場合、ソート条件を指定する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">sort</span></code>プロパティに格納されているソート条件をマッピングファイルに引き渡す。
<code class="docutils literal"><span class="pre">order.property</span></code>はソートする列、<code class="docutils literal"><span class="pre">order.direction</span></code>はASC,DESCなどのソート順を表す。</p>
<p class="last">具体的には<code class="docutils literal"><span class="pre">sort=todo_id,DESC&amp;sort=created_at</span></code>が指定された場合、<code class="docutils literal"><span class="pre">ORDER</span> <span class="pre">BY</span> <span class="pre">todo_id</span> <span class="pre">DESC,</span> <span class="pre">created_at</span> <span class="pre">ASC</span></code>が生成される。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>ソート条件がセットされていない場合はプライマリキー<code class="docutils literal"><span class="pre">todo_id</span></code>でソートを行う。</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>ページネーションのSQL Injection対策ついて</strong></p>
<p>ソート条件は <code class="docutils literal"><span class="pre">${order.property}</span></code> 、 <code class="docutils literal"><span class="pre">${order.direction}</span></code> のように置換変数による埋め込みを行うため、SQL Injectionが発生しないように注意する必要がある。</p>
<p>いずれもリクエストパラメータ <code class="docutils literal"><span class="pre">sort</span></code> で指定した値が格納されるが、不正な値が送信された場合の動作に以下の違いがあり、 <code class="docutils literal"><span class="pre">${order.property}</span></code> でSQL Injectionが発生する可能性がある。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">property</span></code> には、送信されたソートする列名の値がそのまま格納される。</li>
<li><code class="docutils literal"><span class="pre">direction</span></code> には <code class="docutils literal"><span class="pre">ASC</span></code> または <code class="docutils literal"><span class="pre">DESC</span></code> のどちらかが格納される。それ以外の値が送信された場合は <code class="docutils literal"><span class="pre">SortHandlerMethodArgumentResolver</span></code> 内で例外となる。</li>
</ul>
<p class="last">SQL Injection対策については、<a class="reference internal" href="#dataaccessmybatis3howtousesqlinjectioncountermeasure"><span class="std std-ref">SQL Injection対策</span></a> を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtousecreate">
<span id="id30"></span><h3><a class="toc-backref" href="#id123">6.2.2.7. Entityの登録処理</a><a class="headerlink" href="#dataaccessmybatis3howtousecreate" title="Permalink to this headline">¶</a></h3>
<p>Entityの登録方法について、目的別に実装例を説明する。</p>
<div class="section" id="entity1">
<span id="dataaccessmybatis3howtousecreateone"></span><h4><a class="toc-backref" href="#id124">6.2.2.7.1. Entityの1件登録</a><a class="headerlink" href="#entity1" title="Permalink to this headline">¶</a></h4>
<p>Entityを1件登録する際の実装例を以下に示す。</p>
<ul class="simple">
<li>Repositoryインタフェースにメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.repository.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="p">{</span>

    <span class="c1">// (1)</span>
    <span class="kt">void</span> <span class="nf">create</span><span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>上記例では、引数に指定されたTodoオブジェクトを1件登録するためのメソッドとして、
<code class="docutils literal"><span class="pre">create</span></code>メソッドを定義している。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p></p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Entityを登録するメソッドの返り値について</strong></p>
<p>Entityを登録するメソッドの返り値は、基本的には<code class="docutils literal"><span class="pre">void</span></code>でよい。</p>
<p>ただし、SELECTした結果をINSERTするようなSQLを発行する場合は、
アプリケーション要件に応じて<code class="docutils literal"><span class="pre">boolean</span></code>や数値型(<code class="docutils literal"><span class="pre">int</span></code>又は<code class="docutils literal"><span class="pre">long</span></code>)を返り値とすること。</p>
<ul class="last simple">
<li>返り値として<code class="docutils literal"><span class="pre">boolean</span></code>を指定した場合は、登録件数が0件の際は<code class="docutils literal"><span class="pre">false</span></code>、登録件数が1件以上の際は<code class="docutils literal"><span class="pre">true</span></code>が返却される。</li>
<li>返り値として数値型を指定した場合は、登録件数が返却される。</li>
</ul>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>マッピングファイルにSQLを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;create&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
        INSERT INTO
            t_todo
        (
            todo_id,
            todo_title,
            finished,
            created_at,
            version
        )
        /* (3) */
        VALUES
        (
            #{todoId},
            #{todoTitle},
            #{finished},
            #{createdAt},
            #{version}
        )
    <span class="nt">&lt;/insert&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">insert要素の中に、INSERTするSQLを実装する。</p>
<p><code class="docutils literal"><span class="pre">id</span></code>属性には、Repositoryインタフェースに定義したメソッドのメソッド名を指定する。</p>
<p class="last"><code class="docutils literal"><span class="pre">insert</span></code>要素の詳細については、
「<a class="reference external" href="https://mybatis.org/mybatis-3/sqlmap-xml.html#insert_update_and_delete">MyBatis3 REFERENCE DOCUMENTATION (Mapper XML Files-insert, update and delete-)</a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first">VALUE句にレコード登録時の設定値を指定する。</p>
<p class="last">VALUE句にバインドする値は、#{variableName}形式のバインド変数として指定する。
上記例では、Repositoryインタフェースの引数としてJavaBean(<code class="docutils literal"><span class="pre">Todo</span></code>)を指定しているため、
バインド変数名にはJavaBeanのプロパティ名を指定する。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>ServiceクラスにRepositoryをDIし、Repositoryインターフェースのメソッドを呼び出す。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.UUID</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.date.jodatime.JodaTimeDateFactory</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.repository.todo.TodoRepository</span><span class="p">;</span>

<span class="nd">@Transactional</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="p">{</span>

    <span class="c1">// (4)</span>
    <span class="nd">@Inject</span>
    <span class="n">TodoRepository</span> <span class="n">todoRepository</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">JodaTimeDateFactory</span> <span class="n">dateFactory</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">create</span><span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// (5)</span>
        <span class="n">todo</span><span class="p">.</span><span class="na">setTodoId</span><span class="p">(</span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">());</span>
        <span class="n">todo</span><span class="p">.</span><span class="na">setCreatedAt</span><span class="p">(</span><span class="n">dateFactory</span><span class="p">.</span><span class="na">newDate</span><span class="p">());</span>
        <span class="n">todo</span><span class="p">.</span><span class="na">setFinished</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
        <span class="n">todo</span><span class="p">.</span><span class="na">setVersion</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="c1">// (6)</span>
        <span class="n">todoRepository</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span>
        <span class="c1">// (7)</span>
        <span class="k">return</span> <span class="n">todo</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>ServiceクラスにRepositoryインターフェースをDIする。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><p class="first">引数で渡されたEntityオブジェクトに対して、アプリケーション要件に応じて値を設定する。</p>
<p>上記例では、</p>
<ul class="simple">
<li>IDとして「UUID」</li>
<li>登録日時として「システム日時」</li>
<li>完了フラグに「<code class="docutils literal"><span class="pre">false</span></code>: 未完了」</li>
<li>バージョンに「”<code class="docutils literal"><span class="pre">1</span></code>”」</li>
</ul>
<p class="last">を設定している。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>Repositoryインターフェースのメソッドを呼び出し、Entityを1件登録する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td><p class="first">登録したEntityを返却する。</p>
<p class="last">Serviceクラスの処理で登録値を設定する場合は、登録したEntityオブジェクトを返り値として返却する事を推奨する。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtousegenid">
<span id="id31"></span><h4><a class="toc-backref" href="#id125">6.2.2.7.2. キーの生成</a><a class="headerlink" href="#dataaccessmybatis3howtousegenid" title="Permalink to this headline">¶</a></h4>
<p>「<a class="reference internal" href="#dataaccessmybatis3howtousecreateone"><span class="std std-ref">Entityの1件登録</span></a>」では、
Serviceクラスでキー(ID)の生成をする実装例になっているが、
MyBatis3では、マッピングファイル内でキーを生成する仕組みが用意されている。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>MyBatis3のキー生成機能の使用ケースについて</strong></p>
<p class="last">キーを生成するために、データベースの機能(関数やID列など)を使用する場合は、
MyBatis3のキー生成機能の仕組みを使用する事を推奨する。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>キーの生成方法は、2種類用意されている。</p>
<ul class="simple">
<li>データベースから用意されている関数などを呼び出した結果をキーとして扱う方法</li>
<li>データベースから用意されているID列(IDENTITY型、AUTO_INCREMENT型など) + JDBC3.0から追加された<code class="docutils literal"><span class="pre">Statement#getGeneratedKeys()</span></code>を呼び出した結果をキーとして扱う方法</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>まず、データベースから用意されている関数などを呼び出した結果をキーとして扱う方法について説明する。
下記例は、データベースとしてH2 Databaseを使用している。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;create&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
<span class="hll">        <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;selectKey</span> <span class="na">keyProperty=</span><span class="s">&quot;todoId&quot;</span> <span class="na">resultType=</span><span class="s">&quot;string&quot;</span> <span class="na">order=</span><span class="s">&quot;BEFORE&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">            /* (2) */
</span><span class="hll">            SELECT RANDOM_UUID()
</span><span class="hll">        <span class="nt">&lt;/selectKey&gt;</span>
</span>        INSERT INTO
            t_todo
        (
            todo_id,
            todo_title,
            finished,
            created_at,
            version
        )
        VALUES
        (
            #{todoId},
            #{todoTitle},
            #{finished},
            #{createdAt},
            #{version}
        )
    <span class="nt">&lt;/insert&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="11%" />
<col width="78%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>-</td>
<td><p class="first"><code class="docutils literal"><span class="pre">selectKey</span></code>要素の中に、キーを生成するためのSQLを実装する。</p>
<p>上記例では、データベースから提供されている関数を使用してUUIDを取得している。</p>
<p class="last"><code class="docutils literal"><span class="pre">selectKey</span></code>の詳細については、
「<a class="reference external" href="https://mybatis.org/mybatis-3/sqlmap-xml.html#insert_update_and_delete">MyBatis3 REFERENCE DOCUMENTATION (Mapper XML Files-insert, update and delete-)</a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td>keyProperty</td>
<td><p class="first">取得したキー値を格納するEntityのプロパティ名を指定する。</p>
<p class="last">上記例では、Entityの<code class="docutils literal"><span class="pre">todoId</span></code>プロパティに生成したキーが設定される。</p>
</td>
</tr>
<tr class="row-even"><td>&#160;</td>
<td>resultType</td>
<td>SQLを発行して取得するキー値の型を指定する。</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td>order</td>
<td><p class="first">キー生成用SQLを実行するタイミング(<code class="docutils literal"><span class="pre">BEFORE</span></code>又は<code class="docutils literal"><span class="pre">AFTER</span></code>)を指定する。</p>
<ul class="last simple">
<li><code class="docutils literal"><span class="pre">BEFORE</span></code>を指定した場合、<code class="docutils literal"><span class="pre">selectKey</span></code>要素で指定したSQLを実行した結果をEntityに反映した後にINSERT文が実行される。</li>
<li><code class="docutils literal"><span class="pre">AFTER</span></code>を指定した場合、INSERT文を実行した後に<code class="docutils literal"><span class="pre">selectKey</span></code>要素で指定したSQLを実行され、取得した値がEntityに反映される。</li>
</ul>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>-</td>
<td><p class="first">キーを生成するためのSQLを実装する。</p>
<p class="last">上記例では、H2 DatabaseのUUIDを生成する関数を呼び出して、キーを生成している。
キー生成の代表的な実装としては、シーケンスオブジェクトから取得した値を文字列にフォーマットする実装があげられる。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>次に、データベースから用意されているID列 + JDBC3.0から追加された<code class="docutils literal"><span class="pre">Statement#getGeneratedKeys()</span></code>を呼び出した結果をキーとして扱う方法について説明する。
下記例は、データベースとしてH2 Databaseを使用している。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.audit.AuditLogRepository&quot;</span><span class="nt">&gt;</span>

<span class="hll">    <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;create&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;Todo&quot;</span> <span class="na">useGeneratedKeys=</span><span class="s">&quot;true&quot;</span> <span class="na">keyProperty=</span><span class="s">&quot;logId&quot;</span><span class="nt">&gt;</span>
</span>        INSERT INTO
            t_audit_log
        (
            level,
            message,
            created_at,
        )
        VALUES
        (
            #{level},
            #{message},
            #{createdAt},
        )
    <span class="nt">&lt;/insert&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="11%" />
<col width="78%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>useGeneratedKeys</td>
<td><p class="first"><code class="docutils literal"><span class="pre">true</span></code>を指定すると、ID列+<code class="docutils literal"><span class="pre">Statement#getGeneratedKeys()</span></code>を呼び出してキーを取得する機能が利用可能となる。</p>
<p class="last"><code class="docutils literal"><span class="pre">useGeneratedKeys</span></code>の詳細については、
「<a class="reference external" href="https://mybatis.org/mybatis-3/sqlmap-xml.html#insert_update_and_delete">MyBatis3 REFERENCE DOCUMENTATION (Mapper XML Files-insert, update and delete-)</a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td>keyProperty</td>
<td><p class="first">データベース上で自動的にインクリメントされたキー値を格納するEntityのプロパティ名を指定する。</p>
<p class="last">上記例では、INSERT文実行後に、Entityの<code class="docutils literal"><span class="pre">logId</span></code>プロパティに<code class="docutils literal"><span class="pre">Statement#getGeneratedKeys()</span></code>で取得したキー値が設定される。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtousecreatemultiple">
<span id="id34"></span><h4><a class="toc-backref" href="#id126">6.2.2.7.3. Entityの一括登録</a><a class="headerlink" href="#dataaccessmybatis3howtousecreatemultiple" title="Permalink to this headline">¶</a></h4>
<p>Entityを一括で登録する際の実装例を以下に示す。</p>
<p>Entityを一括で登録する場合は、</p>
<ul class="simple">
<li>複数のレコードを同時に登録するINSERT文を発行する</li>
<li>JDBCのバッチ更新機能を使用する</li>
</ul>
<p>方法がある。</p>
<p>JDBCのバッチ更新機能を使用する方法については、「<a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatch"><span class="std std-ref">バッチモードの利用</span></a>」を参照されたい。</p>
<p>ここでは、複数のレコードを同時に登録するINSERT文を発行する方法について説明する。
下記例は、データベースとしてH2 Databaseを使用している。</p>
<ul class="simple">
<li>Repositoryインタフェースにメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.repository.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="p">{</span>

    <span class="c1">// (1)</span>
    <span class="kt">void</span> <span class="nf">createAll</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>上記例では、引数に指定されたTodoオブジェクトのリストを一括登録するためのメソッドとして、
<code class="docutils literal"><span class="pre">createAll</span></code>メソッドを定義している。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>マッピングファイルにSQLを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;createAll&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;list&quot;</span><span class="nt">&gt;</span>
        INSERT INTO
            t_todo
        (
            todo_id,
            todo_title,
            finished,
            created_at,
            version
        )
        /* (2) */
        VALUES
        /* (3) */
        <span class="nt">&lt;foreach</span> <span class="na">collection=</span><span class="s">&quot;list&quot;</span> <span class="na">item=</span><span class="s">&quot;todo&quot;</span> <span class="na">separator=</span><span class="s">&quot;,&quot;</span><span class="nt">&gt;</span>
        (
            #{todo.todoId},
            #{todo.todoTitle},
            #{todo.finished},
            #{todo.createdAt},
            #{todo.version}
        )
        <span class="nt">&lt;/foreach&gt;</span>
    <span class="nt">&lt;/insert&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="11%" />
<col width="78%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>-</td>
<td>VALUE句にレコード登録時の設定値を指定する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>-</td>
<td><p class="first"><code class="docutils literal"><span class="pre">foreach</span></code>要素を使用して、引数で渡されたTodoオブジェクトのリストに対して繰り返し処理を行う。</p>
<p class="last"><code class="docutils literal"><span class="pre">foreach</span></code>の詳細については、
「<a class="reference external" href="https://mybatis.org/mybatis-3/dynamic-sql.html#foreach">MyBatis3 REFERENCE DOCUMENTATION (Dynamic SQL-foreach-)</a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-even"><td>&#160;</td>
<td>collection</td>
<td><p class="first">処理対象のコレクションを指定する。</p>
<p class="last">上記例では、Repositoryのメソッド引数のリストに対して繰り返し処理を行っている。
Repositoryメソッドの引数に<code class="docutils literal"><span class="pre">&#64;Param</span></code>を指定していない場合は、<code class="docutils literal"><span class="pre">list</span></code>を指定する。
<code class="docutils literal"><span class="pre">&#64;Param</span></code>を指定した場合は、<code class="docutils literal"><span class="pre">&#64;Param</span></code>の<code class="docutils literal"><span class="pre">value</span></code>属性に指定した値を指定する。</p>
</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td>item</td>
<td><p class="first">リストの中の1要素を保持するローカル変数名を指定する。</p>
<p class="last"><code class="docutils literal"><span class="pre">foreach</span></code>要素内のSQLからは、#{ローカル変数名.プロパティ名}の形式でJavaBeanのプロパティにアクセスする事ができる。</p>
</td>
</tr>
<tr class="row-even"><td>&#160;</td>
<td>separator</td>
<td><p class="first">リスト内の要素間を区切るための文字列を指定する。</p>
<p class="last">上記例では、”<code class="docutils literal"><span class="pre">,</span></code>”を指定することで、要素毎のVALUE句を”<code class="docutils literal"><span class="pre">,</span></code>”で区切っている。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p></p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>複数のレコードを同時に登録するSQLを使用する際の注意点</strong></p>
<p class="last">複数のレコードを同時に登録するSQLを実行する場合は、前述の「<a class="reference internal" href="#dataaccessmybatis3howtousegenid"><span class="std std-ref">キーの生成</span></a>」を使用することが出来ない。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>以下のようなSQLが生成され、実行される。</li>
</ul>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span>
    <span class="n">t_todo</span>
<span class="p">(</span>
    <span class="n">todo_id</span><span class="p">,</span>
    <span class="n">todo_title</span><span class="p">,</span>
    <span class="n">finished</span><span class="p">,</span>
    <span class="n">created_at</span><span class="p">,</span>
    <span class="k">version</span>
<span class="p">)</span>
<span class="k">VALUES</span>
<span class="p">(</span>
    <span class="s1">&#39;99243507-1b02-45b6-bfb6-d9b89f044e2d&#39;</span><span class="p">,</span>
    <span class="s1">&#39;todo title 1&#39;</span><span class="p">,</span>
    <span class="k">false</span><span class="p">,</span>
    <span class="s1">&#39;09/17/2014 23:59:59.999&#39;</span><span class="p">,</span>
    <span class="mi">1</span>
<span class="p">)</span>
<span class="p">,</span>
<span class="p">(</span>
    <span class="s1">&#39;66b096f1-791f-412f-9a0a-ee4a3a9186c2&#39;</span><span class="p">,</span>
    <span class="s1">&#39;todo title 2&#39;</span><span class="p">,</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;09/17/2014 23:59:59.999&#39;</span><span class="p">,</span>
    <span class="mi">1</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>一括登録するためのSQLは、データベースやバージョンによりサポート状況や文法が異なる。
以下に主要なデータベースのリファレンスページへのリンクを記載しておく。</p>
<ul class="last simple">
<li><a class="reference external" href="https://docs.oracle.com/en/database/oracle/oracle-database/19/sqlrf/GRANT.html">Oracle 19c</a></li>
<li><a class="reference external" href="https://www.ibm.com/docs/en/db2/11.5?topic=statements-insert">DB2 11.5</a></li>
<li><a class="reference external" href="https://www.postgresql.org/docs/13/sql-insert.html">PostgreSQL 13</a></li>
<li><a class="reference external" href="https://dev.mysql.com/doc/refman/8.0/en/insert.html">MySQL 8.0</a></li>
</ul>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtouseupdate">
<span id="id35"></span><h3><a class="toc-backref" href="#id127">6.2.2.8. Entityの更新処理</a><a class="headerlink" href="#dataaccessmybatis3howtouseupdate" title="Permalink to this headline">¶</a></h3>
<p>Entityの更新方法について、目的別に実装例を説明する。</p>
<div class="section" id="dataaccessmybatis3howtouseupdateone">
<span id="id36"></span><h4><a class="toc-backref" href="#id128">6.2.2.8.1. Entityの1件更新</a><a class="headerlink" href="#dataaccessmybatis3howtouseupdateone" title="Permalink to this headline">¶</a></h4>
<p>Entityを1件更新する際の実装例を以下に示す。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>以降の説明では、バージョンカラムを使用して楽観ロックを行う実装例となっているが、
楽観ロックの必要がない場合は、楽観ロック関連の処理を行う必要はない。</p>
<p class="last">排他制御の詳細については、「<a class="reference internal" href="ExclusionControl.html"><span class="doc">排他制御</span></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Repositoryインタフェースにメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.repository.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="p">{</span>

    <span class="c1">// (1)</span>
    <span class="kt">boolean</span> <span class="nf">update</span><span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>上記例では、引数に指定されたTodoオブジェクトを1件更新するためのメソッドとして、
<code class="docutils literal"><span class="pre">update</span></code>メソッドを定義している。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p></p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Entityを1件更新するメソッドの返り値について</strong></p>
<p>Entityを1件更新するメソッドの返り値は、基本的には<code class="docutils literal"><span class="pre">boolean</span></code>でよい。</p>
<p>ただし、更新結果が複数件になった場合にデータ不整合エラーとして扱う必要がある場合は、
数値型(<code class="docutils literal"><span class="pre">int</span></code>又は<code class="docutils literal"><span class="pre">long</span></code>)を返り値にし、更新件数が1件であることをチェックする必要がある。
主キーが更新条件となっている場合は、更新結果が複数件になる事はないので、<code class="docutils literal"><span class="pre">boolean</span></code>でよい。</p>
<ul class="last simple">
<li>返り値として<code class="docutils literal"><span class="pre">boolean</span></code>を指定した場合は、更新件数が0件の際は<code class="docutils literal"><span class="pre">false</span></code>、更新件数が1件以上の際は<code class="docutils literal"><span class="pre">true</span></code>が返却される。</li>
<li>返り値として数値型を指定した場合は、更新件数が返却される。</li>
</ul>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>マッピングファイルにSQLを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;update</span> <span class="na">id=</span><span class="s">&quot;update&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
        UPDATE
            t_todo
        SET
            todo_title = #{todoTitle},
            finished = #{finished},
            version = version + 1
        WHERE
            todo_id = #{todoId}
        AND
            version = #{version}
    <span class="nt">&lt;/update&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">update</span></code>要素の中に、UPDATEするSQLを実装する。</p>
<p><code class="docutils literal"><span class="pre">id</span></code>属性には、Repositoryインタフェースに定義したメソッドのメソッド名を指定する。</p>
<p><code class="docutils literal"><span class="pre">update</span></code>要素の詳細については、
「<a class="reference external" href="https://mybatis.org/mybatis-3/sqlmap-xml.html#insert_update_and_delete">MyBatis3 REFERENCE DOCUMENTATION (Mapper XML Files-insert, update and delete-)</a>」を参照されたい。</p>
<p class="last">SET句及びWHERE句にバインドする値は、#{variableName}形式のバインド変数として指定する。
上記例では、Repositoryインタフェースの引数としてJavaBean(<code class="docutils literal"><span class="pre">Todo</span></code>)を指定しているため、
バインド変数名にはJavaBeanのプロパティ名を指定する。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>ServiceクラスにRepositoryをDIし、Repositoryインターフェースのメソッドを呼び出す。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.repository.todo.TodoRepository</span><span class="p">;</span>

<span class="nd">@Transactional</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="p">{</span>

    <span class="c1">// (3)</span>
    <span class="nd">@Inject</span>
    <span class="n">TodoRepository</span> <span class="n">todoRepository</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">update</span><span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// (4)</span>
        <span class="n">Todo</span> <span class="n">currentTodo</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">todo</span><span class="p">.</span><span class="na">getTodoId</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">currentTodo</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">currentTodo</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()</span> <span class="o">!=</span> <span class="n">todo</span><span class="p">.</span><span class="na">getVersion</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">ObjectOptimisticLockingFailureException</span><span class="p">(</span><span class="n">Todo</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">todo</span>
                    <span class="p">.</span><span class="na">getTodoId</span><span class="p">());</span>
        <span class="p">}</span>

        <span class="c1">// (5)</span>
        <span class="n">currentTodo</span><span class="p">.</span><span class="na">setTodoTitle</span><span class="p">(</span><span class="n">todo</span><span class="p">.</span><span class="na">getTodoTitle</span><span class="p">());</span>
        <span class="n">currentTodo</span><span class="p">.</span><span class="na">setFinished</span><span class="p">(</span><span class="n">todo</span><span class="p">.</span><span class="na">isFinished</span><span class="p">());</span>

        <span class="c1">// (6)</span>
        <span class="kt">boolean</span> <span class="n">updated</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">currentTodo</span><span class="p">);</span>
        <span class="c1">// (7)</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">ObjectOptimisticLockingFailureException</span><span class="p">(</span><span class="n">Todo</span><span class="p">.</span><span class="na">class</span><span class="p">,</span>
                    <span class="n">currentTodo</span><span class="p">.</span><span class="na">getTodoId</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="n">currentTodo</span><span class="p">.</span><span class="na">setVersion</span><span class="p">(</span><span class="n">todo</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">currentTodo</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>ServiceクラスにRepositoryインターフェースをDIする。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p class="first">更新対象のEntityをデータベースより取得する。</p>
<p class="last">上記例では、Entityが更新されている場合(レコードが削除されている場合又はバージョンが更新されている場合)は、
Spring Frameworkから提供されている楽観ロック例外(<code class="docutils literal"><span class="pre">org.springframework.orm.ObjectOptimisticLockingFailureException</span></code>)を発生させている。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><p class="first">更新対象のEntityに対して、更新内容を反映する。</p>
<p class="last">上記例では、「タイトル」「完了フラグ」を反映している。更新項目が少ない場合は上記実装例のままでもよいが、
更新項目が多い場合は、「<a class="reference internal" href="../GeneralFuncDetail/Dozer.html"><span class="doc">Beanマッピング(Dozer)</span></a>」を使用することを推奨する。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>Repositoryインターフェースのメソッドを呼び出し、Entityを1件更新する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td><p class="first">Entityの更新結果を判定する。</p>
<p class="last">上記例では、Entityが更新されなかった場合(レコードが削除されている場合又はバージョンが更新されている場合)は、
Spring Frameworkから提供されている楽観ロック例外(<code class="docutils literal"><span class="pre">org.springframework.orm.ObjectOptimisticLockingFailureException</span></code>)を発生させている。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>上記例では、更新処理が成功した後に、</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">currentTodo</span><span class="p">.</span><span class="na">setVersion</span><span class="p">(</span><span class="n">todo</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
<p>としている。</p>
<p>これはデータベースに更新したバージョンと、Entityが保持するバージョンを合わせるための処理である。</p>
<p class="last">呼び出し元(ControllerやJSPなど)の処理でバージョンを参照する場合は、
データベースの状態とEntityの状態を一致させておかないと、
データ不整合が発生し、アプリケーションが期待通りの動作しない事になる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtouseupdatemultiple">
<span id="id38"></span><h4><a class="toc-backref" href="#id129">6.2.2.8.2. Entityの一括更新</a><a class="headerlink" href="#dataaccessmybatis3howtouseupdatemultiple" title="Permalink to this headline">¶</a></h4>
<p>Entityを一括で更新する際の実装例を以下に示す。</p>
<p>Entityを一括で更新する場合は、</p>
<ul class="simple">
<li>複数のレコードを同時に更新するUPDATE文を発行する</li>
<li>JDBCのバッチ更新機能を使用する</li>
</ul>
<p>方法がある。</p>
<p>JDBCのバッチ更新機能を使用する方法については、「<a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatch"><span class="std std-ref">バッチモードの利用</span></a>」を参照されたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>ここでは、複数のレコードを同時に更新するUPDATE文を発行する方法について説明する。</p>
<ul class="simple">
<li>Repositoryインタフェースにメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.repository.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Param</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="p">{</span>

    <span class="c1">// (1)</span>
    <span class="kt">int</span> <span class="nf">updateFinishedByTodIds</span><span class="p">(</span><span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;finished&quot;</span><span class="p">)</span> <span class="kt">boolean</span> <span class="n">finished</span><span class="p">,</span>
                               <span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;todoIds&quot;</span><span class="p">)</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">todoIds</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>上記例では、引数に指定されたIDのリストに該当するレコードの<code class="docutils literal"><span class="pre">finished</span></code>カラムを更新するためのメソッドとして、
<code class="docutils literal"><span class="pre">updateFinishedByTodIds</span></code>メソッドを定義している。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Entityを一括更新するメソッドの返り値について</strong></p>
<p class="last">Entityを一括更新するメソッドの返り値は、数値型(<code class="docutils literal"><span class="pre">int</span></code>又は<code class="docutils literal"><span class="pre">long</span></code>)でよい。
数値型にすると、更新されたレコード数を取得する事ができる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>マッピングファイルにSQLを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;update</span> <span class="na">id=</span><span class="s">&quot;updateFinishedByTodIds&quot;</span><span class="nt">&gt;</span>
        UPDATE
            t_todo
        SET
            finished = #{finished},
            /* (2) */
            version = version + 1
        WHERE
            /* (3) */
            <span class="nt">&lt;foreach</span> <span class="na">item=</span><span class="s">&quot;todoId&quot;</span> <span class="na">collection=</span><span class="s">&quot;todoIds&quot;</span>
                     <span class="na">open=</span><span class="s">&quot;todo_id IN (&quot;</span> <span class="na">separator=</span><span class="s">&quot;,&quot;</span> <span class="na">close=</span><span class="s">&quot;)&quot;</span><span class="nt">&gt;</span>
                #{todoId}
            <span class="nt">&lt;/foreach&gt;</span>
    <span class="nt">&lt;/update&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="11%" />
<col width="78%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>-</td>
<td><p class="first">バージョンカラムを使用して楽観ロックを行う場合は、バージョンカラムを更新する。</p>
<p class="last">更新しないと、楽観ロック制御が正しく動作しなくなる。
排他制御の詳細については、「<a class="reference internal" href="ExclusionControl.html"><span class="doc">排他制御</span></a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>-</td>
<td>WHERE句に複数レコードを更新するための更新条件を指定する。</td>
</tr>
<tr class="row-even"><td>&#160;</td>
<td>-</td>
<td><p class="first"><code class="docutils literal"><span class="pre">foreach</span></code>要素を使用して、引数で渡されたIDのリストに対して繰り返し処理を行う。</p>
<p>上記例では、引数で渡されたIDのリストより、IN句を生成している。</p>
<p class="last"><code class="docutils literal"><span class="pre">foreach</span></code>の詳細については、
「<a class="reference external" href="https://mybatis.org/mybatis-3/dynamic-sql.html#foreach">MyBatis3 REFERENCE DOCUMENTATION (Dynamic SQL-foreach-)</a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td>collection</td>
<td><p class="first">処理対象のコレクションを指定する。</p>
<p class="last">上記例では、Repositoryのメソッド引数のIDのリスト(<code class="docutils literal"><span class="pre">todoIds</span></code>)に対して繰り返し処理を行っている。</p>
</td>
</tr>
<tr class="row-even"><td>&#160;</td>
<td>item</td>
<td>リストの中の1要素を保持するローカル変数名を指定する。</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td>separator</td>
<td><p class="first">リスト内の要素間を区切るための文字列を指定する。</p>
<p class="last">上記例では、IN句の区切り文字である”<code class="docutils literal"><span class="pre">,</span></code>”を指定している。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtousedelete">
<span id="id40"></span><h3><a class="toc-backref" href="#id130">6.2.2.9. Entityの削除処理</a><a class="headerlink" href="#dataaccessmybatis3howtousedelete" title="Permalink to this headline">¶</a></h3>
<div class="section" id="dataaccessmybatis3howtousedeleteone">
<span id="id41"></span><h4><a class="toc-backref" href="#id131">6.2.2.9.1. Entityの1件削除</a><a class="headerlink" href="#dataaccessmybatis3howtousedeleteone" title="Permalink to this headline">¶</a></h4>
<p>Entityを1件削除する際の実装例を以下に示す。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>以降の説明では、バージョンカラムを使用した楽観ロックを行う実装例となっているが、
楽観ロックの必要がない場合は、楽観ロック関連の処理を行う必要はない。</p>
<p class="last">排他制御の詳細については、「<a class="reference internal" href="ExclusionControl.html"><span class="doc">排他制御</span></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Repositoryインタフェースにメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.repository.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="p">{</span>

    <span class="c1">// (1)</span>
    <span class="kt">boolean</span> <span class="nf">delete</span><span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>上記例では、引数に指定されたTodoオブジェクトを1件削除するためのメソッドとして、
<code class="docutils literal"><span class="pre">delete</span></code>メソッドを定義している。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Entityを1件削除するメソッドの返り値について</strong></p>
<p>Entityを1件削除するメソッドの返り値は、基本的には<code class="docutils literal"><span class="pre">boolean</span></code>でよい。</p>
<p>ただし、削除結果が複数件になった場合にデータ不整合エラーとして扱う必要がある場合は、
数値型(<code class="docutils literal"><span class="pre">int</span></code>又は<code class="docutils literal"><span class="pre">long</span></code>)を返り値にし、削除件数が1件であることをチェックする必要がある。
主キーが削除条件となっている場合は、削除結果が複数件になる事はないので、<code class="docutils literal"><span class="pre">boolean</span></code>でよい。</p>
<ul class="last simple">
<li>返り値として<code class="docutils literal"><span class="pre">boolean</span></code>を指定した場合は、削除件数が0件の際は<code class="docutils literal"><span class="pre">false</span></code>、削除件数が1件以上の際は<code class="docutils literal"><span class="pre">true</span></code>が返却される。</li>
<li>返り値として数値型を指定した場合は、削除件数が返却される。</li>
</ul>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>マッピングファイルにSQLを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;delete</span> <span class="na">id=</span><span class="s">&quot;delete&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
        DELETE FROM
            t_todo
        WHERE
            todo_id = #{todoId}
        AND
            version = #{version}
    <span class="nt">&lt;/delete&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">delete</span></code>要素の中に、DELETEするSQLを実装する。</p>
<p><code class="docutils literal"><span class="pre">id</span></code>属性には、Repositoryインタフェースに定義したメソッドのメソッド名を指定する。</p>
<p><code class="docutils literal"><span class="pre">delete</span></code>要素の詳細については、
「<a class="reference external" href="https://mybatis.org/mybatis-3/sqlmap-xml.html#insert_update_and_delete">MyBatis3 REFERENCE DOCUMENTATION (Mapper XML Files-insert, update and delete-)</a>」を参照されたい。</p>
<p class="last">WHERE句にバインドする値は、#{variableName}形式のバインド変数として指定する。
上記例では、Repositoryインタフェースの引数としてJavaBean(<code class="docutils literal"><span class="pre">Todo</span></code>)を指定しているため、
バインド変数名にはJavaBeanのプロパティ名を指定する。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>ServiceクラスにRepositoryをDIし、Repositoryインターフェースのメソッドを呼び出す。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.repository.todo.TodoRepository</span><span class="p">;</span>

<span class="nd">@Transactional</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="p">{</span>

    <span class="c1">// (3)</span>
    <span class="nd">@Inject</span>
    <span class="n">TodoRepository</span> <span class="n">todoRepository</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">delete</span><span class="p">(</span><span class="n">String</span> <span class="n">todoId</span><span class="p">,</span> <span class="kt">long</span> <span class="n">version</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// (4)</span>
        <span class="n">Todo</span> <span class="n">currentTodo</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">todoId</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">currentTodo</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">currentTodo</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()</span> <span class="o">!=</span> <span class="n">version</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">ObjectOptimisticLockingFailureException</span><span class="p">(</span><span class="n">Todo</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">todoId</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// (5)</span>
        <span class="kt">boolean</span> <span class="n">deleted</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">currentTodo</span><span class="p">);</span>
        <span class="c1">// (6)</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">deleted</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">ObjectOptimisticLockingFailureException</span><span class="p">(</span><span class="n">Todo</span><span class="p">.</span><span class="na">class</span><span class="p">,</span>
                    <span class="n">currentTodo</span><span class="p">.</span><span class="na">getTodoId</span><span class="p">());</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">currentTodo</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>ServiceクラスにRepositoryインターフェースをDIする。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p class="first">削除対象のEntityをデータベースより取得する。</p>
<p class="last">上記例では、Entityが更新されている場合(レコードが削除されている場合又はバージョンが更新されている場合)は、
Spring Frameworkから提供されている楽観ロック例外(<code class="docutils literal"><span class="pre">org.springframework.orm.ObjectOptimisticLockingFailureException</span></code>)を発生させている。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>Repositoryインターフェースのメソッドを呼び出し、Entityを1件削除する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td><p class="first">Entityの削除結果を判定する。</p>
<p class="last">上記例では、Entityが削除されなかった場合(レコードが削除されている場合又はバージョンが更新されている場合)は、
Spring Frameworkから提供されている楽観ロック例外(<code class="docutils literal"><span class="pre">org.springframework.orm.ObjectOptimisticLockingFailureException</span></code>)を発生させている。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtousedeletemultiple">
<span id="id43"></span><h4><a class="toc-backref" href="#id132">6.2.2.9.2. Entityの一括削除</a><a class="headerlink" href="#dataaccessmybatis3howtousedeletemultiple" title="Permalink to this headline">¶</a></h4>
<p>Entityを一括で削除する際の実装例を以下に示す。</p>
<p>Entityを一括で削除する場合は、</p>
<ul class="simple">
<li>複数のレコードを同時に削除するDELETE文を発行する</li>
<li>JDBCのバッチ更新機能を使用する</li>
</ul>
<p>方法がある。</p>
<p>JDBCのバッチ更新機能を使用する方法については、「<a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatch"><span class="std std-ref">バッチモードの利用</span></a>」を参照されたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>ここでは、複数のレコードを同時に削除するDELETE文を発行する方法について説明する。</p>
<ul class="simple">
<li>Repositoryインタフェースにメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.repository.todo</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="p">{</span>

    <span class="c1">// (1)</span>
    <span class="kt">int</span> <span class="nf">deleteOlderFinishedTodo</span><span class="p">(</span><span class="n">Date</span> <span class="n">criteriaDate</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>上記例では、基準日より前に作成され完了済みのレコードを削除するためのメソッドとして、
<code class="docutils literal"><span class="pre">deleteOlderFinishedTodo</span></code>メソッドを定義している。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Entityを一括削除するメソッドの返り値について</strong></p>
<p class="last">Entityを一括削除するメソッドの返り値は、数値型(<code class="docutils literal"><span class="pre">int</span></code>又は<code class="docutils literal"><span class="pre">long</span></code>)でよい。
数値型にすると、削除されたレコード数を取得する事ができる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>マッピングファイルにSQLを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;delete</span> <span class="na">id=</span><span class="s">&quot;deleteOlderFinishedTodo&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;date&quot;</span><span class="nt">&gt;</span>
        <span class="cp">&lt;![CDATA[</span>
<span class="cp">        DELETE FROM</span>
<span class="cp">            t_todo</span>
<span class="cp">        /* (2) */</span>
<span class="cp">        WHERE</span>
<span class="cp">            finished = TRUE</span>
<span class="cp">        AND</span>
<span class="cp">            created_at  &lt; #{criteriaDate}</span>
<span class="cp">        ]]&gt;</span>
    <span class="nt">&lt;/delete&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first">WHERE句に複数レコードを更新するための削除条件を指定する。</p>
<p>上記例では、</p>
<ul class="simple">
<li>完了済み(<code class="docutils literal"><span class="pre">finished</span></code>が<code class="docutils literal"><span class="pre">TRUE</span></code>)</li>
<li>基準日より前に作成された(<code class="docutils literal"><span class="pre">created_at</span></code>が基準日より前)</li>
</ul>
<p class="last">を削除条件として指定している。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtousedynamicsql">
<span id="id44"></span><h3><a class="toc-backref" href="#id133">6.2.2.10. 動的SQLの実装</a><a class="headerlink" href="#dataaccessmybatis3howtousedynamicsql" title="Permalink to this headline">¶</a></h3>
<p>動的SQLを組み立てる実装例を以下に示す。</p>
<p>MyBatis3では、動的にSQLを組み立てるためのXML要素と、OGNLベースの式（Expression言語）を使用することで、
動的SQLを組み立てる仕組みを提供している。</p>
<p>動的SQLの詳細については、
「<a class="reference external" href="https://mybatis.org/mybatis-3/dynamic-sql.html">MyBatis3 REFERENCE DOCUMENTATION (Dynamic SQL)</a>」を参照されたい。</p>
<p>MyBatis3では、動的にSQLを組み立てるために、以下のXML要素を提供している。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="11%" />
<col width="78%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">要素名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">if</span></code></td>
<td>条件に一致した場合のみ、SQLの組み立てを行うための要素。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">choose</span></code></td>
<td>複数の選択肢の中から条件に一致する1つを選んで、SQLの組み立てを行うための要素。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">where</span></code></td>
<td>組み立てたWHERE句に対して、接頭語及び末尾の付与や除去など行うための要素。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">set</span></code></td>
<td>組み立てたSET句用に対して、接頭語及び末尾の付与や除去など行うための要素。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">foreach</span></code></td>
<td>コレクションや配列に対して繰り返し処理を行うための要素</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">bind</span></code></td>
<td><p class="first">OGNL式の結果を変数に格納するための要素。</p>
<p class="last"><code class="docutils literal"><span class="pre">bind</span></code>要素を使用して格納した変数は、SQL内で参照する事ができる。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>一覧には記載していないが、動的SQLを組み立てるためのXML要素として<code class="docutils literal"><span class="pre">trim</span></code>要素が提供されている。</p>
<p><code class="docutils literal"><span class="pre">trim</span></code>要素は、<code class="docutils literal"><span class="pre">where</span></code>要素と<code class="docutils literal"><span class="pre">set</span></code>要素をより汎用的にしたXML要素である。</p>
<p class="last">ほとんどの場合は、<code class="docutils literal"><span class="pre">where</span></code>要素と<code class="docutils literal"><span class="pre">set</span></code>要素で要件を充たせるため、本ガイドラインでは<code class="docutils literal"><span class="pre">trim</span></code>要素の説明は割愛する。
<code class="docutils literal"><span class="pre">trim</span></code>要素が必要になる場合は、
「<a class="reference external" href="https://mybatis.org/mybatis-3/dynamic-sql.html#trim_where_set">MyBatis3 REFERENCE DOCUMENTATION (Dynamic SQL-trim, where, set-)</a>」
を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="if">
<h4><a class="toc-backref" href="#id134">6.2.2.10.1. if要素の実装</a><a class="headerlink" href="#if" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">if</span></code>要素は、指定した条件に一致した場合のみ、SQLの組み立てを行うためのXML要素である。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAllByCriteria&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;TodoCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    SELECT
        todo_id,
        todo_title,
        finished,
        created_at,
        version
    FROM
        t_todo
    WHERE
        todo_title LIKE #{todoTitle} || &#39;%&#39; ESCAPE &#39;~&#39;
    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;if</span> <span class="na">test=</span><span class="s">&quot;finished != null&quot;</span><span class="nt">&gt;</span>
        AND
            finished = #{finished}
    <span class="nt">&lt;/if&gt;</span>
    ORDER BY
        todo_id
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">if</span></code>要素の<code class="docutils literal"><span class="pre">test</span></code>属性に、条件を指定する。</p>
<p class="last">上記例では、検索条件として<code class="docutils literal"><span class="pre">finished</span></code>が指定されている場合に、<code class="docutils literal"><span class="pre">finished</span></code>カラムに対する条件をSQLに加えている。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>上記の動的SQLで生成されるSQL(WHERE句)は、以下2パターンとなる。</p>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (1) finished == null</span>
<span class="p">...</span>
<span class="k">WHERE</span>
    <span class="n">todo_title</span> <span class="k">LIKE</span> <span class="o">?</span> <span class="o">||</span> <span class="s1">&#39;%&#39;</span> <span class="k">ESCAPE</span> <span class="s1">&#39;~&#39;</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">todo_id</span>
</pre></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (2) finished != null</span>
<span class="p">...</span>
<span class="k">WHERE</span>
    <span class="n">todo_title</span> <span class="k">LIKE</span> <span class="o">?</span> <span class="o">||</span> <span class="s1">&#39;%&#39;</span> <span class="k">ESCAPE</span> <span class="s1">&#39;~&#39;</span>
<span class="k">AND</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="o">?</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">todo_id</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="choose">
<h4><a class="toc-backref" href="#id135">6.2.2.10.2. choose要素の実装</a><a class="headerlink" href="#choose" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">choose</span></code>要素は、複数の選択肢の中から条件に一致する1つを選んで、SQLの組み立てを行うためのXML要素である。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAllByCriteria&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;TodoCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    SELECT
        todo_id,
        todo_title,
        finished,
        created_at,
        version
    FROM
        t_todo
    WHERE
        todo_title LIKE #{todoTitle} || &#39;%&#39; ESCAPE &#39;~&#39;
    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;choose&gt;</span>
        <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;when</span> <span class="na">test=</span><span class="s">&quot;createdAt != null&quot;</span><span class="nt">&gt;</span>
            AND
                created_at <span class="cp">&lt;![CDATA[ &gt; ]]&gt;</span> #{createdAt}
        <span class="nt">&lt;/when&gt;</span>
        <span class="c">&lt;!-- (3) --&gt;</span>
        <span class="nt">&lt;otherwise&gt;</span>
            AND
                created_at <span class="cp">&lt;![CDATA[ &gt; ]]&gt;</span> CURRENT_DATE
        <span class="nt">&lt;/otherwise&gt;</span>
    <span class="nt">&lt;/choose&gt;</span>
    ORDER BY
        todo_id
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">choose</span></code>要素に中に、<code class="docutils literal"><span class="pre">when</span></code>要素と<code class="docutils literal"><span class="pre">otherwise</span></code>要素を指定して、SQLを組み立てる条件を指定する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">when</span></code>要素の<code class="docutils literal"><span class="pre">test</span></code>属性に、条件を指定する。</p>
<p class="last">上記例では、検索条件として<code class="docutils literal"><span class="pre">createdAt</span></code>が指定されている場合に、
<code class="docutils literal"><span class="pre">create_at</span></code>カラムの値が指定日以降のレコードを抽出するための条件をSQLに加えている。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">otherwise</span></code>要素に、全ての<code class="docutils literal"><span class="pre">when</span></code>要素に一致しない場合時に組み立てるSQLを指定する。</p>
<p class="last">上記例では、<code class="docutils literal"><span class="pre">create_at</span></code>カラムの値が現在日以降のレコード(当日作成されたレコード)を抽出するための条件をSQLに加えている。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>上記の動的SQLで生成されるSQL(WHERE句)は、以下2パターンとなる。</p>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (1) createdAt!=null</span>
<span class="p">...</span>
<span class="k">WHERE</span>
    <span class="n">todo_title</span> <span class="k">LIKE</span> <span class="o">?</span> <span class="o">||</span> <span class="s1">&#39;%&#39;</span> <span class="k">ESCAPE</span> <span class="s1">&#39;~&#39;</span>
<span class="k">AND</span>
    <span class="n">created_at</span>   <span class="o">&gt;</span>   <span class="o">?</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">todo_id</span>
</pre></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (2) createdAt==null</span>
<span class="p">...</span>
<span class="k">WHERE</span>
    <span class="n">todo_title</span> <span class="k">LIKE</span> <span class="o">?</span> <span class="o">||</span> <span class="s1">&#39;%&#39;</span> <span class="k">ESCAPE</span> <span class="s1">&#39;~&#39;</span>
<span class="k">AND</span>
    <span class="n">created_at</span> <span class="o">&gt;</span> <span class="k">CURRENT_DATE</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">todo_id</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="where">
<h4><a class="toc-backref" href="#id136">6.2.2.10.3. where要素の実装</a><a class="headerlink" href="#where" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">where</span></code>要素は、WHERE句を動的に生成するためのXML要素である。</p>
<p><code class="docutils literal"><span class="pre">where</span></code>要素を使用すると、</p>
<ul class="simple">
<li>WHERE句の付与</li>
<li>AND句、OR句の除去</li>
</ul>
<p>などが行われるため、シンプルにWHERE句を組み立てる事ができる。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAllByCriteria2&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;TodoCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    SELECT
        todo_id,
        todo_title,
        finished,
        created_at,
        version
    FROM
        t_todo
    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;where&gt;</span>
        <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;if</span> <span class="na">test=</span><span class="s">&quot;finished != null&quot;</span><span class="nt">&gt;</span>
            AND
                finished = #{finished}
        <span class="nt">&lt;/if&gt;</span>
        <span class="c">&lt;!-- (3) --&gt;</span>
        <span class="nt">&lt;if</span> <span class="na">test=</span><span class="s">&quot;createdAt != null&quot;</span><span class="nt">&gt;</span>
            AND
                created_at <span class="cp">&lt;![CDATA[ &gt; ]]&gt;</span> #{createdAt}
        <span class="nt">&lt;/if&gt;</span>
    <span class="nt">&lt;/where&gt;</span>
    ORDER BY
        todo_id
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">where</span></code>要素に中で、WHERE句を組み立てるための動的SQLを実装する。</p>
<p class="last"><code class="docutils literal"><span class="pre">where</span></code>要素内で組み立てたSQLに応じて、WHERE句の付与や、AND句及びORの除去などが行われる。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">動的SQLを組み立てる。</p>
<p class="last">上記例では、検索条件として<code class="docutils literal"><span class="pre">finished</span></code>が指定されている場合に、
<code class="docutils literal"><span class="pre">finished</span></code>カラムに対する条件をSQLに加えている。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first">動的SQLを組み立てる。</p>
<p class="last">上記例では、検索条件として<code class="docutils literal"><span class="pre">createdAt</span></code>が指定されている場合に、
<code class="docutils literal"><span class="pre">created_at</span></code>カラムに対する条件をSQLに加えている。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>上記の動的SQLで生成されるSQL(WHERE句)は、以下4パターンとなる。</p>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (1) finished != null &amp;&amp; createdAt != null</span>
<span class="p">...</span>
<span class="k">FROM</span>
    <span class="n">t_todo</span>
<span class="k">WHERE</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="o">?</span>
<span class="k">AND</span>
    <span class="n">created_at</span>  <span class="o">&gt;</span>  <span class="o">?</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">todo_id</span>
</pre></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (2) finished != null &amp;&amp; createdAt == null</span>
<span class="p">...</span>
<span class="k">FROM</span>
    <span class="n">t_todo</span>
<span class="k">WHERE</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="o">?</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">todo_id</span>
</pre></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (3) finished == null &amp;&amp; createdAt != null</span>
<span class="p">...</span>
<span class="k">FROM</span>
    <span class="n">t_todo</span>
<span class="k">WHERE</span>
    <span class="n">created_at</span>  <span class="o">&gt;</span>  <span class="o">?</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">todo_id</span>
</pre></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (4) finished == null &amp;&amp; createdAt == null</span>
<span class="p">...</span>
<span class="k">FROM</span>
    <span class="n">t_todo</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">todo_id</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="set">
<h4><a class="toc-backref" href="#id137">6.2.2.10.4. set要素の実装例</a><a class="headerlink" href="#set" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">set</span></code>要素は、SET句を動的に生成するためのXML要素である。</p>
<p><code class="docutils literal"><span class="pre">set</span></code>要素を使用すると、</p>
<ul class="simple">
<li>SET句の付与</li>
<li>末尾のカンマの除去</li>
</ul>
<p>などが行われるため、シンプルにSET句を組み立てる事ができる。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;update</span> <span class="na">id=</span><span class="s">&quot;update&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    UPDATE
        t_todo
    <span class="c">&lt;!-- (1)  --&gt;</span>
    <span class="nt">&lt;set&gt;</span>
        version = version + 1,
        <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;if</span> <span class="na">test=</span><span class="s">&quot;todoTitle != null&quot;</span><span class="nt">&gt;</span>
            todo_title = #{todoTitle}
        <span class="nt">&lt;/if&gt;</span>
    <span class="nt">&lt;/set&gt;</span>
    WHERE
        todo_id = #{todoId}
<span class="nt">&lt;/update&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">set</span></code>要素に中で、SET句を組み立てるための動的SQLを実装する。</p>
<p class="last"><code class="docutils literal"><span class="pre">set</span></code>要素内で組み立てたSQLに応じて、SET句の付与や、末尾のカンマの除去などが行われる。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">動的SQLを組み立てる。</p>
<p class="last">上記例では、更新項目として<code class="docutils literal"><span class="pre">todoTitle</span></code>が指定されている場合に、
<code class="docutils literal"><span class="pre">todo_title</span></code>カラムを更新カラムとしてSQLに加えている。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>上記の動的SQLで生成されるSQLは、以下2パターンとなる。</p>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (1) todoTitle != null</span>
<span class="k">UPDATE</span>
    <span class="n">t_todo</span>
<span class="k">SET</span>
    <span class="k">version</span> <span class="o">=</span> <span class="k">version</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">todo_title</span> <span class="o">=</span> <span class="o">?</span>
<span class="k">WHERE</span>
    <span class="n">todo_id</span> <span class="o">=</span> <span class="o">?</span>
</pre></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (2) todoTitle == null</span>
<span class="k">UPDATE</span>
    <span class="n">t_todo</span>
<span class="k">SET</span>
   <span class="k">version</span> <span class="o">=</span> <span class="k">version</span> <span class="o">+</span> <span class="mi">1</span>
<span class="k">WHERE</span>
    <span class="n">todo_id</span> <span class="o">=</span> <span class="o">?</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="foreach">
<h4><a class="toc-backref" href="#id138">6.2.2.10.5. foreach要素の実装例</a><a class="headerlink" href="#foreach" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">foreach</span></code>要素は、コレクションや配列に対して繰り返し処理を行うためのXML要素である。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAllByCreatedAtList&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;list&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    SELECT
        todo_id,
        todo_title,
        finished,
        created_at,
        version
    FROM
        t_todo
    <span class="nt">&lt;where&gt;</span>
        <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;if</span> <span class="na">test=</span><span class="s">&quot;list != null&quot;</span><span class="nt">&gt;</span>
            <span class="c">&lt;!-- (2) --&gt;</span>
            <span class="nt">&lt;foreach</span> <span class="na">collection=</span><span class="s">&quot;list&quot;</span> <span class="na">item=</span><span class="s">&quot;date&quot;</span> <span class="na">separator=</span><span class="s">&quot;OR&quot;</span><span class="nt">&gt;</span>
            <span class="cp">&lt;![CDATA[</span>
<span class="cp">                (created_at &gt;= #{date} AND created_at &lt; DATEADD(&#39;DAY&#39;, 1, #{date}))</span>
<span class="cp">            ]]&gt;</span>
            <span class="nt">&lt;/foreach&gt;</span>
        <span class="nt">&lt;/if&gt;</span>
    <span class="nt">&lt;/where&gt;</span>
    ORDER BY
        todo_id
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="17%" />
<col width="72%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>-</td>
<td><p class="first">繰り返し処理を行う対象のコレクション又は配列に対して、<code class="docutils literal"><span class="pre">null</span></code>チェックを行う。</p>
<p class="last"><code class="docutils literal"><span class="pre">null</span></code>にならない事がない場合は、このチェックは実装しなくてもよい。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>-</td>
<td><p class="first"><code class="docutils literal"><span class="pre">foreach</span></code>要素を使用して、コレクションや配列に対して繰り返し処理を行い、動的SQLを組み立てる。</p>
<p class="last">上記例では、レコードの作成日付が、指定された日付(日付リスト)の何れかと一致するレコードを検索するためのWHERE句を組み立てている。</p>
</td>
</tr>
<tr class="row-even"><td>&#160;</td>
<td>collection</td>
<td><p class="first"><code class="docutils literal"><span class="pre">collection</span></code>属性に、繰り返し処理を行うコレクションや配列を指定する。</p>
<p class="last">上記例では、Repositoryメソッドの引数に指定されたコレクションを指定している。</p>
</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td>item</td>
<td><p class="first"><code class="docutils literal"><span class="pre">item</span></code>属性に、リストの中の1要素を保持するローカル変数名を指定する。</p>
<p class="last">上記例では、<code class="docutils literal"><span class="pre">collection</span></code>属性に日付リストを指定しているので、
<code class="docutils literal"><span class="pre">date</span></code>という変数名を指定している。</p>
</td>
</tr>
<tr class="row-even"><td>&#160;</td>
<td>separator</td>
<td><p class="first"><code class="docutils literal"><span class="pre">separator</span></code>属性に、要素間の区切り文字列を指定する。</p>
<p class="last">上記例では、OR条件のWHERE句を組み立てている。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>上記例では使用していないが、 <code class="docutils literal"><span class="pre">foreach</span></code>要素には、以下の属性が存在する。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="17%" />
<col width="72%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>open</td>
<td>コレクションの先頭要素を処理する前に設定する文字列を指定する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>close</td>
<td>コレクションの末尾要素を処理した後に設定する文字列を指定する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>index</td>
<td>ループ番号を格納する変数名を指定する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><code class="docutils literal"><span class="pre">index</span></code>属性を使用するケースはあまりないが、<code class="docutils literal"><span class="pre">open</span></code>属性と <code class="docutils literal"><span class="pre">close</span></code>属性は、
IN句などを動的に生成する際に使用される。</p>
<p>以下に、IN句を作成する際の<code class="docutils literal"><span class="pre">foreach</span></code>要素の使用例を記載しておく。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;foreach</span> <span class="na">collection=</span><span class="s">&quot;list&quot;</span> <span class="na">item=</span><span class="s">&quot;statusCode&quot;</span>
        <span class="na">open=</span><span class="s">&quot;AND order_status IN (&quot;</span>
        <span class="na">separator=</span><span class="s">&quot;,&quot;</span>
        <span class="na">close=</span><span class="s">&quot;)&quot;</span><span class="nt">&gt;</span>
    #{statusCode}
<span class="nt">&lt;/foreach&gt;</span>
</pre></div>
</div>
</div></blockquote>
<p>以下の様なSQLが組み立てられる。</p>
<blockquote class="last">
<div><div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- list=[&#39;accepted&#39;,&#39;checking&#39;]</span>
<span class="p">...</span>
<span class="k">AND</span> <span class="n">order_status</span> <span class="k">IN</span> <span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="o">?</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">上記の動的SQLで生成されるSQL(WHERE句)は、以下3パターンとなる。</div>
</div>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (1) list=null or statusCodes=[]</span>
<span class="p">...</span>
<span class="k">FROM</span>
    <span class="n">t_todo</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">todo_id</span>
</pre></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (2) list=[&#39;2014-01-01&#39;]</span>
<span class="p">...</span>
<span class="k">FROM</span>
    <span class="n">t_todo</span>
<span class="k">WHERE</span>
    <span class="p">(</span><span class="n">created_at</span> <span class="o">&gt;=</span> <span class="o">?</span> <span class="k">AND</span> <span class="n">created_at</span> <span class="o">&lt;</span> <span class="n">DATEADD</span><span class="p">(</span><span class="s1">&#39;DAY&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">?</span><span class="p">))</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">todo_id</span>
</pre></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (3) list=[&#39;2014-01-01&#39;,&#39;2014-01-02&#39;]</span>
<span class="p">...</span>
<span class="k">FROM</span>
    <span class="n">t_todo</span>
<span class="k">WHERE</span>
    <span class="p">(</span><span class="n">created_at</span> <span class="o">&gt;=</span> <span class="o">?</span> <span class="k">AND</span> <span class="n">created_at</span> <span class="o">&lt;</span> <span class="n">DATEADD</span><span class="p">(</span><span class="s1">&#39;DAY&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">?</span><span class="p">))</span>
<span class="k">OR</span>
    <span class="p">(</span><span class="n">created_at</span> <span class="o">&gt;=</span> <span class="o">?</span> <span class="k">AND</span> <span class="n">created_at</span> <span class="o">&lt;</span> <span class="n">DATEADD</span><span class="p">(</span><span class="s1">&#39;DAY&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">?</span><span class="p">))</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">todo_id</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="bind">
<h4><a class="toc-backref" href="#id139">6.2.2.10.6. bind要素の実装例</a><a class="headerlink" href="#bind" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">bind</span></code>要素は、OGNL式の結果を変数に格納するためのXML要素である。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAllByCriteria&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;TodoCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;bind</span> <span class="na">name=</span><span class="s">&quot;escapedTodoTitle&quot;</span>
          <span class="na">value=</span><span class="s">&quot;@org.terasoluna.gfw.common.query.QueryEscapeUtils@toLikeCondition(todoTitle)&quot;</span> <span class="nt">/&gt;</span>
    SELECT
        todo_id,
        todo_title,
        finished,
        created_at,
        version
    FROM
        t_todo
    WHERE
        /* (2) */
        todo_title LIKE #{escapedTodoTitle} || &#39;%&#39; ESCAPE &#39;~&#39;
    ORDER BY
        todo_id
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="17%" />
<col width="72%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>-</td>
<td><p class="first"><code class="docutils literal"><span class="pre">bind</span></code>要素を使用して、OGNL式の結果を変数に格納する</p>
<p class="last">上記例では、OGNL式を使ってメソッドを呼び出した結果を、変数に格納している。</p>
</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td>name</td>
<td><p class="first"><code class="docutils literal"><span class="pre">name</span></code>属性には、変数名を指定する。</p>
<p class="last">ここで指定した変数名は、SQLのバインド変数として使用する事ができる。</p>
</td>
</tr>
<tr class="row-even"><td>&#160;</td>
<td>value</td>
<td><p class="first"><code class="docutils literal"><span class="pre">value</span></code>属性には、OGNL式を指定する。</p>
<p>OGNL式を実行した結果が、<code class="docutils literal"><span class="pre">name</span></code>属性で指定した変数に格納される。</p>
<p class="last">上記例では、共通ライブラリから提供しているメソッド(<code class="docutils literal"><span class="pre">QueryEscapeUtils#toLikeCondition(String)</span></code>)を呼び出した結果を、
<code class="docutils literal"><span class="pre">escapedTodoTitle</span></code>という変数に格納している。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>-</td>
<td><p class="first"><code class="docutils literal"><span class="pre">bind</span></code>要素を使用して作成した変数を、バインド変数として指定する。</p>
<p class="last">上記例では、<code class="docutils literal"><span class="pre">bind</span></code>要素を使用して作成した変数(<code class="docutils literal"><span class="pre">escapedTodoTitle</span></code>)を、バインド変数として指定している。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>上記例では、<code class="docutils literal"><span class="pre">bind</span></code>要素を使用して作成した変数をバインド変数として指定しているが、
置換変数として使用する事もできる。</p>
<p class="last">バインド変数と置換変数については、
「<a class="reference internal" href="#dataaccessmybatis3howtousesqlinjectioncountermeasure"><span class="std std-ref">SQL Injection対策</span></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="like">
<span id="dataaccessmybatis3howtouselikeescape"></span><h3><a class="toc-backref" href="#id140">6.2.2.11. LIKE検索時のエスケープ</a><a class="headerlink" href="#like" title="Permalink to this headline">¶</a></h3>
<p>LIKE検索を行う場合は、検索条件として使用する値をLIKE検索用にエスケープする必要がある。</p>
<p>LIKE検索用のエスケープ処理は、
共通ライブラリから提供している<code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.query.QueryEscapeUtils</span></code> クラスのメソッドを使用することで実現する事ができる。</p>
<p>共通ライブラリから提供しているエスケープ処理の仕様については、
「<a class="reference internal" href="DataAccessCommon.html#data-access-common-appendix-like-escape"><span class="std std-ref">LIKE検索時のエスケープについて</span></a>」を参照されたい。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAllByCriteria&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;TodoCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;bind</span> <span class="na">name=</span><span class="s">&quot;todoTitleContainingCondition&quot;</span>
          <span class="na">value=</span><span class="s">&quot;@org.terasoluna.gfw.common.query.QueryEscapeUtils@toContainingCondition(todoTitle)&quot;</span> <span class="nt">/&gt;</span>
    SELECT
        todo_id,
        todo_title,
        finished,
        created_at,
        version
    FROM
        t_todo
    WHERE
        /* (2) (3) */
        todo_title LIKE #{todoTitleContainingCondition} ESCAPE &#39;~&#39;
    ORDER BY
        todo_id
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">bind</span></code>要素(OGNL式)を使用して、共通ライブラリから提供しているLIKE検索用のエスケープ処理メソッドを呼び出す。</p>
<p class="last">上記例では、部分一致用のエスケープ処理を行い<code class="docutils literal"><span class="pre">todoTitleContainingCondition</span></code>という変数に格納している。
<code class="docutils literal"><span class="pre">QueryEscapeUtils&#64;toContainingCondition(String)</span></code>メソッドは、エスケープした文字列の前後に”<code class="docutils literal"><span class="pre">%</span></code>”を付与するメソッドである。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>部分一致用のエスケープを行った文字列を、LIKE句のバインド変数として指定する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first">ESCAPE句にエスケープ文字を指定する。</p>
<p class="last">共通ライブラリから提供しているエスケープ処理では、
エスケープ文字として”<code class="docutils literal"><span class="pre">~</span></code>”を使用しているため、ESCAPE句に<code class="docutils literal"><span class="pre">'~'</span></code>を指定している。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>上記例では、部分一致用のエスケープ処理を行うメソッドを呼び出しているが、</p>
<ul class="simple">
<li>前方一致用のエスケープ(<code class="docutils literal"><span class="pre">QueryEscapeUtils&#64;toStartingWithCondition(String)</span></code>)</li>
<li>後方一致用のエスケープ(<code class="docutils literal"><span class="pre">QueryEscapeUtils&#64;toEndingWithCondition(String)</span></code>)</li>
<li>エスケープのみ(<code class="docutils literal"><span class="pre">QueryEscapeUtils&#64;toLikeCondition(String)</span></code>)</li>
</ul>
<p>を行うメソッドも用意されている。</p>
<p class="last">詳細は「<a class="reference internal" href="DataAccessCommon.html#data-access-common-appendix-like-escape"><span class="std std-ref">LIKE検索時のエスケープについて</span></a>」を参照されたい。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>上記例では、マッピングファイル内でエスケープ処理を行うメソッドを呼び出しているが、
Repositoryのメソッドを呼び出す前に、Serviceの処理としてエスケープ処理を行う方法もある。</p>
<p class="last">コンポーネントの役割としては、マッピングファイルでエスケープ処理を行う方が適切なため、
本ガイドラインとしては、マッピングファイル内でエスケープ処理を行う事を推奨する。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="sql-injection">
<span id="dataaccessmybatis3howtousesqlinjectioncountermeasure"></span><h3><a class="toc-backref" href="#id141">6.2.2.12. SQL Injection対策</a><a class="headerlink" href="#sql-injection" title="Permalink to this headline">¶</a></h3>
<p>SQLを組み立てる際は、SQL Injectionが発生しないように注意する必要がある。</p>
<p>MyBatis3では、SQLに値を埋め込む仕組みとして、以下の2つの方法を提供している。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="22%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">方法</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>バインド変数を使用して埋め込む</td>
<td><p class="first">この方法を使用すると、 SQL組み立て後に<code class="docutils literal"><span class="pre">java.sql.PreparedStatement</span></code> を使用して値が埋め込められるため、
<strong>安全に値を埋め込むことができる。</strong></p>
<p class="last"><strong>ユーザからの入力値をSQLに埋め込む場合は、原則バインド変数を使用すること。</strong></p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>置換変数を使用して埋め込む</td>
<td>この方法を使用すると、SQLを組み立てるタイミングで文字列として置換されてしまうため、
<strong>安全な値の埋め込みは保証されない。</strong></td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>ユーザからの入力値を置換変数を使って埋め込むと、
SQL Injectionが発生する危険性が高くなることを意識すること。</p>
<p>ユーザからの入力値を置換変数を使って埋め込む必要がある場合は、
SQL Injectionが発生しないことを保障するために、かならず入力チェックを行うこと。</p>
<p class="last">基本的には、 <strong>ユーザからの入力値はそのまま使わないことを強く推奨する。</strong></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="id45">
<h4><a class="toc-backref" href="#id142">6.2.2.12.1. バインド変数を使って埋め込む方法</a><a class="headerlink" href="#id45" title="Permalink to this headline">¶</a></h4>
<p>バインド変数の使用例を以下に示す。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;create&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    INSERT INTO
        t_todo
    (
        todo_id,
        todo_title,
        finished,
        created_at,
        version
    )
    VALUES
    (
        /* (1) */
        #{todoId},
        #{todoTitle},
        #{finished},
        #{createdAt},
        #{version}
    )
<span class="nt">&lt;/insert&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>バインドする値が格納されているプロパティのプロパティ名を、
<code class="docutils literal"><span class="pre">#{</span></code> と”<code class="docutils literal"><span class="pre">}</span></code> “で囲み、バインド変数として指定する。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>バインド変数には、いくつかの属性を指定する事が出来る。</p>
<p>指定できる属性としては、</p>
<ul class="simple">
<li>javaType</li>
<li>jdbcType</li>
<li>typeHandler</li>
<li>numericScale</li>
<li>mode</li>
<li>resultMap</li>
<li>jdbcTypeName</li>
</ul>
<p>がある。</p>
<p>基本的には、単純にプロパティ名を指定するだけで、MyBatisが適切な振る舞いを選択してくれる。
上記属性は、MyBatisが適切な振る舞いを選択してくれない時に指定すればよい。</p>
<p class="last">属性の使い方については、
「<a class="reference external" href="https://mybatis.org/mybatis-3/sqlmap-xml.html#Parameters">MyBatis3 REFERENCE DOCUMENTATION(Mapper XML Files-Parameters-)</a> 」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id46">
<h4><a class="toc-backref" href="#id143">6.2.2.12.2. 置換変数を使って埋め込む方法</a><a class="headerlink" href="#id46" title="Permalink to this headline">¶</a></h4>
<p>置換変数の使用例を以下に示す。</p>
<ul class="simple">
<li>Repositoryインタフェースにメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="p">{</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">findAllByCriteria</span><span class="p">(</span><span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;criteria&quot;</span><span class="p">)</span> <span class="n">TodoCriteria</span> <span class="n">criteria</span><span class="p">,</span>
                                 <span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;direction&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">direction</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>マッピングファイルにSQLを実装する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAllByCriteria&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;TodoCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;bind</span> <span class="na">name=</span><span class="s">&quot;todoTitleContainingCondition&quot;</span>
          <span class="na">value=</span><span class="s">&quot;@org.terasoluna.gfw.common.query.QueryEscapeUtils@toContainingCondition(criteria.todoTitle)&quot;</span> <span class="nt">/&gt;</span>
    SELECT
        todo_id,
        todo_title,
        finished,
        created_at,
        version
    FROM
        t_todo
    WHERE
        todo_title LIKE #{todoTitleContainingCondition} ESCAPE &#39;~&#39;
    ORDER BY
        /* (1) */
        todo_id ${direction}
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>置換する値が格納されているプロパティのプロパティ名を<code class="docutils literal"><span class="pre">${</span></code> と
“<code class="docutils literal"><span class="pre">}</span></code> “で囲み、置換変数として指定する。上記例では、<code class="docutils literal"><span class="pre">${direction}</span></code> の部分は、<code class="docutils literal"><span class="pre">DESC</span></code> または<code class="docutils literal"><span class="pre">ASC</span></code> で置換される。</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>置換変数による埋め込みは、必ずアプリケーションとして安全な値であることを担保した上で、</strong>
<strong>テーブル名、カラム名、ソート条件などに限定して使用することを推奨する。</strong></p>
<p>例えば以下のように、コード値とSQLに埋め込むための値のペアを<code class="docutils literal"><span class="pre">Map</span></code>に格納しておき、</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">directionMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">directionMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">,</span> <span class="s">&quot;ASC&quot;</span><span class="p">);</span>
<span class="n">directionMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;2&quot;</span><span class="p">,</span> <span class="s">&quot;DESC&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
<p>入力値はコード値として扱い、SQLを実行する処理の中で安全な値に変換することが望ましい。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">direction</span> <span class="o">=</span> <span class="n">directionMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">directionCode</span><span class="p">);</span>
<span class="n">todoRepository</span><span class="p">.</span><span class="na">findAllByCriteria</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
<p>上記例では<code class="docutils literal"><span class="pre">Map</span></code>を使用しているが、
共通ライブラリから提供している「<a class="reference internal" href="../WebApplicationDetail/Codelist.html"><span class="doc">コードリスト</span></a> 」を使用しても良い。
「<a class="reference internal" href="../WebApplicationDetail/Codelist.html"><span class="doc">コードリスト</span></a> 」を使用すると、入力チェックと連動する事ができるため、
より安全に値の埋め込みを行う事ができる。</p>
<ul>
<li><p class="first"><code class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/spring/projectName-codelist.xml</span></code></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xmlns:util=</span><span class="s">&quot;http://www.springframework.org/schema/util&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;</span>
<span class="s">        http://www.springframework.org/schema/beans https://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">        http://www.springframework.org/schema/util https://www.springframework.org/schema/util/spring-util.xsd</span>
<span class="s">    &quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;CL_DIRECTION&quot;</span> <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.common.codelist.SimpleMapCodeList&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;map&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;util:map&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;1&quot;</span> <span class="na">value=</span><span class="s">&quot;ASC&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;2&quot;</span> <span class="na">value=</span><span class="s">&quot;DESC&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/util:map&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
</li>
</ul>
<ul class="last">
<li><p class="first">Serviceクラス</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="nd">@Named</span><span class="p">(</span><span class="s">&quot;CL_DIRECTION&quot;</span><span class="p">)</span>
<span class="n">CodeList</span> <span class="n">directionCodeList</span><span class="p">;</span>

<span class="c1">// ...</span>

<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">searchTodos</span><span class="p">(</span><span class="n">TodoCriteria</span> <span class="n">criteria</span><span class="p">,</span> <span class="n">String</span> <span class="n">directionCode</span><span class="p">){</span>
    <span class="n">String</span> <span class="n">direction</span> <span class="o">=</span> <span class="n">directionCodeList</span><span class="p">.</span><span class="na">asMap</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">directionCode</span><span class="p">);</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="p">.</span><span class="na">findAllByCriteria</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">todos</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-extend">
<span id="dataaccessmybatis3howtoextend"></span><h2><a class="toc-backref" href="#id144">6.2.3. How to extend</a><a class="headerlink" href="#how-to-extend" title="Permalink to this headline">¶</a></h2>
<div class="section" id="dataaccessmybatis3howtoextendsqlshare">
<span id="id47"></span><h3><a class="toc-backref" href="#id145">6.2.3.1. SQL文の共有</a><a class="headerlink" href="#dataaccessmybatis3howtoextendsqlshare" title="Permalink to this headline">¶</a></h3>
<p>SQL文を複数のSQLで共有する方法について、説明を行う。</p>
<p>MyBatis3では、 <code class="docutils literal"><span class="pre">sql</span></code>要素と<code class="docutils literal"><span class="pre">include</span></code>要素を使用することで、
SQL文(又はSQL文の一部)を共有する事ができる。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>SQL文の共有化の使用例</strong></p>
<p class="last">ページネーション検索を実現する場合は、「検索条件に一致するEntityの総件数を取得するSQL」と
「 検索条件に一致するEntityのリストを取得するSQL」のWHERE句は共有した方がよい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>マッピングファイルの実装例は以下の通り。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="hll"><span class="c">&lt;!-- (1)  --&gt;</span>
</span><span class="hll"><span class="nt">&lt;sql</span> <span class="na">id=</span><span class="s">&quot;findPageByCriteriaWherePhrase&quot;</span><span class="nt">&gt;</span>
</span>    <span class="cp">&lt;![CDATA[</span>
<span class="cp">    WHERE</span>
<span class="cp">        todo_title LIKE #{title} || &#39;%&#39; ESCAPE &#39;~&#39;</span>
<span class="cp">    AND</span>
<span class="cp">        created_at &lt; #{createdAt}</span>
<span class="cp">    ]]&gt;</span>
<span class="nt">&lt;/sql&gt;</span>

<span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;countByCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;_long&quot;</span><span class="nt">&gt;</span>
    SELECT
        COUNT(*)
    FROM
        t_todo
<span class="hll">    <span class="c">&lt;!-- (2)  --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">&quot;findPageByCriteriaWherePhrase&quot;</span><span class="nt">/&gt;</span>
</span><span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findPageByCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    SELECT
        todo_id,
        todo_title,
        finished,
        created_at,
        version
    FROM
        t_todo
<span class="hll">    <span class="c">&lt;!-- (2)  --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">&quot;findPageByCriteriaWherePhrase&quot;</span><span class="nt">/&gt;</span>
</span>    ORDER BY
        todo_id
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">sql</span></code>要素の中に、複数のSQLで共有するSQL文を実装する。</p>
<p class="last"><code class="docutils literal"><span class="pre">id</span></code>属性には、マッピングファイル内でユニークとなるIDを指定する。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">include</span></code>要素を使用して、インクルードするSQLを指定する。</p>
<p class="last"><code class="docutils literal"><span class="pre">refid</span></code>属性には、インクルードするSQLのID(<code class="docutils literal"><span class="pre">sql</span></code>要素の<code class="docutils literal"><span class="pre">id</span></code>属性に指定した値)を指定する。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtoextendtypehandler">
<span id="id48"></span><h3><a class="toc-backref" href="#id146">6.2.3.2. TypeHandlerの実装</a><a class="headerlink" href="#dataaccessmybatis3howtoextendtypehandler" title="Permalink to this headline">¶</a></h3>
<p>MyBatis3の標準でサポートされていないJoda-Timeのクラスとのマッピングが必要の場合、
独自の<code class="docutils literal"><span class="pre">TypeHandler</span></code> の作成が必要となる。</p>
<p>本ガイドラインでは「<a class="reference internal" href="#dataaccessmybatis3howtoextendtypehandlerjoda"><span class="std std-ref">Joda-Time用のTypeHandlerの実装</span></a>」を例に、<code class="docutils literal"><span class="pre">TypeHandler</span></code> の実装方法について説明する。</p>
<p>作成した<code class="docutils literal"><span class="pre">TypeHandler</span></code> をアプリケーションに適用する方法については、
「<a class="reference internal" href="#dataaccessmybatis3howtousesettingstypehandler"><span class="std std-ref">TypeHandlerの設定</span></a>」を参照されたい。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>BLOB用とCLOB用の実装について</strong></p>
<p>MyBatis 3.4で追加された<code class="docutils literal"><span class="pre">TypeHandler</span></code> は、JDBC 4.0 (Java 1.6)で追加されたAPIを使用することで、BLOBと<code class="docutils literal"><span class="pre">java.io.InputStream</span></code> 、
CLOBと<code class="docutils literal"><span class="pre">java.io.Reader</span></code> の変換を実現している。JDBC 4.0サポートのJDBCドライバーであれば、BLOB⇔<code class="docutils literal"><span class="pre">InputStream</span></code> 、CLOB⇔<code class="docutils literal"><span class="pre">Reader</span></code> 変換用のタイプハンドラーがデフォルトで有効になるため、<code class="docutils literal"><span class="pre">TypeHandler</span></code> を新たに実装する必要はない。</p>
<p>JDBC 4.0との互換性のないJDBCドライバを使う場合は、利用するJDBCドライバの互換バージョンを意識した<code class="docutils literal"><span class="pre">TypeHandler</span></code> を作成する必要がある。</p>
<p class="last">例えば、PostgreSQL用のJDBCドライバ(<code class="docutils literal"><span class="pre">postgresql-42.2.9.jar</span></code>)では、JDBC 4.0から追加されたメソッドの一部が、未実装の状態である。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="joda-timetypehandler">
<span id="dataaccessmybatis3howtoextendtypehandlerjoda"></span><h4><a class="toc-backref" href="#id147">6.2.3.2.1. Joda-Time用のTypeHandlerの実装</a><a class="headerlink" href="#joda-timetypehandler" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">MyBatis3では、Joda-Timeのクラス(<code class="docutils literal"><span class="pre">org.joda.time.DateTime</span></code>、<code class="docutils literal"><span class="pre">org.joda.time.LocalDateTime</span></code>、<code class="docutils literal"><span class="pre">org.joda.time.LocalDate</span></code>など)はサポートされていない。</div>
<div class="line">そのため、EntityクラスのフィールドにJoda-Timeのクラスを使用する場合は、Joda-Time用の<code class="docutils literal"><span class="pre">TypeHandler</span></code> を用意する必要がある。</div>
</div>
<p><code class="docutils literal"><span class="pre">org.joda.time.DateTime</span></code>と<code class="docutils literal"><span class="pre">java.sql.Timestamp</span></code>をマッピングするための<code class="docutils literal"><span class="pre">TypeHandler</span></code> の実装例を、以下に示す。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Jada-Timeから提供されている他のクラス(<code class="docutils literal"><span class="pre">LocalDateTime</span></code>、<code class="docutils literal"><span class="pre">LocalDate</span></code>、<code class="docutils literal"><span class="pre">LocalTime</span></code>など)も同じ要領で実装すればよい。</p>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.infra.mybatis.typehandler</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.sql.CallableStatement</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.sql.PreparedStatement</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.sql.ResultSet</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.sql.SQLException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.sql.Timestamp</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.apache.ibatis.type.BaseTypeHandler</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.type.JdbcType</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.joda.time.DateTime</span><span class="p">;</span>

<span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DateTimeTypeHandler</span> <span class="kd">extends</span> <span class="n">BaseTypeHandler</span><span class="o">&lt;</span><span class="n">DateTime</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="c1">// (2)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setNonNullParameter</span><span class="p">(</span><span class="n">PreparedStatement</span> <span class="n">ps</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span>
            <span class="n">DateTime</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">JdbcType</span> <span class="n">jdbcType</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="p">{</span>
        <span class="n">ps</span><span class="p">.</span><span class="na">setTimestamp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="k">new</span> <span class="n">Timestamp</span><span class="p">(</span><span class="n">parameter</span><span class="p">.</span><span class="na">getMillis</span><span class="p">()));</span>
    <span class="p">}</span>

    <span class="c1">// (3)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">DateTime</span> <span class="nf">getNullableResult</span><span class="p">(</span><span class="n">ResultSet</span> <span class="n">rs</span><span class="p">,</span> <span class="n">String</span> <span class="n">columnName</span><span class="p">)</span>
            <span class="kd">throws</span> <span class="n">SQLException</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">toDateTime</span><span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="na">getTimestamp</span><span class="p">(</span><span class="n">columnName</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="c1">// (3)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">DateTime</span> <span class="nf">getNullableResult</span><span class="p">(</span><span class="n">ResultSet</span> <span class="n">rs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">columnIndex</span><span class="p">)</span>
            <span class="kd">throws</span> <span class="n">SQLException</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">toDateTime</span><span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="na">getTimestamp</span><span class="p">(</span><span class="n">columnIndex</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="c1">// (3)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">DateTime</span> <span class="nf">getNullableResult</span><span class="p">(</span><span class="n">CallableStatement</span> <span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">columnIndex</span><span class="p">)</span>
            <span class="kd">throws</span> <span class="n">SQLException</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">toDateTime</span><span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="na">getTimestamp</span><span class="p">(</span><span class="n">columnIndex</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="n">DateTime</span> <span class="nf">toDateTime</span><span class="p">(</span><span class="n">Timestamp</span> <span class="n">timestamp</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// (4)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">timestamp</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">.</span><span class="na">getTime</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">MyBatis3から提供されている<code class="docutils literal"><span class="pre">BaseTypeHandler</span></code>を親クラスに指定する。</p>
<p class="last">その際、<code class="docutils literal"><span class="pre">BaseTypeHandler</span></code>のジェネリック型には、<code class="docutils literal"><span class="pre">DateTime</span></code>を指定する。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">DateTime</span></code>を<code class="docutils literal"><span class="pre">Timestamp</span></code>に変換し、<code class="docutils literal"><span class="pre">PreparedStatement</span></code>に設定する処理を実装する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">ResultSet</span></code>又は<code class="docutils literal"><span class="pre">CallableStatement</span></code>から取得した<code class="docutils literal"><span class="pre">Timestamp</span></code>を<code class="docutils literal"><span class="pre">DateTime</span></code>に変換し、返り値として返却する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">null</span></code>を許可するカラムの場合、<code class="docutils literal"><span class="pre">Timestamp</span></code>が<code class="docutils literal"><span class="pre">null</span></code>になる可能性があるため、
<code class="docutils literal"><span class="pre">null</span></code>チェックを行ってから<code class="docutils literal"><span class="pre">DateTime</span></code>に変換する必要がある。</p>
<p class="last">上記実装例では、3つのメソッドで同じ処理が必要になるため、privateメソッドを作成している。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="resulthandler">
<span id="dataaccessmybatis3howtoextendresulthandler"></span><h3><a class="toc-backref" href="#id148">6.2.3.3. ResultHandlerの実装</a><a class="headerlink" href="#resulthandler" title="Permalink to this headline">¶</a></h3>
<p>MyBatis3では、検索結果を1件単位で処理する仕組みを提供している。</p>
<p>この仕組みを利用すると、</p>
<ul class="simple">
<li>DBより取得した値をJavaの処理で加工する</li>
<li>DBより取得した値などをJavaの処理として集計する</li>
</ul>
<p>といった処理を行う際に、同時に消費するメモリの容量を最小限に抑える事ができる。</p>
<p>例えば、検索結果をCSV形式のデータとしてダウンロードするような処理を実装する場合は、
検索結果を1件単位で処理する仕組みを使用するとよい。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>検索結果が大量になる可能性があり、且つJavaの処理で検索結果を1件ずつ処理する必要がある場合は、</strong>
<strong>この仕組みを使用することを強く推奨する。</strong></p>
<p>検索結果を1件単位で処理する仕組みを使用しない場合、
検索結果の全データ「1データのサイズ * 検索結果件数」をメモリ上に同時に確保することになり、
全てのデータに対して処理が終了するまでGC候補になることはない。</p>
<p>一方、検索結果を1件単位で処理する仕組みを使用した場合、
基本的には「1データのサイズ」をメモリ上に確保するだけであり、
1データの処理を終えた時点でGC候補となる。</p>
<p>例えば「1データのサイズ」が<code class="docutils literal"><span class="pre">2KB</span></code>で「検索結果件数」が<code class="docutils literal"><span class="pre">10,000</span></code>件だった場合、</p>
<ul class="simple">
<li>まとめて処理を行う場合は、<code class="docutils literal"><span class="pre">20MB</span></code>のメモリ</li>
<li>1件単位で処理を行う場合は、<code class="docutils literal"><span class="pre">2KB</span></code>のメモリ</li>
</ul>
<p>が同時に消費される。シングルスレッドで動くアプリケーションであれば問題になる事はないが、
Webアプリケーションの様なマルチスレッドで動くアプリケーションの場合は、問題になる事がある。</p>
<p>仮に100スレッドで同時に処理を行った場合、</p>
<ul class="simple">
<li>まとめて処理を行う場合は、<code class="docutils literal"><span class="pre">2GB</span></code>のメモリ</li>
<li>1件単位で処理を行う場合は、<code class="docutils literal"><span class="pre">200KB</span></code>のメモリ</li>
</ul>
<p>が同時に消費される。</p>
<p>結果として、</p>
<ul class="simple">
<li>まとめて処理を行う場合は、ヒープの最大サイズの指定によっては、メモリ枯渇によるシステムダウンやフルGCの頻発による性能劣化などが起こる可能性が高まる。</li>
<li>1件単位で処理を行う場合は、メモリ枯渇やコストの高いGC処理が発生する可能性を抑える事ができる。</li>
</ul>
<p class="last">上記に挙げた数字は目安であり、実際の計測値ではないという点を補足しておく。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>以下に、検索結果をCSV形式のデータとしてダウンロードする処理の実装例を示す。</p>
<ul class="simple">
<li>Repositoryインタフェースにメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="p">{</span>

    <span class="c1">// (1) (2)</span>
    <span class="kt">void</span> <span class="nf">collectAllByCriteria</span><span class="p">(</span><span class="n">TodoCriteria</span> <span class="n">criteria</span><span class="p">,</span> <span class="n">ResultHandler</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">resultHandler</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>メソッドの引数として、  <code class="docutils literal"><span class="pre">org.apache.ibatis.session.ResultHandler</span></code>を指定する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">メソッドの返り値は、<code class="docutils literal"><span class="pre">void</span></code>型を指定する。</p>
<p class="last"><code class="docutils literal"><span class="pre">void</span></code>以外を指定すると、<code class="docutils literal"><span class="pre">ResultHandler</span></code>が呼び出されなくなるので、注意すること。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>マッピングファイルにSQLを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;collectAllByCriteria&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;TodoCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    SELECT
        todo_id,
        todo_title,
        finished,
        created_at,
        version
    FROM
        t_todo
    <span class="nt">&lt;where&gt;</span>
        <span class="nt">&lt;if</span> <span class="na">test=</span><span class="s">&quot;title != null&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;bind</span> <span class="na">name=</span><span class="s">&quot;titleContainingCondition&quot;</span>
                  <span class="na">value=</span><span class="s">&quot;@org.terasoluna.gfw.common.query.QueryEscapeUtils@toContainingCondition(title)&quot;</span> <span class="nt">/&gt;</span>
            todo_title LIKE #{titleContainingCondition} ESCAPE &#39;~&#39;
        <span class="nt">&lt;/if&gt;</span>
        <span class="nt">&lt;if</span> <span class="na">test=</span><span class="s">&quot;createdAt != null&quot;</span><span class="nt">&gt;</span>
            <span class="cp">&lt;![CDATA[</span>
<span class="cp">            AND created_at &lt; #{createdAt}</span>
<span class="cp">            ]]&gt;</span>
        <span class="nt">&lt;/if&gt;</span>
    <span class="nt">&lt;/where&gt;</span>
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>マッピングファイルの実装は、通常の検索処理と同じである。</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>fetchSize属性の指定について</strong></p>
<p class="last">大量のデータを返すようなクエリを記述する場合には、<code class="docutils literal"><span class="pre">fetchSize</span></code>属性に適切な値を設定すること。
<code class="docutils literal"><span class="pre">fetchSize</span></code>は、JDBCドライバとデータベース間の１回の通信で取得するデータの件数を設定するパラメータである。
なお、MyBatis 3.3.0以降のバージョンでは、MyBatis設定ファイルに「デフォルトの<code class="docutils literal"><span class="pre">fetchSize</span></code>」を指定することができる。
<code class="docutils literal"><span class="pre">fetchSize</span></code>の詳細は「<a class="reference internal" href="#dataaccessmybatis3howtousesettingsdefaultfetchsize"><span class="std std-ref">fetchSizeの設定</span></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>ServiceクラスにRepositoryをDIし、Repositoryインターフェースのメソッドを呼び出す。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">DateTimeFormatter</span> <span class="n">DATE_FORMATTER</span> <span class="o">=</span>
        <span class="n">DateTimeFormat</span><span class="p">.</span><span class="na">forPattern</span><span class="p">(</span><span class="s">&quot;yyyy/MM/dd&quot;</span><span class="p">);</span>

    <span class="nd">@Inject</span>
    <span class="n">TodoRepository</span> <span class="n">todoRepository</span><span class="p">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">downloadTodos</span><span class="p">(</span><span class="n">TodoCriteria</span> <span class="n">criteria</span><span class="p">,</span>
        <span class="kd">final</span> <span class="n">BufferedWriter</span> <span class="n">downloadWriter</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// (4)</span>
        <span class="n">ResultHandler</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResultHandler</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleResult</span><span class="p">(</span><span class="n">ResultContext</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Todo</span><span class="o">&gt;</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="na">getResultObject</span><span class="p">();</span>
                <span class="n">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">();</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="n">sb</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">todo</span><span class="p">.</span><span class="na">getTodoId</span><span class="p">());</span>
                    <span class="n">sb</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">);</span>
                    <span class="n">sb</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">todo</span><span class="p">.</span><span class="na">getTodoTitle</span><span class="p">());</span>
                    <span class="n">sb</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">);</span>
                    <span class="n">sb</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">todo</span><span class="p">.</span><span class="na">isFinished</span><span class="p">());</span>
                    <span class="n">sb</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">);</span>
                    <span class="n">sb</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">DATE_FORMATTER</span><span class="p">.</span><span class="na">print</span><span class="p">(</span><span class="n">todo</span><span class="p">.</span><span class="na">getCreatedAt</span><span class="p">().</span><span class="na">getTime</span><span class="p">()));</span>
                    <span class="n">downloadWriter</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">sb</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span>
                    <span class="n">downloadWriter</span><span class="p">.</span><span class="na">newLine</span><span class="p">();</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">SystemException</span><span class="p">(</span><span class="s">&quot;e.xx.fw.9001&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span>

        <span class="c1">// (5)</span>
        <span class="n">todoRepository</span><span class="p">.</span><span class="na">collectAllByCriteria</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="n">handler</span><span class="p">);</span>

    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">ResultHandler</span></code>のインスタンスを生成する。</p>
<p><code class="docutils literal"><span class="pre">ResultHandler</span></code>の<code class="docutils literal"><span class="pre">handleResult</span></code>メソッドの中に、1件毎に行う処理を実装する。</p>
<p class="last">上記例では、<code class="docutils literal"><span class="pre">ResultHandler</span></code>の実装クラスは作らず、無名オブジェクトとして<code class="docutils literal"><span class="pre">ResultHandler</span></code>の実装を行っている。
実装クラスを作成してもよいが、複数の処理で共有する必要がない場合は、無理に実装クラスを作成する必要はない。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><p class="first">Repositoryインタフェースのメソッドを呼び出す。</p>
<p>メソッドを呼び出す際に、(4)で生成した<code class="docutils literal"><span class="pre">ResultHandler</span></code>のインスタンスを引数に指定する。</p>
<p><code class="docutils literal"><span class="pre">ResultHandler</span></code>を使用した場合、MyBatisは以下の処理を検索結果の件数分繰り返す。</p>
<ul class="last simple">
<li>検索結果からレコードを取得し、JavaBeanにマッピングを行う。</li>
<li><code class="docutils literal"><span class="pre">ResultHandler</span></code>インスタンスの<code class="docutils literal"><span class="pre">handleResult(ResultContext)</span></code>メソッドを呼び出す。</li>
</ul>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>ResultHandler使用時の注意点</strong></p>
<p><code class="docutils literal"><span class="pre">ResultHandler</span></code>を使用する場合、以下の２点に注意すること。</p>
<ul class="last simple">
<li>MyBatis3では、検索処理の性能向上させる仕組みとして、検索結果をローカルキャッシュ及びグローバルな2次キャッシュに保存する仕組みを提供しているが、<code class="docutils literal"><span class="pre">ResultHandler</span></code>を引数に取るメソッドから返されるデータはキャッシュされない。</li>
<li>手動マッピングを使用して複数行のデータを一つのJavaオブジェクトにマッピングするステートメントに対して<code class="docutils literal"><span class="pre">ResultHandler</span></code>を使用した場合、不完全な状態(関連Entityのオブジェクトがマッピングされる前の状態)のオブジェクトが渡されるケースがある。</li>
</ul>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>ResultContextのメソッドについて</strong></p>
<p><code class="docutils literal"><span class="pre">ResultHandler#handleResult</span></code>メソッドの引数である<code class="docutils literal"><span class="pre">ResultContext</span></code>には、以下のメソッドが用意されている。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="17%" />
<col width="72%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">メソッド</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>getResultObject</td>
<td>検索結果がマッピングされたオブジェクトを取得するためのメソッド。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>getResultCount</td>
<td><code class="docutils literal"><span class="pre">ResultHandler#handleResult</span></code>メソッドの呼び出し回数を取得するためのメソッド。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>stop</td>
<td>以降のレコードに対する処理を中止するようにMyBatis側に通知するためのメソッド。
このメソッドは、以降のレコードを全て破棄したい場合に使用するとよい。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p class="last"><code class="docutils literal"><span class="pre">ResultContext</span></code>には<code class="docutils literal"><span class="pre">isStopped</span></code>というメソッドもあるが、これはMyBatis側が使用するメソッドなので、説明は割愛する。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtoextendexecutortype">
<span id="id49"></span><h3><a class="toc-backref" href="#id149">6.2.3.4. SQL実行モードの利用</a><a class="headerlink" href="#dataaccessmybatis3howtoextendexecutortype" title="Permalink to this headline">¶</a></h3>
<p>MyBatis3では、SQLを実行するモードとして以下の3種類を用意しており、デフォルトは<code class="docutils literal"><span class="pre">SIMPLE</span></code>である。</p>
<p>ここでは、</p>
<ul class="simple">
<li>実行モードの使用方法</li>
<li>バッチモードのRepository利用時の注意点</li>
</ul>
<div class="line-block">
<div class="line">について説明を行う。</div>
<div class="line">実行モードの説明については、「<a class="reference internal" href="#dataaccessmybatis3howtousesettingsexecutortype"><span class="std std-ref">SQL実行モードの設定</span></a>」を参照されたい。</div>
</div>
<div class="section" id="preparedstatement">
<span id="dataaccessmybatis3howtoextendexecutortypereuse"></span><h4><a class="toc-backref" href="#id150">6.2.3.4.1. PreparedStatement再利用モードの利用</a><a class="headerlink" href="#preparedstatement" title="Permalink to this headline">¶</a></h4>
<p>実行モードを<code class="docutils literal"><span class="pre">SIMPLE</span></code>から<code class="docutils literal"><span class="pre">REUSE</span></code>に変更した場合、MyBatis内部の<code class="docutils literal"><span class="pre">PreparedStatement</span></code>の扱い方は変わるが、
MyBatisの動作(使い方)は変わらない。</p>
<p>実行モードをデフォルト(<code class="docutils literal"><span class="pre">SIMPLE</span></code>)から<code class="docutils literal"><span class="pre">REUSE</span></code>に変更する方法を、以下に示す。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/mybatis/mybatis-config.xml</span></code> に設定を追加する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE configuration</span>
<span class="cp">        PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span>
<span class="cp">        &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
    <span class="nt">&lt;settings&gt;</span>
        <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;setting</span> <span class="na">name=</span><span class="s">&quot;defaultExecutorType&quot;</span> <span class="na">value=</span><span class="s">&quot;REUSE&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/settings&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">defaultExecutorType</span></code>に<code class="docutils literal"><span class="pre">REUSE</span></code>に変更する。</p>
<p class="last">上記設定を行うと、デフォルト動作がPreparedStatement再利用モードになる。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtoextendexecutortypebatch">
<span id="id50"></span><h4><a class="toc-backref" href="#id151">6.2.3.4.2. バッチモードの利用</a><a class="headerlink" href="#dataaccessmybatis3howtoextendexecutortypebatch" title="Permalink to this headline">¶</a></h4>
<p>Mapperインタフェースの更新系メソッドの呼び出しを、全てバッチモードで実行する場合は、
「<a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypereuse"><span class="std std-ref">PreparedStatement再利用モードの利用</span></a>」と同じ方法で、
実行モードを<code class="docutils literal"><span class="pre">BATCH</span></code>モードに変更すればよい。</p>
<p>ただし、バッチモードはいくつかの制約事項があるため、
実際のアプリケーション開発では<code class="docutils literal"><span class="pre">SIMPLE</span></code>又は<code class="docutils literal"><span class="pre">REUSE</span></code>モードと共存して使用するケースが想定される。</p>
<p>例えば、</p>
<ul class="simple">
<li>大量のデータ更新を伴い性能要件を充たす事が最優先される処理では、バッチモードを使用する。</li>
<li>楽観ロックの制御などデータの一貫性を保つために更新結果の判定が必要な処理では、<code class="docutils literal"><span class="pre">SIMPLE</span></code>又は<code class="docutils literal"><span class="pre">REUSE</span></code>モードを使用する。</li>
</ul>
<p>等の使い分けを行う場合である。</p>
<blockquote>
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>実行モードを共存して使用する際の注意点</strong></p>
<p>アプリケーション内で複数の実行モードを使用する場合は、
<strong>同一トランザクション内で実行モードを切り替える事が出来ないという点に注意すること。</strong></p>
<p>仮に同一トランザクション内で複数の実行モードを使用した場合は、MyBatisが矛盾を検知しエラーとなる。</p>
<p>これは、同一トランザクション内の処理において、</p>
<ul class="simple">
<li>XxxRepositoryのメソッド呼び出しは<code class="docutils literal"><span class="pre">BATCH</span></code>モードで実行する</li>
<li>YyyRepositoryのメソッド呼び出しは<code class="docutils literal"><span class="pre">REUSE</span></code>モードで実行する</li>
</ul>
<p>といった事が出来ないという事を意味する。</p>
<p>本ガイドラインをベースに作成するアプリケーションのトランザクション境界は、
Service又はRepositoryとなる。
そのため、<strong>アプリケーション内で複数の実行モードを使用する場合は、</strong>
<strong>ServiceやRepositoryの設計を行う際に、実行モードを意識する必要がある。</strong></p>
<p class="last">トランザクションを分離させたい場合は、ServiceやRepositoryのメソッドアノテーションとして、
<code class="docutils literal"><span class="pre">&#64;Transactional(propagation</span> <span class="pre">=</span> <span class="pre">Propagation.REQUIRES_NEW)</span></code>を指定する事で実現する事ができる。
トランザクション管理の詳細については、「<a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html#service-transaction-management"><span class="std std-ref">トランザクション管理について</span></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>以降では、</p>
<ul class="simple">
<li>複数の実行モードを共存させるための設定方法</li>
<li>アプリケーションの実装例</li>
</ul>
<p>について説明を行う。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="dataaccessmybatis3howtoextendexecutortypebatchindividualsetting">
<span id="id51"></span><h5>6.2.3.4.2.1. 個別にバッチモードのRepositoryを作成するための設定<a class="headerlink" href="#dataaccessmybatis3howtoextendexecutortypebatchindividualsetting" title="Permalink to this headline">¶</a></h5>
<p>特定のRepositoryに対してバッチモードのRepositoryを作成したい場合は、
MyBatis-Springから提供されている<code class="docutils literal"><span class="pre">org.mybatis.spring.mapper.MapperFactoryBean</span></code>を使用して、
RepositoryのBean定義を行えばよい。</p>
<p>下記の設定例では、</p>
<ul class="simple">
<li>通常使用するRepositoryとして<code class="docutils literal"><span class="pre">REUSE</span></code>モードのRepository</li>
<li>特定のRepositoryに対して<code class="docutils literal"><span class="pre">BATCH</span></code>モードのRepository</li>
</ul>
<p>をBean登録している。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/spring/projectName-infra.xml</span></code> にBean定義を追加する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
       <span class="na">xmlns:mybatis=</span><span class="s">&quot;http://mybatis.org/schema/mybatis-spring&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;</span>
<span class="s">       http://www.springframework.org/schema/beans</span>
<span class="s">       https://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">       http://www.springframework.org/schema/context</span>
<span class="s">       https://www.springframework.org/schema/context/spring-context.xsd</span>
<span class="s">       http://mybatis.org/schema/mybatis-spring</span>
<span class="s">       http://mybatis.org/schema/mybatis-spring.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sqlSessionFactory&quot;</span>
          <span class="na">class=</span><span class="s">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;configLocation&quot;</span>
                  <span class="na">value=</span><span class="s">&quot;classpath:META-INF/mybatis/mybatis-config.xml&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sqlSessionTemplate&quot;</span>
          <span class="na">class=</span><span class="s">&quot;org.mybatis.spring.SqlSessionTemplate&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">ref=</span><span class="s">&quot;sqlSessionFactory&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span> <span class="na">value=</span><span class="s">&quot;REUSE&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;mybatis:scan</span> <span class="na">base-package=</span><span class="s">&quot;com.example.domain.repository&quot;</span>
                  <span class="na">template-ref=</span><span class="s">&quot;sqlSessionTemplate&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>

    <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;batchSqlSessionTemplate&quot;</span>
          <span class="na">class=</span><span class="s">&quot;org.mybatis.spring.SqlSessionTemplate&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">ref=</span><span class="s">&quot;sqlSessionFactory&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span> <span class="na">value=</span><span class="s">&quot;BATCH&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!-- (4) --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;todoBatchRepository&quot;</span>
          <span class="na">class=</span><span class="s">&quot;org.mybatis.spring.mapper.MapperFactoryBean&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- (5) --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;mapperInterface&quot;</span>
                  <span class="na">value=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!-- (6) --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;sqlSessionTemplate&quot;</span> <span class="na">ref=</span><span class="s">&quot;batchSqlSessionTemplate&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>通常使用するRepositoryで利用するための<code class="docutils literal"><span class="pre">SqlSessionTemplate</span></code>をBean定義する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">通常使用するRepositoryをスキャンしBean登録する。</p>
<p class="last"><code class="docutils literal"><span class="pre">template-ref</span></code>属性に、(1)で定義した<code class="docutils literal"><span class="pre">SqlSessionTemplate</span></code>を指定する。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>バッチモードのRepositoryで利用するための<code class="docutils literal"><span class="pre">SqlSessionTemplate</span></code>をBean定義する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p class="first">バッチモード用のRepositoryをBean定義する。</p>
<p><code class="docutils literal"><span class="pre">id</span></code>属性には、(2)でスキャンしたRepositoryのBean名と重複しない値を指定する。
(2)でスキャンされたRepositoryのBean名は、インタフェース名を「lowerCamelCase」にした値にとなる。</p>
<p class="last">上記例では、バッチモード用の<code class="docutils literal"><span class="pre">TodoRepository</span></code>が<code class="docutils literal"><span class="pre">todoBatchRepository</span></code>という名前のBeanでBean登録される。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">mapperInterface</span></code>プロパティには、
バッチモードを利用するRepositoryのインタフェース名(FQCN)を指定する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">sqlSessionTemplate</span></code>プロパティには、
(3)で定義したバッチモード用の<code class="docutils literal"><span class="pre">SqlSessionTemplate</span></code>を指定する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtoextendexecutortypebatchbulksetting">
<span id="id52"></span><h5>6.2.3.4.2.2. 一括でバッチモードのRepositoryを作成するための設定<a class="headerlink" href="#dataaccessmybatis3howtoextendexecutortypebatchbulksetting" title="Permalink to this headline">¶</a></h5>
<p>一括でバッチモードのRepositoryを作成したい場合は、
MyBatis-Springから提供されているスキャン機能(<code class="docutils literal"><span class="pre">mybatis:scan</span></code>要素)を使用して、
RepositoryのBean定義を行えばよい。</p>
<p>下記の設定例では、全てのRepositoryに対して、<code class="docutils literal"><span class="pre">REUSE</span></code>モードと<code class="docutils literal"><span class="pre">BATCH</span></code>モードのRepositoryをBean登録している。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">BeanNameGenerator</span></code>を作成する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.repository</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.config.BeanDefinition</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.support.BeanDefinitionRegistry</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.support.BeanNameGenerator</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.ClassUtils</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.beans.Introspector</span><span class="p">;</span>

<span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BachRepositoryBeanNameGenerator</span> <span class="kd">implements</span> <span class="n">BeanNameGenerator</span> <span class="p">{</span>
    <span class="c1">// (2)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">generateBeanName</span><span class="p">(</span><span class="n">BeanDefinition</span> <span class="n">definition</span><span class="p">,</span> <span class="n">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">defaultBeanName</span> <span class="o">=</span> <span class="n">Introspector</span><span class="p">.</span><span class="na">decapitalize</span><span class="p">(</span><span class="n">ClassUtils</span><span class="p">.</span><span class="na">getShortName</span><span class="p">(</span><span class="n">definition</span>
                <span class="p">.</span><span class="na">getBeanClassName</span><span class="p">()));</span>
        <span class="k">return</span> <span class="n">defaultBeanName</span><span class="p">.</span><span class="na">replaceAll</span><span class="p">(</span><span class="s">&quot;Repository&quot;</span><span class="p">,</span> <span class="s">&quot;BatchRepository&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">SpringのApplicationContextに登録するBean名を生成するクラスを作成する。</p>
<p class="last">このクラスは、通常使用する<code class="docutils literal"><span class="pre">REUSE</span></code>モードのRepositoryのBean名と、
<code class="docutils literal"><span class="pre">BATCH</span></code>モードのBean名が重複しないようにするために必要なクラスである。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">Bean名を生成するためのメソッドを実装する。</p>
<p class="last">上記例では、Bean名のsuffixを<code class="docutils literal"><span class="pre">BatchRepository</span></code>とする事で、
通常使用される<code class="docutils literal"><span class="pre">REUSE</span></code>モードのRepositoryのBean名と重複しないようにしている。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/spring/projectName-infra.xml</span></code> にBean定義を追加する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
       <span class="na">xmlns:mybatis=</span><span class="s">&quot;http://mybatis.org/schema/mybatis-spring&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;</span>
<span class="s">       http://www.springframework.org/schema/beans</span>
<span class="s">       https://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">       http://www.springframework.org/schema/context</span>
<span class="s">       https://www.springframework.org/schema/context/spring-context.xsd</span>
<span class="s">       http://mybatis.org/schema/mybatis-spring</span>
<span class="s">       http://mybatis.org/schema/mybatis-spring.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sqlSessionFactory&quot;</span>
          <span class="na">class=</span><span class="s">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;configLocation&quot;</span>
                  <span class="na">value=</span><span class="s">&quot;classpath:META-INF/mybatis/mybatis-config.xml&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!-- ... --&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;batchSqlSessionTemplate&quot;</span>
          <span class="na">class=</span><span class="s">&quot;org.mybatis.spring.SqlSessionTemplate&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">ref=</span><span class="s">&quot;sqlSessionFactory&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span> <span class="na">value=</span><span class="s">&quot;BATCH&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;mybatis:scan</span> <span class="na">base-package=</span><span class="s">&quot;com.example.domain.repository&quot;</span>
        <span class="na">template-ref=</span><span class="s">&quot;batchSqlSessionTemplate&quot;</span>
        <span class="na">name-generator=</span><span class="s">&quot;com.example.domain.repository.BatchRepositoryBeanNameGenerator&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="17%" />
<col width="72%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>-</td>
<td><code class="docutils literal"><span class="pre">mybatis:scan</span></code>要素を使用して、バッチモードのRepositoryをBean登録する。</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td>base-package</td>
<td><p class="first">Repositoryをスキャンするベースパッケージを指定する。</p>
<p class="last">指定パッケージの配下に存在するRepositoryインタフェースがスキャンされ、
SpringのApplicationContextにBean登録される。</p>
</td>
</tr>
<tr class="row-even"><td>&#160;</td>
<td>template-ref</td>
<td>バッチモード用の<code class="docutils literal"><span class="pre">SqlSessionTemplate</span></code>のBeanを指定する。</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td>name-generator</td>
<td><p class="first">スキャンしたRepositoryのBean名を生成するためのクラスを指定する。</p>
<p>具体的には、(1)で作成したクラスのクラス名(FQCN)を指定する。</p>
<p class="last">この指定を省略した場合、Bean名が重複するため、
バッチモードのRepositoryはSpringのApplicationContextに登録されない。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtoextendexecutortypebatchusage">
<span id="id53"></span><h5>6.2.3.4.2.3. バッチモードのRepositoryの使用例<a class="headerlink" href="#dataaccessmybatis3howtoextendexecutortypebatchusage" title="Permalink to this headline">¶</a></h5>
<p>以下に、バッチモードのRepositoryを使用してデータベースにアクセスするための実装例を示す。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Transactional</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="p">{</span>

    <span class="c1">// (1)</span>
    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="p">(</span><span class="s">&quot;todoBatchRepository&quot;</span><span class="p">)</span>
    <span class="n">TodoRepository</span> <span class="n">todoBatchRepository</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateTodos</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span> <span class="p">:</span> <span class="n">todos</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// (2)</span>
            <span class="n">todoBatchRepository</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>バッチモードのRepositoryをインジェクションする。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">バッチモードのRepositoryのメソッドを呼び出し、Entityの更新を行う。</p>
<p>バッチモードのRepositoryの場合は、メソッドを呼び出したタイミングでSQLが実行されないため、
メソッドから返却される更新結果は無視する必要がある。</p>
<p class="last">Entityを更新するためのSQLは、トランザクションがコミットされる直前にバッチ実行され、
エラーがなければコミットされる。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>バッチ実行のタイミングについて</strong></p>
<p>SQLがバッチ実行されるタイミングは、基本的には以下の場合である。</p>
<ul class="simple">
<li>トランザクションがコミットされる直前</li>
<li>クエリ(SELECT)を実行する直前</li>
</ul>
<p class="last">Repositoryのメソッドの呼び出し順番に関する注意点は、「<a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchnotesmethodcallorder"><span class="std std-ref">Repositoryのメソッドの呼び出し順番</span></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtoextendexecutortypebatchnotes">
<span id="id54"></span><h4><a class="toc-backref" href="#id152">6.2.3.4.3. バッチモードのRepository利用時の注意点</a><a class="headerlink" href="#dataaccessmybatis3howtoextendexecutortypebatchnotes" title="Permalink to this headline">¶</a></h4>
<p>バッチモードのRepositoryを利用する場合、Serviceクラスの実装として、
以下の点に注意する必要がある。</p>
<ul class="simple">
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchnotesupdateresult"><span class="std std-ref">更新結果の判定</span></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchnotesduplicate"><span class="std std-ref">一意制約違反の検知方法</span></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchnotesmethodcallorder"><span class="std std-ref">Repositoryのメソッドの呼び出し順番</span></a></li>
</ul>
<div class="section" id="dataaccessmybatis3howtoextendexecutortypebatchnotesupdateresult">
<span id="id55"></span><h5>6.2.3.4.3.1. 更新結果の判定<a class="headerlink" href="#dataaccessmybatis3howtoextendexecutortypebatchnotesupdateresult" title="Permalink to this headline">¶</a></h5>
<p>バッチモードのRepositoryを使用した場合、更新結果の妥当性をチェックする事ができない。</p>
<p>バッチモードを使用する場合、Mapperインタフェースのメソッドから返却される更新結果は、</p>
<ul class="simple">
<li>返り値が数値(<code class="docutils literal"><span class="pre">int</span></code>や<code class="docutils literal"><span class="pre">long</span></code>)の場合は、<a class="reference external" href="https://mybatis.org/mybatis-3/apidocs/reference/org/apache/ibatis/executor/BatchExecutor.html#BATCH_UPDATE_RETURN_VALUE">固定値</a>(<code class="docutils literal"><span class="pre">org.apache.ibatis.executor.BatchExecutor#BATCH_UPDATE_RETURN_VALUE</span></code>)</li>
<li>返り値が<code class="docutils literal"><span class="pre">boolean</span></code>の場合は、<code class="docutils literal"><span class="pre">false</span></code></li>
</ul>
<p>が返却される。</p>
<p>これは、Mapperインタフェースのメソッドを呼び出したタイミングではSQLが発行されず、
バッチ実行用にキューイング(<code class="docutils literal"><span class="pre">java.sql.Statement#addBatch()</span></code>)される仕組みになっているためである。</p>
<p>これは、以下の様な実装が出来ないことを意味している。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Transactional</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="p">(</span><span class="s">&quot;todoBatchRepository&quot;</span><span class="p">)</span>
    <span class="n">TodoRepository</span> <span class="n">todoBatchRepository</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateTodos</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span> <span class="p">:</span> <span class="n">todos</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">boolean</span> <span class="n">updateSuccess</span> <span class="o">=</span> <span class="n">todoBatchRepository</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span>
            <span class="c1">// (1)</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">updateSuccess</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// ...</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>上記例のように実装した場合、更新結果は常に<code class="docutils literal"><span class="pre">false</span></code>になるため、
必ず更新失敗時の処理が実行されてしまう。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>アプリケーションの要件によっては、バッチ実行した更新結果の妥当性をチェックすることが求められるケースも考えられる。
そのようなケースでは、Mapperインタフェースに「バッチ実行用にキューイングされているSQLを実行するためのメソッド」を用意すればよい。</p>
<p>MyBatis 3.2系では、<code class="docutils literal"><span class="pre">org.apache.ibatis.session.SqlSession</span></code>インタフェースの<code class="docutils literal"><span class="pre">flushStatements</span></code>メソッドを直接呼び出す必要があったが、
MyBatis 3.3.0以降のバージョンでは、Mapperインタフェースに<code class="docutils literal"><span class="pre">&#64;org.apache.ibatis.annotations.Flush</span></code>アノテーションを付与したメソッドを作成する方法がサポートされている。</p>
<blockquote>
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>バッチモード使用時のJDBCドライバが返却する更新結果について</strong></p>
<p><code class="docutils literal"><span class="pre">&#64;Flush</span></code>アノテーションを付与したメソッド(及び<code class="docutils literal"><span class="pre">SqlSession</span></code>インタフェースの<code class="docutils literal"><span class="pre">flushStatements</span></code>メソッド)を使用するとバッチ実行時の更新結果を受け取る事ができると前述したが、
JDBCドライバから返却される更新結果が「処理したレコード数」になる保証はない。</p>
<p class="last">これは、使用するJDBCドライバの実装に依存する部分なので、使用するJDBCドライバの仕様を確認しておく必要がある。</p>
</div>
</div></blockquote>
<p>以下に、<code class="docutils literal"><span class="pre">&#64;Flush</span></code>アノテーションを付与したメソッドの作成例と呼び出し例を示す。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nd">@Flush</span> <span class="c1">// (1)</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">BatchResult</span><span class="o">&gt;</span> <span class="nf">flush</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Transactional</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="p">(</span><span class="s">&quot;todoBatchRepository&quot;</span><span class="p">)</span>
    <span class="n">TodoRepository</span> <span class="n">todoBatchRepository</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateTodos</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span> <span class="p">:</span> <span class="n">todos</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">todoBatchRepository</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">BatchResult</span><span class="o">&gt;</span> <span class="n">updateResults</span> <span class="o">=</span> <span class="n">todoBatchRepository</span><span class="p">.</span><span class="na">flush</span><span class="p">();</span> <span class="c1">// (2)</span>

        <span class="c1">// Validate update results</span>
        <span class="c1">// ...</span>

    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">&#64;Flush</span></code>アノテーションを付与したメソッド（以降「<code class="docutils literal"><span class="pre">&#64;Flush</span></code>メソッド」と呼ぶ）を作成する。</p>
<p class="last">更新結果の判定が必要な場合は、返り値として<code class="docutils literal"><span class="pre">org.apache.ibatis.executor.BatchResult</span></code>のリスト型を指定する。
更新結果の判定が不要な場合(一意制約違反などのデータベースエラーのみをハンドリングしたい場合)は、返り値は<code class="docutils literal"><span class="pre">void</span></code>でよい。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">バッチ実行用にキューイングされているSQLを実行したいタイミングで、<code class="docutils literal"><span class="pre">&#64;Flush</span></code>メソッドを呼び出す。
<code class="docutils literal"><span class="pre">&#64;Flush</span></code>メソッドを呼び出すと、Mapperインタフェースに紐づく<code class="docutils literal"><span class="pre">SqlSession</span></code>オブジェクトの<code class="docutils literal"><span class="pre">flushStatements</span></code>メソッドが呼び出されて、
バッチ実行用にキューイングされているSQLが実行される。</p>
<p class="last">更新結果の判定が必要な場合は、<code class="docutils literal"><span class="pre">&#64;Flush</span></code>メソッドから返却される更新結果の妥当性チェックを行う。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtoextendexecutortypebatchnotesduplicate">
<span id="id57"></span><h5>6.2.3.4.3.2. 一意制約違反の検知方法<a class="headerlink" href="#dataaccessmybatis3howtoextendexecutortypebatchnotesduplicate" title="Permalink to this headline">¶</a></h5>
<p>バッチモードのRepositoryを使用した場合、
一意制約違反などのデータベースエラーをServiceの処理として検知する事が出来ないケースがある。</p>
<p>これは、Mapperインタフェースのメソッドを呼び出したタイミングではSQLが発行されず、
バッチ実行用にキューイング(<code class="docutils literal"><span class="pre">java.sql.Statement#addBatch()</span></code>)される仕組みになっているためであり、
以下の様な実装が出来ないことを意味している。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Transactional</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="p">(</span><span class="s">&quot;todoBatchRepository&quot;</span><span class="p">)</span>
    <span class="n">TodoRepository</span> <span class="n">todoBatchRepository</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">storeTodos</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span> <span class="p">:</span> <span class="n">todos</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="n">todoBatchRepository</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span>
            <span class="c1">// (1)</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">DuplicateKeyException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// ....</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">上記例のように実装した場合、
このタイミングで<code class="docutils literal"><span class="pre">org.springframework.dao.DuplicateKeyException</span></code>が発生することはないため、
<code class="docutils literal"><span class="pre">DuplicateKeyException</span></code>補足後の処理が実行される事はない。</p>
<p class="last">これは、SQLがバッチ実行されるタイミングが、
Serviceの処理が終わった後(トランザクションがコミットされる直前)に行われるためである。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>アプリケーションの要件によっては、バッチ実行時の一意制約違反を検知することが求められるケースも考えられる。
そのようなケースでは、Mapperインタフェースに「バッチ実行用にキューイングされているSQLを実行するためのメソッド(<code class="docutils literal"><span class="pre">&#64;Flush</span></code>メソッド)」を用意すればよい。
<code class="docutils literal"><span class="pre">&#64;Flush</span></code>メソッドの詳細は、前述の「<a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchnotesupdateresult"><span class="std std-ref">更新結果の判定</span></a>」を参照されたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtoextendexecutortypebatchnotesmethodcallorder">
<span id="id58"></span><h5>6.2.3.4.3.3. Repositoryのメソッドの呼び出し順番<a class="headerlink" href="#dataaccessmybatis3howtoextendexecutortypebatchnotesmethodcallorder" title="Permalink to this headline">¶</a></h5>
<p>バッチモードを使用する目的は更新処理の性能向上であるが、
Repositoryのメソッドの呼び出し順番を間違えると、性能向上につながらないケースがある。</p>
<p>バッチモードを使用して性能向上させるためには、以下のMyBatisの仕様を理解しておく必要がある。</p>
<ul class="simple">
<li>クエリ(SELECT)を実行すると、それまでキューイングされていたSQLがバッチ実行される。</li>
<li>連続して呼び出された更新処理(Repositoryのメソッド)毎に<code class="docutils literal"><span class="pre">PreparedStatement</span></code>が生成され、SQLをキューイングする。</li>
</ul>
<p>これは、以下の様な実装をすると、バッチモードを利用するメリットがない事を意味している。</p>
<ul class="simple">
<li>例１</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Transactional</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="p">(</span><span class="s">&quot;todoBatchRepository&quot;</span><span class="p">)</span>
    <span class="n">TodoRepository</span> <span class="n">todoBatchRepository</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">storeTodos</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span> <span class="p">:</span> <span class="n">todos</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// (1)</span>
            <span class="n">Todo</span> <span class="n">currentTodo</span> <span class="o">=</span> <span class="n">todoBatchRepository</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">todo</span><span class="p">.</span><span class="na">getTodoId</span><span class="p">());</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">currentTodo</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">todoBatchRepository</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span><span class="p">{</span>
                <span class="n">todoBatchRepository</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">上記例のように実装した場合、繰り返し処理の先頭にクエリを発行しているため、
1件毎にSQLがバッチ実行される事になってしまう。
これはほぼ、シンプルモード(<code class="docutils literal"><span class="pre">SIMPLE</span></code>)で実行しているのと同義である。</p>
<p class="last">上記のような処理が必要な場合は、
PreparedStatement再利用モード(<code class="docutils literal"><span class="pre">REUSE</span></code>)のRepositoryを使用した方が効率的である。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>例２</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Transactional</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="p">(</span><span class="s">&quot;todoBatchRepository&quot;</span><span class="p">)</span>
    <span class="n">TodoRepository</span> <span class="n">todoBatchRepository</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">storeTodos</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span> <span class="p">:</span> <span class="n">todos</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// (2)</span>
            <span class="n">todoBatchRepository</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span>
            <span class="n">todoBatchRepository</span><span class="p">.</span><span class="na">createHistory</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">上記のような処理が必要な場合は、Repositoryのメソッドが交互に呼び出されているため、
1件毎に<code class="docutils literal"><span class="pre">PreparedStatement</span></code>が生成されてしまう。
これはほぼ、シンプルモード(<code class="docutils literal"><span class="pre">SIMPLE</span></code>)で実行しているのと同義である。</p>
<p class="last">上記のような処理が必要な場合は、
PreparedStatement再利用モード(<code class="docutils literal"><span class="pre">REUSE</span></code>)のRepositoryを使用した方が効率的である。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtoextendstoredprocedure">
<span id="id59"></span><h3><a class="toc-backref" href="#id153">6.2.3.5. ストアドプロシージャの実装</a><a class="headerlink" href="#dataaccessmybatis3howtoextendstoredprocedure" title="Permalink to this headline">¶</a></h3>
<p>データベースに登録されているストアドプロシージャやファンクションを、
MyBatis3から呼び出す方法について説明を行う。</p>
<p>以下で説明する実装例では、PostgreSQLに登録されているファンクションを呼び出している。</p>
<ul class="simple">
<li>ストアドプロシージャ（ファンクション）を登録する。</li>
</ul>
<blockquote>
<div><div class="highlight-postgresql"><div class="highlight"><pre><span></span><span class="cm">/* (1) */</span>
<span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">findTodo</span><span class="p">(</span><span class="n">pTodoId</span> <span class="nb">CHAR</span><span class="p">)</span>
<span class="k">RETURNS</span> <span class="k">TABLE</span><span class="p">(</span>
    <span class="n">todo_id</span> <span class="nb">CHAR</span><span class="p">,</span>
    <span class="n">todo_title</span> <span class="nb">VARCHAR</span><span class="p">,</span>
    <span class="n">finished</span> <span class="nb">BOOLEAN</span><span class="p">,</span>
    <span class="n">created_at</span> <span class="nb">TIMESTAMP</span><span class="p">,</span>
    <span class="k">version</span> <span class="nb">BIGINT</span>
<span class="p">)</span> <span class="k">AS</span> <span class="s">$$</span> <span class="k">BEGIN</span> <span class="k">RETURN</span> <span class="k">QUERY</span>
<span class="k">SELECT</span>
    <span class="n">t</span><span class="mf">.</span><span class="n">todo_id</span><span class="p">,</span>
    <span class="n">t</span><span class="mf">.</span><span class="n">todo_title</span><span class="p">,</span>
    <span class="n">t</span><span class="mf">.</span><span class="n">finished</span><span class="p">,</span>
    <span class="n">t</span><span class="mf">.</span><span class="n">created_at</span><span class="p">,</span>
    <span class="n">t</span><span class="mf">.</span><span class="k">version</span>
<span class="k">FROM</span>
    <span class="n">t_todo</span> <span class="n">t</span>
<span class="k">WHERE</span>
    <span class="n">t</span><span class="mf">.</span><span class="n">todo_id</span> <span class="o">=</span> <span class="n">pTodoId</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="s">$$</span> <span class="k">LANGUAGE</span> <span class="n">plpgsql</span><span class="p">;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>このファンクションは、指定されたIDのレコードを取得するファンクションである。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Repositoryインタフェースにメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (2)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="kd">extends</span> <span class="n">Repository</span> <span class="p">{</span>
    <span class="n">Todo</span> <span class="nf">findOne</span><span class="p">(</span><span class="n">String</span> <span class="n">todoId</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>SQLを発行する際と同じインタフェースでよい。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>マッピングファイルにストアドプロシージャの呼び出し処理を実装する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot; &gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;string&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span>
            <span class="na">statementType=</span><span class="s">&quot;CALLABLE&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- (4) --&gt;</span>
        {call findTodo(#{todoId})}
    <span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first">ストアドプロシージャを呼び出すステートメントを実装する。</p>
<p>ストアドプロシージャを呼び出す場合は、<code class="docutils literal"><span class="pre">statementType</span></code>属性に<code class="docutils literal"><span class="pre">CALLABLE</span></code>を指定する。
<code class="docutils literal"><span class="pre">CALLABLE</span></code>を指定すると、
<code class="docutils literal"><span class="pre">java.sql.CallableStatement</span></code>を使用してストアドプロシージャが呼び出される。</p>
<p class="last">OUTパラメータをJavaBeanにマッピングするために、
<code class="docutils literal"><span class="pre">resultType</span></code>属性又は<code class="docutils literal"><span class="pre">resultMap</span></code>属性を指定する。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p class="first">ストアドプロシージャを呼び出す。</p>
<p>ストアドプロシージャ（ファンクション）を呼び出す場合は、</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">{call</span> <span class="pre">Procedure</span> <span class="pre">or</span> <span class="pre">Function名(INパラメータ...)}</span></code></li>
</ul>
<p>形式で指定する。</p>
<p class="last">上記例では、<code class="docutils literal"><span class="pre">findTodo</span></code>という名前のファンクションに対して、
INパラメータにIDを指定して呼び出している。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="appendix">
<span id="dataaccessmybatis3appendix"></span><h2><a class="toc-backref" href="#id154">6.2.4. Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this headline">¶</a></h2>
<div class="section" id="mapper">
<span id="dataaccessmybatis3appendixaboutmappermechanism"></span><h3><a class="toc-backref" href="#id155">6.2.4.1. Mapperインタフェースの仕組みについて</a><a class="headerlink" href="#mapper" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Mapperインタフェースを使用する場合、開発者はMapperインタフェースとマッピングファイルを作成するだけで、SQLを実行する事ができる。</div>
<div class="line">Mapperインタフェースの実装クラスは、MyBatis3がJDKのProxy機能を使用してアプリケーション実行時に生成されるため、
開発者がMapperインタフェースの実装クラスを作成する必要はない。</div>
</div>
<div class="line-block">
<div class="line">Mapperインタフェースは、MyBatis3から提供されているインタフェースの継承やアノテーションなどの定義は不要であり、
単にJavaのインタフェースとして作成すればよい。</div>
<div class="line">以下に、Mapperインタフェースとマッピングファイルの作成例、及びアプリケーション(Service)での利用例を示す。</div>
<div class="line">ここでは、開発者が作成する成果物をイメージしてもらう事が目的なので、コードに対する説明はポイントとなる点に絞って行っている。</div>
</div>
<ul>
<li><p class="first">Mapperインタフェースの作成例</p>
<p>本ガイドラインでは、MyBatis3のMapperインタフェースをRepositoryインタフェースとして使用することを前提としているため、
インタフェース名は、「Entity名」 + <code class="docutils literal"><span class="pre">Repository</span></code> というネーミングにしている。</p>
</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.repository.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="p">{</span>
    <span class="n">Todo</span> <span class="nf">findOne</span><span class="p">(</span><span class="n">String</span> <span class="n">todoId</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<ul>
<li><p class="first">マッピングファイルの作成例</p>
<p>マッピングファイルでは、ネームスペースとしてMapperインタフェースのFQCN(Fully Qualified Class Name)を指定し、
Mapperインタフェースに定義したメソッドの呼び出し時に実行するSQLとの紐づけは、
各種ステートメントタグ(insert/update/delete/selectタグ)のid属性に、メソッド名を指定する事で行う事ができる。</p>
</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org/DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="hll"><span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>
</span>
    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;todoResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">column=</span><span class="s">&quot;todo_id&quot;</span> <span class="na">property=</span><span class="s">&quot;todoId&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">column=</span><span class="s">&quot;title&quot;</span> <span class="na">property=</span><span class="s">&quot;title&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">column=</span><span class="s">&quot;finished&quot;</span> <span class="na">property=</span><span class="s">&quot;finished&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/resultMap&gt;</span>

<span class="hll">    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;String&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;todoResultMap&quot;</span><span class="nt">&gt;</span>
</span>      SELECT
        todo_id,
        title,
        finished
      FROM
        t_todo
      WHERE
        todo_id = #{todoId}
    <span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
</div></blockquote>
<ul>
<li><p class="first">アプリケーション(Service)でのMapperインタフェースの使用例</p>
<p>アプリケーション(Service)からMapperインタフェースのメソッドを呼び出す場合は、Spring(DIコンテナ)によって注入されたMapperオブジェクトのメソッドを呼び出す。
アプリケーション(Service)は、Mapperオブジェクトのメソッドを呼び出すことで、透過的にSQLが実行され、SQLの実行結果を得ることができる。</p>
</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.repository.todo.TodoRepository</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">TodoRepository</span> <span class="n">todoRepository</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">getTodo</span><span class="p">(</span><span class="n">String</span> <span class="n">todoId</span><span class="p">){</span>
<span class="hll">        <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">todoId</span><span class="p">);</span>
</span>        <span class="k">if</span><span class="p">(</span><span class="n">todo</span> <span class="o">==</span> <span class="kc">null</span><span class="p">){</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">ResourceNotFoundException</span><span class="p">(</span>
                <span class="n">ResultMessages</span><span class="p">.</span><span class="na">error</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;e.ex.td.5001&quot;</span> <span class="p">,</span><span class="n">todoId</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">todo</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>以下に、Mapperインタフェースのメソッドを呼び出した際に、SQLが実行されるまでの処理フローについて説明を行う。</p>
<blockquote>
<div><div class="figure align-center" id="id78">
<a class="reference internal image-reference" href="../../_images/DataAccessMyBatis3MapperMechanism.png"><img alt="Mapper mechanism" src="../../_images/DataAccessMyBatis3MapperMechanism.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Mapper mechanism</strong></span></p>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">アプリケーションは、Mapperインタフェースに定義されているメソッドを呼び出す。</p>
<p class="last">Mapperインタフェースの実装クラス(MapperインタフェースのProxyオブジェクト)は、アプリケーション起動時にMyBatis3のコンポーネントによって生成される。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">MapperインタフェースのProxyオブジェクトは、<code class="docutils literal"><span class="pre">MapperProxy</span></code> のinvokeメソッドを呼び出す。</p>
<p class="last"><code class="docutils literal"><span class="pre">MapperProxy</span></code> は、Mapperインタフェースのメソッド呼び出しをハンドリングする役割をもつ。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">MapperProxy</span></code> は、呼び出されたMapperインタフェースのメソッドに対応する <code class="docutils literal"><span class="pre">MapperMethod</span></code> を生成し、executeメソッドを呼び出す。</p>
<p class="last"><code class="docutils literal"><span class="pre">MapperMethod</span></code> は、 呼び出されたMapperインタフェースのメソッドに対応する<code class="docutils literal"><span class="pre">SqlSession</span></code> のメソッドを呼び出す役割をもつ。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">MapperMethod</span></code> は、 <code class="docutils literal"><span class="pre">SqlSession</span></code> のメソッドを呼び出す。</p>
<p class="last"><code class="docutils literal"><span class="pre">SqlSession</span></code> のメソッドを呼び出す際は、実行するSQLステートメントを特定するためのキー(以降、「ステートメントID」と呼ぶ)を引き渡している。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">SqlSession</span></code> は、指定されたステートメントIDをキーに、マッピングファイルよりSQLステートメントを取得する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">SqlSession</span></code> は、マッピングファイルより取得したSQLステートメントに指定されているバインド変数に値を設定し、SQLを実行する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td><p class="first">Mapperインタフェース(<code class="docutils literal"><span class="pre">SqlSession</span></code> )は、SQLの実行結果をJavaBeanなどに変換して、アプリケーションに返却する。</p>
<p class="last">件数のカウントや、更新件数などを取得する場合は、プリミティブ型やプリミティブラッパ型などが返却値となるケースもある。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>ステートメントIDとは</strong></p>
<p>ステートメントIDは、実行するSQLステートメントを特定するためのキーであり、
<strong>「MapperインタフェースのFQCN + “.” + 呼び出されたMapperインタフェースのメソッド名」</strong> というルールで生成される。</p>
<p class="last"><code class="docutils literal"><span class="pre">MapperMethod</span></code> によって生成されたステートメントIDに対応するSQLステートメントをマッピングファイルに定義するためには、
マッピングファイルのネームスペースに「MapperインタフェースのFQCN」、
各種ステートメントタグのid属性に「Mapperインタフェースのメソッド名」を指定する必要がある。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3appendixsettingstypealias">
<span id="id60"></span><h3><a class="toc-backref" href="#id156">6.2.4.2. TypeAliasの設定</a><a class="headerlink" href="#dataaccessmybatis3appendixsettingstypealias" title="Permalink to this headline">¶</a></h3>
<p>TypeAliasの設定は、基本的には<code class="docutils literal"><span class="pre">package</span></code> 要素を使用してパッケージ単位で設定すればよいが、</p>
<ul class="simple">
<li>クラス単位でエイリアス名を設定する方法</li>
<li>デフォルトで付与されるエイリアス名を上書きする方法(任意のエイリアス名を指定する方法)</li>
</ul>
<p>も用意されている。</p>
<div class="section" id="id61">
<h4><a class="toc-backref" href="#id157">6.2.4.2.1. TypeAliasをクラス単位に設定</a><a class="headerlink" href="#id61" title="Permalink to this headline">¶</a></h4>
<p>TypeAliasの設定は、クラス単位で設定する事もできる。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/mybatis/mybatis-config.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;typeAliases&gt;</span>
<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;typeAlias</span>
</span><span class="hll">        <span class="na">type=</span><span class="s">&quot;com.example.domain.repository.account.AccountSearchCriteria&quot;</span> <span class="nt">/&gt;</span>
</span>    <span class="nt">&lt;package</span> <span class="na">name=</span><span class="s">&quot;com.example.domain.model&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/typeAliases&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">typeAlias</span></code> 要素の<code class="docutils literal"><span class="pre">type</span></code> 属性に、エイリアスを設定するクラスの完全修飾クラス名(FQCN)を指定する。</p>
<p>上記例だと、<code class="docutils literal"><span class="pre">com.example.domain.repository.account.AccountSearchCriteria</span></code> クラスのエイリアス名は、
<code class="docutils literal"><span class="pre">AccountSearchCriteria</span></code> (パッケージの部分が除去された部分)となる。</p>
<p class="last">エイリアス名に任意の値を指定したい場合は、<code class="docutils literal"><span class="pre">typeAlias</span></code> 要素の<code class="docutils literal"><span class="pre">alias</span></code> 属性に任意のエイリアス名を指定することができる。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id62">
<h4><a class="toc-backref" href="#id158">6.2.4.2.2. デフォルトで付与されるエイリアス名の上書き</a><a class="headerlink" href="#id62" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">package</span></code> 要素を使用してエイリアスを設定した場合や、
<code class="docutils literal"><span class="pre">typeAlias</span></code> 要素の<code class="docutils literal"><span class="pre">alias</span></code> 属性を省略してエイリアスを設定した場合は、
TypeAliasのエイリアス名は、完全修飾クラス名(FQCN)からパッケージの部分が除去された部分となる。</p>
<p>デフォルトで付与されるエイリアス名ではなく、任意のエイリアス名にしたい場合は、
TypeAliasを設定したいクラスに<code class="docutils literal"><span class="pre">&#64;org.apache.ibatis.type.Alias</span></code> アノテーションを指定する事で、
任意のエイリアス名を指定する事ができる。</p>
<ul class="simple">
<li>エイリアス設定対象のJavaクラス</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.model.book</span><span class="p">;</span>

<span class="hll"><span class="nd">@Alias</span><span class="p">(</span><span class="s">&quot;BookAuthor&quot;</span><span class="p">)</span> <span class="c1">// (1)</span>
</span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Author</span> <span class="p">{</span>
   <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.model.article</span><span class="p">;</span>

<span class="hll"><span class="nd">@Alias</span><span class="p">(</span><span class="s">&quot;ArticleAuthor&quot;</span><span class="p">)</span> <span class="c1">// (1)</span>
</span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Author</span> <span class="p">{</span>
   <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">&#64;Alias</span></code> アノテーションの<code class="docutils literal"><span class="pre">value</span></code> 属性に、エイリアス名を指定する。</p>
<p>上記例だと、<code class="docutils literal"><span class="pre">com.example.domain.model.book.Author</span></code> クラスのエイリアス名は、
<code class="docutils literal"><span class="pre">BookAuthor</span></code> となる。</p>
<p class="last">異なるパッケージの中に同じクラス名のクラスが格納されている場合は、この方法を使用することで、それぞれ異なるエイリアス名を設定する事ができる。
ただし、本ガイドラインでは、クラス名は重複しないように設計する事を推奨する。
上記例であれば、クラス名自体を<code class="docutils literal"><span class="pre">BookAuthor</span></code> と<code class="docutils literal"><span class="pre">ArticleAuthor</span></code> にすることを検討して頂きたい。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>TypeAliasの エイリアス名は、</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">typeAlias</span></code> 要素の<code class="docutils literal"><span class="pre">alias</span></code> 属性の指定値</li>
<li><code class="docutils literal"><span class="pre">&#64;Alias</span></code> アノテーションの<code class="docutils literal"><span class="pre">value</span></code> 属性の指定値</li>
<li>デフォルトで付与されるエイリアス名(完全修飾クラス名からパッケージの部分が除去された部分)</li>
</ul>
</div></blockquote>
<p class="last">の優先順で適用される。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="dataaccessmybatis3appendixswitchingsqlbydatabase">
<span id="id63"></span><h3><a class="toc-backref" href="#id159">6.2.4.3. データベースによるSQL切り替えについて</a><a class="headerlink" href="#dataaccessmybatis3appendixswitchingsqlbydatabase" title="Permalink to this headline">¶</a></h3>
<p>MyBatis3では、JDBCドライバから接続しているデータベースのベンダー情報を取得して、
使用するSQLを切り替える仕組み(<code class="docutils literal"><span class="pre">org.apache.ibatis.mapping.VendorDatabaseIdProvider</span></code>)を提供している。</p>
<p>この仕組みは、動作環境として複数のデータベースをサポートするようなアプリケーションを構築する際に有効である。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>本ガイドラインでは、環境依存するコンポーネントや設定ファイルについては、
[projectName]-envというサブプロジェクトで管理し、
ビルド時に実行環境にあったコンポーネントや設定ファイル作成を選択するスタイルを推奨している。</p>
<p>[projectName]-envは、</p>
<ul class="simple">
<li>開発環境(ローカルのPC環境)</li>
<li>各種試験環境</li>
<li>商用環境</li>
</ul>
<p>上記それぞれの差分を吸収するためのサブプロジェクトであり、
複数のデータベースをサポートするアプリケーションの開発でも利用する事ができる。</p>
<p>基本的には、環境依存するコンポーネントや設定ファイルは、
[projectName]-envというサブプロジェクトで管理する事を推奨するが、
SQLのちょっとした違いを吸収したい場合は、本仕組みを使用してもよい。</p>
<p class="last"><strong>アーキテクトは、データベースの違いによるSQLの環境依存をどのように実装するかの指針を明確に示すことで、</strong>
<strong>アプリケーション全体として統一された実装となるように心がけてほしい。</strong></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/spring/projectName-infra.xml</span></code> にBean定義を追加する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xmlns:mybatis=</span><span class="s">&quot;http://mybatis.org/schema/mybatis-spring&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;</span>
<span class="s">        http://www.springframework.org/schema/beans</span>
<span class="s">        https://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">        http://mybatis.org/schema/mybatis-spring</span>
<span class="s">        http://mybatis.org/schema/mybatis-spring.xsd</span>
<span class="s">    &quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;import</span> <span class="na">resource=</span><span class="s">&quot;classpath:/META-INF/spring/projectName-env.xml&quot;</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;databaseIdProvider&quot;</span>
          <span class="na">class=</span><span class="s">&quot;org.apache.ibatis.mapping.VendorDatabaseIdProvider&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;properties&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;props&gt;</span>
                <span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">&quot;H2&quot;</span><span class="nt">&gt;</span>h2<span class="nt">&lt;/prop&gt;</span>
                <span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">&quot;PostgreSQL&quot;</span><span class="nt">&gt;</span>postgresql<span class="nt">&lt;/prop&gt;</span>
            <span class="nt">&lt;/props&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sqlSessionFactory&quot;</span>
        <span class="na">class=</span><span class="s">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
        <span class="c">&lt;!-- (3) --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;databaseIdProvider&quot;</span> <span class="na">ref=</span><span class="s">&quot;databaseIdProvider&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;configLocation&quot;</span>
            <span class="na">value=</span><span class="s">&quot;classpath:/META-INF/mybatis/mybatis-config.xml&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;mybatis:scan</span> <span class="na">base-package=</span><span class="s">&quot;com.example.domain.repository&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">MyBatis3から提供されている<code class="docutils literal"><span class="pre">VendorDatabaseIdProvider</span></code>をBean定義する。</p>
<p class="last"><code class="docutils literal"><span class="pre">VendorDatabaseIdProvider</span></code>は、
JDBCドライバから取得したデータベースのプロダクト名(<code class="docutils literal"><span class="pre">java.sql.DatabaseMetaData#getDatabaseProductName()</span></code>)をデータベースIDとして扱うためのクラスである。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">properties</span></code>プロパティには、JDBCドライバから取得したデータベースのプロダクト名とデータベースIDのマッピングを指定する。</p>
<p class="last">マッピング仕様については、「<a class="reference external" href="https://mybatis.org/mybatis-3/configuration.html#databaseIdProvider">MyBatis3 REFERENCE DOCUMENTATION(Configuration-databaseIdProvider-)</a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first">データベースIDを使用する<code class="docutils literal"><span class="pre">SqlSessionFactoryBean</span></code>の<code class="docutils literal"><span class="pre">databaseIdProvider</span></code>プロパティ対して、
(1)で定義した<code class="docutils literal"><span class="pre">DatabaseIdProvider</span></code>を指定する。</p>
<p class="last">この指定を行うと、マッピングファイルからデータベースIDを参照する事が可能となる。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>本ガイドラインでは、<code class="docutils literal"><span class="pre">properties</span></code>プロパティを指定して、
データベースのプロダクト名とデータベースIDをマッピングする方式を推奨する。</p>
<p class="last">理由は、JDBCドライバから取得できるデータベースのプロダクト名は、
JDBCドライバのバージョンによって変わる可能性があるためである。
<code class="docutils literal"><span class="pre">properties</span></code>プロパティを使用すると、使用するJDBCドライバのバージョンによるプロダクト名の違いを、
一箇所で管理する事ができる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>マッピングファイルの実装を行う。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;create&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;selectKey</span> <span class="na">keyProperty=</span><span class="s">&quot;todoId&quot;</span> <span class="na">resultType=</span><span class="s">&quot;string&quot;</span> <span class="na">order=</span><span class="s">&quot;BEFORE&quot;</span>
               <span class="na">databaseId=</span><span class="s">&quot;h2&quot;</span><span class="nt">&gt;</span>
        SELECT RANDOM_UUID()
    <span class="nt">&lt;/selectKey&gt;</span>
    <span class="nt">&lt;selectKey</span> <span class="na">keyProperty=</span><span class="s">&quot;todoId&quot;</span> <span class="na">resultType=</span><span class="s">&quot;string&quot;</span> <span class="na">order=</span><span class="s">&quot;BEFORE&quot;</span>
               <span class="na">databaseId=</span><span class="s">&quot;postgresql&quot;</span><span class="nt">&gt;</span>
        SELECT UUID_GENERATE_V4()
    <span class="nt">&lt;/selectKey&gt;</span>

    INSERT INTO
      t_todo
    (
        todo_id
        ,todo_title
        ,finished
        ,created_at
        ,version
    )
    VALUES
    (
        #{todoId}
        ,#{todoTitle}
        ,#{finished}
        ,#{createdAt}
        ,#{version}
    )
<span class="nt">&lt;/insert&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">ステートメント要素(<code class="docutils literal"><span class="pre">select</span></code>要素、<code class="docutils literal"><span class="pre">update</span></code>要素、<code class="docutils literal"><span class="pre">sql</span></code>要素など)をデータベース毎に切り替えたい場合は、
各要素の<code class="docutils literal"><span class="pre">databaseId</span></code>属性にデータベースIDを指定する。</p>
<p><code class="docutils literal"><span class="pre">databaseId</span></code>属性を指定すると、データベースIDが一致するステートメント要素が使用される。</p>
<p class="last">上記例では、データベース固有のUUID生成関数を呼び出して、IDを生成している。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>上記例では、PostgreSQLのUUID生成関数として<code class="docutils literal"><span class="pre">UUID_GENERATE_V4()</span></code>を呼び出しているが、
この関数は、<a class="reference external" href="https://www.postgresql.org/docs/13/uuid-ossp.html">uuid-ossp</a>と呼ばれるサブモジュールの関数である。</p>
<p class="last">この関数を使用したい場合は、uuid-osspモジュールを有効にする必要がある。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>データベースIDは、OGNLベースの式（Expression言語）内でも参照する事ができる。</p>
<p>これは、データベースIDを動的SQLの条件として使用できる事を意味している。
以下に実装例を紹介する。</p>
<blockquote class="last">
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAllByCreatedAtBefore&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;_int&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    SELECT
        todo_id,
        todo_title,
        finished,
        created_at,
        version
    FROM
        t_todo
    WHERE
        <span class="nt">&lt;choose&gt;</span>
            <span class="c">&lt;!-- (2) --&gt;</span>
            <span class="nt">&lt;when</span> <span class="na">test=</span><span class="s">&quot;_databaseId == &#39;h2&#39;&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;bind</span> <span class="na">name=</span><span class="s">&quot;criteriaDate&quot;</span>
                      <span class="na">value=</span><span class="s">&quot;&#39;DATEADD(\&#39;DAY\&#39;,#{days} * -1,#{currentDate})&#39;&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/when&gt;</span>
            <span class="nt">&lt;when</span> <span class="na">test=</span><span class="s">&quot;_databaseId == &#39;postgresql&#39;&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;bind</span> <span class="na">name=</span><span class="s">&quot;criteriaDate&quot;</span>
                      <span class="na">value=</span><span class="s">&quot;&#39;#{currentDate}::DATE - (#{days} * INTERVAL \&#39;1 DAY\&#39;)&#39;&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/when&gt;</span>
        <span class="nt">&lt;/choose&gt;</span>
        <span class="cp">&lt;![CDATA[</span>
<span class="cp">            created_at &lt; ${criteriaDate}</span>
<span class="cp">        ]]&gt;</span>
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
</div></blockquote>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">OGNLベースの式（Expression言語）内では、
<code class="docutils literal"><span class="pre">_databaseId</span></code>という特別な変数にデータベースIDが格納されている。</p>
<p class="last">上記例では、「システム日付 - 指定日」より前に作成されたレコードを抽出するための条件を、
データベースの関数を利用して指定している。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="entity1sql">
<span id="dataaccessmybatis3appendixacquirerelatedobjectsatonce"></span><h3><a class="toc-backref" href="#id160">6.2.4.4. 関連Entityを１回のSQLで取得する方法について</a><a class="headerlink" href="#entity1sql" title="Permalink to this headline">¶</a></h3>
<p>主Entityと関連Entityを1回のSQLでまとめて取得する方法について説明する。</p>
<p>主Entityと関連Entityをまとめて取得する仕組みを使用すると、
ServiceクラスでEntity(JavaBean)の組み立て処理を行う必要がなくなり、
Serviceクラスは業務ロジック(ビジネスルール)の実装に集中する事ができる。</p>
<div class="line-block">
<div class="line">また、この方法は、N+1問題を回避する手段としても使用される。</div>
<div class="line">N+1問題については、「<a class="reference internal" href="DataAccessCommon.html#data-access-common-howtosolve-n-plus-1"><span class="std std-ref">N+1問題の対策方法</span></a>」を参照されたい。</div>
</div>
<blockquote>
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>主Entityと関連Entityをまとめて取得する場合は、以下の点に注意して使用すること。</p>
<ul class="simple">
<li>以下の説明では全ての関連Entityを1回のSQLでまとめて取得しているが、
実際のプロジェクトで使用する場合は、
処理で必要となる関連Entityのみ取得するようにした方がよいケースがある。
使用しない関連Entityを同時に取得すると、
無駄なオブジェクト生成やマッピング処理が行われるため性能劣化の要因となる事がある。
<strong>特に、一覧検索を行うSQLでは、必要な関連Entityのみ取得するようにした方がよいケースが多い。</strong></li>
</ul>
<p></p>
<ul class="simple">
<li>使用頻度の低い関連Entityについては、
まとめて取得せず必要なときに個別に取得する方法を採用した方がよいケースがある。
使用頻度の低い関連Entityを同時に取得すると、
無駄なオブジェクト生成やマッピング処理が行われるため性能劣化の要因となる事がある。</li>
</ul>
<p></p>
<ul class="last simple">
<li>1:Nの関係となる関連Entityが複数含まれる場合、
主Entityと関連Entityを別々に取得する方法を採用した方がよいケースがある。
1:Nの関係となる関連Entityが複数ある場合、
無駄なデータをDBから取得する必要があるため、性能劣化の要因となる事がある。
主Entityと関連Entityを別々に取得する方法の一例については、
「<a class="reference internal" href="DataAccessCommon.html#data-access-common-howtosolve-n-plus-1"><span class="std std-ref">N+1問題の対策方法</span></a>」を参照されたい。</li>
</ul>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>使用頻度の低い関連Entityを必要になった時に個別に取得する方法としては、</p>
<ul class="simple">
<li>Serviceクラスの処理で関連Entityを取得するメソッド(SQL)を呼び出して取得する。</li>
<li>関連Entityを”Lazy Load”対象にし、Getterメソッドが呼び出された際にSQLを透過的に実行して取得する。</li>
</ul>
<p>方法がある。</p>
<p>“Lazy Load”の仕組みを使用すると、
ServiceクラスでEntity(JavaBean)の組み立て処理を行う必要がなくなり、
Serviceクラスは業務ロジック(ビジネスルール)の実装に集中する事ができる。</p>
<p><strong>一覧検索を行うSQLで”Lazy Load”を使用するとN+1問題を引き起こすので、使用する際は注意すること。</strong></p>
<p class="last">“Lazy Load”の使用方法については、「<a class="reference internal" href="#dataaccessmybatis3appendixnestedselectlazysetting"><span class="std std-ref">関連EntityをLazy Loadするための設定</span></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>ここからは、ショッピングサイトで扱う注文データを、
1回のSQLでまとめて取得し、主Entity及び関連Entityにマッピングする実装例について説明を行う。</p>
<p>ここで説明する実装方法は、あくまで一例である。
MyBatis3では、本節で説明していない機能も多く提供しており、より高度なマッピングを行う事も可能である。</p>
<p>MyBatis3のマッピング機能の詳細については、
「<a class="reference external" href="https://mybatis.org/mybatis-3/sqlmap-xml.html#Result_Maps">MyBatis3 REFERENCE DOCUMENTATION(Mapper XML Files-Result Maps-)</a> 」を参照されたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="dataaccessmybatis3appendixacquirerelatedobjectsatoncetable">
<span id="id64"></span><h4><a class="toc-backref" href="#id161">6.2.4.4.1. テーブルレイアウトとデータ</a><a class="headerlink" href="#dataaccessmybatis3appendixacquirerelatedobjectsatoncetable" title="Permalink to this headline">¶</a></h4>
<p>説明で使用するテーブルは、以下の通り。</p>
<blockquote>
<div><div class="figure align-center" id="id79">
<a class="reference internal image-reference" href="../../_images/service_entity_table_layout.png"><img alt="ER diagram" src="../../_images/service_entity_table_layout.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - ER diagram</strong></span></p>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="17%" />
<col width="17%" />
<col width="56%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">カテゴリ</th>
<th class="head">テーブル名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>トランザクション系</td>
<td>t_order</td>
<td><p class="first">注文データを保持するテーブル。</p>
<p class="last">１つの注文に対して、1レコードが格納される。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>&#160;</td>
<td>t_order_item</td>
<td><p class="first">１つの注文で購入された商品データを保持するテーブル。</p>
<p class="last">1つの注文で複数の商品が購入された場合は、商品数分レコードが格納される。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>&#160;</td>
<td>t_order_coupon</td>
<td><p class="first">１つの注文で使用されたクーポンのデータを保持するテーブル。</p>
<p class="last">1つの注文で、複数のクーポンが使用された場合は、クーポン数分レコードが格納される。
クーポンを使用しなかった場合は、レコードは格納されない。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>マスタ系</td>
<td>m_item</td>
<td>商品を定義するマスタテーブル。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>&#160;</td>
<td>m_category</td>
<td>商品のカテゴリを定義するマスタテーブル。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>&#160;</td>
<td>m_item_category</td>
<td><p class="first">商品が所属するカテゴリを定義するマスタテーブル。</p>
<p class="last">商品とカテゴリのマッピングを保持している。
1つの商品は、複数のカテゴリに属すことができるモデルとなっている。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td>&#160;</td>
<td>m_coupon</td>
<td>クーポンを定義するマスタテーブル。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="8">
<li></li>
</ol>
</td>
<td>コード系</td>
<td>c_order_status</td>
<td>注文ステータスを定義するコードテーブル。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>説明で使用するテーブルレイアウトと格納データを作成するためのSQL(DDLとDML)を以下に示す。
(SQLはH2 Database用である)</p>
<ul class="simple">
<li>マスタ系テーブル作成用のDDL</li>
</ul>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">m_item</span> <span class="p">(</span>
    <span class="n">code</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
    <span class="n">name</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
    <span class="n">price</span> <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="k">CONSTRAINT</span> <span class="n">m_item_pk</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">m_category</span> <span class="p">(</span>
    <span class="n">code</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
    <span class="n">name</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">m_category_pk</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">m_item_category</span> <span class="p">(</span>
    <span class="n">item_code</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
    <span class="n">category_code</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">m_item_category_pk</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">item_code</span><span class="p">,</span> <span class="n">category_code</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">m_item_category_fk1</span> <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">item_code</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">m_item</span><span class="p">(</span><span class="n">code</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">m_item_category_fk2</span> <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">category_code</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">m_category</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">m_coupon</span> <span class="p">(</span>
    <span class="n">code</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
    <span class="n">name</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
    <span class="n">price</span> <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="k">CONSTRAINT</span> <span class="n">m_coupon_pk</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>コード系テーブル作成用のDDL</li>
</ul>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">c_order_status</span> <span class="p">(</span>
    <span class="n">code</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
    <span class="n">name</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">c_order_status_pk</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>トランザクション系テーブル作成用のDDL</li>
</ul>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">t_order</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">status_code</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">t_order_pk</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">t_order_fk</span> <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">status_code</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">c_order_status</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">t_order_item</span> <span class="p">(</span>
    <span class="n">order_id</span> <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">item_code</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
    <span class="n">quantity</span> <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="k">CONSTRAINT</span> <span class="n">t_order_item_pk</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">item_code</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">t_order_item_fk1</span> <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">t_order</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">t_order_item_fk2</span> <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">item_code</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">m_item</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">t_order_coupon</span> <span class="p">(</span>
    <span class="n">order_id</span> <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">coupon_code</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">t_order_coupon_pk</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">coupon_code</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">t_order_coupon_fk1</span> <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">t_order</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">t_order_coupon_fk2</span> <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">coupon_code</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">m_coupon</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>データ投入用のDML</li>
</ul>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- Setup master tables</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">m_item</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;ITM0000001&#39;</span><span class="p">,</span><span class="s1">&#39;Orange juice&#39;</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">m_item</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;ITM0000002&#39;</span><span class="p">,</span><span class="s1">&#39;NotePC&#39;</span><span class="p">,</span><span class="mi">100000</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">m_category</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;CTG0000001&#39;</span><span class="p">,</span><span class="s1">&#39;Drink&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">m_category</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;CTG0000002&#39;</span><span class="p">,</span><span class="s1">&#39;PC&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">m_category</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;CTG0000003&#39;</span><span class="p">,</span><span class="s1">&#39;Hot selling&#39;</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">m_item_category</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;ITM0000001&#39;</span><span class="p">,</span><span class="s1">&#39;CTG0000001&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">m_item_category</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;ITM0000002&#39;</span><span class="p">,</span><span class="s1">&#39;CTG0000002&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">m_item_category</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;ITM0000002&#39;</span><span class="p">,</span><span class="s1">&#39;CTG0000003&#39;</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">m_coupon</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;CPN0000001&#39;</span><span class="p">,</span><span class="s1">&#39;Join coupon&#39;</span><span class="p">,</span><span class="mi">3000</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">m_coupon</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;CPN0000002&#39;</span><span class="p">,</span><span class="s1">&#39;PC coupon&#39;</span><span class="p">,</span><span class="mi">30000</span><span class="p">);</span>

<span class="c1">-- Setup code tables</span>
<span class="k">INSERT</span>  <span class="k">INTO</span>  <span class="n">c_order_status</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;accepted&#39;</span><span class="p">,</span><span class="s1">&#39;Order accepted&#39;</span><span class="p">);</span>
<span class="k">INSERT</span>  <span class="k">INTO</span>  <span class="n">c_order_status</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;checking&#39;</span><span class="p">,</span><span class="s1">&#39;Stock checking&#39;</span><span class="p">);</span>
<span class="k">INSERT</span>  <span class="k">INTO</span>  <span class="n">c_order_status</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;shipped&#39;</span><span class="p">,</span><span class="s1">&#39;Item Shipped&#39;</span><span class="p">);</span>

<span class="c1">-- Setup transaction tables</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">t_order</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;accepted&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">t_order</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;checking&#39;</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">t_order_item</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;ITM0000001&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">t_order_item</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;ITM0000002&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">t_order_item</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;ITM0000001&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">t_order_item</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;ITM0000002&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">t_order_coupon</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;CPN0000001&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">t_order_coupon</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;CPN0000002&#39;</span><span class="p">);</span>

<span class="k">COMMIT</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3appendixacquirerelatedobjectsatonceentity">
<span id="id65"></span><h4><a class="toc-backref" href="#id162">6.2.4.4.2. Entityのクラス図</a><a class="headerlink" href="#dataaccessmybatis3appendixacquirerelatedobjectsatonceentity" title="Permalink to this headline">¶</a></h4>
<p>実装例では、上記テーブルに格納されているレコードを、以下のEntity(JavaBean)にマッピングする。</p>
<blockquote>
<div><div class="figure align-center" id="id80">
<a class="reference internal image-reference" href="../../_images/dataaccess_entity.png"><img alt="Class(JavaBean) diagram" src="../../_images/dataaccess_entity.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Class(JavaBean) diagram</strong></span></p>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="11%" />
<col width="17%" />
<col width="72%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">クラス名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>Order</td>
<td><p class="first">t_orderテーブルの1レコードを表現するJavaBean。</p>
<p>関連Entityとして、<code class="docutils literal"><span class="pre">OrderStatus</span></code>を1件、<code class="docutils literal"><span class="pre">OrderItem</span></code>および<code class="docutils literal"><span class="pre">OrderCoupon</span></code>を複数保持する。</p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">OrderStatus</span> <span class="n">orderStatus</span><span class="p">;</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">OrderItem</span><span class="o">&gt;</span> <span class="n">orderItems</span><span class="p">;</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">OrderCoupon</span><span class="o">&gt;</span> <span class="n">orderCoupons</span><span class="p">;</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>OrderItem</td>
<td><p class="first">t_order_itemテーブルの1レコードを表現するJavaBean。</p>
<p>関連Entityとして、<code class="docutils literal"><span class="pre">Item</span></code>を保持する。</p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderItem</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">orderId</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">Item</span> <span class="n">item</span><span class="p">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">quantity</span><span class="p">;</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>OrderCoupon</td>
<td><p class="first">t_order_couponテーブルの1コードを表現するJavaBean。</p>
<p>関連Entityとして、<code class="docutils literal"><span class="pre">Coupon</span></code>を保持する。</p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderCoupon</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">orderId</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">Coupon</span> <span class="n">coupon</span><span class="p">;</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>Item</td>
<td><p class="first">m_itemテーブルの1コードを表現するJavaBean。</p>
<p>関連オブジェクトとして、所属している<code class="docutils literal"><span class="pre">Category</span></code>を複数保持する。
<code class="docutils literal"><span class="pre">Category</span></code>との紐づけは、m_item_categoryテーブルによって行われる。</p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Item</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">code</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="p">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">price</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="n">categories</span><span class="p">;</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>Category</td>
<td><p class="first">m_categoryテーブルの1レコードを表現するJavaBean。</p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Category</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">code</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="p">;</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>Coupon</td>
<td><p class="first">m_couponテーブルの1レコードを表現するJavaBean。</p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Coupon</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">code</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="p">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">price</span><span class="p">;</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td>OrderStatus</td>
<td><p class="first">c_order_statusテーブルの1レコードを表現するJavaBean。</p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderStatus</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">code</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="p">;</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3appendixacquirerelatedobjectsatoncerepository">
<span id="id66"></span><h4><a class="toc-backref" href="#id163">6.2.4.4.3. Repositoryインタフェースの実装</a><a class="headerlink" href="#dataaccessmybatis3appendixacquirerelatedobjectsatoncerepository" title="Permalink to this headline">¶</a></h4>
<p>実装例では、</p>
<ul class="simple">
<li>Orderオブジェクトを1件取得するメソッド(<code class="docutils literal"><span class="pre">findOne</span></code>)</li>
<li>該当ページのOrderオブジェクトを取得するメソッド(<code class="docutils literal"><span class="pre">findPage</span></code>)</li>
</ul>
<p>を実装する。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.repository.order</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Order</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderRepository</span> <span class="p">{</span>

    <span class="n">Order</span> <span class="nf">findOne</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">);</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findPage</span><span class="p">(</span><span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;pageable&quot;</span><span class="p">)</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3appendixacquirerelatedobjectsatoncesql">
<span id="id67"></span><h4><a class="toc-backref" href="#id164">6.2.4.4.4. SQLの実装</a><a class="headerlink" href="#dataaccessmybatis3appendixacquirerelatedobjectsatoncesql" title="Permalink to this headline">¶</a></h4>
<p>関連Entityを1回のSQLでまとめて取得する場合は、
取得対象のテーブルをJOINしてマッピングに必要な全てのレコードを取得する。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot; &gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.order.OrderRepository&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;sql</span> <span class="na">id=</span><span class="s">&quot;selectFromJoin&quot;</span><span class="nt">&gt;</span>
        SELECT
            /* (2) */
            o.id,
            /* (3) */
            o.status_code,
            os.name AS status_name,
            /* (4) */
            oi.quantity,
            i.code AS item_code,
            i.name AS item_name,
            i.price AS item_price,
            /* (5) */
            ct.code AS category_code,
            ct.name AS category_name,
            /* (6) */
            cp.code AS coupon_code,
            cp.name AS coupon_name,
            cp.price AS coupon_price
        FROM
            ${orderTable} o
        /* (7) */
        INNER JOIN c_order_status os ON os.code = o.status_code
        INNER JOIN t_order_item oi ON oi.order_id = o.id
        INNER JOIN m_item i ON i.code = oi.item_code
        INNER JOIN m_item_category ic ON ic.item_code = i.code
        INNER JOIN m_category ct ON ct.code = ic.category_code
        /* (8) */
        LEFT JOIN t_order_coupon oc ON oc.order_id = o.id
        LEFT JOIN m_coupon cp ON cp.code = oc.coupon_code
    <span class="nt">&lt;/sql&gt;</span>

    <span class="c">&lt;!-- (9) --&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;_int&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;orderResultMap&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;bind</span> <span class="na">name=</span><span class="s">&quot;orderTable&quot;</span> <span class="na">value=</span><span class="s">&quot;&#39;t_order&#39;&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">&quot;selectFromJoin&quot;</span><span class="nt">/&gt;</span>
        WHERE
            o.id = #{id}
        ORDER BY
            item_code ASC,
            category_code ASC,
            coupon_code ASC
    <span class="nt">&lt;/select&gt;</span>

    <span class="c">&lt;!-- (10) --&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findPage&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;orderResultMap&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;bind</span> <span class="na">name=</span><span class="s">&quot;orderTable&quot;</span> <span class="na">value=</span><span class="s">&quot;</span>
<span class="s">            &#39;(</span>
<span class="s">              SELECT</span>
<span class="s">                  *</span>
<span class="s">              FROM</span>
<span class="s">                  t_order</span>
<span class="s">              ORDER BY</span>
<span class="s">                  id DESC</span>
<span class="s">              LIMIT #{pageable.pageSize}</span>
<span class="s">              OFFSET #{pageable.offset}</span>
<span class="s">              )&#39;&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">&quot;selectFromJoin&quot;</span><span class="nt">/&gt;</span>
        ORDER BY
            id DESC,
            item_code ASC,
            category_code ASC,
            coupon_code ASC
    <span class="nt">&lt;/select&gt;</span>

    <span class="c">&lt;!-- ... --&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">findOne</span></code>メソッドと<code class="docutils literal"><span class="pre">findPage</span></code>メソッド用のSELECT句、FROM句、JOIN句を実装する。</p>
<p class="last">上記例では、<code class="docutils literal"><span class="pre">findOne</span></code>メソッドと<code class="docutils literal"><span class="pre">findPage</span></code>メソッドの共通箇所を共通化している。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>Orderオブジェクトを生成するために必要なデータを取得する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first">OrderStatusオブジェクトを生成するために必要なデータを取得する。</p>
<p class="last">取得するカラム名は重複しないようにする必要がある。
上記例では、<code class="docutils literal"><span class="pre">name</span></code>カラムが重複するため、
AS句を使用して別名(<code class="docutils literal"><span class="pre">status_</span></code>プレフィックス)を指定している。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p class="first">OrderItemオブジェクトとItemオブジェクトを生成するために必要なデータを取得する。</p>
<p class="last">取得するカラム名は重複しないようにする必要がある。
上記例では、<code class="docutils literal"><span class="pre">code</span></code>,<code class="docutils literal"><span class="pre">name</span></code>, <code class="docutils literal"><span class="pre">price</span></code>が重複するため、
AS句を使用して別名(<code class="docutils literal"><span class="pre">item_</span></code>プレフィックス)を指定している。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><p class="first">Categoryオブジェクトを生成するために必要なデータを取得する。</p>
<p class="last">取得するカラム名は重複しないようにする必要がある。
上記例では、<code class="docutils literal"><span class="pre">code</span></code>,<code class="docutils literal"><span class="pre">name</span></code>が重複するため、
AS句を使用して別名(<code class="docutils literal"><span class="pre">category_</span></code>プレフィックス)を指定している。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td><p class="first">OrderCouponオブジェクトとCouponオブジェクトを生成するために必要なデータを取得する。</p>
<p class="last">取得するカラム名は重複しないようにする必要がある。
上記例では、<code class="docutils literal"><span class="pre">code</span></code>,<code class="docutils literal"><span class="pre">name</span></code>, <code class="docutils literal"><span class="pre">price</span></code>が重複するため、
AS句を使用して別名(<code class="docutils literal"><span class="pre">coupon_</span></code>プレフィックス)を指定している。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td>関連オブジェクトを生成するために必要なデータが格納されているテーブルを結合する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="8">
<li></li>
</ol>
</td>
<td>レコードが格納されない可能性のあるテーブルについては、外部結合とする。
クーポンを使用しない場合、t_order_couponにレコードが格納されないので外部結合にする必要がある。
t_order_couponと結合するt_couponも同様である。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="9">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">findOne</span></code>メソッド用のSQLを実装する。</p>
<p class="last">ORDER BY句には、1:Nの関連をもつEntityの並び順を指定する。
上記例では、PKの昇順で並べ替えている。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="10">
<li></li>
</ol>
</td>
<td><code class="docutils literal"><span class="pre">findPage</span></code>メソッド用のSQLを実装する。
ORDER BY句には、Orderと1:Nの関連をもつEntityの並び順を指定する。
上記例では、OrderはPKの降順(新しい順)、関連EntityはPKの昇順で並べ替えている。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>1:Nの関連を持つ関連Entityを1回のSQLでまとめて取得する際にページネーション検索が必要な場合は、
MyBatis3から提供されている<code class="docutils literal"><span class="pre">RowBounds</span></code>を使用することが出来ない。</p>
<p>代替案としては、</p>
<ul class="simple">
<li>まず主Entityのみを検索するメソッドを呼び出し、関連Entityは別途のメソッドを呼び出して取得する</li>
<li>SQLでページ範囲内の主Entityのみ格納されている仮想テーブルを作成し、仮想テーブルのレコードとJOINする事で、
マッピングに必要な全てのレコードを取得する(上記例の <code class="docutils literal"><span class="pre">findPage</span></code>は、このパターンで実装している)</li>
</ul>
<p class="last">等の方法が考えられる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>上記SQL(findPage)を実行すると以下のレコードが取得される。
注文レコードとしては2件だが、レコードが複数件格納される関連テーブルと結合しているため、
合計で9レコードが取得される。</p>
<p>内訳は、</p>
<ul class="simple">
<li>1～3行目は、注文IDが”<code class="docutils literal"><span class="pre">2</span></code>”の<code class="docutils literal"><span class="pre">Order</span></code>オブジェクトを生成するためのレコード</li>
<li>4～9行目は、注文IDが”<code class="docutils literal"><span class="pre">1</span></code>”の<code class="docutils literal"><span class="pre">Order</span></code>オブジェクトを生成するためレコード</li>
</ul>
<p>となる。</p>
<p>以降の説明では、注文IDが”<code class="docutils literal"><span class="pre">1</span></code>”のレコードを例に、
どのように検索結果(<code class="docutils literal"><span class="pre">ResultSet</span></code>)をJavaBeanにマッピングするかを説明していく。</p>
<blockquote>
<div><div class="figure align-center" id="id81">
<a class="reference internal image-reference" href="../../_images/dataaccess_sql_result.png"><img alt="Result Set of findPage" src="../../_images/dataaccess_sql_result.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Result Set of findPage</strong></span></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3appendixacquirerelatedobjectsatoncemapping">
<span id="id68"></span><h4><a class="toc-backref" href="#id165">6.2.4.4.5. マッピングの実装</a><a class="headerlink" href="#dataaccessmybatis3appendixacquirerelatedobjectsatoncemapping" title="Permalink to this headline">¶</a></h4>
<p>上記レコードを、<code class="docutils literal"><span class="pre">Order</span></code>オブジェクトと関連Entityにマッピングするための定義を以下に示す。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot; &gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.order.OrderRepository&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- ... --&gt;</span>

    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;orderResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Order&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;id&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderStatus.code&quot;</span> <span class="na">column=</span><span class="s">&quot;status_code&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderStatus.name&quot;</span> <span class="na">column=</span><span class="s">&quot;status_name&quot;</span> <span class="nt">/&gt;</span>
        <span class="c">&lt;!-- (3) --&gt;</span>
        <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;orderItems&quot;</span> <span class="na">ofType=</span><span class="s">&quot;OrderItem&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;orderId&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;item.code&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;quantity&quot;</span> <span class="na">column=</span><span class="s">&quot;quantity&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;association</span> <span class="na">property=</span><span class="s">&quot;item&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;itemResultMap&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/collection&gt;</span>
        <span class="c">&lt;!-- (4) --&gt;</span>
        <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;orderCoupons&quot;</span> <span class="na">ofType=</span><span class="s">&quot;OrderCoupon&quot;</span>
                    <span class="na">notNullColumn=</span><span class="s">&quot;coupon_code&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;orderId&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
            <span class="c">&lt;!-- (5) --&gt;</span>
            <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;coupon.code&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_code&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;coupon.name&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_name&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;coupon.price&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_price&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/collection&gt;</span>
    <span class="nt">&lt;/resultMap&gt;</span>

    <span class="c">&lt;!-- (6) --&gt;</span>
    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;itemResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Item&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;code&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;item_name&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;price&quot;</span> <span class="na">column=</span><span class="s">&quot;item_price&quot;</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!-- (7) --&gt;</span>
        <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;categories&quot;</span> <span class="na">ofType=</span><span class="s">&quot;Category&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;code&quot;</span> <span class="na">column=</span><span class="s">&quot;category_code&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;category_name&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/collection&gt;</span>
    <span class="nt">&lt;/resultMap&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>取得したレコードを<code class="docutils literal"><span class="pre">Order</span></code>オブジェクトにマッピングするための定義。
関連Entity(<code class="docutils literal"><span class="pre">OrderStatus</span></code>, <code class="docutils literal"><span class="pre">OrderItem</span></code>,<code class="docutils literal"><span class="pre">OrderCoupon</span></code>)のマッピングを行う。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>取得したレコードを<code class="docutils literal"><span class="pre">OrderStatus</span></code>オブジェクトにマッピングするための定義。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>取得したレコードを<code class="docutils literal"><span class="pre">OrderItem</span></code>オブジェクトにマッピングするための定義。
関連Entity(<code class="docutils literal"><span class="pre">Item</span></code>)へのマッピングは、別の<code class="docutils literal"><span class="pre">resultMap</span></code>(6)に委譲している。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>取得したレコードを<code class="docutils literal"><span class="pre">OrderCoupon</span></code>オブジェクトにマッピングするための定義。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>取得したレコードを<code class="docutils literal"><span class="pre">Coupon</span></code>オブジェクトにマッピングするための定義。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>取得したレコードを<code class="docutils literal"><span class="pre">Item</span></code>オブジェクトにマッピングするための定義。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td>取得したレコードを<code class="docutils literal"><span class="pre">Category</span></code>オブジェクトにマッピングするための定義。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="order">
<span id="dataaccessmybatis3appendixacquirerelatedobjectsatoncemappingorder"></span><h5>6.2.4.4.5.1. Orderオブジェクトへのマッピングの実装<a class="headerlink" href="#order" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal"><span class="pre">Order</span></code>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="hll"><span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll"><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;orderResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Order&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">    <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;id&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
</span>    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderStatus.code&quot;</span> <span class="na">column=</span><span class="s">&quot;status_code&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderStatus.name&quot;</span> <span class="na">column=</span><span class="s">&quot;status_name&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;orderItems&quot;</span> <span class="na">ofType=</span><span class="s">&quot;OrderItem&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;orderId&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;item.code&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;quantity&quot;</span> <span class="na">column=</span><span class="s">&quot;quantity&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;association</span> <span class="na">property=</span><span class="s">&quot;item&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;itemResultMap&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/collection&gt;</span>
    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;orderCoupons&quot;</span> <span class="na">ofType=</span><span class="s">&quot;OrderCoupon&quot;</span>
                <span class="na">notNullColumn=</span><span class="s">&quot;coupon_code&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;orderId&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;coupon.code&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_code&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;coupon.name&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_name&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;coupon.price&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_price&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/collection&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<div class="figure align-center" id="id82">
<a class="reference internal image-reference" href="../../_images/dataaccess_resultmap_order.png"><img alt="ResultMap for Order" src="../../_images/dataaccess_resultmap_order.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - ResultMap for Order</strong></span></p>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">検索結果を<code class="docutils literal"><span class="pre">Order</span></code>オブジェクトにマッピングする。</p>
<p class="last"><code class="docutils literal"><span class="pre">type</span></code>属性にマッピングするクラスを指定する。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">取得したレコードの<code class="docutils literal"><span class="pre">id</span></code>カラムの値を、<code class="docutils literal"><span class="pre">Order#id</span></code>プロパティに設定する。</p>
<p class="last"><code class="docutils literal"><span class="pre">id</span></code>カラムはPKなので、<code class="docutils literal"><span class="pre">id</span></code>要素を使用してマッピングを行う。
<code class="docutils literal"><span class="pre">id</span></code>要素を使用すると、指定したプロパティの値でレコードがグループ化される。
具体的には、<code class="docutils literal"><span class="pre">id=1</span></code>と<code class="docutils literal"><span class="pre">id=2</span></code>の2つにグループ化され、
2つの<code class="docutils literal"><span class="pre">Order</span></code>オブジェクトが生成される。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="orderstatus">
<span id="dataaccessmybatis3appendixacquirerelatedobjectsatoncemappingorderstatus"></span><h5>6.2.4.4.5.2. OrderStatusオブジェクトへのマッピングの実装<a class="headerlink" href="#orderstatus" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal"><span class="pre">OrderStatus</span></code>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>「<a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html#domainlayer-entity"><span class="std std-ref">Entityの実装</span></a>」のEntityクラスの作成方針では、
「コード系テーブルは、Entityとして扱うのではなく、java.lang.Stringなどの基本型で扱う。」としている。
これは、コード系テーブルで保持しているデータは、
「<a class="reference internal" href="../WebApplicationDetail/Codelist.html"><span class="doc">コードリスト</span></a>」などの別の仕組みを使用するケースが多いためである。</p>
<p>本節では、関連Entity(JavaBean)へのマッピング方法を説明する事が目的なので、
コード系テーブルもEntityとして扱っている点を補足しておく。</p>
<p class="last">実際のプロジェクトでは、Entityクラスの作成方針を参考にEntityを作成することを推奨する。</p>
</div>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;orderResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Order&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;id&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderStatus.code&quot;</span> <span class="na">column=</span><span class="s">&quot;status_code&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">    <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderStatus.name&quot;</span> <span class="na">column=</span><span class="s">&quot;status_name&quot;</span> <span class="nt">/&gt;</span>
</span>    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;orderItems&quot;</span> <span class="na">ofType=</span><span class="s">&quot;OrderItem&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;orderId&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;item.code&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;quantity&quot;</span> <span class="na">column=</span><span class="s">&quot;quantity&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;association</span> <span class="na">property=</span><span class="s">&quot;item&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;itemResultMap&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/collection&gt;</span>
    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;orderCoupons&quot;</span> <span class="na">ofType=</span><span class="s">&quot;OrderCoupon&quot;</span>
                <span class="na">notNullColumn=</span><span class="s">&quot;coupon_code&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;orderId&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;coupon.code&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_code&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;coupon.name&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_name&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;coupon.price&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_price&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/collection&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<div class="figure align-center" id="id83">
<a class="reference internal image-reference" href="../../_images/dataaccess_resultmap_orderstatus.png"><img alt="ResultMap for OrderStatus" src="../../_images/dataaccess_resultmap_orderstatus.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - ResultMap for OrderStatus</strong></span></p>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>取得したレコードの<code class="docutils literal"><span class="pre">status_code</span></code>カラムの値を、
<code class="docutils literal"><span class="pre">OrderStatus#code</span></code>プロパティに設定する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>取得したレコードの<code class="docutils literal"><span class="pre">status_name</span></code>カラムの値を、
<code class="docutils literal"><span class="pre">OrderStatus#name</span></code>プロパティに設定する。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">OrderStatus</span></code>オブジェクトには、<code class="docutils literal"><span class="pre">id</span></code>カラムでグループ化されたレコードの値が設定される。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="orderitem">
<span id="dataaccessmybatis3appendixacquirerelatedobjectsatoncemappingorderitem"></span><h5>6.2.4.4.5.3. OrderItemオブジェクトへのマッピングの実装<a class="headerlink" href="#orderitem" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal"><span class="pre">OrderItem</span></code>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;orderResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Order&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;id&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderStatus.code&quot;</span> <span class="na">column=</span><span class="s">&quot;status_code&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderStatus.name&quot;</span> <span class="na">column=</span><span class="s">&quot;status_name&quot;</span> <span class="nt">/&gt;</span>
<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;orderItems&quot;</span> <span class="na">ofType=</span><span class="s">&quot;OrderItem&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;orderId&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;item.code&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="nt">/&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (4) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;quantity&quot;</span> <span class="na">column=</span><span class="s">&quot;quantity&quot;</span><span class="nt">/&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (5) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;association</span> <span class="na">property=</span><span class="s">&quot;item&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;itemResultMap&quot;</span><span class="nt">/&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/collection&gt;</span>
</span>    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;orderCoupons&quot;</span> <span class="na">ofType=</span><span class="s">&quot;OrderCoupon&quot;</span>
                <span class="na">notNullColumn=</span><span class="s">&quot;coupon_code&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;orderId&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;coupon.code&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_code&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;coupon.name&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_name&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;coupon.price&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_price&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/collection&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<div class="figure align-center" id="id84">
<a class="reference internal image-reference" href="../../_images/dataaccess_resultmap_orderitem.png"><img alt="ResultMap for OrderItem" src="../../_images/dataaccess_resultmap_orderitem.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - ResultMap for OrderItem</strong></span></p>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">検索結果を<code class="docutils literal"><span class="pre">OrderItem</span></code>オブジェクトにマッピングし、
<code class="docutils literal"><span class="pre">Order#orderItems</span></code>プロパティに追加する。</p>
<p class="last">1:Nの関係の関連Entityにマッピングする場合は、<code class="docutils literal"><span class="pre">collection</span></code>要素を使用する。
<code class="docutils literal"><span class="pre">collection</span></code>要素の詳細は、
「<a class="reference external" href="https://mybatis.org/mybatis-3/sqlmap-xml.html#collection">MyBatis3 REFERENCE DOCUMENTATION(Mapper XML Files-collection-)</a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">取得したレコードの<code class="docutils literal"><span class="pre">id</span></code>カラムの値を、<code class="docutils literal"><span class="pre">OrderItem#orderId</span></code>プロパティに設定する。</p>
<p class="last"><code class="docutils literal"><span class="pre">id</span></code>カラムはPKなので、<code class="docutils literal"><span class="pre">id</span></code>要素を使用してマッピングを行う。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first">取得したレコードの<code class="docutils literal"><span class="pre">item_code</span></code>カラムの値を、<code class="docutils literal"><span class="pre">Item#code</span></code>プロパティに設定する。</p>
<p class="last"><code class="docutils literal"><span class="pre">item_code</span></code>カラムはPKなので、<code class="docutils literal"><span class="pre">id</span></code>要素を使用してマッピングを行う。
<code class="docutils literal"><span class="pre">id</span></code>要素を使用すると、指定したプロパティの値でレコードがグループ化される。
具体的には、<code class="docutils literal"><span class="pre">Item#code=ITM0000001</span></code>と<code class="docutils literal"><span class="pre">Item#code=ITM0000002</span></code>の2つにグループ化され、
2つの<code class="docutils literal"><span class="pre">OrderItem</span></code>オブジェクトが生成される。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>取得したレコードの<code class="docutils literal"><span class="pre">quantity</span></code>カラムの値を、<code class="docutils literal"><span class="pre">OrderItem#quantity</span></code>プロパティに設定する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">Item</span></code>オブジェクトの生成を、別の<code class="docutils literal"><span class="pre">resultMap</span></code>に委譲し、
生成されたオブジェクトを<code class="docutils literal"><span class="pre">OrderItem#item</span></code>プロパティに設定する。
実際のマッピングは、
「<a class="reference internal" href="#dataaccessmybatis3appendixacquirerelatedobjectsatoncemappingitem"><span class="std std-ref">Itemオブジェクトへのマッピングの実装</span></a>」を参照されたい。</p>
<p class="last">1:1の関係の関連Entityにマッピングする場合は、<code class="docutils literal"><span class="pre">association</span></code>要素を使用する。
<code class="docutils literal"><span class="pre">association</span></code>要素の詳細は、
「<a class="reference external" href="https://mybatis.org/mybatis-3/sqlmap-xml.html#association">MyBatis3 REFERENCE DOCUMENTATION(Mapper XML Files-association-)</a>」を参照されたい。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">OrderItem</span></code>オブジェクトには、
<code class="docutils literal"><span class="pre">id</span></code>カラムと<code class="docutils literal"><span class="pre">item_code</span></code>カラムでグループ化されたレコードの値が設定される。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="item">
<span id="dataaccessmybatis3appendixacquirerelatedobjectsatoncemappingitem"></span><h5>6.2.4.4.5.4. Itemオブジェクトへのマッピングの実装<a class="headerlink" href="#item" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal"><span class="pre">Item</span></code>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="hll"><span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll"><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;itemResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Item&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">    <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;code&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="nt">/&gt;</span>
</span><span class="hll">    <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;item_name&quot;</span><span class="nt">/&gt;</span>
</span><span class="hll">    <span class="c">&lt;!-- (4) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;price&quot;</span> <span class="na">column=</span><span class="s">&quot;item_price&quot;</span><span class="nt">/&gt;</span>
</span>    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;categories&quot;</span> <span class="na">ofType=</span><span class="s">&quot;Category&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;code&quot;</span> <span class="na">column=</span><span class="s">&quot;category_code&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;category_name&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/collection&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<div class="figure align-center" id="id85">
<a class="reference internal image-reference" href="../../_images/dataaccess_resultmap_item.png"><img alt="ResultMap for Item" src="../../_images/dataaccess_resultmap_item.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - ResultMap for Item</strong></span></p>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">検索結果を<code class="docutils literal"><span class="pre">Item</span></code>オブジェクトにマッピングする。</p>
<p class="last"><code class="docutils literal"><span class="pre">type</span></code>属性にマッピングするクラスを指定する。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">取得したレコードの<code class="docutils literal"><span class="pre">item_code</span></code>カラムの値を、<code class="docutils literal"><span class="pre">Item#code</span></code>に設定する。</p>
<p class="last"><code class="docutils literal"><span class="pre">item_code</span></code>カラムはPKなので、<code class="docutils literal"><span class="pre">id</span></code>要素を使用してマッピングを行う。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>取得したレコードの<code class="docutils literal"><span class="pre">item_name</span></code>カラムの値を、<code class="docutils literal"><span class="pre">Item#name</span></code>に設定する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>取得したレコードの<code class="docutils literal"><span class="pre">item_price</span></code>カラムの値を、<code class="docutils literal"><span class="pre">Item#price</span></code>に設定する。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">Item</span></code>オブジェクトには、
<code class="docutils literal"><span class="pre">id</span></code>カラムと<code class="docutils literal"><span class="pre">item_code</span></code>カラムでグループ化されたレコードの値が設定される。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="category">
<span id="dataaccessmybatis3appendixacquirerelatedobjectsatoncemappingcategory"></span><h5>6.2.4.4.5.5. Categoryオブジェクトへのマッピングの実装<a class="headerlink" href="#category" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal"><span class="pre">Category</span></code>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;itemResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Item&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;code&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;item_name&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;price&quot;</span> <span class="na">column=</span><span class="s">&quot;item_price&quot;</span><span class="nt">/&gt;</span>
<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;categories&quot;</span> <span class="na">ofType=</span><span class="s">&quot;Category&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;code&quot;</span> <span class="na">column=</span><span class="s">&quot;category_code&quot;</span><span class="nt">/&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;category_name&quot;</span><span class="nt">/&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/collection&gt;</span>
</span><span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<div class="figure align-center" id="id86">
<a class="reference internal image-reference" href="../../_images/dataaccess_resultmap_category.png"><img alt="ResultMap for Category" src="../../_images/dataaccess_resultmap_category.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - ResultMap for Category</strong></span></p>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">検索結果を<code class="docutils literal"><span class="pre">Category</span></code>オブジェクトにマッピングし、<code class="docutils literal"><span class="pre">Item#categories</span></code>プロパティに追加する。</p>
<p class="last">1:Nの関係の関連Entityにマッピングする場合は、<code class="docutils literal"><span class="pre">collection</span></code>要素を使用する。
<code class="docutils literal"><span class="pre">collection</span></code>要素の詳細は、
「<a class="reference external" href="https://mybatis.org/mybatis-3/sqlmap-xml.html#collection">MyBatis3 REFERENCE DOCUMENTATION(Mapper XML Files-collection-)</a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">取得したレコードの<code class="docutils literal"><span class="pre">category_code</span></code>カラムの値を、<code class="docutils literal"><span class="pre">Category#code</span></code>に設定する。</p>
<p><code class="docutils literal"><span class="pre">category_code</span></code>カラムはPKなので、<code class="docutils literal"><span class="pre">id</span></code>要素を使用してマッピングを行う。
<code class="docutils literal"><span class="pre">id</span></code>要素を使用すると、指定したプロパティの値でレコードがグループ化される。</p>
<p>具体的には、</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">Item#code=ITM0000001</span></code>のカテゴリとして、<code class="docutils literal"><span class="pre">Category#code=CTG0000001</span></code>の<code class="docutils literal"><span class="pre">Category</span></code>オブジェクト</li>
<li><code class="docutils literal"><span class="pre">Item#code=ITM0000002</span></code>のカテゴリとして、<code class="docutils literal"><span class="pre">Category#code=CTG0000002</span></code>と<code class="docutils literal"><span class="pre">Category#code=CTG0000003</span></code>の2つの<code class="docutils literal"><span class="pre">Category</span></code>オブジェクト</li>
</ul>
<p class="last">が生成される。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>取得したレコードの<code class="docutils literal"><span class="pre">category_name</span></code>カラムの値を、<code class="docutils literal"><span class="pre">Category#name</span></code> に設定する。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">Category</span></code>オブジェクトには、
<code class="docutils literal"><span class="pre">id</span></code>カラムと<code class="docutils literal"><span class="pre">item_code</span></code>カラムと<code class="docutils literal"><span class="pre">category_code</span></code>カラムでグループ化されたレコードの値が設定される。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="ordercoupon">
<span id="dataaccessmybatis3appendixacquirerelatedobjectsatoncemappingordercoupon"></span><h5>6.2.4.4.5.6. OrderCouponオブジェクトへのマッピングの実装<a class="headerlink" href="#ordercoupon" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal"><span class="pre">OrderCoupon</span></code>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;orderResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Order&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;id&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderStatus.code&quot;</span> <span class="na">column=</span><span class="s">&quot;status_code&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderStatus.name&quot;</span> <span class="na">column=</span><span class="s">&quot;status_name&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;orderItems&quot;</span> <span class="na">ofType=</span><span class="s">&quot;OrderItem&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;orderId&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;item.code&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;quantity&quot;</span> <span class="na">column=</span><span class="s">&quot;quantity&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;association</span> <span class="na">property=</span><span class="s">&quot;item&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;itemResultMap&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/collection&gt;</span>
<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;orderCoupons&quot;</span> <span class="na">ofType=</span><span class="s">&quot;OrderCoupon&quot;</span> <span class="na">notNullColumn=</span><span class="s">&quot;coupon_code&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;orderId&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;coupon.code&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_code&quot;</span><span class="nt">/&gt;</span>
</span>        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;coupon.name&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_name&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;coupon.price&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_price&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/collection&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<div class="figure align-center" id="id87">
<a class="reference internal image-reference" href="../../_images/dataaccess_resultmap_ordercoupon.png"><img alt="ResultMap for OrderCoupon" src="../../_images/dataaccess_resultmap_ordercoupon.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - ResultMap for OrderCoupon</strong></span></p>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">検索結果を<code class="docutils literal"><span class="pre">OrderCoupon</span></code>オブジェクトにマッピングし、<code class="docutils literal"><span class="pre">Order#orderCoupons</span></code>プロパティに追加する。</p>
<p>1:Nの関係の関連Entityにマッピングする場合は、<code class="docutils literal"><span class="pre">collection</span></code>要素を使用する。
<code class="docutils literal"><span class="pre">collection</span></code>要素の詳細は、
「<a class="reference external" href="https://mybatis.org/mybatis-3/sqlmap-xml.html#collection">MyBatis3 REFERENCE DOCUMENTATION(Mapper XML Files-collection-)</a>」を参照されたい。</p>
<p>上記例にて、<code class="docutils literal"><span class="pre">notNullColumn</span></code>属性を指定している点に注目してほしい。</p>
<p>これは<code class="docutils literal"><span class="pre">t_coupon</span></code>テーブルにレコードが存在しない時に、
<code class="docutils literal"><span class="pre">OrderCoupon</span></code>オブジェクトを生成させないための設定である。
本実装例では、<code class="docutils literal"><span class="pre">id</span></code>カラムが”<code class="docutils literal"><span class="pre">2</span></code>”のデータには<code class="docutils literal"><span class="pre">t_coupon</span></code>テーブルのレコードを格納していないため、
検索結果をみると、<code class="docutils literal"><span class="pre">coupon_code</span></code>と<code class="docutils literal"><span class="pre">coupon_name</span></code>と<code class="docutils literal"><span class="pre">coupon_price</span></code>の値が<code class="docutils literal"><span class="pre">null</span></code>になっているのがわかる。</p>
<p><code class="docutils literal"><span class="pre">OrderCoupon</span></code>オブジェクトにマッピングするカラムがこの3つだけであれば、
<code class="docutils literal"><span class="pre">notNullColumn</span></code>属性を指定する必要はないが、
実装例では<code class="docutils literal"><span class="pre">id</span></code>カラムの値を<code class="docutils literal"><span class="pre">OrderCoupon#orderId</span></code>プロパティにマッピングする設定を行っているため、
<code class="docutils literal"><span class="pre">notNullColumn</span></code>属性の指定が必要となる。
これは、マッピング対象のカラムの中に<code class="docutils literal"><span class="pre">null</span></code>でない値がセットされていた場合に、
MyBatisがオブジェクトを生成するためである。</p>
<p class="last">上記例のように、<code class="docutils literal"><span class="pre">notNullColumn</span></code>属性に<code class="docutils literal"><span class="pre">coupon_code</span></code>カラムを指定しておくと、
<code class="docutils literal"><span class="pre">coupon_code</span></code>カラムが<code class="docutils literal"><span class="pre">null</span></code>でない場合(つまり、レコードが存在する場合)にのみ、
オブジェクトが生成される。
<code class="docutils literal"><span class="pre">notNullColumn</span></code>属性には、複数のカラムを指定する事もできる。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">取得したレコードの<code class="docutils literal"><span class="pre">id</span></code>カラムの値を、<code class="docutils literal"><span class="pre">OrderCoupon#orderId</span></code>プロパティに設定する。</p>
<p class="last"><code class="docutils literal"><span class="pre">orderId</span></code>はPKなので、<code class="docutils literal"><span class="pre">id</span></code>要素を使用する。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first">取得したレコードの<code class="docutils literal"><span class="pre">coupon_code</span></code>カラムの値を<code class="docutils literal"><span class="pre">Coupon#code</span></code>に設定する。</p>
<p><code class="docutils literal"><span class="pre">coupon_code</span></code>カラムはPKなので、<code class="docutils literal"><span class="pre">id</span></code>要素を使用してマッピングを行う。
<code class="docutils literal"><span class="pre">id</span></code>要素を使用すると、指定したプロパティの値でレコードがグループ化される。</p>
<p class="last">具体的には、<code class="docutils literal"><span class="pre">Coupon#code=CPN0000001</span></code>と<code class="docutils literal"><span class="pre">Coupon#code=CPN0000002</span></code>の2つにグループ化され、
2つの<code class="docutils literal"><span class="pre">OrderCoupon</span></code>オブジェクトが生成される。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="coupon">
<span id="dataaccessmybatis3appendixacquirerelatedobjectsatoncemappingcoupon"></span><h5>6.2.4.4.5.7. Couponオブジェクトへのマッピングの実装<a class="headerlink" href="#coupon" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal"><span class="pre">Coupon</span></code>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;orderResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Order&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;id&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderStatus.code&quot;</span> <span class="na">column=</span><span class="s">&quot;status_code&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderStatus.name&quot;</span> <span class="na">column=</span><span class="s">&quot;status_name&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;orderItems&quot;</span> <span class="na">ofType=</span><span class="s">&quot;OrderItem&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;orderId&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;item.code&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;quantity&quot;</span> <span class="na">column=</span><span class="s">&quot;quantity&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;association</span> <span class="na">property=</span><span class="s">&quot;item&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;itemResultMap&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/collection&gt;</span>
    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;orderCoupons&quot;</span> <span class="na">ofType=</span><span class="s">&quot;OrderCoupon&quot;</span> <span class="na">notNullColumn=</span><span class="s">&quot;coupon_code&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;orderId&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
<span class="hll">        <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;coupon.code&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_code&quot;</span><span class="nt">/&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;coupon.name&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_name&quot;</span><span class="nt">/&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;coupon.price&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_price&quot;</span><span class="nt">/&gt;</span>
</span>    <span class="nt">&lt;/collection&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<div class="figure align-center" id="id88">
<a class="reference internal image-reference" href="../../_images/dataaccess_resultmap_coupon.png"><img alt="ResultMap for Coupon" src="../../_images/dataaccess_resultmap_coupon.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - ResultMap for Coupon</strong></span></p>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>取得したレコードの<code class="docutils literal"><span class="pre">coupon_code</span></code>カラムの値を、<code class="docutils literal"><span class="pre">Coupon#code</span></code>に設定する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>取得したレコードの<code class="docutils literal"><span class="pre">coupon_name</span></code>カラムの値を、<code class="docutils literal"><span class="pre">Coupon#name</span></code>に設定する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>取得したレコードの<code class="docutils literal"><span class="pre">coupon_price</span></code>カラムの値を、<code class="docutils literal"><span class="pre">Coupon#price</span></code>に設定する。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">Coupon</span></code>オブジェクトには、
<code class="docutils literal"><span class="pre">id</span></code>カラムと<code class="docutils literal"><span class="pre">coupon_code</span></code>カラムでグループ化されたレコードの値が設定される。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3appendixacquirerelatedobjectsatonceobject">
<span id="id71"></span><h5>6.2.4.4.5.8. マッピング後のオブジェクト図<a class="headerlink" href="#dataaccessmybatis3appendixacquirerelatedobjectsatonceobject" title="Permalink to this headline">¶</a></h5>
<p>実際にマッピングされた<code class="docutils literal"><span class="pre">Order</span></code>オブジェクトおよび関連Entityの状態は、以下の通りである。</p>
<blockquote>
<div><div class="figure align-center" id="id89">
<a class="reference internal image-reference" href="../../_images/dataaccess_object.png"><img alt="Mapped object diagram" src="../../_images/dataaccess_object.png" style="width: 90%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Mapped object diagram</strong></span></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">Order</span></code>オブジェクトにマッピングされたレコードとカラムは、以下の通りである。</div>
<div class="line">グレーアウトしている部分は、グループ化によって、グレーアウトされていない部分にマージされる。</div>
</div>
<blockquote>
<div><div class="figure align-center" id="id90">
<a class="reference internal image-reference" href="../../_images/dataaccess_sql_result_used.png"><img alt="Valid Result Set" src="../../_images/dataaccess_sql_result_used.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Valid Result Set</strong></span></p>
</div>
</div></blockquote>
<blockquote id="dataaccessmybatis3appendixacquirerelatedobjectswarningsqlmapping">
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>1:Nの関連をもつレコードをJOINしてマッピングする場合、グレーアウトされている部分のデータの取得が無駄になる点を、意識しておくこと。</p>
<p class="last">Nの部分のデータを使用しない処理で、同じSQLを使用した場合、さらに無駄なデータの取得となってしまうので、Nの部分を取得するSQLと、取得しないSQLを、別々に用意しておくなどの工夫を行うこと。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="entitysql">
<span id="dataaccessmybatis3appendixnestedselect"></span><h3><a class="toc-backref" href="#id166">6.2.4.5. 関連EntityをネストしたSQLを使用して取得する方法について</a><a class="headerlink" href="#entitysql" title="Permalink to this headline">¶</a></h3>
<p>MyBatis3では、マッピング時に別のSQL(ネストしたSQL)を使用して関連Entityを取得する方法を提供している。</p>
<p>ネストしたSQLを使用して関連Entityを取得する仕組みを使用すると、</p>
<ul class="simple">
<li>個々のSQL定義</li>
<li><code class="docutils literal"><span class="pre">resultMap</span></code>要素のマッピング定義</li>
</ul>
<p>をシンプルにする事ができる。</p>
<blockquote>
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>各種定義がシンプルになる一方で、ネストしたSQLを多用すると、
N+1問題を引き起こす要因になるという事を意識する必要がある。</p>
<p>ネストしたSQLを使用する場合のMyBatisのデフォルトの動作は、”Eager Load”となる。
これは、関連Entityの使用有無に関係なくSQLが発行される事を意味しており、</p>
<ul class="simple">
<li>無駄なSQLの実行とデータの取得</li>
<li>N+1問題</li>
</ul>
<p class="last">などが発生する危険性が高まる。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>MyBatis3では、ネストしたSQLを使用して関連Entityを取得する際の動作を、
“Lazy Load”に変更するためのオプションを提供している。</p>
<p class="last">“Lazy Load”の使用方法については、「<a class="reference internal" href="#dataaccessmybatis3appendixnestedselectlazysetting"><span class="std std-ref">関連EntityをLazy Loadするための設定</span></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="dataaccessmybatis3appendixnestedselectmapping">
<span id="id72"></span><h4><a class="toc-backref" href="#id167">6.2.4.5.1. 関連EntityをネストしたSQLを使用して取得する実装例</a><a class="headerlink" href="#dataaccessmybatis3appendixnestedselectmapping" title="Permalink to this headline">¶</a></h4>
<p>ネストしたSQLを使用して関連Entityを取得する際の実装例を以下に示す。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;itemResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Item&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;code&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;item_name&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;price&quot;</span> <span class="na">column=</span><span class="s">&quot;item_price&quot;</span><span class="nt">/&gt;</span>
<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;categories&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span>
</span><span class="hll">        <span class="na">select=</span><span class="s">&quot;findAllCategoryByItemCode&quot;</span> <span class="nt">/&gt;</span>
</span><span class="nt">&lt;/resultMap&gt;</span>

<span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAllCategoryByItemCode&quot;</span>
    <span class="na">parameterType=</span><span class="s">&quot;string&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Category&quot;</span><span class="nt">&gt;</span>
    SELECT
        ct.code,
        ct.name
    FROM
        m_item_category ic
    INNER JOIN m_category ct ON ct.code = ic.category_code
    WHERE
        ic.item_code = #{itemCode}
    ORDER BY
        code
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">association</span></code>要素又は<code class="docutils literal"><span class="pre">collection</span></code>要素の<code class="docutils literal"><span class="pre">select</span></code>属性に、
呼び出すSQLのステートメントIDを指定する。</p>
<p><code class="docutils literal"><span class="pre">column</span></code>属性には、SQLに渡すパラメータ値が格納されているカラム名を指定する。
上記例では、
<code class="docutils literal"><span class="pre">findAllCategoryByItemCode</span></code>のパラメータとして<code class="docutils literal"><span class="pre">item_code</span></code>カラムの値を渡している。</p>
<p class="last">指定可能な属性の詳細は、
「<a class="reference external" href="https://mybatis.org/mybatis-3/sqlmap-xml.html#Nested_Select_for_Association">MyBatis3 REFERENCE DOCUMENTATION(Mapper XML Files-Nested Select for Association-)</a>」を参照されたい。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>上記例では、<code class="docutils literal"><span class="pre">fetchType</span></code>属性を指定していないため、
“Lazy Load”と”Eager Load”のどちらで実行されるかは、
アプリケーション全体の設定に依存する。</p>
<p class="last">アプリケーション全体の設定については、
「<a class="reference internal" href="#dataaccessmybatis3appendixnestedselectlazysettingmybatis"><span class="std std-ref">Lazy Loadを使用するためのMyBatisの設定</span></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="entitylazy-load">
<span id="dataaccessmybatis3appendixnestedselectlazysetting"></span><h4><a class="toc-backref" href="#id168">6.2.4.5.2. 関連EntityをLazy Loadするための設定</a><a class="headerlink" href="#entitylazy-load" title="Permalink to this headline">¶</a></h4>
<p>ネストしたSQLを使用して関連Entityを取得する際のMyBatis3のデフォルト動作は、
“Eager Load”であるが、”Lazy Load”を使用する事も可能である。</p>
<p>以下に、”Lazy Load”を使用するために最低限必要な設定及び使用方法について説明を行う。</p>
<p>説明していない設定値については、
「<a class="reference external" href="https://mybatis.org/mybatis-3/configuration.html#settings">MyBatis3 REFERENCE DOCUMENTATION(Mapper XML Files-settings-)</a>」を参照されたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="dataaccessmybatis3appendixnestedselectlazysettinglibrary">
<span id="id73"></span><h5>6.2.4.5.2.1. バイトコード操作ライブラリの追加<a class="headerlink" href="#dataaccessmybatis3appendixnestedselectlazysettinglibrary" title="Permalink to this headline">¶</a></h5>
<p>“Lazy Load”を使用する場合は、”Lazy Load”を実現するためのProxyオブジェクトを生成するために、</p>
<ul class="simple">
<li>JAVASSIST</li>
<li>CGLIB</li>
</ul>
<p>のいずれか一方のライブラリが必要となる。</p>
<p>MyBatis 3.2系まではCGLIBがデフォルトで使用されるライブラリであったが、MyBatis 3.3.0以降のバージョンではJAVASSISTがデフォルトで使用される。
さらに、MyBatis 3.3.0からJAVASSISTがMyBatis本体に内包されているため、ライブラリを追加しなくても”Lazy Load”を使用する事ができる。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>MyBatis 3.3.0以降のバージョンでCGLIBを使用する場合は、</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">pom.xml</span></code>にCGLIBのアーティファクトを追加</li>
<li>MyBatis設定ファイル(<code class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/mybatis/mybatis-config.xml</span></code>)に「<code class="docutils literal"><span class="pre">proxyFactory=CGLIB</span></code>」を追加</li>
</ul>
<p>すればよい。</p>
<p class="last">CGLIBのアーティファクト情報については、
「<a class="reference external" href="https://mybatis.org/mybatis-3/dependencies.html#compile">MyBatis3 PROJECT DOCUMENTATION(Project Dependencies-compile-)</a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="lazy-loadmybatis">
<span id="dataaccessmybatis3appendixnestedselectlazysettingmybatis"></span><h5>6.2.4.5.2.2. Lazy Loadを使用するためのMyBatisの設定<a class="headerlink" href="#lazy-loadmybatis" title="Permalink to this headline">¶</a></h5>
<p>MyBatis3では、”Lazy Load”の使用有無を、</p>
<ul class="simple">
<li>アプリケーションの全体設定(MyBatis設定ファイル)</li>
<li>個別設定(マッピングファイル)</li>
</ul>
<p>の2箇所で指定する事ができる。</p>
<ul class="simple">
<li>アプリケーションの全体設定は、
MyBatis設定ファイル(<code class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/mybatis/mybatis-config.xml</span></code>)に指定する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE configuration</span>
<span class="cp">        PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span>
<span class="cp">        &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
    <span class="nt">&lt;settings&gt;</span>
        <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;setting</span> <span class="na">name=</span><span class="s">&quot;lazyLoadingEnabled&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/settings&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">アプリケーションのデフォルト動作を<code class="docutils literal"><span class="pre">lazyLoadingEnabled</span></code>に指定する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">true</span></code>: “Lazy Load”</li>
<li><code class="docutils literal"><span class="pre">false</span></code>: “Eager Load” (デフォルト)</li>
</ul>
<p class="last"><code class="docutils literal"><span class="pre">association</span></code>要素と<code class="docutils literal"><span class="pre">collection</span></code>要素の<code class="docutils literal"><span class="pre">fetchType</span></code>属性を指定した場合は、
<code class="docutils literal"><span class="pre">fetchType</span></code>属性の指定値が優先される。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>「<code class="docutils literal"><span class="pre">false</span></code>: “Eager Load”」の状態で<code class="docutils literal"><span class="pre">association</span></code>要素又は<code class="docutils literal"><span class="pre">collection</span></code>要素の<code class="docutils literal"><span class="pre">select</span></code>属性を使用すると、
マッピング時にSQLが実行されるので、注意が必要である。</p>
<p class="last">特に理由がない場合は、<code class="docutils literal"><span class="pre">lazyLoadingEnabled</span></code>は<code class="docutils literal"><span class="pre">true</span></code>にする事を推奨する。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>個別設定は、
マッピングファイルの<code class="docutils literal"><span class="pre">association</span></code>要素と<code class="docutils literal"><span class="pre">collection</span></code>要素の<code class="docutils literal"><span class="pre">fetchType</span></code>属性で指定する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span>    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;itemResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Item&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;code&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;item_name&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;price&quot;</span> <span class="na">column=</span><span class="s">&quot;item_price&quot;</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;categories&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span>
<span class="hll">            <span class="na">fetchType=</span><span class="s">&quot;lazy&quot;</span>
</span>            <span class="na">select=</span><span class="s">&quot;findAllCategoryByItemCode&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/resultMap&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAllCategoryByItemCode&quot;</span>
        <span class="na">parameterType=</span><span class="s">&quot;string&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Category&quot;</span><span class="nt">&gt;</span>
        SELECT
            ct.code,
            ct.name
        FROM
            m_item_category ic
        INNER JOIN m_category ct ON ct.code = ic.category_code
        WHERE
            ic.item_code = #{itemCode}
        ORDER BY
            code
    <span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">association</span></code>要素又は<code class="docutils literal"><span class="pre">collection</span></code>要素の<code class="docutils literal"><span class="pre">fetchType</span></code>属性に、
<code class="docutils literal"><span class="pre">lazy</span></code>又は<code class="docutils literal"><span class="pre">eager</span></code>を指定する。</p>
<p class="last"><code class="docutils literal"><span class="pre">fetchType</span></code>属性を指定すると、アプリケーション全体の設定を上書きする事ができる。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="lazy-load">
<span id="dataaccessmybatis3appendixnestedselectlazysettingtiming"></span><h5>6.2.4.5.2.3. Lazy Loadの実行タイミングを制御するための設定<a class="headerlink" href="#lazy-load" title="Permalink to this headline">¶</a></h5>
<p>MyBatis3では、”Lazy Load”を実行するタイミングを制御するためのオプション(<code class="docutils literal"><span class="pre">aggressiveLazyLoading</span></code>)を提供している <a class="footnote-reference" href="#fdataaccessmybatis31" id="id74">[1]</a> 。</p>
<p>このオプションのデフォルト値はMybatis 3.4.2以降から<code class="docutils literal"><span class="pre">false</span></code>であり、”Lazy Load”対象となっているプロパティのgetterメソッドが呼び出されたタイミングで実行する。</p>
<blockquote>
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><code class="docutils literal"><span class="pre">aggressiveLazyLoading</span></code>が「<code class="docutils literal"><span class="pre">true</span></code>」の場合、”Lazy Load”対象となっているプロパティを保持するオブジェクトのgetterメソッドが呼び出されたタイミングで”Lazy Load”が実行される。
このため、実際にはデータの取得が必要ないにもかかわらずSQLが実行されてしまう可能性があることに注意が必要である。</p>
<p>具体的には、以下のようなマッピングを行い、
“Lazy Load”対象になっていないプロパティだけにアクセスするケースである。
「<code class="docutils literal"><span class="pre">true</span></code>」の場合、”Lazy Load”対象のプロパティに対して直接アクセスしなくても、
“Lazy Load”が実行されてしまう。</p>
<p>特に理由がない場合は、<code class="docutils literal"><span class="pre">aggressiveLazyLoading</span></code>は「<code class="docutils literal"><span class="pre">false</span></code>」(デフォルト)のまま変更しないことを推奨する。</p>
<ul class="last">
<li><p class="first">Entity</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Item</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">code</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="p">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">price</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="n">categories</span><span class="p">;</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">マッピングファイル</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;itemResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Item&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;code&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;item_name&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;price&quot;</span> <span class="na">column=</span><span class="s">&quot;item_price&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;categories&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span>
        <span class="na">fetchType=</span><span class="s">&quot;lazy&quot;</span> <span class="na">select=</span><span class="s">&quot;findByItemCode&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first">アプリケーションコード(Service)</p>
<div class="highlight-java"><div class="highlight"><pre><span></span>    <span class="n">Item</span> <span class="n">item</span> <span class="o">=</span> <span class="n">itemRepository</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">itemCode</span><span class="p">);</span>
<span class="hll">    <span class="c1">// (1)</span>
</span><span class="hll">    <span class="n">String</span> <span class="n">code</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="na">getCode</span><span class="p">();</span>
</span>    <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="na">getName</span><span class="p">();</span>
    <span class="n">String</span> <span class="n">price</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="na">getPrice</span><span class="p">();</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="17%" />
<col width="83%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">上記例では、”Lazy Load”対象のプロパティである<code class="docutils literal"><span class="pre">categories</span></code>プロパティにアクセスしていないが、
<code class="docutils literal"><span class="pre">Item#code</span></code>プロパティにアクセスした際に、”Lazy Load”が実行される。</p>
<p class="last">「<code class="docutils literal"><span class="pre">false</span></code>」（デフォルト）の場合、上記のケースでは”Lazy Load”は実行されない。</p>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
</div></blockquote>
<table class="docutils footnote" frame="void" id="fdataaccessmybatis31" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id74">[1]</a></td><td>設定方法は、<a class="reference external" href="https://mybatis.org/mybatis-3/ja/configuration.html#settings">MyBatisのリファレンス</a> を参照されたい。</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="DataAccessJpa.html" title="6.3. データベースアクセス（JPA編）"
             >next</a> |</li>
        <li class="right" >
          <a href="DataAccessCommon.html" title="6.1. データベースアクセス（共通編）"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.7.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >6. データアクセス</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer">
      © Copyright 2013, NTT DATA Corporation. © Copyright 2013, NTT Corporation.
      Created using <a href="https://www.sphinx-doc.org/en/master/">Sphinx</a> 1.6.3.Theme is <a href="https://pypi.org/project/solar-theme/">Solar</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>

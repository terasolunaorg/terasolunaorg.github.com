<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>4.1. 入力チェック &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.5.1.RELEASE documentation</title>
    <link rel="stylesheet" href="../../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '5.5.1.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="4.2. 例外ハンドリング" href="ExceptionHandling.html" />
    <link rel="prev" title="4. Webアプリ開発機能" href="index.html" /><script src="../../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../../_static/solarized-dark.css" rel="stylesheet">
<link href="../../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ExceptionHandling.html" title="4.2. 例外ハンドリング"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="4. Webアプリ開発機能"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.5.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">4. Webアプリ開発機能</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">4.1. 入力チェック</a><ul>
<li><a class="reference internal" href="#overview">4.1.1. Overview</a><ul>
<li><a class="reference internal" href="#id3">4.1.1.1. 入力チェックの分類</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">4.1.2. How to use</a><ul>
<li><a class="reference internal" href="#validationadddependencylibrary">4.1.2.1. 依存ライブラリの追加</a></li>
<li><a class="reference internal" href="#validation-single-check">4.1.2.2. 単項目チェック</a><ul>
<li><a class="reference internal" href="#validation-basic-validation">4.1.2.2.1. 基本的な単項目チェック</a></li>
<li><a class="reference internal" href="#id7">4.1.2.2.2. 日時フォーマットのチェック</a></li>
<li><a class="reference internal" href="#bean">4.1.2.2.3. ネストしたBeanの単項目チェック</a></li>
<li><a class="reference internal" href="#id8">4.1.2.2.4. コレクション内の値のチェック</a></li>
<li><a class="reference internal" href="#validationgroupvalidation">4.1.2.2.5. バリデーションのグループ化</a></li>
</ul>
</li>
<li><a class="reference internal" href="#validation-correlation-check">4.1.2.3. 相関項目チェック</a><ul>
<li><a class="reference internal" href="#spring-validator">4.1.2.3.1. Spring Validatorによる相関項目チェック実装</a></li>
<li><a class="reference internal" href="#bean-validation">4.1.2.3.2. Bean Validationによる相関項目チェック実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#validation-message-def">4.1.2.4. エラーメッセージの定義</a><ul>
<li><a class="reference internal" href="#validationmessages-properties">4.1.2.4.1. ValidationMessages.propertiesに定義するメッセージ</a></li>
<li><a class="reference internal" href="#application-messages-properties">4.1.2.4.2. application-messages.propertiesに定義するメッセージ</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend">4.1.3. How to extend</a><ul>
<li><a class="reference internal" href="#validation-convine-existing-constraint">4.1.3.1. 既存ルールを組み合わせたBean Validationアノテーションの作成</a></li>
<li><a class="reference internal" href="#validation-implement-new-constraint">4.1.3.2. 新規ルールを実装したBean Validationアノテーションの作成</a><ul>
<li><a class="reference internal" href="#validation-cannot-expressed-existing">4.1.3.2.1. 既存のルールの組み合わせでは表現できないルール</a></li>
<li><a class="reference internal" href="#validation-correlation-item-check">4.1.3.2.2. 相関項目チェックルール</a></li>
<li><a class="reference internal" href="#validation-business-logic-check">4.1.3.2.3. 業務ロジックチェック</a></li>
</ul>
</li>
<li><a class="reference internal" href="#method-validation">4.1.3.3. Method Validation</a><ul>
<li><a class="reference internal" href="#methodvalidationonspringframeworkhowtousesettings">4.1.3.3.1. アプリケーションの設定</a></li>
<li><a class="reference internal" href="#methodvalidationonspringframeworkhowtouseapplytarget">4.1.3.3.2. Method Validation対象のメソッドにするための定義方法</a></li>
<li><a class="reference internal" href="#methodvalidationonspringframeworkhowtouseexceptionhandling">4.1.3.3.3. 制約違反時の例外ハンドリング</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix">4.1.4. Appendix</a><ul>
<li><a class="reference internal" href="#id24">4.1.4.1. Hibernate Validatorが用意する入力チェックルール</a><ul>
<li><a class="reference internal" href="#validation-jsr380-doc">4.1.4.1.1. Bean Validationのチェックルール</a></li>
<li><a class="reference internal" href="#validation-validator-list">4.1.4.1.2. Hibernate Validatorのチェックルール</a></li>
</ul>
</li>
<li><a class="reference internal" href="#validation-default-message-in-hibernate-validator">4.1.4.2. Hibernate Validatorが用意するデフォルトメッセージ</a></li>
<li><a class="reference internal" href="#validation-terasoluna-gfw">4.1.4.3. 共通ライブラリが用意する入力チェックルール</a><ul>
<li><a class="reference internal" href="#terasoluna-gfw-common">4.1.4.3.1. terasoluna-gfw-commonのチェックルール</a></li>
<li><a class="reference internal" href="#terasoluna-gfw-codepoints">4.1.4.3.2. terasoluna-gfw-codepointsのチェックルール</a></li>
<li><a class="reference internal" href="#terasoluna-gfw-validator">4.1.4.3.3. terasoluna-gfw-validatorのチェックルール</a></li>
<li><a class="reference internal" href="#id34">4.1.4.3.4. 共通ライブラリのチェックルールの適用方法</a></li>
<li><a class="reference internal" href="#validation-terasoluna-gfw-how-to-extend">4.1.4.3.5. 共通ライブラリのチェックルールの拡張方法</a></li>
</ul>
</li>
<li><a class="reference internal" href="#validation-type-mismatch">4.1.4.4. 型のミスマッチ</a></li>
<li><a class="reference internal" href="#null">4.1.4.5. 文字列フィールドが未入力の場合にnullをバインドする</a></li>
<li><a class="reference internal" href="#native-to-ascii">4.1.4.6. Native to Asciiを行わないメッセージの読み込み</a></li>
<li><a class="reference internal" href="#os">4.1.4.7. OSコマンドインジェクション対策</a><ul>
<li><a class="reference internal" href="#id38">4.1.4.7.1. OSコマンドインジェクションとは</a></li>
<li><a class="reference internal" href="#id40">4.1.4.7.2. 対策方法</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">4. Webアプリ開発機能</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="ExceptionHandling.html"
                        title="next chapter">4.2. 例外ハンドリング</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/ArchitectureInDetail/WebApplicationDetail/Validation.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="id1">
<h1><a class="toc-backref" href="#id41">4.1. 入力チェック</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<div class="admonition caution">
  <p class="first admonition-title">Caution</p>
  <p><strong>本バージョンの内容は既に古くなっています</strong>。最新のガイドラインは<a href="http://terasolunaorg.github.io/guideline/">こちら</a>からご参照ください。</p>
</div>
<div class="contents topic" id="id2">
<p class="topic-title first">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#id1" id="id41">入力チェック</a><ul>
<li><a class="reference internal" href="#overview" id="id42">Overview</a><ul>
<li><a class="reference internal" href="#id3" id="id43">入力チェックの分類</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use" id="id44">How to use</a><ul>
<li><a class="reference internal" href="#validationadddependencylibrary" id="id45">依存ライブラリの追加</a></li>
<li><a class="reference internal" href="#validation-single-check" id="id46">単項目チェック</a><ul>
<li><a class="reference internal" href="#validation-basic-validation" id="id47">基本的な単項目チェック</a></li>
<li><a class="reference internal" href="#id7" id="id48">日時フォーマットのチェック</a></li>
<li><a class="reference internal" href="#bean" id="id49">ネストしたBeanの単項目チェック</a></li>
<li><a class="reference internal" href="#id8" id="id50">コレクション内の値のチェック</a></li>
<li><a class="reference internal" href="#validationgroupvalidation" id="id51">バリデーションのグループ化</a></li>
</ul>
</li>
<li><a class="reference internal" href="#validation-correlation-check" id="id52">相関項目チェック</a><ul>
<li><a class="reference internal" href="#spring-validator" id="id53">Spring Validatorによる相関項目チェック実装</a></li>
<li><a class="reference internal" href="#bean-validation" id="id54">Bean Validationによる相関項目チェック実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#validation-message-def" id="id55">エラーメッセージの定義</a><ul>
<li><a class="reference internal" href="#validationmessages-properties" id="id56">ValidationMessages.propertiesに定義するメッセージ</a></li>
<li><a class="reference internal" href="#application-messages-properties" id="id57">application-messages.propertiesに定義するメッセージ</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend" id="id58">How to extend</a><ul>
<li><a class="reference internal" href="#validation-convine-existing-constraint" id="id59">既存ルールを組み合わせたBean Validationアノテーションの作成</a></li>
<li><a class="reference internal" href="#validation-implement-new-constraint" id="id60">新規ルールを実装したBean Validationアノテーションの作成</a><ul>
<li><a class="reference internal" href="#validation-cannot-expressed-existing" id="id61">既存のルールの組み合わせでは表現できないルール</a></li>
<li><a class="reference internal" href="#validation-correlation-item-check" id="id62">相関項目チェックルール</a></li>
<li><a class="reference internal" href="#validation-business-logic-check" id="id63">業務ロジックチェック</a></li>
</ul>
</li>
<li><a class="reference internal" href="#method-validation" id="id64">Method Validation</a><ul>
<li><a class="reference internal" href="#methodvalidationonspringframeworkhowtousesettings" id="id65">アプリケーションの設定</a></li>
<li><a class="reference internal" href="#methodvalidationonspringframeworkhowtouseapplytarget" id="id66">Method Validation対象のメソッドにするための定義方法</a></li>
<li><a class="reference internal" href="#methodvalidationonspringframeworkhowtouseexceptionhandling" id="id67">制約違反時の例外ハンドリング</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix" id="id68">Appendix</a><ul>
<li><a class="reference internal" href="#id24" id="id69">Hibernate Validatorが用意する入力チェックルール</a><ul>
<li><a class="reference internal" href="#validation-jsr380-doc" id="id70">Bean Validationのチェックルール</a></li>
<li><a class="reference internal" href="#validation-validator-list" id="id71">Hibernate Validatorのチェックルール</a></li>
</ul>
</li>
<li><a class="reference internal" href="#validation-default-message-in-hibernate-validator" id="id72">Hibernate Validatorが用意するデフォルトメッセージ</a></li>
<li><a class="reference internal" href="#validation-terasoluna-gfw" id="id73">共通ライブラリが用意する入力チェックルール</a><ul>
<li><a class="reference internal" href="#terasoluna-gfw-common" id="id74">terasoluna-gfw-commonのチェックルール</a></li>
<li><a class="reference internal" href="#terasoluna-gfw-codepoints" id="id75">terasoluna-gfw-codepointsのチェックルール</a></li>
<li><a class="reference internal" href="#terasoluna-gfw-validator" id="id76">terasoluna-gfw-validatorのチェックルール</a></li>
<li><a class="reference internal" href="#id34" id="id77">共通ライブラリのチェックルールの適用方法</a></li>
<li><a class="reference internal" href="#validation-terasoluna-gfw-how-to-extend" id="id78">共通ライブラリのチェックルールの拡張方法</a></li>
</ul>
</li>
<li><a class="reference internal" href="#validation-type-mismatch" id="id79">型のミスマッチ</a></li>
<li><a class="reference internal" href="#null" id="id80">文字列フィールドが未入力の場合にnullをバインドする</a></li>
<li><a class="reference internal" href="#native-to-ascii" id="id81">Native to Asciiを行わないメッセージの読み込み</a></li>
<li><a class="reference internal" href="#os" id="id82">OSコマンドインジェクション対策</a><ul>
<li><a class="reference internal" href="#id38" id="id83">OSコマンドインジェクションとは</a></li>
<li><a class="reference internal" href="#id40" id="id84">対策方法</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id42">4.1.1. Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>ユーザーが入力した値が不正かどうかを検証することは必須である。
入力値の検証は大きく分けて、</p>
<ol class="arabic simple">
<li>長さや形式など、文脈によらず入力値だけを見て、それが妥当かどうかを判定できる検証</li>
<li>システムの状態によって入力値が妥当かどうかが変わる検証</li>
</ol>
<p>がある。</p>
<p>1.の例としては必須チェックや、桁数チェックがあり、2.の例としては
登録済みのE-mailかどうかのチェックや、注文数が在庫数以内であるかどうかのチェックが挙げられる。</p>
<p>本節では、基本的には前者のことを説明し、このチェックのことを「入力チェック」を呼ぶ。
後者のチェックは「業務ロジックチェック」と呼ぶ。業務ロジックチェックについては
<a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html"><span class="doc">ドメイン層の実装</span></a>を参照されたい。</p>
<p>本ガイドラインでは、基本的に入力チェックをアプリケーション層で行い、
業務ロジックチェックは、ドメイン層で行うことをポリシーとする。</p>
<p>Webアプリケーションの入力チェックには、サーバサイドで行うチェックと、クライアントサイド(JavaScript)で行うチェックがある。
サーバーサイドのチェックは必須であるが、クライアントサイドでも同じチェックを実施すると、
サーバー通信なしでチェック結果が分かるため、ユーザビリティが向上する。</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">JavaScriptによるクライアントサイドの処理は、改ざん可能であるため、サーバーサイドのチェックは、必ず行うこと。
クライアントサイドのみでチェックを行い、サーバーサイドでチェックを省略した場合は、システムが危険な状態に晒されていることになる。</p>
</div>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id43">4.1.1.1. 入力チェックの分類</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>入力チェックは、単項目チェック、相関項目チェックに分類される。</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="15%" />
<col width="30%" />
<col width="25%" />
<col width="30%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">種類</th>
<th class="head">説明</th>
<th class="head">例</th>
<th class="head">実現方法</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>単項目チェック</td>
<td><div class="first last line-block">
<div class="line">単一のフィールドで完結するチェック</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力必須チェック</div>
<div class="line">桁チェック</div>
<div class="line">型チェック</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Bean Validation (実装ライブラリとしてHibernate Validatorを使用)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td>相関項目チェック</td>
<td><div class="first last line-block">
<div class="line">複数のフィールドを比較するチェック</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワードと確認用パスワードの一致チェック</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="https://docs.spring.io/spring/docs/5.1.4.RELEASE/spring-framework-reference/core.html#validator">org.springframework.validation.Validator</a>インタフェースを実装したValidationクラス</div>
<div class="line">または Bean Validation</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Spring は、Java標準であるBean Validationをサポートしている。
単項目チェックには、このBean Validationを利用する。
相関項目チェックの場合は、Bean ValidationまたはSpringが提供している<code class="docutils literal"><span class="pre">org.springframework.validation.Validator</span></code>インタフェースを利用する。</p>
</div>
</div>
<div class="section" id="how-to-use">
<span id="validation-how-to-use"></span><h2><a class="toc-backref" href="#id44">4.1.2. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<div class="section" id="validationadddependencylibrary">
<span id="id4"></span><h3><a class="toc-backref" href="#id45">4.1.2.1. 依存ライブラリの追加</a><a class="headerlink" href="#validationadddependencylibrary" title="Permalink to this headline">¶</a></h3>
<p>Bean Validation 2.0(Hibernate Validator 6.x)以上を使用する場合、
Bean ValidationのAPI仕様クラス(<code class="docutils literal"><span class="pre">javax.validation</span></code>パッケージのクラス)が格納されているjarファイルとHibernate Validatorのjarファイルに加えて、</p>
<ul class="simple">
<li>Expression Language 3.0以上のAPI仕様クラス (<code class="docutils literal"><span class="pre">javax.el</span></code>パッケージのクラス)</li>
<li>Expression Language 3.0以上のリファレンス実装クラス</li>
</ul>
<p>が格納されているライブラリが必要となる。</p>
<p>アプリケーションサーバにデプロイして動かす場合は、
これらのライブラリはアプリケーションサーバから提供されているため、
依存ライブラリの追加は不要である。
ただし、スタンドアロン環境(JUnitなど)で動かす場合は、これらのライブラリを依存ライブラリとして追加する必要がある。</p>
<p>スタンドアロン環境でBean Validation 2.0以上を動かす際に必要となるライブラリの追加例を以下に示す。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.apache.tomcat.embed<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>tomcat-embed-el<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p class="first">スタンドアロン環境で動かすプロジェクトの <code class="file docutils literal"><span class="pre">pom.xml</span></code> ファイルに、
Expression Language用のクラスが格納されているライブラリを追加する。</p>
<p class="last">上記例では、組込み用のApache Tomcat向けに提供されているライブラリを指定している。
<code class="docutils literal"><span class="pre">tomcat-embed-el</span></code>のjarファイルには、Expression LanguageのAPI仕様クラスとリファレンス実装クラスの両方が格納されている。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>JUnitを実行するために依存ライブラリが必要になる場合は、スコープは <code class="docutils literal"><span class="pre">test</span></code>が適切である。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">上記設定例は、依存ライブラリのバージョンを親プロジェクトである terasoluna-gfw-parent で管理する前提であるため、pom.xmlでのバージョンの指定は不要である。</p>
</div>
</div>
<div class="section" id="validation-single-check">
<span id="id5"></span><h3><a class="toc-backref" href="#id46">4.1.2.2. 単項目チェック</a><a class="headerlink" href="#validation-single-check" title="Permalink to this headline">¶</a></h3>
<p>単項目チェックを実装するには、</p>
<ul class="simple">
<li>フォームクラスのフィールドに、Bean Validation用のアノテーションを付与する</li>
<li>Controllerに、検証するための<code class="docutils literal"><span class="pre">&#64;Validated</span></code>アノテーションを付与する</li>
<li>JSPに、検証エラーメッセージを表示するためのタグを追加する</li>
</ul>
<p>が必要である。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">spring-mvc.xmlに<code class="docutils literal"><span class="pre">&lt;mvc:annotation-driven&gt;</span></code>の設定が行われていれば、Bean Validationは有効になる。</p>
</div>
<div class="section" id="validation-basic-validation">
<span id="id6"></span><h4><a class="toc-backref" href="#id47">4.1.2.2.1. 基本的な単項目チェック</a><a class="headerlink" href="#validation-basic-validation" title="Permalink to this headline">¶</a></h4>
<p>「新規ユーザー登録」処理を例に用いて、実装方法を説明する。ここでは「新規ユーザー登録」のフォームに、以下のチェックルールを設ける。</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="20%" />
<col width="30%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">フィールド名</th>
<th class="head">型</th>
<th class="head">ルール</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">name</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">java.lang.String</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力必須</div>
<div class="line">1文字以上</div>
<div class="line">20文字以下</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">email</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">java.lang.String</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力必須</div>
<div class="line">1文字以上</div>
<div class="line">50文字以下</div>
<div class="line">E-mail形式</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">age</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">java.lang.Integer</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力必須</div>
<div class="line">1以上</div>
<div class="line">200以下</div>
</div>
</td>
</tr>
</tbody>
</table>
<ul>
<li><p class="first">フォームクラス</p>
<p>フォームクラスの各フィールドに、Bean Validationのアノテーションを付ける。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.sample.app.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.constraints.Email</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Max</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Min</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

  <span class="nd">@NotNull</span> <span class="c1">// (1)</span>
  <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">20</span><span class="o">)</span> <span class="c1">// (2)</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

  <span class="nd">@NotNull</span>
  <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">50</span><span class="o">)</span>
  <span class="nd">@Email</span> <span class="c1">// (3)</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>

  <span class="nd">@NotNull</span> <span class="c1">// (4)</span>
  <span class="nd">@Min</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="c1">// (5)</span>
  <span class="nd">@Max</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span> <span class="c1">// (6)</span>
  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">age</span><span class="o">;</span>

  <span class="c1">// omitted setter/getter</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">対象のフィールドが<code class="docutils literal"><span class="pre">null</span></code>でないことを示す<code class="docutils literal"><span class="pre">javax.validation.constraints.NotNull</span></code>を付ける。</div>
<div class="line"><br /></div>
<div class="line">Spring MVCでは、文字列の入力フィールドに未入力の状態でフォームを送信した場合、</div>
<div class="line">デフォルトではフォームオブジェクトに<strong>nullではなく、空文字がバインドされる</strong>。</div>
<div class="line">この<code class="docutils literal"><span class="pre">&#64;NotNull</span></code>は、そもそもリクエストパラメータとして<code class="docutils literal"><span class="pre">name</span></code>が存在することをチェックする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">対象のフィールドの文字列長(またはコレクションのサイズ)が指定したサイズの範囲内にあることを示す<code class="docutils literal"><span class="pre">javax.validation.constraints.Size</span></code>を付ける。</div>
<div class="line"><br /></div>
<div class="line">上記の通り、Spring MVCではデフォルトで、未入力の文字列フィールドには、空文字がバインドされるため、</div>
<div class="line">1文字以上というルールが入力必須を表す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">対象のフィールドがE-mail形式であることを示す<code class="docutils literal"><span class="pre">javax.validation.constraints.Email</span></code>を付ける。</div>
<div class="line">E-mail形式の要件が<code class="docutils literal"><span class="pre">&#64;Email</span></code> のチェックと合致しない場合は、<code class="docutils literal"><span class="pre">javax.validation.constraints.Pattern</span></code>を用いて、正規表現を指定する必要がある。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;Email</span></code> については、<a class="reference internal" href="#validation-jsr380-doc"><span class="std std-ref">Bean Validationのチェックルール</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">数値の入力フィールドに未入力の状態でフォームを送信した場合、フォームオブジェクトに<code class="docutils literal"><span class="pre">null</span></code> がバインドされるため、<code class="docutils literal"><span class="pre">&#64;NotNull</span></code>が<code class="docutils literal"><span class="pre">age</span></code>の入力必須条件を表す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">対象のフィールドが指定した数値の以上であることを示す<code class="docutils literal"><span class="pre">javax.validation.constraints.Min</span></code>を付ける。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">対象のフィールドが指定した数値の以下であることを示す<code class="docutils literal"><span class="pre">javax.validation.constraints.Max</span></code>を付ける。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Bean Validation標準のアノテーション、Hibernate Validationが用意しているアノテーションについては、<a class="reference internal" href="#validation-jsr380-doc"><span class="std std-ref">Bean Validationのチェックルール</span></a>、<a class="reference internal" href="#validation-validator-list"><span class="std std-ref">Hibernate Validatorのチェックルール</span></a>を参照されたい。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">入力フィールドが未入力の場合に、空文字ではなく<code class="docutils literal"><span class="pre">null</span></code>にバインドする方法に関しては、<a class="reference internal" href="#validation-string-trimmer-editor"><span class="std std-ref">文字列フィールドが未入力の場合にnullをバインドする</span></a>を参照されたい。</p>
</div>
</li>
<li><p class="first">Controllerクラス</p>
<p>入力チェック対象のフォームクラスに、<code class="docutils literal"><span class="pre">&#64;Validated</span></code>を付ける。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.sample.app.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.BindingResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ModelAttribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>

  <span class="nd">@ModelAttribute</span>
  <span class="kd">public</span> <span class="n">UserForm</span> <span class="nf">setupForm</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">UserForm</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form&quot;</span><span class="o">)</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">createForm</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="s">&quot;user/createForm&quot;</span><span class="o">;</span> <span class="c1">// (1)</span>
  <span class="o">}</span>

  <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;confirm&quot;</span><span class="o">)</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">createConfirm</span><span class="o">(</span><span class="nd">@Validated</span> <span class="cm">/* (2) */</span> <span class="n">UserForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="cm">/* (3) */</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// (4)</span>
      <span class="k">return</span> <span class="s">&quot;user/createForm&quot;</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="s">&quot;user/createConfirm&quot;</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">create</span><span class="o">(</span><span class="nd">@Validated</span> <span class="n">UserForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (5)</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">return</span> <span class="s">&quot;user/createForm&quot;</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// omitted business logic</span>
    <span class="k">return</span> <span class="s">&quot;redirect:/user/create?complete&quot;</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;complete&quot;</span><span class="o">)</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">createComplete</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="s">&quot;user/createComplete&quot;</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">「新規ユーザー登録」フォーム画面を表示する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フォームにつけたアノテーションで入力チェックをするために、フォームの引数に <code class="docutils literal"><span class="pre">org.springframework.validation.annotation.Validated</span></code>を付ける。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(2)のチェック結果を格納する<code class="docutils literal"><span class="pre">org.springframework.validation.BindingResult</span></code>を、引数に加える。</div>
<div class="line">この<code class="docutils literal"><span class="pre">BindingResult</span></code>は、フォームの直後に記述する必要がある。</div>
<div class="line"><br /></div>
<div class="line">直後に指定されていない場合は、検証後に結果をバインドできず、<code class="docutils literal"><span class="pre">org.springframework.validation.BindException</span></code>がスローされる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(2)のチェック結果は、<code class="docutils literal"><span class="pre">BindingResult.hasErrors()</span></code>メソッドで判定できる。</div>
<div class="line"><code class="docutils literal"><span class="pre">hasErrors()</span></code>の結果が<code class="docutils literal"><span class="pre">true</span></code>の場合は、入力値に問題があるため、フォーム表示画面に戻す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力内容確認画面から新規作成処理にリクエストを送る際にも、<strong>入力チェックを必ず再実行すること</strong>。</div>
<div class="line">途中でデータを改ざんすることは可能であるため、必ず業務処理の直前で入力チェックは必要である。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">&#64;Validated</span></code>は、Bean Validation標準ではなく、Springの独自アノテーションである。
Bean Validation標準の<code class="docutils literal"><span class="pre">javax.validation.Valid</span></code>アノテーションも使用できるが、<code class="docutils literal"><span class="pre">&#64;Validated</span></code>は<code class="docutils literal"><span class="pre">&#64;Valid</span></code>に比べて、
バリデーションのグループを指定できる点で優れているため、本ガイドラインではControllerの引数には、<code class="docutils literal"><span class="pre">&#64;Validated</span></code>を使用することを推奨する。</p>
</div>
</li>
</ul>
<ul id="validation-jsp-impl-sample">
<li><p class="first">JSP</p>
<p><code class="docutils literal"><span class="pre">&lt;form:errors&gt;</span></code>タグで、入力エラーがある場合にエラーメッセージを表示できる。</p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="k">&lt;%-</span><span class="o">-</span> <span class="n">WEB</span><span class="o">-</span><span class="n">INF</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">createForm</span><span class="o">.</span><span class="na">jsp</span> <span class="o">--</span><span class="k">%&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;form:form</span> <span class="na">modelAttribute=</span><span class="s">&quot;userForm&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span>
        <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/user/create&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>Name:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="nt">/&gt;</span><span class="k">&lt;%-</span><span class="o">-(</span><span class="mi">1</span><span class="o">)</span> <span class="o">--</span><span class="k">%&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span><span class="nt">&gt;</span>Email:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span><span class="nt">&gt;</span>Age:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;form:button</span> <span class="na">name=</span><span class="s">&quot;confirm&quot;</span><span class="nt">&gt;</span>Confirm<span class="nt">&lt;/form:button&gt;</span>
    <span class="nt">&lt;/form:form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;form:errors&gt;</span></code>タグの<code class="docutils literal"><span class="pre">path</span></code>属性に、対象のフィールド名を指定する。</div>
<div class="line">この例では、フィールド毎に入力フィールドの横にエラーメッセージを表示する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<p>フォームは、以下のように表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/validations-first-sample1.png"><img alt="../../_images/validations-first-sample1.png" src="../../_images/validations-first-sample1.png" style="width: 60%;" /></a>
</div>
<p>このフォームに対して、すべての入力フィールドを未入力のまま送信すると、以下のようにエラーメッセージが表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/validations-first-sample2.png"><img alt="../../_images/validations-first-sample2.png" src="../../_images/validations-first-sample2.png" style="width: 60%;" /></a>
</div>
<p>NameとEmailが空文字であることに対するエラーメッセージと、Ageが<code class="docutils literal"><span class="pre">null</span></code>であることに対するエラーメッセージが表示されている。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Bean Validationでは、通常、入力値が<code class="docutils literal"><span class="pre">null</span></code>の場合は正常な値とみなす。ただし、
以下のアノテーションを除く。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">javax.validation.constraints.NotNull</span></code></li>
<li><code class="docutils literal"><span class="pre">javax.validation.constraints.NotEmpty</span></code></li>
<li><code class="docutils literal"><span class="pre">javax.validation.constraints.NotBlank</span></code></li>
</ul>
<p class="last">上記の例では、Ageの値は<code class="docutils literal"><span class="pre">null</span></code>であるため、<code class="docutils literal"><span class="pre">&#64;Min</span></code>と<code class="docutils literal"><span class="pre">&#64;Max</span></code>によるチェックは正常とみなされ、
エラーメッセージは出力されていない。</p>
</div>
<p>次に、フィールドに何らかの値を入力してフォームを送信する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/validations-first-sample3.png"><img alt="../../_images/validations-first-sample3.png" src="../../_images/validations-first-sample3.png" style="width: 60%;" /></a>
</div>
<div class="line-block">
<div class="line">Nameの入力値は、チェック条件を満たすため、エラーメッセージが表示されない。</div>
<div class="line">E-mailの入力値は文字列長に関する条件は満たすが、E-mail形式ではないため、エラーメッセージが表示される。</div>
<div class="line">Ageの入力値は最大値を超えているため、エラーメッセージが表示される。</div>
</div>
<p>エラー時にスタイルを変更したい場合は、前述のフォームを、以下のように変更する。</p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;form:form</span> <span class="na">modelAttribute=</span><span class="s">&quot;userForm&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span>
    <span class="na">class=</span><span class="s">&quot;form-horizontal&quot;</span>
    <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/user/create&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Name:<span class="nt">&lt;/form:label&gt;</span><span class="k">&lt;%-</span><span class="o">-</span> <span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">--</span><span class="k">%&gt;</span>
    <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span><span class="k">&lt;%-</span><span class="o">-</span> <span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="o">--</span><span class="k">%&gt;</span>
    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span><span class="k">&lt;%-</span><span class="o">-</span> <span class="o">(</span><span class="mi">3</span><span class="o">)</span> <span class="o">--</span><span class="k">%&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Email:<span class="nt">&lt;/form:label&gt;</span>
    <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Age:<span class="nt">&lt;/form:label&gt;</span>
    <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;form:button</span> <span class="na">name=</span><span class="s">&quot;confirm&quot;</span><span class="nt">&gt;</span>Confirm<span class="nt">&lt;/form:button&gt;</span>
<span class="nt">&lt;/form:form&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラー時に<code class="docutils literal"><span class="pre">&lt;label&gt;</span></code>タグへ加えるクラス名を、<code class="docutils literal"><span class="pre">cssErrorClass</span></code>属性で指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラー時に<code class="docutils literal"><span class="pre">&lt;input&gt;</span></code>タグへ加えるクラス名を、<code class="docutils literal"><span class="pre">cssErrorClass</span></code>属性で指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラーメッセージに加えるクラス名を、<code class="docutils literal"><span class="pre">cssClass</span></code>属性で指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>このJSPに対して、例えば以下のCSSを適用すると、</p>
<div class="highlight-css"><div class="highlight"><pre><span></span><span class="p">.</span><span class="nc">form-horizontal</span> <span class="nt">input</span> <span class="p">{</span>
    <span class="k">display</span><span class="p">:</span> <span class="kc">block</span><span class="p">;</span>
    <span class="k">float</span><span class="p">:</span> <span class="kc">left</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">form-horizontal</span> <span class="nt">label</span> <span class="p">{</span>
    <span class="k">display</span><span class="p">:</span> <span class="kc">block</span><span class="p">;</span>
    <span class="k">float</span><span class="p">:</span> <span class="kc">left</span><span class="p">;</span>
    <span class="k">text-align</span><span class="p">:</span> <span class="kc">right</span><span class="p">;</span>
    <span class="k">float</span><span class="p">:</span> <span class="kc">left</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">form-horizontal</span> <span class="nt">br</span> <span class="p">{</span>
    <span class="k">clear</span><span class="p">:</span> <span class="kc">left</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">error-label</span> <span class="p">{</span>
    <span class="k">color</span><span class="p">:</span> <span class="mh">#b94a48</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">error-input</span> <span class="p">{</span>
    <span class="k">border-color</span><span class="p">:</span> <span class="mh">#b94a48</span><span class="p">;</span>
    <span class="k">margin-left</span><span class="p">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">error-messages</span> <span class="p">{</span>
    <span class="k">color</span><span class="p">:</span> <span class="mh">#b94a48</span><span class="p">;</span>
    <span class="k">display</span><span class="p">:</span> <span class="kc">block</span><span class="p">;</span>
    <span class="k">padding-left</span><span class="p">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
    <span class="k">overflow-x</span><span class="p">:</span> <span class="kc">auto</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>エラー画面は、以下のように表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/validations-has-errors1.png"><img alt="../../_images/validations-has-errors1.png" src="../../_images/validations-has-errors1.png" style="width: 60%;" /></a>
</div>
<p>画面の要件に応じてCSSをカスタマイズすればよい。</p>
<p>エラーメッセージを、入力フィールドの横に一件一件出力する代わりに、
まとめて出力することもできる。</p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;form:form</span> <span class="na">modelAttribute=</span><span class="s">&quot;userForm&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span>
    <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/user/create&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;*&quot;</span> <span class="na">element=</span><span class="s">&quot;div&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-message-list&quot;</span> <span class="nt">/&gt;</span><span class="k">&lt;%-</span><span class="o">-</span> <span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">--</span><span class="k">%&gt;</span>

    <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Name:<span class="nt">&lt;/form:label&gt;</span>
    <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Email:<span class="nt">&lt;/form:label&gt;</span>
    <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Age:<span class="nt">&lt;/form:label&gt;</span>
    <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;form:button</span> <span class="na">name=</span><span class="s">&quot;confirm&quot;</span><span class="nt">&gt;</span>Confirm<span class="nt">&lt;/form:button&gt;</span>
<span class="nt">&lt;/form:form&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;form:form&gt;</span></code>タグ内で、<code class="docutils literal"><span class="pre">&lt;form:errors&gt;</span></code>の<code class="docutils literal"><span class="pre">path</span></code>属性に”<code class="docutils literal"><span class="pre">*</span></code>” を指定することで、</div>
<div class="line"><code class="docutils literal"><span class="pre">&lt;form:form&gt;</span></code>の<code class="docutils literal"><span class="pre">modelAttribute</span></code>属性に指定したModelに関する全エラーメッセージを出力できる。</div>
<div class="line"><code class="docutils literal"><span class="pre">element</span></code>属性に、これらのエラーメッセージを包含するタグ名を指定できる。デフォルトでは、<code class="docutils literal"><span class="pre">span</span></code>であるが、</div>
<div class="line">ここではエラーメッセージ一覧をブロック要素として出力するために、<code class="docutils literal"><span class="pre">div</span></code>を指定する。</div>
<div class="line">また、CSSのクラスを <code class="docutils literal"><span class="pre">cssClass</span></code>属性に指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>例として、以下のCSSクラスを適用した場合の、エラーメッセージ出力例を示す。</p>
<div class="highlight-css"><div class="highlight"><pre><span></span><span class="p">.</span><span class="nc">form-horizontal</span> <span class="nt">input</span> <span class="p">{</span>
    <span class="k">display</span><span class="p">:</span> <span class="kc">block</span><span class="p">;</span>
    <span class="k">float</span><span class="p">:</span> <span class="kc">left</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">form-horizontal</span> <span class="nt">label</span> <span class="p">{</span>
    <span class="k">display</span><span class="p">:</span> <span class="kc">block</span><span class="p">;</span>
    <span class="k">float</span><span class="p">:</span> <span class="kc">left</span><span class="p">;</span>
    <span class="k">text-align</span><span class="p">:</span> <span class="kc">right</span><span class="p">;</span>
    <span class="k">float</span><span class="p">:</span> <span class="kc">left</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">form-horizontal</span> <span class="nt">br</span> <span class="p">{</span>
    <span class="k">clear</span><span class="p">:</span> <span class="kc">left</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">error-label</span> <span class="p">{</span>
    <span class="k">color</span><span class="p">:</span> <span class="mh">#b94a48</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">error-input</span> <span class="p">{</span>
    <span class="k">border-color</span><span class="p">:</span> <span class="mh">#b94a48</span><span class="p">;</span>
    <span class="k">margin-left</span><span class="p">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">error-message-list</span> <span class="p">{</span>
    <span class="k">color</span><span class="p">:</span> <span class="mh">#b94a48</span><span class="p">;</span>
    <span class="k">padding</span><span class="p">:</span><span class="mi">5</span><span class="kt">px</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
    <span class="k">background-color</span><span class="p">:</span> <span class="mh">#fde9f3</span><span class="p">;</span>
    <span class="k">border</span><span class="p">:</span><span class="mi">1</span><span class="kt">px</span> <span class="kc">solid</span> <span class="mh">#c98186</span><span class="p">;</span>
    <span class="k">border-radius</span><span class="p">:</span><span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
    <span class="k">margin-bottom</span><span class="p">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/validations-has-errors2.png"><img alt="../../_images/validations-has-errors2.png" src="../../_images/validations-has-errors2.png" style="width: 60%;" /></a>
</div>
<div class="line-block">
<div class="line">デフォルトでは、エラーメッセージにフィールド名は含まれず、どのフィールドのエラーメッセージなのかが分かりにくい。</div>
<div class="line">そのため、エラーメッセージを一覧で表示する場合は、エラーメッセージの中にフィールド名を含めるようにメッセージを定義する必要がある。</div>
<div class="line">エラーメッセージの定義方法については、「<a class="reference internal" href="#validation-message-def"><span class="std std-ref">エラーメッセージの定義</span></a>」を参照されたい。</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>エラーメッセージを一覧で表示する際の注意点</strong></p>
<p>エラーメッセージの出力順序は順不同であり、標準機能で出力順序を制御することはできない。
そのため、出力順序を制御する(一定に保つ)必要がある場合は、エラー情報をソートするなどの拡張実装が必要となる。</p>
<p>「エラーメッセージを一覧で表示する」方式では、</p>
<ul class="simple">
<li>フィールド単位のエラーメッセージ定義</li>
<li>エラーメッセージの出力順序を制御するための拡張実装</li>
</ul>
<p>が必要となるため、「入力フィールドの横にエラーメッセージを表示する」方式に比べて対応コストが高くなる。
<strong>本ガイドラインでは、画面要件による制約がない場合は「入力フィールドの横にエラーメッセージを表示する」方式を推奨する。</strong></p>
<p class="last">なお、エラーメッセージの出力順序を制御するための拡張方法としては、
Spring Frameworkから提供されている<code class="docutils literal"><span class="pre">org.springframework.validation.beanvalidation.LocalValidatorFactoryBean</span></code>の継承クラスを作成し、
<code class="docutils literal"><span class="pre">processConstraintViolations</span></code>メソッドをオーバーライドしてエラー情報をソートする方法などが考えられる。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>&#64;GroupSequenceアノテーションについて</strong></p>
<p>チェック順番を制御するための仕組みとして<a class="reference external" href="https://docs.jboss.org/hibernate/validator/6.0/reference/en-US/html_single/#_code_groupsequence_code">&#64;GroupSequenceアノテーション</a>が提供されているが、
この仕組みは以下のような動作になるため、エラーメッセージの出力順序を制御するための仕組みではないという点を補足しておく。</p>
<ul class="last simple">
<li>エラーが発生した場合に後続のグループのチェックが実行されない。</li>
<li>同一グループ内のチェックで複数のエラー(複数の項目でエラー)が発生するとエラーメッセージの出力順序は順不同になる。</li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>エラーメッセージをまとめて表示する際に、<code class="docutils literal"><span class="pre">&lt;form:form&gt;</span></code>タグの外に表示したい場合は以下のように<code class="docutils literal"><span class="pre">&lt;spring:nestedPath&gt;</span></code>タグを使用する。</p>
<blockquote class="last">
<div><div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="hll"><span class="nt">&lt;spring:nestedPath</span> <span class="na">path=</span><span class="s">&quot;userForm&quot;</span><span class="nt">&gt;</span>
</span>    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;*&quot;</span> <span class="na">element=</span><span class="s">&quot;div&quot;</span>
        <span class="na">cssClass=</span><span class="s">&quot;error-message-list&quot;</span> <span class="nt">/&gt;</span>
<span class="hll"><span class="nt">&lt;/spring:nestedPath&gt;</span>
</span><span class="nt">&lt;hr&gt;</span>
<span class="nt">&lt;form:form</span> <span class="na">modelAttribute=</span><span class="s">&quot;userForm&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span>
    <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/user/create&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Name:<span class="nt">&lt;/form:label&gt;</span>
    <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Email:<span class="nt">&lt;/form:label&gt;</span>
    <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Age:<span class="nt">&lt;/form:label&gt;</span>
    <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;form:button</span> <span class="na">name=</span><span class="s">&quot;confirm&quot;</span><span class="nt">&gt;</span>Confirm<span class="nt">&lt;/form:button&gt;</span>
<span class="nt">&lt;/form:form&gt;</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="id7">
<h4><a class="toc-backref" href="#id48">4.1.2.2.2. 日時フォーマットのチェック</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">日時フォーマットのチェックを行う場合には、Bean Validationの仕組みではなく、Springが提供する日時のフォーマットを指定する<code class="docutils literal"><span class="pre">&#64;DateTimeFormat</span></code>アノテーションの使用を推奨する。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;DateTimeFormat</span></code>アノテーションの使用方法については、<a class="reference internal" href="../../ImplementationAtEachLayer/ApplicationLayer.html#applicationlayer-datetimeformat"><span class="std std-ref">フィールド単位の日時型変換</span></a>を参照されたい。</div>
<div class="line">Bean Validationの<code class="docutils literal"><span class="pre">&#64;Pattern</span></code>アノテーションを使用することでも日時フォーマットのチェックは可能である。</div>
<div class="line">しかし、<code class="docutils literal"><span class="pre">&#64;Pattern</span></code>アノテーションを使用すると、日時フォーマットを正規表現で記述する必要があり、存在しない日時をチェックする場合には、記述が煩雑化する。</div>
<div class="line">そのため、<code class="docutils literal"><span class="pre">&#64;Pattern</span></code>アノテーションよりも<code class="docutils literal"><span class="pre">&#64;DateTimeFormat</span></code>アノテーションのほうが実装はシンプルになる。</div>
</div>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;DateTimeFormat</span></code>アノテーションはSpringが提供する型変換の仕組みのひとつであるので、入力エラーの場合には、Bean Validationのエラーメッセージではなく、型のミスマッチが発生した時にスローされる例外(<code class="docutils literal"><span class="pre">TypeMismatchException</span></code>)の例外メッセージがそのまま画面へ表示される。</div>
<div class="line">例外メッセージが画面に表示されることを避けるため、型のミスマッチが発生した際のエラーメッセージを<strong>プロパティファイル</strong>に設定する必要がある。</div>
<div class="line">詳細は<a class="reference internal" href="#validation-type-mismatch"><span class="std std-ref">型のミスマッチ</span></a>を参照されたい。</div>
</div>
</div>
<div class="section" id="bean">
<h4><a class="toc-backref" href="#id49">4.1.2.2.3. ネストしたBeanの単項目チェック</a><a class="headerlink" href="#bean" title="Permalink to this headline">¶</a></h4>
<p>ネストしたBeanをBean Validationで検証する方法を説明する。</p>
<p>ECサイトにおける「注文」処理の例を考える。「注文」フォームでは、以下のチェックルールを設ける。</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="20%" />
<col width="30%" />
<col width="30%" />
<col width="20%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">フィールド名</th>
<th class="head">型</th>
<th class="head">ルール</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">coupon</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">java.lang.String</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">5文字以下</div>
<div class="line">半角英数字</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クーポンコード</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">receiverAddress.name</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">java.lang.String</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力必須</div>
<div class="line">1文字以上</div>
<div class="line">50文字以下</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">お届け先氏名</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">receiverAddress.postcode</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">java.lang.String</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力必須</div>
<div class="line">1文字以上</div>
<div class="line">10文字以下</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">お届け先郵便番号</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">receiverAddress.address</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">java.lang.String</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力必須</div>
<div class="line">1文字以上</div>
<div class="line">100文字以下</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">お届け先住所</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">senderAddress.name</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">java.lang.String</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力必須</div>
<div class="line">1文字以上</div>
<div class="line">50文字以下</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">請求先氏名</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">senderAddress.postcode</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">java.lang.String</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力必須</div>
<div class="line">1文字以上</div>
<div class="line">10文字以下</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">請求先郵便番号</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">senderAddress.address</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">java.lang.String</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力必須</div>
<div class="line">1文字以上</div>
<div class="line">100文字以下</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">請求先住所</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><code class="docutils literal"><span class="pre">receiverAddress</span></code>と<code class="docutils literal"><span class="pre">senderAddress</span></code>は、同じ項目であるため、同じフォームクラスを使用する。</p>
<ul>
<li><p class="first">フォームクラス</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.sample.app.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.Valid</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Pattern</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="nd">@Size</span><span class="o">(</span><span class="n">max</span> <span class="o">=</span> <span class="mi">5</span><span class="o">)</span>
    <span class="nd">@Pattern</span><span class="o">(</span><span class="n">regexp</span> <span class="o">=</span> <span class="s">&quot;[a-zA-Z0-9]*&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">coupon</span><span class="o">;</span>

    <span class="nd">@NotNull</span> <span class="c1">// (1)</span>
    <span class="nd">@Valid</span> <span class="c1">// (2)</span>
    <span class="kd">private</span> <span class="n">AddressForm</span> <span class="n">receiverAddress</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Valid</span>
    <span class="kd">private</span> <span class="n">AddressForm</span> <span class="n">senderAddress</span><span class="o">;</span>

    <span class="c1">// omitted setter/getter</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.sample.app.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AddressForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">50</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">10</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">postcode</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">address</span><span class="o">;</span>

    <span class="c1">// omitted setter/getter</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">子フォーム自体が必須であることを示す。</div>
<div class="line">この設定がない場合、<code class="docutils literal"><span class="pre">receiverAddress</span></code>に<code class="docutils literal"><span class="pre">null</span></code>が設定されても、正常とみなされる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ネストしたBeanのBean Validationを有効にするために、<code class="docutils literal"><span class="pre">javax.validation.Valid</span></code>アノテーションを付与する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Controllerクラス</p>
<p>前述のControllerと違いはない。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.sample.app.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.BindingResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ModelAttribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="o">;</span>

<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;order&quot;</span><span class="o">)</span>
<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderController</span> <span class="o">{</span>

    <span class="nd">@ModelAttribute</span>
    <span class="kd">public</span> <span class="n">OrderForm</span> <span class="nf">setupForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">OrderForm</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;order&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">orderForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;order/orderForm&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;order&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;confirm&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">orderConfirm</span><span class="o">(</span><span class="nd">@Validated</span> <span class="n">OrderForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">&quot;order/orderForm&quot;</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="s">&quot;order/orderConfirm&quot;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">JSP</p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="k">&lt;%-</span><span class="o">-</span> <span class="n">WEB</span><span class="o">-</span><span class="n">INF</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">order</span><span class="o">/</span><span class="n">orderForm</span><span class="o">.</span><span class="na">jsp</span> <span class="o">--</span><span class="k">%&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;style</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
  /* omitted (same as previous sample) */
<span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;form:form</span> <span class="na">modelAttribute=</span><span class="s">&quot;orderForm&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span>
        <span class="na">class=</span><span class="s">&quot;form-horizontal&quot;</span>
        <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/order/order&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;coupon&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Coupon Code:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;coupon&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;coupon&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;fieldset&gt;</span>
        <span class="nt">&lt;legend&gt;</span>Receiver<span class="nt">&lt;/legend&gt;</span>
        <span class="k">&lt;%-</span><span class="o">-</span> <span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">--</span><span class="k">%&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;receiverAddress&quot;</span>
            <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
        <span class="k">&lt;%-</span><span class="o">-</span> <span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="o">--</span><span class="k">%&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;receiverAddress.name&quot;</span>
            <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Name:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;receiverAddress.name&quot;</span>
            <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;receiverAddress.name&quot;</span>
            <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;receiverAddress.postcode&quot;</span>
            <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Postcode:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;receiverAddress.postcode&quot;</span>
            <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;receiverAddress.postcode&quot;</span>
            <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;receiverAddress.address&quot;</span>
            <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Address:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;receiverAddress.address&quot;</span>
            <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;receiverAddress.address&quot;</span>
            <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/fieldset&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;fieldset&gt;</span>
        <span class="nt">&lt;legend&gt;</span>Sender<span class="nt">&lt;/legend&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;senderAddress&quot;</span>
            <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;senderAddress.name&quot;</span>
            <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Name:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;senderAddress.name&quot;</span>
            <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;senderAddress.name&quot;</span>
            <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;senderAddress.postcode&quot;</span>
            <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Postcode:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;senderAddress.postcode&quot;</span>
            <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;senderAddress.postcode&quot;</span>
            <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;senderAddress.address&quot;</span>
            <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Address:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;senderAddress.address&quot;</span>
            <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;senderAddress.address&quot;</span>
            <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/fieldset&gt;</span>

        <span class="nt">&lt;form:button</span> <span class="na">name=</span><span class="s">&quot;confirm&quot;</span><span class="nt">&gt;</span>Confirm<span class="nt">&lt;/form:button&gt;</span>
    <span class="nt">&lt;/form:form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">不正な操作により、<code class="docutils literal"><span class="pre">receiverAddress.name</span></code>、<code class="docutils literal"><span class="pre">receiverAddress.postcode</span></code>、<code class="docutils literal"><span class="pre">receiverAddress.address</span></code>のすべて</div>
<div class="line">がリクエストパラメータとして送信されない場合、<code class="docutils literal"><span class="pre">receiverAddress</span></code>が<code class="docutils literal"><span class="pre">null</span></code>とみなされ、この位置にエラーメッセージが表示される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">子フォームのフィールドは、<code class="docutils literal"><span class="pre">親フィールド名.子フィールド名</span></code>で指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<p>フォームは、以下のように表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/validations-nested1.png"><img alt="../../_images/validations-nested1.png" src="../../_images/validations-nested1.png" style="width: 60%;" /></a>
</div>
<p>このフォームに対して、すべての入力フィールドを未入力のまま送信すると、以下のようにエラーメッセージが表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/validations-nested2.png"><img alt="../../_images/validations-nested2.png" src="../../_images/validations-nested2.png" style="width: 60%;" /></a>
</div>
<p>ネストしたBeanのバリデーションはコレクションに対しても有効である。</p>
<p>最初に説明した「ユーザー登録」フォームに住所を3件まで登録できるようにフィールドを追加する。
住所には、前述の<code class="docutils literal"><span class="pre">AddressForm</span></code>を利用する。</p>
<ul>
<li><p class="first">フォームクラス
<code class="docutils literal"><span class="pre">AddressForm</span></code>のリストを、フィールドに追加する。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.sample.app.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.Valid</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Email</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Max</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Min</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">20</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">50</span><span class="o">)</span>
    <span class="nd">@Email</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Min</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
    <span class="nd">@Max</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">age</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">3</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="nd">@Valid</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">AddressForm</span><span class="o">&gt;</span> <span class="n">addresses</span><span class="o">;</span>

    <span class="c1">// omitted setter/getter</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">コレクションのサイズチェックにも、<code class="docutils literal"><span class="pre">&#64;Size</span></code>アノテーションを使用できる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">JSP</p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="k">&lt;%-</span><span class="o">-</span> <span class="n">WEB</span><span class="o">-</span><span class="n">INF</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">createForm</span><span class="o">.</span><span class="na">jsp</span> <span class="o">--</span><span class="k">%&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;style</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
  /* omitted (same as previous sample) */
<span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

    <span class="nt">&lt;form:form</span> <span class="na">modelAttribute=</span><span class="s">&quot;userForm&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span>
        <span class="na">class=</span><span class="s">&quot;form-horizontal&quot;</span>
        <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/user/create&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Name:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Email:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Age:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;addresses&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span><span class="k">&lt;%-</span><span class="o">-</span> <span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">--</span><span class="k">%&gt;</span>
        <span class="nt">&lt;c:forEach</span> <span class="na">items=</span><span class="s">&quot;${userForm.addresses}&quot;</span> <span class="na">varStatus=</span><span class="s">&quot;status&quot;</span><span class="nt">&gt;</span><span class="k">&lt;%-</span><span class="o">-</span> <span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="o">--</span><span class="k">%&gt;</span>
            <span class="nt">&lt;fieldset</span> <span class="na">class=</span><span class="s">&quot;address&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;legend&gt;</span>Address${f:h(status.index + 1)}<span class="nt">&lt;/legend&gt;</span>
                <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;addresses[${status.index}].name&quot;</span>
                    <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Name:<span class="nt">&lt;/form:label&gt;</span><span class="k">&lt;%-</span><span class="o">-</span> <span class="o">(</span><span class="mi">3</span><span class="o">)</span> <span class="o">--</span><span class="k">%&gt;</span>
                <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;addresses[${status.index}].name&quot;</span>
                    <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;addresses[${status.index}].name&quot;</span>
                    <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;br&gt;</span>
                <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;addresses[${status.index}].postcode&quot;</span>
                    <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Postcode:<span class="nt">&lt;/form:label&gt;</span>
                <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;addresses[${status.index}].postcode&quot;</span>
                    <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;addresses[${status.index}].postcode&quot;</span>
                    <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;br&gt;</span>
                <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;addresses[${status.index}].address&quot;</span>
                    <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Address:<span class="nt">&lt;/form:label&gt;</span>
                <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;addresses[${status.index}].address&quot;</span>
                    <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;addresses[${status.index}].address&quot;</span>
                    <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;c:if</span> <span class="na">test=</span><span class="s">&quot;${status.index &gt; 0}&quot;</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;br&gt;</span>
                    <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">&quot;remove-address-button&quot;</span><span class="nt">&gt;</span>Remove<span class="nt">&lt;/button&gt;</span>
                <span class="nt">&lt;/c:if&gt;</span>
            <span class="nt">&lt;/fieldset&gt;</span>
            <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;/c:forEach&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">&quot;add-address-button&quot;</span><span class="nt">&gt;</span>Add address<span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;form:button</span> <span class="na">name=</span><span class="s">&quot;confirm&quot;</span><span class="nt">&gt;</span>Confirm<span class="nt">&lt;/form:button&gt;</span>
    <span class="nt">&lt;/form:form&gt;</span>
    <span class="nt">&lt;script</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span>
        <span class="na">src=</span><span class="s">&quot;${pageContext.request.contextPath}/resources/vendor/js/jquery-1.10.2.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span>
        <span class="na">src=</span><span class="s">&quot;${pageContext.request.contextPath}/resources/app/js/AddressesView.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">addresses</span></code>フィールドに対するエラーメッセージを表示する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">子フォームのコレクションを、<code class="docutils literal"><span class="pre">&lt;c:forEach&gt;</span></code>タグを使ってループで処理する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">コレクション中の子フォームのフィールドは、<code class="docutils literal"><span class="pre">親フィールド名[インデックス].子フィールド名</span></code>で指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<ul>
<li><p class="first">Controllerクラス</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.sample.app.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.BindingResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ModelAttribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>

    <span class="nd">@ModelAttribute</span>
    <span class="kd">public</span> <span class="n">UserForm</span> <span class="nf">setupForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">UserForm</span> <span class="n">form</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserForm</span><span class="o">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">AddressForm</span><span class="o">&gt;</span> <span class="n">addresses</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">AddressForm</span><span class="o">&gt;();</span>
        <span class="n">addresses</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">AddressForm</span><span class="o">());</span>
        <span class="n">form</span><span class="o">.</span><span class="na">setAddresses</span><span class="o">(</span><span class="n">addresses</span><span class="o">);</span> <span class="c1">// (1)</span>
        <span class="k">return</span> <span class="n">form</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;user/createForm&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;confirm&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createConfirm</span><span class="o">(</span><span class="nd">@Validated</span> <span class="n">UserForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">&quot;user/createForm&quot;</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="s">&quot;user/createConfirm&quot;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">「ユーザー登録」フォーム初期表示時に、一件の住所フォームを表示させるために、フォームオブジェクトを編集する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">JavaScript</p>
<p>動的にアドレス入力フィールドを追加するためのJavaScriptも記載するが、このコードの説明は、本質的ではないため割愛する。</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="c1">// webapp/resources/app/js/AddressesView.js</span>

<span class="kd">function</span> <span class="nx">AddressesView</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">addressSize</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;fieldset.address&#39;</span><span class="p">).</span><span class="nx">size</span><span class="p">();</span>
<span class="p">};</span>

<span class="nx">AddressesView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addAddress</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">$address</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;fieldset.address&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">newHtml</span> <span class="o">=</span> <span class="nx">addressTemplate</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">addressSize</span><span class="o">++</span><span class="p">);</span>
  <span class="nx">$address</span><span class="p">.</span><span class="nx">last</span><span class="p">().</span><span class="nx">next</span><span class="p">().</span><span class="nx">after</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">newHtml</span><span class="p">));</span>
<span class="p">};</span>

<span class="nx">AddressesView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">removeAddress</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$fieldset</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">$fieldset</span><span class="p">.</span><span class="nx">next</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span> <span class="c1">// remove &lt;br&gt;</span>
  <span class="nx">$fieldset</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span> <span class="c1">// remove &lt;fieldset&gt;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">addressTemplate</span><span class="p">(</span><span class="nx">number</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="s1">&#39;\</span>
<span class="s1">&lt;fieldset class=&quot;address&quot;&gt;\</span>
<span class="s1">    &lt;legend&gt;Address&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;/legend&gt;\</span>
<span class="s1">    &lt;label for=&quot;addresses&#39;</span> <span class="o">+</span> <span class="nx">number</span> <span class="o">+</span> <span class="s1">&#39;.name&quot;&gt;Name:&lt;/label&gt;\</span>
<span class="s1">    &lt;input id=&quot;addresses&#39;</span> <span class="o">+</span> <span class="nx">number</span> <span class="o">+</span> <span class="s1">&#39;.name&quot; name=&quot;addresses[&#39;</span> <span class="o">+</span> <span class="nx">number</span> <span class="o">+</span> <span class="s1">&#39;].name&quot; type=&quot;text&quot; value=&quot;&quot;/&gt;&lt;br&gt;\</span>
<span class="s1">    &lt;label for=&quot;addresses&#39;</span> <span class="o">+</span> <span class="nx">number</span> <span class="o">+</span> <span class="s1">&#39;.postcode&quot;&gt;Postcode:&lt;/label&gt;\</span>
<span class="s1">    &lt;input id=&quot;addresses&#39;</span> <span class="o">+</span> <span class="nx">number</span> <span class="o">+</span> <span class="s1">&#39;.postcode&quot; name=&quot;addresses[&#39;</span> <span class="o">+</span> <span class="nx">number</span> <span class="o">+</span> <span class="s1">&#39;].postcode&quot; type=&quot;text&quot; value=&quot;&quot;/&gt;&lt;br&gt;\</span>
<span class="s1">    &lt;label for=&quot;addresses&#39;</span> <span class="o">+</span> <span class="nx">number</span> <span class="o">+</span> <span class="s1">&#39;.address&quot;&gt;Address:&lt;/label&gt;\</span>
<span class="s1">    &lt;input id=&quot;addresses&#39;</span> <span class="o">+</span> <span class="nx">number</span> <span class="o">+</span> <span class="s1">&#39;.address&quot; name=&quot;addresses[&#39;</span> <span class="o">+</span> <span class="nx">number</span> <span class="o">+</span> <span class="s1">&#39;].address&quot; type=&quot;text&quot; value=&quot;&quot;/&gt;&lt;br&gt;\</span>
<span class="s1">    &lt;button class=&quot;remove-address-button&quot;&gt;Remove&lt;/button&gt;\</span>
<span class="s1">&lt;/fieldset&gt;\</span>
<span class="s1">&lt;br&gt;\</span>
<span class="s1">&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">addressesView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AddressesView</span><span class="p">();</span>

  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#add-address-button&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="nx">addressesView</span><span class="p">.</span><span class="nx">addAddress</span><span class="p">();</span>
  <span class="p">});</span>

  <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="s1">&#39;.remove-address-button&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span> <span class="o">===</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">$this</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">);</span> <span class="c1">// this button</span>
      <span class="kd">var</span> <span class="nx">$fieldset</span> <span class="o">=</span> <span class="nx">$this</span><span class="p">.</span><span class="nx">parent</span><span class="p">();</span> <span class="c1">// fieldset</span>
      <span class="nx">addressesView</span><span class="p">.</span><span class="nx">removeAddress</span><span class="p">(</span><span class="nx">$fieldset</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>

<span class="p">});</span>
</pre></div>
</div>
</li>
</ul>
<p>フォームは、以下のように表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/validations-nested-collection1.png"><img alt="../../_images/validations-nested-collection1.png" src="../../_images/validations-nested-collection1.png" style="width: 60%;" /></a>
</div>
<p>「Add address」ボタンを2回押して、住所フォームを2件追加する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/validations-nested-collection2.png"><img alt="../../_images/validations-nested-collection2.png" src="../../_images/validations-nested-collection2.png" style="width: 60%;" /></a>
</div>
<p>このフォームに対して、すべての入力フィールドを未入力のまま送信すると、以下のようにエラーメッセージが表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/validations-nested-collection3.png"><img alt="../../_images/validations-nested-collection3.png" src="../../_images/validations-nested-collection3.png" style="width: 60%;" /></a>
</div>
</div>
<div class="section" id="id8">
<h4><a class="toc-backref" href="#id50">4.1.2.2.4. コレクション内の値のチェック</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<p>複数選択可能な画面項目（チェックボックスや複数選択ドロップダウンなど）を扱う際は、フォームクラスで画面項目を <code class="docutils literal"><span class="pre">String</span></code>等の基本型のコレクションとして扱うことが一般的である。</p>
<p>ここでは、Bean Validation 2.0の標準アノテーションである<code class="docutils literal"><span class="pre">&#64;NotEmpty</span></code>及び共通ライブラリが提供する<code class="docutils literal"><span class="pre">&#64;ExistInCodeList</span></code>を例に、コレクション内の値の入力チェックを行う例を示す。</p>
<ul>
<li><p class="first">フォームクラス</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.sample.app.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotEmpty</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.codelist.ExistInCodeList</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleForm</span> <span class="o">{</span>
    <span class="nd">@NotEmpty</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="nd">@NotEmpty</span> <span class="nd">@ExistInCodeList</span><span class="o">(</span><span class="n">codeListId</span> <span class="o">=</span> <span class="s">&quot;CL_ROLE&quot;</span><span class="o">)</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">roles</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getRoles</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">roles</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setRoles</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">roles</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">roles</span> <span class="o">=</span> <span class="n">roles</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力チェック対象となるコレクションの型引数に対して<code class="docutils literal"><span class="pre">&#64;NotEmpty</span></code>アノテーション及び<code class="docutils literal"><span class="pre">&#64;ExistInCodeList</span></code>アノテーションを設定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;ExistInCodeList</span></code>アノテーションの<code class="docutils literal"><span class="pre">codeListId</span></code>パラメータにチェック元となるコードリストを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul>
<li><p class="first">JSP</p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;form:form</span> <span class="na">modelAttribute=</span><span class="s">&quot;sampleForm&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;form:checkboxes</span> <span class="na">path=</span><span class="s">&quot;roles&quot;</span> <span class="na">items=</span><span class="s">&quot;${CL_ROLE}&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;roles*&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;form:button&gt;</span>Submit<span class="nt">&lt;/form:button&gt;</span>
<span class="nt">&lt;/form:form&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;form:checkboxes&gt;</span></code>を実装する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Java SE 8で<code class="docutils literal"><span class="pre">java.lang.annotation.ElementType.TYPE_USE</span></code>が追加された。
これにより、従来のクラスやメソッド等の宣言に対してだけでなく、型全般（ローカル変数の型等）にアノテーションを付加できるようになり、
Java SE 8に対応したHibernate Validator 5.2+は、<code class="docutils literal"><span class="pre">Collection</span></code>, <code class="docutils literal"><span class="pre">Map</span></code>, <code class="docutils literal"><span class="pre">Optional</span></code>, などのパラメータ化された型に付与された制約アノテーションを読み取ることで、コレクション内の値に対するチェックが可能になった。</p>
<p>さらに、Bean Validation 2.0(Hibernate Validator 6.x)より、Bean Validation 2.0の標準仕様として、<code class="docutils literal"><span class="pre">List&lt;&#64;NotNull</span> <span class="pre">String&gt;</span></code>のように、コレクション内の各値に対してBean Validationの標準アノテーションを付与し、チェックすることが可能になった。</p>
<p class="last">上記に伴い、共通ライブラリで提供される<code class="docutils literal"><span class="pre">&#64;ExistInCodeList</span></code>、<code class="docutils literal"><span class="pre">&#64;ConsistOf</span></code>、<code class="docutils literal"><span class="pre">&#64;ByteMin</span></code>、<code class="docutils literal"><span class="pre">&#64;ByteMax</span></code>、<code class="docutils literal"><span class="pre">&#64;ByteSize</span></code>の各アノテーションは、
TERASOLUNA Server Framework for Java 5.5.1.RELEASEよりBean Validation 2.0に準拠し、<code class="docutils literal"><span class="pre">List&lt;&#64;ExistInCodeList</span> <span class="pre">String&gt;</span></code>のように、デフォルトでコレクション内の各値に対して付与し、チェック出来るように変更している。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="validationgroupvalidation">
<span id="id9"></span><h4><a class="toc-backref" href="#id51">4.1.2.2.5. バリデーションのグループ化</a><a class="headerlink" href="#validationgroupvalidation" title="Permalink to this headline">¶</a></h4>
<p>バリデーショングループを作成し、一つのフィールドに対して、グループごとに入力チェックルールを指定することができる。</p>
<p>前述の「新規ユーザー登録」の例で、<code class="docutils literal"><span class="pre">age</span></code>フィールドに「成年であること」というルールを追加する。
「成年かどうか」は国によってルールが違うため、<code class="docutils literal"><span class="pre">country</span></code>フィールドも追加する。</p>
<p>Bean Validationでグループを指定する場合、アノテーションの<code class="docutils literal"><span class="pre">group</span></code>属性に、グループを示す任意の<code class="docutils literal"><span class="pre">java.lang.Class</span></code>オブジェクトを設定する。</p>
<p>ここでは、以下の3グループ(interface)を作成する。</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">グループ</th>
<th class="head">成人条件</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">Chinese</span></code></td>
<td>18歳以上</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">Japanese</span></code></td>
<td>20歳以上</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">Singaporean</span></code></td>
<td>21歳以上</td>
</tr>
</tbody>
</table>
<p>このグループをつかって、バリデーションを実行する例を示す。</p>
<ul>
<li><p class="first">フォームクラス</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.sample.app.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.Valid</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Email</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Max</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Min</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">Chinese</span> <span class="o">{</span>
    <span class="o">};</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">Japanese</span> <span class="o">{</span>
    <span class="o">};</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">Singaporean</span> <span class="o">{</span>
    <span class="o">};</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">20</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">50</span><span class="o">)</span>
    <span class="nd">@Email</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Min</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="mi">18</span><span class="o">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">Chinese</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// (2)</span>
    <span class="nd">@Min</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="mi">20</span><span class="o">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">Japanese</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="nd">@Min</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="mi">21</span><span class="o">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">Singaporean</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="nd">@Max</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">age</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">2</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">2</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">country</span><span class="o">;</span> <span class="c1">// (3)</span>

    <span class="c1">// omitted setter/getter</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">グループクラスを指定するために、各グループをインタフェースで定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">グループごとにルールを定義する。グループを指定するために、<code class="docutils literal"><span class="pre">groups</span></code>属性に対象のグループクラスを指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">groups</span></code>属性を省略した場合、<code class="docutils literal"><span class="pre">javax.validation.groups.Default</span></code>グループが使用される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">グループを振り分けるための、フィールドを追加する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Bean Validation 2.0では、デフォルトで一つのフィールドに同じアノテーションを複数指定できる</strong></p>
<p>Bean Validation 1.1では、一つのフィールドに同じ制約アノテーションを複数指定する場合は、以下のように<code class="docutils literal"><span class="pre">List</span></code>で囲う必要があった。
Bean Validation 2.0では、<code class="docutils literal"><span class="pre">List</span></code>で囲うことなく複数指定できるようになっている。</p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Min.List</span><span class="o">({</span>
        <span class="nd">@Min</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="mi">18</span><span class="o">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">Chinese</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
        <span class="nd">@Min</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="mi">20</span><span class="o">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">Japanese</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
        <span class="nd">@Min</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="mi">21</span><span class="o">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">Singaporean</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">})</span>
<span class="kd">private</span> <span class="n">Integer</span> <span class="n">age</span><span class="o">;</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div></blockquote>
<ul>
<li><p class="first">JSP</p>
<p>JSPに大きな変更はない。</p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;form:form</span> <span class="na">modelAttribute=</span><span class="s">&quot;userForm&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span>
    <span class="na">class=</span><span class="s">&quot;form-horizontal&quot;</span>
    <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/user/create&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Name:<span class="nt">&lt;/form:label&gt;</span>
    <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Email:<span class="nt">&lt;/form:label&gt;</span>
    <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Age:<span class="nt">&lt;/form:label&gt;</span>
    <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;country&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Country:<span class="nt">&lt;/form:label&gt;</span>
    <span class="nt">&lt;form:select</span> <span class="na">path=</span><span class="s">&quot;country&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;form:option</span> <span class="na">value=</span><span class="s">&quot;cn&quot;</span><span class="nt">&gt;</span>China<span class="nt">&lt;/form:option&gt;</span>
        <span class="nt">&lt;form:option</span> <span class="na">value=</span><span class="s">&quot;jp&quot;</span><span class="nt">&gt;</span>Japan<span class="nt">&lt;/form:option&gt;</span>
        <span class="nt">&lt;form:option</span> <span class="na">value=</span><span class="s">&quot;sg&quot;</span><span class="nt">&gt;</span>Singapore<span class="nt">&lt;/form:option&gt;</span>
    <span class="nt">&lt;/form:select&gt;</span>
    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;country&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;form:button</span> <span class="na">name=</span><span class="s">&quot;confirm&quot;</span><span class="nt">&gt;</span>Confirm<span class="nt">&lt;/form:button&gt;</span>
<span class="nt">&lt;/form:form&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first">Controllerクラス</p>
<p><code class="docutils literal"><span class="pre">&#64;Validated</span></code>に、対象のグループを設定することで、バリデーションルールを変更できる。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.sample.app.validation</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">javax.validation.groups.Default</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.BindingResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ModelAttribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.sample.app.validation.UserForm.Chinese</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.sample.app.validation.UserForm.Japanese</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.sample.app.validation.UserForm.Singaporean</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>

    <span class="nd">@ModelAttribute</span>
    <span class="kd">public</span> <span class="n">UserForm</span> <span class="nf">setupForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">UserForm</span> <span class="n">form</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserForm</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">form</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;user/createForm&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">String</span> <span class="nf">createConfirm</span><span class="o">(</span><span class="n">UserForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">&quot;user/createForm&quot;</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="s">&quot;user/createConfirm&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="o">{</span>
            <span class="s">&quot;confirm&quot;</span><span class="o">,</span>  <span class="cm">/* (1) */</span> <span class="s">&quot;country=cn&quot;</span> <span class="o">})</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createConfirmForChinese</span><span class="o">(</span><span class="nd">@Validated</span><span class="o">({</span> <span class="cm">/* (2) */</span> <span class="n">Chinese</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">Default</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span> <span class="n">UserForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">createConfirm</span><span class="o">(</span><span class="n">form</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="o">{</span>
            <span class="s">&quot;confirm&quot;</span><span class="o">,</span> <span class="s">&quot;country=jp&quot;</span> <span class="o">})</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createConfirmForJapanese</span><span class="o">(</span><span class="nd">@Validated</span><span class="o">({</span> <span class="n">Japanese</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">Default</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span> <span class="n">UserForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">createConfirm</span><span class="o">(</span><span class="n">form</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="o">{</span>
            <span class="s">&quot;confirm&quot;</span><span class="o">,</span> <span class="s">&quot;country=sg&quot;</span> <span class="o">})</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createConfirmForSingaporean</span><span class="o">(</span><span class="nd">@Validated</span><span class="o">({</span> <span class="n">Singaporean</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">Default</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span> <span class="n">UserForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">createConfirm</span><span class="o">(</span><span class="n">form</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">グループを振り分けるためのパラメータの条件を、<code class="docutils literal"><span class="pre">param</span></code>属性に追加する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;Min</span></code>以外のアノテーションは、<code class="docutils literal"><span class="pre">Default</span></code>グループに属しているため、<code class="docutils literal"><span class="pre">Default</span></code>の指定も必要である。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<p>この例では、各入力値の組み合わせに対するチェック結果は、以下の表の通りである。</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="20%" />
<col width="20%" />
<col width="20%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><code class="docutils literal"><span class="pre">age</span></code>の値</th>
<th class="head"><code class="docutils literal"><span class="pre">country</span></code>の値</th>
<th class="head">入力チェック結果</th>
<th class="head">エラーメッセージ</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">17</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">cn</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">NG</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">must be greater than or equal to 18</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">jp</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">NG</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">must be greater than or equal to 20</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">sg</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">NG</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">must be greater than or equal to 21</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">18</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">cn</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OK</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">jp</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">NG</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">must be greater than or equal to 20</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">sg</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">NG</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">must be greater than or equal to 21</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">20</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">cn</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OK</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">jp</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OK</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">sg</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">NG</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">must be greater than or equal to 21</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">21</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">cn</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OK</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">jp</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OK</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">sg</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OK</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">このControllerの実装は、<code class="docutils literal"><span class="pre">country</span></code>の値が、”cn”、”jp”、”sg”のいずれでもない場合のハンドリングが行われておらず、不十分である。
<code class="docutils literal"><span class="pre">country</span></code>の値が、想定外の場合に、400エラーが返却される。</p>
</div>
<p>次にチェック対象の国が増えたため、成人条件18歳以上をデフォルトルールとしたい場合を考える。</p>
<p>ルールは、以下のようになる。</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">グループ</th>
<th class="head">成人条件</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">Japanese</span></code></td>
<td>20歳以上</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">Singaporean</span></code></td>
<td>21歳以上</td>
</tr>
<tr class="row-even"><td>上記以外の国(<code class="docutils literal"><span class="pre">Default</span></code>)</td>
<td>18歳以上</td>
</tr>
</tbody>
</table>
<ul>
<li><p class="first">フォームクラス</p>
<p><code class="docutils literal"><span class="pre">Default</span></code>グループに意味を持たせるため、<code class="docutils literal"><span class="pre">&#64;Min</span></code>以外のアノテーションにも、明示的に全グループを指定する必要がある。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.sample.app.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.Valid</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Email</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Max</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Min</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.groups.Default</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">Japanese</span> <span class="o">{</span>
    <span class="o">};</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">Singaporean</span> <span class="o">{</span>
    <span class="o">};</span>

    <span class="nd">@NotNull</span><span class="o">(</span><span class="n">groups</span> <span class="o">=</span> <span class="o">{</span> <span class="n">Default</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Japanese</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Singaporean</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span> <span class="c1">// (1)</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">20</span><span class="o">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="o">{</span> <span class="n">Default</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Japanese</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">Singaporean</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="nd">@NotNull</span><span class="o">(</span><span class="n">groups</span> <span class="o">=</span> <span class="o">{</span> <span class="n">Default</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Japanese</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Singaporean</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">50</span><span class="o">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="o">{</span> <span class="n">Default</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Japanese</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">Singaporean</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
    <span class="nd">@Email</span><span class="o">(</span><span class="n">groups</span> <span class="o">=</span> <span class="o">{</span> <span class="n">Default</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Japanese</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Singaporean</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>

    <span class="nd">@NotNull</span><span class="o">(</span><span class="n">groups</span> <span class="o">=</span> <span class="o">{</span> <span class="n">Default</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Japanese</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Singaporean</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
    <span class="nd">@Min</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="mi">18</span><span class="o">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">Default</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// (2)</span>
    <span class="nd">@Min</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="mi">20</span><span class="o">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">Japanese</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="nd">@Min</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="mi">21</span><span class="o">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">Singaporean</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="nd">@Max</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="mi">200</span><span class="o">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="o">{</span> <span class="n">Default</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Japanese</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Singaporean</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">age</span><span class="o">;</span>

    <span class="nd">@NotNull</span><span class="o">(</span><span class="n">groups</span> <span class="o">=</span> <span class="o">{</span> <span class="n">Default</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Japanese</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Singaporean</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">2</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">2</span><span class="o">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="o">{</span> <span class="n">Default</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Japanese</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">Singaporean</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">country</span><span class="o">;</span>

    <span class="c1">// omitted setter/getter</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;Min</span></code>以外のアノテーションにも、全グループを設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Default</span></code>グループに対するルールを設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">JSP</p>
<p>JSPに変更はない</p>
</li>
<li><p class="first">Controllerクラス</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.sample.app.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.BindingResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ModelAttribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.sample.app.validation.UserForm.Japanese</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.sample.app.validation.UserForm.Singaporean</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>

    <span class="nd">@ModelAttribute</span>
    <span class="kd">public</span> <span class="n">UserForm</span> <span class="nf">setupForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">UserForm</span> <span class="n">form</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserForm</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">form</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;user/createForm&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">String</span> <span class="nf">createConfirm</span><span class="o">(</span><span class="n">UserForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">&quot;user/createForm&quot;</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="s">&quot;user/createConfirm&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="o">{</span> <span class="s">&quot;confirm&quot;</span> <span class="o">})</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createConfirmForDefault</span><span class="o">(</span><span class="nd">@Validated</span> <span class="cm">/* (1) */</span> <span class="n">UserForm</span> <span class="n">form</span><span class="o">,</span>
            <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">createConfirm</span><span class="o">(</span><span class="n">form</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="o">{</span>
            <span class="s">&quot;confirm&quot;</span><span class="o">,</span> <span class="s">&quot;country=jp&quot;</span> <span class="o">})</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createConfirmForJapanese</span><span class="o">(</span>
            <span class="nd">@Validated</span><span class="o">(</span><span class="n">Japanese</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>  <span class="cm">/* (2) */</span> <span class="n">UserForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">createConfirm</span><span class="o">(</span><span class="n">form</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="o">{</span>
            <span class="s">&quot;confirm&quot;</span><span class="o">,</span> <span class="s">&quot;country=sg&quot;</span> <span class="o">})</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createConfirmForSingaporean</span><span class="o">(</span>
            <span class="nd">@Validated</span><span class="o">(</span><span class="n">Singaporean</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="n">UserForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">createConfirm</span><span class="o">(</span><span class="n">form</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">country</span></code>フィールド指定がない場合に、<code class="docutils literal"><span class="pre">Default</span></code>グループが使用されるように設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">country</span></code>フィールド指定がある場合に、<code class="docutils literal"><span class="pre">Default</span></code>グループが含まれないように設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<p>バリデーショングループを使用する方法について、2パターン説明した。</p>
<p>前者は<code class="docutils literal"><span class="pre">Default</span></code>グループをControllerクラスで使用し、後者は<code class="docutils literal"><span class="pre">Default</span></code>グループをフォームクラスで使用した。</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">パターン</th>
<th class="head">メリット</th>
<th class="head">デメリット</th>
<th class="head">使用の判断ポイント</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">Default</span></code>グループをControllerクラスで使用</td>
<td>グループ化する必要のないルールは、<code class="docutils literal"><span class="pre">group</span></code>属性を設定する必要がない。</td>
<td>グループの全パターンを定義する必要があるので、グループパターンが多いと、定義が困難になる。</td>
<td>グループパターンが、数種類の場合に使用すべき(新規作成グループ、更新グループ、削除グループ等)</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">Default</span></code>グループをフォームクラスで使用</td>
<td>デフォルトに属さないグループのみ定義すればよいため、パターンが多くても対応できる。</td>
<td>グループ化する必要のないルールにも、<code class="docutils literal"><span class="pre">group</span></code>属性を設定する必要があり、管理が煩雑になる。</td>
<td>グループパターンにデフォルト値を設定できる(グループの大多数に共通項がある)場合に使用すべき</td>
</tr>
</tbody>
</table>
<p><strong>使用の判断ポイントのどちらにも当てはまらない場合は、Bean Validationの使用が不適切であることが考えられる。</strong>設計を見直したうえで、Spring Validatorの使用または業務ロジックチェックでの実装を検討すること。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>これまでの例ではバリデーショングループの切り替えは、リクエストパラメータ等、<code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>アノテーションで指定できるパラメータによって行った。
この方法では認証オブジェクトが有する権限情報など、<code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>アノテーションでは扱えない情報でグループを切り替えることはできない。</p>
<p>この場合は、<code class="docutils literal"><span class="pre">&#64;Validated</span></code>アノテーションを使用せず、<code class="docutils literal"><span class="pre">org.springframework.validation.SmartValidator</span></code>を使用し、Controllerのハンドラメソッド内でグループを指定したバリデーションを行えばよい。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">SmartValidator</span> <span class="n">smartValidator</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;confirm&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createConfirm</span><span class="o">(</span><span class="cm">/* (2) */</span> <span class="n">UserForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// (3)</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">validationGroup</span> <span class="o">=</span> <span class="n">Default</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
        <span class="c1">// logic to determine validation group</span>
        <span class="c1">// if (xxx) {</span>
        <span class="c1">//     validationGroup = Xxx.class;</span>
        <span class="c1">// }</span>
        <span class="n">smartValidator</span><span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">form</span><span class="o">,</span> <span class="n">result</span><span class="o">,</span> <span class="n">validationGroup</span><span class="o">);</span> <span class="c1">// (4)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">&quot;user/createForm&quot;</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="s">&quot;user/createConfirm&quot;</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">SmartValidator</span></code>をインジェクションする。<code class="docutils literal"><span class="pre">SmartValidator</span></code>は<code class="docutils literal"><span class="pre">&lt;mvc:annotation-driven&gt;</span></code>の設定が行われていれば使用できるため、別途Bean定義不要である。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;Validated</span></code>アノテーションは使わない。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">バリデーショングループを決定する。</div>
<div class="line">バリデーショングループを決定するロジックは、Helperクラスに委譲して、Controller内のロジックをシンプルな状態に保つことを推奨する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">SmartValidator</span></code>の<code class="docutils literal"><span class="pre">validate</span></code>メソッドを使用して、グループを指定したバリデーションを実行する。</div>
<div class="line">グループの指定は可変長引数になっており、複数指定できる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p class="last">基本的には、Controllerにロジックを書くべきではないため、<code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>の属性でルールを切り替えられるのであれば、<code class="docutils literal"><span class="pre">SmartValidator</span></code>は使わない方がよい。</p>
</div>
</div>
</div>
<div class="section" id="validation-correlation-check">
<span id="id10"></span><h3><a class="toc-backref" href="#id52">4.1.2.3. 相関項目チェック</a><a class="headerlink" href="#validation-correlation-check" title="Permalink to this headline">¶</a></h3>
<p>複数フィールドにまたがる相関項目チェックには、
Spring Validator(<code class="docutils literal"><span class="pre">org.springframework.validation.Validator</span></code>インタフェースを実装した<code class="docutils literal"><span class="pre">Validator</span></code>)、
または、Bean Validationを用いる。</p>
<p>それぞれ説明するが、先にそれぞれの特徴と推奨する使い分けを述べる。</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="20%" />
<col width="40%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">方式</th>
<th class="head">特徴</th>
<th class="head">用途</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">Spring Validator</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">特定のクラスに対する入力チェックの作成が容易である。</div>
<div class="line">Controllerでの利用が不便。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">特定のフォームに依存した業務要件固有の入力チェック実装</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">Bean Validation</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力チェックの作成はSpring Validatorほど容易でない。</div>
<div class="line">Controllerでの利用が容易。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">特定のフォームに依存しない、開発プロジェクト共通の入力チェック実装</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="section" id="spring-validator">
<h4><a class="toc-backref" href="#id53">4.1.2.3.1. Spring Validatorによる相関項目チェック実装</a><a class="headerlink" href="#spring-validator" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">「パスワードリセット」処理を例に実装方法を説明する。</div>
<div class="line">以下のルールを実装する。ここでは「パスワードリセット」のフォームに以下のチェックルールを設ける。</div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="20%" />
<col width="30%" />
<col width="30%" />
<col width="20%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">フィールド名</th>
<th class="head">型</th>
<th class="head">ルール</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">password</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">java.lang.String</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力必須</div>
<div class="line">8文字以上</div>
<div class="line"><strong>confirmPasswordと同じ値であること</strong></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">confirmPassword</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">java.lang.String</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">特になし</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">確認用パスワード</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>「confirmPasswordと同じ値であること」というルールは<code class="docutils literal"><span class="pre">password</span></code>フィールドと<code class="docutils literal"><span class="pre">confirmPassword</span></code>フィールドの両方の情報が必要であるため、相関項目チェックルールである。</p>
<ul>
<li><p class="first">フォームクラス</p>
<p>相関項目チェックルール以外は、これまで通りBean Validationのアノテーションで実装する。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.sample.app.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordResetForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">8</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">confirmPassword</span><span class="o">;</span>

    <span class="c1">// omitted setter/getter</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">パスワードは、通常ハッシュ化してデータベースに保存するため、最大値のチェックは行わなくても良い。</p>
</div>
</li>
<li><p class="first">Validatorクラス</p>
<p><code class="docutils literal"><span class="pre">org.springframework.validation.Validator</span></code>インタフェースを実装して、相関項目チェックルールを実現する。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.sample.app.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.Errors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.Validator</span><span class="o">;</span>

<span class="nd">@Component</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordEqualsValidator</span> <span class="kd">implements</span> <span class="n">Validator</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">PasswordResetForm</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span> <span class="c1">// (2)</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">validate</span><span class="o">(</span><span class="n">Object</span> <span class="n">target</span><span class="o">,</span> <span class="n">Errors</span> <span class="n">errors</span><span class="o">)</span> <span class="o">{</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">errors</span><span class="o">.</span><span class="na">hasFieldErrors</span><span class="o">(</span><span class="s">&quot;password&quot;</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// (3)</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">PasswordResetForm</span> <span class="n">form</span> <span class="o">=</span> <span class="o">(</span><span class="n">PasswordResetForm</span><span class="o">)</span> <span class="n">target</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="na">getPassword</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">confirmPassword</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="na">getConfirmPassword</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">password</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">confirmPassword</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// (4)</span>
            <span class="n">errors</span><span class="o">.</span><span class="na">rejectValue</span><span class="o">(</span><span class="cm">/* (5) */</span> <span class="s">&quot;password&quot;</span><span class="o">,</span>
            <span class="cm">/* (6) */</span> <span class="s">&quot;PasswordEqualsValidator.passwordResetForm.password&quot;</span><span class="o">,</span>
            <span class="cm">/* (7) */</span> <span class="s">&quot;password and confirm password must be same.&quot;</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;Component</span></code>を付与し、Validatorをコンポーネントスキャン対象にする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">このValidatorのチェック対象であるかどうかを判別する。ここでは、<code class="docutils literal"><span class="pre">PasswordResetForm</span></code>クラスをチェック対象とする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">単項目チェック時に対象フィールドでエラーが発生している場合は、このValidatorで相関チェックは行わない。</div>
<div class="line">相関チェックを必ず行う必要がある場合は、この判定ロジックは不要である。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">チェックロジックを実装する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラー対象のフィールド名を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラーメッセージのコード名を指定する。ここではコードを、</div>
<div class="line">“バリデータ名.フォーム属性名.プロパティ名”</div>
<div class="line">とする。メッセージ定義は<a class="reference internal" href="#validation-message-in-application-messages"><span class="std std-ref">application-messages.propertiesに定義するメッセージ</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラーメッセージをコードで解決できなかった場合に使用する、デフォルトメッセージを設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Spring Validator実装クラスは、使用するControllerと同じパッケージに配置することを推奨する。</p>
</div>
</li>
<li><p class="first">Controllerクラス</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.sample.app.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.BindingResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.WebDataBinder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.InitBinder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ModelAttribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;password&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordResetController</span> <span class="o">{</span>
    <span class="nd">@Inject</span>
    <span class="n">PasswordEqualsValidator</span> <span class="n">passwordEqualsValidator</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="nd">@ModelAttribute</span>
    <span class="kd">public</span> <span class="n">PasswordResetForm</span> <span class="nf">setupForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">PasswordResetForm</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@InitBinder</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initBinder</span><span class="o">(</span><span class="n">WebDataBinder</span> <span class="n">binder</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">binder</span><span class="o">.</span><span class="na">addValidators</span><span class="o">(</span><span class="n">passwordEqualsValidator</span><span class="o">);</span> <span class="c1">// (2)</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;reset&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">resetForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;password/resetForm&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;reset&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">reset</span><span class="o">(</span><span class="nd">@Validated</span> <span class="n">PasswordResetForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (3)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">&quot;password/resetForm&quot;</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="s">&quot;redirect:/password/reset?complete&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;reset&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;complete&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">resetComplete</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;password/resetComplete&quot;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">使用するSpring Validatorを、インジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;InitBinder</span></code>アノテーションがついたメソッド内で、<code class="docutils literal"><span class="pre">WebDataBinder.addValidators</span></code>メソッドにより、Validatorを追加する。</div>
<div class="line">これにより、<code class="docutils literal"><span class="pre">&#64;Validated</span></code>アノテーションでバリデーションをする際に、追加したValidatorも呼び出される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力チェックの実装は、これまで通りである。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">JSP</p>
<p>JSPに特筆すべき点はない。</p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="k">&lt;%-</span><span class="o">-</span> <span class="n">WEB</span><span class="o">-</span><span class="n">INF</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">password</span><span class="o">/</span><span class="n">resetForm</span><span class="o">.</span><span class="na">jsp</span> <span class="o">--</span><span class="k">%&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;style</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
/* omitted */
<span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;form:form</span> <span class="na">modelAttribute=</span><span class="s">&quot;passwordResetForm&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span>
        <span class="na">class=</span><span class="s">&quot;form-horizontal&quot;</span>
        <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/password/reset&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;password&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Password:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:password</span> <span class="na">path=</span><span class="s">&quot;password&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;password&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;confirmPassword&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Password (Confirm):<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:password</span> <span class="na">path=</span><span class="s">&quot;confirmPassword&quot;</span>
            <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;confirmPassword&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;form:button&gt;</span>Reset<span class="nt">&lt;/form:button&gt;</span>
    <span class="nt">&lt;/form:form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
</li>
</ul>
<p><code class="docutils literal"><span class="pre">password</span></code>フィールドと、<code class="docutils literal"><span class="pre">confirmPassword</span></code>フィールドに、別の値を入力してフォームを送信した場合は、以下のようにエラーメッセージが表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/validations-correlation-check1.png"><img alt="../../_images/validations-correlation-check1.png" src="../../_images/validations-correlation-check1.png" style="width: 60%;" /></a>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">&lt;form:password&gt;</span></code>タグを使用すると、再表示時に、データがクリアされる。</p>
</div>
<div class="admonition note" id="validation-how-to-cross-field-validation-for-multi-field-highlight">
<p class="first admonition-title">Note</p>
<p>相関チェック対象の複数フィールドに対してエラー情報を設定することも可能である。
ただし、必ずエラーメッセージの表示とスタイル適用がセットで行われ、いずれか片方のみを行うことはできない。</p>
<p>相関チェックエラーとなった両方のフィールドにスタイル適用したいが、エラーメッセージは1つだけ表示したいような場合は、
エラーメッセージに空文字を設定することで実現することが可能である。
以下に、<code class="docutils literal"><span class="pre">password</span></code>フィールドと<code class="docutils literal"><span class="pre">confirmPassword</span></code>フィールドにスタイルを適用し、<code class="docutils literal"><span class="pre">password</span></code>フィールドのみにエラーメッセージを表示する例を示す。</p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.sample.app.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.Errors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.Validator</span><span class="o">;</span>

<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordEqualsValidator</span> <span class="kd">implements</span> <span class="n">Validator</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">PasswordResetForm</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">validate</span><span class="o">(</span><span class="n">Object</span> <span class="n">target</span><span class="o">,</span> <span class="n">Errors</span> <span class="n">errors</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// omitted</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">password</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">confirmPassword</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// register a field error for password</span>
            <span class="n">errors</span><span class="o">.</span><span class="na">rejectValue</span><span class="o">(</span><span class="s">&quot;password&quot;</span><span class="o">,</span>
                   <span class="s">&quot;PasswordEqualsValidator.passwordResetForm.password&quot;</span><span class="o">,</span>
                   <span class="s">&quot;password and confirm password must be same.&quot;</span><span class="o">);</span>

            <span class="c1">// register a field error for confirmPassword</span>
            <span class="n">errors</span><span class="o">.</span><span class="na">rejectValue</span><span class="o">(</span><span class="s">&quot;confirmPassword&quot;</span><span class="o">,</span> <span class="c1">// (1)</span>
                      <span class="s">&quot;PasswordEqualsValidator.passwordResetForm.confirmPassword&quot;</span><span class="o">,</span> <span class="c1">// (2)</span>
                      <span class="s">&quot;&quot;</span><span class="o">);</span> <span class="c1">// (3)</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">confirmPassword</span></code>フィールドのエラーを登録する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラーメッセージのコード名を指定する。この際、対応するエラーメッセージに空文字を指定する。</div>
<div class="line">メッセージ定義は<a class="reference internal" href="#validation-message-in-application-messages"><span class="std std-ref">application-messages.propertiesに定義するメッセージ</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラーメッセージをコードで解決できなかった場合に使用する、デフォルトメッセージを設定する。</div>
<div class="line">上記の例では空文字を設定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><code class="docutils literal"><span class="pre">&#64;InitBinder</span></code>アノテーションを付与したメソッドでValidatorが登録されると、Validatorの <code class="docutils literal"><span class="pre">supports</span></code>メソッドでValidatorのサポート対象の型かどうか判定される。このとき、サポート対象でない場合は<code class="docutils literal"><span class="pre">java.lang.IllegalStateException</span></code>が発生する点に注意されたい。</p>
<p><code class="docutils literal"><span class="pre">&#64;InitBinder</span></code>アノテーションを付与したメソッドは、Modelに独自の型のオブジェクトが追加された際に必ず実行されるが、 <code class="docutils literal"><span class="pre">&#64;InitBinder(&quot;xxx&quot;)</span></code>でモデル名を指定することで、適用範囲を限定することが可能である。</p>
<p>例えば以下のようなケースが該当するため、注意されたい。</p>
<ul class="simple">
<li>一つのControllerで複数のフォームを扱う場合（複数のフォームオブジェクトを <code class="docutils literal"><span class="pre">&#64;ModelAttribute</span></code>アノテーションを付与したメソッドで登録する場合や、ハンドラメソッドの引数として受け取る場合）</li>
<li>フォームオブジェクトに限らず、ハンドラメソッドの引数として受け取った<code class="docutils literal"><span class="pre">Model</span></code>に、<code class="docutils literal"><span class="pre">ResultMessages</span></code>オブジェクトや<code class="docutils literal"><span class="pre">Page</span></code>オブジェクトなどの独自の型のオブジェクトを登録する場合</li>
<li>同様に<code class="docutils literal"><span class="pre">RedirectAttributes</span></code>に独自の型のオブジェクトを登録する場合</li>
</ul>
<p>以下に、一つのControllerで複数のフォームを扱う場合の実装例を示す。</p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;xxx&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">XxxController</span> <span class="o">{</span>
    <span class="c1">// omitted</span>
    <span class="nd">@ModelAttribute</span><span class="o">(</span><span class="s">&quot;aaa&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nf">AaaForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">AaaForm</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@ModelAttribute</span><span class="o">(</span><span class="s">&quot;bbb&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nf">BbbForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">BbbForm</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@InitBinder</span><span class="o">(</span><span class="s">&quot;aaa&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initBinderForAaa</span><span class="o">(</span><span class="n">WebDataBinder</span> <span class="n">binder</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// add validators for AaaForm</span>
        <span class="n">binder</span><span class="o">.</span><span class="na">addValidators</span><span class="o">(</span><span class="n">aaaValidator</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@InitBinder</span><span class="o">(</span><span class="s">&quot;bbb&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initBinderForBbb</span><span class="o">(</span><span class="n">WebDataBinder</span> <span class="n">binder</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// add validators for BbbForm</span>
        <span class="n">binder</span><span class="o">.</span><span class="na">addValidators</span><span class="o">(</span><span class="n">bbbValidator</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// omitted</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>相関項目チェックルールのチェック内容をバリデーショングループに応じて変更したい場合（例えば、特定のバリデーショングループが指定された場合だけ相関項目チェックを実施したい場合など）は、 <code class="docutils literal"><span class="pre">org.springframework.validation.Validator</span></code>インターフェイスを実装する代わりに、 <code class="docutils literal"><span class="pre">org.springframework.validation.SmartValidator</span></code>インターフェイスを実装し、validateメソッド内で処理を切り替えるとよい。</p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.sample.app.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.commons.lang3.ArrayUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.Errors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.SmartValidator</span><span class="o">;</span>

<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordEqualsValidator</span> <span class="kd">implements</span> <span class="n">SmartValidator</span> <span class="o">{</span> <span class="c1">// Implements SmartValidator instead of Validator interface</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">PasswordResetForm</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">validate</span><span class="o">(</span><span class="n">Object</span> <span class="n">target</span><span class="o">,</span> <span class="n">Errors</span> <span class="n">errors</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">validate</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">errors</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{});</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">validate</span><span class="o">(</span><span class="n">Object</span> <span class="n">target</span><span class="o">,</span> <span class="n">Errors</span> <span class="n">errors</span><span class="o">,</span> <span class="n">Object</span><span class="o">...</span> <span class="n">validationHints</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Check validationHints(groups) and apply validation logic only when &#39;Update.class&#39; is specified</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ArrayUtils</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">validationHints</span><span class="o">,</span> <span class="n">Update</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">PasswordResetForm</span> <span class="n">form</span> <span class="o">=</span> <span class="o">(</span><span class="n">PasswordResetForm</span><span class="o">)</span> <span class="n">target</span><span class="o">;</span>
            <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="na">getPassword</span><span class="o">();</span>
            <span class="n">String</span> <span class="n">confirmPassword</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="na">getConfirmPassword</span><span class="o">();</span>

            <span class="c1">// omitted...</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="bean-validation">
<h4><a class="toc-backref" href="#id54">4.1.2.3.2. Bean Validationによる相関項目チェック実装</a><a class="headerlink" href="#bean-validation" title="Permalink to this headline">¶</a></h4>
<p>Bean Validationによって、相関項目チェックの実装するためには、独自バリデーションルールの追加を行う必要がある。</p>
<p><a class="reference internal" href="#validation-custom-constraint"><span class="std std-ref">How to extend</span></a>にて説明する。</p>
</div>
</div>
<div class="section" id="validation-message-def">
<span id="id11"></span><h3><a class="toc-backref" href="#id55">4.1.2.4. エラーメッセージの定義</a><a class="headerlink" href="#validation-message-def" title="Permalink to this headline">¶</a></h3>
<p>入力チェックエラーメッセージを変更する方法を説明する。</p>
<p>Spring MVCによるBean Validationのエラーメッセージは、以下の順で解決される。</p>
<ol class="arabic">
<li><div class="first line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.context.MessageSource</span></code>に定義されているメッセージの中に、ルールに合致するものがあればそれをエラーメッセージとして使用する (Springのルール)。</div>
<div class="line">Springのデフォルトのルールについては、「<a class="reference external" href="https://docs.spring.io/spring/docs/5.1.4.RELEASE/javadoc-api/org/springframework/validation/DefaultMessageCodesResolver.html">DefaultMessageCodesResolverのJavaDoc</a>」を参照されたい。</div>
</div>
</li>
<li><p class="first">1.でメッセージが見つからない場合、アノテーションの<code class="docutils literal"><span class="pre">message</span></code>属性に、指定されたメッセージからエラーメッセージを取得する (Bean Validationのルール)</p>
</li>
</ol>
<blockquote>
<div><ol class="arabic simple">
<li><code class="docutils literal"><span class="pre">message</span></code>属性に指定されたメッセージが、”{メッセージキー}”形式でない場合、そのテキストをエラーメッセージとして使用する。</li>
<li><code class="docutils literal"><span class="pre">message</span></code>属性に指定されたメッセージが、”{メッセージキー}”形式の場合、クラスパス直下のValidationMessages.propertiesから、メッセージキーに対応するメッセージを探す。</li>
</ol>
<blockquote>
<div><ol class="arabic simple">
<li>メッセージキーに対応するメッセージが定義されている場合は、そのメッセージを使用する</li>
<li>メッセージキーに対応するメッセージが定義されていない場合は、”{メッセージキー}”をそのままエラーメッセージとして使用する</li>
</ol>
</div></blockquote>
</div></blockquote>
<p>基本的にエラーメッセージは、propertiesファイルに定義することを推奨する。</p>
<p>定義する箇所は、以下の2パターン存在する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">org.springframework.context.MessageSource</span></code>が読み込むpropertiesファイル</li>
<li>クラスパス直下のValidationMessages.properties</li>
</ul>
<p>以下の説明では、applicationContext.xmlに次の設定があることを前提とし、前者を”application-messages.properties”、後者を”ValidationMessages.properties”と呼ぶ。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;messageSource&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.context.support.ResourceBundleMessageSource&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;basenames&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;list&gt;</span>
            <span class="nt">&lt;value&gt;</span>i18n/application-messages<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/validations-message-properties-position-image.png"><img alt="../../_images/validations-message-properties-position-image.png" src="../../_images/validations-message-properties-position-image.png" style="width: 40%;" /></a>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><code class="docutils literal"><span class="pre">ValidationMessages.properties</span></code>ファイルは、クラスパスの直下に複数存在させてはいけない。</p>
<p>クラスパスの直下に複数の<code class="docutils literal"><span class="pre">ValidationMessages.properties</span></code>ファイルが存在する場合、
いずれか１つのファイルが読み込まれ、他のファイルが読み込まれないため、適切なメッセージが表示されない可能性がある。</p>
<ul class="simple">
<li>マルチプロジェクト構成を採用する場合は、<code class="docutils literal"><span class="pre">ValidationMessages.properties</span></code>ファイルを複数のプロジェクトに配置しないように注意すること。</li>
<li>Bean Validation用の共通部品をjarファイルとして配布する際に、<code class="docutils literal"><span class="pre">ValidationMessages.properties</span></code>ファイルをjarファイルの中に含めないように注意すること。</li>
</ul>
<p class="last">なお、version 1.0.2.RELEASE以降の <a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw-web-multi-blank">ブランクプロジェクト</a> からプロジェクトを生成した場合は、
<code class="docutils literal"><span class="pre">xxx-web/src/main/resources</span></code>の直下に<code class="docutils literal"><span class="pre">ValidationMessages.properties</span></code>が格納されている。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>本ガイドラインでは、以下のように定義を分けることを推奨する。</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">プロパティファイル名</th>
<th class="head">定義する内容</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">ValidationMessages.properties</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">システムで定めたBean Validationのデフォルトエラーメッセージ</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">application-messages.properties</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">個別で上書きしたいBean Validationのエラーメッセージ</div>
<div class="line">Spring Validatorで実装した入力チェックのエラーメッセージ</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>ValidationMessages.propertiesを用意しない場合は、<a class="reference internal" href="#validation-default-message-in-hibernate-validator"><span class="std std-ref">Hibernate Validatorが用意するデフォルトメッセージ</span></a>が使用される。</p>
<p><code class="docutils literal"><span class="pre">MessageSource</span></code>と連携することで、日本語メッセージをNative to Asciiせずに直接扱うことができる。
詳細は、<a class="reference internal" href="#validation-without-native2ascii"><span class="std std-ref">Native to Asciiを行わないメッセージの読み込み</span></a>を参照されたい。</p>
<div class="section" id="validationmessages-properties">
<span id="validation-message-in-validationmessages"></span><h4><a class="toc-backref" href="#id56">4.1.2.4.1. ValidationMessages.propertiesに定義するメッセージ</a><a class="headerlink" href="#validationmessages-properties" title="Permalink to this headline">¶</a></h4>
<p>クラスパス直下(通常src/main/resources)のValidationMessages.properties内の、
Bean Validationのアノテーションの<code class="docutils literal"><span class="pre">message</span></code>属性に指定されたメッセージキーに対して、メッセージを定義する。</p>
<p><a class="reference internal" href="#validation-basic-validation"><span class="std std-ref">基本的な単項目チェック</span></a>の初めに使用した、以下のフォームを用いて説明する。</p>
<ul>
<li><p class="first">フォームクラス(再掲)</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">20</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">50</span><span class="o">)</span>
    <span class="nd">@Email</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Min</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
    <span class="nd">@Max</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">age</span><span class="o">;</span>

    <span class="c1">// omitted getter/setter</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">ValidationMessages.properties</p>
<p><code class="docutils literal"><span class="pre">&#64;NotNull</span></code>, <code class="docutils literal"><span class="pre">&#64;Size</span></code>, <code class="docutils literal"><span class="pre">&#64;Min</span></code>, <code class="docutils literal"><span class="pre">&#64;Max</span></code>, <code class="docutils literal"><span class="pre">&#64;Email</span></code>のエラーメッセージを変更する。</p>
<div class="highlight-properties"><div class="highlight"><pre><span></span><span class="na">javax.validation.constraints.NotNull.message</span><span class="o">=</span><span class="s">is required.</span>
<span class="c"># (1)</span>
<span class="na">javax.validation.constraints.Size.message</span><span class="o">=</span><span class="s">size is not in the range {min} through {max}.</span>
<span class="na">javax.validation.constraints.Min.message</span><span class="o">=</span><span class="s">can not be less than {value}.</span>
<span class="na">javax.validation.constraints.Max.message</span><span class="o">=</span><span class="s">can not be greater than {value}.</span>
<span class="na">javax.validation.constraints.Email.message</span><span class="o">=</span><span class="s">is an invalid e-mail address.</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アノテーションに指定した属性値は、<code class="docutils literal"><span class="pre">{属性名}</span></code>で埋め込むことができる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<p>この設定を加えた状態で、すべての入力フィールドを未入力のままフォームを送信すると、以下のように変更したエラーメッセージが、表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/validations-customize-message1.png"><img alt="../../_images/validations-customize-message1.png" src="../../_images/validations-customize-message1.png" style="width: 60%;" /></a>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Bean Validation標準のアノテーションやHibernate Validator独自のアノテーションには<code class="docutils literal"><span class="pre">message</span></code>属性に<code class="docutils literal"><span class="pre">{アノテーションのFQCN.message}</span></code>という値が設定されているため、</p>
<blockquote>
<div><div class="highlight-properties"><div class="highlight"><pre><span></span><span class="na">アノテーションのFQCN.message</span><span class="o">=</span><span class="s">メッセージ</span>
</pre></div>
</div>
</div></blockquote>
<p class="last">という形式でプロパティファイルにメッセージを定義すればよいが、すべてのアノテーションが、この形式になっているわけではないので、
対象のアノテーションのJavadocまたはソースコードを確認すること。</p>
</div>
<p>エラーメッセージに、フィールド名を含める場合は、以下のように、メッセージに<code class="docutils literal"><span class="pre">{0}</span></code>を加える。</p>
<ul>
<li><p class="first">ValidationMessages.properties</p>
<p><code class="docutils literal"><span class="pre">&#64;NotNull</span></code>、<code class="docutils literal"><span class="pre">&#64;Size</span></code>、<code class="docutils literal"><span class="pre">&#64;Min</span></code>、<code class="docutils literal"><span class="pre">&#64;Max</span></code>、<code class="docutils literal"><span class="pre">&#64;Email</span></code>のエラーメッセージを変更する。</p>
<div class="highlight-properties"><div class="highlight"><pre><span></span><span class="na">javax.validation.constraints.NotNull.message</span><span class="o">=</span><span class="s">&quot;{0}&quot; is required.</span>
<span class="na">javax.validation.constraints.Size.message</span><span class="o">=</span><span class="s">The size of &quot;{0}&quot; is not in the range {min} through {max}.</span>
<span class="na">javax.validation.constraints.Min.message</span><span class="o">=</span><span class="s">&quot;{0}&quot; can not be less than {value}.</span>
<span class="na">javax.validation.constraints.Max.message</span><span class="o">=</span><span class="s">&quot;{0}&quot; can not be greater than {value}.</span>
<span class="na">javax.validation.constraints.Email.message</span><span class="o">=</span><span class="s">&quot;{0}&quot; is an invalid e-mail address.</span>
</pre></div>
</div>
</li>
</ul>
<p>エラーメッセージは、以下のように変更される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/validations-customize-message2.png"><img alt="../../_images/validations-customize-message2.png" src="../../_images/validations-customize-message2.png" style="width: 60%;" /></a>
</div>
<p>このままでは、フォームクラスのプロパティ名が表示されてしまい、ユーザーフレンドリではない。
適切なフィールド名を表示したい場合は、<strong>application-messages.propertiesに</strong></p>
<div class="highlight-properties"><div class="highlight"><pre><span></span><span class="na">フォームのプロパティ名</span><span class="o">=</span><span class="s">表示するフィールド名</span>
</pre></div>
</div>
<p>形式でフィールド名を定義すればよい。</p>
<p>これまでの例に、以下の設定を追加する。</p>
<ul>
<li><p class="first">application-messages.properties</p>
<div class="highlight-properties"><div class="highlight"><pre><span></span><span class="na">name</span><span class="o">=</span><span class="s">Name</span>
<span class="na">email</span><span class="o">=</span><span class="s">Email</span>
<span class="na">age</span><span class="o">=</span><span class="s">Age</span>
</pre></div>
</div>
</li>
</ul>
<p>エラーメッセージは、以下のように変更される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/validations-customize-message3.png"><img alt="../../_images/validations-customize-message3.png" src="../../_images/validations-customize-message3.png" style="width: 60%;" /></a>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">{0}</span></code>でフィールド名を埋め込めるのは、Bean Validationの機能ではなく、Springの機能である。
したがって、フィールド名変更の設定は、Spring管理下のapplication-messages.properties(<code class="docutils literal"><span class="pre">ResourceBundleMessageSource</span></code>)に定義する必要がある。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Bean Validation 1.1より、
<code class="file docutils literal"><span class="pre">ValidationMessages.properties</span></code> に指定するメッセージの中にExpression Language(以降、「EL式」と呼ぶ)を使用する事ができるようになった。
Hibernate Validator 6.xでは、Expression Language 3.0以上をサポートしている。</p>
<p>実行可能なEL式のバージョンは、アプリケーションサーバのバージョンによって異なる。
そのため、EL式を使用する場合は、<strong>アプリケーションサーバがサポートしているEL式のバージョンを確認した上で使用すること。</strong></p>
<p>以下に、Hibernate Validatorがデフォルトで用意している <code class="file docutils literal"><span class="pre">ValidationMessages.properties</span></code> に定義されているメッセージを例に、EL式の使用例を示す。</p>
<blockquote>
<div><div class="highlight-properties"><div class="highlight"><pre><span></span><span class="c"># ...</span>
<span class="c"># (1)</span>
<span class="na">javax.validation.constraints.DecimalMax.message</span>  <span class="o">=</span> <span class="s">must be less than ${inclusive == true ? &#39;or equal to &#39; : &#39;&#39;}{value}</span>
<span class="c"># ...</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p class="first">メッセージの中の 「<code class="docutils literal"><span class="pre">${inclusive</span> <span class="pre">==</span> <span class="pre">true</span> <span class="pre">?</span> <span class="pre">'or</span> <span class="pre">equal</span> <span class="pre">to</span> <span class="pre">'</span> <span class="pre">:</span> <span class="pre">''}</span></code>」の部分がEL式である。</p>
<p>上記のメッセージ定義から実際に生成されるメッセージのパターンは、</p>
<ul class="simple">
<li>must be less than or equal to {value}</li>
<li>must be less than {value}</li>
</ul>
<p>の2パターンとなる。(<code class="docutils literal"><span class="pre">{value}</span></code>の部分には、<code class="docutils literal"><span class="pre">&#64;DecimalMax</span></code>アノテーションの <code class="docutils literal"><span class="pre">value</span></code>属性に指定した値が埋め込まれる)</p>
<p>前者は<code class="docutils literal"><span class="pre">&#64;DecimalMax</span></code>アノテーションの <code class="docutils literal"><span class="pre">inclusive</span></code>属性に <code class="docutils literal"><span class="pre">true</span></code>を指定した場合(又は指定しなかった場合)、
後者は<code class="docutils literal"><span class="pre">&#64;DecimalMax</span></code>アノテーションの <code class="docutils literal"><span class="pre">inclusive</span></code>属性に <code class="docutils literal"><span class="pre">false</span></code>を指定した場合に生成される。</p>
<p class="last">Bean ValidationにおけるEL式の扱いについては、
<a class="reference external" href="https://docs.jboss.org/hibernate/validator/6.0/reference/en-US/html_single/#section-interpolation-with-message-expressions">Hibernate Validator Reference Guide(Interpolation with message expressions)</a>を参照されたい。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>また、<code class="file docutils literal"><span class="pre">ValidationMessages.properties</span></code> に指定するメッセージに <code class="docutils literal"><span class="pre">${validatedValue}</span></code>を使用することで、エラーメッセージにチェック対象の値を含むことができる。</p>
<p>以下に、 <code class="docutils literal"><span class="pre">${validatedValue}</span></code>の使用例を示す。</p>
<blockquote class="last">
<div><div class="highlight-properties"><div class="highlight"><pre><span></span><span class="c"># ...</span>
<span class="c"># (1)</span>
<span class="na">javax.validation.constraints.Pattern.message</span> <span class="o">=</span> <span class="s">The value entered &quot;${validatedValue}&quot; is invalid.</span>
<span class="c"># ...</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p class="first">上記のメッセージ定義から実際に生成されるメッセージは、 <code class="docutils literal"><span class="pre">${validatedValue}</span></code>の部分にフォームに入力した値が埋め込まれる。
入力値に機密情報を含む場合、機密情報がメッセージに表示されないようにするため、 <code class="docutils literal"><span class="pre">${validatedValue}</span></code>を使用しないように注意すること。</p>
<p class="last">詳細については、<a class="reference external" href="https://docs.jboss.org/hibernate/validator/6.0/reference/en-US/html_single/#section-interpolation-with-message-expressions">Hibernate Validator Reference Guide(Interpolation with message expressions)</a>を参照されたい。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div>
<div class="section" id="application-messages-properties">
<span id="validation-message-in-application-messages"></span><h4><a class="toc-backref" href="#id57">4.1.2.4.2. application-messages.propertiesに定義するメッセージ</a><a class="headerlink" href="#application-messages-properties" title="Permalink to this headline">¶</a></h4>
<p>ValidationMessages.propertiesでシステムが利用するデフォルトのメッセージを定義したが、
画面によっては、デフォルトメッセージから変更したい場合が出てくる。</p>
<p>その場合、application-messages.propertiesに、以下の形式でメッセージを定義する。</p>
<div class="highlight-properties"><div class="highlight"><pre><span></span><span class="na">アノテーション名.フォーム属性名.プロパティ名</span><span class="o">=</span><span class="s">対象のメッセージ</span>
</pre></div>
</div>
<p><a class="reference internal" href="#validation-message-in-validationmessages"><span class="std std-ref">ValidationMessages.propertiesに定義するメッセージ</span></a>の設定がある前提で、以下の設定で<code class="docutils literal"><span class="pre">email</span></code>と<code class="docutils literal"><span class="pre">age</span></code>フィールドのメッセージを上書きする。</p>
<ul>
<li><p class="first">application-messages.properties</p>
<div class="highlight-properties"><div class="highlight"><pre><span></span><span class="c"># override messages</span>
<span class="c"># for email field</span>
<span class="na">Size.userForm.email</span><span class="o">=</span><span class="s">The size of &quot;{0}&quot; must be between {2} and {1}.</span>
<span class="c"># for age field</span>
<span class="na">NotNull.userForm.age</span><span class="o">=</span><span class="s">&quot;{0}&quot; is compulsory.</span>
<span class="na">Min.userForm.age</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be greater than or equal to {1}.</span>
<span class="na">Max.userForm.age</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be less than or equal to {1}.</span>

<span class="c"># filed names</span>
<span class="na">name</span><span class="o">=</span><span class="s">Name</span>
<span class="na">email</span><span class="o">=</span><span class="s">Email</span>
<span class="na">age</span><span class="o">=</span><span class="s">Age</span>
</pre></div>
</div>
</li>
</ul>
<p>アノテーションの属性値は、<code class="docutils literal"><span class="pre">{1}</span></code>以降に埋め込まれる。なお、属性値のインデックス位置は、アノテーションの属性名のアルファベット順(昇順)となる。</p>
<p>例えば、<code class="docutils literal"><span class="pre">&#64;Size</span></code>のインデックス位置は、</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">{0}</span></code> : プロパティ名 (物理名又は論理名)</li>
<li><code class="docutils literal"><span class="pre">{1}</span></code> : <code class="docutils literal"><span class="pre">max</span></code>属性の値</li>
<li><code class="docutils literal"><span class="pre">{2}</span></code> : <code class="docutils literal"><span class="pre">min</span></code>属性の値</li>
</ul>
<p>となる。
仕様の詳細については <a class="reference external" href="https://docs.spring.io/spring/docs/5.1.4.RELEASE/javadoc-api/org/springframework/validation/beanvalidation/SpringValidatorAdapter.html#getArgumentsForConstraint-java.lang.String-java.lang.String-javax.validation.metadata.ConstraintDescriptor-">SpringValidatorAdapterのJavaDoc</a>を参照されたい。</p>
<p>エラーメッセージは以下のように変更される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/validations-customize-message4.png"><img alt="../../_images/validations-customize-message4.png" src="../../_images/validations-customize-message4.png" style="width: 60%;" /></a>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">application-messages.propertiesのメッセージキーの形式は、<a class="reference external" href="https://docs.spring.io/spring/docs/5.1.4.RELEASE/javadoc-api/org/springframework/validation/DefaultMessageCodesResolver.html">これ以外にも用意されている</a>が、
デフォルトメッセージを一部上書きする目的で使用するのであれば、基本的に、<code class="docutils literal"><span class="pre">アノテーション名.フォーム属性名.プロパティ名</span></code>形式でよい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-extend">
<span id="validation-custom-constraint"></span><h2><a class="toc-backref" href="#id58">4.1.3. How to extend</a><a class="headerlink" href="#how-to-extend" title="Permalink to this headline">¶</a></h2>
<p>Bean Validationは標準で用意されているチェックルール以外に、独自ルール用アノテーションを作成する仕組みをもつ。</p>
<p>作成方法は大きく分けて、以下の観点で分かれる。</p>
<ul class="simple">
<li>既存ルールの組み合わせ</li>
<li>新規ルールの作成</li>
</ul>
<p>基本的には、以下の雛形を使用して、ルール毎にアノテーションを作成する。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.common.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.Documented</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Repeatable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Constraint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Payload</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.ANNOTATION_TYPE</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.CONSTRUCTOR</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.FIELD</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.METHOD</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.PARAMETER</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.TYPE_USE</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.RetentionPolicy.RUNTIME</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.common.validation.Xxx.List</span><span class="o">;</span>

<span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{})</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span><span class="o">,</span> <span class="n">TYPE_USE</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="nd">@Repeatable</span><span class="o">(</span><span class="n">List</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">Xxx</span> <span class="o">{</span>
    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{com.example.common.validation.Xxx.message}&quot;</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="nf">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span><span class="o">,</span> <span class="n">TYPE_USE</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">Xxx</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="section" id="validation-convine-existing-constraint">
<span id="id15"></span><h3><a class="toc-backref" href="#id59">4.1.3.1. 既存ルールを組み合わせたBean Validationアノテーションの作成</a><a class="headerlink" href="#validation-convine-existing-constraint" title="Permalink to this headline">¶</a></h3>
<p>システム共通で、</p>
<ul class="simple">
<li>文字列は半角英数字の文字種に限定したい</li>
<li>数値は8桁までの正の数に限定したい</li>
</ul>
<div class="line-block">
<div class="line">または、ドメイン共通で、</div>
</div>
<ul class="simple">
<li>「ユーザーID」は、4文字以上20文字以下の半角英字に制限したい</li>
<li>「年齢」は、1歳以上150歳以下に制限したい</li>
</ul>
<div class="line-block">
<div class="line">という制約がある場合を考える。</div>
<div class="line">これらは既存ルールの<code class="docutils literal"><span class="pre">&#64;Pattern</span></code>、<code class="docutils literal"><span class="pre">&#64;Size</span></code>、<code class="docutils literal"><span class="pre">&#64;Min</span></code>、<code class="docutils literal"><span class="pre">&#64;Max</span></code>等を組み合わせることでも実現できるが、</div>
<div class="line">同じルールを複数の箇所で使用すると、設定内容が分散してしまい、メンテナンス性が悪化する。</div>
</div>
<p>複数のルールを組み合わせて一つのルールを作成することができる。
独自アノテーションを作成すると、正規表現パターンや、最大値・最小値などの値を共通化できるだけでなく、エラーメッセージも共通化できるというメリットがある。
これにより、再利用性や保守性が高まる。複数のルールの組み合わせではなくても、一つのルールの属性を特定するだけでも効果的である。</p>
<p>以下に、実装例を示す。</p>
<ul>
<li><p class="first">半角英数字の文字種に限定する<code class="docutils literal"><span class="pre">&#64;Alphanumeric</span></code>アノテーションの実装例</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.common.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.Documented</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Repeatable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Constraint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Payload</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.ReportAsSingleViolation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Pattern</span><span class="o">;</span>

<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.ANNOTATION_TYPE</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.CONSTRUCTOR</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.FIELD</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.METHOD</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.PARAMETER</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.TYPE_USE</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.RetentionPolicy.RUNTIME</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.common.validation.AlphaNumeric.List</span><span class="o">;</span>

<span class="hll"><span class="nd">@Documented</span>
</span><span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{})</span> <span class="c1">// (1)</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span><span class="o">,</span> <span class="n">TYPE_USE</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="hll"><span class="nd">@Repeatable</span><span class="o">(</span><span class="n">List</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class="hll"><span class="nd">@ReportAsSingleViolation</span> <span class="c1">// (2)</span>
</span><span class="nd">@Pattern</span><span class="o">(</span><span class="n">regexp</span> <span class="o">=</span> <span class="s">&quot;[a-zA-Z0-9]*&quot;</span><span class="o">)</span> <span class="c1">// (3)</span>
<span class="hll"><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">AlphaNumeric</span> <span class="o">{</span>
</span>    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{com.example.common.validation.AlphaNumeric.message}&quot;</span><span class="o">;</span> <span class="c1">// (4)</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="nf">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span><span class="o">,</span> <span class="n">TYPE_USE</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">AlphaNumeric</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">既存のアノテーションを利用して実装を行う場合、<code class="docutils literal"><span class="pre">validatedBy</span></code>は空にしておく必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラーメッセージをまとめ、エラー時はこのアノテーションによるメッセージだけを変えるようにする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">このアノテーションにより使用されるルールを定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラーメッセージのデフォルト値を定義する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">8桁までの正の数に限定する<code class="docutils literal"><span class="pre">&#64;MaxDigits</span></code>アノテーションの実装例</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.common.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.Documented</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Repeatable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Constraint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Payload</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.ReportAsSingleViolation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.PositiveOrZero</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Max</span><span class="o">;</span>

<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.ANNOTATION_TYPE</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.CONSTRUCTOR</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.FIELD</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.METHOD</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.PARAMETER</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.TYPE_USE</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.RetentionPolicy.RUNTIME</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.common.validation.MaxDigits.List</span><span class="o">;</span>

<span class="hll"><span class="nd">@Documented</span>
</span><span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{})</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span><span class="o">,</span> <span class="n">TYPE_USE</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="hll"><span class="nd">@Repeatable</span><span class="o">(</span><span class="n">List</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class="hll"><span class="nd">@ReportAsSingleViolation</span>
</span><span class="hll"><span class="nd">@PositiveOrZero</span>
</span><span class="nd">@Max</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="mi">99999999</span><span class="o">)</span>
<span class="hll"><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">MaxDigits</span> <span class="o">{</span>
</span>    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{com.example.common.validation.MaxDigits.message}&quot;</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="nf">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span><span class="o">,</span> <span class="n">TYPE_USE</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">MaxDigits</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">「ユーザーID」のフォーマットを規定する<code class="docutils literal"><span class="pre">&#64;UserId</span></code>アノテーションの実装例</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.sample.domain.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.Documented</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Repeatable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Constraint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Payload</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.ReportAsSingleViolation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Pattern</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="o">;</span>

<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.ANNOTATION_TYPE</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.CONSTRUCTOR</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.FIELD</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.METHOD</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.PARAMETER</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.TYPE_USE</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.RetentionPolicy.RUNTIME</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.sample.domain.validation.UserId.List</span><span class="o">;</span>

<span class="hll"><span class="nd">@Documented</span>
</span><span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{})</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span><span class="o">,</span> <span class="n">TYPE_USE</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="hll"><span class="nd">@Repeatable</span><span class="o">(</span><span class="n">List</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class="hll"><span class="nd">@ReportAsSingleViolation</span>
</span><span class="hll"><span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">4</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">20</span><span class="o">)</span>
</span><span class="nd">@Pattern</span><span class="o">(</span><span class="n">regexp</span> <span class="o">=</span> <span class="s">&quot;[a-z]*&quot;</span><span class="o">)</span>
<span class="hll"><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">UserId</span> <span class="o">{</span>
</span>    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{com.example.sample.domain.validation.UserId.message}&quot;</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="nf">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span><span class="o">,</span> <span class="n">TYPE_USE</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">UserId</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">「年齢」の制限を規定する<code class="docutils literal"><span class="pre">&#64;Age</span></code>アノテーションの実装例</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.sample.domain.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.Documented</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Repeatable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Constraint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Payload</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.ReportAsSingleViolation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Max</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Min</span><span class="o">;</span>

<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.ANNOTATION_TYPE</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.CONSTRUCTOR</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.FIELD</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.METHOD</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.PARAMETER</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.TYPE_USE</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.RetentionPolicy.RUNTIME</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.sample.domain.validation.Age.List</span><span class="o">;</span>

<span class="hll"><span class="nd">@Documented</span>
</span><span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{})</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span><span class="o">,</span> <span class="n">TYPE_USE</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="hll"><span class="nd">@Repeatable</span><span class="o">(</span><span class="n">List</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class="hll"><span class="nd">@ReportAsSingleViolation</span>
</span><span class="hll"><span class="nd">@Min</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
</span><span class="nd">@Max</span><span class="o">(</span><span class="mi">150</span><span class="o">)</span>
<span class="hll"><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">Age</span> <span class="o">{</span>
</span>    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{com.example.sample.domain.validation.Age.message}&quot;</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="nf">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span><span class="o">,</span> <span class="n">TYPE_USE</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">Age</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">1つのアノテーションに複数のルールを設定した場合、それらのAND条件が複合ルールとなる。
Hibernate Validatorでは、OR条件を実現するための<code class="docutils literal"><span class="pre">&#64;ConstraintComposition</span></code>アノテーションが用意されている。
詳細は、<a class="reference external" href="http://docs.jboss.org/hibernate/validator/6.0/reference/en-US/html_single/#section-boolean-constraint-composition">Hibernate Validatorのドキュメント</a>を参照されたい。</p>
</div>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="validation-implement-new-constraint">
<span id="id16"></span><h3><a class="toc-backref" href="#id60">4.1.3.2. 新規ルールを実装したBean Validationアノテーションの作成</a><a class="headerlink" href="#validation-implement-new-constraint" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">javax.validation.ConstraintValidator</span></code>インタフェースを実装し、そのValidatorを使用するアノテーションを作成することで、任意のルールを作成することができる。</p>
<p>用途としては、以下の3通りが挙げられる。</p>
<ul class="simple">
<li>既存のルールの組み合わせでは表現できないルール</li>
<li>相関項目チェックルール</li>
<li>業務ロジックチェック</li>
</ul>
<div class="section" id="validation-cannot-expressed-existing">
<span id="id17"></span><h4><a class="toc-backref" href="#id61">4.1.3.2.1. 既存のルールの組み合わせでは表現できないルール</a><a class="headerlink" href="#validation-cannot-expressed-existing" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">&#64;Pattern</span></code>、<code class="docutils literal"><span class="pre">&#64;Size</span></code>、<code class="docutils literal"><span class="pre">&#64;Min</span></code>、<code class="docutils literal"><span class="pre">&#64;Max</span></code>等を組み合わせても表現できないルールは、<code class="docutils literal"><span class="pre">javax.validation.ConstraintValidator</span></code>実装クラスに記述する。</p>
<p>例として、IPv4形式のIPアドレス（Internet Protocol address）であることをチェックするルールを挙げる。</p>
<ul>
<li><p class="first">アノテーション</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.common.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.Documented</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Repeatable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Constraint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Payload</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.ANNOTATION_TYPE</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.CONSTRUCTOR</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.FIELD</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.METHOD</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.PARAMETER</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.TYPE_USE</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.RetentionPolicy.RUNTIME</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.common.validation.IPv4.List</span><span class="o">;</span>

<span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{</span> <span class="n">IPv4Validator</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span> <span class="c1">// (1)</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span><span class="o">,</span> <span class="n">TYPE_USE</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="nd">@Repeatable</span><span class="o">(</span><span class="n">List</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">IPv4</span> <span class="o">{</span>
    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{com.example.common.validation.IPv4.message}&quot;</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="nf">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span><span class="o">,</span> <span class="n">TYPE_USE</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">IPv4</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">このアノテーションを使用したときに実行される<code class="docutils literal"><span class="pre">ConstraintValidator</span></code>を指定する。複数指定することができる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Validator</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.common.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.ConstraintValidator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.ConstraintValidatorContext</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IPv4Validator</span> <span class="kd">implements</span> <span class="n">ConstraintValidator</span><span class="o">&lt;</span><span class="n">IPv4</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span> <span class="c1">// (1)</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">IPv4</span> <span class="n">constraintAnnotation</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (2)</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isValid</span><span class="o">(</span><span class="n">String</span> <span class="n">value</span><span class="o">,</span> <span class="n">ConstraintValidatorContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (3)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">// (4)</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">isIPv4Valid</span><span class="o">(</span><span class="n">value</span><span class="o">);</span> <span class="c1">// (5)</span>
    <span class="o">}</span>

    <span class="c1">// This logic check IPv4 address like 192.168.0.1</span>
    <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isIPv4Valid</span><span class="o">(</span><span class="n">String</span> <span class="n">ipAddress</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">octets</span> <span class="o">=</span> <span class="n">ipAddress</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&quot;\\.&quot;</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">octets</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">4</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">octet</span><span class="o">:</span> <span class="n">octets</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">intOctet</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">octet</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">intOctet</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="mi">255</span> <span class="o">&lt;</span> <span class="n">intOctet</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NumberFormatException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ジェネリクスのパラメータに、対象のアノテーションとフィールドの型を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">initialize</span></code>メソッドに、初期化処理を実装する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">isValid</span></code>メソッドで入力チェック処理を実装する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力値が、<code class="docutils literal"><span class="pre">null</span></code>の場合は、正常とみなす。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">IPv4形式のIPアドレスであることのチェックを行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last"><a class="reference internal" href="FileUpload.html#fileupload-validator"><span class="std std-ref">ファイルアップロードのBean Validation</span></a>の例も、ここに分類される。また共通ライブラリでは、この実装として<a class="reference internal" href="Codelist.html#codelist-validate"><span class="std std-ref">&#64;ExistInCodeList</span></a>を用意している。</p>
</div>
</div>
<div class="section" id="validation-correlation-item-check">
<span id="id18"></span><h4><a class="toc-backref" href="#id62">4.1.3.2.2. 相関項目チェックルール</a><a class="headerlink" href="#validation-correlation-item-check" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><a class="reference internal" href="#validation-correlation-check"><span class="std std-ref">相関項目チェック</span></a>で説明したように、Bean Validationによって複数のフィールドにまたがる相関項目チェックを実装できる。</div>
<div class="line">Bean Validationで相関項目チェックルールを実装する場合は、汎用的なルールを対象とすることを推奨する。</div>
</div>
<p>以下では、「あるフィールドとその確認用フィールドの内容が一致すること」というルールを実現する例を挙げる。</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>共通ライブラリでは、2つのフィールドの内容を比較する相関項目チェックの実装として<a class="reference internal" href="#validation-terasoluna-gfw-list"><span class="std std-ref">&#64;Compare</span></a>アノテーションを用意している。</p>
<p class="last"><cite>&#64;Compare</cite>アノテーションを利用することで、このルールをより簡単に実現することができる。 詳細は<a class="reference internal" href="#validation-terasoluna-gfw-how-to-extend"><span class="std std-ref">共通ライブラリのチェックルールの拡張方法</span></a>を参照されたい。</p>
</div>
<p>ここでは、確認用フィールドの先頭に、「confirm」を付与する規約を設ける。</p>
<ul>
<li><p class="first">アノテーション</p>
<p>相関項目チェック用のアノテーションはクラスレベルに付与できるようにする。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.common.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.Documented</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Constraint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Payload</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.ANNOTATION_TYPE</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.TYPE</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.RetentionPolicy.RUNTIME</span><span class="o">;</span>

<span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{</span> <span class="n">ConfirmValidator</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">TYPE</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span> <span class="o">})</span> <span class="c1">// (1)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">Confirm</span> <span class="o">{</span>
    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{com.example.common.validation.Confirm.message}&quot;</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="nf">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="cm">/**</span>
<span class="cm">     * Field name</span>
<span class="cm">     */</span>
    <span class="n">String</span> <span class="nf">field</span><span class="o">();</span> <span class="c1">// (2)</span>

    <span class="nd">@Target</span><span class="o">({</span> <span class="n">TYPE</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">Confirm</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">このアノテーションが、クラスまたはアノテーションにのみ付加できるように、対象を絞る。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アノテーションに渡すパラメータを定義する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Validator</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.common.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.ConstraintValidator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.ConstraintValidatorContext</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.BeanWrapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.BeanWrapperImpl</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.ObjectUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.StringUtils</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConfirmValidator</span> <span class="kd">implements</span> <span class="n">ConstraintValidator</span><span class="o">&lt;</span><span class="n">Confirm</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">field</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">confirmField</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">message</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">Confirm</span> <span class="n">constraintAnnotation</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">constraintAnnotation</span><span class="o">.</span><span class="na">field</span><span class="o">();</span>
        <span class="n">confirmField</span> <span class="o">=</span> <span class="s">&quot;confirm&quot;</span> <span class="o">+</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">capitalize</span><span class="o">(</span><span class="n">field</span><span class="o">);</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">constraintAnnotation</span><span class="o">.</span><span class="na">message</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isValid</span><span class="o">(</span><span class="n">Object</span> <span class="n">value</span><span class="o">,</span> <span class="n">ConstraintValidatorContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">BeanWrapper</span> <span class="n">beanWrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BeanWrapperImpl</span><span class="o">(</span><span class="n">value</span><span class="o">);</span> <span class="c1">// (1)</span>
        <span class="n">Object</span> <span class="n">fieldValue</span> <span class="o">=</span> <span class="n">beanWrapper</span><span class="o">.</span><span class="na">getPropertyValue</span><span class="o">(</span><span class="n">field</span><span class="o">);</span> <span class="c1">// (2)</span>
        <span class="n">Object</span> <span class="n">confirmFieldValue</span> <span class="o">=</span> <span class="n">beanWrapper</span><span class="o">.</span><span class="na">getPropertyValue</span><span class="o">(</span><span class="n">confirmField</span><span class="o">);</span>
        <span class="kt">boolean</span> <span class="n">matched</span> <span class="o">=</span> <span class="n">ObjectUtils</span><span class="o">.</span><span class="na">nullSafeEquals</span><span class="o">(</span><span class="n">fieldValue</span><span class="o">,</span>
                <span class="n">confirmFieldValue</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">matched</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">context</span><span class="o">.</span><span class="na">disableDefaultConstraintViolation</span><span class="o">();</span> <span class="c1">// (3)</span>
            <span class="n">context</span><span class="o">.</span><span class="na">buildConstraintViolationWithTemplate</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">addPropertyNode</span><span class="o">(</span><span class="n">field</span><span class="o">).</span><span class="na">addConstraintViolation</span><span class="o">();</span> <span class="c1">// (4)</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JavaBeanのプロパティにアクセスする際に便利な<code class="docutils literal"><span class="pre">org.springframework.beans.BeanWrapper</span></code>を使用する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">BeanWrapper</span></code>経由で、フォームオブジェクトからプロパティ値を取得する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">デフォルトの<code class="docutils literal"><span class="pre">ConstraintViolation</span></code>オブジェクトの生成を無効にする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">独自<code class="docutils literal"><span class="pre">ConstraintViolation</span></code>オブジェクトを生成する。</div>
<div class="line"><code class="docutils literal"><span class="pre">ConstraintValidatorContext.buildConstraintViolationWithTemplate</span></code>で出力するメッセージを定義する。</div>
<div class="line"><code class="docutils literal"><span class="pre">ConstraintViolationBuilder.addPropertyNode</span></code>でエラーメッセージを出力したいフィールド名を指定する。</div>
<div class="line">詳細は、<a class="reference external" href="https://javaee.github.io/javaee-spec/javadocs/index.html?javax/validation/ConstraintValidatorContext.html">ConstraintValidatorContextのJavaDoc</a>を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Spring Validatorによる相関項目チェックにて紹介したように、Bean Validationにおいても
<a class="reference internal" href="#validation-how-to-cross-field-validation-for-multi-field-highlight"><span class="std std-ref">相関チェック対象の複数フィールドに対してエラー情報を設定する</span></a> ことが可能である。</p>
<p>以下に、Bean Validationにて<code class="docutils literal"><span class="pre">password</span></code>フィールドと<code class="docutils literal"><span class="pre">confirmPassword</span></code>フィールドにスタイルを適用し、<code class="docutils literal"><span class="pre">password</span></code>フィールドのみにエラーメッセージを表示する例を示す。</p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// omitted</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConfirmValidator</span> <span class="kd">implements</span> <span class="n">ConstraintValidator</span><span class="o">&lt;</span><span class="n">Confirm</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">field</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">confirmField</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">message</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">Confirm</span> <span class="n">constraintAnnotation</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// omitted</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isValid</span><span class="o">(</span><span class="n">Object</span> <span class="n">value</span><span class="o">,</span> <span class="n">ConstraintValidatorContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// omitted</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">matched</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">context</span><span class="o">.</span><span class="na">disableDefaultConstraintViolation</span><span class="o">();</span>

            <span class="c1">//new ConstraintViolation to be generated for field</span>
            <span class="n">context</span><span class="o">.</span><span class="na">buildConstraintViolationWithTemplate</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">addPropertyNode</span><span class="o">(</span><span class="n">field</span><span class="o">).</span><span class="na">addConstraintViolation</span><span class="o">();</span>

            <span class="c1">//new ConstraintViolation to be generated for confirmField</span>
            <span class="n">context</span><span class="o">.</span><span class="na">buildConstraintViolationWithTemplate</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
                    <span class="o">.</span><span class="na">addPropertyNode</span><span class="o">(</span><span class="n">confirmField</span><span class="o">).</span><span class="na">addConstraintViolation</span><span class="o">();</span>

            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">confirmPassword</span></code>フィールドのエラーを登録する。この際、エラーメッセージに空文字を設定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<p>この<code class="docutils literal"><span class="pre">&#64;Confirm</span></code>アノテーションを使用して、前述の「パスワードリセット」処理を再実装すると、以下のようになる。</p>
<ul>
<li><p class="first">フォームクラス</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.sample.app.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.common.validation.Confirm</span><span class="o">;</span>

<span class="nd">@Confirm</span><span class="o">(</span><span class="n">field</span> <span class="o">=</span> <span class="s">&quot;password&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordResetForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">8</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">confirmPassword</span><span class="o">;</span>

    <span class="c1">// omitted geter/setter</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クラスレベルに<code class="docutils literal"><span class="pre">&#64;Confirm</span></code>アノテーションを付与する。</div>
<div class="line">これにより<code class="docutils literal"><span class="pre">ConstraintValidator.isValid</span></code>の引数にはフォームオブジェクトが渡る。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Controllerクラス</p>
<p>Validatorのインジェクションおよび<code class="docutils literal"><span class="pre">&#64;InitBinder</span></code>によるValidatorの追加は、不要になる。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.sample.app.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.BindingResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ModelAttribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;password&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordResetController</span> <span class="o">{</span>

    <span class="nd">@ModelAttribute</span>
    <span class="kd">public</span> <span class="n">PasswordResetForm</span> <span class="nf">setupForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">PasswordResetForm</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;reset&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">resetForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;password/resetForm&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;reset&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">reset</span><span class="o">(</span><span class="nd">@Validated</span> <span class="n">PasswordResetForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">&quot;password/resetForm&quot;</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="s">&quot;redirect:/password/reset?complete&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;reset&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;complete&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">resetComplete</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;password/resetComplete&quot;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="validation-business-logic-check">
<span id="id19"></span><h4><a class="toc-backref" href="#id63">4.1.3.2.3. 業務ロジックチェック</a><a class="headerlink" href="#validation-business-logic-check" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">業務ロジックチェックは、基本的には<a class="reference internal" href="../../ImplementationAtEachLayer/DomainLayer.html#service-implementation-label"><span class="std std-ref">ドメイン層のServiceで実装</span></a>し、結果メッセージは<code class="docutils literal"><span class="pre">ResultMessages</span></code>オブジェクトに格納することを推奨している。</div>
<div class="line">したがって、<a class="reference internal" href="MessageManagement.html#message-display"><span class="std std-ref">通常画面の上部などに表示されることを想定している</span></a>。</div>
</div>
<p>一方で、「入力されたユーザー名が既に登録済みかどうか」など、対象の入力フィールドに対する業務ロジックエラーメッセージを、フィールドの横に表示したい場合もある。
このような場合は、ValidatorクラスにServiceクラスをインジェクションして、業務ロジックチェックを実行し、その結果を、<code class="docutils literal"><span class="pre">ConstraintValidator.isValid</span></code>の結果に使用すればよい。</p>
<p>「入力されたユーザー名が既に登録済みかどうか」をBean Validationで実現する例を示す。</p>
<ul>
<li><p class="first">Serviceクラス</p>
<p>実装クラス(UserServiceImpl)は割愛する。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.sample.domain.service.user</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserService</span> <span class="o">{</span>

    <span class="kt">boolean</span> <span class="nf">isUnusedUserId</span><span class="o">(</span><span class="n">String</span> <span class="n">userId</span><span class="o">);</span>

    <span class="c1">// omitted other methods</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">アノテーション</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.sample.domain.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.Documented</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Repeatable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Constraint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Payload</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.ANNOTATION_TYPE</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.CONSTRUCTOR</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.FIELD</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.METHOD</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.PARAMETER</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.TYPE_USE</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.RetentionPolicy.RUNTIME</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.sample.domain.validation.UnusedUserId.List</span><span class="o">;</span>

<span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{</span> <span class="n">UnusedUserIdValidator</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span><span class="o">,</span> <span class="n">TYPE_USE</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="nd">@Repeatable</span><span class="o">(</span><span class="n">List</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">UnusedUserId</span> <span class="o">{</span>
    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{com.example.sample.domain.validation.UnusedUserId.message}&quot;</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="nf">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span><span class="o">,</span> <span class="n">TYPE_USE</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">UnusedUserId</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Validatorクラス</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.sample.domain.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.ConstraintValidator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.ConstraintValidatorContext</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.sample.domain.service.user.UserService</span><span class="o">;</span>

<span class="nd">@Component</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UnusedUserIdValidator</span> <span class="kd">implements</span>
                                  <span class="n">ConstraintValidator</span><span class="o">&lt;</span><span class="n">UnusedUserId</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Inject</span> <span class="c1">// (2)</span>
    <span class="n">UserService</span> <span class="n">userService</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">UnusedUserId</span> <span class="n">constraintAnnotation</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isValid</span><span class="o">(</span><span class="n">String</span> <span class="n">value</span><span class="o">,</span> <span class="n">ConstraintValidatorContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">userService</span><span class="o">.</span><span class="na">isUnusedUserId</span><span class="o">(</span><span class="n">value</span><span class="o">);</span> <span class="c1">// (3)</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Validatorクラスをコンポーネントスキャンの対象にする。</div>
<div class="line">パッケージがBean定義ファイルの<code class="docutils literal"><span class="pre">&lt;context:component-scan</span> <span class="pre">base-package=&quot;...&quot;</span> <span class="pre">/&gt;</span></code>の設定に含まれている必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">呼び出すServiceクラスを、インジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">業務ロジックの結果を返却する。<code class="docutils literal"><span class="pre">isValid</span></code>メソッド名で業務ロジックを記述せず、かならずServiceに処理を委譲すること。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="method-validation">
<span id="methodvalidation"></span><h3><a class="toc-backref" href="#id64">4.1.3.3. Method Validation</a><a class="headerlink" href="#method-validation" title="Permalink to this headline">¶</a></h3>
<p>Bean Validationによってメソッドの実引数と返り値の妥当性を確認する方法を説明する。
説明のために、本節ではこの方法をMethod Validationと呼ぶ。
防衛的プログラミングを行う場合などでは、Controller以外のクラスでメソッドの入出力を確認する必要がある。
このとき、Bean Validationライブラリを利用すれば、Controllerで使用したBean Validationの制約アノテーションを再利用できる。</p>
<div class="section" id="methodvalidationonspringframeworkhowtousesettings">
<span id="id20"></span><h4><a class="toc-backref" href="#id65">4.1.3.3.1. アプリケーションの設定</a><a class="headerlink" href="#methodvalidationonspringframeworkhowtousesettings" title="Permalink to this headline">¶</a></h4>
<p>Spring Frameworkが提供するMethod Validationを使用する場合は、
Spring Frameworkから提供されている<code class="docutils literal"><span class="pre">org.springframework.validation.beanvalidation.MethodValidationPostProcessor</span></code>クラスをBean定義する必要がある。</p>
<p><code class="docutils literal"><span class="pre">MethodValidationPostProcessor</span></code>を定義するBean定義ファイルは、Method Validationを使用する箇所によって異なる。</p>
<p>ここでは、本ガイドラインが推奨するマルチプロジェクト環境でMethod Validationを使用するための設定例を示す。</p>
<ul class="simple">
<li>アプリケーション層用のプロジェクト(<code class="docutils literal"><span class="pre">projectName-web</span></code>)</li>
<li>ドメイン層用のプロジェクト(<code class="docutils literal"><span class="pre">projectName-domain</span></code>)</li>
</ul>
<p>の両プロジェクトの設定を変更する必要がある。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/spring/projectName-domain.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;validator&quot;</span>
      <span class="na">class=</span><span class="s">&quot;org.springframework.validation.beanvalidation.LocalValidatorFactoryBean&quot;</span><span class="nt">/&gt;</span>

<span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.validation.beanvalidation.MethodValidationPostProcessor&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;validator&quot;</span> <span class="na">ref=</span><span class="s">&quot;validator&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">projectName-web/src/main/resources/META-INF/spring/spring-mvc.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;mvc:annotation-driven</span> <span class="na">validator=</span><span class="s">&quot;validator&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
<span class="nt">&lt;/mvc:annotation-driven&gt;</span>

<span class="c">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.validation.beanvalidation.MethodValidationPostProcessor&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;validator&quot;</span> <span class="na">ref=</span><span class="s">&quot;validator&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
</div></blockquote>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><code class="docutils literal"><span class="pre">LocalValidatorFactoryBean</span></code>をBean定義する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">MethodValidationPostProcessor</span></code>をBean定義し、
ドメイン層のクラスのメソッドに対してMethod Validationが実行されるようにする。</p>
<p class="last"><code class="docutils literal"><span class="pre">validator</span></code>プロパティには、(1)で定義したBeanを指定する。</p>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">&lt;mvc:annotation-driven&gt;</span></code>要素の<code class="docutils literal"><span class="pre">validator</span></code>属性に、(1)で定義したBeanを指定する。</p>
<p class="last">この設定がない場合は(1)で作成したものとは異なる<code class="docutils literal"><span class="pre">Validator</span></code>インスタンスが生成されてしまう。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">MethodValidationPostProcessor</span></code>をBean定義し、
アプリケーション層のクラスのメソッドに対してMethod Validationが実行されるようにする。</p>
<p class="last"><code class="docutils literal"><span class="pre">validator</span></code>プロパティには、(1)で定義したBeanを指定する。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><code class="docutils literal"><span class="pre">LocalValidatorFactoryBean</span></code>は、
Bean Validation(Hibernate Validator)が提供する<code class="docutils literal"><span class="pre">Validator</span></code>クラスとSpring Frameworkを連携するためのラッパー<code class="docutils literal"><span class="pre">Validator</span></code>オブジェクトを生成するためのクラスである。</p>
<p class="last">このクラスによって生成されたラッパー<code class="docutils literal"><span class="pre">Validator</span></code>を使用することで、
Spring Frameworkが提供するメッセージ管理機能(<code class="docutils literal"><span class="pre">MessageSource</span></code>)やDIコンテナなどとの連携が行えるようになる。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Spring Frameworkでは、DIコンテナで管理されているBeanのメソッド呼び出しに対するMethod Validationの実行を、
AOPの仕組みを利用して行っている。</p>
<p class="last"><code class="docutils literal"><span class="pre">MethodValidationPostProcessor</span></code>は、Method Validationを実行するためのAOPを適用するためのクラスである。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">上記例では、各Beanの<code class="docutils literal"><span class="pre">validator</span></code>プロパティに対して、同じ<code class="docutils literal"><span class="pre">Validator</span></code>オブジェクト(インスタンス)を設定しているが、
これは必ずしも必須ではない。
ただし、特に理由がない場合は、同じオブジェクト(インスタンス)を設定しておくことを推奨する。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="methodvalidationonspringframeworkhowtouseapplytarget">
<span id="id21"></span><h4><a class="toc-backref" href="#id66">4.1.3.3.2. Method Validation対象のメソッドにするための定義方法</a><a class="headerlink" href="#methodvalidationonspringframeworkhowtouseapplytarget" title="Permalink to this headline">¶</a></h4>
<p>メソッドにMethod Validationを適用するには、
対象のメソッドを含むことを示したアノテーションをクラスレベルに、
Bean Validationの制約アノテーションをメソッドと仮引数にそれぞれ指定する必要がある。</p>
<p>「<a class="reference internal" href="#methodvalidationonspringframeworkhowtousesettings"><span class="std std-ref">アプリケーションの設定</span></a>」を行っただけでは、Method Validationを実行するAOPは適用されない。
Method Validationを実行するAOPを適用するためには、
インタフェース又はクラスに<code class="docutils literal"><span class="pre">&#64;</span> <span class="pre">org.springframework.validation.annotation.Validated</span></code>アノテーションを付与する必要がある。</p>
<p>ここでは、インタフェースに対してアノテーションを指定する方法を紹介する。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="o">;</span>

<span class="nd">@Validated</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">HelloService</span> <span class="o">{</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p class="first">Method Validationの対象となるインタフェースに、<code class="docutils literal"><span class="pre">Validated</span></code>アノテーションを指定する。</p>
<p class="last">上記例では、<code class="docutils literal"><span class="pre">HelloService</span></code>インタフェースの実装メソッドに対して、
Method Validationを実行するAOPが適用される。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><code class="docutils literal"><span class="pre">&#64;Validated</span></code>アノテーションの<code class="docutils literal"><span class="pre">value</span></code>属性にグループインタフェースを指定することで、
指定したグループに属するValidationのみ実行する事も可能である。</p>
<p>また、メソッドレベルに<code class="docutils literal"><span class="pre">Validated</span></code>アノテーションを付与することで、
メソッド毎にバリデーショングループを切り替える事も可能な仕組みとなっている。</p>
<p class="last">バリデーショングループについては、「<a class="reference internal" href="#validationgroupvalidation"><span class="std std-ref">バリデーションのグループ化</span></a>」を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>次に、Bean Validationの制約アノテーションをメソッドや仮引数へ指定する方法を説明する。
具体的には、</p>
<ul class="simple">
<li>メソッドの引数</li>
<li>メソッドの引数に指定されたJavaBeanのフィールド</li>
</ul>
<p>に対してBean Validationの制約アノテーションを、</p>
<ul class="simple">
<li>メソッドの返り値</li>
<li>メソッドの返り値として返却するJavaBeanのフィールド</li>
</ul>
<p>に対してBean Validationの制約アノテーションを指定する。</p>
<p>以下に、具体的な指定方法について説明する。
以降の説明では、インタフェースにアノテーションを指定する方法を紹介する。</p>
<p>まず、メソッドのシグネチャとして基本型(プリミティブやプリミティブラッパ型など)を使用するメソッドに対して、
制約アノテーションを指定する方法について説明する。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>

<span class="nd">@Validated</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">HelloService</span> <span class="o">{</span>

    <span class="c1">// (2)</span>
    <span class="nd">@NotNull</span>
    <span class="n">String</span> <span class="nf">hello</span><span class="o">(</span><span class="nd">@NotNull</span> <span class="cm">/* (1) */</span> <span class="n">String</span> <span class="n">message</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p class="first">Bean Validationの制約アノテーションをメソッドの引数アノテーションとして指定する。</p>
<p class="last"><code class="docutils literal"><span class="pre">&#64;NotNull</span></code>は<code class="docutils literal"><span class="pre">message</span></code>という引数がNull値を許可しないことを意味する制約である。
引数にNull値が指定された場合、<code class="docutils literal"><span class="pre">javax.validation.ConstraintViolationException</span></code>が発生する。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p class="first">Bean Validationの制約アノテーションをメソッドアノテーションとして指定する。</p>
<p class="last">上記例では、返り値がNull値にならないことを示しており、
返り値としてNull値が返却された場合、<code class="docutils literal"><span class="pre">javax.validation.ConstraintViolationException</span></code>が発生する。</p>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>次に、メソッドのシグネチャとしてJavaBeanを使用するメソッドに対して、
Bean Validationの制約アノテーションを指定する方法について説明する。</p>
<p>ここでは、インタフェースに対してアノテーションを指定する方法を紹介する。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ポイントは、<code class="docutils literal"><span class="pre">&#64;javax.validation.Valid</span></code>アノテーションを指定するという点である。
以下に、サンプルコード使って指定方法を詳しく説明する。</p>
</div>
<p><strong>Serviceインタフェース</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>

<span class="nd">@Validated</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">HelloService</span> <span class="o">{</span>

    <span class="nd">@NotNull</span> <span class="c1">// (3)</span>
    <span class="nd">@Valid</span>   <span class="c1">// (4)</span>
    <span class="n">HelloOutput</span> <span class="nf">hello</span><span class="o">(</span><span class="nd">@NotNull</span> <span class="cm">/* (1) */</span> <span class="nd">@Valid</span> <span class="cm">/* (2) */</span> <span class="n">HelloInput</span> <span class="n">input</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p class="first">Bean Validationの制約アノテーションをメソッドの引数アノテーションとして指定する。</p>
<p class="last"><code class="docutils literal"><span class="pre">input</span></code>という引数(JavaBean)がNull値を許可しない事を示しており、
引数にNull値が指定された場合は、<code class="docutils literal"><span class="pre">javax.validation.ConstraintViolationException</span></code>が発生する。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">&#64;javax.validation.Valid</span></code>アノテーションをメソッドの引数アノテーションとして指定する。</p>
<p class="last"><code class="docutils literal"><span class="pre">&#64;Valid</span></code>アノテーションを付与する事で、引数のJavaBeanのフィールドに指定したBean Validationの制約アノテーションが有効となる。
JavaBeanに指定された制約を満たさない場合は<code class="docutils literal"><span class="pre">javax.validation.ConstraintViolationException</span></code>が発生する。</p>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p class="first">Bean Validationの制約アノテーションをメソッドアノテーションとして指定する。</p>
<p class="last">返り値のJavaBeanがNull値にならないことを示しており、
返り値としてNull値が返却された場合は例外が発生する。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">&#64;Valid</span></code>アノテーションをメソッドアノテーションとして指定する。</p>
<p class="last"><code class="docutils literal"><span class="pre">&#64;Valid</span></code>アノテーションを付与する事で、返り値のJavaBeanのフィールドに指定したBean Validationの制約アノテーションが有効となる。
JavaBeanに指定された制約を満たさない場合は<code class="docutils literal"><span class="pre">javax.validation.ConstraintViolationException</span></code>が発生する。</p>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">以下にJavaBeanの実装サンプルを紹介する。</div>
<div class="line">基本的には、Bean Validationの制約アノテーションを指定するだけだが、JavaBeanが更にJavaBeanをネストしている場合は注意が必要になる。</div>
</div>
<p><strong>Input用のJavaBean</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Past</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloInput</span> <span class="o">{</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Past</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">visitDate</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">visitMessage</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">userId</span><span class="o">;</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</pre></div>
</div>
<p><strong>Output用のJavaBean</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.User</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.Valid</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Past</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloOutput</span> <span class="o">{</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Past</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">acceptDate</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">acceptMessage</span><span class="o">;</span>

    <span class="nd">@Valid</span> <span class="c1">// (5)</span>
    <span class="kd">private</span> <span class="n">User</span> <span class="n">user</span><span class="o">;</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</pre></div>
</div>
<p><strong>Output用のJavaBean内でネストしているJavaBean</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.domain.model</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Past</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>

    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">userId</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">userName</span><span class="o">;</span>

    <span class="nd">@Past</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">dateOfBirth</span><span class="o">;</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><p class="first">ネストしたJavaBeanに指定しているBean Validationの制約アノテーションを有効にする場合は、
<code class="docutils literal"><span class="pre">&#64;Valid</span></code>アノテーションをフィールドアノテーションとして指定する。</p>
<p class="last"><code class="docutils literal"><span class="pre">&#64;Valid</span></code>アノテーションを付与する事で、ネストしたJavaBeanのフィールドに指定したBean Validationの制約アノテーションが有効となる。
ネストしたJavaBeanに指定された制約を満たさない場合は<code class="docutils literal"><span class="pre">javax.validation.ConstraintViolationException</span></code>が発生する。</p>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="methodvalidationonspringframeworkhowtouseexceptionhandling">
<span id="id22"></span><h4><a class="toc-backref" href="#id67">4.1.3.3.3. 制約違反時の例外ハンドリング</a><a class="headerlink" href="#methodvalidationonspringframeworkhowtouseexceptionhandling" title="Permalink to this headline">¶</a></h4>
<p>制約に違反した場合、<code class="docutils literal"><span class="pre">javax.validation.ConstraintViolationException</span></code>が発生する。</p>
<p><code class="docutils literal"><span class="pre">ConstraintViolationException</span></code>が発生した場合、スタックトレースから発生したメソッドは特定できるが、
具体的な違反内容が特定できない。</p>
<p>違反内容を特定するためには、<code class="docutils literal"><span class="pre">ConstraintViolationException</span></code>をハンドリングしてログ出力を行う例外ハンドリングクラスを作成するとよい。</p>
<p>以下の例外ハンドリングクラスの作成例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.app</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.ConstraintViolationException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ControllerAdvice</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ExceptionHandler</span><span class="o">;</span>

<span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConstraintViolationExceptionHandler</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">ConstraintViolationExceptionHandler</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="c1">// (1)</span>
    <span class="nd">@ExceptionHandler</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">handleConstraintViolationException</span><span class="o">(</span><span class="n">ConstraintViolationException</span> <span class="n">e</span><span class="o">){</span>
        <span class="c1">// (2)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">log</span><span class="o">.</span><span class="na">isErrorEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;ConstraintViolations[\n{}\n]&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getConstraintViolations</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="s">&quot;common/error/systemError&quot;</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">ConstraintViolationException</span></code>をハンドリングするための<code class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></code>メソッドを作成する。</p>
<p class="last">メソッドの引数として、<code class="docutils literal"><span class="pre">ConstraintViolationException</span></code>を受け取るようにする。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>メソッドの引数で受け取った<code class="docutils literal"><span class="pre">ConstraintViolationException</span></code>が保持している違反内容(<code class="docutils literal"><span class="pre">ConstraintViolation</span></code>の<code class="docutils literal"><span class="pre">Set</span></code>)をログに出力する。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">&#64;ControllerAdvice</span></code>アノテーションの詳細については「<a class="reference internal" href="../../ImplementationAtEachLayer/ApplicationLayer.html#application-layer-controller-advice"><span class="std std-ref">&#64;ControllerAdviceの実装</span></a>」を参照されたい。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><code class="docutils literal"><span class="pre">ConstraintViolation#getMessage</span></code>メソッドを使用することでエラーメッセージを取得することができるが、Springの機能によるメッセージ補完は行われないため、エラーメッセージに <code class="docutils literal"><span class="pre">{0}</span></code>でフィールド名を埋め込むことはできない。</p>
<p>代わりに、フィールド名は<code class="docutils literal"><span class="pre">ConstraintViolation#getPropertyPath</span></code>メソッドで取得することが可能である。</p>
<p>Springの機能によるメッセージ補完については、<a class="reference internal" href="#validation-message-in-validationmessages"><span class="std std-ref">ValidationMessages.propertiesに定義するメッセージ</span></a> のNoteを参照されたい。</p>
<p class="last"><code class="docutils literal"><span class="pre">ConstraintViolation</span></code>の詳細については、<a class="reference external" href="http://docs.jboss.org/hibernate/validator/6.0/reference/en-US/html_single/#_code_constraintviolation_code_methods">Hibernate Validatorのリファレンス</a>を参照されたい。</p>
</div>
</div>
</div>
</div>
<div class="section" id="appendix">
<h2><a class="toc-backref" href="#id68">4.1.4. Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id24">
<h3><a class="toc-backref" href="#id69">4.1.4.1. Hibernate Validatorが用意する入力チェックルール</a><a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Hibernate ValidatorはBean Validationで定義されたアノテーションに加え、独自の検証用アノテーションを提供している。</div>
<div class="line">検証に使用することができるアノテーションのリストは、<a class="reference external" href="http://docs.jboss.org/hibernate/validator/6.0/reference/en-US/html_single/#section-builtin-constraints">こちら</a>を参照されたい。</div>
</div>
<div class="section" id="validation-jsr380-doc">
<span id="id26"></span><h4><a class="toc-backref" href="#id70">4.1.4.1.1. Bean Validationのチェックルール</a><a class="headerlink" href="#validation-jsr380-doc" title="Permalink to this headline">¶</a></h4>
<p>Bean Validationの標準アノテーション(<code class="docutils literal"><span class="pre">javax.validation.*</span></code>)を以下に示す。</p>
<p>詳細は、<a class="reference external" href="https://beanvalidation.org/2.0/spec/#builtinconstraints">Bean Validation specification(Built-in Constraint definitions)</a>を参照されたい。</p>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="15%" />
<col width="30%" />
<col width="30%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">アノテーション</th>
<th class="head">対象の型</th>
<th class="head">説明</th>
<th class="head">使用例</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">&#64;NotNull</span></code></td>
<td>任意</td>
<td>対象のフィールドが、<code class="docutils literal"><span class="pre">null</span></code>でないことを検証する。</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@NotNull</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">id</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">&#64;NotEmpty</span></code></td>
<td><code class="docutils literal"><span class="pre">Collection</span></code>、<code class="docutils literal"><span class="pre">Map</span></code>、Array、任意の<code class="docutils literal"><span class="pre">CharSequence</span></code>インタフェースの実装クラスに適用可能</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">null</span></code>、または空でないことを検証する。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;NotNull</span></code> + <code class="docutils literal"><span class="pre">&#64;Min(1)</span></code>の組み合わせでチェックする場合は、<code class="docutils literal"><span class="pre">&#64;NotEmpty</span></code>を使用すること。（2.0から追加）</div>
</div>
</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@NotEmpty</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">&#64;NotBlank</span></code></td>
<td>任意の<code class="docutils literal"><span class="pre">CharSequence</span></code>インタフェースの実装クラスに適用可能</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">null</span></code>、空文字(<code class="docutils literal"><span class="pre">&quot;&quot;</span></code>)、空白のみでないことを検証する。（2.0から追加）</div>
</div>
</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@NotBlank</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">userId</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">&#64;Null</span></code></td>
<td>任意</td>
<td><div class="first last line-block">
<div class="line">対象のフィールドが、<code class="docutils literal"><span class="pre">null</span></code>であることを検証する。</div>
<div class="line">(例：グループ検証での使用)</div>
</div>
</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Null</span><span class="o">(</span><span class="n">groups</span><span class="o">={</span><span class="n">Update</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">id</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">&#64;Pattern</span></code></td>
<td><code class="docutils literal"><span class="pre">String</span></code></td>
<td><div class="first last line-block">
<div class="line">対象のフィールドが正規表現にマッチするかどうか</div>
<div class="line">(Hibernate Validator実装では、任意の<code class="docutils literal"><span class="pre">CharSequence</span></code>インタフェースの実装クラスにも適用可能)</div>
</div>
</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Pattern</span><span class="o">(</span><span class="n">regexp</span> <span class="o">=</span> <span class="s">&quot;[0-9]+&quot;</span><span class="o">)</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">tel</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">&#64;Min</span></code></td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">BigDecimal</span></code>, <code class="docutils literal"><span class="pre">BigInteger</span></code>, <code class="docutils literal"><span class="pre">byte</span></code>, <code class="docutils literal"><span class="pre">short</span></code>, <code class="docutils literal"><span class="pre">int</span></code>, <code class="docutils literal"><span class="pre">long</span></code>およびラッパー</div>
<div class="line">(Hibernate Validator実装では、任意の<code class="docutils literal"><span class="pre">Number</span></code>の継承クラス,<code class="docutils literal"><span class="pre">CharSequence</span></code>インタフェースの実装クラスにも適用可能。ただし、文字列が数値表現の場合に限る。)</div>
</div>
</td>
<td>値が、最小値以上であるかどうかを検証する。</td>
<td>&#64;Max参照</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">&#64;Max</span></code></td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">BigDecimal</span></code>, <code class="docutils literal"><span class="pre">BigInteger</span></code>, <code class="docutils literal"><span class="pre">byte</span></code>, <code class="docutils literal"><span class="pre">short</span></code>, <code class="docutils literal"><span class="pre">int</span></code>, <code class="docutils literal"><span class="pre">long</span></code>およびラッパー</div>
<div class="line">(Hibernate Validator実装では任意の<code class="docutils literal"><span class="pre">Number</span></code>の継承クラス,<code class="docutils literal"><span class="pre">CharSequence</span></code>インタフェースの実装クラスにも適用可能。ただし、文字列が数値表現の場合に限る。)</div>
</div>
</td>
<td>値が、最大値以下であるかどうかを検証する。</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Min</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
<span class="nd">@Max</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">quantity</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">&#64;DecimalMin</span></code></td>
<td><code class="docutils literal"><span class="pre">BigDecimal</span></code>, <code class="docutils literal"><span class="pre">BigInteger</span></code>, <code class="docutils literal"><span class="pre">String</span></code>, <code class="docutils literal"><span class="pre">byte</span></code>, <code class="docutils literal"><span class="pre">short</span></code>, <code class="docutils literal"><span class="pre">int</span></code>, <code class="docutils literal"><span class="pre">long</span></code>およびラッパー
(Hibernate Validator実装では任意の<code class="docutils literal"><span class="pre">Number</span></code>の継承クラス,<code class="docutils literal"><span class="pre">CharSequence</span></code>インタフェースの実装クラスにも適用可能)</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Decimal</span></code>型の値が、最小値以上であるかどうかを検証する。</div>
<div class="line"><code class="docutils literal"><span class="pre">inclusive</span> <span class="pre">=</span> <span class="pre">false</span></code>を指定する事で、最小値より大きいかどうかを検証するように動作を変更する事ができる。</div>
</div>
</td>
<td><code class="docutils literal"><span class="pre">&#64;DecimalMax</span></code>参照</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">&#64;DecimalMax</span></code></td>
<td><code class="docutils literal"><span class="pre">BigDecimal</span></code>, <code class="docutils literal"><span class="pre">BigInteger</span></code>, <code class="docutils literal"><span class="pre">String</span></code>, <code class="docutils literal"><span class="pre">byte</span></code>, <code class="docutils literal"><span class="pre">short</span></code>, <code class="docutils literal"><span class="pre">int</span></code>, <code class="docutils literal"><span class="pre">long</span></code>およびラッパー
(Hibernate Validator実装では任意の<code class="docutils literal"><span class="pre">Number</span></code>の継承クラス,<code class="docutils literal"><span class="pre">CharSequence</span></code>インタフェースの実装クラスにも適用可能)</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Decimal</span></code>型の値が、最大値以下であるかどうかを検証する。</div>
<div class="line"><code class="docutils literal"><span class="pre">inclusive</span> <span class="pre">=</span> <span class="pre">false</span></code>を指定する事で、最大値より小さいかどうかを検証するように動作を変更する事ができる。</div>
</div>
</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@DecimalMin</span><span class="o">(</span><span class="s">&quot;0.0&quot;</span><span class="o">)</span>
<span class="nd">@DecimalMax</span><span class="o">(</span><span class="s">&quot;99999.99&quot;</span><span class="o">)</span>
<span class="kd">private</span> <span class="n">BigDecimal</span> <span class="n">price</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">&#64;Positive</span></code></td>
<td><code class="docutils literal"><span class="pre">BigDecimal</span></code>, <code class="docutils literal"><span class="pre">BigInteger</span></code>, <code class="docutils literal"><span class="pre">byte</span></code>, <code class="docutils literal"><span class="pre">short</span></code>, <code class="docutils literal"><span class="pre">int</span></code>, <code class="docutils literal"><span class="pre">long</span></code>, <code class="docutils literal"><span class="pre">float</span></code>, <code class="docutils literal"><span class="pre">double</span></code>およびラッパー</td>
<td><div class="first last line-block">
<div class="line">値が正の数値（0を含まない）であるかどうかを検証する。（2.0から追加）</div>
</div>
</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Positive</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">deposit</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">&#64;PositiveOrZero</span></code></td>
<td><code class="docutils literal"><span class="pre">BigDecimal</span></code>, <code class="docutils literal"><span class="pre">BigInteger</span></code>, <code class="docutils literal"><span class="pre">byte</span></code>, <code class="docutils literal"><span class="pre">short</span></code>, <code class="docutils literal"><span class="pre">int</span></code>, <code class="docutils literal"><span class="pre">long</span></code>, <code class="docutils literal"><span class="pre">float</span></code>, <code class="docutils literal"><span class="pre">double</span></code>およびラッパー</td>
<td><div class="first last line-block">
<div class="line">値が正の数値（0を含む）であるかどうかを検証する。（2.0から追加）</div>
</div>
</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@PositiveOrZero</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">deposit</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">&#64;Negative</span></code></td>
<td><code class="docutils literal"><span class="pre">BigDecimal</span></code>, <code class="docutils literal"><span class="pre">BigInteger</span></code>, <code class="docutils literal"><span class="pre">byte</span></code>, <code class="docutils literal"><span class="pre">short</span></code>, <code class="docutils literal"><span class="pre">int</span></code>, <code class="docutils literal"><span class="pre">long</span></code>, <code class="docutils literal"><span class="pre">float</span></code>, <code class="docutils literal"><span class="pre">double</span></code>およびラッパー</td>
<td><div class="first last line-block">
<div class="line">値が負の数値（0を含まない）であるかどうかを検証する。（2.0から追加）</div>
</div>
</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Negative</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">deposit</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">&#64;NegativeOrZero</span></code></td>
<td><code class="docutils literal"><span class="pre">BigDecimal</span></code>, <code class="docutils literal"><span class="pre">BigInteger</span></code>, <code class="docutils literal"><span class="pre">byte</span></code>, <code class="docutils literal"><span class="pre">short</span></code>, <code class="docutils literal"><span class="pre">int</span></code>, <code class="docutils literal"><span class="pre">long</span></code>, <code class="docutils literal"><span class="pre">float</span></code>, <code class="docutils literal"><span class="pre">double</span></code>およびラッパー</td>
<td><div class="first last line-block">
<div class="line">値が正の数値（0を含む）であるかどうかを検証する。（2.0から追加）</div>
</div>
</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@NegativeOrZero</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">deposit</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">&#64;Size</span></code></td>
<td><code class="docutils literal"><span class="pre">String</span></code>(文字列の長さ), <code class="docutils literal"><span class="pre">Collection</span></code>(要素のサイズ), <code class="docutils literal"><span class="pre">Map</span></code>(要素のサイズ), Array(配列の長さ)
(Hibernate Validator実装では、任意の<code class="docutils literal"><span class="pre">CharSequence</span></code>インタフェースの実装クラスにも適用可能)</td>
<td><div class="first last line-block">
<div class="line">要素の長さ(要素のサイズ)が<code class="docutils literal"><span class="pre">min</span></code>と<code class="docutils literal"><span class="pre">max</span></code>の間のサイズか検証する。</div>
<div class="line"><code class="docutils literal"><span class="pre">min</span></code>と<code class="docutils literal"><span class="pre">max</span></code>は省略可能であるが、デフォルトは<code class="docutils literal"><span class="pre">min=0</span></code>,<code class="docutils literal"><span class="pre">max=</span> <span class="pre">Integer.MAX_VALUE</span></code>となる。</div>
</div>
</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Size</span><span class="o">(</span><span class="n">min</span><span class="o">=</span><span class="mi">4</span><span class="o">,</span> <span class="n">max</span><span class="o">=</span><span class="mi">64</span><span class="o">)</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">&#64;Digits</span></code></td>
<td><code class="docutils literal"><span class="pre">BigDecimal</span></code>, <code class="docutils literal"><span class="pre">BigInteger</span></code>, <code class="docutils literal"><span class="pre">String</span></code>, <code class="docutils literal"><span class="pre">byte</span></code>, <code class="docutils literal"><span class="pre">short</span></code>, <code class="docutils literal"><span class="pre">int</span></code>, <code class="docutils literal"><span class="pre">long</span></code>およびラッパー</td>
<td><div class="first last line-block">
<div class="line">値が指定された範囲内の数値であるかチェックする。</div>
<div class="line"><code class="docutils literal"><span class="pre">integer</span></code>に最大整数の桁を指定し、<code class="docutils literal"><span class="pre">fraction</span></code>に最大小数桁を指定する。</div>
</div>
</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Digits</span><span class="o">(</span><span class="n">integer</span><span class="o">=</span><span class="mi">6</span><span class="o">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mi">2</span><span class="o">)</span>
<span class="kd">private</span> <span class="n">BigDecimal</span> <span class="n">price</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">&#64;AssertTrue</span></code></td>
<td><code class="docutils literal"><span class="pre">boolean</span></code>,<code class="docutils literal"><span class="pre">Boolean</span></code></td>
<td>対象のフィールドが<code class="docutils literal"><span class="pre">true</span></code>であることを検証する(例：規約に同意したかどうか)</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@AssertTrue</span>
<span class="kd">private</span> <span class="kt">boolean</span> <span class="n">checked</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">&#64;AssertFalse</span></code></td>
<td><code class="docutils literal"><span class="pre">boolean</span></code>,<code class="docutils literal"><span class="pre">Boolean</span></code></td>
<td>対象のフィールドが<code class="docutils literal"><span class="pre">false</span></code>であることを検証する</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@AssertFalse</span>
<span class="kd">private</span> <span class="kt">boolean</span> <span class="n">checked</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">&#64;Future</span></code></td>
<td><code class="docutils literal"><span class="pre">Date</span></code>, <code class="docutils literal"><span class="pre">Calendar</span></code>および<code class="docutils literal"><span class="pre">JSR-310</span> <span class="pre">Date</span> <span class="pre">and</span> <span class="pre">Time</span> <span class="pre">API</span></code>で提供されるクラス
(Hibernate Validator実装ではJoda-Timeのクラスにも適用可能。詳細は、「<a class="reference external" href="https://javaee.github.io/javaee-spec/javadocs/javax/validation/constraints/Future.html">&#64;FutureアノテーションのJavaDoc</a>」を参照されたい。)</td>
<td>未来日付であるか検証する。</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Future</span>
<span class="kd">private</span> <span class="n">Date</span> <span class="n">eventDate</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">&#64;FutureOrPresent</span></code></td>
<td><code class="docutils literal"><span class="pre">Date</span></code>, <code class="docutils literal"><span class="pre">Calendar</span></code>および<code class="docutils literal"><span class="pre">JSR-310</span> <span class="pre">Date</span> <span class="pre">and</span> <span class="pre">Time</span> <span class="pre">API</span></code>で提供されるクラス
(Hibernate Validator実装ではJoda-Timeのクラスにも適用可能。詳細は、「<a class="reference external" href="https://javaee.github.io/javaee-spec/javadocs/javax/validation/constraints/FutureOrPresent.html">&#64;FutureOrPresentアノテーションのJavaDoc</a>」を参照されたい。)</td>
<td><div class="first last line-block">
<div class="line">現在または未来日付であるか検証する。（2.0から追加）</div>
</div>
</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@FutureOrPresent</span>
<span class="kd">private</span> <span class="n">Date</span> <span class="n">eventDate</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">&#64;Past</span></code></td>
<td><code class="docutils literal"><span class="pre">Date</span></code>, <code class="docutils literal"><span class="pre">Calendar</span></code>および<code class="docutils literal"><span class="pre">JSR-310</span> <span class="pre">Date</span> <span class="pre">and</span> <span class="pre">Time</span> <span class="pre">API</span></code>で提供されるクラス
(Hibernate Validator実装ではJoda-Timeのクラスにも適用可能。詳細は、「<a class="reference external" href="https://javaee.github.io/javaee-spec/javadocs/javax/validation/constraints/Past.html">&#64;PastアノテーションのJavaDoc</a>」を参照されたい。)</td>
<td>過去日付であるか検証する。</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Past</span>
<span class="kd">private</span> <span class="n">Date</span> <span class="n">eventDate</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">&#64;PastOrPresent</span></code></td>
<td><code class="docutils literal"><span class="pre">Date</span></code>, <code class="docutils literal"><span class="pre">Calendar</span></code>および<code class="docutils literal"><span class="pre">JSR-310</span> <span class="pre">Date</span> <span class="pre">and</span> <span class="pre">Time</span> <span class="pre">API</span></code>で提供されるクラス
(Hibernate Validator実装ではJoda-Timeのクラスにも適用可能。詳細は、「<a class="reference external" href="https://javaee.github.io/javaee-spec/javadocs/javax/validation/constraints/PastOrPresent.html">&#64;PastOrPresentアノテーションのJavaDoc</a>」を参照されたい。)</td>
<td><div class="first last line-block">
<div class="line">現在または過去日付であるか検証する。（2.0から追加）</div>
</div>
</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@PastOrPresent</span>
<span class="kd">private</span> <span class="n">Date</span> <span class="n">eventDate</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">&#64;Email</span></code></td>
<td>任意の<code class="docutils literal"><span class="pre">CharSequence</span></code>インタフェースの実装クラスに適用可能</td>
<td><div class="first last line-block">
<div class="line">E-mailアドレスとして妥当であること検証する。（2.0から追加）</div>
</div>
</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Email</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">&#64;Valid</span></code></td>
<td>任意の非プリミティブ型</td>
<td>関連付けられているオブジェクトについて、再帰的に検証を行う。</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Valid</span>
<span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Employer</span><span class="o">&gt;</span> <span class="n">employers</span><span class="o">;</span>

<span class="nd">@Valid</span>
<span class="kd">private</span> <span class="n">Dept</span> <span class="n">dept</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><code class="docutils literal"><span class="pre">&#64;Size</span></code>アノテーションでは、サロゲートペアと呼ばれるchar型2つ（32ビット）で表される文字に対する考慮がされていない。</p>
<p>サロゲートペアを含む文字列をチェック対象とした場合、カウントした文字数が実際の入力文字数より多くカウントされる可能性があるため注意すること。</p>
<p class="last">サロゲートペアを含む文字列の文字列長については、 <a class="reference internal" href="../GeneralFuncDetail/StringProcessing.html#stringprocessinghowtogetsurrogatepairstringlength"><span class="std std-ref">文字列長の取得</span></a> を参照されたい。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>E-mailの形式は<a class="reference external" href="https://www.ietf.org/rfc/rfc2822.txt">RFC2822</a>で定義されているが、<code class="docutils literal"><span class="pre">&#64;Email</span></code>は厳密にRFC2822に準拠していることをチェックするものではない。</p>
<p>例えばマルチバイト文字（全角文字）を含んでいても<code class="docutils literal"><span class="pre">&#64;Email</span></code>でのチェックをパスすることが確認されている。
また、実際に利用されているEmailアドレスも、必ずしもRFC2822に厳密に準拠しているわけではない。</p>
<p class="last">これらの注意点を考慮した上で、利用・サポートするSMTPサーバなどによって適切なルールでの入力チェックを実装することを推奨する。
実装の際は、<a class="reference internal" href="#validation-convine-existing-constraint"><span class="std std-ref">既存ルールを組み合わせたBean Validationアノテーションの作成</span></a>を参照されたい。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Bean Validationが提供する<code class="docutils literal"><span class="pre">ClockProvider</span></code>を実装することで、
<code class="docutils literal"><span class="pre">&#64;Past</span></code>、<code class="docutils literal"><span class="pre">&#64;Future</span></code>、<code class="docutils literal"><span class="pre">&#64;PastOrPresent</span></code>、<code class="docutils literal"><span class="pre">&#64;FutureOrPresent</span></code>の基準となる日付を変更することが出来る。
なお、実装した<code class="docutils literal"><span class="pre">ClockProvider</span></code>を適用するには、<code class="docutils literal"><span class="pre">LocalValidatorFactoryBean</span></code>の継承クラスを作成し、<code class="docutils literal"><span class="pre">postProcessConfiguration</span></code>メソッドをオーバーライドすれば良い。
<code class="docutils literal"><span class="pre">ClockProvider</span></code>を実装したクラスの例に関しては、<a class="reference external" href="http://docs.jboss.org/hibernate/validator/6.0/reference/en-US/html_single/#section-clock-provider">Hibernate Validator Reference Guide(ClockProvider and temporal validation tolerance)</a>を参照されたい。</p>
</div>
</div>
<div class="section" id="validation-validator-list">
<span id="id27"></span><h4><a class="toc-backref" href="#id71">4.1.4.1.2. Hibernate Validatorのチェックルール</a><a class="headerlink" href="#validation-validator-list" title="Permalink to this headline">¶</a></h4>
<p>Hibernate Validatorの代表的なアノテーション(<code class="docutils literal"><span class="pre">org.hibernate.validator.constraints.*</span></code>)を以下に示す。</p>
<p>詳細は、<a class="reference external" href="http://docs.jboss.org/hibernate/validator/6.0/reference/en-US/html_single/#validator-defineconstraints-hv-constraints">Hibernate Validator仕様</a>を参照されたい。</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="15%" />
<col width="30%" />
<col width="30%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">アノテーション</th>
<th class="head">対象の型</th>
<th class="head">説明</th>
<th class="head">使用例</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">&#64;CreditCardNumber</span></code></td>
<td>任意の<code class="docutils literal"><span class="pre">CharSequence</span></code>インタフェースの実装クラスに適用可能</td>
<td><div class="first last line-block">
<div class="line">Luhnアルゴリズムでクレジットカード番号が妥当かどうかを検証する。使用可能な番号かどうかをチェックするわけではない。</div>
<div class="line"><code class="docutils literal"><span class="pre">ignoreNonDigitCharacters</span> <span class="pre">=</span> <span class="pre">true</span></code>を指定する事で、数字以外の文字を無視して検証する事ができる。</div>
</div>
</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@CreditCardNumber</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">cardNumber</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">&#64;ISBN</span></code></td>
<td>任意の<code class="docutils literal"><span class="pre">CharSequence</span></code>インタフェースの実装クラスに適用可能</td>
<td><div class="first last line-block">
<div class="line">ISBNの形式として妥当であること（番号の長さとチェックディジット）を検証する。</div>
<div class="line"><code class="docutils literal"><span class="pre">type</span></code>を指定する事で、ISBNの形式（ISBN-10とISBN-13）の選択が出来る。デフォルトではISBN-13となる。</div>
<div class="line">検証時には、ISBN以外のすべての文字（0-9までの数字とX以外の文字）は無視される。</div>
<div class="line">このため、番号の一部を”<code class="docutils literal"><span class="pre">-</span></code>“を利用して区切ることが出来る。（例：978-161-729-045-9）</div>
</div>
</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@ISBN</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">bookNumber</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">&#64;URL</span></code></td>
<td>任意の<code class="docutils literal"><span class="pre">CharSequence</span></code>インタフェースの実装クラスに適用可能</td>
<td>URLとして妥当であること検証する。<code class="docutils literal"><span class="pre">java.net.URL</span></code>のコンストラクタを使用して文字列検証を行っており、
URLとして妥当とされるプロトコルはJVMがサポートするプロトコル(<code class="docutils literal"><span class="pre">http</span></code>,<code class="docutils literal"><span class="pre">https</span></code>,<code class="docutils literal"><span class="pre">file</span></code>,<code class="docutils literal"><span class="pre">jar</span></code>など)に依存する。</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@URL</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">url</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">従来、Hibernate Validatorの独自アノテーションであった<code class="docutils literal"><span class="pre">&#64;Email</span></code>、<code class="docutils literal"><span class="pre">&#64;NotBlank</span></code>、<code class="docutils literal"><span class="pre">&#64;NotEmpty</span></code>は、Bean Validation 2.0よりデフォルトで提供されるようになった。
これに伴い、Hibernate Validator 6.0より、Hibernate Validatorが提供する<code class="docutils literal"><span class="pre">&#64;Email</span></code>、<code class="docutils literal"><span class="pre">&#64;NotBlank</span></code>、<code class="docutils literal"><span class="pre">&#64;NotEmpty</span></code>は非推奨となった。
引き続き使用することは出来るが、Bean Validationで提供されるアノテーションを使用することを推奨する。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><code class="docutils literal"><span class="pre">&#64;URL</span></code>にて、JVMがサポートしていないプロトコルについても妥当として検証したい場合、Hibernateから提供されている<code class="docutils literal"><span class="pre">org.hibernate.validator.constraintvalidators.RegexpURLValidator</span></code>を使用する。
当該クラスは<code class="docutils literal"><span class="pre">&#64;URL</span></code>アノテーションに対応するValidatorクラスで、URL形式であるかを正規表現で検証しており、JVMがサポートしていないプロトコルについても妥当として検証可能である。</p>
<ul class="simple">
<li>アプリケーション全体の<code class="docutils literal"><span class="pre">&#64;URL</span></code>のチェックルールを変更してもよい場合には、<a class="reference external" href="https://docs.jboss.org/hibernate/validator/6.0/api/org/hibernate/validator/constraints/URL.html">JavaDoc</a>に記載されているように、
XMLにてValidatorクラスを<code class="docutils literal"><span class="pre">RegexpURLValidator</span></code>に変更する。</li>
<li>一部の項目だけに正規表現による検証を適用し、<code class="docutils literal"><span class="pre">&#64;URL</span></code>はデフォルトのルールを使用したい場合には、新規アノテーション、および<code class="docutils literal"><span class="pre">RegexpURLValidator</span></code>と同様の検証を行う<code class="docutils literal"><span class="pre">javax.validation.ConstraintValidator</span></code>実装クラスを作成し、
必要な項目に作成したアノテーションによる検証を適用する。</li>
</ul>
<p>など、用途に応じた適用を行えばよい。</p>
<p class="last">XMLによるチェックルール変更の詳細については<a class="reference external" href="https://docs.jboss.org/hibernate/validator/6.0/reference/en-US/html_single/#section-configuration-validation-xml">Hibernateのリファレンス</a>を、
新規アノテーションの作成方法については、<a class="reference internal" href="#validation-implement-new-constraint"><span class="std std-ref">新規ルールを実装したBean Validationアノテーションの作成</span></a>をそれぞれ参照されたい。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">&#64;ISBN</span></code>アノテーションはHibernate Validator 6.0.6.Finalより追加された。</p>
</div>
</div>
</div>
<div class="section" id="validation-default-message-in-hibernate-validator">
<span id="id29"></span><h3><a class="toc-backref" href="#id72">4.1.4.2. Hibernate Validatorが用意するデフォルトメッセージ</a><a class="headerlink" href="#validation-default-message-in-hibernate-validator" title="Permalink to this headline">¶</a></h3>
<p>hibernate-validator-&lt;version&gt;.jar内のorg/hibernate/validatorに、ValidationMessages.propertiesのデフォルト値が定義されている。</p>
<div class="highlight-properties"><div class="highlight"><pre><span></span><span class="na">javax.validation.constraints.AssertFalse.message</span>     <span class="o">=</span> <span class="s">must be false</span>
<span class="na">javax.validation.constraints.AssertTrue.message</span>      <span class="o">=</span> <span class="s">must be true</span>
<span class="na">javax.validation.constraints.DecimalMax.message</span>      <span class="o">=</span> <span class="s">must be less than ${inclusive == true ? &#39;or equal to &#39; : &#39;&#39;}{value}</span>
<span class="na">javax.validation.constraints.DecimalMin.message</span>      <span class="o">=</span> <span class="s">must be greater than ${inclusive == true ? &#39;or equal to &#39; : &#39;&#39;}{value}</span>
<span class="na">javax.validation.constraints.Digits.message</span>          <span class="o">=</span> <span class="s">numeric value out of bounds (&lt;{integer} digits&gt;.&lt;{fraction} digits&gt; expected)</span>
<span class="na">javax.validation.constraints.Email.message</span>           <span class="o">=</span> <span class="s">must be a well-formed email address</span>
<span class="na">javax.validation.constraints.Future.message</span>          <span class="o">=</span> <span class="s">must be a future date</span>
<span class="na">javax.validation.constraints.FutureOrPresent.message</span> <span class="o">=</span> <span class="s">must be a date in the present or in the future</span>
<span class="na">javax.validation.constraints.Max.message</span>             <span class="o">=</span> <span class="s">must be less than or equal to {value}</span>
<span class="na">javax.validation.constraints.Min.message</span>             <span class="o">=</span> <span class="s">must be greater than or equal to {value}</span>
<span class="na">javax.validation.constraints.Negative.message</span>        <span class="o">=</span> <span class="s">must be less than 0</span>
<span class="na">javax.validation.constraints.NegativeOrZero.message</span>  <span class="o">=</span> <span class="s">must be less than or equal to 0</span>
<span class="na">javax.validation.constraints.NotBlank.message</span>        <span class="o">=</span> <span class="s">must not be blank</span>
<span class="na">javax.validation.constraints.NotEmpty.message</span>        <span class="o">=</span> <span class="s">must not be empty</span>
<span class="na">javax.validation.constraints.NotNull.message</span>         <span class="o">=</span> <span class="s">must not be null</span>
<span class="na">javax.validation.constraints.Null.message</span>            <span class="o">=</span> <span class="s">must be null</span>
<span class="na">javax.validation.constraints.Past.message</span>            <span class="o">=</span> <span class="s">must be a past date</span>
<span class="na">javax.validation.constraints.PastOrPresent.message</span>   <span class="o">=</span> <span class="s">must be a date in the past or in the present</span>
<span class="na">javax.validation.constraints.Pattern.message</span>         <span class="o">=</span> <span class="s">must match &quot;{regexp}&quot;</span>
<span class="na">javax.validation.constraints.Positive.message</span>        <span class="o">=</span> <span class="s">must be greater than 0</span>
<span class="na">javax.validation.constraints.PositiveOrZero.message</span>  <span class="o">=</span> <span class="s">must be greater than or equal to 0</span>
<span class="na">javax.validation.constraints.Size.message</span>            <span class="o">=</span> <span class="s">size must be between {min} and {max}</span>

<span class="na">org.hibernate.validator.constraints.CreditCardNumber.message</span>        <span class="o">=</span> <span class="s">invalid credit card number</span>
<span class="na">org.hibernate.validator.constraints.Currency.message</span>                <span class="o">=</span> <span class="s">invalid currency (must be one of {value})</span>
<span class="na">org.hibernate.validator.constraints.EAN.message</span>                     <span class="o">=</span> <span class="s">invalid {type} barcode</span>
<span class="na">org.hibernate.validator.constraints.Email.message</span>                   <span class="o">=</span> <span class="s">not a well-formed email address</span>
<span class="na">org.hibernate.validator.constraints.ISBN.message</span>                    <span class="o">=</span> <span class="s">invalid ISBN</span>
<span class="na">org.hibernate.validator.constraints.Length.message</span>                  <span class="o">=</span> <span class="s">length must be between {min} and {max}</span>
<span class="na">org.hibernate.validator.constraints.CodePointLength.message</span>         <span class="o">=</span> <span class="s">length must be between {min} and {max}</span>
<span class="na">org.hibernate.validator.constraints.LuhnCheck.message</span>               <span class="o">=</span> <span class="s">the check digit for ${validatedValue} is invalid, Luhn Modulo 10 checksum failed</span>
<span class="na">org.hibernate.validator.constraints.Mod10Check.message</span>              <span class="o">=</span> <span class="s">the check digit for ${validatedValue} is invalid, Modulo 10 checksum failed</span>
<span class="na">org.hibernate.validator.constraints.Mod11Check.message</span>              <span class="o">=</span> <span class="s">the check digit for ${validatedValue} is invalid, Modulo 11 checksum failed</span>
<span class="na">org.hibernate.validator.constraints.ModCheck.message</span>                <span class="o">=</span> <span class="s">the check digit for ${validatedValue} is invalid, ${modType} checksum failed</span>
<span class="na">org.hibernate.validator.constraints.NotBlank.message</span>                <span class="o">=</span> <span class="s">may not be empty</span>
<span class="na">org.hibernate.validator.constraints.NotEmpty.message</span>                <span class="o">=</span> <span class="s">may not be empty</span>
<span class="na">org.hibernate.validator.constraints.ParametersScriptAssert.message</span>  <span class="o">=</span> <span class="s">script expression &quot;{script}&quot; didn&#39;t evaluate to true</span>
<span class="na">org.hibernate.validator.constraints.Range.message</span>                   <span class="o">=</span> <span class="s">must be between {min} and {max}</span>
<span class="na">org.hibernate.validator.constraints.SafeHtml.message</span>                <span class="o">=</span> <span class="s">may have unsafe html content</span>
<span class="na">org.hibernate.validator.constraints.ScriptAssert.message</span>            <span class="o">=</span> <span class="s">script expression &quot;{script}&quot; didn&#39;t evaluate to true</span>
<span class="na">org.hibernate.validator.constraints.UniqueElements.message</span>          <span class="o">=</span> <span class="s">must only contain unique elements</span>
<span class="na">org.hibernate.validator.constraints.URL.message</span>                     <span class="o">=</span> <span class="s">must be a valid URL</span>

<span class="na">org.hibernate.validator.constraints.br.CNPJ.message</span>                 <span class="o">=</span> <span class="s">invalid Brazilian corporate taxpayer registry number (CNPJ)</span>
<span class="na">org.hibernate.validator.constraints.br.CPF.message</span>                  <span class="o">=</span> <span class="s">invalid Brazilian individual taxpayer registry number (CPF)</span>
<span class="na">org.hibernate.validator.constraints.br.TituloEleitoral.message</span>      <span class="o">=</span> <span class="s">invalid Brazilian Voter ID card number</span>

<span class="na">org.hibernate.validator.constraints.pl.REGON.message</span>                <span class="o">=</span> <span class="s">invalid Polish Taxpayer Identification Number (REGON)</span>
<span class="na">org.hibernate.validator.constraints.pl.NIP.message</span>                  <span class="o">=</span> <span class="s">invalid VAT Identification Number (NIP)</span>
<span class="na">org.hibernate.validator.constraints.pl.PESEL.message</span>                <span class="o">=</span> <span class="s">invalid Polish National Identification Number (PESEL)</span>

<span class="na">org.hibernate.validator.constraints.time.DurationMax.message</span>        <span class="o">=</span> <span class="s">must be shorter than${inclusive == true ? &#39; or equal to&#39; : &#39;&#39;}${days == 0 ? &#39;&#39; : days == 1 ? &#39; 1 day&#39; : &#39; &#39; += days += &#39; days&#39;}${hours == 0 ? &#39;&#39; : hours == 1 ? &#39; 1 hour&#39; : &#39; &#39; += hours += &#39; hours&#39;}${minutes == 0 ? &#39;&#39; : minutes == 1 ? &#39; 1 minute&#39; : &#39; &#39; += minutes += &#39; minutes&#39;}${seconds == 0 ? &#39;&#39; : seconds == 1 ? &#39; 1 second&#39; : &#39; &#39; += seconds += &#39; seconds&#39;}${millis == 0 ? &#39;&#39; : millis == 1 ? &#39; 1 milli&#39; : &#39; &#39; += millis += &#39; millis&#39;}${nanos == 0 ? &#39;&#39; : nanos == 1 ? &#39; 1 nano&#39; : &#39; &#39; += nanos += &#39; nanos&#39;}</span>
<span class="na">org.hibernate.validator.constraints.time.DurationMin.message</span>        <span class="o">=</span> <span class="s">must be longer than${inclusive == true ? &#39; or equal to&#39; : &#39;&#39;}${days == 0 ? &#39;&#39; : days == 1 ? &#39; 1 day&#39; : &#39; &#39; += days += &#39; days&#39;}${hours == 0 ? &#39;&#39; : hours == 1 ? &#39; 1 hour&#39; : &#39; &#39; += hours += &#39; hours&#39;}${minutes == 0 ? &#39;&#39; : minutes == 1 ? &#39; 1 minute&#39; : &#39; &#39; += minutes += &#39; minutes&#39;}${seconds == 0 ? &#39;&#39; : seconds == 1 ? &#39; 1 second&#39; : &#39; &#39; += seconds += &#39; seconds&#39;}${millis == 0 ? &#39;&#39; : millis == 1 ? &#39; 1 milli&#39; : &#39; &#39; += millis += &#39; millis&#39;}${nanos == 0 ? &#39;&#39; : nanos == 1 ? &#39; 1 nano&#39; : &#39; &#39; += nanos += &#39; nanos&#39;}</span>
</pre></div>
</div>
</div>
<div class="section" id="validation-terasoluna-gfw">
<span id="id30"></span><h3><a class="toc-backref" href="#id73">4.1.4.3. 共通ライブラリが用意する入力チェックルール</a><a class="headerlink" href="#validation-terasoluna-gfw" title="Permalink to this headline">¶</a></h3>
<p>共通ライブラリでは、独自の検証用アノテーションを提供している。
ここでは、共通ライブラリで提供しているアノテーションを使用した入力チェックルールの指定方法について説明する。</p>
<div class="section" id="terasoluna-gfw-common">
<h4><a class="toc-backref" href="#id74">4.1.4.3.1. terasoluna-gfw-commonのチェックルール</a><a class="headerlink" href="#terasoluna-gfw-common" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw/tree/5.5.1.RELEASE/terasoluna-gfw-common-libraries/terasoluna-gfw-common">terasoluna-gfw-common</a>が提供するアノテーション(<code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.codelist.*</span></code>)を以下に示す。</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="15%" />
<col width="30%" />
<col width="30%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">アノテーション</th>
<th class="head">対象の型</th>
<th class="head">説明</th>
<th class="head">使用例</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">&#64;ExistInCodeList</span></code></td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Character</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">CharSequence</span></code>の実装クラス</div>
<div class="line">(<code class="docutils literal"><span class="pre">String</span></code>, <code class="docutils literal"><span class="pre">StringBuilder</span></code>など)</div>
<div class="line"><code class="docutils literal"><span class="pre">Number</span></code>の継承クラス</div>
<div class="line">(<code class="docutils literal"><span class="pre">Integer</span></code>, <code class="docutils literal"><span class="pre">Long</span></code>など) <strong>5.4.2から追加</strong></div>
</div>
</td>
<td>値がコードリストに含まれているかどうかを検証する。</td>
<td><a class="reference internal" href="Codelist.html#codelist-validate"><span class="std std-ref">&#64;ExistInCodeList</span></a>参照</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="terasoluna-gfw-codepoints">
<h4><a class="toc-backref" href="#id75">4.1.4.3.2. terasoluna-gfw-codepointsのチェックルール</a><a class="headerlink" href="#terasoluna-gfw-codepoints" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw/tree/5.5.1.RELEASE/terasoluna-gfw-common-libraries/terasoluna-gfw-codepoints">terasoluna-gfw-codepoints</a>が提供するアノテーション(<code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.codepoints.*</span></code>)を以下に示す。なお、<code class="docutils literal"><span class="pre">terasoluna-gfw-codepoints</span></code>はバージョン5.1.0.RELEASE以上で利用することができる。</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="15%" />
<col width="30%" />
<col width="30%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">アノテーション</th>
<th class="head">対象の型</th>
<th class="head">説明</th>
<th class="head">使用例</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">&#64;ConsistOf</span></code></td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">CharSequence</span></code>の実装クラス</div>
<div class="line">(<code class="docutils literal"><span class="pre">String</span></code>, <code class="docutils literal"><span class="pre">StringBuilder</span></code>など)</div>
</div>
</td>
<td>チェック対象の文字列が指定したコードポイント集合に全て含まれるかどうかを検証する。</td>
<td><a class="reference internal" href="../GeneralFuncDetail/StringProcessing.html#stringprocessinghowtousecodepointsvalidator"><span class="std std-ref">&#64;ConsistOf</span></a>参照</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="terasoluna-gfw-validator">
<span id="validation-terasoluna-gfw-list"></span><h4><a class="toc-backref" href="#id76">4.1.4.3.3. terasoluna-gfw-validatorのチェックルール</a><a class="headerlink" href="#terasoluna-gfw-validator" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw/tree/5.5.1.RELEASE/terasoluna-gfw-common-libraries/terasoluna-gfw-validator">terasoluna-gfw-validator</a>が提供するアノテーション(<code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.validator.constraints.*</span></code>)を以下に示す。なお、<code class="docutils literal"><span class="pre">terasoluna-gfw-validator</span></code>はバージョン5.1.0.RELEASE以上で利用することができる。</p>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="15%" />
<col width="30%" />
<col width="30%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">アノテーション</th>
<th class="head">対象の型</th>
<th class="head">説明</th>
<th class="head">使用例</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">&#64;ByteMin</span></code></td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">CharSequence</span></code>の実装クラス</div>
<div class="line">(<code class="docutils literal"><span class="pre">String</span></code>, <code class="docutils literal"><span class="pre">StringBuilder</span></code>など)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">値のバイト長が最小値以上であることを検証する。</div>
<div class="line"><br /></div>
<div class="line"><strong>[アノテーションの属性]</strong></div>
<div class="line"><code class="docutils literal"><span class="pre">long</span> <span class="pre">value</span></code> - バイト長の最小値を指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">String</span> <span class="pre">charset</span></code> - 値をバイトシーケンスに符号化する際に使用する文字セットを指定する。デフォルト値は<code class="docutils literal"><span class="pre">UTF-8</span></code>。</div>
</div>
</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@ByteMin</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span>
        <span class="n">charset</span> <span class="o">=</span> <span class="s">&quot;Shift_JIS&quot;</span><span class="o">)</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">id</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">&#64;ByteMax</span></code></td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">CharSequence</span></code>の実装クラス</div>
<div class="line">(<code class="docutils literal"><span class="pre">String</span></code>, <code class="docutils literal"><span class="pre">StringBuilder</span></code>など)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">値のバイト長が最大値以下であることを検証する。</div>
<div class="line"><br /></div>
<div class="line"><strong>[アノテーションの属性]</strong></div>
<div class="line"><code class="docutils literal"><span class="pre">long</span> <span class="pre">value</span></code> - バイト長の最大値を指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">String</span> <span class="pre">charset</span></code> - 値をバイトシーケンスに符号化する際に使用する文字セットを指定する。デフォルト値は<code class="docutils literal"><span class="pre">UTF-8</span></code>。</div>
</div>
</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@ByteMax</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">id</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">&#64;ByteSize</span></code></td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">CharSequence</span></code>の実装クラス</div>
<div class="line">(<code class="docutils literal"><span class="pre">String</span></code>, <code class="docutils literal"><span class="pre">StringBuilder</span></code>など)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">値のバイト長が最小値と最大値の範囲内であることを検証する。（<strong>5.4.2から追加</strong>）</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;ByteMin</span></code>と <code class="docutils literal"><span class="pre">&#64;ByteMax</span></code>を組み合わせて使う場合は、こちらを使うことを推奨する。</div>
<div class="line"><br /></div>
<div class="line"><strong>[アノテーションの属性]</strong></div>
<div class="line"><code class="docutils literal"><span class="pre">long</span> <span class="pre">min</span></code> - バイト長の最小値を指定する。デフォルト値は<code class="docutils literal"><span class="pre">0</span></code>。</div>
<div class="line"><code class="docutils literal"><span class="pre">long</span> <span class="pre">max</span></code> - バイト長の最大値を指定する。デフォルト値は<code class="docutils literal"><span class="pre">Long.MAX_VALUE</span></code>。</div>
<div class="line"><code class="docutils literal"><span class="pre">String</span> <span class="pre">charset</span></code> - 値をバイトシーケンスに符号化する際に使用する文字セットを指定する。デフォルト値は<code class="docutils literal"><span class="pre">UTF-8</span></code>。</div>
</div>
</td>
<td><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@ByteSize</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">100</span><span class="o">)</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">id</span><span class="o">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">&#64;Compare</span></code></td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Comparable</span></code>インタフェースの実装クラスをプロパティにもつ任意のJavaBeanに適用可能</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">指定したプロパティの値の比較結果が正しいことを検証する。</div>
<div class="line"><br /></div>
<div class="line"><strong>[アノテーションの属性]</strong></div>
<div class="line"><code class="docutils literal"><span class="pre">String</span> <span class="pre">left</span></code> - オブジェクト内の比較元としたいプロパティ名を指定する。検証エラーとなった場合は、このプロパティにメッセージを表示される。</div>
<div class="line"><code class="docutils literal"><span class="pre">String</span> <span class="pre">right</span></code> - オブジェクト内の比較先としたいプロパティ名を指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.validator.constraints.Compare.Operator</span> <span class="pre">operator</span></code> - 比較方法を示す列挙型<code class="docutils literal"><span class="pre">Operator</span></code>の値を指定する。指定可能な値は以下の通り。</div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">EQUAL</span></code> : <code class="docutils literal"><span class="pre">left</span> <span class="pre">=</span> <span class="pre">right</span></code>である</li>
<li><code class="docutils literal"><span class="pre">NOT_EQUAL</span></code> : <code class="docutils literal"><span class="pre">left</span> <span class="pre">!=</span> <span class="pre">right</span></code>である</li>
<li><code class="docutils literal"><span class="pre">GREATER_THAN</span></code> : <code class="docutils literal"><span class="pre">left</span> <span class="pre">&gt;</span> <span class="pre">right</span></code>である</li>
<li><code class="docutils literal"><span class="pre">GREATER_THAN_OR_EQUAL</span></code> : <code class="docutils literal"><span class="pre">left</span> <span class="pre">&gt;=</span> <span class="pre">right</span></code>である</li>
<li><code class="docutils literal"><span class="pre">LESS_THAN</span></code> : <code class="docutils literal"><span class="pre">left</span> <span class="pre">&lt;</span> <span class="pre">right</span></code>である</li>
<li><code class="docutils literal"><span class="pre">LESS_THAN_OR_EQUAL</span></code> : <code class="docutils literal"><span class="pre">left</span> <span class="pre">&lt;=</span> <span class="pre">right</span></code>である</li>
</ul>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">NOT_EQUAL</span></code>は、terasoluna-gfw-validator 5.3.2.RELEASE以上で利用可能な値である。</div>
<div class="line"><br /></div>
<div class="line"><code class="docutils literal"><span class="pre">boolean</span> <span class="pre">requireBoth</span></code> - <code class="docutils literal"><span class="pre">left</span></code>属性と<code class="docutils literal"><span class="pre">right</span></code>属性で指定したフィールドの両方が入力されている（<code class="docutils literal"><span class="pre">null</span></code>でない）必要があるかどうかを指定する。</div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">true</span></code> : どちらか一方だけ入力されている場合は検証エラーとする。ただし、両方とも未入力の場合は検証成功とする</li>
<li><code class="docutils literal"><span class="pre">false</span></code> : どちらか一方でも入力されている場合は検証成功とする（デフォルト）</li>
</ul>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.validator.constraints.Compare.Node</span> <span class="pre">node</span></code> - エラーメッセージを出力するパスを示す列挙型<code class="docutils literal"><span class="pre">Node</span></code>の値を指定する。指定可能な値は以下の通り。</div>
</div>
<ul class="last simple">
<li><code class="docutils literal"><span class="pre">PROPERTY</span></code> : <code class="docutils literal"><span class="pre">left</span></code>属性で指定したフィールドのエラーとして出力する（デフォルト）</li>
<li><code class="docutils literal"><span class="pre">ROOT_BEAN</span></code> : チェックを実施したオブジェクトのエラーとして出力する</li>
</ul>
</td>
<td><p class="first">メールアドレスと確認用に入力したメールアドレスが一致することをチェックし、フォーム全体のエラーメッセージとして表示する場合、以下のように実装する。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Compare</span><span class="o">(</span><span class="n">left</span> <span class="o">=</span> <span class="s">&quot;email&quot;</span><span class="o">,</span>
        <span class="n">right</span> <span class="o">=</span> <span class="s">&quot;confirmEmail&quot;</span><span class="o">,</span>
        <span class="n">operator</span> <span class="o">=</span> <span class="n">Compare</span><span class="o">.</span><span class="na">Operator</span><span class="o">.</span><span class="na">EQUAL</span><span class="o">,</span>
        <span class="n">requireBoth</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">Compare</span><span class="o">.</span><span class="na">Node</span><span class="o">.</span><span class="na">ROOT_BEAN</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserRegisterForm</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">confirmEmail</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>期間の開始日と終了日が両方入力された場合は、開始日が終了日以前であることをチェックし、期間の開始日にエラーメッセージを表示する場合、以下のように実装する。</p>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Compare</span><span class="o">(</span><span class="n">left</span> <span class="o">=</span> <span class="s">&quot;form&quot;</span><span class="o">,</span>
        <span class="n">right</span> <span class="o">=</span> <span class="s">&quot;to&quot;</span><span class="o">,</span>
        <span class="n">operator</span> <span class="o">=</span> <span class="n">Compare</span><span class="o">.</span><span class="na">Operator</span><span class="o">.</span><span class="na">LESS_THAN_OR_EQUAL</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Period</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">from</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">to</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>相関項目チェックにおける入力必須について</strong></p>
<p>単項目チェックにおいては、入力フィールドが入力されている（ <code class="docutils literal"><span class="pre">null</span></code>でない）かどうかは <code class="docutils literal"><span class="pre">&#64;NotNull</span></code>を併用してチェックすればよい。しかし、相関項目チェックにおいては、「どちらか一方でも入力した場合は、もう一方の入力を強制する」といった、 <code class="docutils literal"><span class="pre">&#64;NotNull</span></code>の併用だけでは実現できない場合がある。このため、<code class="docutils literal"><span class="pre">&#64;Compare</span></code>では、チェック対象の入力必須を制御する <code class="docutils literal"><span class="pre">requireBoth</span></code>属性を提供しており、これを併用して要件に応じたチェックを実装することができる。</p>
<p>なお、入力フィールドが未入力の場合に <code class="docutils literal"><span class="pre">null</span></code>がバインドされる場合のみ、 <code class="docutils literal"><span class="pre">requireBoth</span></code>属性が利用できる。Spring MVCでは文字列の入力フィールドに未入力の状態でフォームを送信した場合、デフォルトでは、フォームオブジェクトに<code class="docutils literal"><span class="pre">null</span></code>ではなく、空文字がバインドされることに注意しなければならない。  文字列フィールドが未入力の場合に、空文字ではなく、<code class="docutils literal"><span class="pre">null</span></code>をフォームオブジェクトにバインドするには、<a class="reference internal" href="#validation-string-trimmer-editor"><span class="std std-ref">文字列フィールドが未入力の場合にnullをバインドする</span></a>を参照されたい。</p>
<p>期間の開始日が終了日以前であることのチェックを例に、想定されるチェック要件と設定の例を以下に示す。</p>
<blockquote class="last">
<div><table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">チェック要件</th>
<th class="head">設定例</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">from</span></code>と <code class="docutils literal"><span class="pre">to</span></code>がともに必須で、<code class="docutils literal"><span class="pre">from</span></code>と <code class="docutils literal"><span class="pre">to</span></code>の比較チェックを行う。</td>
<td><p class="first"><code class="docutils literal"><span class="pre">from</span></code>と <code class="docutils literal"><span class="pre">to</span></code>に <code class="docutils literal"><span class="pre">&#64;NotNull</span></code>を付与し、 <code class="docutils literal"><span class="pre">requireBoth</span></code>属性はデフォルト値（ <code class="docutils literal"><span class="pre">false</span></code>）を使用する。</p>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Compare</span><span class="o">(</span><span class="n">left</span> <span class="o">=</span> <span class="s">&quot;from&quot;</span><span class="o">,</span> <span class="n">right</span> <span class="o">=</span> <span class="s">&quot;to&quot;</span><span class="o">,</span> <span class="n">operator</span> <span class="o">=</span> <span class="n">Compare</span><span class="o">.</span><span class="na">Operator</span><span class="o">.</span><span class="na">LESS_THAN_OR_EQUAL</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Period</span> <span class="o">{</span>
  <span class="nd">@NotNull</span>
  <span class="n">LocalDate</span> <span class="n">from</span><span class="o">;</span>
  <span class="nd">@NotNull</span>
  <span class="n">LocalDate</span> <span class="n">to</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">from</span></code>だけ必須だが、 <code class="docutils literal"><span class="pre">to</span></code>も入力された時は比較チェックする。</td>
<td><p class="first"><code class="docutils literal"><span class="pre">from</span></code>にだけ <code class="docutils literal"><span class="pre">&#64;NotNull</span></code>を付与し、 <code class="docutils literal"><span class="pre">requireBoth</span></code>属性はデフォルト値（ <code class="docutils literal"><span class="pre">false</span></code>）を使用する。</p>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Compare</span><span class="o">(</span><span class="n">left</span> <span class="o">=</span> <span class="s">&quot;from&quot;</span><span class="o">,</span> <span class="n">right</span> <span class="o">=</span> <span class="s">&quot;to&quot;</span><span class="o">,</span> <span class="n">operator</span> <span class="o">=</span> <span class="n">Compare</span><span class="o">.</span><span class="na">Operator</span><span class="o">.</span><span class="na">LESS_THAN_OR_EQUAL</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Period</span> <span class="o">{</span>
  <span class="nd">@NotNull</span>
  <span class="n">LocalDate</span> <span class="n">from</span><span class="o">;</span>
  <span class="n">LocalDate</span> <span class="n">to</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">from</span></code>と <code class="docutils literal"><span class="pre">to</span></code>がともに必須ではなく、 <code class="docutils literal"><span class="pre">from</span></code>と <code class="docutils literal"><span class="pre">to</span></code>が両方入力された時だけ比較チェックする。どちらか一方だけが入力された場合は比較チェックを行わない。</td>
<td><p class="first"><code class="docutils literal"><span class="pre">&#64;NotNull</span></code>は付与せず、 <code class="docutils literal"><span class="pre">requireBoth</span></code>属性はデフォルト値（ <code class="docutils literal"><span class="pre">false</span></code>）を使用する。</p>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Compare</span><span class="o">(</span><span class="n">left</span> <span class="o">=</span> <span class="s">&quot;from&quot;</span><span class="o">,</span> <span class="n">right</span> <span class="o">=</span> <span class="s">&quot;to&quot;</span><span class="o">,</span> <span class="n">operator</span> <span class="o">=</span> <span class="n">Compare</span><span class="o">.</span><span class="na">Operator</span><span class="o">.</span><span class="na">LESS_THAN_OR_EQUAL</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Period</span> <span class="o">{</span>
  <span class="n">LocalDate</span> <span class="n">from</span><span class="o">;</span>
  <span class="n">LocalDate</span> <span class="n">to</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">from</span></code>と <code class="docutils literal"><span class="pre">to</span></code>がともに必須ではないが、 <code class="docutils literal"><span class="pre">from</span></code>か <code class="docutils literal"><span class="pre">to</span></code>のどちら一方でも入力した場合は、必ず両方入力して比較チェックを行う。</td>
<td><p class="first"><code class="docutils literal"><span class="pre">&#64;NotNull</span></code>は付与せず、 <code class="docutils literal"><span class="pre">requireBoth</span></code>属性に <code class="docutils literal"><span class="pre">true</span></code>を設定する。</p>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Compare</span><span class="o">(</span><span class="n">left</span> <span class="o">=</span> <span class="s">&quot;from&quot;</span><span class="o">,</span> <span class="n">right</span> <span class="o">=</span> <span class="s">&quot;to&quot;</span><span class="o">,</span> <span class="n">operator</span> <span class="o">=</span> <span class="n">Compare</span><span class="o">.</span><span class="na">Operator</span><span class="o">.</span><span class="na">LESS_THAN_OR_EQUAL</span><span class="o">,</span> <span class="n">requireBoth</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Period</span> <span class="o">{</span>
  <span class="n">LocalDate</span> <span class="n">from</span><span class="o">;</span>
  <span class="n">LocalDate</span> <span class="n">to</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id34">
<h4><a class="toc-backref" href="#id77">4.1.4.3.4. 共通ライブラリのチェックルールの適用方法</a><a class="headerlink" href="#id34" title="Permalink to this headline">¶</a></h4>
<p>以下の手順で、共通ライブラリのチェックルールを適用する。</p>
<p>使用したいチェックルールに応じて、依存ライブラリを追加する。<code class="docutils literal"><span class="pre">terasoluna-gfw-validator</span></code>を追加する例を以下に示す。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.terasoluna.gfw<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>terasoluna-gfw-validator<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">上記設定例は、依存ライブラリのバージョンを親プロジェクトである terasoluna-gfw-parent で管理する前提であるため、pom.xmlでのバージョンの指定は不要である。</p>
</div>
<p>次に、<a class="reference internal" href="#validation-message-in-validationmessages"><span class="std std-ref">ValidationMessages.propertiesに定義するメッセージ</span></a>で説明したように <code class="file docutils literal"><span class="pre">ValidationMessages.properties</span></code> に、アノテーションに対応する任意のメッセージ定義を追加する。</p>
<div class="highlight-properties"><div class="highlight"><pre><span></span><span class="c"># (1)</span>
<span class="na">org.terasoluna.gfw.common.validator.constraints.ByteMin.message</span> <span class="o">=</span> <span class="s">must be greater than or equal to {value} bytes</span>
<span class="na">org.terasoluna.gfw.common.validator.constraints.ByteMax.message</span> <span class="o">=</span> <span class="s">must be less than or equal to {value} bytes</span>
<span class="na">org.terasoluna.gfw.common.validator.constraints.ByteSize.message</span> <span class="o">=</span> <span class="s">must be between {min} and {max} bytes</span>
<span class="na">org.terasoluna.gfw.common.validator.constraints.Compare.message</span> <span class="o">=</span> <span class="s">invalid combination of {left} and {right}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>アノテーションごとにメッセージ定義を追加する。アノテーションの属性値は、プレースホルダ（<code class="docutils literal"><span class="pre">{属性名}</span></code>の形式）を使用してメッセージの中に埋め込むことができる。</td>
</tr>
</tbody>
</table>
<p>最後に、<a class="reference internal" href="#validation-basic-validation"><span class="std std-ref">基本的な単項目チェック</span></a>で説明したように、JavaBeanのプロパティにアノテーションを付与する。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Bean Validationでは、アノテーションの属性値の不正により検証が実行できない場合、<code class="docutils literal"><span class="pre">javax.validation.ValidationException</span></code>がスローされる。スタックトレースに出力される原因を参照し、属性値を適切な値に修正すること。</p>
<p class="last">詳細は、<a class="reference external" href="https://beanvalidation.org/2.0/spec/#exception">Bean Validation specification(Exception model)</a>を参照されたい。</p>
</div>
</div>
<div class="section" id="validation-terasoluna-gfw-how-to-extend">
<span id="id35"></span><h4><a class="toc-backref" href="#id78">4.1.4.3.5. 共通ライブラリのチェックルールの拡張方法</a><a class="headerlink" href="#validation-terasoluna-gfw-how-to-extend" title="Permalink to this headline">¶</a></h4>
<p>共通ライブラリで提供しているチェックルールを利用して、任意のルールを作成することができる。</p>
<p>以下では、<a class="reference internal" href="#validation-correlation-item-check"><span class="std std-ref">相関項目チェックルール</span></a>で独自に実装した<code class="docutils literal"><span class="pre">&#64;Confirm</span></code>アノテーションを、共通ライブラリで提供しているチェックルールを利用して作成する例を紹介する。</p>
<p><a class="reference internal" href="#validation-convine-existing-constraint"><span class="std std-ref">既存ルールを組み合わせたBean Validationアノテーションの作成</span></a>で説明したように、<code class="docutils literal"><span class="pre">&#64;Compare</span></code>を利用して<code class="docutils literal"><span class="pre">&#64;Confirm</span></code>アノテーションを作成する。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.sample.domain.validation</span><span class="o">;</span>

<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.ANNOTATION_TYPE</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.TYPE</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.RetentionPolicy.RUNTIME</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.Documented</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.Constraint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.OverridesAttribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Payload</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.validator.constraints.Compare</span><span class="o">;</span>

<span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{})</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">TYPE</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span> <span class="o">})</span> <span class="c1">// (1)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="nd">@Compare</span><span class="o">(</span><span class="n">left</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">,</span> <span class="n">right</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">,</span> <span class="n">operator</span> <span class="o">=</span> <span class="n">Compare</span><span class="o">.</span><span class="na">Operator</span><span class="o">.</span><span class="na">EQUAL</span><span class="o">,</span> <span class="n">requireBoth</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <span class="c1">// (2)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">Confirm</span> <span class="o">{</span>

    <span class="nd">@OverridesAttribute</span><span class="o">(</span><span class="n">constraint</span> <span class="o">=</span> <span class="n">Compare</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;message&quot;</span><span class="o">)</span> <span class="c1">// (3)</span>
    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{com.example.sample.domain.validation.Confirm.message}&quot;</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="nf">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="nd">@OverridesAttribute</span><span class="o">(</span><span class="n">constraint</span> <span class="o">=</span> <span class="n">Compare</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;left&quot;</span><span class="o">)</span> <span class="c1">// (4)</span>
    <span class="n">String</span> <span class="nf">field</span><span class="o">();</span>

    <span class="nd">@OverridesAttribute</span><span class="o">(</span><span class="n">constraint</span> <span class="o">=</span> <span class="n">Compare</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;right&quot;</span><span class="o">)</span> <span class="c1">// (5)</span>
    <span class="n">String</span> <span class="nf">confirmField</span><span class="o">();</span>

    <span class="nd">@Documented</span>
    <span class="nd">@Target</span><span class="o">({</span> <span class="n">TYPE</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
    <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">Confirm</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">このアノテーションを付与できる場所を、クラスまたはアノテーションに限定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;Compare</span></code>アノテーションの<code class="docutils literal"><span class="pre">operator</span></code>属性に<code class="docutils literal"><span class="pre">Compare.Operator.EQUAL</span></code>(同値であること)を指定する。どちらか一方が未入力の場合はエラーとするため、<code class="docutils literal"><span class="pre">requireBoth</span></code>属性に<code class="docutils literal"><span class="pre">true</span></code>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;Compare</span></code>アノテーションの<code class="docutils literal"><span class="pre">message</span></code>属性をオーバーライドし、エラー時に<code class="docutils literal"><span class="pre">message</span></code>属性に指定したメッセージが使用されるようにする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;Compare</span></code>アノテーションの<code class="docutils literal"><span class="pre">left</span></code>属性をオーバーライドし、属性名を<code class="docutils literal"><span class="pre">field</span></code>に変更する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">同様に<code class="docutils literal"><span class="pre">right</span></code>属性をオーバーライドし、属性名を<code class="docutils literal"><span class="pre">confirmField</span></code>に変更する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>「<a class="reference internal" href="#validation-convine-existing-constraint"><span class="std std-ref">既存ルールを組み合わせたBean Validationアノテーションの作成</span></a>」では<code class="docutils literal"><span class="pre">&#64;ReportAsSingleViolation</span></code>を付与する方法を紹介しているが、<code class="docutils literal"><span class="pre">&#64;ReportAsSingleViolation</span></code>を付与するとラップされた<code class="docutils literal"><span class="pre">&#64;Compare</span></code>のエラーメッセージは使用されず、<code class="docutils literal"><span class="pre">&#64;Confirm</span></code>のエラーメッセージのみが表示される。<code class="docutils literal"><span class="pre">&#64;Confirm</span></code>はフォームオブジェクトに対する入力チェックであるため、エラーメッセージはフォームオブジェクトに割り当てられ、実際に表示したい<code class="docutils literal"><span class="pre">field</span></code>属性に指定したフィールドには割り当てられない。</p>
<p class="last">これを回避するためには、<code class="docutils literal"><span class="pre">&#64;ReportAsSingleViolation</span></code>を付与せず、<code class="docutils literal"><span class="pre">&#64;Confirm</span></code>の<code class="docutils literal"><span class="pre">message</span></code>属性で<code class="docutils literal"><span class="pre">&#64;Compare</span></code>の<code class="docutils literal"><span class="pre">message</span></code>属性をオーバーライドする必要がある。これにより、<code class="docutils literal"><span class="pre">&#64;Compare</span></code>のルールに従い<code class="docutils literal"><span class="pre">left</span></code>属性（つまり<code class="docutils literal"><span class="pre">&#64;Confirm</span></code>の<code class="docutils literal"><span class="pre">field</span></code>属性）に<code class="docutils literal"><span class="pre">&#64;Confirm</span></code>のエラーメッセージを割り当てることができるようになる。</p>
</div>
<p><a class="reference internal" href="#validation-correlation-item-check"><span class="std std-ref">相関項目チェックルール</span></a>で実装したアノテーションの代わりに、上記で作成したアノテーションを使用する。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.sample.app.validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.common.validation.Confirm</span><span class="o">;</span>

<span class="nd">@Confirm</span><span class="o">(</span><span class="n">field</span> <span class="o">=</span> <span class="s">&quot;password&quot;</span><span class="o">,</span> <span class="n">confirmField</span> <span class="o">=</span> <span class="s">&quot;confirmPassword&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordResetForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="nd">@NotNull</span> <span class="c1">// (2)</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">8</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>

    <span class="nd">@NotNull</span> <span class="c1">// (3)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">confirmPassword</span><span class="o">;</span>

    <span class="c1">// omitted geter/setter</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クラスレベルに<code class="docutils literal"><span class="pre">&#64;Confirm</span></code>アノテーションを付与する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">password</span></code>フィールドが<code class="docutils literal"><span class="pre">null</span></code>の場合は<code class="docutils literal"><span class="pre">&#64;Confirm</span></code>の検証はパスするため、<code class="docutils literal"><span class="pre">null</span></code>チェックは<code class="docutils literal"><span class="pre">&#64;NotNull</span></code>アノテーションを付与して行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">同様に<code class="docutils literal"><span class="pre">confirmPassword</span></code>フィールドにも、<code class="docutils literal"><span class="pre">&#64;NotNull</span></code>アノテーションを付与する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="validation-type-mismatch">
<span id="id36"></span><h3><a class="toc-backref" href="#id79">4.1.4.4. 型のミスマッチ</a><a class="headerlink" href="#validation-type-mismatch" title="Permalink to this headline">¶</a></h3>
<p>フォームオブジェクトの<code class="docutils literal"><span class="pre">String</span></code>以外のフィールドに対して、変換不可能な値を送信した場合は<code class="docutils literal"><span class="pre">org.springframework.beans.TypeMismatchException</span></code>がスローされる。</p>
<p>「新規ユーザー登録」処理の例では「Age」フィールドは<code class="docutils literal"><span class="pre">Integer</span></code>で定義されているが、このフィールドに対して整数に変換できない値を入力すると、以下のようなエラーメッセージが表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/validations-typemismatch1.png"><img alt="../../_images/validations-typemismatch1.png" src="../../_images/validations-typemismatch1.png" style="width: 60%;" /></a>
</div>
<p>例外の原因がそのまま表示されてしまい、エラーメッセージとしては不適切である。
型がミスマッチの場合のエラーメッセージは、<code class="docutils literal"><span class="pre">org.springframework.context.MessageSource</span></code>が読み込むpropertiesファイル(application-messages.properties)に定義できる。</p>
<p>以下のルールで、エラーメッセージを定義すればよい。</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="35%" />
<col width="40%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">メッセージキー</th>
<th class="head">メッセージ内容</th>
<th class="head">用途</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">typeMismatch</span></code></td>
<td>型ミスマッチエラーのデフォルトメッセージ</td>
<td>システム全体のデフォルト値</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">typeMismatch.対象のFQCN</span></code></td>
<td>特定の型ミスマッチエラーのデフォルトメッセージ</td>
<td>システム全体のデフォルト値</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">typeMismatch.フォーム属性名.プロパティ名</span></code></td>
<td>特定のフォームのフィールドに対する型ミスマッチエラーのメッセージ</td>
<td>画面毎に変更したいメッセージ</td>
</tr>
</tbody>
</table>
<p>application-messages.propertiesに以下の定義を行った場合、</p>
<div class="highlight-properties"><div class="highlight"><pre><span></span><span class="c"># typemismatch</span>
<span class="na">typeMismatch</span><span class="o">=</span><span class="s">&quot;{0}&quot; is invalid.</span>
<span class="na">typeMismatch.int</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be an integer.</span>
<span class="na">typeMismatch.double</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be a double.</span>
<span class="na">typeMismatch.float</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be a float.</span>
<span class="na">typeMismatch.long</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be a long.</span>
<span class="na">typeMismatch.short</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be a short.</span>
<span class="na">typeMismatch.java.lang.Integer</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be an integer.</span>
<span class="na">typeMismatch.java.lang.Double</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be a double.</span>
<span class="na">typeMismatch.java.lang.Float</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be a float.</span>
<span class="na">typeMismatch.java.lang.Long</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be a long.</span>
<span class="na">typeMismatch.java.lang.Short</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be a short.</span>
<span class="na">typeMismatch.java.util.Date</span><span class="o">=</span><span class="s">&quot;{0}&quot; is not a date.</span>

<span class="c"># filed names</span>
<span class="na">name</span><span class="o">=</span><span class="s">Name</span>
<span class="na">email</span><span class="o">=</span><span class="s">Email</span>
<span class="na">age</span><span class="o">=</span><span class="s">Age</span>
</pre></div>
</div>
<p>エラーメッセージは、次のように変更される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/validations-typemismatch2.png"><img alt="../../_images/validations-typemismatch2.png" src="../../_images/validations-typemismatch2.png" style="width: 60%;" /></a>
</div>
<div class="line-block">
<div class="line"><a class="reference internal" href="#validation-message-in-application-messages"><span class="std std-ref">application-messages.propertiesに定義するメッセージ</span></a>で説明したように、<code class="docutils literal"><span class="pre">{0}</span></code>でフィールド名を埋めることができる。</div>
<div class="line"><strong>基本的にデフォルトメッセージは定義しておくこと</strong>。</div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">メッセージキーのルールの詳細は、<a class="reference external" href="https://docs.spring.io/spring/docs/5.1.4.RELEASE/javadoc-api/org/springframework/validation/DefaultMessageCodesResolver.html">DefaultMessageCodesResolverのJavadoc</a>を参照されたい。</p>
</div>
</div>
<div class="section" id="null">
<span id="validation-string-trimmer-editor"></span><h3><a class="toc-backref" href="#id80">4.1.4.5. 文字列フィールドが未入力の場合にnullをバインドする</a><a class="headerlink" href="#null" title="Permalink to this headline">¶</a></h3>
<p>これまで説明してきたように、Spring MVCでは文字列の入力フィールドに未入力の状態でフォームを送信した場合、
デフォルトでは、フォームオブジェクトに<code class="docutils literal"><span class="pre">null</span></code>ではなく、空文字がバインドされる。</p>
<p>この場合、「未入力は許容するが、入力された場合は6文字以上であること」という要件を、既存のアノテーションで満たすことができない。</p>
<div class="line-block">
<div class="line">文字列フィールドが未入力の場合に、空文字ではなく、<code class="docutils literal"><span class="pre">null</span></code>をフォームオブジェクトにバインドするには、</div>
<div class="line">以下のように<code class="docutils literal"><span class="pre">org.springframework.beans.propertyeditors.StringTrimmerEditor</span></code>を使用すればよい。</div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;xxx&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">XxxController</span> <span class="o">{</span>

    <span class="nd">@InitBinder</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initBinder</span><span class="o">(</span><span class="n">WebDataBinder</span> <span class="n">binder</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// bind empty strings as null</span>
        <span class="n">binder</span><span class="o">.</span><span class="na">registerCustomEditor</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">StringTrimmerEditor</span><span class="o">(</span><span class="kc">true</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">// omitted ...</span>
<span class="o">}</span>
</pre></div>
</div>
<p>この設定により、Controller毎に空文字を<code class="docutils literal"><span class="pre">null</span></code>とみなすかどうかを設定できる。</p>
<p>プロジェクト全体で空文字を<code class="docutils literal"><span class="pre">null</span></code>にしたい場合は、プロジェクト共通設定として<a class="reference internal" href="../../ImplementationAtEachLayer/ApplicationLayer.html#application-layer-controller-advice"><span class="std std-ref">&#64;ControllerAdvice</span></a>で設定すればよい。</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>Spring Framework 4.0 より追加された&#64;ControllerAdviceアノテーションの属性について</strong></p>
<p class="last"><code class="docutils literal"><span class="pre">&#64;ControllerAdvice</span></code>アノテーションの属性を指定することで、
<code class="docutils literal"><span class="pre">&#64;ControllerAdvice</span></code>が付与されたクラスで実装したメソッドを適用するControllerを柔軟に指定できるように改善されている。
属性の詳細については、<a class="reference internal" href="../../ImplementationAtEachLayer/ApplicationLayer.html#application-layer-controller-advice-attribute"><span class="std std-ref">&#64;ControllerAdviceの属性</span></a>を参照されたい。</p>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">XxxControllerAdvice</span> <span class="o">{</span>

    <span class="nd">@InitBinder</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initBinder</span><span class="o">(</span><span class="n">WebDataBinder</span> <span class="n">binder</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// bind empty strings as null</span>
        <span class="n">binder</span><span class="o">.</span><span class="na">registerCustomEditor</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">StringTrimmerEditor</span><span class="o">(</span><span class="kc">true</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">// omitted ...</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">この設定を行った場合は、フォームオブジェクトの文字列フィールドに設定される空文字がすべて<code class="docutils literal"><span class="pre">null</span></code>になる。</div>
<div class="line">したがって、必須チェックに、かならず<code class="docutils literal"><span class="pre">&#64;NotNull</span></code>が必要であることに注意しないといけない。</div>
</div>
</div>
<div class="section" id="native-to-ascii">
<span id="validation-without-native2ascii"></span><h3><a class="toc-backref" href="#id81">4.1.4.6. Native to Asciiを行わないメッセージの読み込み</a><a class="headerlink" href="#native-to-ascii" title="Permalink to this headline">¶</a></h3>
<p>Native to Asciiを行わずにBean Validationのメッセージ（<code class="docutils literal"><span class="pre">ValidationMessage.properties</span></code>）を読み込む方法紹介する。</p>
<p>日本語メッセージをNative to Asciiせずに直接扱いたい場合、Springの <code class="docutils literal"><span class="pre">MessageSource</span></code>と連携すると簡単に実装することができる。</p>
<p>以下のように定義すると、<code class="docutils literal"><span class="pre">MessageSource</span></code>の機能で読み込まれたメッセージが<code class="docutils literal"><span class="pre">Hibernate</span> <span class="pre">Validator</span></code>の中で
使用されるようになる。</p>
<ul>
<li><p class="first">Bean定義</p>
<p><code class="docutils literal"><span class="pre">*-domain.xml</span></code></p>
</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;validator&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.validation.beanvalidation.LocalValidatorFactoryBean&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;validationMessageSource&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.context.support.ResourceBundleMessageSource&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;basenames&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;list&gt;</span>
                    <span class="nt">&lt;value&gt;</span>ValidationMessages<span class="nt">&lt;/value&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
                <span class="nt">&lt;/list&gt;</span>
            <span class="nt">&lt;/property&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultEncoding&quot;</span> <span class="na">value=</span><span class="s">&quot;UTF-8&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.validation.beanvalidation.MethodValidationPostProcessor&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;validator&quot;</span> <span class="na">ref=</span><span class="s">&quot;validator&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">spring-mvc.xml</span></code></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (5) --&gt;</span>
<span class="nt">&lt;mvc:annotation-driven</span> <span class="na">validator=</span><span class="s">&quot;validator&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- ommited --&gt;</span>
<span class="nt">&lt;/mvc:annotation-driven&gt;</span>

<span class="c">&lt;!-- (6) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.validation.beanvalidation.MethodValidationPostProcessor&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;validator&quot;</span> <span class="na">ref=</span><span class="s">&quot;validator&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><code class="docutils literal"><span class="pre">LocalValidatorFactoryBean</span></code>をBean定義する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><code class="docutils literal"><span class="pre">MessageSource</span></code>の定義。ここでは<code class="docutils literal"><span class="pre">ResourceBundleMessageSource</span></code>を使用する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><code class="docutils literal"><span class="pre">ApplicationContext</span></code>に読み込ませるリソースバンドルを指定する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#methodvalidation"><span class="std std-ref">Method Validation</span></a>を利用する際には、<code class="docutils literal"><span class="pre">MethodValidationPostProcessor</span></code>の<code class="docutils literal"><span class="pre">validator</span></code>プロパティに(1)で定義したBeanを指定する。</div>
<div class="line">Method Validationを利用しない場合、このBean定義は不要である。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><code class="docutils literal"><span class="pre">&lt;mvc:annotation-driven&gt;</span></code>要素の<code class="docutils literal"><span class="pre">validator</span></code>属性に、(1)で定義したBeanを指定する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td>(4)と同様である。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">MessageSource</span></code>の機能を利用することで、
プロパティファイルの配置先がクラスパス直下に制限されなくなる。また、複数のプロパティファイルを指定することもできるようになる。</p>
</div>
</div></blockquote>
</div>
<div class="section" id="os">
<span id="validation-os-command-injection"></span><h3><a class="toc-backref" href="#id82">4.1.4.7. OSコマンドインジェクション対策</a><a class="headerlink" href="#os" title="Permalink to this headline">¶</a></h3>
<p>ここでは、セキュリティ脆弱性の一種であるOSコマンドインジェクションとその対策について説明する。</p>
<div class="section" id="id38">
<h4><a class="toc-backref" href="#id83">4.1.4.7.1. OSコマンドインジェクションとは</a><a class="headerlink" href="#id38" title="Permalink to this headline">¶</a></h4>
<p>OSコマンドインジェクションとは、アプリケーション内でユーザー入力文字列からコマンド実行文字列を組み立てている箇所がある場合に、
ユーザー入力文字列の中に悪意のあるコマンドが送り込まれると、コンピュータを不正に操られてしまう問題である。</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">詳細は、OWASPの<a class="reference external" href="https://www.owasp.org/index.php/Command_Injection">解説ページ</a>などを参照されたい。</p>
</div>
<p>Javaでは<code class="docutils literal"><span class="pre">ProcessBuilder</span></code>クラスや、<code class="docutils literal"><span class="pre">Runtime</span></code>クラスの<code class="docutils literal"><span class="pre">exec</span></code>メソッドを用いてコマンドを実行する際に、実行するコマンドとして以下のものを利用する場合に、
OSコマンドインジェクションが発生する可能性がある。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">/bin/sh</span></code>（Unix系の場合）や<code class="docutils literal"><span class="pre">cmd.exe</span></code>（Windowsの場合）</li>
<li>ユーザーが入力した文字列</li>
</ul>
<p>以下では、<code class="docutils literal"><span class="pre">/bin/sh</span></code>を利用する場合にOSコマンドインジェクションが発生する例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">ProcessBuilder</span> <span class="n">pb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProcessBuilder</span><span class="o">(</span><span class="s">&quot;/bin/sh&quot;</span><span class="o">,</span> <span class="s">&quot;-c&quot;</span><span class="o">,</span> <span class="n">script</span><span class="o">);</span> <span class="c1">// (1)</span>
<span class="n">Process</span> <span class="n">p</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例えば、<code class="docutils literal"><span class="pre">script</span></code>に”exec.sh ; cat /etc/passwd” が入ると、文字列中のセミコロンが<code class="docutils literal"><span class="pre">/bin/sh</span></code>により区切り文字として解釈され、”cat /etc/passwd”が実行される。</div>
<div class="line">そのため、標準出力の扱い方によっては<code class="docutils literal"><span class="pre">/etc/passwd</span></code>が出力される可能性がある。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>ScriptEngineやScriptTemplateViewResolverの利用について</strong></p>
<p>Java SE 6より追加された<code class="docutils literal"><span class="pre">ScriptEngine</span></code>や、Spring Framework 4.2より追加された<code class="docutils literal"><span class="pre">ScriptTemplateViewResolver</span></code>では、
JVM上で別言語（<code class="docutils literal"><span class="pre">Ruby</span></code>や<code class="docutils literal"><span class="pre">Python</span></code>など）を使用することができる。</p>
<p class="last">これらの機能を利用して別言語のコードを実行する場合、コードの書き方によってはOSコマンドインジェクションが発生する可能性があるため、
利用には十分注意すること。</p>
</div>
</div>
<div class="section" id="id40">
<h4><a class="toc-backref" href="#id84">4.1.4.7.2. 対策方法</a><a class="headerlink" href="#id40" title="Permalink to this headline">¶</a></h4>
<p>OSコマンドインジェクションを起こさないためには、可能な限り外部プロセスの実行を避ける。ただし諸般の事情により外部プロセスの実行がどうしても必要な場合、
以下の対策を行った上で外部プロセス実行を実装すること。</p>
<ul class="simple">
<li>極力、<code class="docutils literal"><span class="pre">/bin/sh</span></code>（Unix系の場合）や<code class="docutils literal"><span class="pre">cmd.exe</span></code>（Windowsの場合）を使用したコマンド実行を行わない</li>
<li>ユーザーにより入力された文字が、アプリケーションとして許可されたものであるか、ホワイトリスト方式を用いてチェックする</li>
</ul>
<p>以下では、ユーザーが入力したコマンドと引数が指定された文字列で構成されているかをホワイトリスト方式でチェックするルールの例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Pattern</span><span class="o">(</span><span class="n">regexp</span> <span class="o">=</span> <span class="s">&quot;batch0\\d\\.sh&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">cmdStr</span><span class="o">;</span>

<span class="nd">@Pattern</span><span class="o">(</span><span class="n">regexp</span> <span class="o">=</span> <span class="s">&quot;[\\w=_]+&quot;</span><span class="o">)</span>  <span class="c1">// (2)</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">arg</span><span class="o">;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">コマンドとして <code class="docutils literal"><span class="pre">batch0X.sh</span></code>（Xは0から9までの半角数字）のみ許可するルールを指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数として、無害な文字である半角英数字（\w）、”<code class="docutils literal"><span class="pre">=</span></code>” 、”<code class="docutils literal"><span class="pre">_</span></code>” から構成された文字列のみ許可するルールを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">この例では、コマンドや引数にパスが含まれないようなルールとすることで、ディレクトリトラバーサルを起こさないようにしている。</p>
</div>
<p><code class="docutils literal"><span class="pre">&#64;Pattern</span></code>を利用する場合、<code class="docutils literal"><span class="pre">&#64;Pattern</span></code>に指定された正規表現がそのままエラーメッセージとして出力され、
以下の点でメッセージとしては不適切である。</p>
<ul class="simple">
<li>エラーの意味が不明確となり、ユーザに優しくない</li>
<li>脆弱性への対策のためのロジックが利用者に露呈してしまう</li>
</ul>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/validations-os-command-injection.png"><img alt="../../_images/validations-os-command-injection.png" src="../../_images/validations-os-command-injection.png" style="width: 60%;" /></a>
</div>
<p>エラーの意味を明確にし、かつ、ロジックを隠蔽するために、application-messages.propertiesに適切なメッセージを定義する。
メッセージの定義方法については、<a class="reference internal" href="#validation-message-in-application-messages"><span class="std std-ref">application-messages.propertiesに定義するメッセージ</span></a>を参照されたい。</p>
<div class="highlight-properties"><div class="highlight"><pre><span></span><span class="na">Pattern.cmdForm.cmdStr</span> <span class="o">=</span> <span class="s">permit command name: batch00.sh - batch09.sh</span>
<span class="na">Pattern.cmdForm.arg</span> <span class="o">=</span> <span class="s">permit parameter characters and symbols: alphanumeric, =, _</span>
</pre></div>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/validations-os-command-injection2.png"><img alt="../../_images/validations-os-command-injection2.png" src="../../_images/validations-os-command-injection2.png" style="width: 60%;" /></a>
</div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ExceptionHandling.html" title="4.2. 例外ハンドリング"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="4. Webアプリ開発機能"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.5.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >4. Webアプリ開発機能</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer">
      © Copyright 2013, NTT DATA Corporation. © Copyright 2013, NTT Corporation.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3.Theme is <a href="http://github.com/vimalkvn/solar-theme">Solar</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>4.3. セッション管理 &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.7.0.SP1.RELEASE documentation</title>
    <link rel="stylesheet" href="../../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '5.7.0.SP1.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="4.4. ページネーション" href="Pagination.html" />
    <link rel="prev" title="4.2. 例外ハンドリング" href="ExceptionHandling.html" /><script src="../../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../../_static/solarized-dark.css" rel="stylesheet">
<link href="../../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="Pagination.html" title="4.4. ページネーション"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ExceptionHandling.html" title="4.2. 例外ハンドリング"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.7.0.SP1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">4. Webアプリ開発機能</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">4.3. セッション管理</a><ul>
<li><a class="reference internal" href="#overview">4.3.1. Overview</a><ul>
<li><a class="reference internal" href="#id3">4.3.1.1. セッションのライフサイクル</a><ul>
<li><a class="reference internal" href="#id4">4.3.1.1.1. セッションの生成</a></li>
<li><a class="reference internal" href="#id5">4.3.1.1.2. セッションへの属性格納</a></li>
<li><a class="reference internal" href="#id6">4.3.1.1.3. セッションからの属性削除</a></li>
<li><a class="reference internal" href="#id7">4.3.1.1.4. セッションの破棄</a></li>
<li><a class="reference internal" href="#id8">4.3.1.1.5. セッションタイムアウト後のリクエスト検知</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id9">4.3.1.2. セッションの利用について</a><ul>
<li><a class="reference internal" href="#id10">4.3.1.2.1. セッション利用時のメリットとデメリット</a></li>
<li><a class="reference internal" href="#id11">4.3.1.2.2. セッションを利用しない時のメリットとデメリット</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id12">4.3.1.3. セッションに格納するデータについて</a><ul>
<li><a class="reference internal" href="#id13">4.3.1.3.1. シリアライズ可能なオブジェクト</a></li>
<li><a class="reference internal" href="#id14">4.3.1.3.2. セッションに格納するデータの容量</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ap">4.3.1.4. APサーバ多重化時の考慮点について</a></li>
<li><a class="reference internal" href="#id15">4.3.1.5. セッションの保存先について</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">4.3.2. How to use</a><ul>
<li><a class="reference internal" href="#sessionattributes">4.3.2.1. <code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>アノテーションの使用</a><ul>
<li><a class="reference internal" href="#id16">4.3.2.1.1. セッションに格納するオブジェクトの指定</a></li>
<li><a class="reference internal" href="#id17">4.3.2.1.2. セッションにオブジェクトを追加</a></li>
<li><a class="reference internal" href="#id18">4.3.2.1.3. セッションに格納されているオブジェクトの取得</a></li>
<li><a class="reference internal" href="#id19">4.3.2.1.4. セッションに格納したオブジェクトの削除</a></li>
<li><a class="reference internal" href="#id20">4.3.2.1.5. &#64;SessionAttributesを使った処理の実装例</a></li>
</ul>
</li>
<li><a class="reference internal" href="#spring-frameworksessionbean">4.3.2.2. Spring FrameworkのsessionスコープのBeanの使用</a><ul>
<li><a class="reference internal" href="#sessionbean">4.3.2.2.1. sessionスコープのBean定義</a></li>
<li><a class="reference internal" href="#id21">4.3.2.2.2. sessionスコープのBeanの利用</a></li>
<li><a class="reference internal" href="#id22">4.3.2.2.3. セッションに格納したオブジェクトの削除</a></li>
<li><a class="reference internal" href="#id23">4.3.2.2.4. sessionスコープのBeanを使った処理の実装例</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id24">4.3.2.3. セッション操作のデバッグログ出力</a></li>
<li><a class="reference internal" href="#jsp-sessionscope">4.3.2.4. JSPの暗黙オブジェクト <code class="docutils literal"><span class="pre">sessionScope</span></code> を使用する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend">4.3.3. How to extend</a><ul>
<li><a class="reference internal" href="#session-management-how-to-extend-synchronizeonsession">4.3.3.1. 同一セッション内のリクエストの同期化</a></li>
</ul>
</li>
<li><a class="reference internal" href="#appendix">4.3.4. Appendix</a><ul>
<li><a class="reference internal" href="#session-management-appendix-sessionattribute">4.3.4.1. <code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>アノテーションを使ったウィザード形式の画面遷移の実装例</a></li>
<li><a class="reference internal" href="#sessionbeancontroller">4.3.4.2. sessionスコープのBeanを使った複数のControllerを跨いだ画面遷移の実装例</a></li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="ExceptionHandling.html"
                        title="previous chapter">4.2. 例外ハンドリング</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="Pagination.html"
                        title="next chapter">4.4. ページネーション</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/ArchitectureInDetail/WebApplicationDetail/SessionManagement.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="id1">
<h1>4.3. セッション管理<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="id2">
<p class="topic-title">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id31">Overview</a><ul>
<li><a class="reference internal" href="#id3" id="id32">セッションのライフサイクル</a><ul>
<li><a class="reference internal" href="#id4" id="id33">セッションの生成</a></li>
<li><a class="reference internal" href="#id5" id="id34">セッションへの属性格納</a></li>
<li><a class="reference internal" href="#id6" id="id35">セッションからの属性削除</a></li>
<li><a class="reference internal" href="#id7" id="id36">セッションの破棄</a></li>
<li><a class="reference internal" href="#id8" id="id37">セッションタイムアウト後のリクエスト検知</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id9" id="id38">セッションの利用について</a><ul>
<li><a class="reference internal" href="#id10" id="id39">セッション利用時のメリットとデメリット</a></li>
<li><a class="reference internal" href="#id11" id="id40">セッションを利用しない時のメリットとデメリット</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id12" id="id41">セッションに格納するデータについて</a><ul>
<li><a class="reference internal" href="#id13" id="id42">シリアライズ可能なオブジェクト</a></li>
<li><a class="reference internal" href="#id14" id="id43">セッションに格納するデータの容量</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ap" id="id44">APサーバ多重化時の考慮点について</a></li>
<li><a class="reference internal" href="#id15" id="id45">セッションの保存先について</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use" id="id46">How to use</a><ul>
<li><a class="reference internal" href="#sessionattributes" id="id47"><code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>アノテーションの使用</a><ul>
<li><a class="reference internal" href="#id16" id="id48">セッションに格納するオブジェクトの指定</a></li>
<li><a class="reference internal" href="#id17" id="id49">セッションにオブジェクトを追加</a></li>
<li><a class="reference internal" href="#id18" id="id50">セッションに格納されているオブジェクトの取得</a></li>
<li><a class="reference internal" href="#id19" id="id51">セッションに格納したオブジェクトの削除</a></li>
<li><a class="reference internal" href="#id20" id="id52">&#64;SessionAttributesを使った処理の実装例</a></li>
</ul>
</li>
<li><a class="reference internal" href="#spring-frameworksessionbean" id="id53">Spring FrameworkのsessionスコープのBeanの使用</a><ul>
<li><a class="reference internal" href="#sessionbean" id="id54">sessionスコープのBean定義</a></li>
<li><a class="reference internal" href="#id21" id="id55">sessionスコープのBeanの利用</a></li>
<li><a class="reference internal" href="#id22" id="id56">セッションに格納したオブジェクトの削除</a></li>
<li><a class="reference internal" href="#id23" id="id57">sessionスコープのBeanを使った処理の実装例</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id24" id="id58">セッション操作のデバッグログ出力</a></li>
<li><a class="reference internal" href="#jsp-sessionscope" id="id59">JSPの暗黙オブジェクト <code class="docutils literal"><span class="pre">sessionScope</span></code> を使用する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend" id="id60">How to extend</a><ul>
<li><a class="reference internal" href="#session-management-how-to-extend-synchronizeonsession" id="id61">同一セッション内のリクエストの同期化</a></li>
</ul>
</li>
<li><a class="reference internal" href="#appendix" id="id62">Appendix</a><ul>
<li><a class="reference internal" href="#session-management-appendix-sessionattribute" id="id63"><code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>アノテーションを使ったウィザード形式の画面遷移の実装例</a></li>
<li><a class="reference internal" href="#sessionbeancontroller" id="id64">sessionスコープのBeanを使った複数のControllerを跨いだ画面遷移の実装例</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id31">4.3.1. Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>本節では、Webアプリケーションのセッション管理について説明する。</p>
<div class="line-block">
<div class="line">Webアプリケーションは、HTTPを利用して、クライアントとサーバ間でのデータのやり取りを行う。</div>
<div class="line">HTTP自体には、物理的にセッションを維持する仕組みはないが、セッションを識別するための値(セッションID)を、クライアントとサーバとの間で連携することで、論理的にセッションを維持する仕組みが提供されている。</div>
<div class="line">クライアントと、サーバとの間で、セッションIDの連携する方法としては、Cookie、またはリクエストパラメータが使用される。</div>
<div class="line">以下に、論理的なセッションの確立イメージを示す。</div>
</div>
<blockquote>
<div><div class="figure align-center" id="id27">
<a class="reference internal image-reference" href="../../_images/session-management_overview_cooperation.png"><img alt="Establishment of logical session" src="../../_images/session-management_overview_cooperation.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Establishment of logical session</strong></span></p>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Webブラウザ(Client)は、セッションが確立していない状態で、Webアプリケーション(Server)にアクセスする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Webアプリケーションは、Webブラウザとのセッションを管理するために、<code class="docutils literal"><span class="pre">HttpSession</span></code>オブジェクトを生成する。<code class="docutils literal"><span class="pre">HttpSession</span></code>オブジェクトを生成したタイミングで、セッションIDが払い出される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Webアプリケーションは、Webブラウザから送信されたデータを、<code class="docutils literal"><span class="pre">HttpSession</span></code>オブジェクトに格納する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Webアプリケーションは、Webブラウザにレスポンスを返却する。レスポンスの「Set-Cookie」ヘッダに、「JSESSIONID = 払い出されたセッションID」を設定することで、セッションIDをWebブラウザに連携する。</div>
<div class="line">連携したセッションIDはCookieに格納される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Webブラウザは、リクエストの「Cookie」ヘッダに、「JSESSIONID = 払い出されたセッションID」を設定することで、セッションIDをWebアプリケーションと連携する。</div>
<div class="line">Webアプリケーションがデプロイされているアプリケーションサーバは、Webブラウザから連携されたセッションIDに対応する<code class="docutils literal"><span class="pre">HttpSession</span></code>オブジェクトを取得し、リクエストに関連づける。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Webアプリケーションは、リクエストに関連付けられた<code class="docutils literal"><span class="pre">HttpSession</span></code>オブジェクトから、(1)のリクエストで格納したデータを取得する。</div>
<div class="line"><strong>リクエストをまたいで、同じデータにアクセスすることができる。</strong></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Webアプリケーションは、Webブラウザにレスポンスを返却する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>セッションIDを連携するためのパラメータ名について</strong></p>
<p class="last">Jakarta EE（Java EE）のSerlvetの仕様では、セッションIDを連携するためのパラメータ名のデフォルトは、「JSESSIONID」となっている。</p>
</div>
</div></blockquote>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id32">4.3.1.1. セッションのライフサイクル</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">セッションのライフサイクルの制御(生成、破棄、タイムアウト検知)は、Controllerの処理として実装するのではなく、</div>
<div class="line">フレームワークや共通ライブラリから提供されている処理を使用して行う。</div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">以降の説明で登場する <code class="docutils literal"><span class="pre">セッション</span></code> は、Servlet APIより提供されている <code class="docutils literal"><span class="pre">javax.servlet.http.HttpSession</span></code> オブジェクトの事である。
<code class="docutils literal"><span class="pre">HttpSession</span></code> オブジェクトは、上記で説明した論理的なセッションを表現するJavaオブジェクトである。</p>
</div>
</div></blockquote>
<div class="section" id="id4">
<h4><a class="toc-backref" href="#id33">4.3.1.1.1. セッションの生成</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p>本ガイドラインで推奨している方法でWebアプリケーションを作成した場合、以下のいずれかの処理でセッションが生成される。</p>
<blockquote>
<div><table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">Spring Securityから提供されている認証・認可を行う処理。</div>
<div class="line">Spring Securityの設定により、セッションの生成有無や、生成タイミングを指定することができる。</div>
<div class="line">Spring Securityで行われるセッション管理についての詳細は、<a class="reference internal" href="../../Security/SessionManagement.html#authentication-spring-security-how-to-use-sessionmanagement"><span class="std std-ref">How to use</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">Spring Securityから提供されているCSRFトークンチェックを行う処理。</div>
<div class="line">既にセッションが確立されている場合は、新たなセッションは生成されない。</div>
<div class="line">CSRFトークンチェックの詳細については、<a class="reference internal" href="../../Security/CSRF.html"><span class="doc">CSRF対策</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">共通ライブラリから提供されているトランザクショントークンチェックを行う処理。</div>
<div class="line">既にセッションが確立されている場合は、新たなセッションは生成されない。</div>
<div class="line">トランザクショントークンチェックの詳細については、<a class="reference internal" href="DoubleSubmitProtection.html"><span class="doc">二重送信防止</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RedirectAttributes</span></code>インタフェースのaddFlashAttributeメソッドを使用して、リダイレクト先のリクエストにモデル（フォームオブジェクトやドメインオブジェクトなど）を引き渡す処理。</div>
<div class="line">既にセッションが確立されている場合は、新たなセッションは生成されない。</div>
<div class="line"><code class="docutils literal"><span class="pre">RedirectAttributes</span></code>およびFlash scopeについての詳細は、<a class="reference internal" href="../../ImplementationAtEachLayer/ApplicationLayer.html#controller-method-argument-redirectattributes-label"><span class="std std-ref">リダイレクト先にデータを渡す</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>アノテーションを使用して、モデル（フォームオブジェクトや、ドメインオブジェクトなど）をセッションに格納する処理。</div>
<div class="line">指定したモデル（フォームオブジェクトや、ドメインオブジェクトなど）がセッションに格納される。既にセッションが確立されている場合は、新たなセッションは生成されない。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>アノテーションの使用方法については、<a class="reference internal" href="#session-management-how-to-use-sessionattributes"><span class="std std-ref">&#64;SessionAttributesアノテーションの使用</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">Spring Frameworkの、sessionスコープのBeanを使用する処理。</div>
<div class="line">既にセッションが確立されている場合は、新たなセッションは生成されない。</div>
<div class="line">sessionスコープのBeanの使用方法については、<a class="reference internal" href="#session-management-how-to-use-sessionscope"><span class="std std-ref">Spring FrameworkのsessionスコープのBeanの使用</span></a>を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">上記の項番4, 5, 6については、セッションの使用有無はControllerの実装によって指定するが、セッションの生成タイミングは、フレームワークによって制御される。
つまり、Controllerの処理として <code class="docutils literal"><span class="pre">HttpSession</span></code> のAPIを直接使用する必要はない。</p>
</div>
</div></blockquote>
</div>
<div class="section" id="id5">
<h4><a class="toc-backref" href="#id34">4.3.1.1.2. セッションへの属性格納</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<p>本ガイドラインで推奨している方法でWebアプリケーションを作成した場合、以下のいずれかの処理でセッションに属性(オブジェクト)が格納される。</p>
<blockquote>
<div><table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">Spring Securityから提供されている認証を行う処理。</div>
<div class="line">認証されたユーザ情報がセッションに格納される。</div>
<div class="line">Spring Securityで行われる認証処理の詳細は、<a class="reference internal" href="../../Security/Authentication.html"><span class="doc">認証</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">Spring Securityから提供されているCSRFトークンチェックを行う処理。</div>
<div class="line">払い出されたトークン値がセッションに格納される。</div>
<div class="line">CSRFトークンチェックの詳細については、<a class="reference internal" href="../../Security/CSRF.html"><span class="doc">CSRF対策</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">共通ライブラリから提供されているトランザクショントークンチェックを行う処理。</div>
<div class="line">払い出されたトークン値がセッションに格納される。</div>
<div class="line">トランザクショントークンチェックの詳細については、<a class="reference internal" href="DoubleSubmitProtection.html"><span class="doc">二重送信防止</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RedirectAttributes</span></code>インタフェースのaddFlashAttributeメソッドを使用して、リダイレクト先のリクエストにモデル（フォームオブジェクトやドメインオブジェクトなど）を引き渡す処理。</div>
<div class="line"><code class="docutils literal"><span class="pre">RedirectAttributes</span></code>インタフェースのaddFlashAttributeメソッドの引数に指定したオブジェクトが、セッション上に存在するFlash scopeという領域に格納される。</div>
<div class="line"><code class="docutils literal"><span class="pre">RedirectAttributes</span></code>およびFlash scopeについての詳細は、<a class="reference internal" href="../../ImplementationAtEachLayer/ApplicationLayer.html#controller-method-argument-redirectattributes-label"><span class="std std-ref">リダイレクト先にデータを渡す</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>アノテーションを使用して、モデル（フォームオブジェクトや、ドメインオブジェクトなど）をセッションに格納する処理。</div>
<div class="line">指定したモデル（フォームオブジェクトや、ドメインオブジェクトなど）がセッションに格納される。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>アノテーションの使用方法については、<a class="reference internal" href="#session-management-how-to-use-sessionattributes"><span class="std std-ref">&#64;SessionAttributesアノテーションの使用</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">Spring Frameworkの、sessionスコープのBeanを使用する処理。</div>
<div class="line">sessionスコープのBeanがセッションに格納される。</div>
<div class="line">sessionスコープのBeanの使用方法については、<a class="reference internal" href="#session-management-how-to-use-sessionscope"><span class="std std-ref">Spring FrameworkのsessionスコープのBeanの使用</span></a>を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">オブジェクトをセッションに格納するタイミングはフレームワークによって制御されるため、Controllerの処理として <code class="docutils literal"><span class="pre">HttpSession</span></code> オブジェクトのsetAttributeメソッドを呼び出すことはない。</p>
</div>
</div></blockquote>
</div>
<div class="section" id="id6">
<h4><a class="toc-backref" href="#id35">4.3.1.1.3. セッションからの属性削除</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<p>本ガイドラインで推奨している方法で、Webアプリケーションを作成した場合、以下のいずれかの処理でセッションから属性(オブジェクト)が削除される。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">Spring Securityから提供されているログアウトを行う処理。</div>
<div class="line">認証されたユーザ情報がセッションから削除される。</div>
<div class="line">Spring Securityで行われるログアウト処理についての詳細は、<a class="reference internal" href="../../Security/Authentication.html"><span class="doc">認証</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">共通ライブラリから提供されているトランザクショントークンチェックを行う処理。</div>
<div class="line">払い出されたトークン値が、ネームスペースに割り振られている上限値を超えた場合、使用されていないトークン値がセッションから削除される。</div>
<div class="line">トランザクショントークンチェックの詳細については、<a class="reference internal" href="DoubleSubmitProtection.html"><span class="doc">二重送信防止</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">Flash scopeにオブジェクトを格納した後のリダイレクト処理。</div>
<div class="line"><code class="docutils literal"><span class="pre">RedirectAttributes</span></code>インタフェースのaddFlashAttributeメソッドの引数に指定したオブジェクトが、セッション上に存在するFlash scopeという領域から削除される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">Controllerの処理として、 <code class="docutils literal"><span class="pre">SessionStatus</span></code>オブジェクトのsetCompleteメソッドを呼び出した後のフレームワークの処理。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>アノテーションで指定したオブジェクトがセッションから削除される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">セッションからオブジェクトを削除するタイミングはフレームワークによって制御されるため、Controllerの処理として <code class="docutils literal"><span class="pre">HttpSession</span></code> オブジェクトのremoveAttributeメソッドを呼び出すことはない。</p>
</div>
</div></blockquote>
</div>
<div class="section" id="id7">
<h4><a class="toc-backref" href="#id36">4.3.1.1.4. セッションの破棄</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<p>本ガイドラインで推奨している方法で、Webアプリケーションを作成した場合、以下のいずれかの処理でセッションが破棄される。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">Spring Securityから提供されているログアウト処理。</div>
<div class="line">Spring Securityで行われるログアウト処理についての詳細は、<a class="reference internal" href="../../Security/Authentication.html"><span class="doc">認証</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">アプリケーションサーバのセッションタイムアウト検知処理。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>明示的に破棄する際のイメージを、以下に示す。</p>
<blockquote>
<div><div class="figure align-center" id="id28">
<a class="reference internal image-reference" href="../../_images/session-management_overview_invalidate1.png"><img alt="Invalidate session by processing of Web Application" src="../../_images/session-management_overview_invalidate1.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Invalidate session by processing of Web Application</strong></span></p>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Webブラウザからセッションを破棄する処理に、アクセスする。</div>
<div class="line">Spring Securityを使用する場合は、Spring Securityから提供されているログアウト処理が、セッションを破棄する処理を行っている。</div>
<div class="line">Spring Securityで行われるログアウト処理についての詳細は、<a class="reference internal" href="../../Security/Authentication.html"><span class="doc">認証</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Webアプリケーションは、Webブラウザから連携されたセッションIDに対応する<code class="docutils literal"><span class="pre">HttpSession</span></code>オブジェクトを破棄する。</div>
<div class="line">この時点でサーバ側には、 <code class="docutils literal"><span class="pre">SESSION01</span></code> というIDの<code class="docutils literal"><span class="pre">HttpSession</span></code>オブジェクトが消滅する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Webブラウザから破棄されたセッションのセッションIDを使ってアクセスされた場合、セッションIDに対応する<code class="docutils literal"><span class="pre">HttpSession</span></code>オブジェクトが存在しないため、別のセッションを生成する。</div>
<div class="line">上記例では、セッションIDが、 <code class="docutils literal"><span class="pre">SESSION02</span></code> のセッションを生成している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>タイムアウトによって、自動的に破棄される際のイメージを、以下に示す。</p>
<blockquote>
<div><div class="figure align-center" id="id29">
<a class="reference internal image-reference" href="../../_images/session-management_overview_invalidate2.png"><img alt="Invalidate session by timeout Application Server" src="../../_images/session-management_overview_invalidate2.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Invalidate session by Application Server</strong></span></p>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">確立されたセッションに対して一定時間アクセスがない場合、アプリケーションサーバは、セッションタイムアウトを検知する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アプリケーションサーバは、セッションタイムアウトが検知されたセッションを破棄する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">セッションタイムアウト発生後に、Webブラウザからアクセスされた場合、Webブラウザから送られてきたセッションIDに対応する<code class="docutils literal"><span class="pre">HttpSession</span></code>オブジェクトが存在しないため、セッションタイムアウトエラーをWebブラウザに返却する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>セッションタイムアウトの設計</strong></p>
<p class="last">セッションにデータを格納する場合は、必ずセッションタイムアウトの設計を行うこと。特に、格納するデータのサイズが大きくなる場合は、タイムアウトは、可能な限り短く設定することを推奨する。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>デフォルトのセッションタイムアウト時間について</strong></p>
<p>デフォルトのセッションタイムアウト時間は、アプリケーションサーバによって異なる。</p>
<ul class="last simple">
<li>Tomcat : 1800 秒 (30分)</li>
<li>WebLogic : 3600 秒 (60分)</li>
<li>WebSphere : 1800 秒 (30分)</li>
<li>JBoss : 1800 秒 (30分)</li>
</ul>
</div>
</div></blockquote>
</div>
<div class="section" id="id8">
<h4><a class="toc-backref" href="#id37">4.3.1.1.5. セッションタイムアウト後のリクエスト検知</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<p>本ガイドラインで推奨している方法でWebアプリケーションを作成した場合、以下のいずれかの処理で、セッションタイムアウト後のリクエストを検知する。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">Spring Securityから提供されているセッションのタイムアウトチェック処理。</div>
<div class="line">Spring Securityのデフォルトの設定では、セッションのタイムアウトチェックは行われない。</div>
<div class="line">そのため、セッションにデータを格納する場合は、Spring Securityのセッションのタイムアウトチェック処理を有効化するための設定が、必要となる。</div>
<div class="line">Spring Securityで行われるセッションのタイムアウトチェック処理の詳細は、<a class="reference internal" href="../../Security/SessionManagement.html#authentication-spring-security-how-to-use-sessionmanagement"><span class="std std-ref">How to use</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">Spring Securityを使用しない場合は、Servlet Filter、または、Spring MVCの<code class="docutils literal"><span class="pre">HandlerInterceptor</span></code>にて、セッションのタイムアウトチェックを行う処理を実装する必要がある。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>Spring Securityから提供されているセッションチェック処理を使用して、セッションタイムアウトを検知する際のイメージについて、以下に示す。</p>
<blockquote>
<div><div class="figure align-center" id="id30">
<a class="reference internal image-reference" href="../../_images/session-management_overview_sessiontimeout.png"><img alt="Detected a request of after session timeout by Spring Security" src="../../_images/session-management_overview_sessiontimeout.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Detected a request of after session timeout by Spring Security</strong></span></p>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">確立されたセッションに対して、一定時間アクセスがない場合、アプリケーションサーバは、セッションタイムアウトを検知し、セッションを破棄する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">セッションタイムアウト発生後に、Webブラウザからアクセスが発生する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring Securityから提供されているセッションの存在チェック処理は、クライアントから連携されたセッションIDに対応する<code class="docutils literal"><span class="pre">HttpSession</span></code>オブジェクトが存在しないため、セッションタイムアウトエラーとする。</div>
<div class="line">Spring Securityのデフォルト実装では、エラー画面を表示するための、URLへのリダイレクト要求が応答される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>セッションのタイムアウトチェックの必要性</strong></p>
<p class="last">「セッションにデータが格納されていること」が事前条件となる処理については、必ずセッションのタイムアウトチェックを行うこと。
セッションのタイムアウトチェックを行わないと、処理で必要なデータが取得できないため、予期しないシステムエラーの発生や、想定外の動作を引き起こす可能性がある。</p>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="id9">
<h3><a class="toc-backref" href="#id38">4.3.1.2. セッションの利用について</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">複数の画面(複数のリクエスト)をまたがって、データの持ち回りが必要になる場合は、持ち回り対象のデータをセッションに格納することで、簡単にデータを持回ることができる。</div>
<div class="line">ただし、セッションにデータを格納すると、データの持ち回りが簡単になるというメリットがある反面、アプリケーション上の制約などが発生するというデメリットもあるため、アプリケーションおよびシステム要件を考慮して、使用有無を決めること。</div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">本ガイドラインでは、安易にセッションにデータを格納するのではなく、まずはセッションを使わない方針で検討し、本当に必要なデータのみセッションに格納することを推奨する。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>以下の条件にあてはまるデータについては、セッションにデータを格納した方がよい場合がある。</p>
<ul class="last">
<li><div class="first line-block">
<div class="line">ユースケース間で連携はしないが、別のユースケースに移って戻った際に、状態を保持しておく必要があるデータ。</div>
<div class="line">例えば、一覧画面の検索条件が、このパターンに該当する。</div>
<div class="line">一覧画面の検索条件は、別のユースケース（例えば、「検索したデータを変更する」ユースケース）から戻った際に、別のユースケースに移る前の状態を保持することが機能要件となる事が多い。</div>
<div class="line">検索条件をhiddenで持ち回る方法もあるが、ユースケース間に余計な依存関係が生まれ、アプリケーションの実装も複雑になることが予想される。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">ユースケース間で連携が必要なデータ。</div>
<div class="line">たとえば、ショッピングサイトのカートに格納するデータが、このパターンに該当する。</div>
<div class="line">ショッピングサイトのカートに格納するデータは、「商品をカートに追加する」ユースケース、「カートを表示する」ユースケース、「カートの状態を変更する」ユースケース、「カートにいれた商品を購入する」ユースケースでデータの連携が必要となるためである。</div>
<div class="line">ただし、スケラビリティを考慮する必要がある場合は、セッションではなくデータベースに格納した方がよいケースがある。</div>
</div>
</li>
</ul>
</div>
</div></blockquote>
<div class="section" id="id10">
<h4><a class="toc-backref" href="#id39">4.3.1.2.1. セッション利用時のメリットとデメリット</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<p>セッション利用時のメリットとデメリットは、以下の通りである。</p>
<ul>
<li><p class="first"><strong>メリット</strong></p>
<ul>
<li><div class="first line-block">
<div class="line">複数の画面(複数のリクエスト)をまたいで、データを持ち回ることができるため、ウィザード画面のような複数の画面で、1つ処理を構成する場合に、簡単にデータが持ち回れる。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">取得したデータをセッションに格納しておくことで、データの取得処理の実行回数を、減らすことができる。</div>
</div>
</li>
</ul>
</li>
<li><p class="first"><strong>デメリット</strong></p>
<ul>
<li><div class="first line-block">
<div class="line">同一処理の画面を、複数のブラウザやタブで立ち上げた場合、互いの操作がセッション上に格納しているデータに干渉しあうため、データの整合性を保つことができなくなる。</div>
<div class="line">データの整合性を保つためには、同一処理の画面を複数立ち上げることができないように、制御する必要がある。</div>
<div class="line">データの整合性を保つための制御は、共通ライブラリから提供しているトランザクショントークンチェックを使用することで実現する事ができるが、ユーザビリティの低いアプリケーションとなってしまう。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">セッションは、通常アプリケーションサーバ上のメモリとして管理されるため、セッションに格納するデータの量に比例して、メモリの使用量も増大する。</div>
<div class="line">処理で使用されなくなったデータを残したままにすると、ガベージコレクションの対象外となり、メモリ枯渇の原因となるため、不要になった段階でセッションから削除する必要がある。</div>
<div class="line">セッションから不要となったデータを削除するタイミングについて、別途設計を行う必要がある。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">処理で扱うデータをセッションに格納すると、APサーバのスケーラビリティを低下させる要因となりうる。</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>APサーバをスケールアウトする場合、以下のいずれかの仕組みが必要となる。</p>
<ol class="arabic">
<li><div class="first line-block">
<div class="line">セッションをレプリケーションし、すべてのAPサーバでセッション情報を共有する。</div>
<div class="line">セッションをレプリケーションする場合は、セッションに格納されるデータの量とレプリケーション対象となるAPサーバの数に比例してレプリケーション処理にかかる負荷が高くなる。</div>
<div class="line">そのため、スケールアウトすることで、レスポンスタイムなどが劣化する可能性がある点に注意が必要となる。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">ロードバランサによって、同一セッション内で発生するリクエストを全て同じAPサーバに振り分ける。</div>
<div class="line">同じAPサーバに振り分ける場合は、APサーバがダウンした場合に別のAPサーバで処理を継続することができない。</div>
<div class="line">そのため、高い可用性(サービスレベル)が求められるアプリケーションでは使用できない可能性がある点に注意が必要となる。</div>
</div>
</li>
</ol>
<p class="last">それぞれの注意点を考慮した上で、スケールアウトする方法を判断すること。</p>
</div>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id11">
<h4><a class="toc-backref" href="#id40">4.3.1.2.2. セッションを利用しない時のメリットとデメリット</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">セッション使用時のデメリットを回避するためには、サーバの処理で必要となるすべてのデータを、リクエストパラメータとして連携することで、実現することができる。</div>
<div class="line">セッションを利用しない時の、メリットとデメリットは、以下の通りである。</div>
</div>
<ul>
<li><p class="first"><strong>メリット</strong></p>
<ul>
<li><div class="first line-block">
<div class="line">サーバ側でデータを保持しないため、複数ブラウザや複数タブを使用しても、互いの操作が干渉することはない。そのため、同一処理の画面を複数立ち上げることもできるので、ユーザビリティが損なわれることはない。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">サーバ側でデータを保持しないため、持続的に使用するメモリの使用量を、抑えることができる。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">APサーバのスケーラビリティを低下させる要因が少なくなる。</div>
</div>
</li>
</ul>
</li>
<li><p class="first"><strong>デメリット</strong></p>
<ul>
<li><div class="first line-block">
<div class="line">サーバの処理で必要となるデータを、リクエストパラメータとして送信する必要があるため、画面表示に表示していない項目についても、hidden項目に指定する必要がある。</div>
<div class="line">そのため、JSPの実装コードが増える。</div>
<div class="line">これは、JSPタグライブラリを作成することで、最小限に抑えることが可能である。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">サーバの処理で必要となるデータを、すべてのリクエストで送信する必要があるため、ネットワーク上に流れるデータ量が増える。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">画面表示に必要なデータを、その都度取得する必要があるため、データの取得処理の実行回数が増える。</div>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="id12">
<h3><a class="toc-backref" href="#id41">4.3.1.3. セッションに格納するデータについて</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<p>セッションに格納するデータは、以下の点を考慮する必要がある。</p>
<ul class="simple">
<li>シリアライズすることができるオブジェクト(<code class="docutils literal"><span class="pre">java.io.Serializable</span></code>を実装しているオブジェクト)であること。</li>
<li>メモリ枯渇の原因となるような容量の大きいオブジェクトでないこと。</li>
</ul>
<div class="section" id="id13">
<h4><a class="toc-backref" href="#id42">4.3.1.3.1. シリアライズ可能なオブジェクト</a><a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">セッションに格納するデータは、特定の条件下において、ディスク、またはネットワークへの入出力が行われる可能性がある。</div>
<div class="line">そのため、シリアライズすることができるオブジェクトである必要がある。</div>
</div>
<p>ディスクへの入出力が発生するケースは、以下の通りである。</p>
<ul>
<li><div class="first line-block">
<div class="line">アクティブなセッションが存在する状態で、アプリケーションサーバが停止された場合、セッションおよびセッションに格納されていたデータは、ディスクに退避される。</div>
<div class="line">退避されたセッション、および格納されていたデータは、アプリケーションサーバ起動時に復元される。</div>
<div class="line">データの復元に関するこの動作は、アプリケーションサーバによってサポート状況が異なる。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">セッションの格納領域が溢れそうになった場合や、最終アクセスから一定時間アクセスがない場合、セッションのスワップアウトが発生する可能性がある。</div>
<div class="line">スワップアウトされたセッションは、アクセスが発生した際にスワップインされる。</div>
<div class="line">スワップアウトの発生条件などは、アプリケーションサーバによって異なる。</div>
</div>
</li>
</ul>
<p>ネットワークへの入出力が発生するケースは、以下の通りである。</p>
<ul>
<li><div class="first line-block">
<div class="line">セッションを、別のアプリケーションサーバにレプリケーションする場合、セッションに格納したデータが、ネットワークを経由して、別のアプリケーションサーバに送信される。</div>
</div>
</li>
</ul>
</div>
<div class="section" id="id14">
<h4><a class="toc-backref" href="#id43">4.3.1.3.2. セッションに格納するデータの容量</a><a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h4>
<p><strong>セッションに格納するデータは、できる限りコンパクトにすることを推奨する。</strong></p>
<p>セッションに格納されているデータの容量が大きい場合は、致命的なパフォーマンス低下を引き起こす原因となるので、容量の大きいデータは、セッションに格納しないように設計することを推奨する。</p>
<p>パフォーマンス低下を引き起こす主な原因は、以下の通り。</p>
<ul>
<li><div class="first line-block">
<div class="line">セッションに容量の大きいデータを格納する場合、メモリ枯渇が発生しないようにするために、アプリケーションサーバの設定をスワップアウトが発生しやすい設定にしておく必要がある。</div>
<div class="line">スワップアウト処理は、「重い」処理であるため、スワップアウトが頻繁に発生すると、アプリケーション全体のパフォーマンスに影響を与える可能性がある。</div>
<div class="line">スワップアウトに関する動作や設定方法は、アプリケーションサーバによってサポート状況が異なる。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">セッションをレプリケーションする場合、オブジェクトのシリアライズとデシリアライズが行われる。</div>
<div class="line">容量の大きいオブジェクトのシリアライズとデシリアライズ処理は、「重い」処理であるため、レスポンスタイムなどのパフォーマンスに影響を与える可能性がある。</div>
</div>
</li>
</ul>
<p>セッションに格納するデータをコンパクトにするために、以下の条件にあてはまるデータについては、セッションスコープではなく、リクエストスコープに格納することを検討すること。</p>
<ul>
<li><div class="first line-block">
<div class="line">画面操作で編集することができない読み取り専用のデータ。</div>
<div class="line">データが必要になったタイミングで最新のデータを取得し、取得したデータをリクエストスコープへ格納した上でView(JSP)へ表示するようにすれば、セッションへ格納する必要はない。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">画面操作で編集できるが、生存期間がユースケース内の画面操作に閉じているデータ。</div>
<div class="line">HTMLフォームのhidden項目として、全ての画面遷移でデータを引き回せば、セッションに格納する必要はない。</div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="ap">
<h3><a class="toc-backref" href="#id44">4.3.1.4. APサーバ多重化時の考慮点について</a><a class="headerlink" href="#ap" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">通常のシステム構成では、アプリケーションサーバが1台で構成されることはほとんどなく、可用性要件、性能要件などを考慮して、複数台で構成することになる。</div>
<div class="line">そのため、セッションにデータを格納する場合は、システム要件にあわせて以下の何れかの仕組みを適用する必要がある。</div>
</div>
<ol class="arabic">
<li><div class="first line-block">
<div class="line">高い可用性(サービスレベル)が求められるシステムの場合は、APサーバダウン時に別のAPサーバで処理が継続できるようにする必要がある。</div>
<div class="line">APサーバダウン時に別のAPサーバで処理を継続するためには、全てのAPサーバでセッション情報を共有しておく必要があるので、アプリケーションサーバをクラスタ構成としてセッションをレプリケーションする必要がある。</div>
<div class="line">セッション情報を共有する別の方法としては、セッションの保存先をOracle Coherenceのようなキャッシュサーバやデータベースにすることで実現することも可能である。</div>
<div class="line">APサーバの台数、セッションに格納されるデータの容量、同時に貼らせるセッション数が大量になる場合は、セッションの保存先をOracle Coherenceのようなキャッシュサーバやデータベースにすることを検討した方がよい。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">高い可用性(サービスレベル)が求められないシステムの場合は、APサーバダウン時に別のAPサーバで処理を継続できるようにする必要はない。</div>
<div class="line">そのため、全てのAPサーバでセッション情報を共有する必要はないので、ロードバランサの機能を使って同一セッション内で発生するリクエストを全て同じAPサーバに振り分けるようにすればよい。</div>
</div>
</li>
</ol>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>本ガイドラインで推奨している方法でWebアプリケーションを作成した場合、以下のデータがセッションに格納されるため、何れかの仕組みを適用する必要がある。</p>
<ul class="last simple">
<li>Spring Securityの認証処理で認証されたユーザ情報。</li>
<li>Spring SecurityのCSRFトークンチェックで払い出されたトークン値。</li>
<li>共通ライブラリから提供しているトランザクショントークンチェックで払い出されたトークン値。</li>
</ul>
</div>
</div>
<div class="section" id="id15">
<h3><a class="toc-backref" href="#id45">4.3.1.5. セッションの保存先について</a><a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">セッションの保存先は、APサーバのメモリだけではなく、Key-Value StoreやOracle Coherenceのようなインメモリデータグリッドにすることも可能である。</div>
<div class="line">スケーラビリティが求められる場合は検討の余地がある。</div>
<div class="line">セッションの保存先を変更する際の実装方法については、APサーバーや保存先によって異なるため、本ガイドラインでは説明は割愛する。</div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="how-to-use">
<h2><a class="toc-backref" href="#id46">4.3.2. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<p>本ガイドラインでは、セッションにデータを格納する場合は、以下のいずれかの方法を使用して行うことを推奨している。</p>
<ol class="arabic simple">
<li><a class="reference internal" href="#session-management-how-to-use-sessionattributes"><span class="std std-ref">&#64;SessionAttributesアノテーションの使用</span></a></li>
<li><a class="reference internal" href="#session-management-how-to-use-sessionscope"><span class="std std-ref">Spring FrameworkのsessionスコープのBeanの使用</span></a></li>
</ol>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Controllerのハンドラメソッドの引数に <code class="docutils literal"><span class="pre">HttpSession</span></code> オブジェクトを指定することで、 <code class="docutils literal"><span class="pre">HttpSession</span></code> のAPIを直接呼び出すことができるが、
<strong>原則としてはHttpSessionのAPIを直接使用しないことを強く推奨する。</strong></p>
<p class="last"><code class="docutils literal"><span class="pre">HttpSession</span></code> を直接使わないと実現できない処理については、 <code class="docutils literal"><span class="pre">HttpSession</span></code> のAPIを直接使用してもよいが、
多くの業務処理において、HttpSessionのAPIを直接使用する必要はないため、原則Controllerのハンドラメソッドの引数として、 <code class="docutils literal"><span class="pre">HttpSession</span></code> オブジェクトを指定しないようにすること。</p>
</div>
<div class="section" id="sessionattributes">
<span id="session-management-how-to-use-sessionattributes"></span><h3><a class="toc-backref" href="#id47">4.3.2.1. <code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>アノテーションの使用</a><a class="headerlink" href="#sessionattributes" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>アノテーションは、Controller内で行われる画面遷移において、データを持ち回る場合に使用する。</p>
<div class="line-block">
<div class="line">ただし、入力画面、確認画面、完了画面がそれぞれ１ページで構成されるような場合は、セッションを使わずにHTMLフォームのhiddenを使ってデータを持ち回った方がよい。</div>
<div class="line">入力画面が複数のページで構成されるような場合や、複雑な画面遷移を伴う場合は、 <code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>アノテーションを使用してフォームオブジェクトをセッションに格納する方法を採用すべきか検討すること。</div>
<div class="line">フォームオブジェクトをセッションに格納することで、アプリケーションの設計及び実装がシンプルになる可能性がある。</div>
</div>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/session-management_overview_sessionattributes.png"><img alt="" src="../../_images/session-management_overview_sessionattributes.png" style="width: 80%;" /></a>
</div>
</div></blockquote>
<div class="section" id="id16">
<h4><a class="toc-backref" href="#id48">4.3.2.1.1. セッションに格納するオブジェクトの指定</a><a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>アノテーションをクラスに指定し、セッションに格納するオブジェクトを指定する。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;wizard&quot;</span><span class="p">)</span>
<span class="nd">@SessionAttributes</span><span class="p">(</span><span class="n">types</span> <span class="o">=</span> <span class="p">{</span> <span class="n">WizardForm</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">Entity</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WizardController</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>アノテーションのtypes属性に、セッションに格納するオブジェクトの型を指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;ModelAttribute</span></code>アノテーション、または<code class="docutils literal"><span class="pre">Model</span></code>のaddAttributeメソッドを使用して、<code class="docutils literal"><span class="pre">Model</span></code>オブジェクトに追加されたオブジェクトのうち、types属性で指定した型に一致するオブジェクトが、セッションに格納される。</div>
<div class="line">上記例では、 <code class="docutils literal"><span class="pre">WizardForm</span></code>クラスと <code class="docutils literal"><span class="pre">Entity</span></code>クラスのオブジェクトが、セッションに格納される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>ライフサイクルの管理単位</strong></p>
<p><code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>アノテーションを使って、セッションに格納したオブジェクトは、Controller単位で、ライフサイクルが管理される。</p>
<p class="last"><code class="docutils literal"><span class="pre">SessionStatus</span></code>オブジェクトのsetCompleteメソッドを呼び出すと、<code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>アノテーションで指定したオブジェクトが、すべてセッションから削除される。
そのため、ライフサイクルが異なるオブジェクトを、セッションに格納する場合は、Controllerを分割する必要がある。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>&#64;SessionAttributesアノテーション使用時の注意点</strong></p>
<p>Controller単位で、ライフサイクルが管理されると上で説明したが、複数のControllerで同じ属性名のオブジェクトを、<code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>アノテーションを使って、セッションに格納した場合は、
Controllerをまたいで、ライフサイクルが管理される。</p>
<p class="last">別ウィンドウやタブを開いて、同時に画面操作できる処理の場合は、同じオブジェクトに対してアクセスすることになるため、不具合を引き起こす原因になりうる。
そのため、複数のControllerで、同じフォームオブジェクトのクラスを使用する場合は、<code class="docutils literal"><span class="pre">&#64;ModelAttribute</span></code>アノテーションのvalue属性に、それぞれ別の値(属性名)を指定した上で、 <code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code> アノテーションの value属性に <code class="docutils literal"><span class="pre">&#64;ModelAttribute</span></code>アノテーションのvalue属性に指定した値と同じ値を指定すること。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">セッションに格納するオブジェクトの指定は、属性名で指定することも出来る。</div>
<div class="line">以下に、指定方法を示す。</div>
</div>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;wizard&quot;</span><span class="p">)</span>
<span class="nd">@SessionAttributes</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;wizardCreateForm&quot;</span> <span class="p">})</span> <span class="c1">// (2)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WizardController</span> <span class="p">{</span>

    <span class="c1">// ...</span>

    <span class="nd">@ModelAttribute</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;wizardCreateForm&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">WizardForm</span> <span class="nf">setUpWizardForm</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">WizardForm</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>アノテーションのvalue属性に、セッションに格納するオブジェクトの属性名を指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;ModelAttribute</span></code>アノテーション、または<code class="docutils literal"><span class="pre">Model</span></code>のaddAttributeメソッドを使用して、<code class="docutils literal"><span class="pre">Model</span></code>オブジェクトに追加されたオブジェクトのうち、value属性で指定した属性名に一致するオブジェクトが、セッションに格納される。</div>
<div class="line">上記例では、属性名が<code class="docutils literal"><span class="pre">wizardCreateForm</span></code>のオブジェクトが、セッションに格納される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id17">
<h4><a class="toc-backref" href="#id49">4.3.2.1.2. セッションにオブジェクトを追加</a><a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h4>
<p>セッションにオブジェクトを追加する場合、以下2つの方法を使用する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">&#64;ModelAttribute</span></code>アノテーションが付与されたメソッドにて、セッションに追加するオブジェクトを返却する。</li>
<li><code class="docutils literal"><span class="pre">Model</span></code>オブジェクトのaddAttributeメソッドを使用して、セッションに格納するオブジェクトを追加する。</li>
</ul>
<p><code class="docutils literal"><span class="pre">Model</span></code>オブジェクトに追加されたオブジェクトは、<code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>アノテーションのtypesと、value属性の属性値にしたがって、
セッションに格納されるため、Controllerのハンドラメソッドで、セッションを意識した実装を行う必要はない。</p>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;ModelAttribute</span></code>アノテーションが付与されたメソッドを使用して、セッションに格納するオブジェクトを返却する方法について、説明する。</div>
<div class="line">フォームオブジェクトをセッションに格納する場合は、この方法を使用して、オブジェクトを生成することを推奨する。</div>
</div>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@ModelAttribute</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;wizardForm&quot;</span><span class="p">)</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="n">WizardForm</span> <span class="nf">setUpWizardForm</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">WizardForm</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Model</span></code>オブジェクトに格納する属性名を、value属性に指定する。</div>
<div class="line">上記例では、返却したオブジェクトが、<code class="docutils literal"><span class="pre">wizardForm</span></code>という属性名でセッションに格納される。</div>
<div class="line">value属性を指定した場合、セッションにオブジェクトを格納した後のリクエストで、<code class="docutils literal"><span class="pre">&#64;ModelAttribute</span></code>アノテーションの付与されたメソッドが呼び出されなくなるため、無駄なオブジェクトの生成が行われないというメリットがある。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>&#64;ModelAttributeアノテーションのvalue属性を省略した場合の動作について</strong></p>
<p>value属性を省略した場合、デフォルトの属性名を生成するために、すべてのリクエストで、<code class="docutils literal"><span class="pre">&#64;ModelAttribute</span></code>アノテーションの付与されたメソッドが呼ばれる。
そのため、無駄なオブジェクトが生成されるというデメリットがあるので、 <strong>セッションに格納する場合は、この方法は原則使用しないこと。</strong></p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@ModelAttribute</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="n">WizardForm</span> <span class="nf">setUpWizardForm</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">WizardForm</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;ModelAttribute</span></code>アノテーションが付与されたメソッドにて、セッションに追加するオブジェクトを生成し、返却する。</div>
<div class="line">上記例では、<code class="docutils literal"><span class="pre">wizardForm</span></code>という属性名で返却したオブジェクトが、セッションに格納される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">Model</span></code>オブジェクトのaddAttributeメソッドを使用し、セッションにオブジェクトを追加する方法について、説明する。</div>
<div class="line">Domainオブジェクトをセッションに格納する場合は、この方法を使用して、オブジェクトを追加することになる。</div>
</div>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;update/{id}&quot;</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form1&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">updateForm1</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">)</span> <span class="n">Integer</span> <span class="n">id</span><span class="p">,</span> <span class="n">WizardForm</span> <span class="n">form</span><span class="p">,</span>
        <span class="n">Model</span> <span class="n">model</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Entity</span> <span class="n">loadedEntity</span> <span class="o">=</span> <span class="n">entityService</span><span class="p">.</span><span class="na">getEntity</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
    <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="n">loadedEntity</span><span class="p">);</span> <span class="c1">// (3)</span>
    <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">loadedEntity</span><span class="p">,</span> <span class="n">form</span><span class="p">);</span>
    <span class="k">return</span> <span class="s">&quot;wizard/form1&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Model</span></code>オブジェクトのaddAttributeメソッドを使用して、セッションに格納するオブジェクトを追加する。</div>
<div class="line">上記例では、<code class="docutils literal"><span class="pre">entity</span></code>という属性名で、ドメイン層から取得したオブジェクトを、セッションに格納している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id18">
<h4><a class="toc-backref" href="#id50">4.3.2.1.3. セッションに格納されているオブジェクトの取得</a><a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">セッションに格納されているオブジェクトは、Controllerのハンドラメソッドの引数として、受け取ることができる。</div>
<div class="line">セッションに格納されているオブジェクトは、<code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>アノテーションの属性値にしたがって、<code class="docutils literal"><span class="pre">Model</span></code>オブジェクトに格納されるため、Controllerのハンドラメソッドでは、セッションを意識した実装を行う必要はない。</div>
</div>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;save&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">save</span><span class="p">(</span><span class="nd">@Validated</span><span class="p">({</span> <span class="n">Wizard1</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">Wizard2</span><span class="p">.</span><span class="na">class</span><span class="p">,</span>
        <span class="n">Wizard3</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span> <span class="n">WizardForm</span> <span class="n">form</span><span class="p">,</span>   <span class="c1">// (1)</span>
        <span class="n">BindingResult</span> <span class="n">result</span><span class="p">,</span>
        <span class="n">Entity</span> <span class="n">entity</span><span class="p">,</span>                      <span class="c1">// (2)</span>
        <span class="n">RedirectAttributes</span> <span class="n">redirectAttributes</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">return</span> <span class="s">&quot;redirect:/wizard/save?complete&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Model</span></code>オブジェクトに格納されているオブジェクトを取得する。</div>
<div class="line">上記例では、<code class="docutils literal"><span class="pre">wizardForm</span></code>という属性名でセッションスコープに格納されているオブジェクトが、引数formに渡される。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;Validated</span></code> アノテーションで指定している <code class="docutils literal"><span class="pre">Wizard1.class</span></code> , <code class="docutils literal"><span class="pre">Wizard2.class</span></code> , <code class="docutils literal"><span class="pre">Wizard3.class</span></code> については、 Appendixの <a class="reference internal" href="#session-management-appendix-sessionattribute"><span class="std std-ref">&#64;SessionAttributesアノテーションを使ったウィザード形式の画面遷移の実装例</span></a> を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">上記例では、<code class="docutils literal"><span class="pre">entity</span></code>という属性名でセッションスコープに格納されているオブジェクトが、引数entityに渡される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>セッションスコープに格納しているオブジェクトを受け取る際にリクエストパラメータのバインドを防止する方法</strong></p>
<p>セッションスコープに格納しているオブジェクトをハンドラメソッドの引数として受け取る際、その引数にリクエストパラメータがバインドされる可能性がある。</p>
<p>リクエストパラメータがバインドされない様にするためには、セッションスコープに格納しているオブジェクトをハンドラメソッドの引数から受け取らず、ハンドラメソッド内で<code class="docutils literal"><span class="pre">Model</span></code>オブジェクトから取得する方法があるが、
取得するオブジェクトの属性名を文字列で指定する必要があるためタイプセーフではない。</p>
<p>これに対し、Spring Framework 4.3では<code class="docutils literal"><span class="pre">&#64;ModelAttribute</span></code>アノテーションに<code class="docutils literal"><span class="pre">binding</span></code>属性が追加され、引数にリクエストパラメータをバインドするか否かを指定できる様になった。
引数に<code class="docutils literal"><span class="pre">&#64;ModelAttribute</span></code>アノテーションを付与し、<code class="docutils literal"><span class="pre">binding</span></code>属性に<code class="docutils literal"><span class="pre">false</span></code>を指定することで、
リクエストパラメータのバインドを防止しつつ、タイプセーフにセッションスコープに格納しているオブジェクトを取得することができる。</p>
<p>下記の例は、<code class="docutils literal"><span class="pre">entity</span></code>という属性名でセッションスコープに格納しているオブジェクトをリクエストパラメータのバインドを防止して取得している。</p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;save&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">save</span><span class="p">(</span><span class="nd">@Validated</span><span class="p">({</span> <span class="n">Wizard1</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">Wizard2</span><span class="p">.</span><span class="na">class</span><span class="p">,</span>
        <span class="n">Wizard3</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span> <span class="n">WizardForm</span> <span class="n">form</span><span class="p">,</span>
        <span class="n">BindingResult</span> <span class="n">result</span><span class="p">,</span>
        <span class="nd">@ModelAttribute</span><span class="p">(</span><span class="n">binding</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="n">Entity</span> <span class="n">entity</span><span class="p">,</span>
        <span class="n">RedirectAttributes</span> <span class="n">redirectAttributes</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">return</span> <span class="s">&quot;redirect:/wizard/save?complete&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div></blockquote>
<p>Controllerのハンドラメソッドの引数に渡すオブジェクトが、<code class="docutils literal"><span class="pre">Model</span></code>オブジェクトに存在しない場合、<code class="docutils literal"><span class="pre">&#64;ModelAttribute</span></code>アノテーションの指定の有無で、動作が変わる。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">&#64;ModelAttribute</span></code>アノテーションを指定していない場合は、新しいオブジェクトが生成されて引数に渡される。
生成されたオブジェクトは <code class="docutils literal"><span class="pre">Model</span></code> オブジェクトに格納されるため、セッションにも格納される。</li>
</ul>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>リダイレクト時の動作について</strong></p>
<p class="last">遷移先をリダイレクトにした場合は、生成されたオブジェクトは、セッションに格納されない。
そのため、生成されたオブジェクトを、リダイレクト先の処理で参照したい場合は、<code class="docutils literal"><span class="pre">RedirectAttributes</span></code>のaddFlashAttributeメソッドを使用して、Flashスコープにオブジェクトを格納する必要がある。</p>
</div>
</div></blockquote>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">&#64;ModelAttribute</span></code> アノテーションを指定している場合は、<code class="docutils literal"><span class="pre">org.springframework.web.HttpSessionRequiredException</span></code>が発生する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;save&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">save</span><span class="p">(</span><span class="nd">@Validated</span><span class="p">({</span> <span class="n">Wizard1</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">Wizard2</span><span class="p">.</span><span class="na">class</span><span class="p">,</span>
        <span class="n">Wizard3</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span> <span class="n">WizardForm</span> <span class="n">form</span><span class="p">,</span> <span class="c1">// (3)</span>
        <span class="n">BindingResult</span> <span class="n">result</span><span class="p">,</span>
        <span class="nd">@ModelAttribute</span> <span class="n">Entity</span> <span class="n">entity</span><span class="p">,</span> <span class="c1">// (4)</span>
        <span class="n">RedirectAttributes</span> <span class="n">redirectAttributes</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">return</span> <span class="s">&quot;redirect:/wizard/save?complete&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;Validated</span></code>アノテーションで、特定の検証グループ(<code class="docutils literal"><span class="pre">Wizard1.class</span></code>, <code class="docutils literal"><span class="pre">Wizard2.class</span></code>, <code class="docutils literal"><span class="pre">Wizard3.class</span></code>)を設定して入力チェックを行っている。</div>
<div class="line">入力チェックの詳細については、<a class="reference internal" href="Validation.html"><span class="doc">入力チェック</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数に、<code class="docutils literal"><span class="pre">&#64;ModelAttribute</span></code>アノテーションを指定している場合、セッションに対象のオブジェクトが存在しない時に呼び出されると、<code class="docutils literal"><span class="pre">HttpSessionRequiredException</span></code>が発生する。</div>
<div class="line"><code class="docutils literal"><span class="pre">HttpSessionRequiredException</span></code>は、ブラウザバックや、URL直接指定のアクセスなどの、クライアントの操作に起因して発生する例外になるため、クライアントエラーとして、例外ハンドリングを行う必要がある。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><code class="docutils literal"><span class="pre">HttpSessionRequiredException</span></code>をクライアントエラーとするための設定は、以下の通りである。</p>
<ul class="simple">
<li>spring-mvc.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.SystemExceptionResolver&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionCodeResolver&quot;</span> <span class="na">ref=</span><span class="s">&quot;exceptionCodeResolver&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionMappings&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;map&gt;</span>
            <span class="c">&lt;!-- ... --&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;HttpSessionRequiredException &quot;</span>
                   <span class="na">value=</span><span class="s">&quot;common/error/operationError&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (5) --&gt;</span>
        <span class="nt">&lt;/map&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;statusCodes&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;map&gt;</span>
            <span class="c">&lt;!-- ... --&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;common/error/operationError&quot;</span> <span class="na">value=</span><span class="s">&quot;400&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (6) --&gt;</span>
        <span class="nt">&lt;/map&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">共通ライブラリから提供している<code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>の<code class="docutils literal"><span class="pre">exceptionMappings</span></code>に、<code class="docutils literal"><span class="pre">HttpSessionRequiredException</span></code>の例外ハンドリングの定義を追加する。</div>
<div class="line">上記例では、  例外発生時の遷移先のView名として、<code class="docutils literal"><span class="pre">common/error/operationError</span></code>を指定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>の<code class="docutils literal"><span class="pre">statusCodes</span></code>に、<code class="docutils literal"><span class="pre">HttpSessionRequiredException</span></code>発生時の、HTTPレスポンスコードを指定する。</div>
<div class="line">上記例では、  例外発生時のHTTPレスポンスコードとして、 Bad Request(<code class="docutils literal"><span class="pre">400</span></code>)を指定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>applicationContext.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;exceptionCodeResolver&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.common.exception.SimpleMappingExceptionCodeResolver&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- Setting and Customization by project. --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionMappings&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;map&gt;</span>
            <span class="c">&lt;!-- ... --&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;HttpSessionRequiredException&quot;</span> <span class="na">value=</span><span class="s">&quot;w.xx.0003&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (7) --&gt;</span>
        <span class="nt">&lt;/map&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultExceptionCode&quot;</span> <span class="na">value=</span><span class="s">&quot;e.xx.0001&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (8) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">共通ライブラリから提供している<code class="docutils literal"><span class="pre">SimpleMappingExceptionCodeResolver</span></code>の<code class="docutils literal"><span class="pre">exceptionMappings</span></code>に、<code class="docutils literal"><span class="pre">HttpSessionRequiredException</span></code>の例外ハンドリングの定義を追加する。</div>
<div class="line">上記例では、  例外発生時の例外コードとして、<code class="docutils literal"><span class="pre">w.xx.0003</span></code>を指定している。</div>
<div class="line">この設定を追加しない場合は、デフォルトの例外コードが、ログに出力される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例外発生時のデフォルトの例外コード。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id19">
<h4><a class="toc-backref" href="#id51">4.3.2.1.4. セッションに格納したオブジェクトの削除</a><a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>を用いてセッションに格納したオブジェクトを削除する場合、 <code class="docutils literal"><span class="pre">org.springframework.web.bind.support.SessionStatus</span></code>のsetCompleteメソッドを、Controllerのハンドラメソッドから呼び出す。</div>
<div class="line"><code class="docutils literal"><span class="pre">SessionStatus</span></code>オブジェクトのsetCompleteメソッドを呼び出すと、 <code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>アノテーションの属性値に指定されているオブジェクトが、セッションから削除される。</div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>セッションから削除されるタイミングについて</strong></p>
<p><code class="docutils literal"><span class="pre">SessionStatus</span></code>オブジェクトのsetCompleteメソッドを呼び出すことで、<code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>アノテーションの属性値に指定されているオブジェクトが、セッションから削除される。
ただし、実際に削除されるタイミングは、setCompleteメソッドを呼び出したタイミングではない。</p>
<p class="last"><code class="docutils literal"><span class="pre">SessionStatus</span></code>オブジェクトのsetCompleteメソッド自体は、内部のフラグを変更しているだけなので、実際の削除は、Controllerのハンドラメソッドの処理が終了した後に、フレームワークによって行われる。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>View(JSP)からのオブジェクトの参照について</strong></p>
<p class="last"><code class="docutils literal"><span class="pre">SessionStatus</span></code>オブジェクトのsetCompleteメソッドを呼び出すことで、セッションから削除されるが、同じオブジェクトが、<code class="docutils literal"><span class="pre">Model</span></code>オブジェクトに残っているため、View(JSP)から参照することができる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>セッションに格納したオブジェクトの削除は、以下3カ所で行う必要がある。</p>
<ul>
<li><div class="first line-block">
<div class="line">完了画面を表示するためのリクエスト。<strong>(必須)</strong></div>
<div class="line">完了画面を表示した後に、セッションに格納したオブジェクトにアクセスすることはないため、不要になったオブジェクトを削除する。</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>削除が必要な理由</strong></p>
<p class="last">セッションに格納されているオブジェクトは、ガベージコレクションの対象とならないため、不要になったオブジェクトを削除しないと、メモリ枯渇の原因になりうる。
また、不要なオブジェクトがセッションに格納されていると、セッションのスワップアウトが発生した際の処理が重くなり、アプリケーション全体の性能に影響を与える可能性がある。</p>
</div>
</div></blockquote>
<ul>
<li><div class="first line-block">
<div class="line">一連の画面操作を中止するためのリクエスト。<strong>(必須)</strong></div>
<div class="line">「メニューへ戻る」や「中止」などの、一連の画面操作を中止するためのイベントについても、セッションに格納したオブジェクトにアクセスすることはないため、不要になったオブジェクトを削除すること。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">入力画面を初期表示するためのリクエスト。(任意)</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>削除が必要な理由</strong></p>
<p class="last">画面操作の途中でブラウザやタブを閉じた場合、セッションに格納されているフォームオブジェクトに入力途中の情報が残るため、初期表示時に削除しないと、入力途中の情報が画面に表示されてしまう。
ただし、入力途中の情報が画面に表示されてもよい場合は、初期表示するためのリクエストで削除は必須ではない。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>完了画面を表示するためのリクエストで削除する際の実装例は、以下の通りである。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;save&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">save</span><span class="p">(</span><span class="nd">@ModelAttribute</span> <span class="nd">@Validated</span><span class="p">({</span> <span class="n">Wizard1</span><span class="p">.</span><span class="na">class</span><span class="p">,</span>
        <span class="n">Wizard2</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">Wizard3</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span> <span class="n">WizardForm</span> <span class="n">form</span><span class="p">,</span>
        <span class="n">BindingResult</span> <span class="n">result</span><span class="p">,</span> <span class="n">Entity</span> <span class="n">entity</span><span class="p">,</span>
        <span class="n">RedirectAttributes</span> <span class="n">redirectAttributes</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">return</span> <span class="s">&quot;redirect:/wizard/save?complete&quot;</span><span class="p">;</span> <span class="c1">// (2)</span>
<span class="p">}</span>

<span class="c1">// (3)</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;save&quot;</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;complete&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">saveComplete</span><span class="p">(</span><span class="n">SessionStatus</span> <span class="n">sessionStatus</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sessionStatus</span><span class="p">.</span><span class="na">setComplete</span><span class="p">();</span> <span class="c1">// (4)</span>
    <span class="k">return</span> <span class="s">&quot;wizard/complete&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">更新処理を行うためのハンドラメソッド。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">完了画面を表示するためのリクエスト(3)へ、リダイレクトする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">完了画面を表示するためのハンドラメソッド。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">SessionStatus</span></code>オブジェクトのsetCompleteメソッドを呼び出し、オブジェクトをセッションから削除する。</div>
<div class="line"><code class="docutils literal"><span class="pre">Model</span></code>オブジェクトに同じオブジェクトが残っているため、直接、View(JSP)の表示処理に影響は与えない。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>一連の画面操作を中止するためのリクエストで削除する際の実装例は、以下の通りである。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;save&quot;</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;cancel&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">saveCancel</span><span class="p">(</span><span class="n">SessionStatus</span> <span class="n">sessionStatus</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sessionStatus</span><span class="p">.</span><span class="na">setComplete</span><span class="p">();</span> <span class="c1">// (2)</span>
    <span class="k">return</span> <span class="s">&quot;redirect:/wizard/menu&quot;</span><span class="p">;</span> <span class="c1">// (3)</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">一連の画面操作を中止するためのハンドラメソッド。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">SessionStatus</span></code>オブジェクトのsetCompleteメソッドを呼び出し、オブジェクトをセッションから削除する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">上記例では、メニュー画面へ、リダイレクトしている。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>入力画面を、初期表示するためのリクエストで削除する際の実装例は、以下の通りである。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">initializeCreateWizardForm</span><span class="p">(</span><span class="n">SessionStatus</span> <span class="n">sessionStatus</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sessionStatus</span><span class="p">.</span><span class="na">setComplete</span><span class="p">();</span>              <span class="c1">// (2)</span>
    <span class="k">return</span> <span class="s">&quot;redirect:/wizard/create?form1&quot;</span><span class="p">;</span>   <span class="c1">// (3)</span>
<span class="p">}</span>

<span class="c1">// (4)</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form1&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">createForm1</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">&quot;wizard/form1&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力画面を初期表示するためのハンドラメソッド。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">SessionStatus</span></code>オブジェクトのsetCompleteメソッドを呼び出す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力画面を表示するためのリクエスト(4)へ、リダイレクトする。</div>
<div class="line"><code class="docutils literal"><span class="pre">SessionStatus</span></code>オブジェクトのsetCompleteメソッドを呼び出すことで、</div>
<div class="line">セッションからは削除されるが、<code class="docutils literal"><span class="pre">Model</span></code>オブジェクトに同じオブジェクトが残っているため、</div>
<div class="line">直接View(JSP)を呼び出してしまうと、入力途中の情報が表示されてしまう。</div>
<div class="line">そのため、<strong>セッションから削除したうえで、入力画面を表示するためのリクエストへ、リダイレクトする必要がある。</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力画面を表示するためのハンドラメソッド。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id20">
<h4><a class="toc-backref" href="#id52">4.3.2.1.5. &#64;SessionAttributesを使った処理の実装例</a><a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h4>
<p>より具体的な実装例については、Appendixの<a class="reference internal" href="#session-management-appendix-sessionattribute"><span class="std std-ref">&#64;SessionAttributesアノテーションを使ったウィザード形式の画面遷移の実装例</span></a>を参照されたい。</p>
</div>
</div>
<div class="section" id="spring-frameworksessionbean">
<span id="session-management-how-to-use-sessionscope"></span><h3><a class="toc-backref" href="#id53">4.3.2.2. Spring FrameworkのsessionスコープのBeanの使用</a><a class="headerlink" href="#spring-frameworksessionbean" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Spring FrameworkのsessionスコープのBeanは、</div>
<div class="line">複数のControllerをまたいだ画面遷移において、データを持ち回る場合に使用する。</div>
</div>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/session-management_overview_sessionscope.png"><img alt="" src="../../_images/session-management_overview_sessionscope.png" style="width: 90%;" /></a>
</div>
</div></blockquote>
<div class="section" id="sessionbean">
<h4><a class="toc-backref" href="#id54">4.3.2.2.1. sessionスコープのBean定義</a><a class="headerlink" href="#sessionbean" title="Permalink to this headline">¶</a></h4>
<p>Spring FrameworkのsessionスコープのBeanを、定義する。</p>
<p>sessionスコープのBeanを定義する方法は、以下2種類の方法がある。</p>
<ul class="simple">
<li>component-scanを使用してbeanを定義する。</li>
<li>Bean定義ファイル(XML)にbeanを定義する。</li>
</ul>
<p>component-scanを使用する方法を、以下に示す。</p>
<ul class="simple">
<li>クラス</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Component</span>
<span class="nd">@Scope</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;session&quot;</span><span class="p">,</span> <span class="n">proxyMode</span> <span class="o">=</span> <span class="n">ScopedProxyMode</span><span class="p">.</span><span class="na">TARGET_CLASS</span><span class="p">)</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SessionCart</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">Cart</span> <span class="n">cart</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">Cart</span> <span class="nf">getCart</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cart</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cart</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cart</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">cart</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCart</span><span class="p">(</span><span class="n">Cart</span> <span class="n">cart</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">cart</span> <span class="o">=</span> <span class="n">cart</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">clearCart</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// (2)</span>
        <span class="n">cart</span><span class="p">.</span><span class="na">clearCart</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Beanのスコープを<code class="docutils literal"><span class="pre">session</span></code>にする。また、proxyMode 属性で <code class="docutils literal"><span class="pre">ScopedProxyMode.TARGET_CLASS</span></code>を指定し、scoped-proxyを有効にする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">注文が完了した際にカートの状態をクリア(カート内の商品を削除)するためのメソッドを用意する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>JPAで扱うEntityクラスをsessionスコープのBeanとして定義したい場合は、直接sessionスコープのBeanとして定義するのではなく、ラッパークラスを用意することを推奨する。</p>
<p>JPAで扱うEntityクラスをsessionスコープのBeanとして定義すると、JPAのAPIでsessionスコープのBeanを直接扱うことができない(直接あつかうと、エラーとなる)。
そのため、JPAで扱うことができるEntityオブジェクトへの変換処理が、必要になってしまう。</p>
<p class="last">上記例では、<code class="docutils literal"><span class="pre">Cart</span></code>というJPAのEntityクラスを、<code class="docutils literal"><span class="pre">SessionCart</span></code>というラッパークラスに包んで、sessionスコープのBeanとしている。
こうすることで、JPAで扱うことができるEntityオブジェクトへの変換処理が不要となるため、Controllerで行う処理がシンプルになる。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>scoped-proxyを有効化する理由について</strong></p>
<p class="last">sessionスコープのBeanをsingletonスコープのControllerにInjectするために、scoped-proxyを有効化する必要がある。</p>
</div>
</div></blockquote>
<ul class="simple">
<li>spring-mvc.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">&quot;xxx.yyy.zzz.app&quot;</span> <span class="nt">/&gt;</span> // (2)
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;context:component-scan&gt;</span></code> 要素でベースとなるパッケージを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Bean定義ファイル(XML)に定義する方法を、以下に示す。</p>
<ul class="simple">
<li>JavaBean</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;beans:bean</span> <span class="na">id=</span><span class="s">&quot;sessionCart&quot;</span> <span class="na">class=</span><span class="s">&quot;xxx.yyy.zzz.app.SessionCart&quot;</span>
            <span class="na">scope=</span><span class="s">&quot;session&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;aop:scoped-proxy</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;/beans:bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Beanのスコープを<code class="docutils literal"><span class="pre">session</span></code>にする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;aop:scoped-proxy</span> <span class="pre">/&gt;</span></code> 要素を指定し、scoped-proxyを有効にする。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id21">
<h4><a class="toc-backref" href="#id55">4.3.2.2.2. sessionスコープのBeanの利用</a><a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">sessionスコープのBeanを利用して、オブジェクトをセッションに格納・取得する場合は、</div>
<div class="line">sessionスコープのBeanを、ControllerにInjectする。</div>
</div>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="n">SessionCart</span> <span class="n">sessionCart</span><span class="p">;</span> <span class="c1">// (1)</span>

<span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;add&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">addCart</span><span class="p">(</span><span class="nd">@Validated</span> <span class="n">ItemForm</span> <span class="n">form</span><span class="p">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">hasErrors</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;item/item&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">CartItem</span> <span class="n">cartItem</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">CartItem</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
    <span class="n">Cart</span> <span class="n">addedCart</span> <span class="o">=</span> <span class="n">cartService</span><span class="p">.</span><span class="na">addCartItem</span><span class="p">(</span><span class="n">sessionCart</span><span class="p">.</span><span class="na">getCart</span><span class="p">(),</span> <span class="c1">// (2)</span>
            <span class="n">cartItem</span><span class="p">);</span>
    <span class="n">sessionCart</span><span class="p">.</span><span class="na">setCart</span><span class="p">(</span><span class="n">addedCart</span><span class="p">);</span> <span class="c1">// (3)</span>
    <span class="k">return</span> <span class="s">&quot;redirect:/cart&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">sessionスコープのBeanを、ControllerにInjectする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">sessionスコープのBeanのメソッド呼び出しを行うと、セッションに格納されているオブジェクトが返却される。</div>
<div class="line">セッションにオブジェクトが格納されていない場合は、新たに生成されたオブジェクトが返却され、セッションにも格納される。</div>
<div class="line">上記例では、カートに追加する前に在庫数などのチェックを行うため、Serviceのメソッドを呼び出している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">上記例では、<code class="docutils literal"><span class="pre">CartService</span></code>のaddCartItemメソッドの引数に渡した<code class="docutils literal"><span class="pre">Cart</span></code>オブジェクトと、</div>
<div class="line">返り値で返却される<code class="docutils literal"><span class="pre">Cart</span></code>オブジェクトが、別のインスタンスになる可能性があるため、</div>
<div class="line">返却された<code class="docutils literal"><span class="pre">Cart</span></code>オブジェクトをsessionスコープのBeanに設定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>View(JSP)からsessionスコープのBeanを参照する方法</strong></p>
<p class="last">SpEL(Spring Expression Language)式を用いることでControllerにおいて<code class="docutils literal"><span class="pre">Model</span></code>オブジェクトへBeanを追加しなくても、JSPからsessionスコープのBeanを参照することができる。</p>
</div>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;spring:eval</span> <span class="na">var=</span><span class="s">&quot;cart&quot;</span> <span class="na">expression=</span><span class="s">&quot;@sessionCart.cart&quot;</span> <span class="nt">/&gt;</span>     <span class="k">&lt;%-</span><span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">--</span><span class="k">%&gt;</span>

<span class="k">&lt;%-</span><span class="o">-</span> <span class="n">omitted</span> <span class="o">--</span><span class="k">%&gt;</span>

<span class="nt">&lt;c:forEach</span> <span class="na">var=</span><span class="s">&quot;item&quot;</span> <span class="na">items=</span><span class="s">&quot;${cart.cartItems}&quot;</span><span class="nt">&gt;</span>     <span class="k">&lt;%-</span><span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">--</span><span class="k">%&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>${f:h(item.id)}<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span>${f:h(item.itemCode)}<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span>${f:h(item.quantity)}<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;/c:forEach&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">sessionスコープのBeanを参照する</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">sessionスコープのBeanを表示する</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id22">
<h4><a class="toc-backref" href="#id56">4.3.2.2.3. セッションに格納したオブジェクトの削除</a><a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">不要になったオブジェクトをセッション上から削除する場合は、sessionスコープのBeanのフィールドをリセットする。</div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>sessionスコープのBeanは、セッションが切れる時にDIコンテナによって破棄される。</p>
<p class="last">DIコンテナがsessionスコープのBeanのライフサイクルを管理しているので、Bean自体の破棄はDIコンテナにまかせる。</p>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;order&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderController</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">SessionCart</span> <span class="n">sessionCart</span><span class="p">;</span> <span class="c1">// (1)</span>

    <span class="c1">// ...</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">order</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="k">return</span> <span class="s">&quot;redirect:/order?complete&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="s">&quot;complete&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">complete</span><span class="p">(</span><span class="n">Model</span> <span class="n">model</span><span class="p">,</span> <span class="n">SessionStatus</span> <span class="n">sessionStatus</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sessionCart</span><span class="p">.</span><span class="na">clearCart</span><span class="p">();</span> <span class="c1">// (2)</span>
        <span class="k">return</span> <span class="s">&quot;order/complete&quot;</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">sessionスコープのBeanをインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">sessionスコープのBeanの状態をクリアし、注文済みの商品をカートから削除する</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id23">
<h4><a class="toc-backref" href="#id57">4.3.2.2.4. sessionスコープのBeanを使った処理の実装例</a><a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h4>
<p>より具体的な実装例については、Appendixの<a class="reference internal" href="#session-management-appendix-sessionscope"><span class="std std-ref">sessionスコープのBeanを使った複数のControllerを跨いだ画面遷移の実装例</span></a>を参照されたい。</p>
</div>
</div>
<div class="section" id="id24">
<h3><a class="toc-backref" href="#id58">4.3.2.3. セッション操作のデバッグログ出力</a><a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">セッションに対して行われた操作を、デバッグログに出力するクラスを、共通ライブラリとして提供している。</div>
<div class="line">セッションに対する操作が、想定通りに動作しているか確認する必要がある場合に、このクラスで出力するログが有効である。</div>
</div>
<p>共通ライブラリの詳細は、<a class="reference internal" href="../GeneralFuncDetail/Logging.html#logging-appendix-httpsessioneventlogginglistener"><span class="std std-ref">HttpSessionEventLoggingListener</span></a>を参照されたい。</p>
</div>
<div class="section" id="jsp-sessionscope">
<h3><a class="toc-backref" href="#id59">4.3.2.4. JSPの暗黙オブジェクト <code class="docutils literal"><span class="pre">sessionScope</span></code> を使用する</a><a class="headerlink" href="#jsp-sessionscope" title="Permalink to this headline">¶</a></h3>
<p>JSPの暗黙オブジェクトである <code class="docutils literal"><span class="pre">sessionScope</span></code>を使用する場合は、 pageディレクティブのsession属性の値を <code class="docutils literal"><span class="pre">true</span></code> にする必要がある。
ブランクプロジェクトから提供している <code class="file docutils literal"><span class="pre">include.jsp</span></code> では、 <code class="docutils literal"><span class="pre">false</span></code> となっている。</p>
<p><code class="file docutils literal"><span class="pre">include.jsp</span></code> は、 <code class="file docutils literal"><span class="pre">src/main/webapp/WEB-INF/views/common</span></code> ディレクトリに格納されている。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">include.jsp</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="k">&lt;%@</span> <span class="n">page</span> <span class="n">session</span><span class="o">=</span><span class="s">&quot;true&quot;</span><span class="k">%&gt;</span>     <span class="k">&lt;%-</span><span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">--</span><span class="k">%&gt;</span>

<span class="k">&lt;%-</span><span class="o">-</span> <span class="n">omitted</span> <span class="o">--</span><span class="k">%&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">pageディレクティブのsession属性の値を <code class="docutils literal"><span class="pre">true</span></code> にする。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="how-to-extend">
<h2><a class="toc-backref" href="#id60">4.3.3. How to extend</a><a class="headerlink" href="#how-to-extend" title="Permalink to this headline">¶</a></h2>
<div class="section" id="session-management-how-to-extend-synchronizeonsession">
<span id="id25"></span><h3><a class="toc-backref" href="#id61">4.3.3.1. 同一セッション内のリクエストの同期化</a><a class="headerlink" href="#session-management-how-to-extend-synchronizeonsession" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>アノテーション、またはsessionスコープのBeanを使用する場合は、同一セッション内のリクエストを同期化することを推奨する。</div>
<div class="line">同期化しない場合、セッションに格納されているオブジェクトに、同時にアクセスする可能性があるため、想定外のエラーや、動作を引き起こす原因になりうる。</div>
</div>
<div class="line-block">
<div class="line">例えば、入力チェック済みのフォームオブジェクトに対して、不正な値が設定される可能性がある。</div>
<div class="line">これを防ぐ方法として、<code class="docutils literal"><span class="pre">org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter</span></code>の、synchronizeOnSessionをtrueにして、同一セッション内のリクエストを同期化することを、強く推奨する。</div>
</div>
<p>以下のようなBeanPostProcessorを作成し、Bean定義することで実現できる。</p>
<ul class="simple">
<li>コンポーネント</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.app.config</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.BeansException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.config.BeanPostProcessor</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EnableSynchronizeOnSessionPostProcessor</span>
    <span class="kd">implements</span> <span class="n">BeanPostProcessor</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span>
            <span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">EnableSynchronizeOnSessionPostProcessor</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">postProcessBeforeInitialization</span><span class="p">(</span><span class="n">Object</span> <span class="n">bean</span><span class="p">,</span> <span class="n">String</span> <span class="n">beanName</span><span class="p">)</span>
        <span class="kd">throws</span> <span class="n">BeansException</span> <span class="p">{</span>
        <span class="c1">// NO-OP</span>
        <span class="k">return</span> <span class="n">bean</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">postProcessAfterInitialization</span><span class="p">(</span><span class="n">Object</span> <span class="n">bean</span><span class="p">,</span> <span class="n">String</span> <span class="n">beanName</span><span class="p">)</span>
        <span class="kd">throws</span> <span class="n">BeansException</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bean</span> <span class="k">instanceof</span> <span class="n">RequestMappingHandlerAdapter</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">RequestMappingHandlerAdapter</span> <span class="n">adapter</span> <span class="o">=</span>
                <span class="p">(</span><span class="n">RequestMappingHandlerAdapter</span><span class="p">)</span> <span class="n">bean</span><span class="p">;</span>
            <span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;enable synchronizeOnSession =&gt; {}&quot;</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>
            <span class="n">adapter</span><span class="p">.</span><span class="na">setSynchronizeOnSession</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span> <span class="c1">// (1)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">bean</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter</span></code>のsetSynchronizeOnSessionメソッドの引数に、<code class="docutils literal"><span class="pre">true</span></code>を指定すると、同一セッション内でのリクエストが同期化される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>spring-mvc.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;com.example.app.config.EnableSynchronizeOnSessionPostProcessor&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(1)で作成した、<code class="docutils literal"><span class="pre">BeanPostProcessor</span></code> をBean定義する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">synchronizeOnSessionにより同期化が行われるのはControllerの範囲であるため、
Viewでセッションスコープのフォームオブジェクトから値を取得している場合は、別スレッドから書き換えられた不正な値が得られる可能性がある。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="appendix">
<h2><a class="toc-backref" href="#id62">4.3.4. Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this headline">¶</a></h2>
<div class="section" id="session-management-appendix-sessionattribute">
<span id="id26"></span><h3><a class="toc-backref" href="#id63">4.3.4.1. <code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>アノテーションを使ったウィザード形式の画面遷移の実装例</a><a class="headerlink" href="#session-management-appendix-sessionattribute" title="Permalink to this headline">¶</a></h3>
<p>ウィザード形式の画面遷移を行う処理を例に、<code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code>アノテーションを使った実装の説明を行う。</p>
<p>処理の仕様は、以下の通りとする。</p>
<ul class="simple">
<li>Entityの登録と、更新を行うための画面を提供する。</li>
<li>入力画面は、3画面で構成され、各画面で1項目ずつ入力を行う。</li>
<li>入力した値は、保存(登録/更新)する前に、確認画面で確認できる。</li>
<li>入力チェックは、画面遷移するタイミングで行い、エラーがある場合は、入力画面に戻る。</li>
<li>保存(登録/更新)する前に、すべての入力値に対する入力チェックを再度行い、エラーがある場合は、不正操作を通知するエラー画面を表示する。</li>
<li>すべての入力値に対するチェックが妥当な場合は、入力データをデータベースに保存する。</li>
</ul>
<p>基本的な画面遷移は、以下の通りとする。</p>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/session-management_appendix_screenflow1.png"><img alt="Invalidate session by processing of Web Application" src="../../_images/session-management_appendix_screenflow1.png" style="width: 100%;" /></a>
</div>
</div></blockquote>
<p>実装例は、以下の通りである。</p>
<ul class="simple">
<li>フォームオブジェクト</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WizardForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

    <span class="c1">// (1)</span>
    <span class="nd">@NotEmpty</span><span class="p">(</span><span class="n">groups</span> <span class="o">=</span> <span class="p">{</span> <span class="n">Wizard1</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">field1</span><span class="p">;</span>

    <span class="c1">// (2)</span>
    <span class="nd">@NotEmpty</span><span class="p">(</span><span class="n">groups</span> <span class="o">=</span> <span class="p">{</span> <span class="n">Wizard2</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">field2</span><span class="p">;</span>

    <span class="c1">// (3)</span>
    <span class="nd">@NotEmpty</span><span class="p">(</span><span class="n">groups</span> <span class="o">=</span> <span class="p">{</span> <span class="n">Wizard3</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">field3</span><span class="p">;</span>

    <span class="c1">// ...</span>

    <span class="c1">// (4)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">Wizard1</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="c1">// (5)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">Wizard2</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="c1">// (6)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">Wizard3</span> <span class="p">{</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">1ページ目の入力画面で入力するフィールド。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">2ページ目の入力画面で入力するフィールド。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">3ページ目の入力画面で入力するフィールド。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">1ページ目の入力画面で入力されるフィールドであることを示すための、検証グループインタフェース。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">2ページ目の入力画面で入力されるフィールドであることを示すための、検証グループインタフェース。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">3ページ目の入力画面で入力されるフィールドであることを示すための、検証グループインタフェース。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>検証グループについて</strong></p>
<p class="last">画面遷移時の入力チェックでは、該当ページのフィールドのみチェックする必要がある。
Bean Validationでは、検証グループを表すクラス、またはインタフェースを設けることで、検証するルールをグループ化することができる。
今回の実装例のケースでは、画面毎に検証グループを用意することで、画面毎の入力チェックを実現している。</p>
</div>
</div></blockquote>
<ul class="simple">
<li>Controller</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;wizard&quot;</span><span class="p">)</span>
<span class="nd">@SessionAttributes</span><span class="p">(</span><span class="n">types</span> <span class="o">=</span> <span class="p">{</span> <span class="n">WizardForm</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">Entity</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span> <span class="c1">// (7)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WizardController</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">WizardService</span> <span class="n">wizardService</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">Mapper</span> <span class="n">beanMapper</span><span class="p">;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">上記例では、フォームオブジェクト(<code class="docutils literal"><span class="pre">WizardForm.class</span></code>)と、エンティティ(<code class="docutils literal"><span class="pre">Entity.class</span></code>)のオブジェクトを、セッションに格納する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@ModelAttribute</span><span class="p">(</span><span class="s">&quot;wizardForm&quot;</span><span class="p">)</span> <span class="c1">// (8)</span>
<span class="kd">public</span> <span class="n">WizardForm</span> <span class="nf">setUpWizardForm</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">WizardForm</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">上記例では、セッションに格納するフォームオブジェクト(<code class="docutils literal"><span class="pre">WizardForm</span></code>)を生成している。 無駄なオブジェクトの生成をなくすために、<code class="docutils literal"><span class="pre">&#64;ModelAttribute</span></code>アノテーションのvalue属性を指定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (9)</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">initializeCreateWizardForm</span><span class="p">(</span><span class="n">SessionStatus</span> <span class="n">sessionStatus</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sessionStatus</span><span class="p">.</span><span class="na">setComplete</span><span class="p">();</span>
    <span class="k">return</span> <span class="s">&quot;redirect:/wizard/create?form1&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// (10)</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form1&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">createForm1</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">&quot;wizard/form1&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">登録用入力画面を、初期表示するためのハンドラメソッド。</div>
<div class="line">操作途中のオブジェクトが、セッションに格納されている可能性があるため、このハンドラメソッドで、セッションに格納されているオブジェクトを削除しておく。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">１ページ目の登録用入力画面を、表示するためのハンドラメソッド。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (11)</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;{id}/update&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">initializeUpdateWizardForm</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">)</span> <span class="n">Integer</span> <span class="n">id</span><span class="p">,</span>
        <span class="n">RedirectAttributes</span> <span class="n">redirectAttributes</span><span class="p">,</span> <span class="n">SessionStatus</span> <span class="n">sessionStatus</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sessionStatus</span><span class="p">.</span><span class="na">setComplete</span><span class="p">();</span>
    <span class="k">return</span> <span class="s">&quot;redirect:/wizard/{id}/update?form1&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// (12)</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;{id}/update&quot;</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form1&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">updateForm1</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">)</span> <span class="n">Integer</span> <span class="n">id</span><span class="p">,</span> <span class="n">WizardForm</span> <span class="n">form</span><span class="p">,</span>
        <span class="n">Model</span> <span class="n">model</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Entity</span> <span class="n">loadedEntity</span> <span class="o">=</span> <span class="n">wizardService</span><span class="p">.</span><span class="na">getEntity</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
    <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">loadedEntity</span><span class="p">,</span> <span class="n">form</span><span class="p">);</span> <span class="c1">// (13)</span>
    <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="n">loadedEntity</span><span class="p">);</span> <span class="c1">// (14)</span>
    <span class="k">return</span> <span class="s">&quot;wizard/form1&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">更新用入力画面を、初期表示するためのハンドラメソッド。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">１ページ目の更新用入力画面を、表示するためのハンドラメソッド。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(13)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したエンティティの状態をフォームオブジェクトに設定する。上記例では、DozerというBeanマッパーライブラリを使用している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(14)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したエンティティを <code class="docutils literal"><span class="pre">Model</span></code> オブジェクトに追加し、セッションに格納する。</div>
<div class="line">上記例では、<code class="docutils literal"><span class="pre">entity</span></code>という属性名で、セッションに格納される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (15)</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;save&quot;</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form2&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">saveForm2</span><span class="p">(</span><span class="nd">@Validated</span><span class="p">(</span><span class="n">Wizard1</span><span class="p">.</span><span class="na">class</span><span class="p">)</span> <span class="n">WizardForm</span> <span class="n">form</span><span class="p">,</span> <span class="c1">// (16)</span>
        <span class="n">BindingResult</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">hasErrors</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">saveRedoForm1</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="s">&quot;wizard/form2&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// (17)</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;save&quot;</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form3&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">saveForm3</span><span class="p">(</span><span class="nd">@Validated</span><span class="p">(</span><span class="n">Wizard2</span><span class="p">.</span><span class="na">class</span><span class="p">)</span> <span class="n">WizardForm</span> <span class="n">form</span><span class="p">,</span> <span class="c1">// (18)</span>
        <span class="n">BindingResult</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">hasErrors</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">saveRedoForm2</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="s">&quot;wizard/form3&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// (19)</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;save&quot;</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;confirm&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">saveConfirm</span><span class="p">(</span><span class="nd">@Validated</span><span class="p">(</span><span class="n">Wizard3</span><span class="p">.</span><span class="na">class</span><span class="p">)</span> <span class="n">WizardForm</span> <span class="n">form</span><span class="p">,</span> <span class="c1">// (20)</span>
        <span class="n">BindingResult</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">hasErrors</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">saveRedoForm3</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="s">&quot;wizard/confirm&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(15)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">2ページ目の入力画面を、表示するためのハンドラメソッド。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(16)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">1ページ目の入力画面で入力された値のみ、入力チェックするために、<code class="docutils literal"><span class="pre">&#64;Validated</span></code>アノテーションのvalue属性に、1ページ目の入力画面の検証グループ(<code class="docutils literal"><span class="pre">Wizard1.class</span></code>)を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(17)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">3ページ目の入力画面を、表示するためのハンドラメソッド。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(18)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">2ページ目の入力画面で入力された値のみ、入力チェックするために、<code class="docutils literal"><span class="pre">&#64;Validated</span></code>アノテーションのvalue属性に、2ページ目の入力画面の検証グループ(<code class="docutils literal"><span class="pre">Wizard2.class</span></code>)を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(19)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">確認画面を表示するためのハンドラメソッド。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(20)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">3ページ目の入力画面で入力された値のみ、入力チェックするために、<code class="docutils literal"><span class="pre">&#64;Validated</span></code>アノテーションのvalue属性に、3ページ目の入力画面の検証グループ(<code class="docutils literal"><span class="pre">Wizard3.class</span></code>)を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (21)</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;save&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">save</span><span class="p">(</span><span class="nd">@ModelAttribute</span> <span class="nd">@Validated</span><span class="p">({</span> <span class="n">Wizard1</span><span class="p">.</span><span class="na">class</span><span class="p">,</span>
        <span class="n">Wizard2</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">Wizard3</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span> <span class="n">WizardForm</span> <span class="n">form</span><span class="p">,</span> <span class="c1">// (22)</span>
        <span class="n">BindingResult</span> <span class="n">result</span><span class="p">,</span>
        <span class="n">Entity</span> <span class="n">entity</span><span class="p">,</span> <span class="c1">// (23)</span>
        <span class="n">RedirectAttributes</span> <span class="n">redirectAttributes</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">hasErrors</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">InvalidRequestException</span><span class="p">(</span><span class="n">result</span><span class="p">);</span> <span class="c1">// (24)</span>
    <span class="p">}</span>

    <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">entity</span><span class="p">);</span>

    <span class="n">entity</span> <span class="o">=</span> <span class="n">wizardService</span><span class="p">.</span><span class="na">saveEntity</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span> <span class="c1">// (25)</span>

    <span class="n">redirectAttributes</span><span class="p">.</span><span class="na">addFlashAttribute</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span> <span class="c1">// (26)</span>

    <span class="k">return</span> <span class="s">&quot;redirect:/wizard/save?complete&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// (27)</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;save&quot;</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;complete&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">saveComplete</span><span class="p">(</span><span class="n">SessionStatus</span> <span class="n">sessionStatus</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sessionStatus</span><span class="p">.</span><span class="na">setComplete</span><span class="p">();</span>
    <span class="k">return</span> <span class="s">&quot;wizard/complete&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(21)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">保存処理を実行するためのハンドラメソッド。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(22)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力画面で入力された値を全てチェックするために、<code class="docutils literal"><span class="pre">&#64;Validated</span></code>アノテーションのvalue属性に、各入力画面の検証グループインタフェース(<code class="docutils literal"><span class="pre">Wizard1.class</span></code>,  <code class="docutils literal"><span class="pre">Wizard2.class</span></code>, <code class="docutils literal"><span class="pre">Wizard3.class</span></code>)を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(23)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">保存する<code class="docutils literal"><span class="pre">Entity.class</span></code>のオブジェクトを取得する。</div>
<div class="line">登録処理の場合は、新たに生成されたオブジェクト、更新処理の場合は、(14)の処理でセッションに格納したオブジェクトが取得される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(24)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アプリケーションが提供しているボタンを使って、画面遷移を行っていれば、このタイミングでエラーは発生しないので、不正な操作が行われた場合に<code class="docutils literal"><span class="pre">InvalidRequestException</span></code>がthrowされる。</div>
<div class="line">なお、<code class="docutils literal"><span class="pre">InvalidRequestException</span></code>は共通ライブラリから提供している例外クラスではないため、別途作成する必要がある。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(25)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力値が反映された<code class="docutils literal"><span class="pre">Entity.class</span></code>のオブジェクトを保存する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(26)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リダイレクト先のハンドラメソッドで保存した<code class="docutils literal"><span class="pre">Entity.class</span></code>のオブジェクトを参照できるようにするために、Flashスコープに格納する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(27)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">完了画面を表示するためのハンドラメソッド。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-java"><div class="highlight"><pre><span></span>    <span class="c1">// (28)</span>
    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;save&quot;</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;redoForm1&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">saveRedoForm1</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;wizard/form1&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (29)</span>
    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;save&quot;</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;redoForm2&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">saveRedoForm2</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;wizard/form2&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (30)</span>
    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;save&quot;</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;redoForm3&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">saveRedoForm3</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;wizard/form3&quot;</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(28)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">1ページ目の入力画面を、再表示するためのハンドラメソッド。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(29)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">2ページ目の入力画面を、再表示するためのハンドラメソッド。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(30)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">3ページ目の入力画面を、再表示するためのハンドラメソッド。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Controllerの全ソース</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;wizard&quot;</span><span class="p">)</span>
<span class="nd">@SessionAttributes</span><span class="p">(</span><span class="n">types</span> <span class="o">=</span> <span class="p">{</span> <span class="n">WizardForm</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">Entity</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span>
<span class="c1">// (7)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WizardController</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">EntityService</span> <span class="n">wizardService</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">Mapper</span> <span class="n">beanMapper</span><span class="p">;</span>

    <span class="nd">@ModelAttribute</span><span class="p">(</span><span class="s">&quot;wizardForm&quot;</span><span class="p">)</span>
    <span class="c1">// (8)</span>
    <span class="kd">public</span> <span class="n">WizardForm</span> <span class="nf">setUpWizardForm</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">WizardForm</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// (9)</span>
    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">initializeCreateWizardForm</span><span class="p">(</span><span class="n">SessionStatus</span> <span class="n">sessionStatus</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sessionStatus</span><span class="p">.</span><span class="na">setComplete</span><span class="p">();</span>
        <span class="k">return</span> <span class="s">&quot;redirect:/wizard/create?form1&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (10)</span>
    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form1&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createForm1</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;wizard/form1&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (11)</span>
    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;{id}/update&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">initializeUpdateWizardForm</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">)</span> <span class="n">Integer</span> <span class="n">id</span><span class="p">,</span>
            <span class="n">RedirectAttributes</span> <span class="n">redirectAttributes</span><span class="p">,</span> <span class="n">SessionStatus</span> <span class="n">sessionStatus</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sessionStatus</span><span class="p">.</span><span class="na">setComplete</span><span class="p">();</span>
        <span class="k">return</span> <span class="s">&quot;redirect:/wizard/{id}/update?form1&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (12)</span>
    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;{id}/update&quot;</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form1&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">updateForm1</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">)</span> <span class="n">Integer</span> <span class="n">id</span><span class="p">,</span> <span class="n">WizardForm</span> <span class="n">form</span><span class="p">,</span>
            <span class="n">Model</span> <span class="n">model</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Entity</span> <span class="n">loadedEntity</span> <span class="o">=</span> <span class="n">wizardService</span><span class="p">.</span><span class="na">getEntity</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
        <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">loadedEntity</span><span class="p">,</span> <span class="n">form</span><span class="p">);</span> <span class="c1">// (13)</span>
        <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="n">loadedEntity</span><span class="p">);</span> <span class="c1">// (14)</span>
        <span class="k">return</span> <span class="s">&quot;wizard/form1&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (15)</span>
    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;save&quot;</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form2&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">saveForm2</span><span class="p">(</span><span class="nd">@Validated</span><span class="p">(</span><span class="n">Wizard1</span><span class="p">.</span><span class="na">class</span><span class="p">)</span> <span class="n">WizardForm</span> <span class="n">form</span><span class="p">,</span> <span class="c1">// (16)</span>
            <span class="n">BindingResult</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">hasErrors</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">saveRedoForm1</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="s">&quot;wizard/form2&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (17)</span>
    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;save&quot;</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form3&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">saveForm3</span><span class="p">(</span><span class="nd">@Validated</span><span class="p">(</span><span class="n">Wizard2</span><span class="p">.</span><span class="na">class</span><span class="p">)</span> <span class="n">WizardForm</span> <span class="n">form</span><span class="p">,</span> <span class="c1">// (18)</span>
            <span class="n">BindingResult</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">hasErrors</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">saveRedoForm2</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="s">&quot;wizard/form3&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (19)</span>
    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;save&quot;</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;confirm&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">saveConfirm</span><span class="p">(</span><span class="nd">@Validated</span><span class="p">(</span><span class="n">Wizard3</span><span class="p">.</span><span class="na">class</span><span class="p">)</span> <span class="n">WizardForm</span> <span class="n">form</span><span class="p">,</span> <span class="c1">// (20)</span>
            <span class="n">BindingResult</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">hasErrors</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">saveRedoForm3</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="s">&quot;wizard/confirm&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (21)</span>
    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;save&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">save</span><span class="p">(</span><span class="nd">@ModelAttribute</span> <span class="nd">@Validated</span><span class="p">({</span> <span class="n">Wizard1</span><span class="p">.</span><span class="na">class</span><span class="p">,</span>
            <span class="n">Wizard2</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">Wizard3</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span> <span class="n">WizardForm</span> <span class="n">form</span><span class="p">,</span> <span class="c1">// (22)</span>
            <span class="n">BindingResult</span> <span class="n">result</span><span class="p">,</span> <span class="n">Entity</span> <span class="n">entity</span><span class="p">,</span> <span class="c1">// (23)</span>
            <span class="n">RedirectAttributes</span> <span class="n">redirectAttributes</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">hasErrors</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">InvalidRequestException</span><span class="p">(</span><span class="n">result</span><span class="p">);</span> <span class="c1">// (24)</span>
        <span class="p">}</span>

        <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">entity</span><span class="p">);</span>

        <span class="n">entity</span> <span class="o">=</span> <span class="n">wizardService</span><span class="p">.</span><span class="na">saveEntity</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span> <span class="c1">// (25)</span>

        <span class="n">redirectAttributes</span><span class="p">.</span><span class="na">addFlashAttribute</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span> <span class="c1">// (26)</span>

        <span class="k">return</span> <span class="s">&quot;redirect:/wizard/save?complete&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (27)</span>
    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;save&quot;</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;complete&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">saveComplete</span><span class="p">(</span><span class="n">SessionStatus</span> <span class="n">sessionStatus</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sessionStatus</span><span class="p">.</span><span class="na">setComplete</span><span class="p">();</span>
        <span class="k">return</span> <span class="s">&quot;wizard/complete&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (28)</span>
    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;save&quot;</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;redoForm1&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">saveRedoForm1</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;wizard/form1&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (29)</span>
    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;save&quot;</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;redoForm2&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">saveRedoForm2</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;wizard/form2&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (30)</span>
    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;save&quot;</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;redoForm3&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">saveRedoForm3</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;wizard/form3&quot;</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>1ページ目の入力画面(JSP)</li>
</ul>
<blockquote>
<div><div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>Wizard Form(1/3)<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Wizard Form(1/3)<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;form:form</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/wizard/save&quot;</span>
        <span class="na">modelAttribute=</span><span class="s">&quot;wizardForm&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;field1&quot;</span><span class="nt">&gt;</span>Field1<span class="nt">&lt;/form:label&gt;</span> :
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;field1&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;field1&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;div&gt;</span>
            <span class="nt">&lt;form:button</span> <span class="na">name=</span><span class="s">&quot;form2&quot;</span><span class="nt">&gt;</span>Next<span class="nt">&lt;/form:button&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/form:form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>2ページ目の入力画面(JSP)</li>
</ul>
<blockquote>
<div><div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>Wizard Form(2/3)<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Wizard Form(2/3)<span class="nt">&lt;/h1&gt;</span>
    <span class="k">&lt;%-</span><span class="o">-</span> <span class="p">(</span><span class="mi">31</span><span class="p">)</span> <span class="o">--</span><span class="k">%&gt;</span>
    <span class="nt">&lt;form:form</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/wizard/save&quot;</span>
        <span class="na">modelAttribute=</span><span class="s">&quot;wizardForm&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;field2&quot;</span><span class="nt">&gt;</span>Field2<span class="nt">&lt;/form:label&gt;</span> :
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;field2&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;field2&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;div&gt;</span>
            <span class="nt">&lt;form:button</span> <span class="na">name=</span><span class="s">&quot;redoForm1&quot;</span><span class="nt">&gt;</span>Back<span class="nt">&lt;/form:button&gt;</span>
            <span class="nt">&lt;form:button</span> <span class="na">name=</span><span class="s">&quot;form3&quot;</span><span class="nt">&gt;</span>Next<span class="nt">&lt;/form:button&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/form:form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(31)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フォームオブジェクトをセッションに格納しているため、1ページ目の入力画面のフィールドを、hidden項目にする必要はない。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>3ページ目の入力画面(JSP)</li>
</ul>
<blockquote>
<div><div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>Wizard Form(3/3)<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Wizard Form(3/3)<span class="nt">&lt;/h1&gt;</span>
    <span class="k">&lt;%-</span><span class="o">-</span> <span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="o">--</span><span class="k">%&gt;</span>
    <span class="nt">&lt;form:form</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/wizard/save&quot;</span>
        <span class="na">modelAttribute=</span><span class="s">&quot;wizardForm&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;field3&quot;</span><span class="nt">&gt;</span>Field3<span class="nt">&lt;/form:label&gt;</span> :
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;field3&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;field3&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;div&gt;</span>
            <span class="nt">&lt;form:button</span> <span class="na">name=</span><span class="s">&quot;redoForm2&quot;</span><span class="nt">&gt;</span>Back<span class="nt">&lt;/form:button&gt;</span>
            <span class="nt">&lt;form:button</span> <span class="na">name=</span><span class="s">&quot;confirm&quot;</span><span class="nt">&gt;</span>Confirm<span class="nt">&lt;/form:button&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/form:form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(32)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フォームオブジェクトをセッションに格納しているため、1ページ目と2ページ目の入力画面のフィールドを、hidden項目にする必要はない。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>確認画面(JSP)</li>
</ul>
<blockquote>
<div><div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>Confirm<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Confirm<span class="nt">&lt;/h1&gt;</span>
    <span class="k">&lt;%-</span><span class="o">-</span> <span class="p">(</span><span class="mi">33</span><span class="p">)</span> <span class="o">--</span><span class="k">%&gt;</span>
    <span class="nt">&lt;form:form</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/wizard/save&quot;</span>
        <span class="na">modelAttribute=</span><span class="s">&quot;wizardForm&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div&gt;</span>
            Field1 : ${f:h(wizardForm.field1)}
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div&gt;</span>
            Field2 : ${f:h(wizardForm.field2)}
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div&gt;</span>
            Field3 : ${f:h(wizardForm.field3)}
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div&gt;</span>
            <span class="nt">&lt;form:button</span> <span class="na">name=</span><span class="s">&quot;redoForm3&quot;</span><span class="nt">&gt;</span>Back<span class="nt">&lt;/form:button&gt;</span>
            <span class="nt">&lt;form:button&gt;</span>OK<span class="nt">&lt;/form:button&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/form:form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(33)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フォームオブジェクトをセッションに格納しているため、入力画面のフィールドを、hidden項目にする必要はない。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>完了画面(JSP)</li>
</ul>
<blockquote>
<div><div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>Complete<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Complete<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;div&gt;</span>
            ID : ${f:h(entity.id)}
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div&gt;</span>
            Field1 : ${f:h(entity.field1)}
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div&gt;</span>
            Field2 : ${f:h(entity.field2)}
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div&gt;</span>
            Field3 : ${f:h(entity.field3)}
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;${pageContext.request.contextPath}/wizard/create&quot;</span><span class="nt">&gt;</span>
            Continue operation of Create
        <span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;${pageContext.request.contextPath}/wizard/${entity.id}/update&quot;</span><span class="nt">&gt;</span>
            Continue operation of Update
        <span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>spring-mvc.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.SystemExceptionResolver&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionCodeResolver&quot;</span> <span class="na">ref=</span><span class="s">&quot;exceptionCodeResolver&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionMappings&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;map&gt;</span>
            <span class="c">&lt;!-- ... --&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;InvalidRequestException&quot;</span>
                   <span class="na">value=</span><span class="s">&quot;common/error/operationError&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (34) --&gt;</span>
        <span class="nt">&lt;/map&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;statusCodes&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;map&gt;</span>
            <span class="c">&lt;!-- ... --&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;common/error/operationError&quot;</span> <span class="na">value=</span><span class="s">&quot;400&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (35) --&gt;</span>
        <span class="nt">&lt;/map&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(34)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">共通ライブラリから提供している<code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>の<code class="docutils literal"><span class="pre">exceptionMappings</span></code>に、保存処理実行時に不正なリクエストを検知したことを、通知する例外<code class="docutils literal"><span class="pre">InvalidRequestException</span></code>の、例外ハンドリングの定義を追加する。</div>
<div class="line">上記例では、 例外発生時の遷移先のView名として、<code class="docutils literal"><span class="pre">/WEB-INF/views/common/error/operationError.jsp</span></code>を指定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(35)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>の<code class="docutils literal"><span class="pre">statusCodes</span></code> に、<code class="docutils literal"><span class="pre">HttpSessionRequiredException</span></code>発生時のHTTPレスポンスコードを指定する。</div>
<div class="line">上記例では、 例外発生時のHTTPレスポンスコードとして、Bad Request(<code class="docutils literal"><span class="pre">400</span></code>)を指定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>applicationContext.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;exceptionCodeResolver&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.common.exception.SimpleMappingExceptionCodeResolver&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- Setting and Customization by project. --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionMappings&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;map&gt;</span>
            <span class="c">&lt;!-- ... --&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;InvalidRequestException&quot;</span> <span class="na">value=</span><span class="s">&quot;w.xx.0004&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (36) --&gt;</span>
        <span class="nt">&lt;/map&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultExceptionCode&quot;</span> <span class="na">value=</span><span class="s">&quot;e.xx.0001&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (37) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(36)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">共通ライブラリから提供している<code class="docutils literal"><span class="pre">SimpleMappingExceptionCodeResolver</span></code>の<code class="docutils literal"><span class="pre">exceptionMappings</span></code>に、<code class="docutils literal"><span class="pre">InvalidRequestException</span></code>の例外ハンドリングの定義を追加する。</div>
<div class="line">上記例では、  例外発生時の例外コードとして、<code class="docutils literal"><span class="pre">w.xx.0004</span></code>を指定している。</div>
<div class="line">この設定を追加しない場合は、デフォルトの例外コードが、ログに出力される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(37)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例外発生時のデフォルトの例外コード。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="sessionbeancontroller">
<span id="session-management-appendix-sessionscope"></span><h3><a class="toc-backref" href="#id64">4.3.4.2. sessionスコープのBeanを使った複数のControllerを跨いだ画面遷移の実装例</a><a class="headerlink" href="#sessionbeancontroller" title="Permalink to this headline">¶</a></h3>
<p>複数のControllerをまたいで画面遷移を行う処理を例に、sessionスコープのBeanを使った実装の説明を行う。</p>
<p>処理の仕様は、以下の通りとする。</p>
<ul class="simple">
<li>商品をカートに追加する処理を提供する。</li>
<li>カートに追加されている商品の、数量変更を行う処理を提供する。</li>
<li>カートに格納されている商品を、注文する処理を提供する。</li>
<li>上記3つの処理は、それぞれ独立した機能として提供するため、別Controller(ItemController, CartController, OrderController)とする。</li>
<li>カートは、上記3つの処理で共有するため、セッションに格納する。</li>
<li>商品をカートに追加した場合は、カート画面に遷移する。</li>
</ul>
<p>画面遷移は、以下の通りとする。</p>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/session-management_appendix_screenflow2.png"><img alt="Invalidate session by processing of Web Application" src="../../_images/session-management_appendix_screenflow2.png" style="width: 100%;" /></a>
</div>
</div></blockquote>
<p>実装例は、以下の通りである。</p>
<ul class="simple">
<li>sessionスコープのBeanとして定義するJavaBean</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Component</span>
<span class="nd">@Scope</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;session&quot;</span><span class="p">,</span> <span class="n">proxyMode</span> <span class="o">=</span> <span class="n">ScopedProxyMode</span><span class="p">.</span><span class="na">TARGET_CLASS</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SessionCart</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">Cart</span> <span class="n">cart</span><span class="p">;</span> <span class="c1">// (1)</span>

    <span class="kd">public</span> <span class="n">Cart</span> <span class="nf">getCart</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cart</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cart</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cart</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">cart</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCart</span><span class="p">(</span><span class="n">Cart</span> <span class="n">cart</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">cart</span> <span class="o">=</span> <span class="n">cart</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">clearCart</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// (2)</span>
        <span class="n">cart</span><span class="p">.</span><span class="na">clearCart</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Cart</span></code>というEntity(Domainオブジェクト)をラップしている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">カートに追加された商品のオブジェクトを<code class="docutils literal"><span class="pre">cart</span></code>から削除し，カートが空の状態にする。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>ItemController</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;item&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ItemController</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">SessionCart</span> <span class="n">sessionCart</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">CartService</span> <span class="n">cartService</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">Mapper</span> <span class="n">beanMapper</span><span class="p">;</span>

    <span class="nd">@ModelAttribute</span>
    <span class="kd">public</span> <span class="n">ItemForm</span> <span class="nf">setUpItemForm</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ItemForm</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// (3)</span>
    <span class="nd">@RequestMapping</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">view</span><span class="p">(</span><span class="n">Model</span> <span class="n">model</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;item/item&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (4)</span>
    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;add&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">addCart</span><span class="p">(</span><span class="nd">@Validated</span> <span class="n">ItemForm</span> <span class="n">form</span><span class="p">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">hasErrors</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s">&quot;item/item&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">CartItem</span> <span class="n">cartItem</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">CartItem</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="n">Cart</span> <span class="n">cart</span> <span class="o">=</span> <span class="n">cartService</span><span class="p">.</span><span class="na">addCartItem</span><span class="p">(</span><span class="n">sessionCart</span><span class="p">.</span><span class="na">getCart</span><span class="p">(),</span> <span class="c1">// (5)</span>
                <span class="n">cartItem</span><span class="p">);</span>
        <span class="n">sessionCart</span><span class="p">.</span><span class="na">setCart</span><span class="p">(</span><span class="n">cart</span><span class="p">);</span> <span class="c1">// (6)</span>
        <span class="k">return</span> <span class="s">&quot;redirect:/cart&quot;</span><span class="p">;</span> <span class="c1">// (7)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">商品画面を、表示するためのハンドラメソッド。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">指定された商品を、カートに追加するためのハンドラメソッド。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">セッションに格納されている<code class="docutils literal"><span class="pre">Cart</span></code>オブジェクトを、Serviceのメソッドに渡す。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Serviceのメソッドから返却された<code class="docutils literal"><span class="pre">Cart</span></code>オブジェクトを、sessionスコープのBeanに反映する。</div>
<div class="line">sessionスコープのBeanに反映することで、<code class="docutils literal"><span class="pre">Cart</span></code>オブジェクトがセッションに格納される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">商品をカートに追加した後に、カート画面を表示するためのリクエストに、リダイレクトする。</div>
<div class="line"><strong>別Controllerの画面に遷移する場合は、直接View(JSP)を呼び出すのではなく、画面を表示するためのリクエストにリダイレクトすることを推奨する。</strong></div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>CartController</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;cart&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CartController</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">SessionCart</span> <span class="n">sessionCart</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">CartService</span> <span class="n">cartService</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">Mapper</span> <span class="n">beanMapper</span><span class="p">;</span>

    <span class="nd">@ModelAttribute</span>
    <span class="kd">public</span> <span class="n">CartForm</span> <span class="nf">setUpCartForm</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">CartForm</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// (8)</span>
    <span class="nd">@RequestMapping</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">cart</span><span class="p">(</span><span class="n">CartForm</span> <span class="n">form</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">sessionCart</span><span class="p">.</span><span class="na">getCart</span><span class="p">(),</span> <span class="n">form</span><span class="p">);</span>
        <span class="k">return</span> <span class="s">&quot;cart/cart&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (9)</span>
    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="s">&quot;edit&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">edit</span><span class="p">(</span><span class="nd">@Validated</span> <span class="n">CartForm</span> <span class="n">form</span><span class="p">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="p">,</span>
            <span class="n">Model</span> <span class="n">model</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">hasErrors</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s">&quot;cart/cart&quot;</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">Cart</span> <span class="n">cart</span> <span class="o">=</span> <span class="n">sessionCart</span><span class="p">.</span><span class="na">getCart</span><span class="p">();</span>
        <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">CartItemForm</span><span class="o">&gt;</span> <span class="n">itemForm</span> <span class="o">=</span> <span class="n">form</span><span class="p">.</span><span class="na">getCartItems</span><span class="p">().</span><span class="na">iterator</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">CartItem</span> <span class="n">item</span> <span class="p">:</span> <span class="n">cart</span><span class="p">.</span><span class="na">getCartItems</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">itemForm</span><span class="p">.</span><span class="na">next</span><span class="p">(),</span> <span class="n">item</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">cart</span> <span class="o">=</span> <span class="n">cartService</span><span class="p">.</span><span class="na">saveCart</span><span class="p">(</span><span class="n">cart</span><span class="p">);</span>
        <span class="n">sessionCart</span><span class="p">.</span><span class="na">setCart</span><span class="p">(</span><span class="n">cart</span><span class="p">);</span> <span class="c1">// (10)</span>

        <span class="k">return</span> <span class="s">&quot;redirect:/cart&quot;</span><span class="p">;</span> <span class="c1">// (11)</span>
    <span class="p">}</span>


<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">カート画面(数量変更画面)を表示するためのハンドラメソッド。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">数量変更を、行うためのハンドラメソッド。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Serviceのメソッドから返却された<code class="docutils literal"><span class="pre">Cart</span></code>オブジェクトをsessionスコープのBeanに反映する。</div>
<div class="line">sessionスコープのBeanに反映することで、セッションに反映される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">数量変更を行った後に、カート画面(数量変更画面)を表示するためのリクエストに、リダイレクトする。</div>
<div class="line"><strong>更新処理を行った場合は、直接View(JSP)を呼び出すのではなく、画面を表示するためのリクエストにリダイレクトすることを推奨する。</strong></div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>OrderController</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;order&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderController</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">SessionCart</span> <span class="n">sessionCart</span><span class="p">;</span>

    <span class="nd">@ModelAttribute</span>
    <span class="kd">public</span> <span class="n">OrderForm</span> <span class="nf">setUpOrderForm</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">OrderForm</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// (12)</span>
    <span class="nd">@RequestMapping</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">view</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;order/order&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (13)</span>
    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">order</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="k">return</span> <span class="s">&quot;redirect:/order?complete&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (14)</span>
    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="s">&quot;complete&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">complete</span><span class="p">(</span><span class="n">Model</span> <span class="n">model</span><span class="p">,</span> <span class="n">SessionStatus</span> <span class="n">sessionStatus</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sessionCart</span><span class="p">.</span><span class="na">clearCart</span><span class="p">();</span>
        <span class="k">return</span> <span class="s">&quot;order/complete&quot;</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">注文画面を、表示するためのハンドラメソッド。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(13)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">注文処理を行うためのハンドラメソッド。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(14)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">注文完了画面を表示するためのハンドラメソッド。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>商品画面(JSP)</li>
</ul>
<blockquote>
<div><div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>Item<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Item<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;form:form</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/item/add&quot;</span>
        <span class="na">modelAttribute=</span><span class="s">&quot;itemForm&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;itemCode&quot;</span><span class="nt">&gt;</span>Item Code<span class="nt">&lt;/form:label&gt;</span> :
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;itemCode&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;itemCode&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;quantity&quot;</span><span class="nt">&gt;</span>Quantity<span class="nt">&lt;/form:label&gt;</span> :
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;quantity&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;quantity&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;div&gt;</span>
            <span class="k">&lt;%-</span><span class="o">-</span> <span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">--</span><span class="k">%&gt;</span>
            <span class="nt">&lt;form:button&gt;</span>Add<span class="nt">&lt;/form:button&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/form:form&gt;</span>
    <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;${pageContext.request.contextPath}/cart&quot;</span><span class="nt">&gt;</span>Go to Cart<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(15)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">商品を追加するためのボタン。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>カート画面(JSP)</li>
</ul>
<blockquote>
<div><div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>Cart<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="k">&lt;%-</span><span class="o">-</span> <span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">--</span><span class="k">%&gt;</span>
    <span class="nt">&lt;spring:eval</span> <span class="na">var=</span><span class="s">&quot;cart&quot;</span> <span class="na">experssion=</span><span class="s">&quot;@sessionCart.cart&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Cart<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;c:choose&gt;</span>
        <span class="nt">&lt;c:when</span> <span class="na">test=</span><span class="s">&quot;${ empty cart.cartItems }&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div&gt;</span>Cart is empty.<span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/c:when&gt;</span>
        <span class="nt">&lt;c:otherwise&gt;</span>
            CART ID :
            ${f:h(cart.id)}
            <span class="nt">&lt;form:form</span> <span class="na">modelAttribute=</span><span class="s">&quot;cartForm&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;table</span> <span class="na">border=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;thead&gt;</span>
                        <span class="nt">&lt;tr&gt;</span>
                            <span class="nt">&lt;th&gt;</span>ID<span class="nt">&lt;/th&gt;</span>
                            <span class="nt">&lt;th&gt;</span>ITEM CODE<span class="nt">&lt;/th&gt;</span>
                            <span class="nt">&lt;th&gt;</span>QUANTITY<span class="nt">&lt;/th&gt;</span>
                        <span class="nt">&lt;/tr&gt;</span>
                    <span class="nt">&lt;/thead&gt;</span>
                    <span class="nt">&lt;tbody&gt;</span>
                        <span class="nt">&lt;c:forEach</span> <span class="na">var=</span><span class="s">&quot;item&quot;</span>
                            <span class="na">items=</span><span class="s">&quot;${cart.cartItems}&quot;</span>
                            <span class="na">varStatus=</span><span class="s">&quot;rowStatus&quot;</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;tr&gt;</span>
                                <span class="nt">&lt;td&gt;</span>${f:h(item.id)}<span class="nt">&lt;/td&gt;</span>
                                <span class="nt">&lt;td&gt;</span>${f:h(item.itemCode)}<span class="nt">&lt;/td&gt;</span>
                                <span class="nt">&lt;td&gt;</span>
                                    <span class="nt">&lt;form:input</span>
                                        <span class="na">path=</span><span class="s">&quot;cartItems[${rowStatus.index}].quantity&quot;</span> <span class="nt">/&gt;</span>
                                    <span class="nt">&lt;form:errors</span>
                                        <span class="na">path=</span><span class="s">&quot;cartItems[${rowStatus.index}].quantity&quot;</span> <span class="nt">/&gt;</span>
                                <span class="nt">&lt;/td&gt;</span>
                            <span class="nt">&lt;/tr&gt;</span>
                        <span class="nt">&lt;/c:forEach&gt;</span>
                    <span class="nt">&lt;/tbody&gt;</span>
                <span class="nt">&lt;/table&gt;</span>
                <span class="k">&lt;%-</span><span class="o">-</span> <span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="o">--</span><span class="k">%&gt;</span>
                <span class="nt">&lt;form:button</span> <span class="na">name=</span><span class="s">&quot;edit&quot;</span><span class="nt">&gt;</span>Save<span class="nt">&lt;/form:button&gt;</span>
            <span class="nt">&lt;/form:form&gt;</span>
            <span class="nt">&lt;div&gt;</span>
                <span class="k">&lt;%-</span><span class="o">-</span> <span class="p">(</span><span class="mi">18</span><span class="p">)</span> <span class="o">--</span><span class="k">%&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;${pageContext.request.contextPath}/order&quot;</span><span class="nt">&gt;</span>Go to Order<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/c:otherwise&gt;</span>
    <span class="nt">&lt;/c:choose&gt;</span>
    <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;${pageContext.request.contextPath}/item&quot;</span><span class="nt">&gt;</span>Back to Item<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(16)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SpEL式を用いてsessionスコープのBeanを参照する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(17)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">数量を更新するためのボタン。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(18)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">注文画面を表示するためのリンク。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>注文画面(JSP)</li>
</ul>
<blockquote>
<div><div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>Order<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;spring:eval</span> <span class="na">var=</span><span class="s">&quot;cart&quot;</span> <span class="na">experssion=</span><span class="s">&quot;@sessionCart.cart&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Order<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;table</span> <span class="na">border=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;thead&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;th&gt;</span>ID<span class="nt">&lt;/th&gt;</span>
                <span class="nt">&lt;th&gt;</span>ITEM CODE<span class="nt">&lt;/th&gt;</span>
                <span class="nt">&lt;th&gt;</span>QUANTITY<span class="nt">&lt;/th&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;/thead&gt;</span>
        <span class="nt">&lt;tbody&gt;</span>
            <span class="nt">&lt;c:forEach</span> <span class="na">var=</span><span class="s">&quot;item&quot;</span> <span class="na">items=</span><span class="s">&quot;${cart.cartItems}&quot;</span>
                <span class="na">varStatus=</span><span class="s">&quot;rowStatus&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;tr&gt;</span>
                    <span class="nt">&lt;td&gt;</span>${f:h(item.id)}<span class="nt">&lt;/td&gt;</span>
                    <span class="nt">&lt;td&gt;</span>${f:h(item.itemCode)}<span class="nt">&lt;/td&gt;</span>
                    <span class="nt">&lt;td&gt;</span>${f:h(item.quantity)}<span class="nt">&lt;/td&gt;</span>
                <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;/c:forEach&gt;</span>
        <span class="nt">&lt;/tbody&gt;</span>
    <span class="nt">&lt;/table&gt;</span>
    <span class="nt">&lt;form:form</span> <span class="na">modelAttribute=</span><span class="s">&quot;orderForm&quot;</span><span class="nt">&gt;</span>
        <span class="k">&lt;%-</span><span class="o">-</span> <span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="o">--</span><span class="k">%&gt;</span>
        <span class="nt">&lt;form:button&gt;</span>Order<span class="nt">&lt;/form:button&gt;</span>
    <span class="nt">&lt;/form:form&gt;</span>
    <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;${pageContext.request.contextPath}/cart&quot;</span><span class="nt">&gt;</span>Back to Cart<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;${pageContext.request.contextPath}/item&quot;</span><span class="nt">&gt;</span>Back to Item<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(19)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">注文するためのボタン。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>注文完了画面(JSP)</li>
</ul>
<blockquote>
<div><div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>Order Complete<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Order Complete<span class="nt">&lt;/h1&gt;</span>
    ORDER ID :
    ${f:h(order.id)}
    <span class="nt">&lt;table</span> <span class="na">border=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;thead&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;th&gt;</span>ID<span class="nt">&lt;/th&gt;</span>
                <span class="nt">&lt;th&gt;</span>ITEM CODE<span class="nt">&lt;/th&gt;</span>
                <span class="nt">&lt;th&gt;</span>QUANTITY<span class="nt">&lt;/th&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;/thead&gt;</span>
        <span class="nt">&lt;tbody&gt;</span>
            <span class="nt">&lt;c:forEach</span> <span class="na">var=</span><span class="s">&quot;item&quot;</span> <span class="na">items=</span><span class="s">&quot;${order.orderItems}&quot;</span>
                <span class="na">varStatus=</span><span class="s">&quot;rowStatus&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;tr&gt;</span>
                    <span class="nt">&lt;td&gt;</span>${f:h(item.id)}<span class="nt">&lt;/td&gt;</span>
                    <span class="nt">&lt;td&gt;</span>${f:h(item.itemCode)}<span class="nt">&lt;/td&gt;</span>
                    <span class="nt">&lt;td&gt;</span>${f:h(item.quantity)}<span class="nt">&lt;/td&gt;</span>
                <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;/c:forEach&gt;</span>
        <span class="nt">&lt;/tbody&gt;</span>
    <span class="nt">&lt;/table&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;${pageContext.request.contextPath}/item&quot;</span><span class="nt">&gt;</span>Back to Item<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
</div></blockquote>
<p></p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="Pagination.html" title="4.4. ページネーション"
             >next</a> |</li>
        <li class="right" >
          <a href="ExceptionHandling.html" title="4.2. 例外ハンドリング"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.7.0.SP1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >4. Webアプリ開発機能</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer">
      © Copyright 2013, NTT DATA Corporation. © Copyright 2013, NTT Corporation.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3.Theme is <a href="http://github.com/vimalkvn/solar-theme">Solar</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>
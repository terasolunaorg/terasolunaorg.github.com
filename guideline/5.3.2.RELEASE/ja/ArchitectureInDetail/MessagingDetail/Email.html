<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>8.1. E-mail送信(SMTP) &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.3.2.RELEASE documentation</title>
    <link rel="stylesheet" href="../../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '5.3.2.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="8.2. JMS(Java Message Service)" href="JMS.html" />
    <link rel="prev" title="8. メッセージ連携" href="index.html" /><script async src="https://www.googletagmanager.com/gtag/js?id=G-847V2Q99G8"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date()); gtag('config', 'G-847V2Q99G8');
</script>
<script src="../../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../../_static/solarized-dark.css" rel="stylesheet">
<link href="../../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="JMS.html" title="8.2. JMS(Java Message Service)"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="8. メッセージ連携"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.3.2.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">8. メッセージ連携</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">8.1. E-mail送信(SMTP)</a><ul>
<li><a class="reference internal" href="#overview">8.1.1. Overview</a><ul>
<li><a class="reference internal" href="#javamail">8.1.1.1. JavaMailについて</a></li>
<li><a class="reference internal" href="#spring-frameworkmail">8.1.1.2. Spring FrameworkのMail連携用コンポーネントについて</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">8.1.2. How to use</a><ul>
<li><a class="reference internal" href="#id3">8.1.2.1. 依存ライブラリについて</a></li>
<li><a class="reference internal" href="#javamailsender">8.1.2.2. JavaMailSenderの設定方法</a><ul>
<li><a class="reference internal" href="#id5">8.1.2.2.1. アプリケーションサーバ提供のメールセッションを使用する場合</a></li>
<li><a class="reference internal" href="#id6">8.1.2.2.2. アプリケーションサーバ提供のメールセッションを使用しない場合（認証なし）</a></li>
<li><a class="reference internal" href="#id7">8.1.2.2.3. アプリケーションサーバ提供のメールセッションを使用しない場合（認証あり）</a></li>
</ul>
</li>
<li><a class="reference internal" href="#simplemailmessage">8.1.2.3. SimpleMailMessageによるメール送信方法</a></li>
<li><a class="reference internal" href="#id8">8.1.2.4. MimeMessageによるメール送信方法</a><ul>
<li><a class="reference internal" href="#email-text">8.1.2.4.1. テキストメールの送信</a></li>
<li><a class="reference internal" href="#html">8.1.2.4.2. HTMLメールの送信</a></li>
<li><a class="reference internal" href="#email-attachment">8.1.2.4.3. 添付ファイル付きメールの送信</a></li>
<li><a class="reference internal" href="#email-inline-resource">8.1.2.4.4. インラインリソース付きメールの送信</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id12">8.1.2.5. メール送信時の例外について</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend">8.1.3. How to extend</a><ul>
<li><a class="reference internal" href="#id13">8.1.3.1. テンプレートを使用したメール本文の作成方法</a><ul>
<li><a class="reference internal" href="#freemarker">8.1.3.1.1. FreeMarkerを使用したメール本文の作成</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix">8.1.4. Appendix</a><ul>
<li><a class="reference internal" href="#iso-2022-jp">8.1.4.1. ISO-2022-JPのエンコードについての考慮</a></li>
<li><a class="reference internal" href="#email-note-of-when-sending">8.1.4.2. JavaMailでマルチバイト文字を使用する際の注意点</a></li>
<li><a class="reference internal" href="#email-header-injection">8.1.4.3. メールヘッダ・インジェクション対策</a></li>
<li><a class="reference internal" href="#email-processing-method">8.1.4.4. 処理方式</a><ul>
<li><a class="reference internal" href="#id19">8.1.4.4.1. データベースまたはメッセージキューに保持されたメール情報をもとにメール送信を行う</a></li>
</ul>
</li>
<li><a class="reference internal" href="#greenmail">8.1.4.5. GreenMailを利用したテスト</a></li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">8. メッセージ連携</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="JMS.html"
                        title="next chapter">8.2. JMS(Java Message Service)</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/ArchitectureInDetail/MessagingDetail/Email.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="e-mail-smtp">
<h1>8.1. E-mail送信(SMTP)<a class="headerlink" href="#e-mail-smtp" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="id1">
<p class="topic-title">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id25">Overview</a><ul>
<li><a class="reference internal" href="#javamail" id="id26">JavaMailについて</a></li>
<li><a class="reference internal" href="#spring-frameworkmail" id="id27">Spring FrameworkのMail連携用コンポーネントについて</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use" id="id28">How to use</a><ul>
<li><a class="reference internal" href="#id3" id="id29">依存ライブラリについて</a></li>
<li><a class="reference internal" href="#javamailsender" id="id30">JavaMailSenderの設定方法</a><ul>
<li><a class="reference internal" href="#id5" id="id31">アプリケーションサーバ提供のメールセッションを使用する場合</a></li>
<li><a class="reference internal" href="#id6" id="id32">アプリケーションサーバ提供のメールセッションを使用しない場合（認証なし）</a></li>
<li><a class="reference internal" href="#id7" id="id33">アプリケーションサーバ提供のメールセッションを使用しない場合（認証あり）</a></li>
</ul>
</li>
<li><a class="reference internal" href="#simplemailmessage" id="id34">SimpleMailMessageによるメール送信方法</a></li>
<li><a class="reference internal" href="#id8" id="id35">MimeMessageによるメール送信方法</a><ul>
<li><a class="reference internal" href="#email-text" id="id36">テキストメールの送信</a></li>
<li><a class="reference internal" href="#html" id="id37">HTMLメールの送信</a></li>
<li><a class="reference internal" href="#email-attachment" id="id38">添付ファイル付きメールの送信</a></li>
<li><a class="reference internal" href="#email-inline-resource" id="id39">インラインリソース付きメールの送信</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id12" id="id40">メール送信時の例外について</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend" id="id41">How to extend</a><ul>
<li><a class="reference internal" href="#id13" id="id42">テンプレートを使用したメール本文の作成方法</a><ul>
<li><a class="reference internal" href="#freemarker" id="id43">FreeMarkerを使用したメール本文の作成</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix" id="id44">Appendix</a><ul>
<li><a class="reference internal" href="#iso-2022-jp" id="id45">ISO-2022-JPのエンコードについての考慮</a></li>
<li><a class="reference internal" href="#email-note-of-when-sending" id="id46">JavaMailでマルチバイト文字を使用する際の注意点</a></li>
<li><a class="reference internal" href="#email-header-injection" id="id47">メールヘッダ・インジェクション対策</a></li>
<li><a class="reference internal" href="#email-processing-method" id="id48">処理方式</a><ul>
<li><a class="reference internal" href="#id19" id="id49">データベースまたはメッセージキューに保持されたメール情報をもとにメール送信を行う</a></li>
</ul>
</li>
<li><a class="reference internal" href="#greenmail" id="id50">GreenMailを利用したテスト</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id25">8.1.1. Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>本節では、SMTPによるE-mailの送信方法について説明する。</p>
<p>本ガイドラインでは、JavaMailのAPIとSpring Frameworkから提供されているMail連携用コンポーネントを利用することを前提としている。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">説明の対象としているのはメールを送信する部分のみである。
メール送信に係る処理方式については言及していない。
（<a class="reference internal" href="#email-processing-method"><span class="std std-ref">処理方式</span></a>において一例を紹介している。）</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="javamail">
<h3><a class="toc-backref" href="#id26">8.1.1.1. JavaMailについて</a><a class="headerlink" href="#javamail" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://java.net/projects/javamail/pages/Home">JavaMail</a>は、Javaでメールの送受信を行うためのAPIを提供している。
Java EEに含まれるものであるが、Java SEでも追加パッケージとして利用可能である。
JavaMailを利用することで、メール機能を容易にJavaアプリケーションに組み込むことができる。</p>
<p>なお、本ガイドラインでは、Spring FrameworkのMail連携用コンポーネントを利用する前提であるため、JavaMailのAPIについての詳細には触れていない。
JavaMailのAPI仕様については、<a class="reference external" href="http://download.oracle.com/otn-pub/jcp/java_mail-1_5-mrel2-eval-spec/JavaMail-1.5.pdf">JavaMail API Design Specification</a>を参照されたい。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>メールセッション</strong></p>
<p>メールセッション（<a class="reference external" href="http://docs.oracle.com/javaee/7/api/javax/mail/Session.html">Session</a>）は、メールサーバに接続する際に必要となる情報を管理する。</p>
<p>メールセッションを取得するには以下のような方法がある。</p>
<ul class="simple">
<li>典型的なエンタープライズアプリケーションにおいては、Java EEのコンテナで管理されたメールセッションをJNDI経由で取得する。</li>
<li>Tomcatの場合はリソースファクトリで定義したメールセッションをJNDI経由で取得する。</li>
<li>staticファクトリメソッドを利用してBean定義したメールセッションをDIコンテナから取得する。</li>
<li>Javaソースから直接<code class="docutils literal"><span class="pre">Session</span></code>のstaticファクトリメソッドを利用して取得する。</li>
</ul>
<p>なお、後述するSpringの<code class="docutils literal"><span class="pre">JavaMailSenderImpl</span></code>を使用すると、メールセッションを直接扱わずにメールサーバと接続することも可能である。</p>
<p>本ガイドラインでは、以下の二つの方法による実装例を紹介する。</p>
<ul class="last simple">
<li>メールセッションをJNDI経由で取得する方法</li>
<li>セッションを直接扱わずに<code class="docutils literal"><span class="pre">JavaMailSenderImpl</span></code>のプロパティに接続情報を指定する方法</li>
</ul>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="spring-frameworkmail">
<h3><a class="toc-backref" href="#id27">8.1.1.2. Spring FrameworkのMail連携用コンポーネントについて</a><a class="headerlink" href="#spring-frameworkmail" title="Permalink to this headline">¶</a></h3>
<p>Spring Frameworkはメール送信を行うためのコンポーネント（<code class="docutils literal"><span class="pre">org.springframework.mail</span></code>パッケージ）を提供している。
このパッケージに含まれるコンポーネントはメール送信に係る詳細なロジックを隠蔽し、低レベルのAPIハンドリング(JavaMailのAPI呼び出し)を代行する。</p>
<p>具体的な実装方法の説明を行う前に、Spring Frameworkが提供するメール送信用のコンポーネントがどのようにメールを送信しているかを説明する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/EmailOverview.png"><img alt="Constitution of Spring Mail" src="../../_images/EmailOverview.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="11%" />
<col width="22%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">コンポーネント</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アプリケーション</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JavaMailSender</span></code>のメソッドを呼び出し、メールの送信依頼を行う。</div>
<div class="line"><br /></div>
<div class="line">* 単純なメッセージを送信する場合は、<code class="docutils literal"><span class="pre">SimpleMailMessage</span></code>を生成し宛先や本文を設定することでメールを送信することもできる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JavaMailSender</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アプリケーションから指定された<code class="docutils literal"><span class="pre">MimeMessagePreparator</span></code>(JavaMailの<code class="docutils literal"><span class="pre">MimeMessage</span></code>を作成するためのコールバックインターフェース)を呼び出し、メール送信用のメッセージ(<code class="docutils literal"><span class="pre">MimeMessage</span></code>)の作成依頼を行う。</div>
<div class="line"><br /></div>
<div class="line">* <code class="docutils literal"><span class="pre">SimpleMailMessage</span></code>を使用してメッセージを送信する場合はこの処理は呼びだされない。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アプリケーション</div>
<div class="line">(<code class="docutils literal"><span class="pre">MimeMessagePreparator</span></code>)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">MimeMessageHelper</span></code>のメソッドを利用して、メール送信用のメッセージ(<code class="docutils literal"><span class="pre">MimeMessage</span></code>)を作成する。</div>
<div class="line"><br /></div>
<div class="line">* <code class="docutils literal"><span class="pre">SimpleMailMessage</span></code>を使用してメッセージを送信する場合はこの処理は呼びだされない。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JavaMailSender</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JavaMailのAPIを使用して、メールの送信依頼を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JavaMail</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">メールサーバへメッセージを送信する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p></p>
<p>本ガイドラインでは、以下のインタフェースやクラスを使用してメール送信処理を実装する方法について説明する。</p>
<ul>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">JavaMailSender</span></code></dt>
<dd><div class="first last line-block">
<div class="line">JavaMail用のメール送信インターフェース。</div>
<div class="line">JavaMailの<a class="reference external" href="http://docs.oracle.com/javaee/7/api/javax/mail/internet/MimeMessage.html">MimeMessage</a>とSpringの<code class="docutils literal"><span class="pre">SimpleMailMessage</span></code>の両方に対応している。</div>
<div class="line">また、JavaMailの<code class="docutils literal"><span class="pre">Session</span></code>の管理は<code class="docutils literal"><span class="pre">JavaMailSender</span></code>の実装クラスによって行われるため、メール送信処理をコーディングする際に<code class="docutils literal"><span class="pre">Session</span></code>を直接扱う必要がない。</div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">JavaMailSenderImpl</span></code></dt>
<dd><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JavaMailSender</span></code>インタフェースの実装クラス。</div>
<div class="line">このクラスでは、設定済みの<code class="docutils literal"><span class="pre">Session</span></code>をDIする方法と、プロパティに指定した接続情報から<code class="docutils literal"><span class="pre">Session</span></code>を作成する方法をサポートしている。</div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">MimeMessagePreparator</span></code></dt>
<dd><div class="first last line-block">
<div class="line">JavaMailの<code class="docutils literal"><span class="pre">MimeMessage</span></code>を作成するためのコールバックインターフェース。</div>
<div class="line"><code class="docutils literal"><span class="pre">JavaMailSender</span></code>の<code class="docutils literal"><span class="pre">send</span></code>メソッド内から呼び出される。</div>
<div class="line"><code class="docutils literal"><span class="pre">MimeMessagePreparator</span></code>の<code class="docutils literal"><span class="pre">prepare</span></code>メソッドで発生した例外は<code class="docutils literal"><span class="pre">MailPreparationException</span></code>（実行時例外）にラップされ再スローされる。</div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">MimeMessageHelper</span></code></dt>
<dd><div class="first last line-block">
<div class="line">JavaMailの<code class="docutils literal"><span class="pre">MimeMessage</span></code>の作成を容易にするためのヘルパークラス。</div>
<div class="line"><code class="docutils literal"><span class="pre">MimeMessageHelper</span></code>には、<code class="docutils literal"><span class="pre">MimeMessage</span></code>に値を設定するための便利なメソッドがいくつも用意されている。</div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">SimpleMailMessage</span></code></dt>
<dd><div class="first last line-block">
<div class="line">単純なメールメッセージを作成するためのクラス。</div>
<div class="line">英文のプレーンテキストメールを作成する際に使用できる。</div>
<div class="line">UTF-8等の特定のエンコード指定、HTMLメールや添付ファイル付きメールの送信、あるいはメールアドレスに個人名を付随させるといったリッチなメッセージの作成を行う際は、JavaMailの<code class="docutils literal"><span class="pre">MimeMessage</span></code>を使用する必要がある。</div>
</div>
</dd>
</dl>
</li>
</ul>
</div>
</div>
<div class="section" id="how-to-use">
<h2><a class="toc-backref" href="#id28">8.1.2. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id29">8.1.2.1. 依存ライブラリについて</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>Spring FrameworkのMail連携用コンポーネントを利用する場合、以下のライブラリが追加で必要となる。</p>
<ul class="simple">
<li><a class="reference external" href="https://java.net/projects/javamail/pages/Home">JavaMail</a></li>
</ul>
<div class="line-block">
<div class="line">上記ライブラリに対する依存関係を<code class="file docutils literal"><span class="pre">pom.xml</span></code>に追加する。</div>
<div class="line">マルチプロジェクト構成の場合は、domainプロジェクトの<code class="file docutils literal"><span class="pre">pom.xml</span></code>(<code class="file docutils literal"><span class="pre">projectName-domain/pom.xml</span></code>)に追加する。</div>
</div>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependencies&gt;</span>

    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.sun.mail<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>javax.mail<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>

<span class="nt">&lt;/dependencies&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JavaMailのライブラリをdependenciesに追加する。</div>
<div class="line">アプリケーションサーバ提供のメールセッションを使用する場合、<code class="docutils literal"><span class="pre">&lt;scope&gt;</span></code>を<code class="docutils literal"><span class="pre">provided</span></code>に設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">上記設定例は、依存ライブラリのバージョンを親プロジェクトである terasoluna-gfw-parent で管理する前提であるため、pom.xmlでのバージョンの指定は不要である。
上記の依存ライブラリはterasoluna-gfw-parentが利用している<a class="reference external" href="http://platform.spring.io/platform/">Spring IO Platform</a>で定義済みである。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="javamailsender">
<h3><a class="toc-backref" href="#id30">8.1.2.2. JavaMailSenderの設定方法</a><a class="headerlink" href="#javamailsender" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">JavaMailSender</span></code>をDIするためのBean定義を行う。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">マルチプロジェクト構成の場合は、envプロジェクトの<code class="file docutils literal"><span class="pre">projectName-env.xml</span></code>に設定することを推奨する。
なお、本ガイドラインでは、マルチプロジェクト構成を採用することを推奨している。</p>
</div>
<div class="section" id="id5">
<h4><a class="toc-backref" href="#id31">8.1.2.2.1. アプリケーションサーバ提供のメールセッションを使用する場合</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<p>アプリケーションサーバ提供のメールセッションを使用する場合の設定例を以下に示す。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils" id="id21">
<caption><span class="caption-text"><strong>アプリケーションサーバから提供されているメールセッション</strong></span><a class="headerlink" href="#id21" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="35%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">アプリケーションサーバ</th>
<th class="head">参照ページ</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>Apache Tomcat 8.5</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="http://tomcat.apache.org/tomcat-8.5-doc/jndi-resources-howto.html#JavaMail_Sessions">Apache Tomcat 8.5 User Guide(JNDI Resources HOW-TO)</a>(JavaMail Sessions)を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>Apache Tomcat 8.0</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="http://tomcat.apache.org/tomcat-8.0-doc/jndi-resources-howto.html#JavaMail_Sessions">Apache Tomcat 8.0 User Guide(JNDI Resources HOW-TO)</a>(JavaMail Sessions)を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>Oracle WebLogic Server 12c</td>
<td><a class="reference external" href="http://docs.oracle.com/middleware/1221/wls/WLACH/taskhelp/mail/CreateMailSessions.html">Oracle WebLogic Server 12.2.1.0 Documentation</a>を参照されたい。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>IBM WebSphere Application Server Version 9.0</td>
<td><a class="reference external" href="https://www-01.ibm.com/support/knowledgecenter/SSD28V_9.0.0/com.ibm.websphere.wlp.core.doc/ae/twlp_admin_javamail.html">WebSphere Application Server Version 9.0.0 documentation</a>を参照されたい。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>Red Hat JBoss Enterprise Application Platform Version 7.0</td>
<td><a class="reference external" href="https://access.redhat.com/documentation/en/red-hat-jboss-enterprise-application-platform/7.0/paged/configuration-guide/chapter-10-mail-subsystem">JBoss Enterprise Application Platform 7.0 Product Documentation</a>を参照されたい。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>Red Hat JBoss Enterprise Application Platform Version 6.4</td>
<td><a class="reference external" href="https://access.redhat.com/documentation/en-US/JBoss_Enterprise_Application_Platform/6.4/html/Administration_and_Configuration_Guide/chap-Mail_subsystem.html">JBoss Enterprise Application Platform 6.4 Product Documentation</a>を参照されたい。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>JNDI経由で取得したメールセッションをBeanとして登録するための設定を行う。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;jee:jndi-lookup</span> <span class="na">id=</span><span class="s">&quot;mailSession&quot;</span> <span class="na">jndi-name=</span><span class="s">&quot;mail/Session&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;jee:jndi-lookup&gt;</span></code>要素の<code class="docutils literal"><span class="pre">jndi-name</span></code>属性に、アプリケーションサーバ提供のメールセッションのJNDI名を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>次に、<code class="docutils literal"><span class="pre">JavaMailSender</span></code>をBean定義する。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;mailSender&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.mail.javamail.JavaMailSenderImpl&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;session&quot;</span> <span class="na">ref=</span><span class="s">&quot;mailSession&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JavaMailSenderImpl</span></code>をBean定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">session</span></code>プロパティに設定済みのメールセッションのBeanを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id6">
<h4><a class="toc-backref" href="#id32">8.1.2.2.2. アプリケーションサーバ提供のメールセッションを使用しない場合（認証なし）</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<p>認証が必要ない場合の設定例を以下に示す。</p>
<p><code class="docutils literal"><span class="pre">JavaMailSender</span></code>をBean定義する。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;mailSender&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.mail.javamail.JavaMailSenderImpl&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;host&quot;</span> <span class="na">value=</span><span class="s">&quot;${mail.smtp.host}&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;port&quot;</span> <span class="na">value=</span><span class="s">&quot;${mail.smtp.port}&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JavaMailSenderImpl</span></code>をBean定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">host</span></code>プロパティにSMTPサーバのホスト名を指定する。</div>
<div class="line">この例では、プロパティファイルで定義した値（キー「<code class="docutils literal"><span class="pre">mail.smtp.host</span></code>」に対する値）を設定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">port</span></code>プロパティにSMTPサーバのポート番号を指定する。</div>
<div class="line">この例では、プロパティファイルで定義した値（キー「<code class="docutils literal"><span class="pre">mail.smtp.port</span></code>」に対する値）を設定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">プロパティファイルについての詳細は、<a class="reference internal" href="../GeneralFuncDetail/PropertyManagement.html"><span class="doc">プロパティ管理</span></a> を参照されたい。</p>
</div>
</div>
<div class="section" id="id7">
<h4><a class="toc-backref" href="#id33">8.1.2.2.3. アプリケーションサーバ提供のメールセッションを使用しない場合（認証あり）</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<p>認証が必要な場合の設定例を以下に示す。</p>
<p><code class="docutils literal"><span class="pre">JavaMailSender</span></code>をBean定義する。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;mailSender&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.mail.javamail.JavaMailSenderImpl&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;host&quot;</span> <span class="na">value=</span><span class="s">&quot;${mail.smtp.host}&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;port&quot;</span> <span class="na">value=</span><span class="s">&quot;${mail.smtp.port}&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;username&quot;</span> <span class="na">value=</span><span class="s">&quot;${mail.smtp.user}&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span> <span class="na">value=</span><span class="s">&quot;${mail.smtp.password}&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;javaMailProperties&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;props&gt;</span>
            <span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">&quot;mail.smtp.auth&quot;</span><span class="nt">&gt;</span>true<span class="nt">&lt;/prop&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
        <span class="nt">&lt;/props&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">username</span></code>プロパティにSMTPサーバのユーザ名を指定する。</div>
<div class="line">この例では、プロパティファイルで定義した値（キー「<code class="docutils literal"><span class="pre">mail.smtp.user</span></code>」に対する値）を設定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">password</span></code>プロパティにSMTPサーバのパスワードを指定する。</div>
<div class="line">この例では、プロパティファイルで定義した値（キー「<code class="docutils literal"><span class="pre">mail.smtp.password</span></code>」に対する値）を設定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">javaMailProperties</span></code>プロパティにキー「<code class="docutils literal"><span class="pre">mail.smtp.auth</span></code>」として<code class="docutils literal"><span class="pre">true</span></code>を設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">プロパティファイルについての詳細は、<a class="reference internal" href="../GeneralFuncDetail/PropertyManagement.html"><span class="doc">プロパティ管理</span></a> を参照されたい。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">TLSによる接続が必要な場合、<code class="docutils literal"><span class="pre">javaMailProperties</span></code>プロパティにキー「<code class="docutils literal"><span class="pre">mail.smtp.starttls.enable</span></code>」として<code class="docutils literal"><span class="pre">true</span></code>を設定する。
なお、左記のとおり指定した場合でもSMTPサーバがSTARTTLSをサポートしていない場合は平文による通信が行われる。
必要に応じて<code class="docutils literal"><span class="pre">javaMailProperties</span></code>プロパティにキー「<code class="docutils literal"><span class="pre">mail.smtp.starttls.required</span></code>」として<code class="docutils literal"><span class="pre">true</span></code>を設定することで、STARTTLSを利用できない場合にエラーとすることも可能である。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="simplemailmessage">
<h3><a class="toc-backref" href="#id34">8.1.2.3. SimpleMailMessageによるメール送信方法</a><a class="headerlink" href="#simplemailmessage" title="Permalink to this headline">¶</a></h3>
<p>英文のプレーンテキストメール（エンコードの指定や添付ファイル等が不要なメール）を送信する場合は、Springが提供している<code class="docutils literal"><span class="pre">SimpleMailMessage</span></code>クラスを使用する。</p>
<p>以下に、<code class="docutils literal"><span class="pre">SimpleMailMessage</span></code>クラスを使用したメール送信方法を説明する。</p>
<p><strong>Bean定義例</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;templateMessage&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.mail.SimpleMailMessage&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;from&quot;</span> <span class="na">value=</span><span class="s">&quot;info@example.com&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;subject&quot;</span> <span class="na">value=</span><span class="s">&quot;Registration confirmation.&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">テンプレートとして<code class="docutils literal"><span class="pre">SimpleMailMessage</span></code>をBean定義する。</div>
<div class="line">テンプレートの<code class="docutils literal"><span class="pre">SimpleMailMessage</span></code>を利用するのは必須ではないが、メールメッセージで固定的な箇所（例えば送信元メールアドレス等）をテンプレート化しておくことで、メールメッセージ作成時に個別に設定する必要がなくなる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">from</span></code>プロパティにFromヘッダの内容を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">subject</span></code>プロパティにSubjectヘッダの内容を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>Javaクラスの実装例</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="n">JavaMailSender</span> <span class="n">mailSender</span><span class="p">;</span> <span class="c1">// (1)</span>

<span class="nd">@Inject</span>
<span class="n">SimpleMailMessage</span> <span class="n">templateMessage</span><span class="p">;</span> <span class="c1">// (2)</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">register</span><span class="p">(</span><span class="n">User</span> <span class="n">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// omitted</span>

    <span class="c1">// (3)</span>
    <span class="n">SimpleMailMessage</span> <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleMailMessage</span><span class="p">(</span><span class="n">templateMessage</span><span class="p">);</span>
    <span class="n">message</span><span class="p">.</span><span class="na">setTo</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getEmailAddress</span><span class="p">());</span>
    <span class="n">String</span> <span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Hi &quot;</span>
            <span class="o">+</span> <span class="n">user</span><span class="p">.</span><span class="na">getUserName</span><span class="p">()</span>
            <span class="o">+</span> <span class="s">&quot;, welcome to EXAMPLE.COM!\r\n&quot;</span>
            <span class="o">+</span> <span class="s">&quot;If you were not an intended recipient, Please notify the sender.&quot;</span><span class="p">;</span>
    <span class="n">message</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
    <span class="n">mailSender</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>

    <span class="c1">// omitted</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JavaMailSender</span></code>をインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">テンプレートとしてBean定義した<code class="docutils literal"><span class="pre">SimpleMailMessage</span></code>をインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">テンプレートのBeanを利用して<code class="docutils literal"><span class="pre">SimpleMailMessage</span></code>のインスタンスを生成し、Toヘッダと本文を設定して送信する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils" id="id22">
<caption><span class="caption-text"><strong>SimpleMailMessageで設定可能なプロパティ</strong></span><a class="headerlink" href="#id22" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="30%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">プロパティ</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">1.</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">from</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fromヘッダを設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">2.</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">to</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Toヘッダを設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">3.</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">cc</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Ccヘッダを設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">4.</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">bcc</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Bccヘッダを設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">5.</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">subject</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Subjectヘッダを設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">6.</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">replyTo</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Reply-Toヘッダを設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">7.</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">sentDate</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Dateヘッダを設定する。</div>
<div class="line">なお、明示的に設定しない場合は送信時にシステム時刻（<code class="docutils literal"><span class="pre">new</span> <span class="pre">Date()</span></code>）が自動設定される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">8.</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">text</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本文を設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p class="last">To、Cc、Bccに複数の宛先を設定する場合は配列にして設定する。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">メールヘッダを設定する場合、メールヘッダ・インジェクションに対する考慮が必要となる。
詳細は<a class="reference internal" href="#email-header-injection"><span class="std std-ref">メールヘッダ・インジェクション対策</span></a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id8">
<h3><a class="toc-backref" href="#id35">8.1.2.4. MimeMessageによるメール送信方法</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>英文以外のメールやHTMLメール、添付ファイルの送信を行う場合、
<code class="docutils literal"><span class="pre">javax.mail.internet.MimeMessage</span></code>クラスを使用する。
本ガイドラインでは<code class="docutils literal"><span class="pre">MimeMessageHelper</span></code>クラスを使用して<code class="docutils literal"><span class="pre">MimeMessage</span></code>を作成する方法を推奨している。</p>
<p>本項では、<code class="docutils literal"><span class="pre">MimeMessageHelper</span></code>クラスを使用した以下のメール送信方法を説明する。</p>
<ul class="simple">
<li><a class="reference internal" href="#email-text"><span class="std std-ref">テキストメールの送信</span></a></li>
<li><a class="reference internal" href="#email-html"><span class="std std-ref">HTMLメールの送信</span></a></li>
<li><a class="reference internal" href="#email-attachment"><span class="std std-ref">添付ファイル付きメールの送信</span></a></li>
<li><a class="reference internal" href="#email-inline-resource"><span class="std std-ref">インラインリソース付きメールの送信</span></a></li>
</ul>
<div class="section" id="email-text">
<span id="id9"></span><h4><a class="toc-backref" href="#id36">8.1.2.4.1. テキストメールの送信</a><a class="headerlink" href="#email-text" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">MimeMessageHelper</span></code>クラスを使用して、テキストメールを送信する実装例を以下に示す。</p>
<p><strong>Javaクラスの実装例</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="n">JavaMailSender</span> <span class="n">mailSender</span><span class="p">;</span> <span class="c1">// (1)</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">register</span><span class="p">(</span><span class="n">User</span> <span class="n">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// omitted</span>

    <span class="c1">// (2)</span>
    <span class="n">mailSender</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="k">new</span> <span class="n">MimeMessagePreparator</span><span class="p">()</span> <span class="p">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="p">(</span><span class="n">MimeMessage</span> <span class="n">mimeMessage</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
            <span class="n">MimeMessageHelper</span> <span class="n">helper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MimeMessageHelper</span><span class="p">(</span><span class="n">mimeMessage</span><span class="p">,</span>
                    <span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">.</span><span class="na">name</span><span class="p">());</span> <span class="c1">// (3)</span>
            <span class="n">helper</span><span class="p">.</span><span class="na">setFrom</span><span class="p">(</span><span class="s">&quot;EXAMPLE.COM &lt;info@example.com&gt;&quot;</span><span class="p">);</span> <span class="c1">// (4)</span>
            <span class="n">helper</span><span class="p">.</span><span class="na">setTo</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getEmailAddress</span><span class="p">());</span> <span class="c1">// (5)</span>
            <span class="n">helper</span><span class="p">.</span><span class="na">setSubject</span><span class="p">(</span><span class="s">&quot;Registration confirmation.&quot;</span><span class="p">);</span> <span class="c1">// (6)</span>
            <span class="n">String</span> <span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Hi &quot;</span>
                    <span class="o">+</span> <span class="n">user</span><span class="p">.</span><span class="na">getUserName</span><span class="p">()</span>
                    <span class="o">+</span> <span class="s">&quot;, welcome to EXAMPLE.COM!\r\n&quot;</span>
                    <span class="o">+</span> <span class="s">&quot;If you were not an intended recipient, Please notify the sender.&quot;</span><span class="p">;</span>
            <span class="n">helper</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="n">text</span><span class="p">);</span> <span class="c1">// (7)</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="c1">// omitted</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JavaMailSender</span></code>をインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JavaMailSender</span></code>の<code class="docutils literal"><span class="pre">send</span></code>メソッドを利用してメールを送信する。</div>
<div class="line">引数には<code class="docutils literal"><span class="pre">MimeMessagePreparator</span></code>を実装した匿名内部クラスを定義する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">文字コードを指定して、<code class="docutils literal"><span class="pre">MimeMessageHelper</span></code>のインスタンスを生成する。</div>
<div class="line">この例では、文字コードにUTF-8を指定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fromヘッダの内容を設定する。</div>
<div class="line">この例では、”名前 &lt;アドレス&gt;”の形式で設定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Toヘッダの内容を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Subjectヘッダの内容を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本文の内容を設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">メールヘッダを設定する場合、メールヘッダ・インジェクションに対する考慮が必要となる。
詳細は<a class="reference internal" href="#email-header-injection"><span class="std std-ref">メールヘッダ・インジェクション対策</span></a>を参照されたい。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">日本語のメールを送信する際、UTF-8をサポートしていないメールクライアントもサポートする必要がある場合はエンコードにISO-2022-JPを利用することも考えられる。
エンコードにISO-2022-JPを利用する際に考慮すべき事項について、<a class="reference internal" href="#email-iso-2022-jp"><span class="std std-ref">ISO-2022-JPのエンコードについての考慮</span></a>を参照されたい。</p>
</div>
</div>
<div class="section" id="html">
<span id="email-html"></span><h4><a class="toc-backref" href="#id37">8.1.2.4.2. HTMLメールの送信</a><a class="headerlink" href="#html" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">MimeMessageHelper</span></code>クラスを使用して、HTMLメールを送信する実装例を以下に示す。</p>
<p><strong>Javaクラスの実装例</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="n">JavaMailSender</span> <span class="n">mailSender</span><span class="p">;</span> <span class="c1">// (1)</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">register</span><span class="p">(</span><span class="n">User</span> <span class="n">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// omitted</span>

    <span class="c1">// (2)</span>
    <span class="n">mailSender</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="k">new</span> <span class="n">MimeMessagePreparator</span><span class="p">()</span> <span class="p">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="p">(</span><span class="n">MimeMessage</span> <span class="n">mimeMessage</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
            <span class="n">MimeMessageHelper</span> <span class="n">helper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MimeMessageHelper</span><span class="p">(</span><span class="n">mimeMessage</span><span class="p">,</span>
                    <span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">.</span><span class="na">name</span><span class="p">());</span> <span class="c1">// (3)</span>
            <span class="n">helper</span><span class="p">.</span><span class="na">setFrom</span><span class="p">(</span><span class="s">&quot;EXAMPLE.COM &lt;info@example.com&gt;&quot;</span><span class="p">);</span> <span class="c1">// (4)</span>
            <span class="n">helper</span><span class="p">.</span><span class="na">setTo</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getEmailAddress</span><span class="p">());</span> <span class="c1">// (5)</span>
            <span class="n">helper</span><span class="p">.</span><span class="na">setSubject</span><span class="p">(</span><span class="s">&quot;Registration confirmation.&quot;</span><span class="p">);</span> <span class="c1">// (6)</span>
            <span class="n">String</span> <span class="n">text</span> <span class="o">=</span> <span class="s">&quot;&lt;html&gt;&lt;body&gt;&lt;h3&gt;Hi &quot;</span>
                    <span class="o">+</span> <span class="n">user</span><span class="p">.</span><span class="na">getUserName</span><span class="p">()</span>
                    <span class="o">+</span> <span class="s">&quot;, welcome to EXAMPLE.COM!&lt;/h3&gt;&quot;</span>
                    <span class="o">+</span> <span class="s">&quot;If you were not an intended recipient, Please notify the sender.&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">;</span>
            <span class="n">helper</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span> <span class="c1">// (7)</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="c1">// omitted</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JavaMailSender</span></code>をインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JavaMailSender</span></code>の<code class="docutils literal"><span class="pre">send</span></code>メソッドを利用してメールを送信する。</div>
<div class="line">引数には<code class="docutils literal"><span class="pre">MimeMessagePreparator</span></code>を実装した匿名内部クラスを定義する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">文字コードを指定して、<code class="docutils literal"><span class="pre">MimeMessageHelper</span></code>のインスタンスを生成する。</div>
<div class="line">この例では、文字コードにUTF-8を指定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fromヘッダの内容を設定する。</div>
<div class="line">この例では、”名前 &lt;アドレス&gt;”の形式で設定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Toヘッダの内容を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Subjectヘッダの内容を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本文の内容を設定する。<code class="docutils literal"><span class="pre">setText</span></code>メソッドの第二引数に<code class="docutils literal"><span class="pre">true</span></code>を指定することで、Content-Typeがtext/htmlになる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">メール本文のHTMLを生成する際に外部から入力された値を使用する場合はXSS攻撃への対策を行うこと。</p>
</div>
</div>
<div class="section" id="email-attachment">
<span id="id10"></span><h4><a class="toc-backref" href="#id38">8.1.2.4.3. 添付ファイル付きメールの送信</a><a class="headerlink" href="#email-attachment" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">MimeMessageHelper</span></code>クラスを使用して、添付ファイル付きメールを送信する実装例を以下に示す。</p>
<p><strong>Javaクラスの実装例</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="n">JavaMailSender</span> <span class="n">mailSender</span><span class="p">;</span> <span class="c1">// (1)</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">register</span><span class="p">(</span><span class="n">User</span> <span class="n">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// omitted</span>

    <span class="c1">// (2)</span>
    <span class="n">mailSender</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="k">new</span> <span class="n">MimeMessagePreparator</span><span class="p">()</span> <span class="p">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="p">(</span><span class="n">MimeMessage</span> <span class="n">mimeMessage</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
            <span class="n">MimeMessageHelper</span> <span class="n">helper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MimeMessageHelper</span><span class="p">(</span><span class="n">mimeMessage</span><span class="p">,</span>
                    <span class="kc">true</span><span class="p">,</span> <span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">.</span><span class="na">name</span><span class="p">());</span> <span class="c1">// (3)</span>
            <span class="n">helper</span><span class="p">.</span><span class="na">setFrom</span><span class="p">(</span><span class="s">&quot;EXAMPLE.COM &lt;info@example.com&gt;&quot;</span><span class="p">);</span> <span class="c1">// (4)</span>
            <span class="n">helper</span><span class="p">.</span><span class="na">setTo</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getEmailAddress</span><span class="p">());</span> <span class="c1">// (5)</span>
            <span class="n">helper</span><span class="p">.</span><span class="na">setSubject</span><span class="p">(</span><span class="s">&quot;Registration confirmation.&quot;</span><span class="p">);</span> <span class="c1">// (6)</span>
            <span class="n">String</span> <span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Hi &quot;</span>
                    <span class="o">+</span> <span class="n">user</span><span class="p">.</span><span class="na">getUserName</span><span class="p">()</span>
                    <span class="o">+</span> <span class="s">&quot;, welcome to EXAMPLE.COM!\r\n&quot;</span>
                    <span class="o">+</span> <span class="s">&quot;Please find attached the file.\r\n\r\n&quot;</span>
                    <span class="o">+</span> <span class="s">&quot;If you were not an intended recipient, Please notify the sender.&quot;</span><span class="p">;</span>
            <span class="n">helper</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="n">text</span><span class="p">);</span> <span class="c1">// (7)</span>
            <span class="n">ClassPathResource</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathResource</span><span class="p">(</span><span class="s">&quot;doc/quickstart.pdf&quot;</span><span class="p">);</span>
            <span class="n">helper</span><span class="p">.</span><span class="na">addAttachment</span><span class="p">(</span><span class="s">&quot;QuickStart.pdf&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span> <span class="c1">// (8)</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="c1">// omitted</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JavaMailSender</span></code>をインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JavaMailSender</span></code>の<code class="docutils literal"><span class="pre">send</span></code>メソッドを利用してメールを送信する。</div>
<div class="line">引数には<code class="docutils literal"><span class="pre">MimeMessagePreparator</span></code>を実装した匿名内部クラスを定義する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">文字コードを指定して、<code class="docutils literal"><span class="pre">MimeMessageHelper</span></code>のインスタンスを生成する。</div>
<div class="line">この例では、文字コードにUTF-8を指定している。</div>
<div class="line"><code class="docutils literal"><span class="pre">MimeMessageHelper</span></code>のコンストラクタの第二引数に<code class="docutils literal"><span class="pre">true</span></code>を指定することで、マルチパートモード（デフォルトの<code class="docutils literal"><span class="pre">MULTIPART_MODE_MIXED_RELATED</span></code>）になる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fromヘッダの内容を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Toヘッダの内容を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Subjectヘッダの内容を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本文の内容を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">添付ファイル名を指定して添付するファイルを設定する。</div>
<div class="line">この例では、<code class="docutils literal"><span class="pre">QuickStart.pdf</span></code>というファイル名で、クラスパス上にある<code class="file docutils literal"><span class="pre">doc/quickstart.pdf</span></code>というファイルを添付している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="email-inline-resource">
<span id="id11"></span><h4><a class="toc-backref" href="#id39">8.1.2.4.4. インラインリソース付きメールの送信</a><a class="headerlink" href="#email-inline-resource" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">MimeMessageHelper</span></code>クラスを使用して、インラインリソース付きメールを送信する実装例を以下に示す。</p>
<p><strong>Javaクラスの実装例</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="n">JavaMailSender</span> <span class="n">mailSender</span><span class="p">;</span> <span class="c1">// (1)</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">register</span><span class="p">(</span><span class="n">User</span> <span class="n">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// omitted</span>

    <span class="c1">// (2)</span>
    <span class="n">mailSender</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="k">new</span> <span class="n">MimeMessagePreparator</span><span class="p">()</span> <span class="p">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="p">(</span><span class="n">MimeMessage</span> <span class="n">mimeMessage</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
            <span class="n">MimeMessageHelper</span> <span class="n">helper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MimeMessageHelper</span><span class="p">(</span><span class="n">mimeMessage</span><span class="p">,</span>
                    <span class="kc">true</span><span class="p">,</span> <span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">.</span><span class="na">name</span><span class="p">());</span> <span class="c1">// (3)</span>
            <span class="n">helper</span><span class="p">.</span><span class="na">setFrom</span><span class="p">(</span><span class="s">&quot;EXAMPLE.COM &lt;info@example.com&gt;&quot;</span><span class="p">);</span> <span class="c1">// (4)</span>
            <span class="n">helper</span><span class="p">.</span><span class="na">setTo</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getEmailAddress</span><span class="p">());</span> <span class="c1">// (5)</span>
            <span class="n">helper</span><span class="p">.</span><span class="na">setSubject</span><span class="p">(</span><span class="s">&quot;Registration confirmation.&quot;</span><span class="p">);</span> <span class="c1">// (6)</span>
            <span class="n">String</span> <span class="n">cid</span> <span class="o">=</span> <span class="s">&quot;identifier1234&quot;</span><span class="p">;</span>
            <span class="n">String</span> <span class="n">text</span> <span class="o">=</span> <span class="s">&quot;&lt;html&gt;&lt;body&gt;&lt;img src=&#39;cid:&quot;</span>
                    <span class="o">+</span> <span class="n">cid</span>
                    <span class="o">+</span> <span class="s">&quot;&#39; /&gt;&lt;h3&gt;Hi &quot;</span>
                    <span class="o">+</span> <span class="n">user</span><span class="p">.</span><span class="na">getUserName</span><span class="p">()</span>
                    <span class="o">+</span> <span class="s">&quot;, welcome to EXAMPLE.COM!\r\n&lt;/h3&gt;&quot;</span>
                    <span class="o">+</span> <span class="s">&quot;If you were not an intended recipient, Please notify the sender.&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">;</span>
            <span class="n">helper</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span> <span class="c1">// (7)</span>
            <span class="n">ClassPathResource</span> <span class="n">res</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathResource</span><span class="p">(</span><span class="s">&quot;image/logo.jpg&quot;</span><span class="p">);</span>
            <span class="n">helper</span><span class="p">.</span><span class="na">addInline</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span> <span class="c1">// (8)</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="c1">// omitted</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JavaMailSender</span></code>をインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JavaMailSender</span></code>の<code class="docutils literal"><span class="pre">send</span></code>メソッドを利用してメールを送信する。</div>
<div class="line">引数には<code class="docutils literal"><span class="pre">MimeMessagePreparator</span></code>を実装した匿名内部クラスを定義する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">文字コードを指定して、<code class="docutils literal"><span class="pre">MimeMessageHelper</span></code>のインスタンスを生成する。</div>
<div class="line">この例では、文字コードにUTF-8を指定している。</div>
<div class="line"><code class="docutils literal"><span class="pre">MimeMessageHelper</span></code>のコンストラクタの第二引数に<code class="docutils literal"><span class="pre">true</span></code>を指定することで、マルチパートモードになる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fromヘッダの内容を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Toヘッダの内容を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Subjectヘッダの内容を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本文の内容を設定する。<code class="docutils literal"><span class="pre">setText</span></code>メソッドの第二引数に<code class="docutils literal"><span class="pre">true</span></code>を指定することで、Content-Typeがtext/htmlになる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">インラインリソースのコンテンツIDを指定してインラインリソースを設定する。</div>
<div class="line">この例では、<code class="docutils literal"><span class="pre">identifier1234</span></code>というコンテンツIDで、クラスパス上にある<code class="file docutils literal"><span class="pre">image/logo.jpg</span></code>というファイルを設定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">addInline</span></code>メソッドは、<code class="docutils literal"><span class="pre">setText</span></code>メソッドの後に呼び出すこと。
そうしないと、メールクライアントがインラインリソースを正しく参照できないことがある。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id12">
<h3><a class="toc-backref" href="#id40">8.1.2.5. メール送信時の例外について</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">JavaMailSender</span></code>の<code class="docutils literal"><span class="pre">send</span></code>メソッドを利用してメール送信を行う際に発生する例外は<code class="docutils literal"><span class="pre">org.springframework.mail.MailException</span></code>を継承した例外である。
<code class="docutils literal"><span class="pre">MailException</span></code>を継承した例外クラスと、それぞれの例外の発生条件について、以下の表に示す。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils" id="id23">
<caption><span class="caption-text"><strong>メール送信時の例外</strong></span><a class="headerlink" href="#id23" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="35%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">例外クラス</th>
<th class="head">発生条件</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><a class="reference external" href="http://docs.spring.io/spring/docs/4.3.14.RELEASE/javadoc-api/org/springframework/mail/MailAuthenticationException.html">MailAuthenticationException</a></td>
<td><div class="first last line-block">
<div class="line">認証失敗時に発生する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><a class="reference external" href="http://docs.spring.io/spring/docs/4.3.14.RELEASE/javadoc-api/org/springframework/mail/MailParseException.html">MailParseException</a></td>
<td><div class="first last line-block">
<div class="line">メールメッセージのプロパティに不正な値が設定されている場合に発生する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><a class="reference external" href="http://docs.spring.io/spring/docs/4.3.14.RELEASE/javadoc-api/org/springframework/mail/MailPreparationException.html">MailPreparationException</a></td>
<td><div class="first last line-block">
<div class="line">メールメッセージを作成中に想定外のエラーが起きた場合に発生する。
想定外のエラーとしては、例えばテンプレートライブラリで発生するエラーといったものがある。</div>
<div class="line"><code class="docutils literal"><span class="pre">MimeMessagePreparator</span></code>で発生した例外が<code class="docutils literal"><span class="pre">MailPreparationException</span></code>にラップされてスローされる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><a class="reference external" href="http://docs.spring.io/spring/docs/4.3.14.RELEASE/javadoc-api/org/springframework/mail/MailSendException.html">MailSendException</a></td>
<td><div class="first last line-block">
<div class="line">メールの送信エラーが起きた場合に発生する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">特定の例外に対するエラー画面遷移については、 <a class="reference internal" href="../WebApplicationDetail/ExceptionHandling.html"><span class="doc">例外ハンドリング</span></a> を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="how-to-extend">
<h2><a class="toc-backref" href="#id41">8.1.3. How to extend</a><a class="headerlink" href="#how-to-extend" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id13">
<h3><a class="toc-backref" href="#id42">8.1.3.1. テンプレートを使用したメール本文の作成方法</a><a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<p>上で示した実装例のようにJavaソースでメール本文を直接組み立てるのは、以下の理由から推奨しない。</p>
<ul class="simple">
<li>メール本文をJavaソースで組み立てるのは可読性が悪くエラーを作りやすい。</li>
<li>表示ロジックとビジネスロジックの境界が曖昧となる。</li>
<li>メール本文のデザインを変更するために、Javaソースの修正、コンパイル、デプロイが必要になる。</li>
</ul>
<p>よって、メール本文のデザインを定義するためにテンプレートライブラリを使用することを推奨する。
特にメール本文が複雑になるような場合はテンプレートライブラリを使用すべきである。</p>
<div class="section" id="freemarker">
<h4><a class="toc-backref" href="#id43">8.1.3.1.1. FreeMarkerを使用したメール本文の作成</a><a class="headerlink" href="#freemarker" title="Permalink to this headline">¶</a></h4>
<p>本ガイドラインでは、テンプレートライブラリとして<a class="reference external" href="http://freemarker.org/">FreeMarker</a>を使用する方法について説明する。</p>
<ul>
<li><p class="first">FreeMarkerを使用するために、依存ライブラリを設定する。</p>
<blockquote>
<div><p><strong>pom.xmlの設定例</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependencies&gt;</span>

    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.freemarker<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>freemarker<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>

<span class="nt">&lt;/dependencies&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">FreeMarkerのライブラリをdependenciesに追加する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">上記設定例は、依存ライブラリのバージョンを親プロジェクトである terasoluna-gfw-parent で管理する前提であるため、pom.xmlでのバージョンの指定は不要である。
上記の依存ライブラリはterasoluna-gfw-parentが利用している<a class="reference external" href="http://platform.spring.io/platform/">Spring IO Platform</a>で定義済みである。</p>
</div>
</div></blockquote>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">freemarker.template.Configuration</span></code>を生成するためのFactoryBeanをBean定義する。</p>
<blockquote>
<div><p><strong>Bean定義ファイルの設定例</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;freemarkerConfiguration&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.ui.freemarker.FreeMarkerConfigurationFactoryBean&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;templateLoaderPath&quot;</span> <span class="na">value=</span><span class="s">&quot;classpath:/META-INF/freemarker/&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultEncoding&quot;</span> <span class="na">value=</span><span class="s">&quot;UTF-8&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">FreeMarkerConfigurationFactoryBean</span></code>をBean定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">templateLoaderPath</span></code>プロパティにテンプレートファイルの格納された場所を指定する。</div>
<div class="line">この例では、クラスパス上にある<code class="file docutils literal"><span class="pre">META-INF/freemarker/</span></code>ディレクトリを設定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">defaultEncoding</span></code>プロパティにデフォルトのエンコードを指定する。</div>
<div class="line">この例では、UTF-8を設定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">上記以外の設定については、<a class="reference external" href="http://docs.spring.io/spring/docs/4.3.14.RELEASE/javadoc-api/org/springframework/ui/freemarker/FreeMarkerConfigurationFactoryBean.html">FreeMarkerConfigurationFactoryBeanのJavaDoc</a>を参照されたい。
また、FreeMarker自体の設定については、<a class="reference external" href="http://freemarker.org/docs/pgui_config.html">FreeMarker Manual (Programmer’s Guide / The Configuration)</a>を参照されたい。</p>
</div>
</div></blockquote>
</li>
<li><p class="first">メール本文のテンプレートファイルを作成する。</p>
<blockquote>
<div><p><strong>テンプレートファイルの設定例</strong></p>
<div class="highlight-text"><div class="highlight"><pre><span></span>&lt;#escape x as x?html&gt; &lt;#-- (1) --&gt;
&lt;html&gt;
    &lt;body&gt;
        &lt;h3&gt;Hi ${userName}, welcome to TERASOLUNA.ORG!&lt;/h3&gt; &lt;#-- (2) --&gt;

        &lt;div&gt;
            If you were not an intended recipient, Please notify the sender.
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;
&lt;/#escape&gt;
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">XSS攻撃への対策としてHTMLエスケープを行うように設定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">データモデルに設定された<code class="docutils literal"><span class="pre">userName</span></code>の値を埋め込む。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">テンプレート言語（FTL）の詳細については、<a class="reference external" href="http://freemarker.org/docs/ref.html">FreeMarker Manual (Template Language Reference)</a>を参照されたい。</p>
</div>
</div></blockquote>
</li>
<li><p class="first">テンプレートを使用してメール本文を生成し、メール送信する。</p>
<blockquote>
<div><p><strong>Javaクラスの実装例</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="n">JavaMailSender</span> <span class="n">mailSender</span><span class="p">;</span>

<span class="nd">@Inject</span>
<span class="n">Configuration</span> <span class="n">freemarkerConfiguration</span><span class="p">;</span> <span class="c1">// (1)</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">register</span><span class="p">(</span><span class="n">User</span> <span class="n">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// omitted</span>

    <span class="n">mailSender</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="k">new</span> <span class="n">MimeMessagePreparator</span><span class="p">()</span> <span class="p">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="p">(</span><span class="n">MimeMessage</span> <span class="n">mimeMessage</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
            <span class="n">MimeMessageHelper</span> <span class="n">helper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MimeMessageHelper</span><span class="p">(</span><span class="n">mimeMessage</span><span class="p">,</span>
                    <span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">.</span><span class="na">name</span><span class="p">());</span>
            <span class="n">helper</span><span class="p">.</span><span class="na">setFrom</span><span class="p">(</span><span class="s">&quot;EXAMPLE.COM &lt;info@example.com&gt;&quot;</span><span class="p">);</span>
            <span class="n">helper</span><span class="p">.</span><span class="na">setTo</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getEmailAddress</span><span class="p">());</span>
            <span class="n">helper</span><span class="p">.</span><span class="na">setSubject</span><span class="p">(</span><span class="s">&quot;Registration confirmation.&quot;</span><span class="p">);</span>
            <span class="n">Template</span> <span class="n">template</span> <span class="o">=</span> <span class="n">freemarkerConfiguration</span>
                    <span class="p">.</span><span class="na">getTemplate</span><span class="p">(</span><span class="s">&quot;registration-confirmation.ftl&quot;</span><span class="p">);</span> <span class="c1">// (2)</span>
            <span class="n">String</span> <span class="n">text</span> <span class="o">=</span> <span class="n">FreeMarkerTemplateUtils</span>
                    <span class="p">.</span><span class="na">processTemplateIntoString</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">user</span><span class="p">);</span> <span class="c1">// (3)</span>
            <span class="n">helper</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="c1">// omitted</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="http://freemarker.org/docs/api/freemarker/template/Configuration.html">Configuration</a>をインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Configuration</span></code>の<code class="docutils literal"><span class="pre">getTemplate</span></code>メソッドを利用して<a class="reference external" href="http://freemarker.org/docs/api/freemarker/template/Template.html">Template</a>を取得する。</div>
<div class="line">この例では、テンプレートファイルとして”registration-confirmation.ftl”を指定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得した<code class="docutils literal"><span class="pre">Template</span></code>をもとに、<code class="docutils literal"><span class="pre">org.springframework.ui.freemarker.FreeMarkerTemplateUtils</span></code>の<code class="docutils literal"><span class="pre">processTemplateIntoString</span></code>メソッドを利用してテンプレートから文字列を生成する。</div>
<div class="line">この例では、データモデルとして<code class="docutils literal"><span class="pre">userName</span></code>プロパティを持つ<code class="docutils literal"><span class="pre">User</span></code>オブジェクト（JavaBeans）を指定している。
これにより、テンプレートファイルの<code class="docutils literal"><span class="pre">${userName}</span></code>の箇所に<code class="docutils literal"><span class="pre">userName</span></code>プロパティの値が埋め込まれる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="appendix">
<h2><a class="toc-backref" href="#id44">8.1.4. Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this headline">¶</a></h2>
<div class="section" id="iso-2022-jp">
<span id="email-iso-2022-jp"></span><h3><a class="toc-backref" href="#id45">8.1.4.1. ISO-2022-JPのエンコードについての考慮</a><a class="headerlink" href="#iso-2022-jp" title="Permalink to this headline">¶</a></h3>
<p>日本語のメールを送信する際、送信したメールを受信するメールクライアントを限定できない場合は、エンコードにISO-2022-JPを利用することを検討する必要がある。
この理由としては、レガシーなメールクライアントがUTF-8に対応していない場合を考慮するためである。</p>
<p>MS932で入力された文字列に対し、エンコードにISO-2022-JPをはじめとするJIS X 0208の文字集合をベースとしたエンコードを設定した場合、
以下の表に記載する7文字において文字化けが発生する。</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="20%" />
<col width="15%" />
<col width="15%" />
<col width="15%" />
<col width="15%" />
<col width="20%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">変換前</th>
<th class="head">&#160;</th>
<th class="head">&#160;</th>
<th class="head">変換後</th>
<th class="head">&#160;</th>
<th class="head">&#160;</th>
</tr>
<tr class="row-even"><th class="head"><div class="first last line-block">
<div class="line">MS932</div>
<div class="line">入力文字</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">入力値</div>
<div class="line">（SJIS）</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">Unicode</div>
<div class="line">（UTF-16）</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">Unicode</div>
<div class="line">（UTF-16）</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">ISO-2022-JP</div>
<div class="line">（JIS）</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">JIS X 0208</div>
<div class="line">代替文字</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">―（全角ハイフン）</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">815D</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">U+2015</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">U+2014</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">213E</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">—（EM ダッシュ）</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">－（ハイフンマイナス）</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">817C</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">U+FF0D</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">U+2212</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">215D</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">−（全角マイナス）</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">～（全角チルド）</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">8160</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">U+FF5E</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">U+301C</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">2141</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">〜（波ダッシュ）</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">∥（平行記号）</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">8161</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">U+2225</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">U+2016</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">2142</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">‖（双柱）</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">￠（全角セント記号）</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">8191</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">U+FFE0</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">U+00A2</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">2171</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">¢（セント記号）</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">￡（全角ポンド記号）</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">8192</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">U+FFE1</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">U+00A3</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">2172</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">£（ポンド記号）</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">￢（全角否定記号）</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">81CA</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">U+FFE2</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">U+00AC</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">224C</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">¬（否定記号）</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>この問題は、Unicodeを介して文字コード変換を行う際に、MS932に有りJIS X 0208に無い文字が存在するためであり、
文字化けを回避するためには、文字化けする文字について代替文字に文字コードを置き換えるなどの対処を行う必要がある。
なお、後述するx-windows-iso2022jpを使用する場合、変換処理は不要である。</p>
<p>以下に、変換処理の実装例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">convertISO2022JPCharacters</span><span class="p">(</span><span class="n">String</span> <span class="n">targetStr</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">targetStr</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">char</span><span class="o">[]</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">targetStr</span><span class="p">.</span><span class="na">toCharArray</span><span class="p">();</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ch</span><span class="p">.</span><span class="na">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// &#39;―&#39;（全角ハイフン）</span>
        <span class="k">case</span> <span class="sc">&#39;\u2015&#39;</span><span class="p">:</span>
            <span class="n">ch</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="sc">&#39;\u2014&#39;</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="c1">// &#39;－&#39;（全角マイナス）</span>
        <span class="k">case</span> <span class="sc">&#39;\uff0d&#39;</span><span class="p">:</span>
            <span class="n">ch</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="sc">&#39;\u2212&#39;</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="c1">// &#39;～&#39;（波ダッシュ）</span>
        <span class="k">case</span> <span class="sc">&#39;\uff5e&#39;</span><span class="p">:</span>
            <span class="n">ch</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="sc">&#39;\u301c&#39;</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="c1">// &#39;∥&#39;（双柱）</span>
        <span class="k">case</span> <span class="sc">&#39;\u2225&#39;</span><span class="p">:</span>
            <span class="n">ch</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="sc">&#39;\u2016&#39;</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="c1">// &#39;￠&#39;（セント記号)</span>
        <span class="k">case</span> <span class="sc">&#39;\uffe0&#39;</span><span class="p">:</span>
            <span class="n">ch</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="sc">&#39;\u00A2&#39;</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="c1">// &#39;￡&#39;（ポンド記号）</span>
        <span class="k">case</span> <span class="sc">&#39;\uffe1&#39;</span><span class="p">:</span>
            <span class="n">ch</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="sc">&#39;\u00A3&#39;</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="c1">// &#39;￢&#39;（否定記号）</span>
        <span class="k">case</span> <span class="sc">&#39;\uffe2&#39;</span><span class="p">:</span>
            <span class="n">ch</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="sc">&#39;\u00AC&#39;</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="p">:</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Unicodeへのマッピング時の問題であるため、入力値の文字コードに依らず変換は必要である。
変換対象となるのは日本語を含む文字列が設定される可能性のあるヘッダおよび本文の文字列である。
日本語を含む可能性があり一般的によく使われると考えられるヘッダとしては、From、To、Cc、Bcc、Reply-To、Subjectが挙げられる。</p>
</div>
<p>また、エンコードにISO-2022-JPを設定する場合、以下のような範囲外となる拡張文字が文字化けする。</p>
<div class="figure align-center" id="id24">
<a class="reference internal image-reference" href="../../_images/EmailOutofEscapeCharacter.png"><img alt="Out of EscapeCharacter" src="../../_images/EmailOutofEscapeCharacter.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>図-範囲外となる拡張文字の例</strong></span></p>
</div>
<p>これらの文字は本来使用すべきではない。
もし、これらの文字を使用する必要がある場合、JVMの起動オプションとして以下のように設定することで
ISO-2022-JPのエンコードが指定された場合にx-windows-iso2022jpでマッピングするように差し替えることが可能である。</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>-Dsun.nio.cs.map=x-windows-iso2022jp/ISO-2022-JP
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">x-windows-iso2022jpはISO-2022-JPの規格と異なるマッピング（MS932ベース）を含むISO-2022-JP実装である。
メールヘッダでISO-2022-JPのエンコードが指定された場合に範囲外の拡張文字を扱えるような実装となっているかはメールクライアントに依存する。
このため、x-windows-iso2022jpを使用してマッピングした場合でも、すべてのメールクライアントで確実に文字化けしないことが保証されるわけではない。</p>
</div>
<p>拡張文字を代替文字に変換してもよい場合、前述した7文字と同様にアプリケーションで独自に変換を行う方法も合わせて検討されたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="email-note-of-when-sending">
<span id="id16"></span><h3><a class="toc-backref" href="#id46">8.1.4.2. JavaMailでマルチバイト文字を使用する際の注意点</a><a class="headerlink" href="#email-note-of-when-sending" title="Permalink to this headline">¶</a></h3>
<p>JavaMailでは、送信するメールの本文の終端がマルチバイト文字で終わっていると、終端に余計な文字（「?」や「w)」等）が出力される場合がある。
本事象は以下の方法で回避できる。</p>
<ul class="simple">
<li>メール本文の終端文字を半角文字にする</li>
<li>メール本文の終端を改行コード（CRLF）にする</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="email-header-injection">
<span id="id17"></span><h3><a class="toc-backref" href="#id47">8.1.4.3. メールヘッダ・インジェクション対策</a><a class="headerlink" href="#email-header-injection" title="Permalink to this headline">¶</a></h3>
<p>メールヘッダ・インジェクション攻撃が成功すると、本来意図していない宛先にメール送信され、
迷惑メール送信の踏み台に悪用される可能性がある。
メールヘッダ（Subject等）の内容に外部から入力された文字列を利用する場合、メールヘッダ・インジェクション攻撃への対策が必要となる。</p>
<p>例えば、<code class="docutils literal"><span class="pre">MimeMessageHelper</span></code>の<code class="docutils literal"><span class="pre">setSubject</span></code>メソッドで以下の文字列を設定すると、Bccヘッダを追加し本文を改ざんすることが可能となる。</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>Notification\r\nBcc: attacker@exapmle.com\r\n\r\nManipulated body.
</pre></div>
</div>
<p>メールヘッダ・インジェクション攻撃への対策としては、以下のような方法が考えられる。</p>
<ul class="simple">
<li>メールヘッダに設定する内容は固定値とし、外部から入力された文字列はすべてメール本文に出力する。</li>
<li>メールヘッダに設定する内容に改行文字が含まれないことをチェックする。</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="email-processing-method">
<span id="id18"></span><h3><a class="toc-backref" href="#id48">8.1.4.4. 処理方式</a><a class="headerlink" href="#email-processing-method" title="Permalink to this headline">¶</a></h3>
<p>メール送信は時間のかかる処理であるため、Webアプリケーションのリクエストの中で送信処理を行うと応答時間が長くなってしまう。
このため、通常はWebアプリケーションのリクエストの中では送信処理を行わず、非同期でメール送信を行う処理方式とすることが多い。
メール送信の処理方式について詳細については言及しないが、以下に一例を示すので参考にされたい。</p>
<div class="section" id="id19">
<h4><a class="toc-backref" href="#id49">8.1.4.4.1. データベースまたはメッセージキューに保持されたメール情報をもとにメール送信を行う</a><a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h4>
<p>データベースまたはメッセージキューに保持されたメール情報をもとにメール送信を行うには、以下のような機能をアプリケーションに組み込む。</p>
<ul class="simple">
<li>送信するメールの情報（宛先や本文、添付ファイル等）をデータベース（またはメッセージキュー）に登録する。</li>
<li>データベース（またはメッセージキュー）から未送信のメール情報を定期的に取得し、SMTPによるメール送信を行う。</li>
<li>送信結果をデータベース（またはメッセージキュー）に登録する。</li>
</ul>
<p>なお、以下の点を含めて検討する必要がある。</p>
<ul class="simple">
<li>登録されたメール情報やメール送信結果の確認方法</li>
<li>メール送信エラー時の取り扱い</li>
</ul>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">メールサービスによっては、連続してメールが送信された場合に、スパムメールと判定されることがある。
左記への対策としては、同一ドメインに対し連続で送信処理を行わないように、送信順序をランダムにする方法が考えられる。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="greenmail">
<span id="email-test-with-greenmail"></span><h3><a class="toc-backref" href="#id50">8.1.4.5. GreenMailを利用したテスト</a><a class="headerlink" href="#greenmail" title="Permalink to this headline">¶</a></h3>
<p>メール送信機能をテストするためにフェイクサーバとして<a class="reference external" href="http://www.icegreen.com/greenmail/">GreenMail</a>を利用する方法を紹介する。
GreenMailはライブラリとして利用する以外に、warファイルをデプロイして利用することも可能である。</p>
<p>GreenMailを利用したテストコードの実装例を以下に示す。</p>
<p><strong>pom.xmlの設定例</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependencies&gt;</span>

    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.icegreen<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>greenmail<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.4.1<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>

<span class="nt">&lt;/dependencies&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GreenMailのライブラリをdependenciesに追加する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>JUnitソースの実装例</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="n">EmailService</span> <span class="n">emailService</span><span class="p">;</span>

<span class="nd">@Rule</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">GreenMailRule</span> <span class="n">greenMail</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GreenMailRule</span><span class="p">(</span>
        <span class="n">ServerSetupTest</span><span class="p">.</span><span class="na">SMTP</span><span class="p">);</span> <span class="c1">// (1)</span>

<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSend</span><span class="p">()</span> <span class="p">{</span>

    <span class="n">String</span> <span class="n">from</span> <span class="o">=</span> <span class="s">&quot;info@example.com&quot;</span><span class="p">;</span>
    <span class="n">String</span> <span class="n">to</span> <span class="o">=</span> <span class="s">&quot;foo@example.com&quot;</span><span class="p">;</span>
    <span class="n">String</span> <span class="n">subject</span> <span class="o">=</span> <span class="s">&quot;Registration confirmation.&quot;</span><span class="p">;</span>
    <span class="n">String</span> <span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Hi &quot;</span>
            <span class="o">+</span> <span class="n">to</span>
            <span class="o">+</span> <span class="s">&quot;, welcome to EXAMPLE.COM!\r\n&quot;</span>
            <span class="o">+</span> <span class="s">&quot;If you were not an intended recipient, Please notify the sender.&quot;</span><span class="p">;</span>
    <span class="n">emailService</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">text</span><span class="p">);</span>

    <span class="n">assertTrue</span><span class="p">(</span><span class="n">greenMail</span><span class="p">.</span><span class="na">waitForIncomingEmail</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span> <span class="c1">// (2)</span>

    <span class="n">Message</span><span class="o">[]</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">greenMail</span><span class="p">.</span><span class="na">getReceivedMessages</span><span class="p">();</span> <span class="c1">// (3)</span>

    <span class="n">assertNotNull</span><span class="p">(</span><span class="n">messages</span><span class="p">);</span>
    <span class="n">assertEquals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">messages</span><span class="p">.</span><span class="na">length</span><span class="p">);</span>
    <span class="c1">// omitted</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ServerSetupTest.SMTP</span></code>を指定した<code class="docutils literal"><span class="pre">GreenMailRule</span></code>をルールとして設定する。</div>
<div class="line">SMTPのポート番号はデフォルトで<code class="docutils literal"><span class="pre">3025</span></code>が使用される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">waitForIncomingEmail</span></code>メソッドを利用してメールの到達を待機する。</div>
<div class="line">別スレッドで非同期にメール送信が行われる際に利用する。</div>
<div class="line">この例では、メール送信が非同期で行われている前提で、1通のメールが到達するまで最大3秒待機する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">getReceivedMessages</span></code>メソッドを利用してすべての受信メールを取得する。</div>
<div class="line">GreenMailで送信したメールは宛先に係らず、すべてGreenMailで受信される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="JMS.html" title="8.2. JMS(Java Message Service)"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="8. メッセージ連携"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.3.2.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >8. メッセージ連携</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer">
      © Copyright 2013-2018, NTT DATA Corporation. © Copyright 2013-2018, NTT Corporation.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3.Theme is <a href="http://github.com/vimalkvn/solar-theme">Solar</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>
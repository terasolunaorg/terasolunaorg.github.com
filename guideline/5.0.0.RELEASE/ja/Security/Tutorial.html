<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>6.2. Spring Securityチュートリアル &mdash; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.0.0.RELEASE documentation</title>
    
    <link rel="stylesheet" href="../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '5.0.0.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.0.0.RELEASE documentation" href="../index.html" />
    <link rel="up" title="6. TERASOLUNA Server Framework for Java (5.x)によるセキュリティ対策" href="index.html" />
    <link rel="next" title="6.3. 認証" href="Authentication.html" />
    <link rel="prev" title="6.1. Spring Security概要" href="SpringSecurity.html" /><script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="Authentication.html" title="6.3. 認証"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="SpringSecurity.html" title="6.1. Spring Security概要"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.0.0.RELEASE documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">6. TERASOLUNA Server Framework for Java (5.x)によるセキュリティ対策</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">6.2. Spring Securityチュートリアル</a><ul>
<li><a class="reference internal" href="#id2">6.2.1. はじめに</a><ul>
<li><a class="reference internal" href="#id3">6.2.1.1. このチュートリアルで学ぶこと</a></li>
<li><a class="reference internal" href="#id4">6.2.1.2. 対象読者</a></li>
<li><a class="reference internal" href="#id5">6.2.1.3. 検証環境</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6">6.2.2. 作成するアプリケーションの概要</a></li>
<li><a class="reference internal" href="#id7">6.2.3. 環境構築</a><ul>
<li><a class="reference internal" href="#id8">6.2.3.1. プロジェクトの作成</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id9">6.2.4. アプリケーションの作成</a><ul>
<li><a class="reference internal" href="#id10">6.2.4.1. ドメイン層の実装</a><ul>
<li><a class="reference internal" href="#domain-object">6.2.4.1.1. Domain Objectの作成</a></li>
<li><a class="reference internal" href="#accountrepository">6.2.4.1.2. AccountRepositoryの作成</a></li>
<li><a class="reference internal" href="#accountsharedservice">6.2.4.1.3. AccountSharedServiceの作成</a></li>
<li><a class="reference internal" href="#tutorial-createauthservice">6.2.4.1.4. 認証サービスの作成</a></li>
<li><a class="reference internal" href="#id12">6.2.4.1.5. データベースの初期化スクリプトの設定</a></li>
<li><a class="reference internal" href="#id13">6.2.4.1.6. ドメイン層の作成後のパッケージエクスプローラー</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id14">6.2.4.2. アプリケーション層の実装</a><ul>
<li><a class="reference internal" href="#id15">6.2.4.2.1. Spring Securityの設定</a></li>
<li><a class="reference internal" href="#id16">6.2.4.2.2. ログインページの作成</a></li>
<li><a class="reference internal" href="#jsp">6.2.4.2.3. JSPからログインユーザーのアカウント情報へアクセス</a></li>
<li><a class="reference internal" href="#id17">6.2.4.2.4. ログアウトボタンの追加</a></li>
<li><a class="reference internal" href="#controller">6.2.4.2.5. Controllerからログインユーザーのアカウント情報へアクセス</a></li>
<li><a class="reference internal" href="#id18">6.2.4.2.6. アプリケーション層の作成後のパッケージエクスプローラー</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id19">6.2.5. おわりに</a></li>
<li><a class="reference internal" href="#appendix">6.2.6. Appendix</a><ul>
<li><a class="reference internal" href="#securitytutorialappendixconfigurationfiles">6.2.6.1. 設定ファイルの解説</a><ul>
<li><a class="reference internal" href="#spring-security-xml">6.2.6.1.1. spring-security.xml</a></li>
<li><a class="reference internal" href="#spring-mvc-xml">6.2.6.1.2. spring-mvc.xml</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="SpringSecurity.html"
                        title="previous chapter">6.1. Spring Security概要</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="Authentication.html"
                        title="next chapter">6.3. 認証</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/Security/Tutorial.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="spring-security">
<h1>6.2. Spring Securityチュートリアル<a class="headerlink" href="#spring-security" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="id1">
<p class="topic-title first">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#id2" id="id21">はじめに</a><ul>
<li><a class="reference internal" href="#id3" id="id22">このチュートリアルで学ぶこと</a></li>
<li><a class="reference internal" href="#id4" id="id23">対象読者</a></li>
<li><a class="reference internal" href="#id5" id="id24">検証環境</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6" id="id25">作成するアプリケーションの概要</a></li>
<li><a class="reference internal" href="#id7" id="id26">環境構築</a><ul>
<li><a class="reference internal" href="#id8" id="id27">プロジェクトの作成</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id9" id="id28">アプリケーションの作成</a><ul>
<li><a class="reference internal" href="#id10" id="id29">ドメイン層の実装</a><ul>
<li><a class="reference internal" href="#domain-object" id="id30">Domain Objectの作成</a></li>
<li><a class="reference internal" href="#accountrepository" id="id31">AccountRepositoryの作成</a></li>
<li><a class="reference internal" href="#accountsharedservice" id="id32">AccountSharedServiceの作成</a></li>
<li><a class="reference internal" href="#tutorial-createauthservice" id="id33">認証サービスの作成</a></li>
<li><a class="reference internal" href="#id12" id="id34">データベースの初期化スクリプトの設定</a></li>
<li><a class="reference internal" href="#id13" id="id35">ドメイン層の作成後のパッケージエクスプローラー</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id14" id="id36">アプリケーション層の実装</a><ul>
<li><a class="reference internal" href="#id15" id="id37">Spring Securityの設定</a></li>
<li><a class="reference internal" href="#id16" id="id38">ログインページの作成</a></li>
<li><a class="reference internal" href="#jsp" id="id39">JSPからログインユーザーのアカウント情報へアクセス</a></li>
<li><a class="reference internal" href="#id17" id="id40">ログアウトボタンの追加</a></li>
<li><a class="reference internal" href="#controller" id="id41">Controllerからログインユーザーのアカウント情報へアクセス</a></li>
<li><a class="reference internal" href="#id18" id="id42">アプリケーション層の作成後のパッケージエクスプローラー</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id19" id="id43">おわりに</a></li>
<li><a class="reference internal" href="#appendix" id="id44">Appendix</a><ul>
<li><a class="reference internal" href="#securitytutorialappendixconfigurationfiles" id="id45">設定ファイルの解説</a><ul>
<li><a class="reference internal" href="#spring-security-xml" id="id46">spring-security.xml</a></li>
<li><a class="reference internal" href="#spring-mvc-xml" id="id47">spring-mvc.xml</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id21">6.2.1. はじめに</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id22">6.2.1.1. このチュートリアルで学ぶこと</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Spring Securityによる基本的な認証・認可</li>
<li>データベース上のアカウント情報を使用したログイン</li>
<li>認証済みアカウントオブジェクトの取得方法</li>
</ul>
</div>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id23">6.2.1.2. 対象読者</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference internal" href="../TutorialTodo/index.html"><em>チュートリアル(Todoアプリケーション)</em></a>を実施ずみ (インフラストラクチャ層の実装としてMyBatis3を使用して実施していること)</li>
<li>Mavenの基本的な操作を理解している</li>
</ul>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id24">6.2.1.3. 検証環境</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference internal" href="../TutorialTodo/index.html"><em>チュートリアル(Todoアプリケーション)</em></a>と同様。</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id6">
<h2><a class="toc-backref" href="#id25">6.2.2. 作成するアプリケーションの概要</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>ログインページでIDとパスワード指定して、アプリケーションにログインする事ができる。</li>
<li>ログイン処理で必要となるアカウント情報はデータベース上に格納する。</li>
<li>ウェルカムページとアカウント情報表示ページがあり、これらのページはログインしないと閲覧する事ができない。</li>
<li>アプリケーションからログアウトする事ができる。</li>
</ul>
<p>アプリケーションの概要を以下の図で示す。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/security_tutorial_applicatioin_overview.png"><img alt="../_images/security_tutorial_applicatioin_overview.png" src="../_images/security_tutorial_applicatioin_overview.png" style="width: 90%;" /></a>
</div>
<p>URL一覧を以下に示す。</p>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="15%" />
<col width="15%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">プロセス名</th>
<th class="head">HTTPメソッド</th>
<th class="head">URL</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>ログインフォーム表示</td>
<td>GET</td>
<td>/login.jsp</td>
<td>ログインフォームを表示する</td>
</tr>
<tr class="row-odd"><td>2</td>
<td>ログイン</td>
<td>POST</td>
<td>/authentication</td>
<td>ログインフォームから入力されたユーザー名、パスワードを使って認証する(Spring Securityが行う)</td>
</tr>
<tr class="row-even"><td>3</td>
<td>ウェルカムページ表示</td>
<td>GET</td>
<td>/</td>
<td>ウェルカムページを表示する</td>
</tr>
<tr class="row-odd"><td>4</td>
<td>アカウント情報表示</td>
<td>GET</td>
<td>/account</td>
<td>ログインユーザーのアカウント情報を表示する</td>
</tr>
<tr class="row-even"><td>5</td>
<td>ログアウト</td>
<td>POST</td>
<td>/logout</td>
<td>ログアウトする(Spring Securityが行う)</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id7">
<h2><a class="toc-backref" href="#id26">6.2.3. 環境構築</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id8">
<h3><a class="toc-backref" href="#id27">6.2.3.1. プロジェクトの作成</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>Mavenのアーキタイプを利用し、<a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw-web-blank">TERASOLUNA Server Framework for Java (5.x)のブランクプロジェクト</a>を作成する。</p>
<p>本チュートリアルでは、MyBatis3用のブランクプロジェクトを作成する。</p>
<p>なお、Spring Tool Suite(STS)へのインポート方法やアプリケーションサーバの起動方法など基本知識については、
<a class="reference internal" href="../TutorialTodo/index.html"><em>チュートリアル(Todoアプリケーション)</em></a> で説明済みのため、本チュートリアルでは説明を割愛する。</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">mvn archetype:generate -B^</span>
<span class="go"> -DarchetypeCatalog=http://repo.terasoluna.org/nexus/content/repositories/terasoluna-gfw-releases^</span>
<span class="go"> -DarchetypeGroupId=org.terasoluna.gfw.blank^</span>
<span class="go"> -DarchetypeArtifactId=terasoluna-gfw-web-blank-mybatis3-archetype^</span>
<span class="go"> -DarchetypeVersion=5.0.0.RELEASE^</span>
<span class="go"> -DgroupId=com.example.security^</span>
<span class="go"> -DartifactId=first-springsecurity^</span>
<span class="go"> -Dversion=1.0.0-SNAPSHOT</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>チュートリアルを進める上で必要となる設定の多くは、作成したブランクプロジェクトに既に設定済みの状態である。
チュートリアルを実施するだけであれば、これらの設定の理解は必須ではないが、
アプリケーションを動かすためにどのような設定が必要なのかを理解しておくことを推奨する。</p>
<p>アプリケーションを動かすために必要な設定(設定ファイル)の解説については、
「<a class="reference internal" href="#securitytutorialappendixconfigurationfiles"><em>設定ファイルの解説</em></a>」を参照されたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id9">
<h2><a class="toc-backref" href="#id28">6.2.4. アプリケーションの作成</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id10">
<h3><a class="toc-backref" href="#id29">6.2.4.1. ドメイン層の実装</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>Spring Securityの認証処理は基本的に以下の流れになる。</p>
<ol class="arabic simple">
<li>入力された<tt class="docutils literal"><span class="pre">username</span></tt>からユーザー情報を検索する。</li>
<li>ユーザー情報が存在する場合、そのユーザー情報がもつパスワードと入力されたパスワードをハッシュ化したものを比較する。</li>
<li>比較結果が一致する場合、認証成功とみなす。</li>
</ol>
<p>ユーザー情報が見つからない場合やパスワードの比較結果が一致しない場合は認証失敗である。</p>
<p>ドメイン層ではユーザー名からAccountオブジェクトを取得する処理が必要となる。実装は、以下の順に進める。</p>
<ol class="arabic simple">
<li>Domain Object(<tt class="docutils literal"><span class="pre">Account</span></tt>)の作成</li>
<li><tt class="docutils literal"><span class="pre">AccountRepository</span></tt>の作成</li>
<li><tt class="docutils literal"><span class="pre">AccountSharedService</span></tt>の作成</li>
</ol>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="domain-object">
<h4><a class="toc-backref" href="#id30">6.2.4.1.1. Domain Objectの作成</a><a class="headerlink" href="#domain-object" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">認証情報(ユーザー名とパスワード)を保持する<tt class="docutils literal"><span class="pre">Account</span></tt>クラスを作成する。</div>
<div class="line"><tt class="docutils literal"><span class="pre">src/main/java/com/example/security/domain/model/Account.java</span></tt></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">model</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Account</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">firstName</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">lastName</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getUsername</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">username</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">username</span> <span class="o">=</span> <span class="n">username</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getPassword</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">password</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPassword</span><span class="o">(</span><span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">password</span> <span class="o">=</span> <span class="n">password</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getFirstName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">firstName</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFirstName</span><span class="o">(</span><span class="n">String</span> <span class="n">firstName</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">firstName</span> <span class="o">=</span> <span class="n">firstName</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getLastName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">lastName</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLastName</span><span class="o">(</span><span class="n">String</span> <span class="n">lastName</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">lastName</span> <span class="o">=</span> <span class="n">lastName</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;Account [username=&quot;</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="s">&quot;, password=&quot;</span> <span class="o">+</span> <span class="n">password</span>
                <span class="o">+</span> <span class="s">&quot;, firstName=&quot;</span> <span class="o">+</span> <span class="n">firstName</span> <span class="o">+</span> <span class="s">&quot;, lastName=&quot;</span> <span class="o">+</span> <span class="n">lastName</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="accountrepository">
<h4><a class="toc-backref" href="#id31">6.2.4.1.2. AccountRepositoryの作成</a><a class="headerlink" href="#accountrepository" title="Permalink to this headline">¶</a></h4>
<p><tt class="docutils literal"><span class="pre">Account</span></tt>オブジェクトをデータベースから取得する処理を実装する。</p>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">AccountRepository</span></tt>インタフェースを作成する。</div>
<div class="line"><tt class="docutils literal"><span class="pre">src/main/java/com/example/security/domain/repository/account/AccountRepository.java</span></tt></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">account</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.security.domain.model.Account</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AccountRepository</span> <span class="o">{</span>
    <span class="n">Account</span> <span class="nf">findOne</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">Account</span></tt>を1件取得するためのSQLをMapperファイルに定義する。</div>
<div class="line"><tt class="docutils literal"><span class="pre">src/main/resources/com/example/security/domain/repository/account/AccountRepository.xml</span></tt></div>
</div>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.security.domain.repository.account.AccountRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;accountResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Account&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;username&quot;</span> <span class="na">column=</span><span class="s">&quot;username&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;password&quot;</span> <span class="na">column=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;firstName&quot;</span> <span class="na">column=</span><span class="s">&quot;first_name&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;lastName&quot;</span> <span class="na">column=</span><span class="s">&quot;last_name&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/resultMap&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;String&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;accountResultMap&quot;</span><span class="nt">&gt;</span>
        SELECT
            username,
            password,
            first_name,
            last_name
        FROM
            account
        WHERE
            username = #{username}
    <span class="nt">&lt;/select&gt;</span>
<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="accountsharedservice">
<h4><a class="toc-backref" href="#id32">6.2.4.1.3. AccountSharedServiceの作成</a><a class="headerlink" href="#accountsharedservice" title="Permalink to this headline">¶</a></h4>
<p>ユーザー名から<tt class="docutils literal"><span class="pre">Account</span></tt>オブジェクトを取得する業務処理を実装する。</p>
<p>この処理は、Spring Securityの認証サービスから利用するため、インタフェース名は<tt class="docutils literal"><span class="pre">AccountSharedService</span></tt>、クラス名は<tt class="docutils literal"><span class="pre">AccountSharedServiceImpl</span></tt>とする。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>本ガイドラインでは、Serviceから別のServiceを呼び出し事を推奨していない。</p>
<p>ドメイン層の処理(Service)を共通化したい場合は、<tt class="docutils literal"><span class="pre">XxxService</span></tt>という名前ではなく、
Serviceの処理を共通化するためのServiceであることを示すために、
<tt class="docutils literal"><span class="pre">XxxSharedService</span></tt>という名前にすることを推奨している。</p>
<p class="last">本チュートリアルで作成するアプリケーションでは共通化は必須ではないが、
通常のアプリケーションであればアカウント情報を管理する業務のServiceと処理を共通化することが想定される。
そのため、本チュートリアルではアカウント情報を取得処理をSharedServiceとして実装する。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">AccountSharedService</span></tt>インタフェースを作成する。</div>
<div class="line"><tt class="docutils literal"><span class="pre">src/main/java/com/example/security/domain/service/account/AccountSharedService.java</span></tt></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">account</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.security.domain.model.Account</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AccountSharedService</span> <span class="o">{</span>
    <span class="n">Account</span> <span class="nf">findOne</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">AccountSharedServiceImpl</span></tt>クラスを作成する。</div>
<div class="line"><tt class="docutils literal"><span class="pre">src/main/java/com/example/security/domain/service/account/AccountSharedServiceImpl.java</span></tt></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">account</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.ResourceNotFoundException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.security.domain.model.Account</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.security.domain.repository.account.AccountRepository</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountSharedServiceImpl</span> <span class="kd">implements</span> <span class="n">AccountSharedService</span> <span class="o">{</span>
    <span class="nd">@Inject</span>
    <span class="n">AccountRepository</span> <span class="n">accountRepository</span><span class="o">;</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span><span class="o">=</span><span class="kc">true</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Account</span> <span class="nf">findOne</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// (1)</span>
        <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">accountRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
        <span class="c1">// (2)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">account</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ResourceNotFoundException</span><span class="o">(</span><span class="s">&quot;The given account is not found! username=&quot;</span>
                    <span class="o">+</span> <span class="n">username</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">account</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザー名に一致する<tt class="docutils literal"><span class="pre">Account</span></tt>オブジェクトを1件取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザー名に一致する<tt class="docutils literal"><span class="pre">Account</span></tt>が存在しない場合は、共通ライブラリから提供している<tt class="docutils literal"><span class="pre">ResourceNotFoundException</span></tt>をスローする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="tutorial-createauthservice">
<span id="id11"></span><h4><a class="toc-backref" href="#id33">6.2.4.1.4. 認証サービスの作成</a><a class="headerlink" href="#tutorial-createauthservice" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Spring Securityで使用する認証ユーザー情報を保持するクラスを作成する。</div>
<div class="line"><tt class="docutils literal"><span class="pre">src/main/java/com/example/security/domain/service/userdetails/SampleUserDetails.java</span></tt></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">userdetails</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.security.core.authority.AuthorityUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.User</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.security.domain.model.Account</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleUserDetails</span> <span class="kd">extends</span> <span class="n">User</span> <span class="o">{</span> <span class="c1">// (1)</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Account</span> <span class="n">account</span><span class="o">;</span> <span class="c1">// (2)</span>

    <span class="kd">public</span> <span class="nf">SampleUserDetails</span><span class="o">(</span><span class="n">Account</span> <span class="n">account</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// (3)</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span> <span class="n">account</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span> <span class="n">AuthorityUtils</span>
                <span class="o">.</span><span class="na">createAuthorityList</span><span class="o">(</span><span class="s">&quot;ROLE_USER&quot;</span><span class="o">));</span> <span class="c1">// (4)</span>
        <span class="k">this</span><span class="o">.</span><span class="na">account</span> <span class="o">=</span> <span class="n">account</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Account</span> <span class="nf">getAccount</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// (5)</span>
        <span class="k">return</span> <span class="n">account</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">org.springframework.security.core.userdetails.UserDetails</span></tt>インタフェースを実装する。</div>
<div class="line">ここでは<tt class="docutils literal"><span class="pre">UserDetails</span></tt>を実装した<tt class="docutils literal"><span class="pre">org.springframework.security.core.userdetails.User</span></tt> クラスを継承し、本プロジェクト用の<tt class="docutils literal"><span class="pre">UserDetails</span></tt>クラスを実装する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Springの認証ユーザークラスに、本プロジェクトのアカウント情報を保持させる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">User</span></tt>クラスのコンストラクタを呼び出す。第1引数はユーザー名、第2引数はパスワード、第3引数は権限リストである。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">簡易実装として、<tt class="docutils literal"><span class="pre">&quot;ROLE_USER&quot;</span></tt>というロールのみ持つ権限を作成する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウント情報のgetterを用意する。これにより、ログインユーザーの<tt class="docutils literal"><span class="pre">Account</span></tt>オブジェクトを取得することができる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">Spring Securityで使用する認証ユーザー情報を取得するサービスを作成する。</div>
<div class="line"><tt class="docutils literal"><span class="pre">src/main/java/com/example/security/domain/service/userdetails/SampleUserDetailsService.java</span></tt></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">userdetails</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.UserDetails</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.UserDetailsService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.UsernameNotFoundException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.ResourceNotFoundException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.security.domain.model.Account</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.security.domain.service.account.AccountSharedService</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleUserDetailsService</span> <span class="kd">implements</span> <span class="n">UserDetailsService</span> <span class="o">{</span> <span class="c1">// (1)</span>
    <span class="nd">@Inject</span>
    <span class="n">AccountSharedService</span> <span class="n">accountSharedService</span><span class="o">;</span> <span class="c1">// (2)</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span><span class="o">=</span><span class="kc">true</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">UsernameNotFoundException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">accountSharedService</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">username</span><span class="o">);</span> <span class="c1">// (3)</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">SampleUserDetails</span><span class="o">(</span><span class="n">account</span><span class="o">);</span> <span class="c1">// (4)</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ResourceNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">UsernameNotFoundException</span><span class="o">(</span><span class="s">&quot;user not found&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span> <span class="c1">// (5)</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">org.springframework.security.core.userdetails.UserDetailsService</span></tt>インタフェースを実装する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">AccountSharedService</span></tt>をインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">username</span></tt>から<tt class="docutils literal"><span class="pre">Account</span></tt>オブジェクトを取得する処理を<tt class="docutils literal"><span class="pre">AccountSharedService</span></tt>に委譲する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得した<tt class="docutils literal"><span class="pre">Account</span></tt>オブジェクトを使用して、本プロジェクト用の<tt class="docutils literal"><span class="pre">UserDetails</span></tt>オブジェクトを作成し、メソッドの返り値として返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">対象のユーザーが見つからない場合は、<tt class="docutils literal"><span class="pre">UsernameNotFoundException</span></tt>がスローする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id12">
<h4><a class="toc-backref" href="#id34">6.2.4.1.5. データベースの初期化スクリプトの設定</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<p>本チュートリアルでは、アカウント情報を保持するデータベースとしてH2 Database(インメモリデータベース)を使用する。
そのため、アプリケーションサーバ起動時にSQLを実行してデータベースを初期化する必要がある。</p>
<div class="line-block">
<div class="line">データベースを初期化するSQLスクリプトを実行するための設定を追加する。</div>
<div class="line"><tt class="docutils literal"><span class="pre">src/main/resources/META-INF/spring/first-springsecurity-env.xml</span></tt></div>
</div>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
<span class="hll">    <span class="na">xmlns:jdbc=</span><span class="s">&quot;http://www.springframework.org/schema/jdbc&quot;</span>
</span>    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="hll"><span class="s">        http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc.xsd&quot;</span><span class="nt">&gt;</span>
</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;dateFactory&quot;</span> <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.common.date.jodatime.DefaultJodaTimeDateFactory&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;realDataSource&quot;</span> <span class="na">class=</span><span class="s">&quot;org.apache.commons.dbcp2.BasicDataSource&quot;</span>
        <span class="na">destroy-method=</span><span class="s">&quot;close&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;driverClassName&quot;</span> <span class="na">value=</span><span class="s">&quot;${database.driverClassName}&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;url&quot;</span> <span class="na">value=</span><span class="s">&quot;${database.url}&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;username&quot;</span> <span class="na">value=</span><span class="s">&quot;${database.username}&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span> <span class="na">value=</span><span class="s">&quot;${database.password}&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultAutoCommit&quot;</span> <span class="na">value=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxTotal&quot;</span> <span class="na">value=</span><span class="s">&quot;${cp.maxActive}&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxIdle&quot;</span> <span class="na">value=</span><span class="s">&quot;${cp.maxIdle}&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;minIdle&quot;</span> <span class="na">value=</span><span class="s">&quot;${cp.minIdle}&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxWaitMillis&quot;</span> <span class="na">value=</span><span class="s">&quot;${cp.maxWait}&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">class=</span><span class="s">&quot;net.sf.log4jdbc.Log4jdbcProxyDataSource&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">ref=</span><span class="s">&quot;realDataSource&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!--  REMOVE THIS LINE IF YOU USE JPA</span>
<span class="c">    &lt;bean id=&quot;transactionManager&quot;</span>
<span class="c">        class=&quot;org.springframework.orm.jpa.JpaTransactionManager&quot;&gt;</span>
<span class="c">        &lt;property name=&quot;entityManagerFactory&quot; ref=&quot;entityManagerFactory&quot; /&gt;</span>
<span class="c">    &lt;/bean&gt;</span>
<span class="c">          REMOVE THIS LINE IF YOU USE JPA  --&gt;</span>
    <span class="c">&lt;!--  REMOVE THIS LINE IF YOU USE MyBatis2</span>
<span class="c">    &lt;bean id=&quot;transactionManager&quot;</span>
<span class="c">        class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt;</span>
<span class="c">        &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot; /&gt;</span>
<span class="c">    &lt;/bean&gt;</span>
<span class="c">          REMOVE THIS LINE IF YOU USE MyBatis2  --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;transactionManager&quot;</span>
        <span class="na">class=</span><span class="s">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;jdbc:initialize-database</span> <span class="na">data-source=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ignore-failures=</span><span class="s">&quot;ALL&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;jdbc:script</span> <span class="na">location=</span><span class="s">&quot;classpath:/database/${database}-schema.sql&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">        <span class="nt">&lt;jdbc:script</span> <span class="na">location=</span><span class="s">&quot;classpath:/database/${database}-dataload.sql&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/jdbc:initialize-database&gt;</span>
</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">&lt;jdbc:initialize-database&gt;</span></tt>タグにデータベースを初期化するSQLスクリプトを実行するための設定を行う。</p>
<p class="last">この設定は通常、開発中のみでしか使用しない(環境に依存する設定)ため、<tt class="docutils literal"><span class="pre">first-springsecurity-env.xml</span></tt>に定義する。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p class="first">アカウント情報を保持するテーブルを作成するためのDDL文が記載されているSQLファイルを指定する。</p>
<p class="last">ブランクプロジェクトの設定では、<tt class="docutils literal"><span class="pre">first-springsecurity-infra.properties</span></tt>に<tt class="docutils literal"><span class="pre">database=H2</span></tt>と定義されているため、<tt class="docutils literal"><span class="pre">H2-schema.sql</span></tt>が実行される。</p>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p class="first">デモユーザーを登録するためのDML文が記載されているSQLファイルを指定する。</p>
<p class="last">ブランクプロジェクトの設定では、<tt class="docutils literal"><span class="pre">first-springsecurity-infra.properties</span></tt>に<tt class="docutils literal"><span class="pre">database=H2</span></tt>と定義されているため、<tt class="docutils literal"><span class="pre">H2-dataload.sql</span></tt>が実行される。</p>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">アカウント情報を保持するテーブルを作成するためのDDL文を作成する。</div>
<div class="line"><tt class="docutils literal"><span class="pre">src/main/resources/database/H2-schema.sql</span></tt></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">account</span><span class="p">(</span>
    <span class="n">username</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
    <span class="n">password</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">60</span><span class="p">),</span>
    <span class="n">first_name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
    <span class="n">last_name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
    <span class="k">constraint</span> <span class="n">pk_tbl_account</span> <span class="k">primary</span> <span class="k">key</span> <span class="p">(</span><span class="n">username</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
<div class="line">デモユーザー(username=demo、password=demo)を登録するためのDML文を作成する。</div>
<div class="line"><tt class="docutils literal"><span class="pre">src/main/resources/database/H2-dataload.sql</span></tt></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">account</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">)</span> <span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;demo&#39;</span><span class="p">,</span> <span class="s1">&#39;$2a$10$oxSJl.keBwxmsMLkcT9lPeAIxfNTPNQxpeywMrF7A3kVszwUTqfTK&#39;</span><span class="p">,</span> <span class="s1">&#39;Taro&#39;</span><span class="p">,</span> <span class="s1">&#39;Yamada&#39;</span><span class="p">);</span> <span class="c1">-- (1)</span>
<span class="k">COMMIT</span><span class="p">;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p class="first">ブランクプロジェクトの設定では、<tt class="docutils literal"><span class="pre">applicationContext.xml</span></tt>にパスワードをハッシュ化するためのクラスとして<tt class="docutils literal"><span class="pre">org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder</span></tt>が設定されている。</p>
<p class="last">本チュートリアルでは、<tt class="docutils literal"><span class="pre">BCryptPasswordEncoder</span></tt>を使用してパスワードのハッシュ化を行うため、パスワードには<tt class="docutils literal"><span class="pre">&quot;demo&quot;</span></tt>という文字列をBCryptアルゴリズムでハッシュ化した文字列を投入する。</p>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id13">
<h4><a class="toc-backref" href="#id35">6.2.4.1.6. ドメイン層の作成後のパッケージエクスプローラー</a><a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h4>
<p>ドメイン層に作成したファイルを確認する。</p>
<p>Package ExplorerのPackage PresentationはHierarchicalを使用している。</p>
<div class="figure">
<img alt="security tutorial domain layer package explorer" src="../_images/security_tutorial-domain-layer-package-explorer.png" />
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id14">
<h3><a class="toc-backref" href="#id36">6.2.4.2. アプリケーション層の実装</a><a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id15">
<h4><a class="toc-backref" href="#id37">6.2.4.2.1. Spring Securityの設定</a><a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h4>
<p><tt class="docutils literal"><span class="pre">spring-security.xml</span></tt>にSpring Securityによる認証・認可の設定を行う。</p>
<p>本チュートリアルで作成するアプリケーションで扱うURLのパターンを以下に示す。</p>
<table border="1" class="docutils">
<colgroup>
<col width="30%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">URL</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">/login.jsp</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ログインフォームの表示するためのURL</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">/login.jsp?error=true</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証エラー時に遷移するページ(ログインページ)を表示するためのURL</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">/authenticate</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証処理を行うためのURL</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">/logout</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ログアウト処理を行うためのURL</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">/</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ウェルカムページを表示するためのURL</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">/account</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ログインユーザーのアカウント情報を表示するためのURL</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block" id="tutorial-setting-spring-security">
<div class="line">ブランクプロジェクトから提供されている設定に加えて、以下の設定を追加する。</div>
<div class="line"><tt class="docutils literal"><span class="pre">src/main/resources/META-INF/spring/spring-security.xml</span></tt></div>
</div>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
    <span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;sec:http</span> <span class="na">pattern=</span><span class="s">&quot;/resources/**&quot;</span> <span class="na">security=</span><span class="s">&quot;none&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:http</span> <span class="na">auto-config=</span><span class="s">&quot;true&quot;</span> <span class="na">use-expressions=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;sec:headers&gt;</span>
            <span class="nt">&lt;sec:cache-control</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;sec:content-type-options</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;sec:hsts</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;sec:frame-options</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;sec:xss-protection</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/sec:headers&gt;</span>
        <span class="nt">&lt;sec:csrf</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;sec:access-denied-handler</span> <span class="na">ref=</span><span class="s">&quot;accessDeniedHandler&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;sec:custom-filter</span> <span class="na">ref=</span><span class="s">&quot;userIdMDCPutFilter&quot;</span> <span class="na">after=</span><span class="s">&quot;ANONYMOUS_FILTER&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;sec:session-management</span> <span class="nt">/&gt;</span>
<span class="hll">        <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;sec:form-login</span>
</span>            <span class="na">login-page=</span><span class="s">&quot;/login.jsp&quot;</span>
            <span class="na">authentication-failure-url=</span><span class="s">&quot;/login.jsp?error=true&quot;</span>
            <span class="na">login-processing-url=</span><span class="s">&quot;/authenticate&quot;</span> <span class="nt">/&gt;</span>
<span class="hll">        <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;sec:logout</span>
</span>            <span class="na">logout-url=</span><span class="s">&quot;/logout&quot;</span>
            <span class="na">logout-success-url=</span><span class="s">&quot;/&quot;</span>
            <span class="na">delete-cookies=</span><span class="s">&quot;JSESSIONID&quot;</span> <span class="nt">/&gt;</span>
<span class="hll">        <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/login.jsp&quot;</span> <span class="na">access=</span><span class="s">&quot;permitAll&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">        <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/**&quot;</span> <span class="na">access=</span><span class="s">&quot;isAuthenticated()&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">
</span>    <span class="nt">&lt;/sec:http&gt;</span>

    <span class="nt">&lt;sec:authentication-manager&gt;</span>
        <span class="c">&lt;!-- com.example.security.domain.service.userdetails.SampleUserDetailsService</span>
<span class="c">          is scanned by component scan with @Service --&gt;</span>
        <span class="c">&lt;!-- (4) --&gt;</span>
<span class="hll">        <span class="nt">&lt;sec:authentication-provider</span>
</span><span class="hll">            <span class="na">user-service-ref=</span><span class="s">&quot;sampleUserDetailsService&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">            <span class="c">&lt;!-- (5) --&gt;</span>
</span><span class="hll">            <span class="nt">&lt;sec:password-encoder</span> <span class="na">ref=</span><span class="s">&quot;passwordEncoder&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">        <span class="nt">&lt;/sec:authentication-provider&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/sec:authentication-manager&gt;</span>
</span>
    <span class="c">&lt;!-- Change View for CSRF or AccessDenied --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;accessDeniedHandler&quot;</span>
        <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.access.DelegatingAccessDeniedHandler&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;map&gt;</span>
                <span class="nt">&lt;entry</span>
                    <span class="na">key=</span><span class="s">&quot;org.springframework.security.web.csrf.InvalidCsrfTokenException&quot;</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;bean</span>
                        <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.access.AccessDeniedHandlerImpl&quot;</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;errorPage&quot;</span>
                            <span class="na">value=</span><span class="s">&quot;/WEB-INF/views/common/error/invalidCsrfTokenError.jsp&quot;</span> <span class="nt">/&gt;</span>
                    <span class="nt">&lt;/bean&gt;</span>
                <span class="nt">&lt;/entry&gt;</span>
                <span class="nt">&lt;entry</span>
                    <span class="na">key=</span><span class="s">&quot;org.springframework.security.web.csrf.MissingCsrfTokenException&quot;</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;bean</span>
                        <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.access.AccessDeniedHandlerImpl&quot;</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;errorPage&quot;</span>
                            <span class="na">value=</span><span class="s">&quot;/WEB-INF/views/common/error/missingCsrfTokenError.jsp&quot;</span> <span class="nt">/&gt;</span>
                    <span class="nt">&lt;/bean&gt;</span>
                <span class="nt">&lt;/entry&gt;</span>
            <span class="nt">&lt;/map&gt;</span>
        <span class="nt">&lt;/constructor-arg&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;bean</span>
                <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.access.AccessDeniedHandlerImpl&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;errorPage&quot;</span>
                    <span class="na">value=</span><span class="s">&quot;/WEB-INF/views/common/error/accessDeniedError.jsp&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/bean&gt;</span>
        <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!-- Put UserID into MDC --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;userIdMDCPutFilter&quot;</span> <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.security.web.logging.UserIdMDCPutFilter&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">&lt;sec:form-login&gt;</span></tt>タグでログインフォームに関する設定を行う。</p>
<p><tt class="docutils literal"><span class="pre">&lt;sec:form-login&gt;</span></tt>タグには、</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">login-page</span></tt>属性にログインフォームを表示するためのURL</li>
<li><tt class="docutils literal"><span class="pre">authentication-failure-url</span></tt>属性に認証エラー時に遷移するページを表示するためのURL</li>
<li><tt class="docutils literal"><span class="pre">login-processing-url</span></tt>属性に認証処理を行うためのURL</li>
</ul>
<p class="last">を設定する。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">&lt;sec:logout&gt;</span></tt>タグでログアウトに関する設定を行う。</p>
<p><tt class="docutils literal"><span class="pre">&lt;sec:logout&gt;</span></tt>タグには、</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">logout-url</span></tt>属性にログアウト処理を行うためのURL</li>
<li><tt class="docutils literal"><span class="pre">logout-success-url</span></tt>属性にログアウト後に遷移するページを表示するためのURL(本チュートリアルではウェルカムページを表示するためのURL)</li>
<li><tt class="docutils literal"><span class="pre">delete-cookies</span></tt>属性にログアウト時に削除するCookie名(本チュートリアルではセッションIDのCookie名)</li>
</ul>
<p class="last">を設定する。</p>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">&lt;sec:intercept-url&gt;</span></tt>タグを使用してURL毎の認可設定を行う。</p>
<p><tt class="docutils literal"><span class="pre">&lt;sec:intercept-url&gt;</span></tt>タグには、</p>
<ul class="simple">
<li>ログインフォームを表示するためのURLには、全てのユーザーのアクセスを許可する<tt class="docutils literal"><span class="pre">permitAll</span></tt></li>
<li>上記以外のURLには、認証済みユーザーのみアクセスを許可する<tt class="docutils literal"><span class="pre">isAuthenticated()</span></tt></li>
</ul>
<p>を設定する。</p>
<p class="last">ただし、<tt class="docutils literal"><span class="pre">/resources/</span></tt>配下のURLについては、Spring Securityによる認証・認可処理を行わない設定(<tt class="docutils literal"><span class="pre">&lt;sec:http</span> <span class="pre">pattern=&quot;/resources/**&quot;</span> <span class="pre">security=&quot;none&quot;/&gt;</span></tt>)が行われているため、全てのユーザーがアクセスすることができる。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">&lt;sec:authentication-provider&gt;</span></tt>タグを使用して、認証処理を行う<tt class="docutils literal"><span class="pre">org.springframework.security.authentication.AuthenticationProvider</span></tt>の設定を行う。</p>
<p>デフォルトでは、<tt class="docutils literal"><span class="pre">UserDetailsService</span></tt>を使用して<tt class="docutils literal"><span class="pre">UserDetails</span></tt>を取得し、その<tt class="docutils literal"><span class="pre">UserDetails</span></tt>が持つハッシュ化済みパスワードと、ログインフォームで指定されたパスワードを比較してユーザー認証を行うクラス(<tt class="docutils literal"><span class="pre">org.springframework.security.authentication.dao.DaoAuthenticationProvider</span></tt>)が使用される。</p>
<p class="last"><tt class="docutils literal"><span class="pre">user-service-ref</span></tt>属性に<tt class="docutils literal"><span class="pre">UserDetailsService</span></tt>インタフェースを実装しているコンポーネントのbean名を指定する。本チュートリアルでは、ドメイン層に作成した<tt class="docutils literal"><span class="pre">SampleUserDetailsService</span></tt>クラスを設定する。</p>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">&lt;sec:password-encoder&gt;</span></tt>タグを使用して、ログインフォームで指定されたパスワードをハッシュ化するためのクラス(<tt class="docutils literal"><span class="pre">PasswordEncoder</span></tt>)の設定を行う。</p>
<p class="last">本チュートリアルでは、<tt class="docutils literal"><span class="pre">applicationContext.xml</span></tt>に定義されている<tt class="docutils literal"><span class="pre">org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder</span></tt>を利用する。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>認証処理とログアウト処理を行うためのURLについては、Spring Securityが提供しているデフォルトのURLを変更している。</p>
<p class="last">これは、これらのURLの中にSpring Securityを使用している事がわかる文字列(<tt class="docutils literal"><span class="pre">spring_security</span></tt>)が含まれているためである。
デフォルトのURLをそのまま使用した場合、Spring Securityにセキュリティ上の脆弱性が発覚した場合に、
悪意のあるユーザからの攻撃を受けやすくなるという点に注意してほしい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id16">
<h4><a class="toc-backref" href="#id38">6.2.4.2.2. ログインページの作成</a><a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">ログインページにログインフォームを作成する。</div>
<div class="line"><tt class="docutils literal"><span class="pre">src/main/webapp/login.jsp</span></tt></div>
</div>
<div class="highlight-jsp"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>Login Page<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span>
    <span class="na">href=</span><span class="s">&quot;${pageContext.request.contextPath}/resources/app/css/styles.css&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h3&gt;</span>Login with Username and Password<span class="nt">&lt;/h3&gt;</span>

        <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;c:if</span> <span class="na">test=</span><span class="s">&quot;${param.error}&quot;</span><span class="nt">&gt;</span>
            <span class="c">&lt;!-- (2) --&gt;</span>
            <span class="nt">&lt;t:messagesPanel</span> <span class="na">messagesType=</span><span class="s">&quot;error&quot;</span>
                <span class="na">messagesAttributeName=</span><span class="s">&quot;SPRING_SECURITY_LAST_EXCEPTION&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/c:if&gt;</span>

        <span class="c">&lt;!-- (3) --&gt;</span>
        <span class="nt">&lt;form:form</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/authenticate&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;table&gt;</span>
                <span class="nt">&lt;tr&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;j_username&quot;</span><span class="nt">&gt;</span>User:<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">id=</span><span class="s">&quot;j_username&quot;</span>
                        <span class="na">name=</span><span class="s">&quot;j_username&quot;</span> <span class="na">value=</span><span class="s">&#39;demo&#39;</span><span class="nt">&gt;</span>(demo)<span class="nt">&lt;/td&gt;</span><span class="c">&lt;!-- (4) --&gt;</span>
                <span class="nt">&lt;/tr&gt;</span>
                <span class="nt">&lt;tr&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;j_password&quot;</span><span class="nt">&gt;</span>Password:<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="na">id=</span><span class="s">&quot;j_password&quot;</span>
                        <span class="na">name=</span><span class="s">&quot;j_password&quot;</span> <span class="na">value=</span><span class="s">&quot;demo&quot;</span> <span class="nt">/&gt;</span>(demo)<span class="nt">&lt;/td&gt;</span><span class="c">&lt;!-- (5) --&gt;</span>
                <span class="nt">&lt;/tr&gt;</span>
                <span class="nt">&lt;tr&gt;</span>
                    <span class="nt">&lt;td&gt;</span><span class="ni">&amp;nbsp;</span><span class="nt">&lt;/td&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">name=</span><span class="s">&quot;submit&quot;</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Login&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;/table&gt;</span>
        <span class="nt">&lt;/form:form&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>認証が失敗した場合、<tt class="docutils literal"><span class="pre">&quot;/login.jsp?error=true&quot;</span></tt>が呼び出し、ログインページを表示する。
そのため、認証エラー後の表示の時のみエラーメッセージが表示されるように<tt class="docutils literal"><span class="pre">&lt;c:if&gt;</span></tt>タグを使用する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p class="first">共通ライブラリから提供されている<tt class="docutils literal"><span class="pre">&lt;t:messagesPanel&gt;</span></tt>タグを使用してエラーメッセージを表示する。</p>
<p class="last">認証が失敗した場合、認証エラーの例外オブジェクトが<tt class="docutils literal"><span class="pre">&quot;SPRING_SECURITY_LAST_EXCEPTION&quot;</span></tt>という属性名でセッションスコープに格納される。</p>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">&lt;form:form&gt;</span></tt>タグの<tt class="docutils literal"><span class="pre">action</span></tt>属性に、認証処理用のURL(<tt class="docutils literal"><span class="pre">&quot;/authenticate&quot;</span></tt>)と設定する。</p>
<p class="last">認証処理に必要なパラメータ(ユーザー名とパスワード)をPOSTメソッドを使用して送信する。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p class="first">ユーザー名を指定するテキストボックスを作成する。</p>
<p class="last">Spring Securityのデフォルトのパラメータ名は<tt class="docutils literal"><span class="pre">j_username</span></tt>である。</p>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><p class="first">パスワードを指定するテキストボックス(パスワード用のテキストボックス)を作成する。</p>
<p class="last">Spring Securityのデフォルトのパラメータ名は<tt class="docutils literal"><span class="pre">j_password</span></tt>である。</p>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">セッションスコープに格納される認証エラーの例外オブジェクトをJSPから取得できるようにする。</div>
<div class="line"><tt class="docutils literal"><span class="pre">src/main/webapp/WEB-INF/views/common/include.jsp</span></tt></div>
</div>
<div class="highlight-jsp"><div class="highlight"><pre><span class="hll"><span class="k">&lt;%@</span> <span class="n">page</span> <span class="n">session</span><span class="o">=</span><span class="s">&quot;true&quot;</span><span class="k">%&gt;</span> <span class="c">&lt;!-- (6) --&gt;</span>
</span><span class="k">&lt;%@</span> <span class="n">taglib</span> <span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://java.sun.com/jsp/jstl/core&quot;</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;c&quot;</span><span class="k">%&gt;</span>
<span class="k">&lt;%@</span> <span class="n">taglib</span> <span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://java.sun.com/jsp/jstl/fmt&quot;</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;fmt&quot;</span><span class="k">%&gt;</span>
<span class="k">&lt;%@</span> <span class="n">taglib</span> <span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://www.springframework.org/tags&quot;</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;spring&quot;</span><span class="k">%&gt;</span>
<span class="k">&lt;%@</span> <span class="n">taglib</span> <span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://www.springframework.org/tags/form&quot;</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;form&quot;</span><span class="k">%&gt;</span>
<span class="k">&lt;%@</span> <span class="n">taglib</span> <span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://www.springframework.org/security/tags&quot;</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;sec&quot;</span><span class="k">%&gt;</span>
<span class="k">&lt;%@</span> <span class="n">taglib</span> <span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://terasoluna.org/functions&quot;</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;f&quot;</span><span class="k">%&gt;</span>
<span class="k">&lt;%@</span> <span class="n">taglib</span> <span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://terasoluna.org/tags&quot;</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;t&quot;</span><span class="k">%&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><tt class="docutils literal"><span class="pre">page</span></tt>ディレクティブの<tt class="docutils literal"><span class="pre">session</span></tt>属性を<tt class="docutils literal"><span class="pre">true</span></tt>にする。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ブランクプロジェクトのデフォルト設定では、JSPからセッションスコープにアクセスできないようになっている。
これは、安易にセッションが使用されないようにするためであるが、
認証エラーの例外オブジェクトをJSPから取得する場合は、JSPからセッションスコープにアクセスできるようにする必要がある。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">ブラウザのアドレスバーに <a class="reference external" href="http://localhost:8080/first-springsecurity/">http://localhost:8080/first-springsecurity/</a> を入力し、ウェルカムページを表示しようとする。</div>
<div class="line">未ログイン状態のため、<tt class="docutils literal"><span class="pre">&lt;sec:form-login&gt;</span></tt>タグの<tt class="docutils literal"><span class="pre">login-page</span></tt>属性の設定値( <a class="reference external" href="http://localhost:8080/first-springsecurity/login.jsp">http://localhost:8080/first-springsecurity/login.jsp</a> )に遷移し、以下のような画面が表示される。</div>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../_images/security_tutorial_login_page.png"><img alt="../_images/security_tutorial_login_page.png" src="../_images/security_tutorial_login_page.png" style="width: 80%;" /></a>
</div>
</div>
<div class="section" id="jsp">
<h4><a class="toc-backref" href="#id39">6.2.4.2.3. JSPからログインユーザーのアカウント情報へアクセス</a><a class="headerlink" href="#jsp" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">JSPからログインユーザーのアカウント情報にアクセスし、氏名を表示する。</div>
<div class="line"><tt class="docutils literal"><span class="pre">src/main/webapp/WEB-INF/views/welcome/home.jsp</span></tt></div>
</div>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;title&gt;</span>Home<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span>
    <span class="na">href=</span><span class="s">&quot;${pageContext.request.contextPath}/resources/app/css/styles.css&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>

<span class="hll"><span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll"><span class="nt">&lt;sec:authentication</span> <span class="na">property=</span><span class="s">&quot;principal.account&quot;</span> <span class="na">var=</span><span class="s">&quot;account&quot;</span> <span class="nt">/&gt;</span>
</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Hello world!<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;p&gt;</span>The time on the server is ${serverTime}.<span class="nt">&lt;/p&gt;</span>
<span class="hll">        <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;p&gt;</span>Welcome ${f:h(account.firstName)} ${f:h(account.lastName)} !!<span class="nt">&lt;/p&gt;</span>
</span>        <span class="nt">&lt;ul&gt;</span>
            <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;${pageContext.request.contextPath}/account&quot;</span><span class="nt">&gt;</span>view account<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">&lt;sec:authentication&gt;</span></tt>タグを使用して、ログインユーザーの<tt class="docutils literal"><span class="pre">org.springframework.security.core.Authentication</span></tt>オブジェクトにアクセスする。</p>
<p><tt class="docutils literal"><span class="pre">property</span></tt>属性を使用すると<tt class="docutils literal"><span class="pre">Authentication</span></tt>オブジェクトが保持する任意のプロパティにアクセスする事ができ、アクセスしたプロパティ値は<tt class="docutils literal"><span class="pre">var</span></tt>属性を使用して任意のスコープに格納することできる。
デフォルトではpageスコープの設定され、このJSP内のみで参照可能となる。</p>
<p class="last">チュートリアルでは、ログインユーザーの<tt class="docutils literal"><span class="pre">Account</span></tt>オブジェクトを<tt class="docutils literal"><span class="pre">account</span></tt>という属性名でpageスコープに格納する。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>ログインユーザーの<tt class="docutils literal"><span class="pre">Account</span></tt>オブジェクトにアクセスして、<tt class="docutils literal"><span class="pre">firstName</span></tt>と<tt class="docutils literal"><span class="pre">lastName</span></tt>を表示する。</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>ログインページのLoginボタンを押下し、ウェルカムページを表示する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/security_tutorial_welcome_page.png"><img alt="../_images/security_tutorial_welcome_page.png" src="../_images/security_tutorial_welcome_page.png" style="width: 70%;" /></a>
</div>
</div>
<div class="section" id="id17">
<h4><a class="toc-backref" href="#id40">6.2.4.2.4. ログアウトボタンの追加</a><a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">ログアウトするためのボタンを追加する。</div>
<div class="line"><tt class="docutils literal"><span class="pre">src/main/webapp/WEB-INF/views/welcome/home.jsp</span></tt></div>
</div>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;title&gt;</span>Home<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span>
    <span class="na">href=</span><span class="s">&quot;${pageContext.request.contextPath}/resources/app/css/styles.css&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>

<span class="nt">&lt;sec:authentication</span> <span class="na">property=</span><span class="s">&quot;principal.account&quot;</span> <span class="na">var=</span><span class="s">&quot;account&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Hello world!<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;p&gt;</span>The time on the server is ${serverTime}.<span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;p&gt;</span>Welcome ${f:h(account.firstName)} ${f:h(account.lastName)} !!<span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;p&gt;</span>
<span class="hll">            <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">            <span class="nt">&lt;form:form</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/logout&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">                <span class="nt">&lt;button&gt;</span>Logout<span class="nt">&lt;/button&gt;</span>
</span><span class="hll">            <span class="nt">&lt;/form:form&gt;</span>
</span>        <span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;ul&gt;</span>
            <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;${pageContext.request.contextPath}/account&quot;</span><span class="nt">&gt;</span>view account<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">&lt;form:form&gt;</span></tt>タグを使用して、ログアウト用のフォームを追加する。</p>
<p class="last"><tt class="docutils literal"><span class="pre">action</span></tt>属性には、ログアウト処理用のURL(<tt class="docutils literal"><span class="pre">&quot;/logout&quot;</span></tt>)を指定して、Logoutボタンを追加する。</p>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Logoutボタンを押下し、アプリケーションからログアウトする(ログインページが表示される)。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/security_tutorial_add_logout.png"><img alt="../_images/security_tutorial_add_logout.png" src="../_images/security_tutorial_add_logout.png" style="width: 70%;" /></a>
</div>
</div>
<div class="section" id="controller">
<h4><a class="toc-backref" href="#id41">6.2.4.2.5. Controllerからログインユーザーのアカウント情報へアクセス</a><a class="headerlink" href="#controller" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Controllerからログインユーザーのアカウント情報にアクセスし、アカウント情報をViewに引き渡す。</div>
<div class="line"><tt class="docutils literal"><span class="pre">src/main/java/com/example/security/app/account/AccountController.java</span></tt></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">account</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.security.web.bind.annotation.AuthenticationPrincipal</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.ui.Model</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.security.domain.model.Account</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.security.domain.service.userdetails.SampleUserDetails</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;account&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountController</span> <span class="o">{</span>

    <span class="nd">@RequestMapping</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">view</span><span class="o">(</span>
<span class="hll">            <span class="nd">@AuthenticationPrincipal</span> <span class="n">SampleUserDetails</span> <span class="n">userDetails</span><span class="o">,</span> <span class="c1">// (1)</span>
</span>            <span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
<span class="hll">        <span class="c1">// (2)</span>
</span><span class="hll">        <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">userDetails</span><span class="o">.</span><span class="na">getAccount</span><span class="o">();</span>
</span><span class="hll">        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">account</span><span class="o">);</span>
</span>        <span class="k">return</span> <span class="s">&quot;account/view&quot;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></tt>アノテーションを指定して、ログインユーザーの<tt class="docutils literal"><span class="pre">UserDetails</span></tt>オブジェクトを受け取る。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">SampleUserDetails</span></tt>オブジェクトが保持している<tt class="docutils literal"><span class="pre">Account</span></tt>オブジェクトを取得し、Viewに引き渡すために<tt class="docutils literal"><span class="pre">Model</span></tt>に格納する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">Controllerから引き渡されたアカウント情報にアクセスし、アカウント情報を表示する。</div>
<div class="line"><tt class="docutils literal"><span class="pre">src/main/webapp/WEB-INF/views/account/view.jsp</span></tt></div>
</div>
<div class="highlight-jsp"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;title&gt;</span>Home<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span>
    <span class="na">href=</span><span class="s">&quot;${pageContext.request.contextPath}/resources/app/css/styles.css&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Account Information<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;table&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;th&gt;</span>Username<span class="nt">&lt;/th&gt;</span>
                <span class="nt">&lt;td&gt;</span>${f:h(account.username)}<span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;th&gt;</span>First name<span class="nt">&lt;/th&gt;</span>
                <span class="nt">&lt;td&gt;</span>${f:h(account.firstName)}<span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;th&gt;</span>Last name<span class="nt">&lt;/th&gt;</span>
                <span class="nt">&lt;td&gt;</span>${f:h(account.lastName)}<span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;/table&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>ウェルカムページのview accountリンクを押下して、ログインユーザーのアカウント情報表示ページを表示する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/security_tutorial_account_information_page.png"><img alt="../_images/security_tutorial_account_information_page.png" src="../_images/security_tutorial_account_information_page.png" style="width: 80%;" /></a>
</div>
</div>
<div class="section" id="id18">
<h4><a class="toc-backref" href="#id42">6.2.4.2.6. アプリケーション層の作成後のパッケージエクスプローラー</a><a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h4>
<p>アプリケーション層に作成したファイルを確認する。</p>
<p>Package ExplorerのPackage PresentationはHierarchicalを使用している。</p>
<div class="figure">
<img alt="security tutorial application layer package explorer" src="../_images/security_tutorial-application-layer-package-explorer.png" />
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="id19">
<h2><a class="toc-backref" href="#id43">6.2.5. おわりに</a><a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h2>
<p>本チュートリアルでは以下の内容を学習した。</p>
<ul class="simple">
<li>Spring Securityによる基本的な認証・認可</li>
<li>認証ユーザーオブジェクトのカスタマイズ方法</li>
<li>RepositoryおよびServiceクラスを用いた認証処理の設定</li>
<li>JSPでログイン済みアカウント情報にアクセスする方法</li>
<li>Controllerでログイン済みアカウント情報にアクセスする方法</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="appendix">
<h2><a class="toc-backref" href="#id44">6.2.6. Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this headline">¶</a></h2>
<div class="section" id="securitytutorialappendixconfigurationfiles">
<span id="id20"></span><h3><a class="toc-backref" href="#id45">6.2.6.1. 設定ファイルの解説</a><a class="headerlink" href="#securitytutorialappendixconfigurationfiles" title="Permalink to this headline">¶</a></h3>
<p>Spring Securityを利用するためにどのような設定が必要なのかを理解するために、設定ファイルの解説を行う。</p>
<div class="section" id="spring-security-xml">
<h4><a class="toc-backref" href="#id46">6.2.6.1.1. spring-security.xml</a><a class="headerlink" href="#spring-security-xml" title="Permalink to this headline">¶</a></h4>
<p><tt class="docutils literal"><span class="pre">spring-security.xml</span></tt>には、Spring Securityに関する定義を行う。</p>
<p>作成したブランクプロジェクトの<tt class="docutils literal"><span class="pre">src/main/resources/META-INF/spring/spring-security.xml</span></tt>は、以下のような設定となっている。</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
    <span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;</span><span class="nt">&gt;</span>

<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span>    <span class="nt">&lt;sec:http</span> <span class="na">pattern=</span><span class="s">&quot;/resources/**&quot;</span> <span class="na">security=</span><span class="s">&quot;none&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:http</span> <span class="na">auto-config=</span><span class="s">&quot;true&quot;</span> <span class="na">use-expressions=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<span class="hll">        <span class="c">&lt;!-- (2) --&gt;</span>
</span>        <span class="nt">&lt;sec:headers&gt;</span>
            <span class="nt">&lt;sec:cache-control</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;sec:content-type-options</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;sec:hsts</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;sec:frame-options</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;sec:xss-protection</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/sec:headers&gt;</span>
<span class="hll">        <span class="c">&lt;!-- (3) --&gt;</span>
</span>        <span class="nt">&lt;sec:csrf</span> <span class="nt">/&gt;</span>
<span class="hll">        <span class="c">&lt;!-- (4) --&gt;</span>
</span>        <span class="nt">&lt;sec:access-denied-handler</span> <span class="na">ref=</span><span class="s">&quot;accessDeniedHandler&quot;</span><span class="nt">/&gt;</span>
<span class="hll">        <span class="c">&lt;!-- (5) --&gt;</span>
</span>        <span class="nt">&lt;sec:custom-filter</span> <span class="na">ref=</span><span class="s">&quot;userIdMDCPutFilter&quot;</span> <span class="na">after=</span><span class="s">&quot;ANONYMOUS_FILTER&quot;</span><span class="nt">/&gt;</span>
<span class="hll">        <span class="c">&lt;!-- (6) --&gt;</span>
</span>        <span class="nt">&lt;sec:session-management</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/sec:http&gt;</span>

<span class="hll">    <span class="c">&lt;!-- (7) --&gt;</span>
</span>    <span class="nt">&lt;sec:authentication-manager&gt;&lt;/sec:authentication-manager&gt;</span>

<span class="hll">    <span class="c">&lt;!-- (4) --&gt;</span>
</span>    <span class="c">&lt;!-- Change View for CSRF or AccessDenied --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;accessDeniedHandler&quot;</span>
        <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.access.DelegatingAccessDeniedHandler&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;map&gt;</span>
                <span class="nt">&lt;entry</span>
                    <span class="na">key=</span><span class="s">&quot;org.springframework.security.web.csrf.InvalidCsrfTokenException&quot;</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;bean</span>
                        <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.access.AccessDeniedHandlerImpl&quot;</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;errorPage&quot;</span>
                            <span class="na">value=</span><span class="s">&quot;/WEB-INF/views/common/error/invalidCsrfTokenError.jsp&quot;</span> <span class="nt">/&gt;</span>
                    <span class="nt">&lt;/bean&gt;</span>
                <span class="nt">&lt;/entry&gt;</span>
                <span class="nt">&lt;entry</span>
                    <span class="na">key=</span><span class="s">&quot;org.springframework.security.web.csrf.MissingCsrfTokenException&quot;</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;bean</span>
                        <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.access.AccessDeniedHandlerImpl&quot;</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;errorPage&quot;</span>
                            <span class="na">value=</span><span class="s">&quot;/WEB-INF/views/common/error/missingCsrfTokenError.jsp&quot;</span> <span class="nt">/&gt;</span>
                    <span class="nt">&lt;/bean&gt;</span>
                <span class="nt">&lt;/entry&gt;</span>
            <span class="nt">&lt;/map&gt;</span>
        <span class="nt">&lt;/constructor-arg&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;bean</span>
                <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.access.AccessDeniedHandlerImpl&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;errorPage&quot;</span>
                    <span class="na">value=</span><span class="s">&quot;/WEB-INF/views/common/error/accessDeniedError.jsp&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/bean&gt;</span>
        <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

<span class="hll">    <span class="c">&lt;!-- (5) --&gt;</span>
</span>    <span class="c">&lt;!-- Put UserID into MDC --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;userIdMDCPutFilter&quot;</span> <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.security.web.logging.UserIdMDCPutFilter&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">&lt;sec:http&gt;</span></tt>タグを使用してHTTPアクセスに対して認証・認可を制御する。</p>
<p class="last">ブランクプロジェクトのデフォルトの設定では、静的リソース(js, css, imageファイルなど)にアクセスするためのURLを認証・認可の対象外にしている。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">&lt;sec:headers&gt;</span></tt>タグを使用して、セキュリティ対策用のレスポンスヘッダの付与を制御する。</p>
<p class="last">使用方法については、「<a class="reference internal" href="SpringSecurity.html#springsecurityappendixsecheaders"><em>セキュアなHTTPヘッダー付与の設定</em></a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">&lt;sec:csrf&gt;</span></tt>タグを使用して、CSRF対策を制御する。</p>
<p class="last">使用方法については、「<a class="reference internal" href="CSRF.html"><em>CSRF対策</em></a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">&lt;sec:access-denied-handler&gt;</span></tt>タグを使用して、アクセスを拒否した後の動作を制御する。</p>
<p>ブランクプロジェクトのデフォルトの設定では、</p>
<ul class="simple">
<li>不正なCSRFトークンを検知した場合(<tt class="docutils literal"><span class="pre">InvalidCsrfTokenException</span></tt>が発生した場合)の遷移先</li>
<li>トークンストアからCSRFトークンが取得できない場合(<tt class="docutils literal"><span class="pre">MissingCsrfTokenException</span></tt>が発生した場合)の遷移先</li>
<li>認可処理でアクセスが拒否された場合(上記以外の<tt class="docutils literal"><span class="pre">AccessDeniedException</span></tt>が発生した場合)の遷移先</li>
</ul>
<p class="last">が設定済みである。</p>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>Spring Securityの認証ユーザ名をロガーのMDCに格納するためのサーブレットフィルタを有効化する。
この設定を有効化すると、ログに認証ユーザ名が出力されるため、トレーサビリティを向上することができる。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">&lt;sec:session-management&gt;</span></tt>タグを使用して、Spring Securityのセッション管理方法を制御する。</p>
<p class="last">使用方法については、「<a class="reference internal" href="Authentication.html#authentication-spring-security-how-to-use-sessionmanagement"><em>Spring Securityにおけるセッション管理</em></a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">&lt;sec:authentication-manager&gt;</span></tt>タグを使用して、認証処理を制御する。</p>
<p class="last">使用方法については、「<a class="reference internal" href="Authentication.html#authenticationproviderconfiguration"><em>認証処理の設定</em></a>」を参照されたい。</p>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="spring-mvc-xml">
<h4><a class="toc-backref" href="#id47">6.2.6.1.2. spring-mvc.xml</a><a class="headerlink" href="#spring-mvc-xml" title="Permalink to this headline">¶</a></h4>
<p><tt class="docutils literal"><span class="pre">spring-mvc.xml</span></tt>には、Spring SecurityとSpring MVCを連携するための設定を行う。</p>
<p>作成したブランクプロジェクトの<tt class="docutils literal"><span class="pre">src/main/resources/META-INF/spring/spring-mvc.xml</span></tt>は、以下のような設定となっている。
Spring Securityと関係のない設定については、説明を割愛する。</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
    <span class="na">xmlns:mvc=</span><span class="s">&quot;http://www.springframework.org/schema/mvc&quot;</span> <span class="na">xmlns:util=</span><span class="s">&quot;http://www.springframework.org/schema/util&quot;</span>
    <span class="na">xmlns:aop=</span><span class="s">&quot;http://www.springframework.org/schema/aop&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd</span>
<span class="s">        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">        http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd</span>
<span class="s">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
<span class="s">        http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;context:property-placeholder</span>
        <span class="na">location=</span><span class="s">&quot;classpath*:/META-INF/spring/*.properties&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;mvc:annotation-driven&gt;</span>
        <span class="nt">&lt;mvc:argument-resolvers&gt;</span>
            <span class="nt">&lt;bean</span>
                <span class="na">class=</span><span class="s">&quot;org.springframework.data.web.PageableHandlerMethodArgumentResolver&quot;</span> <span class="nt">/&gt;</span>
<span class="hll">            <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">            <span class="nt">&lt;bean</span>
</span><span class="hll">                <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.bind.support.AuthenticationPrincipalArgumentResolver&quot;</span> <span class="nt">/&gt;</span>
</span>        <span class="nt">&lt;/mvc:argument-resolvers&gt;</span>
    <span class="nt">&lt;/mvc:annotation-driven&gt;</span>

    <span class="nt">&lt;mvc:default-servlet-handler</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">&quot;com.example.security.app&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;mvc:resources</span> <span class="na">mapping=</span><span class="s">&quot;/resources/**&quot;</span>
        <span class="na">location=</span><span class="s">&quot;/resources/,classpath:META-INF/resources/&quot;</span>
        <span class="na">cache-period=</span><span class="s">&quot;#{60 * 60}&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;mvc:interceptors&gt;</span>
        <span class="nt">&lt;mvc:interceptor&gt;</span>
            <span class="nt">&lt;mvc:mapping</span> <span class="na">path=</span><span class="s">&quot;/**&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/resources/**&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/**/*.html&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;bean</span>
                <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.logging.TraceLoggingInterceptor&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/mvc:interceptor&gt;</span>
        <span class="nt">&lt;mvc:interceptor&gt;</span>
            <span class="nt">&lt;mvc:mapping</span> <span class="na">path=</span><span class="s">&quot;/**&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/resources/**&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/**/*.html&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;bean</span>
                <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.token.transaction.TransactionTokenInterceptor&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/mvc:interceptor&gt;</span>
        <span class="nt">&lt;mvc:interceptor&gt;</span>
            <span class="nt">&lt;mvc:mapping</span> <span class="na">path=</span><span class="s">&quot;/**&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/resources/**&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/**/*.html&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.codelist.CodeListInterceptor&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;codeListIdPattern&quot;</span> <span class="na">value=</span><span class="s">&quot;CL_.+&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/bean&gt;</span>
        <span class="nt">&lt;/mvc:interceptor&gt;</span>
        <span class="c">&lt;!--  REMOVE THIS LINE IF YOU USE JPA</span>
<span class="c">        &lt;mvc:interceptor&gt;</span>
<span class="c">            &lt;mvc:mapping path=&quot;/**&quot; /&gt;</span>
<span class="c">            &lt;mvc:exclude-mapping path=&quot;/resources/**&quot; /&gt;</span>
<span class="c">            &lt;mvc:exclude-mapping path=&quot;/**/*.html&quot; /&gt;</span>
<span class="c">            &lt;bean</span>
<span class="c">                class=&quot;org.springframework.orm.jpa.support.OpenEntityManagerInViewInterceptor&quot; /&gt;</span>
<span class="c">        &lt;/mvc:interceptor&gt;</span>
<span class="c">            REMOVE THIS LINE IF YOU USE JPA  --&gt;</span>
    <span class="nt">&lt;/mvc:interceptors&gt;</span>

    <span class="c">&lt;!-- Settings View Resolver. --&gt;</span>
    <span class="nt">&lt;mvc:view-resolvers&gt;</span>
        <span class="nt">&lt;mvc:jsp</span> <span class="na">prefix=</span><span class="s">&quot;/WEB-INF/views/&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/mvc:view-resolvers&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;requestDataValueProcessor&quot;</span>
        <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.mvc.support.CompositeRequestDataValueProcessor&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg&gt;</span>
            <span class="nt">&lt;util:list&gt;</span>
<span class="hll">                <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">                <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.servlet.support.csrf.CsrfRequestDataValueProcessor&quot;</span> <span class="nt">/&gt;</span>
</span>                <span class="nt">&lt;bean</span>
                    <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.token.transaction.TransactionTokenRequestDataValueProcessor&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/util:list&gt;</span>
        <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!-- Setting Exception Handling. --&gt;</span>
    <span class="c">&lt;!-- Exception Resolver. --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.SystemExceptionResolver&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionCodeResolver&quot;</span> <span class="na">ref=</span><span class="s">&quot;exceptionCodeResolver&quot;</span> <span class="nt">/&gt;</span>
        <span class="c">&lt;!-- Setting and Customization by project. --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;order&quot;</span> <span class="na">value=</span><span class="s">&quot;3&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionMappings&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;map&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;ResourceNotFoundException&quot;</span> <span class="na">value=</span><span class="s">&quot;common/error/resourceNotFoundError&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;BusinessException&quot;</span> <span class="na">value=</span><span class="s">&quot;common/error/businessError&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;InvalidTransactionTokenException&quot;</span> <span class="na">value=</span><span class="s">&quot;common/error/transactionTokenError&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;.DataAccessException&quot;</span> <span class="na">value=</span><span class="s">&quot;common/error/dataAccessError&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/map&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;statusCodes&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;map&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;common/error/resourceNotFoundError&quot;</span> <span class="na">value=</span><span class="s">&quot;404&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;common/error/businessError&quot;</span> <span class="na">value=</span><span class="s">&quot;409&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;common/error/transactionTokenError&quot;</span> <span class="na">value=</span><span class="s">&quot;409&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;common/error/dataAccessError&quot;</span> <span class="na">value=</span><span class="s">&quot;500&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/map&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultErrorView&quot;</span> <span class="na">value=</span><span class="s">&quot;common/error/systemError&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultStatusCode&quot;</span> <span class="na">value=</span><span class="s">&quot;500&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
    <span class="c">&lt;!-- Setting AOP. --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;handlerExceptionResolverLoggingInterceptor&quot;</span>
        <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.HandlerExceptionResolverLoggingInterceptor&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionLogger&quot;</span> <span class="na">ref=</span><span class="s">&quot;exceptionLogger&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;aop:config&gt;</span>
        <span class="nt">&lt;aop:advisor</span> <span class="na">advice-ref=</span><span class="s">&quot;handlerExceptionResolverLoggingInterceptor&quot;</span>
            <span class="na">pointcut=</span><span class="s">&quot;execution(* org.springframework.web.servlet.HandlerExceptionResolver.resolveException(..))&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/aop:config&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></tt>アノテーションを指定して、ログインユーザーの<tt class="docutils literal"><span class="pre">UserDetails</span></tt>オブジェクトをControllerの引数として受け取れるようにするための設定。</p>
<p class="last"><tt class="docutils literal"><span class="pre">&lt;mvc:argument-resolvers&gt;</span></tt>タグに<tt class="docutils literal"><span class="pre">AuthenticationPrincipalArgumentResolver</span></tt>を指定する。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">&lt;form:form&gt;</span></tt>タグ(JSPタグライブラリ)を使用して、CSRFトークン値をHTMLフォームに埋め込むための設定。</p>
<p class="last"><tt class="docutils literal"><span class="pre">CompositeRequestDataValueProcessor</span></tt>のコンストラクタに<tt class="docutils literal"><span class="pre">CsrfRequestDataValueProcessor</span></tt>を指定する。</p>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="Authentication.html" title="6.3. 認証"
             >next</a> |</li>
        <li class="right" >
          <a href="SpringSecurity.html" title="6.1. Spring Security概要"
             >previous</a> |</li>
        <li><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.0.0.RELEASE documentation</a> &raquo;</li>
          <li><a href="index.html" >6. TERASOLUNA Server Framework for Java (5.x)によるセキュリティ対策</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013-2015, NTT DATA.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.Theme by <a href="http://github.com/vkvn">vkvn</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>
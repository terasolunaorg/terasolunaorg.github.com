<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>8.1. E-mail送信(SMTP) &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.9.0.RELEASE documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/solar.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/tabs.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="8.2. JMS(Jakarta Messaging)" href="JMS.html" />
    <link rel="prev" title="8. メッセージ連携" href="index.html" /><script src="../../_static/jquery.js" type="text/javascript"></script>
<script src="../../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../../_static/solarized-dark.css" rel="stylesheet">
<link href="../../_static/jquery.treeview.css" rel="stylesheet">
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="JMS.html" title="8.2. JMS(Jakarta Messaging)"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="8. メッセージ連携"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.9.0.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U"><span class="section-number">8. </span>メッセージ連携</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">8.1. </span>E-mail送信(SMTP)</a></li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox"> scroll sidebar</label>
  <div>
    <h3><a href="../../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">8.1. E-mail送信(SMTP)</a><ul>
<li><a class="reference internal" href="#overview">8.1.1. Overview</a><ul>
<li><a class="reference internal" href="#jakarta-mail">8.1.1.1. Jakarta Mailについて</a></li>
<li><a class="reference internal" href="#spring-frameworkmail">8.1.1.2. Spring FrameworkのMail連携用コンポーネントについて</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">8.1.2. How to use</a><ul>
<li><a class="reference internal" href="#depends-jakartamail">8.1.2.1. 依存ライブラリについて</a></li>
<li><a class="reference internal" href="#javamailsender">8.1.2.2. JavaMailSenderの設定方法</a><ul>
<li><a class="reference internal" href="#id5">8.1.2.2.1. アプリケーションサーバ提供のメールセッションを使用する場合</a></li>
<li><a class="reference internal" href="#id6">8.1.2.2.2. アプリケーションサーバ提供のメールセッションを使用しない場合（認証なし）</a></li>
<li><a class="reference internal" href="#id7">8.1.2.2.3. アプリケーションサーバ提供のメールセッションを使用しない場合（認証あり）</a></li>
</ul>
</li>
<li><a class="reference internal" href="#simplemailmessage">8.1.2.3. SimpleMailMessageによるメール送信方法</a></li>
<li><a class="reference internal" href="#id8">8.1.2.4. MimeMessageによるメール送信方法</a><ul>
<li><a class="reference internal" href="#email-text">8.1.2.4.1. テキストメールの送信</a></li>
<li><a class="reference internal" href="#html">8.1.2.4.2. HTMLメールの送信</a></li>
<li><a class="reference internal" href="#email-attachment">8.1.2.4.3. 添付ファイル付きメールの送信</a></li>
<li><a class="reference internal" href="#email-inline-resource">8.1.2.4.4. インラインリソース付きメールの送信</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id12">8.1.2.5. メール送信時の例外について</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend">8.1.3. How to extend</a><ul>
<li><a class="reference internal" href="#id13">8.1.3.1. テンプレートを使用したメール本文の作成方法</a><ul>
<li><a class="reference internal" href="#freemarker">8.1.3.1.1. FreeMarkerを使用したメール本文の作成</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix">8.1.4. Appendix</a><ul>
<li><a class="reference internal" href="#iso-2022-jp">8.1.4.1. ISO-2022-JPのエンコードについての考慮</a></li>
<li><a class="reference internal" href="#javamail">8.1.4.2. JavaMailで発生していたマルチバイト文字を使用する際の不具合について</a></li>
<li><a class="reference internal" href="#email-header-injection">8.1.4.3. メールヘッダ・インジェクション対策</a></li>
<li><a class="reference internal" href="#email-processing-method">8.1.4.4. 処理方式</a><ul>
<li><a class="reference internal" href="#id18">8.1.4.4.1. データベースまたはメッセージキューに保持されたメール情報をもとにメール送信を行う</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="index.html"
                          title="previous chapter"><span class="section-number">8. </span>メッセージ連携</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="JMS.html"
                          title="next chapter"><span class="section-number">8.2. </span>JMS(Jakarta Messaging)</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/ArchitectureInDetail/MessagingDetail/Email.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="e-mail-smtp">
<h1><span class="section-number">8.1. </span>E-mail送信(SMTP)<a class="headerlink" href="#e-mail-smtp" title="Permalink to this heading">¶</a></h1>
<nav class="contents local" id="id1">
<p class="topic-title">目次</p>
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id23">Overview</a></p>
<ul>
<li><p><a class="reference internal" href="#jakarta-mail" id="id24">Jakarta Mailについて</a></p></li>
<li><p><a class="reference internal" href="#spring-frameworkmail" id="id25">Spring FrameworkのMail連携用コンポーネントについて</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#how-to-use" id="id26">How to use</a></p>
<ul>
<li><p><a class="reference internal" href="#depends-jakartamail" id="id27">依存ライブラリについて</a></p></li>
<li><p><a class="reference internal" href="#javamailsender" id="id28">JavaMailSenderの設定方法</a></p>
<ul>
<li><p><a class="reference internal" href="#id5" id="id29">アプリケーションサーバ提供のメールセッションを使用する場合</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id30">アプリケーションサーバ提供のメールセッションを使用しない場合（認証なし）</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id31">アプリケーションサーバ提供のメールセッションを使用しない場合（認証あり）</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#simplemailmessage" id="id32">SimpleMailMessageによるメール送信方法</a></p></li>
<li><p><a class="reference internal" href="#id8" id="id33">MimeMessageによるメール送信方法</a></p>
<ul>
<li><p><a class="reference internal" href="#email-text" id="id34">テキストメールの送信</a></p></li>
<li><p><a class="reference internal" href="#html" id="id35">HTMLメールの送信</a></p></li>
<li><p><a class="reference internal" href="#email-attachment" id="id36">添付ファイル付きメールの送信</a></p></li>
<li><p><a class="reference internal" href="#email-inline-resource" id="id37">インラインリソース付きメールの送信</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id12" id="id38">メール送信時の例外について</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#how-to-extend" id="id39">How to extend</a></p>
<ul>
<li><p><a class="reference internal" href="#id13" id="id40">テンプレートを使用したメール本文の作成方法</a></p>
<ul>
<li><p><a class="reference internal" href="#freemarker" id="id41">FreeMarkerを使用したメール本文の作成</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#appendix" id="id42">Appendix</a></p>
<ul>
<li><p><a class="reference internal" href="#iso-2022-jp" id="id43">ISO-2022-JPのエンコードについての考慮</a></p></li>
<li><p><a class="reference internal" href="#javamail" id="id44">JavaMailで発生していたマルチバイト文字を使用する際の不具合について</a></p></li>
<li><p><a class="reference internal" href="#email-header-injection" id="id45">メールヘッダ・インジェクション対策</a></p></li>
<li><p><a class="reference internal" href="#email-processing-method" id="id46">処理方式</a></p>
<ul>
<li><p><a class="reference internal" href="#id18" id="id47">データベースまたはメッセージキューに保持されたメール情報をもとにメール送信を行う</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="overview">
<h2><a class="toc-backref" href="#id23" role="doc-backlink"><span class="section-number">8.1.1. </span>Overview</a><a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h2>
<p>本節では、SMTPによるE-mailの送信方法について説明する。</p>
<p>本ガイドラインでは、Jakarta MailのAPIとSpring Frameworkから提供されているMail連携用コンポーネントを利用することを前提としている。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>説明の対象としているのはメールを送信する部分のみである。メール送信に係る処理方式については言及していない。（<a class="reference internal" href="#email-processing-method"><span class="std std-ref">処理方式</span></a>において一例を紹介している。）</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="jakarta-mail">
<h3><a class="toc-backref" href="#id24" role="doc-backlink"><span class="section-number">8.1.1.1. </span>Jakarta Mailについて</a><a class="headerlink" href="#jakarta-mail" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line"><a class="reference external" href="https://eclipse-ee4j.github.io/angus-mail/">Jakarta Mail</a>は、Javaでメールの送受信を行うためのAPIを提供している。</div>
<div class="line">Jakarta Mailを利用することで、メール機能を容易にJavaアプリケーションに組み込むことができる。</div>
</div>
<div class="line-block">
<div class="line">なお、本ガイドラインでは、Spring FrameworkのMail連携用コンポーネントを利用する前提であるため、Jakarta MailのAPIについての詳細には触れていない。</div>
<div class="line">Jakarta MailのAPI仕様については、<a class="reference external" href="https://jakarta.ee/specifications/mail/2.1/jakarta-mail-spec-2.1.html">API Documentation</a>を参照されたい。</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>メールセッション</strong></p>
<p>メールセッション（<a class="reference external" href="https://jakarta.ee/specifications/mail/2.1/apidocs/jakarta.mail/jakarta/mail/session">Session</a>）は、メールサーバに接続する際に必要となる情報を管理する。</p>
<p>メールセッションを取得するには以下のような方法がある。</p>
<ul class="simple">
<li><p>典型的なエンタープライズアプリケーションにおいては、Jakarta EE（Java EE）のコンテナで管理されたメールセッションをJNDI経由で取得する。</p></li>
<li><p>Tomcatの場合はリソースファクトリで定義したメールセッションをJNDI経由で取得する。</p></li>
<li><p>staticファクトリメソッドを利用してBean定義したメールセッションをDIコンテナから取得する。</p></li>
<li><p>Javaソースから直接<code class="docutils literal notranslate"><span class="pre">Session</span></code>のstaticファクトリメソッドを利用して取得する。</p></li>
</ul>
<p>なお、後述するSpringの<code class="docutils literal notranslate"><span class="pre">JavaMailSenderImpl</span></code>を使用すると、メールセッションを直接扱わずにメールサーバと接続することも可能である。</p>
<p>本ガイドラインでは、以下の二つの方法による実装例を紹介する。</p>
<ul class="simple">
<li><p>メールセッションをJNDI経由で取得する方法</p></li>
<li><p>セッションを直接扱わずに<code class="docutils literal notranslate"><span class="pre">JavaMailSenderImpl</span></code>のプロパティに接続情報を指定する方法</p></li>
</ul>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="spring-frameworkmail">
<h3><a class="toc-backref" href="#id25" role="doc-backlink"><span class="section-number">8.1.1.2. </span>Spring FrameworkのMail連携用コンポーネントについて</a><a class="headerlink" href="#spring-frameworkmail" title="Permalink to this heading">¶</a></h3>
<p>Spring Frameworkはメール送信を行うためのコンポーネント（<code class="docutils literal notranslate"><span class="pre">org.springframework.mail</span></code>パッケージ）を提供している。
このパッケージに含まれるコンポーネントはメール送信に係る詳細なロジックを隠蔽し、低レベルのAPIハンドリング(Jakarta MailのAPI呼び出し)を代行する。</p>
<p>具体的な実装方法の説明を行う前に、Spring Frameworkが提供するメール送信用のコンポーネントがどのようにメールを送信しているかを説明する。</p>
<figure class="align-default">
<a class="reference internal image-reference" href="../../_images/EmailOverview.png"><img alt="Constitution of Spring Mail" src="../../_images/EmailOverview.png" style="width: 100%;" /></a>
</figure>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 11.1%" />
<col style="width: 22.2%" />
<col style="width: 66.7%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>コンポーネント</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">アプリケーション</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">JavaMailSender</span></code>のメソッドを呼び出し、メールの送信依頼を行う。</div>
<div class="line"><br /></div>
<div class="line">* 単純なメッセージを送信する場合は、<code class="docutils literal notranslate"><span class="pre">SimpleMailMessage</span></code>を生成し宛先や本文を設定することでメールを送信することもできる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">JavaMailSender</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">アプリケーションから指定された<code class="docutils literal notranslate"><span class="pre">MimeMessagePreparator</span></code>(Jakarta Mailの<code class="docutils literal notranslate"><span class="pre">MimeMessage</span></code>を作成するためのコールバックインターフェース)を呼び出し、メール送信用のメッセージ(<code class="docutils literal notranslate"><span class="pre">MimeMessage</span></code>)の作成依頼を行う。</div>
<div class="line"><br /></div>
<div class="line">* <code class="docutils literal notranslate"><span class="pre">SimpleMailMessage</span></code>を使用してメッセージを送信する場合はこの処理は呼びだされない。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">アプリケーション</div>
<div class="line">(<code class="docutils literal notranslate"><span class="pre">MimeMessagePreparator</span></code>)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">MimeMessageHelper</span></code>のメソッドを利用して、メール送信用のメッセージ(<code class="docutils literal notranslate"><span class="pre">MimeMessage</span></code>)を作成する。</div>
<div class="line"><br /></div>
<div class="line">* <code class="docutils literal notranslate"><span class="pre">SimpleMailMessage</span></code>を使用してメッセージを送信する場合はこの処理は呼びだされない。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">JavaMailSender</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Jakarta MailのAPIを使用して、メールの送信依頼を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Jakarta Mail</div>
</div>
</td>
<td><div class="line-block">
<div class="line">メールサーバへメッセージを送信する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>本ガイドラインでは、以下のインタフェースやクラスを使用してメール送信処理を実装する方法について説明する。</p>
<ul>
<li><dl>
<dt><code class="docutils literal notranslate"><span class="pre">JavaMailSender</span></code></dt><dd><div class="line-block">
<div class="line">Jakarta Mail用のメール送信インターフェース。</div>
<div class="line">Jakarta Mailの<a class="reference external" href="https://jakarta.ee/specifications/mail/2.1/apidocs/jakarta.mail/jakarta/mail/internet/mimemessage">MimeMessage</a>とSpringの<code class="docutils literal notranslate"><span class="pre">SimpleMailMessage</span></code>の両方に対応している。</div>
<div class="line">また、Jakarta Mailの<code class="docutils literal notranslate"><span class="pre">Session</span></code>の管理は<code class="docutils literal notranslate"><span class="pre">JavaMailSender</span></code>の実装クラスによって行われるため、メール送信処理をコーディングする際に<code class="docutils literal notranslate"><span class="pre">Session</span></code>を直接扱う必要がない。</div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt><code class="docutils literal notranslate"><span class="pre">JavaMailSenderImpl</span></code></dt><dd><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">JavaMailSender</span></code>インタフェースの実装クラス。</div>
<div class="line">このクラスでは、設定済みの<code class="docutils literal notranslate"><span class="pre">Session</span></code>をDIする方法と、プロパティに指定した接続情報から<code class="docutils literal notranslate"><span class="pre">Session</span></code>を作成する方法をサポートしている。</div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt><code class="docutils literal notranslate"><span class="pre">MimeMessagePreparator</span></code></dt><dd><div class="line-block">
<div class="line">Jakarta Mailの<code class="docutils literal notranslate"><span class="pre">MimeMessage</span></code>を作成するためのコールバックインターフェース。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">JavaMailSender</span></code>の<code class="docutils literal notranslate"><span class="pre">send</span></code>メソッド内から呼び出される。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">MimeMessagePreparator</span></code>の<code class="docutils literal notranslate"><span class="pre">prepare</span></code>メソッドで発生した例外は<code class="docutils literal notranslate"><span class="pre">MailPreparationException</span></code>（実行時例外）にラップされ再スローされる。</div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt><code class="docutils literal notranslate"><span class="pre">MimeMessageHelper</span></code></dt><dd><div class="line-block">
<div class="line">Jakarta Mailの<code class="docutils literal notranslate"><span class="pre">MimeMessage</span></code>の作成を容易にするためのヘルパークラス。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">MimeMessageHelper</span></code>には、<code class="docutils literal notranslate"><span class="pre">MimeMessage</span></code>に値を設定するための便利なメソッドがいくつも用意されている。</div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt><code class="docutils literal notranslate"><span class="pre">SimpleMailMessage</span></code></dt><dd><div class="line-block">
<div class="line">単純なメールメッセージを作成するためのクラス。</div>
<div class="line">英文のプレーンテキストメールを作成する際に使用できる。</div>
<div class="line">UTF-8等の特定のエンコード指定、HTMLメールや添付ファイル付きメールの送信、あるいはメールアドレスに個人名を付随させるといったリッチなメッセージの作成を行う際は、Jakarta Mailの<code class="docutils literal notranslate"><span class="pre">MimeMessage</span></code>を使用する必要がある。</div>
</div>
</dd>
</dl>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="how-to-use">
<h2><a class="toc-backref" href="#id26" role="doc-backlink"><span class="section-number">8.1.2. </span>How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this heading">¶</a></h2>
<section id="depends-jakartamail">
<span id="id3"></span><h3><a class="toc-backref" href="#id27" role="doc-backlink"><span class="section-number">8.1.2.1. </span>依存ライブラリについて</a><a class="headerlink" href="#depends-jakartamail" title="Permalink to this heading">¶</a></h3>
<p>Spring FrameworkのMail連携用コンポーネントを利用する場合、以下のライブラリが追加で必要となる。</p>
<ul class="simple">
<li><p><a class="reference external" href="https://eclipse-ee4j.github.io/angus-mail/">Jakarta Mail</a></p></li>
</ul>
<div class="line-block">
<div class="line">上記ライブラリに対する依存関係を<code class="file docutils literal notranslate"><span class="pre">pom.xml</span></code>に追加する。</div>
<div class="line">マルチプロジェクト構成の場合は、domainプロジェクトの<code class="file docutils literal notranslate"><span class="pre">pom.xml</span></code>(<code class="file docutils literal notranslate"><span class="pre">projectName-domain/pom.xml</span></code>)に追加する。</div>
</div>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;dependencies&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.eclipse.angus<span class="nt">&lt;/groupId&gt;</span>
<span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>jakarta.mail<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>

<span class="nt">&lt;/dependencies&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Jakarta Mailのライブラリをdependenciesに追加する。</div>
<div class="line">アプリケーションサーバ提供のメールセッションを使用する場合、<code class="docutils literal notranslate"><span class="pre">&lt;scope&gt;</span></code>を<code class="docutils literal notranslate"><span class="pre">provided</span></code>に設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>上記設定例は、依存ライブラリのバージョンを親プロジェクトである terasoluna-gfw-parent で管理する前提であるため、pom.xmlでのバージョンの指定は不要である。</p>
<p>上記の依存ライブラリはterasoluna-gfw-parentが依存している<a class="reference external" href="https://docs.spring.io/spring-boot/docs/3.2.2/reference/htmlsingle/#dependency-versions">Spring Boot</a>で管理されている。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="javamailsender">
<h3><a class="toc-backref" href="#id28" role="doc-backlink"><span class="section-number">8.1.2.2. </span>JavaMailSenderの設定方法</a><a class="headerlink" href="#javamailsender" title="Permalink to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">JavaMailSender</span></code>をDIするためのBean定義を行う。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>マルチプロジェクト構成の場合は、envプロジェクトの<code class="file docutils literal notranslate"><span class="pre">projectName-env.xml</span></code>に設定することを推奨する。なお、本ガイドラインでは、マルチプロジェクト構成を採用することを推奨している。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="id5">
<h4><a class="toc-backref" href="#id29" role="doc-backlink"><span class="section-number">8.1.2.2.1. </span>アプリケーションサーバ提供のメールセッションを使用する場合</a><a class="headerlink" href="#id5" title="Permalink to this heading">¶</a></h4>
<p>アプリケーションサーバ提供のメールセッションを使用する場合の設定例を以下に示す。</p>
<blockquote>
<div><table class="docutils align-default" id="id19">
<caption><span class="caption-text"><strong>アプリケーションサーバから提供されているメールセッション</strong></span><a class="headerlink" href="#id19" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 10.0%" />
<col style="width: 35.0%" />
<col style="width: 55.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>アプリケーションサーバ</p></th>
<th class="head"><p>参照ページ</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li></li>
</ol>
</td>
<td><p>Apache Tomcat 10.1</p></td>
<td><div class="line-block">
<div class="line"><a class="reference external" href="https://tomcat.apache.org/tomcat-10.1-doc/jndi-resources-howto.html#JavaMail_Sessions">Apache Tomcat 10.1 User Guide(JNDI Resources HOW-TO)</a>(JavaMail Sessions)を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>JNDI経由で取得したメールセッションをBeanとして登録するための設定を行う。</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-0-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-0-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-0-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-0-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-0-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;mailSession&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">Session</span><span class="w"> </span><span class="nf">mailSession</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">JndiObjectFactoryBean</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JndiObjectFactoryBean</span><span class="p">();</span>
<span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">setJndiName</span><span class="p">(</span><span class="s">&quot;mail/Session&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">setResourceRef</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">afterPropertiesSet</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">Session</span><span class="p">)</span><span class="w"> </span><span class="n">bean</span><span class="p">.</span><span class="na">getObject</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">JndiObjectFactoryBean</span></code>クラスの<code class="docutils literal notranslate"><span class="pre">JndiName</span></code>に、アプリケーションサーバ提供のメールセッションのJNDI名を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ResourceRef</span></code>を<code class="docutils literal notranslate"><span class="pre">true</span></code>とすることでJNDI名に<code class="docutils literal notranslate"><span class="pre">java:comp/env</span></code>が付与される。</div>
<div class="line">上記例では、JDNI名が<code class="docutils literal notranslate"><span class="pre">java:comp/env/mail/Session</span></code>となる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>次に、<code class="docutils literal notranslate"><span class="pre">JavaMailSender</span></code>をBean定義する。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;mailSender&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">JavaMailSender</span><span class="w"> </span><span class="nf">mailSender</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">JavaMailSenderImpl</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JavaMailSenderImpl</span><span class="p">();</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">setSession</span><span class="p">(</span><span class="n">mailSession</span><span class="p">());</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">JavaMailSenderImpl</span></code>をBean定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">session</span></code>プロパティに設定済みのメールセッションのBeanを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div><div aria-labelledby="tab-0-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;beans</span><span class="w"> </span><span class="na">xmlns:jee=</span><span class="s">&quot;http://www.springframework.org/schema/jee&quot;</span>
<span class="w">    </span><span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee.xsd</span>
<span class="s">    &quot;</span><span class="nt">&gt;</span>

<span class="w">    </span><span class="nt">&lt;jee:jndi-lookup</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;mailSession&quot;</span><span class="w"> </span><span class="na">jndi-name=</span><span class="s">&quot;mail/Session&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) (2) --&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&lt;jee:jndi-lookup&gt;</span></code>要素の<code class="docutils literal notranslate"><span class="pre">jndi-name</span></code>属性に、アプリケーションサーバ提供のメールセッションのJNDI名を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ResourceRef</span></code>はデフォルトで<code class="docutils literal notranslate"><span class="pre">true</span></code>となっているため、JNDI名に<code class="docutils literal notranslate"><span class="pre">java:comp/env</span></code>が付与される。</div>
<div class="line">上記例では、JDNI名が<code class="docutils literal notranslate"><span class="pre">java:comp/env/mail/Session</span></code>となる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>次に、<code class="docutils literal notranslate"><span class="pre">JavaMailSender</span></code>をBean定義する。</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;mailSender&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.mail.javamail.JavaMailSenderImpl&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;session&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;mailSession&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">JavaMailSenderImpl</span></code>をBean定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">session</span></code>プロパティに設定済みのメールセッションのBeanを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id6">
<h4><a class="toc-backref" href="#id30" role="doc-backlink"><span class="section-number">8.1.2.2.2. </span>アプリケーションサーバ提供のメールセッションを使用しない場合（認証なし）</a><a class="headerlink" href="#id6" title="Permalink to this heading">¶</a></h4>
<p>認証が必要ない場合の設定例を以下に示す。</p>
<p><code class="docutils literal notranslate"><span class="pre">JavaMailSender</span></code>をBean定義する。</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-1-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-1-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-1-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-1-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-1-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-1-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// (2)</span>
<span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${mail.smtp.host}&quot;</span><span class="p">)</span>
<span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">host</span><span class="p">;</span>

<span class="c1">// (3)</span>
<span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${mail.smtp.port}&quot;</span><span class="p">)</span>
<span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="p">;</span>

<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;mailSender&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">JavaMailSender</span><span class="w"> </span><span class="nf">mailSender</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">JavaMailSenderImpl</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JavaMailSenderImpl</span><span class="p">();</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">setHost</span><span class="p">(</span><span class="n">host</span><span class="p">);</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">setPort</span><span class="p">(</span><span class="n">port</span><span class="p">);</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">JavaMailSenderImpl</span></code>をBean定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">host</span></code>プロパティにSMTPサーバのホスト名を指定する。</div>
<div class="line">この例では、プロパティファイルで定義した値（キー「<code class="docutils literal notranslate"><span class="pre">mail.smtp.host</span></code>」に対する値）を設定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">port</span></code>プロパティにSMTPサーバのポート番号を指定する。</div>
<div class="line">この例では、プロパティファイルで定義した値（キー「<code class="docutils literal notranslate"><span class="pre">mail.smtp.port</span></code>」に対する値）を設定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div><div aria-labelledby="tab-1-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-1-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;mailSender&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.mail.javamail.JavaMailSenderImpl&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;host&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${mail.smtp.host}&quot;</span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;port&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${mail.smtp.port}&quot;</span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">JavaMailSenderImpl</span></code>をBean定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">host</span></code>プロパティにSMTPサーバのホスト名を指定する。</div>
<div class="line">この例では、プロパティファイルで定義した値（キー「<code class="docutils literal notranslate"><span class="pre">mail.smtp.host</span></code>」に対する値）を設定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">port</span></code>プロパティにSMTPサーバのポート番号を指定する。</div>
<div class="line">この例では、プロパティファイルで定義した値（キー「<code class="docutils literal notranslate"><span class="pre">mail.smtp.port</span></code>」に対する値）を設定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>プロパティファイルについての詳細は、<a class="reference internal" href="../GeneralFuncDetail/PropertyManagement.html"><span class="doc">プロパティ管理</span></a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id7">
<h4><a class="toc-backref" href="#id31" role="doc-backlink"><span class="section-number">8.1.2.2.3. </span>アプリケーションサーバ提供のメールセッションを使用しない場合（認証あり）</a><a class="headerlink" href="#id7" title="Permalink to this heading">¶</a></h4>
<p>認証が必要な場合の設定例を以下に示す。</p>
<p><code class="docutils literal notranslate"><span class="pre">JavaMailSender</span></code>をBean定義する。</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-2-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-2-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-2-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-2-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-2-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-2-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${mail.smtp.host}&quot;</span><span class="p">)</span>
<span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">host</span><span class="p">;</span>

<span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${mail.smtp.port}&quot;</span><span class="p">)</span>
<span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="p">;</span>

<span class="c1">// (1)</span>
<span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${mail.smtp.user}&quot;</span><span class="p">)</span>
<span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">;</span>

<span class="c1">// (2)</span>
<span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${mail.smtp.password}&quot;</span><span class="p">)</span>
<span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>

<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;mailSenderAuth&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">JavaMailSender</span><span class="w"> </span><span class="nf">mailSenderAuth</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">JavaMailSenderImpl</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JavaMailSenderImpl</span><span class="p">();</span>
<span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">setHost</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">setPort</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">setUsername</span><span class="p">(</span><span class="n">username</span><span class="p">);</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">setPassword</span><span class="p">(</span><span class="n">password</span><span class="p">);</span><span class="w"> </span><span class="c1">// (2)</span>

<span class="w">    </span><span class="n">Properties</span><span class="w"> </span><span class="n">prop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Properties</span><span class="p">();</span>
<span class="w">    </span><span class="n">prop</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="s">&quot;mail.smtp.auth&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">setJavaMailProperties</span><span class="p">(</span><span class="n">prop</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">username</span></code>プロパティにSMTPサーバのユーザ名を指定する。</div>
<div class="line">この例では、プロパティファイルで定義した値（キー「<code class="docutils literal notranslate"><span class="pre">mail.smtp.user</span></code>」に対する値）を設定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">password</span></code>プロパティにSMTPサーバのパスワードを指定する。</div>
<div class="line">この例では、プロパティファイルで定義した値（キー「<code class="docutils literal notranslate"><span class="pre">mail.smtp.password</span></code>」に対する値）を設定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">javaMailProperties</span></code>プロパティにキー「<code class="docutils literal notranslate"><span class="pre">mail.smtp.auth</span></code>」として<code class="docutils literal notranslate"><span class="pre">true</span></code>を設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div><div aria-labelledby="tab-2-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-2-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;mailSender&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.mail.javamail.JavaMailSenderImpl&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;host&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${mail.smtp.host}&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;port&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${mail.smtp.port}&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;username&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${mail.smtp.user}&quot;</span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;password&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${mail.smtp.password}&quot;</span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;javaMailProperties&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;props&gt;</span>
<span class="w">            </span><span class="nt">&lt;prop</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;mail.smtp.auth&quot;</span><span class="nt">&gt;</span>true<span class="nt">&lt;/prop&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="w">        </span><span class="nt">&lt;/props&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">username</span></code>プロパティにSMTPサーバのユーザ名を指定する。</div>
<div class="line">この例では、プロパティファイルで定義した値（キー「<code class="docutils literal notranslate"><span class="pre">mail.smtp.user</span></code>」に対する値）を設定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">password</span></code>プロパティにSMTPサーバのパスワードを指定する。</div>
<div class="line">この例では、プロパティファイルで定義した値（キー「<code class="docutils literal notranslate"><span class="pre">mail.smtp.password</span></code>」に対する値）を設定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">javaMailProperties</span></code>プロパティにキー「<code class="docutils literal notranslate"><span class="pre">mail.smtp.auth</span></code>」として<code class="docutils literal notranslate"><span class="pre">true</span></code>を設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>プロパティファイルについての詳細は、<a class="reference internal" href="../GeneralFuncDetail/PropertyManagement.html"><span class="doc">プロパティ管理</span></a> を参照されたい。</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>TLSによる接続が必要な場合、<code class="docutils literal notranslate"><span class="pre">javaMailProperties</span></code>プロパティにキー「<code class="docutils literal notranslate"><span class="pre">mail.smtp.starttls.enable</span></code>」として<code class="docutils literal notranslate"><span class="pre">true</span></code>を設定する。なお、左記のとおり指定した場合でもSMTPサーバがSTARTTLSをサポートしていない場合は平文による通信が行われる。</p>
<p>必要に応じて<code class="docutils literal notranslate"><span class="pre">javaMailProperties</span></code>プロパティにキー「<code class="docutils literal notranslate"><span class="pre">mail.smtp.starttls.required</span></code>」として<code class="docutils literal notranslate"><span class="pre">true</span></code>を設定することで、STARTTLSを利用できない場合にエラーとすることも可能である。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="simplemailmessage">
<h3><a class="toc-backref" href="#id32" role="doc-backlink"><span class="section-number">8.1.2.3. </span>SimpleMailMessageによるメール送信方法</a><a class="headerlink" href="#simplemailmessage" title="Permalink to this heading">¶</a></h3>
<p>英文のプレーンテキストメール（エンコードの指定や添付ファイル等が不要なメール）を送信する場合は、Springが提供している<code class="docutils literal notranslate"><span class="pre">SimpleMailMessage</span></code>クラスを使用する。</p>
<p>以下に、<code class="docutils literal notranslate"><span class="pre">SimpleMailMessage</span></code>クラスを使用したメール送信方法を説明する。</p>
<p><strong>Bean定義例</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-3-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-3-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-3-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-3-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-3-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-3-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;templateMessage&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">SimpleMailMessage</span><span class="w"> </span><span class="nf">templateMessage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">SimpleMailMessage</span><span class="w"> </span><span class="n">templateMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SimpleMailMessage</span><span class="p">();</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="n">templateMessage</span><span class="p">.</span><span class="na">setFrom</span><span class="p">(</span><span class="s">&quot;info@example.com&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="n">templateMessage</span><span class="p">.</span><span class="na">setSubject</span><span class="p">(</span><span class="s">&quot;Registration confirmation.&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">templateMessage</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">テンプレートとして<code class="docutils literal notranslate"><span class="pre">SimpleMailMessage</span></code>をBean定義する。</div>
<div class="line">テンプレートの<code class="docutils literal notranslate"><span class="pre">SimpleMailMessage</span></code>を利用するのは必須ではないが、メールメッセージで固定的な箇所（例えば送信元メールアドレス等）をテンプレート化しておくことで、メールメッセージ作成時に個別に設定する必要がなくなる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">from</span></code>プロパティにFromヘッダの内容を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">subject</span></code>プロパティにSubjectヘッダの内容を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div><div aria-labelledby="tab-3-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-3-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;templateMessage&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.mail.SimpleMailMessage&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;from&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;info@example.com&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;subject&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;Registration confirmation.&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">テンプレートとして<code class="docutils literal notranslate"><span class="pre">SimpleMailMessage</span></code>をBean定義する。</div>
<div class="line">テンプレートの<code class="docutils literal notranslate"><span class="pre">SimpleMailMessage</span></code>を利用するのは必須ではないが、メールメッセージで固定的な箇所（例えば送信元メールアドレス等）をテンプレート化しておくことで、メールメッセージ作成時に個別に設定する必要がなくなる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">from</span></code>プロパティにFromヘッダの内容を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">subject</span></code>プロパティにSubjectヘッダの内容を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></div>
<p><strong>Javaクラスの実装例</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="n">JavaMailSender</span><span class="w"> </span><span class="n">mailSender</span><span class="p">;</span><span class="w"> </span><span class="c1">// (1)</span>

<span class="nd">@Inject</span>
<span class="n">SimpleMailMessage</span><span class="w"> </span><span class="n">templateMessage</span><span class="p">;</span><span class="w"> </span><span class="c1">// (2)</span>

<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// omitted</span>

<span class="w">    </span><span class="c1">// (3)</span>
<span class="w">    </span><span class="n">SimpleMailMessage</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SimpleMailMessage</span><span class="p">(</span><span class="n">templateMessage</span><span class="p">);</span>
<span class="w">    </span><span class="n">message</span><span class="p">.</span><span class="na">setTo</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getEmailAddress</span><span class="p">());</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Hi &quot;</span>
<span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getUserName</span><span class="p">()</span>
<span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, welcome to EXAMPLE.COM!\r\n&quot;</span>
<span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;If you were not an intended recipient, Please notify the sender.&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">message</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
<span class="w">    </span><span class="n">mailSender</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// omitted</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">JavaMailSender</span></code>をインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">テンプレートとしてBean定義した<code class="docutils literal notranslate"><span class="pre">SimpleMailMessage</span></code>をインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">テンプレートのBeanを利用して<code class="docutils literal notranslate"><span class="pre">SimpleMailMessage</span></code>のインスタンスを生成し、Toヘッダと本文を設定して送信する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<table class="docutils align-default" id="id20">
<caption><span class="caption-text"><strong>SimpleMailMessageで設定可能なプロパティ</strong></span><a class="headerlink" href="#id20" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 10.0%" />
<col style="width: 30.0%" />
<col style="width: 60.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>プロパティ</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">1.</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">from</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Fromヘッダを設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">2.</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">to</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Toヘッダを設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">3.</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">cc</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Ccヘッダを設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">4.</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">bcc</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Bccヘッダを設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">5.</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">subject</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Subjectヘッダを設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">6.</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">replyTo</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Reply-Toヘッダを設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">7.</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">sentDate</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Dateヘッダを設定する。</div>
<div class="line">なお、明示的に設定しない場合は送信時にシステム時刻（<code class="docutils literal notranslate"><span class="pre">new</span> <span class="pre">Date()</span></code>）が自動設定される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">8.</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">text</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">本文を設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>To、Cc、Bccに複数の宛先を設定する場合は配列にして設定する。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>メールヘッダを設定する場合、メールヘッダ・インジェクションに対する考慮が必要となる。</p>
<p>詳細は<a class="reference internal" href="#email-header-injection"><span class="std std-ref">メールヘッダ・インジェクション対策</span></a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id8">
<h3><a class="toc-backref" href="#id33" role="doc-backlink"><span class="section-number">8.1.2.4. </span>MimeMessageによるメール送信方法</a><a class="headerlink" href="#id8" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">英文以外のメールやHTMLメール、添付ファイルの送信を行う場合、<code class="docutils literal notranslate"><span class="pre">jakarta.mail.internet.MimeMessage</span></code>クラスを使用する。</div>
<div class="line">本ガイドラインでは<code class="docutils literal notranslate"><span class="pre">MimeMessageHelper</span></code>クラスを使用して<code class="docutils literal notranslate"><span class="pre">MimeMessage</span></code>を作成する方法を推奨している。</div>
</div>
<p>本項では、<code class="docutils literal notranslate"><span class="pre">MimeMessageHelper</span></code>クラスを使用した以下のメール送信方法を説明する。</p>
<ul class="simple">
<li><p><a class="reference internal" href="#email-text"><span class="std std-ref">テキストメールの送信</span></a></p></li>
<li><p><a class="reference internal" href="#email-html"><span class="std std-ref">HTMLメールの送信</span></a></p></li>
<li><p><a class="reference internal" href="#email-attachment"><span class="std std-ref">添付ファイル付きメールの送信</span></a></p></li>
<li><p><a class="reference internal" href="#email-inline-resource"><span class="std std-ref">インラインリソース付きメールの送信</span></a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="email-text">
<span id="id9"></span><h4><a class="toc-backref" href="#id34" role="doc-backlink"><span class="section-number">8.1.2.4.1. </span>テキストメールの送信</a><a class="headerlink" href="#email-text" title="Permalink to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">MimeMessageHelper</span></code>クラスを使用して、テキストメールを送信する実装例を以下に示す。</p>
<p><strong>Javaクラスの実装例</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="n">JavaMailSender</span><span class="w"> </span><span class="n">mailSender</span><span class="p">;</span><span class="w"> </span><span class="c1">// (1)</span>

<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// omitted</span>

<span class="w">    </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="n">mailSender</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MimeMessagePreparator</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="nd">@Override</span>
<span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">prepare</span><span class="p">(</span><span class="n">MimeMessage</span><span class="w"> </span><span class="n">mimeMessage</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MimeMessageHelper</span><span class="w"> </span><span class="n">helper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MimeMessageHelper</span><span class="p">(</span><span class="n">mimeMessage</span><span class="p">,</span>
<span class="w">                    </span><span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">.</span><span class="na">name</span><span class="p">());</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">            </span><span class="n">helper</span><span class="p">.</span><span class="na">setFrom</span><span class="p">(</span><span class="s">&quot;EXAMPLE.COM &lt;info@example.com&gt;&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// (4)</span>
<span class="w">            </span><span class="n">helper</span><span class="p">.</span><span class="na">setTo</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getEmailAddress</span><span class="p">());</span><span class="w"> </span><span class="c1">// (5)</span>
<span class="w">            </span><span class="n">helper</span><span class="p">.</span><span class="na">setSubject</span><span class="p">(</span><span class="s">&quot;Registration confirmation.&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// (6)</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Hi &quot;</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getUserName</span><span class="p">()</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, welcome to EXAMPLE.COM!\r\n&quot;</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;If you were not an intended recipient, Please notify the sender.&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">helper</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="n">text</span><span class="p">);</span><span class="w"> </span><span class="c1">// (7)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// omitted</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">JavaMailSender</span></code>をインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">JavaMailSender</span></code>の<code class="docutils literal notranslate"><span class="pre">send</span></code>メソッドを利用してメールを送信する。</div>
<div class="line">引数には<code class="docutils literal notranslate"><span class="pre">MimeMessagePreparator</span></code>を実装した匿名内部クラスを定義する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">文字コードを指定して、<code class="docutils literal notranslate"><span class="pre">MimeMessageHelper</span></code>のインスタンスを生成する。</div>
<div class="line">この例では、文字コードにUTF-8を指定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Fromヘッダの内容を設定する。</div>
<div class="line">この例では、”名前 &lt;アドレス&gt;”の形式で設定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Toヘッダの内容を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Subjectヘッダの内容を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">本文の内容を設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>メールヘッダを設定する場合、メールヘッダ・インジェクションに対する考慮が必要となる。</p>
<p>詳細は<a class="reference internal" href="#email-header-injection"><span class="std std-ref">メールヘッダ・インジェクション対策</span></a>を参照されたい。</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>日本語のメールを送信する際、UTF-8をサポートしていないメールクライアントもサポートする必要がある場合はエンコードにISO-2022-JPを利用することも考えられる。</p>
<p>エンコードにISO-2022-JPを利用する際に考慮すべき事項について、<a class="reference internal" href="#email-iso-2022-jp"><span class="std std-ref">ISO-2022-JPのエンコードについての考慮</span></a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="html">
<span id="email-html"></span><h4><a class="toc-backref" href="#id35" role="doc-backlink"><span class="section-number">8.1.2.4.2. </span>HTMLメールの送信</a><a class="headerlink" href="#html" title="Permalink to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">MimeMessageHelper</span></code>クラスを使用して、HTMLメールを送信する実装例を以下に示す。</p>
<p><strong>Javaクラスの実装例</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="n">JavaMailSender</span><span class="w"> </span><span class="n">mailSender</span><span class="p">;</span><span class="w"> </span><span class="c1">// (1)</span>

<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// omitted</span>

<span class="w">    </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="n">mailSender</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MimeMessagePreparator</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="nd">@Override</span>
<span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">prepare</span><span class="p">(</span><span class="n">MimeMessage</span><span class="w"> </span><span class="n">mimeMessage</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MimeMessageHelper</span><span class="w"> </span><span class="n">helper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MimeMessageHelper</span><span class="p">(</span><span class="n">mimeMessage</span><span class="p">,</span>
<span class="w">                    </span><span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">.</span><span class="na">name</span><span class="p">());</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">            </span><span class="n">helper</span><span class="p">.</span><span class="na">setFrom</span><span class="p">(</span><span class="s">&quot;EXAMPLE.COM &lt;info@example.com&gt;&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// (4)</span>
<span class="w">            </span><span class="n">helper</span><span class="p">.</span><span class="na">setTo</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getEmailAddress</span><span class="p">());</span><span class="w"> </span><span class="c1">// (5)</span>
<span class="w">            </span><span class="n">helper</span><span class="p">.</span><span class="na">setSubject</span><span class="p">(</span><span class="s">&quot;Registration confirmation.&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// (6)</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&lt;html&gt;&lt;body&gt;&lt;h3&gt;Hi &quot;</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getUserName</span><span class="p">()</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, welcome to EXAMPLE.COM!&lt;/h3&gt;&quot;</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;If you were not an intended recipient, Please notify the sender.&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">helper</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w"> </span><span class="c1">// (7)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// omitted</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">JavaMailSender</span></code>をインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">JavaMailSender</span></code>の<code class="docutils literal notranslate"><span class="pre">send</span></code>メソッドを利用してメールを送信する。</div>
<div class="line">引数には<code class="docutils literal notranslate"><span class="pre">MimeMessagePreparator</span></code>を実装した匿名内部クラスを定義する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">文字コードを指定して、<code class="docutils literal notranslate"><span class="pre">MimeMessageHelper</span></code>のインスタンスを生成する。</div>
<div class="line">この例では、文字コードにUTF-8を指定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Fromヘッダの内容を設定する。</div>
<div class="line">この例では、”名前 &lt;アドレス&gt;”の形式で設定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Toヘッダの内容を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Subjectヘッダの内容を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">本文の内容を設定する。<code class="docutils literal notranslate"><span class="pre">setText</span></code>メソッドの第二引数に<code class="docutils literal notranslate"><span class="pre">true</span></code>を指定することで、Content-Typeがtext/htmlになる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>メール本文のHTMLを生成する際に外部から入力された値を使用する場合はXSS攻撃への対策を行うこと。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="email-attachment">
<span id="id10"></span><h4><a class="toc-backref" href="#id36" role="doc-backlink"><span class="section-number">8.1.2.4.3. </span>添付ファイル付きメールの送信</a><a class="headerlink" href="#email-attachment" title="Permalink to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">MimeMessageHelper</span></code>クラスを使用して、添付ファイル付きメールを送信する実装例を以下に示す。</p>
<p><strong>Javaクラスの実装例</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="n">JavaMailSender</span><span class="w"> </span><span class="n">mailSender</span><span class="p">;</span><span class="w"> </span><span class="c1">// (1)</span>

<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// omitted</span>

<span class="w">    </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="n">mailSender</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MimeMessagePreparator</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="nd">@Override</span>
<span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">prepare</span><span class="p">(</span><span class="n">MimeMessage</span><span class="w"> </span><span class="n">mimeMessage</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MimeMessageHelper</span><span class="w"> </span><span class="n">helper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MimeMessageHelper</span><span class="p">(</span><span class="n">mimeMessage</span><span class="p">,</span>
<span class="w">                    </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">.</span><span class="na">name</span><span class="p">());</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">            </span><span class="n">helper</span><span class="p">.</span><span class="na">setFrom</span><span class="p">(</span><span class="s">&quot;EXAMPLE.COM &lt;info@example.com&gt;&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// (4)</span>
<span class="w">            </span><span class="n">helper</span><span class="p">.</span><span class="na">setTo</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getEmailAddress</span><span class="p">());</span><span class="w"> </span><span class="c1">// (5)</span>
<span class="w">            </span><span class="n">helper</span><span class="p">.</span><span class="na">setSubject</span><span class="p">(</span><span class="s">&quot;Registration confirmation.&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// (6)</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Hi &quot;</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getUserName</span><span class="p">()</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, welcome to EXAMPLE.COM!\r\n&quot;</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;Please find attached the file.\r\n\r\n&quot;</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;If you were not an intended recipient, Please notify the sender.&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">helper</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="n">text</span><span class="p">);</span><span class="w"> </span><span class="c1">// (7)</span>
<span class="w">            </span><span class="n">ClassPathResource</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ClassPathResource</span><span class="p">(</span><span class="s">&quot;doc/quickstart.pdf&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">helper</span><span class="p">.</span><span class="na">addAttachment</span><span class="p">(</span><span class="s">&quot;QuickStart.pdf&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">);</span><span class="w"> </span><span class="c1">// (8)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// omitted</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">JavaMailSender</span></code>をインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">JavaMailSender</span></code>の<code class="docutils literal notranslate"><span class="pre">send</span></code>メソッドを利用してメールを送信する。</div>
<div class="line">引数には<code class="docutils literal notranslate"><span class="pre">MimeMessagePreparator</span></code>を実装した匿名内部クラスを定義する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">文字コードを指定して、<code class="docutils literal notranslate"><span class="pre">MimeMessageHelper</span></code>のインスタンスを生成する。</div>
<div class="line">この例では、文字コードにUTF-8を指定している。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">MimeMessageHelper</span></code>のコンストラクタの第二引数に<code class="docutils literal notranslate"><span class="pre">true</span></code>を指定することで、マルチパートモード（デフォルトの<code class="docutils literal notranslate"><span class="pre">MULTIPART_MODE_MIXED_RELATED</span></code>）になる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Fromヘッダの内容を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Toヘッダの内容を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Subjectヘッダの内容を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">本文の内容を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">添付ファイル名を指定して添付するファイルを設定する。</div>
<div class="line">この例では、<code class="docutils literal notranslate"><span class="pre">QuickStart.pdf</span></code>というファイル名で、クラスパス上にある<code class="file docutils literal notranslate"><span class="pre">doc/quickstart.pdf</span></code>というファイルを添付している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="email-inline-resource">
<span id="id11"></span><h4><a class="toc-backref" href="#id37" role="doc-backlink"><span class="section-number">8.1.2.4.4. </span>インラインリソース付きメールの送信</a><a class="headerlink" href="#email-inline-resource" title="Permalink to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">MimeMessageHelper</span></code>クラスを使用して、インラインリソース付きメールを送信する実装例を以下に示す。</p>
<p><strong>Javaクラスの実装例</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="n">JavaMailSender</span><span class="w"> </span><span class="n">mailSender</span><span class="p">;</span><span class="w"> </span><span class="c1">// (1)</span>

<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// omitted</span>

<span class="w">    </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="n">mailSender</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MimeMessagePreparator</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="nd">@Override</span>
<span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">prepare</span><span class="p">(</span><span class="n">MimeMessage</span><span class="w"> </span><span class="n">mimeMessage</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MimeMessageHelper</span><span class="w"> </span><span class="n">helper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MimeMessageHelper</span><span class="p">(</span><span class="n">mimeMessage</span><span class="p">,</span>
<span class="w">                    </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">.</span><span class="na">name</span><span class="p">());</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">            </span><span class="n">helper</span><span class="p">.</span><span class="na">setFrom</span><span class="p">(</span><span class="s">&quot;EXAMPLE.COM &lt;info@example.com&gt;&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// (4)</span>
<span class="w">            </span><span class="n">helper</span><span class="p">.</span><span class="na">setTo</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getEmailAddress</span><span class="p">());</span><span class="w"> </span><span class="c1">// (5)</span>
<span class="w">            </span><span class="n">helper</span><span class="p">.</span><span class="na">setSubject</span><span class="p">(</span><span class="s">&quot;Registration confirmation.&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// (6)</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">cid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;identifier1234&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&lt;html&gt;&lt;body&gt;&lt;img src=&#39;cid:&quot;</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">cid</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39; /&gt;&lt;h3&gt;Hi &quot;</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getUserName</span><span class="p">()</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, welcome to EXAMPLE.COM!\r\n&lt;/h3&gt;&quot;</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;If you were not an intended recipient, Please notify the sender.&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">helper</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w"> </span><span class="c1">// (7)</span>
<span class="w">            </span><span class="n">ClassPathResource</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ClassPathResource</span><span class="p">(</span><span class="s">&quot;image/logo.jpg&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">helper</span><span class="p">.</span><span class="na">addInline</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">);</span><span class="w"> </span><span class="c1">// (8)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// omitted</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">JavaMailSender</span></code>をインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">JavaMailSender</span></code>の<code class="docutils literal notranslate"><span class="pre">send</span></code>メソッドを利用してメールを送信する。</div>
<div class="line">引数には<code class="docutils literal notranslate"><span class="pre">MimeMessagePreparator</span></code>を実装した匿名内部クラスを定義する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">文字コードを指定して、<code class="docutils literal notranslate"><span class="pre">MimeMessageHelper</span></code>のインスタンスを生成する。</div>
<div class="line">この例では、文字コードにUTF-8を指定している。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">MimeMessageHelper</span></code>のコンストラクタの第二引数に<code class="docutils literal notranslate"><span class="pre">true</span></code>を指定することで、マルチパートモードになる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Fromヘッダの内容を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Toヘッダの内容を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Subjectヘッダの内容を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">本文の内容を設定する。<code class="docutils literal notranslate"><span class="pre">setText</span></code>メソッドの第二引数に<code class="docutils literal notranslate"><span class="pre">true</span></code>を指定することで、Content-Typeがtext/htmlになる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">インラインリソースのコンテンツIDを指定してインラインリソースを設定する。</div>
<div class="line">この例では、<code class="docutils literal notranslate"><span class="pre">identifier1234</span></code>というコンテンツIDで、クラスパス上にある<code class="file docutils literal notranslate"><span class="pre">image/logo.jpg</span></code>というファイルを設定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">addInline</span></code>メソッドは、<code class="docutils literal notranslate"><span class="pre">setText</span></code>メソッドの後に呼び出すこと。そうしないと、メールクライアントがインラインリソースを正しく参照できないことがある。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="id12">
<h3><a class="toc-backref" href="#id38" role="doc-backlink"><span class="section-number">8.1.2.5. </span>メール送信時の例外について</a><a class="headerlink" href="#id12" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">JavaMailSender</span></code>の<code class="docutils literal notranslate"><span class="pre">send</span></code>メソッドを利用してメール送信を行う際に発生する例外は<code class="docutils literal notranslate"><span class="pre">org.springframework.mail.MailException</span></code>を継承した例外である。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">MailException</span></code>を継承した例外クラスと、それぞれの例外の発生条件について、以下の表に示す。</div>
</div>
<blockquote>
<div><table class="docutils align-default" id="id21">
<caption><span class="caption-text"><strong>メール送信時の例外</strong></span><a class="headerlink" href="#id21" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 10.0%" />
<col style="width: 35.0%" />
<col style="width: 55.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>例外クラス</p></th>
<th class="head"><p>発生条件</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li></li>
</ol>
</td>
<td><p><a class="reference external" href="https://docs.spring.io/spring-framework/docs/6.1.3/javadoc-api/org/springframework/mail/MailAuthenticationException.html">MailAuthenticationException</a></p></td>
<td><div class="line-block">
<div class="line">認証失敗時に発生する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p><a class="reference external" href="https://docs.spring.io/spring-framework/docs/6.1.3/javadoc-api/org/springframework/mail/MailParseException.html">MailParseException</a></p></td>
<td><div class="line-block">
<div class="line">メールメッセージのプロパティに不正な値が設定されている場合に発生する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p><a class="reference external" href="https://docs.spring.io/spring-framework/docs/6.1.3/javadoc-api/org/springframework/mail/MailPreparationException.html">MailPreparationException</a></p></td>
<td><div class="line-block">
<div class="line">メールメッセージを作成中に想定外のエラーが起きた場合に発生する。
想定外のエラーとしては、例えばテンプレートライブラリで発生するエラーといったものがある。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">MimeMessagePreparator</span></code>で発生した例外が<code class="docutils literal notranslate"><span class="pre">MailPreparationException</span></code>にラップされてスローされる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p><a class="reference external" href="https://docs.spring.io/spring-framework/docs/6.1.3/javadoc-api/org/springframework/mail/MailSendException.html">MailSendException</a></p></td>
<td><div class="line-block">
<div class="line">メールの送信エラーが起きた場合に発生する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>特定の例外に対するエラー画面遷移については、<a class="reference internal" href="../WebApplicationDetail/ExceptionHandling.html"><span class="doc">例外ハンドリング</span></a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="how-to-extend">
<h2><a class="toc-backref" href="#id39" role="doc-backlink"><span class="section-number">8.1.3. </span>How to extend</a><a class="headerlink" href="#how-to-extend" title="Permalink to this heading">¶</a></h2>
<section id="id13">
<h3><a class="toc-backref" href="#id40" role="doc-backlink"><span class="section-number">8.1.3.1. </span>テンプレートを使用したメール本文の作成方法</a><a class="headerlink" href="#id13" title="Permalink to this heading">¶</a></h3>
<p>上で示した実装例のようにJavaソースでメール本文を直接組み立てるのは、以下の理由から推奨しない。</p>
<ul class="simple">
<li><p>メール本文をJavaソースで組み立てるのは可読性が悪くエラーを作りやすい。</p></li>
<li><p>表示ロジックとビジネスロジックの境界が曖昧となる。</p></li>
<li><p>メール本文のデザインを変更するために、Javaソースの修正、コンパイル、デプロイが必要になる。</p></li>
</ul>
<div class="line-block">
<div class="line">よって、メール本文のデザインを定義するためにテンプレートライブラリを使用することを推奨する。</div>
<div class="line">特にメール本文が複雑になるような場合はテンプレートライブラリを使用すべきである。</div>
<div class="line"><br /></div>
</div>
<section id="freemarker">
<h4><a class="toc-backref" href="#id41" role="doc-backlink"><span class="section-number">8.1.3.1.1. </span>FreeMarkerを使用したメール本文の作成</a><a class="headerlink" href="#freemarker" title="Permalink to this heading">¶</a></h4>
<p>本ガイドラインでは、テンプレートライブラリとして<a class="reference external" href="https://freemarker.apache.org/">FreeMarker</a>を使用する方法について説明する。</p>
<ul>
<li><p>FreeMarkerを使用するために、依存ライブラリを設定する。</p>
<p><strong>pom.xmlの設定例</strong></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;dependencies&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.freemarker<span class="nt">&lt;/groupId&gt;</span>
<span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>freemarker<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>

<span class="nt">&lt;/dependencies&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">FreeMarkerのライブラリをdependenciesに追加する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>上記設定例は、依存ライブラリのバージョンを親プロジェクトである terasoluna-gfw-parent で管理する前提であるため、pom.xmlでのバージョンの指定は不要である。</p>
<p>上記の依存ライブラリはterasoluna-gfw-parentが依存している<a class="reference external" href="https://docs.spring.io/spring-boot/docs/3.2.2/reference/htmlsingle/#dependency-versions">Spring Boot</a>で管理されている。</p>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">freemarker.template.Configuration</span></code>を生成するためのFactoryBeanをBean定義する。</p>
<p><strong>Bean定義ファイルの設定例</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-4-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-4-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-4-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-4-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-4-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-4-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;freemarkerConfiguration&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">FreeMarkerConfigurationFactoryBean</span><span class="w"> </span><span class="nf">freemarkerConfiguration</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">FreeMarkerConfigurationFactoryBean</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FreeMarkerConfigurationFactoryBean</span><span class="p">();</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">setTemplateLoaderPath</span><span class="p">(</span><span class="s">&quot;classpath:/META-INF/freemarker/&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">setDefaultEncoding</span><span class="p">(</span><span class="s">&quot;UTF-8&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">FreeMarkerConfigurationFactoryBean</span></code>をBean定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">templateLoaderPath</span></code>プロパティにテンプレートファイルの格納された場所を指定する。</div>
<div class="line">この例では、クラスパス上にある<code class="file docutils literal notranslate"><span class="pre">META-INF/freemarker/</span></code>ディレクトリを設定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">defaultEncoding</span></code>プロパティにデフォルトのエンコードを指定する。</div>
<div class="line">この例では、UTF-8を設定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div><div aria-labelledby="tab-4-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-4-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;freemarkerConfiguration&quot;</span>
<span class="w">    </span><span class="na">class=</span><span class="s">&quot;org.springframework.ui.freemarker.FreeMarkerConfigurationFactoryBean&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;templateLoaderPath&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;classpath:/META-INF/freemarker/&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;defaultEncoding&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;UTF-8&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">FreeMarkerConfigurationFactoryBean</span></code>をBean定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">templateLoaderPath</span></code>プロパティにテンプレートファイルの格納された場所を指定する。</div>
<div class="line">この例では、クラスパス上にある<code class="file docutils literal notranslate"><span class="pre">META-INF/freemarker/</span></code>ディレクトリを設定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">defaultEncoding</span></code>プロパティにデフォルトのエンコードを指定する。</div>
<div class="line">この例では、UTF-8を設定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>上記以外の設定については、<a class="reference external" href="https://docs.spring.io/spring-framework/docs/6.1.3/javadoc-api/org/springframework/ui/freemarker/FreeMarkerConfigurationFactoryBean.html">FreeMarkerConfigurationFactoryBeanのJavaDoc</a>を参照されたい。</p>
<p>FreeMarker自体の設定については、<a class="reference external" href="https://freemarker.apache.org/docs/pgui_config.html">FreeMarker Manual (Programmer’s Guide / The Configuration)</a>を参照されたい。</p>
</div>
<ul>
<li><p>メール本文のテンプレートファイルを作成する。</p>
<p><strong>テンプレートファイルの設定例</strong></p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&lt;#escape x as x?html&gt; &lt;#-- (1) --&gt;
&lt;html&gt;
    &lt;body&gt;
        &lt;h3&gt;Hi ${userName}, welcome to TERASOLUNA.ORG!&lt;/h3&gt; &lt;#-- (2) --&gt;

        &lt;div&gt;
            If you were not an intended recipient, Please notify the sender.
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;
&lt;/#escape&gt;
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">XSS攻撃への対策としてHTMLエスケープを行うように設定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">データモデルに設定された<code class="docutils literal notranslate"><span class="pre">userName</span></code>の値を埋め込む。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>テンプレート言語（FTL）の詳細については、<a class="reference external" href="https://freemarker.apache.org/docs/ref.html">FreeMarker Manual (Template Language Reference)</a>を参照されたい。</p>
</div>
</li>
<li><p>テンプレートを使用してメール本文を生成し、メール送信する。</p>
<p><strong>Javaクラスの実装例</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="n">JavaMailSender</span><span class="w"> </span><span class="n">mailSender</span><span class="p">;</span>

<span class="nd">@Inject</span>
<span class="n">Configuration</span><span class="w"> </span><span class="n">freemarkerConfiguration</span><span class="p">;</span><span class="w"> </span><span class="c1">// (1)</span>

<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// omitted</span>

<span class="w">    </span><span class="n">mailSender</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MimeMessagePreparator</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="nd">@Override</span>
<span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">prepare</span><span class="p">(</span><span class="n">MimeMessage</span><span class="w"> </span><span class="n">mimeMessage</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MimeMessageHelper</span><span class="w"> </span><span class="n">helper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MimeMessageHelper</span><span class="p">(</span><span class="n">mimeMessage</span><span class="p">,</span>
<span class="w">                    </span><span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">.</span><span class="na">name</span><span class="p">());</span>
<span class="w">            </span><span class="n">helper</span><span class="p">.</span><span class="na">setFrom</span><span class="p">(</span><span class="s">&quot;EXAMPLE.COM &lt;info@example.com&gt;&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">helper</span><span class="p">.</span><span class="na">setTo</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getEmailAddress</span><span class="p">());</span>
<span class="w">            </span><span class="n">helper</span><span class="p">.</span><span class="na">setSubject</span><span class="p">(</span><span class="s">&quot;Registration confirmation.&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">Template</span><span class="w"> </span><span class="n">template</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">freemarkerConfiguration</span>
<span class="w">                    </span><span class="p">.</span><span class="na">getTemplate</span><span class="p">(</span><span class="s">&quot;registration-confirmation.ftl&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FreeMarkerTemplateUtils</span>
<span class="w">                    </span><span class="p">.</span><span class="na">processTemplateIntoString</span><span class="p">(</span><span class="n">template</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">);</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">            </span><span class="n">helper</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// omitted</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><a class="reference external" href="https://freemarker.apache.org/docs/api/freemarker/template/Configuration.html">Configuration</a>をインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">Configuration</span></code>の<code class="docutils literal notranslate"><span class="pre">getTemplate</span></code>メソッドを利用して<a class="reference external" href="https://freemarker.apache.org/docs/api/freemarker/template/Template.html">Template</a>を取得する。</div>
<div class="line">この例では、テンプレートファイルとして”registration-confirmation.ftl”を指定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得した<code class="docutils literal notranslate"><span class="pre">Template</span></code>をもとに、<code class="docutils literal notranslate"><span class="pre">org.springframework.ui.freemarker.FreeMarkerTemplateUtils</span></code>の<code class="docutils literal notranslate"><span class="pre">processTemplateIntoString</span></code>メソッドを利用してテンプレートから文字列を生成する。</div>
<div class="line">この例では、データモデルとして<code class="docutils literal notranslate"><span class="pre">userName</span></code>プロパティを持つ<code class="docutils literal notranslate"><span class="pre">User</span></code>オブジェクト（JavaBeans）を指定している。これにより、テンプレートファイルの<code class="docutils literal notranslate"><span class="pre">${userName}</span></code>の箇所に<code class="docutils literal notranslate"><span class="pre">userName</span></code>プロパティの値が埋め込まれる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
</section>
<section id="appendix">
<h2><a class="toc-backref" href="#id42" role="doc-backlink"><span class="section-number">8.1.4. </span>Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this heading">¶</a></h2>
<section id="iso-2022-jp">
<span id="email-iso-2022-jp"></span><h3><a class="toc-backref" href="#id43" role="doc-backlink"><span class="section-number">8.1.4.1. </span>ISO-2022-JPのエンコードについての考慮</a><a class="headerlink" href="#iso-2022-jp" title="Permalink to this heading">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>ここではUTF-8に対応していない場合の例を記載しているが、UTF-8に対応しているのであればUTF-8を使用することを検討されたい。</p>
</div>
<div class="line-block">
<div class="line">日本語のメールを送信する際、メールクライアントがUTF-8に対応していない場合は一部の文字を変換して送る必要がある。</div>
<div class="line">例えば、MS932で入力された文字列に対しエンコードにISO-2022-JPをはじめとするJIS X 0208の文字集合をベースとしたエンコードを設定した場合、以下の表に記載する7文字において文字化けが発生する。</div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 20.0%" />
<col style="width: 15.0%" />
<col style="width: 15.0%" />
<col style="width: 15.0%" />
<col style="width: 15.0%" />
<col style="width: 20.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>変換前</p></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"><p>変換後</p></th>
<th class="head"></th>
<th class="head"></th>
</tr>
<tr class="row-even"><th class="head"><div class="line-block">
<div class="line">MS932</div>
<div class="line">入力文字</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">入力値</div>
<div class="line">（SJIS）</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">Unicode</div>
<div class="line">（UTF-16）</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">Unicode</div>
<div class="line">（UTF-16）</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">ISO-2022-JP</div>
<div class="line">（JIS）</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">JIS X 0208</div>
<div class="line">代替文字</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-odd"><td><div class="line-block">
<div class="line">―（全角ハイフン）</div>
</div>
</td>
<td><div class="line-block">
<div class="line">815D</div>
</div>
</td>
<td><div class="line-block">
<div class="line">U+2015</div>
</div>
</td>
<td><div class="line-block">
<div class="line">U+2014</div>
</div>
</td>
<td><div class="line-block">
<div class="line">213E</div>
</div>
</td>
<td><div class="line-block">
<div class="line">—（EM ダッシュ）</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">－（ハイフンマイナス）</div>
</div>
</td>
<td><div class="line-block">
<div class="line">817C</div>
</div>
</td>
<td><div class="line-block">
<div class="line">U+FF0D</div>
</div>
</td>
<td><div class="line-block">
<div class="line">U+2212</div>
</div>
</td>
<td><div class="line-block">
<div class="line">215D</div>
</div>
</td>
<td><div class="line-block">
<div class="line">−（全角マイナス）</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">～（全角チルド）</div>
</div>
</td>
<td><div class="line-block">
<div class="line">8160</div>
</div>
</td>
<td><div class="line-block">
<div class="line">U+FF5E</div>
</div>
</td>
<td><div class="line-block">
<div class="line">U+301C</div>
</div>
</td>
<td><div class="line-block">
<div class="line">2141</div>
</div>
</td>
<td><div class="line-block">
<div class="line">〜（波ダッシュ）</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">∥（平行記号）</div>
</div>
</td>
<td><div class="line-block">
<div class="line">8161</div>
</div>
</td>
<td><div class="line-block">
<div class="line">U+2225</div>
</div>
</td>
<td><div class="line-block">
<div class="line">U+2016</div>
</div>
</td>
<td><div class="line-block">
<div class="line">2142</div>
</div>
</td>
<td><div class="line-block">
<div class="line">‖（双柱）</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">￠（全角セント記号）</div>
</div>
</td>
<td><div class="line-block">
<div class="line">8191</div>
</div>
</td>
<td><div class="line-block">
<div class="line">U+FFE0</div>
</div>
</td>
<td><div class="line-block">
<div class="line">U+00A2</div>
</div>
</td>
<td><div class="line-block">
<div class="line">2171</div>
</div>
</td>
<td><div class="line-block">
<div class="line">¢（セント記号）</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">￡（全角ポンド記号）</div>
</div>
</td>
<td><div class="line-block">
<div class="line">8192</div>
</div>
</td>
<td><div class="line-block">
<div class="line">U+FFE1</div>
</div>
</td>
<td><div class="line-block">
<div class="line">U+00A3</div>
</div>
</td>
<td><div class="line-block">
<div class="line">2172</div>
</div>
</td>
<td><div class="line-block">
<div class="line">£（ポンド記号）</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">￢（全角否定記号）</div>
</div>
</td>
<td><div class="line-block">
<div class="line">81CA</div>
</div>
</td>
<td><div class="line-block">
<div class="line">U+FFE2</div>
</div>
</td>
<td><div class="line-block">
<div class="line">U+00AC</div>
</div>
</td>
<td><div class="line-block">
<div class="line">224C</div>
</div>
</td>
<td><div class="line-block">
<div class="line">¬（否定記号）</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>この問題は、Unicodeを介して文字コード変換を行う際に、MS932に有りJIS X 0208に無い文字が存在するためであり、文字化けを回避するためには、文字化けする文字について代替文字に文字コードを置き換えるなどの対処を行う必要がある。</p>
<p>以下に、変換処理の実装例を示す。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">convertISO2022JPCharacters</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">targetStr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">targetStr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">char</span><span class="o">[]</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">targetStr</span><span class="p">.</span><span class="na">toCharArray</span><span class="p">();</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ch</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// @formatter:off</span>
<span class="w">        </span><span class="n">ch</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;\u2015&#39;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="sc">&#39;\u2014&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// &#39;―&#39;（全角ハイフン） -&gt; &#39;—&#39;（EM ダッシュ）</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;\uff0d&#39;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="sc">&#39;\u2212&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// &#39;－&#39;（ハイフンマイナス） -&gt; &#39;−&#39;（全角マイナス）</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;\uff5e&#39;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="sc">&#39;\u301c&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// &#39;～&#39;（全角チルド） -&gt; &#39;〜&#39;（波ダッシュ）</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;\u2225&#39;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="sc">&#39;\u2016&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// &#39;∥&#39;（平行記号） -&gt; &#39;‖&#39;（双柱）</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;\uffe0&#39;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="sc">&#39;\u00A2&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// &#39;￠&#39;（全角セント記号） -&gt; &#39;¢&#39;（セント記号）</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;\uffe1&#39;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="sc">&#39;\u00A3&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// &#39;￡&#39;（全角ポンド記号） -&gt; &#39;£&#39;（ポンド記号）</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;\uffe2&#39;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="sc">&#39;\u00AC&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// &#39;￢&#39;（全角否定記号） -&gt; &#39;¬&#39;（否定記号）</span>
<span class="w">            </span><span class="k">default</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">ch</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="c1">// @formatter:on</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Unicodeへのマッピング時の問題であるため、入力値の文字コードに依らず変換は必要である。</p>
<p>変換対象となるのは日本語を含む文字列が設定される可能性のあるヘッダおよび本文の文字列である。</p>
<p>日本語を含む可能性があり一般的によく使われると考えられるヘッダとしては、From、To、Cc、Bcc、Reply-To、Subjectが挙げられる。</p>
</div>
<div class="line-block">
<div class="line">また、エンコードにISO-2022-JPを設定する場合、以下のような範囲外となる拡張文字が文字化けするため、これらの拡張文字は使用すべきではない。</div>
<div class="line">拡張文字を代替文字に変換してもよい場合、前述した7文字と同様にアプリケーションで独自に変換を行う方法を検討されたい。</div>
</div>
<figure class="align-center" id="id22">
<a class="reference internal image-reference" href="../../_images/EmailOutofEscapeCharacter.png"><img alt="Out of EscapeCharacter" src="../../_images/EmailOutofEscapeCharacter.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>図-範囲外となる拡張文字の例</strong></span><a class="headerlink" href="#id22" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="javamail">
<h3><a class="toc-backref" href="#id44" role="doc-backlink"><span class="section-number">8.1.4.2. </span>JavaMailで発生していたマルチバイト文字を使用する際の不具合について</a><a class="headerlink" href="#javamail" title="Permalink to this heading">¶</a></h3>
<p>JavaMailでは、送信するメールの本文の終端がマルチバイト文字で終わっていると、終端に余計な文字（「?」や「w)」等）が出力される場合があり、従来は以下の方法で回避していた。</p>
<ul class="simple">
<li><p>メール本文の終端文字を半角文字にする</p></li>
<li><p>メール本文の終端を改行コード（CRLF）にする</p></li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>本事象は、シングルバイト文字とマルチバイト文字の切り替えのために付与される制御コードが付与されていなかったことに起因し、JavaMail 1.4.4でワークアラウンドが施されたことによって、以降のバージョンでは当事象が発生しなくなった。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="email-header-injection">
<span id="id16"></span><h3><a class="toc-backref" href="#id45" role="doc-backlink"><span class="section-number">8.1.4.3. </span>メールヘッダ・インジェクション対策</a><a class="headerlink" href="#email-header-injection" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">メールヘッダ・インジェクション攻撃が成功すると、本来意図していない宛先にメール送信され、迷惑メール送信の踏み台に悪用される可能性がある。</div>
<div class="line">メールヘッダ（Subject等）の内容に外部から入力された文字列を利用する場合、メールヘッダ・インジェクション攻撃への対策が必要となる。</div>
<div class="line"><br /></div>
<div class="line">例えば、<code class="docutils literal notranslate"><span class="pre">MimeMessageHelper</span></code>の<code class="docutils literal notranslate"><span class="pre">setSubject</span></code>メソッドで以下の文字列を設定すると、Bccヘッダを追加し本文を改ざんすることが可能となる。</div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Notification\r\nBcc: attacker@exapmle.com\r\n\r\nManipulated body.
</pre></div>
</div>
<p>メールヘッダ・インジェクション攻撃への対策としては、以下のような方法が考えられる。</p>
<ul class="simple">
<li><p>メールヘッダに設定する内容は固定値とし、外部から入力された文字列はすべてメール本文に出力する。</p></li>
<li><p>メールヘッダに設定する内容に改行文字が含まれないことをチェックする。</p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="email-processing-method">
<span id="id17"></span><h3><a class="toc-backref" href="#id46" role="doc-backlink"><span class="section-number">8.1.4.4. </span>処理方式</a><a class="headerlink" href="#email-processing-method" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">メール送信は時間のかかる処理であるため、Webアプリケーションのリクエストの中で送信処理を行うと応答時間が長くなってしまう。このため、通常はWebアプリケーションのリクエストの中では送信処理を行わず、非同期でメール送信を行う処理方式とすることが多い。</div>
<div class="line">メール送信の処理方式について詳細については言及しないが、以下に一例を示すので参考にされたい。</div>
<div class="line"><br /></div>
</div>
<section id="id18">
<h4><a class="toc-backref" href="#id47" role="doc-backlink"><span class="section-number">8.1.4.4.1. </span>データベースまたはメッセージキューに保持されたメール情報をもとにメール送信を行う</a><a class="headerlink" href="#id18" title="Permalink to this heading">¶</a></h4>
<p>データベースまたはメッセージキューに保持されたメール情報をもとにメール送信を行うには、以下のような機能をアプリケーションに組み込む。</p>
<ul class="simple">
<li><p>送信するメールの情報（宛先や本文、添付ファイル等）をデータベース（またはメッセージキュー）に登録する。</p></li>
<li><p>データベース（またはメッセージキュー）から未送信のメール情報を定期的に取得し、SMTPによるメール送信を行う。</p></li>
<li><p>送信結果をデータベース（またはメッセージキュー）に登録する。</p></li>
</ul>
<p>なお、以下の点を含めて検討する必要がある。</p>
<ul class="simple">
<li><p>登録されたメール情報やメール送信結果の確認方法</p></li>
<li><p>メール送信エラー時の取り扱い</p></li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>メールサービスによっては、連続してメールが送信された場合に、スパムメールと判定されることがある。
左記への対策としては、同一ドメインに対し連続で送信処理を行わないように、送信順序をランダムにする方法が考えられる。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div></div></blockquote>
</section>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="JMS.html" title="8.2. JMS(Jakarta Messaging)"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="8. メッセージ連携"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.9.0.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" ><span class="section-number">8. </span>メッセージ連携</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">8.1. </span>E-mail送信(SMTP)</a></li> 
      </ul>
    </div>
    <div class="footer">
      © Copyright 2024, NTT DATA Group Corporation. © Copyright 2013, NTT Corporation.
      Created using <a href="https://www.sphinx-doc.org/en/master/">Sphinx</a> 7.0.1.Theme is <a href="https://pypi.org/project/solar-theme/">Solar</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    </script>
  </body>
</html>
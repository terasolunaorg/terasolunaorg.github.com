<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>9.3. 認可 &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.7.0.RELEASE documentation</title>
    <link rel="stylesheet" href="../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '5.7.0.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="9.4. セッション管理" href="SessionManagement.html" />
    <link rel="prev" title="9.2. 認証" href="Authentication.html" /><script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="SessionManagement.html" title="9.4. セッション管理"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Authentication.html" title="9.2. 認証"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.7.0.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">9. セキュリティ対策</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">9.3. 認可</a><ul>
<li><a class="reference internal" href="#overview">9.3.1. Overview</a><ul>
<li><a class="reference internal" href="#id4">9.3.1.1. 認可処理のアーキテクチャ</a><ul>
<li><a class="reference internal" href="#exceptiontranslationfilter">9.3.1.1.1. ExceptionTranslationFilter</a></li>
<li><a class="reference internal" href="#filtersecurityinterceptor">9.3.1.1.2. FilterSecurityInterceptor</a></li>
<li><a class="reference internal" href="#accessdecisionmanager">9.3.1.1.3. AccessDecisionManager</a></li>
<li><a class="reference internal" href="#accessdecisionvoter">9.3.1.1.4. AccessDecisionVoter</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">9.3.2. How to use</a><ul>
<li><a class="reference internal" href="#springsecurityauthorizationpolicy">9.3.2.1. アクセスポリシーの記述方法</a><ul>
<li><a class="reference internal" href="#built-incommon-expressions">9.3.2.1.1. Built-InのCommon Expressions</a></li>
<li><a class="reference internal" href="#built-inweb-expressions">9.3.2.1.2. Built-InのWeb Expressions</a></li>
<li><a class="reference internal" href="#id7">9.3.2.1.3. 演算子の使用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#web">9.3.2.2. Webリソースへの認可</a><ul>
<li><a class="reference internal" href="#id8">9.3.2.2.1. 認可処理の適用</a></li>
<li><a class="reference internal" href="#id9">9.3.2.2.2. アクセスポリシーの定義</a><ul>
<li><a class="reference internal" href="#access-policy-designate-web-resource">9.3.2.2.2.1. アクセスポリシーを適用するWebリソースの指定</a></li>
<li><a class="reference internal" href="#id11">9.3.2.2.2.2. アクセスポリシーの指定</a></li>
<li><a class="reference internal" href="#id12">9.3.2.2.2.3. パス変数の参照</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#authorizationtomethod">9.3.2.3. メソッドへの認可</a><ul>
<li><a class="reference internal" href="#aop">9.3.2.3.1. AOPの有効化</a></li>
<li><a class="reference internal" href="#id15">9.3.2.3.2. 認可処理の適用</a></li>
<li><a class="reference internal" href="#id16">9.3.2.3.3. アクセスポリシーの定義</a><ul>
<li><a class="reference internal" href="#id17">9.3.2.3.3.1. メソッド実行前に適用するアクセスポリシーの指定</a></li>
<li><a class="reference internal" href="#id18">9.3.2.3.3.2. メソッド実行後に適用するアクセスポリシーの指定</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#jsp">9.3.2.4. JSPの画面項目への認可</a><ul>
<li><a class="reference internal" href="#id19">9.3.2.4.1. アクセスポリシーの定義</a></li>
<li><a class="reference internal" href="#id20">9.3.2.4.2. Webリソースに指定したアクセスポリシーとの連動</a></li>
<li><a class="reference internal" href="#id21">9.3.2.4.3. 認可処理の判定結果を変数に格納</a></li>
</ul>
</li>
<li><a class="reference internal" href="#authorizationerrorresponse">9.3.2.5. 認可エラー時のレスポンス</a><ul>
<li><a class="reference internal" href="#accessdeniedhandler">9.3.2.5.1. AccessDeniedHandler</a></li>
<li><a class="reference internal" href="#authenticationentrypoint">9.3.2.5.2. AuthenticationEntryPoint</a></li>
<li><a class="reference internal" href="#springsecurityauthorizationonerror">9.3.2.5.3. 認可エラー時の遷移先</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend">9.3.3. How to extend</a><ul>
<li><a class="reference internal" href="#id24">9.3.3.1. 認可エラー時のレスポンス (認証済みユーザー編)</a><ul>
<li><a class="reference internal" href="#springsecurityauthorizationaccessdeniedhandler">9.3.3.1.1. AccessDeniedHandlerの適用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id26">9.3.3.2. 認可エラー時のレスポンス (未認証ユーザー編)</a><ul>
<li><a class="reference internal" href="#id27">9.3.3.2.1. リクエスト毎にAuthenticationEntryPointを適用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id28">9.3.3.3. ロールの階層化</a><ul>
<li><a class="reference internal" href="#id29">9.3.3.3.1. 階層関係の設定</a></li>
<li><a class="reference internal" href="#id30">9.3.3.3.2. Webリソースの認可処理への適用</a></li>
<li><a class="reference internal" href="#id31">9.3.3.3.3. メソッドの認可処理への適用</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="Authentication.html"
                        title="previous chapter">9.2. 認証</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="SessionManagement.html"
                        title="next chapter">9.4. セッション管理</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/Security/Authorization.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="springsecurityauthorization">
<span id="id1"></span><h1>9.3. 認可<a class="headerlink" href="#springsecurityauthorization" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="id2">
<p class="topic-title">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id42">Overview</a><ul>
<li><a class="reference internal" href="#id4" id="id43">認可処理のアーキテクチャ</a><ul>
<li><a class="reference internal" href="#exceptiontranslationfilter" id="id44">ExceptionTranslationFilter</a></li>
<li><a class="reference internal" href="#filtersecurityinterceptor" id="id45">FilterSecurityInterceptor</a></li>
<li><a class="reference internal" href="#accessdecisionmanager" id="id46">AccessDecisionManager</a></li>
<li><a class="reference internal" href="#accessdecisionvoter" id="id47">AccessDecisionVoter</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use" id="id48">How to use</a><ul>
<li><a class="reference internal" href="#springsecurityauthorizationpolicy" id="id49">アクセスポリシーの記述方法</a><ul>
<li><a class="reference internal" href="#built-incommon-expressions" id="id50">Built-InのCommon Expressions</a></li>
<li><a class="reference internal" href="#built-inweb-expressions" id="id51">Built-InのWeb Expressions</a></li>
<li><a class="reference internal" href="#id7" id="id52">演算子の使用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#web" id="id53">Webリソースへの認可</a><ul>
<li><a class="reference internal" href="#id8" id="id54">認可処理の適用</a></li>
<li><a class="reference internal" href="#id9" id="id55">アクセスポリシーの定義</a><ul>
<li><a class="reference internal" href="#access-policy-designate-web-resource" id="id56">アクセスポリシーを適用するWebリソースの指定</a></li>
<li><a class="reference internal" href="#id11" id="id57">アクセスポリシーの指定</a></li>
<li><a class="reference internal" href="#id12" id="id58">パス変数の参照</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#authorizationtomethod" id="id59">メソッドへの認可</a><ul>
<li><a class="reference internal" href="#aop" id="id60">AOPの有効化</a></li>
<li><a class="reference internal" href="#id15" id="id61">認可処理の適用</a></li>
<li><a class="reference internal" href="#id16" id="id62">アクセスポリシーの定義</a><ul>
<li><a class="reference internal" href="#id17" id="id63">メソッド実行前に適用するアクセスポリシーの指定</a></li>
<li><a class="reference internal" href="#id18" id="id64">メソッド実行後に適用するアクセスポリシーの指定</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#jsp" id="id65">JSPの画面項目への認可</a><ul>
<li><a class="reference internal" href="#id19" id="id66">アクセスポリシーの定義</a></li>
<li><a class="reference internal" href="#id20" id="id67">Webリソースに指定したアクセスポリシーとの連動</a></li>
<li><a class="reference internal" href="#id21" id="id68">認可処理の判定結果を変数に格納</a></li>
</ul>
</li>
<li><a class="reference internal" href="#authorizationerrorresponse" id="id69">認可エラー時のレスポンス</a><ul>
<li><a class="reference internal" href="#accessdeniedhandler" id="id70">AccessDeniedHandler</a></li>
<li><a class="reference internal" href="#authenticationentrypoint" id="id71">AuthenticationEntryPoint</a></li>
<li><a class="reference internal" href="#springsecurityauthorizationonerror" id="id72">認可エラー時の遷移先</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend" id="id73">How to extend</a><ul>
<li><a class="reference internal" href="#id24" id="id74">認可エラー時のレスポンス (認証済みユーザー編)</a><ul>
<li><a class="reference internal" href="#springsecurityauthorizationaccessdeniedhandler" id="id75">AccessDeniedHandlerの適用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id26" id="id76">認可エラー時のレスポンス (未認証ユーザー編)</a><ul>
<li><a class="reference internal" href="#id27" id="id77">リクエスト毎にAuthenticationEntryPointを適用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id28" id="id78">ロールの階層化</a><ul>
<li><a class="reference internal" href="#id29" id="id79">階層関係の設定</a></li>
<li><a class="reference internal" href="#id30" id="id80">Webリソースの認可処理への適用</a></li>
<li><a class="reference internal" href="#id31" id="id81">メソッドの認可処理への適用</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id42">9.3.1. Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>本節では、Spring Securityが提供している認可機能について説明する。</p>
<p>認可処理は、アプリケーションの利用者がアクセスできるリソースを制御するための処理である。
利用者がアクセスできるリソースを制御するためのもっとも標準的な方法は、
リソース(又はリソースの集合)毎にアクセスポリシーを定義しておき、利用者がリソースにアクセスしようとした時にアクセスポリシーを調べて制御する方法である。</p>
<p>アクセスポリシーには、どのリソースにどのユーザーからのアクセスを許可するかを定義する。
Spring Securityでは、以下の3つのリソースに対してアクセスポリシーを定義することができる。</p>
<ul class="simple">
<li>Webリソース</li>
<li>Javaメソッド</li>
<li>ドメインオブジェクト <a class="footnote-reference" href="#fspringsecurityauthorization1" id="id3">[1]</a></li>
<li>JSPの画面項目</li>
</ul>
<p>本節では、「Webリソース」「Javaメソッド」「JSPの画面項目」のアクセスに対して認可処理を適用するための実装例(定義例)を紹介しながら、Spring Securityの認可機能について説明する。</p>
<table class="docutils footnote" frame="void" id="fspringsecurityauthorization1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[1]</a></td><td>ドメインオブジェクトのアクセスに対する認可処理については、 <a class="reference external" href="https://docs.spring.io/spring-security/site/docs/5.4.2/reference/html5/#domain-acls">Spring Security Reference -Domain Object Security (ACLs)-</a>を参照されたい。</td></tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id43">9.3.1.1. 認可処理のアーキテクチャ</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>Spring Securityは、以下のような流れで認可処理を行う。</p>
<div class="figure" id="id32">
<a class="reference internal image-reference" href="../_images/AuthorizationArchitecture.png"><img alt="../_images/AuthorizationArchitecture.png" src="../_images/AuthorizationArchitecture.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>認可処理のアーキテクチャ</strong></span></p>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントは、任意のリソースにアクセスする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">FilterSecurityInterceptor</span></code>クラスは、<code class="docutils literal"><span class="pre">AccessDecisionManager</span></code>インタフェースのメソッドを呼び出し、リソースへのアクセス権の有無をチェックする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AffirmativeBased</span></code>クラス(デフォルトで使用される<code class="docutils literal"><span class="pre">AccessDecisionManager</span></code>の実装クラス)は、<code class="docutils literal"><span class="pre">AccessDecisionVoter</span></code>インタフェースのメソッドを呼び出し、アクセス権の有無を投票させる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">FilterSecurityInterceptor</span></code>は、<code class="docutils literal"><span class="pre">AccessDecisionManager</span></code>によってアクセス権が付与された場合に限り、リソースへアクセスする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="exceptiontranslationfilter">
<h4><a class="toc-backref" href="#id44">9.3.1.1.1. ExceptionTranslationFilter</a><a class="headerlink" href="#exceptiontranslationfilter" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">ExceptionTranslationFilter</span></code>は、認可処理(<code class="docutils literal"><span class="pre">AccessDecisionManager</span></code>)で発生した例外をハンドリングし、クライアントへ適切なレスポンスを行うためのSecurity Filterである。
デフォルトの実装では、未認証ユーザーからのアクセスの場合は認証を促すレスポンス、認証済みのユーザーからのアクセスの場合は認可エラーを通知するレスポンスを返却する。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="filtersecurityinterceptor">
<h4><a class="toc-backref" href="#id45">9.3.1.1.2. FilterSecurityInterceptor</a><a class="headerlink" href="#filtersecurityinterceptor" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">FilterSecurityInterceptor</span></code>は、HTTPリクエストに対して認可処理を適用するためのSecurity Filterで、実際の認可処理は<code class="docutils literal"><span class="pre">AccessDecisionManager</span></code>に委譲する。
<code class="docutils literal"><span class="pre">AccessDecisionManager</span></code>インタフェースのメソッドを呼び出す際には、クライアントがアクセスしようとしたリソースに指定されているアクセスポリシーを連携する。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="accessdecisionmanager">
<h4><a class="toc-backref" href="#id46">9.3.1.1.3. AccessDecisionManager</a><a class="headerlink" href="#accessdecisionmanager" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">AccessDecisionManager</span></code>は、アクセスしようとしたリソースに対してアクセス権があるかチェックを行うためのインタフェースである。</p>
<p>Spring Securityが提供する実装クラスは3種類存在するが、いずれも<code class="docutils literal"><span class="pre">AccessDecisionVoter</span></code>というインタフェースのメソッドを呼び出してアクセス権を付与するか否かを判定させている。
<code class="docutils literal"><span class="pre">AccessDecisionVoter</span></code>は「付与」「拒否」「棄権」のいずれかを投票し、<code class="docutils literal"><span class="pre">AccessDecisionManager</span></code>の実装クラスが投票結果を集約して最終的なアクセス権を判断する。
アクセス権がないと判断した場合は、<code class="docutils literal"><span class="pre">AccessDeniedException</span></code>を発生させアクセスを拒否する。</p>
<p>なお、すべての投票結果が「棄権」であった場合、Spring Securityのでデフォルトでは、「アクセス権なし」と判定される。</p>
<table border="1" class="colwidths-given docutils" id="id33">
<caption><span class="caption-text"><strong>Spring Securityが提供するAccessDecisionManagerの実装クラス</strong></span><a class="headerlink" href="#id33" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">クラス名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AffirmativeBased</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AccessDecisionVoter</span></code>に投票させ、「付与」が１件投票された時点でアクセス権を与える実装クラス。</div>
<div class="line"><strong>デフォルトで使用される実装クラス。</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ConsensusBased</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">全ての<code class="docutils literal"><span class="pre">AccessDecisionVoter</span></code>に投票させ、「付与」の投票数が多い場合にアクセス権を与える実装クラス。</div>
<div class="line">「付与」「拒否」が１件以上、且つ同数の場合、Spring Securityのデフォルトでは、「アクセス権あり」と判定される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UnanimousBased</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AccessDecisionVoter</span></code>に投票させ、「拒否」が１件投票された時点で <strong>アクセス権を与えない</strong> 実装クラス。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>AccessDecisionVoterの選択</strong></p>
<p class="last">使用する<code class="docutils literal"><span class="pre">AccessDecisionVoter</span></code>が1つの場合はどの実装クラスを使っても動作に違いはない。
複数の<code class="docutils literal"><span class="pre">AccessDecisionVoter</span></code>を使用する場合は、要件に合わせて実装クラスを選択されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="accessdecisionvoter">
<h4><a class="toc-backref" href="#id47">9.3.1.1.4. AccessDecisionVoter</a><a class="headerlink" href="#accessdecisionvoter" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">AccessDecisionVoter</span></code>は、アクセスしようとしたリソースに指定されているアクセスポリシーを参照してアクセス権を付与するかを投票するためのインタフェースである。</p>
<p>Spring Securityが提供する主な実装クラスは以下の通り。</p>
<table border="1" class="colwidths-given docutils" id="id34">
<caption><span class="caption-text"><strong>Spring Securityが提供するAccessDecisionVoterの主な実装クラス</strong></span><a class="headerlink" href="#id34" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">クラス名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">WebExpressionVoter</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SpEL経由で認証情報(<code class="docutils literal"><span class="pre">Authentication</span></code>)が保持する権限情報とリクエスト情報(<code class="docutils literal"><span class="pre">HttpServletRequest</span></code>)を参照して投票を行う実装クラス。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">PreInvocationAuthorizationAdviceVoter</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">メソッド呼び出しに対する認可処理を行う<code class="docutils literal"><span class="pre">&#64;PreAuthorize</span></code>、<code class="docutils literal"><span class="pre">&#64;PreFilter</span></code>が付与されている場合に投票を行う実装クラス。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RoleVoter</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">利用者が持つロールを参照して投票を行う実装クラス。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RoleHierarchyVoter</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">利用者が持つ階層化されたロールを参照して投票を行う実装クラス。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthenticatedVoter</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証状態を参照して投票を行う実装クラス。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>デフォルトで適用されるAccessDecisionVoter</strong></p>
<p class="last">デフォルトで適用される<code class="docutils literal"><span class="pre">AccessDecisionVoter</span></code>インタフェースの実装クラスは、Spring Security 4.0から<code class="docutils literal"><span class="pre">WebExpressionVoter</span></code>に統一されている。
<code class="docutils literal"><span class="pre">WebExpressionVoter</span></code>は、<code class="docutils literal"><span class="pre">RoleVoter</span></code>、<code class="docutils literal"><span class="pre">RoleHierarchyVoter</span></code>、<code class="docutils literal"><span class="pre">AuthenticatedVoter</span></code>を使用した時と同じことが実現できるため、
本ガイドラインでも、デフォルトの<code class="docutils literal"><span class="pre">WebExpressionVoter</span></code>を使って認可処理を行う前提で説明を行う。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-use">
<h2><a class="toc-backref" href="#id48">9.3.2. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<p>認可機能を使用するために必要となるbean定義例(アクセスポリシーの指定方法)や実装方法について説明する。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="springsecurityauthorizationpolicy">
<span id="id5"></span><h3><a class="toc-backref" href="#id49">9.3.2.1. アクセスポリシーの記述方法</a><a class="headerlink" href="#springsecurityauthorizationpolicy" title="Permalink to this headline">¶</a></h3>
<p>アクセスポリシーの記述方法を説明する。</p>
<p>Spring Securityは、アクセスポリシーを指定する記述方法としてSpring Expression Language(SpEL)をサポートしている。
SpELを使わない方法もあるが、本ガイドラインではExpressionを使ってアクセスポリシーを指定する方法で説明を行う。
SpELの使い方については本節でも紹介するが、より詳しい使い方を知りたい場合は <a class="reference external" href="https://docs.spring.io/spring-framework/docs/5.3.2/reference/html/core.html#expressions">Spring Framework Documentation -Spring Expression Language (SpEL)-</a>を参照されたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="built-incommon-expressions">
<h4><a class="toc-backref" href="#id50">9.3.2.1.1. Built-InのCommon Expressions</a><a class="headerlink" href="#built-incommon-expressions" title="Permalink to this headline">¶</a></h4>
<p>Spring Securityが用意している共通的なExpressionは以下の通り。</p>
<table border="1" class="colwidths-given longtable docutils" id="id35">
<caption><span class="caption-text"><strong>Spring Securityが提供している共通的なExpression</strong></span><a class="headerlink" href="#id35" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="30%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Expression</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">hasRole(String</span> <span class="pre">role)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ログインユーザーが、引数に指定したロールを保持している場合に<code class="docutils literal"><span class="pre">true</span></code>を返却する。</div>
<div class="line">ロールの<code class="docutils literal"><span class="pre">ROLE_</span></code> プレフィックスは省略可能である。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">hasAnyRole(String...</span> <span class="pre">roles)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ログインユーザーが、引数に指定したロールのいずれかを保持している場合に<code class="docutils literal"><span class="pre">true</span></code>を返却する。</div>
<div class="line">ロールの<code class="docutils literal"><span class="pre">ROLE_</span></code> プレフィックスは省略可能である。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">isAnonymous()</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ログインしていない匿名ユーザーの場合に<code class="docutils literal"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">isRememberMe()</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Remember Me認証によってログインしたユーザーの場合に<code class="docutils literal"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">isAuthenticated()</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ログイン中の場合に<code class="docutils literal"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">isFullyAuthenticated()</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Remember Me認証ではなく通常の認証プロセスによってログインしたユーザーの場合に<code class="docutils literal"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">permitAll</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">常に<code class="docutils literal"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">denyAll</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">常に<code class="docutils literal"><span class="pre">false</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">principal</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証されたユーザーのユーザー情報(<code class="docutils literal"><span class="pre">UserDetails</span></code>インタフェースを実装したクラスのオブジェクト)を返却する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">authentication</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証されたユーザーの認証情報(<code class="docutils literal"><span class="pre">Authentication</span></code>インタフェースを実装したクラスのオブジェクト)を返却する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Expressionを使用した認証情報へのアクセス</strong></p>
<p class="last">Expressionとして<code class="docutils literal"><span class="pre">principal</span></code>や<code class="docutils literal"><span class="pre">authentication</span></code>を使用すると、ログインユーザーのユーザー情報や認証情報を参照することができるため、ロール以外の属性を使ってアクセスポリシーを設定することが可能になる。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Spring Secuirtyが提供するその他のExpression</strong></p>
<p>上記に記載した以外にも、Spring Securityではログインユーザーが保持する権限を確認するExpressionとして、
<code class="docutils literal"><span class="pre">hasAuthority(String</span> <span class="pre">authority)</span></code>、<code class="docutils literal"><span class="pre">hasAnyAuthority(String...</span> <span class="pre">authorities)</span></code>、<code class="docutils literal"><span class="pre">hasPermission(Object</span> <span class="pre">target,</span> <span class="pre">Object</span> <span class="pre">permission)</span></code>、<code class="docutils literal"><span class="pre">hasPermission(Object</span> <span class="pre">targetId,</span> <span class="pre">String</span> <span class="pre">targetType,</span> <span class="pre">Object</span> <span class="pre">permission)</span></code>を提供している。</p>
<p class="last">ユーザの属性により権限をグループ化したものがロールであり、一般的には個々の権限による認可ではなくロールによる認可が推奨される。
Spring Securityの認可においてはいずれもログインユーザが「指定した権限（ロール）を保持しているか」を確認するため利用方法に違いはないが、
権限名はロール名と異なり<code class="docutils literal"><span class="pre">ROLE_</span></code>のようなプレフィックスがないため、権限の定義と認可で名称を完全一致させる必要がある。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="built-inweb-expressions">
<span id="id6"></span><h4><a class="toc-backref" href="#id51">9.3.2.1.2. Built-InのWeb Expressions</a><a class="headerlink" href="#built-inweb-expressions" title="Permalink to this headline">¶</a></h4>
<p>Spring Securityが用意しているWebアプリケーション向けExpressionは以下の通り。</p>
<table border="1" class="colwidths-given docutils" id="id36">
<caption><span class="caption-text"><strong>Spring Securityが提供するWebアプリケーション向けExpression</strong></span><a class="headerlink" href="#id36" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="30%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Expression</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">hasIpAddress(String</span> <span class="pre">ipAddress)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエスト元のIPアドレスが、引数に指定したIPアドレス体系に一致する場合に<code class="docutils literal"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id7">
<h4><a class="toc-backref" href="#id52">9.3.2.1.3. 演算子の使用</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<p>演算子を使用した判定も行うことができる。
以下の例では、ロールと、リクエストされたIPアドレス両方に合致した場合、アクセス可能となる。</p>
<ul>
<li><p class="first">spring-security.xmlの定義例</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/admin/**&quot;</span> <span class="na">access=</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;) and hasIpAddress(&#39;192.168.10.1&#39;)&quot;</span><span class="nt">/&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<p><strong>使用可能な演算子一覧</strong></p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">演算子</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">[式1]</span> <span class="pre">and</span> <span class="pre">[式2]</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">式1、式2が、どちらも真の場合に、真を返す。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">[式1]</span> <span class="pre">or</span> <span class="pre">[式2]</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">いずれかの式が、真の場合に、真を返す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">![式]</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">式が真の場合は偽を、偽の場合は真を返す。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="web">
<span id="authorizationtowebresources"></span><h3><a class="toc-backref" href="#id53">9.3.2.2. Webリソースへの認可</a><a class="headerlink" href="#web" title="Permalink to this headline">¶</a></h3>
<p>Spring Securityは、サーブレットフィルタの仕組みを利用してWebリソース(HTTPリクエスト)に対して認可処理を行う。</p>
<div class="section" id="id8">
<h4><a class="toc-backref" href="#id54">9.3.2.2.1. 認可処理の適用</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<p>Webリソースに対して認可処理を適用する場合は、以下のようなbean定義を行う。</p>
<ul class="simple">
<li>spring-security.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/**&quot;</span> <span class="na">access=</span><span class="s">&quot;isAuthenticated()&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;sec:intercept-url&gt;</span></code>タグに、HTTPリクエストに対してアクセスポリシーを定義する。</div>
<div class="line">ここでは、SpELを使用して「Webアプリケーション配下の全てのリクエストに対して認証済みのユーザーのみアクセスを許可する」というアクセスポリシーを定義している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id9">
<h4><a class="toc-backref" href="#id55">9.3.2.2.2. アクセスポリシーの定義</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<p>bean定義ファイルを使用して、Webリソースに対してアクセスポリシーを定義する方法について説明する。</p>
<div class="section" id="access-policy-designate-web-resource">
<span id="id10"></span><h5><a class="toc-backref" href="#id56">9.3.2.2.2.1. アクセスポリシーを適用するWebリソースの指定</a><a class="headerlink" href="#access-policy-designate-web-resource" title="Permalink to this headline">¶</a></h5>
<p>まず、アクセスポリシーを適用するリソース(HTTPリクエスト)を指定する。
アクセスポリシーを適用するリソースの指定は、<code class="docutils literal"><span class="pre">&lt;sec:intercept-url&gt;</span></code>タグの以下の属性を使用する。</p>
<table border="1" class="colwidths-given docutils" id="id37">
<caption><span class="caption-text"><strong>アクセスポリシーを適用するリソースを指定するための属性</strong></span><a class="headerlink" href="#id37" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">属性名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">pattern</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Ant形式又は正規表現で指定したパスパターンに一致するリソースを適用対象にするための属性。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">method</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">指定したHTTPメソッド(GET,POSTなど)を使ってアクセスがあった場合に適用対象にするための属性。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">requires-channel</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">「http」、もしくは「https」を指定する。指定したプロトコルでのアクセスを強制するための属性。</div>
<div class="line">指定しない場合、どちらでもアクセス可能である。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>上記以外の属性については、<a class="reference external" href="https://docs.spring.io/spring-security/site/docs/5.4.2/reference/html5/#nsa-intercept-url">&lt;intercept-url&gt;</a>を参照されたい。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">&lt;sec:intercept-url&gt;</span></code>タグ<code class="docutils literal"><span class="pre">pattern</span></code>属性の定義例（spring-security.xml）</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span> <span class="nt">&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/admin/accounts/**&quot;</span> <span class="na">access=</span><span class="s">&quot;...&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/admin/**&quot;</span> <span class="na">access=</span><span class="s">&quot;...&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/**&quot;</span> <span class="na">access=</span><span class="s">&quot;...&quot;</span><span class="nt">/&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<p>Spring Securityは定義した順番でリクエストとのマッチング処理を行い、最初にマッチした定義を適用する。
そのため、bean定義ファイルを使用してアクセスポリシーを指定する場合も定義順番には注意が必要である。</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>パスパターンの解釈</strong></p>
<p>Spring Securityのデフォルトの動作では、パスパターンはAnt形式で解釈する。
パスパターンを正規表現で指定したい場合は、<code class="docutils literal"><span class="pre">&lt;sec:http&gt;</span></code>タグの<code class="docutils literal"><span class="pre">request-matcher</span></code>属性に
<code class="docutils literal"><span class="pre">regex</span></code>を指定すること。</p>
<blockquote class="last">
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span> <span class="na">request-matcher=</span><span class="s">&quot;regex&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/admin/accounts/.*&quot;</span> <span class="na">access=</span><span class="s">&quot;hasRole(&#39;ACCOUNT_MANAGER&#39;)&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Spring Security 4.1以降、Spring Securityがデフォルトで使用している<cite>AntPathRequestMatcher</cite> のパスマッチングの仕様が大文字・小文字を区別する様になった。</p>
<p>例えば以下に示すように、<code class="docutils literal"><span class="pre">/Todo/List</span></code>というパスが割り当てられたSpring MVCのエンドポイントに対してアクセスポリシーを定義する場合は、
<code class="docutils literal"><span class="pre">&lt;sec:intercept-url&gt;</span></code>タグの <code class="docutils literal"><span class="pre">pattern</span></code>属性に指定する値は <code class="docutils literal"><span class="pre">/Todo/List</span></code>や <code class="docutils literal"><span class="pre">/Todo/*</span></code>など大文字・小文字をそろえる必要がある。
誤って<code class="docutils literal"><span class="pre">/todo/list</span></code>や<code class="docutils literal"><span class="pre">/todo/**</span></code>など大文字・小文字がそろっていない値を指定してしまうと、意図した認可制御が行われなくなるので注意されたい。</p>
<ul class="simple">
<li>Spring MVCのエンドポイントの実装例</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s">&quot;/Todo/List&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">viewTodoList</span><span class="p">(){</span>
   <span class="c1">//...</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>アクセスポリシーの定義例</li>
</ul>
<blockquote class="last">
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/Todo/List&quot;</span> <span class="na">access=</span><span class="s">&quot;isAuthenticated()&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Spring MVCとSpring Securityでは、リクエストとのマッチングの仕組みが厳密には異なっており、この差異を利用してSpring Securityの認可機能を突破し、ハンドラメソッドにアクセスできる脆弱性が存在する。
本事象の詳細は「<a class="reference external" href="https://pivotal.io/security/cve-2016-5007">CVE-2016-5007 Spring Security / MVC Path Matching Inconsistency</a>」を参照されたい。</p>
<p class="last"><cite>trimTokens</cite> プロパティに <cite>true</cite> を設定した<cite>org.springframework.util.AntPathMatcher</cite> のBeanがSpring MVCに適用されている場合に、本事象が発生する。
Spring Framework 4.2以前は <cite>trimTokens</cite> プロパティのデフォルト値が<cite>true</cite>となっていたが、Spring Framework 4.3 からデフォルト値は <cite>false</cite> となったため、意図的に変更しない限り本事象は発生しない。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>特定のURLに対してアクセスポリシーを設ける(<code class="docutils literal"><span class="pre">pattern</span></code>属性に”<code class="docutils literal"><span class="pre">*</span></code>”や<code class="docutils literal"><span class="pre">**</span></code>などのワイルドカード指定を含めない)場合、
拡張子を付けたパターンとリクエストパスの末尾に”<code class="docutils literal"><span class="pre">/</span></code>”を付けたパターンに対するアクセスポリシーの追加が必須である。</p>
<p>下記の設定例は、<code class="docutils literal"><span class="pre">/restrict</span></code>に対して「ROLE_ADMIN」ロールを持つユーザからのアクセスのみを許可している。</p>
<blockquote class="last">
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/restrict.*&quot;</span> <span class="na">access=</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;)&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/restrict/&quot;</span> <span class="na">access=</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;)&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/restrict&quot;</span> <span class="na">access=</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;)&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">/restrict</span></code>に拡張子を付けたパターン(<code class="docutils literal"><span class="pre">/restrict.json</span></code>など)のアクセスポリシーを定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">/restrict</span></code>にリクエストパスの末尾に”<code class="docutils literal"><span class="pre">/</span></code>”を付けたパターン(<code class="docutils literal"><span class="pre">/restrict/</span></code>など)のアクセスポリシーを定義する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">/restrict</span></code>に対するアクセスポリシーを定義する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div>
<div class="section" id="id11">
<h5><a class="toc-backref" href="#id57">9.3.2.2.2.2. アクセスポリシーの指定</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h5>
<p>つぎに、アクセスポリシーを指定する。
アクセスポリシーの指定は、<code class="docutils literal"><span class="pre">&lt;sec:intercept-url&gt;</span></code>タグの<code class="docutils literal"><span class="pre">access</span></code>属性に指定する。</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">&lt;sec:intercept-url&gt;</span></code>タグ<code class="docutils literal"><span class="pre">access</span></code>属性の定義例（<code class="docutils literal"><span class="pre">spring-security.xml</span></code>）</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/admin/accounts/**&quot;</span> <span class="na">access=</span><span class="s">&quot;hasRole(&#39;ACCOUNT_MANAGER&#39;)&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/admin/configurations/**&quot;</span> <span class="na">access=</span><span class="s">&quot;hasIpAddress(&#39;127.0.0.1&#39;) and hasRole(&#39;CONFIGURATION_MANAGER&#39;)&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/admin/**&quot;</span> <span class="na">access=</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;)&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils" id="id38">
<caption><span class="caption-text"><strong>アクセスポリシーを指定するための属性</strong></span><a class="headerlink" href="#id38" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">属性名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">access</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SpELでのアクセス制御式や、アクセス可能なロールを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<div class="line-block">
<div class="line">ログインユーザーに「ROLE_USER」「ROLE_ADMIN」というロールがある場合を例に、設定例を示す。</div>
</div>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">&lt;sec:intercept-url&gt;</span></code>タグ<code class="docutils literal"><span class="pre">pattern</span></code>属性の定義例（spring-security.xml）</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/reserve/**&quot;</span> <span class="na">access=</span><span class="s">&quot;hasAnyRole(&#39;USER&#39;,&#39;ADMIN&#39;)&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/admin/**&quot;</span> <span class="na">access=</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;)&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/**&quot;</span> <span class="na">access=</span><span class="s">&quot;denyAll&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">「<code class="docutils literal"><span class="pre">/reserve/**</span></code>」にアクセスするためには、「ROLE_USER」もしくは「ROLE_ADMIN」ロールが必要である。</div>
<div class="line"><code class="docutils literal"><span class="pre">hasAnyRole</span></code>については、後述する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">「<code class="docutils literal"><span class="pre">/admin/**</span></code>」にアクセスするためには、「ROLE_ADMIN」ロールが必要である。</div>
<div class="line"><code class="docutils literal"><span class="pre">hasRole</span></code>については、後述する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">denyAll</span></code>を全てのパターンに設定し、</div>
<div class="line">権限設定が記述されていないURLに対してはどのユーザーもアクセス出来ない設定としている。</div>
<div class="line"><code class="docutils literal"><span class="pre">denyAll</span></code>については、後述する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>URLパターンの記述順序について</strong></p>
<p class="last">クライアントからのリクエストに対して、intercept-urlで記述されているパターンに、上から順にマッチさせ、マッチしたパターンに対してアクセス認可を行う。
そのため、パターンの記述は、必ず、より限定されたパターンから記述すること。</p>
</div>
</li>
</ul>
<p>Spring Securiyではデフォルトで、SpELが有効になっている。
<code class="docutils literal"><span class="pre">access</span></code>属性に記述したSpELは真偽値で評価され、式が真の場合に、アクセスが認可される。
以下に使用例を示す。</p>
<ul>
<li><p class="first">spring-security.xmlの定義例</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/admin/**&quot;</span> <span class="na">access=</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;)&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">hasRole('ロール名')</span></code>を指定することで、ログインユーザーが指定したロールを保持していれば真を返す。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<p id="spring-el">使用可能な主なExpressionは、<a class="reference internal" href="#springsecurityauthorizationpolicy"><span class="std std-ref">アクセスポリシーの記述方法</span></a> を参照されたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id12">
<h5><a class="toc-backref" href="#id58">9.3.2.2.2.3. パス変数の参照</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h5>
<p>Spring Security 4.1以降では、アクセスポリシーを適用するリソースを指定する際にパス変数<a class="footnote-reference" href="#fpathvariabledescription" id="id13">[2]</a>を使用することができ、
アクセスポリシーの定義内で<code class="docutils literal"><span class="pre">#パス変数名</span></code>と指定することで参照できる。</p>
<p>ただし、拡張子を付けてアクセス可能なパスに対してパス変数を使用するアクセスポリシーを定義する場合は、パス変数値に拡張子部分が格納されない様に定義する必要がある。</p>
<p>例えば、パターンに<code class="docutils literal"><span class="pre">/users/{userName}</span></code>と定義し、<code class="docutils literal"><span class="pre">/users/personName.json</span></code>というリクエストパスを送信した際、
アクセスポリシーの定義内で参照しているパス変数<code class="docutils literal"><span class="pre">#userName</span></code>には<code class="docutils literal"><span class="pre">personName</span></code>ではなく<code class="docutils literal"><span class="pre">personName.json</span></code>が格納され、
意図しない認可制御が行われてしまう。</p>
<p>この事象を防ぐためには、「拡張子を付けたパスに対するアクセスポリシー」を定義した後に、「拡張子を付けないパスに対するアクセスポリシー」を定義する必要がある。</p>
<p>以下の例は、ログインユーザが自身のユーザ情報のみアクセスできる様にアクセスポリシーを定義している。</p>
<ul>
<li><p class="first">spring-security.xmlの定義例（ワイルドカードを使用する場合）</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http&gt;</span>
    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/users/{userName}.*&quot;</span>  <span class="na">access=</span><span class="s">&quot;isAuthenticated() and #userName == principal.username&quot;</span><span class="nt">/&gt;</span>
    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/users/{userName}/**&quot;</span> <span class="na">access=</span><span class="s">&quot;isAuthenticated() and #userName == principal.username&quot;</span><span class="nt">/&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">「拡張子を付けたパスに対するアクセスポリシー」を定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">「拡張子を付けないパスに対するアクセスポリシー」を定義する。</div>
<div class="line">ワイルドカードを使用して<code class="docutils literal"><span class="pre">/users/{userName}</span></code>で始まるパスに対するアクセスポリシーを定義する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul>
<li><p class="first">spring-security.xmlの定義例（ワイルドカードを使用しない場合）</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http&gt;</span>
    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/users/{userName}.*&quot;</span> <span class="na">access=</span><span class="s">&quot;isAuthenticated() and #userName == principal.username&quot;</span><span class="nt">/&gt;</span>
    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/users/{userName}/&quot;</span>  <span class="na">access=</span><span class="s">&quot;isAuthenticated() and #userName == principal.username&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/users/{userName}&quot;</span>   <span class="na">access=</span><span class="s">&quot;isAuthenticated() and #userName == principal.username&quot;</span><span class="nt">/&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">「拡張子を付けたパスに対するアクセスポリシー」を定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">「拡張子を付けないパスに対するアクセスポリシー」を定義する。</div>
<div class="line">ワイルドカードを使用しない場合、Spring MVCとSpring Securityのパスマッチングの差を吸収するために</div>
<div class="line">末尾が”<code class="docutils literal"><span class="pre">/</span></code>” で終わるパスに対するアクセスポリシーも定義する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<table class="docutils footnote" frame="void" id="fpathvariabledescription" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id13">[2]</a></td><td>パス変数の説明は <a class="reference internal" href="../ImplementationAtEachLayer/ApplicationLayer.html"><span class="doc">アプリケーション層の実装</span></a> の<a class="reference internal" href="../ImplementationAtEachLayer/ApplicationLayer.html#controller-method-argument-pathvariable-label"><span class="std std-ref">URLのパスから値を取得する</span></a>を参照されたい。</td></tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="authorizationtomethod">
<span id="id14"></span><h3><a class="toc-backref" href="#id59">9.3.2.3. メソッドへの認可</a><a class="headerlink" href="#authorizationtomethod" title="Permalink to this headline">¶</a></h3>
<p>Spring Securityは、Spring AOPの仕組みを利用してDIコンテナで管理しているBeanのメソッド呼び出しに対して認可処理を行う。</p>
<p>メソッドに対する認可処理は、ドメイン層(サービス層)のメソッド呼び出しに対して行うことを想定して提供されている。
メソッドに対する認可処理を使用すると、ドメインオブジェクトのプロパティを参照することができるため、きめの細かいアクセスポリシーの定義を行うことが可能になる。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="aop">
<h4><a class="toc-backref" href="#id60">9.3.2.3.1. AOPの有効化</a><a class="headerlink" href="#aop" title="Permalink to this headline">¶</a></h4>
<p>メソッドへの認可処理を使用する場合は、メソッド呼び出しに対して認可処理を行うためのコンポーネント(AOP)を有効化する必要がある。
AOPを有効化すると、アクセスポリシーをメソッドのアノテーションに定義できるようになる。</p>
<p>Spring Securityは、以下のアノテーションをサポートしている。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">&#64;PreAuthorize</span></code>、<code class="docutils literal"><span class="pre">&#64;PostAuthorize</span></code>、<code class="docutils literal"><span class="pre">&#64;PreFilter</span></code>、<code class="docutils literal"><span class="pre">&#64;PostFilter</span></code></li>
<li>JSR-250 (<code class="docutils literal"><span class="pre">javax.annotation.security</span></code>パッケージ)のアノテーション(<code class="docutils literal"><span class="pre">&#64;RolesAllowed</span></code>など)</li>
<li><code class="docutils literal"><span class="pre">&#64;Secured</span></code></li>
</ul>
<p>本ガイドラインでは、アクセスポリシーをExpressionで使用することができる<code class="docutils literal"><span class="pre">&#64;PreAuthorize</span></code>、<code class="docutils literal"><span class="pre">&#64;PostAuthorize</span></code>を使用する方法を説明する。</p>
<ul class="simple">
<li>spring-security.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:global-method-security</span> <span class="na">pre-post-annotations=</span><span class="s">&quot;enabled&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) (2) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;sec:global-method-security&gt;</span></code>タグを付与すると、メソッド呼び出しに対する認可処理を行うAOPが有効になる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">pre-post-annotations</span></code>属性に<code class="docutils literal"><span class="pre">enabled</span></code>を指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">pre-post-annotations</span></code>属性に<code class="docutils literal"><span class="pre">enabled</span></code>を指定すると、Expressionを指定してアクセスポリシーを定義できるアノテーションが有効になる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id15">
<h4><a class="toc-backref" href="#id61">9.3.2.3.2. 認可処理の適用</a><a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h4>
<p>メソッドに対して認可処理を適用する際は、アクセスポリシーを指定するアノテーションを使用して、メソッド毎にアクセスポリシーを定義する。</p>
</div>
<div class="section" id="id16">
<h4><a class="toc-backref" href="#id62">9.3.2.3.3. アクセスポリシーの定義</a><a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id17">
<h5><a class="toc-backref" href="#id63">9.3.2.3.3.1. メソッド実行前に適用するアクセスポリシーの指定</a><a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h5>
<p>メソッドの実行前に適用するアクセスポリシーを指定する場合は、<code class="docutils literal"><span class="pre">&#64;PreAuthorize</span></code>を使用する。</p>
<p><code class="docutils literal"><span class="pre">&#64;PreAuthorize</span></code>の<code class="docutils literal"><span class="pre">value</span></code>属性に指定したExpressionの結果が<code class="docutils literal"><span class="pre">true</span></code>になるとメソッドの実行が許可される。
下記例では、管理者以外は、他人のアカウント情報にアクセスできないように定義している。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">&#64;PreAuthorize</span></code>の定義例</li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (1) (2)</span>
<span class="nd">@PreAuthorize</span><span class="p">(</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;) or (#username == principal.username)&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">Account</span> <span class="nf">findOne</span><span class="p">(</span><span class="n">String</span> <span class="n">username</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">accountRepository</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">username</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可処理を適用したいメソッドに、<code class="docutils literal"><span class="pre">&#64;PreAuthorize</span></code>を付与する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">value</span></code>属性に、メソッドに対してアクセスポリシーを定義する。</div>
<div class="line">ここでは、「管理者の場合は全てのアカウントへのアクセスを許可する」「管理者以外の場合は自身のアカウントへのアクセスのみ許可する」というアクセスポリシーを定義している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>ここでポイントになるのは、Expressionの中からメソッドの引数にアクセスしている部分である。
具体的には、「<code class="docutils literal"><span class="pre">#username</span></code>」の部分が引数にアクセスしている部分である。
Expression内で「# + 引数名」形式のExpressionを指定することで、メソッドの引数にアクセスすることができる。</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>引数名を指定するアノテーション</strong></p>
<p>Spring Securityは、クラスに出力されているデバッグ情報から引数名を解決する仕組み
になっているが、アノテーション(<code class="docutils literal"><span class="pre">&#64;org.springframework.security.core.parameters.P</span></code>)
を使用して明示的に引数名を指定することもできる。</p>
<p>以下のケースにあてはまる場合は、アノテーションを使用して明示的に変数名を指定する。</p>
<ul>
<li><p class="first">クラスに変数のデバッグ情報を出力しない</p>
</li>
<li><p class="first">Expressionの中から実際の変数名とは別の名前を使ってアクセスしたい (例えば短縮した名前)</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@PreAuthorize</span><span class="p">(</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;) or (#username == principal.username)&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">Account</span> <span class="nf">findOne</span><span class="p">(</span><span class="nd">@P</span><span class="p">(</span><span class="s">&quot;username&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">username</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">accountRepository</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">username</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
<p>なお、<code class="docutils literal"><span class="pre">#username</span></code>と、メソッドの引数である <code class="docutils literal"><span class="pre">username</span></code>の名称が一致している場合は <code class="docutils literal"><span class="pre">&#64;P</span></code>を省略することが可能である。
ただし、Spring Securityは引数名の解決を、実装クラスの引数名を使用して行っているため <code class="docutils literal"><span class="pre">&#64;PreAuthorize</span></code> アノテーションをインターフェースに定義している場合には、
<strong>実装クラスの引数名を、 &#64;PreAuthorize 内で指定した #username と一致させる必要がある</strong> ので、注意されたい。</p>
<p class="last">JDK 8 から追加されたコンパイルオプション(<code class="docutils literal"><span class="pre">-parameters</span></code>)を使用すると、メソッドパラメータにリフレクション用のメタデータが生成されるため、アノテーションを指定しなくても引数名が解決される。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Spring 5から、SpringのコアAPIに<a class="reference external" href="https://docs.spring.io/spring-framework/docs/5.3.2/reference/html/core.html#null-safety">null-safety</a>の機能が取り入れられており、SpELが解釈される際の<code class="docutils literal"><span class="pre">null</span></code>に対する動作も変更(<a class="reference external" href="https://jira.spring.io/browse/SPR-15540">SPR-15540</a>)されている。
例えば<code class="docutils literal"><span class="pre">&#64;PreAuthorize</span></code>の引数(<code class="docutils literal"><span class="pre">#xxx</span></code>)や、<code class="docutils literal"><span class="pre">&#64;PostAuthorize</span></code>の戻り値（<code class="docutils literal"><span class="pre">resultObject</span></code>）が<code class="docutils literal"><span class="pre">Map</span></code>を含む場合、<code class="docutils literal"><span class="pre">Map</span></code>から値を取得するSpELでキー値に<code class="docutils literal"><span class="pre">null</span></code>となる値を入力すると、Spring 4以前ではそのまま<code class="docutils literal"><span class="pre">Map</span></code>に<code class="docutils literal"><span class="pre">null</span></code>が渡され該当する値がないため<code class="docutils literal"><span class="pre">null</span></code>が返却されていたが、Spring 5以降ではキーとなるSpELを評価した結果に対する<code class="docutils literal"><span class="pre">null</span></code>チェックが追加されており、<code class="docutils literal"><span class="pre">null</span></code>の場合は<code class="docutils literal"><span class="pre">IllegalStateException</span></code>が発生する。
そのため、キーとする値に対して事前に<code class="docutils literal"><span class="pre">null</span></code>チェックを行うなど、<code class="docutils literal"><span class="pre">null</span></code>を考慮した実装が必要となる。</p>
</div>
</div>
<div class="section" id="id18">
<h5><a class="toc-backref" href="#id64">9.3.2.3.3.2. メソッド実行後に適用するアクセスポリシーの指定</a><a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h5>
<p>メソッドの実行後に適用するアクセスポリシーを指定する場合は、<code class="docutils literal"><span class="pre">&#64;PostAuthorize</span></code>を使用する。</p>
<p><code class="docutils literal"><span class="pre">&#64;PostAuthorize</span></code>の<code class="docutils literal"><span class="pre">value</span></code>属性に指定したExpressionの結果が<code class="docutils literal"><span class="pre">true</span></code>になるとメソッドの実行結果が呼び出し元に返却される。
下記例では、所属する部署が違うユーザーのアカウント情報にアクセスできないように定義している。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">&#64;PostAuthorize</span></code>の定義例</li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@PreAuthorize</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">)</span>
<span class="nd">@PostAuthorize</span><span class="p">(</span><span class="s">&quot;(returnObject == null) &quot;</span> <span class="o">+</span>
        <span class="s">&quot;or (returnObject.departmentCode == principal.account.departmentCode)&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">Account</span> <span class="nf">findOne</span><span class="p">(</span><span class="n">String</span> <span class="n">username</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">accountRepository</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">username</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>ここでポイントになるのは、Expressionの中からメソッドの返り値にアクセスしている部分である。
具体的には、「<code class="docutils literal"><span class="pre">returnObject.departmentCode</span></code>」の部分が返り値にアクセスしている部分である。
Expression内で「<code class="docutils literal"><span class="pre">returnObject</span></code>」を指定すると、メソッドの返り値にアクセスすることができる。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="jsp">
<h3><a class="toc-backref" href="#id65">9.3.2.4. JSPの画面項目への認可</a><a class="headerlink" href="#jsp" title="Permalink to this headline">¶</a></h3>
<p>Spring Securityは、JSPタグライブラリを使用してJSPの画面項目に対して認可処理を適用することができる。</p>
<p>ここでは最もシンプルな定義を例に、JSPの画面項目のアクセスに対して認可処理を適用する方法について説明する。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="id19">
<h4><a class="toc-backref" href="#id66">9.3.2.4.1. アクセスポリシーの定義</a><a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h4>
<p>JSPタグライブラリを使用してJSPの画面項目に対してアクセスポリシーを定義する際は、表示を許可する条件(アクセスポリシー)をJSPに定義する。</p>
<ul class="simple">
<li>アクセスポリシー定義例</li>
</ul>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="k">&lt;%@</span> <span class="n">taglib</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;sec&quot;</span> <span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://www.springframework.org/security/tags&quot;</span> <span class="k">%&gt;</span>

<span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;sec:authorize</span> <span class="na">access=</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;)&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;h2&gt;</span>Admin Menu<span class="nt">&lt;/h2&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:authorize&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アクセスポリシーを適用したい部分を<code class="docutils literal"><span class="pre">&lt;sec:authorize&gt;</span></code>タグで囲む。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">access</span></code>属性にアクセスポリシーを定義する。ここでは、「管理者の場合は表示を許可する」というアクセスポリシーを定義している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id20">
<h4><a class="toc-backref" href="#id67">9.3.2.4.2. Webリソースに指定したアクセスポリシーとの連動</a><a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h4>
<p>ボタンやリンクなど(サーバーへのリクエストを伴う画面項目)に対してアクセスポリシーを定義する際は、リクエスト先のWebリソースに定義されているアクセスポリシーと連動させる。
Webリソースに指定したアクセスポリシーと連動させる場合は、<code class="docutils literal"><span class="pre">&lt;sec:authorize&gt;</span></code>タグの<code class="docutils literal"><span class="pre">url</span></code>属性を使用する。</p>
<p><code class="docutils literal"><span class="pre">url</span></code>属性に指定したWebリソースにアクセスできる場合に限り<code class="docutils literal"><span class="pre">&lt;sec:authorize&gt;</span></code>タグの中に実装したJSPの処理が実行される。</p>
<ul class="simple">
<li>Webリソースに定義されているアクセスポリシーとの連携例</li>
</ul>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;ul&gt;</span>
    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;sec:authorize</span> <span class="na">url=</span><span class="s">&quot;/admin/accounts&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;li&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;&lt;c:url value=&#39;/admin/accounts&#39; /&gt;&quot;</span><span class="nt">&gt;</span>Account Management<span class="nt">&lt;/a&gt;</span>
        <span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;/sec:authorize&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ボタンやリンクを出力する部分を<code class="docutils literal"><span class="pre">&lt;sec:authorize&gt;</span></code>タグで囲む。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;sec:authorize&gt;</span></code>タグの<code class="docutils literal"><span class="pre">url</span></code>属性にWebリソースへアクセスするためのURLを指定する。</div>
<div class="line">ここでは、「<code class="docutils literal"><span class="pre">/admin/accounts</span></code>というURLが割り振られているWebリソースにアクセス可能な場合は表示を許可する」というアクセスポリシーを定義しており、Webリソースに定義されているアクセスポリシーを直接意識する必要がない。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>HTTPメソッドによるポリシーの指定</strong></p>
<p class="last">Webリソースのアクセスポリシーの定義をする際に、HTTPメソッドによって異なるアクセスポリシーを指定している場合は、<code class="docutils literal"><span class="pre">&lt;sec:authorize&gt;</span></code>タグの<code class="docutils literal"><span class="pre">method</span></code>属性を指定して、連動させる定義を特定すること。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>表示制御に関する留意点</strong></p>
<p>ボタンやリンクなどの表示制御を行う場合は、必ずWebリソースに定義されているアクセスポリシーと連動させること。</p>
<p class="last">ボタンやリンクに対して直接アクセスポリシーの指定を行い、Webリソース自体にアクセスポリシーを定義していないと、
URLを直接してアクセスするような不正なアクセスを防ぐことができない。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id21">
<h4><a class="toc-backref" href="#id68">9.3.2.4.3. 認可処理の判定結果を変数に格納</a><a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">&lt;sec:authorize&gt;</span></code>タグを使って呼び出した認可処理の判定結果は、変数に格納して使いまわすことができる。</p>
<ul class="simple">
<li>JSPの実装例</li>
</ul>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:authorize</span> <span class="na">url=</span><span class="s">&quot;/admin/accounts&quot;</span>
               <span class="na">var=</span><span class="s">&quot;hasAccountsAuthority&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

<span class="nt">&lt;c:if</span> <span class="na">test=</span><span class="s">&quot;${hasAccountsAuthority}&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/c:if&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">var</span></code>属性に判定結果を格納するための変数名を指定する。</div>
<div class="line">アクセスが許可された場合は、変数に<code class="docutils literal"><span class="pre">true</span></code>が設定される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">変数の値を参照して表示処理を実装する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="authorizationerrorresponse">
<span id="id22"></span><h3><a class="toc-backref" href="#id69">9.3.2.5. 認可エラー時のレスポンス</a><a class="headerlink" href="#authorizationerrorresponse" title="Permalink to this headline">¶</a></h3>
<p>Spring Securityは、リソースへのアクセスを拒否した場合、以下のような流れでエラーをハンドリングしてレスポンスの制御を行う。</p>
<div class="figure" id="id39">
<a class="reference internal image-reference" href="../_images/AuthorizationAccessDeniedHandling.png"><img alt="../_images/AuthorizationAccessDeniedHandling.png" src="../_images/AuthorizationAccessDeniedHandling.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>認可エラーのハンドリングの仕組み</strong></span></p>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring Securityは、リソースやメソッドへのアクセスを拒否するために、<code class="docutils literal"><span class="pre">AccessDeniedException</span></code>を発生させる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ExceptionTranslationFilter</span></code>クラスは、<code class="docutils literal"><span class="pre">AccessDeniedException</span></code>をキャッチし、<code class="docutils literal"><span class="pre">AccessDeniedHandler</span></code>または<code class="docutils literal"><span class="pre">AuthenticationEntryPoint</span></code>インタフェースのメソッドを呼び出してエラー応答を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証済みのユーザーからのアクセスの場合は、<code class="docutils literal"><span class="pre">AccessDeniedHandler</span></code>インタフェースのメソッドを呼び出してエラー応答を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">未認証のユーザーからのアクセスの場合は、<code class="docutils literal"><span class="pre">AuthenticationEntryPoint</span></code>インタフェースのメソッドを呼び出してエラー応答を行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="accessdeniedhandler">
<h4><a class="toc-backref" href="#id70">9.3.2.5.1. AccessDeniedHandler</a><a class="headerlink" href="#accessdeniedhandler" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">AccessDeniedHandler</span></code>インタフェースは、認証済みのユーザーからのアクセスを拒否した際のエラー応答を行うためのインタフェースである。
Spring Securityは、<code class="docutils literal"><span class="pre">AccessDeniedHandler</span></code>インタフェースの実装クラスとして以下のクラスを提供している。</p>
<table border="1" class="colwidths-given docutils" id="id40">
<caption><span class="caption-text"><strong>Spring Securityが提供するAccessDeniedHandlerの実装クラス</strong></span><a class="headerlink" href="#id40" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">クラス名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AccessDeniedHandlerImpl</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">HTTPレスポンスコードに403(Forbidden)を設定し、指定されたエラーページに遷移する。</div>
<div class="line">エラーページの指定がない場合は、HTTPレスポンスコードに403(Forbidden)を設定してエラー応答(<code class="docutils literal"><span class="pre">HttpServletResponse#sendError</span></code>)を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">InvalidSessionAccessDeniedHandler</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">InvalidSessionStrategy</span></code>インタフェースの実装クラスに処理を委譲する。</div>
<div class="line">このクラスは、CSRF対策とセッション管理機能を使用してセッションタイムアウトを検知する設定を有効にした際に、CSRFトークンがセッションに存在しない(つまりセッションタイムアウトが発生している)場合に使用される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DelegatingAccessDeniedHandler</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AccessDeniedException</span></code>と<code class="docutils literal"><span class="pre">AccessDeniedHandler</span></code>インタフェースの実装クラスのマッピングを行い、発生した<code class="docutils literal"><span class="pre">AccessDeniedException</span></code>に対応する<code class="docutils literal"><span class="pre">AccessDeniedHandler</span></code>インタフェースの実装クラスに処理を委譲する。</div>
<div class="line"><code class="docutils literal"><span class="pre">InvalidSessionAccessDeniedHandler</span></code>はこの仕組みを利用して呼び出されている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RequestMatcherDelegatingAccessDeniedHandler</span></code></div>
</div>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">RequestMatcher</span></code>インタフェースの仕組みを利用して、指定されたリクエストのパターンに対応する<code class="docutils literal"><span class="pre">AccessDeniedHandler</span></code>インタフェースの実装クラスに処理を委譲する。</p>
<div class="last admonition note">
<p class="first admonition-title">Note</p>
<p><code class="docutils literal"><span class="pre">RequestMatcherDelegatingAccessDeniedHandler</span></code>の設定方法については、<a class="reference internal" href="LinkageWithBrowser.html#linkagewithbrowsereachrequestpattern"><span class="std std-ref">リクエストパターン毎のセキュリティヘッダの出力</span></a>の
<code class="docutils literal"><span class="pre">DelegatingRequestMatcherHeaderWriter</span></code>と同様にリクエストパターンの判定を行う<code class="docutils literal"><span class="pre">RequestMatcher</span></code>と処理を委譲する<code class="docutils literal"><span class="pre">AccessDeniedHandler</span></code>を設定すれば良い。</p>
<p class="last">なお、<code class="docutils literal"><span class="pre">&lt;sec:intercept-url&gt;</span></code>と<code class="docutils literal"><span class="pre">RequestMatcherDelegatingAccessDeniedHandler</span></code>がパスマッチングを行う間にはリクエストのパスが変わる可能性がある処理が挟まれないため、
Warning「指定したパスが意図した通りに認識されない問題」に記載されているような事象は発生しない。</p>
</div>
</td>
</tr>
</tbody>
</table>
<p>Spring Securityのデフォルトの設定では、エラーページの指定がない<code class="docutils literal"><span class="pre">AccessDeniedHandlerImpl</span></code>が使用される。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="authenticationentrypoint">
<h4><a class="toc-backref" href="#id71">9.3.2.5.2. AuthenticationEntryPoint</a><a class="headerlink" href="#authenticationentrypoint" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">AuthenticationEntryPoint</span></code>インタフェースは、未認証のユーザーからのアクセスを拒否した際のエラー応答を行うためのインタフェースである。
Spring Securityは、<code class="docutils literal"><span class="pre">AuthenticationEntryPoint</span></code>インタフェースの実装クラスとして以下のクラスを提供している。</p>
<table border="1" class="colwidths-given docutils" id="id41">
<caption><span class="caption-text"><strong>Spring Securityが提供する主なAuthenticationEntryPointの実装クラス</strong></span><a class="headerlink" href="#id41" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">クラス名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">LoginUrlAuthenticationEntryPoint</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フォーム認証用のログインフォームを表示する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">BasicAuthenticationEntryPoint</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Basic認証用のエラー応答を行う。</div>
<div class="line">具体的には、HTTPレスポンスコードに401(Unauthorized)を、レスポンスヘッダとしてBasic認証用の「<code class="docutils literal"><span class="pre">WWW-Authenticate</span></code>」ヘッダを設定してエラー応答(<code class="docutils literal"><span class="pre">HttpServletResponse#sendError</span></code>)を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DigestAuthenticationEntryPoint</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Digest認証用のエラー応答を行う。</div>
<div class="line">具体的には、HTTPレスポンスコードに401(Unauthorized)を、レスポンスヘッダとしてDigest認証用の「<code class="docutils literal"><span class="pre">WWW-Authenticate</span></code>」ヘッダを設定してエラー応答(<code class="docutils literal"><span class="pre">HttpServletResponse#sendError</span></code>)を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Http403ForbiddenEntryPoint</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">HTTPレスポンスコードに403(Forbidden)を設定してエラー応答(<code class="docutils literal"><span class="pre">HttpServletResponse#sendError</span></code>)を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">HttpStatusEntryPoint</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">任意のHTTPレスポンスコードを設定して正常応答(<code class="docutils literal"><span class="pre">HttpServletResponse#setStatus</span></code>)を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DelegatingAuthenticationEntryPoint</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RequestMatcher</span></code>インタフェースの仕組みを利用して、指定されたリクエストのパターンに対応する<code class="docutils literal"><span class="pre">AuthenticationEntryPoint</span></code>インタフェースの実装クラスに処理を委譲する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Spring Securityのデフォルトの設定では、認証方式に対応する<code class="docutils literal"><span class="pre">AuthenticationEntryPoint</span></code>インタフェースの実装クラスが使用される。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="springsecurityauthorizationonerror">
<span id="id23"></span><h4><a class="toc-backref" href="#id72">9.3.2.5.3. 認可エラー時の遷移先</a><a class="headerlink" href="#springsecurityauthorizationonerror" title="Permalink to this headline">¶</a></h4>
<p>Spring Securityのデフォルトの設定だと、認証済みのユーザーからのアクセスを拒否した際は、アプリケーションサーバのエラーページが表示される。
アプリケーションサーバーのエラーページを表示してしまうと、システムのセキュリティを低下させる要因になるため、適切なエラー画面を表示することを推奨する。
エラーページの指定は、以下のようなbean定義を行うことで可能である。</p>
<ul class="simple">
<li>spring-security.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
    <span class="nt">&lt;sec:access-denied-handler</span>
        <span class="na">error-page=</span><span class="s">&quot;/WEB-INF/views/common/error/accessDeniedError.jsp&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;sec:access-denied-handler&gt;</span></code>タグの<code class="docutils literal"><span class="pre">error-page</span></code>属性に認可エラー用のエラーページを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>サーブレットコンテナのエラーページ機能の利用</strong></p>
<p>認可エラーのエラーページは、サーブレットコンテナのエラーページ機能を使って指定することもできる。</p>
<p>サーブレットコンテナのエラーページ機能を使う場合は、<code class="docutils literal"><span class="pre">web.xml</span></code>の<code class="docutils literal"><span class="pre">&lt;error-page&gt;</span></code>タグを使用してエラーページを指定する。</p>
<blockquote class="last">
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;error-page&gt;</span>
    <span class="nt">&lt;error-code&gt;</span>403<span class="nt">&lt;/error-code&gt;</span>
    <span class="nt">&lt;location&gt;</span>/WEB-INF/views/common/error/accessDeniedError.jsp<span class="nt">&lt;/location&gt;</span>
<span class="nt">&lt;/error-page&gt;</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-extend">
<h2><a class="toc-backref" href="#id73">9.3.3. How to extend</a><a class="headerlink" href="#how-to-extend" title="Permalink to this headline">¶</a></h2>
<p>本節では、Spring Securityが用意しているカスタマイズポイントや拡張方法について説明する。</p>
<p>Spring Securityは、多くのカスタマイズポイントを提供しているため、すべてのカスタマイズポイントは紹介しない。
本節では代表的なカスタマイズポイントに絞って説明を行う。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="id24">
<h3><a class="toc-backref" href="#id74">9.3.3.1. 認可エラー時のレスポンス (認証済みユーザー編)</a><a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h3>
<p>ここでは、認証済みユーザーからのアクセスを拒否した際の動作をカスタマイズする方法を説明する。</p>
<div class="section" id="springsecurityauthorizationaccessdeniedhandler">
<span id="id25"></span><h4><a class="toc-backref" href="#id75">9.3.3.1.1. AccessDeniedHandlerの適用</a><a class="headerlink" href="#springsecurityauthorizationaccessdeniedhandler" title="Permalink to this headline">¶</a></h4>
<p>Spring Securityが提供しているデフォルトの動作をカスタマイズする仕組みだけでは要件をみたせない場合は、<code class="docutils literal"><span class="pre">AccessDeniedHandler</span></code>インタフェースの実装クラスを直接適用することができる。</p>
<p>例えば、Ajaxのリクエスト(REST APIなど)で認可エラーが発生した場合は、エラーページ(HTML)ではなくJSON形式でエラー情報を応答することが求められるケースがある。
そのような場合は、<code class="docutils literal"><span class="pre">AccessDeniedHandler</span></code>インタフェースの実装クラスを作成してSpring Securityに適用することで実現することができる。</p>
<ul class="simple">
<li>AccessDeniedHandlerインタフェースの実装クラスの作成例</li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JsonDelegatingAccessDeniedHandler</span> <span class="kd">implements</span> <span class="n">AccessDeniedHandler</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">RequestMatcher</span> <span class="n">jsonRequestMatcher</span><span class="p">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">AccessDeniedHandler</span> <span class="n">delegateHandler</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">JsonDelegatingAccessDeniedHandler</span><span class="p">(</span>
            <span class="n">RequestMatcher</span> <span class="n">jsonRequestMatcher</span><span class="p">,</span> <span class="n">AccessDeniedHandler</span> <span class="n">delegateHandler</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">jsonRequestMatcher</span> <span class="o">=</span> <span class="n">jsonRequestMatcher</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="na">delegateHandler</span> <span class="o">=</span> <span class="n">delegateHandler</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="p">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="p">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="p">,</span>
                       <span class="n">AccessDeniedException</span> <span class="n">accessDeniedException</span><span class="p">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span><span class="p">,</span> <span class="n">ServletException</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">jsonRequestMatcher</span><span class="p">.</span><span class="na">matches</span><span class="p">(</span><span class="n">request</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// response error information of JSON format</span>
            <span class="n">response</span><span class="p">.</span><span class="na">setStatus</span><span class="p">(</span><span class="n">HttpServletResponse</span><span class="p">.</span><span class="na">SC_FORBIDDEN</span><span class="p">);</span>
            <span class="c1">// omitted</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// response error page of HTML format</span>
            <span class="n">delegateHandler</span><span class="p">.</span><span class="na">handle</span><span class="p">(</span>
                    <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">accessDeniedException</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li>spring-security.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;accessDeniedHandler&quot;</span>
      <span class="na">class=</span><span class="s">&quot;com.example.web.security.JsonDelegatingAccessDeniedHandler&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.util.matcher.AntPathRequestMatcher&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;constructor-arg</span> <span class="na">value=</span><span class="s">&quot;/api/**&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;constructor-arg&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.access.AccessDeniedHandlerImpl&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;errorPage&quot;</span>
                      <span class="na">value=</span><span class="s">&quot;/WEB-INF/views/common/error/accessDeniedError.jsp&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;sec:http&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
    <span class="nt">&lt;sec:access-denied-handler</span> <span class="na">ref=</span><span class="s">&quot;accessDeniedHandler&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>(1)</td>
<td><code class="docutils literal"><span class="pre">AccessDeniedHandler</span></code>インタフェースの実装クラスをbean定義してDIコンテナに登録する。</td>
</tr>
<tr class="row-odd"><td>(2)</td>
<td><code class="docutils literal"><span class="pre">&lt;sec:access-denied-handler&gt;</span></code>タグの<code class="docutils literal"><span class="pre">ref</span></code>属性に<code class="docutils literal"><span class="pre">AccessDeniedHandler</span></code>のbeanを指定する。</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id26">
<h3><a class="toc-backref" href="#id76">9.3.3.2. 認可エラー時のレスポンス (未認証ユーザー編)</a><a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h3>
<p>ここでは、未認証ユーザーからのアクセスを拒否した際の動作をカスタマイズする方法を説明する。</p>
<div class="section" id="id27">
<h4><a class="toc-backref" href="#id77">9.3.3.2.1. リクエスト毎にAuthenticationEntryPointを適用</a><a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h4>
<p>認証済みユーザーと同様に、Ajaxのリクエスト(REST APIなど)で認可エラーが発生した場合は、ログインページ(HTML)ではなくJSON形式でエラー情報を応答することが求められるケースがある。
そのような場合は、リクエストのパターン毎に<code class="docutils literal"><span class="pre">AuthenticationEntryPoint</span></code>インタフェースの実装クラスをSpring Securityに適用することで実現することができる。</p>
<ul class="simple">
<li>spring-security.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;authenticationEntryPoint&quot;</span>
      <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.DelegatingAuthenticationEntryPoint&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg&gt;</span>
        <span class="nt">&lt;map&gt;</span>
            <span class="nt">&lt;entry&gt;</span>
                <span class="nt">&lt;key&gt;</span>
                    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.util.matcher.AntPathRequestMatcher&quot;</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;constructor-arg</span> <span class="na">value=</span><span class="s">&quot;/api/**&quot;</span><span class="nt">/&gt;</span>
                    <span class="nt">&lt;/bean&gt;</span>
                <span class="nt">&lt;/key&gt;</span>
                <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;com.example.web.security.JsonAuthenticationEntryPoint&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/entry&gt;</span>
        <span class="nt">&lt;/map&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultEntryPoint&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;constructor-arg</span> <span class="na">value=</span><span class="s">&quot;/login&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;sec:http</span> <span class="na">entry-point-ref=</span><span class="s">&quot;authenticationEntryPoint&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthenticationEntryPoint</span></code>インタフェースの実装クラスをbean定義してDIコンテナに登録する。</div>
<div class="line">ここでは、Spring Securityが提供している<code class="docutils literal"><span class="pre">DelegatingAuthenticationEntryPoint</span></code>クラスを利用して、リクエストのパターン毎に<code class="docutils literal"><span class="pre">AuthenticationEntryPoint</span></code>インタフェースの実装クラスを適用している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;sec:http&gt;</span></code>タグの<code class="docutils literal"><span class="pre">entry-point-ref</span></code>属性に<code class="docutils literal"><span class="pre">AuthenticationEntryPoint</span></code>のbeanを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>デフォルトで適用されるAuthenticationEntryPoint</strong></p>
<p class="last">リクエストに対応する<code class="docutils literal"><span class="pre">AuthenticationEntryPoint</span></code>インタフェースの実装クラスの指定がない場合は、Spring Securityがデフォルトで定義する<code class="docutils literal"><span class="pre">AuthenticationEntryPoint</span></code>インタフェースの実装クラスが使用される仕組みになっている。
認証方式としてフォーム認証を使用する場合は、<code class="docutils literal"><span class="pre">LoginUrlAuthenticationEntryPoint</span></code>クラスが使用されログインフォームが表示される。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id28">
<h3><a class="toc-backref" href="#id78">9.3.3.3. ロールの階層化</a><a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h3>
<p>認可処理では、ロールに階層関係を設けることができる。</p>
<p>上位に指定したロールは、下位のロールにアクセスが許可されているリソースにもアクセスすることができる。
ロールの関係が複雑な場合は、階層関係も設けることも検討されたい。</p>
<p>例えば、「ROLE_ADMIN」が上位ロール、「ROLE_USER」が下位ロールという階層関係を設けた場合、
下記のようアクセスポリシーを設定すると、「ROLE_ADMIN」権限を持つユーザーは、
<code class="docutils literal"><span class="pre">/user</span></code>配下のパス(「ROLE_USER」権限を持つユーザーがアクセスできるパス)にアクセスすることができる。</p>
<ul class="simple">
<li>spring-security.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/user/**&quot;</span> <span class="na">access=</span><span class="s">&quot;hasAnyRole(&#39;USER&#39;)&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="id29">
<h4><a class="toc-backref" href="#id79">9.3.3.3.1. 階層関係の設定</a><a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h4>
<p>ロールの階層関係は、<code class="docutils literal"><span class="pre">org.springframework.security.access.hierarchicalroles.RoleHierarchy</span></code>インタフェースの実装クラスで解決する。</p>
<ul class="simple">
<li>spring-security.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;roleHierarchy&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.access.hierarchicalroles.RoleHierarchyImpl&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;hierarchy&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;value&gt;</span>
            ROLE_ADMIN &gt; ROLE_STAFF
            ROLE_STAFF &gt; ROLE_USER
        <span class="nt">&lt;/value&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.access.hierarchicalroles.RoleHierarchyImpl</span></code> クラスを指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">RoleHierarchyImpl</span></code>は、Spring Securityが提供するデフォルトの実装クラスである。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">hierarchy</span></code>プロパティに階層関係を定義する。</div>
<div class="line"><br /></div>
<div class="line">書式: [上位ロール] &gt; [下位ロール]</div>
<div class="line"><br /></div>
<div class="line">上記例では、</div>
<div class="line">STAFFは、USERに認可されたリソースにもアクセス可能である。</div>
<div class="line">ADMINは、USERとSTAFFに認可されたリソースにもアクセス可能である。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id30">
<h4><a class="toc-backref" href="#id80">9.3.3.3.2. Webリソースの認可処理への適用</a><a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h4>
<p>ロールの階層化を、WebリソースとJSPの画面項目に対する認可処理に適用する方法を説明する。</p>
<ul class="simple">
<li>spring-security.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;webExpressionHandler&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.access.expression.DefaultWebSecurityExpressionHandler&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;roleHierarchy&quot;</span> <span class="na">ref=</span><span class="s">&quot;roleHierarchy&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;sec:http&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
    <span class="nt">&lt;sec:expression-handler</span> <span class="na">ref=</span><span class="s">&quot;webExpressionHandler&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.web.access.expression.DefaultWebSecurityExpressionHandler</span></code>のBeanを定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">roleHierarchy</span></code>プロパティに<code class="docutils literal"><span class="pre">RoleHierarchy</span></code>インタフェースの実装クラスのBeanを指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;sec:expression-handler&gt;</span></code>タグの<code class="docutils literal"><span class="pre">ref</span></code>属性に、<code class="docutils literal"><span class="pre">org.springframework.security.access.expression.SecurityExpressionHandler</span></code>インタフェースの実装クラスのBeanを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id31">
<h4><a class="toc-backref" href="#id81">9.3.3.3.3. メソッドの認可処理への適用</a><a class="headerlink" href="#id31" title="Permalink to this headline">¶</a></h4>
<p>ロールの階層化を、Javaメソッドに対する認可処理に適用する方法を説明する。</p>
<ul class="simple">
<li>spring-security.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;methodExpressionHandler&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.access.expression.method.DefaultMethodSecurityExpressionHandler&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;roleHierarchy&quot;</span> <span class="na">ref=</span><span class="s">&quot;roleHierarchy&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;sec:global-method-security</span> <span class="na">pre-post-annotations=</span><span class="s">&quot;enabled&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;sec:expression-handler</span> <span class="na">ref=</span><span class="s">&quot;methodExpressionHandler&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/sec:global-method-security&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.access.expression.method.DefaultMethodSecurityExpressionHandler</span></code>のBeanを定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">roleHierarchy</span></code>プロパティに<code class="docutils literal"><span class="pre">RoleHierarchy</span></code>インタフェースの実装クラスのBeanを指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;sec:expression-handler&gt;</span></code>タグの<code class="docutils literal"><span class="pre">ref</span></code>属性に、<code class="docutils literal"><span class="pre">org.springframework.security.access.expression.SecurityExpressionHandler</span></code>インタフェースの実装クラスのBeanを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="SessionManagement.html" title="9.4. セッション管理"
             >next</a> |</li>
        <li class="right" >
          <a href="Authentication.html" title="9.2. 認証"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.7.0.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >9. セキュリティ対策</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer">
      © Copyright 2013, NTT DATA Corporation. © Copyright 2013, NTT Corporation.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3.Theme is <a href="http://github.com/vimalkvn/solar-theme">Solar</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>
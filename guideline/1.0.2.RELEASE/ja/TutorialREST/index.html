<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>7.1. チュートリアル(Todoアプリケーション REST編) &mdash; TERASOLUNA Global Framework Development Guideline 1.0.2.RELEASE documentation</title>
    
    <link rel="stylesheet" href="../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0.2.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="TERASOLUNA Global Framework Development Guideline 1.0.2.RELEASE documentation" href="../index.html" />
    <link rel="up" title="7. Appendix" href="../Appendix/index.html" />
    <link rel="next" title="7.2. Blankプロジェクトから新規プロジェクト作成" href="../Appendix/CreateProjectFromBlank.html" />
    <link rel="prev" title="7. Appendix" href="../Appendix/index.html" /><script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../Appendix/CreateProjectFromBlank.html" title="7.2. Blankプロジェクトから新規プロジェクト作成"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../Appendix/index.html" title="7. Appendix"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">TERASOLUNA Global Framework Development Guideline 1.0.2.RELEASE documentation</a> &raquo;</li>
          <li><a href="../Appendix/index.html" accesskey="U">7. Appendix</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">7.1. チュートリアル(Todoアプリケーション REST編)</a><ul>
<li><a class="reference internal" href="#id2">7.1.1. はじめに</a><ul>
<li><a class="reference internal" href="#id3">7.1.1.1. このチュートリアルで学ぶこと</a></li>
<li><a class="reference internal" href="#id4">7.1.1.2. 対象読者</a></li>
<li><a class="reference internal" href="#id5">7.1.1.3. 検証環境</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6">7.1.2. 環境構築</a><ul>
<li><a class="reference internal" href="#id7">7.1.2.1. Dev HTTP Clientのインストール</a></li>
<li><a class="reference internal" href="#id8">7.1.2.2. プロジェクト作成</a></li>
<li><a class="reference internal" href="#id9">7.1.2.3. プロジェクトのインポート</a></li>
<li><a class="reference internal" href="#id10">7.1.2.4. ドメイン層のファイルをコピー</a></li>
<li><a class="reference internal" href="#id11">7.1.2.5. テーブル定義の追加</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rest-api">7.1.3. REST APIの作成</a><ul>
<li><a class="reference internal" href="#api">7.1.3.1. API仕様</a><ul>
<li><a class="reference internal" href="#get-todos">7.1.3.1.1. GET Todos</a></li>
<li><a class="reference internal" href="#post-todos">7.1.3.1.2. POST Todos</a></li>
<li><a class="reference internal" href="#get-todo">7.1.3.1.3. GET Todo</a></li>
<li><a class="reference internal" href="#put-todo">7.1.3.1.4. PUT Todo</a></li>
<li><a class="reference internal" href="#delete-todo">7.1.3.1.5. DELETE Todo</a></li>
<li><a class="reference internal" href="#id12">7.1.3.1.6. エラー応答</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rest-apidispatcherservlet">7.1.3.2. REST API用のDispatcherServletを用意</a><ul>
<li><a class="reference internal" href="#web-xml">7.1.3.2.1. web.xmlの修正</a></li>
<li><a class="reference internal" href="#spring-mvc-rest-xml">7.1.3.2.2. spring-mvc-rest.xmlの作成</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rest-apispring-security">7.1.3.3. REST API用のSpring Securityの定義追加</a></li>
<li><a class="reference internal" href="#id13">7.1.3.4. REST API用パッケージの作成</a></li>
<li><a class="reference internal" href="#resource">7.1.3.5. Resourceクラスの作成</a></li>
<li><a class="reference internal" href="#controller">7.1.3.6. Controllerクラスの作成</a><ul>
<li><a class="reference internal" href="#id14">7.1.3.6.1. GET Todosの実装</a></li>
<li><a class="reference internal" href="#id15">7.1.3.6.2. POST Todosの実装</a></li>
<li><a class="reference internal" href="#id16">7.1.3.6.3. GET Todoの実装</a></li>
<li><a class="reference internal" href="#id17">7.1.3.6.4. PUT Todoの実装</a></li>
<li><a class="reference internal" href="#id18">7.1.3.6.5. DELETE Todoの実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id19">7.1.3.7. 例外ハンドリングの実装</a><ul>
<li><a class="reference internal" href="#id20">7.1.3.7.1. ドメイン層の実装を変更</a></li>
<li><a class="reference internal" href="#id21">7.1.3.7.2. エラーメッセージの定義</a></li>
<li><a class="reference internal" href="#id22">7.1.3.7.3. エラーハンドリング用のクラスを格納するパッケージの作成</a></li>
<li><a class="reference internal" href="#id23">7.1.3.7.4. REST APIのエラーハンドリングを行うクラスの作成</a></li>
<li><a class="reference internal" href="#rest-apijavabean">7.1.3.7.5. REST APIのエラー情報を保持するJavaBeanの作成</a></li>
<li><a class="reference internal" href="#httpbody">7.1.3.7.6. HTTPレスポンスBODYにエラー情報を出力するための実装</a></li>
<li><a class="reference internal" href="#id24">7.1.3.7.7. 入力エラーのエラーハンドリングの実装</a></li>
<li><a class="reference internal" href="#id25">7.1.3.7.8. 業務例外のエラーハンドリングの実装</a></li>
<li><a class="reference internal" href="#id26">7.1.3.7.9. リソース未検出例外のエラーハンドリングの実装</a></li>
<li><a class="reference internal" href="#id27">7.1.3.7.10. システム例外のエラーハンドリングの実装</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id28">7.1.4. おわりに</a></li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="../Appendix/index.html"
                        title="previous chapter">7. Appendix</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../Appendix/CreateProjectFromBlank.html"
                        title="next chapter">7.2. Blankプロジェクトから新規プロジェクト作成</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/TutorialREST/index.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="todo-rest">
<h1>7.1. チュートリアル(Todoアプリケーション REST編)<a class="headerlink" href="#todo-rest" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="id1">
<p class="topic-title first">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#id2" id="id29">はじめに</a><ul>
<li><a class="reference internal" href="#id3" id="id30">このチュートリアルで学ぶこと</a></li>
<li><a class="reference internal" href="#id4" id="id31">対象読者</a></li>
<li><a class="reference internal" href="#id5" id="id32">検証環境</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6" id="id33">環境構築</a><ul>
<li><a class="reference internal" href="#id7" id="id34">Dev HTTP Clientのインストール</a></li>
<li><a class="reference internal" href="#id8" id="id35">プロジェクト作成</a></li>
<li><a class="reference internal" href="#id9" id="id36">プロジェクトのインポート</a></li>
<li><a class="reference internal" href="#id10" id="id37">ドメイン層のファイルをコピー</a></li>
<li><a class="reference internal" href="#id11" id="id38">テーブル定義の追加</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rest-api" id="id39">REST APIの作成</a><ul>
<li><a class="reference internal" href="#api" id="id40">API仕様</a><ul>
<li><a class="reference internal" href="#get-todos" id="id41">GET Todos</a></li>
<li><a class="reference internal" href="#post-todos" id="id42">POST Todos</a></li>
<li><a class="reference internal" href="#get-todo" id="id43">GET Todo</a></li>
<li><a class="reference internal" href="#put-todo" id="id44">PUT Todo</a></li>
<li><a class="reference internal" href="#delete-todo" id="id45">DELETE Todo</a></li>
<li><a class="reference internal" href="#id12" id="id46">エラー応答</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rest-apidispatcherservlet" id="id47">REST API用のDispatcherServletを用意</a><ul>
<li><a class="reference internal" href="#web-xml" id="id48">web.xmlの修正</a></li>
<li><a class="reference internal" href="#spring-mvc-rest-xml" id="id49">spring-mvc-rest.xmlの作成</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rest-apispring-security" id="id50">REST API用のSpring Securityの定義追加</a></li>
<li><a class="reference internal" href="#id13" id="id51">REST API用パッケージの作成</a></li>
<li><a class="reference internal" href="#resource" id="id52">Resourceクラスの作成</a></li>
<li><a class="reference internal" href="#controller" id="id53">Controllerクラスの作成</a><ul>
<li><a class="reference internal" href="#id14" id="id54">GET Todosの実装</a></li>
<li><a class="reference internal" href="#id15" id="id55">POST Todosの実装</a></li>
<li><a class="reference internal" href="#id16" id="id56">GET Todoの実装</a></li>
<li><a class="reference internal" href="#id17" id="id57">PUT Todoの実装</a></li>
<li><a class="reference internal" href="#id18" id="id58">DELETE Todoの実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id19" id="id59">例外ハンドリングの実装</a><ul>
<li><a class="reference internal" href="#id20" id="id60">ドメイン層の実装を変更</a></li>
<li><a class="reference internal" href="#id21" id="id61">エラーメッセージの定義</a></li>
<li><a class="reference internal" href="#id22" id="id62">エラーハンドリング用のクラスを格納するパッケージの作成</a></li>
<li><a class="reference internal" href="#id23" id="id63">REST APIのエラーハンドリングを行うクラスの作成</a></li>
<li><a class="reference internal" href="#rest-apijavabean" id="id64">REST APIのエラー情報を保持するJavaBeanの作成</a></li>
<li><a class="reference internal" href="#httpbody" id="id65">HTTPレスポンスBODYにエラー情報を出力するための実装</a></li>
<li><a class="reference internal" href="#id24" id="id66">入力エラーのエラーハンドリングの実装</a></li>
<li><a class="reference internal" href="#id25" id="id67">業務例外のエラーハンドリングの実装</a></li>
<li><a class="reference internal" href="#id26" id="id68">リソース未検出例外のエラーハンドリングの実装</a></li>
<li><a class="reference internal" href="#id27" id="id69">システム例外のエラーハンドリングの実装</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id28" id="id70">おわりに</a></li>
</ul>
</div>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id29">7.1.1. はじめに</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id30">7.1.1.1. このチュートリアルで学ぶこと</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>TERASOLUNA Global Frameworkによる基本的なRESTful Webサービスの構築方法</li>
</ul>
</div>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id31">7.1.1.2. 対象読者</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>﻿<a class="reference internal" href="../TutorialTodo/index.html"><em>チュートリアル(Todoアプリケーション)</em></a>を実施している。</li>
</ul>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id32">7.1.1.3. 検証環境</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>このチュートリアルは以下の環境で動作確認している。他の環境で実施する際は本書をベースに適宜読み替えて設定していくこと。</p>
<p>ただし、REST Clientとして、Google Chromeの拡張機能である「<a class="reference external" href="https://chrome.google.com/webstore/detail/dev-http-client/aejoelaoggembcahagimdiliamlcdmfm">Dev HTTP Client</a>」を使用するため、
Web BrowserはGoogle Chromeを使用する必要がある。</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">種別</th>
<th class="head">名前</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>OS</td>
<td>Windows7 64bit</td>
</tr>
<tr class="row-odd"><td>JVM</td>
<td>Java 1.7</td>
</tr>
<tr class="row-even"><td>IDE</td>
<td>Spring Tool Suite Version: 3.4.0.RELEASE, Build Id: 201310051614 (以降「STS」と呼ぶ)</td>
</tr>
<tr class="row-odd"><td>Build</td>
<td>Maven 3.0.4</td>
</tr>
<tr class="row-even"><td>Application Server</td>
<td>VMWare vFabric tc Server Developer Edition v2.9 (以降「ts Server」と呼ぶ)</td>
</tr>
<tr class="row-odd"><td>Web Browser</td>
<td>Google Chrome 33.0.1750.154 m, Language is English(United States)</td>
</tr>
<tr class="row-even"><td>REST Client</td>
<td>Dev HTTP Client 0.6.9.16</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div>
<div class="section" id="id6">
<h2><a class="toc-backref" href="#id33">7.1.2. 環境構築</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<p>Java, STS, Maven, Google Chromeについては、﻿<a class="reference internal" href="../TutorialTodo/index.html"><em>チュートリアル(Todoアプリケーション)</em></a>を実施する事でインストール済みの状態である事を前提とする。</p>
<div class="section" id="id7">
<h3><a class="toc-backref" href="#id34">7.1.2.1. Dev HTTP Clientのインストール</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>まず、RESTクライアントしてChromeの拡張機能である「Dev HTTP Client」をインストールする。</p>
<p>Chromeの「Tools」→「Extensions」を選択する。</p>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/install-dev-http-client1.png"><img alt="../_images/install-dev-http-client1.png" src="../_images/install-dev-http-client1.png" style="width: 80%;" /></a>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>「Get more extensions」のリンクを押下する。</p>
<blockquote>
<div><div class="figure">
<img alt="../_images/install-dev-http-client2.png" src="../_images/install-dev-http-client2.png" />
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>検索フォームに「dev http clinet」を入力して検索する。</p>
<blockquote>
<div><div class="figure">
<img alt="../_images/install-dev-http-client3.png" src="../_images/install-dev-http-client3.png" />
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Dev HTTP Clientの「+ FREE」ボタンを押下する。</p>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/install-dev-http-client4.png"><img alt="../_images/install-dev-http-client4.png" src="../_images/install-dev-http-client4.png" style="width: 80%;" /></a>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>「Add」ボタンを押下する。</p>
<blockquote>
<div><div class="figure">
<img alt="../_images/install-dev-http-client5.png" src="../_images/install-dev-http-client5.png" />
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Chromeのアプリケーション一覧を開く(ブラウザのアドレスバーに「chrome://apps/」を指定して開く)と、DHC(Dev HTTP Client)が追加されている。</p>
<blockquote>
<div><div class="figure">
<img alt="../_images/install-dev-http-client6.png" src="../_images/install-dev-http-client6.png" />
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">DHC(Dev HTTP Client)をクリックする。</div>
<div class="line">以下の画面が表示されれば、インストール完了となる。</div>
<div class="line">この画面は、ブラウザのアドレスバーに「chrome-extension://aejoelaoggembcahagimdiliamlcdmfm/HttpClient.html」を入力する事で開く事もできる。</div>
</div>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/install-dev-http-client7.png"><img alt="../_images/install-dev-http-client7.png" src="../_images/install-dev-http-client7.png" style="width: 80%;" /></a>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id8">
<h3><a class="toc-backref" href="#id35">7.1.2.2. プロジェクト作成</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">チュートリアル用のプロジェクトを作成する。</div>
<div class="line">ドメイン層は<a class="reference internal" href="../TutorialTodo/index.html"><em>チュートリアル(Todoアプリケーション)</em></a>で作成したTodoアプリケーションのものを利用するが、今回はプロジェクトの雛形をBlankプロジェクトから生成する。</div>
</div>
<p>以下のコマンドを実行し、MyBatis2版のMavenプロジェクトを作成する。</p>
<blockquote>
<div><div class="highlight-console"><div class="highlight"><pre><span class="go">mvn archetype:generate -B^</span>
<span class="go"> -DarchetypeCatalog=http://repo.terasoluna.org/nexus/content/repositories/terasoluna-gfw-releases^</span>
<span class="go"> -DarchetypeGroupId=org.terasoluna.gfw.blank^</span>
<span class="go"> -DarchetypeArtifactId=terasoluna-gfw-web-blank-mybatis2-archetype^</span>
<span class="go"> -DarchetypeVersion=1.0.1.RELEASE^</span>
<span class="go"> -DgroupId=todo^</span>
<span class="go"> -DartifactId=todo-api^</span>
<span class="go"> -Dversion=1.0-SNAPSHOT</span>
</pre></div>
</div>
</div></blockquote>
<p>コンソール上に以下のようなログが表示されれば、ブランクプロジェクトの作成は成功となる。</p>
<blockquote>
<div><div class="highlight-console"><div class="highlight"><pre><span class="go">C:\workspace&gt;mvn archetype:generate -B^</span>
<span class="go">More?  -DarchetypeCatalog=http://repo.terasoluna.org/nexus/content/repositories/terasoluna-gfw-releases^</span>
<span class="go">More?  -DarchetypeGroupId=org.terasoluna.gfw.blank^</span>
<span class="go">More?  -DarchetypeArtifactId=terasoluna-gfw-web-blank-mybatis2-archetype^</span>
<span class="go">More?  -DarchetypeVersion=1.0.1.RELEASE^</span>
<span class="go">More?  -DgroupId=todo^</span>
<span class="go">More?  -DartifactId=todo-api^</span>
<span class="go">More?  -Dversion=1.0-SNAPSHOT</span>
<span class="go">[INFO] Scanning for projects...</span>
<span class="go">[INFO]</span>
<span class="go">[INFO] ------------------------------------------------------------------------</span>
<span class="go">[INFO] Building Maven Stub Project (No POM) 1</span>
<span class="go">[INFO] ------------------------------------------------------------------------</span>
<span class="go">[INFO]</span>
<span class="go">[INFO] &gt;&gt;&gt; maven-archetype-plugin:2.2:generate (default-cli) @ standalone-pom &gt;&gt;&gt;</span>
<span class="go">[INFO]</span>
<span class="go">[INFO] &lt;&lt;&lt; maven-archetype-plugin:2.2:generate (default-cli) @ standalone-pom &lt;&lt;&lt;</span>
<span class="go">[INFO]</span>
<span class="go">[INFO] --- maven-archetype-plugin:2.2:generate (default-cli) @ standalone-pom ---</span>
<span class="go">[INFO] Generating project in Batch mode</span>
<span class="go">[INFO] Archetype repository missing. Using the one from [org.terasoluna.gfw.blank:terasoluna-gfw-web-blank-mybatis2-archetype:1.0.0.RELEASE -&gt; http://repo.terasoluna.org/nexus/content/repositories/terasoluna-gfw-releases] found in catalog http://repo.terasoluna.org/nexus/content/repositories/terasoluna-gfw-releases</span>
<span class="go">[INFO] ----------------------------------------------------------------------------</span>
<span class="go">[INFO] Using following parameters for creating project from Archetype: terasoluna-gfw-web-blank-mybatis2-archetype:1.0.1.RELEASE</span>
<span class="go">[INFO] ----------------------------------------------------------------------------</span>
<span class="go">[INFO] Parameter: groupId, Value: todo</span>
<span class="go">[INFO] Parameter: artifactId, Value: todo-api</span>
<span class="go">[INFO] Parameter: version, Value: 1.0-SNAPSHOT</span>
<span class="go">[INFO] Parameter: package, Value: todo</span>
<span class="go">[INFO] Parameter: packageInPathFormat, Value: todo</span>
<span class="go">[INFO] Parameter: package, Value: todo</span>
<span class="go">[INFO] Parameter: version, Value: 1.0-SNAPSHOT</span>
<span class="go">[INFO] Parameter: groupId, Value: todo</span>
<span class="go">[INFO] Parameter: artifactId, Value: todo-api</span>
<span class="go">[INFO] project created from Archetype in dir: C:\workspace\todo-api</span>
<span class="go">[INFO] ------------------------------------------------------------------------</span>
<span class="go">[INFO] BUILD SUCCESS</span>
<span class="go">[INFO] ------------------------------------------------------------------------</span>
<span class="go">[INFO] Total time: 2.287s</span>
<span class="go">[INFO] Finished at: Fri Aug 22 20:20:55 JST 2014</span>
<span class="go">[INFO] Final Memory: 11M/231M</span>
<span class="go">[INFO] ------------------------------------------------------------------------</span>
<span class="go">C:\workspace&gt;</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="id9">
<h3><a class="toc-backref" href="#id36">7.1.2.3. プロジェクトのインポート</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>作成したMavenプロジェクトをSTSのworkspaceにインポートする。</p>
<p>STSで「File」→「Import」→「Maven」→「Existing Maven Projects」を選択して「Next &gt;」をクリックする。</p>
<p>先ほど作成した「todo-api」フォルダを選択し、「Finish」をクリックする。</p>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/import-maven-project.png"><img alt="../_images/import-maven-project.png" src="../_images/import-maven-project.png" style="width: 90%;" /></a>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>「Pacakge Presentaion」は、以下のように「Hierarchical」に変更することを推奨する。</p>
<p>「Package Explorer」→「View Menu」→「Pacakge Presentaion」を選択して「Hierarchical」をクリックする。</p>
<blockquote class="last">
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/package-presentation-hierarchical.png"><img alt="../_images/package-presentation-hierarchical.png" src="../_images/package-presentation-hierarchical.png" style="width: 70%;" /></a>
</div>
</div></blockquote>
</div>
</div></blockquote>
</div>
<div class="section" id="id10">
<h3><a class="toc-backref" href="#id37">7.1.2.4. ドメイン層のファイルをコピー</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>﻿<a class="reference internal" href="../TutorialTodo/index.html"><em>チュートリアル(Todoアプリケーション)</em></a>で作成したクラスのうち、</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">todo.domain.model.Todo</span></tt></li>
<li><tt class="docutils literal"><span class="pre">todo.domain.repository.todo.TodoRepository</span></tt></li>
<li><tt class="docutils literal"><span class="pre">todo.domain.repository.todo.TodoRepositoryImpl</span></tt>(MyBatis2版)</li>
<li><tt class="docutils literal"><span class="pre">todo.domain.serivce.todo.TodoService</span></tt></li>
<li><tt class="docutils literal"><span class="pre">todo.domain.serivce.todo.TodoServiceImpl</span></tt>(インフラストラクチャ層の変更反映版)</li>
</ul>
<p>と設定ファイル</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">src/main/resources/META-INF/mybatis/sql/todo-sqlmap.xml</span></tt></li>
</ul>
<p>を、STSにインポートしたプロジェクトにコピーする。</p>
<p>コピー後のSTSのworkspaceは以下のようになる。</p>
<blockquote>
<div><div class="figure">
<img alt="../_images/after-cp-domain-layer.png" src="../_images/after-cp-domain-layer.png" />
</div>
</div></blockquote>
</div>
<div class="section" id="id11">
<h3><a class="toc-backref" href="#id38">7.1.2.5. テーブル定義の追加</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<p>﻿﻿todoテーブルを生成するためのDDLを追加する。</p>
<p><a class="reference internal" href="../TutorialTodo/index.html"><em>チュートリアル(Todoアプリケーション)</em></a>で作成した、<tt class="file docutils literal"><span class="pre">src/main/resources/META-INF/spring/todo-infra.properties</span></tt>の<tt class="docutils literal"><span class="pre">database.url</span></tt>に設定されているテーブル定義の設定内容を、
今回作成した<tt class="file docutils literal"><span class="pre">src/main/resources/META-INF/spring/todo-api-infra.properties</span></tt>の<tt class="docutils literal"><span class="pre">database.url</span></tt>にコピーする。</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">src/main/resources/META-INF/spring/todo-api-infra.properties</span></tt></li>
</ul>
<blockquote>
<div><p>INITパラメータにテーブルを作成するDDLを指定する事で、アプリケーションサーバ起動時にH2のインメモリデータベースにtodoテーブルが作成される。</p>
<div class="highlight-properties"><div class="highlight"><pre><span class="na">database</span><span class="o">=</span><span class="s">H2</span>
<span class="hll"><span class="na">database.url</span><span class="o">=</span><span class="s">jdbc:h2:mem:todo-api;DB_CLOSE_DELAY=-1;INIT=create table if not exists todo(todo_id varchar(36) primary key, todo_title varchar(30), finished boolean, created_at timestamp)</span>
</span><span class="na">database.username</span><span class="o">=</span><span class="s">sa</span>
<span class="na">database.password</span><span class="o">=</span>
<span class="na">database.driverClassName</span><span class="o">=</span><span class="s">org.h2.Driver</span>
<span class="c"># connection pool</span>
<span class="na">cp.maxActive</span><span class="o">=</span><span class="s">96</span>
<span class="na">cp.maxIdle</span><span class="o">=</span><span class="s">16</span>
<span class="na">cp.minIdle</span><span class="o">=</span><span class="s">0</span>
<span class="na">cp.maxWait</span><span class="o">=</span><span class="s">60000</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="rest-api">
<h2><a class="toc-backref" href="#id39">7.1.3. REST APIの作成</a><a class="headerlink" href="#rest-api" title="Permalink to this headline">¶</a></h2>
<p>本チュートリアルでは、todoテーブルで管理しているデータ(以降、「Todoリソース」呼ぶ)をWeb上に公開するためのREST APIを作成する。</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="10%" />
<col width="30%" />
<col width="15%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">API名</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">HTTP</div>
<div class="line">メソッド</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">パス</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">ステータス</div>
<div class="line">コード</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">GET Todos</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">/api/v1/todos</span></tt></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">200</div>
<div class="line">(OK)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Todoリソースを全件取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">POST Todos</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">POST</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">/api/v1/todos</span></tt></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">201</div>
<div class="line">(Created)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Todoリソースを新規作成する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">GET Todo</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">/api/v1/todos/{todoId}</span></tt></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">200</div>
<div class="line">(OK)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Todoリソースを一件取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">PUT Todo</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">PUT</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">/api/v1/todos/{todoId}</span></tt></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">200</div>
<div class="line">(OK)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Todoリソースを完了状態に更新する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">DELETE Todo</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">DELETE</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">/api/v1/todos/{todoId}</span></tt></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">204</div>
<div class="line">(No Content)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Todoリソースを削除する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>パス内に含まれている<tt class="docutils literal"><span class="pre">{todoId}</span></tt>は、パス変数と呼ばれ、任意の可変値を扱う事ができる。
パス変数を使用する事で、<tt class="docutils literal"><span class="pre">GET</span> <span class="pre">/api/v1/todos/123</span></tt>と<tt class="docutils literal"><span class="pre">GET</span> <span class="pre">/api/v1/todos/456</span></tt>を同じAPIで扱う事ができる。</p>
<p class="last">本チュートリアルでは、Todoを一意に識別するためのID(Todo ID)をパス変数として扱っている。</p>
</div>
</div></blockquote>
<div class="section" id="api">
<h3><a class="toc-backref" href="#id40">7.1.3.1. API仕様</a><a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">HTTPリクエストとレスポンスの具体例を用いて、本チュートリアルで作成するREST APIのインタフェース仕様を示す。</div>
<div class="line">本質的ではないHTTPヘッダー等は例から除いている。</div>
</div>
<div class="line-block">
<div class="line">下記に示す具体例では、Webアプリケーションのコンテキストパスは「&lt;contextPath&gt;」で表現している。</div>
<div class="line">本チュートリアルで作成するWebアプリケーションのコンテキストパスは、「todo-api」となる。</div>
</div>
<div class="section" id="get-todos">
<h4><a class="toc-backref" href="#id41">7.1.3.1.1. GET Todos</a><a class="headerlink" href="#get-todos" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">リクエスト</p>
<div class="highlight-bash"><div class="highlight"><pre>&gt; GET /&lt;contextPath&gt;/api/v1/todos HTTP/1.1
</pre></div>
</div>
</li>
<li><p class="first">レスポンス</p>
<p>作成済みのTodoリソースのリストをJSON形式で返却する。</p>
<div class="highlight-bash"><div class="highlight"><pre>&lt; HTTP/1.1 200 OK
&lt; Content-Type: application/json;charset<span class="o">=</span>UTF-8
&lt;
<span class="o">[{</span><span class="s2">&quot;todoId&quot;</span>:<span class="s2">&quot;9aef3ee3-30d4-4a7c-be4a-bc184ca1d558&quot;</span>,<span class="s2">&quot;todoTitle&quot;</span>:<span class="s2">&quot;Hello World!&quot;</span>,<span class="s2">&quot;finished&quot;</span>:false,<span class="s2">&quot;createdAt&quot;</span>:<span class="s2">&quot;2014-02-25T02:21:48.493+0000&quot;</span><span class="o">}]</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="post-todos">
<h4><a class="toc-backref" href="#id42">7.1.3.1.2. POST Todos</a><a class="headerlink" href="#post-todos" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">リクエスト</p>
<p>新規作成するTodoリソースの内容(タイトル)をJSON形式で指定する。</p>
<div class="highlight-bash"><div class="highlight"><pre>&gt; POST /&lt;contextPath&gt;/api/v1/todos HTTP/1.1
&gt; Content-Type: application/json
&gt; Content-Length: 29
&gt;
<span class="o">{</span><span class="s2">&quot;todoTitle&quot;</span>: <span class="s2">&quot;Study Spring&quot;</span><span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">レスポンス</p>
<p>作成したTodoリソースをJSON形式で返却する。</p>
<div class="highlight-bash"><div class="highlight"><pre>&lt; HTTP/1.1 201 Created
&lt; Content-Type: application/json;charset<span class="o">=</span>UTF-8
&lt;
<span class="o">{</span><span class="s2">&quot;todoId&quot;</span>:<span class="s2">&quot;d6101d61-b22c-48ee-9110-e106af6a1404&quot;</span>,<span class="s2">&quot;todoTitle&quot;</span>:<span class="s2">&quot;Study Spring&quot;</span>,<span class="s2">&quot;finished&quot;</span>:false,<span class="s2">&quot;createdAt&quot;</span>:<span class="s2">&quot;2014-02-25T04:05:58.752+0000&quot;</span><span class="o">}</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="get-todo">
<h4><a class="toc-backref" href="#id43">7.1.3.1.3. GET Todo</a><a class="headerlink" href="#get-todo" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">リクエスト</p>
<div class="line-block">
<div class="line">パス変数「<tt class="docutils literal"><span class="pre">todoId</span></tt>」に、取得対象のTodoリソースのIDを指定する。</div>
<div class="line">下記例では、パス変数「<tt class="docutils literal"><span class="pre">todoId</span></tt>」に<tt class="docutils literal"><span class="pre">9aef3ee3-30d4-4a7c-be4a-bc184ca1d558</span></tt>を指定している。</div>
</div>
<div class="highlight-bash"><div class="highlight"><pre>&gt; GET /&lt;contextPath&gt;/api/v1/todos/9aef3ee3-30d4-4a7c-be4a-bc184ca1d558 HTTP/1.1
</pre></div>
</div>
</li>
<li><p class="first">レスポンス</p>
<p>パス変数「<tt class="docutils literal"><span class="pre">todoId</span></tt>」に一致するTodoリソースをJSON形式で返却する。</p>
<div class="highlight-bash"><div class="highlight"><pre>&lt; HTTP/1.1 200 OK
&lt; Content-Type: application/json;charset<span class="o">=</span>UTF-8
&lt;
<span class="o">{</span><span class="s2">&quot;todoId&quot;</span>:<span class="s2">&quot;9aef3ee3-30d4-4a7c-be4a-bc184ca1d558&quot;</span>,<span class="s2">&quot;todoTitle&quot;</span>:<span class="s2">&quot;Hello World!&quot;</span>,<span class="s2">&quot;finished&quot;</span>:false,<span class="s2">&quot;createdAt&quot;</span>:<span class="s2">&quot;2014-02-25T02:21:48.493+0000&quot;</span><span class="o">}</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="put-todo">
<h4><a class="toc-backref" href="#id44">7.1.3.1.4. PUT Todo</a><a class="headerlink" href="#put-todo" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">リクエスト</p>
<div class="line-block">
<div class="line">パス変数「<tt class="docutils literal"><span class="pre">todoId</span></tt>」に、更新対象のTodoのIDを指定する。</div>
<div class="line">PUT Todoでは、Todoリソースを完了状態に更新するだけなので、リクエストBODYを受け取らないインタフェース仕様にしている。</div>
</div>
<div class="highlight-bash"><div class="highlight"><pre>&gt; PUT /&lt;contextPath&gt;/api/v1/todos/9aef3ee3-30d4-4a7c-be4a-bc184ca1d558 HTTP/1.1
</pre></div>
</div>
</li>
<li><p class="first">レスポンス</p>
<p>パス変数「<tt class="docutils literal"><span class="pre">todoId</span></tt>」に一致するTodoリソースを完了状態(<tt class="docutils literal"><span class="pre">finished</span></tt>フィールドを<tt class="docutils literal"><span class="pre">true</span></tt>)に更新し、JSON形式で返却する。</p>
<div class="highlight-bash"><div class="highlight"><pre>&lt; HTTP/1.1 200 OK
&lt; Content-Type: application/json;charset<span class="o">=</span>UTF-8
&lt;
<span class="o">{</span><span class="s2">&quot;todoId&quot;</span>:<span class="s2">&quot;9aef3ee3-30d4-4a7c-be4a-bc184ca1d558&quot;</span>,<span class="s2">&quot;todoTitle&quot;</span>:<span class="s2">&quot;Hello World!&quot;</span>,<span class="s2">&quot;finished&quot;</span>:true,<span class="s2">&quot;createdAt&quot;</span>:<span class="s2">&quot;2014-02-25T02:21:48.493+0000&quot;</span><span class="o">}</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="delete-todo">
<h4><a class="toc-backref" href="#id45">7.1.3.1.5. DELETE Todo</a><a class="headerlink" href="#delete-todo" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">リクエスト</p>
<p>パス変数「<tt class="docutils literal"><span class="pre">todoId</span></tt>」に、削除対象のTodoリソースのIDを指定する。</p>
<div class="highlight-bash"><div class="highlight"><pre>&gt; DELETE /todo-api/api/v1/todos/9aef3ee3-30d4-4a7c-be4a-bc184ca1d558 HTTP/1.1
</pre></div>
</div>
</li>
<li><p class="first">レスポンス</p>
<p>DELETE Todoでは、Todoリソースの削除が完了した事で返却するリソースが存在しなくなった事を示すために、レスポンスBODYを返却しないインタフェース仕様にしている。</p>
<div class="highlight-bash"><div class="highlight"><pre>&lt; HTTP/1.1 204 No Content
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="id12">
<h4><a class="toc-backref" href="#id46">7.1.3.1.6. エラー応答</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">REST APIでエラーが発生した場合は、JSON形式でエラー内容を返却する。</div>
<div class="line">以下に代表的なエラー発生時のレスポンス仕様について記載する。</div>
<div class="line">下記以外のエラーパターンもあるが、本チュートリアルでは説明は割愛する。</div>
</div>
<p>﻿<a class="reference internal" href="../TutorialTodo/index.html"><em>チュートリアル(Todoアプリケーション)</em></a>では、エラーメッセージはプログラムの中でハードコーディングしていたが、本チュートリアルでは、エラーメッセージはエラーコードをキーにプロパティファイルから取得する。</p>
<ul>
<li><p class="first">入力チェックエラー発生時のレスポンス仕様</p>
<div class="highlight-bash"><div class="highlight"><pre>&lt; HTTP/1.1 400 Bad Request
&lt; Content-Type: application/json;charset<span class="o">=</span>UTF-8
&lt;
<span class="o">{</span><span class="s2">&quot;code&quot;</span>:<span class="s2">&quot;E400&quot;</span>,<span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;[E400] The requested Todo contains invalid values.&quot;</span>,<span class="s2">&quot;details&quot;</span>:<span class="o">[{</span><span class="s2">&quot;code&quot;</span>:<span class="s2">&quot;NotNull&quot;</span>,<span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;todoTitle may not be null.&quot;</span>,target:<span class="s2">&quot;todoTitle&quot;</span><span class="o">}]}</span>
</pre></div>
</div>
</li>
<li><p class="first">業務エラー発生時のレスポンス仕様</p>
<div class="highlight-bash"><div class="highlight"><pre>&lt; HTTP/1.1 409 Conflict
&lt; Content-Type: application/json;charset<span class="o">=</span>UTF-8
&lt;
<span class="o">{</span><span class="s2">&quot;code&quot;</span>:<span class="s2">&quot;E002&quot;</span>,<span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;[E002] The requested Todo is already finished. (id=353fb5db-151a-4696-9b4a-b958358a5ab3)&quot;</span><span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">リソース未検出時のレスポンス仕様</p>
<div class="highlight-bash"><div class="highlight"><pre>&lt; HTTP/1.1 404 Not Found
&lt; Content-Type: application/json;charset<span class="o">=</span>UTF-8
&lt;
<span class="o">{</span><span class="s2">&quot;code&quot;</span>:<span class="s2">&quot;E404&quot;</span>,<span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;[E404] The requested Todo is not found. (id=353fb5db-151a-4696-9b4a-b958358a5ab2)&quot;</span><span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">システムエラー発生時のレスポンス仕様</p>
<div class="highlight-bash"><div class="highlight"><pre>&lt; HTTP/1.1 500 Internal Server Error
&lt; Content-Type: application/json;charset<span class="o">=</span>UTF-8
&lt;
<span class="o">{</span><span class="s2">&quot;code&quot;</span>:<span class="s2">&quot;E500&quot;</span>,<span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;[E500] System error occurred.&quot;</span><span class="o">}</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="rest-apidispatcherservlet">
<h3><a class="toc-backref" href="#id47">7.1.3.2. REST API用のDispatcherServletを用意</a><a class="headerlink" href="#rest-apidispatcherservlet" title="Permalink to this headline">¶</a></h3>
<p>まず、REST API用のリクエストを処理するための<tt class="docutils literal"><span class="pre">DispatcherServlet</span></tt>の定義を追加する。</p>
<div class="section" id="web-xml">
<h4><a class="toc-backref" href="#id48">7.1.3.2.1. web.xmlの修正</a><a class="headerlink" href="#web-xml" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">REST API用の設定を追加する。</div>
<div class="line">追加で設定する箇所をハイライトしている。</div>
</div>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;web-app</span> <span class="na">xmlns=</span><span class="s">&quot;http://java.sun.com/xml/ns/javaee&quot;</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span>
    <span class="na">version=</span><span class="s">&quot;3.0&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;listener&gt;</span>
        <span class="nt">&lt;listener-class&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="nt">&lt;/listener-class&gt;</span>
    <span class="nt">&lt;/listener&gt;</span>
    <span class="nt">&lt;listener&gt;</span>
        <span class="nt">&lt;listener-class&gt;</span>org.terasoluna.gfw.web.logging.HttpSessionEventLoggingListener<span class="nt">&lt;/listener-class&gt;</span>
    <span class="nt">&lt;/listener&gt;</span>
    <span class="nt">&lt;context-param&gt;</span>
        <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
        <span class="c">&lt;!-- Root ApplicationContext --&gt;</span>
        <span class="nt">&lt;param-value&gt;</span>
            classpath*:META-INF/spring/applicationContext.xml
            classpath*:META-INF/spring/spring-security.xml
        <span class="nt">&lt;/param-value&gt;</span>
    <span class="nt">&lt;/context-param&gt;</span>

    <span class="nt">&lt;filter&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>MDCClearFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;filter-class&gt;</span>org.terasoluna.gfw.web.logging.mdc.MDCClearFilter<span class="nt">&lt;/filter-class&gt;</span>
    <span class="nt">&lt;/filter&gt;</span>
    <span class="nt">&lt;filter-mapping&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>MDCClearFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/filter-mapping&gt;</span>

    <span class="nt">&lt;filter&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>exceptionLoggingFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;filter-class&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="nt">&lt;/filter-class&gt;</span>
    <span class="nt">&lt;/filter&gt;</span>
    <span class="nt">&lt;filter-mapping&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>exceptionLoggingFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/filter-mapping&gt;</span>

    <span class="nt">&lt;filter&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>XTrackMDCPutFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;filter-class&gt;</span>org.terasoluna.gfw.web.logging.mdc.XTrackMDCPutFilter<span class="nt">&lt;/filter-class&gt;</span>
    <span class="nt">&lt;/filter&gt;</span>
    <span class="nt">&lt;filter-mapping&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>XTrackMDCPutFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/filter-mapping&gt;</span>

    <span class="nt">&lt;filter&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>CharacterEncodingFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;filter-class&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="nt">&lt;/filter-class&gt;</span>
        <span class="nt">&lt;init-param&gt;</span>
            <span class="nt">&lt;param-name&gt;</span>encoding<span class="nt">&lt;/param-name&gt;</span>
            <span class="nt">&lt;param-value&gt;</span>UTF-8<span class="nt">&lt;/param-value&gt;</span>
        <span class="nt">&lt;/init-param&gt;</span>
        <span class="nt">&lt;init-param&gt;</span>
            <span class="nt">&lt;param-name&gt;</span>forceEncoding<span class="nt">&lt;/param-name&gt;</span>
            <span class="nt">&lt;param-value&gt;</span>true<span class="nt">&lt;/param-value&gt;</span>
        <span class="nt">&lt;/init-param&gt;</span>
    <span class="nt">&lt;/filter&gt;</span>
    <span class="nt">&lt;filter-mapping&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>CharacterEncodingFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/filter-mapping&gt;</span>

    <span class="nt">&lt;filter&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>springSecurityFilterChain<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;filter-class&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="nt">&lt;/filter-class&gt;</span>
    <span class="nt">&lt;/filter&gt;</span>

    <span class="nt">&lt;filter-mapping&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>springSecurityFilterChain<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/filter-mapping&gt;</span>

<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;servlet&gt;</span>
</span><span class="hll">        <span class="nt">&lt;servlet-name&gt;</span>restApiServlet<span class="nt">&lt;/servlet-name&gt;</span>
</span><span class="hll">        <span class="nt">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="nt">&lt;/servlet-class&gt;</span>
</span><span class="hll">        <span class="nt">&lt;init-param&gt;</span>
</span><span class="hll">            <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
</span><span class="hll">            <span class="c">&lt;!-- ApplicationContext for Spring MVC (REST) --&gt;</span>
</span><span class="hll">            <span class="nt">&lt;param-value&gt;</span>classpath*:META-INF/spring/spring-mvc-rest.xml<span class="nt">&lt;/param-value&gt;</span>
</span><span class="hll">        <span class="nt">&lt;/init-param&gt;</span>
</span><span class="hll">        <span class="nt">&lt;load-on-startup&gt;</span>1<span class="nt">&lt;/load-on-startup&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/servlet&gt;</span>
</span>
<span class="hll">    <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;servlet-mapping&gt;</span>
</span><span class="hll">        <span class="nt">&lt;servlet-name&gt;</span>restApiServlet<span class="nt">&lt;/servlet-name&gt;</span>
</span><span class="hll">        <span class="nt">&lt;url-pattern&gt;</span>/api/v1/*<span class="nt">&lt;/url-pattern&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/servlet-mapping&gt;</span>
</span>
    <span class="nt">&lt;servlet&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>appServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="nt">&lt;/servlet-class&gt;</span>
        <span class="nt">&lt;init-param&gt;</span>
            <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
            <span class="c">&lt;!-- ApplicationContext for Spring MVC --&gt;</span>
            <span class="nt">&lt;param-value&gt;</span>classpath*:META-INF/spring/spring-mvc.xml<span class="nt">&lt;/param-value&gt;</span>
        <span class="nt">&lt;/init-param&gt;</span>
        <span class="nt">&lt;load-on-startup&gt;</span>1<span class="nt">&lt;/load-on-startup&gt;</span>
    <span class="nt">&lt;/servlet&gt;</span>

    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>appServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>

    <span class="nt">&lt;jsp-config&gt;</span>
        <span class="nt">&lt;jsp-property-group&gt;</span>
            <span class="nt">&lt;url-pattern&gt;</span>*.jsp<span class="nt">&lt;/url-pattern&gt;</span>
            <span class="nt">&lt;el-ignored&gt;</span>false<span class="nt">&lt;/el-ignored&gt;</span>
            <span class="nt">&lt;page-encoding&gt;</span>UTF-8<span class="nt">&lt;/page-encoding&gt;</span>
            <span class="nt">&lt;scripting-invalid&gt;</span>false<span class="nt">&lt;/scripting-invalid&gt;</span>
            <span class="nt">&lt;include-prelude&gt;</span>/WEB-INF/views/common/include.jsp<span class="nt">&lt;/include-prelude&gt;</span>
        <span class="nt">&lt;/jsp-property-group&gt;</span>
    <span class="nt">&lt;/jsp-config&gt;</span>

    <span class="nt">&lt;error-page&gt;</span>
        <span class="nt">&lt;error-code&gt;</span>500<span class="nt">&lt;/error-code&gt;</span>
        <span class="nt">&lt;location&gt;</span>/WEB-INF/views/common/error/systemError.jsp<span class="nt">&lt;/location&gt;</span>
    <span class="nt">&lt;/error-page&gt;</span>
    <span class="nt">&lt;error-page&gt;</span>
        <span class="nt">&lt;error-code&gt;</span>404<span class="nt">&lt;/error-code&gt;</span>
        <span class="nt">&lt;location&gt;</span>/WEB-INF/views/common/error/resourceNotFoundError.jsp<span class="nt">&lt;/location&gt;</span>
    <span class="nt">&lt;/error-page&gt;</span>
    <span class="nt">&lt;error-page&gt;</span>
        <span class="nt">&lt;exception-type&gt;</span>java.lang.Exception<span class="nt">&lt;/exception-type&gt;</span>
        <span class="nt">&lt;location&gt;</span>/WEB-INF/views/common/error/unhandledSystemError.html<span class="nt">&lt;/location&gt;</span>
    <span class="nt">&lt;/error-page&gt;</span>

    <span class="nt">&lt;session-config&gt;</span>
        <span class="c">&lt;!-- 30min --&gt;</span>
        <span class="nt">&lt;session-timeout&gt;</span>30<span class="nt">&lt;/session-timeout&gt;</span>
    <span class="nt">&lt;/session-config&gt;</span>

<span class="nt">&lt;/web-app&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">初期化パラメータ「<tt class="docutils literal"><span class="pre">contextConfigLocation</span></tt>」に、REST用のSpringMVC設定ファイルを指定する。</div>
<div class="line">本チュートリアルでは、クラスパス上にある「<tt class="file docutils literal"><span class="pre">META-INF/spring/spring-mvc-rest.xml</span></tt>」を指定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">&lt;url-pattern&gt;</span></tt>要素に、REST API用の<tt class="docutils literal"><span class="pre">DispatcherServlet</span></tt>にマッピングするURLのパターンを指定する。</div>
<div class="line">本チュートリアルでは、<tt class="docutils literal"><span class="pre">/api/v1/</span></tt>から始まる場合はリクエストをREST APIへのリクエストとしてREST API用の<tt class="docutils literal"><span class="pre">DispatcherServlet</span></tt>へマッピングしている。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="spring-mvc-rest-xml">
<h4><a class="toc-backref" href="#id49">7.1.3.2.2. spring-mvc-rest.xmlの作成</a><a class="headerlink" href="#spring-mvc-rest-xml" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><tt class="file docutils literal"><span class="pre">src/main/resources/META-INF/spring/spring-mvc.xml</span></tt>をコピーして、REST用のSpringMVC設定ファイルを作成する。</div>
<div class="line">REST用のSpringMVC設定ファイルは以下のような定義となる。</div>
</div>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">src/main/resources/META-INF/spring/spring-mvc-rest.xml</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xmlns:mvc=</span><span class="s">&quot;http://www.springframework.org/schema/mvc&quot;</span>
       <span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
       <span class="na">xmlns:aop=</span><span class="s">&quot;http://www.springframework.org/schema/aop&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd</span>
<span class="s">    http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">    http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
<span class="s">        http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;context:property-placeholder</span>
            <span class="na">location=</span><span class="s">&quot;classpath*:/META-INF/spring/*.properties&quot;</span><span class="nt">/&gt;</span>

<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span>    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">&quot;todo.api&quot;</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;mvc:annotation-driven&gt;</span>
        <span class="nt">&lt;mvc:message-converters&gt;</span>
<span class="hll">            <span class="c">&lt;!-- (2) --&gt;</span>
</span>            <span class="nt">&lt;bean</span>
                    <span class="na">class=</span><span class="s">&quot;org.springframework.http.converter.json.MappingJacksonHttpMessageConverter&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;objectMapper&quot;</span> <span class="na">ref=</span><span class="s">&quot;objectMapper&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/bean&gt;</span>
        <span class="nt">&lt;/mvc:message-converters&gt;</span>
        <span class="nt">&lt;mvc:argument-resolvers&gt;</span>
            <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.data.web.PageableHandlerMethodArgumentResolver&quot;</span><span class="nt">&gt;&lt;/bean&gt;</span>
        <span class="nt">&lt;/mvc:argument-resolvers&gt;</span>
    <span class="nt">&lt;/mvc:annotation-driven&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;objectMapper&quot;</span> <span class="na">class=</span><span class="s">&quot;org.codehaus.jackson.map.ObjectMapper&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dateFormat&quot;</span><span class="nt">&gt;</span>
<span class="hll">            <span class="c">&lt;!-- (3) --&gt;</span>
</span>            <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.codehaus.jackson.map.util.StdDateFormat&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;mvc:interceptors&gt;</span>
        <span class="nt">&lt;mvc:interceptor&gt;</span>
            <span class="nt">&lt;mvc:mapping</span> <span class="na">path=</span><span class="s">&quot;/**&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/resources/**&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/**/*.html&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;bean</span>
                    <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.logging.TraceLoggingInterceptor&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/mvc:interceptor&gt;</span>
<span class="hll">        <span class="c">&lt;!-- (4) --&gt;</span>
</span>        <span class="c">&lt;!--  REMOVE THIS LINE IF YOU USE JPA</span>
<span class="c">        &lt;mvc:interceptor&gt;</span>
<span class="c">            &lt;mvc:mapping path=&quot;/**&quot;/&gt;</span>
<span class="c">            &lt;mvc:exclude-mapping path=&quot;/resources/**&quot;/&gt;</span>
<span class="c">            &lt;mvc:exclude-mapping path=&quot;/**/*.html&quot;/&gt;</span>
<span class="c">            &lt;bean</span>
<span class="c">                    class=&quot;org.springframework.orm.jpa.support.OpenEntityManagerInViewInterceptor&quot;/&gt;</span>
<span class="c">        &lt;/mvc:interceptor&gt;</span>
<span class="c">              REMOVE THIS LINE IF YOU USE JPA  --&gt;</span>
    <span class="nt">&lt;/mvc:interceptors&gt;</span>

    <span class="c">&lt;!-- Setting AOP. --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;handlerExceptionResolverLoggingInterceptor&quot;</span>
        <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.HandlerExceptionResolverLoggingInterceptor&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionLogger&quot;</span> <span class="na">ref=</span><span class="s">&quot;exceptionLogger&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;aop:config&gt;</span>
        <span class="nt">&lt;aop:advisor</span> <span class="na">advice-ref=</span><span class="s">&quot;handlerExceptionResolverLoggingInterceptor&quot;</span>
            <span class="na">pointcut=</span><span class="s">&quot;execution(* org.springframework.web.servlet.HandlerExceptionResolver.resolveException(..))&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/aop:config&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">REST API用のパッケージ配下に対してコンポーネントスキャンの設定をする。</div>
<div class="line">本チュートリアルでは、REST API用のパッケージを<tt class="docutils literal"><span class="pre">todo.api</span></tt>にしている。</div>
<div class="line">画面遷移用のContollerは、<tt class="docutils literal"><span class="pre">app</span></tt>パッケージ配下に格納していたが、REST API用のContollerは、<tt class="docutils literal"><span class="pre">api</span></tt>パッケージ配下に格納する事を推奨する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">&lt;mvc:message-converters&gt;</span></tt>に、Contrtollerの引数及び返り値で扱うJavaBeanをシリアライズ/デシリアライズするためのクラスを設定する。</div>
<div class="line">複数設定する事ができるが、今回のチュートリアルではJSONしか使用しないため、<tt class="docutils literal"><span class="pre">MappingJacksonHttpMessageConverter</span></tt>のみ指定している。</div>
<div class="line"><tt class="docutils literal"><span class="pre">MappingJacksonHttpMessageConverter</span></tt>の<tt class="docutils literal"><span class="pre">objectMapper</span></tt>プロパティには、Jacksonより提供されている「JSON &lt;-&gt; JavaBean」の変換を行うためのコンポーネント「<tt class="docutils literal"><span class="pre">ObjectMapper</span></tt>」を指定する。</div>
<div class="line">本チュートリアルでは、日時型の変換をカスタマイズした<tt class="docutils literal"><span class="pre">ObjectMapper</span></tt>を指定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本チュートリアルでは、<tt class="docutils literal"><span class="pre">java.util.Date</span></tt>オブジェクトをシリアライズする際にISO-8601形式とする。</div>
<div class="line"><tt class="docutils literal"><span class="pre">Date</span></tt>オブジェクトをシリアライズする際にISO-8601形式にする場合は、<tt class="docutils literal"><span class="pre">ObjectMapper</span></tt>の<tt class="docutils literal"><span class="pre">dateFormat</span></tt>プロパティに<tt class="docutils literal"><span class="pre">org.codehaus.jackson.map.util.StdDateFormat</span></tt>を設定する事で実現する事ができる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JPAを使用する場合は<tt class="docutils literal"><span class="pre">OpenEntityManagerInViewInterceptor</span></tt>を使用するが、今回のチュートリアルではMyBatis2を使用するので、コメントアウトのままにするか、この<tt class="docutils literal"><span class="pre">&lt;mvc:interceptor&gt;</span></tt>タグを削除する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="figure">
<img alt="../_images/add-spring-mvc-rest.png" src="../_images/add-spring-mvc-rest.png" />
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="rest-apispring-security">
<h3><a class="toc-backref" href="#id50">7.1.3.3. REST API用のSpring Securityの定義追加</a><a class="headerlink" href="#rest-apispring-security" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">本チュートリアルで作成するREST APIでは、CSRF対策を無効にする。</div>
<div class="line">REST APIを使って構築するWebアプリケーションでも、CSRF対策は必要である。ただし、本チュートリアルの目的としてCSRF対策の話題は本質的ではないため、機能を無効化し、説明も割愛する。</div>
</div>
<div class="line-block">
<div class="line">CSRF対策を無効化すると、セッションを使用する必要がなくなる。</div>
<div class="line">そのため、本チュートリアルではセッションを使用しないアーキテクチャ（ステートレスなアーキテクチャ）を採用する。</div>
</div>
<div class="line-block">
<div class="line">以下の設定を追加する事で、CSRF対策の無効化及びセッションを使用しないようにする事ができる。</div>
</div>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">src/main/resources/META-INF/spring/spring-security.xml</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
    <span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;sec:http</span> <span class="na">pattern=</span><span class="s">&quot;/resources/**&quot;</span> <span class="na">security=</span><span class="s">&quot;none&quot;</span><span class="nt">/&gt;</span>

<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;sec:http</span> <span class="na">pattern=</span><span class="s">&quot;/api/v1/**&quot;</span> <span class="na">auto-config=</span><span class="s">&quot;true&quot;</span> <span class="na">use-expressions=</span><span class="s">&quot;true&quot;</span> <span class="na">create-session=</span><span class="s">&quot;stateless&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">        <span class="c">&lt;!--&lt;sec:custom-filter ref=&quot;csrfFilter&quot; before=&quot;LOGOUT_FILTER&quot;/&gt;--&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;sec:custom-filter</span> <span class="na">ref=</span><span class="s">&quot;userIdMDCPutFilter&quot;</span> <span class="na">after=</span><span class="s">&quot;ANONYMOUS_FILTER&quot;</span><span class="nt">/&gt;</span>
</span><span class="hll">        <span class="c">&lt;!--&lt;sec:session-management session-authentication-strategy-ref=&quot;sessionAuthenticationStrategy&quot; /&gt;--&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/sec:http&gt;</span>
</span>
    <span class="nt">&lt;sec:http</span> <span class="na">auto-config=</span><span class="s">&quot;true&quot;</span> <span class="na">use-expressions=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;sec:custom-filter</span> <span class="na">ref=</span><span class="s">&quot;csrfFilter&quot;</span> <span class="na">before=</span><span class="s">&quot;LOGOUT_FILTER&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;sec:custom-filter</span> <span class="na">ref=</span><span class="s">&quot;userIdMDCPutFilter&quot;</span> <span class="na">after=</span><span class="s">&quot;ANONYMOUS_FILTER&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;sec:session-management</span> <span class="na">session-authentication-strategy-ref=</span><span class="s">&quot;sessionAuthenticationStrategy&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/sec:http&gt;</span>
    <span class="nt">&lt;sec:authentication-manager&gt;&lt;/sec:authentication-manager&gt;</span>

    <span class="c">&lt;!-- CSRF Protection --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;csrfTokenRepository&quot;</span>
        <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.csrf.HttpSessionCsrfTokenRepository&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;csrfFilter&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.csrf.CsrfFilter&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">ref=</span><span class="s">&quot;csrfTokenRepository&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;accessDeniedHandler&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;bean</span>
                <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.access.AccessDeniedHandlerImpl&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;errorPage&quot;</span> <span class="na">value=</span><span class="s">&quot;/WEB-INF/views/common/error/csrfTokenError.jsp&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/bean&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sessionAuthenticationStrategy&quot;</span>
        <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.session.CompositeSessionAuthenticationStrategy&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;list&gt;</span>
                <span class="nt">&lt;bean</span>
                    <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.session.SessionFixationProtectionStrategy&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;bean</span>
                    <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.csrf.CsrfAuthenticationStrategy&quot;</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span>
                        <span class="na">ref=</span><span class="s">&quot;csrfTokenRepository&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;/bean&gt;</span>
            <span class="nt">&lt;/list&gt;</span>
        <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!-- Put UserID into MDC --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;userIdMDCPutFilter&quot;</span> <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.security.web.logging.UserIdMDCPutFilter&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;removeValue&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">REST API用のSpring Securityの定義を追加する。</div>
<div class="line"><tt class="docutils literal"><span class="pre">&lt;sec:http&gt;</span></tt>要素のpattern属性に、REST API用のリクエストパスのURLパターンを指定している。</div>
<div class="line">本チュートリアルでは<tt class="docutils literal"><span class="pre">/api/v1/</span></tt>で始まるリクエストパスをREST API用のリクエストパスとして扱う。</div>
<div class="line">また、create-session属性を<tt class="docutils literal"><span class="pre">stateless</span></tt>とする事で、Spring Securityの処理でセッションが使用されなくなる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">CSRF対策を無効化するために、CSRF対策用のServlet Filterの定義をコメントアウトしている。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">セッションを使用しないアーキテクチャを採用するために、セッション管理に関係するコンポーネントへの参照定義をコメントアウトしている。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id13">
<h3><a class="toc-backref" href="#id51">7.1.3.4. REST API用パッケージの作成</a><a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<p>REST API用のクラスを格納するパッケージを作成する。</p>
<div class="line-block">
<div class="line">REST API用のクラスを格納するルートパッケージのパッケージ名は<tt class="docutils literal"><span class="pre">api</span></tt>として、配下にリソース毎のパッケージ(リソース名の小文字)を作成する事を推奨する。</div>
<div class="line">本チュートリアルで扱うリソースのリソース名はTodoなので、<tt class="docutils literal"><span class="pre">todo.api.todo</span></tt>パッケージを作成する。</div>
</div>
<blockquote>
<div><div class="figure">
<img alt="../_images/make-package-for-rest.png" src="../_images/make-package-for-rest.png" />
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>作成したパッケージに格納するクラスは、通常以下の３種類となる。
作成するクラスのクラス名は、以下のネーミングルールとする事を推奨する。</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">[リソース名]Resource</span></tt></li>
<li><tt class="docutils literal"><span class="pre">[リソース名]RestController</span></tt></li>
<li><tt class="docutils literal"><span class="pre">[リソース名]Helper</span></tt> (必要に応じて)</li>
</ul>
<p>本チュートリアルで扱うリソースのリソース名がTodoなので、</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">TodoResource</span></tt></li>
<li><tt class="docutils literal"><span class="pre">TodoRestController</span></tt></li>
</ul>
<p>を作成する。</p>
<p class="last">本チュートリアルでは、<tt class="docutils literal"><span class="pre">TodoRestHelper</span></tt>は作成しない。</p>
</div>
</div></blockquote>
</div>
<div class="section" id="resource">
<h3><a class="toc-backref" href="#id52">7.1.3.5. Resourceクラスの作成</a><a class="headerlink" href="#resource" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Todoリソースを表現する<tt class="docutils literal"><span class="pre">TodoResource</span></tt>クラスを作成する。</div>
<div class="line">本ガイドラインでは、REST APIの入出力となるJSON(またはXML)を表現するJava Beanを<strong>Resourceクラス</strong>と呼ぶ。</div>
</div>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">TodoResource.java</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoResource</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">todoId</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">30</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">todoTitle</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">finished</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">Date</span> <span class="n">createdAt</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTodoId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">todoId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTodoId</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">todoId</span> <span class="o">=</span> <span class="n">todoId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTodoTitle</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">todoTitle</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTodoTitle</span><span class="o">(</span><span class="n">String</span> <span class="n">todoTitle</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">todoTitle</span> <span class="o">=</span> <span class="n">todoTitle</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isFinished</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">finished</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFinished</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">finished</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">finished</span> <span class="o">=</span> <span class="n">finished</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Date</span> <span class="nf">getCreatedAt</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">createdAt</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCreatedAt</span><span class="o">(</span><span class="n">Date</span> <span class="n">createdAt</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">createdAt</span> <span class="o">=</span> <span class="n">createdAt</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="figure">
<img alt="../_images/create-todo-resource.png" src="../_images/create-todo-resource.png" />
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>DomainObjectクラス(本チュートリアルでは<tt class="docutils literal"><span class="pre">Todo</span></tt>クラス)があるにも関わらず、Resourceクラスを作成する理由は、
クライアントとの入出力で使用するインタフェース上の情報と、業務処理で扱う情報は必ずしも一致しないためである。</p>
<p>これらを混同してして使用すると、アプリケーション層の影響がドメイン層におよび、保守性を低下させる。
DomainObjectとResourceクラスは別々に作成し、Dozer等のBeanMapperを利用してデータ変換を行うことを推奨する。</p>
<p>ResourceクラスはFormクラスと役割が似ているが、FormクラスはHTMLの<tt class="docutils literal"><span class="pre">&lt;form&gt;</span></tt> タグをJavaBeanで表現したもの、
ResourceクラスはREST APIの入出力をJavaBeanで表現したものであり、本質的には異なるものである。</p>
<p class="last">ただし、実体としてはBean Validationのアノテーションを付与したJavaBeanであり、Controllerクラスと同じパッケージに格納することから、
Formクラスとほぼ同じである。</p>
</div>
</div></blockquote>
</div>
<div class="section" id="controller">
<h3><a class="toc-backref" href="#id53">7.1.3.6. Controllerクラスの作成</a><a class="headerlink" href="#controller" title="Permalink to this headline">¶</a></h3>
<p><tt class="docutils literal"><span class="pre">TodoResource</span></tt>のREST APIを提供する<tt class="docutils literal"><span class="pre">TodoRestController</span></tt>クラスを作成する。</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">TodoRestController.java</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;todos&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="o">{</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースのパスを指定する。</div>
<div class="line"><tt class="docutils literal"><span class="pre">/api/v1/</span></tt>の部分はweb.xmlに定義しているため、この設定を行うことで<tt class="docutils literal"><span class="pre">/&lt;contextPath&gt;/api/v1/todos</span></tt>というパスにマッピングされる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="section" id="id14">
<h4><a class="toc-backref" href="#id54">7.1.3.6.1. GET Todosの実装</a><a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h4>
<p>作成済みのTodoリソースを全件取得するAPI(GET Todos)の処理を、<tt class="docutils literal"><span class="pre">TodoRestController</span></tt>の<tt class="docutils literal"><span class="pre">getTodos</span></tt>メソッドに実装する。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="hll"><span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
</span><span class="hll">
</span><span class="hll"><span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>
</span><span class="hll">
</span><span class="hll"><span class="kn">import</span> <span class="nn">org.dozer.Mapper</span><span class="o">;</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="o">;</span>
</span><span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="hll"><span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="o">;</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ResponseBody</span><span class="o">;</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ResponseStatus</span><span class="o">;</span>
</span><span class="hll">
</span><span class="hll"><span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="o">;</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">todo.domain.service.todo.TodoService</span><span class="o">;</span>
</span>
<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;todos&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="o">{</span>
<span class="hll">    <span class="nd">@Inject</span>
</span><span class="hll">    <span class="n">TodoService</span> <span class="n">todoService</span><span class="o">;</span>
</span><span class="hll">    <span class="nd">@Inject</span>
</span><span class="hll">    <span class="n">Mapper</span> <span class="n">beanMapper</span><span class="o">;</span>
</span><span class="hll">
</span><span class="hll">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span> <span class="c1">// (1)</span>
</span><span class="hll">    <span class="nd">@ResponseBody</span> <span class="c1">// (2)</span>
</span><span class="hll">    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span> <span class="c1">// (3)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">TodoResource</span><span class="o">&gt;</span> <span class="n">getTodos</span><span class="o">()</span> <span class="o">{</span>
</span><span class="hll">        <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span> <span class="o">=</span> <span class="n">todoService</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
</span><span class="hll">        <span class="n">List</span><span class="o">&lt;</span><span class="n">TodoResource</span><span class="o">&gt;</span> <span class="n">todoResources</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span><span class="hll">        <span class="k">for</span> <span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span> <span class="o">:</span> <span class="n">todos</span><span class="o">)</span> <span class="o">{</span>
</span><span class="hll">            <span class="n">todoResources</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">todo</span><span class="o">,</span> <span class="n">TodoResource</span><span class="o">.</span><span class="na">class</span><span class="o">));</span> <span class="c1">// (4)</span>
</span><span class="hll">        <span class="o">}</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">todoResources</span><span class="o">;</span> <span class="c1">// (5)</span>
</span><span class="hll">    <span class="o">}</span>
</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">メソッドがGETのリクエストを処理するために、<tt class="docutils literal"><span class="pre">method</span></tt>属性に<tt class="docutils literal"><span class="pre">RequestMethod.GET</span></tt>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">メソッドの返り値として返却したオブジェクトを、レスポンスBODYのメッセージとしてクライアントに返答することを示す<tt class="docutils literal"><span class="pre">&#64;ResponseBody</span></tt>アノテーションを付与する。</div>
<div class="line">本チュートリアルでは、JSON形式のデータにシリアライズする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">応答するHTTPステータスコードを<tt class="docutils literal"><span class="pre">&#64;ResponseStatus</span></tt>アノテーションに指定する。</div>
<div class="line">HTTPステータスとして、&#8221;200 OK&#8221;を設定するため、value属性には<tt class="docutils literal"><span class="pre">HttpStatus.OK</span></tt>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">TodoService.findAll</span></tt>で取得した<tt class="docutils literal"><span class="pre">Todo</span></tt>オブジェクトを、応答するJSONを表現する<tt class="docutils literal"><span class="pre">TodoResource</span></tt>型に変換する。</div>
<div class="line"><tt class="docutils literal"><span class="pre">Todo</span></tt>と<tt class="docutils literal"><span class="pre">TodoResource</span></tt>の変換処理は、Dozerの<tt class="docutils literal"><span class="pre">org.dozer.Mapper</span></tt>を使うと便利である。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">List&lt;TodoResource&gt;</span></tt>オブジェクトを返却することで、<tt class="file docutils literal"><span class="pre">spring-mvc-rest.xml</span></tt>に定義した<tt class="docutils literal"><span class="pre">MappingJacksonHttpMessageConverter</span></tt>により、<tt class="docutils literal"><span class="pre">[{&quot;todoId&quot;</span> <span class="pre">:</span> <span class="pre">&quot;xxx&quot;,</span> <span class="pre">&quot;todoTitle&quot;:</span> <span class="pre">&quot;yyy&quot;,</span> <span class="pre">...},</span> <span class="pre">{&quot;todoId&quot;</span> <span class="pre">:</span> <span class="pre">&quot;xxx&quot;,</span> <span class="pre">&quot;todoTitle&quot;:</span> <span class="pre">&quot;yyy&quot;,</span> <span class="pre">...},</span> <span class="pre">...]</span></tt>形式のJSONにシリアライズされる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line">tc Serverを起動し、実装したAPIの動作確認を行う。</div>
<div class="line">プロジェクト名を右クリックして、「Run As」→「Run on Server」を選択する。</div>
</div>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/run-on-server1.png"><img alt="../_images/run-on-server1.png" src="../_images/run-on-server1.png" style="width: 100%;" /></a>
</div>
</div></blockquote>
<p>「VMWare vFabric tc Server Developer Edition v2.9」を選択して、「Next &gt;」をクリックする。</p>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/run-on-server2.png"><img alt="../_images/run-on-server2.png" src="../_images/run-on-server2.png" style="width: 100%;" /></a>
</div>
</div></blockquote>
<p>「Configured」の欄に「todo-api」が含まれていることを確認して、「Finish」をクリックする。</p>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/run-on-server3.png"><img alt="../_images/run-on-server3.png" src="../_images/run-on-server3.png" style="width: 100%;" /></a>
</div>
</div></blockquote>
<p>正常に起動して<tt class="docutils literal"><span class="pre">&quot;localhost:8080/todo-api/&quot;</span></tt>にアクセスすると、以下のようにデフォルトのwelcomeページが表示される。</p>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/run-on-server4.png"><img alt="../_images/run-on-server4.png" src="../_images/run-on-server4.png" style="width: 100%;" /></a>
</div>
</div></blockquote>
<p>次に、REST APIにアクセスする。
Dev HTTP Clientを開いてURLに<tt class="docutils literal"><span class="pre">&quot;localhost:8080/todo-api/api/v1/todos&quot;</span></tt>を入力し、メソッドにGETを指定して、&#8221;Send&#8221;ボタンをクリックする。</p>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/get-todos1.png"><img alt="../_images/get-todos1.png" src="../_images/get-todos1.png" style="width: 100%;" /></a>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">以下のように「RESPONSE」の「BODY」に実行結果のJSONが表示される。</div>
<div class="line">現時点ではデータが何も登録されていないため、空配列である<tt class="docutils literal"><span class="pre">[]</span></tt>が返却される。</div>
</div>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/get-todos2.png"><img alt="../_images/get-todos2.png" src="../_images/get-todos2.png" style="width: 100%;" /></a>
</div>
<p>Spring Securityの設定を、セッションを使用しない設定に変更しているため、「RESPONSE」の「HEADERS」に<tt class="docutils literal"><span class="pre">&quot;Set-Cookie:</span> <span class="pre">JSESSIONID=xxxx&quot;</span></tt>がないという点にも着目してほしい。</p>
</div></blockquote>
</div>
<div class="section" id="id15">
<h4><a class="toc-backref" href="#id55">7.1.3.6.2. POST Todosの実装</a><a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h4>
<p>Todoリソースを新規作成するAPI(POST Todos)の処理を、<tt class="docutils literal"><span class="pre">TodoRestController</span></tt>の<tt class="docutils literal"><span class="pre">postTodos</span></tt>メソッドに実装する。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.dozer.Mapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="hll"><span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="o">;</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestBody</span><span class="o">;</span>
</span><span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ResponseBody</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ResponseStatus</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">todo.domain.service.todo.TodoService</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;todos&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="o">{</span>
    <span class="nd">@Inject</span>
    <span class="n">TodoService</span> <span class="n">todoService</span><span class="o">;</span>
    <span class="nd">@Inject</span>
    <span class="n">Mapper</span> <span class="n">beanMapper</span><span class="o">;</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">TodoResource</span><span class="o">&gt;</span> <span class="n">getTodos</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span> <span class="o">=</span> <span class="n">todoService</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">TodoResource</span><span class="o">&gt;</span> <span class="n">todoResources</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span> <span class="o">:</span> <span class="n">todos</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">todoResources</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">todo</span><span class="o">,</span> <span class="n">TodoResource</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">todoResources</span><span class="o">;</span>
    <span class="o">}</span>

<span class="hll">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span> <span class="c1">// (1)</span>
</span><span class="hll">    <span class="nd">@ResponseBody</span>
</span><span class="hll">    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">CREATED</span><span class="o">)</span> <span class="c1">// (2)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">TodoResource</span> <span class="nf">postTodos</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nd">@Validated</span> <span class="n">TodoResource</span> <span class="n">todoResource</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (3)</span>
</span><span class="hll">        <span class="n">Todo</span> <span class="n">createdTodo</span> <span class="o">=</span> <span class="n">todoService</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">beanMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">todoResource</span><span class="o">,</span> <span class="n">Todo</span><span class="o">.</span><span class="na">class</span><span class="o">));</span> <span class="c1">// (4)</span>
</span><span class="hll">        <span class="n">TodoResource</span> <span class="n">createdTodoResponse</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">createdTodo</span><span class="o">,</span> <span class="n">TodoResource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span> <span class="c1">// (5)</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">createdTodoResponse</span><span class="o">;</span> <span class="c1">// (6)</span>
</span><span class="hll">    <span class="o">}</span>
</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">メソッドがPOSTのリクエストを処理するために、<tt class="docutils literal"><span class="pre">method</span></tt>属性に<tt class="docutils literal"><span class="pre">RequestMethod.POST</span></tt>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">応答するHTTPステータスコードを<tt class="docutils literal"><span class="pre">&#64;ResponseStatus</span></tt>アノテーションに指定する。</div>
<div class="line">HTTPステータスとして、&#8221;201 Created&#8221;を設定するため、value属性には<tt class="docutils literal"><span class="pre">HttpStatus.CREATED</span></tt>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">HTTPリクエストのBody(JSON)をJavaBeanにマッピングするために、<tt class="docutils literal"><span class="pre">&#64;RequestBody</span></tt>アノテーションをマッピング対象の<tt class="docutils literal"><span class="pre">TodoResource</span></tt>クラスに付与する。</div>
<div class="line">また、入力チェックするために<tt class="docutils literal"><span class="pre">&#64;Validated</span></tt>も付与する。例外ハンドリングは別途行う必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">TodoResource</span></tt>を<tt class="docutils literal"><span class="pre">Todo</span></tt>クラスに変換後、<tt class="docutils literal"><span class="pre">TodoService.create</span></tt>を実行し、Todoリソースを新規作成する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">TodoService.create</span></tt>によって新規作成された<tt class="docutils literal"><span class="pre">Todo</span></tt>オブジェクトを、応答するJSONを表現する<tt class="docutils literal"><span class="pre">TodoResource</span></tt>型に変換する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">TodoResource</span></tt>オブジェクトを返却することで、<tt class="file docutils literal"><span class="pre">spring-mvc-rest.xml</span></tt>に定義した<tt class="docutils literal"><span class="pre">MappingJacksonHttpMessageConverter</span></tt>により、<tt class="docutils literal"><span class="pre">{&quot;todoId&quot;</span> <span class="pre">:</span> <span class="pre">&quot;xxx&quot;,</span> <span class="pre">&quot;todoTitle&quot;:</span> <span class="pre">&quot;yyy&quot;,</span> <span class="pre">...}</span></tt>形式のJSONにシリアライズされる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line">HTTP Dev Clientを使用して、実装したAPIの動作確認を行う。</div>
<div class="line">Dev HTTP Clientを開いてURLに<tt class="docutils literal"><span class="pre">&quot;localhost:8080/todo-api/api/v1/todos&quot;</span></tt>を入力し、メソッドにPOSTを指定する。</div>
<div class="line">「REQUEST」の「BODY」に以下のJSONを入力する。</div>
</div>
<blockquote>
<div><div class="highlight-json"><div class="highlight"><pre><span class="p">{</span>
  <span class="nt">&quot;todoTitle&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello World!&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>また、「REQUEST」の「HEADERS」の「+」ボタンでHTTPヘッダーを追加し、「<tt class="docutils literal"><span class="pre">Content-Type</span></tt>」に「<tt class="docutils literal"><span class="pre">application/json</span></tt>」を設定後、&#8221;Send&#8221;ボタンをクリックする。</p>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/post-todos1.png"><img alt="../_images/post-todos1.png" src="../_images/post-todos1.png" style="width: 100%;" /></a>
</div>
</div></blockquote>
<p>&#8220;201 Created&#8221;のHTTPステータスが返却され、「RESPONSE」の「Body」に新規作成されたTodoリソースのJSONが表示される。</p>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/post-todos2.png"><img alt="../_images/post-todos2.png" src="../_images/post-todos2.png" style="width: 100%;" /></a>
</div>
</div></blockquote>
<p>この状態で再びGET Todosを実行すると、作成したTodoリソースを含む配列が返却される。</p>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/get-todos3.png"><img alt="../_images/get-todos3.png" src="../_images/get-todos3.png" style="width: 100%;" /></a>
</div>
</div></blockquote>
</div>
<div class="section" id="id16">
<h4><a class="toc-backref" href="#id56">7.1.3.6.3. GET Todoの実装</a><a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h4>
<p>﻿<a class="reference internal" href="../TutorialTodo/index.html"><em>チュートリアル(Todoアプリケーション)</em></a>では、<tt class="docutils literal"><span class="pre">TodoService</span></tt>に一件取得用のメソッド(<tt class="docutils literal"><span class="pre">findOne</span></tt>)を作成しなかったため、
<tt class="docutils literal"><span class="pre">TodoService</span></tt>と<tt class="docutils literal"><span class="pre">TodoServiceImpl</span></tt>に以下のハイライト部を追加する。</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">TodoService.java</span></tt></li>
</ul>
<blockquote>
<div><p><tt class="docutils literal"><span class="pre">findOne</span></tt>メソッドの定義を追加する。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoService</span> <span class="o">{</span>
    <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">findAll</span><span class="o">();</span>

<span class="hll">    <span class="n">Todo</span> <span class="nf">findOne</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">);</span>
</span>
    <span class="n">Todo</span> <span class="nf">create</span><span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="o">);</span>

    <span class="n">Todo</span> <span class="nf">finish</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">);</span>

    <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">TodoServiceImpl.java</span></tt></li>
</ul>
<blockquote>
<div><p><tt class="docutils literal"><span class="pre">findOne</span></tt>メソッド呼び出し時に開始されるトランザクションを読み取り専用に設定する。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.UUID</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.BusinessException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.ResourceNotFoundException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessages</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">todo.domain.repository.todo.TodoRepository</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>
    <span class="nd">@Inject</span>
    <span class="n">TodoRepository</span> <span class="n">todoRepository</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">MAX_UNFINISHED_COUNT</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>

    <span class="nd">@Override</span>
<span class="hll">    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
</span>    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">findOne</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">todo</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ResultMessages</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">();</span>
            <span class="n">messages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ResultMessage</span>
                    <span class="o">.</span><span class="na">fromText</span><span class="o">(</span><span class="s">&quot;[E404] The requested Todo is not found. (id=&quot;</span>
                            <span class="o">+</span> <span class="n">todoId</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="o">));</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ResourceNotFoundException</span><span class="o">(</span><span class="n">messages</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">todo</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">findAll</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">todoRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">create</span><span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">unfinishedCount</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="o">.</span><span class="na">countByFinished</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">unfinishedCount</span> <span class="o">&gt;=</span> <span class="n">MAX_UNFINISHED_COUNT</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ResultMessages</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">();</span>
            <span class="n">messages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ResultMessage</span>
                    <span class="o">.</span><span class="na">fromText</span><span class="o">(</span><span class="s">&quot;[E001] The count of un-finished Todo must not be over &quot;</span>
                            <span class="o">+</span> <span class="n">MAX_UNFINISHED_COUNT</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span><span class="o">));</span>

            <span class="k">throw</span> <span class="k">new</span> <span class="nf">BusinessException</span><span class="o">(</span><span class="n">messages</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">String</span> <span class="n">todoId</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
        <span class="n">Date</span> <span class="n">createdAt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">();</span>

        <span class="n">todo</span><span class="o">.</span><span class="na">setTodoId</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span>
        <span class="n">todo</span><span class="o">.</span><span class="na">setCreatedAt</span><span class="o">(</span><span class="n">createdAt</span><span class="o">);</span>
        <span class="n">todo</span><span class="o">.</span><span class="na">setFinished</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

        <span class="n">todoRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">todo</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">finish</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">findOne</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">todo</span><span class="o">.</span><span class="na">isFinished</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">ResultMessages</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">();</span>
            <span class="n">messages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ResultMessage</span>
                    <span class="o">.</span><span class="na">fromText</span><span class="o">(</span><span class="s">&quot;[E002] The requested Todo is already finished. (id=&quot;</span>
                            <span class="o">+</span> <span class="n">todoId</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="o">));</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">BusinessException</span><span class="o">(</span><span class="n">messages</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">todo</span><span class="o">.</span><span class="na">setFinished</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">todoRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">todo</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">findOne</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span>
        <span class="n">todoRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<p>Todoリソースを一件取得するAPI(GET Todo)の処理を、<tt class="docutils literal"><span class="pre">TodoRestController</span></tt>の<tt class="docutils literal"><span class="pre">getTodo</span></tt>メソッドに実装する。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.dozer.Mapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="o">;</span>
<span class="hll"><span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PathVariable</span><span class="o">;</span>
</span><span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestBody</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ResponseBody</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ResponseStatus</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">todo.domain.service.todo.TodoService</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;todos&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="o">{</span>
    <span class="nd">@Inject</span>
    <span class="n">TodoService</span> <span class="n">todoService</span><span class="o">;</span>
    <span class="nd">@Inject</span>
    <span class="n">Mapper</span> <span class="n">beanMapper</span><span class="o">;</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">TodoResource</span><span class="o">&gt;</span> <span class="n">getTodos</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span> <span class="o">=</span> <span class="n">todoService</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">TodoResource</span><span class="o">&gt;</span> <span class="n">todoResources</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span> <span class="o">:</span> <span class="n">todos</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">todoResources</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">todo</span><span class="o">,</span> <span class="n">TodoResource</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">todoResources</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">CREATED</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">TodoResource</span> <span class="nf">postTodos</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nd">@Validated</span> <span class="n">TodoResource</span> <span class="n">todoResource</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Todo</span> <span class="n">createdTodo</span> <span class="o">=</span> <span class="n">todoService</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">beanMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">todoResource</span><span class="o">,</span> <span class="n">Todo</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="n">TodoResource</span> <span class="n">createdTodoResponse</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">createdTodo</span><span class="o">,</span> <span class="n">TodoResource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">createdTodoResponse</span><span class="o">;</span>
    <span class="o">}</span>

<span class="hll">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span><span class="o">=</span><span class="s">&quot;{todoId}&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span> <span class="c1">// (1)</span>
</span><span class="hll">    <span class="nd">@ResponseBody</span>
</span><span class="hll">    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">TodoResource</span> <span class="nf">getTodo</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&quot;todoId&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (2)</span>
</span><span class="hll">        <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">todoService</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span> <span class="c1">// (3)</span>
</span><span class="hll">        <span class="n">TodoResource</span> <span class="n">todoResource</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">todo</span><span class="o">,</span> <span class="n">TodoResource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">todoResource</span><span class="o">;</span>
</span><span class="hll">    <span class="o">}</span>
</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスから<tt class="docutils literal"><span class="pre">todoId</span></tt>を取得するために、<tt class="docutils literal"><span class="pre">&#64;RequestMapping</span></tt>アノテーションの<tt class="docutils literal"><span class="pre">value</span></tt>属性にパス変数を指定する。</div>
<div class="line">メソッドがGETのリクエストを処理するために、<tt class="docutils literal"><span class="pre">method</span></tt>属性に<tt class="docutils literal"><span class="pre">RequestMethod.GET</span></tt>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">&#64;PathVariable</span></tt>アノテーションの<tt class="docutils literal"><span class="pre">value</span></tt>属性に、<tt class="docutils literal"><span class="pre">todoId</span></tt>を取得するためのパス変数名を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パス変数から取得した<tt class="docutils literal"><span class="pre">todoId</span></tt>を使用して、Todoリソースを一件を取得する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line">HTTP Dev Clientを使用して、実装したAPIの動作確認を行う。</div>
<div class="line">Dev HTTP Clientを開いてURLに<tt class="docutils literal"><span class="pre">&quot;localhost:8080/todo-api/api/v1/todos/{todoId}</span></tt>&#8220;を入力し、メソッドにGETを指定する。</div>
<div class="line"><tt class="docutils literal"><span class="pre">{todoId}</span></tt>の部分は実際のIDを入れる必要があるので、POST TodosまたはGET Todosを実行してResponse中の<tt class="docutils literal"><span class="pre">todoId</span></tt>をコピーして貼り付けてから、&#8221;Send&#8221;ボタンをクリックする。</div>
</div>
<p>&#8220;200 OK&#8221;のHTTPステータスが返却され、「RESPONSE」の「Body」に指定したTodoリソースのJSONが表示される。</p>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/get-todo1.png"><img alt="../_images/get-todo1.png" src="../_images/get-todo1.png" style="width: 100%;" /></a>
</div>
</div></blockquote>
</div>
<div class="section" id="id17">
<h4><a class="toc-backref" href="#id57">7.1.3.6.4. PUT Todoの実装</a><a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h4>
<p>Todoリソースを一件更新(完了状態へ更新)するAPI(PUT Todo)の処理を、<tt class="docutils literal"><span class="pre">TodoRestController</span></tt>の<tt class="docutils literal"><span class="pre">putTodo</span></tt>メソッドに実装する。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.dozer.Mapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PathVariable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestBody</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ResponseBody</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ResponseStatus</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">todo.domain.service.todo.TodoService</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;todos&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="o">{</span>
    <span class="nd">@Inject</span>
    <span class="n">TodoService</span> <span class="n">todoService</span><span class="o">;</span>
    <span class="nd">@Inject</span>
    <span class="n">Mapper</span> <span class="n">beanMapper</span><span class="o">;</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">TodoResource</span><span class="o">&gt;</span> <span class="n">getTodos</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span> <span class="o">=</span> <span class="n">todoService</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">TodoResource</span><span class="o">&gt;</span> <span class="n">todoResources</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span> <span class="o">:</span> <span class="n">todos</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">todoResources</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">todo</span><span class="o">,</span> <span class="n">TodoResource</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">todoResources</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">CREATED</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">TodoResource</span> <span class="nf">postTodos</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nd">@Validated</span> <span class="n">TodoResource</span> <span class="n">todoResource</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Todo</span> <span class="n">createdTodo</span> <span class="o">=</span> <span class="n">todoService</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">beanMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">todoResource</span><span class="o">,</span> <span class="n">Todo</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="n">TodoResource</span> <span class="n">createdTodoResponse</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">createdTodo</span><span class="o">,</span> <span class="n">TodoResource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">createdTodoResponse</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span><span class="o">=</span><span class="s">&quot;{todoId}&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">TodoResource</span> <span class="nf">getTodo</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&quot;todoId&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">todoService</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span>
        <span class="n">TodoResource</span> <span class="n">todoResource</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">todo</span><span class="o">,</span> <span class="n">TodoResource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">todoResource</span><span class="o">;</span>
    <span class="o">}</span>

<span class="hll">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span><span class="o">=</span><span class="s">&quot;{todoId}&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">PUT</span><span class="o">)</span> <span class="c1">// (1)</span>
</span><span class="hll">    <span class="nd">@ResponseBody</span>
</span><span class="hll">    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">TodoResource</span> <span class="nf">putTodo</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&quot;todoId&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (2)</span>
</span><span class="hll">        <span class="n">Todo</span> <span class="n">finishedTodo</span> <span class="o">=</span> <span class="n">todoService</span><span class="o">.</span><span class="na">finish</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span> <span class="c1">// (3)</span>
</span><span class="hll">        <span class="n">TodoResource</span> <span class="n">finishedTodoResource</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">finishedTodo</span><span class="o">,</span> <span class="n">TodoResource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">finishedTodoResource</span><span class="o">;</span>
</span><span class="hll">    <span class="o">}</span>
</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスから<tt class="docutils literal"><span class="pre">todoId</span></tt>を取得するために、<tt class="docutils literal"><span class="pre">&#64;RequestMapping</span></tt>アノテーションの<tt class="docutils literal"><span class="pre">value</span></tt>属性にパス変数を指定する。</div>
<div class="line">メソッドがGETのリクエストを処理するために、<tt class="docutils literal"><span class="pre">method</span></tt>属性に<tt class="docutils literal"><span class="pre">RequestMethod.GET</span></tt>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">&#64;PathVariable</span></tt>アノテーションの<tt class="docutils literal"><span class="pre">value</span></tt>属性に、<tt class="docutils literal"><span class="pre">todoId</span></tt>を取得するためのパス変数名を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パス変数から取得した<tt class="docutils literal"><span class="pre">todoId</span></tt>を使用して、Todoリソースを完了状態へ更新する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line">HTTP Dev Clientを使用して、実装したAPIの動作確認を行う。</div>
<div class="line">Dev HTTP Clientを開いてURLに<tt class="docutils literal"><span class="pre">&quot;localhost:8080/todo-api/api/v1/todos/{todoId}&quot;</span></tt>を入力し、メソッドにPUTを指定する。</div>
<div class="line"><tt class="docutils literal"><span class="pre">{todoId}</span></tt>の部分は実際のIDを入れる必要があるので、POST TodosまたはGET Todosを実行してResponse中の<tt class="docutils literal"><span class="pre">todoId</span></tt>をコピーして貼り付けてから、&#8221;Send&#8221;ボタンをクリックする。</div>
</div>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/put-todo1.png"><img alt="../_images/put-todo1.png" src="../_images/put-todo1.png" style="width: 100%;" /></a>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">&#8220;200 OK&#8221;のHTTPステータスが返却され、「RESPONSE」の「Body」に更新されたTodoリソースのJSONが表示される。</div>
<div class="line"><tt class="docutils literal"><span class="pre">finished</span></tt>が<tt class="docutils literal"><span class="pre">true</span></tt>に更新されている。</div>
</div>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/put-todo2.png"><img alt="../_images/put-todo2.png" src="../_images/put-todo2.png" style="width: 100%;" /></a>
</div>
</div></blockquote>
</div>
<div class="section" id="id18">
<h4><a class="toc-backref" href="#id58">7.1.3.6.5. DELETE Todoの実装</a><a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h4>
<p>最後に、Todoリソースを一件削除するAPI(DELETE Todo)の処理を、<tt class="docutils literal"><span class="pre">TodoRestController</span></tt>の<tt class="docutils literal"><span class="pre">deleteTodo</span></tt>メソッドに実装する。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.dozer.Mapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PathVariable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestBody</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ResponseBody</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ResponseStatus</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">todo.domain.service.todo.TodoService</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;todos&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="o">{</span>
    <span class="nd">@Inject</span>
    <span class="n">TodoService</span> <span class="n">todoService</span><span class="o">;</span>
    <span class="nd">@Inject</span>
    <span class="n">Mapper</span> <span class="n">beanMapper</span><span class="o">;</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">TodoResource</span><span class="o">&gt;</span> <span class="n">getTodos</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span> <span class="o">=</span> <span class="n">todoService</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">TodoResource</span><span class="o">&gt;</span> <span class="n">todoResources</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span> <span class="o">:</span> <span class="n">todos</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">todoResources</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">todo</span><span class="o">,</span> <span class="n">TodoResource</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">todoResources</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">CREATED</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">TodoResource</span> <span class="nf">postTodos</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nd">@Validated</span> <span class="n">TodoResource</span> <span class="n">todoResource</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Todo</span> <span class="n">createdTodo</span> <span class="o">=</span> <span class="n">todoService</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">beanMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">todoResource</span><span class="o">,</span> <span class="n">Todo</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="n">TodoResource</span> <span class="n">createdTodoResponse</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">createdTodo</span><span class="o">,</span> <span class="n">TodoResource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">createdTodoResponse</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span><span class="o">=</span><span class="s">&quot;{todoId}&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">TodoResource</span> <span class="nf">getTodo</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&quot;todoId&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">todoService</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span>
        <span class="n">TodoResource</span> <span class="n">todoResource</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">todo</span><span class="o">,</span> <span class="n">TodoResource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">todoResource</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span><span class="o">=</span><span class="s">&quot;{todoId}&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">PUT</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">TodoResource</span> <span class="nf">putTodo</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&quot;todoId&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Todo</span> <span class="n">finishedTodo</span> <span class="o">=</span> <span class="n">todoService</span><span class="o">.</span><span class="na">finish</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span>
        <span class="n">TodoResource</span> <span class="n">finishedTodoResource</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">finishedTodo</span><span class="o">,</span> <span class="n">TodoResource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">finishedTodoResource</span><span class="o">;</span>
    <span class="o">}</span>

<span class="hll">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span><span class="o">=</span><span class="s">&quot;{todoId}&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">DELETE</span><span class="o">)</span> <span class="c1">// (1)</span>
</span><span class="hll">    <span class="nd">@ResponseBody</span>
</span><span class="hll">    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">NO_CONTENT</span><span class="o">)</span> <span class="c1">// (2)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteTodo</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&quot;todoId&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (3)</span>
</span><span class="hll">        <span class="n">todoService</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span> <span class="c1">// (4)</span>
</span><span class="hll">    <span class="o">}</span>
</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスから<tt class="docutils literal"><span class="pre">todoId</span></tt>を取得するために、<tt class="docutils literal"><span class="pre">&#64;RequestMapping</span></tt>アノテーションの<tt class="docutils literal"><span class="pre">value</span></tt>属性にパス変数を指定する。</div>
<div class="line">メソッドがDELETEのリクエストを処理するために、<tt class="docutils literal"><span class="pre">method</span></tt>属性に<tt class="docutils literal"><span class="pre">RequestMethod.DELETE</span></tt>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">応答するHTTPステータスコードを<tt class="docutils literal"><span class="pre">&#64;ResponseStatus</span></tt>アノテーションに指定する。</div>
<div class="line">HTTPステータスとして、&#8221;204 No Content&#8221;を設定するため、value属性には<tt class="docutils literal"><span class="pre">HttpStatus.NO_CONTENT</span></tt>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">DELETEの場合は返却するコンテンツがないため、返り値の型を<tt class="docutils literal"><span class="pre">void</span></tt>とする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パス変数から取得した<tt class="docutils literal"><span class="pre">todoId</span></tt>を使用して、Todoリソースを削除する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line">HTTP Dev Clientを使用して、実装したAPIの動作確認を行う。</div>
<div class="line">Dev HTTP Clientを開いてURLに<tt class="docutils literal"><span class="pre">&quot;localhost:8080/todo-api/api/v1/todos/{todoId}&quot;</span></tt>を入力し、メソッドにDELETEを指定する。</div>
<div class="line"><tt class="docutils literal"><span class="pre">{todoId}</span></tt>の部分は実際のIDを入れる必要があるので、POST TodosまたはGET Todosを実行してResponse中の<tt class="docutils literal"><span class="pre">todoId</span></tt>をコピーして貼り付けてから、&#8221;Send&#8221;ボタンをクリックする。</div>
</div>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/delete-todo1.png"><img alt="../_images/delete-todo1.png" src="../_images/delete-todo1.png" style="width: 100%;" /></a>
</div>
</div></blockquote>
<p>&#8220;204 No Content&#8221;のHTTPステータスが返却され、「RESPONSE」の「Body」は空である。</p>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/delete-todo2.png"><img alt="../_images/delete-todo2.png" src="../_images/delete-todo2.png" style="width: 100%;" /></a>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">Dev HTTP ClientのURLに<tt class="docutils literal"><span class="pre">&quot;localhost:8080/todo-api/api/v1/todos&quot;</span></tt>を入力し、メソッドにGETを指定してから&#8221;Send&#8221;ボタンをクリックする。</div>
<div class="line">Todoリソースが削除されている事が確認できる。</div>
</div>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/delete-todo3.png"><img alt="../_images/delete-todo3.png" src="../_images/delete-todo3.png" style="width: 100%;" /></a>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="id19">
<h3><a class="toc-backref" href="#id59">7.1.3.7. 例外ハンドリングの実装</a><a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">本チュートリアルでは、例外ハンドリングの実装方法をイメージしやすくするため、本ガイドラインで推奨している実装よりシンプルな実装にしてある。</div>
<div class="line">実際の例外ハンドリングは、<a class="reference internal" href="../ArchitectureInDetail/REST.html"><em>RESTful Web Service</em></a>で<strong>説明されている方法でハンドリングを行うことを強く推奨する</strong>。</div>
</div>
<div class="section" id="id20">
<h4><a class="toc-backref" href="#id60">7.1.3.7.1. ドメイン層の実装を変更</a><a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">本チュートリアルでは、エラーコードをキーにプロパティファイルからエラーメッセージを取得する。</div>
<div class="line">そのため、例外ハンドリングの実装を行う前に、<a class="reference internal" href="../TutorialTodo/index.html"><em>チュートリアル(Todoアプリケーション)</em></a>で作成したServiceクラスの実装を以下のように変更する。</div>
</div>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">TodoServiceImpl.java</span></tt></li>
</ul>
<blockquote>
<div><p>ハードコーディングされていたエラーメッセージの代わりに、エラーコードを指定するように変更する。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.UUID</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.BusinessException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.ResourceNotFoundException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessages</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">todo.domain.repository.todo.TodoRepository</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>
    <span class="nd">@Inject</span>
    <span class="n">TodoRepository</span> <span class="n">todoRepository</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">MAX_UNFINISHED_COUNT</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">findOne</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">todo</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ResultMessages</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">();</span>
<span class="hll">            <span class="n">messages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;E404&quot;</span><span class="o">,</span> <span class="n">todoId</span><span class="o">);</span>
</span>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ResourceNotFoundException</span><span class="o">(</span><span class="n">messages</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">todo</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">findAll</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">todoRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">create</span><span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">unfinishedCount</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="o">.</span><span class="na">countByFinished</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">unfinishedCount</span> <span class="o">&gt;=</span> <span class="n">MAX_UNFINISHED_COUNT</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ResultMessages</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">();</span>
<span class="hll">            <span class="n">messages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;E001&quot;</span><span class="o">,</span> <span class="n">MAX_UNFINISHED_COUNT</span><span class="o">);</span>
</span>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">BusinessException</span><span class="o">(</span><span class="n">messages</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">String</span> <span class="n">todoId</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
        <span class="n">Date</span> <span class="n">createdAt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">();</span>

        <span class="n">todo</span><span class="o">.</span><span class="na">setTodoId</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span>
        <span class="n">todo</span><span class="o">.</span><span class="na">setCreatedAt</span><span class="o">(</span><span class="n">createdAt</span><span class="o">);</span>
        <span class="n">todo</span><span class="o">.</span><span class="na">setFinished</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

        <span class="n">todoRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">todo</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">finish</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">findOne</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">todo</span><span class="o">.</span><span class="na">isFinished</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">ResultMessages</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">();</span>
<span class="hll">            <span class="n">messages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;E002&quot;</span><span class="o">,</span> <span class="n">todoId</span><span class="o">);</span>
</span>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">BusinessException</span><span class="o">(</span><span class="n">messages</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">todo</span><span class="o">.</span><span class="na">setFinished</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">todoRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">todo</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">findOne</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span>
        <span class="n">todoRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="id21">
<h4><a class="toc-backref" href="#id61">7.1.3.7.2. エラーメッセージの定義</a><a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">本チュートリアルでは、エラーコードをキーにプロパティファイルからエラーメッセージを取得する。</div>
<div class="line">そのため、例外ハンドリングの実装を行う前に、エラーコードに対応するエラーメッセージを、メッセージ用のプロパティファイルに定義する。</div>
</div>
<p>処理結果用のエラーコードに対応するエラーメッセージを、メッセージ用のプロパティファイル(<tt class="file docutils literal"><span class="pre">src/main/resources/i18n/application-messages.properties</span></tt>)に定義する。</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">application-messages.properties</span></tt></li>
</ul>
<blockquote>
<div><p>ハイライトした部分のメッセージ定義を追加する。</p>
<div class="highlight-properties"><div class="highlight"><pre><span class="na">e.xx.fw.5001</span> <span class="o">=</span> <span class="s">Resource not found.</span>

<span class="na">e.xx.fw.7001</span> <span class="o">=</span> <span class="s">Illegal screen flow detected!</span>
<span class="na">e.xx.fw.7002</span> <span class="o">=</span> <span class="s">CSRF attack detected!</span>

<span class="na">e.xx.fw.8001</span> <span class="o">=</span> <span class="s">Business error occurred!</span>

<span class="na">e.xx.fw.9001</span> <span class="o">=</span> <span class="s">System error occurred!</span>
<span class="na">e.xx.fw.9002</span> <span class="o">=</span> <span class="s">Data Access error!</span>

<span class="hll"><span class="na">E001</span> <span class="o">=</span> <span class="s">[E001] The count of un-finished Todo must not be over {0}.</span>
</span><span class="hll"><span class="na">E002</span> <span class="o">=</span> <span class="s">[E002] The requested Todo is already finished. (id={0})</span>
</span><span class="hll"><span class="na">E400</span> <span class="o">=</span> <span class="s">[E400] The requested Todo contains invalid values.</span>
</span><span class="hll"><span class="na">E404</span> <span class="o">=</span> <span class="s">[E404] The requested Todo is not found. (id={0})</span>
</span><span class="hll"><span class="na">E500</span> <span class="o">=</span> <span class="s">[E500] System error occurred.</span>
</span><span class="hll"><span class="na">E999</span> <span class="o">=</span> <span class="s">[E999] Error occurred. Caused by : {0}</span>
</span></pre></div>
</div>
<div class="figure">
<img alt="../_images/application-messages.png" src="../_images/application-messages.png" />
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">入力チェック用のエラーコードに対応するエラーメッセージを、Bean Validationのメッセージ用のプロパティファイル(<tt class="file docutils literal"><span class="pre">src/main/resources/ValidationMessages.properties</span></tt>)に定義する。</div>
<div class="line"><br /></div>
</div>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">ValidationMessages.properties</span></tt></li>
</ul>
<blockquote>
<div><div class="line-block">
<div class="line">デフォルトのメッセージは、メッセージの中に項目名が含まれないため、デフォルトのメッセージ定義を変更する。</div>
<div class="line">本チュートリアルでは、<tt class="docutils literal"><span class="pre">TodoResource</span></tt>クラスで使用しているルール(<tt class="docutils literal"><span class="pre">&#64;NotNull</span></tt>と<tt class="docutils literal"><span class="pre">&#64;Size</span></tt>)に対応するメッセージのみ定義する。</div>
</div>
<div class="highlight-properties"><div class="highlight"><pre><span class="hll"><span class="na">javax.validation.constraints.NotNull.message</span> <span class="o">=</span> <span class="s">{0} may not be null.</span>
</span><span class="hll"><span class="na">javax.validation.constraints.Size.message</span>    <span class="o">=</span> <span class="s">{0} size must be between {min} and {max}.</span>
</span></pre></div>
</div>
<div class="figure">
<img alt="../_images/validation-messages.png" src="../_images/validation-messages.png" />
</div>
</div></blockquote>
</div>
<div class="section" id="id22">
<h4><a class="toc-backref" href="#id62">7.1.3.7.3. エラーハンドリング用のクラスを格納するパッケージの作成</a><a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">エラーハンドリング用のクラスを格納するためのパッケージを作成する。</div>
<div class="line">本チュートリアルでは、<tt class="docutils literal"><span class="pre">todo.api.common.error</span></tt>をエラーハンドリング用のクラスを格納するためのパッケージとする。</div>
</div>
<blockquote>
<div><div class="figure">
<img alt="../_images/exception-package.png" src="../_images/exception-package.png" />
</div>
</div></blockquote>
</div>
<div class="section" id="id23">
<h4><a class="toc-backref" href="#id63">7.1.3.7.4. REST APIのエラーハンドリングを行うクラスの作成</a><a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">REST APIのエラーハンドリングは、Spring MVCから提供されている<tt class="docutils literal"><span class="pre">org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler</span></tt>を継承したクラスを作成し、<tt class="docutils literal"><span class="pre">&#64;ControllerAdvice</span></tt>アノテーションを付与する方法でハンドリングする事を推奨する。</div>
<div class="line">以下に、<tt class="docutils literal"><span class="pre">ResponseEntityExceptionHandler</span></tt>を継承した<tt class="docutils literal"><span class="pre">todo.api.common.error.RestGlobalExceptionHandler</span></tt>クラスを作成する。</div>
</div>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">RestGlobalExceptionHandler.java</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">error</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ControllerAdvice</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler</span><span class="o">;</span>

<span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RestGlobalExceptionHandler</span> <span class="kd">extends</span> <span class="n">ResponseEntityExceptionHandler</span> <span class="o">{</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="figure">
<img alt="../_images/exception-handlingclass.png" src="../_images/exception-handlingclass.png" />
</div>
</div></blockquote>
</div>
<div class="section" id="rest-apijavabean">
<h4><a class="toc-backref" href="#id64">7.1.3.7.5. REST APIのエラー情報を保持するJavaBeanの作成</a><a class="headerlink" href="#rest-apijavabean" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">REST APIで発生したエラー情報を保持するクラスとして、<tt class="docutils literal"><span class="pre">ApiError</span></tt>クラスを<tt class="docutils literal"><span class="pre">todo.api.common.error</span></tt>パッケージに作成する。</div>
<div class="line"><tt class="docutils literal"><span class="pre">ApiError</span></tt>クラスがJSONに変換されて、クライアントに応答される。</div>
</div>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">ApiError.java</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">error</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.codehaus.jackson.map.annotate.JsonSerialize</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.codehaus.jackson.map.annotate.JsonSerialize.Inclusion</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiError</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">code</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">message</span><span class="o">;</span>

    <span class="nd">@JsonSerialize</span><span class="o">(</span><span class="n">include</span> <span class="o">=</span> <span class="n">Inclusion</span><span class="o">.</span><span class="na">NON_EMPTY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">target</span><span class="o">;</span>

    <span class="nd">@JsonSerialize</span><span class="o">(</span><span class="n">include</span> <span class="o">=</span> <span class="n">Inclusion</span><span class="o">.</span><span class="na">NON_EMPTY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ApiError</span><span class="o">&gt;</span> <span class="n">details</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="kd">public</span> <span class="nf">ApiError</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">,</span> <span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">message</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">ApiError</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">,</span> <span class="n">String</span> <span class="n">message</span><span class="o">,</span> <span class="n">String</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">code</span> <span class="o">=</span> <span class="n">code</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">code</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getMessage</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">message</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTarget</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">target</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ApiError</span><span class="o">&gt;</span> <span class="n">getDetails</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">details</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addDetail</span><span class="o">(</span><span class="n">ApiError</span> <span class="n">detail</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">details</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">detail</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="figure">
<img alt="../_images/exception-apierror.png" src="../_images/exception-apierror.png" />
</div>
</div></blockquote>
</div>
<div class="section" id="httpbody">
<h4><a class="toc-backref" href="#id65">7.1.3.7.6. HTTPレスポンスBODYにエラー情報を出力するための実装</a><a class="headerlink" href="#httpbody" title="Permalink to this headline">¶</a></h4>
<p><tt class="docutils literal"><span class="pre">ResponseEntityExceptionHandler</span></tt>はデフォルトではHTTPステータス(400や500など)の設定のみを行い、HTTPレスポンスのBODYは設定しない。
そのため、<tt class="docutils literal"><span class="pre">handleExceptionInternal</span></tt>メソッドを以下のようにオーバーライドして、BODYを出力するように実装する。</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">RestGlobalExceptionHandler.java</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">error</span><span class="o">;</span>

<span class="hll"><span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>
</span>
<span class="hll"><span class="kn">import</span> <span class="nn">org.springframework.context.MessageSource</span><span class="o">;</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">org.springframework.http.HttpHeaders</span><span class="o">;</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="o">;</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">org.springframework.http.ResponseEntity</span><span class="o">;</span>
</span><span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ControllerAdvice</span><span class="o">;</span>
<span class="hll"><span class="kn">import</span> <span class="nn">org.springframework.web.context.request.WebRequest</span><span class="o">;</span>
</span><span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler</span><span class="o">;</span>

<span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RestGlobalExceptionHandler</span> <span class="kd">extends</span> <span class="n">ResponseEntityExceptionHandler</span> <span class="o">{</span>

<span class="hll">    <span class="nd">@Inject</span>
</span><span class="hll">    <span class="n">MessageSource</span> <span class="n">messageSource</span><span class="o">;</span>
</span>
<span class="hll">    <span class="nd">@Override</span>
</span><span class="hll">    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">handleExceptionInternal</span><span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">,</span>
</span><span class="hll">            <span class="n">Object</span> <span class="n">body</span><span class="o">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="o">,</span> <span class="n">HttpStatus</span> <span class="n">status</span><span class="o">,</span>
</span><span class="hll">            <span class="n">WebRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
</span><span class="hll">        <span class="n">Object</span> <span class="n">responseBody</span> <span class="o">=</span> <span class="n">body</span><span class="o">;</span>
</span><span class="hll">        <span class="k">if</span> <span class="o">(</span><span class="n">body</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="hll">            <span class="n">responseBody</span> <span class="o">=</span> <span class="n">createApiError</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="s">&quot;E999&quot;</span><span class="o">,</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span><span class="hll">        <span class="o">}</span>
</span><span class="hll">        <span class="k">return</span> <span class="k">new</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;(</span><span class="n">responseBody</span><span class="o">,</span> <span class="n">headers</span><span class="o">,</span> <span class="n">status</span><span class="o">);</span>
</span><span class="hll">    <span class="o">}</span>
</span>
<span class="hll">    <span class="kd">private</span> <span class="n">ApiError</span> <span class="nf">createApiError</span><span class="o">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorCode</span><span class="o">,</span>
</span><span class="hll">            <span class="n">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class="hll">        <span class="k">return</span> <span class="k">new</span> <span class="nf">ApiError</span><span class="o">(</span><span class="n">errorCode</span><span class="o">,</span> <span class="n">messageSource</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(</span><span class="n">errorCode</span><span class="o">,</span>
</span><span class="hll">                <span class="n">args</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getLocale</span><span class="o">()));</span>
</span><span class="hll">    <span class="o">}</span>
</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">上記実装を行う事で、<tt class="docutils literal"><span class="pre">ResponseEntityExceptionHandler</span></tt>でハンドリングされる例外については、HTTPレスポンスBODYにエラー情報が出力される。</div>
<div class="line"><tt class="docutils literal"><span class="pre">ResponseEntityExceptionHandler</span></tt>でハンドリングされる例外については、<a class="reference internal" href="../ArchitectureInDetail/ExceptionHandling.html#exception-handling-appendix-defaulthandlerexceptionresolver-label"><em>DefaultHandlerExceptionResolverで設定されるHTTPレスポンスコードについて</em></a>を参照されたい。</div>
</div>
<div class="line-block">
<div class="line">HTTP Dev Clientを使用して、実装したエラーハンドリングの動作確認を行う。</div>
<div class="line">Dev HTTP Clientを開いてURLに<tt class="docutils literal"><span class="pre">&quot;localhost:8080/todo-api/api/v1/todos&quot;</span></tt>を入力し、メソッドにPUTを指定してから、&#8221;Send&#8221;ボタンをクリックする。</div>
</div>
<p>&#8220;405 Method Not Allowed&#8221;のHTTPステータスが返却され、「RESPONSE」の「Body」には、エラー情報のJSONが表示される。</p>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/exception-genericerror.png"><img alt="../_images/exception-genericerror.png" src="../_images/exception-genericerror.png" style="width: 100%;" /></a>
</div>
</div></blockquote>
</div>
<div class="section" id="id24">
<h4><a class="toc-backref" href="#id66">7.1.3.7.7. 入力エラーのエラーハンドリングの実装</a><a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h4>
<p>入力エラーの種類は、</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">org.springframework.web.bind.MethodArgumentNotValidException</span></tt></li>
<li><tt class="docutils literal"><span class="pre">org.springframework.validation.BindException</span></tt></li>
<li><tt class="docutils literal"><span class="pre">org.springframework.http.converter.HttpMessageNotReadableException</span></tt></li>
<li><tt class="docutils literal"><span class="pre">org.springframework.beans.TypeMismatchException</span></tt></li>
</ul>
<p>となる。</p>
<div class="line-block">
<div class="line">本チュートリアルでは、<tt class="docutils literal"><span class="pre">MethodArgumentNotValidException</span></tt>のエラーハンドリングの実装を行う。</div>
<div class="line"><tt class="docutils literal"><span class="pre">MethodArgumentNotValidException</span></tt>は、HTTPリクエストBODYに格納されているデータに入力エラーがあった場合に発生する例外である。</div>
</div>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">RestGlobalExceptionHandler.java</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">error</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.context.MessageSource</span><span class="o">;</span>
<span class="hll"><span class="kn">import</span> <span class="nn">org.springframework.context.support.DefaultMessageSourceResolvable</span><span class="o">;</span>
</span><span class="kn">import</span> <span class="nn">org.springframework.http.HttpHeaders</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.ResponseEntity</span><span class="o">;</span>
<span class="hll"><span class="kn">import</span> <span class="nn">org.springframework.validation.FieldError</span><span class="o">;</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">org.springframework.validation.ObjectError</span><span class="o">;</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">org.springframework.web.bind.MethodArgumentNotValidException</span><span class="o">;</span>
</span><span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ControllerAdvice</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.context.request.WebRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler</span><span class="o">;</span>

<span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RestGlobalExceptionHandler</span> <span class="kd">extends</span> <span class="n">ResponseEntityExceptionHandler</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">MessageSource</span> <span class="n">messageSource</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">handleExceptionInternal</span><span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">,</span>
            <span class="n">Object</span> <span class="n">body</span><span class="o">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="o">,</span> <span class="n">HttpStatus</span> <span class="n">status</span><span class="o">,</span>
            <span class="n">WebRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Object</span> <span class="n">responseBody</span> <span class="o">=</span> <span class="n">body</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">body</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">responseBody</span> <span class="o">=</span> <span class="n">createApiError</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="s">&quot;E999&quot;</span><span class="o">,</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;(</span><span class="n">responseBody</span><span class="o">,</span> <span class="n">headers</span><span class="o">,</span> <span class="n">status</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">ApiError</span> <span class="nf">createApiError</span><span class="o">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorCode</span><span class="o">,</span>
            <span class="n">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ApiError</span><span class="o">(</span><span class="n">errorCode</span><span class="o">,</span> <span class="n">messageSource</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(</span><span class="n">errorCode</span><span class="o">,</span>
                <span class="n">args</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getLocale</span><span class="o">()));</span>
    <span class="o">}</span>

<span class="hll">    <span class="nd">@Override</span>
</span><span class="hll">    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">handleMethodArgumentNotValid</span><span class="o">(</span>
</span><span class="hll">            <span class="n">MethodArgumentNotValidException</span> <span class="n">ex</span><span class="o">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="o">,</span>
</span><span class="hll">            <span class="n">HttpStatus</span> <span class="n">status</span><span class="o">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
</span><span class="hll">        <span class="n">ApiError</span> <span class="n">apiError</span> <span class="o">=</span> <span class="n">createApiError</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="s">&quot;E400&quot;</span><span class="o">);</span>
</span><span class="hll">        <span class="k">for</span> <span class="o">(</span><span class="n">FieldError</span> <span class="n">fieldError</span> <span class="o">:</span> <span class="n">ex</span><span class="o">.</span><span class="na">getBindingResult</span><span class="o">().</span><span class="na">getFieldErrors</span><span class="o">())</span> <span class="o">{</span>
</span><span class="hll">            <span class="n">apiError</span><span class="o">.</span><span class="na">addDetail</span><span class="o">(</span><span class="n">createApiError</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">fieldError</span><span class="o">,</span> <span class="n">fieldError</span>
</span><span class="hll">                    <span class="o">.</span><span class="na">getField</span><span class="o">()));</span>
</span><span class="hll">        <span class="o">}</span>
</span><span class="hll">        <span class="k">for</span> <span class="o">(</span><span class="n">ObjectError</span> <span class="n">objectError</span> <span class="o">:</span> <span class="n">ex</span><span class="o">.</span><span class="na">getBindingResult</span><span class="o">().</span><span class="na">getGlobalErrors</span><span class="o">())</span> <span class="o">{</span>
</span><span class="hll">            <span class="n">apiError</span><span class="o">.</span><span class="na">addDetail</span><span class="o">(</span><span class="n">createApiError</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">objectError</span><span class="o">,</span> <span class="n">objectError</span>
</span><span class="hll">                    <span class="o">.</span><span class="na">getObjectName</span><span class="o">()));</span>
</span><span class="hll">        <span class="o">}</span>
</span><span class="hll">        <span class="k">return</span> <span class="nf">handleExceptionInternal</span><span class="o">(</span><span class="n">ex</span><span class="o">,</span> <span class="n">apiError</span><span class="o">,</span> <span class="n">headers</span><span class="o">,</span> <span class="n">status</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
</span><span class="hll">    <span class="o">}</span>
</span>
<span class="hll">    <span class="kd">private</span> <span class="n">ApiError</span> <span class="nf">createApiError</span><span class="o">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="o">,</span>
</span><span class="hll">            <span class="n">DefaultMessageSourceResolvable</span> <span class="n">messageSourceResolvable</span><span class="o">,</span>
</span><span class="hll">            <span class="n">String</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
</span><span class="hll">        <span class="k">return</span> <span class="k">new</span> <span class="nf">ApiError</span><span class="o">(</span><span class="n">messageSourceResolvable</span><span class="o">.</span><span class="na">getCode</span><span class="o">(),</span> <span class="n">messageSource</span>
</span><span class="hll">                <span class="o">.</span><span class="na">getMessage</span><span class="o">(</span><span class="n">messageSourceResolvable</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getLocale</span><span class="o">()),</span> <span class="n">target</span><span class="o">);</span>
</span><span class="hll">    <span class="o">}</span>
</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">HTTP Dev Clientを使用して、実装したエラーハンドリングの動作確認を行う。</div>
<div class="line">Dev HTTP Clientを開いてURLに<tt class="docutils literal"><span class="pre">&quot;localhost:8080/todo-api/api/v1/todos&quot;</span></tt>を入力し、メソッドにPOSTを指定する。</div>
<div class="line">「REQUEST」の「BODY」に以下のJSONを入力する。</div>
</div>
<blockquote>
<div><div class="highlight-json"><div class="highlight"><pre><span class="p">{</span>
  <span class="nt">&quot;todoTitle&quot;</span><span class="p">:</span> <span class="kc">null</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>また、「REQUEST」の「HEADERS」の「+」ボタンでHTTPヘッダーを追加し、「Content-Type」に「application/json」を設定後、”Send”ボタンをクリックする。</p>
<div class="line-block">
<div class="line">&#8220;400 Bad Request&#8221;のHTTPステータスが返却され、「RESPONSE」の「Body」には、エラー情報のJSONが表示される。</div>
<div class="line"><tt class="docutils literal"><span class="pre">todoTitle</span></tt>は必須項目なので、必須エラーが発生している。</div>
</div>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/exception-inputerror.png"><img alt="../_images/exception-inputerror.png" src="../_images/exception-inputerror.png" style="width: 100%;" /></a>
</div>
</div></blockquote>
</div>
<div class="section" id="id25">
<h4><a class="toc-backref" href="#id67">7.1.3.7.8. 業務例外のエラーハンドリングの実装</a><a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h4>
<p><tt class="docutils literal"><span class="pre">RestGlobalExceptionHandler</span></tt>に<tt class="docutils literal"><span class="pre">org.terasoluna.gfw.common.exception.BusinessException</span></tt>をハンドリングするメソッドを追加して、業務例外をハンドリングする。</p>
<p>業務例外が発生した場合は、&#8221;409 Conflict&#8221;のHTTPステータスを設定する。</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">RestGlobalExceptionHandler.java</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">error</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.context.MessageSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.support.DefaultMessageSourceResolvable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpHeaders</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.ResponseEntity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.FieldError</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.ObjectError</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.MethodArgumentNotValidException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ControllerAdvice</span><span class="o">;</span>
<span class="hll"><span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ExceptionHandler</span><span class="o">;</span>
</span><span class="kn">import</span> <span class="nn">org.springframework.web.context.request.WebRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler</span><span class="o">;</span>
<span class="hll"><span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.BusinessException</span><span class="o">;</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.ResultMessagesNotificationException</span><span class="o">;</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessage</span><span class="o">;</span>
</span>
<span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RestGlobalExceptionHandler</span> <span class="kd">extends</span> <span class="n">ResponseEntityExceptionHandler</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">MessageSource</span> <span class="n">messageSource</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">handleExceptionInternal</span><span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">,</span>
            <span class="n">Object</span> <span class="n">body</span><span class="o">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="o">,</span> <span class="n">HttpStatus</span> <span class="n">status</span><span class="o">,</span>
            <span class="n">WebRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Object</span> <span class="n">responseBody</span> <span class="o">=</span> <span class="n">body</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">body</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">responseBody</span> <span class="o">=</span> <span class="n">createApiError</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="s">&quot;E999&quot;</span><span class="o">,</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;(</span><span class="n">responseBody</span><span class="o">,</span> <span class="n">headers</span><span class="o">,</span> <span class="n">status</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">ApiError</span> <span class="nf">createApiError</span><span class="o">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorCode</span><span class="o">,</span>
            <span class="n">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ApiError</span><span class="o">(</span><span class="n">errorCode</span><span class="o">,</span> <span class="n">messageSource</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(</span><span class="n">errorCode</span><span class="o">,</span>
                <span class="n">args</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getLocale</span><span class="o">()));</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">handleMethodArgumentNotValid</span><span class="o">(</span>
            <span class="n">MethodArgumentNotValidException</span> <span class="n">ex</span><span class="o">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="o">,</span>
            <span class="n">HttpStatus</span> <span class="n">status</span><span class="o">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ApiError</span> <span class="n">apiError</span> <span class="o">=</span> <span class="n">createApiError</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="s">&quot;E400&quot;</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">FieldError</span> <span class="n">fieldError</span> <span class="o">:</span> <span class="n">ex</span><span class="o">.</span><span class="na">getBindingResult</span><span class="o">().</span><span class="na">getFieldErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">apiError</span><span class="o">.</span><span class="na">addDetail</span><span class="o">(</span><span class="n">createApiError</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">fieldError</span><span class="o">,</span> <span class="n">fieldError</span>
                    <span class="o">.</span><span class="na">getField</span><span class="o">()));</span>
        <span class="o">}</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">ObjectError</span> <span class="n">objectError</span> <span class="o">:</span> <span class="n">ex</span><span class="o">.</span><span class="na">getBindingResult</span><span class="o">().</span><span class="na">getGlobalErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">apiError</span><span class="o">.</span><span class="na">addDetail</span><span class="o">(</span><span class="n">createApiError</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">objectError</span><span class="o">,</span> <span class="n">objectError</span>
                    <span class="o">.</span><span class="na">getObjectName</span><span class="o">()));</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nf">handleExceptionInternal</span><span class="o">(</span><span class="n">ex</span><span class="o">,</span> <span class="n">apiError</span><span class="o">,</span> <span class="n">headers</span><span class="o">,</span> <span class="n">status</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">ApiError</span> <span class="nf">createApiError</span><span class="o">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="o">,</span>
            <span class="n">DefaultMessageSourceResolvable</span> <span class="n">messageSourceResolvable</span><span class="o">,</span>
            <span class="n">String</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ApiError</span><span class="o">(</span><span class="n">messageSourceResolvable</span><span class="o">.</span><span class="na">getCode</span><span class="o">(),</span> <span class="n">messageSource</span>
                <span class="o">.</span><span class="na">getMessage</span><span class="o">(</span><span class="n">messageSourceResolvable</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getLocale</span><span class="o">()),</span> <span class="n">target</span><span class="o">);</span>
    <span class="o">}</span>

<span class="hll">    <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="n">BusinessException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">handleBusinessException</span><span class="o">(</span><span class="n">BusinessException</span> <span class="n">ex</span><span class="o">,</span>
</span><span class="hll">            <span class="n">WebRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
</span><span class="hll">        <span class="k">return</span> <span class="nf">handleResultMessagesNotificationException</span><span class="o">(</span><span class="n">ex</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
</span><span class="hll">                <span class="n">HttpStatus</span><span class="o">.</span><span class="na">CONFLICT</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
</span><span class="hll">    <span class="o">}</span>
</span>
<span class="hll">    <span class="kd">private</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">handleResultMessagesNotificationException</span><span class="o">(</span>
</span><span class="hll">            <span class="n">ResultMessagesNotificationException</span> <span class="n">ex</span><span class="o">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="o">,</span>
</span><span class="hll">            <span class="n">HttpStatus</span> <span class="n">status</span><span class="o">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
</span><span class="hll">        <span class="n">ResultMessage</span> <span class="n">message</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="na">getResultMessages</span><span class="o">().</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">();</span>
</span><span class="hll">        <span class="n">ApiError</span> <span class="n">apiError</span> <span class="o">=</span> <span class="n">createApiError</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">getCode</span><span class="o">(),</span> <span class="n">message</span>
</span><span class="hll">                <span class="o">.</span><span class="na">getArgs</span><span class="o">());</span>
</span><span class="hll">        <span class="k">return</span> <span class="nf">handleExceptionInternal</span><span class="o">(</span><span class="n">ex</span><span class="o">,</span> <span class="n">apiError</span><span class="o">,</span> <span class="n">headers</span><span class="o">,</span> <span class="n">status</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
</span><span class="hll">    <span class="o">}</span>
</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">HTTP Dev Clientを使用して、実装したエラーハンドリングの動作確認を行う。</div>
<div class="line">Dev HTTP Clientを開いてURLに<tt class="docutils literal"><span class="pre">&quot;localhost:8080/todo-api/api/v1/todos/{todoId}&quot;</span></tt>を入力し、メソッドにPUTを指定する。</div>
<div class="line">{todoId}の部分は実際のIDを入れる必要があるので、POST TodosまたはGET Todosを実行してResponse中のtodoIdをコピーして貼り付けてから、”Send”ボタンを2回クリックする。</div>
<div class="line">未完了状態のTodoのtodoIdを指定すること。</div>
</div>
<p>2回目のリクエストに対するレスポンスとして、&#8221;409 Conflict&#8221;のHTTPステータスが返却され、「RESPONSE」の「Body」には、エラー情報のJSONが表示される。</p>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/exception-businesserror.png"><img alt="../_images/exception-businesserror.png" src="../_images/exception-businesserror.png" style="width: 100%;" /></a>
</div>
</div></blockquote>
</div>
<div class="section" id="id26">
<h4><a class="toc-backref" href="#id68">7.1.3.7.9. リソース未検出例外のエラーハンドリングの実装</a><a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h4>
<p><tt class="docutils literal"><span class="pre">RestGlobalExceptionHandler</span></tt>に<tt class="docutils literal"><span class="pre">org.terasoluna.gfw.common.exception.ResourceNotFoundException</span></tt>をハンドリングするメソッドを追加して、リソース未検出例外をハンドリングする。</p>
<div class="line-block">
<div class="line">リソース未検出例外が発生した場合、&#8221;404 NotFound&#8221;のHTTPステータスを設定する。</div>
</div>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">RestGlobalExceptionHandler.java</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">error</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.context.MessageSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.support.DefaultMessageSourceResolvable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpHeaders</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.ResponseEntity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.FieldError</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.ObjectError</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.MethodArgumentNotValidException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ControllerAdvice</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ExceptionHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.context.request.WebRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.BusinessException</span><span class="o">;</span>
<span class="hll"><span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.ResourceNotFoundException</span><span class="o">;</span>
</span><span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.ResultMessagesNotificationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessage</span><span class="o">;</span>

<span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RestGlobalExceptionHandler</span> <span class="kd">extends</span> <span class="n">ResponseEntityExceptionHandler</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">MessageSource</span> <span class="n">messageSource</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">handleExceptionInternal</span><span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">,</span>
            <span class="n">Object</span> <span class="n">body</span><span class="o">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="o">,</span> <span class="n">HttpStatus</span> <span class="n">status</span><span class="o">,</span>
            <span class="n">WebRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Object</span> <span class="n">responseBody</span> <span class="o">=</span> <span class="n">body</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">body</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">responseBody</span> <span class="o">=</span> <span class="n">createApiError</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="s">&quot;E999&quot;</span><span class="o">,</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;(</span><span class="n">responseBody</span><span class="o">,</span> <span class="n">headers</span><span class="o">,</span> <span class="n">status</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">ApiError</span> <span class="nf">createApiError</span><span class="o">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorCode</span><span class="o">,</span>
            <span class="n">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ApiError</span><span class="o">(</span><span class="n">errorCode</span><span class="o">,</span> <span class="n">messageSource</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(</span><span class="n">errorCode</span><span class="o">,</span>
                <span class="n">args</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getLocale</span><span class="o">()));</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">handleMethodArgumentNotValid</span><span class="o">(</span>
            <span class="n">MethodArgumentNotValidException</span> <span class="n">ex</span><span class="o">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="o">,</span>
            <span class="n">HttpStatus</span> <span class="n">status</span><span class="o">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ApiError</span> <span class="n">apiError</span> <span class="o">=</span> <span class="n">createApiError</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="s">&quot;E400&quot;</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">FieldError</span> <span class="n">fieldError</span> <span class="o">:</span> <span class="n">ex</span><span class="o">.</span><span class="na">getBindingResult</span><span class="o">().</span><span class="na">getFieldErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">apiError</span><span class="o">.</span><span class="na">addDetail</span><span class="o">(</span><span class="n">createApiError</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">fieldError</span><span class="o">,</span> <span class="n">fieldError</span>
                    <span class="o">.</span><span class="na">getField</span><span class="o">()));</span>
        <span class="o">}</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">ObjectError</span> <span class="n">objectError</span> <span class="o">:</span> <span class="n">ex</span><span class="o">.</span><span class="na">getBindingResult</span><span class="o">().</span><span class="na">getGlobalErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">apiError</span><span class="o">.</span><span class="na">addDetail</span><span class="o">(</span><span class="n">createApiError</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">objectError</span><span class="o">,</span> <span class="n">objectError</span>
                    <span class="o">.</span><span class="na">getObjectName</span><span class="o">()));</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nf">handleExceptionInternal</span><span class="o">(</span><span class="n">ex</span><span class="o">,</span> <span class="n">apiError</span><span class="o">,</span> <span class="n">headers</span><span class="o">,</span> <span class="n">status</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">ApiError</span> <span class="nf">createApiError</span><span class="o">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="o">,</span>
            <span class="n">DefaultMessageSourceResolvable</span> <span class="n">messageSourceResolvable</span><span class="o">,</span>
            <span class="n">String</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ApiError</span><span class="o">(</span><span class="n">messageSourceResolvable</span><span class="o">.</span><span class="na">getCode</span><span class="o">(),</span> <span class="n">messageSource</span>
                <span class="o">.</span><span class="na">getMessage</span><span class="o">(</span><span class="n">messageSourceResolvable</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getLocale</span><span class="o">()),</span> <span class="n">target</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="n">BusinessException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">handleBusinessException</span><span class="o">(</span><span class="n">BusinessException</span> <span class="n">ex</span><span class="o">,</span>
            <span class="n">WebRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">handleResultMessagesNotificationException</span><span class="o">(</span><span class="n">ex</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
                <span class="n">HttpStatus</span><span class="o">.</span><span class="na">CONFLICT</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">handleResultMessagesNotificationException</span><span class="o">(</span>
            <span class="n">ResultMessagesNotificationException</span> <span class="n">ex</span><span class="o">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="o">,</span>
            <span class="n">HttpStatus</span> <span class="n">status</span><span class="o">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ResultMessage</span> <span class="n">message</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="na">getResultMessages</span><span class="o">().</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">();</span>
        <span class="n">ApiError</span> <span class="n">apiError</span> <span class="o">=</span> <span class="n">createApiError</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">getCode</span><span class="o">(),</span> <span class="n">message</span>
                <span class="o">.</span><span class="na">getArgs</span><span class="o">());</span>
        <span class="k">return</span> <span class="nf">handleExceptionInternal</span><span class="o">(</span><span class="n">ex</span><span class="o">,</span> <span class="n">apiError</span><span class="o">,</span> <span class="n">headers</span><span class="o">,</span> <span class="n">status</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
    <span class="o">}</span>

<span class="hll">    <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="n">ResourceNotFoundException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">handleResourceNotFoundException</span><span class="o">(</span>
</span><span class="hll">            <span class="n">ResourceNotFoundException</span> <span class="n">ex</span><span class="o">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
</span><span class="hll">        <span class="k">return</span> <span class="nf">handleResultMessagesNotificationException</span><span class="o">(</span><span class="n">ex</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
</span><span class="hll">                <span class="n">HttpStatus</span><span class="o">.</span><span class="na">NOT_FOUND</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
</span><span class="hll">    <span class="o">}</span>
</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">HTTP Dev Clientを使用して、実装したエラーハンドリングの動作確認を行う。</div>
<div class="line">Dev HTTP Clientを開いてURLに<tt class="docutils literal"><span class="pre">&quot;localhost:8080/todo-api/api/v1/todos/{todoId}&quot;</span></tt>を入力し、メソッドにGETを指定する。</div>
<div class="line">{todoId}の部分には存在しないIDを指定して、”Send”ボタンをクリックする。</div>
</div>
<p>&#8220;404 Not Found&#8221;のHTTPステータスが返却され、「RESPONSE」の「Body」には、エラー情報のJSONが表示される。</p>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/exception-notfound.png"><img alt="../_images/exception-notfound.png" src="../_images/exception-notfound.png" style="width: 100%;" /></a>
</div>
</div></blockquote>
</div>
<div class="section" id="id27">
<h4><a class="toc-backref" href="#id69">7.1.3.7.10. システム例外のエラーハンドリングの実装</a><a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h4>
<p>最後に、<tt class="docutils literal"><span class="pre">RestGlobalExceptionHandler</span></tt>に<tt class="docutils literal"><span class="pre">java.lang.Exception</span></tt>をハンドリングするメソッドを追加して、システム例外をハンドリングする。</p>
<p>システム例外が発生した場合、&#8221;500 InternalServerError&#8221;のHTTPステータスを設定する。</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">RestGlobalExceptionHandler.java</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">error</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.context.MessageSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.support.DefaultMessageSourceResolvable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpHeaders</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.ResponseEntity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.FieldError</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.ObjectError</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.MethodArgumentNotValidException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ControllerAdvice</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ExceptionHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.context.request.WebRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.BusinessException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.ResourceNotFoundException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.ResultMessagesNotificationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessage</span><span class="o">;</span>

<span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RestGlobalExceptionHandler</span> <span class="kd">extends</span> <span class="n">ResponseEntityExceptionHandler</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">MessageSource</span> <span class="n">messageSource</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">handleExceptionInternal</span><span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">,</span>
            <span class="n">Object</span> <span class="n">body</span><span class="o">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="o">,</span> <span class="n">HttpStatus</span> <span class="n">status</span><span class="o">,</span>
            <span class="n">WebRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Object</span> <span class="n">responseBody</span> <span class="o">=</span> <span class="n">body</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">body</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">responseBody</span> <span class="o">=</span> <span class="n">createApiError</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="s">&quot;E999&quot;</span><span class="o">,</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;(</span><span class="n">responseBody</span><span class="o">,</span> <span class="n">headers</span><span class="o">,</span> <span class="n">status</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">ApiError</span> <span class="nf">createApiError</span><span class="o">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorCode</span><span class="o">,</span>
            <span class="n">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ApiError</span><span class="o">(</span><span class="n">errorCode</span><span class="o">,</span> <span class="n">messageSource</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(</span><span class="n">errorCode</span><span class="o">,</span>
                <span class="n">args</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getLocale</span><span class="o">()));</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">handleMethodArgumentNotValid</span><span class="o">(</span>
            <span class="n">MethodArgumentNotValidException</span> <span class="n">ex</span><span class="o">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="o">,</span>
            <span class="n">HttpStatus</span> <span class="n">status</span><span class="o">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ApiError</span> <span class="n">apiError</span> <span class="o">=</span> <span class="n">createApiError</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="s">&quot;E400&quot;</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">FieldError</span> <span class="n">fieldError</span> <span class="o">:</span> <span class="n">ex</span><span class="o">.</span><span class="na">getBindingResult</span><span class="o">().</span><span class="na">getFieldErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">apiError</span><span class="o">.</span><span class="na">addDetail</span><span class="o">(</span><span class="n">createApiError</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">fieldError</span><span class="o">,</span> <span class="n">fieldError</span>
                    <span class="o">.</span><span class="na">getField</span><span class="o">()));</span>
        <span class="o">}</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">ObjectError</span> <span class="n">objectError</span> <span class="o">:</span> <span class="n">ex</span><span class="o">.</span><span class="na">getBindingResult</span><span class="o">().</span><span class="na">getGlobalErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">apiError</span><span class="o">.</span><span class="na">addDetail</span><span class="o">(</span><span class="n">createApiError</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">objectError</span><span class="o">,</span> <span class="n">objectError</span>
                    <span class="o">.</span><span class="na">getObjectName</span><span class="o">()));</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nf">handleExceptionInternal</span><span class="o">(</span><span class="n">ex</span><span class="o">,</span> <span class="n">apiError</span><span class="o">,</span> <span class="n">headers</span><span class="o">,</span> <span class="n">status</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">ApiError</span> <span class="nf">createApiError</span><span class="o">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="o">,</span>
            <span class="n">DefaultMessageSourceResolvable</span> <span class="n">messageSourceResolvable</span><span class="o">,</span>
            <span class="n">String</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ApiError</span><span class="o">(</span><span class="n">messageSourceResolvable</span><span class="o">.</span><span class="na">getCode</span><span class="o">(),</span> <span class="n">messageSource</span>
                <span class="o">.</span><span class="na">getMessage</span><span class="o">(</span><span class="n">messageSourceResolvable</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getLocale</span><span class="o">()),</span> <span class="n">target</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="n">BusinessException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">handleBusinessException</span><span class="o">(</span><span class="n">BusinessException</span> <span class="n">ex</span><span class="o">,</span>
            <span class="n">WebRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">handleResultMessagesNotificationException</span><span class="o">(</span><span class="n">ex</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
                <span class="n">HttpStatus</span><span class="o">.</span><span class="na">CONFLICT</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">handleResultMessagesNotificationException</span><span class="o">(</span>
            <span class="n">ResultMessagesNotificationException</span> <span class="n">ex</span><span class="o">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="o">,</span>
            <span class="n">HttpStatus</span> <span class="n">status</span><span class="o">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ResultMessage</span> <span class="n">message</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="na">getResultMessages</span><span class="o">().</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">();</span>
        <span class="n">ApiError</span> <span class="n">apiError</span> <span class="o">=</span> <span class="n">createApiError</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">getCode</span><span class="o">(),</span> <span class="n">message</span>
                <span class="o">.</span><span class="na">getArgs</span><span class="o">());</span>
        <span class="k">return</span> <span class="nf">handleExceptionInternal</span><span class="o">(</span><span class="n">ex</span><span class="o">,</span> <span class="n">apiError</span><span class="o">,</span> <span class="n">headers</span><span class="o">,</span> <span class="n">status</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="n">ResourceNotFoundException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">handleResourceNotFoundException</span><span class="o">(</span>
            <span class="n">ResourceNotFoundException</span> <span class="n">ex</span><span class="o">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">handleResultMessagesNotificationException</span><span class="o">(</span><span class="n">ex</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
                <span class="n">HttpStatus</span><span class="o">.</span><span class="na">NOT_FOUND</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
    <span class="o">}</span>

<span class="hll">    <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="n">Exception</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">handleSystemError</span><span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">,</span>
</span><span class="hll">            <span class="n">WebRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
</span><span class="hll">        <span class="n">ApiError</span> <span class="n">apiError</span> <span class="o">=</span> <span class="n">createApiError</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="s">&quot;E500&quot;</span><span class="o">);</span>
</span><span class="hll">        <span class="k">return</span> <span class="nf">handleExceptionInternal</span><span class="o">(</span><span class="n">ex</span><span class="o">,</span> <span class="n">apiError</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
</span><span class="hll">                <span class="n">HttpStatus</span><span class="o">.</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
</span><span class="hll">    <span class="o">}</span>
</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">HTTP Dev Clientを使用して、実装したエラーハンドリングの動作確認を行う。</div>
<div class="line">システムエラーを発生させるために、テーブルを未作成の状態でアプリケーションを起動させる。</div>
</div>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">todo-api-infra.properties</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-properties"><div class="highlight"><pre><span class="na">database</span><span class="o">=</span><span class="s">H2</span>
<span class="c">#database.url=jdbc:h2:mem:todo-api;DB_CLOSE_DELAY=-1;INIT=create table if not exists todo(todo_id varchar(36) primary key, todo_title varchar(30), finished boolean, created_at timestamp)</span>
<span class="hll"><span class="na">database.url</span><span class="o">=</span><span class="s">jdbc:h2:mem:todo-api;DB_CLOSE_DELAY=-1</span>
</span><span class="na">database.username</span><span class="o">=</span><span class="s">sa</span>
<span class="na">database.password</span><span class="o">=</span>
<span class="na">database.driverClassName</span><span class="o">=</span><span class="s">org.h2.Driver</span>
<span class="c"># connection pool</span>
<span class="na">cp.maxActive</span><span class="o">=</span><span class="s">96</span>
<span class="na">cp.maxIdle</span><span class="o">=</span><span class="s">16</span>
<span class="na">cp.minIdle</span><span class="o">=</span><span class="s">0</span>
<span class="na">cp.maxWait</span><span class="o">=</span><span class="s">60000</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">Dev HTTP Clientを開いてURLに<tt class="docutils literal"><span class="pre">&quot;localhost:8080/todo-api/api/v1/todos&quot;</span></tt>を入力し、メソッドにGETを指定して、”Send”ボタンをクリックする。</div>
</div>
<p>&#8220;500 Internal Server Error&#8221;のHTTPステータスが返却され、「RESPONSE」の「Body」には、エラー情報のJSONが表示される。</p>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/exception-systemerror.png"><img alt="../_images/exception-systemerror.png" src="../_images/exception-systemerror.png" style="width: 100%;" /></a>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>システムエラーが発生した場合、クライアントへ返却するメッセージは、エラー原因が特定されないシンプルなエラーメッセージを設定することを推奨する。
エラー原因が特定できるメッセージを設定してしまうと、システムの脆弱性をクライアントに公開する可能性があり、セキュリティー上問題がある。</p>
<p>エラー原因は、エラー解析用にログに出力すればよい。
Blankプロジェクトのデフォルトの設定では、共通ライブラリから提供している<tt class="docutils literal"><span class="pre">ExceptionLogger</span></tt>によってログが出力されるようなっているため、ログを出力するための設定や実装は不要である。</p>
<p><tt class="docutils literal"><span class="pre">ExceptionLogger</span></tt>によって出力されるログは以下の通りである。
Todoテーブルが存在しない事が原因でシステムエラーが発生している事がわかる。</p>
<blockquote class="last">
<div><div class="highlight-text"><div class="highlight"><pre>date:2014-04-04 15:15:07    thread:tomcat-http--3   X-Track:09689dcae9d04ad3b25650cba2ebbe3a    level:ERROR logger:o.t.gfw.common.exception.ExceptionLogger         message:[e.xx.fw.9001] SqlMapClient operation; bad SQL grammar []; nested exception is com.ibatis.common.jdbc.exception.NestedSQLException:
--- The error occurred while executing query.
--- Check the  SELECT todo_id,        todo_title,        finished,        created_at FROM   todo .
--- Check the SQL Statement (preparation failed).
<span class="hll">--- Cause: org.h2.jdbc.JdbcSQLException: Table &quot;TODO&quot; not found; SQL statement:
</span> SELECT todo_id,        todo_title,        finished,        created_at FROM   todo  [42102-172]
org.springframework.jdbc.BadSqlGrammarException: SqlMapClient operation; bad SQL grammar []; nested exception is com.ibatis.common.jdbc.exception.NestedSQLException:
--- The error occurred while executing query.
--- Check the  SELECT todo_id,        todo_title,        finished,        created_at FROM   todo .
--- Check the SQL Statement (preparation failed).
--- Cause: org.h2.jdbc.JdbcSQLException: Table &quot;TODO&quot; not found; SQL statement:
 SELECT todo_id,        todo_title,        finished,        created_at FROM   todo  [42102-172]
    at org.springframework.jdbc.support.SQLErrorCodeSQLExceptionTranslator.doTranslate(SQLErrorCodeSQLExceptionTranslator.java:237) ~[spring-jdbc-3.2.4.RELEASE.jar:3.2.4.RELEASE]
    at org.springframework.jdbc.support.AbstractFallbackSQLExceptionTranslator.translate(AbstractFallbackSQLExceptionTranslator.java:72) ~[spring-jdbc-3.2.4.RELEASE.jar:3.2.4.RELEASE]
    at org.springframework.orm.ibatis.SqlMapClientTemplate.execute(SqlMapClientTemplate.java:206) ~[spring-orm-3.2.4.RELEASE.jar:3.2.4.RELEASE]
    at org.springframework.orm.ibatis.SqlMapClientTemplate.queryForList(SqlMapClientTemplate.java:296) ~[spring-orm-3.2.4.RELEASE.jar:3.2.4.RELEASE]
    at jp.terasoluna.fw.dao.ibatis.QueryDAOiBatisImpl.executeForObjectList(QueryDAOiBatisImpl.java:421) ~[terasoluna-ibatis-2.0.5.0.jar:2.0.5.0]
    at todo.domain.repository.todo.TodoRepositoryImpl.findAll(TodoRepositoryImpl.java:33) ~[TodoRepositoryImpl.class:na]
    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:1.7.0_51]
    ...

    (omitted)
</pre></div>
</div>
</div></blockquote>
</div>
</div></blockquote>
</div>
</div>
</div>
<div class="section" id="id28">
<h2><a class="toc-backref" href="#id70">7.1.4. おわりに</a><a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h2>
<p>このチュートリアルでは、以下の内容を学習した。</p>
<ul class="simple">
<li>TERASOLUNA Global Frameworkによる基本的なRESTful Webサービスの構築方法</li>
<li>REST API(GET, POST, PUT, DELETE)を提供するControllerクラスの実装</li>
<li>JavaBeanとJSONの相互変換方法</li>
<li>エラーメッセージの定義方法</li>
<li>Spring MVCを使用した各種例外のハンドリング方法</li>
</ul>
<p>ここでは、基本的なRESTful Webサービスの実装法について示した。
考え方の元となるアーキテクチャ・設計指針等について理解を深める為には、「<a class="reference internal" href="../ArchitectureInDetail/REST.html"><em>RESTful Web Service</em></a>」 を参照されたい。</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../Appendix/CreateProjectFromBlank.html" title="7.2. Blankプロジェクトから新規プロジェクト作成"
             >next</a> |</li>
        <li class="right" >
          <a href="../Appendix/index.html" title="7. Appendix"
             >previous</a> |</li>
        <li><a href="../index.html">TERASOLUNA Global Framework Development Guideline 1.0.2.RELEASE documentation</a> &raquo;</li>
          <li><a href="../Appendix/index.html" >7. Appendix</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013-2015, NTT DATA.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.Theme by <a href="http://github.com/vkvn">vkvn</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>
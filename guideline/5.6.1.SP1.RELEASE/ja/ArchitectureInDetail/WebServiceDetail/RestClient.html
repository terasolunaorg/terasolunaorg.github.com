<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>5.2. RESTクライアント（HTTPクライアント） &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.6.1.SP1.RELEASE documentation</title>
    <link rel="stylesheet" href="../../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '5.6.1.SP1.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="5.3. SOAP Web Service（サーバ/クライアント）" href="SOAP.html" />
    <link rel="prev" title="5.1. RESTful Web Service" href="REST.html" /><script src="../../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../../_static/solarized-dark.css" rel="stylesheet">
<link href="../../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="SOAP.html" title="5.3. SOAP Web Service（サーバ/クライアント）"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="REST.html" title="5.1. RESTful Web Service"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.6.1.SP1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">5. Web Service</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">5.2. RESTクライアント（HTTPクライアント）</a><ul>
<li><a class="reference internal" href="#overview">5.2.1. Overview</a><ul>
<li><a class="reference internal" href="#resttemplate">5.2.1.1. <code class="docutils literal"><span class="pre">RestTemplate</span></code> とは</a><ul>
<li><a class="reference internal" href="#httpmessageconverter">5.2.1.1.1. <code class="docutils literal"><span class="pre">HttpMessageConverter</span></code></a></li>
<li><a class="reference internal" href="#clienthttprequestfactory">5.2.1.1.2. <code class="docutils literal"><span class="pre">ClientHttpRequestFactory</span></code></a></li>
<li><a class="reference internal" href="#responseerrorhandler">5.2.1.1.3. <code class="docutils literal"><span class="pre">ResponseErrorHandler</span></code></a></li>
<li><a class="reference internal" href="#clienthttprequestinterceptor">5.2.1.1.4. <code class="docutils literal"><span class="pre">ClientHttpRequestInterceptor</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">5.2.2. How to use</a><ul>
<li><a class="reference internal" href="#restclienthowtousesetup">5.2.2.1. <code class="docutils literal"><span class="pre">RestTemplate</span></code>のセットアップ</a><ul>
<li><a class="reference internal" href="#id9">5.2.2.1.1. 依存ライブラリ設定</a></li>
<li><a class="reference internal" href="#resttemplatebean">5.2.2.1.2. <code class="docutils literal"><span class="pre">RestTemplate</span></code>のbean定義</a></li>
<li><a class="reference internal" href="#id10">5.2.2.1.3. <code class="docutils literal"><span class="pre">RestTemplate</span></code>の利用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#get">5.2.2.2. GETリクエストの送信</a><ul>
<li><a class="reference internal" href="#getforobject">5.2.2.2.1. <code class="docutils literal"><span class="pre">getForObject</span></code>メソッドを使用した実装</a></li>
<li><a class="reference internal" href="#getforentity">5.2.2.2.2. <code class="docutils literal"><span class="pre">getForEntity</span></code>メソッドを使用した実装</a></li>
<li><a class="reference internal" href="#exchange">5.2.2.2.3. <code class="docutils literal"><span class="pre">exchange</span></code>メソッドを使用した実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#post">5.2.2.3. POSTリクエストの送信</a><ul>
<li><a class="reference internal" href="#postforobject">5.2.2.3.1. <code class="docutils literal"><span class="pre">postForObject</span></code>メソッドを使用した実装</a></li>
<li><a class="reference internal" href="#postforentity">5.2.2.3.2. <code class="docutils literal"><span class="pre">postForEntity</span></code>メソッドを使用した実装</a></li>
<li><a class="reference internal" href="#id11">5.2.2.3.3. <code class="docutils literal"><span class="pre">exchange</span></code>メソッドを使用した実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#restclienthowtousegetcollection">5.2.2.4. コレクション形式のデータ取得</a></li>
<li><a class="reference internal" href="#restclienthowtouserequestheader">5.2.2.5. リクエストヘッダの設定</a><ul>
<li><a class="reference internal" href="#content-type">5.2.2.5.1. Content-Typeヘッダの設定</a></li>
<li><a class="reference internal" href="#accept">5.2.2.5.2. Acceptヘッダの設定</a></li>
<li><a class="reference internal" href="#restclienthowtouserequestheaderanyheader">5.2.2.5.3. 任意のリクエストヘッダの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#restclienthowtouseerrorhandling">5.2.2.6. エラーハンドリング</a><ul>
<li><a class="reference internal" href="#restclienthowtouseerrorhandlinghandleexception">5.2.2.6.1. 例外ハンドリング(デフォルトの動作)</a></li>
<li><a class="reference internal" href="#restclienthowtouseerrorhandlingresponseentity">5.2.2.6.2. <code class="docutils literal"><span class="pre">ResponseEntity</span></code>の返却（エラーハンドラの拡張）</a></li>
</ul>
</li>
<li><a class="reference internal" href="#restclienthowtousetimeoutsettings">5.2.2.7. 通信タイムアウトの設定</a></li>
<li><a class="reference internal" href="#ssl">5.2.2.8. SSL自己署名証明書の使用</a></li>
<li><a class="reference internal" href="#basic">5.2.2.9. Basic認証</a></li>
<li><a class="reference internal" href="#restclienthowtousefileupload">5.2.2.10. ファイルアップロード(マルチパートリクエスト)</a></li>
<li><a class="reference internal" href="#restclienthowtousefiledownload">5.2.2.11. ファイルダウンロード</a></li>
<li><a class="reference internal" href="#restfulurl-uri">5.2.2.12. RESTfulなURL(URIテンプレート)を扱う方法と実装例</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend">5.2.3. How to extend</a><ul>
<li><a class="reference internal" href="#restclienthowtoextendhttpmessageconverter">5.2.3.1. 任意の<code class="docutils literal"><span class="pre">HttpMessageConverter</span></code>を登録する方法</a></li>
<li><a class="reference internal" href="#restclienthowtoextendclienthttprequestinterceptor">5.2.3.2. 共通処理の適用（<code class="docutils literal"><span class="pre">ClientHttpRequestInterceptor</span></code>）</a><ul>
<li><a class="reference internal" href="#restclienthowtoextendclienthttprequestinterceptorlogging">5.2.3.2.1. ロギング処理</a></li>
<li><a class="reference internal" href="#restclientbasicauthorizationinterceptorbeandefinition">5.2.3.2.2. Basic認証用のリクエストヘッダ設定処理</a></li>
<li><a class="reference internal" href="#id27">5.2.3.2.3. <code class="docutils literal"><span class="pre">ClientHttpRequestInterceptor</span></code>の適用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#restclientasync">5.2.3.3. 非同期リクエスト</a><ul>
<li><a class="reference internal" href="#asyncresttemplatebean">5.2.3.3.1. <code class="docutils literal"><span class="pre">AsyncRestTemplate</span></code>のbean定義</a></li>
<li><a class="reference internal" href="#restclientasyncimplementation">5.2.3.3.2. 非同期リクエストの実装</a></li>
<li><a class="reference internal" href="#id30">5.2.3.3.3. 非同期リクエストの共通処理の実装</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix">5.2.4. Appendix</a><ul>
<li><a class="reference internal" href="#http-proxy">5.2.4.1. HTTP Proxyサーバの設定方法</a><ul>
<li><a class="reference internal" href="#simpleclienthttprequestfactoryhttp-proxy">5.2.4.1.1. SimpleClientHttpRequestFactoryを使用したHTTP Proxyサーバの設定方法</a></li>
<li><a class="reference internal" href="#httpcomponentsclienthttprequestfactoryhttp-proxy">5.2.4.1.2. HttpComponentsClientHttpRequestFactoryを使用したHTTP Proxyサーバの設定方法</a><ul>
<li><a class="reference internal" href="#id31">5.2.4.1.2.1. HTTP Proxyサーバの指定方法</a></li>
<li><a class="reference internal" href="#id33">5.2.4.1.2.2. HTTP Proxyサーバの資格情報の指定方法</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#jsonjsr-310-date-and-time-api">5.2.4.2. JSONでJSR-310 Date and Time APIを使う場合の設定</a></li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="REST.html"
                        title="previous chapter">5.1. RESTful Web Service</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="SOAP.html"
                        title="next chapter">5.3. SOAP Web Service（サーバ/クライアント）</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/ArchitectureInDetail/WebServiceDetail/RestClient.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="rest-http">
<h1>5.2. RESTクライアント（HTTPクライアント）<a class="headerlink" href="#rest-http" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="id1">
<p class="topic-title">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id37">Overview</a><ul>
<li><a class="reference internal" href="#resttemplate" id="id38"><code class="docutils literal"><span class="pre">RestTemplate</span></code> とは</a><ul>
<li><a class="reference internal" href="#httpmessageconverter" id="id39"><code class="docutils literal"><span class="pre">HttpMessageConverter</span></code></a></li>
<li><a class="reference internal" href="#clienthttprequestfactory" id="id40"><code class="docutils literal"><span class="pre">ClientHttpRequestFactory</span></code></a></li>
<li><a class="reference internal" href="#responseerrorhandler" id="id41"><code class="docutils literal"><span class="pre">ResponseErrorHandler</span></code></a></li>
<li><a class="reference internal" href="#clienthttprequestinterceptor" id="id42"><code class="docutils literal"><span class="pre">ClientHttpRequestInterceptor</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use" id="id43">How to use</a><ul>
<li><a class="reference internal" href="#restclienthowtousesetup" id="id44"><code class="docutils literal"><span class="pre">RestTemplate</span></code>のセットアップ</a><ul>
<li><a class="reference internal" href="#id9" id="id45">依存ライブラリ設定</a></li>
<li><a class="reference internal" href="#resttemplatebean" id="id46"><code class="docutils literal"><span class="pre">RestTemplate</span></code>のbean定義</a></li>
<li><a class="reference internal" href="#id10" id="id47"><code class="docutils literal"><span class="pre">RestTemplate</span></code>の利用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#get" id="id48">GETリクエストの送信</a><ul>
<li><a class="reference internal" href="#getforobject" id="id49"><code class="docutils literal"><span class="pre">getForObject</span></code>メソッドを使用した実装</a></li>
<li><a class="reference internal" href="#getforentity" id="id50"><code class="docutils literal"><span class="pre">getForEntity</span></code>メソッドを使用した実装</a></li>
<li><a class="reference internal" href="#exchange" id="id51"><code class="docutils literal"><span class="pre">exchange</span></code>メソッドを使用した実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#post" id="id52">POSTリクエストの送信</a><ul>
<li><a class="reference internal" href="#postforobject" id="id53"><code class="docutils literal"><span class="pre">postForObject</span></code>メソッドを使用した実装</a></li>
<li><a class="reference internal" href="#postforentity" id="id54"><code class="docutils literal"><span class="pre">postForEntity</span></code>メソッドを使用した実装</a></li>
<li><a class="reference internal" href="#id11" id="id55"><code class="docutils literal"><span class="pre">exchange</span></code>メソッドを使用した実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#restclienthowtousegetcollection" id="id56">コレクション形式のデータ取得</a></li>
<li><a class="reference internal" href="#restclienthowtouserequestheader" id="id57">リクエストヘッダの設定</a><ul>
<li><a class="reference internal" href="#content-type" id="id58">Content-Typeヘッダの設定</a></li>
<li><a class="reference internal" href="#accept" id="id59">Acceptヘッダの設定</a></li>
<li><a class="reference internal" href="#restclienthowtouserequestheaderanyheader" id="id60">任意のリクエストヘッダの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#restclienthowtouseerrorhandling" id="id61">エラーハンドリング</a><ul>
<li><a class="reference internal" href="#restclienthowtouseerrorhandlinghandleexception" id="id62">例外ハンドリング(デフォルトの動作)</a></li>
<li><a class="reference internal" href="#restclienthowtouseerrorhandlingresponseentity" id="id63"><code class="docutils literal"><span class="pre">ResponseEntity</span></code>の返却（エラーハンドラの拡張）</a></li>
</ul>
</li>
<li><a class="reference internal" href="#restclienthowtousetimeoutsettings" id="id64">通信タイムアウトの設定</a></li>
<li><a class="reference internal" href="#ssl" id="id65">SSL自己署名証明書の使用</a></li>
<li><a class="reference internal" href="#basic" id="id66">Basic認証</a></li>
<li><a class="reference internal" href="#restclienthowtousefileupload" id="id67">ファイルアップロード(マルチパートリクエスト)</a></li>
<li><a class="reference internal" href="#restclienthowtousefiledownload" id="id68">ファイルダウンロード</a></li>
<li><a class="reference internal" href="#restfulurl-uri" id="id69">RESTfulなURL(URIテンプレート)を扱う方法と実装例</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend" id="id70">How to extend</a><ul>
<li><a class="reference internal" href="#restclienthowtoextendhttpmessageconverter" id="id71">任意の<code class="docutils literal"><span class="pre">HttpMessageConverter</span></code>を登録する方法</a></li>
<li><a class="reference internal" href="#restclienthowtoextendclienthttprequestinterceptor" id="id72">共通処理の適用（<code class="docutils literal"><span class="pre">ClientHttpRequestInterceptor</span></code>）</a><ul>
<li><a class="reference internal" href="#restclienthowtoextendclienthttprequestinterceptorlogging" id="id73">ロギング処理</a></li>
<li><a class="reference internal" href="#restclientbasicauthorizationinterceptorbeandefinition" id="id74">Basic認証用のリクエストヘッダ設定処理</a></li>
<li><a class="reference internal" href="#id27" id="id75"><code class="docutils literal"><span class="pre">ClientHttpRequestInterceptor</span></code>の適用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#restclientasync" id="id76">非同期リクエスト</a><ul>
<li><a class="reference internal" href="#asyncresttemplatebean" id="id77"><code class="docutils literal"><span class="pre">AsyncRestTemplate</span></code>のbean定義</a></li>
<li><a class="reference internal" href="#restclientasyncimplementation" id="id78">非同期リクエストの実装</a></li>
<li><a class="reference internal" href="#id30" id="id79">非同期リクエストの共通処理の実装</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix" id="id80">Appendix</a><ul>
<li><a class="reference internal" href="#http-proxy" id="id81">HTTP Proxyサーバの設定方法</a><ul>
<li><a class="reference internal" href="#simpleclienthttprequestfactoryhttp-proxy" id="id82">SimpleClientHttpRequestFactoryを使用したHTTP Proxyサーバの設定方法</a></li>
<li><a class="reference internal" href="#httpcomponentsclienthttprequestfactoryhttp-proxy" id="id83">HttpComponentsClientHttpRequestFactoryを使用したHTTP Proxyサーバの設定方法</a></li>
</ul>
</li>
<li><a class="reference internal" href="#jsonjsr-310-date-and-time-api" id="id84">JSONでJSR-310 Date and Time APIを使う場合の設定</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<span id="restclientoverview"></span><h2><a class="toc-backref" href="#id37">5.2.1. Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>本節では、Spring Frameworkが提供する<code class="docutils literal"><span class="pre">org.springframework.web.client.RestTemplate</span></code>を使用してRESTful Web Service(REST API)を呼び出す実装方法について説明する。</p>
<div class="section" id="resttemplate">
<span id="restclientoverviewresttemplate"></span><h3><a class="toc-backref" href="#id38">5.2.1.1. <code class="docutils literal"><span class="pre">RestTemplate</span></code> とは</a><a class="headerlink" href="#resttemplate" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">RestTemplate</span></code>は、REST API(Web API)を呼び出すためのメソッドを提供するクラスであり、
Spring Frameworkが提供するHTTPクライアントである。</p>
<p>具体的な実装方法の説明を行う前に、<code class="docutils literal"><span class="pre">RestTemplate</span></code>がどのようにREST API(Web API)にアクセスしているかを説明する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/RestClientOverview.png"><img alt="Constitution of RestTemplate" src="../../_images/RestClientOverview.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="22%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">コンポーネント</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アプリケーション</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RestTemplate</span></code>のメソッドを呼び出して、REST API(Web API)の呼び出し依頼を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RestTemplate</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">HttpMessageConverter</span></code>を使用して、Javaオブジェクトをリクエストボディに設定する電文(JSON等)に変換する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ClientHttpRequestFactory</span></code>から<code class="docutils literal"><span class="pre">ClientHttpRequest</span></code>を取得して、電文(JSON等)の送信依頼を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ClientHttpRequest</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">電文(JSON等)をリクエストボディに設定して、REST API(Web API)にHTTP経由でリクエストを行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RestTemplate</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ResponseErrorHandler</span></code>を使用して、HTTP通信のエラー判定及びエラー処理を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ResponseErrorHandler</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ClientHttpResponse</span></code>からレスポンスデータを取得して、エラー判定及びエラー処理を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RestTemplate</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">HttpMessageConverter</span></code>を使用して、レスポンスボディに設定されている電文(JSON等)をJavaオブジェクトに変換する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">REST API(Web API)の呼び出し結果(Javaオブジェクト)をアプリケーションへ返却する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>非同期処理への対応</strong></p>
<p class="last">REST APIからの応答を別スレッドで処理したい場合(非同期で処理したい場合)は、
<code class="docutils literal"><span class="pre">RestTemplate</span></code>の代わりに<code class="docutils literal"><span class="pre">org.springframework.web.client.AsyncRestTemplate</span></code>を使用すればよい。
非同期処理の実装例については、<a class="reference internal" href="#restclientasync"><span class="std std-ref">非同期リクエスト</span></a> を参照されたい。</p>
</div>
<div class="section" id="httpmessageconverter">
<span id="restclientoverviewhttpmessageconverter"></span><h4><a class="toc-backref" href="#id39">5.2.1.1.1. <code class="docutils literal"><span class="pre">HttpMessageConverter</span></code></a><a class="headerlink" href="#httpmessageconverter" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">org.springframework.http.converter.HttpMessageConverter</span></code>は、アプリケーションで扱うJavaオブジェクトとサーバと通信するための電文(JSON等)を相互に変換するためのインタフェースである。</p>
<p><code class="docutils literal"><span class="pre">RestTemplate</span></code>を使用した場合、デフォルトで以下の<code class="docutils literal"><span class="pre">HttpMessageConverter</span></code>の実装クラスが登録される。</p>
<table border="1" class="colwidths-given longtable docutils" id="id34">
<caption><span class="caption-text"><strong>デフォルトで登録されるHttpMessageConverter</strong></span><a class="headerlink" href="#id34" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="5%" />
<col width="25%" />
<col width="55%" />
<col width="15%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">クラス名</th>
<th class="head">説明</th>
<th class="head">サポート型</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.http.converter.</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">ByteArrayHttpMessageConverter</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">「HTTPボディ(テキスト or バイナリデータ)⇔バイト配列」変換用のクラス。</div>
<div class="line">デフォルトですべてのメディアタイプ(<code class="docutils literal"><span class="pre">*/*</span></code>)をサポートする。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">byte[]</span></code></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.http.converter.</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">StringHttpMessageConverter</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">「HTTPボディ(テキスト)⇔文字列」変換用のクラス。</div>
<div class="line">デフォルトですべてのテキストメディアタイプ(<code class="docutils literal"><span class="pre">text/*</span></code>)をサポートする。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">String</span></code></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.http.converter.</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">ResourceHttpMessageConverter</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">「HTTPボディ(バイナリデータ)⇔Springのリソースオブジェクト」変換用のクラス。</div>
<div class="line">デフォルトですべてのメディアタイプ(<code class="docutils literal"><span class="pre">*/*</span></code>)をサポートする。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Resource</span></code> <a class="footnote-reference" href="#p1" id="id2">[1]</a></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.http.converter.xml.</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">SourceHttpMessageConverter</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">「HTTPボディ(XML)⇔XMLソースオブジェクト」変換用のクラス。</div>
<div class="line">デフォルトでXML用のメディアタイプ(<code class="docutils literal"><span class="pre">text/xml</span></code>,<code class="docutils literal"><span class="pre">application/xml</span></code>,<code class="docutils literal"><span class="pre">application/*-xml</span></code>)をサポートする。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Source</span></code> <a class="footnote-reference" href="#p2" id="id3">[2]</a></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.http.converter.support.</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">AllEncompassingFormHttpMessageConverter</span></code></div>
</div>
</td>
<td><div class="first line-block">
<div class="line">「HTTPボディ⇔<code class="docutils literal"><span class="pre">MultiValueMap</span></code>オブジェクト」変換用のクラス。</div>
<div class="line"><code class="docutils literal"><span class="pre">FormHttpMessageConverter</span></code>の拡張クラスで、multipartのパートデータとしてXMLとJSONへの変換がサポートされている。</div>
<div class="line">デフォルトでフォームデータ用のメディアタイプ(<code class="docutils literal"><span class="pre">application/x-www-form-urlencoded</span></code>,<code class="docutils literal"><span class="pre">multipart/form-data</span></code>)をサポートする。</div>
</div>
<ul class="simple">
<li>メディアタイプが<code class="docutils literal"><span class="pre">application/x-www-form-urlencoded</span></code>の場合、<code class="docutils literal"><span class="pre">MultiValueMap&lt;String,</span> <span class="pre">String&gt;</span></code>として読込/書込される。</li>
<li>メディアタイプが<code class="docutils literal"><span class="pre">multipart/form-data</span></code>の場合、<code class="docutils literal"><span class="pre">MultiValueMap&lt;String,</span> <span class="pre">Object&gt;</span></code>として書込され、<code class="docutils literal"><span class="pre">Object</span></code>は<code class="docutils literal"><span class="pre">AllEncompassingFormHttpMessageConverter</span></code>内に別途設定される<code class="docutils literal"><span class="pre">HttpMessageConveter</span></code>で変換される。
（注意： Note 参照）</li>
</ul>
<div class="last line-block">
<div class="line">デフォルトで登録されるパートデータ変換用の<code class="docutils literal"><span class="pre">HttpMessageConveter</span></code>は、<a class="reference external" href="https://github.com/spring-projects/spring-framework/blob/v5.2.20.RELEASE/spring-web/src/main/java/org/springframework/http/converter/support/AllEncompassingFormHttpMessageConverter.java">AllEncompassingFormHttpMessageConverter</a>と <a class="reference external" href="https://github.com/spring-projects/spring-framework/blob/v5.2.20.RELEASE/spring-web/src/main/java/org/springframework/http/converter/FormHttpMessageConverter.java">FormHttpMessageConverter</a>のソースを参照されたい。なお、任意の<code class="docutils literal"><span class="pre">HttpMessageConverter</span></code>を登録することもできる。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">MultiValueMap</span></code> <a class="footnote-reference" href="#p3" id="id4">[3]</a></div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>AllEncompassingFormHttpMessageConverterのメディアタイプがmultipart/form-dataの場合について</strong></p>
<p class="last">メディアタイプが<code class="docutils literal"><span class="pre">multipart/form-data</span></code>の場合、「<code class="docutils literal"><span class="pre">MultiValueMap</span></code>オブジェクト から HTTPボディ」への変換は可能だが、
「HTTPボディ から <code class="docutils literal"><span class="pre">MultiValueMap</span></code>オブジェクト」への変換は現状サポートされていない。
よって、「HTTPボディ から <code class="docutils literal"><span class="pre">MultiValueMap</span></code>オブジェクト」への変換を行いたい場合は、独自に実装する必要がある。</p>
</div>
<p></p>
<table border="1" class="colwidths-given longtable docutils" id="id35">
<caption><span class="caption-text"><strong>依存ライブラリがクラスパス上に存在する場合に登録されるHttpMessageConverter</strong></span><a class="headerlink" href="#id35" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="5%" />
<col width="25%" />
<col width="55%" />
<col width="15%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">クラス名</th>
<th class="head">説明</th>
<th class="head">サポート型</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.http.converter.feed.</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">AtomFeedHttpMessageConverter</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">「HTTPボディ(Atom)⇔Atomフィードオブジェクト」変換用のクラス。</div>
<div class="line">デフォルトでATOM用のメディアタイプ(<code class="docutils literal"><span class="pre">application/atom+xml</span></code>)をサポートする。</div>
<div class="line">(ROMEがクラスパスに存在する場合に登録される)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Feed</span></code> <a class="footnote-reference" href="#p4" id="id5">[4]</a></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.http.converter.feed.</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">RssChannelHttpMessageConverter</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">「HTTPボディ(RSS)⇔Rssチャネルオブジェクト」変換用のクラス。</div>
<div class="line">デフォルトでRSS用のメディアタイプ(<code class="docutils literal"><span class="pre">application/rss+xml</span></code>)をサポートする。</div>
<div class="line">(ROMEがクラスパスに存在する場合に登録される)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Channel</span></code> <a class="footnote-reference" href="#p5" id="id6">[5]</a></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.http.converter.json.</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">MappingJackson2HttpMessageConverter</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">「HTTPボディ(JSON)⇔JavaBean」変換用のクラス。</div>
<div class="line">デフォルトでJSON用のメディアタイプ(<code class="docutils literal"><span class="pre">application/json</span></code>,<code class="docutils literal"><span class="pre">application/*+json</span></code>)をサポートする。</div>
<div class="line">(Jackson2がクラスパスに存在する場合に登録される)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Object</span></code> (JavaBean)</div>
<div class="line"><code class="docutils literal"><span class="pre">Map</span></code></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.http.converter.xml.</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">MappingJackson2XmlHttpMessageConverter</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">「HTTPボディ(XML)⇔JavaBean」変換用のクラス。</div>
<div class="line">デフォルトでXML用のメディアタイプ(<code class="docutils literal"><span class="pre">text/xml</span></code>,<code class="docutils literal"><span class="pre">application/xml</span></code>,<code class="docutils literal"><span class="pre">application/*-xml</span></code>)をサポートする。</div>
<div class="line">(Jackson-dataformat-xmlがクラスパスに存在する場合に登録される)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Object</span></code> (JavaBean)</div>
<div class="line"><code class="docutils literal"><span class="pre">Map</span></code></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.http.converter.xml.</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">Jaxb2RootElementHttpMessageConverter</span></code></div>
</div>
</td>
<td><div class="first line-block">
<div class="line">「HTTPボディ(XML)⇔JavaBean」変換用のクラス。</div>
<div class="line">デフォルトでXML用のメディアタイプ(<code class="docutils literal"><span class="pre">text/xml</span></code>,<code class="docutils literal"><span class="pre">application/xml</span></code>,<code class="docutils literal"><span class="pre">application/*-xml</span></code>)をサポートする。</div>
<div class="line">(JAXBがクラスパスに存在する場合に登録される)</div>
</div>
<div class="last admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Java SE 11環境にてJAXBをクラスパスに登録するには<a class="reference internal" href="../../Appendix/Java11Changes.html#remove-jaxb-from-java11"><span class="std std-ref">JAXBの削除</span></a>を参照されたい。</p>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Object</span></code> (JavaBean)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.http.converter.json.</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">GsonHttpMessageConverter</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">「HTTPボディ(JSON)⇔JavaBean」変換用のクラス。</div>
<div class="line">デフォルトでJSON用のメディアタイプ(<code class="docutils literal"><span class="pre">application/json</span></code>,<code class="docutils literal"><span class="pre">application/*+json</span></code>)をサポートする。</div>
<div class="line">(Gsonがクラスパスに存在する場合に登録される)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Object</span></code> (JavaBean)</div>
<div class="line"><code class="docutils literal"><span class="pre">Map</span></code></div>
</div>
</td>
</tr>
</tbody>
</table>
<p></p>
<table class="docutils footnote" frame="void" id="p1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td><code class="docutils literal"><span class="pre">org.springframework.core.io</span></code>パッケージのクラス</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="p2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[2]</a></td><td><code class="docutils literal"><span class="pre">javax.xml.transform</span></code>パッケージのクラス</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="p3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[3]</a></td><td><code class="docutils literal"><span class="pre">org.springframework.util</span></code>パッケージのクラス</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="p4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[4]</a></td><td><code class="docutils literal"><span class="pre">com.rometools.rome.feed.atom</span></code>パッケージのクラス</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="p5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[5]</a></td><td><code class="docutils literal"><span class="pre">com.rometools.rome.feed.rss</span></code>パッケージのクラス</td></tr>
</tbody>
</table>
</div>
<div class="section" id="clienthttprequestfactory">
<span id="restclientoverviewclienthttprequestfactory"></span><h4><a class="toc-backref" href="#id40">5.2.1.1.2. <code class="docutils literal"><span class="pre">ClientHttpRequestFactory</span></code></a><a class="headerlink" href="#clienthttprequestfactory" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">RestTemplate</span></code>は、サーバとの通信処理を以下の３つのインタフェースの実装クラスに委譲することで実現している。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">org.springframework.http.client.ClientHttpRequestFactory</span></code></li>
<li><code class="docutils literal"><span class="pre">org.springframework.http.client.ClientHttpRequest</span></code></li>
<li><code class="docutils literal"><span class="pre">org.springframework.http.client.ClientHttpResponse</span></code></li>
</ul>
<p>この３つのインタフェースのうち、開発者が意識するのは<code class="docutils literal"><span class="pre">ClientHttpRequestFactory</span></code>である。
<code class="docutils literal"><span class="pre">ClientHttpRequestFactory</span></code>は、サーバとの通信処理を行うクラス(<code class="docutils literal"><span class="pre">ClientHttpRequest</span></code>と <code class="docutils literal"><span class="pre">ClientHttpResponse</span></code>インタフェースの実装クラス)を解決する役割を担っている。</p>
<p>なお、Spring Frameworkが提供している主な<code class="docutils literal"><span class="pre">ClientHttpRequestFactory</span></code>の実装クラスは以下の通りである。</p>
<table border="1" class="colwidths-given docutils" id="id36">
<caption><span class="caption-text"><strong>Spring Frameworkが提供している主なClientHttpRequestFactoryの実装クラス</strong></span><a class="headerlink" href="#id36" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="5%" />
<col width="25%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">クラス名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.http.client.</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">SimpleClientHttpRequestFactory</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Java SE標準の <a class="reference external" href="https://docs.oracle.com/javase/8/docs/api/java/net/HttpURLConnection.html">HttpURLConnection</a>のAPIを使用して通信処理(同期、非同期)を行うための実装クラス。(デフォルトで使用される実装クラス)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.http.client.</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">Netty4ClientHttpRequestFactory</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="http://netty.io/">Netty 4</a>のAPIを使用して通信処理(同期、非同期)を行うための実装クラス。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.http.client.</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">HttpComponentsClientHttpRequestFactory</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="http://hc.apache.org/httpcomponents-client-ga/">Apache HttpComponents HttpClient</a>のAPIを使用して同期型の通信処理を行うための実装クラス。(HttpClient 4.3以上が必要)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.http.client.</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">HttpComponentsAsyncClientHttpRequestFactory</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="http://hc.apache.org/httpcomponents-asyncclient-dev/">Apache HttpComponents HttpAsyncClient</a>のAPIを使用して非同期型の通信処理を行うための実装クラス。(HttpAsyncClient 4.0以上が必要)</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.http.client.</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">OkHttpClientHttpRequestFactory</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="http://square.github.io/okhttp/">Square OkHttp</a>のAPIを使用して通信処理（同期、非同期）を行うための実装クラス。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>使用するClientHttpRequestFactoryの実装クラスについて</strong></p>
<p class="last"><code class="docutils literal"><span class="pre">RestTemplate</span></code>が使用するデフォルト実装は<code class="docutils literal"><span class="pre">SimpleClientHttpRequestFactory</span></code>であり、本ガイドラインでも<code class="docutils literal"><span class="pre">SimpleClientHttpRequestFactory</span></code>を使用した際の実装例となっている。
Java SEの<code class="docutils literal"><span class="pre">HttpURLConnection</span></code>で要件が満たせない場合は、Netty、Apache Http Componentsなどのライブラリの利用を検討されたい。</p>
</div>
</div>
<div class="section" id="responseerrorhandler">
<span id="restclientoverviewresponseerrorhandler"></span><h4><a class="toc-backref" href="#id41">5.2.1.1.3. <code class="docutils literal"><span class="pre">ResponseErrorHandler</span></code></a><a class="headerlink" href="#responseerrorhandler" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">RestTemplate</span></code>は、サーバとの通信エラーのハンドリングを<code class="docutils literal"><span class="pre">org.springframework.web.client.ResponseErrorHandler</span></code>インタフェースに委譲することで実現している。</p>
<p><code class="docutils literal"><span class="pre">ResponseErrorHandler</span></code>には、</p>
<ul class="simple">
<li>エラー判定を行うメソッド(<code class="docutils literal"><span class="pre">hasError</span></code>)</li>
<li>エラー処理を行うメソッド(<code class="docutils literal"><span class="pre">handleError</span></code>)</li>
</ul>
<p>が定義されており、Spring Frameworkはデフォルト実装として<code class="docutils literal"><span class="pre">org.springframework.web.client.DefaultResponseErrorHandler</span></code>を提供している。</p>
<p><code class="docutils literal"><span class="pre">DefaultResponseErrorHandler</span></code>は、サーバから応答されたHTTPステータスコードの値によって以下のようなエラー処理を行う。</p>
<ul class="simple">
<li>レスポンスコードが正常系(2xx)の場合は、エラー処理は行わない。</li>
<li>レスポンスコードがクライアントエラー系(4xx)の場合は、<code class="docutils literal"><span class="pre">org.springframework.web.client.HttpClientErrorException</span></code>を発生させる。</li>
<li>レスポンスコードがサーバエラー系(5xx)の場合は、<code class="docutils literal"><span class="pre">org.springframework.web.client.HttpServerErrorException</span></code>を発生させる。</li>
<li>レスポンスコードが未定義のコード(ユーザ定義のカスタムコード)の場合は、<code class="docutils literal"><span class="pre">org.springframework.web.client.UnknownHttpStatusCodeException</span></code>を発生させる。</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>エラー時のレスポンスデータの取得方法</strong></p>
<p class="last">エラー時のレスポンスデータ(HTTPステータスコード、レスポンスヘッダ、レスポンスボディなど)は、例外クラスのgetterメソッドを呼び出すことで取得することができる。</p>
</div>
</div>
<div class="section" id="clienthttprequestinterceptor">
<span id="restclientoverviewclienthttprequestinterceptor"></span><h4><a class="toc-backref" href="#id42">5.2.1.1.4. <code class="docutils literal"><span class="pre">ClientHttpRequestInterceptor</span></code></a><a class="headerlink" href="#clienthttprequestinterceptor" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">org.springframework.http.client.ClientHttpRequestInterceptor</span></code>は、サーバとの通信の前後に共通的な処理を実装するためのインタフェースである。</p>
<p><code class="docutils literal"><span class="pre">ClientHttpRequestInterceptor</span></code>を使用すると、</p>
<ul class="simple">
<li>サーバとの通信ログ</li>
<li>認証ヘッダの設定</li>
</ul>
<p>といった共通的な処理を<code class="docutils literal"><span class="pre">RestTemplate</span></code>に適用することができる。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>ClientHttpRequestInterceptorの動作仕様</strong></p>
<p><code class="docutils literal"><span class="pre">ClientHttpRequestInterceptor</span></code>は複数適用することができ、指定した順番でチェーン実行される。
これはサーブレットフィルタの動作によく似ており、最後に実行されるチェーン先として<code class="docutils literal"><span class="pre">ClientHttpRequest</span></code>によるHTTP通信処理が登録されている。
例えば、ある条件に一致した際にサーバとの通信処理をキャンセルしたいという要件があった場合は、チェーン先を呼びださなければよい。</p>
<p>この仕組みを活用すると、</p>
<ul class="simple">
<li>サーバとの通信の閉塞</li>
<li>通信処理のリトライ</li>
</ul>
<p class="last">といった処理を適用することもできる。</p>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-use">
<span id="restclienthowtouse"></span><h2><a class="toc-backref" href="#id43">5.2.2. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<p>本節では、<code class="docutils literal"><span class="pre">RestTemplate</span></code>を使用したクライアント処理の実装方法について説明する。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>RestTemplateがサポートするHTTPメソッドについて</strong></p>
<p class="last">本ガイドラインでは、GETメソッドとPOSTメソッドを使用したクライアント処理の実装例のみを紹介するが、
<code class="docutils literal"><span class="pre">RestTemplate</span></code>は他のHTTPメソッド(PUT, PATCH, DELETE, HEAD, OPTIONSなど)もサポートしており、同じような要領で使用することができる。
詳細は<a class="reference external" href="https://docs.spring.io/spring/docs/5.2.20.RELEASE/javadoc-api/org/springframework/web/client/RestTemplate.html">RestTemplate</a>のJavadocを参照されたい。</p>
</div>
<div class="section" id="restclienthowtousesetup">
<span id="id8"></span><h3><a class="toc-backref" href="#id44">5.2.2.1. <code class="docutils literal"><span class="pre">RestTemplate</span></code>のセットアップ</a><a class="headerlink" href="#restclienthowtousesetup" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">RestTemplate</span></code>を使用する場合は、<code class="docutils literal"><span class="pre">RestTemplate</span></code>をDIコンテナに登録し、<code class="docutils literal"><span class="pre">RestTemplate</span></code>を利用するコンポーネントにインジェクションする。</p>
<div class="section" id="id9">
<h4><a class="toc-backref" href="#id45">5.2.2.1.1. 依存ライブラリ設定</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">RestTemplate</span></code>を使用するために<code class="docutils literal"><span class="pre">pom.xml</span></code>に、Spring Frameworkのspring-webライブラリを追加する。</div>
<div class="line">マルチプロジェクト構成の場合は、domainプロジェクトの<code class="docutils literal"><span class="pre">pom.xml</span></code>に追加する。</div>
</div>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependencies&gt;</span>

    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-web<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>

<span class="nt">&lt;/dependencies&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">上記設定例は、依存ライブラリのバージョンを親プロジェクトである terasoluna-gfw-parent で管理する前提であるため、pom.xmlでのバージョンの指定は不要である。
上記の依存ライブラリはterasoluna-gfw-parentが依存している<a class="reference external" href="https://docs.spring.io/spring-boot/docs/2.2.4.RELEASE/reference/htmlsingle/#dependency-versions">Spring Boot</a>で管理されている。</p>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring Frameworkの<code class="docutils literal"><span class="pre">spring-web</span></code>ライブラリをdependenciesに追加する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="resttemplatebean">
<h4><a class="toc-backref" href="#id46">5.2.2.1.2. <code class="docutils literal"><span class="pre">RestTemplate</span></code>のbean定義</a><a class="headerlink" href="#resttemplatebean" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">RestTemplate</span></code>のbean定義を行い、DIコンテナに登録する。</p>
<p><strong>bean定義ファイル(applicationContext.xml)の定義例</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;restTemplate&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.web.client.RestTemplate&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RestTemplate</span></code>をデフォルト設定のまま利用する場合は、デフォルトコンストラクタを使用してbeanを登録する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>RestTemplateのカスタマイズ方法</strong></p>
<p>HTTP通信処理をカスタマイズする場合は、以下のようなbean定義となる。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;clientHttpRequestFactory&quot;</span>
      <span class="na">class=</span><span class="s">&quot;org.springframework.http.client.SimpleClientHttpRequestFactory&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="c">&lt;!-- Set properties for customize a http communication (omit on this sample) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;restTemplate&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.web.client.RestTemplate&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;clientHttpRequestFactory&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ClientHttpRequestFactory</span></code>のbean定義を行う。</div>
<div class="line">本ガイドラインではタイムアウトの設定をカスタマイズする方法を紹介している。詳細は <a class="reference internal" href="#restclienthowtousetimeoutsettings"><span class="std std-ref">通信タイムアウトの設定</span></a> を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ClientHttpRequestFactory</span></code>を引数に指定するコンストラクタを使用してbeanを登録する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>なお、<code class="docutils literal"><span class="pre">HttpMessageConverter</span></code>、<code class="docutils literal"><span class="pre">ResponseErrorHandler</span></code>、<code class="docutils literal"><span class="pre">ClientHttpRequestInterceptor</span></code>のカスタマイズ方法については、</p>
<ul class="simple">
<li><a class="reference internal" href="#restclienthowtoextendhttpmessageconverter"><span class="std std-ref">任意のHttpMessageConverterを登録する方法</span></a></li>
<li><a class="reference internal" href="#restclienthowtouseerrorhandlingresponseentity"><span class="std std-ref">ResponseEntityの返却（エラーハンドラの拡張）</span></a></li>
<li><a class="reference internal" href="#restclienthowtoextendclienthttprequestinterceptor"><span class="std std-ref">共通処理の適用（ClientHttpRequestInterceptor）</span></a></li>
</ul>
<p class="last">を参照されたい。</p>
</div>
</div>
<div class="section" id="id10">
<h4><a class="toc-backref" href="#id47">5.2.2.1.3. <code class="docutils literal"><span class="pre">RestTemplate</span></code>の利用</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">RestTemplate</span></code>を利用する場合は、DIコンテナに登録されている<code class="docutils literal"><span class="pre">RestTemplate</span></code>をインジェクションする。</p>
<p><strong>RestTemplateのインジェクション例</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountServiceImpl</span> <span class="kd">implements</span> <span class="n">AccountService</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">RestTemplate</span> <span class="n">restTemplate</span><span class="p">;</span>

    <span class="c1">// ...</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="get">
<span id="restclienthowtouseget"></span><h3><a class="toc-backref" href="#id48">5.2.2.2. GETリクエストの送信</a><a class="headerlink" href="#get" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">RestTemplate</span></code>は、GETリクエストを行うためのメソッドを複数提供している。</p>
<ul class="simple">
<li>通常は<code class="docutils literal"><span class="pre">getForObject</span></code>メソッド又は<code class="docutils literal"><span class="pre">getForEntity</span></code>メソッドを使用する。</li>
<li>任意のヘッダを設定するなどリクエストに細かい設定を行いたい場合は、<code class="docutils literal"><span class="pre">org.springframework.http.RequestEntity</span></code>と<code class="docutils literal"><span class="pre">exchange</span></code>メソッドを使用する。</li>
</ul>
<div class="section" id="getforobject">
<h4><a class="toc-backref" href="#id49">5.2.2.2.1. <code class="docutils literal"><span class="pre">getForObject</span></code>メソッドを使用した実装</a><a class="headerlink" href="#getforobject" title="Permalink to this headline">¶</a></h4>
<p>レスポンスボディのみ取得できればよい場合は、<code class="docutils literal"><span class="pre">getForObject</span></code>メソッドを使用する。</p>
<p><strong>getForObjectメソッドの使用例</strong></p>
<p>フィールド宣言部</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${api.url:http://localhost:8080/api}&quot;</span><span class="p">)</span>
<span class="n">URI</span> <span class="n">uri</span><span class="p">;</span>
</pre></div>
</div>
<p>メソッド内部</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">restTemplate</span><span class="p">.</span><span class="na">getForObject</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">);</span> <span class="c1">// (1)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">getForObject</span></code>メソッドを使用した場合は、戻り値はレスポンスボディの値になる。</div>
<div class="line">レスポンスボディのデータは<code class="docutils literal"><span class="pre">HttpMessageConverter</span></code>によって第2引数に指定したJavaクラスへ変換された後、返却される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="getforentity">
<h4><a class="toc-backref" href="#id50">5.2.2.2.2. <code class="docutils literal"><span class="pre">getForEntity</span></code>メソッドを使用した実装</a><a class="headerlink" href="#getforentity" title="Permalink to this headline">¶</a></h4>
<p>HTTPステータスコード、レスポンスヘッダ、レスポンスボディを取得する必要がある場合は、<code class="docutils literal"><span class="pre">getForEntity</span></code>メソッドを使用する。</p>
<p><strong>getForEntityメソッドの使用例</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">responseEntity</span> <span class="o">=</span>
        <span class="n">restTemplate</span><span class="p">.</span><span class="na">getForEntity</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">);</span> <span class="c1">// (1)</span>
<span class="n">HttpStatus</span> <span class="n">statusCode</span> <span class="o">=</span> <span class="n">responseEntity</span><span class="p">.</span><span class="na">getStatusCode</span><span class="p">();</span> <span class="c1">// (2)</span>
<span class="n">HttpHeaders</span> <span class="n">header</span> <span class="o">=</span> <span class="n">responseEntity</span><span class="p">.</span><span class="na">getHeaders</span><span class="p">();</span> <span class="c1">// (3)</span>
<span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">responseEntity</span><span class="p">.</span><span class="na">getBody</span><span class="p">();</span> <span class="c1">// (4)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">getForEntity</span></code>メソッドを使用した場合は、戻り値は<code class="docutils literal"><span class="pre">org.springframework.http.ResponseEntity</span></code>となる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">HTTPステータスコードは<code class="docutils literal"><span class="pre">getStatusCode</span></code>メソッドを用いて取得する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">レスポンスヘッダは<code class="docutils literal"><span class="pre">getHeaders</span></code>メソッドを用いて取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">レスポンスボディは<code class="docutils literal"><span class="pre">getBody</span></code>メソッドを用いて取得する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>ResponseEntityとは</strong></p>
<p class="last"><code class="docutils literal"><span class="pre">ResponseEntity</span></code>はHTTPレスポンスを表すクラスで、HTTPステータスコード、レスポンスヘッダ、レスポンスボディの情報を取得することができる。
詳細は<a class="reference external" href="https://docs.spring.io/spring/docs/5.2.20.RELEASE/javadoc-api/org/springframework/http/ResponseEntity.html">ResponseEntity</a>のJavadocを参照されたい。</p>
</div>
</div>
<div class="section" id="exchange">
<h4><a class="toc-backref" href="#id51">5.2.2.2.3. <code class="docutils literal"><span class="pre">exchange</span></code>メソッドを使用した実装</a><a class="headerlink" href="#exchange" title="Permalink to this headline">¶</a></h4>
<p>リクエストヘッダを指定する必要がある場合は、<code class="docutils literal"><span class="pre">org.springframework.http.RequestEntity</span></code>を生成し<code class="docutils literal"><span class="pre">exchange</span></code>メソッドを使用する。</p>
<p><strong>exchangeメソッドの使用例</strong></p>
<p>import部</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">org.springframework.http.RequestEntity</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.ResponseEntity</span><span class="p">;</span>
</pre></div>
</div>
<p>フィールド宣言部</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${api.url:http://localhost:8080/api}&quot;</span><span class="p">)</span>
<span class="n">URI</span> <span class="n">uri</span><span class="p">;</span>
</pre></div>
</div>
<p>メソッド内部</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">RequestEntity</span> <span class="n">requestEntity</span> <span class="o">=</span> <span class="n">RequestEntity</span>
        <span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span><span class="c1">//(1)</span>
        <span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="c1">//(2)</span>

<span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">responseEntity</span> <span class="o">=</span>
        <span class="n">restTemplate</span><span class="p">.</span><span class="na">exchange</span><span class="p">(</span><span class="n">requestEntity</span><span class="p">,</span> <span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="c1">//(3)</span>

<span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">responseEntity</span><span class="p">.</span><span class="na">getBody</span><span class="p">();</span><span class="c1">//(4)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RequestEntity</span></code>の<code class="docutils literal"><span class="pre">get</span></code>メソッドを使用し、GETリクエスト用のリクエストビルダを生成する。</div>
<div class="line">パラメータにURIを設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RequestEntity.HeadersBuilder</span></code>の<code class="docutils literal"><span class="pre">build</span></code>メソッドを使用し、<code class="docutils literal"><span class="pre">RequestEntity</span></code>オブジェクトを作成する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">exchange</span></code>メソッドを使用し、リクエストを送信する。第二引数に、レスポンスデータの型を指定する。</div>
<div class="line">レスポンスは、<code class="docutils literal"><span class="pre">ResponseEntity&lt;T&gt;</span></code>になる。型パラメータに、レスポンスデータの型を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">getBody</span></code>メソッドを使用し、レスポンスボディのデータを取得する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>RequestEntityとは</strong></p>
<p><code class="docutils literal"><span class="pre">RequestEntity</span></code>はHTTPリクエストを表すクラスで、接続URI、HTTPメソッド、リクエストヘッダ、リクエストボディを設定することができる。
詳細は<a class="reference external" href="https://docs.spring.io/spring/docs/5.2.20.RELEASE/javadoc-api/org/springframework/http/RequestEntity.html">RequestEntity</a>のJavadocを参照されたい。</p>
<p class="last">なお、リクエストヘッダの設定方法については、<a class="reference internal" href="#restclienthowtouserequestheader"><span class="std std-ref">リクエストヘッダの設定</span></a> を参照されたい。</p>
</div>
</div>
</div>
<div class="section" id="post">
<span id="restclienthowtousepost"></span><h3><a class="toc-backref" href="#id52">5.2.2.3. POSTリクエストの送信</a><a class="headerlink" href="#post" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">RestTemplate</span></code>は、POSTリクエストを行うためのメソッドを複数提供している。</p>
<ul class="simple">
<li>通常は、<code class="docutils literal"><span class="pre">postForObject</span></code>、<code class="docutils literal"><span class="pre">postForEntity</span></code>を使用する。</li>
<li>任意のヘッダを設定するなどリクエストに細かい設定を行いたい場合は、<code class="docutils literal"><span class="pre">RequestEntity</span></code>と <code class="docutils literal"><span class="pre">exchange</span></code>メソッドを使用する。</li>
</ul>
<div class="section" id="postforobject">
<h4><a class="toc-backref" href="#id53">5.2.2.3.1. <code class="docutils literal"><span class="pre">postForObject</span></code>メソッドを使用した実装</a><a class="headerlink" href="#postforobject" title="Permalink to this headline">¶</a></h4>
<p>POSTした結果としてレスポンスボディのみ取得できればよい場合は、<code class="docutils literal"><span class="pre">postForObject</span></code>メソッドを使用する。</p>
<p><strong>postForObjectメソッドの使用例</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="p">();</span>

<span class="c1">//...</span>

<span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">restTemplate</span><span class="p">.</span><span class="na">postForObject</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">);</span> <span class="c1">// (1)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">postForObject</span></code>メソッドは、簡易にPOSTリクエストを実装できる。</div>
<div class="line">第二引数には、<code class="docutils literal"><span class="pre">HttpMessageConverter</span></code>によってリクエストボディに変換されるJavaオブジェクトを設定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">postForObject</span></code>メソッドを使用した場合は、戻り値はレスポンスボディの値になる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="postforentity">
<h4><a class="toc-backref" href="#id54">5.2.2.3.2. <code class="docutils literal"><span class="pre">postForEntity</span></code>メソッドを使用した実装</a><a class="headerlink" href="#postforentity" title="Permalink to this headline">¶</a></h4>
<p>POSTした結果としてHTTPステータスコード、レスポンスヘッダ、レスポンスボディを取得する必要がある場合は、<code class="docutils literal"><span class="pre">postForEntity</span></code>メソッドを使用する。</p>
<p><strong>postForEntityメソッドの使用例</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="p">();</span>

<span class="c1">//...</span>

<span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">responseEntity</span> <span class="o">=</span>
        <span class="n">restTemplate</span><span class="p">.</span><span class="na">postForEntity</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">);</span> <span class="c1">// (1)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">postForEntity</span></code>メソッドも<code class="docutils literal"><span class="pre">getForObject</span></code>メソッドと同様に簡易にPOSTリクエストを実装できる。</div>
<div class="line"><code class="docutils literal"><span class="pre">postForEntity</span></code>メソッドを使用した場合は、戻り値は<code class="docutils literal"><span class="pre">ResponseEntity</span></code>となる。</div>
<div class="line">レスポンスボディの値は、<code class="docutils literal"><span class="pre">ResponseEntity</span></code>から取得する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id11">
<h4><a class="toc-backref" href="#id55">5.2.2.3.3. <code class="docutils literal"><span class="pre">exchange</span></code>メソッドを使用した実装</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<p>リクエストヘッダを指定する必要がある場合は、<code class="docutils literal"><span class="pre">RequestEntity</span></code>を生成し<code class="docutils literal"><span class="pre">exchange</span></code>メソッドを使用する。</p>
<p><strong>exchangeメソッドの使用例</strong></p>
<p>import部</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">org.springframework.http.RequestEntity</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.ResponseEntity</span><span class="p">;</span>
</pre></div>
</div>
<p>フィールド宣言部</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${api.url:http://localhost:8080/api}&quot;</span><span class="p">)</span>
<span class="n">URI</span> <span class="n">uri</span><span class="p">;</span>
</pre></div>
</div>
<p>メソッド内部</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="p">();</span>

<span class="c1">//...</span>

<span class="n">RequestEntity</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">requestEntity</span> <span class="o">=</span> <span class="n">RequestEntity</span><span class="c1">//(1)</span>
        <span class="p">.</span><span class="na">post</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span><span class="c1">//(2)</span>
        <span class="p">.</span><span class="na">body</span><span class="p">(</span><span class="n">user</span><span class="p">);</span><span class="c1">//(3)</span>

<span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">responseEntity</span> <span class="o">=</span>
        <span class="n">restTemplate</span><span class="p">.</span><span class="na">exchange</span><span class="p">(</span><span class="n">requestEntity</span><span class="p">,</span> <span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="c1">//(4)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RequestEntity</span></code>を使用して、リクエストを生成する。型パラメータに、リクエストボディに設定するデータの型を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">post</span></code>メソッドを使用し、POSTリクエスト用のリクエストビルダを生成する。パラメータにURIを設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RequestEntity.BodyBuilder</span></code>の<code class="docutils literal"><span class="pre">body</span></code>メソッドを使用し、<code class="docutils literal"><span class="pre">RequestEntity</span></code>オブジェクトを作成する。</div>
<div class="line">パラメータにリクエストボディに変換するJavaオブジェクトを設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">exchange</span></code>メソッドを使用し、リクエストを送信する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>リクエストヘッダの設定方法</strong></p>
<p class="last">リクエストヘッダの設定方法については、<a class="reference internal" href="#restclienthowtouserequestheader"><span class="std std-ref">リクエストヘッダの設定</span></a> を参照されたい。</p>
</div>
</div>
</div>
<div class="section" id="restclienthowtousegetcollection">
<span id="id12"></span><h3><a class="toc-backref" href="#id56">5.2.2.4. コレクション形式のデータ取得</a><a class="headerlink" href="#restclienthowtousegetcollection" title="Permalink to this headline">¶</a></h3>
<p>サーバから応答されるレスポンスボディの電文(JSON等)がコレクション形式の場合は、以下のような実装となる。</p>
<p><strong>コレクション形式のデータの取得例</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;</span> <span class="n">responseEntity</span> <span class="o">=</span> <span class="c1">//(1)</span>
    <span class="n">restTemplate</span><span class="p">.</span><span class="na">exchange</span><span class="p">(</span><span class="n">requestEntity</span><span class="p">,</span> <span class="k">new</span> <span class="n">ParameterizedTypeReference</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;</span><span class="p">(){});</span> <span class="c1">//(2)</span>

<span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">userList</span> <span class="o">=</span> <span class="n">responseEntity</span><span class="p">.</span><span class="na">getBody</span><span class="p">();</span><span class="c1">//(3)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ResponseEntity</span></code>の型パラメータに<code class="docutils literal"><span class="pre">List</span></code>&lt;レスポンスデータの型&gt;を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">exchange</span></code>メソッドの第二引数に<code class="docutils literal"><span class="pre">org.springframework.core.ParameterizedTypeReference</span></code>のインスタンスを指定し、型パラメータに<code class="docutils literal"><span class="pre">List</span></code>&lt;レスポンスデータの型&gt;を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">getBody</span></code>メソッドで、レスポンスボディのデータを取得する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="restclienthowtouserequestheader">
<span id="id13"></span><h3><a class="toc-backref" href="#id57">5.2.2.5. リクエストヘッダの設定</a><a class="headerlink" href="#restclienthowtouserequestheader" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">RequestEntity</span></code>と<code class="docutils literal"><span class="pre">exchange</span></code>メソッドを使用すると、<code class="docutils literal"><span class="pre">RequestEntity</span></code>のメソッドを使用して特定のヘッダ及び任意のヘッダを設定することができる。
詳細は<a class="reference external" href="https://docs.spring.io/spring/docs/5.2.20.RELEASE/javadoc-api/org/springframework/http/RequestEntity.html">RequestEntity</a>のJavadocを参照されたい。</p>
<p>本ガイドラインでは、</p>
<ul class="simple">
<li><a class="reference internal" href="#restclienthowtouserequestheadercontenttype"><span class="std std-ref">Content-Typeヘッダの設定</span></a></li>
<li><a class="reference internal" href="#restclienthowtouserequestheaderaccept"><span class="std std-ref">Acceptヘッダの設定</span></a></li>
<li><a class="reference internal" href="#restclienthowtouserequestheaderanyheader"><span class="std std-ref">任意のリクエストヘッダの設定</span></a></li>
</ul>
<p>について説明する。</p>
<div class="section" id="content-type">
<span id="restclienthowtouserequestheadercontenttype"></span><h4><a class="toc-backref" href="#id58">5.2.2.5.1. Content-Typeヘッダの設定</a><a class="headerlink" href="#content-type" title="Permalink to this headline">¶</a></h4>
<p>サーバへデータを送信する場合は、通常Content-Typeヘッダの指定が必要となる。</p>
<p><strong>Content-Typeヘッダの設定例</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="p">();</span>

<span class="c1">//...</span>

<span class="n">RequestEntity</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">requestEntity</span> <span class="o">=</span> <span class="n">RequestEntity</span>
        <span class="p">.</span><span class="na">post</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="p">.</span><span class="na">contentType</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">)</span> <span class="c1">// (1)</span>
        <span class="p">.</span><span class="na">body</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RequestEntity.BodyBuilder</span></code>の<code class="docutils literal"><span class="pre">contentType</span></code>メソッドを使用し、Context-Typeヘッダの値を指定する。</div>
<div class="line">上記の実装例では、データ形式がJSONであることを示す「<code class="docutils literal"><span class="pre">application/json</span></code>」を設定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="accept">
<span id="restclienthowtouserequestheaderaccept"></span><h4><a class="toc-backref" href="#id59">5.2.2.5.2. Acceptヘッダの設定</a><a class="headerlink" href="#accept" title="Permalink to this headline">¶</a></h4>
<p>サーバから取得するデータの形式を指定する場合は、Acceptヘッダの指定が必要となる。
サーバが複数のデータ形式のレスポンスをサポートしていない場合は、Acceptヘッダを明示的に指定しなくてもよいケースもある。</p>
<p><strong>Acceptヘッダの設定例</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="p">();</span>

<span class="c1">//...</span>

<span class="n">RequestEntity</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">requestEntity</span> <span class="o">=</span> <span class="n">RequestEntity</span>
        <span class="p">.</span><span class="na">post</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">)</span> <span class="c1">// (1)</span>
        <span class="p">.</span><span class="na">body</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RequestEntity.HeadersBuilder</span></code>の<code class="docutils literal"><span class="pre">accept</span></code>メソッドを使用して、Acceptヘッダの値を設定する。</div>
<div class="line">上記の実装例では、取得可能なデータ形式がJSONであることを示す「<code class="docutils literal"><span class="pre">application/json</span></code>」を設定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="restclienthowtouserequestheaderanyheader">
<span id="id15"></span><h4><a class="toc-backref" href="#id60">5.2.2.5.3. 任意のリクエストヘッダの設定</a><a class="headerlink" href="#restclienthowtouserequestheaderanyheader" title="Permalink to this headline">¶</a></h4>
<p>サーバへアクセスするために、リクエストヘッダの設定が必要になるケースがある。</p>
<p><strong>任意ヘッダの設定例</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="p">();</span>

<span class="c1">//...</span>

<span class="n">RequestEntity</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">requestEntity</span> <span class="o">=</span> <span class="n">RequestEntity</span>
        <span class="p">.</span><span class="na">post</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&quot;Authorization&quot;</span><span class="p">,</span> <span class="s">&quot;Basic &quot;</span> <span class="o">+</span> <span class="n">base64Credentials</span><span class="p">)</span> <span class="c1">// (1)</span>
        <span class="p">.</span><span class="na">body</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RequestEntity.HeadersBuilder</span></code>の<code class="docutils literal"><span class="pre">header</span></code>メソッドを使用してリクエストヘッダの名前と値を設定する。</div>
<div class="line">上記の実装例では、AuthorizationヘッダにBasic認証に必要な資格情報を設定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="restclienthowtouseerrorhandling">
<span id="id16"></span><h3><a class="toc-backref" href="#id61">5.2.2.6. エラーハンドリング</a><a class="headerlink" href="#restclienthowtouseerrorhandling" title="Permalink to this headline">¶</a></h3>
<div class="section" id="restclienthowtouseerrorhandlinghandleexception">
<span id="id17"></span><h4><a class="toc-backref" href="#id62">5.2.2.6.1. 例外ハンドリング(デフォルトの動作)</a><a class="headerlink" href="#restclienthowtouseerrorhandlinghandleexception" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">RestTemplate</span></code>のデフォルト実装(<code class="docutils literal"><span class="pre">DefaultResponseErrorHandler</span></code>)では、</p>
<ul class="simple">
<li>レスポンスコードがクライアントエラー系(4xx)の場合は、<code class="docutils literal"><span class="pre">HttpClientErrorException</span></code></li>
<li>レスポンスコードがサーバエラー系(5xx)の場合は、<code class="docutils literal"><span class="pre">HttpServerErrorException</span></code></li>
<li>レスポンスコードが未定義のコード(ユーザ定義のカスタムコード)の場合は、<code class="docutils literal"><span class="pre">UnknownHttpStatusCodeException</span></code></li>
</ul>
<p>が発生するため、必要に応じてこれらの例外をハンドリングする必要がある。</p>
<p><strong>例外ハンドリングの実装例</strong></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>以下の実装例は、サーバエラーが発生した際の例外ハンドリングの一例である。</p>
<p class="last">アプリケーションの要件に応じて<strong>適切な例外ハンドリングを行うこと。</strong></p>
</div>
<p>フィールド宣言部</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${api.retry.maxCount}&quot;</span><span class="p">)</span>
<span class="kt">int</span> <span class="n">retryMaxCount</span><span class="p">;</span>

<span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${api.retry.retryWaitTimeCoefficient}&quot;</span><span class="p">)</span>
<span class="kt">int</span> <span class="n">retryWaitTimeCoefficient</span><span class="p">;</span>
</pre></div>
</div>
<p>メソッド内部</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">retryCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>

        <span class="n">responseEntity</span> <span class="o">=</span> <span class="n">restTemplate</span><span class="p">.</span><span class="na">exchange</span><span class="p">(</span><span class="n">requestEntity</span><span class="p">,</span> <span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isInfoEnabled</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Success({}) &quot;</span><span class="p">,</span> <span class="n">responseEntity</span><span class="p">.</span><span class="na">getStatusCode</span><span class="p">());</span>
        <span class="p">}</span>

        <span class="k">break</span><span class="p">;</span>

    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">HttpServerErrorException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (1)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">retryCount</span> <span class="o">==</span> <span class="n">retryMaxCount</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="n">e</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">retryCount</span><span class="o">++</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isWarnEnabled</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">logger</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;An error ({}) occurred on the server. (The number of retries：{} Times)&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="na">getStatusCode</span><span class="p">(),</span>
                <span class="n">retryCount</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">try</span> <span class="p">{</span>
            <span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">retryWaitTimeCoefficient</span> <span class="o">*</span> <span class="n">retryCount</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">ie</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">interrupt</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="c1">//...</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例外をキャッチしてエラー処理を行う。サーバエラー（500系）の場合、<code class="docutils literal"><span class="pre">HttpServerErrorException</span></code>をキャッチする。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="restclienthowtouseerrorhandlingresponseentity">
<span id="id18"></span><h4><a class="toc-backref" href="#id63">5.2.2.6.2. <code class="docutils literal"><span class="pre">ResponseEntity</span></code>の返却（エラーハンドラの拡張）</a><a class="headerlink" href="#restclienthowtouseerrorhandlingresponseentity" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">org.springframework.web.client.ResponseErrorHandler</span></code>インタフェースの実装クラスを<code class="docutils literal"><span class="pre">RestTemplate</span></code>に設定することで、独自のエラー処理を行うことができる。</p>
<p>以下の例では、サーバエラー及びクライアントエラーが発生した場合でも<code class="docutils literal"><span class="pre">ResponseEntity</span></code>を返すようにエラーハンドラを拡張している。</p>
<p><strong>エラーハンドラの実装クラスの作成例</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">org.springframework.http.client.ClientHttpResponse</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.client.DefaultResponseErrorHandler</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomErrorHandler</span> <span class="kd">extends</span> <span class="n">DefaultResponseErrorHandler</span> <span class="p">{</span> <span class="c1">// (1)</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleError</span><span class="p">(</span><span class="n">ClientHttpResponse</span> <span class="n">response</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="p">{</span>
        <span class="c1">//Don&#39;t throw Exception.</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ResponseErrorHandler</span></code>インタフェースの実装クラスを作成する。</div>
<div class="line">上記の作成例では、デフォルトのエラーハンドラの実装クラスである<code class="docutils literal"><span class="pre">DefaultResponseErrorHandler</span></code>を拡張し、</div>
<div class="line">サーバエラー及びクライアントエラーが発生した際に例外を発生させずに<code class="docutils literal"><span class="pre">ResponseEntity</span></code>が返るようにしている。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>bean定義ファイル(applicationContext.xml)の定義例</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;customErrorHandler&quot;</span> <span class="na">class=</span><span class="s">&quot;com.example.restclient.CustomErrorHandler&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;restTemplate&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.web.client.RestTemplate&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;errorHandler&quot;</span> <span class="na">ref=</span><span class="s">&quot;customErrorHandler&quot;</span> <span class="nt">/&gt;</span><span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ResponseErrorHandler</span></code>の実装クラスのbean定義を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">errorHandler</span></code>プロパティに<code class="docutils literal"><span class="pre">ResponseErrorHandler</span></code>のbeanをインジェクションする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>クライアント処理の実装例</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">retryCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">responseEntity</span> <span class="o">=</span> <span class="n">restTemplate</span><span class="p">.</span><span class="na">exchange</span><span class="p">(</span><span class="n">requestEntity</span><span class="p">,</span> <span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">responseEntity</span><span class="p">.</span><span class="na">getStatusCode</span><span class="p">()</span> <span class="o">==</span> <span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (1)</span>

        <span class="k">break</span><span class="p">;</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">responseEntity</span><span class="p">.</span><span class="na">getStatusCode</span><span class="p">()</span> <span class="o">==</span> <span class="n">HttpStatus</span><span class="p">.</span><span class="na">SERVICE_UNAVAILABLE</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (2)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">retryCount</span> <span class="o">==</span> <span class="n">retryMaxCount</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">retryCount</span><span class="o">++</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isWarnEnabled</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">logger</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;An error ({}) occurred on the server. (The number of retries：{} Times)&quot;</span><span class="p">,</span>
                <span class="n">responseEntity</span><span class="p">.</span><span class="na">getStatusCode</span><span class="p">(),</span> <span class="n">retryCount</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">try</span> <span class="p">{</span>
            <span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">retryWaitTimeCoefficient</span> <span class="o">*</span> <span class="n">retryCount</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">ie</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">interrupt</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="c1">//...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">上記の実装例では、エラー時にも<code class="docutils literal"><span class="pre">ResponseEntity</span></code>を返すようにエラーハンドラを拡張しているので、返却された<code class="docutils literal"><span class="pre">ResponseEntity</span></code>からHTTPステータスコードを取得して、処理結果が正常であったか確認する必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラー発生時も返却された<code class="docutils literal"><span class="pre">ResponseEntity</span></code>からHTTPステータスコードを取得して、その値に応じて処理を制御することができる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="restclienthowtousetimeoutsettings">
<span id="id19"></span><h3><a class="toc-backref" href="#id64">5.2.2.7. 通信タイムアウトの設定</a><a class="headerlink" href="#restclienthowtousetimeoutsettings" title="Permalink to this headline">¶</a></h3>
<p>サーバとの通信に対してタイムアウト時間を指定したい場合は、以下のようなbean定義を行う。</p>
<p><strong>bean定義ファイル(applicationContext.xml)の定義例</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;clientHttpRequestFactory&quot;</span>
      <span class="na">class=</span><span class="s">&quot;org.springframework.http.client.SimpleClientHttpRequestFactory&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;connectTimeout&quot;</span> <span class="na">value=</span><span class="s">&quot;${api.connectTimeout: 2000}&quot;</span> <span class="nt">/&gt;</span><span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;readTimeout&quot;</span> <span class="na">value=</span><span class="s">&quot;${api.readTimeout: 2000}&quot;</span> <span class="nt">/&gt;</span><span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;restTemplate&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.web.client.RestTemplate&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;clientHttpRequestFactory&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">connectTimeout</span></code>プロパティにサーバとの接続タイムアウト時間(ミリ秒)を設定する。</div>
<div class="line">タイムアウト発生時は<code class="docutils literal"><span class="pre">org.springframework.web.client.ResourceAccessException</span></code>が発生する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">readTimeout</span></code>プロパティにレスポンスデータの読み込みタイムアウト時間(ミリ秒)を設定する。</div>
<div class="line">タイムアウト発生時は<code class="docutils literal"><span class="pre">ResourceAccessException</span></code>が発生する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>タイムアウト発生時の起因例外</strong></p>
<p><code class="docutils literal"><span class="pre">ResourceAccessException</span></code>は起因例外をラップしており、接続タイムアウト及び読み込みタイムアウト発生時の起因例外は共に<code class="docutils literal"><span class="pre">java.net.SocketTimeoutException</span></code>である。
デフォルト実装(<code class="docutils literal"><span class="pre">SimpleClientHttpRequestFactory</span></code>)を使用した場合は、どちらのタイムアウトが発生したかを例外クラスの種類で区別できないという点を補足しておく。</p>
<p class="last">なお、他の<code class="docutils literal"><span class="pre">HttpRequestFactory</span></code>を使用した場合の動作は未検証であるため、起因例外が上記と異なる可能性がある。
他の<code class="docutils literal"><span class="pre">HttpRequestFactory</span></code>を使用する場合は、タイムアウト時に発生する例外を把握した上で適切な例外ハンドリングを行うこと。</p>
</div>
</div>
<div class="section" id="ssl">
<span id="restclienthowtousehttps"></span><h3><a class="toc-backref" href="#id65">5.2.2.8. SSL自己署名証明書の使用</a><a class="headerlink" href="#ssl" title="Permalink to this headline">¶</a></h3>
<p>テスト環境などでSSL自己署名証明書を使用する場合は、以下のように実装する。</p>
<p><strong>FactoryBeanの実装例</strong></p>
<p><code class="docutils literal"><span class="pre">RestTemplate</span></code>のBean定義で、コンストラクタの引数に渡す <code class="docutils literal"><span class="pre">org.springframework.http.client.ClientHttpRequestFactory</span></code>を作成するための <code class="docutils literal"><span class="pre">org.springframework.beans.factory.FactoryBean</span></code>を実装する。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.security.KeyStore</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.net.ssl.KeyManagerFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.net.ssl.SSLContext</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.net.ssl.TrustManagerFactory</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.apache.http.client.HttpClient</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.impl.client.HttpClientBuilder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.FactoryBean</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.client.ClientHttpRequestFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.client.HttpComponentsClientHttpRequestFactory</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RequestFactoryBean</span> <span class="kd">implements</span>
        <span class="n">FactoryBean</span><span class="o">&lt;</span><span class="n">ClientHttpRequestFactory</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">keyStoreFileName</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kt">char</span><span class="o">[]</span> <span class="n">keyStorePassword</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">ClientHttpRequestFactory</span> <span class="nf">getObject</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>

        <span class="c1">// (1)</span>
        <span class="n">SSLContext</span> <span class="n">sslContext</span> <span class="o">=</span> <span class="n">SSLContext</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&quot;TLS&quot;</span><span class="p">);</span>

        <span class="n">KeyStore</span> <span class="n">ks</span> <span class="o">=</span> <span class="n">KeyStore</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">KeyStore</span><span class="p">.</span><span class="na">getDefaultType</span><span class="p">());</span>
        <span class="n">ks</span><span class="p">.</span><span class="na">load</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getClassLoader</span><span class="p">()</span>
                <span class="p">.</span><span class="na">getResourceAsStream</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">keyStoreFileName</span><span class="p">),</span>
                <span class="k">this</span><span class="p">.</span><span class="na">keyStorePassword</span><span class="p">);</span>

        <span class="n">KeyManagerFactory</span> <span class="n">kmf</span> <span class="o">=</span> <span class="n">KeyManagerFactory</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">KeyManagerFactory</span>
                <span class="p">.</span><span class="na">getDefaultAlgorithm</span><span class="p">());</span>
        <span class="n">kmf</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="na">keyStorePassword</span><span class="p">);</span>

        <span class="n">TrustManagerFactory</span> <span class="n">tmf</span> <span class="o">=</span> <span class="n">TrustManagerFactory</span>
                <span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">TrustManagerFactory</span><span class="p">.</span><span class="na">getDefaultAlgorithm</span><span class="p">());</span>
        <span class="n">tmf</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">ks</span><span class="p">);</span>

        <span class="n">sslContext</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">kmf</span><span class="p">.</span><span class="na">getKeyManagers</span><span class="p">(),</span> <span class="n">tmf</span><span class="p">.</span><span class="na">getTrustManagers</span><span class="p">(),</span> <span class="kc">null</span><span class="p">);</span>

        <span class="c1">// (2)</span>
        <span class="n">HttpClient</span> <span class="n">httpClient</span> <span class="o">=</span> <span class="n">HttpClientBuilder</span><span class="p">.</span><span class="na">create</span><span class="p">()</span>
                <span class="p">.</span><span class="na">setSSLContext</span><span class="p">(</span><span class="n">sslContext</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>

        <span class="c1">// (3)</span>
        <span class="n">ClientHttpRequestFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpComponentsClientHttpRequestFactory</span><span class="p">(</span>
                <span class="n">httpClient</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">factory</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">getObjectType</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">ClientHttpRequestFactory</span><span class="p">.</span><span class="na">class</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isSingleton</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setKeyStoreFileName</span><span class="p">(</span><span class="n">String</span> <span class="n">keyStoreFileName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">keyStoreFileName</span> <span class="o">=</span> <span class="n">keyStoreFileName</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setKeyStorePassword</span><span class="p">(</span><span class="kt">char</span><span class="o">[]</span> <span class="n">keyStorePassword</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">keyStorePassword</span> <span class="o">=</span> <span class="n">keyStorePassword</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">後述のbean定義で指定されたキーストアファイルのファイル名とパスワードを元に、SSLコンテキストを作成する。</div>
<div class="line">使用するSSL自己署名証明書のキーストアファイルは、クラスパス上に配置する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">作成したSSLコンテキストを利用する <code class="docutils literal"><span class="pre">org.apache.http.client.HttpClient</span></code>を作成する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">作成した<code class="docutils literal"><span class="pre">HttpClient</span></code>を利用する <code class="docutils literal"><span class="pre">ClientHttpRequestFactory</span></code>を作成する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>JDK 11より、TLS(Transport Layer Security) 1.3がデフォルトになった。</p>
<p>通信先のアプリケーションがTLS 1.2以前のバージョンにしか対応していない等の理由により、使用するTLSのバージョンをJVMレベルで変更するには<a class="reference internal" href="../../Appendix/Java11Changes.html#support-tls1-3-by-default-from-java11"><span class="std std-ref">HTTP通信におけるTLS(Transport Layer Security) v1.3のサポート</span></a>を参照されたい。</p>
<p class="last">ただし、JVMレベルで設定してしまうと一つのクライアントアプリからTLS 1.2とTLS 1.3を利用した別々のアプリケーションに接続するような要件を実現することができない。
このような場合は、<code class="docutils literal"><span class="pre">HttpClient</span></code>ごとに利用するTLSのバージョンを指定するような実装を検討されたい。</p>
</div>
<p><code class="docutils literal"><span class="pre">HttpClient</span></code>および  <code class="docutils literal"><span class="pre">HttpClientBuilder</span></code>を使用するためには、Apache HttpComponents HttpClient のライブラリが必要となる。
以下を <code class="file docutils literal"><span class="pre">pom.xml</span></code>に追加し、Apache HttpComponents HttpClient を依存ライブラリに追加する。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">pom.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.apache.httpcomponents<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>httpclient<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">上記設定例は、依存ライブラリのバージョンを親プロジェクトである terasoluna-gfw-parent で管理する前提であるため、pom.xmlでのバージョンの指定は不要である。
上記の依存ライブラリはterasoluna-gfw-parentが依存している<a class="reference external" href="https://docs.spring.io/spring-boot/docs/2.2.4.RELEASE/reference/htmlsingle/#dependency-versions">Spring Boot</a>で管理されている。</p>
</div>
<p><strong>bean定義ファイル(applicationContext.xml)の定義例</strong></p>
<p>SSL自己署名証明書を使用したSSL通信を行う <code class="docutils literal"><span class="pre">RestTemplate</span></code>を定義する。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;httpsRestTemplate&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.web.client.RestTemplate&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;com.example.restclient.RequestFactoryBean&quot;</span><span class="nt">&gt;</span><span class="c">&lt;!-- (1) --&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;keyStoreFileName&quot;</span> <span class="na">value=</span><span class="s">&quot;${rscl.keystore.filename}&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;keyStorePassword&quot;</span> <span class="na">value=</span><span class="s">&quot;${rscl.keystore.password}&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">作成した <code class="docutils literal"><span class="pre">RequestFactoryBean</span></code>を <code class="docutils literal"><span class="pre">RestTemplate</span></code>のコンストラクタに指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">RequestFactoryBean</span></code>には、キーストアファイルのファイル名とパスワードを渡す。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>RestTemplateの使用方法</strong></p>
<p><code class="docutils literal"><span class="pre">RestTemplate</span></code>の使い方については、SSL自己署名証明書を使用しない場合と同じである。</p>
</div>
<div class="section" id="basic">
<span id="restclienthowtouseauthentication"></span><h3><a class="toc-backref" href="#id66">5.2.2.9. Basic認証</a><a class="headerlink" href="#basic" title="Permalink to this headline">¶</a></h3>
<p>サーバがBasic認証を要求する場合は、以下のように実装する。このとき、Java標準の<code class="docutils literal"><span class="pre">java.util.Base64</span></code>を使用する。</p>
<p><strong>Basic認証の実装例</strong></p>
<p>フィールド宣言部</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${api.auth.username}&quot;</span><span class="p">)</span>
<span class="n">String</span> <span class="n">username</span><span class="p">;</span>

<span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${api.auth.password}&quot;</span><span class="p">)</span>
<span class="n">String</span> <span class="n">password</span><span class="p">;</span>
</pre></div>
</div>
<p>メソッド内部</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">plainCredentials</span> <span class="o">=</span> <span class="n">username</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="n">password</span><span class="p">;</span> <span class="c1">// (1)</span>
<span class="n">String</span> <span class="n">base64Credentials</span> <span class="o">=</span> <span class="n">Base64</span><span class="p">.</span><span class="na">getEncoder</span><span class="p">()</span>
        <span class="p">.</span><span class="na">encodeToString</span><span class="p">(</span><span class="n">plainCredentials</span><span class="p">.</span><span class="na">getBytes</span><span class="p">(</span><span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">));</span> <span class="c1">// (2)</span>

<span class="n">RequestEntity</span> <span class="n">requestEntity</span> <span class="o">=</span> <span class="n">RequestEntity</span>
      <span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
      <span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&quot;Authorization&quot;</span><span class="p">,</span> <span class="s">&quot;Basic &quot;</span> <span class="o">+</span> <span class="n">base64Credentials</span><span class="p">)</span> <span class="c1">// (3)</span>
      <span class="p">.</span><span class="na">build</span><span class="p">();</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザ名とパスワードを「”<code class="docutils literal"><span class="pre">:</span></code>” 」でつなげる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">（1）をバイト配列に変換して、Base64エンコードする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">AuthorizationヘッダをBasic認証の資格情報を設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Spring Security 5より、<code class="docutils literal"><span class="pre">org.springframework.security.crypto.codec.Base64</span></code>は非推奨になったため、Java標準の<code class="docutils literal"><span class="pre">java.util.Base64</span></code>に置き換えることを推奨する。</p>
</div>
</div>
<div class="section" id="restclienthowtousefileupload">
<span id="id21"></span><h3><a class="toc-backref" href="#id67">5.2.2.10. ファイルアップロード(マルチパートリクエスト)</a><a class="headerlink" href="#restclienthowtousefileupload" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">RestTemplate</span></code>を使用してファイルアップロード(マルチパートリクエスト)を行う場合は、以下のように実装する。</p>
<p><strong>ファイルアップロードの実装例</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">MultiValueMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">multiPartBody</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedMultiValueMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="c1">//(1)</span>
<span class="n">multiPartBody</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;file&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="n">ClassPathResource</span><span class="p">(</span><span class="s">&quot;/uploadFiles/User.txt&quot;</span><span class="p">));</span><span class="c1">//(2)</span>

<span class="n">RequestEntity</span><span class="o">&lt;</span><span class="n">MultiValueMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;&gt;</span> <span class="n">requestEntity</span> <span class="o">=</span> <span class="n">RequestEntity</span>
        <span class="p">.</span><span class="na">post</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="p">.</span><span class="na">contentType</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">MULTIPART_FORM_DATA</span><span class="p">)</span><span class="c1">//(3)</span>
        <span class="p">.</span><span class="na">body</span><span class="p">(</span><span class="n">multiPartBody</span><span class="p">);</span><span class="c1">//(4)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">マルチパートリクエストとして送信するデータを格納するために<code class="docutils literal"><span class="pre">MultiValueMap</span></code>を生成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パラメータ名をキーに指定して、アップロードするファイルを<code class="docutils literal"><span class="pre">MultiValueMap</span></code>に追加する。</div>
<div class="line">上記例では、<code class="docutils literal"><span class="pre">file</span></code>というパラメータ名を指定して、クラスパス上に配置されているファイルをアップロードファイルとして追加している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Content-Typeヘッダのメディアタイプを<code class="docutils literal"><span class="pre">multipart/form-data</span></code>に設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アップロードするファイルが格納されている<code class="docutils literal"><span class="pre">MultiValueMap</span></code>をリクエストボディに設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Spring Frameworkが提供するResourceクラスについて</strong></p>
<p>Spring Frameworkはリソースを表現するインタフェースとして<code class="docutils literal"><span class="pre">org.springframework.core.io.Resource</span></code>を提供しており、
ファイルをアップロードする際に使用することができる。</p>
<p><code class="docutils literal"><span class="pre">Resource</span></code>インタフェースの主な実装クラスは以下の通りである。</p>
<ul class="last simple">
<li><code class="docutils literal"><span class="pre">org.springframework.core.io.PathResource</span></code></li>
<li><code class="docutils literal"><span class="pre">org.springframework.core.io.FileSystemResource</span></code></li>
<li><code class="docutils literal"><span class="pre">org.springframework.core.io.ClassPathResource</span></code></li>
<li><code class="docutils literal"><span class="pre">org.springframework.core.io.UrlResource</span></code></li>
<li><code class="docutils literal"><span class="pre">org.springframework.core.io.InputStreamResource</span></code>  (ファイル名をサーバに連携できない)</li>
<li><code class="docutils literal"><span class="pre">org.springframework.core.io.ByteArrayResource</span></code>  (ファイル名をサーバに連携できない)</li>
</ul>
</div>
</div>
<div class="section" id="restclienthowtousefiledownload">
<span id="id22"></span><h3><a class="toc-backref" href="#id68">5.2.2.11. ファイルダウンロード</a><a class="headerlink" href="#restclienthowtousefiledownload" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">RestTeamplate</span></code>を使用してファイルダウンロードを行う場合は、以下のように実装する。</p>
<p><strong>ファイルダウンロードの実装例（ファイルサイズが小さい場合）</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">RequestEntity</span> <span class="n">requestEntity</span> <span class="o">=</span> <span class="n">RequestEntity</span>
        <span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="p">.</span><span class="na">build</span><span class="p">();</span>

<span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">responseEntity</span> <span class="o">=</span>
        <span class="n">restTemplate</span><span class="p">.</span><span class="na">exchange</span><span class="p">(</span><span class="n">requestEntity</span><span class="p">,</span> <span class="kt">byte</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="c1">//(1)</span>

<span class="kt">byte</span><span class="o">[]</span> <span class="n">downloadContent</span> <span class="o">=</span> <span class="n">responseEntity</span><span class="p">.</span><span class="na">getBody</span><span class="p">();</span><span class="c1">//(2)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ダウンロードファイルを指定したデータ型で扱う。ここでは、バイト配列を指定。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">レスポンスボディからダウンロードしたファイルのデータを取得する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>サイズの大きいファイルをダウンロードする際の注意点</strong></p>
<p class="last">サイズの大きなファイルをデフォルトで登録されている<code class="docutils literal"><span class="pre">HttpMessageConverter</span></code>を使用して <code class="docutils literal"><span class="pre">byte</span></code>配列で取得すると、 <code class="docutils literal"><span class="pre">java.lang.OutOfMemoryError</span></code>が発生する可能性がある。
そのため、サイズの大きなファイルをダウンロードしたい場合は、レスポンスから <code class="docutils literal"><span class="pre">InputStream</span></code>を取得して、ダウンロードデータを少しずつファイルに書き出す必要がある。</p>
</div>
<p id="restclienthowtousebigfiledownload"><strong>ファイルダウンロードの実装例（ファイルサイズが大きい場合）</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="kd">final</span> <span class="n">ResponseExtractor</span><span class="o">&lt;</span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;&gt;</span> <span class="n">responseExtractor</span> <span class="o">=</span>
        <span class="k">new</span> <span class="n">ResponseExtractor</span><span class="o">&lt;</span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;&gt;</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">// (2)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="nf">extractData</span><span class="p">(</span><span class="n">ClientHttpResponse</span> <span class="n">response</span><span class="p">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span> <span class="p">{</span>

        <span class="n">File</span> <span class="n">rcvFile</span> <span class="o">=</span> <span class="n">File</span><span class="p">.</span><span class="na">createTempFile</span><span class="p">(</span><span class="s">&quot;rcvFile&quot;</span><span class="p">,</span> <span class="s">&quot;zip&quot;</span><span class="p">);</span>

        <span class="n">FileCopyUtils</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">getBody</span><span class="p">(),</span> <span class="k">new</span> <span class="n">FileOutputStream</span><span class="p">(</span><span class="n">rcvFile</span><span class="p">));</span>

        <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">getStatusCode</span><span class="p">())</span>
                <span class="p">.</span><span class="na">headers</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">getHeaders</span><span class="p">()).</span><span class="na">body</span><span class="p">(</span><span class="n">rcvFile</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">};</span>

<span class="c1">// (3)</span>
<span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="n">responseEntity</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">restTemplate</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">targetUri</span><span class="p">,</span>
        <span class="n">HttpMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="n">responseExtractor</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">responseEntity</span><span class="p">.</span><span class="na">getStatusCode</span><span class="p">()))</span> <span class="p">{</span>
    <span class="n">File</span> <span class="n">getFile</span> <span class="o">=</span> <span class="n">responseEntity</span><span class="p">.</span><span class="na">getBody</span><span class="p">();</span>

    <span class="p">.....</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RestTemplate#execute</span></code>で取得されたレスポンスから、<code class="docutils literal"><span class="pre">RestTemplate#execute</span></code>の戻り値を作成するための処理を作成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">レスポンスボディ(<code class="docutils literal"><span class="pre">InputStream</span></code>)からデータを読込み、ファイルを作成する。</div>
<div class="line">作成したファイルとHTTPヘッダ、ステータスコードを <code class="docutils literal"><span class="pre">ResponseEntity&lt;File&gt;</span></code>に格納して返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RestTemplate#execute</span></code>を使用して、ファイルのダウンロードを行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>ファイルダウンロードの実装例（ファイルサイズが大きい場合（ResponseEntityを使わない例））</strong></p>
<p>ステータスコードの判定やHTTPヘッダの参照等が不要な場合は、 以下のように<code class="docutils literal"><span class="pre">ResponseEntity</span></code>ではなく <code class="docutils literal"><span class="pre">File</span></code>を返却すればよい。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">final</span> <span class="n">ResponseExtractor</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="n">responseExtractor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResponseExtractor</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">File</span> <span class="nf">extractData</span><span class="p">(</span><span class="n">ClientHttpResponse</span> <span class="n">response</span><span class="p">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span> <span class="p">{</span>

        <span class="n">File</span> <span class="n">rcvFile</span> <span class="o">=</span> <span class="n">File</span><span class="p">.</span><span class="na">createTempFile</span><span class="p">(</span><span class="s">&quot;rcvFile&quot;</span><span class="p">,</span> <span class="s">&quot;zip&quot;</span><span class="p">);</span>

        <span class="n">FileCopyUtils</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">getBody</span><span class="p">(),</span> <span class="k">new</span> <span class="n">FileOutputStream</span><span class="p">(</span>
                <span class="n">rcvFile</span><span class="p">));</span>

        <span class="k">return</span> <span class="n">rcvFile</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">};</span>

<span class="n">File</span> <span class="n">getFile</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">restTemplate</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">targetUri</span><span class="p">,</span> <span class="n">HttpMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">,</span>
        <span class="kc">null</span><span class="p">,</span> <span class="n">responseExtractor</span><span class="p">);</span>
<span class="p">.....</span>
</pre></div>
</div>
</div>
<div class="section" id="restfulurl-uri">
<span id="restclienthowtouserestfull"></span><h3><a class="toc-backref" href="#id69">5.2.2.12. RESTfulなURL(URIテンプレート)を扱う方法と実装例</a><a class="headerlink" href="#restfulurl-uri" title="Permalink to this headline">¶</a></h3>
<p>RESTfulなURLを扱うには、URIテンプレートを使用して実装を行えばよい。</p>
<p><strong>getForObjectメソッドでの使用例</strong></p>
<p>フィールド宣言部</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${api.serverUrl}/api/users/{userId}&quot;</span><span class="p">)</span> <span class="c1">// (1)</span>
<span class="n">String</span> <span class="n">uriStr</span><span class="p">;</span>
</pre></div>
</div>
<p>メソッド内部</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">restTemplate</span><span class="p">.</span><span class="na">getForObject</span><span class="p">(</span><span class="n">uriStr</span><span class="p">,</span> <span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="s">&quot;0001&quot;</span><span class="p">);</span> <span class="c1">// (2)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">URIテンプレートの変数{userId}は、<code class="docutils literal"><span class="pre">RestTeamplate</span></code>の使用時に指定の値に変換される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">URIテンプレートの変数1つ目が <code class="docutils literal"><span class="pre">getForObject</span></code>メソッドの第3引数に指定した値で置換され、『<a class="reference external" href="http://localhost:8080/api/users/0001">http://localhost:8080/api/users/0001</a>』として処理される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>exchangeメソッドでの使用例</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${api.serverUrl}/api/users/{action}&quot;</span><span class="p">)</span> <span class="c1">// (1)</span>
<span class="n">String</span> <span class="n">uriStr</span><span class="p">;</span>
</pre></div>
</div>
<p>メソッド内部</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">URI</span> <span class="n">targetUri</span> <span class="o">=</span> <span class="n">UriComponentsBuilder</span><span class="p">.</span><span class="na">fromUriString</span><span class="p">(</span><span class="n">uriStr</span><span class="p">).</span>
        <span class="n">buildAndExpand</span><span class="p">(</span><span class="s">&quot;create&quot;</span><span class="p">).</span><span class="na">toUri</span><span class="p">();</span> <span class="c1">//(2)</span>

<span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="p">();</span>

<span class="c1">//...</span>

<span class="n">RequestEntity</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">requestEntity</span> <span class="o">=</span> <span class="n">RequestEntity</span>
        <span class="p">.</span><span class="na">post</span><span class="p">(</span><span class="n">targetUri</span><span class="p">)</span>
        <span class="p">.</span><span class="na">body</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>

<span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">responseEntity</span> <span class="o">=</span> <span class="n">restTemplate</span><span class="p">.</span><span class="na">exchange</span><span class="p">(</span><span class="n">requestEntity</span><span class="p">,</span> <span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">URIテンプレートの変数{action}は、<code class="docutils literal"><span class="pre">RestTeamplate</span></code>の使用時に指定の値に変換される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UriComponentsBuilder</span></code>を使用することで、URIテンプレートの変数1つ目が <code class="docutils literal"><span class="pre">buildAndExpand</span></code>の引数で指定した値に置換され、『<a class="reference external" href="http://localhost:8080/api/users/create">http://localhost:8080/api/users/create</a>』のURIが作成される。</div>
<div class="line">詳細は<a class="reference external" href="https://docs.spring.io/spring/docs/5.2.20.RELEASE/javadoc-api/org/springframework/web/util/UriComponentsBuilder.html">UriComponentsBuilder</a>のJavadocを参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="how-to-extend">
<span id="restclienthowtoextend"></span><h2><a class="toc-backref" href="#id70">5.2.3. How to extend</a><a class="headerlink" href="#how-to-extend" title="Permalink to this headline">¶</a></h2>
<p>本節では、<code class="docutils literal"><span class="pre">RestTemplate</span></code>の拡張方法について説明する。</p>
<div class="section" id="restclienthowtoextendhttpmessageconverter">
<span id="id23"></span><h3><a class="toc-backref" href="#id71">5.2.3.1. 任意の<code class="docutils literal"><span class="pre">HttpMessageConverter</span></code>を登録する方法</a><a class="headerlink" href="#restclienthowtoextendhttpmessageconverter" title="Permalink to this headline">¶</a></h3>
<p>デフォルトで登録されている <code class="docutils literal"><span class="pre">HttpMessageConverter</span></code>で電文変換の要件を満たせない場合は、任意の<code class="docutils literal"><span class="pre">HttpMessageConverter</span></code>を登録することができる。
ただし、デフォルトで登録されていた<code class="docutils literal"><span class="pre">HttpMessageConverter</span></code>は削除されるので、必要な<code class="docutils literal"><span class="pre">HttpMessageConverter</span></code>をすべて個別に登録する必要がある。</p>
<p><strong>bean定義ファイル(applicationContext.xml)の定義例</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;jaxb2CollectionHttpMessageConverter&quot;</span>
      <span class="na">class=</span><span class="s">&quot;org.springframework.http.converter.xml.Jaxb2CollectionHttpMessageConverter&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;restTemplate&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.web.client.RestTemplate&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;messageConverters&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;list&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;jaxb2CollectionHttpMessageConverter&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">登録する<code class="docutils literal"><span class="pre">HttpMessageConverter</span></code>の実装クラスをbean定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">messageConverters</span></code>プロパティに登録する<code class="docutils literal"><span class="pre">HttpMessageConverter</span></code>のbeanをインジェクションする。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="restclienthowtoextendclienthttprequestinterceptor">
<span id="id24"></span><h3><a class="toc-backref" href="#id72">5.2.3.2. 共通処理の適用（<code class="docutils literal"><span class="pre">ClientHttpRequestInterceptor</span></code>）</a><a class="headerlink" href="#restclienthowtoextendclienthttprequestinterceptor" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">ClientHttpRequestInterceptor</span></code>を使用することで、サーバとの通信処理の前後に任意の処理を実行させることができる。</div>
<div class="line">ここでは、<a class="reference internal" href="#restclienthowtoextendclienthttprequestinterceptorlogging"><span class="std std-ref">ロギング処理</span></a> と、<a class="reference internal" href="#restclientbasicauthorizationinterceptorbeandefinition"><span class="std std-ref">Basic認証用のリクエストヘッダ設定処理</span></a> を適用する方法を紹介する。</div>
</div>
<div class="section" id="restclienthowtoextendclienthttprequestinterceptorlogging">
<span id="id25"></span><h4><a class="toc-backref" href="#id73">5.2.3.2.1. ロギング処理</a><a class="headerlink" href="#restclienthowtoextendclienthttprequestinterceptorlogging" title="Permalink to this headline">¶</a></h4>
<p>サーバとの通信ログを出力したい場合は、以下のような実装を行う。</p>
<p><strong>通信ログ出力の実装例</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.restclient</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.http.HttpRequest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.client.ClientHttpRequestExecution</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.client.ClientHttpRequestInterceptor</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.client.ClientHttpResponse</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoggingInterceptor</span> <span class="kd">implements</span> <span class="n">ClientHttpRequestInterceptor</span> <span class="p">{</span> <span class="c1">//(1)</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">LoggingInterceptor</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">ClientHttpResponse</span> <span class="nf">intercept</span><span class="p">(</span><span class="n">HttpRequest</span> <span class="n">request</span><span class="p">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">body</span><span class="p">,</span>
            <span class="n">ClientHttpRequestExecution</span> <span class="n">execution</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isInfoEnabled</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">String</span> <span class="n">requestBody</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">);</span>

            <span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Request Header {}&quot;</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="na">getHeaders</span><span class="p">());</span> <span class="c1">//(2)</span>
            <span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Request Body {}&quot;</span><span class="p">,</span> <span class="n">requestBody</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">ClientHttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">execution</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">body</span><span class="p">);</span> <span class="c1">//(3)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isInfoEnabled</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Response Header {}&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="na">getHeaders</span><span class="p">());</span> <span class="c1">// (4)</span>
            <span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Response Status Code {}&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="na">getStatusCode</span><span class="p">());</span> <span class="c1">// (5)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">response</span><span class="p">;</span> <span class="c1">// (6)</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ClientHttpRequestInterceptor</span></code>インタフェースを実装する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエストする前に行いたい共通処理を実装する。</div>
<div class="line">上記の実装例では、リクエストヘッダーとリクエストボディの内容をログに出力している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">intercept</span></code>メソッドの引数として受け取った<code class="docutils literal"><span class="pre">ClientHttpRequestExecution</span></code>の<code class="docutils literal"><span class="pre">execute</span></code>メソッドを実行し、リクエストの送信を実行する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">レスポンスを受け取った後に行いたい共通処理を実装する。</div>
<div class="line">上記の実装例では、レスポンスヘッダの内容をログに出力している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(4)と同様に、ステータスコードの内容をログに出力している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(3)で受信したレスポンスをリターンする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>bean定義ファイル(applicationContext.xml)の定義例</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;loggingInterceptor&quot;</span> <span class="na">class=</span><span class="s">&quot;com.example.restclient.LoggingInterceptor&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ClientHttpRequestInterceptor</span></code>の実装クラスのbean定義を行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="restclientbasicauthorizationinterceptorbeandefinition">
<span id="id26"></span><h4><a class="toc-backref" href="#id74">5.2.3.2.2. Basic認証用のリクエストヘッダ設定処理</a><a class="headerlink" href="#restclientbasicauthorizationinterceptorbeandefinition" title="Permalink to this headline">¶</a></h4>
<p>サーバにアクセスするためにBasic認証用のリクエストヘッダを設定する必要がある場合は、以下のようなbean定義を行う。</p>
<p><strong>bean定義ファイル(applicationContext.xml)の定義例</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;basicAuthInterceptor&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.http.client.support.BasicAuthorizationInterceptor&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">value=</span><span class="s">&quot;${api.auth.username}&quot;</span> <span class="nt">/&gt;</span><span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span> <span class="na">value=</span><span class="s">&quot;${api.auth.password}&quot;</span> <span class="nt">/&gt;</span><span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ClientHttpRequestInterceptor</span></code>インタフェースを実装した<code class="docutils literal"><span class="pre">BasicAuthorizationInterceptor</span></code>のbean定義を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">コンストラクタの第一引数にユーザ名を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">コンストラクタの第二引数にパスワードを設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id27">
<h4><a class="toc-backref" href="#id75">5.2.3.2.3. <code class="docutils literal"><span class="pre">ClientHttpRequestInterceptor</span></code>の適用</a><a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">RestTemplate</span></code>に作成した<code class="docutils literal"><span class="pre">ClientHttpRequestInterceptor</span></code>を適用する場合は、以下のようなbean定義を行う。</p>
<p><strong>bean定義ファイル(applicationContext.xml)の定義例</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;restTemplate&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.web.client.RestTemplate&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;interceptors&quot;</span><span class="nt">&gt;</span><span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;list&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;basicAuthInterceptor&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;loggingInterceptor&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">interceptors</span></code>プロパティに<code class="docutils literal"><span class="pre">ClientHttpRequestInterceptor</span></code>のbeanをインジェクションする。</div>
<div class="line">複数のbeanをインジェクションした場合は、リストの先頭から順にチェーン実行される。</div>
<div class="line">上記の例だと、<code class="docutils literal"><span class="pre">BasicAuthorizationInterceptor</span></code> -&gt; <code class="docutils literal"><span class="pre">LoggingInterceptor</span></code> -&gt; <code class="docutils literal"><span class="pre">ClientHttpRequest</span></code> の順番でリクエスト前の処理が実行される。(レスポンス後の処理は順番が逆転する)</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="restclientasync">
<span id="id28"></span><h3><a class="toc-backref" href="#id76">5.2.3.3. 非同期リクエスト</a><a class="headerlink" href="#restclientasync" title="Permalink to this headline">¶</a></h3>
<p>非同期リクエストを行う場合は、<code class="docutils literal"><span class="pre">org.springframework.web.client.AsyncRestTemplate</span></code>を使用する。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Spring Framework 5.0から、Spring Web Reactiveの機能として<code class="docutils literal"><span class="pre">RestTemplate</span></code>の後継となる<code class="docutils literal"><span class="pre">WebClient</span></code>が提供された。これに伴い<code class="docutils literal"><span class="pre">AsyncRestTemplate</span></code>は非推奨となった。将来のバージョンでは<code class="docutils literal"><span class="pre">RestTemplate</span></code>も非推奨となる予定であり、今後は主要な新機能の追加はされずメンテナンスのみとなることがアナウンスされている。</p>
<p class="last">TERASOLUNA Server Framework for Java (5.x)ではSpring Web Reactiveをサポートしていないため、<code class="docutils literal"><span class="pre">WebClient</span></code>への移行は推奨していない。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="asyncresttemplatebean">
<span id="restclientasyncbeandefinition"></span><h4><a class="toc-backref" href="#id77">5.2.3.3.1. <code class="docutils literal"><span class="pre">AsyncRestTemplate</span></code>のbean定義</a><a class="headerlink" href="#asyncresttemplatebean" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">AsyncRestTemplate</span></code>のbean定義を行う。</p>
<p><strong>bean定義ファイル(applicationContext.xml)の定義例</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;asyncRestTemplate&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.web.client.AsyncRestTemplate&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AsyncRestTemplate</span></code>をデフォルト設定のまま利用する場合は、デフォルトコンストラクタを使用してbeanを登録する。</div>
<div class="line">デフォルト設定の場合、<code class="docutils literal"><span class="pre">AsyncRestTemplate</span></code>の<code class="docutils literal"><span class="pre">org.springframework.http.client.AsyncClientHttpRequestFactory</span></code>には、<code class="docutils literal"><span class="pre">org.springframework.core.task.AsyncListenableTaskExecutor</span></code>として<code class="docutils literal"><span class="pre">org.springframework.core.task.SimpleAsyncTaskExecutor</span></code>が設定された <code class="docutils literal"><span class="pre">SimpleClientHttpRequestFactory</span></code>が設定される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>AsyncRestTemplateのカスタマイズ方法</strong></p>
<p>デフォルトで設定される<code class="docutils literal"><span class="pre">SimpleAsyncTaskExecutor</span></code>は、スレッドプールを使わずにスレッドを生成しており、
スレッドの同時実行数に制限は無い。
そのため、同時に使用するスレッド数が非常に大きい場合はOutOfMemoryErrorが発生する可能性がある。</p>
<p><code class="docutils literal"><span class="pre">AsyncRestTemplate</span></code>のコンストラクタに<code class="docutils literal"><span class="pre">org.springframework.core.task.AsyncListenableTaskExecutor</span></code>インターフェースのBeanを設定することで、スレッドプールの設定を行える。
下記は<code class="docutils literal"><span class="pre">org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor</span></code>を設定する例である。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;asyncTaskExecutor&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;corePoolSize&quot;</span> <span class="na">value=</span><span class="s">&quot;5&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;queueCapacity&quot;</span> <span class="na">value=</span><span class="s">&quot;25&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxPoolSize&quot;</span> <span class="na">value=</span><span class="s">&quot;10&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- (5) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;asyncRestTemplate&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.web.client.AsyncRestTemplate&quot;</span> <span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">ref=</span><span class="s">&quot;asyncTaskExecutor&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AsyncTaskExecutor</span></code>のbean定義を行う。</div>
<div class="line"><code class="docutils literal"><span class="pre">ThreadPoolTaskExecutor</span></code>を使うことで、スレッドプールを使ったスレッド運用が行われる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">corePoolSize</span></code>プロパティを設定することで、通常使用するスレッド数のカスタマイズを行える。</div>
<div class="line">タスク実行時にプール内のスレッド数が<code class="docutils literal"><span class="pre">corePoolSize</span></code>未満の場合、アイドル状態のスレッドが存在していてもプール内に新しいスレッドが作成される。</div>
<div class="line">デフォルト値は<code class="docutils literal"><span class="pre">1</span></code>。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">queueCapacity</span></code>プロパティを設定すると、キュー容量のカスタマイズを行える。</div>
<div class="line"><code class="docutils literal"><span class="pre">corePoolSize</span></code>を超えたリクエストは、<code class="docutils literal"><span class="pre">queueCapacity</span></code>までキューイングされる。</div>
<div class="line">デフォルト値は<code class="docutils literal"><span class="pre">Integer.MAX_VALUE</span></code>。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">maxPoolSize</span></code>プロパティを設定することで、最大スレッド数のカスタマイズを行える。</div>
<div class="line">リクエストが<code class="docutils literal"><span class="pre">queueCapacity</span></code>を超えた場合、<code class="docutils literal"><span class="pre">maxPoolSize</span></code>まで新しいスレッドを作成する。</div>
<div class="line">デフォルト値は<code class="docutils literal"><span class="pre">Integer.MAX_VALUE</span></code>。</div>
<div class="line">キュー容量、 スレッド数が共に飽和状態の場合、新しいタスクは拒否される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AsyncRestTemplate</span></code>のbean定義を行う。</div>
<div class="line"><code class="docutils literal"><span class="pre">ThreadPoolTaskExecutor</span></code>を引数に指定するコンストラクタを使用してbeanを登録する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>本ガイドラインでは、タスク実行処理をカスタマイズする実装例のみを紹介するが、
<code class="docutils literal"><span class="pre">AsyncRestTemplate</span></code>は、HTTP通信処理もカスタマイズ出来る。
詳細は<a class="reference external" href="https://docs.spring.io/spring/docs/5.2.20.RELEASE/javadoc-api/org/springframework/web/client/AsyncRestTemplate.html">AsyncRestTemplate</a>のJavadocを参照されたい。</p>
<p class="last">また、<code class="docutils literal"><span class="pre">ThreadPoolTaskExecutor</span></code>についても、スレッドプールサイズ以外のカスタマイズが出来る。
詳細は<a class="reference external" href="https://docs.spring.io/spring/docs/5.2.20.RELEASE/javadoc-api/org/springframework/scheduling/concurrent/ThreadPoolTaskExecutor.html">ThreadPoolTaskExecutor</a>のJavadocを参照されたい。</p>
</div>
</div>
<div class="section" id="restclientasyncimplementation">
<span id="id29"></span><h4><a class="toc-backref" href="#id78">5.2.3.3.2. 非同期リクエストの実装</a><a class="headerlink" href="#restclientasyncimplementation" title="Permalink to this headline">¶</a></h4>
<p><strong>非同期リクエストの実装例</strong></p>
<p>フィールド宣言部</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="n">AsyncRestTemplate</span> <span class="n">asyncRestTemplate</span><span class="p">;</span>
</pre></div>
</div>
<p>メソッド内部</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">ListenableFuture</span><span class="o">&lt;</span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;</span> <span class="n">responseEntity</span> <span class="o">=</span>
        <span class="n">asyncRestTemplate</span><span class="p">.</span><span class="na">getForEntity</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">);</span> <span class="c1">// (1)</span>

<span class="n">responseEntity</span><span class="p">.</span><span class="na">addCallback</span><span class="p">(</span><span class="k">new</span> <span class="n">ListenableFutureCallback</span><span class="o">&lt;</span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// (2)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSuccess</span><span class="p">(</span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">entity</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onFailure</span><span class="p">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">//...</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AsyncRestTemplate</span></code>の各メソッドを使用して、非同期リクエストを送信する。</div>
<div class="line">上記の実装例では、<code class="docutils literal"><span class="pre">getForEntity</span></code>メソッドを使用している。</div>
<div class="line">戻り値は、<code class="docutils literal"><span class="pre">org.springframework.util.concurrent.ListenableFuture</span></code>にラップされた、<code class="docutils literal"><span class="pre">ResponseEntity</span></code>となっている。</div>
<div class="line">各メソッドの使用方法は、<code class="docutils literal"><span class="pre">RestTemplate</span></code>と似たものとなっている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ListenableFuture</span></code>に<code class="docutils literal"><span class="pre">org.springframework.util.concurrent.ListenableFutureCallback</span></code>を登録して、レスポンスが返ってきた際の処理を実装する。</div>
<div class="line">成功のレスポンスが返ってきた場合の処理は<code class="docutils literal"><span class="pre">onSuccess</span></code>メソッドに、エラーが発生した場合の処理は<code class="docutils literal"><span class="pre">onFailure</span></code>メソッドに実装する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id30">
<h4><a class="toc-backref" href="#id79">5.2.3.3.3. 非同期リクエストの共通処理の実装</a><a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">org.springframework.http.client.AsyncClientHttpRequestInterceptor</span></code>を使用することで、サーバとの通信処理の前後に任意の処理を実行させることができる。</p>
<p>ここでは、ロギング処理の実装例を紹介する。</p>
<p><strong>通信ログ出力の実装例</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.restclient</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.nio.charset.StandardCharsets</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpRequest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.client.AsyncClientHttpRequestExecution</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.client.AsyncClientHttpRequestInterceptor</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.client.ClientHttpResponse</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.concurrent.ListenableFuture</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.concurrent.ListenableFutureCallback</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AsyncLoggingInterceptor</span> <span class="kd">implements</span>
                                     <span class="n">AsyncClientHttpRequestInterceptor</span> <span class="p">{</span> <span class="c1">// (1)</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span>
            <span class="n">AsyncLoggingInterceptor</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">ListenableFuture</span><span class="o">&lt;</span><span class="n">ClientHttpResponse</span><span class="o">&gt;</span> <span class="nf">intercept</span><span class="p">(</span><span class="n">HttpRequest</span> <span class="n">request</span><span class="p">,</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">body</span><span class="p">,</span>
            <span class="n">AsyncClientHttpRequestExecution</span> <span class="n">execution</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="p">{</span>
        <span class="c1">// (2)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isInfoEnabled</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">String</span> <span class="n">requestBody</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">);</span>

            <span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Request Header {}&quot;</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="na">getHeaders</span><span class="p">());</span>
            <span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Request Body {}&quot;</span><span class="p">,</span> <span class="n">requestBody</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// (3)</span>
        <span class="n">ListenableFuture</span><span class="o">&lt;</span><span class="n">ClientHttpResponse</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">execution</span><span class="p">.</span><span class="na">executeAsync</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span> <span class="n">body</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isInfoEnabled</span><span class="p">())</span> <span class="p">{</span>
            <span class="c1">// (4)</span>
            <span class="n">future</span><span class="p">.</span><span class="na">addCallback</span><span class="p">(</span><span class="k">new</span> <span class="n">ListenableFutureCallback</span><span class="o">&lt;</span><span class="n">ClientHttpResponse</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>

                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSuccess</span><span class="p">(</span><span class="n">ClientHttpResponse</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">try</span> <span class="p">{</span>
                        <span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Response Header {}&quot;</span><span class="p">,</span> <span class="n">response</span>
                                <span class="p">.</span><span class="na">getHeaders</span><span class="p">());</span>
                        <span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Response Status Code {}&quot;</span><span class="p">,</span> <span class="n">response</span>
                                <span class="p">.</span><span class="na">getStatusCode</span><span class="p">());</span>
                    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">logger</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;I/O Error&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onFailure</span><span class="p">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Communication Error&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">future</span><span class="p">;</span> <span class="c1">// (5)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AsyncClientHttpRequestInterceptor</span></code>インタフェースを実装する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">非同期リクエストを送信する前に実行する処理を実装する。</div>
<div class="line">上記の実装例では、リクエストヘッダとリクエストボディの内容をログに出力している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">intercept</span></code>メソッドの引数として受け取った<code class="docutils literal"><span class="pre">AsyncClientHttpRequestExecution</span></code>の<code class="docutils literal"><span class="pre">executeAsync</span></code>メソッドを使用して、非同期リクエストを送信する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">(3)で受け取った<code class="docutils literal"><span class="pre">ListenableFuture</span></code>に<code class="docutils literal"><span class="pre">org.springframework.util.concurrent.ListenableFutureCallback</span></code>を登録して、レスポンスが返ってきた際の処理を実装する。</div>
<div class="line">レスポンスが返却された場合、<code class="docutils literal"><span class="pre">onSuccess</span></code>メソッドが呼び出される。</div>
<div class="line">また、非同期リクエスト時に例外が発生した場合、<code class="docutils literal"><span class="pre">onFailure</span></code>メソッドが呼び出される。以下に具体例を示す。</div>
</div>
<ul class="last simple">
<li>指定したホストに接続できない（<code class="docutils literal"><span class="pre">ConnectException</span></code>）</li>
<li>レスポンスデータの読み込みタイムアウトが発生した（<code class="docutils literal"><span class="pre">SocketTimeoutException</span></code>）</li>
</ul>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(3)で受け取った<code class="docutils literal"><span class="pre">ListenableFuture</span></code>をリターンする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>bean定義ファイル(applicationContext.xml)の定義例</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;asyncLoggingInterceptor&quot;</span> <span class="na">class=</span><span class="s">&quot;com.example.restclient.AsyncLoggingInterceptor&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;asyncRestTemplate&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.web.client.AsyncRestTemplate&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;interceptors&quot;</span><span class="nt">&gt;</span><span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;list&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;asyncLoggingInterceptor&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AsyncClientHttpRequestInterceptor</span></code>の実装クラスのbean定義を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">interceptors</span></code>プロパティに<code class="docutils literal"><span class="pre">AsyncClientHttpRequestInterceptor</span></code>のbeanをインジェクションする。</div>
<div class="line">複数のbeanをインジェクションした場合は、<code class="docutils literal"><span class="pre">RestTemplate</span></code>と同様にリストの先頭から順にチェーン実行される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="section" id="appendix">
<span id="restclientappendix"></span><h2><a class="toc-backref" href="#id80">5.2.4. Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this headline">¶</a></h2>
<div class="section" id="http-proxy">
<span id="restclientproxysettings"></span><h3><a class="toc-backref" href="#id81">5.2.4.1. HTTP Proxyサーバの設定方法</a><a class="headerlink" href="#http-proxy" title="Permalink to this headline">¶</a></h3>
<p>サーバへアクセスする際にHTTP Proxyサーバを経由する必要がある場合は、システムプロパティやJVM起動引数、または<code class="docutils literal"><span class="pre">RestTemplate</span></code>のBean定義にてHTTP Proxyサーバの設定が必要となる。
システムプロパティやJVM起動引数に設定した場合、アプリケーション全体に影響を与えてしまうため、<code class="docutils literal"><span class="pre">RestTemplate</span></code>毎にHTTP Proxyサーバの設定を行う例を紹介する。</p>
<p><code class="docutils literal"><span class="pre">RestTemplate</span></code>毎のHTTP Proxyサーバの設定は、<code class="docutils literal"><span class="pre">ClientHttpRequestFactory</span></code>インタフェースのデフォルト実装である<code class="docutils literal"><span class="pre">SimpleClientHttpRequestFactory</span></code>に付与することが可能である。
ただし<code class="docutils literal"><span class="pre">SimpleClientHttpRequestFactory</span></code>では資格情報を設定することはできないため、Proxy認証を行う場合は<code class="docutils literal"><span class="pre">HttpComponentsClientHttpRequestFactory</span></code>を使用する。
<code class="docutils literal"><span class="pre">HttpComponentsClientHttpRequestFactory</span></code>は、<code class="docutils literal"><span class="pre">Apache</span> <span class="pre">HttpComponents</span> <span class="pre">HttpClient</span></code>を用いてリクエストを生成する<code class="docutils literal"><span class="pre">ClientHttpRequestFactory</span></code>インタフェースの実装クラスである。</p>
<div class="section" id="simpleclienthttprequestfactoryhttp-proxy">
<h4><a class="toc-backref" href="#id82">5.2.4.1.1. SimpleClientHttpRequestFactoryを使用したHTTP Proxyサーバの設定方法</a><a class="headerlink" href="#simpleclienthttprequestfactoryhttp-proxy" title="Permalink to this headline">¶</a></h4>
<p>資格情報が不要なHTTP Proxyサーバの接続先の指定については、<code class="docutils literal"><span class="pre">RestTemplate</span></code>がデフォルトで使用する<code class="docutils literal"><span class="pre">SimpleClientHttpRequestFactory</span></code>で指定することが可能である。</p>
<p><strong>Bean定義ファイル</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;inetSocketAddress&quot;</span> <span class="na">class=</span><span class="s">&quot;java.net.InetSocketAddress&quot;</span> <span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">value=</span><span class="s">&quot;${rscl.http.proxyHost}&quot;</span> <span class="nt">/&gt;</span>    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span> <span class="na">value=</span><span class="s">&quot;${rscl.http.proxyPort}&quot;</span> <span class="nt">/&gt;</span>    <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;simpleClientRestTemplate&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.web.client.RestTemplate&quot;</span> <span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg&gt;</span>
        <span class="c">&lt;!-- (5) --&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.http.client.SimpleClientHttpRequestFactory&quot;</span><span class="nt">&gt;</span>
            <span class="c">&lt;!-- (6) --&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;proxy&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;java.net.Proxy&quot;</span> <span class="nt">&gt;</span>
                    <span class="c">&lt;!-- (7) --&gt;</span>
                    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;util:constant</span> <span class="na">static-field=</span><span class="s">&quot;java.net.Proxy.Type.HTTP&quot;</span><span class="nt">/&gt;</span>
                    <span class="nt">&lt;/constructor-arg&gt;</span>
                    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span> <span class="na">ref=</span><span class="s">&quot;inetSocketAddress&quot;</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;/bean&gt;</span>
            <span class="nt">&lt;/property&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">java.net.InetSocketAddress</span></code>にHTTP Proxyサーバの設定を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">InetSocketAddress</span></code>のコンストラクタの第一引数に、プロパティファイルに設定されたキー<code class="docutils literal"><span class="pre">rscl.http.proxyHost</span></code>の値をHTTP Proxyサーバのホスト名として設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">InetSocketAddress</span></code>のコンストラクタの第二引数に、プロパティファイルに設定されたキー<code class="docutils literal"><span class="pre">rscl.http.proxyPort</span></code>の値をHTTP Proxyサーバのポート番号として設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RestTemplate</span></code>のBean定義を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RestTemplate</span></code>のコンストラクタの引数に、<code class="docutils literal"><span class="pre">SimpleClientHttpRequestFactory</span></code>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">SimpleClientHttpRequestFactory</span></code>の<code class="docutils literal"><span class="pre">proxy</span></code>プロパティに<code class="docutils literal"><span class="pre">java.net.Proxy</span></code>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Proxy</span></code>のコンストラクタの引数に、<code class="docutils literal"><span class="pre">java.net.Proxy.Type.HTTP</span></code>と生成した<code class="docutils literal"><span class="pre">InetSocketAddress</span></code>を設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="httpcomponentsclienthttprequestfactoryhttp-proxy">
<h4><a class="toc-backref" href="#id83">5.2.4.1.2. HttpComponentsClientHttpRequestFactoryを使用したHTTP Proxyサーバの設定方法</a><a class="headerlink" href="#httpcomponentsclienthttprequestfactoryhttp-proxy" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id31">
<h5>5.2.4.1.2.1. HTTP Proxyサーバの指定方法<a class="headerlink" href="#id31" title="Permalink to this headline">¶</a></h5>
<p>資格情報が必要なHTTP Proxyサーバの接続先の指定は、<code class="docutils literal"><span class="pre">RestTemplate</span></code>に対して、<code class="docutils literal"><span class="pre">HttpComponentsClientHttpRequestFactory</span></code>を使用し指定する。</p>
<p><strong>pom.xml</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.apache.httpcomponents<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>httpclient<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">HttpComponentsClientHttpRequestFactory</span></code>内で使用する<code class="docutils literal"><span class="pre">Apache</span> <span class="pre">HTTP</span> <span class="pre">Client</span></code>を使用するために、<code class="docutils literal"><span class="pre">Apache</span> <span class="pre">HttpComponents</span> <span class="pre">Client</span></code>を <code class="file docutils literal"><span class="pre">pom.xml</span></code> の依存ライブラリに追加する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">上記設定例は、依存ライブラリのバージョンを親プロジェクトである terasoluna-gfw-parent で管理する前提であるため、pom.xmlでのバージョンの指定は不要である。
上記の依存ライブラリはterasoluna-gfw-parentが依存している<a class="reference external" href="https://docs.spring.io/spring-boot/docs/2.2.4.RELEASE/reference/htmlsingle/#dependency-versions">Spring Boot</a>で管理されている。</p>
</div>
<p><strong>Bean定義ファイル</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;proxyHttpClientBuilder&quot;</span> <span class="na">class=</span><span class="s">&quot;org.apache.http.impl.client.HttpClientBuilder&quot;</span> <span class="na">factory-method=</span><span class="s">&quot;create&quot;</span> <span class="nt">&gt;</span>
    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;proxy&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.apache.http.HttpHost&quot;</span> <span class="nt">&gt;</span>
            <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">value=</span><span class="s">&quot;${rscl.http.proxyHost}&quot;</span> <span class="nt">/&gt;</span>    <span class="c">&lt;!-- (3) --&gt;</span>
            <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span> <span class="na">value=</span><span class="s">&quot;${rscl.http.proxyPort}&quot;</span> <span class="nt">/&gt;</span>    <span class="c">&lt;!-- (4) --&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- (5) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;proxyRestTemplate&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.web.client.RestTemplate&quot;</span> <span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg&gt;</span>
        <span class="c">&lt;!-- (6) --&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.http.client.HttpComponentsClientHttpRequestFactory&quot;</span><span class="nt">&gt;</span>
            <span class="c">&lt;!-- (7) --&gt;</span>
            <span class="nt">&lt;constructor-arg&gt;</span>
                <span class="nt">&lt;bean</span> <span class="na">factory-bean=</span><span class="s">&quot;proxyHttpClientBuilder&quot;</span> <span class="na">factory-method=</span><span class="s">&quot;build&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/constructor-arg&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.apache.http.impl.client.HttpClientBuilder</span></code>を使用し、<code class="docutils literal"><span class="pre">org.apache.http.client.HttpClient</span></code>の設定を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">HttpClientBuilder</span></code>の<code class="docutils literal"><span class="pre">proxy</span></code>プロパティに、HTTP Proxyサーバの設定を行った<code class="docutils literal"><span class="pre">org.apache.http.HttpHost</span></code>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">HttpHost</span></code>のコンストラクタの第一引数に、プロパティファイルに設定されたキー<code class="docutils literal"><span class="pre">rscl.http.proxyHost</span></code>の値をHTTP Proxyサーバのホスト名として設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">HttpHost</span></code>のコンストラクタの第二引数に、プロパティファイルに設定されたキー<code class="docutils literal"><span class="pre">rscl.http.proxyPort</span></code>の値をHTTP Proxyサーバのポート番号として設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RestTemplate</span></code>のBean定義を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RestTemplate</span></code>のコンストラクタの引数に、<code class="docutils literal"><span class="pre">HttpComponentsClientHttpRequestFactory</span></code>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">HttpComponentsClientHttpRequestFactory</span></code>のコンストラクタの引数に、<code class="docutils literal"><span class="pre">HttpClientBuilder</span></code>から生成した<code class="docutils literal"><span class="pre">HttpClient</span></code>を設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id33">
<h5>5.2.4.1.2.2. HTTP Proxyサーバの資格情報の指定方法<a class="headerlink" href="#id33" title="Permalink to this headline">¶</a></h5>
<p>HTTP Proxyサーバにアクセスする際に資格情報(ユーザ名とパスワード)が必要な場合は、<code class="docutils literal"><span class="pre">org.apache.http.impl.client.BasicCredentialsProvider</span></code>を使用し資格情報を設定する。</p>
<p><code class="docutils literal"><span class="pre">BasicCredentialsProvider</span></code>の<code class="docutils literal"><span class="pre">setCredentials</span></code>メソッドが引数を2つ取るため、セッターインジェクションを利用してBeanを生成することができない。このため、<code class="docutils literal"><span class="pre">org.springframework.beans.factory.FactoryBean</span></code>を利用してBeanを生成する。</p>
<p><strong>FactoryBeanクラス</strong></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">org.apache.http.auth.AuthScope</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.auth.UsernamePasswordCredentials</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.impl.client.BasicCredentialsProvider</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.FactoryBean</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="p">;</span>

<span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BasicCredentialsProviderFactoryBean</span> <span class="kd">implements</span> <span class="n">FactoryBean</span><span class="o">&lt;</span><span class="n">BasicCredentialsProvider</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="c1">// (2)</span>
    <span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${rscl.http.proxyHost}&quot;</span><span class="p">)</span>
    <span class="n">String</span> <span class="n">host</span><span class="p">;</span>

    <span class="c1">// (3)</span>
    <span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${rscl.http.proxyPort}&quot;</span><span class="p">)</span>
    <span class="kt">int</span> <span class="n">port</span><span class="p">;</span>

    <span class="c1">// (4)</span>
    <span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${rscl.http.proxyUserName}&quot;</span><span class="p">)</span>
    <span class="n">String</span> <span class="n">userName</span><span class="p">;</span>

    <span class="c1">// (5)</span>
    <span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${rscl.http.proxyPassword}&quot;</span><span class="p">)</span>
    <span class="n">String</span> <span class="n">password</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">BasicCredentialsProvider</span> <span class="nf">getObject</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>

        <span class="c1">// (6)</span>
        <span class="n">AuthScope</span> <span class="n">authScope</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AuthScope</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">host</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="na">port</span><span class="p">);</span>

        <span class="c1">// (7)</span>
        <span class="n">UsernamePasswordCredentials</span> <span class="n">usernamePasswordCredentials</span> <span class="o">=</span>
                <span class="k">new</span> <span class="n">UsernamePasswordCredentials</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">userName</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="na">password</span><span class="p">);</span>

        <span class="c1">// (8)</span>
        <span class="n">BasicCredentialsProvider</span> <span class="n">credentialsProvider</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BasicCredentialsProvider</span><span class="p">();</span>
        <span class="n">credentialsProvider</span><span class="p">.</span><span class="na">setCredentials</span><span class="p">(</span><span class="n">authScope</span><span class="p">,</span> <span class="n">usernamePasswordCredentials</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">credentialsProvider</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">getObjectType</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">BasicCredentialsProvider</span><span class="p">.</span><span class="na">class</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isSingleton</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.beans.factory.FactoryBean</span></code>を実装した<code class="docutils literal"><span class="pre">BasicCredentialsProviderFactoryBean</span></code>クラスを定義する。</div>
<div class="line">Beanの型に<code class="docutils literal"><span class="pre">BasicCredentialsProvider</span></code>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">プロパティファイルに設定されたキー<code class="docutils literal"><span class="pre">rscl.http.proxyHost</span></code>の値をHTTP Proxyサーバのホスト名として、インスタンス変数に設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">プロパティファイルに設定されたキー<code class="docutils literal"><span class="pre">rscl.http.proxyPort</span></code>の値をHTTP Proxyサーバのポート番号として、インスタンス変数に設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">プロパティファイルに設定されたキー<code class="docutils literal"><span class="pre">rscl.http.proxyUserName</span></code>の値をHTTP Proxyサーバのユーザ名として、インスタンス変数に設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">プロパティファイルに設定されたキー<code class="docutils literal"><span class="pre">rscl.http.proxyPassword</span></code>の値をHTTP Proxyサーバのパスワードとして、インスタンス変数に設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.apache.http.auth.AuthScope</span></code> を作成し資格情報のスコープを設定する。この例は、HTTP Proxyサーバのホスト名とポート番号を指定したものである。その他の設定方法については、<a class="reference external" href="https://hc.apache.org/httpcomponents-client-ga/httpclient/apidocs/org/apache/http/auth/AuthScope.html">AuthScope (Apache HttpClient API)</a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.apache.http.auth.UsernamePasswordCredentials</span></code> を作成し資格情報を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.apache.http.impl.client.BasicCredentialsProvider</span></code>を作成し、<code class="docutils literal"><span class="pre">setCredentials</span></code>メソッドを使用し、資格情報のスコープと資格情報を設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>Bean定義ファイル</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;proxyHttpClientBuilder&quot;</span> <span class="na">class=</span><span class="s">&quot;org.apache.http.impl.client.HttpClientBuilder&quot;</span> <span class="na">factory-method=</span><span class="s">&quot;create&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultCredentialsProvider&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;com.example.restclient.BasicCredentialsProviderFactoryBean&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;proxy&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;proxyHost&quot;</span> <span class="na">class=</span><span class="s">&quot;org.apache.http.HttpHost&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">value=</span><span class="s">&quot;${rscl.http.proxyHost}&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span> <span class="na">value=</span><span class="s">&quot;${rscl.http.proxyPort}&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;proxyRestTemplate&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.web.client.RestTemplate&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.http.client.HttpComponentsClientHttpRequestFactory&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;constructor-arg&gt;</span>
                <span class="nt">&lt;bean</span> <span class="na">factory-bean=</span><span class="s">&quot;proxyHttpClientBuilder&quot;</span> <span class="na">factory-method=</span><span class="s">&quot;build&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/constructor-arg&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">HttpClientBuilder</span></code>の<code class="docutils literal"><span class="pre">defaultCredentialsProvider</span></code>プロパティに、<code class="docutils literal"><span class="pre">BasicCredentialsProvider</span></code>を設定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">BasicCredentialsProvider</span></code>は、<code class="docutils literal"><span class="pre">FactoryBean</span></code>を実装した<code class="docutils literal"><span class="pre">BasicCredentialsProviderFactoryBean</span></code>を使用しBeanを作成する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="section" id="jsonjsr-310-date-and-time-api">
<h3><a class="toc-backref" href="#id84">5.2.4.2. JSONでJSR-310 Date and Time APIを使う場合の設定</a><a class="headerlink" href="#jsonjsr-310-date-and-time-api" title="Permalink to this headline">¶</a></h3>
<p>リソースを表現するJavaBean(Resourceクラス)のプロパティとしてJSR-310 Date and Time APIを使用する場合の設定は
「<a class="reference internal" href="REST.html#restappendixusingjsr310-jodatime"><span class="std std-ref">JSR-310 Date and Time API / Joda Timeを使う場合の設定</span></a> 」を参照されたい。</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="SOAP.html" title="5.3. SOAP Web Service（サーバ/クライアント）"
             >next</a> |</li>
        <li class="right" >
          <a href="REST.html" title="5.1. RESTful Web Service"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.6.1.SP1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >5. Web Service</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer">
      © Copyright 2013, NTT DATA Corporation. © Copyright 2013, NTT Corporation.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3.Theme is <a href="http://github.com/vimalkvn/solar-theme">Solar</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>
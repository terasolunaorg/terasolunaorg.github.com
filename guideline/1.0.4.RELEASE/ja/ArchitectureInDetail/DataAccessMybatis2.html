<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>5.3. データベースアクセス（Mybatis2編） &#8212; TERASOLUNA Global Framework Development Guideline 1.0.4.RELEASE documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/solar.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5.4. 排他制御" href="ExclusionControl.html" />
    <link rel="prev" title="5.2. データベースアクセス（JPA編）" href="DataAccessJpa.html" /><script async src="https://www.googletagmanager.com/gtag/js?id=G-847V2Q99G8"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date()); gtag('config', 'G-847V2Q99G8');
</script>
<script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ExclusionControl.html" title="5.4. 排他制御"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="DataAccessJpa.html" title="5.2. データベースアクセス（JPA編）"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Global Framework Development Guideline 1.0.4.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U"><span class="section-number">5. </span>TERASOLUNA Global Frameworkの機能詳細</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">5.3. </span>データベースアクセス（Mybatis2編）</a></li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">5.3. データベースアクセス（Mybatis2編）</a><ul>
<li><a class="reference internal" href="#overview">5.3.1. Overview</a><ul>
<li><a class="reference internal" href="#mybatis">5.3.1.1. Mybatisについて</a></li>
<li><a class="reference internal" href="#terasoluna-dao">5.3.1.2. TERASOLUNA DAOについて</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">5.3.2. How to use</a><ul>
<li><a class="reference internal" href="#pom-xml">5.3.2.1. pom.xmlの設定</a></li>
<li><a class="reference internal" href="#id2">5.3.2.2. アプリケーションの設定</a><ul>
<li><a class="reference internal" href="#id3">5.3.2.2.1. データソースの設定</a></li>
<li><a class="reference internal" href="#platformtransactionmanager">5.3.2.2.2. PlatformTransactionManagerの設定</a></li>
<li><a class="reference internal" href="#id4">5.3.2.2.3. TERASOLUNA DAOの設定</a></li>
<li><a class="reference internal" href="#lob">5.3.2.2.4. LOB型を扱う場合の設定</a></li>
<li><a class="reference internal" href="#sqlmapconfig-label">5.3.2.2.5. Mybatisの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sql">5.3.2.3. SQLマッピングの実装(基本編)</a><ul>
<li><a class="reference internal" href="#select">5.3.2.3.1. select要素の実装例</a></li>
<li><a class="reference internal" href="#insert">5.3.2.3.2. insert要素の実装例</a></li>
<li><a class="reference internal" href="#update">5.3.2.3.3. update要素の実装例</a></li>
<li><a class="reference internal" href="#delete">5.3.2.3.4. delete要素の実装例</a></li>
<li><a class="reference internal" href="#procedure">5.3.2.3.5. procedure要素の実装例</a></li>
<li><a class="reference internal" href="#id6">5.3.2.3.6. sql要素の実装例</a></li>
<li><a class="reference internal" href="#data-access-mybatis2-howtouse-lob-update">5.3.2.3.7. LOB型更新の実装例</a></li>
<li><a class="reference internal" href="#id8">5.3.2.3.8. LOB型取得の実装例</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sql-sql">5.3.2.4. SQLマッピングの実装例(動的SQL編)</a><ul>
<li><a class="reference internal" href="#id9">5.3.2.4.1. パラメータオブジェクトの指定有無を判定</a></li>
<li><a class="reference internal" href="#javabean">5.3.2.4.2. パラメータオブジェクト(JavaBean)のプロパティの存在有無を判定</a></li>
<li><a class="reference internal" href="#id10">5.3.2.4.3. パラメータオブジェクト(JavaBean)のプロパティ値の設定有無を判定</a></li>
<li><a class="reference internal" href="#id11">5.3.2.4.4. パラメータオブジェクト(JavaBean)のプロパティ値を判定</a></li>
<li><a class="reference internal" href="#id12">5.3.2.4.5. 判定要素の共通属性</a></li>
<li><a class="reference internal" href="#id13">5.3.2.4.6. コレクションの繰り返し</a></li>
<li><a class="reference internal" href="#id14">5.3.2.4.7. 動的SQLのブロック化</a></li>
</ul>
</li>
<li><a class="reference internal" href="#querydao">5.3.2.5. QueryDAOの使用例</a><ul>
<li><a class="reference internal" href="#id15">5.3.2.5.1. 1件検索</a></li>
<li><a class="reference internal" href="#id16">5.3.2.5.2. 複数件検索</a></li>
<li><a class="reference internal" href="#id17">5.3.2.5.3. ページネーション検索（TERASOLUNA DAO標準機能方式）</a></li>
<li><a class="reference internal" href="#id18">5.3.2.5.4. ページネーション検索（SQL絞り込み方式）</a></li>
</ul>
</li>
<li><a class="reference internal" href="#updatedao">5.3.2.6. UpdateDAOの使用例</a><ul>
<li><a class="reference internal" href="#id19">5.3.2.6.1. 1件挿入</a></li>
<li><a class="reference internal" href="#id20">5.3.2.6.2. 複数件挿入(バッチ実行)</a></li>
<li><a class="reference internal" href="#id21">5.3.2.6.3. 1件更新</a></li>
<li><a class="reference internal" href="#id22">5.3.2.6.4. 複数件更新(バッチ実行)</a></li>
<li><a class="reference internal" href="#where">5.3.2.6.5. 複数件更新(WHERE句指定)</a></li>
<li><a class="reference internal" href="#id23">5.3.2.6.6. 1件削除</a></li>
<li><a class="reference internal" href="#id24">5.3.2.6.7. 複数件削除(バッチ実行)</a></li>
<li><a class="reference internal" href="#id25">5.3.2.6.8. 複数件削除(WHERE句指定)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#storedproceduredao">5.3.2.7. StoredProcedureDAOの使用例</a></li>
<li><a class="reference internal" href="#queryrowhandledao">5.3.2.8. QueryRowHandleDAOの使用例</a></li>
<li><a class="reference internal" href="#like">5.3.2.9. LIKE検索時のエスケープについて</a><ul>
<li><a class="reference internal" href="#query">5.3.2.9.1. 一致方法をQuery側で指定する場合の使用方法</a></li>
<li><a class="reference internal" href="#id26">5.3.2.9.2. 一致方法をロジック側で指定する場合の使用方法</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sql-injection">5.3.2.10. SQL Injection対策について</a><ul>
<li><a class="reference internal" href="#id27">5.3.2.10.1. バインド変数を使って埋め込む方法</a></li>
<li><a class="reference internal" href="#id28">5.3.2.10.2. 置換変数を使って埋め込む方法</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix">5.3.3. Appendix</a><ul>
<li><a class="reference internal" href="#id29">5.3.3.1. 関連オブジェクトを１回のSQLでまとめて取得する実装例</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="DataAccessJpa.html"
                          title="previous chapter"><span class="section-number">5.2. </span>データベースアクセス（JPA編）</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="ExclusionControl.html"
                          title="next chapter"><span class="section-number">5.4. </span>排他制御</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/ArchitectureInDetail/DataAccessMybatis2.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="mybatis2">
<h1><span class="section-number">5.3. </span>データベースアクセス（Mybatis2編）<a class="headerlink" href="#mybatis2" title="Permalink to this heading">¶</a></h1>
<nav class="contents local" id="id1">
<p class="topic-title">目次</p>
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id48">Overview</a></p>
<ul>
<li><p><a class="reference internal" href="#mybatis" id="id49">Mybatisについて</a></p></li>
<li><p><a class="reference internal" href="#terasoluna-dao" id="id50">TERASOLUNA DAOについて</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#how-to-use" id="id51">How to use</a></p>
<ul>
<li><p><a class="reference internal" href="#pom-xml" id="id52">pom.xmlの設定</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id53">アプリケーションの設定</a></p>
<ul>
<li><p><a class="reference internal" href="#id3" id="id54">データソースの設定</a></p></li>
<li><p><a class="reference internal" href="#platformtransactionmanager" id="id55">PlatformTransactionManagerの設定</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id56">TERASOLUNA DAOの設定</a></p></li>
<li><p><a class="reference internal" href="#lob" id="id57">LOB型を扱う場合の設定</a></p></li>
<li><p><a class="reference internal" href="#sqlmapconfig-label" id="id58">Mybatisの設定</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#sql" id="id59">SQLマッピングの実装(基本編)</a></p>
<ul>
<li><p><a class="reference internal" href="#select" id="id60">select要素の実装例</a></p></li>
<li><p><a class="reference internal" href="#insert" id="id61">insert要素の実装例</a></p></li>
<li><p><a class="reference internal" href="#update" id="id62">update要素の実装例</a></p></li>
<li><p><a class="reference internal" href="#delete" id="id63">delete要素の実装例</a></p></li>
<li><p><a class="reference internal" href="#procedure" id="id64">procedure要素の実装例</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id65">sql要素の実装例</a></p></li>
<li><p><a class="reference internal" href="#data-access-mybatis2-howtouse-lob-update" id="id66">LOB型更新の実装例</a></p></li>
<li><p><a class="reference internal" href="#id8" id="id67">LOB型取得の実装例</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#sql-sql" id="id68">SQLマッピングの実装例(動的SQL編)</a></p>
<ul>
<li><p><a class="reference internal" href="#id9" id="id69">パラメータオブジェクトの指定有無を判定</a></p></li>
<li><p><a class="reference internal" href="#javabean" id="id70">パラメータオブジェクト(JavaBean)のプロパティの存在有無を判定</a></p></li>
<li><p><a class="reference internal" href="#id10" id="id71">パラメータオブジェクト(JavaBean)のプロパティ値の設定有無を判定</a></p></li>
<li><p><a class="reference internal" href="#id11" id="id72">パラメータオブジェクト(JavaBean)のプロパティ値を判定</a></p></li>
<li><p><a class="reference internal" href="#id12" id="id73">判定要素の共通属性</a></p></li>
<li><p><a class="reference internal" href="#id13" id="id74">コレクションの繰り返し</a></p></li>
<li><p><a class="reference internal" href="#id14" id="id75">動的SQLのブロック化</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#querydao" id="id76">QueryDAOの使用例</a></p>
<ul>
<li><p><a class="reference internal" href="#id15" id="id77">1件検索</a></p></li>
<li><p><a class="reference internal" href="#id16" id="id78">複数件検索</a></p></li>
<li><p><a class="reference internal" href="#id17" id="id79">ページネーション検索（TERASOLUNA DAO標準機能方式）</a></p></li>
<li><p><a class="reference internal" href="#id18" id="id80">ページネーション検索（SQL絞り込み方式）</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#updatedao" id="id81">UpdateDAOの使用例</a></p>
<ul>
<li><p><a class="reference internal" href="#id19" id="id82">1件挿入</a></p></li>
<li><p><a class="reference internal" href="#id20" id="id83">複数件挿入(バッチ実行)</a></p></li>
<li><p><a class="reference internal" href="#id21" id="id84">1件更新</a></p></li>
<li><p><a class="reference internal" href="#id22" id="id85">複数件更新(バッチ実行)</a></p></li>
<li><p><a class="reference internal" href="#where" id="id86">複数件更新(WHERE句指定)</a></p></li>
<li><p><a class="reference internal" href="#id23" id="id87">1件削除</a></p></li>
<li><p><a class="reference internal" href="#id24" id="id88">複数件削除(バッチ実行)</a></p></li>
<li><p><a class="reference internal" href="#id25" id="id89">複数件削除(WHERE句指定)</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#storedproceduredao" id="id90">StoredProcedureDAOの使用例</a></p></li>
<li><p><a class="reference internal" href="#queryrowhandledao" id="id91">QueryRowHandleDAOの使用例</a></p></li>
<li><p><a class="reference internal" href="#like" id="id92">LIKE検索時のエスケープについて</a></p>
<ul>
<li><p><a class="reference internal" href="#query" id="id93">一致方法をQuery側で指定する場合の使用方法</a></p></li>
<li><p><a class="reference internal" href="#id26" id="id94">一致方法をロジック側で指定する場合の使用方法</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#sql-injection" id="id95">SQL Injection対策について</a></p>
<ul>
<li><p><a class="reference internal" href="#id27" id="id96">バインド変数を使って埋め込む方法</a></p></li>
<li><p><a class="reference internal" href="#id28" id="id97">置換変数を使って埋め込む方法</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#appendix" id="id98">Appendix</a></p>
<ul>
<li><p><a class="reference internal" href="#id29" id="id99">関連オブジェクトを１回のSQLでまとめて取得する実装例</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="overview">
<h2><a class="toc-backref" href="#id48" role="doc-backlink"><span class="section-number">5.3.1. </span>Overview</a><a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h2>
<div class="line-block">
<div class="line">本節では、MyBatis2.xを使って、データベースにアクセスする方法について説明する。</div>
<div class="line">本ガイドラインでは、TERASOLUNA DAO(MybatisのラッパーDAO)を使用することを前提としている。</div>
</div>
<blockquote>
<div><figure class="align-center" id="id30">
<a class="reference internal image-reference" href="../_images/dataaccess_mybatis.png"><img alt="Target of description" src="../_images/dataaccess_mybatis.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>Picture - Target of description</strong></span><a class="headerlink" href="#id30" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</div></blockquote>
<section id="mybatis">
<h3><a class="toc-backref" href="#id49" role="doc-backlink"><span class="section-number">5.3.1.1. </span>Mybatisについて</a><a class="headerlink" href="#mybatis" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">Mybatisは、O/R Mapperの一つだが、データベースで管理されているレコードと、オブジェクトをマッピングするという考え方ではなく、</div>
<div class="line">SQLとオブジェクトをマッピングするという考え方で開発されたO/R Mapperである。</div>
<div class="line">そのため、正規化されていないデータベースへアクセスする場合や、発行するSQLをO/R Mapperに任せずに、アプリケーション側で完全に制御したい場合に有効なO/R Mapperである。</div>
<div class="line">Mybatis2.xの詳細については、<a class="reference external" href="https://mybatis.googlecode.com/files/MyBatis-SqlMaps-2_en.pdf">Mybatis Developer Guide(PDF)</a>を参照されたい。</div>
</div>
</section>
<section id="terasoluna-dao">
<h3><a class="toc-backref" href="#id50" role="doc-backlink"><span class="section-number">5.3.1.2. </span>TERASOLUNA DAOについて</a><a class="headerlink" href="#terasoluna-dao" title="Permalink to this heading">¶</a></h3>
<p>TERASOLUNA DAOは、O/R Mapperに依存する処理を隠蔽するためのDAOインタフェースと、Mybatis2.xを使用したDAO実装クラスを提供している。</p>
<p>TERASOLUNA DAOから提供されているDAOインタフェースは、以下の通りである。</p>
<blockquote>
<div><table class="docutils align-default" id="id31">
<caption><span class="caption-text"><strong>TERASOLUNA DAOから提供されているDAOインタフェース</strong></span><a class="headerlink" href="#id31" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 10%" />
<col style="width: 35%" />
<col style="width: 55%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>クラス名</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li></li>
</ol>
</td>
<td><div class="line-block">
<div class="line">jp.terasoluna.fw.dao.</div>
<div class="line">QueryDAO</div>
</div>
</td>
<td><p>参照系SQLを実行するためのDAOインタフェース</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="2">
<li></li>
</ol>
</td>
<td><div class="line-block">
<div class="line">jp.terasoluna.fw.dao.</div>
<div class="line">UpdateDAO</div>
</div>
</td>
<td><p>更新系SQLを実行するためのDAOインタフェース</p></td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="3">
<li></li>
</ol>
</td>
<td><div class="line-block">
<div class="line">jp.terasoluna.fw.dao.</div>
<div class="line">StoredProcedureDAO</div>
</div>
</td>
<td><p>StoredProcedureを実行するためのDAOインタフェース</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="4">
<li></li>
</ol>
</td>
<td><div class="line-block">
<div class="line">jp.terasoluna.fw.dao.</div>
<div class="line">QueryRowHandleDAO</div>
</div>
</td>
<td><p>参照系SQLを実行して取得されるレコードに対して、一レコードずつ処理を行うためのDAOインタフェース。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>TERASOLUNA DAO(Mybatis実装)を使って、データベースにアクセスする際の基本フローを、以下に示す。</p>
<blockquote>
<div><figure class="align-center" id="id32">
<a class="reference internal image-reference" href="../_images/dataaccess_mybatis_basic_flow.png"><img alt="Basic flow of TERASOLUNA DAO" src="../_images/dataaccess_mybatis_basic_flow.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>Picture - Basic flow of TERASOLUNA DAO</strong></span><a class="headerlink" href="#id32" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ServiceまたはRepositoryから、TERASOLUNA DAOから提供されているDAOインタフェースのメソッドを呼び出す。</div>
<div class="line">メソッドの呼び出しパラメータとして、SQLIDとSQLに埋め込む値を保持しているオブジェクトを渡す。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">TERASOLUNA DAOは、MybatisのAPIに、処理を委譲する。</div>
<div class="line">ServiceまたはRepositoryから指定されたSQLIDと、SQLに埋め込む値を保持しているオブジェクトもMybatisに渡される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Mybatisは、指定されたSQLIDに対応するSQLを、設定ファイル(<code class="docutils literal notranslate"><span class="pre">sqlMap.xml</span></code>)から取得し、SQLとバインド値を、JDBCドライバに渡す。</div>
<div class="line">(実際の値のバインドは、<code class="docutils literal notranslate"><span class="pre">java.sql.PreparedStatement</span></code>のAPIが使われている)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p>JDBCドライバは、渡されたSQLとバインド値を、データベースに送信することで、SQLを実行する。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="how-to-use">
<h2><a class="toc-backref" href="#id51" role="doc-backlink"><span class="section-number">5.3.2. </span>How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this heading">¶</a></h2>
<section id="pom-xml">
<h3><a class="toc-backref" href="#id52" role="doc-backlink"><span class="section-number">5.3.2.1. </span>pom.xmlの設定</a><a class="headerlink" href="#pom-xml" title="Permalink to this heading">¶</a></h3>
<p>インフラストラクチャ層にMyBatis2(TERASOLUNA DAO)を使用する場合、以下のdependencyをpom.xmlに追加する。</p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
<span class="w">    </span><span class="nt">&lt;groupId&gt;</span>org.terasoluna.gfw<span class="nt">&lt;/groupId&gt;</span>
<span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>terasoluna-gfw-mybatis2<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">MyBatis2に関連するライブラリ群が定義してある <code class="docutils literal notranslate"><span class="pre">terasoluna-gfw-mybatis2</span></code> をdependencyに追加する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id2">
<h3><a class="toc-backref" href="#id53" role="doc-backlink"><span class="section-number">5.3.2.2. </span>アプリケーションの設定</a><a class="headerlink" href="#id2" title="Permalink to this heading">¶</a></h3>
<section id="id3">
<h4><a class="toc-backref" href="#id54" role="doc-backlink"><span class="section-number">5.3.2.2.1. </span>データソースの設定</a><a class="headerlink" href="#id3" title="Permalink to this heading">¶</a></h4>
<p>データソースに設定は、共通編の<a class="reference internal" href="DataAccessCommon.html#data-access-common-howtouse-datasource"><span class="std std-ref">データソースの設定</span></a>を参照されたい。</p>
</section>
<section id="platformtransactionmanager">
<h4><a class="toc-backref" href="#id55" role="doc-backlink"><span class="section-number">5.3.2.2.2. </span>PlatformTransactionManagerの設定</a><a class="headerlink" href="#platformtransactionmanager" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">ローカルトランザクションを使用する場合は、以下の通りに設定する。</div>
</div>
<blockquote>
<div><p>ローカルトランザクションを使用する場合、JDBCのAPIを呼び出してトランザクション制御を行う<code class="docutils literal notranslate"><span class="pre">org.springframework.jdbc.datasource.DataSourceTransactionManager</span></code>を使用する。</p>
</div></blockquote>
<ul class="simple">
<li><p>xxx-env.xml</p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;transactionManager&quot;</span>
<span class="w">    </span><span class="na">class=</span><span class="s">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;dataSource&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">org.springframework.jdbc.datasource.DataSourceTransactionManager</span></code>を指定する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p>設定済みのデータソースのbeanを指定する。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>アプリケーションサーバから提供されているトランザクションマネージャを使用する場合は、以下の通りに設定する。</p>
<blockquote>
<div><p>アプリケーションサーバから提供されているトランザクションマネージャを使用する場合、JTAのAPIを呼び出してトランザクション制御を行う<code class="docutils literal notranslate"><span class="pre">org.springframework.transaction.jta.JtaTransactionManager</span></code>を使用する。</p>
</div></blockquote>
<ul class="simple">
<li><p>xxx-env.xml</p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;tx:jta-transaction-manager</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">アプリケーションがデプロイされているアプリケーションサーバに、最適な<code class="docutils literal notranslate"><span class="pre">JtaTransactionManager</span></code>が、<code class="docutils literal notranslate"><span class="pre">&quot;transactionManager&quot;</span></code>というidで、bean定義される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="id4">
<h4><a class="toc-backref" href="#id56" role="doc-backlink"><span class="section-number">5.3.2.2.3. </span>TERASOLUNA DAOの設定</a><a class="headerlink" href="#id4" title="Permalink to this heading">¶</a></h4>
<p>Spring Frameworkから提供されている<code class="docutils literal notranslate"><span class="pre">SqlMapClient</span></code>のファクトリクラスと、TERASOLUNA DAOのbean定義を行う。</p>
<ul class="simple">
<li><p>xxx-infra.xml</p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;sqlMapClient&quot;</span>
<span class="w">    </span><span class="na">class=</span><span class="s">&quot;org.springframework.orm.ibatis.SqlMapClientFactoryBean&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;configLocations&quot;</span>
<span class="w">        </span><span class="na">value=</span><span class="s">&quot;classpath*:/META-INF/mybatis/config/*sqlMapConfig.xml&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;mappingLocations&quot;</span>
<span class="w">        </span><span class="na">value=</span><span class="s">&quot;classpath*:/META-INF/mybatis/sql/**/*-sqlmap.xml&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;dataSource&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;queryDAO&quot;</span>
<span class="w">    </span><span class="na">class=</span><span class="s">&quot;jp.terasoluna.fw.dao.ibatis.QueryDAOiBatisImpl&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (5) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;sqlMapClient&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;sqlMapClient&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (6) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="cm">&lt;!-- (5) (6) --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;updateDAO&quot;</span>
<span class="w">    </span><span class="na">class=</span><span class="s">&quot;jp.terasoluna.fw.dao.ibatis.UpdateDAOiBatisImpl&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;sqlMapClient&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;sqlMapClient&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="cm">&lt;!-- (5) (6) --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;spDAO&quot;</span>
<span class="w">    </span><span class="na">class=</span><span class="s">&quot;jp.terasoluna.fw.dao.ibatis.StoredProcedureDAOiBatisImpl&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;sqlMapClient&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;sqlMapClient&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="cm">&lt;!-- (5) (6) --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;queryRowHandleDAO&quot;</span>
<span class="w">    </span><span class="na">class=</span><span class="s">&quot;jp.terasoluna.fw.dao.ibatis.QueryRowHandleDAOiBatisImpl&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;sqlMapClient&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;sqlMapClient&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">SqlMapClient</span></code>クラスのファクトリクラスとして、<code class="docutils literal notranslate"><span class="pre">org.springframework.orm.ibatis.SqlMapClientFactoryBean</span></code>を指定する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Mybatisの設定ファイルのロケーションを指定する。</div>
<div class="line">例では、クラスパス上の「<code class="docutils literal notranslate"><span class="pre">/META-INF/mybatis/config/</span></code>」ディレクトリに格納されている「<code class="docutils literal notranslate"><span class="pre">sqlMapConfig.xml</span></code>」で終わるファイルが、対象ファイルとなる。</div>
<div class="line">設定ファイルについては、<a class="reference internal" href="#sqlmapconfig-label"><span class="std std-ref">Mybatisの設定</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">MybatisのSQLマッピングファイルのロケーションを指定する。</div>
<div class="line">例では、クラスパス上の「<code class="docutils literal notranslate"><span class="pre">/META-INF/mybatis/sql/</span></code>」ディレクトリ配下（サブディレクトリも含む）に格納されている「<code class="docutils literal notranslate"><span class="pre">-sqlmap.xml</span></code>」で終わるファイルが、対象ファイルとなる。</div>
<div class="line">SQLマッピングファイルについては、<a class="reference internal" href="#sqlmap-label"><span class="std std-ref">SQLマッピングの実装(基本編)</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p>設定済みのデータソースのbeanを指定する。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><p>TERASOLUNA DAOのMybatis実装クラスを指定して、bean定義する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><p>(1)で定義した<code class="docutils literal notranslate"><span class="pre">SqlMapClient</span></code>クラスのファクトリクラスのbeanを指定する。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="lob">
<h4><a class="toc-backref" href="#id57" role="doc-backlink"><span class="section-number">5.3.2.2.4. </span>LOB型を扱う場合の設定</a><a class="headerlink" href="#lob" title="Permalink to this heading">¶</a></h4>
<p>BLOBやCLOBなどのLarge Objectを扱う場合は、<code class="docutils literal notranslate"><span class="pre">SqlMapClient</span></code>クラスのファクトリクラスに、<code class="docutils literal notranslate"><span class="pre">LobHandler</span></code>を指定する。</p>
<ul class="simple">
<li><p>xxx-infra.xml</p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;nativeJdbcExtractor&quot;</span>
<span class="w">    </span><span class="na">class=</span><span class="s">&quot;org.springframework.jdbc.support.nativejdbc.CommonsDbcpNativeJdbcExtractor&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>

<span class="cm">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;lobHandler&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.jdbc.support.lob.OracleLobHandler&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;nativeJdbcExtractor&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;nativeJdbcExtractor&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;sqlMapClient&quot;</span>
<span class="w">    </span><span class="na">class=</span><span class="s">&quot;org.springframework.orm.ibatis.SqlMapClientFactoryBean&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;configLocations&quot;</span>
<span class="w">        </span><span class="na">value=</span><span class="s">&quot;classpath*:/META-INF/mybatis/config/*sqlMapConfig.xml&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;mappingLocations&quot;</span>
<span class="w">        </span><span class="na">value=</span><span class="s">&quot;classpath*:/META-INF/mybatis/sql/**/*-sqlmap.xml&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;dataSource&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">   </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;lobHandler&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;lobHandler&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.jdbc.support.nativejdbc.NativeJdbcExtractor</span></code>インタフェースの実装クラスを、bean定義する。</div>
<div class="line">例では、<code class="docutils literal notranslate"><span class="pre">org.springframework.jdbc.support.nativejdbc.CommonsDbcpNativeJdbcExtractor</span></code>を指定しているが、</div>
<div class="line">Tomcat以外のAPサーバでは、コネクションプールの実装によって、JDBCコネクションを取得できない場合がある。</div>
<div class="line">その場合、Springが提供している他の<code class="docutils literal notranslate"><span class="pre">NativeJdbcExtractor</span></code>(<code class="docutils literal notranslate"><span class="pre">org.springframework.jdbc.support.nativejdbc.WebLogicNativeJdbcExtractor</span></code>など)を指定するか、各APサーバ用に、新たに<code class="docutils literal notranslate"><span class="pre">NativeJdbcExtractor</span></code>を作成する必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.jdbc.support.lob.LobHandler</span></code>インタフェースの実装クラスをbean定義する。</div>
<div class="line">例では、Oracle使用時に指定する<code class="docutils literal notranslate"><span class="pre">org.springframework.jdbc.support.lob.OracleLobHandler</span></code>を指定しているが、</div>
<div class="line">Oracle以外の場合は、<code class="docutils literal notranslate"><span class="pre">org.springframework.jdbc.support.lob.DefaultLobHandler</span></code>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">(1)で定義した<code class="docutils literal notranslate"><span class="pre">NativeJdbcExtractor</span></code>のbeanを指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">(3)で定義した<code class="docutils literal notranslate"><span class="pre">LobHandler</span></code>のbeanを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="sqlmapconfig-label">
<span id="id5"></span><h4><a class="toc-backref" href="#id58" role="doc-backlink"><span class="section-number">5.3.2.2.5. </span>Mybatisの設定</a><a class="headerlink" href="#sqlmapconfig-label" title="Permalink to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">SqlMapClient</span></code>のデフォルトの動作をカスタマイズする。必要に応じてカスタマイズすること。</p>
<ul class="simple">
<li><p>sqlMapConfig.xml</p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE sqlMapConfig</span>
<span class="cp">            PUBLIC &quot;-//ibatis.apache.org//DTD SQL Map Config 2.0//EN&quot;</span>
<span class="cp">            &quot;http://ibatis.apache.org/dtd/sql-map-config-2.dtd&quot;&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>

<span class="nt">&lt;sqlMapConfig&gt;</span>
<span class="w">    </span><span class="nt">&lt;settings</span><span class="w"> </span><span class="na">useStatementNamespaces=</span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/sqlMapConfig&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 6%" />
<col style="width: 94%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>DTDファイルを指定する。指定することで、スキーマのチェックと、IDE上でのコード補完が有効となる。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">useStatementNamespaces=&quot;true&quot;</span></code>を設定することで、SQLマッピングファイルで指定するネームスペースを、SQLIDとして使用するように設定している。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><p>sqlMapConfigの子要素について</p></li>
</ul>
<blockquote>
<div><div class="line-block">
<div class="line">子要素として、<code class="docutils literal notranslate"><span class="pre">properties</span></code>, <code class="docutils literal notranslate"><span class="pre">settings</span></code>,<code class="docutils literal notranslate"><span class="pre">resultObjectFactory</span></code>, <code class="docutils literal notranslate"><span class="pre">typeAlias</span></code>, <code class="docutils literal notranslate"><span class="pre">transactionManager</span></code>, <code class="docutils literal notranslate"><span class="pre">sqlMap</span></code>が存在する。</div>
<div class="line">必要に応じて、設定を行うこと。</div>
<div class="line">詳細は、Mybatis Developer Guide(PDF)の「The SQL Map XML Configuration File」(P.8-16)を参照されたい。</div>
</div>
<table class="docutils align-default" id="id33">
<caption><span class="caption-text"><strong>sqlMapConfigの子要素</strong></span><a class="headerlink" href="#id33" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 10%" />
<col style="width: 20%" />
<col style="width: 70%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>要素</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li></li>
</ol>
</td>
<td><p>properties</p></td>
<td><div class="line-block">
<div class="line">プロパティファイルを読み込むための要素。読み込んだプロパティファイルに定義されているプロパティは、</div>
<div class="line">Mybatisの設定ファイルおよびSQLマッピングファイル内から、<code class="docutils literal notranslate"><span class="pre">&quot;${プロパティ名}&quot;</span></code>の形式で参照することができる。</div>
<div class="line">環境に依存する値や、共通的な設定値を定義する際に使用する。</div>
<div class="line">詳細は、Mybatis Developer Guide(PDF)の「The SQL Map XML Configuration File」(P.9)を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p>settings</p></td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">SqlMapClient</span></code>のデフォルト動作のカスタマイズを行うための要素。</div>
<div class="line">設定項目の詳細については、Mybatis Developer Guide(PDF)の「The SQL Map XML Configuration File」(P.9-11)を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p>resultObjectFactory</p></td>
<td><div class="line-block">
<div class="line">SQLマッピングファイルのselect要素、statement要素、procedure要素のresultClass属性、または、resultMap要素のclass属性に指定されたクラスのインスタンスを生成するファクトリクラスを指定する要素。</div>
<div class="line">指定しない場合は、デフォルト実装である<code class="docutils literal notranslate"><span class="pre">java.lang.Class#newInstance()</span></code>メソッドで生成されたインスタンスが使用される。</div>
<div class="line">詳細については、Mybatis Developer Guide(PDF)の「The SQL Map XML Configuration File」(P.11-12)を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p>typeAlias</p></td>
<td><div class="line-block">
<div class="line">クラス名(FQCN)に別名（短縮名）を付けるための要素。</div>
<div class="line">ここで定義した別名は、Mybatisの設定ファイルおよびSQLマッピングファイルのクラスを指定する箇所で使うことができる。通常、パッケージを除いたシンプルなクラス名を指定することが多い。</div>
<div class="line">詳細については、Mybatis Developer Guide(PDF)の「The SQL Map XML Configuration File」(P.12)を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="5">
<li></li>
</ol>
</td>
<td><p>transactionManager</p></td>
<td><p>トランザクション管理は、Spring Frameworkの機能を使うため、定義は不要である。</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="6">
<li></li>
</ol>
</td>
<td><p>sqlMap</p></td>
<td><p>TERASOLUNA DAOの設定で設定済みのため、定義は不要である。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
</section>
<section id="sql">
<span id="sqlmap-label"></span><h3><a class="toc-backref" href="#id59" role="doc-backlink"><span class="section-number">5.3.2.3. </span>SQLマッピングの実装(基本編)</a><a class="headerlink" href="#sql" title="Permalink to this heading">¶</a></h3>
<p>以下に、基本的なSQLマッピングの実装例を示す。</p>
<p>アプリケーション内で使用するSQLを実装する。</p>
<ul class="simple">
<li><p>xxx-sqlmap.xml</p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE sqlMap</span>
<span class="cp">            PUBLIC &quot;-//ibatis.apache.org//DTD SQL Map 2.0//EN&quot;</span>
<span class="cp">            &quot;http://ibatis.apache.org/dtd/sql-map-2.dtd&quot;&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>

<span class="nt">&lt;sqlMap</span><span class="w"> </span><span class="na">namespace=</span><span class="s">&quot;xxx&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;findOne&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="cm">&lt;!-- ... --&gt;</span>
<span class="w">    </span><span class="nt">&lt;/select&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- ... --&gt;</span>

<span class="nt">&lt;/sqlMap&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>DTDファイルを指定する。指定することで、スキーマのチェックと、STS上でのコード補完が有効となる。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p>ネームスペースを指定する。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">sqlMapConfig.xml</span></code>にて、ネームスペースをSQLIDとして使用するように設定しているので、このSQLを実行するために指定するSQLIDは「<code class="docutils literal notranslate"><span class="pre">xxx.findOne</span></code>」となる。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><p>sqlMapの子要素について</p></li>
</ul>
<blockquote>
<div><p>子要素として、<code class="docutils literal notranslate"><span class="pre">cacheModel</span></code>, <code class="docutils literal notranslate"><span class="pre">typeAlias</span></code>, <code class="docutils literal notranslate"><span class="pre">parameterMap</span></code>, <code class="docutils literal notranslate"><span class="pre">resultMap</span></code>, <code class="docutils literal notranslate"><span class="pre">select</span></code>, <code class="docutils literal notranslate"><span class="pre">insert</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code>, <code class="docutils literal notranslate"><span class="pre">delete</span></code>, <code class="docutils literal notranslate"><span class="pre">statement</span></code>, <code class="docutils literal notranslate"><span class="pre">sql</span></code>, <code class="docutils literal notranslate"><span class="pre">procedure</span></code>が存在する。</p>
<table class="docutils align-default" id="id34">
<caption><span class="caption-text"><strong>sqlMapの子要素</strong></span><a class="headerlink" href="#id34" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 10%" />
<col style="width: 20%" />
<col style="width: 70%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>要素</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li></li>
</ol>
</td>
<td><p>typeAlias</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">sqlMapConfig.xml</span></code>の<code class="docutils literal notranslate"><span class="pre">typeAlias</span></code>と同じ。</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p>cacheModel</p></td>
<td><p>オブジェクトのキャッシュの定義を行う要素</p></td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p>parameterMap</p></td>
<td><p>SQLにバインドするパラメータ（オブジェクト）のマッピングに関する定義を行う要素</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p>resultMap</p></td>
<td><p>SQLの実行結果として返却されるレコードとオブジェクトのマッピングに関する定義を行う要素</p></td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="5">
<li></li>
</ol>
</td>
<td><p>select</p></td>
<td><p>SELECT文を記載する要素</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="6">
<li></li>
</ol>
</td>
<td><p>insert</p></td>
<td><p>INSERT文を記載する要素</p></td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="7">
<li></li>
</ol>
</td>
<td><p>update</p></td>
<td><p>UPDATE文を記載する要素</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="8">
<li></li>
</ol>
</td>
<td><p>delete</p></td>
<td><p>DELETE文を記載する要素</p></td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="9">
<li></li>
</ol>
</td>
<td><p>statement</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">select</span></code>, <code class="docutils literal notranslate"><span class="pre">insert</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code>, <code class="docutils literal notranslate"><span class="pre">delete</span></code>, <code class="docutils literal notranslate"><span class="pre">procedure</span></code> 要素を包含している汎用要素。個別の要素(<code class="docutils literal notranslate"><span class="pre">select</span></code>, <code class="docutils literal notranslate"><span class="pre">insert</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code>, <code class="docutils literal notranslate"><span class="pre">delete</span></code>, <code class="docutils literal notranslate"><span class="pre">procedure</span></code>)を使用することを推奨する。</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="10">
<li></li>
</ol>
</td>
<td><p>sql</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">select</span></code>, <code class="docutils literal notranslate"><span class="pre">insert</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code>, <code class="docutils literal notranslate"><span class="pre">delete</span></code>, <code class="docutils literal notranslate"><span class="pre">statement</span></code>からインクルードするためのSQL文（SQL文の一部）を記載する要素。この要素をうまく使うことで、複数のSQLで重複している部分を、共通化することができる。</p></td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="11">
<li></li>
</ol>
</td>
<td><p>procedure</p></td>
<td><p>PROCEDURE呼び出しを記載する要素</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>詳細は、Mybatis Developer Guide(PDF)の、以下の章を参照されたい。</p>
<ul>
<li><div class="line-block">
<div class="line">The SQL Map XML File(P.17-18)</div>
<div class="line">SQLマッピングファイルの簡単な定義例が記載されている。</div>
</div>
</li>
<li><div class="line-block">
<div class="line">Mapped Statements(P.18-26)</div>
<div class="line">SQLを組み立てるための要素の、基本的な使い方が記載されている。</div>
</div>
</li>
<li><div class="line-block">
<div class="line">Parameter Maps and Inline Parameters(P.27-31)</div>
<div class="line">SQLにバインドするパラメータ（オブジェクト）のマッピングに関する、詳細な説明が記載されている。</div>
</div>
</li>
<li><div class="line-block">
<div class="line">Substitution Strings(P.32)</div>
<div class="line">SQLのバインド変数について、記載されている。</div>
</div>
</li>
<li><div class="line-block">
<div class="line">Result Maps(P.32-41)</div>
<div class="line">SQLの実行結果として返却されるレコードと、オブジェクトのマッピングに関する、詳細な説明が記載されている。</div>
</div>
</li>
<li><div class="line-block">
<div class="line">Supported Types for Parameter Maps and Result Maps(P.42-43)</div>
<div class="line">ParameterMapと、ResultMapでサポートされている型と、拡張方法が記載されている。</div>
</div>
</li>
<li><div class="line-block">
<div class="line">Caching Mapped Statement Results(P.44-47)</div>
<div class="line">キャッシュに関する詳細な説明が、記載されている。</div>
</div>
</li>
<li><div class="line-block">
<div class="line">Dynamic Mapped Statements(P.48-53)</div>
<div class="line">動的SQLに関する詳細な説明が、記載されている。</div>
</div>
</li>
<li><div class="line-block">
<div class="line">Simple Dynamic SQL Elements(P.53)</div>
<div class="line">動的SQLの簡易的な実装方法の説明が、記載されている。</div>
</div>
</li>
</ul>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code class="docutils literal notranslate"><span class="pre">statement</span></code>, <code class="docutils literal notranslate"><span class="pre">select</span></code>, <code class="docutils literal notranslate"><span class="pre">procedure</span></code>要素を使用して、大量データを返すようなクエリを記述する場合には、fetchSize属性に適切な値を設定しておくこと。
fetchSize属性は、JDBCドライバとデータベース間の通信において、一度の通信で取得するデータの件数を設定するパラメータである。
fetchSize属性を省略した場合は、各JDBCドライバのデフォルト値が利用されるため、デフォルト値が全件取得するJDBCドライバの場合、メモリの枯渇の原因になる可能性があるので、注意が必要となる。</p>
</div>
</div></blockquote>
<section id="select">
<h4><a class="toc-backref" href="#id60" role="doc-backlink"><span class="section-number">5.3.2.3.1. </span>select要素の実装例</a><a class="headerlink" href="#select" title="Permalink to this heading">¶</a></h4>
<p>select要素を実装する前に、検索したレコードのカラムと、JavaBeanのプロパティのマッピング定義を行う。</p>
<ul class="simple">
<li><p>xxx-sqlmap.xml</p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;resultMap</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;resultMap_Todo&quot;</span>
<span class="w">           </span><span class="na">class=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model.Todo&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;todoId&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;todo_id&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;todoTitle&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;todo_title&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;finished&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;finished&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;createdAt&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;created_at&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;version&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;version&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 80%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>属性</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">-</div>
</div>
</td>
<td><p>検索したレコードとJavaBeanのマッピングを行う。詳細は、Developer Guideを参照されたい。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="line-block">
<div class="line">id</div>
</div>
</td>
<td><p>マッピングを識別するためのIDを指定する。select属性から参照される。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="line-block">
<div class="line">class</div>
</div>
</td>
<td><p>マッピングするJavaBeanのFQCNを指定する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">-</div>
</div>
</td>
<td><p>JavaBeanのプロパティと、検索したレコードのカラムのマッピングを行う。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="line-block">
<div class="line">property</div>
</div>
</td>
<td><p>JavaBeanのプロパティ名を指定する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="line-block">
<div class="line">column</div>
</div>
</td>
<td><p>property属性で指定したプロパティに、マッピングするレコードのカラム名を指定する。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>select要素を実装する。</p>
<ul class="simple">
<li><p>xxx-sqlmap.xml</p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;findOne&quot;</span>
<span class="w">        </span><span class="na">parameterClass=</span><span class="s">&quot;java.lang.String&quot;</span>
<span class="w">        </span><span class="na">resultMap=</span><span class="s">&quot;resultMap_Todo&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="w">    </span>SELECT
<span class="w">        </span>*
<span class="w">    </span>FROM
<span class="w">        </span>todo
<span class="w">    </span>WHERE
<span class="w">        </span>todo_id<span class="w"> </span>=<span class="w"> </span>#todoId#<span class="w">   </span>/*<span class="w"> </span>(4)<span class="w"> </span>*/
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 80%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>属性</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">-</div>
</div>
</td>
<td><p>検索用SQLを実装する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="line-block">
<div class="line">id</div>
</div>
</td>
<td><p>検索SQLを識別するためのIDを指定する。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="line-block">
<div class="line">parameterClass</div>
</div>
</td>
<td><div class="line-block">
<div class="line">バインド用オブジェクトの型を指定する。</div>
<div class="line">例では、<code class="docutils literal notranslate"><span class="pre">java.lang.String</span></code>を指定しているが、複数のパラメータ(検索条件)を渡したい場合は、JavaBeanを指定することもできる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="line-block">
<div class="line">resultMap</div>
</div>
</td>
<td><div class="line-block">
<div class="line">(1)で定義したresultMapを指定する。</div>
<div class="line">resultMapを使わずに、自動的にclass属性で指定したJavaBeanのプロパティにマッピングすることもできるが、取得レコードのカラム名と、JavaBeanのプロパティ名が一致している必要がある。</div>
<div class="line">取得レコードのカラム名とJavaBeanのプロパティ名を一致させる方法として、AS句を使って、カラム名に別名を付与する方法がある。</div>
<div class="line">例えば、SQLを<code class="docutils literal notranslate"><span class="pre">&quot;SELECT</span> <span class="pre">todo_title</span> <span class="pre">AS</span> <span class="pre">todoTitle,</span> <span class="pre">...&quot;</span></code>とすると、JavaBeanのtodoTitleプロパティに、値が設定される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="line-block">
<div class="line">SQLにバインド値を指定する。</div>
<div class="line">例では、JavaBeanではなく単一オブジェクト（<code class="docutils literal notranslate"><span class="pre">java.lang.String</span></code>）を使用しているので、バインド変数名は任意の名前を指定することができる。</div>
<div class="line">バインド用オブジェクトにJavaBeanを使用する場合は、バインド用の変数名は、JavaBeanのプロパティ名と一致させる必要がある。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>自動マッピングについて</strong></p>
<p>resultMap属性を使わずに、resultClass属性で指定したJavaBeanのプロパティに、自動的にマッピングすることもできるが、取得レコードのカラム名と、JavaBeanのプロパティ名が一致している必要がある。
取得レコードのカラム名と、JavaBeanのプロパティ名を一致させる方法として、AS句を使って、カラム名に別名を付与する方法がある。下記に、自動マッピングを使用した場合の実装例を示す。</p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;findOne&quot;</span>
<span class="w">        </span><span class="na">parameterClass=</span><span class="s">&quot;java.lang.String&quot;</span>
<span class="hll"><span class="w">        </span><span class="na">resultClass=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model.Todo&quot;</span><span class="nt">&gt;</span>
</span><span class="w">    </span>SELECT
<span class="hll"><span class="w">        </span>todo_id<span class="w"> </span>AS<span class="w"> </span>todoId,
</span><span class="hll"><span class="w">        </span>todo_title<span class="w"> </span>AS<span class="w"> </span>todoTitle,
</span><span class="w">        </span>finished,
<span class="hll"><span class="w">        </span>created_at<span class="w"> </span>AS<span class="w"> </span>createdAt,
</span><span class="w">        </span>version
<span class="w">    </span>FROM
<span class="w">        </span>todo
<span class="w">    </span>WHERE
<span class="w">        </span>todo_id<span class="w"> </span>=<span class="w"> </span>#todoId#
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
</div></blockquote>
<p>自動マッピングは、取得したレコードとJavaBeanをマッピングする手段としては、もっとも簡単な方法である。ただし、自動マッピングを使用した場合は、以下の制約や注意点があることを考慮し、使用すること。</p>
<ul class="simple">
<li><p>SQLで取得した値の型宣言や、変換定義などが行えない。</p></li>
<li><p>複雑なマッピング（例えば、ネストされているJavaBeanへのマッピング）が行えない。</p></li>
<li><p>マッピングする際に、<code class="docutils literal notranslate"><span class="pre">java.sql.ResultSetMetaData</span></code>にアクセスするため、若干のパフォーマンス劣化が発生する。</p></li>
</ul>
</div>
</div></blockquote>
</section>
<section id="insert">
<h4><a class="toc-backref" href="#id61" role="doc-backlink"><span class="section-number">5.3.2.3.2. </span>insert要素の実装例</a><a class="headerlink" href="#insert" title="Permalink to this heading">¶</a></h4>
<p>insert要素を実装する。</p>
<ul class="simple">
<li><p>xxx-sqlmap.xml</p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;insert</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;insert&quot;</span>
<span class="w">        </span><span class="na">parameterClass=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model.Todo&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span>INSERT<span class="w"> </span>INTO<span class="w"> </span>todo
<span class="w">        </span>(
<span class="w">            </span>todo_id
<span class="w">            </span>,todo_title
<span class="w">            </span>,finished
<span class="w">            </span>,created_at
<span class="w">            </span>,version
<span class="w">        </span>)
<span class="w">        </span>values(
<span class="w">            </span>#todoId#<span class="w">       </span>/*<span class="w"> </span>(2)<span class="w"> </span>*/
<span class="w">            </span>,#todoTitle#
<span class="w">            </span>,#finished#
<span class="w">            </span>,#createdAt#
<span class="w">            </span>,1
<span class="w">        </span>)
<span class="nt">&lt;/insert&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 80%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>属性</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">-</div>
</div>
</td>
<td><p>挿入用SQLを実装する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="line-block">
<div class="line">id</div>
</div>
</td>
<td><p>挿入用SQLを識別するためのIDを指定する。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="line-block">
<div class="line">parameterClass</div>
</div>
</td>
<td><p>バインド用オブジェクトの型を指定する。JavaBeanを指定することもできる。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">-</div>
</div>
</td>
<td><p>SQLにバインド値を指定する。バインド用オブジェクトにJavaBeanを使用する場合は、バインド用の変数名は、JavaBeanのプロパティ名と一致させる必要がある。</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>parameterMap属性や、”Inline Parameter Maps”の仕組みを使用することで、SQLにバインドする値の型の宣言や、変換定義を行うことができる。
例えば、バインド値が<code class="docutils literal notranslate"><span class="pre">null</span></code>の場合に、デフォルト値を設定することができる。詳細は、Mybatis Developer Guide(PDF)の「Parameter Maps and Inline Parameters」(P.27-31)を参照されたい。</p>
</div>
</div></blockquote>
</section>
<section id="update">
<h4><a class="toc-backref" href="#id62" role="doc-backlink"><span class="section-number">5.3.2.3.3. </span>update要素の実装例</a><a class="headerlink" href="#update" title="Permalink to this heading">¶</a></h4>
<p>update要素を実装する。</p>
<ul class="simple">
<li><p>xxx-sqlmap.xml</p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;update</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;update&quot;</span>
<span class="w">        </span><span class="na">parameterClass=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model.Todo&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span>UPDATE<span class="w"> </span>todo<span class="w"> </span>SET
<span class="w">        </span>todo_id<span class="w"> </span>=<span class="w"> </span>#todoId#
<span class="w">        </span>,todo_title<span class="w"> </span>=<span class="w"> </span>#todoTitle#
<span class="w">        </span>,finished<span class="w"> </span>=<span class="w"> </span>#finished#
<span class="w">        </span>,version<span class="w"> </span>=<span class="w"> </span>(#version#<span class="w"> </span>+<span class="w"> </span>1)
<span class="w">    </span>WHERE
<span class="w">        </span>todo_id<span class="w"> </span>=<span class="w"> </span>#todoId#
<span class="w">    </span>AND<span class="w"> </span>version<span class="w"> </span>=<span class="w"> </span>#version#
<span class="nt">&lt;/update&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>更新用SQLを実装する。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="delete">
<h4><a class="toc-backref" href="#id63" role="doc-backlink"><span class="section-number">5.3.2.3.4. </span>delete要素の実装例</a><a class="headerlink" href="#delete" title="Permalink to this heading">¶</a></h4>
<p>delete要素を実装する。</p>
<ul class="simple">
<li><p>xxx-sqlmap.xml</p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;delete</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;delete&quot;</span><span class="w"> </span><span class="na">parameterClass=</span><span class="s">&quot;java.lang.String&quot;</span><span class="nt">&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span>DELETE<span class="w"> </span>FROM
<span class="w">        </span>todo
<span class="w">    </span>WHERE
<span class="w">        </span>todo_id<span class="w"> </span>=<span class="w"> </span>#todoId#
<span class="nt">&lt;/delete&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>削除用SQLを実装する。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="procedure">
<h4><a class="toc-backref" href="#id64" role="doc-backlink"><span class="section-number">5.3.2.3.5. </span>procedure要素の実装例</a><a class="headerlink" href="#procedure" title="Permalink to this heading">¶</a></h4>
<p>以下は、PostgreSQLに作成したファンクションを、procedure要素を使って呼び出す例となっている。</p>
<p>テーブルと、ファンクション(PL/pgSQL実装)を作成するSQLは、以下の通りである。</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">sales</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">itemno</span><span class="w"> </span><span class="n">INT4</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">quantity</span><span class="w"> </span><span class="n">INT4</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">price</span><span class="w"> </span><span class="n">INT4</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
<span class="p">);</span>
</pre></div>
</div>
<div class="highlight-guess notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE</span>
    <span class="n">FUNCTION</span> <span class="n">sales_item</span><span class="p">(</span><span class="n">p_itemno</span> <span class="n">INT4</span><span class="p">)</span> <span class="n">RETURNS</span> <span class="n">TABLE</span> <span class="p">(</span>
        <span class="n">quantity</span> <span class="n">INT4</span>
        <span class="p">,</span><span class="n">total</span> <span class="n">INT4</span>
    <span class="p">)</span> <span class="n">AS</span> <span class="o">$$</span> <span class="kr">BEGIN</span> <span class="kr">RETURN</span> <span class="n">QUERY</span>
        <span class="n">SELECT</span>
                <span class="n">s</span><span class="p">.</span><span class="n">quantity</span>
                <span class="p">,</span><span class="n">s</span><span class="p">.</span><span class="n">quantity</span> <span class="o">*</span> <span class="n">s</span><span class="p">.</span><span class="n">price</span>
            <span class="n">FROM</span>
                <span class="n">sales</span> <span class="n">s</span>
            <span class="n">WHERE</span>
                <span class="n">itemno</span> <span class="o">=</span> <span class="n">p_itemno</span><span class="p">;</span>
<span class="kr">END</span><span class="p">;</span>
<span class="o">$$</span> <span class="n">LANGUAGE</span> <span class="n">plpgsql</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>parameterMap要素を実装する。</p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;parameterMap</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;salesItemMap&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model.SalesItem&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;parameter</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;id&quot;</span><span class="w"> </span><span class="na">jdbcType=</span><span class="s">&quot;INTEGER&quot;</span><span class="w"> </span><span class="na">mode=</span><span class="s">&quot;IN&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;parameter</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;quantity&quot;</span><span class="w"> </span><span class="na">jdbcType=</span><span class="s">&quot;INTEGER&quot;</span><span class="w"> </span><span class="na">mode=</span><span class="s">&quot;OUT&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;parameter</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;total&quot;</span><span class="w"> </span><span class="na">jdbcType=</span><span class="s">&quot;INTEGER&quot;</span><span class="w"> </span><span class="na">mode=</span><span class="s">&quot;OUT&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/parameterMap&gt;</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// (4)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SalesItem</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Serializable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">quantity</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">total</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>ファンクションに渡すINパラメータと、OUTパラメータのマッピングを定義する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p>INパラメータのマッピングを定義している。INパラメータに、<code class="docutils literal notranslate"><span class="pre">SalesItem#id</span></code>をマッピングしている。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p>OUTパラメータのマッピングを定義している。OUTパラメータの1番目を<code class="docutils literal notranslate"><span class="pre">SalesItem#quantity</span></code>に、2番目を<code class="docutils literal notranslate"><span class="pre">SalesItem#total</span></code>にマッピングしている。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p>マッピング対象となるJavaBean。</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>parameterMap属性を使わずに、”Inline Parameter Maps”の仕組みでマッピングする事もできる。
具体例は、Mybatis Developer Guide(PDF)の「Parameter Maps and Inline Parameters」(P.31)を参照されたい。</p>
</div>
</div></blockquote>
<p>procedure要素を実装する。</p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;procedure</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;findSalesItem&quot;</span><span class="w"> </span><span class="na">parameterMap=</span><span class="s">&quot;salesItemMap&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span>{call<span class="w"> </span>sales_item(?,?,?)}
<span class="nt">&lt;/procedure&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">呼び出すProcedureやFunctionを、”{call Procedure/Function名(INパラメータ …,OUTパラメータ…)}”の形式で指定する。</div>
<div class="line">例では、<code class="docutils literal notranslate"><span class="pre">sales_item</span></code>というFunctionに対して、INパラメータ1つと、OUTパラメータ2つを指定している。</div>
<div class="line">バインドされる値は、parameterMap要素で指定したマッピング定義の定義順となる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="id6">
<h4><a class="toc-backref" href="#id65" role="doc-backlink"><span class="section-number">5.3.2.3.6. </span>sql要素の実装例</a><a class="headerlink" href="#id6" title="Permalink to this heading">¶</a></h4>
<p>sql要素の実装する。</p>
<ul class="simple">
<li><p>xxx-sqlmap.xml</p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sql</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;fragment_where_byFinished&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span>WHERE
<span class="w">        </span>finished<span class="w"> </span>=<span class="w"> </span>#finished#
<span class="nt">&lt;/sql&gt;</span>

<span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;findByFinished&quot;</span>
<span class="w">        </span><span class="na">parameterClass=</span><span class="s">&quot;boolean&quot;</span>
<span class="w">        </span><span class="na">resultMap=</span><span class="s">&quot;resultMap_Todo&quot;</span><span class="nt">&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span>SELECT
<span class="w">        </span>*
<span class="w">    </span>FROM
<span class="w">        </span>todo
<span class="w">    </span><span class="nt">&lt;include</span><span class="w"> </span><span class="na">refid=</span><span class="s">&quot;fragment_where_byFinished&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="w">    </span>ORDER<span class="w"> </span>BY
<span class="w">        </span>created_at<span class="w"> </span>DESC
<span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;countByFinished&quot;</span>
<span class="w">        </span><span class="na">parameterClass=</span><span class="s">&quot;boolean&quot;</span>
<span class="w">        </span><span class="na">resultClass=</span><span class="s">&quot;long&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (4) --&gt;</span>
<span class="w">    </span>SELECT
<span class="w">        </span>count(*)
<span class="w">    </span>FROM
<span class="w">        </span>todo
<span class="w">    </span><span class="nt">&lt;include</span><span class="w"> </span><span class="na">refid=</span><span class="s">&quot;fragment_where_byFinished&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (5) --&gt;</span>
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>(2)と(4)のSQLで共有するWHERE句を定義している。includeされるSQLの定義は、includeする側のSQLより先に、定義する必要がある。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p>条件に一致するデータを取得するためのSQL</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p>(1)で定義したWHERE句が実装されているSQLを、includeする。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p>条件に一致するデータ件数を取得するためのSQL</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><p>(1)で定義したWHERE句が実装されているSQLを、includeする。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="data-access-mybatis2-howtouse-lob-update">
<span id="id7"></span><h4><a class="toc-backref" href="#id66" role="doc-backlink"><span class="section-number">5.3.2.3.7. </span>LOB型更新の実装例</a><a class="headerlink" href="#data-access-mybatis2-howtouse-lob-update" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">BLOBおよびCLOBなどのLarge Objectを、データベースに更新する場合の実装例を、以下に示す。</div>
<div class="line">下記は、BLOBを扱うテーブルへレコードを挿入する例となっている。</div>
</div>
<ul class="simple">
<li><p>DDL</p></li>
</ul>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">upload_binary</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">file_id</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">file_name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">content</span><span class="w"> </span><span class="nb">BLOB</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="c1">-- (1)</span>
<span class="w">    </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n">pk_upload_binary</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">BLOB型のカラムを定義する。</div>
<div class="line">上記例では、データベースとしてOracleを使用する前提のDDLとなっている。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><p>DTO(JavaBean)</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">BinaryFile</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Serializable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// omitted</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">fileId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">fileName</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">InputStream</span><span class="w"> </span><span class="n">content</span><span class="p">;</span><span class="w"> </span><span class="c1">// (2)</span>

<span class="w">    </span><span class="c1">// omitted setter/getter</span>

<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">BLOB型の値を保持するプロパティを<code class="docutils literal notranslate"><span class="pre">java.io.InputStream</span></code>型で定義する。</div>
<div class="line">上記例では、<code class="docutils literal notranslate"><span class="pre">InputStream</span></code>に、アップロードされたファイルの入力ストリームが設定される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>BLOBを扱う プロパティの型は、原則<code class="docutils literal notranslate"><span class="pre">InputStream</span></code>型で定義することを推奨する。
BLOBはバイト配列として扱うこともできるが、データの容量が大きくなると、メモリ枯渇の原因となる可能性がある。</p>
<p>CLOBを扱うプロパティの型は、 原則<code class="docutils literal notranslate"><span class="pre">java.io.Reader</span></code>型で定義することを推奨する。
CLOBは文字列として扱うこともできるが、データの容量が大きくなると、メモリ枯渇の原因となる可能性がある。</p>
</div>
</div></blockquote>
<ul class="simple">
<li><p>xxx-sqlmap.xml</p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;parameterMap</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;uploadBinaryParameterMap&quot;</span>
<span class="w">              </span><span class="na">class=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.service.BinaryFile&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;parameter</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;fileId&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;parameter</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;fileName&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;parameter</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;content&quot;</span>
<span class="w">               </span><span class="na">jdbcType=</span><span class="s">&quot;BLOB&quot;</span>
<span class="w">               </span><span class="na">typeHandler=</span><span class="s">&quot;jp.terasoluna.fw.orm.ibatis.support.BlobInputStreamTypeHandler&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/parameterMap&gt;</span>

<span class="cm">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;insert</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;uploadBinary&quot;</span><span class="w"> </span><span class="na">parameterMap=</span><span class="s">&quot;uploadBinaryParameterMap&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span>INSERT<span class="w"> </span>INTO<span class="w"> </span>upload_binary
<span class="w">    </span>(
<span class="w">        </span>file_id
<span class="w">        </span>,file_name
<span class="w">        </span>,content
<span class="w">    </span>)
<span class="w">    </span>VALUES
<span class="w">    </span>(
<span class="w">        </span>?
<span class="w">        </span>,?
<span class="w">        </span>,?
<span class="w">    </span>)
<span class="nt">&lt;/insert&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">BLOB型のカラムの登録値を保持するパラメータに対して、登録するために必要な定義を指定する。</div>
<div class="line">jdbcType属性には<code class="docutils literal notranslate"><span class="pre">&quot;BLOB&quot;</span></code>を、typeHandler属性には<code class="docutils literal notranslate"><span class="pre">&quot;jp.terasoluna.fw.orm.ibatis.support.BlobInputStreamTypeHandler&quot;</span></code>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">BLOB型のカラムをもつテーブルに、レコードを登録するためのSQL。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>CLOBを扱う場合は、jdbcType属性には<code class="docutils literal notranslate"><span class="pre">&quot;CLOB&quot;</span></code>を、typeHandler属性には<code class="docutils literal notranslate"><span class="pre">&quot;jp.terasoluna.fw.orm.ibatis.support.ClobReaderTypeHandler&quot;</span></code>を指定する。</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>FQCNで指定しているクラス名は、 typeAlias要素を使って別名を付与することで、シンプルに記載することができる。</p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- (5) --&gt;</span>
<span class="nt">&lt;typeAlias</span><span class="w"> </span><span class="na">alias=</span><span class="s">&quot;BinaryFile&quot;</span>
<span class="w">           </span><span class="na">type=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.service.BinaryFile&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;typeAlias</span><span class="w"> </span><span class="na">alias=</span><span class="s">&quot;BlobInputStreamTypeHandler&quot;</span>
<span class="w">           </span><span class="na">type=</span><span class="s">&quot;jp.terasoluna.fw.orm.ibatis.support.BlobInputStreamTypeHandler&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;parameterMap</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;uploadBinaryParameterMap&quot;</span>
<span class="w">              </span><span class="na">class=</span><span class="s">&quot;BinaryFile&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (6) --&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>

<span class="w">    </span><span class="nt">&lt;parameter</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;content&quot;</span><span class="w"> </span><span class="na">jdbcType=</span><span class="s">&quot;BLOB&quot;</span>
<span class="w">               </span><span class="na">typeHandler=</span><span class="s">&quot;BlobInputStreamTypeHandler&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (6) --&gt;</span>

<span class="nt">&lt;/parameterMap&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">typeAlias要素を使って、クラス名(FQCN)に別名を付与する。</div>
<div class="line">上記例では、<code class="docutils literal notranslate"><span class="pre">BinaryFile</span></code>と<code class="docutils literal notranslate"><span class="pre">BlobInputStreamTypeHandler</span></code>クラスに対して、別名を付与している。</div>
<div class="line">typeAlias要素は、<code class="file docutils literal notranslate"><span class="pre">sqlMapConfig.xml</span></code>と<code class="file docutils literal notranslate"><span class="pre">xxx-sqlmap.xml</span></code>の両方で、定義することができる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">(5)で付与したクラス名(FQCN)の別名を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div></blockquote>
<ul class="simple">
<li><p>Service</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// omitted</span>

<span class="nd">@Inject</span>
<span class="n">UpdateDAO</span><span class="w"> </span><span class="n">updateDAO</span><span class="p">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span><span class="w"> </span><span class="n">BinaryFile</span><span class="w"> </span><span class="nf">uploadBinaryFile</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">fileName</span><span class="p">,</span>
<span class="w">        </span><span class="n">InputStream</span><span class="w"> </span><span class="n">contentInputStream</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="c1">// (7)</span>
<span class="w">    </span><span class="n">BinaryFile</span><span class="w"> </span><span class="n">inputFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BinaryFile</span><span class="p">();</span>
<span class="w">    </span><span class="n">inputFile</span><span class="p">.</span><span class="na">setFileId</span><span class="p">(</span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">());</span>
<span class="w">    </span><span class="n">inputFile</span><span class="p">.</span><span class="na">setFileName</span><span class="p">(</span><span class="n">fileName</span><span class="p">);</span>
<span class="w">    </span><span class="n">inputFile</span><span class="p">.</span><span class="na">setContent</span><span class="p">(</span><span class="n">contentInputStream</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// (8)</span>
<span class="w">    </span><span class="n">updateDAO</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="s">&quot;example.uploadBinary&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">inputFile</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">inputFile</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// omitted</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">レコードを登録するために必要な情報を、DTOに設定する。</div>
<div class="line">上記例では、ファイルIDをUUIDとして採番し、引数で受け取ったファイル名と、ファイルの中身が格納されている<code class="docutils literal notranslate"><span class="pre">InputStream</span></code>オブジェクトを、DTOに設定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">登録するために必要な情報を、保持するDTOを引数に、<code class="docutils literal notranslate"><span class="pre">UpdateDAO</span></code>を呼び出す。</div>
<div class="line">DAOの呼び出し方法は、BLOBを扱わない場合と同じである。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><p>Controller</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;uploadBinary&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">uploadBinaryFile</span><span class="p">(</span>
<span class="w">        </span><span class="nd">@RequestPart</span><span class="p">(</span><span class="s">&quot;file&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">MultipartFile</span><span class="w"> </span><span class="n">multipartFile</span><span class="p">,</span><span class="w"> </span><span class="n">Model</span><span class="w"> </span><span class="n">model</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// (9)</span>
<span class="w">    </span><span class="n">BinaryFile</span><span class="w"> </span><span class="n">uploadedFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uploadService</span><span class="p">.</span><span class="na">uploadBinaryFile</span><span class="p">(</span><span class="n">multipartFile</span>
<span class="w">            </span><span class="p">.</span><span class="na">getOriginalFilename</span><span class="p">(),</span><span class="w"> </span><span class="n">multipartFile</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">());</span>
<span class="w">    </span><span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="n">uploadedFile</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;upload/form&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">アップロードされたファイルのファイル名と、ファイルの中身が格納されている<code class="docutils literal notranslate"><span class="pre">InputStream</span></code>を引数に、Serviceのメソッドを呼び出す。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="id8">
<h4><a class="toc-backref" href="#id67" role="doc-backlink"><span class="section-number">5.3.2.3.8. </span>LOB型取得の実装例</a><a class="headerlink" href="#id8" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">BLOBおよびCLOBなどのLarge Objectを、データベースから取得する場合の実装例を、以下に示す。</div>
<div class="line">下記は、BLOBを扱うテーブルからレコードを取得する例となっている。</div>
<div class="line">必要なテーブルを作成するDDLやDTO(JavaBean)は、<a class="reference internal" href="#data-access-mybatis2-howtouse-lob-update"><span class="std std-ref">LOB型更新の実装例</span></a>を参照されたい。</div>
</div>
<ul class="simple">
<li><p>xxx-sqlmap.xml</p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;resultMap</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;selectBinaryResultMap&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;BinaryFile&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;fileId&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;file_id&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;fileName&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;file_name&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;content&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;content&quot;</span><span class="w"> </span><span class="na">jdbcType=</span><span class="s">&quot;BLOB&quot;</span>
<span class="w">            </span><span class="na">typeHandler=</span><span class="s">&quot;BlobInputStreamTypeHandler&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>

<span class="cm">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;selectBinary&quot;</span><span class="w"> </span><span class="na">parameterClass=</span><span class="s">&quot;java.lang.String&quot;</span>
<span class="w">        </span><span class="na">resultMap=</span><span class="s">&quot;selectBinaryResultMap&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span>SELECT
<span class="w">        </span>*
<span class="w">    </span>FROM
<span class="w">        </span>upload_binary
<span class="w">    </span>WHERE
<span class="w">        </span>file_id<span class="w"> </span>=<span class="w"> </span>#fileId#
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">BLOB型のカラムから取得した値を保持するプロパティに対して、値を取得するために必要な定義を指定する。</div>
<div class="line">jdbcType属性には<code class="docutils literal notranslate"><span class="pre">&quot;BLOB&quot;</span></code>を、typeHandler属性には<code class="docutils literal notranslate"><span class="pre">&quot;jp.terasoluna.fw.orm.ibatis.support.BlobInputStreamTypeHandler&quot;</span></code>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">BLOB型のカラムをもつテーブルから、レコードを取得するためのSQL。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>CLOBを扱う場合は、jdbcType属性には<code class="docutils literal notranslate"><span class="pre">&quot;CLOB&quot;</span></code>を、typeHandler属性には<code class="docutils literal notranslate"><span class="pre">&quot;jp.terasoluna.fw.orm.ibatis.support.ClobReaderTypeHandler&quot;</span></code>を指定する。</p>
</div>
</div></blockquote>
<ul class="simple">
<li><p>Service / Repository</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// omitted</span>

<span class="nd">@Inject</span>
<span class="n">QueryDAO</span><span class="w"> </span><span class="n">queryDAO</span><span class="p">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span><span class="w"> </span><span class="n">BinaryFile</span><span class="w"> </span><span class="nf">getBinaryFile</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">fileId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// (3)</span>
<span class="w">    </span><span class="n">BinaryFile</span><span class="w"> </span><span class="n">loadedFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queryDAO</span><span class="p">.</span><span class="na">executeForObject</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;article.selectBinary&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fileId</span><span class="p">,</span><span class="w"> </span><span class="n">BinaryFile</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">loadedFile</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// omitted</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Controllerから指定された取得条件を引数に、<code class="docutils literal notranslate"><span class="pre">QueryDAO</span></code>を呼び出す。</div>
<div class="line">上記例では、ファイルIDに一致するアップロードファイルの情報を取得している。</div>
<div class="line">DAOの呼び出し方法は、BLOBを扱わない場合と同じである。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
</section>
<section id="sql-sql">
<h3><a class="toc-backref" href="#id68" role="doc-backlink"><span class="section-number">5.3.2.4. </span>SQLマッピングの実装例(動的SQL編)</a><a class="headerlink" href="#sql-sql" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">Mybatisでは、動的にSQLを組み立てる仕組みが、デフォルトで用意されている。</div>
<div class="line">以下に、動的にSQLを組み立てる方法について説明する。</div>
<div class="line">詳細については、Developer Guide(PDF)の「Dynamic Mapped Statements」(P.48-53)を参照されたい。</div>
</div>
<section id="id9">
<h4><a class="toc-backref" href="#id69" role="doc-backlink"><span class="section-number">5.3.2.4.1. </span>パラメータオブジェクトの指定有無を判定</a><a class="headerlink" href="#id9" title="Permalink to this heading">¶</a></h4>
<p>SQLに渡されたパラメータオブジェクトが指定されているかを判定し、SQLを組み立てることができる。</p>
<p>判定用の要素は、以下の通りである。</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 15%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>要素</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li></li>
</ol>
</td>
<td><p>isParameterPresent</p></td>
<td><p>パラメータオブジェクトが指定されている(NULLでない)時のSQLを組み立てるための要素。</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p>isNotParameterPresent</p></td>
<td><p>パラメータオブジェクトが指定されていない(NULLである)時のSQLを組み立てるための要素。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>実装例は、以下の通りである。</p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;findOne&quot;</span><span class="w"> </span><span class="na">parameterClass=</span><span class="s">&quot;java.lang.Integer&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;...&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span>SELECT
<span class="w">        </span>*
<span class="w">    </span>FROM
<span class="w">        </span>t_order
<span class="w">    </span>WHERE

<span class="w">    </span><span class="nt">&lt;isParameterPresent&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">        </span>id<span class="w"> </span>=<span class="w"> </span>#id#
<span class="w">    </span><span class="nt">&lt;/isParameterPresent&gt;</span>

<span class="w">    </span><span class="nt">&lt;isNotParameterPresent&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">        </span>1<span class="w"> </span>=<span class="w"> </span>2
<span class="w">    </span><span class="nt">&lt;/isNotParameterPresent&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- ... --&gt;</span>

<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例では、パラメータオブジェクトが指定されている時に、idカラムをWHERE句に設定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例では、パラメータオブジェクトが指定されていない時に、一致するレコードが0件になるように、条件「<code class="docutils literal notranslate"><span class="pre">1=2</span></code>」を設定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>上記の動的SQLで生成されるSQLは、以下2パターンとなる。</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- (1) parameterObject(id)=1</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t_order</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>

<span class="c1">-- (2)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t_order</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="javabean">
<h4><a class="toc-backref" href="#id70" role="doc-backlink"><span class="section-number">5.3.2.4.2. </span>パラメータオブジェクト(JavaBean)のプロパティの存在有無を判定</a><a class="headerlink" href="#javabean" title="Permalink to this heading">¶</a></h4>
<p>SQLに渡されたパラメータオブジェクト(JavaBean)に指定したプロパティが存在するか判定し、SQLを組み立てることができる。</p>
<p>判定用の要素は、以下の通りである。</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 15%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>要素</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li></li>
</ol>
</td>
<td><p>isPropertyAvailable</p></td>
<td><p>指定したプロパティが、存在する時のSQLを組み立てるための要素。</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p>isNotPropertyAvailable</p></td>
<td><p>指定したプロパティが、存在しない時のSQLを組み立てるための要素。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>実装例は、以下の通りである。</p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;findOne&quot;</span><span class="w"> </span><span class="na">parameterClass=</span><span class="s">&quot;OrderCriteria&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;...&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span>SELECT
<span class="w">        </span>*
<span class="w">    </span>FROM
<span class="w">        </span>t_order
<span class="w">    </span>WHERE

<span class="w">    </span><span class="nt">&lt;isPropertyAvailable</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;statusCode&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">        </span>status_code<span class="w"> </span>=<span class="w"> </span>#statusCode#
<span class="w">    </span><span class="nt">&lt;/isPropertyAvailable&gt;</span>

<span class="w">    </span><span class="nt">&lt;isNotPropertyAvailable</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;statusCode&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">        </span><span class="cp">&lt;![CDATA[</span>
<span class="cp">        status_code &lt;&gt; &#39;completed&#39;</span>
<span class="cp">        ]]&gt;</span>
<span class="w">    </span><span class="nt">&lt;/isNotPropertyAvailable&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- ... --&gt;</span>

<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例では、<code class="docutils literal notranslate"><span class="pre">statusCode</span></code>プロパティが存在する場合に、status_codeカラムが、<code class="docutils literal notranslate"><span class="pre">statusCode</span></code>と一致するレコードが取得されるように、WHERE句を設定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例では、<code class="docutils literal notranslate"><span class="pre">statusCode</span></code>プロパティが存在しない場合に、status_codeカラムが、<code class="docutils literal notranslate"><span class="pre">'completed'</span></code>以外のレコードが取得されるように、WHERE句を設定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>上記の動的SQLで生成されるSQLは、以下2パターンとなる。</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- (1) statusCode=&#39;checking&#39;</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t_order</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">status_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checking&#39;</span>

<span class="c1">-- (2)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t_order</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">status_code</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="id10">
<h4><a class="toc-backref" href="#id71" role="doc-backlink"><span class="section-number">5.3.2.4.3. </span>パラメータオブジェクト(JavaBean)のプロパティ値の設定有無を判定</a><a class="headerlink" href="#id10" title="Permalink to this heading">¶</a></h4>
<p>SQLに渡されたパラメータオブジェクト(JavaBean)のプロパティに値が指定されているか判定し、SQLを組み立てることができる。</p>
<p>判定用の要素は、以下の通りである。</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 15%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>要素</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li></li>
</ol>
</td>
<td><p>isNull</p></td>
<td><p>プロパティの値が、<code class="docutils literal notranslate"><span class="pre">null</span></code>時のSQLを組み立てるための要素。</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p>isNotNull</p></td>
<td><p>プロパティの値が、<code class="docutils literal notranslate"><span class="pre">null</span></code>でない時のSQLを組み立てるための要素。</p></td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p>isEmpty</p></td>
<td><p>プロパティの値が、<code class="docutils literal notranslate"><span class="pre">null</span></code>または、空の時のSQLを組み立てるための要素。
<code class="docutils literal notranslate"><span class="pre">Collection</span></code>および、<code class="docutils literal notranslate"><span class="pre">String</span></code>に対して、指定することができる。</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p>isNotEmpty</p></td>
<td><p>プロパティの値が、<code class="docutils literal notranslate"><span class="pre">null</span></code>および、空でない時のSQLを組み立てるための要素。
<code class="docutils literal notranslate"><span class="pre">Collection</span></code>および、<code class="docutils literal notranslate"><span class="pre">String</span></code>に対して、指定することができる。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>実装例は、以下の通りである。</p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;findOne&quot;</span><span class="w"> </span><span class="na">parameterClass=</span><span class="s">&quot;OrderCriteria&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span>SELECT
<span class="w">        </span>*
<span class="w">    </span>FROM
<span class="w">        </span>t_order
<span class="w">    </span>WHERE

<span class="w">    </span><span class="nt">&lt;isNull</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;orderedDate&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">        </span><span class="cp">&lt;![CDATA[</span>
<span class="cp">        CURRENT_DATE - &#39;1 months&#39;::interval &lt;= ordered_date</span>
<span class="cp">        ]]&gt;</span>
<span class="w">    </span><span class="nt">&lt;/isNull&gt;</span>

<span class="w">    </span><span class="nt">&lt;isNotNull</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;orderedDate&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">        </span>ordered_date<span class="w"> </span>=<span class="w"> </span>#orderedDate#
<span class="w">    </span><span class="nt">&lt;/isNotNull&gt;</span>

<span class="w">    </span><span class="nt">&lt;isEmpty</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;statusCodes&quot;</span><span class="w"> </span><span class="na">prepend=</span><span class="s">&quot;AND&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="w">        </span><span class="cp">&lt;![CDATA[</span>
<span class="cp">        status_code &lt;&gt; &#39;completed&#39;</span>
<span class="cp">        ]]&gt;</span>
<span class="w">    </span><span class="nt">&lt;/isEmpty&gt;</span>

<span class="w">    </span><span class="nt">&lt;isNotEmpty</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;statusCodes&quot;</span><span class="w"> </span><span class="na">prepend=</span><span class="s">&quot;AND&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (4) --&gt;</span>
<span class="w">        </span>status_code<span class="w"> </span>IN
<span class="w">        </span><span class="nt">&lt;iterate</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;statusCodes&quot;</span><span class="w"> </span><span class="na">open=</span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="na">close=</span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="na">conjunction=</span><span class="s">&quot;,&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span>#statusCodes[]#
<span class="w">        </span><span class="nt">&lt;/iterate&gt;</span>
<span class="w">    </span><span class="nt">&lt;/isNotEmpty&gt;</span>

<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例では、<code class="docutils literal notranslate"><span class="pre">orderedDate</span></code>プロパティ(Date型)の値が<code class="docutils literal notranslate"><span class="pre">null</span></code>の場合に、ordered_dateカラムが、1ヶ月前以降のレコードが取得されるように、WHERE句を設定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例では、<code class="docutils literal notranslate"><span class="pre">orderedDate</span></code>プロパティ(Date型) の値が<code class="docutils literal notranslate"><span class="pre">null</span></code>でない場合に、ordered_dateカラムが<code class="docutils literal notranslate"><span class="pre">orderedDate</span></code>と一致するレコードが取得されるように、WHERE句を設定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例では、<code class="docutils literal notranslate"><span class="pre">statusCodes</span></code>プロパティ(List&lt;String&gt;型)の値が、空の場合に、status_codeカラムが、<code class="docutils literal notranslate"><span class="pre">'completed'</span></code>以外のレコードが取得されるように、WHERE句を設定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例では、<code class="docutils literal notranslate"><span class="pre">statusCodes</span></code>プロパティ(List&lt;String&gt;型)の値が、空でない場合に、status_codeカラムが、<code class="docutils literal notranslate"><span class="pre">statusCodes</span></code>に格納されているいずれかの値と一致するレコードが取得されるように、WHERE句を設定している。</div>
<div class="line">iterate要素の説明は、後述する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>上記の動的SQLで生成されるSQLは、以下4パターンとなる。</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- (1) orderedDate=null, statusCodes=[]</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t_order</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">CURRENT_DATE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="s1">&#39;1 months&#39;</span><span class="p">::</span><span class="nb">interval</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ordered_date</span>
<span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">status_code</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span>

<span class="c1">-- (2) orderedDate=null, statusCodes=[&#39;accepted&#39;,&#39;checking&#39;]</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t_order</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">CURRENT_DATE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="s1">&#39;1 months&#39;</span><span class="p">::</span><span class="nb">interval</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ordered_date</span>
<span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">status_code</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;accepted&#39;</span><span class="p">,</span><span class="s1">&#39;checking&#39;</span><span class="p">)</span>

<span class="c1">-- (3) orderedDate=2013/12/31, statusCodes=null</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t_order</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">ordered_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;2013/12/31&#39;</span>
<span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">status_code</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span>

<span class="c1">-- (4) orderedDate=2013/12/31, statusCodes=[&#39;accepted&#39;]</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t_order</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">ordered_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;2013/12/31&#39;</span>
<span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">status_code</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;accepted&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id11">
<h4><a class="toc-backref" href="#id72" role="doc-backlink"><span class="section-number">5.3.2.4.4. </span>パラメータオブジェクト(JavaBean)のプロパティ値を判定</a><a class="headerlink" href="#id11" title="Permalink to this heading">¶</a></h4>
<p>SQLに渡されたパラメータオブジェクト(JavaBean)のプロパティに指定されている値を判定し、SQLを組み立てることができる。</p>
<p>判定用の要素は、以下の通りである。</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 15%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>要素</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li></li>
</ol>
</td>
<td><p>isEqual</p></td>
<td><p>プロパティの値が、指定した値と一致する時のSQLを組み立てるための要素。</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p>isNotEqual</p></td>
<td><p>プロパティの値が、指定した値と一致しない時のSQLを組み立てるための要素。</p></td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p>isGreaterThan</p></td>
<td><p>プロパティの値が、指定した値より大きい時のSQLを組み立てるための要素。</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p>isGreaterEqual</p></td>
<td><p>プロパティの値が、指定した値以上の時のSQLを組み立てるための要素。</p></td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="5">
<li></li>
</ol>
</td>
<td><p>isLessThan</p></td>
<td><p>プロパティの値が、指定した値より小さい時のSQLを組み立てるための要素。</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="6">
<li></li>
</ol>
</td>
<td><p>isLessEqual</p></td>
<td><p>プロパティの値が、指定した値以下の時のSQLを組み立てるための要素。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>実装例は、以下の通りである。</p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;findOne&quot;</span><span class="w"> </span><span class="na">parameterClass=</span><span class="s">&quot;OrderCriteria&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;...&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span>SELECT
<span class="w">        </span>*
<span class="w">    </span>FROM
<span class="w">        </span>t_order
<span class="w">    </span>WHERE
<span class="w">        </span>(
<span class="w">        </span><span class="cp">&lt;![CDATA[</span>
<span class="cp">        status_code &lt;&gt; &#39;completed&#39;</span>
<span class="cp">        ]]&gt;</span>
<span class="w">        </span><span class="nt">&lt;isEqual</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;containCompletedOrder&quot;</span>
<span class="w">                 </span><span class="na">compareValue=</span><span class="s">&quot;true&quot;</span>
<span class="w">                 </span><span class="na">prepend=</span><span class="s">&quot;OR&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">            </span>status_code<span class="w"> </span>=<span class="w"> </span>&#39;completed&#39;
<span class="w">        </span><span class="nt">&lt;/isNull&gt;</span>
<span class="w">        </span>)

<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例では、<code class="docutils literal notranslate"><span class="pre">containCompletedOrder</span></code>プロパティ(Boolean型)の値が、<code class="docutils literal notranslate"><span class="pre">true</span></code>の場合に、status_codeカラムが<code class="docutils literal notranslate"><span class="pre">'completed'</span></code>のレコードも取得されるように、WHERE句を設定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>compareProperty属性を使用することで、JavaBean内の別のプロパティの値と、比較することもできる。</p>
</div>
</div></blockquote>
<p>上記の動的SQLで生成されるSQLは、以下2パターンとなる。</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- (1) containCompletedOrder=false</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t_order</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="n">status_code</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w">  </span><span class="s1">&#39;completed&#39;</span><span class="p">)</span>

<span class="c1">-- (2) containCompletedOrder=true</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t_order</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="n">status_code</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w">  </span><span class="s1">&#39;completed&#39;</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">status_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="id12">
<h4><a class="toc-backref" href="#id73" role="doc-backlink"><span class="section-number">5.3.2.4.5. </span>判定要素の共通属性</a><a class="headerlink" href="#id12" title="Permalink to this heading">¶</a></h4>
<p>動的SQLを組み立てるための要素には、以下の共通的な属性が存在する。</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 15%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>属性</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li></li>
</ol>
</td>
<td><p>prepend</p></td>
<td><p>動的SQLを組み立てるための判定要素で、<code class="docutils literal notranslate"><span class="pre">true</span></code>と判断され、SQLが組み立てられた際に、SQLの先頭に設定する文字列を指定する。</p></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p>open</p></td>
<td><p>動的SQLを組み立てるための判定要素の中で、組み立てたSQLの前に追加する文字列を指定する。</p></td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p>close</p></td>
<td><p>動的SQLを組み立てるための判定要素の中で、組み立てたSQLの後に付与する文字列を指定する。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>実装例は、以下の通りである。</p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;findOne&quot;</span><span class="w"> </span><span class="na">parameterClass=</span><span class="s">&quot;OrderCriteria&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;...&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span>SELECT
<span class="w">        </span>*
<span class="w">    </span>FROM
<span class="w">        </span>t_order

<span class="w">    </span><span class="nt">&lt;isNotEmpty</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;statusCode&quot;</span>
<span class="w">                </span><span class="na">prepend=</span><span class="s">&quot;WHERE&quot;</span>
<span class="w">                </span><span class="na">open=</span><span class="s">&quot;(&quot;</span>
<span class="w">                </span><span class="na">close=</span><span class="s">&quot;)&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">        </span>status_code<span class="w"> </span>=<span class="w"> </span>#statusCode#
<span class="w">        </span><span class="nt">&lt;isEqual</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;containCompletedOrder&quot;</span><span class="w"> </span><span class="na">compareValue=</span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="na">prepend=</span><span class="s">&quot;OR&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span>status_code<span class="w"> </span>=<span class="w"> </span>&#39;completed&#39;
<span class="w">        </span><span class="nt">&lt;/isEqual&gt;</span>
<span class="w">    </span><span class="nt">&lt;/isNotEmpty&gt;</span>

<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 15%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>属性</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例では、<code class="docutils literal notranslate"><span class="pre">statusCode</span></code>プロパティに値が指定されている場合に、status_codeカラムをWHERE句にし、</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">containCompletedOrder</span></code>プロパティ(Boolean型)の値が<code class="docutils literal notranslate"><span class="pre">true</span></code>の場合は、status_codeカラムが<code class="docutils literal notranslate"><span class="pre">'completed'</span></code>のレコードも取得されるように、WHERE句を設定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="line-block">
<div class="line">prepend</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">statusCode</span></code>プロパティに値が指定されている場合に、SQLに<code class="docutils literal notranslate"><span class="pre">&quot;WHERE&quot;</span></code>を設定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="line-block">
<div class="line">open</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">containCompletedOrder</span></code>プロパティ(Boolean型)の値が、<code class="docutils literal notranslate"><span class="pre">true</span></code>の場合は、OR条件を加えるため、</div>
<div class="line">status_codeカラムに対する条件をグループ化するための開始文^<code class="docutils literal notranslate"><span class="pre">&quot;(&quot;</span></code>を指定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="line-block">
<div class="line">close</div>
</div>
</td>
<td><div class="line-block">
<div class="line">status_codeカラムに対する条件をグループ化するための終了文字<code class="docutils literal notranslate"><span class="pre">&quot;)&quot;</span></code>を指定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>上記の動的SQLで生成されるSQLは、以下3パターンとなる。</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- (1) statusCode=null, containCompletedOrder=false</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t_order</span>

<span class="c1">-- (2) statusCode=&#39;accepted&#39;, containCompletedOrder=false</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t_order</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="n">status_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;accepted&#39;</span><span class="p">)</span>

<span class="c1">-- (3) statusCode=&#39;checking&#39;, containCompletedOrder=true</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t_order</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="n">status_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checking&#39;</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">status_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="id13">
<h4><a class="toc-backref" href="#id74" role="doc-backlink"><span class="section-number">5.3.2.4.6. </span>コレクションの繰り返し</a><a class="headerlink" href="#id13" title="Permalink to this heading">¶</a></h4>
<p>SQLに渡されたバインド値が、コレクションや配列の場合、コレクションおよび配列の要素分処理を繰り返して、SQLを組み立てることができる。</p>
<p>要素は、以下の通りである。</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 15%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>要素</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li></li>
</ol>
</td>
<td><p>iterate</p></td>
<td><p>コレクションおよび配列に対して、繰り返し処理を行い、SQLを組み立てるための要素。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>実装例は、以下の通りである。</p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;findOne&quot;</span><span class="w"> </span><span class="na">parameterClass=</span><span class="s">&quot;OrderCriteria&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;...&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span>SELECT
<span class="w">        </span>*
<span class="w">    </span>FROM
<span class="w">        </span>t_order

<span class="w">    </span><span class="nt">&lt;isNotNull</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;statusCodes&quot;</span><span class="w"> </span><span class="na">prepend=</span><span class="s">&quot;WHERE&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;iterate</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;statusCodes&quot;</span>
<span class="w">                 </span><span class="na">prepend=</span><span class="s">&quot;status_code IN&quot;</span>
<span class="w">                 </span><span class="na">open=</span><span class="s">&quot;(&quot;</span>
<span class="w">                 </span><span class="na">conjunction=</span><span class="s">&quot;,&quot;</span>
<span class="w">                 </span><span class="na">close=</span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">            </span>#statusCodes[]#
<span class="w">        </span><span class="nt">&lt;/iterate&gt;</span>
<span class="w">    </span><span class="nt">&lt;/isNotNull&gt;</span>

<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 15%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>属性</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例では、<code class="docutils literal notranslate"><span class="pre">statusCodes</span></code>プロパティ(List&lt;String&gt;)に格納されている値を、IN句の値として設定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="line-block">
<div class="line">prepend</div>
</div>
</td>
<td><div class="line-block">
<div class="line">コレクションまたは配列の要素が存在する場合に、最初に設定する文字列を指定する。例では、条件に加えるカラム名と、IN句を指定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="line-block">
<div class="line">open</div>
</div>
</td>
<td><div class="line-block">
<div class="line">コレクションまたは配列の最初の要素を処理する前に設定する文字列を指定する。例では、IN句に指定する値の開始囲い文字<code class="docutils literal notranslate"><span class="pre">&quot;(&quot;</span></code>を指定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="line-block">
<div class="line">conjunction</div>
</div>
</td>
<td><div class="line-block">
<div class="line">次の要素がある場合、次の要素の処理を行う前に設定する文字列を指定する。例では、IN句に指定する値の区切り文字<code class="docutils literal notranslate"><span class="pre">&quot;,&quot;</span></code>を指定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="line-block">
<div class="line">close</div>
</div>
</td>
<td><div class="line-block">
<div class="line">コレクションまたは配列の最後の要素の処理を行った後に、設定する文字列を指定する。例では、IN句に指定する値の終了囲い文字<code class="docutils literal notranslate"><span class="pre">&quot;)&quot;</span></code>を指定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>上記例は、JavaBeanの中のプロパティがコレクションの場合の実装例であるが、パラメータオブジェクト自体をコレクションにすることもできる。
その場合は、property属性は指定せず、<code class="docutils literal notranslate"><span class="pre">#[]#</span></code>という形式でアクセスすることができる。</p>
<p>コレクションには、JavaBeanを格納することもでき、JavaBeanにネストされているコレクションにも、アクセスすることができる。
詳細は、Developer Guide(PDF)の「Dynamic Mapped Statements」(P.52)を参照されたい。</p>
</div>
</div></blockquote>
<p>上記の動的SQLで生成されるSQLは、以下3パターンとなる。</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- (1) statusCodes=null</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t_order</span>

<span class="c1">-- (2) statusCodes=[]</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t_order</span>

<span class="c1">-- (3) statusCodes=[&#39;accepted&#39;,&#39;checking&#39;]</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t_order</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">status_code</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;accepted&#39;</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checking&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="id14">
<h4><a class="toc-backref" href="#id75" role="doc-backlink"><span class="section-number">5.3.2.4.7. </span>動的SQLのブロック化</a><a class="headerlink" href="#id14" title="Permalink to this heading">¶</a></h4>
<p>個々の動的SQLをブロック化することで、ブロック全体として、prepend, open, close属性を制御することができる。</p>
<p>要素は、以下の通りである。</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 15%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>要素</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li></li>
</ol>
</td>
<td><p>dynamic</p></td>
<td><p>動的SQLを組み立てる要素をブロック化するための要素。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>実装例は、以下の通りである。</p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;findOne&quot;</span><span class="w"> </span><span class="na">parameterClass=</span><span class="s">&quot;OrderCriteria&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;...&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span>SELECT
<span class="w">        </span>*
<span class="w">    </span>FROM
<span class="w">        </span>t_order
<span class="w">    </span>WHERE

<span class="w">    </span><span class="nt">&lt;dynamic</span><span class="w"> </span><span class="na">prepend=</span><span class="s">&quot;WHERE&quot;</span>
<span class="w">             </span><span class="na">open=</span><span class="s">&quot;(&quot;</span>
<span class="w">             </span><span class="na">close=</span><span class="s">&quot;)&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>

<span class="w">        </span><span class="nt">&lt;isNotEmpty</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;id&quot;</span><span class="w"> </span><span class="na">prepend=</span><span class="s">&quot;AND&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">            </span>id<span class="w"> </span>=<span class="w"> </span>#id#
<span class="w">        </span><span class="nt">&lt;/isNotEmpty&gt;</span>

<span class="w">        </span><span class="nt">&lt;isNotEmpty</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;statusCode&quot;</span><span class="w"> </span><span class="na">prepend=</span><span class="s">&quot;AND&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="w">            </span>status_code<span class="w"> </span>=<span class="w"> </span>#statusCode#
<span class="w">        </span><span class="nt">&lt;/isNotEmpty&gt;</span>

<span class="w">    </span><span class="nt">&lt;/dynamic&gt;</span>

<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 15%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>属性</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="line-block">
<div class="line">(2)と(3)の動的SQLを、ブロック化している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="line-block">
<div class="line">prepend</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ブロック内で組み立てたSQLの先頭に設定する文字列を指定する。ここで指定した値は、ブロック内で最初に一致した動的SQLのprepend属性の値として使用される。</div>
<div class="line">上記例だと、<code class="docutils literal notranslate"><span class="pre">id</span></code>プロパティに値を指定した場合、(2)のprepend属性の値は、<code class="docutils literal notranslate"><span class="pre">&quot;AND&quot;</span></code>ではなく、<code class="docutils literal notranslate"><span class="pre">&quot;WHERE&quot;</span></code>となる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="line-block">
<div class="line">open</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ブロック中で組み立てたSQLの前に、追加する文字列を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="line-block">
<div class="line">close</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ブロック中で組み立てたSQLの後に、追加する文字列を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>上記の動的SQLで生成されるSQLは、以下4パターンとなる。</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- (1) id=null, statusCode=null</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t_order</span>

<span class="c1">-- (2) id=1, statusCode=null</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t_order</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="c1">-- (3) id=null, statusCode=&#39;accepted&#39;</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t_order</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="n">status_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;accepted&#39;</span><span class="p">)</span>

<span class="c1">-- (4) id=1, statusCode=&#39;accepted&#39;</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t_order</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">status_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;accepted&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</section>
</section>
<section id="querydao">
<h3><a class="toc-backref" href="#id76" role="doc-backlink"><span class="section-number">5.3.2.5. </span>QueryDAOの使用例</a><a class="headerlink" href="#querydao" title="Permalink to this heading">¶</a></h3>
<section id="id15">
<h4><a class="toc-backref" href="#id77" role="doc-backlink"><span class="section-number">5.3.2.5.1. </span>1件検索</a><a class="headerlink" href="#id15" title="Permalink to this heading">¶</a></h4>
<p>検索結果が、0～1件となるクエリを発行したい場合、以下のような実装となる。</p>
<ul class="simple">
<li><p>Xxx.java</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">String</span><span class="w"> </span><span class="n">todoId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;xxxxx....&quot;</span><span class="p">;</span>
<span class="n">Todo</span><span class="w"> </span><span class="n">loadedTodo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queryDAO</span><span class="p">.</span><span class="na">executeForObject</span><span class="p">(</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">        </span><span class="s">&quot;todo.findOne&quot;</span><span class="p">,</span><span class="w">    </span><span class="c1">// (2)</span>
<span class="w">        </span><span class="n">todoId</span><span class="p">,</span><span class="w">            </span><span class="c1">// (3)</span>
<span class="w">        </span><span class="n">Todo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">       </span><span class="c1">// (4)</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">loadedTodo</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// (5)</span>
<span class="w">    </span><span class="c1">// ...                 // (6)</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>検索結果を(4)で指定した型のオブジェクトとして取得するためのメソッド(<code class="docutils literal notranslate"><span class="pre">QueryDAO#executeForObject</span></code>)を呼び出す。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">検索結果が0～1件となるSQLのSQLIDを指定する。</div>
<div class="line">検索結果が複数件になる場合は、Mybatisが<code class="docutils literal notranslate"><span class="pre">java.sql.SQLException</span></code>を発生させる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">SQLのバインドパラメータを指定する。</div>
<div class="line">例では、<code class="docutils literal notranslate"><span class="pre">java.lang.String</span></code>にしているが、複数のパラメータ(検索条件)を渡したい場合は、JavaBeanを指定することもできる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p>SQLの取得結果をマッピングするオブジェクトの型を指定する。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><p>検索結果が0件の場合は、nullになるので、null判定が必要である。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><p>検索結果が、0件の場合の処理を実装する。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="id16">
<h4><a class="toc-backref" href="#id78" role="doc-backlink"><span class="section-number">5.3.2.5.2. </span>複数件検索</a><a class="headerlink" href="#id16" title="Permalink to this heading">¶</a></h4>
<p>検索結果が、0～N件となるクエリを発行し、条件に一致するデータをすべて取得する場合は、以下のような実装となる。</p>
<ul class="simple">
<li><p>Xxx.java</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kt">boolean</span><span class="w"> </span><span class="n">finished</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">unfinishedTodoList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queryDAO</span><span class="p">.</span><span class="na">executeForObjectList</span><span class="p">(</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">        </span><span class="s">&quot;todo.findByFinished&quot;</span><span class="p">,</span><span class="w">     </span><span class="c1">// (2)</span>
<span class="w">        </span><span class="n">finished</span><span class="p">);</span><span class="w">                 </span><span class="c1">// (3)</span>
<span class="k">if</span><span class="p">(</span><span class="n">unfinishedTodoList</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">()){</span><span class="w">  </span><span class="c1">// (4)</span>
<span class="w">    </span><span class="c1">// ...                         // (5)</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>オブジェクトのリストを取得するための、メソッドを呼び出す。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p>検索結果が、0～N件となるSQLのSQLIDを指定する。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">SQLのバインドパラメータを指定する。</div>
<div class="line">例では、booleanにしているが、複数のパラメータ(検索条件)を渡したい場合は、JavaBeanを指定することもできる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p>検索結果が0件の場合は、空のリストが返却される。nullは返却されないので、nullチェックは不要である。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><p>検索結果が、0件の場合の処理を実装する。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="id17">
<h4><a class="toc-backref" href="#id79" role="doc-backlink"><span class="section-number">5.3.2.5.3. </span>ページネーション検索（TERASOLUNA DAO標準機能方式）</a><a class="headerlink" href="#id17" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">検索結果が、0～N件となるクエリを発行し、条件に一致するデータの一部(指定ページ部分)を取得する場合は、以下のような実装となる。</div>
<div class="line">以下の例では、TERASOLUNA DAOから提供されているAPIを使って、実現する実装例となっている。</div>
</div>
<dl>
<dt></dt><dd><div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>検索条件に一致するデータ件数が非常に多くなる場合の注意点</strong></p>
<p>TERASOLUNA DAO標準機能のページネーション検索は、<code class="docutils literal notranslate"><span class="pre">java.sql.ResultSet#next</span></code>を使って取得するレコードの開始位置までスキップする実装となっているため、
検索条件に一致するデータ件数が、非常に多い場合、処理性能に影響を与える可能性がある。
検索条件に一致するデータ件数が、非常に多くなる可能性がある場合は、TERASOLUNA DAO標準機能のページネーション検索ではなく、SQL絞り込み方式の採用を検討すること。</p>
</div>
</dd>
</dl>
<ul class="simple">
<li><p>Xxx.java</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Pageable</span><span class="w"> </span><span class="n">pageable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PageRequest</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="kt">boolean</span><span class="w"> </span><span class="n">finished</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="kt">long</span><span class="w"> </span><span class="n">totalCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queryDAO</span><span class="p">.</span><span class="na">executeForObject</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;todo.countByFinished&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">        </span><span class="n">finished</span><span class="p">,</span>
<span class="w">        </span><span class="n">Long</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">            </span><span class="c1">// (3)</span>

<span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">unfinishedTodoList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="k">if</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">totalCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">unfinishedTodoList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queryDAO</span><span class="p">.</span><span class="na">executeForObjectList</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;todo.findByFinished&quot;</span><span class="p">,</span><span class="w">   </span><span class="c1">// (4)</span>
<span class="w">        </span><span class="n">finished</span><span class="p">,</span>
<span class="w">        </span><span class="n">pageable</span><span class="p">.</span><span class="na">getOffset</span><span class="p">(),</span><span class="w">    </span><span class="c1">// (5)</span>
<span class="w">        </span><span class="n">pageable</span><span class="p">.</span><span class="na">getPageSize</span><span class="p">());</span><span class="w"> </span><span class="c1">// (6)</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">unfinishedTodoList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">Page</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PageImpl</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="p">(</span><span class="w"> </span><span class="c1">// (7)</span>
<span class="w">        </span><span class="n">unfinishedTodoList</span><span class="p">,</span><span class="w"> </span><span class="c1">// (8)</span>
<span class="w">        </span><span class="n">pageable</span><span class="p">,</span><span class="w">           </span><span class="c1">// (9)</span>
<span class="w">        </span><span class="n">totalCount</span><span class="p">);</span><span class="w">        </span><span class="c1">// (10)</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>xxx-sqlmap.xml</p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;findByFinished&quot;</span>
<span class="w">        </span><span class="na">parameterClass=</span><span class="s">&quot;boolean&quot;</span>
<span class="w">        </span><span class="na">resultMap=</span><span class="s">&quot;resultMap_Todo&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (11) --&gt;</span>
<span class="w">    </span>SELECT
<span class="w">        </span>*
<span class="w">    </span>FROM
<span class="w">        </span>todo
<span class="w">    </span>WHERE
<span class="w">        </span>finished<span class="w"> </span>=<span class="w"> </span>#finished#
<span class="w">    </span>ORDER<span class="w"> </span>BY
<span class="w">        </span>created_at<span class="w"> </span>DESC
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>Spring Dataより提供されているページング検索用のオブジェクト（<code class="docutils literal notranslate"><span class="pre">org.springframework.data.domain.PageRequest</span></code>）を生成する。
Pageableオブジェクトは、リクエストパラメータに指定して、Controllerの引数として受け事もできる。詳細は、<a class="reference internal" href="Pagination.html"><span class="doc">ページネーション</span></a>を参照されたい。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p>条件に一致するデータの合計件数を、取得するためのSQLの、SQLIDを指定して実行する。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p>件数の取得なので、Long.classを指定する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p>検索結果が、0～N件となるSQLの、SQLIDを指定して実行する。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得開始位置を指定する。</div>
<div class="line">0開始。取得件数が10件のときに、10を指定すると、11～20件目が取得される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得件数を指定する。</div>
<div class="line">取得開始位置が0のときに、10を指定すると、1～10件目が取得される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><p>Spring Dataより提供されているページ用のオブジェクト（<code class="docutils literal notranslate"><span class="pre">org.springframework.data.domain.PageImpl</span></code>）を生成する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(8)</div>
</div>
</td>
<td><p>ページネーション検索して、取得したリストを指定する。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(9)</div>
</div>
</td>
<td><p>ページネーション検索で使用したページング検索用のオブジェクト(Pageable)を指定する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(10)</div>
</div>
</td>
<td><p>条件に一致するデータの、合計件数を指定する。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(11)</div>
</div>
</td>
<td><p>SQLの実装例。SQLとしては、取得位置を意識する必要はない。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="id18">
<h4><a class="toc-backref" href="#id80" role="doc-backlink"><span class="section-number">5.3.2.5.4. </span>ページネーション検索（SQL絞り込み方式）</a><a class="headerlink" href="#id18" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">検索結果が0～N件となるクエリを発行し、条件に一致するデータの一部(指定ページ部分)を取得する場合は、以下のような実装となる。</div>
<div class="line">以下の例では、TERASOLUNA DAOから提供されているAPIを使わずに、SQLを使って実現する実装例となっている。</div>
</div>
<ul class="simple">
<li><p>PageableBindParams.java (サンプルクラス)</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PageableBindParams</span><span class="o">&lt;</span><span class="n">P</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Serializable</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">serialVersionUID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1L</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="n">bindParams</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Pageable</span><span class="w"> </span><span class="n">pageable</span><span class="p">;</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">PageableBindParams</span><span class="p">(</span><span class="n">P</span><span class="w"> </span><span class="n">bindParams</span><span class="p">,</span><span class="w"> </span><span class="n">Pageable</span><span class="w"> </span><span class="n">pageable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">bindParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bindParams</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">pageable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pageable</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="nf">getBindParams</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">bindParams</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Pageable</span><span class="w"> </span><span class="nf">getPageable</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">pageable</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>Xxx.java</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Pageable</span><span class="w"> </span><span class="n">pageable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PageRequest</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
<span class="kt">boolean</span><span class="w"> </span><span class="n">finished</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="kt">long</span><span class="w"> </span><span class="n">totalCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queryDAO</span><span class="p">.</span><span class="na">executeForObject</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;todo.countByFinished&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">finished</span><span class="p">,</span>
<span class="w">        </span><span class="n">Long</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"> </span><span class="c1">// (2)</span>

<span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">unfinishedTodoList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="k">if</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">totalCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">PageableBindParams</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pageableBindParams</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">PageableBindParams</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="p">(</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">                    </span><span class="n">finished</span><span class="p">,</span><span class="w">  </span><span class="c1">// (4)</span>
<span class="w">                    </span><span class="n">pageable</span><span class="p">);</span><span class="w"> </span><span class="c1">// (5)</span>
<span class="w">    </span><span class="n">unfinishedTodoList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queryDAO</span><span class="p">.</span><span class="na">executeForObjectList</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;todo.findPageByFinished&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// (6)</span>
<span class="w">            </span><span class="n">pageableBindParams</span><span class="p">);</span><span class="w">       </span><span class="c1">// (7)</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">unfinishedTodoList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">Page</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PageImpl</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">        </span><span class="n">unfinishedTodoList</span><span class="p">,</span>
<span class="w">        </span><span class="n">pageable</span><span class="p">,</span>
<span class="w">        </span><span class="n">totalCount</span><span class="p">);</span><span class="w"> </span><span class="c1">// (8)</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>xxx-sqlmap.xml</p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;findPageByFinished&quot;</span>
<span class="w">         </span><span class="na">parameterClass=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.dto.PageableBindParams&quot;</span>
<span class="w">         </span><span class="na">resultMap=</span><span class="s">&quot;resultMap_Todo&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (9) --&gt;</span>
<span class="w">     </span>SELECT
<span class="w">         </span>*
<span class="w">     </span>FROM
<span class="w">         </span>todo
<span class="w">     </span>WHERE
<span class="w">         </span>finished<span class="w"> </span>=<span class="w"> </span>#bindParams#
<span class="w">     </span>ORDER<span class="w"> </span>BY
<span class="w">         </span>created_at<span class="w"> </span>DESC
<span class="w">     </span>OFFSET
<span class="w">         </span>#pageable.offset#<span class="w">    </span>/*<span class="w"> </span>(10)<span class="w"> </span>*/
<span class="w">     </span>LIMIT
<span class="w">         </span>#pageable.pageSize#<span class="w">  </span>/*<span class="w"> </span>(11)<span class="w"> </span>*/
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>検索条件となるパラメータ（バインドパラメータ）と、Spring Dataより提供されているページング検索用のオブジェクト（<code class="docutils literal notranslate"><span class="pre">org.springframework.data.domain.Pageable</span></code>）を保持するJavaBean。
DAOに渡せるバインドオブジェクトは一つのみなので、本クラスのような集約オブジェクトが、必要となる。本クラスは、サンプル実装なので、各プロジェクトで必要に応じて用意すること。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p>TERASOLUNA DAO標準機能使用時と同様に、合計件数を取得する。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">DAOに渡すバインド用オブジェクトを生成する。</div>
<div class="line">例では、(1)で用意したクラスを使用する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">対象データを絞り込むための、検索条件を指定する。</div>
<div class="line">例では、finishedの値として、「false」を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">該当ページのデータを絞り込むための、検索条件を指定する。</div>
<div class="line">例では、Spring Dataより提供されているページング検索用のオブジェクト（<code class="docutils literal notranslate"><span class="pre">org.springframework.data.domain.PageRequest</span></code>）を指定している。</div>
<div class="line">Pageableオブジェクトは、リクエストパラメータに指定して、Controllerの引数として受けることもできる。詳細は、<a class="reference internal" href="Pagination.html"><span class="doc">ページネーション</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><p>該当ページのデータを抽出するSQLが実装されているSQLのSQLIDを指定する。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><p>(3)で生成したバインド用オブジェクトを指定する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(8)</div>
</div>
</td>
<td><p>TERASOLUNA DAO標準機能使用時と同様に、Spring Dataより提供されているページ用のオブジェクト（ <code class="docutils literal notranslate"><span class="pre">org.springframework.data.domain.PageImpl</span></code> ）を生成する。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(9)</div>
</div>
</td>
<td><p>SQLの実装例。例では、PostgreSQLから提供されている機能(OFFSET,LIMIT)を使用している。SQLとして、取得位置を意識する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得開始位置を指定する。</div>
<div class="line">0開始。取得件数が10件のときに、10を指定すると、11～20件目が取得される。(PostgreSQLの機能を使用する)</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得件数を指定する。</div>
<div class="line">取得開始位置が、0のときに、10を指定すると、1～10件目が取得される。(PostgreSQLの機能を使用する)</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
</section>
<section id="updatedao">
<h3><a class="toc-backref" href="#id81" role="doc-backlink"><span class="section-number">5.3.2.6. </span>UpdateDAOの使用例</a><a class="headerlink" href="#updatedao" title="Permalink to this heading">¶</a></h3>
<section id="id19">
<h4><a class="toc-backref" href="#id82" role="doc-backlink"><span class="section-number">5.3.2.6.1. </span>1件挿入</a><a class="headerlink" href="#id19" title="Permalink to this heading">¶</a></h4>
<p>1件のデータの挿入する場合、以下のような実装となる。</p>
<ul class="simple">
<li><p>Xxx.java</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="n">Todo</span><span class="w"> </span><span class="n">todo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Todo</span><span class="p">();</span>
<span class="n">todo</span><span class="p">.</span><span class="na">setTodoId</span><span class="p">(</span><span class="n">todoId</span><span class="p">);</span>
<span class="n">todo</span><span class="p">.</span><span class="na">setTodoTitle</span><span class="p">(</span><span class="n">todoTitle</span><span class="p">);</span>
<span class="n">todo</span><span class="p">.</span><span class="na">setFinished</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="n">todo</span><span class="p">.</span><span class="na">setCreatedAt</span><span class="p">(</span><span class="n">now</span><span class="p">);</span>
<span class="kt">int</span><span class="w"> </span><span class="n">insertedCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updateDAO</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="s">&quot;todo.insert&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">todo</span><span class="p">);</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="k">if</span><span class="p">(</span><span class="n">insertedCount</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">){</span><span class="w">  </span><span class="c1">// (3)</span>
<span class="w">    </span><span class="c1">// ...               // (4)</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>挿入対象のデータ(JavaBean)を生成する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p>挿入用SQLのSQLIDと、挿入対象のデータ(JavaBean)を指定して、DAOを実行する。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p>必要に応じて、実際に挿入されたデータの件数を、チェックする。例では、挿入件数が1件であるかをチェックしている。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p>必要に応じて、実際に挿入された件数が、想定件数と異なる場合の処理を行う。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="id20">
<h4><a class="toc-backref" href="#id83" role="doc-backlink"><span class="section-number">5.3.2.6.2. </span>複数件挿入(バッチ実行)</a><a class="headerlink" href="#id20" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">複数のSQLを、バッチ実行することで、複数件のデータを挿入する場合は、以下のような実装となる。</div>
<div class="line">TERASOLUNA DAOから提供されている<code class="docutils literal notranslate"><span class="pre">jp.terasoluna.fw.dao.SqlHolder</span></code>を使用する。</div>
</div>
<ul class="simple">
<li><p>Xxx.java</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="n">Todo</span><span class="w"> </span><span class="n">todo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Todo</span><span class="p">();</span>
<span class="n">todo</span><span class="p">.</span><span class="na">setTodoId</span><span class="p">(</span><span class="n">todoId</span><span class="p">);</span>
<span class="n">todo</span><span class="p">.</span><span class="na">setTodoTitle</span><span class="p">(</span><span class="n">todoTitle</span><span class="p">);</span>
<span class="n">todo</span><span class="p">.</span><span class="na">setFinished</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="n">todo</span><span class="p">.</span><span class="na">setCreatedAt</span><span class="p">(</span><span class="n">now</span><span class="p">);</span>

<span class="c1">// (2)</span>
<span class="n">Todo</span><span class="w"> </span><span class="n">todo2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Todo</span><span class="p">();</span>
<span class="n">todo2</span><span class="p">.</span><span class="na">setTodoId</span><span class="p">(</span><span class="n">todoId2</span><span class="p">);</span>
<span class="n">todo2</span><span class="p">.</span><span class="na">setTodoTitle</span><span class="p">(</span><span class="n">todoTitle2</span><span class="p">);</span>
<span class="n">todo2</span><span class="p">.</span><span class="na">setFinished</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="n">todo2</span><span class="p">.</span><span class="na">setCreatedAt</span><span class="p">(</span><span class="n">now</span><span class="p">);</span>

<span class="n">List</span><span class="o">&lt;</span><span class="n">SqlHolder</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sqlHolders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">SqlHolder</span><span class="o">&gt;</span><span class="p">();</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="n">sqlHolders</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">SqlHolder</span><span class="p">(</span><span class="s">&quot;todo.insert&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">todo</span><span class="p">));</span><span class="w">      </span><span class="c1">// (4)</span>
<span class="n">sqlHolders</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">SqlHolder</span><span class="p">(</span><span class="s">&quot;todo.insert&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">todo2</span><span class="p">));</span><span class="w">     </span><span class="c1">// (4)</span>
<span class="kt">int</span><span class="w"> </span><span class="n">insertedCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updateDAO</span><span class="p">.</span><span class="na">executeBatch</span><span class="p">(</span><span class="n">sqlHolders</span><span class="p">);</span><span class="w">  </span><span class="c1">// (5)</span>
<span class="k">if</span><span class="p">(</span><span class="n">insertedCount</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="p">){</span><span class="w">  </span><span class="c1">// (6)</span>
<span class="w">    </span><span class="c1">// ...               // (7)</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>挿入対象のデータ(JavaBean)を生成する。1件目のデータ。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p>挿入対象のデータ(JavaBean)を生成する。2件目のデータ。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p>バッチ実行用に、TERASOLUNA DAOから提供されている<code class="docutils literal notranslate"><span class="pre">jp.terasoluna.fw.dao.SqlHolder</span></code>のリストを生成する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p>(1), (2)で生成したデータを、バインド用オブジェクトとして、SqlHolderのリストに追加する。例では、2件リストに追加している。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><p>(1)～(4)で生成したSqlHolderのリストを指定して、バッチを実行する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">必要に応じて、実際に挿入されたデータの件数をチェックする。</div>
<div class="line">例では、挿入件数が2件であるかをチェックしている。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><p>必要に応じて、実際に挿入された件数が、想定件数と異なる場合の処理を行う。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<dl>
<dt></dt><dd><div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>バッチ実行における挿入件数について</strong></p>
<p>バッチ実行した場合、JDBCドライバによっては、正確な行数が取得できないケースがある。
正確に取得できないドライバを使用する場合に、挿入件数をチェックする必要があるケースで、バッチ実行を使用しないこと。
(更新時の更新件数、削除時の削除件数も同様である。)</p>
</div>
</dd>
</dl>
</section>
<section id="id21">
<h4><a class="toc-backref" href="#id84" role="doc-backlink"><span class="section-number">5.3.2.6.3. </span>1件更新</a><a class="headerlink" href="#id21" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">1件のデータの更新する場合、以下のような実装となる。</div>
<div class="line">1件挿入の場合と同じである。使用するSQLが、更新用のSQLになる。</div>
</div>
<ul class="simple">
<li><p>Xxx.java</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Todo</span><span class="w"> </span><span class="n">loadedTodo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queryDAO</span><span class="p">.</span><span class="na">executeForObject</span><span class="p">(</span><span class="s">&quot;todo.findOne&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">todoId</span><span class="p">,</span>
<span class="w">        </span><span class="n">Todo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">     </span><span class="c1">// (1)</span>
<span class="n">todo2</span><span class="p">.</span><span class="na">setFinished</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="kt">int</span><span class="w"> </span><span class="n">updatedCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updateDAO</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="s">&quot;todo.update&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">todo</span><span class="p">);</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="k">if</span><span class="p">(</span><span class="n">updatedCount</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">){</span><span class="w">   </span><span class="c1">// (4)</span>
<span class="w">    </span><span class="c1">// ...               // (5)</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>更新対象のデータ(JavaBean)を、検索する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p>データを更新する。例では、finishedを、falseからtrueに更新する。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p>更新用SQLのSQLIDと、更新対象のデータ(JavaBean)を指定して、DAOを実行する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">必要に応じて、実際の更新されたデータの件数をチェックする。</div>
<div class="line">例では、更新件数が1件であるかをチェックしている。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><p>必要に応じて、実際に更新された件数が、想定件数と異なる場合の処理を行う。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="id22">
<h4><a class="toc-backref" href="#id85" role="doc-backlink"><span class="section-number">5.3.2.6.4. </span>複数件更新(バッチ実行)</a><a class="headerlink" href="#id22" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">複数のSQLをバッチ実行することで、複数件のデータを更新する場合の実装例は、複数件挿入(バッチ実行)と同じである。</div>
<div class="line">更新値が、レコード毎に異なる場合、バッチ実行による複数件更新が有効である。</div>
</div>
</section>
<section id="where">
<h4><a class="toc-backref" href="#id86" role="doc-backlink"><span class="section-number">5.3.2.6.5. </span>複数件更新(WHERE句指定)</a><a class="headerlink" href="#where" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">SQLで指定した条件に一致するデータを一括で更新する場合、以下のような実装となる。</div>
<div class="line">全レコードを同じ値に一括更新する場合は、WHERE句指定による複数件更新が有効的である。</div>
</div>
<ul class="simple">
<li><p>Xxx.java</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">deadlineDays</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">updatedCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updateDAO</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="s">&quot;todo.update&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">deadlineDays</span><span class="p">);</span><span class="w"> </span><span class="c1">// (1)</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>xxx-sqlmap.xml</p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="nt">&lt;update</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;updateFinishedDeadlineByUnfinished&quot;</span><span class="w"> </span><span class="na">parameterClass=</span><span class="s">&quot;int&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">     </span><span class="cp">&lt;![CDATA[</span>
<span class="cp">     UPDATE</span>
<span class="cp">         todo</span>
<span class="cp">     SET</span>
<span class="cp">         todo_title = &#39;[Finished Deadline] &#39; || todo_title</span>
<span class="cp">         ,version = (version + 1)</span>
<span class="cp">     WHERE</span>
<span class="cp">         finished = false</span>
<span class="cp">     AND</span>
<span class="cp">         created_at &lt; current_date - #deadlineDays#</span>
<span class="cp">     ]]&gt;</span>
<span class="nt">&lt;/update&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>一括更新用SQLのSQLIDと、更新対象のデータを抽出するための条件を指定して、DAOを実行する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p>一括更新するSQLの実装例。例では、作成してから7日経過して、完了していないTODOのタイトルに“[Finished Deadline] “という文字列を先頭に付与している。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="id23">
<h4><a class="toc-backref" href="#id87" role="doc-backlink"><span class="section-number">5.3.2.6.6. </span>1件削除</a><a class="headerlink" href="#id23" title="Permalink to this heading">¶</a></h4>
<p>1件のデータの削除する場合、以下のような実装となる。</p>
<ul class="simple">
<li><p>Xxx.java</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">String</span><span class="w"> </span><span class="n">todoId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;xxxxx....&quot;</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">deletedCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updateDAO</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="s">&quot;todo.delete&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">todoId</span><span class="p">);</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="k">if</span><span class="p">(</span><span class="n">deletedCount</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">){</span>
<span class="w">    </span><span class="c1">// ...               // (2)</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">削除用SQLのSQLIDとPKを指定して、DAOを実行する。</div>
<div class="line">例では、<code class="docutils literal notranslate"><span class="pre">java.lang.String</span></code>にしているが、複合キーの場合は、JavaBeanを指定することもできる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p>必要に応じて、実際に削除された件数が、想定件数と異なる場合の処理を行う。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="id24">
<h4><a class="toc-backref" href="#id88" role="doc-backlink"><span class="section-number">5.3.2.6.7. </span>複数件削除(バッチ実行)</a><a class="headerlink" href="#id24" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">複数のSQLをバッチ実行することで、複数件のデータを削除する場合の実装例は、複数件更新(バッチ実行)と同じである。</div>
<div class="line">1件削除時の処理を共有する必要がある場合は、バッチ実行による複数件削除を使用する。ただし、削除する対象データが大量になる場合は、WHERE句指定による一括削除の方式を検討した方がよい。</div>
</div>
</section>
<section id="id25">
<h4><a class="toc-backref" href="#id89" role="doc-backlink"><span class="section-number">5.3.2.6.8. </span>複数件削除(WHERE句指定)</a><a class="headerlink" href="#id25" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">SQLで指定した条件に一致するデータを一括で削除する場合の実装例は、複数件更新(WHERE句指定)と同じである。</div>
<div class="line">削除対象のレコードが大量になる場合は、WHERE句指定による複数件削除が有効的である。</div>
</div>
</section>
</section>
<section id="storedproceduredao">
<h3><a class="toc-backref" href="#id90" role="doc-backlink"><span class="section-number">5.3.2.7. </span>StoredProcedureDAOの使用例</a><a class="headerlink" href="#storedproceduredao" title="Permalink to this heading">¶</a></h3>
<p>プロシージャや、ファンクションを呼び出す場合、以下のような実装となる。</p>
<ul class="simple">
<li><p>Xxx.java</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">SalesItem</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SalesItem</span><span class="p">();</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="n">item</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="n">Integer</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w">  </span><span class="c1">// (2)</span>
<span class="n">storedProcedureDAO</span><span class="p">.</span><span class="na">executeForObject</span><span class="p">(</span><span class="s">&quot;todo.findSalesItem&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">item</span><span class="p">);</span><span class="w">  </span><span class="c1">// (3)</span>
<span class="c1">// (4)</span>
<span class="n">logger</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;Quantity is {}.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="na">getQuantity</span><span class="p">());</span>
<span class="n">logger</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;Total is {}.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="na">getTotal</span><span class="p">());</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>プロシージャや、ファンクションのINパラメータを、OUTパラメータを保持するバインド用オブジェクトを生成する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p>INパラメータとして、IDをを設定する。例では、IDとして、<code class="docutils literal notranslate"><span class="pre">1</span></code>を設定している。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p>ストアードプロシージャ呼び出し用SQLの、SQLIDとバインド用オブジェクトを引数に、<code class="docutils literal notranslate"><span class="pre">StoredProcedureDAO</span></code>のメソッドを呼び出す。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">StoredProcedureDAO</span></code>のメソッドの呼び出しが、正常に終了した場合、</div>
<div class="line">プロシージャや、ファンクションのOUTパラメータが、バインド用オブジェクトに設定される。</div>
<div class="line">例では、バインド用オブジェクトに設定されたOUTパラメータの値を、ログに出力している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="queryrowhandledao">
<h3><a class="toc-backref" href="#id91" role="doc-backlink"><span class="section-number">5.3.2.8. </span>QueryRowHandleDAOの使用例</a><a class="headerlink" href="#queryrowhandledao" title="Permalink to this heading">¶</a></h3>
<ul class="simple">
<li><p>Xxx.java</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kt">boolean</span><span class="w"> </span><span class="n">finished</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="n">queryRowHandleDAO</span><span class="p">.</span><span class="na">executeWithRowHandler</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;todo.findByFinished&quot;</span><span class="p">,</span><span class="w">            </span><span class="c1">// (1)</span>
<span class="w">        </span><span class="n">finished</span><span class="p">,</span><span class="w">                         </span><span class="c1">// (2)</span>
<span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">DataRowHandler</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">            </span><span class="c1">// (3)</span>
<span class="w">            </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleRow</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">valueObject</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (4)</span>
<span class="w">                </span><span class="n">Todo</span><span class="w"> </span><span class="n">todo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Todo</span><span class="p">)</span><span class="w"> </span><span class="n">valueObject</span><span class="p">;</span>
<span class="w">                </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="n">todo</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">  </span><span class="c1">// (5)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">});</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>検索結果が、0～N件となるSQLの、SQLIDを指定する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">SQLのバインドパラメータを指定する。</div>
<div class="line">例では、booleanにしているが、複数のパラメータ(検索条件)を渡したい場合は、JavaBeanを指定することもできる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">jp.terasoluna.fw.dao.event.DataRowHandler</span></code>の実装オブジェクトを指定する。</div>
<div class="line">例では、無名クラスを使用しているが、実際のプロジェクトでは、実装クラスを作成することを検討すること。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">検索結果の1レコード毎に、handleRowメソッドが呼び出される。</div>
<div class="line">引数にわたってくるオブジェクトは、select要素にresultClass属性、または、resultMap要素のclass属性に指定したクラスのオブジェクトとなる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><p>例では、ログ出力しているだけだが、実際のプロジェクトで使う場合は、値の加工、各レコード値の集計、ファイル出力などの処理を行うことになる。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="like">
<span id="data-access-mybatis2-howtouse-like-escape"></span><h3><a class="toc-backref" href="#id92" role="doc-backlink"><span class="section-number">5.3.2.9. </span>LIKE検索時のエスケープについて</a><a class="headerlink" href="#like" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">LIKE検索を行う場合は、検索条件として使用する値を、LIKE検索用にエスケープする必要がある。</div>
<div class="line">LIKE検索用のエスケープ処理は、共通ライブラリから提供している<code class="docutils literal notranslate"><span class="pre">org.terasoluna.gfw.common.query.QueryEscapeUtils</span></code>クラスのメソッドを使用することで、実現できる。</div>
<div class="line">共通ライブラリから提供しているエスケープ処理の仕様については、<a class="reference internal" href="DataAccessCommon.html"><span class="doc">データベースアクセス（共通編）</span></a>の<a class="reference internal" href="DataAccessCommon.html#data-access-common-appendix-like-escape"><span class="std std-ref">LIKE検索時のエスケープについて</span></a>を参照されたい。</div>
</div>
<div class="line-block">
<div class="line">以下に、共通ライブラリから提供しているエスケープ処理の、使用方法について説明する。</div>
</div>
<section id="query">
<h4><a class="toc-backref" href="#id93" role="doc-backlink"><span class="section-number">5.3.2.9.1. </span>一致方法をQuery側で指定する場合の使用方法</a><a class="headerlink" href="#query" title="Permalink to this heading">¶</a></h4>
<p>一致方法(前方一致、後方一致、部分一致)の指定をJPQLとして指定する場合は、エスケープのみ行うメソッドを使用する。</p>
<ul class="simple">
<li><p><code class="file docutils literal notranslate"><span class="pre">xxx-sqlmap.xml</span></code></p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span>//<span class="w"> </span>(1)<span class="w"> </span>(2)
<span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;findAllByWord&quot;</span><span class="w"> </span><span class="na">parameterClass=</span><span class="s">&quot;String&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;resultMap_Article&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span>SELECT
<span class="w">      </span>*
<span class="w">  </span>FROM
<span class="w">      </span>article
<span class="w">  </span>WHERE
<span class="w">      </span>title<span class="w"> </span>LIKE<span class="w"> </span>&#39;%&#39;<span class="w"> </span>||<span class="w"> </span>#word#<span class="w"> </span>||<span class="w"> </span>&#39;%&#39;<span class="w"> </span>ESCAPE<span class="w"> </span>&#39;~&#39;
<span class="w">  </span>OR
<span class="w">      </span>overview<span class="w"> </span>LIKE<span class="w"> </span>&#39;%&#39;<span class="w"> </span>||<span class="w"> </span>#word#<span class="w"> </span>||<span class="w"> </span>&#39;%&#39;<span class="w"> </span>ESCAPE<span class="w"> </span>&#39;~&#39;
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">SQL内に、LIKE検索用のワイルドカード(<code class="docutils literal notranslate"><span class="pre">&quot;%&quot;</span></code>または<code class="docutils literal notranslate"><span class="pre">&quot;_&quot;</span></code>)を指定する。</div>
<div class="line">上記例では、引数<code class="docutils literal notranslate"><span class="pre">word</span></code>の前後に、ワイルドカード(<code class="docutils literal notranslate"><span class="pre">&quot;%&quot;</span></code>)を指定することで、一致方法を部分一致にしている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">共通ライブラリから提供しているエスケープ処理は、エスケープ文字として<code class="docutils literal notranslate"><span class="pre">&quot;~&quot;</span></code>を使用しているため、 LIKE句の後ろに<code class="docutils literal notranslate"><span class="pre">&quot;ESCAPE</span> <span class="pre">'~'&quot;</span></code>を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><p>Service or Repository</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="n">QueryDAO</span><span class="w"> </span><span class="n">queryDAO</span><span class="p">;</span>

<span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">Page</span><span class="o">&lt;</span><span class="n">Article</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">searchArticle</span><span class="p">(</span><span class="n">ArticleSearchCriteria</span><span class="w"> </span><span class="n">criteria</span><span class="p">,</span>
<span class="w">        </span><span class="n">Pageable</span><span class="w"> </span><span class="n">pageable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">escapedWord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">QueryEscapeUtils</span><span class="p">.</span><span class="na">toLikeCondition</span><span class="p">(</span><span class="n">criteria</span><span class="p">.</span><span class="na">getWord</span><span class="p">());</span><span class="w"> </span><span class="c1">// (3)</span>

<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queryDAO</span><span class="p">.</span><span class="na">executeForObject</span><span class="p">(</span><span class="s">&quot;article.countByWord&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">escapedWord</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Article</span><span class="o">&gt;</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">total</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">contents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queryDAO</span><span class="p">.</span><span class="na">executeForObjectList</span><span class="p">(</span><span class="s">&quot;article.findAllByWord&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">escapedWord</span><span class="p">,</span><span class="w"> </span><span class="n">pageable</span><span class="p">.</span><span class="na">getOffset</span><span class="p">(),</span><span class="w"> </span><span class="n">pageable</span><span class="p">.</span><span class="na">getPageSize</span><span class="p">());</span><span class="w"> </span><span class="c1">// (4)</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">contents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Collections</span><span class="p">.</span><span class="na">emptyList</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PageImpl</span><span class="o">&lt;</span><span class="n">Article</span><span class="o">&gt;</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span><span class="w"> </span><span class="n">pageable</span><span class="p">,</span><span class="w"> </span><span class="n">total</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">LIKE検索の一致方法をQuery側で指定する場合は、<code class="docutils literal notranslate"><span class="pre">QueryEscapeUtils#toLikeCondition(String)</span></code>メソッドを呼び出し、LIKE検索用のエスケープのみ行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">LIKE検索用にエスケープされた値を、<code class="docutils literal notranslate"><span class="pre">QueryDAO</span></code>のバインドパラメータに渡す。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="id26">
<h4><a class="toc-backref" href="#id94" role="doc-backlink"><span class="section-number">5.3.2.9.2. </span>一致方法をロジック側で指定する場合の使用方法</a><a class="headerlink" href="#id26" title="Permalink to this heading">¶</a></h4>
<p>一致方法(前方一致、後方一致、部分一致)をロジック側で判定する場合は、エスケープされた値にワイルドカードを付与するメソッドを使用する。</p>
<ul class="simple">
<li><p><code class="file docutils literal notranslate"><span class="pre">xxx-sqlmap.xml</span></code></p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span>//<span class="w"> </span>(1)
<span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;findAllByWord&quot;</span><span class="w"> </span><span class="na">parameterClass=</span><span class="s">&quot;String&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;resultMap_Article&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span>SELECT
<span class="w">      </span>*
<span class="w">  </span>FROM
<span class="w">      </span>article
<span class="w">  </span>WHERE
<span class="w">      </span>title<span class="w"> </span>LIKE<span class="w"> </span>#word#<span class="w"> </span>ESCAPE<span class="w"> </span>&#39;~&#39;
<span class="w">  </span>OR
<span class="w">      </span>overview<span class="w"> </span>LIKE<span class="w"> </span>#word#<span class="w"> </span>ESCAPE<span class="w"> </span>&#39;~&#39;
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">SQL内に、LIKE検索用のワイルドカードは、指定しない。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><p>Service or Repository</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="n">QueryDAO</span><span class="w"> </span><span class="n">queryDAO</span><span class="p">;</span>

<span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">Page</span><span class="o">&lt;</span><span class="n">Article</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">searchArticle</span><span class="p">(</span><span class="n">ArticleSearchCriteria</span><span class="w"> </span><span class="n">criteria</span><span class="p">,</span>
<span class="w">        </span><span class="n">Pageable</span><span class="w"> </span><span class="n">pageable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">escapedWord</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">QueryEscapeUtils</span>
<span class="w">            </span><span class="p">.</span><span class="na">toContainingCondition</span><span class="p">(</span><span class="n">criteria</span><span class="p">.</span><span class="na">getWord</span><span class="p">());</span><span class="w"> </span><span class="c1">// (2)</span>

<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queryDAO</span><span class="p">.</span><span class="na">executeForObject</span><span class="p">(</span><span class="s">&quot;article.countByWord&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">escapedWord</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Article</span><span class="o">&gt;</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">total</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">contents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queryDAO</span><span class="p">.</span><span class="na">executeForObjectList</span><span class="p">(</span><span class="s">&quot;article.findAllByWord&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">escapedWord</span><span class="p">,</span><span class="w"> </span><span class="n">pageable</span><span class="p">.</span><span class="na">getOffset</span><span class="p">(),</span><span class="w"> </span><span class="n">pageable</span><span class="p">.</span><span class="na">getPageSize</span><span class="p">());</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">contents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Collections</span><span class="p">.</span><span class="na">emptyList</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PageImpl</span><span class="o">&lt;</span><span class="n">Article</span><span class="o">&gt;</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span><span class="w"> </span><span class="n">pageable</span><span class="p">,</span><span class="w"> </span><span class="n">total</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ロジック側で一致方法を指定する場合は、  以下の何れかのメソッドを呼び出し、LIKE検索用のエスケープとLIKE検索用のワイルドカードを付与する。</div>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">QueryEscapeUtils#toStartingWithCondition(String)</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">QueryEscapeUtils#toEndingWithCondition(String)</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">QueryEscapeUtils#toContainingCondition(String)</span></code></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">LIKE検索用にエスケープ＋ワイルドカードが付与された値を、<code class="docutils literal notranslate"><span class="pre">QueryDAO</span></code>のバインドパラメータに渡す。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
</section>
<section id="sql-injection">
<h3><a class="toc-backref" href="#id95" role="doc-backlink"><span class="section-number">5.3.2.10. </span>SQL Injection対策について</a><a class="headerlink" href="#sql-injection" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">SQLを組み立てる際は、SQL Injectionが発生しないように、注意する必要がある。</div>
<div class="line">Mybatis2では、SQLに値を埋め込む仕組みを、2つ提供している。</div>
</div>
<ul>
<li><div class="line-block">
<div class="line">バインド変数を使って埋め込む方法。</div>
<div class="line">この方法を使用すると、 SQL組み立て後に<code class="docutils literal notranslate"><span class="pre">java.sql.PreparedStatement</span></code>を使用して、値が埋め込められるため、安全に値を埋め込むことができる。</div>
<div class="line"><strong>ユーザからの入力値をSQLに埋め込む場合は、原則バインド変数を使用すること。</strong></div>
</div>
</li>
<li><div class="line-block">
<div class="line">置換変数を使って埋め込む方法。</div>
<div class="line">この方法を使用すると、SQLを組み立てるタイミングで、文字列として置換されてしまうため、安全な値の埋め込みは、保証されない。</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>ユーザからの入力値を置換変数を使って埋め込むと、SQL Injectionが発生する危険性が高くなることを意識すること。
ユーザからの入力値を置換変数を使って埋め込む必要がある場合は、かならずSQL Injectionが発生しないことを保障するための、入力チェックを実施すること。</p>
<p>基本的には、 <strong>ユーザからの入力値はそのまま使わないことを強く推奨する。</strong></p>
</div>
</div></blockquote>
<section id="id27">
<h4><a class="toc-backref" href="#id96" role="doc-backlink"><span class="section-number">5.3.2.10.1. </span>バインド変数を使って埋め込む方法</a><a class="headerlink" href="#id27" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">バインド変数を使用する場合は、 ParameterMapまたはInline Parametersを使用する。</div>
<div class="line">以下に、使用例を示す。</div>
</div>
<p>ParameterMapの使用例を、以下に示す。</p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;parameterMap</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;uploadBinaryParameterMap&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;BinaryFile&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;parameter</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;fileId&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;parameter</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;fileName&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;parameter</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;content&quot;</span><span class="w"> </span><span class="na">jdbcType=</span><span class="s">&quot;BLOB&quot;</span><span class="w"> </span><span class="na">typeHandler=</span><span class="s">&quot;BlobInputStreamTypeHandler&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/parameterMap&gt;</span>

<span class="nt">&lt;insert</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;uploadBinary&quot;</span><span class="w"> </span><span class="na">parameterMap=</span><span class="s">&quot;uploadBinaryParameterMap&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span>INSERT<span class="w"> </span>INTO<span class="w"> </span>upload_binary
<span class="w">    </span>(
<span class="w">        </span>file_id
<span class="w">        </span>,file_name
<span class="w">        </span>,content
<span class="w">    </span>)
<span class="w">    </span>VALUES
<span class="w">    </span>(
<span class="w">        </span>?<span class="w">   </span>/*<span class="w"> </span>(2)<span class="w"> </span>*/
<span class="w">        </span>,?
<span class="w">        </span>,?
<span class="w">    </span>)
<span class="nt">&lt;/insert&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">バインド変数として値を埋め込むプロパティを定義する。定義した順番が、(2)で指定している<code class="docutils literal notranslate"><span class="pre">?</span></code>の位置に対応する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">SQLにバインド変数を指定する。(1)で定義した順番で、<code class="docutils literal notranslate"><span class="pre">?</span></code>の部分に、値がバインドされる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>Inline Parametersの使用例を、以下に示す。</p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;insert</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;insert&quot;</span>
<span class="w">        </span><span class="na">parameterClass=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model.Todo&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span>INSERT<span class="w"> </span>INTO<span class="w"> </span>todo
<span class="w">        </span>(
<span class="w">            </span>todo_id
<span class="w">            </span>,todo_title
<span class="w">            </span>,finished
<span class="w">            </span>,created_at
<span class="w">            </span>,version
<span class="w">        </span>)
<span class="w">        </span>values(
<span class="w">            </span>#todoId#<span class="w">       </span>/*<span class="w"> </span>(3)<span class="w"> </span>*/
<span class="w">            </span>,#todoTitle#
<span class="w">            </span>,#finished#
<span class="w">            </span>,#createdAt#
<span class="w">            </span>,1
<span class="w">        </span>)
<span class="nt">&lt;/insert&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">バインドする値が格納されているプロパティのプロパティ名を、<code class="docutils literal notranslate"><span class="pre">#</span></code>で囲み、バインド変数として指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="id28">
<h4><a class="toc-backref" href="#id97" role="doc-backlink"><span class="section-number">5.3.2.10.2. </span>置換変数を使って埋め込む方法</a><a class="headerlink" href="#id28" title="Permalink to this heading">¶</a></h4>
<p>バインド変数を使用する場合の使用例を、以下に示す。</p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;findByFinished&quot;</span>
<span class="w">        </span><span class="na">parameterClass=</span><span class="s">&quot;...&quot;</span>
<span class="w">        </span><span class="na">resultMap=</span><span class="s">&quot;resultMap_Todo&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span>SELECT
<span class="w">        </span>*
<span class="w">    </span>FROM
<span class="w">        </span>todo
<span class="w">    </span>WHERE
<span class="w">        </span>finished<span class="w"> </span>=<span class="w"> </span>#finished#
<span class="w">    </span>ORDER<span class="w"> </span>BY
<span class="w">        </span>created_at<span class="w"> </span>$direction$<span class="w">  </span>/*<span class="w"> </span>(4)<span class="w"> </span>*/
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">置換する値が格納されているプロパティのプロパティ名を<code class="docutils literal notranslate"><span class="pre">$</span></code>で囲み、置換変数として指定する。</div>
<div class="line">上記例では、<code class="docutils literal notranslate"><span class="pre">$direction$</span></code>の部分は、<code class="docutils literal notranslate"><span class="pre">&quot;DESC&quot;</span></code>または<code class="docutils literal notranslate"><span class="pre">&quot;ASC&quot;</span></code>で置換される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>置換変数による埋め込みは、必ずアプリケーションとして安全な値であることを担保した上で、テーブル名、カラム名、ソート条件などに限定して、使用することを推奨する。</p>
<p>例えば、以下のようにコード値と実際に使用する安全な値をペアでMapに格納し、</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">safeValueMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">safeValueMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ASC&quot;</span><span class="p">);</span>
<span class="n">safeValueMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;DESC&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
<p>実際の入力はコード値になるようにして、SQLを実行する処理中で変換することが望ましい。</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">String</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">safeValueMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="na">getDirection</span><span class="p">());</span>
</pre></div>
</div>
</div></blockquote>
<p><a class="reference internal" href="Codelist.html"><span class="doc">コードリスト</span></a>を使用しても良い。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
</section>
<section id="appendix">
<h2><a class="toc-backref" href="#id98" role="doc-backlink"><span class="section-number">5.3.3. </span>Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this heading">¶</a></h2>
<section id="id29">
<h3><a class="toc-backref" href="#id99" role="doc-backlink"><span class="section-number">5.3.3.1. </span>関連オブジェクトを１回のSQLでまとめて取得する実装例</a><a class="headerlink" href="#id29" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">テーブル毎にEntityのようなJavaBeanを用意して、データベースにアクセスする際に、関連オブジェクトを、1回のSQLでまとめて取得する方法について説明する。</div>
<div class="line">この方法は、N+1問題を回避する手段としても使用される。</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>以下の点に注意して、使用すること。</p>
<ul class="simple">
<li><p>本例では、使い方を説明するために、すべての関連オブジェクトを、1回のSQLでまとめて取得している。
しかしながら、実際のプロジェクトで使用する場合は、処理で必要となる関連オブジェクトのみ取得するようにすること。
なぜなら、使用しない関連オブジェクトを、同時に取得してしまった場合、性能劣化の原因となるケースがあるからである。</p></li>
<li><p>使用頻度の低い、1:Nの関係をもつ関連オブジェクトについては、まとめて取得しない。
必要なときに、個別に取得する方法を採用した方がよいケースがある。
性能要件を満たせる場合は、まとめて取得してもよい。</p></li>
<li><p>1:Nの関係となる関連オブジェクトが、多く含まれる場合、まとめて取得すると、マッピング処理に使用されない無駄なデータの取得が行われ、性能劣化の原因となるケースがある。
性能要件を満たせる場合は、まとめて取得してもよいが、他の方法を検討した方がよい。</p></li>
</ul>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>N+1問題の回避手段については、Mybatis Developer Guide(PDF)の「Result Maps/Avoiding N+1 Selects (1:1)」(P.37-38)及び「Result Maps/Avoiding N+1 Selects (1:M and M:N)」(P.39-40)を参照されたい。</p>
</div>
<div class="line-block">
<div class="line">以降では、注文テーブルを使って、具体的に実装例について説明する。</div>
<div class="line">説明で使用するテーブルは、以下の通りである。</div>
</div>
<blockquote>
<div><figure class="align-center" id="id35">
<a class="reference internal image-reference" href="../_images/dataaccess_er.png"><img alt="ER diagram" src="../_images/dataaccess_er.png" style="width: 90%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>Picture - ER diagram</strong></span><a class="headerlink" href="#id35" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 20%" />
<col style="width: 15%" />
<col style="width: 55%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>カテゴリ</p></th>
<th class="head"><p>テーブル名</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>トランザクション系</p></td>
<td><p>t_order</p></td>
<td><p>注文を保持するテーブル。１つの注文に対して、1レコードが格納される。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td></td>
<td><p>t_order_item</p></td>
<td><p>１つの注文で購入された商品を保持するテーブル。1つの注文で、複数の商品が購入された場合は、商品数分レコードが格納される。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td></td>
<td><p>t_order_coupon</p></td>
<td><p>１つの注文で使用されたクーポンを保持するテーブル。1つの注文で、複数のクーポンが使用された場合は、クーポン数分レコードが格納される。クーポンを使用しなかった場合は、レコードは格納されない。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p>マスタ系</p></td>
<td><p>m_item</p></td>
<td><p>商品を定義するマスタテーブル。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td></td>
<td><p>m_category</p></td>
<td><p>カテゴリを定義するマスタテーブル。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td></td>
<td><p>m_item_category</p></td>
<td><p>商品が所属するカテゴリを定義するマスタテーブル。商品とカテゴリのマッピングを保持している。1つの商品は、複数のカテゴリに属すことができるモデルとなっている。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td></td>
<td><p>m_coupon</p></td>
<td><p>クーポンを定義するマスタテーブル。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(8)</div>
</div>
</td>
<td><p>コード系</p></td>
<td><p>c_order_status</p></td>
<td><p>注文ステータスを定義するコードテーブル。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>トランザクション系テーブルのレイアウトと、格納されているレコードは、以下の通りである。</p>
<blockquote>
<div><p><strong>t_order</strong></p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>id(PK)</p></th>
<th class="head"><p>status_code</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>accepted</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>checking</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><p><strong>t_order_item</strong></p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>order_id(PK)</p></th>
<th class="head"><p>item_code(PK)</p></th>
<th class="head"><p>quantity</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>ITM0000001</p></td>
<td><p>10</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>ITM0000002</p></td>
<td><p>20</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>ITM0000001</p></td>
<td><p>30</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>ITM0000002</p></td>
<td><p>40</p></td>
</tr>
</tbody>
</table>
<p><strong>t_order_coupon</strong></p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>order_id(PK)</p></th>
<th class="head"><p>coupon_code(PK)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>CPN0000001</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>CPN0000002</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>マスタ系テーブルのレイアウトと、格納されているレコードは、以下の通りである。</p>
<blockquote>
<div><p><strong>m_item</strong></p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>code(PK)</p></th>
<th class="head"><p>name</p></th>
<th class="head"><p>price</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ITM0000001</p></td>
<td><p>Orange juice</p></td>
<td><p>100</p></td>
</tr>
<tr class="row-odd"><td><p>ITM0000002</p></td>
<td><p>NotePC</p></td>
<td><p>100000</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><p><strong>m_category</strong></p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>code(PK)</p></th>
<th class="head"><p>name</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>CTG0000001</p></td>
<td><p>Drink</p></td>
</tr>
<tr class="row-odd"><td><p>CTG0000002</p></td>
<td><p>PC</p></td>
</tr>
<tr class="row-even"><td><p>CTG0000003</p></td>
<td><p>Hot selling</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><p><strong>m_item_category</strong></p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>item_code(PK)</p></th>
<th class="head"><p>category_code(PK)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ITM0000001</p></td>
<td><p>CTG0000001</p></td>
</tr>
<tr class="row-odd"><td><p>ITM0000002</p></td>
<td><p>CTG0000002</p></td>
</tr>
<tr class="row-even"><td><p>ITM0000002</p></td>
<td><p>CTG0000003</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><p><strong>m_coupon</strong></p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>code(PK)</p></th>
<th class="head"><p>name</p></th>
<th class="head"><p>price</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>CPN0000001</p></td>
<td><p>Join coupon</p></td>
<td><p>3000</p></td>
</tr>
<tr class="row-odd"><td><p>CPN0000002</p></td>
<td><p>PC coupon</p></td>
<td><p>30000</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>コード系テーブルのレイアウトと、格納されているレコードは、以下の通りである。</p>
<blockquote>
<div><p><strong>c_order_status</strong></p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>code(PK)</p></th>
<th class="head"><p>name</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>accepted</p></td>
<td><p>Order accepted</p></td>
</tr>
<tr class="row-odd"><td><p>checking</p></td>
<td><p>Stock checking</p></td>
</tr>
<tr class="row-even"><td><p>shipped</p></td>
<td><p>Item Shipped</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>以降で説明する実装例では、上記テーブルに格納されているデータを、以下のJavaBeanにマッピングして、取得する。</p>
<blockquote>
<div><figure class="align-center" id="id36">
<a class="reference internal image-reference" href="../_images/dataaccess_entity.png"><img alt="Class(JavaBean) diagram" src="../_images/dataaccess_entity.png" style="width: 90%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>Picture - Class(JavaBean) diagram</strong></span><a class="headerlink" href="#id36" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 17%" />
<col style="width: 72%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>クラス名</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>Order</p></td>
<td><p>t_orderテーブルの1レコードを表現するJavaBean。 関連オブジェクトとして、<code class="docutils literal notranslate"><span class="pre">OrderStatus</span></code>と<code class="docutils literal notranslate"><span class="pre">OrderItem</span></code>および<code class="docutils literal notranslate"><span class="pre">OrderCoupon</span></code>を複数保持する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p>OrderItem</p></td>
<td><p>t_order_itemテーブルの1レコードを表現するJavaBean。 関連オブジェクトとして、<code class="docutils literal notranslate"><span class="pre">Item</span></code>を保持する。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p>OrderCoupon</p></td>
<td><p>t_order_couponテーブルの1コードを表現するJavaBean。関連オブジェクトとして、<code class="docutils literal notranslate"><span class="pre">Coupon</span></code>を保持する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p>Item</p></td>
<td><p>m_itemテーブルの1コードを表現するJavaBean。 関連オブジェクトとして、所属している<code class="docutils literal notranslate"><span class="pre">Category</span></code>を複数保持する。<code class="docutils literal notranslate"><span class="pre">Item</span></code>と<code class="docutils literal notranslate"><span class="pre">Category</span></code>の紐づけは、m_item_categoryテーブルによって行われる。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><p>Category</p></td>
<td><p>m_categoryテーブルの1レコードを表現するJavaBean。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><p>Coupon</p></td>
<td><p>m_couponテーブルの1レコードを表現するJavaBean。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><p>OrderStatus</p></td>
<td><p>c_order_statusテーブルの1レコードを表現するJavaBean。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>JavaBeanのプロパティ定義は、以下の通りである。</p>
<ul class="simple">
<li><p>Order.java</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Order</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Serializable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">OrderItem</span><span class="o">&gt;</span><span class="w"> </span><span class="n">orderItems</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">OrderCoupon</span><span class="o">&gt;</span><span class="w"> </span><span class="n">orderCoupons</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">OrderStatus</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>OrderItem.java</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OrderItem</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Serializable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">orderId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">itemCode</span><span class="p">;</span><span class="w"> </span><span class="c1">// &lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Item</span><span class="w"> </span><span class="n">item</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">quantity</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>保持する値が、直後の変数<code class="docutils literal notranslate"><span class="pre">item</span></code>の<code class="docutils literal notranslate"><span class="pre">code</span></code>プロパティと重複する。これは、後述するresultMap要素の、groupBy属性によるレコードの、グルーピングを行う際に必要になるため、定義している。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><p>OrderCoupon.java</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OrderCoupon</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Serializable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">orderId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">couponCode</span><span class="p">;</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Coupon</span><span class="w"> </span><span class="n">coupon</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>保持する値が、直後の変数<code class="docutils literal notranslate"><span class="pre">Coupon</span></code>の<code class="docutils literal notranslate"><span class="pre">code</span></code>プロパティと重複する。これは、後述するresultMap要素の、groupBy属性によるレコードの、グルーピングを行う際に必要になるため、定義している。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><p>Item.java</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Item</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Serializable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">code</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">price</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span><span class="w"> </span><span class="n">categories</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>Category.java</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Category</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Serializable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">code</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>Coupon.java</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Coupon</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Serializable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">code</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">price</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>OrderStatus.java</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OrderStatus</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Serializable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">code</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">SQLマッピングを実装する。</div>
<div class="line">関連するオブジェクトを、1回のSQLでまとめて取得する場合、取得したいテーブルをJOINして、マッピングに必要なすべてのレコードを取得する。</div>
<div class="line">取得したレコードは、resultMap要素にマッピング定義を行い、JavaBeanにマッピングする。</div>
</div>
<div class="line-block">
<div class="line">以下では、1件のOrderを取得するSQL(findOne)と、すべてのOrderを取得するSQL(findAll)の実装例となっている。</div>
<div class="line">なお、以下の実装例では、ネームスペースに<code class="docutils literal notranslate"><span class="pre">&quot;order&quot;</span></code>を指定し、 マッピングするJavaBeanは、typeAliasを使って、パッケージ名を除いたクラス名が定義してある前提となっている。</div>
</div>
<ul class="simple">
<li><p>sqlMapConfig.xml</p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;typeAlias</span><span class="w"> </span><span class="na">alias=</span><span class="s">&quot;Order&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model.Order&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;typeAlias</span><span class="w"> </span><span class="na">alias=</span><span class="s">&quot;OrderStatus&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model.OrderStatus&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;typeAlias</span><span class="w"> </span><span class="na">alias=</span><span class="s">&quot;OrderItem&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model.OrderItem&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;typeAlias</span><span class="w"> </span><span class="na">alias=</span><span class="s">&quot;OrderCoupon&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model.OrderCoupon&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;typeAlias</span><span class="w"> </span><span class="na">alias=</span><span class="s">&quot;Item&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model.Item&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;typeAlias</span><span class="w"> </span><span class="na">alias=</span><span class="s">&quot;Category&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model.Category&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;typeAlias</span><span class="w"> </span><span class="na">alias=</span><span class="s">&quot;Coupon&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model.Coupon&quot;</span><span class="nt">/&gt;</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>order-sqlmap.xml</p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sqlMap</span><span class="w"> </span><span class="na">namespace=</span><span class="s">&quot;order&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- ... --&gt;</span>

<span class="nt">&lt;/sqlMap&gt;</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">まず、SQLについて説明する。</div>
<div class="line">実際の定義は、resultMap要素の後に、定義すること。</div>
</div>
<p>SQLの実装</p>
<ul class="simple">
<li><p>findOne/findAll共通部分のSQL定義(sql要素)</p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sql</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;fragment_selectFormJoin&quot;</span><span class="nt">&gt;</span><span class="w">         </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span>SELECT<span class="w">                                   </span>/*<span class="w"> </span>(2)<span class="w"> </span>*/
<span class="w">        </span>o.id
<span class="w">        </span>,os.code<span class="w"> </span>AS<span class="w"> </span>status_code
<span class="w">        </span>,os.name<span class="w"> </span>AS<span class="w"> </span>status_name
<span class="w">        </span>,ol.quantity
<span class="w">        </span>,i.code<span class="w"> </span>AS<span class="w"> </span>item_code
<span class="w">        </span>,i.name<span class="w"> </span>AS<span class="w"> </span>item_name
<span class="w">        </span>,i.price<span class="w"> </span>AS<span class="w"> </span>item_price
<span class="w">        </span>,ct.code<span class="w"> </span>AS<span class="w"> </span>category_code
<span class="w">        </span>,ct.name<span class="w"> </span>AS<span class="w"> </span>category_name
<span class="w">        </span>,cp.code<span class="w"> </span>AS<span class="w"> </span>coupon_code
<span class="w">        </span>,cp.name<span class="w"> </span>AS<span class="w"> </span>coupon_name
<span class="w">        </span>,cp.price<span class="w"> </span>AS<span class="w"> </span>coupon_price
<span class="w">    </span>FROM
<span class="w">        </span>t_order<span class="w"> </span>o
<span class="w">    </span>INNER<span class="w"> </span>JOIN<span class="w">                                </span>/*<span class="w"> </span>(3)<span class="w"> </span>*/
<span class="w">        </span>c_order_status<span class="w"> </span>os
<span class="w">            </span>ON<span class="w"> </span>os.code<span class="w"> </span>=<span class="w"> </span>o.status_code
<span class="w">    </span>INNER<span class="w"> </span>JOIN
<span class="w">        </span>t_orderline<span class="w"> </span>ol
<span class="w">            </span>ON<span class="w"> </span>ol.order_id<span class="w"> </span>=<span class="w"> </span>o.id
<span class="w">    </span>INNER<span class="w"> </span>JOIN
<span class="w">        </span>m_item<span class="w"> </span>i
<span class="w">            </span>ON<span class="w"> </span>i.code<span class="w"> </span>=<span class="w"> </span>ol.item_code
<span class="w">    </span>INNER<span class="w"> </span>JOIN
<span class="w">        </span>m_item_category<span class="w"> </span>ic
<span class="w">            </span>ON<span class="w"> </span>ic.item_code<span class="w"> </span>=<span class="w"> </span>i.code
<span class="w">    </span>INNER<span class="w"> </span>JOIN
<span class="w">        </span>m_category<span class="w"> </span>ct
<span class="w">            </span>ON<span class="w"> </span>ct.code<span class="w"> </span>=<span class="w"> </span>ic.category_code
<span class="w">    </span>LEFT<span class="w"> </span>JOIN<span class="w">                                  </span>/*<span class="w"> </span>(4)<span class="w"> </span>*/
<span class="w">        </span>t_order_coupon<span class="w"> </span>oc
<span class="w">            </span>ON<span class="w"> </span>oc.order_id<span class="w"> </span>=<span class="w"> </span>o.id
<span class="w">    </span>LEFT<span class="w"> </span>JOIN
<span class="w">        </span>m_coupon<span class="w"> </span>cp
<span class="w">            </span>ON<span class="w"> </span>cp.code<span class="w"> </span>=<span class="w"> </span>oc.coupon_code
<span class="nt">&lt;/sql&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>findOneと、findAllでSELECT句、FROM句、JOIN句を共有するためのsql要素。findOneとfindAllで、多くの共通部分があったので共通化している。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p>関連オブジェクトを生成するために、必要なデータをすべて取得する。カラム名は、重複しないようにする必要がある。上記例では、<code class="docutils literal notranslate"><span class="pre">code</span></code>, <code class="docutils literal notranslate"><span class="pre">name</span></code>, <code class="docutils literal notranslate"><span class="pre">price</span></code>が重複するため、AS句で別名を指定している。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p>関連オブジェクトを生成するために、必要なデータが格納されているテーブルを結合する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p>データが格納されない可能性のあるテーブルについては、外部結合とする。クーポンを使用しない場合、t_group_couponにレコードが格納されないので外部結合にする必要がある。t_group_couponと結合するt_couponも同様である。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><p>findOneのSQL定義</p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;findOne&quot;</span><span class="w"> </span><span class="na">parameterClass=</span><span class="s">&quot;java.lang.Integer&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;orderResultMap&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;include</span><span class="w"> </span><span class="na">refid=</span><span class="s">&quot;fragment_selectFormJoin&quot;</span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span>WHERE
<span class="w">        </span>o.id<span class="w"> </span>=<span class="w"> </span>#id#<span class="w">         </span>/*<span class="w"> </span>(3)<span class="w"> </span>*/
<span class="w">    </span>ORDER<span class="w"> </span>BY<span class="w">                </span>/*<span class="w"> </span>(4)<span class="w"> </span>*/
<span class="w">        </span>item_code<span class="w"> </span>ASC<span class="w">       </span>/*<span class="w"> </span>(5)<span class="w"> </span>*/
<span class="w">        </span>,category_code<span class="w"> </span>ASC<span class="w">  </span>/*<span class="w"> </span>(6)<span class="w"> </span>*/
<span class="w">        </span>,coupon_code<span class="w"> </span>ASC<span class="w">    </span>/*<span class="w"> </span>(7)<span class="w"> </span>*/
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>指定された注文IDの、<code class="docutils literal notranslate"><span class="pre">Order</span></code>オブジェクトおよび関連オブジェクトを取得するためのSQL。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p>findAllと共有するSELECT句、FROM句、JOIN句が実装されたSQLを、インクルードしている。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p>バインド値で渡された注文IDを、WHERE句に指定する。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p>1:Nの関係の関連オブジェクトがある場合は、リスト内の並び順を制御するための、ORDER BY句を指定する。並び順を意識する必要がない場合は、指定は不要である。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">Order#orderItems</span></code>のリストを、t_itemテーブルのcodeカラムの昇順にするための指定。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">Item#categories</span></code>のリストを、t_categoryテーブルのcodeカラムの昇順にするための指定。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">Order#orderCoupons</span></code>のリストを、t_couponのcodeの昇順にするための指定。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><p>findAllのSQL定義</p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;findAll&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;orderResultMap&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;include</span><span class="w"> </span><span class="na">refid=</span><span class="s">&quot;fragment_selectFormJoin&quot;</span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span>ORDER<span class="w"> </span>BY
<span class="w">        </span>o.id<span class="w"> </span>DESC<span class="w">     </span>/*<span class="w"> </span>(3)<span class="w"> </span>*/
<span class="w">        </span>,i.code<span class="w"> </span>ASC
<span class="w">        </span>,ct.code<span class="w"> </span>ASC
<span class="w">        </span>,cp.code<span class="w"> </span>ASC
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>すべてのOrder、および、関連オブジェクトを取得するためのSQL。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p>findOneとfindAllでSELECT句、FROM句、JOIN句を共有するためのsql要素。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p>取得されるリストの並び順を、t_orderのidの降順にするための指定。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line">上記SQL(findAll)を実行した結果、以下のレコードが取得される。</div>
<div class="line">注文レコードとしては2件だが、レコードが複数件格納される関連テーブルと結合しているため、合計で9レコードが取得される。</div>
<div class="line">1～3行目は、注文IDが<code class="docutils literal notranslate"><span class="pre">2</span></code>の <code class="docutils literal notranslate"><span class="pre">Order</span></code>オブジェクトを生成するためのレコード、4～9行目は注文IDが<code class="docutils literal notranslate"><span class="pre">1</span></code>の <code class="docutils literal notranslate"><span class="pre">Order</span></code>オブジェクトを生成するためのレコードとなる。</div>
</div>
<blockquote>
<div><figure class="align-center" id="id37">
<a class="reference internal image-reference" href="../_images/dataaccess_sql_result.png"><img alt="Result Set of findAll" src="../_images/dataaccess_sql_result.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>Picture - Result Set of findAll</strong></span><a class="headerlink" href="#id37" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>上記レコードを、<code class="docutils literal notranslate"><span class="pre">Order</span></code>オブジェクト、および、関連オブジェクトにマッピングする方法について説明する。</p>
<div class="line-block">
<div class="line">resultMap要素の実装</div>
<div class="line">それぞれの説明については、後述する。</div>
</div>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;resultMap</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;orderResultMap&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;Order&quot;</span><span class="w"> </span><span class="na">groupBy=</span><span class="s">&quot;id&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;id&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;status&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;order.orderStatusResultMap&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;orderItems&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;order.orderItemResultMap&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;orderCoupons&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;order.orderCouponResultMap&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>

<span class="nt">&lt;resultMap</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;orderStatusResultMap&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;OrderStatus&quot;</span><span class="w"> </span><span class="na">groupBy=</span><span class="s">&quot;code&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;code&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;status_code&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;status_name&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>

<span class="nt">&lt;resultMap</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;orderItemResultMap&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;OrderItem&quot;</span><span class="w"> </span><span class="na">groupBy=</span><span class="s">&quot;itemCode&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;itemCode&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;item&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;order.itemResultMap&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;quantity&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;quantity&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>

<span class="nt">&lt;resultMap</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;itemResultMap&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;Item&quot;</span><span class="w"> </span><span class="na">groupBy=</span><span class="s">&quot;code&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;code&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;item_name&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;price&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;item_price&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;categories&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;order.categoryResultMap&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>

<span class="nt">&lt;resultMap</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;categoryResultMap&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;Category&quot;</span><span class="w"> </span><span class="na">groupBy=</span><span class="s">&quot;code&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;code&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;category_code&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;category_name&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>

<span class="nt">&lt;resultMap</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;orderCouponResultMap&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;OrderCoupon&quot;</span><span class="w"> </span><span class="na">groupBy=</span><span class="s">&quot;couponCode&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;couponCode&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;coupon_code&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;coupon&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;order.couponResultMap&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>

<span class="nt">&lt;resultMap</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;couponResultMap&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;Coupon&quot;</span><span class="w"> </span><span class="na">groupBy=</span><span class="s">&quot;code&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;code&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;coupon_code&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;coupon_name&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;price&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;coupon_price&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>各resultMap要素の役割と依存関係を、以下に示す。</p>
<blockquote>
<div><figure class="align-center" id="id38">
<a class="reference internal image-reference" href="../_images/dataaccess_resultmap.png"><img alt="Implementation of ResultMap" src="../_images/dataaccess_resultmap.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>Picture - Implementation of ResultMap</strong></span><a class="headerlink" href="#id38" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得したレコードを<code class="docutils literal notranslate"><span class="pre">Order</span></code>オブジェクトにマッピングするための定義。</div>
<div class="line">関連オブジェクト(<code class="docutils literal notranslate"><span class="pre">OrderStatus</span></code>, <code class="docutils literal notranslate"><span class="pre">OrderItem</span></code>, <code class="docutils literal notranslate"><span class="pre">OrderCoupon</span></code>)のマッピングは、別のresultMapに委譲している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得したレコードを、<code class="docutils literal notranslate"><span class="pre">OrderStatus</span></code>オブジェクトにマッピングするための定義。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得したレコードを、<code class="docutils literal notranslate"><span class="pre">OrderItem</span></code>オブジェクトにマッピングするための定義。</div>
<div class="line">関連オブジェクト(<code class="docutils literal notranslate"><span class="pre">Item</span></code>)のマッピングは別のresultMapに委譲している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得したレコードを、<code class="docutils literal notranslate"><span class="pre">Item</span></code>オブジェクトにマッピングするための定義。</div>
<div class="line">関連オブジェクト(<code class="docutils literal notranslate"><span class="pre">Category</span></code>)のマッピングは、別のresultMapに委譲している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得したレコードを、<code class="docutils literal notranslate"><span class="pre">Category</span></code>オブジェクトにマッピングするための定義。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得したレコードを、<code class="docutils literal notranslate"><span class="pre">OrderCoupon</span></code>オブジェクトにマッピングするための定義。</div>
<div class="line">関連オブジェクト(<code class="docutils literal notranslate"><span class="pre">Coupon</span></code>)のマッピングは、別のresultMapに委譲している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得したレコードを、<code class="docutils literal notranslate"><span class="pre">Coupon</span></code>オブジェクトにマッピングするための定義。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">Order</span></code>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;resultMap</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;orderResultMap&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;Order&quot;</span><span class="w"> </span><span class="na">groupBy=</span><span class="s">&quot;id&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;id&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;status&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;order.orderStatusResultMap&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;orderItems&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;order.orderItemResultMap&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (4) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;orderCoupons&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;order.orderCouponResultMap&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (5) --&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<figure class="align-center" id="id39">
<a class="reference internal image-reference" href="../_images/dataaccess_resultmap_order.png"><img alt="ResultMap for Order" src="../_images/dataaccess_resultmap_order.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>Picture - ResultMap for Order</strong></span><a class="headerlink" href="#id39" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得したレコードは、注文毎にグループ化する必要があるため、注文を一意に識別するための値が格納されている<code class="docutils literal notranslate"><span class="pre">id</span></code>プロパティを、groupBy属性に指定する。</div>
<div class="line">本例では、<code class="docutils literal notranslate"><span class="pre">id</span></code>プロパティでグループ化されるため、<code class="docutils literal notranslate"><span class="pre">id=1</span></code>と<code class="docutils literal notranslate"><span class="pre">id=2</span></code>の２つの<code class="docutils literal notranslate"><span class="pre">Order</span></code>オブジェクトが、生成される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得したレコードの<code class="docutils literal notranslate"><span class="pre">id</span></code>カラムの値を、<code class="docutils literal notranslate"><span class="pre">Order#id</span></code>に設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">OrderStatus</span></code>オブジェクトの生成を、<code class="docutils literal notranslate"><span class="pre">id=&quot;order.orderStatusResultMap&quot;</span></code>のresultMapに委譲し、生成されたオブジェクトを、<code class="docutils literal notranslate"><span class="pre">Order#status</span></code>に設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">OrderItem</span></code>オブジェクトの生成を、<code class="docutils literal notranslate"><span class="pre">id=&quot;order.orderItemResultMap&quot;</span></code>のresultMapに委譲し、生成されたオブジェクトを、<code class="docutils literal notranslate"><span class="pre">Order#orderItems</span></code>のリストに追加する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">OrderCoupon</span></code>オブジェクトの生成を、<code class="docutils literal notranslate"><span class="pre">id=&quot;order.orderCouponResultMap&quot;</span></code>のresultMapに委譲し、生成されたオブジェクトを、<code class="docutils literal notranslate"><span class="pre">Order#orderCoupons</span></code>のリストに追加する。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>以降では、<code class="docutils literal notranslate"><span class="pre">id=1</span></code>の<code class="docutils literal notranslate"><span class="pre">Order</span></code>オブジェクトへのマッピングに、焦点を当てて説明する。</p>
<p><code class="docutils literal notranslate"><span class="pre">OrderStatus</span></code>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;resultMap</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;orderStatusResultMap&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;OrderStatus&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;code&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;status_code&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;status_name&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<figure class="align-center" id="id40">
<a class="reference internal image-reference" href="../_images/dataaccess_resultmap_orderstatus.png"><img alt="ResultMap for OrderStatus" src="../_images/dataaccess_resultmap_orderstatus.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>Picture - ResultMap for OrderStatus</strong></span><a class="headerlink" href="#id40" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"> <code class="docutils literal notranslate"><span class="pre">Order</span></code>と、<code class="docutils literal notranslate"><span class="pre">OrderStatus</span></code>オブジェクトは、1:1の関係なので、groupBy属性の指定は不要である。</div>
<div class="line">本例では、<code class="docutils literal notranslate"><span class="pre">code=accepted</span></code>の<code class="docutils literal notranslate"><span class="pre">OrderStatus</span></code>オブジェクトが生成される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得したレコードの、<code class="docutils literal notranslate"><span class="pre">status_code</span></code>カラムの値を、<code class="docutils literal notranslate"><span class="pre">OrderStatus#code</span></code>に設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得したレコードの、<code class="docutils literal notranslate"><span class="pre">status_name</span></code>カラムの値を、<code class="docutils literal notranslate"><span class="pre">OrderStatus#name</span></code>に設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">OrderItem</span></code>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;resultMap</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;orderItemResultMap&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;OrderItem&quot;</span><span class="w"> </span><span class="na">groupBy=</span><span class="s">&quot;itemCode&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;itemCode&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;item&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;order.itemResultMap&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;quantity&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;quantity&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<figure class="align-center" id="id41">
<a class="reference internal image-reference" href="../_images/dataaccess_resultmap_orderitem.png"><img alt="ResultMap for OrderItem" src="../_images/dataaccess_resultmap_orderitem.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>Picture - ResultMap for OrderItem</strong></span><a class="headerlink" href="#id41" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">Order</span></code>と<code class="docutils literal notranslate"><span class="pre">OrderItem</span></code>は、1:Nの関係なので、groupBy属性の指定が必要である。</div>
<div class="line">注文商品は、t_order_itemのプライマリキー(order_id,item_code)でグループ化する必要があるが、order_idカラムについては、親のresultMapで指定されているため、ここでは、item_codeカラムの値を保持する<code class="docutils literal notranslate"><span class="pre">itemCode</span></code>プロパティのみ指定する。</div>
<div class="line">本例では、<code class="docutils literal notranslate"><span class="pre">itemCode</span></code>プロパティでグループ化されるため、<code class="docutils literal notranslate"><span class="pre">itemCode=ITM0000001</span></code>と<code class="docutils literal notranslate"><span class="pre">itemCode=ITM0000002</span></code>の、２つの<code class="docutils literal notranslate"><span class="pre">OrderItem</span></code>オブジェクトが生成される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得したレコードの<code class="docutils literal notranslate"><span class="pre">item_code</span></code>カラムの値を、<code class="docutils literal notranslate"><span class="pre">OrderItem#itemCode</span></code>に設定する。</div>
<div class="line">(3)で生成される<code class="docutils literal notranslate"><span class="pre">Item#code</span></code>と重複するが、<code class="docutils literal notranslate"><span class="pre">itemCode</span></code>プロパティは、<code class="docutils literal notranslate"><span class="pre">OrderItem</span></code>をグループ化するために必要なプロパティとなる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">Item</span></code>オブジェクトの生成を、<code class="docutils literal notranslate"><span class="pre">id=&quot;order.itemResultMap&quot;</span></code>のresultMapに委譲し、生成されたオブジェクトを<code class="docutils literal notranslate"><span class="pre">OrderItem#item</span></code>に設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得したレコードの<code class="docutils literal notranslate"><span class="pre">quantity</span></code>カラムの値を、<code class="docutils literal notranslate"><span class="pre">OrderItem#quantity</span></code>に設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">Item</span></code>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;resultMap</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;itemResultMap&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;Item&quot;</span><span class="w"> </span><span class="na">groupBy=</span><span class="s">&quot;code&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;code&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;item_name&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;price&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;item_price&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (4) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;categories&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;order.categoryResultMap&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (5) --&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<figure class="align-center" id="id42">
<a class="reference internal image-reference" href="../_images/dataaccess_resultmap_item.png"><img alt="ResultMap for Item" src="../_images/dataaccess_resultmap_item.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>Picture - ResultMap for Item</strong></span><a class="headerlink" href="#id42" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"> <code class="docutils literal notranslate"><span class="pre">OrderItem</span></code>と<code class="docutils literal notranslate"><span class="pre">Item</span></code>オブジェクトは、1:1の関係だが、<code class="docutils literal notranslate"><span class="pre">Item</span></code>と<code class="docutils literal notranslate"><span class="pre">Category</span></code>は、1:Nの関係なので、groupBy属性の指定が必要である。</div>
<div class="line">カテゴリは商品毎にグループ化する必要があるため、商品を一意に識別するための値が格納されている<code class="docutils literal notranslate"><span class="pre">code</span></code>プロパティを、groupBy属性に指定する。</div>
<div class="line">本例では、<code class="docutils literal notranslate"><span class="pre">OrderItem#itemCode=ITM0000001</span></code>用に、 <code class="docutils literal notranslate"><span class="pre">code=ITM0000001</span></code>の<code class="docutils literal notranslate"><span class="pre">Item</span></code>オブジェクトが、<code class="docutils literal notranslate"><span class="pre">OrderItem#itemCode=ITM0000002</span></code>用に、<code class="docutils literal notranslate"><span class="pre">code=ITM0000002</span></code>の<code class="docutils literal notranslate"><span class="pre">Item</span></code>オブジェクトが生成される。(計２つのオブジェクトが生成される。)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得したレコードの<code class="docutils literal notranslate"><span class="pre">item_code</span></code>カラムの値を、<code class="docutils literal notranslate"><span class="pre">Item#code</span></code>に設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得したレコードの<code class="docutils literal notranslate"><span class="pre">item_name</span></code>カラムの値を、<code class="docutils literal notranslate"><span class="pre">Item#name</span></code>に設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得したレコードの<code class="docutils literal notranslate"><span class="pre">item_price</span></code>カラムの値を、<code class="docutils literal notranslate"><span class="pre">Item#price</span></code>に設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">Category</span></code>オブジェクトの生成を、<code class="docutils literal notranslate"><span class="pre">id=&quot;order.categoryResultMap&quot;</span></code>のresultMapに委譲し、生成されたオブジェクトを <code class="docutils literal notranslate"><span class="pre">Item#categories</span></code> のリストに追加する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">Category</span></code>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;resultMap</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;categoryResultMap&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;Category&quot;</span><span class="w"> </span><span class="na">groupBy=</span><span class="s">&quot;code&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;code&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;category_code&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;category_name&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<figure class="align-center" id="id43">
<a class="reference internal image-reference" href="../_images/dataaccess_resultmap_category.png"><img alt="ResultMap for Item" src="../_images/dataaccess_resultmap_category.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>Picture - ResultMap for Item</strong></span><a class="headerlink" href="#id43" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">本例では、1:Nの関係のテーブル(t_orderとt_order_line、t_orderとt_order_coupon)を複数結合しているため、 t_order_couponに複数レコードが格納されていると <code class="docutils literal notranslate"><span class="pre">Item</span></code>オブジェクト内に保持する<code class="docutils literal notranslate"><span class="pre">Category</span></code>オブジェクトのリストが、重複してしまう。</div>
<div class="line">重複をなくすために、カテゴリを一意に識別するための値が格納されている<code class="docutils literal notranslate"><span class="pre">code</span></code>プロパティを、groupBy属性に指定する。<code class="docutils literal notranslate"><span class="pre">code</span></code>プロパティの値が、同じ<code class="docutils literal notranslate"><span class="pre">Category</span></code>オブジェクトが一つにマージされ、重複をなくすことができる。</div>
<div class="line">本例では、<code class="docutils literal notranslate"><span class="pre">Item#code=ITM0000001</span></code>用に、<code class="docutils literal notranslate"><span class="pre">code=CTG0000001</span></code>の<code class="docutils literal notranslate"><span class="pre">Category</span></code>オブジェクトが、<code class="docutils literal notranslate"><span class="pre">Item#code=ITM0000002</span></code>用に、<code class="docutils literal notranslate"><span class="pre">code=CTG0000002</span></code>と、<code class="docutils literal notranslate"><span class="pre">code=CTG0000003</span></code>の2つの<code class="docutils literal notranslate"><span class="pre">Category</span></code>オブジェクトが生成される。(計3つのオブジェクトが生成される。)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得したレコードの <code class="docutils literal notranslate"><span class="pre">item_code</span></code>カラムの値を、<code class="docutils literal notranslate"><span class="pre">Item#code</span></code>に設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得したレコードの <code class="docutils literal notranslate"><span class="pre">item_name</span></code>カラムの値を、<code class="docutils literal notranslate"><span class="pre">Item#name</span></code>に設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">OrderCoupon</span></code>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;resultMap</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;orderCouponResultMap&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;OrderCoupon&quot;</span><span class="w"> </span><span class="na">groupBy=</span><span class="s">&quot;couponCode&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;couponCode&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;coupon_code&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;coupon&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;order.couponResultMap&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<figure class="align-center" id="id44">
<a class="reference internal image-reference" href="../_images/dataaccess_resultmap_ordercoupon.png"><img alt="ResultMap for OrderCoupon" src="../_images/dataaccess_resultmap_ordercoupon.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>Picture - ResultMap for OrderCoupon</strong></span><a class="headerlink" href="#id44" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"> <code class="docutils literal notranslate"><span class="pre">Order</span></code>と<code class="docutils literal notranslate"><span class="pre">OrderCoupon</span></code>は、1:Nの関係なので、groupBy属性の指定が必要である。</div>
<div class="line">注文クーポンは、t_order_couponのプライマリキー(order_id,coupon_code)でグループ化する必要があるが、order_idカラムについては親のresultMapで指定されているため、ここでは、coupon_codeカラムの値を保持する<code class="docutils literal notranslate"><span class="pre">couponCode</span></code>プロパティのみ指定する。</div>
<div class="line">本例では、<code class="docutils literal notranslate"><span class="pre">couponCode</span></code>プロパティでグループ化されるため、<code class="docutils literal notranslate"><span class="pre">couponCode=CPN0000001</span></code>と<code class="docutils literal notranslate"><span class="pre">couponCode=CPN0000002</span></code> 、の2つの <code class="docutils literal notranslate"><span class="pre">OrderCoupon</span></code>オブジェクトが生成される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得したレコードの<code class="docutils literal notranslate"><span class="pre">coupon_code</span></code>カラムの値を、<code class="docutils literal notranslate"><span class="pre">OrderCoupon#couponCode</span></code>に設定する。</div>
<div class="line">(3)で生成される<code class="docutils literal notranslate"><span class="pre">Coupon#code</span></code>と重複するが、<code class="docutils literal notranslate"><span class="pre">couponCode</span></code>プロパティは、<code class="docutils literal notranslate"><span class="pre">OrderCoupon</span></code>をグループ化するために必要なプロパティとなる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">Coupon</span></code>オブジェクトの生成を<code class="docutils literal notranslate"><span class="pre">id=&quot;order.couponResultMap&quot;</span></code>のresultMapに委譲し、生成されたオブジェクトを<code class="docutils literal notranslate"><span class="pre">OrderCoupon#coupon</span></code>に設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">Coupon</span></code>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;resultMap</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;couponResultMap&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;Coupon&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;code&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;coupon_code&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;coupon_name&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;price&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;coupon_price&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<figure class="align-center" id="id45">
<a class="reference internal image-reference" href="../_images/dataaccess_resultmap_coupon.png"><img alt="ResultMap for Coupon" src="../_images/dataaccess_resultmap_coupon.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>Picture - ResultMap for Coupon</strong></span><a class="headerlink" href="#id45" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">OrderCoupon</span></code>と<code class="docutils literal notranslate"><span class="pre">Coupon</span></code>オブジェクトは、1:1の関係なので、groupBy属性の指定が不要である。</div>
<div class="line">本例では、<code class="docutils literal notranslate"><span class="pre">OrderCoupon#couponCode=CPN0000001</span></code>用に、<code class="docutils literal notranslate"><span class="pre">code=CPN0000001</span></code>の<code class="docutils literal notranslate"><span class="pre">Coupon</span></code>オブジェクトが、<code class="docutils literal notranslate"><span class="pre">OrderCoupon#couponCode=CPN0000001</span></code>用に、<code class="docutils literal notranslate"><span class="pre">code=CPN0000001</span></code>の<code class="docutils literal notranslate"><span class="pre">Coupon</span></code>オブジェクトが生成される。(計２つのオブジェクトが生成される。)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得したレコードの<code class="docutils literal notranslate"><span class="pre">coupon_code</span></code>カラムの値を、<code class="docutils literal notranslate"><span class="pre">Coupon#code</span></code>に設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得したレコードの<code class="docutils literal notranslate"><span class="pre">coupon_name</span></code>カラムの値を、<code class="docutils literal notranslate"><span class="pre">Coupon#name</span></code>に設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得したレコードの<code class="docutils literal notranslate"><span class="pre">coupon_price</span></code>カラムの値を、<code class="docutils literal notranslate"><span class="pre">Coupon#price</span></code>に設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line">JavaBeanにマッピングされたレコードとカラムは、以下の通りである。</div>
<div class="line">グレーアウトしている部分は、groupBy属性に指定によって、グレーアウトされていない部分にマージされる。</div>
</div>
<blockquote>
<div><figure class="align-center" id="id46">
<a class="reference internal image-reference" href="../_images/dataaccess_sql_result_used.png"><img alt="Valid Result Set for result mapping" src="../_images/dataaccess_sql_result_used.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>Picture - Valid Result Set for result mapping</strong></span><a class="headerlink" href="#id46" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</div></blockquote>
<blockquote id="data-access-mybatis2-warning-sqlmapping-bulk">
<div><div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>1:Nの関連をもつレコードをJOINしてマッピングする場合、グレーアウトされている部分のデータの取得が無駄になる点を、意識しておくこと。</p>
<p>Nの部分のデータを使用しない処理で、同じSQLを使用した場合、さらに無駄なデータの取得となってしまうので、Nの部分を取得するSQLと、取得しないSQLを、別々に用意しておくなどの工夫を行うこと。</p>
</div>
</div></blockquote>
<p>実際にマッピングされた<code class="docutils literal notranslate"><span class="pre">Order</span></code>オブジェクトおよび関連オブジェクトの状態は、以下の通りである。</p>
<blockquote>
<div><figure class="align-center" id="id47">
<a class="reference internal image-reference" href="../_images/dataaccess_object.png"><img alt="Mapped object diagram" src="../_images/dataaccess_object.png" style="width: 90%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>Picture - Mapped object diagram</strong></span><a class="headerlink" href="#id47" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>関連オブジェクトを取得する別の方法として、取得したレコードの値を使って、内部で別のSQLを実行して、取得する方法がある。
内部で別のSQLを実行する方法は、個々のSQLや、resultMap要素の定義が、非常にシンプルとなる。
ただし、この方法で取得する場合は、N+1問題を引き起こす要因となることを、意識しておく必要がある。</p>
<p>内部で別のSQLを実行する方法については、Mybatis Developer Guide(PDF)の「Result Maps/Complex Properties」(P.36-37)および「Result Maps/Composite Keys or Multiple Complex Parameters Properties」(P.40-41)を参照されたい。</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>内部で別のSQLを実行する方法を使う場合、関連オブジェクトは “Eager Load” されるため、関連オブジェクトを使用しない場合も、SQLが実行されてしまう。
この動作回避する方法として、Mybatisでは、関連オブジェクトを “Lazy Load” する方法を、オプションとして提供している。</p>
<p>“Lazy Load”を有効にするための設定は、以下の通りである。</p>
<ul class="simple">
<li><p>Mybatis設定ファイルのsetting要素のenhancementEnabled属性を、<code class="docutils literal notranslate"><span class="pre">true</span></code>に設定する。</p></li>
<li><p>CGLIB 2.xを、クラスパスに追加する。</p></li>
</ul>
</div>
</div></blockquote>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ExclusionControl.html" title="5.4. 排他制御"
             >next</a> |</li>
        <li class="right" >
          <a href="DataAccessJpa.html" title="5.2. データベースアクセス（JPA編）"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Global Framework Development Guideline 1.0.4.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" ><span class="section-number">5. </span>TERASOLUNA Global Frameworkの機能詳細</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">5.3. </span>データベースアクセス（Mybatis2編）</a></li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013-2016, NTT DATA.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 5.3.0.Theme by <a href="http://github.com/vkvn">vkvn</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>
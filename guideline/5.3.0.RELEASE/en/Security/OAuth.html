<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>9.10. OAuth &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.3.0.RELEASE documentation</title>
    
    <link rel="stylesheet" href="../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '5.3.0.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="top" title="TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.3.0.RELEASE documentation" href="../index.html" />
    <link rel="up" title="9. Security countermeasures" href="index.html" />
    <link rel="next" title="10. Tutorials" href="../Tutorial/index.html" />
    <link rel="prev" title="9.9. Implementation Example of Typical Security Requirements" href="SecureLoginDemo.html" /><script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../Tutorial/index.html" title="10. Tutorials"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="SecureLoginDemo.html" title="9.9. Implementation Example of Typical Security Requirements"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.3.0.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">9. Security countermeasures</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">9.10. OAuth</a><ul>
<li><a class="reference internal" href="#overview">9.10.1. Overview</a><ul>
<li><a class="reference internal" href="#about-oauth-2-0">9.10.1.1. About OAuth 2.0</a></li>
<li><a class="reference internal" href="#architecture-of-oauth-2-0">9.10.1.2. Architecture of OAuth 2.0</a><ul>
<li><a class="reference internal" href="#roles">9.10.1.2.1. Roles</a></li>
<li><a class="reference internal" href="#scope">9.10.1.2.2. Scope</a></li>
<li><a class="reference internal" href="#protocol-flow">9.10.1.2.3. Protocol flow</a></li>
<li><a class="reference internal" href="#authorization-grant">9.10.1.2.4. Authorization grant</a></li>
<li><a class="reference internal" href="#life-cycle-of-access-token">9.10.1.2.5. Life cycle of access token</a></li>
</ul>
</li>
<li><a class="reference internal" href="#architecture-of-spring-security-oauth">9.10.1.3. Architecture of Spring Security OAuth</a><ul>
<li><a class="reference internal" href="#authorization-server">9.10.1.3.1. Authorization server</a></li>
<li><a class="reference internal" href="#resource-server">9.10.1.3.2. Resource server</a></li>
<li><a class="reference internal" href="#client">9.10.1.3.3. Client</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">9.10.2. How to use</a><ul>
<li><a class="reference internal" href="#set-up-of-spring-security-oauth">9.10.2.1. Set-up of Spring Security OAuth</a></li>
<li><a class="reference internal" href="#application-settings">9.10.2.2. Application settings</a></li>
<li><a class="reference internal" href="#implementation-of-authorization-server">9.10.2.3. Implementation of authorization server</a><ul>
<li><a class="reference internal" href="#creation-of-setting-file-authorization-server">9.10.2.3.1. Creation of setting file (Authorization server)</a></li>
<li><a class="reference internal" href="#defining-authorization-server">9.10.2.3.2. Defining authorization server</a></li>
<li><a class="reference internal" href="#client-authentication">9.10.2.3.3. Client authentication</a></li>
<li><a class="reference internal" href="#resource-owner-authentication">9.10.2.3.4. Resource owner authentication</a></li>
<li><a class="reference internal" href="#authorization-for-each-scope">9.10.2.3.5. Authorization for each scope</a></li>
<li><a class="reference internal" href="#customising-scope-authorization-screen">9.10.2.3.6. Customising scope authorization screen</a></li>
<li><a class="reference internal" href="#error-handling-at-the-time-of-authorization-request">9.10.2.3.7. Error handling at the time of authorization request</a></li>
<li><a class="reference internal" href="#how-to-share-access-token-with-resource-server">9.10.2.3.8. How to share access token with resource server</a></li>
<li><a class="reference internal" href="#canceling-a-token-authorization-server">9.10.2.3.9. Canceling a token (authorization server)</a></li>
<li><a class="reference internal" href="#transaction-control">9.10.2.3.10. Transaction control</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-of-resource-server">9.10.2.4. Implementation of resource server</a><ul>
<li><a class="reference internal" href="#creating-a-setup-file-resource-server">9.10.2.4.1. Creating a setup file (resource server)</a></li>
<li><a class="reference internal" href="#setting-of-accessible-scope-for-the-resource">9.10.2.4.2. Setting of accessible scope for the resource</a></li>
<li><a class="reference internal" href="#configuration-of-access-token-resource-server">9.10.2.4.3. Configuration of access token (Resource Server)</a></li>
<li><a class="reference internal" href="#fetching-user-information">9.10.2.4.4. Fetching user information</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-of-client">9.10.2.5. Implementation of client</a><ul>
<li><a class="reference internal" href="#accessing-a-resource-using-oauth2resttemplate">9.10.2.5.1. Accessing a resource using OAuth2RestTemplate</a><ul>
<li><a class="reference internal" href="#creation-of-configuration-file-client">9.10.2.5.1.1. Creation of configuration file (Client)</a></li>
<li><a class="reference internal" href="#applying-oauth2clientcontextfilter">9.10.2.5.1.2. Applying OAuth2ClientContextFilter</a></li>
<li><a class="reference internal" href="#settings-of-oauth2resttemplate">9.10.2.5.1.3. Settings of OAuth2RestTemplate</a><ul>
<li><a class="reference internal" href="#setting-a-resource-while-using-authorization-code-grant">9.10.2.5.1.3.1. Setting a resource while using authorization code grant</a></li>
<li><a class="reference internal" href="#settings-of-resource-at-the-time-of-using-resource-owner-password-credential-grant">9.10.2.5.1.3.2. Settings of resource at the time of using resource owner password credential grant</a></li>
<li><a class="reference internal" href="#settings-of-resource-at-the-time-of-using-client-credential-grant">9.10.2.5.1.3.3. Settings of resource at the time of using client credential grant</a></li>
</ul>
</li>
<li><a class="reference internal" href="#accessing-a-resource-server">9.10.2.5.1.4. Accessing a resource Server</a></li>
</ul>
</li>
<li><a class="reference internal" href="#accessing-a-resource-using-javascript">9.10.2.5.2. Accessing a resource using JavaScript</a></li>
<li><a class="reference internal" href="#cancellation-of-token-client-server">9.10.2.5.3. Cancellation of token (Client server)</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend">9.10.3. How to extend</a><ul>
<li><a class="reference internal" href="#linking-authorization-server-and-resource-server-through-endpoints">9.10.3.1. Linking Authorization Server and Resource Server through endpoints</a><ul>
<li><a class="reference internal" href="#linkage-through-http-access">9.10.3.1.1. Linkage through HTTP access</a></li>
<li><a class="reference internal" href="#extension-of-defaultaccesstokenconverter">9.10.3.1.2. Extension of DefaultAccessTokenConverter</a><ul>
<li><a class="reference internal" href="#defaultaccesstokenconverter-means">9.10.3.1.2.1. DefaultAccessTokenConverter means</a></li>
<li><a class="reference internal" href="#id3">9.10.3.1.2.2. Implementation of Authorization Server</a></li>
<li><a class="reference internal" href="#id4">9.10.3.1.2.3. Implementation of Resource Server</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="SecureLoginDemo.html"
                        title="previous chapter">9.9. Implementation Example of Typical Security Requirements</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../Tutorial/index.html"
                        title="next chapter">10. Tutorials</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/Security/OAuth.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="oauth">
<span id="id1"></span><h1>9.10. OAuth<a class="headerlink" href="#oauth" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="index">
<p class="topic-title first">Index</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id22">Overview</a><ul>
<li><a class="reference internal" href="#about-oauth-2-0" id="id23">About OAuth 2.0</a></li>
<li><a class="reference internal" href="#architecture-of-oauth-2-0" id="id24">Architecture of OAuth 2.0</a><ul>
<li><a class="reference internal" href="#roles" id="id25">Roles</a></li>
<li><a class="reference internal" href="#scope" id="id26">Scope</a></li>
<li><a class="reference internal" href="#protocol-flow" id="id27">Protocol flow</a></li>
<li><a class="reference internal" href="#authorization-grant" id="id28">Authorization grant</a></li>
<li><a class="reference internal" href="#life-cycle-of-access-token" id="id29">Life cycle of access token</a></li>
</ul>
</li>
<li><a class="reference internal" href="#architecture-of-spring-security-oauth" id="id30">Architecture of Spring Security OAuth</a><ul>
<li><a class="reference internal" href="#authorization-server" id="id31">Authorization server</a></li>
<li><a class="reference internal" href="#resource-server" id="id32">Resource server</a></li>
<li><a class="reference internal" href="#client" id="id33">Client</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use" id="id34">How to use</a><ul>
<li><a class="reference internal" href="#set-up-of-spring-security-oauth" id="id35">Set-up of Spring Security OAuth</a></li>
<li><a class="reference internal" href="#application-settings" id="id36">Application settings</a></li>
<li><a class="reference internal" href="#implementation-of-authorization-server" id="id37">Implementation of authorization server</a><ul>
<li><a class="reference internal" href="#creation-of-setting-file-authorization-server" id="id38">Creation of setting file (Authorization server)</a></li>
<li><a class="reference internal" href="#defining-authorization-server" id="id39">Defining authorization server</a></li>
<li><a class="reference internal" href="#client-authentication" id="id40">Client authentication</a></li>
<li><a class="reference internal" href="#resource-owner-authentication" id="id41">Resource owner authentication</a></li>
<li><a class="reference internal" href="#authorization-for-each-scope" id="id42">Authorization for each scope</a></li>
<li><a class="reference internal" href="#customising-scope-authorization-screen" id="id43">Customising scope authorization screen</a></li>
<li><a class="reference internal" href="#error-handling-at-the-time-of-authorization-request" id="id44">Error handling at the time of authorization request</a></li>
<li><a class="reference internal" href="#how-to-share-access-token-with-resource-server" id="id45">How to share access token with resource server</a></li>
<li><a class="reference internal" href="#canceling-a-token-authorization-server" id="id46">Canceling a token (authorization server)</a></li>
<li><a class="reference internal" href="#transaction-control" id="id47">Transaction control</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-of-resource-server" id="id48">Implementation of resource server</a><ul>
<li><a class="reference internal" href="#creating-a-setup-file-resource-server" id="id49">Creating a setup file (resource server)</a></li>
<li><a class="reference internal" href="#setting-of-accessible-scope-for-the-resource" id="id50">Setting of accessible scope for the resource</a></li>
<li><a class="reference internal" href="#configuration-of-access-token-resource-server" id="id51">Configuration of access token (Resource Server)</a></li>
<li><a class="reference internal" href="#fetching-user-information" id="id52">Fetching user information</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-of-client" id="id53">Implementation of client</a><ul>
<li><a class="reference internal" href="#accessing-a-resource-using-oauth2resttemplate" id="id54">Accessing a resource using OAuth2RestTemplate</a><ul>
<li><a class="reference internal" href="#creation-of-configuration-file-client" id="id55">Creation of configuration file (Client)</a></li>
<li><a class="reference internal" href="#applying-oauth2clientcontextfilter" id="id56">Applying OAuth2ClientContextFilter</a></li>
<li><a class="reference internal" href="#settings-of-oauth2resttemplate" id="id57">Settings of OAuth2RestTemplate</a><ul>
<li><a class="reference internal" href="#setting-a-resource-while-using-authorization-code-grant" id="id58">Setting a resource while using authorization code grant</a></li>
<li><a class="reference internal" href="#settings-of-resource-at-the-time-of-using-resource-owner-password-credential-grant" id="id59">Settings of resource at the time of using resource owner password credential grant</a></li>
<li><a class="reference internal" href="#settings-of-resource-at-the-time-of-using-client-credential-grant" id="id60">Settings of resource at the time of using client credential grant</a></li>
</ul>
</li>
<li><a class="reference internal" href="#accessing-a-resource-server" id="id61">Accessing a resource Server</a></li>
</ul>
</li>
<li><a class="reference internal" href="#accessing-a-resource-using-javascript" id="id62">Accessing a resource using JavaScript</a></li>
<li><a class="reference internal" href="#cancellation-of-token-client-server" id="id63">Cancellation of token (Client server)</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend" id="id64">How to extend</a><ul>
<li><a class="reference internal" href="#linking-authorization-server-and-resource-server-through-endpoints" id="id65">Linking Authorization Server and Resource Server through endpoints</a><ul>
<li><a class="reference internal" href="#linkage-through-http-access" id="id66">Linkage through HTTP access</a></li>
<li><a class="reference internal" href="#extension-of-defaultaccesstokenconverter" id="id67">Extension of DefaultAccessTokenConverter</a><ul>
<li><a class="reference internal" href="#defaultaccesstokenconverter-means" id="id68">DefaultAccessTokenConverter means</a></li>
<li><a class="reference internal" href="#id3" id="id69">Implementation of Authorization Server</a></li>
<li><a class="reference internal" href="#id4" id="id70">Implementation of Resource Server</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<span id="oauthoverview"></span><h2><a class="toc-backref" href="#id22">9.10.1. Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This section explains the overview of OAuth 2.0 and the method to implement authorization control function as per the specifications of OAuth 2.0,
by using Spring Security OAuth which is one of the Spring project.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>** Reference of Spring Security OAuth **</p>
<p class="last">Spring Security OAuth also provides the functions which are not introduced in this guideline.
Refer to   <a class="reference external" href="https://projects.spring.io/spring-security-oauth/docs/oauth2.html">OAuth 2 Developers Guide</a> , for the details of Spring Security OAuth.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="about-oauth-2-0">
<span id="oauthaboutoauth2-0"></span><h3><a class="toc-backref" href="#id23">9.10.1.1. About OAuth 2.0</a><a class="headerlink" href="#about-oauth-2-0" title="Permalink to this headline">¶</a></h3>
<p>OAuth 2.0 is the authorization framework where access range can be specified for the resources protected on server,
when HTTP service is used in third-party application.</p>
<p>OAuth 2.0 is specified as RFC, and it consists of various related technical specifications.</p>
<p>Important specifications of OAuth 2.0 are as follows.</p>
<table border="1" class="colwidths-given docutils" id="id5">
<caption><span class="caption-text">** OAuth 2.0 important specifications **</span><a class="headerlink" href="#id5" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="15%" />
<col width="30%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">RFC</th>
<th class="head">Overview</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">RFC 6749</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="http://tools.ietf.org/html/rfc6749">The OAuth 2.0 Authorization Framework</a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Technical specifications describing the most fundamental contents of OAuth 2.0, such as terminology and authorization methods.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">RFC 6750</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="https://tools.ietf.org/html/rfc6750">Bearer Token Usage</a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Technical specifications related to method of transferring the &#8220;Access token without signature&#8221; (Hereafter, referred as access token) within servers,
which is used for authorization control described in RFC 6749.</div>
<div class="line">Information about access token is described later.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">RFC 6819</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="https://tools.ietf.org/html/rfc6819">Threat Model and Security Considerations</a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Technical specifications about the security requirements that need to be considered while using OAuth 2.0</div>
<div class="line">In these guidelines, the concrete explanation about the study items is omitted.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">RFC 7519</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="https://tools.ietf.org/html/rfc7519">JSON Web Token (JWT)</a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Technical specifications related to &#8220;JSON Web Token (JWT)&#8221; which is a token including JSON that can be signed.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">RFC 7523</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="https://tools.ietf.org/html/rfc7523">JSON Web Token (JWT) Profile for OAuth 2.0 Client Authentication and Authorization Grants</a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Technical specifications related to method of using JWT prescribed in RFC 6819 as an access token to be used for authorization control described in RFC 6749.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">RFC 7009</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="https://tools.ietf.org/html/rfc7009">OAuth 2.0 Token Revocation</a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Technical specifications related to additional end point invalidating the token.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>In conventional client-server type authentication model, the third-party application performs authentication by using user authentication information (user name and password etc.)
in order to access the resources protected on server.</p>
<p>In other words, user needs to share the authentication information with third party in order to provide the rights to third party applications for accessing the resources; however it has the risks such as unintended access and information leakage by the user, if there are defects and malicious operations in third party application.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_TraditionalAuthenticationModel.png"><img alt="../_images/OAuth_TraditionalAuthenticationModel.png" src="../_images/OAuth_TraditionalAuthenticationModel.png" style="width: 100%;" /></a>
</div>
<p>On the other hand, in OAuth 2.0, authentication can be directly performed by the user, and third party applications can access resources without sharing authentication information to third parties by issuing information for authenticated requests called as &#8220;access token&#8221;.</p>
<p>Moreover, more flexible access control is achieved as compared with conventional client-server type authentication model, by enabling the specification of access range (scope) of resources when access token is issued.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_OAuthAuthenticationModel.png"><img alt="../_images/OAuth_OAuthAuthenticationModel.png" src="../_images/OAuth_OAuthAuthenticationModel.png" style="width: 100%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="architecture-of-oauth-2-0">
<span id="oautharchitecture"></span><h3><a class="toc-backref" href="#id24">9.10.1.2. Architecture of OAuth 2.0</a><a class="headerlink" href="#architecture-of-oauth-2-0" title="Permalink to this headline">¶</a></h3>
<p>This section explains the roles, scope, authorization grant, and protocol flow defined in OAuth 2.0.
In OAuth 2.0, concepts such as scope and authorization grant are defined, and the specifications of authorization are prescribed by using these concepts.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="roles">
<span id="oauthrole"></span><h4><a class="toc-backref" href="#id25">9.10.1.2.1. Roles</a><a class="headerlink" href="#roles" title="Permalink to this headline">¶</a></h4>
<p>Following 4 roles are defined in OAuth 2.0.</p>
<table border="1" class="colwidths-given longtable docutils" id="id6">
<caption><span class="caption-text">** Roles in OAuth 2.0 **</span><a class="headerlink" href="#id6" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Role name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">Resource owner</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Role permitting the access to protected resources. User (End user) etc.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">Resource server</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Role providing the protected resources. Web server.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">Authorization server</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Role authenticating resource owner and issuing the access token (Information necessary for  client to access the resource server). Web server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">Client</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Role getting the authorization of resource owner and making the request for protected resources on behalf of resource owner. Web application etc. Client information is registered in the authorization server in-advance and managed by client ID which is unique in the authorization server.</div>
<div class="line">OAuth 2.0 defines following 2 client types based on the ability to maintain confidentiality of client credentials (client authentication information).</div>
<div class="line">(1) Confidential</div>
<div class="line-block">
<div class="line">Client that can maintain the confidentiality of client credential.</div>
</div>
<div class="line">(2) Public</div>
<div class="line-block">
<div class="line">Client that cannot maintain the confidentiality of client credentials and cannot perform secure client authentication by using other means like the client executed on the device of resource owner.</div>
<div class="line"><br /></div>
</div>
<div class="line">Moreover, OAuth 2.0 is being designed by considering the following examples as a client.</div>
<div class="line">(1) Web application (web application)</div>
<div class="line-block">
<div class="line">Client executed on Web server (Confidential).</div>
</div>
<div class="line">(2) User agent-based application (user-agent-based application)</div>
<div class="line-block">
<div class="line">Client executed in user agents of resource owner, by downloading the client code from Web server (public) . Such as Javascript application.</div>
</div>
<div class="line">(3) Native application (native application)</div>
<div class="line-block">
<div class="line">Client installed and executed on the device of resource owner (Public).</div>
</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="scope">
<span id="oauthscope"></span><h4><a class="toc-backref" href="#id26">9.10.1.2.2. Scope</a><a class="headerlink" href="#scope" title="Permalink to this headline">¶</a></h4>
<p>The concept &#8220;Scope&#8221; is being used as a method of controlling access for resources protected in OAuth 2.0.</p>
<p>In response to the request from client, the authorization server can specify the access rights (read, write permissions etc.) for the protected resources, including the scope in access token based on the policy of authorization server or the instructions of resource owner.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="protocol-flow">
<span id="oauthprotocolflow"></span><h4><a class="toc-backref" href="#id27">9.10.1.2.3. Protocol flow</a><a class="headerlink" href="#protocol-flow" title="Permalink to this headline">¶</a></h4>
<p>In OAuth 2.0, resources are accessed in the following flow.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ProtocolFlow.png"><img alt="../_images/OAuth_ProtocolFlow.png" src="../_images/OAuth_ProtocolFlow.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given docutils" id="id7">
<caption><span class="caption-text">** Protocol flow of OAuth 2.0 **</span><a class="headerlink" href="#id7" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client requests authorization for the resource owner. As shown in the above figure, request is directly made to the resource owner, but it is recommended to request through the authorization server.</div>
<div class="line"><br /></div>
<div class="line">Request is made through authorization server for the authorization code grant and implicit grant among the grant types described later.</div>
<div class="line"><br /></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client receives an authorization grant (described later) as the credentials representing authorization from resource owner.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client requests for access token by presenting own authentication information and authorization grant given by resource owner to the authorization server.</div>
<div class="line"><br /></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authorization server authenticates the client and confirms the validity of authorization grant. It issues the access token if authorization grant is valid.</div>
<div class="line"><br /></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client requests to the resource protected on the resource server and authenticates with the issued access token.</div>
<div class="line"><br /></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource server checks the validity of access token and accepts the request if it is valid.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In order to simplify the complicated mechanism of signature and token exchange which was not popular in OAuth 1.0, the request handling access token needs to be made by HTTPS communication in OAuth 2.0.
(Using HTTPS communication prevents eavesdropping of access token)</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="authorization-grant">
<span id="authorizationgrant"></span><h4><a class="toc-backref" href="#id28">9.10.1.2.4. Authorization grant</a><a class="headerlink" href="#authorization-grant" title="Permalink to this headline">¶</a></h4>
<p>Authorization grant represents authorization from resource owner and it is used when client fetches the access token.
In OAuth 2.0, following 4 grant types are defined, however these can be individually extended such as adding the credential items etc.</p>
<p>Client requests the access token to authorization server from any of grant types and accesses the resource server with the fetched access token.
Authorization server must define 1 or more supporting grant types, and determine the grant type to be used among these as per the authorization request from client.</p>
<table border="1" class="colwidths-given docutils" id="id8">
<caption><span class="caption-text"><strong>Authorization grant in OAuth 2.0</strong></span><a class="headerlink" href="#id8" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Grant type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">Authorization code grant</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In the flow of authorization code grant, the authorization server issues authorization code to client as an intermediary between client and resource owner, and the client issues the access token by passing the authorization code to authorization server.</div>
<div class="line">It is not necessary to share the credentials of resource owner to the client in order to issue the access token by using the authorization code issued by authorization server.</div>
<div class="line">Authorization code grant is used, when confidential client uses OAuth 2.0 similar to a Web application.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">Implicit grant</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">In the flow of implicit grant, authorization server acts as an intermediary similar to authorization code grant, however it issues the access token directly instead of an authorization code.</div>
<div class="line">Since access token is encoded in the URL, it may get leaked to a resource owner or other applications on the same device. Further, since the client is not authenticated, a risk of spoofing attack due to unauthorized usage of access token issued to other clients is also likely.</div>
</div>
<div class="last line-block">
<div class="line">Implicit grant should be used only when client type is public, such as client implemented in Javascript.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">Resource owner password credential grant</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In the flow of resource owner password credential grant, client uses the authentication information of resource owner as authorization grant and issues the access token directly.</div>
<div class="line">Since the credentials of resource owner must be shared with client, a risk of unauthorized usage or leakage of credentials is likely if client&#8217;s reliability is low.</div>
<div class="line">Resource owner password credential grant should be used only when there is high reliability between resource owner and client and when other grant types cannot be used.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">Client credential grant</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In the flow of client credential grant, authentication information of client is used as an authorization grant, and access token is issued directly.</div>
<div class="line">It is used when client is a resource owner.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Flow of authorization code grant is as follows.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_AuthorizationCodeGrant.png"><img alt="../_images/OAuth_AuthorizationCodeGrant.png" src="../_images/OAuth_AuthorizationCodeGrant.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id9">
<caption><span class="caption-text"><strong>Authorization code grant flow</strong></span><a class="headerlink" href="#id9" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource owner accesses the pages required for resources which are protected on resource server provided by the client through user agent.</div>
<div class="line">Client gives access to authorization end point on authorization server for the user agent of resource owner, in order to fetch authorization from resource owner.</div>
<div class="line">In this case, client includes the &#8220;Client ID for own identification&#8221;, &#8220;Scope requested to the resource as an option&#8221;, &#8220;Redirect URL for returning the user agent after authorization process performed by authorization server&#8221; and &#8220;State&#8221; in the request parameters.</div>
<div class="line">state is a random value associated with user agent and is used to ensure that series of flows is executed by the same user agent (CSRF countermeasures)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">User agent accesses the authorization end point of authorization server indicated to the client.</div>
<div class="line">Authorization server authenticates the resource owner through user agent and checks the validity of parameters by comparing it with the registered client information, based on the client ID, scope and redirect URL of request parameter.</div>
<div class="line">After confirmation, resource owner is asked to approve/ deny the access request.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource owner sends approval / denial of access request to the authorization server.</div>
<div class="line">When resource owner grants access, the authorization end point of authorization server issues authorization code and gives the instructions to redirect the user agent to client by using the redirect URL of request parameter.</div>
<div class="line">In such case, authorization code is assigned to redirect URL, as the request parameter of redirect URL.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">User agent accesses the redirect URL with assigned authorization code.</div>
<div class="line">When processing of client is completed, the response is returned to resource owner.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client sends the authorization code to the token end point on authorization server, in order to request the access token.</div>
<div class="line">Token end point of authorization server authenticates the client and verifies the validity of authorization code, and issues the access token and optional refresh token if it is valid.</div>
<div class="line">Refresh token is used to issue new access token when the access token is disabled or expired.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client accesses the resource server with the fetched access token.</div>
<div class="line">Resource server checks the validity of access token, and if it is valid, it processes the request and returns the response to client.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Flow of implicit grant is as follows.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ImplicitGrant.png"><img alt="../_images/OAuth_ImplicitGrant.png" src="../_images/OAuth_ImplicitGrant.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id10">
<caption><span class="caption-text"><strong>Flow of implicit grant</strong></span><a class="headerlink" href="#id10" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource owner accesses the pages required for resources which are protected on resource server provided by the client through user agent.</div>
<div class="line">Client gives access to authorization end point on authorization server for the user agent of resource owner, in order to fetch authorization from resource owner and issue the access token.</div>
<div class="line">In this case, client includes the &#8220;Client ID for own identification&#8221;, &#8220;Scope requested to the resource as an option&#8221;, &#8220;Redirect URL for returning the user agent after performing authorization process by authorization server&#8221; and &#8220;State&#8221;, in the request parameters.</div>
<div class="line">state is a random value associated with user agent and is used to ensure that series of flows is executed by the same user agent (CSRF countermeasures)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">User agent accesses the authorization end point of authorization server indicated to the client.</div>
<div class="line">Authorization server authenticates the resource owner through user agent and checks the validity of parameters by comparing it with the registered client information, based on the client ID, scope and redirect URL of request parameter.</div>
<div class="line">After confirmation, resource owner is asked to approve/ deny the access request.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource owner sends approval / denial of access request to the authorization server.</div>
<div class="line">When resource owner grants access, the authorization end point of authorization server gives the instructions to redirect the user agent to client resource by using the redirect URL of request parameter. In such case, access token is assigned to URL fragment of redirect URL.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">User agent sends the request to client resource as per the redirect instructions. In such case, information of URL fragment is saved locally, and URL fragment is not sent in case of redirect.</div>
<div class="line">When client resource is accessed, the web page (usually, HTML document including the embedded script) is returned.</div>
<div class="line">User agent executes the script included in web page and extracts the access token from the locally saved URL fragment.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">User agent passes the access token to client.</div>
<div class="line">When processing of client is completed, the response is returned to resource owner.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client accesses the resource server with the fetched access token.</div>
<div class="line">Resource server checks the validity of access token, and if it is valid, it processes the request and returns the response to client</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Flow of resource owner password credential grant is as follows.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ResourceOwnerPasswordCredentialsGrant.png"><img alt="../_images/OAuth_ResourceOwnerPasswordCredentialsGrant.png" src="../_images/OAuth_ResourceOwnerPasswordCredentialsGrant.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given docutils" id="id11">
<caption><span class="caption-text"><strong>Flow of resource owner password credential grant</strong></span><a class="headerlink" href="#id11" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource owner provides the credentials (user name, password) to the client.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client accesses the token end point of authorization server, in order to request the access token.</div>
<div class="line">In this case, client includes the credentials specified from resource owner and the scope requested to resource, in the request parameter.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Token end point of authorization server authenticates the client and verifies the credentials of resource owner. If it is valid, it issues the access token.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Flow of client credential grant is as follows.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ClientCredentialsGrant.png"><img alt="../_images/OAuth_ClientCredentialsGrant.png" src="../_images/OAuth_ClientCredentialsGrant.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given docutils" id="id12">
<caption><span class="caption-text"><strong>Flow of client credential grant</strong></span><a class="headerlink" href="#id12" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client accesses the token end point of authorization server, in order to request the access token.</div>
<div class="line">In this case, client requests for access token including the client&#8217;s own credentials.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Token end point of authorization server authenticates the client and issues the access token when authentication is successful.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="life-cycle-of-access-token">
<span id="accesstokenlifecycle"></span><h4><a class="toc-backref" href="#id29">9.10.1.2.5. Life cycle of access token</a><a class="headerlink" href="#life-cycle-of-access-token" title="Permalink to this headline">¶</a></h4>
<p>Access token is issued by authorization server, by confirming the validity of authorization grant presented by the client.
For an issued access token, the scope is assigned based on the policy of authority server or the instructions of resource owner and access is obtained for the protected resource.
Expiry period is set when the access token is issued, and if it expires, the access rights of protected resource are invalidated.</p>
<p>Flow from issue of access token till its invalidation is as follows.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_LifeCycleOfAccessToken.png"><img alt="../_images/OAuth_LifeCycleOfAccessToken.png" src="../_images/OAuth_LifeCycleOfAccessToken.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id13">
<caption><span class="caption-text"><strong>Flow from issue of access token till its invalidation</strong></span><a class="headerlink" href="#id13" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client presents the authorization grant and requests for access token.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authorization server confirms the authorization grant presented by client and issues the access token.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client presents the access token and requests for resource protected on resource server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource server verifies the validity of access token presented by client and if it is valid, performs processing for the resource protected on resource server.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client presents the access token (expired), and requests for the resource protected on resource server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource server verifies the validity of access token presented by client, and returns error if the access token has expired.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">When access token expires, the access rights of protected resources are invalidated, but access rights of protected resources can also be invalidated by disabling the access token before expiry of access token.</div>
<div class="line">When access token is to be disabled before its expiry, the client requests authorization server to cancel the token. Access rights of protected resources are invalidated for the disabled access token.</div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">When access token expires, authorization grant should be presented to authorization server again and validity should be re-confirmed by authorization server, in order to re-acquire the access token by client.
Therefore, when short validity term of access token is set, the usability decreases. On the other hand, when long validity term of access token is set, a high risk of disclosure or access token, and misuse is likely if it is disclosed.</div>
</div>
<div class="line-block">
<div class="line">Refresh token can be used to reduce the risk of disclosure without decreasing the usability of the token.
Refresh token can be used to get the new access token without re-submitting the authorization grant when access token is invalidated or expired.
When validity term is set at the time of issuing the refresh token and when refresh token expires, the access token cannot be re-issued.</div>
<div class="line">Risk of disclosure of access token and misuse at the time of disclosure can also be controlled while maintaining the usability with the re-issue of access token in short cycle, by setting the short validity term of access token and setting the long validity term of refresh token.</div>
</div>
<div class="line-block">
<div class="line">Issuing the refresh token is optional and is to be determined by the authorization server.</div>
</div>
<p>Flow of re-issuing the access token as per the refresh token is as follows.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_LifeCycleOfAccessTokenWithRefreshToken.png"><img alt="../_images/OAuth_LifeCycleOfAccessTokenWithRefreshToken.png" src="../_images/OAuth_LifeCycleOfAccessTokenWithRefreshToken.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given docutils" id="id14">
<caption><span class="caption-text"><strong>Flow from issuing the access token till its re-issue</strong></span><a class="headerlink" href="#id14" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client presents the authorization grant and requests for access token.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authorization server confirms the authorization grant presented by client and issues the access token and refresh token.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client presents the access token and requests for resource protected on resource server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource server verifies the validity of access token presented by client, and if it is valid, it processes the resource protected on resource server.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client presents the access token (expired), and requests for the resource protected on resource server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource server verifies the validity of access token presented by client, and returns error if the access token has expired.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When access token expiration error is returned from resource server, the client requests a new access token by presenting the refresh token.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authorization server verifies the validity of refresh token presented by client and if it is valid, issues the access token and optional refresh token.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="architecture-of-spring-security-oauth">
<span id="springsecurityoautharchitecture"></span><h3><a class="toc-backref" href="#id30">9.10.1.3. Architecture of Spring Security OAuth</a><a class="headerlink" href="#architecture-of-spring-security-oauth" title="Permalink to this headline">¶</a></h3>
<p>Spring Security OAuth is a library that provides functions necessary while building 3 roles such as Authorization Server, Resource Server, and Client as Spring applications among the roles defined in OAuth 2.0.
Spring Security OAuth is the technique that works by linking with the functions provided by Spring Framework (Spring MVC) and Spring Security, and it can build the authorization server, resource server and client by appropriate configuration (Bean definition) of default package provided by Spring Security OAuth.
Further, many extension points are provided similar to Spring Framework and Spring Security in order to incorporate the requirements that cannot be implemented in default package provided by Spring Security OAuth.</p>
<p>Further, refer to <a class="reference internal" href="Authentication.html"><span class="doc">Authentication</span></a> and <a class="reference internal" href="Authorization.html"><span class="doc">Authorization</span></a> for the details, when the functions provided by Spring Security are to be used for authentication/ authorization of requests within each roles.</p>
<p>When authorization server, resource server, client are built by using Spring Security OAuth, process is performed with the flow given below.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_OAuth2Architecture.png"><img alt="../_images/OAuth_OAuth2Architecture.png" src="../_images/OAuth_OAuth2Architecture.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given docutils" id="id15">
<caption><span class="caption-text"><strong>Flow of Spring Security OAuth</strong></span><a class="headerlink" href="#id15" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resource owner accesses the client through user agent.</div>
<div class="line">Client calls <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> from service.</div>
<div class="line">In case of authorization grant accessing the authorization end point, instructions are given to user agent to redirect to authorization end point of authorization server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">User agent accesses the <code class="docutils literal"><span class="pre">AuthorizationEndpoint</span></code> which is an authorization end point of authorization server.</div>
<div class="line"> <code class="docutils literal"><span class="pre">AuthorizationEndpoint</span></code> displays the screen that demands the authorization to the resource owner.</div>
<div class="line">Resource owner accesses  <code class="docutils literal"><span class="pre">AuthorizationEndpoint</span></code> by authorizing the scope for client.</div>
<div class="line"> <code class="docutils literal"><span class="pre">AuthorizationEndpoint</span></code> issues the authorization code if authorization grant is authorization code grant and it issues the access token if it is the implicit grant.</div>
<div class="line">Issued authorization code or access token is passed to the client through user agent by using the redirect.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client accesses  <code class="docutils literal"><span class="pre">TokenEndpoint</span></code> which is the token end point of authorization server from  <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>.</div>
<div class="line"> <code class="docutils literal"><span class="pre">TokenEndpoint</span></code> calls  <code class="docutils literal"><span class="pre">AuthorizationServerTokenService</span></code> and issues the access token. Issued access token is passed to client as a response.</div>
<div class="line">If authorization grant is authorization code grant, the authorization code is presented to authorization server. Validity of authorization code is verified by  <code class="docutils literal"><span class="pre">TokenEndpoint</span></code> before issuing the access token.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client specifies the access token fetched in (2) or (3) and accesses the resource server from  <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>.</div>
<div class="line">Resource server calls the  <code class="docutils literal"><span class="pre">OAuth2AuthenticationManager</span></code> and fetches the authentication information associated with access token through  <code class="docutils literal"><span class="pre">ResourceServerTokenServices</span></code>. Further, it verifies the access token when authentication information is fetched.</div>
<div class="line">When access token verification is successful, the resource corresponding to request from the client is returned.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>As mentioned earlier, usage of HTTPS communication at each end point is assumed in OAuth 2.0, however there may be the cases when HTTPS communication is used in
SSL accelerator or web server, or when distributed in multiple AP servers by using load balancer.
When authorization code or redirect URL is embedded in client for linking the access token after authorization by resource owner,
the redirect URL indicating the SSL accelerator, Web server and load balancer should be embedded.</p>
<p>Spring (Spring Security OAuth) provides the technique for assembling the redirect URL by using any of the following headers.</p>
<ul class="simple">
<li>Forwarded header</li>
<li>X-Forwarded-Host header, X-Forwarded-Port header, X-Forwarded-Proto header</li>
</ul>
<p class="last">Setting should be done in order to assign the above mentioned headers at SSL accelerator and Web server, load balancer side, so that an appropriate redirect URL can be created in Spring(Spring Security OAuth).
If this is not performed, verification of request parameter (redirect URL) performed in the authorization code grant or implicit grant is likely to fail.</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">End point provided by Spring Security OAuth is implemented by extending the Spring MVC function. <code class="docutils literal"><span class="pre">&#64;FrameworkEndpoint</span></code> annotation is set in class at end point provided by Spring Security OAuth.
This is because <code class="docutils literal"><span class="pre">&#64;Controller</span></code> annotation does not conflict with the class registered by developer as a component.
Further, end point registered in <code class="docutils literal"><span class="pre">&#64;FrameworkEndpoint</span></code> annotation as component handles the <code class="docutils literal"><span class="pre">&#64;FrameworkEndpoint</span></code> method conflicting with URL as Handler class, after reading <code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code> annotation of end point by <code class="docutils literal"><span class="pre">FrameworkEndpointHandlerMapping</span></code> which is an extension class of <code class="docutils literal"><span class="pre">RequestMappingHandlerMapping</span></code>.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="authorization-server">
<span id="authorizationserver"></span><h4><a class="toc-backref" href="#id31">9.10.1.3.1. Authorization server</a><a class="headerlink" href="#authorization-server" title="Permalink to this headline">¶</a></h4>
<p>Authorization server authenticates the resource owner, fetches the authorization from the resource owner after authentication, and then issues the access token.</p>
<p>OAuth 2.0 supports the &#8220;Scope&#8221; concept as an expression for specifying the access scope.
Client specifies the scope while sending the authorization request, and when the resource owner authorizes the specified scope or when it matches with the scope registered previously in authorization server, that scope is authorized for the client by authorization server.
Authorization can be used together in accordance with the scope of client and roles of Spring Security explained in <a class="reference internal" href="Authorization.html#springsecurityauthorization"><span class="std std-ref">Authorization</span></a> section.</p>
<p>Spring Security OAuth provides the function to get an authorization from resource owner in <code class="docutils literal"><span class="pre">AuthorizationEndpoint</span></code>, and
provides the function to issue access token of client in <code class="docutils literal"><span class="pre">AuthorizationEndpoint</span></code> or <code class="docutils literal"><span class="pre">TokenEndpoint</span></code>.
<code class="docutils literal"><span class="pre">AuthorizationEndpoint</span></code> and <code class="docutils literal"><span class="pre">TokenEndpoint</span></code> issues the access token by <code class="docutils literal"><span class="pre">DefaultTokenServices</span></code> which is a default package of <code class="docutils literal"><span class="pre">AuthorizationServerTokenService</span></code>.</p>
<p>When access token is issued, the client information registered in authorization server through <code class="docutils literal"><span class="pre">ClientDetailsService</span></code> is fetched,
and the same is used for verifying the possibility of access token issue.
In OAuth 2.0 specifications, the registration procedure of clients that uses authorization server is not prescribed, and the client registration procedure is not supported in Spring Security OAuth as well.</p>
<p>Hence, when client registration interface is to be provided in the application, it must be implemented independently.</p>
<p>Spring Security authentication function is used for resource owner authentication.
Refer to <a class="reference internal" href="Authentication.html#springsecurityauthentication"><span class="std std-ref">Authentication</span></a> for the details.</p>
<p>Configuration of authorization server is shown below.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_AutohrizationServerAuthArchitecture.png"><img alt="../_images/OAuth_AutohrizationServerAuthArchitecture.png" src="../_images/OAuth_AutohrizationServerAuthArchitecture.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given docutils" id="id16">
<caption><span class="caption-text"><strong>Working of authorization server (In case of authorization end point access)</strong></span><a class="headerlink" href="#id16" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"> <code class="docutils literal"><span class="pre">AuthorizationEndpoint</span></code> process is executed by accessing the authorization end point (/oauth/authorize) of authorization server by the user agent.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call  <code class="docutils literal"><span class="pre">ClientDetailsService</span></code> method, and verify request parameter after fetching the client information registered in advance.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call <code class="docutils literal"><span class="pre">UserApprovalHandler</span></code> method and check whether authorization of scope is registered for client</div>
<div class="line">When authorization is not registered, the screen (/oauth/confirm_access) asking the resource owner for authorization through user agent is displayed.</div>
<div class="line">In such case, the scope to be inquired is linked by getting the product of request parameter and client information registered in advance, and by using <code class="docutils literal"><span class="pre">&#64;SessionAttributes</span></code> of Spring MVC.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Manage authorization status by <code class="docutils literal"><span class="pre">ApprovalStore</span></code> in <code class="docutils literal"><span class="pre">ApprovalStoreUserApprovalHandler</span></code> which is package of <code class="docutils literal"><span class="pre">UserApprovalHandler</span></code>.</div>
<div class="line">When authorization is performed by resource owner, call <code class="docutils literal"><span class="pre">ApprovalStore</span></code> method and register specified information.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">As described earlier, the scope to be inquired is the product of scope registered previously in authorization server and scope specified by request parameter at the time of authorization request by client.
For example, when the scope of READ and CREATE is specified by request parameters for the client assigning the scopes such as READ, CREATE, DELETE on authorization server, then the scope such as READ, CREATE which is product of (READ,CREATE,DELETE) and (READ,CREATE) can be assigned.
When the scope that is not assigned to client on authorization server is specified by request parameter, an error occurs and access is denied.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_AutohrizationServerTokenArchitecture.png"><img alt="../_images/OAuth_AutohrizationServerTokenArchitecture.png" src="../_images/OAuth_AutohrizationServerTokenArchitecture.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given docutils" id="id17">
<caption><span class="caption-text"><strong>Working of authorization server (In case of token end point access)</strong></span><a class="headerlink" href="#id17" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">TokenEndpoint</span></code> process is executed by accessing the token end point (/oauth/token) of authorization server by the client</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call <code class="docutils literal"><span class="pre">ClientDetailsService</span></code> method and check whether the scope of request parameter is registered in client after fetching the previously registered client information.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When scope is registered, call <code class="docutils literal"><span class="pre">TokenGranter</span></code> method and issue access token.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call <code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code> method and issue an access token in <code class="docutils literal"><span class="pre">AbstractTokenGranter</span></code> which is an implementation of <code class="docutils literal"><span class="pre">TokenGranter</span></code>.</div>
<div class="line"><code class="docutils literal"><span class="pre">AbstractTokenGranter</span></code> which is the base class of <code class="docutils literal"><span class="pre">TokenGranter</span></code> implemented as per grant type, and actual process is assigned to each class.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call <code class="docutils literal"><span class="pre">TokenStore</span></code> method and manage status of access token in <code class="docutils literal"><span class="pre">DefaultTokenServices</span></code> which is an implementation of <code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="resource-server">
<span id="resourceserver"></span><h4><a class="toc-backref" href="#id32">9.10.1.3.2. Resource server</a><a class="headerlink" href="#resource-server" title="Permalink to this headline">¶</a></h4>
<p>Resource server processes the access request for protected resource from the client and returns the response.
Resource server verifies whether the access token added to the request from client is within the validity period and gets the authentication information associated with the access token.
After fetching the authentication information, requested resource verifies whether the concerned access token is within scope.
Process after access token verification can be implemented similar to the normal applications.</p>
<p>Spring Security OAuth implements the verification function of access token, by using authentication and authorization framework of Spring Security.
<code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code> provided by Spring Security OAuth is specifically used in <code class="docutils literal"><span class="pre">ServletFilter</span></code>.
<code class="docutils literal"><span class="pre">OAuth2AuthenticationEntryPoint</span></code> is used as an <code class="docutils literal"><span class="pre">AuthenticationEntryPoint</span></code> interface and <code class="docutils literal"><span class="pre">OAuth2AuthenticationManager</span></code> is used as <code class="docutils literal"><span class="pre">AuthenticationManager</span></code> respectively.
Refer to &#8220;<a class="reference internal" href="Authentication.html#springsecurityauthentication"><span class="std std-ref">Authentication</span></a>&#8221; for the details of Spring Security.</p>
<p>Configuration of resource server is as follows.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ResourceServerArchitecture.png"><img alt="../_images/OAuth_ResourceServerArchitecture.png" src="../_images/OAuth_ResourceServerArchitecture.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given docutils" id="id18">
<caption><span class="caption-text"><strong>Working of resource server</strong></span><a class="headerlink" href="#id18" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When client accesses the resource server at the beginning, <code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code> is called.</div>
<div class="line"><br /></div>
<div class="line">Access token is extracted in <code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">After extracting the access token, fetch the authentication information associated with access token through <code class="docutils literal"><span class="pre">ResourceServerTokenServices</span></code> in <code class="docutils literal"><span class="pre">OAuth2AuthenticationManager</span></code> which is an implementation of <code class="docutils literal"><span class="pre">AuthenticationManager</span></code>.</div>
<div class="line">Further, verify the access token when authentication information is fetched.</div>
<div class="line">As a method of fetching authentication information associated with access token, a method of fetching the same by using  <code class="docutils literal"><span class="pre">TokenStore</span></code> commonly with the authorization server is listed besides the method of inquiring by HTTP to authorization server.</div>
<div class="line"><br /></div>
<div class="line">How to fetch the authentication information depends on the implementation of <code class="docutils literal"><span class="pre">ResourceServerTokenServices</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When verification of access token is successful, return the resource for the requests from client.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Handle the exception occurred at the time of authentication error by using <code class="docutils literal"><span class="pre">OAuth2AuthenticationEntryPoint</span></code>and receive error response.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Handle the exception occurred at the time of authorization error by using <code class="docutils literal"><span class="pre">OAuth2AccessDeniedHandler</span></code> and receive error response.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="client">
<span id="id2"></span><h4><a class="toc-backref" href="#id33">9.10.1.3.3. Client</a><a class="headerlink" href="#client" title="Permalink to this headline">¶</a></h4>
<p>Client authorizes the resource owner and fetches the access token, accesses the resource protected on resource server on behalf of resource owner.
In such a case, the access token issued from authorization server is added for the request to the resource.</p>
<p>Spring Security OAuth provides <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> which is OAuth 2.0 implementation of <code class="docutils literal"><span class="pre">RestOperations</span></code>, as the implementation method of client&#8217;s basic functions.</p>
<p>In <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>, authorization function required in authorization code grant is implemented by using <code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code> as servlet filter, in addition to functions such as issuing access token, re-issuing access token using refresh token and accessing the resource server using access token.</p>
<p>Further, in  <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>, access token acquired from authorization server along with grant type specified <code class="docutils literal"><span class="pre">OAuth2ProtectedResourceDetails</span></code> is saved in <code class="docutils literal"><span class="pre">DefaultOAuth2ClientContext</span></code>  which is an implementation of <code class="docutils literal"><span class="pre">OAuth2ClientContext</span></code>.
<code class="docutils literal"><span class="pre">DefaultOAuth2ClientContext</span></code> is defined as Bean of session scope by default, and access token can be shared among multiple requests.</p>
<p>When function to access resource server is to be developed, it is implemented similarly as development of usual REST client, except using <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> provided by Spring Security OAuth instead of <code class="docutils literal"><span class="pre">RestTemplate</span></code> provided by Spring Web, as an implementation of package of  <code class="docutils literal"><span class="pre">RestOperations</span></code>.</p>
<p>Configuration while using  <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> as client function is given below.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ClientArchitecture.png"><img alt="../_images/OAuth_ClientArchitecture.png" src="../_images/OAuth_ClientArchitecture.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils" id="id19">
<caption><span class="caption-text"><strong>Working of client</strong></span><a class="headerlink" href="#id19" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No,</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">User agent accesses the <code class="docutils literal"><span class="pre">Controller</span></code> so that <code class="docutils literal"><span class="pre">Service</span></code> of client can be called.</div>
<div class="line">Servlet function ( <code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code> ) for capturing <code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code> that may occur in (5) is applied for access along with access to resource server.</div>
<div class="line">User agent can access the authorization end point on authorization server, by applying this servlet function when `` UserRedirectRequiredException`` occurs.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> from <code class="docutils literal"><span class="pre">Service</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Before accessing resource server, confirm that access token is retained by <code class="docutils literal"><span class="pre">DefaultOAuth2ClientContext</span></code> which is retained as a member.</div>
<div class="line">When access token is saved and is within the validity period, specify access token fetched from <code class="docutils literal"><span class="pre">DefaultOAuth2ClientContext</span></code> and access the resource server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When access token is not saved at first access, or when validity period is lapsed, call <code class="docutils literal"><span class="pre">AccessTokenProvider</span></code> and fetch the access token.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch <code class="docutils literal"><span class="pre">AccessTokenProvider</span></code>the access token for grant type defined in <code class="docutils literal"><span class="pre">OAuth2ProtectedResourceDetails</span></code> as detailed information of resource.</div>
<div class="line"><code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code> is thrown when fetching of authorization code is not completed in <code class="docutils literal"><span class="pre">AuthorizationCodeAccessTokenProvider</span></code> which is an implementation of authorization code grant.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify access token fetched in (3) or (5) and access resource server.</div>
<div class="line">When an error occurs such as &#8220;access token expired&#8221; (<code class="docutils literal"><span class="pre">AccessTokenRequiredException</span></code>) while accessing, perform subsequent processes from (4) onwards again after initializing retained access token.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-use">
<span id="howtouse"></span><h2><a class="toc-backref" href="#id34">9.10.2. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<p>Bean definition example and implementation method required for using Spring Security OAuth is described.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="set-up-of-spring-security-oauth">
<span id="oauthsetup"></span><h3><a class="toc-backref" href="#id35">9.10.2.1. Set-up of Spring Security OAuth</a><a class="headerlink" href="#set-up-of-spring-security-oauth" title="Permalink to this headline">¶</a></h3>
<p>Spring Security OAuth is added as a dependent library in order to use the class provided by Spring Security OAuth.</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.security.oauth<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-security-oauth2<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Add Spring Security OAuth as a dependent library in <code class="file docutils literal"><span class="pre">pom.xml</span></code> of project using Spring Security OAuth.</div>
<div class="line">When resource server, authorization server, client are added as different project, respective description should be added.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">As given in above setting example, since it is assumed that dependency library version is managed by the parent project &#8220;terasoluna- gfw- parent&#8221;, it is not necessary to specify the version in pom.xml
The dependent library mentioned above is defined in <a class="reference external" href="http://platform.spring.io/platform/">Spring IO Platform</a> used by terasoluna-gfw-parent.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="application-settings">
<span id="oauthhowtouseapplicationsettings"></span><h3><a class="toc-backref" href="#id36">9.10.2.2. Application settings</a><a class="headerlink" href="#application-settings" title="Permalink to this headline">¶</a></h3>
<p>Settings of the application using Spring Security OAuth are described.</p>
<p>As shown in &#8220;<a class="reference internal" href="#authorizationgrant"><span class="std std-ref">Authorization grant</span></a>&#8221;,flow differs between authorization server and client differs in OAuth 2.0.
Hence, settings should be done in the application using Spring Security OAuth in accordance with the grant type supported by application.
Refer to implementation of each role for the setting details for each grant type.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="implementation-of-authorization-server">
<span id="implementationoauthauthorizationserver"></span><h3><a class="toc-backref" href="#id37">9.10.2.3. Implementation of authorization server</a><a class="headerlink" href="#implementation-of-authorization-server" title="Permalink to this headline">¶</a></h3>
<p>Implementation method of authorization server is described.</p>
<p>Authorization server provides end points for &#8220;fetching authorization from resource owners&#8221; and &#8220;issuing access tokens&#8221;, by using the function of Spring Security OAuth.
Further, while accessing the above-mentioned end point, it is necessary to authenticate the resource owner or client, and these guidelines are implemented by using the technique for authentication/ authorization of Spring Security.</p>
<div class="section" id="creation-of-setting-file-authorization-server">
<span id="oauthauthorizationservercreatesettingfile"></span><h4><a class="toc-backref" href="#id38">9.10.2.3.1. Creation of setting file (Authorization server)</a><a class="headerlink" href="#creation-of-setting-file-authorization-server" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code> is created as configuration file for defining in authorization server.</div>
<div class="line"><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code> performs Bean definition of end points for providing the functions of authentication server, and makes security setting for the end points and sets the grant type supporting the authorization server.</div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
       <span class="na">xmlns:oauth2=</span><span class="s">&quot;http://www.springframework.org/schema/security/oauth2&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/security</span>
<span class="s">           http://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">           http://www.springframework.org/schema/security/oauth2</span>
<span class="s">           http://www.springframework.org/schema/security/spring-security-oauth2.xsd</span>
<span class="s">           http://www.springframework.org/schema/beans</span>
<span class="s">           http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>


<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<p>Next, settings are described in <code class="docutils literal"><span class="pre">web.xml</span></code> in order to read the created <code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">web.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;context-param&gt;</span>
    <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
    <span class="nt">&lt;param-value&gt;</span>
        classpath*:META-INF/spring/applicationContext.xml
        classpath*:META-INF/spring/oauth2-auth.xml  <span class="c">&lt;!-- (1) --&gt;</span>
        classpath*:META-INF/spring/spring-security.xml
    <span class="nt">&lt;/param-value&gt;</span>
<span class="nt">&lt;/context-param&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify a Bean definition file of  OAuth 2.0. It should be described before <code class="docutils literal"><span class="pre">spring-security.xml</span></code>, by considering the case when URL targeted for access control set in <code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code> is included in the URL targeted for access control set in <code class="docutils literal"><span class="pre">spring-security.xml</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="defining-authorization-server">
<span id="oauthauthorizationserverdefinition"></span><h4><a class="toc-backref" href="#id39">9.10.2.3.2. Defining authorization server</a><a class="headerlink" href="#defining-authorization-server" title="Permalink to this headline">¶</a></h4>
<p>Definitions of authorization server are added as below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
     <span class="na">token-endpoint-url=</span><span class="s">&quot;/oth2/token&quot;</span>
     <span class="na">authorization-endpoint-url=</span><span class="s">&quot;/oth2/authorize&quot;</span> <span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;oauth2:authorization-code</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;oauth2:implicit</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (4) --&gt;</span>
    <span class="nt">&lt;oauth2:client-credentials</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (5) --&gt;</span>
    <span class="nt">&lt;oauth2:password</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (6) --&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use  <code class="docutils literal"><span class="pre">&lt;oauth2:authorization-server&gt;</span></code> tag and define settings of authorization server.</div>
<div class="line">Authorization end points for authorization and token end points for issuing the access tokens are registered as components, by using the <code class="docutils literal"><span class="pre">&lt;oauth2:authorization-server&gt;</span></code> tags.</div>
<div class="line">Specify URL of token end point in <code class="docutils literal"><span class="pre">token-endpoint-url</span></code> attribute. When it is not specified, default value &#8220;/oauth/token&#8221; is specified.</div>
<div class="line">Specify URL of authorization end point in <code class="docutils literal"><span class="pre">authorization-endpoint-url</span></code> attribute. When it is not specified, default value &#8220;/oauth/authorize&#8221; is specified.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use <code class="docutils literal"><span class="pre">&lt;oauth2:authorization-code&gt;</span></code> tag and support authorization code grant.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use <code class="docutils literal"><span class="pre">&lt;oauth2:implicit&gt;</span></code> tag and support implicit grant.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use <code class="docutils literal"><span class="pre">&lt;oauth2:refresh-token&gt;</span></code> tag and support refresh token.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use  <code class="docutils literal"><span class="pre">&lt;oauth2:client-credentials&gt;</span></code> tag and support client credential grant.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use  <code class="docutils literal"><span class="pre">&lt;oauth2:password&gt;</span></code> tag and support resource owner password credential grant.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When multiple supporting grant types are to be specified, they should be specified in the above mentioned sequence.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Authorization code is used for only the short period from issuing the authorization code till issuing the access token, hence it is managed in in-memory by default.
In case of configuration of multiple authorization servers, it should be managed in DB, in order to share authorization codes among multiple servers.
When authorization code is to be managed in DB, the following table, consisting of the column having authorization code as primary key and the column having authentication information, is created. Following example explains the DB definitions when PostgreSQL is used.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ERDiagramCode.png"><img alt="../_images/OAuth_ERDiagramCode.png" src="../_images/OAuth_ERDiagramCode.png" style="width: 30%;" /></a>
</div>
<p>Bean ID of <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.code.JdbcAuthorizationCodeServices</span></code> managing authorization code in DB is specified in <code class="docutils literal"><span class="pre">authorization-code-services-ref</span></code> of <code class="docutils literal"><span class="pre">&lt;oauth2:authorization-code&gt;</span></code> tag, in the configuration file of authorization server.
Data source to be connected to table for authorization code storage is specified in the constructor of <code class="docutils literal"><span class="pre">JdbcAuthorizationCodeServices</span></code>.
<strong>Always</strong> refer to <a class="reference internal" href="#oauthauthorizationserverhowtocontrolltarnsaction"><span class="std std-ref">Transaction control</span></a> for the precautions while managing the authorization code permanently in DB.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
     <span class="na">token-endpoint-url=</span><span class="s">&quot;/oth2/token&quot;</span>
     <span class="na">authorization-endpoint-url=</span><span class="s">&quot;/oth2/authorize&quot;</span> <span class="nt">&gt;</span>
    <span class="nt">&lt;oauth2:authorization-code</span> <span class="na">authorization-code-services-ref=</span><span class="s">&quot;authorizationCodeServices&quot;</span><span class="nt">/&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;authorizationCodeServices&quot;</span>
      <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.code.JdbcAuthorizationCodeServices&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;codeDataSource&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="client-authentication">
<span id="oauthauthorizationserverclientauthentication"></span><h4><a class="toc-backref" href="#id40">9.10.2.3.3. Client authentication</a><a class="headerlink" href="#client-authentication" title="Permalink to this headline">¶</a></h4>
<p>Clients that have accessed end points should be authenticated, in order to confirm whether they are registered clients.
Client is authenticated by verifying the client ID and password passed by client as parameters based on the client information retained by authorization server. Basic authentication is used for authentication.</p>
<p>Spring Security OAuth provides the implementation class of <code class="docutils literal"><span class="pre">oorg.springframework.security.oauth2.provider.ClientDetailsService</span></code> which is an interface for fetching the client information.
Further, <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.client.BaseClientDetails</span></code> class which is implementation class of <code class="docutils literal"><span class="pre">ClientDetails</span></code> interface is provided as a class retaining the client information.
<code class="docutils literal"><span class="pre">BaseClientDetails</span></code> provides the basic parameters such as client ID and supporting grant type etc. by using OAuth 2.0, and the parameters can be added by extending <code class="docutils literal"><span class="pre">BaseClientDetails</span></code>.
In this case, extension of <code class="docutils literal"><span class="pre">BaseClientDetails</span></code> and creation of <code class="docutils literal"><span class="pre">ClientDetailsService</span></code> implementation class is performed, and client information wherein client name is added as individual parameter is managed by using DB and the implementation method for authentication is explained.</p>
<p>At first, DB is created as below.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ERDiagram.png"><img alt="../_images/OAuth_ERDiagram.png" src="../_images/OAuth_ERDiagram.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A table to retain client information. client_id is considered as primary key.</div>
<div class="line">Roles of each column are as below.</div>
<div class="line-block">
<div class="line">・client_id: A column to retain the client ID which is an ID to identify a client.</div>
<div class="line">・client_secret: A column to retain the password which is used to authenticate the client.</div>
<div class="line">・client_name: An individual column to retain the client name. Not required since it is an individual column.</div>
<div class="line">・access_token_validity: A column to retain the validity period [seconds] of access token.</div>
<div class="line">・refresh_token_validity: A column to retain the validity period [seconds] of refresh token.</div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A table to retain the scope information. It is mapped with the client information by considering client_id as the external key.</div>
<div class="line">Scope used for client authorization is retained in scope column. Records are registered only for the scope of client.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A table to retain the resource information. It is mapped with the client information by considering client_id as the external key.</div>
<div class="line">Resource ID used in resource server for identifying whether it is a resource that can be accessed by client is retained in resource_id column.</div>
<div class="line">Access to resource is permitted, only when resource ID defined for the resource retained by resource server is included in resource ID registered here.</div>
<div class="line">Records are registered only for the resource IDs accessible by client.</div>
<div class="line">When not even single resource ID is registered, all resources can be accessed, hence precaution must be taken when it is not registered.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A table to retain the grant information. It is mapped with the client information by considering client_id as the external key.</div>
<div class="line">Grant to be used by client is retained in authorized_grant_type column.</div>
<div class="line">Records are registered only for the grant count to be used by client</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A table to retain the redirect URL information. It is mapped with the client information by considering client_id as the external key.</div>
<div class="line">web_server_redirect_uri column retains the URL that redirects user agent after authorization by resource owner.</div>
<div class="line">Redirect URLs are used only for authorization code grants, implicit grants.</div>
<div class="line">Table itself is not required, when grant types other than authorization code grant and implicit grant are used.</div>
<div class="line">An error occurs, when there is no URL declared by client at the time of authorization request and when there is no redirect URL matching with host and route path.</div>
<div class="line">Records are registered only for the URLs that can be declared by client.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>A model retaining the client information is created.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">Client.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">clientId</span><span class="o">;</span> <span class="c1">// (1)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">clientSecret</span><span class="o">;</span> <span class="c1">// (2)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">clientName</span><span class="o">;</span> <span class="c1">// (3)</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">accessTokenValidity</span><span class="o">;</span> <span class="c1">// (4)</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">refreshTokenValidity</span><span class="o">;</span> <span class="c1">// (5)</span>
    <span class="c1">// Getters and Setters are omitted</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A field to retain the client ID identifying the client.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A field to retain the password used for client authentication.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">An extended field to retain the client name which is not provided in Spring Security OAuth.</div>
<div class="line">Not required, since it is an extended field.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A field to retain the validity period [seconds] of access token.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A field to retain the validity period [seconds] of refresh token.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Detailed information of client can be extended easily by creating the class inheriting the <code class="docutils literal"><span class="pre">BaseClientDetails</span></code> class.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">OAuthClientDetails.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuthClientDetails</span> <span class="kd">extends</span> <span class="n">BaseClientDetails</span><span class="o">{</span>
    <span class="kd">private</span> <span class="n">Client</span> <span class="n">client</span><span class="o">;</span>
    <span class="c1">// Getter and Setter are omitted</span>
<span class="o">}</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.ClientDetailsService</span></code> is an interface for fetching the detailed client information required in authorization process from the data store.
Creation of <code class="docutils literal"><span class="pre">ClientDetailsService</span></code> implementation class is described below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">OAuthClientDetailsService.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;clientDetailsService&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuthClientDetailsService</span> <span class="kd">implements</span> <span class="n">ClientDetailsService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ClientRepository</span> <span class="n">clientRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">ClientDetails</span> <span class="nf">loadClientByClientId</span><span class="o">(</span><span class="n">String</span> <span class="n">clientId</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">ClientRegistrationException</span> <span class="o">{</span>

        <span class="n">Client</span> <span class="n">client</span> <span class="o">=</span> <span class="n">clientRepository</span><span class="o">.</span><span class="na">findClientByClientId</span><span class="o">(</span><span class="n">clientId</span><span class="o">);</span> <span class="c1">// (2)</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">client</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (3)</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="n">NoSuchClientException</span><span class="o">(</span><span class="s">&quot;No client with requested id: &quot;</span> <span class="o">+</span> <span class="n">clientId</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// (4)</span>
        <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">clientScopes</span> <span class="o">=</span> <span class="n">clientRepository</span><span class="o">.</span><span class="na">findClientScopesByClientId</span><span class="o">(</span><span class="n">clientId</span><span class="o">);</span>
        <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">clientResources</span> <span class="o">=</span> <span class="n">clientRepository</span><span class="o">.</span><span class="na">findClientResourcesByClientId</span><span class="o">(</span><span class="n">clientId</span><span class="o">);</span>
        <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">clientGrants</span> <span class="o">=</span> <span class="n">clientRepository</span><span class="o">.</span><span class="na">findClientGrantsByClientId</span><span class="o">(</span><span class="n">clientId</span><span class="o">);</span>
        <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">clientRedirectUris</span> <span class="o">=</span> <span class="n">clientRepository</span><span class="o">.</span><span class="na">findClientRedirectUrisByClientId</span><span class="o">(</span><span class="n">clientId</span><span class="o">);</span>


         <span class="c1">// (5)</span>
        <span class="n">OAuthClientDetails</span> <span class="n">clientDetails</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OAuthClientDetails</span><span class="o">();</span>
        <span class="n">clientDetails</span><span class="o">.</span><span class="na">setClientId</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">getClientId</span><span class="o">());</span>
        <span class="n">clientDetails</span><span class="o">.</span><span class="na">setClientSecret</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">getClientSecret</span><span class="o">());</span>
        <span class="n">clientDetails</span><span class="o">.</span><span class="na">setAccessTokenValiditySeconds</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">getAccessTokenValidity</span><span class="o">());</span>
        <span class="n">clientDetails</span><span class="o">.</span><span class="na">setRefreshTokenValiditySeconds</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">getRefreshTokenValidity</span><span class="o">());</span>
        <span class="n">clientDetails</span><span class="o">.</span><span class="na">setResourceIds</span><span class="o">(</span><span class="n">clientResources</span><span class="o">);</span>
        <span class="n">clientDetails</span><span class="o">.</span><span class="na">setScope</span><span class="o">(</span><span class="n">clientScopes</span><span class="o">);</span>
        <span class="n">clientDetails</span><span class="o">.</span><span class="na">setAuthorizedGrantTypes</span><span class="o">(</span><span class="n">clientGrants</span><span class="o">);</span>
        <span class="n">clientDetails</span><span class="o">.</span><span class="na">setRegisteredRedirectUri</span><span class="o">(</span><span class="n">clientRedirectUris</span><span class="o">);</span>
        <span class="n">clientDetails</span><span class="o">.</span><span class="na">setClient</span><span class="o">(</span><span class="n">client</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">clientDetails</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Add <code class="docutils literal"><span class="pre">&#64;Service</span></code> annotation to the class level as service in order to use it as target for component-scan.</div>
<div class="line">Specify Bean name as <code class="docutils literal"><span class="pre">clientDetailsService</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Client information fetched from database is stored in the Client model.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When the client information is not found, an exception of Spring Security OAuth - <code class="docutils literal"><span class="pre">NoSuchClientException</span></code> is generated.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch information associated with the client.</div>
<div class="line">If the process efficiency is reduced by calling Repository by dividing it for multiple times, fetch collectively in (2).</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set various types of fetched information in <code class="docutils literal"><span class="pre">OAuthClientDetails</span></code> field.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Add settings necessary for client authentication to <code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code>.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span> <span class="na">pattern=</span><span class="s">&quot;/oth2/*token*/**&quot;</span>
    <span class="na">authentication-manager-ref=</span><span class="s">&quot;clientAuthenticationManager&quot;</span> <span class="na">realm=</span><span class="s">&quot;Realm&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;sec:http-basic</span> <span class="nt">/&gt;</span>           <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;sec:csrf</span> <span class="na">disabled=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/**&quot;</span> <span class="na">access=</span><span class="s">&quot;isAuthenticated()&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>

<span class="nt">&lt;oauth2:authorization-server</span>
     <span class="na">token-endpoint-url=</span><span class="s">&quot;/oth2/token&quot;</span>
     <span class="na">authorization-endpoint-url=</span><span class="s">&quot;/oth2/authorize&quot;</span>
     <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (5) --&gt;</span>
    <span class="nt">&lt;oauth2:authorization-code</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:implicit</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:client-credentials</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:password</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>

<span class="nt">&lt;sec:authentication-manager</span> <span class="na">id=</span><span class="s">&quot;clientAuthenticationManager&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (6) --&gt;</span>
    <span class="nt">&lt;sec:authentication-provider</span> <span class="na">user-service-ref=</span><span class="s">&quot;clientDetailsUserService&quot;</span> <span class="nt">&gt;</span>  <span class="c">&lt;!-- (7) --&gt;</span>
        <span class="nt">&lt;sec:password-encoder</span> <span class="na">ref=</span><span class="s">&quot;passwordEncoder&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (8) --&gt;</span>
    <span class="nt">&lt;/sec:authentication-provider&gt;</span>
<span class="nt">&lt;/sec:authentication-manager&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;clientDetailsUserService&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.client.ClientDetailsUserDetailsService&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (9) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;clientDetailsService&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (10) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify a location below <code class="docutils literal"><span class="pre">/oth2/*token*/</span></code> as a target for access control
as an endpoint URL in order to perform  security settings for endpoint related to access token operation.</div>
<div class="line">Here, the endpoint URL acting as a access control target is set to a value starting from <code class="docutils literal"><span class="pre">/oth2/</span></code>,
endpoint URL defined by Spring Security OAuth and its default value are as below.</div>
<div class="line-block">
<div class="line">・<code class="docutils literal"><span class="pre">/oauth/token</span></code> - an endpoint URL of endpoint used in issuing a token</div>
<div class="line">・<code class="docutils literal"><span class="pre">/oauth/check_token</span></code>- an endpoint URL of endpoint used to verify a token</div>
<div class="line">・<code class="docutils literal"><span class="pre">/oauth/token_key</span></code>- an endpoint URL of endpoint used for fetching a public key, when JWT signature is created by public key encryption method</div>
</div>
<div class="line">Specify a Bean of <code class="docutils literal"><span class="pre">AuthenticationManager</span></code> for client authentication defined in (5), in <code class="docutils literal"><span class="pre">authentication-manager-ref</span></code> attribute.</div>
<div class="line">Also, when Basic authentication is enabled by XML Namespace as shown in (2), Realm name of Basic authentication becomes <code class="docutils literal"><span class="pre">&quot;Spring</span> <span class="pre">Security</span> <span class="pre">Application&quot;</span></code>.</div>
<div class="line">Specify an appropriate value in <code class="docutils literal"><span class="pre">realm</span></code> attribute since internal information of the application gets revealed.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Apply Basic authentication to client authentication.</div>
<div class="line">For details, refer <a class="reference external" href="http://docs.spring.io/spring-security/site/docs/4.1.4.RELEASE/reference/html/basic.html">http://docs.spring.io/spring-security/site/docs/4.1.4.RELEASE/reference/html/basic.html</a> .</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Disable CSRF countermeasures function for accessing <code class="docutils literal"><span class="pre">/oth2/*token*/**</span></code>.</div>
<div class="line">Spring Security OAuth adopts validity check of request wherein state parameter is used, recommended as a CSRF countermeasure of OAuth 2.0.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Settings which assign rights of access only to authenticated users, for locations under endpoint URL.</div>
<div class="line">How to specify access policy for Web resource, refer <a class="reference internal" href="Authorization.html"><span class="doc">Authorization</span></a>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify a Bean of <code class="docutils literal"><span class="pre">OAuthClientDetailsService</span></code> in <code class="docutils literal"><span class="pre">client-details-service-ref</span></code> attribute.</div>
<div class="line">BeanID to be specified must match with Bean ID specified by implementation class of <code class="docutils literal"><span class="pre">ClientDetailsService</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for <code class="docutils literal"><span class="pre">AuthenticationManager</span></code> for authentication of client.</div>
<div class="line"><code class="docutils literal"><span class="pre">AuthenticationManager</span></code> used in the authentication of resource owner and Bean ID of alias must be specified.</div>
<div class="line">For authentication of resource owner, refer <a class="reference internal" href="#oauthauthorizationserverresourceownerauthentication"><span class="std std-ref">Resource owner authentication</span></a>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify a Bean of <code class="docutils literal"><span class="pre">ClientDetailsUserDetailsService</span></code> defined in (9), in <code class="docutils literal"><span class="pre">user-service-ref</span></code> attribute of <code class="docutils literal"><span class="pre">sec:authentication-provider</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify a Bean of <code class="docutils literal"><span class="pre">PasswordEncoder</span></code> used in password hashing, which is used in client authentication.</div>
<div class="line">For details of password hashing, refer <a class="reference internal" href="Authentication.html#springsecurityauthenticationpasswordhashing"><span class="std std-ref">Password hashing</span></a>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for <code class="docutils literal"><span class="pre">ClientDetailsUserDetailsService</span></code> which is an implementation class of <code class="docutils literal"><span class="pre">UserDetailsService</span></code> interface.</div>
<div class="line"><code class="docutils literal"><span class="pre">UserDetailsService</span></code> used in the resource owner authentication and Bean ID of alias must be specified.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify a Bean of <code class="docutils literal"><span class="pre">OAuthClientDetailsService</span></code> which fetches client information from  database, in constructor argument.</div>
<div class="line">Bean ID to be specified must match with Bean ID specified by the implementation class of <code class="docutils literal"><span class="pre">ClientDetailsService</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="resource-owner-authentication">
<span id="oauthauthorizationserverresourceownerauthentication"></span><h4><a class="toc-backref" href="#id41">9.10.2.3.4. Resource owner authentication</a><a class="headerlink" href="#resource-owner-authentication" title="Permalink to this headline">¶</a></h4>
<p>When an authorization code grant is used for fetching an access token, a resource owner must be authenticated by a method like providing a login screen among others.</p>
<div class="line-block">
<div class="line">This guideline assumes the use of Spring Security for authentication of resource owner.</div>
<div class="line">A URL with an authorization end point URL must be defined in authorization settings as an access policy to enable access to authorized endpoint URL only to authenticated users.
Further, a controller URL which displays the authorization screen and a controller URL which handles exceptions in authorization endpoint must also be similarly defined as access policies.</div>
<div class="line">For the controller which displays authorization screen, refer <a class="reference internal" href="#oauthauthorizationserverhowtocustomizeauthorizeview"><span class="std std-ref">Customising scope authorization screen</span></a> and for the controller which handles exception in authorization endpoint, refer <a class="reference internal" href="#oauthauthorizationserverhowtohandleerror"><span class="std std-ref">Error handling at the time of authorization request</span></a>.</div>
</div>
<p>For details of Spring Security, refer <a class="reference internal" href="Authentication.html"><span class="doc">Authentication</span></a> and <a class="reference internal" href="Authorization.html"><span class="doc">Authorization</span></a>.</p>
<p>Definition examples of access policies which include authorization endpoint URL, a URL of controller which displays authorization and a URL of controller which handles errors of authorization endpoint are shown below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">spring-security.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span> <span class="na">authentication-manager-ref=</span><span class="s">&quot;userLoginManager&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;sec:form-login</span> <span class="na">login-page=</span><span class="s">&quot;/login&quot;</span>
        <span class="na">authentication-failure-url=</span><span class="s">&quot;/login?error=true&quot;</span>
        <span class="na">login-processing-url=</span><span class="s">&quot;/login&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:logout</span> <span class="na">logout-url=</span><span class="s">&quot;/logout&quot;</span>
        <span class="na">logout-success-url=</span><span class="s">&quot;/&quot;</span>
        <span class="na">delete-cookies=</span><span class="s">&quot;JSESSIONID&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:access-denied-handler</span> <span class="na">ref=</span><span class="s">&quot;accessDeniedHandler&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:custom-filter</span> <span class="na">ref=</span><span class="s">&quot;userIdMDCPutFilter&quot;</span> <span class="na">after=</span><span class="s">&quot;ANONYMOUS_FILTER&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:session-management</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/login/**&quot;</span> <span class="na">access=</span><span class="s">&quot;permitAll&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/oth2/**&quot;</span> <span class="na">access=</span><span class="s">&quot;isAuthenticated()&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>

 <span class="nt">&lt;sec:authentication-manager</span> <span class="na">id=</span><span class="s">&quot;userLoginManager&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;sec:authentication-provider</span>
        <span class="na">user-service-ref=</span><span class="s">&quot;userDetailsService&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;sec:password-encoder</span> <span class="na">ref=</span><span class="s">&quot;passwordEncoder&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/sec:authentication-provider&gt;</span>
<span class="nt">&lt;/sec:authentication-manager&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;userDetailsService&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.core.userdetails.jdbc.JdbcDaoImpl&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify location under root (&#8220;<code class="docutils literal"><span class="pre">/</span></code>&#8221;) as an access control target, which includes authorization endpoint URL - <code class="docutils literal"><span class="pre">/oth2/authorize</span></code>, a URL of controller which displays authorization screen - <code class="docutils literal"><span class="pre">/oauth/confirm_access</span></code> and a URL which handles errors of authorization endpoint - <code class="docutils literal"><span class="pre">/oauth/error</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify location under root (&#8220;<code class="docutils literal"><span class="pre">/</span></code>&#8221;) to enable the access only by authenticated users, which includes authorization endpoint URL - <code class="docutils literal"><span class="pre">/oth2/authorize</span></code>, a URL of controller which displays authorization screen - <code class="docutils literal"><span class="pre">/oauth/confirm_access</span></code> and a URL of controller which handles errors of authorization endpoint - <code class="docutils literal"><span class="pre">/oauth/error</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for <code class="docutils literal"><span class="pre">AuthenticationManager</span></code> for authenticating resource owner.</div>
<div class="line"><code class="docutils literal"><span class="pre">AuthenticationManager</span></code> used in client authentication and Bean ID of alias must be specified.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="authorization-for-each-scope">
<span id="oauthauthorizationserverhowtoauthorizebyscope"></span><h4><a class="toc-backref" href="#id42">9.10.2.3.5. Authorization for each scope</a><a class="headerlink" href="#authorization-for-each-scope" title="Permalink to this headline">¶</a></h4>
<p>A setup method wherein each scope is authorized individually instead of authorizing the requested scope together while requesting the authorization for resource owner, is explained.</p>
<p>Authorization information must be controlled in a DB for performing perpetual management to prevent loss of authorization information at the time of restarting authorization server or to share authorization information across multiple authorization servers.
Following DB is created for storing authorization information for each scope. The example below explains DB definition when PostgreSQL is used.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ERDiagramApprovals.png"><img alt="../_images/OAuth_ERDiagramApprovals.png" src="../_images/OAuth_ERDiagramApprovals.png" style="width: 50%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A table to retain authorization information. userId, clientId and scope are used as primary keys.</div>
<div class="line">Role of each column is as below.</div>
<div class="line-block">
<div class="line">・userId: A column to retain user name of resource owner who performs the authorization.</div>
<div class="line">・clientId: A column to retain client ID of the client authorized by the resource owner.</div>
<div class="line">・scope: A column to retain scope authorized by resource owner.</div>
<div class="line">・status: A column to check whether the authorization is done by the resource owner. <code class="docutils literal"><span class="pre">APPROVED</span></code> is set when authorized and <code class="docutils literal"><span class="pre">DENIED</span></code> is set when authorization is denied.</div>
<div class="line">・expiresAt: A column to retain validity period of authorization information.</div>
<div class="line">・lastModifiedAt: A column to retain last modified date for authorization information.</div>
</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Fetch authorization for each scope of resource owner and apply settings to store the same in DB and control.</p>
<p>Implementation example is as below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
     <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span>
     <span class="na">token-endpoint-url=</span><span class="s">&quot;/oth2/token&quot;</span>
     <span class="na">authorization-endpoint-url=</span><span class="s">&quot;/oth2/authorize&quot;</span>
     <span class="na">user-approval-handler-ref=</span><span class="s">&quot;userApprovalHandler&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

     <span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;/oauth2:authorization-server&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;userApprovalHandler&quot;</span>
      <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.approval.ApprovalStoreUserApprovalHandler&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;clientDetailsService&quot;</span> <span class="na">ref=</span><span class="s">&quot;clientDetailsService&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;approvalStore&quot;</span> <span class="na">ref=</span><span class="s">&quot;approvalStore&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;requestFactory&quot;</span> <span class="na">ref=</span><span class="s">&quot;requestFactory&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;approvalExpiryInSeconds&quot;</span> <span class="na">value=</span><span class="s">&quot;3200&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;approvalStore&quot;</span>
      <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.approval.JdbcApprovalStore&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;approvalDataSource&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;requestFactory&quot;</span>
      <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.request.DefaultOAuth2RequestFactory&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;clientDetailsService&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify a Bean of <code class="docutils literal"><span class="pre">ApprovalStoreUserApprovalHandler</span></code> defined in (2), in <code class="docutils literal"><span class="pre">user-approval-handler-ref</span></code> as <code class="docutils literal"><span class="pre">UserApprovalHandler</span></code> which performs authorization process of scope.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for <code class="docutils literal"><span class="pre">ApprovalStoreUserApprovalHandler</span></code> which performs authorization process of scope.</div>
<div class="line">Specify a Bean of <code class="docutils literal"><span class="pre">JdbcApprovalStore</span></code> defined in (3), in <code class="docutils literal"><span class="pre">approvalStore</span></code> property which manages authorization results of resource owner.</div>
<div class="line">Specify a Bean of <code class="docutils literal"><span class="pre">OAuthClientDetailsService</span></code> in <code class="docutils literal"><span class="pre">clientDetailsService</span></code> property which fetches client information to be used in authorization process of scope.</div>
<div class="line">Specify a Bean of <code class="docutils literal"><span class="pre">DefaultOAuth2RequestFactory</span></code> in <code class="docutils literal"><span class="pre">requestFactory</span></code> property.</div>
<div class="line">Bean set in <code class="docutils literal"><span class="pre">requestFactory</span></code> property is not used by <code class="docutils literal"><span class="pre">ApprovalStoreUserApprovalHandler</span></code>, however, since an error occurs at the time of Bean generation of <code class="docutils literal"><span class="pre">ApprovalStoreUserApprovalHandler</span></code> when the setting is not applied, settings in <code class="docutils literal"><span class="pre">requestFactory</span></code> property is necessary.</div>
<div class="line">When validity period [Seconds] of authorization information is to be specified, validity period [Seconds] is set in <code class="docutils literal"><span class="pre">approvalExpiryInSeconds</span></code> property. If any setting is not applied, the authorization information will remain valid a month from authorization.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for <code class="docutils literal"><span class="pre">JdbcApprovalStore</span></code> which manages authorization information in DB.</div>
<div class="line">Specify a database in the constructor to connect to the table for storing authorization information.</div>
<div class="line">For precautions while performing perpetual management of authorization information in DB, <strong>always</strong> refer <a class="reference internal" href="#oauthauthorizationserverhowtocontrolltarnsaction"><span class="std std-ref">Transaction control</span></a>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When perpetual management is not required to be performed for authorization information and is to be managed by in-memory instead of a DB, a Bean is to be defined for <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.approval.InMemoryApprovalStore</span></code> as <code class="docutils literal"><span class="pre">approvalStore</span></code>.</p>
</div>
</div>
<div class="section" id="customising-scope-authorization-screen">
<span id="oauthauthorizationserverhowtocustomizeauthorizeview"></span><h4><a class="toc-backref" href="#id43">9.10.2.3.6. Customising scope authorization screen</a><a class="headerlink" href="#customising-scope-authorization-screen" title="Permalink to this headline">¶</a></h4>
<p>When the scope authorization screen is to be customised, it can be done by creating controller and JSP. An example is explained below wherein the scope authorization screen is customised.</p>
<p>When an endpoint which requests authorization to resource owner is to be called, it is forwarded to (context path)/oauth/confirm_access.
A controller which handles (context path)/oauth/confirm_access is created.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">OAuth2ApprovalController.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2ApprovalController</span> <span class="o">{</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/oauth/confirm_access&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">confirmAccess</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// omitted</span>
        <span class="k">return</span> <span class="s">&quot;approval/oauthConfirm&quot;</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use <code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code> annotation and perform mapping as a method for accessing <code class="docutils literal"><span class="pre">&quot;/oauth/confirm_access&quot;</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Next, a JSP of scope authorization screen is created.
Since scope for authorization is registered in the Model by <code class="docutils literal"><span class="pre">scopes</span></code> key, scope authorization screen is displayed by using the same.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauthConfirm.jsp</span></code></li>
</ul>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="k">&lt;%@</span> <span class="n">taglib</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;sec&quot;</span> <span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://www.springframework.org/security/tags&quot;</span> <span class="k">%&gt;</span>

<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>OAuth Approval<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;p&gt;</span>Do you authorize &#39;${f:h(authorizationRequest.clientId)}&#39; to access your protected resources?<span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">&#39;confirmationForm&#39;</span> <span class="na">name=</span><span class="s">&#39;confirmationForm&#39;</span> <span class="na">action=</span><span class="s">&#39;${pageContext.request.contextPath}/oth2/authorize&#39;</span> <span class="na">method=</span><span class="s">&#39;post&#39;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;c:forEach</span> <span class="na">var=</span><span class="s">&quot;scope&quot;</span> <span class="na">items=</span><span class="s">&quot;${scopes}&quot;</span> <span class="na">varStatus=</span><span class="s">&quot;status&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
                <span class="nt">&lt;li&gt;</span>
                    ${f:h(scope.key)}  <span class="c">&lt;!-- (2) --&gt;</span>
                    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&#39;radio&#39;</span> <span class="na">name=</span><span class="s">&quot;${f:h(scope.key)}&quot;</span> <span class="na">value=</span><span class="s">&#39;true&#39;</span><span class="nt">/&gt;</span>Approve
                    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&#39;radio&#39;</span> <span class="na">name=</span><span class="s">&quot;${f:h(scope.key)}&quot;</span> <span class="na">value=</span><span class="s">&#39;false&#39;</span><span class="nt">/&gt;</span>Deny
                <span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;/c:forEach&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&#39;user_oauth_approval&#39;</span> <span class="na">value=</span><span class="s">&#39;true&#39;</span> <span class="na">type=</span><span class="s">&#39;hidden&#39;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
            <span class="nt">&lt;sec:csrfInput</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (4) --&gt;</span>
            <span class="nt">&lt;label&gt;</span>
                <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&#39;authorize&#39;</span> <span class="na">value=</span><span class="s">&#39;Authorize&#39;</span> <span class="na">type=</span><span class="s">&#39;submit&#39;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;/form&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Output a radio button for specifying authorization for each scope. Since target scope is included in <code class="docutils literal"><span class="pre">scopes</span></code> list, specify <code class="docutils literal"><span class="pre">scopes</span></code> in <code class="docutils literal"><span class="pre">items</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Since key names of elements which retain <code class="docutils literal"><span class="pre">scopes</span></code> list are used as respective scope names, key names are displayed on the screen.</div>
<div class="line">Set output of Approve and Deny radio buttons for selecting &#8220;Authorise&#8221; and &#8220;Deny&#8221;.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring Security OAuth assigns <code class="docutils literal"><span class="pre">user_oauth_approval</span></code> to the request parameter by embedding <code class="docutils literal"><span class="pre">user_oauth_approval</span></code> as a hidden item.</div>
<div class="line"><code class="docutils literal"><span class="pre">user_oauth_approval</span></code> assigned to the request parameter can be used for executing a method which performs scope authorization of authorization endpoint.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify <code class="docutils literal"><span class="pre">&lt;sec:csrfInput&gt;</span></code> element in <code class="docutils literal"><span class="pre">&lt;form&gt;</span></code> element of HTML in order to deliver CSRF.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="error-handling-at-the-time-of-authorization-request">
<span id="oauthauthorizationserverhowtohandleerror"></span><h4><a class="toc-backref" href="#id44">9.10.2.3.7. Error handling at the time of authorization request</a><a class="headerlink" href="#error-handling-at-the-time-of-authorization-request" title="Permalink to this headline">¶</a></h4>
<p>When an authorization error (error related to security like &#8220;client does not exist&#8221; or redirect URL check error) occurs in authorization end point, <code class="docutils literal"><span class="pre">OAuth2Exception</span></code> offered by Spring Security OAuth is thrown and the request (context path) /oauth/error is forwarded.
Hence, when exception in authorization end point is to be handled, a controller to handle (context path)/oauth/error must be created.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">OAuth2ErrorController.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2ErrorController</span> <span class="o">{</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/oauth/error&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">handleError</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// omitted</span>
        <span class="k">return</span> <span class="s">&quot;common/error/oauthError&quot;</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use <code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code> annotation and perform mapping as a method for accessing <code class="docutils literal"><span class="pre">&quot;/oauth/error&quot;</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Next, a JSP of error screen thus displayed is created.
Since details of error occurred in authorization end point are registered in the Model by <code class="docutils literal"><span class="pre">error</span></code> key, error details are displayed on the screen using the same.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauthError.jsp</span></code></li>
</ul>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;title&gt;</span>OAuth Error!<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span>
    <span class="na">href=</span><span class="s">&quot;${pageContext.request.contextPath}/resources/app/css/styles.css&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>OAuth Error!<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;p&gt;</span>${f:h(error.OAuth2ErrorCode)}<span class="nt">&lt;/p&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;p&gt;</span>${f:h(error.message)}<span class="nt">&lt;/p&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Output error response included in <code class="docutils literal"><span class="pre">error</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Output error message included in <code class="docutils literal"><span class="pre">error</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When an error other than authorization error (error related to security error like &#8220;client does not exist&#8221;, redirect URL check error etc) occur in authorization endpoint,
errors are notified on the client side after redirecting.</p>
</div>
</div>
<div class="section" id="how-to-share-access-token-with-resource-server">
<span id="oauthauthorizationserverhowtoconfigureaccesstoken"></span><h4><a class="toc-backref" href="#id45">9.10.2.3.8. How to share access token with resource server</a><a class="headerlink" href="#how-to-share-access-token-with-resource-server" title="Permalink to this headline">¶</a></h4>
<p>Authorization server links with the access token via <code class="docutils literal"><span class="pre">TokenServices</span></code> so that the resource server can determine the authorization for accessing a resource based on access token.
Various methods exist for methods for linking.</p>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Method of linking</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Linking via DB</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method wherein a common DB is used and access token is linked.</div>
<div class="line">It can be used when resource server and authorization server share a DB.</div>
<div class="line">Authorization server specifies <code class="docutils literal"><span class="pre">DefaultTokenServices</span></code> as an implementation of TokenService, and <code class="docutils literal"><span class="pre">JdbcTokenStore</span></code> as an implementation of TokenStore.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Linking via HTTP access</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method wherein access token is linked by accessing HTTP.</div>
<div class="line">This method is used when resource server and authorization server cannot use a common DB.</div>
<div class="line">Since the resource server requests the fetching and verification of access token to authorization server, authorization server is overloaded.</div>
<div class="line">Authorization server specifies <code class="docutils literal"><span class="pre">DefaultTokenServices</span></code> as an implementation of TokenService.</div>
<div class="line">Specify <code class="docutils literal"><span class="pre">JdbcTokenStore</span></code> when the access token is to be managed by DB and <code class="docutils literal"><span class="pre">InMemoryTokenStore</span></code> when it is to be managed by memory, as an implementation of TokenStore.</div>
<div class="line">Implementation wherein the access token is managed by memory is exclusively for testing purpose since access tokens are lost due to operations like restarting a server etc.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Linking via JWT</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method wherein JWT is used and access token is linked.</div>
<div class="line">This method is used when resource server and authorization server cannot use a common DB.</div>
<div class="line">Since request is not sent to authorization server for fetching an access token, when compared with linking via HTTP access, authorization server is not overloaded.</div>
<div class="line">Authorization server specifies <code class="docutils literal"><span class="pre">DefaultTokenServices</span></code> as an implementation of TokenService and <code class="docutils literal"><span class="pre">JwtTokenStore</span></code> as an implementation of TokenStore.</div>
<div class="line">Access token is signed, encoded and decoded by using <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter</span></code>.</div>
<div class="line">There are two methods for signing and verification of access token - a method which uses public key and a method which uses common key.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Linking via memory</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method wherein access token is linked by sharing the memory.</div>
<div class="line">It can be used when an application is designed wherein resource server and authorization server become a single process.</div>
<div class="line">Authorization server specifies <code class="docutils literal"><span class="pre">DefaultTokenServices</span></code> as an implementation of TokenService and <code class="docutils literal"><span class="pre">InMemoryTokenStore</span></code> as an implementation of TokenStore.</div>
<div class="line">Since the access token is linked via memory, linking of access token using common DB and HTTP access is not necessary.</div>
<div class="line">Implementation wherein the access token is shared via memory is exclusively for testing purpose since access tokens are lost due to operations like restarting the server etc.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p class="last">How to implement linking by using JWT will be explained in detail in next version.</p>
</div>
<p>Here, a method wherein access token is linked via common DB is explained as a representative method.
A method to link via HTTP access is explained in How To Extend of this section.</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="#oauthauthorizationserverhowtocooperatewithhttp"><span class="std std-ref">Linkage through HTTP access</span></a></li>
</ul>
</div></blockquote>
<p>When access token is linked via a common DB, <code class="docutils literal"><span class="pre">JdbcTokenStore</span></code> offered by Spring Security OAuth is used.</p>
<p>Implementation example is as below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
     <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span>
     <span class="na">token-endpoint-url=</span><span class="s">&quot;/oth2/token&quot;</span>
     <span class="na">authorization-endpoint-url=</span><span class="s">&quot;/oth2/authorize&quot;</span>
     <span class="na">user-approval-handler-ref=</span><span class="s">&quot;userApprovalHandler&quot;</span>
     <span class="na">token-services-ref=</span><span class="s">&quot;tokenServices&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;oauth2:authorization-code</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:implicit</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:client-credentials</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:password</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;tokenServices&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.DefaultTokenServices&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;tokenStore&quot;</span> <span class="na">ref=</span><span class="s">&quot;tokenStore&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;clientDetailsService&quot;</span> <span class="na">ref=</span><span class="s">&quot;clientDetailsService&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;supportRefreshToken&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;tokenStore&quot;</span>
  <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.store.JdbcTokenStore&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
  <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;tokenDataSource&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify <code class="docutils literal"><span class="pre">tokenServices</span></code> defined in (2) in <code class="docutils literal"><span class="pre">token-services-ref</span></code> attribute as TokenService used by authorization server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify <code class="docutils literal"><span class="pre">DefaultTokenServices</span></code> in <code class="docutils literal"><span class="pre">tokenServices</span></code> class.</div>
<div class="line">Specify <code class="docutils literal"><span class="pre">TokenStore</span></code> defined in (4), in <code class="docutils literal"><span class="pre">tokenStore</span></code> property as the token store which manages access tokens.</div>
<div class="line">This setting is applied to resource server as well when the access token is linked with resource server via common DB.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify <code class="docutils literal"><span class="pre">true</span></code> in <code class="docutils literal"><span class="pre">supportRefreshToken</span></code> attribute when refresh token is enabled.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for <code class="docutils literal"><span class="pre">JdbcTokenStore</span></code> as the token store.</div>
<div class="line">Specify a data source in the constructor for connecting to a table wherein token information is stored.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><code class="docutils literal"><span class="pre">JdbcTokenStore</span></code> creates following DB wherein a schema is defined for Spring Security OAuth, for linking the access tokens.
The example below explains the DB definition while using PostgreSQL as a common DB.</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/OAuth_ERDiagramToken.png"><img alt="../_images/OAuth_ERDiagramToken.png" src="../_images/OAuth_ERDiagramToken.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A table which manages the access token. It is used to share information of access token issued by authorization server with the resource server.</div>
<div class="line">Roles of each column are as below.</div>
<div class="line-block">
<div class="line">・authentication_id: A column to store authentication key which uniquely identifies authentication information. It is used as a primary key.</div>
<div class="line">・token: A column which retains token information as a binary after serializing. Validity period of access token, scope, token ID of access token, token ID of refresh token, token type which shows types of token to be used are stored as information of the token to be retained.</div>
<div class="line">・token_id: A column to retain token ID which uniquely identifies access token.</div>
<div class="line">・user_name: A column to retain user name of authenticated resource owner.</div>
<div class="line">・client_id: A column to retain client ID of authenticated client.</div>
<div class="line">・authentication: A column which retains authentication information of resource owner and client as a binary after serializing.</div>
<div class="line">・refresh_token: A column which retains token ID of refresh token associated with access token.</div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A table which manages refresh token associated with access token.</div>
<div class="line">Roles of each column are as given below.</div>
<div class="line-block">
<div class="line">・token_id: A column to retain token ID which uniquely identifies refresh token. It is used as a primary key.</div>
<div class="line">・token: A column which retains token information as binary after serializing. It retains validity period of refresh token.</div>
<div class="line">・authentication: A column that retains authentication information of resource owner and client as binary after serializing. Information same as authentication information retained by table which manages access tokens, is retained.</div>
</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When the token is managed by common DB, the expired token is deleted within the timing of use of access token by client.
Therefore, even if token has expired, access token is deleted only when it is accessed by the client.
Expired tokens must be purged separately by batch processing in order to delete the same from DB.</p>
</div>
</div>
<div class="section" id="canceling-a-token-authorization-server">
<span id="oauthauthorizationserverhowtocanceltoken"></span><h4><a class="toc-backref" href="#id46">9.10.2.3.9. Canceling a token (authorization server)</a><a class="headerlink" href="#canceling-a-token-authorization-server" title="Permalink to this headline">¶</a></h4>
<p>How to implement cancellation of issued access token is explained.</p>
<p>Access token can be cancelled by calling <code class="docutils literal"><span class="pre">revokeToken</span></code> method of a class
which implements <code class="docutils literal"><span class="pre">ConsumerTokenService</span></code> interface.
<code class="docutils literal"><span class="pre">DefaultTokenService</span></code> class implements <code class="docutils literal"><span class="pre">ConsumerTokenService</span></code> interface.</p>
<p>Authorization information can be deleted as well at the time of cancellation of access token.
When authorization request is sent without deleting authorization information after cancellation of access token while using authorization code grant and implicit grant, authorization information at the time of previous authorization request is reused.
Authorization information at the time of previous authorization request can be reused when validity period of authorization information is valid and entire authorization request scope is authorized.</p>
<p>Implementation example is given below.</p>
<p>An interface of service class which cancels a token and implementation class are created.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">RevokeTokenService.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RevokeTokenService</span> <span class="o">{</span>

    <span class="n">String</span> <span class="nf">revokeToken</span><span class="o">(</span><span class="n">String</span> <span class="n">tokenValue</span><span class="o">,</span> <span class="n">String</span> <span class="n">clientId</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">RevokeTokenServiceImpl.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RevokeTokenServiceImpl</span> <span class="kd">implements</span> <span class="n">RevokeTokenService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ConsumerTokenServices</span> <span class="n">consumerService</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="nd">@Inject</span>
    <span class="n">TokenStore</span> <span class="n">tokenStore</span><span class="o">;</span> <span class="c1">// (2)</span>

    <span class="nd">@Inject</span>
    <span class="n">ApprovalStore</span> <span class="n">approvalStore</span><span class="o">;</span> <span class="c1">// (3)</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">revokeToken</span><span class="o">(</span><span class="n">String</span> <span class="n">tokenValue</span><span class="o">,</span> <span class="n">String</span> <span class="n">clientId</span><span class="o">){</span> <span class="c1">// (4)</span>
        <span class="c1">// (5)</span>
        <span class="n">OAuth2Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="n">tokenStore</span><span class="o">.</span><span class="na">readAuthentication</span><span class="o">(</span><span class="n">tokenValue</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">authentication</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">clientId</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">authentication</span><span class="o">.</span><span class="na">getOAuth2Request</span><span class="o">().</span><span class="na">getClientId</span><span class="o">()))</span> <span class="o">{</span> <span class="c1">// (6)</span>
                <span class="c1">// (7)</span>
                <span class="n">Authentication</span> <span class="n">user</span> <span class="o">=</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getUserAuthentication</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Approval</span><span class="o">&gt;</span> <span class="n">approvals</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Approval</span><span class="o">&gt;();</span>
                    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">scope</span> <span class="o">:</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getOAuth2Request</span><span class="o">().</span><span class="na">getScope</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">approvals</span><span class="o">.</span><span class="na">add</span><span class="o">(</span>
                                <span class="k">new</span> <span class="n">Approval</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">clientId</span><span class="o">,</span> <span class="n">scope</span><span class="o">,</span> <span class="k">new</span> <span class="n">Date</span><span class="o">(),</span> <span class="n">ApprovalStatus</span><span class="o">.</span><span class="na">APPROVED</span><span class="o">));</span>
                    <span class="o">}</span>
                    <span class="n">approvalStore</span><span class="o">.</span><span class="na">revokeApprovals</span><span class="o">(</span><span class="n">approvals</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">consumerService</span><span class="o">.</span><span class="na">revokeToken</span><span class="o">(</span><span class="n">tokenValue</span><span class="o">);</span> <span class="c1">// (8)</span>
                <span class="k">return</span> <span class="s">&quot;success&quot;</span><span class="o">;</span>

            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">return</span> <span class="s">&quot;invalid client&quot;</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">&quot;invalid token&quot;</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inject implementation class of <code class="docutils literal"><span class="pre">ConsumerTokenService</span></code> interface which cancels access tokens.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inject implementation class of <code class="docutils literal"><span class="pre">TokenStore</span></code> used to fetch authentication information while issuing an access token.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inject implementation class of <code class="docutils literal"><span class="pre">ApprovalStore</span></code> used to fetch authorization information while issuing an access token.</div>
<div class="line">It is not required when authorization information is not to be deleted while cancelling an access token.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Receive value of access token to be cancelled and client ID used for checking the client as parameters.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call <code class="docutils literal"><span class="pre">readAuthentication</span></code> method of implementation class of <code class="docutils literal"><span class="pre">TokenStore</span></code> and fetch authentication information while issuing an access token.</div>
<div class="line">Token is deleted only when authentication information can be successfully fetched.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch client ID used at the time of issuing access token, from authentication information and check whether it matches with client ID of request parameter.</div>
<div class="line">Delete access token only when it matches with client ID at the time of issuing an access token.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch authentication information of resource owner at the time of issuing an access token.</div>
<div class="line">When authentication information of resource owner could be fetched, call <code class="docutils literal"><span class="pre">revokeApprovals</span></code> method of implementation class of <code class="docutils literal"><span class="pre">TokenStore</span></code> and delete authorization information.</div>
<div class="line">Since authentication information for resource owner does not exist while using client credential grant, the parameters to be passed to <code class="docutils literal"><span class="pre">revokeApprovals</span></code> method cannot be generated.</div>
<div class="line">Therefore, authorization information cannot be deleted when it is not possible to fetch authentication information of resource owner.</div>
<div class="line">This process is not required when authorization information is not deleted while cancelling the access token.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call <code class="docutils literal"><span class="pre">revokeToken</span></code> method of implementation class <code class="docutils literal"><span class="pre">ConsumerTokenService</span></code> and delete access token and refresh token associated with access token.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>A controller which receives a cancellation request of token is created.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">TokenRevocationRestController.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;oth2&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TokenRevocationRestController</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">RevokeTokenService</span> <span class="n">revokeTokenService</span><span class="o">;</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;tokens/revoke&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">revoke</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;token&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">token</span><span class="o">,</span>
        <span class="nd">@AuthenticationPrincipal</span> <span class="n">UserDetails</span> <span class="n">user</span><span class="o">){</span>

        <span class="c1">// (2)</span>
        <span class="n">String</span> <span class="n">clientId</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getUsername</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">revokeTokenService</span><span class="o">.</span><span class="na">revokeToken</span><span class="o">(</span><span class="n">token</span><span class="o">,</span> <span class="n">clientId</span><span class="o">);</span> <span class="c1">// (3)</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. no.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use <code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code> annotation and map as a method for accessing <code class="docutils literal"><span class="pre">&quot;/oth2/tokens/revoke&quot;</span></code>.</div>
<div class="line">The path specified here must apply Basic authentication and disable CSRF countermeasures, similar to settings performed in <a class="reference internal" href="#oauthauthorizationserverclientauthentication"><span class="std std-ref">Client authentication</span></a>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch client ID used while checking the cancellation of token, from authentication information generated in Basic authentication.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Call <code class="docutils literal"><span class="pre">RevokeTokenService</span></code> and delete a token.</div>
<div class="line">Pass value of access token received as the request parameter and client ID received from authentication information as parameters.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">RFC 7009 states that <code class="docutils literal"><span class="pre">token_type_hint</span></code> can be arbitrarily assigned as a request parameter.
<code class="docutils literal"><span class="pre">token_type_hint</span></code> is a hint to determine whether to delete access token or refresh token.
<code class="docutils literal"><span class="pre">ConsumerTokenService</span></code> offered by Spring Security OAuth is not used in the implementation example above in order to delete both access token and refresh token by passing the access token.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The client which requests deletion of token to the authorization server should also delete a token retained by the client after deletion of authorization server.
For deletion of token of client server, refer <a class="reference internal" href="#oauthclientserverhowtocanceltoken"><span class="std std-ref">Cancellation of token (Client server)</span></a>.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="transaction-control">
<span id="oauthauthorizationserverhowtocontrolltarnsaction"></span><h4><a class="toc-backref" href="#id47">9.10.2.3.10. Transaction control</a><a class="headerlink" href="#transaction-control" title="Permalink to this headline">¶</a></h4>
<p>It explains precautions of transaction control in authorization server.</p>
<p>When the information handled by Spring Security Auth (authorization code, authorization information, token) is to be managed in DB, for authorization server, transaction control must be considered.</p>
<p>Default implementation of <code class="docutils literal"><span class="pre">AuthorizationServerTokenServices</span></code> - <code class="docutils literal"><span class="pre">DefaultTokenServices</span></code> contains a method to issue access token and refresh token.
These methods can be called under transaction control by assigning <code class="docutils literal"><span class="pre">&#64;Transactional</span></code> to <code class="docutils literal"><span class="pre">createAccessToken</span></code> and <code class="docutils literal"><span class="pre">refreshAccessToken</span></code> respectively, however, the operation otherwise becomes non-transactional control.</p>
<p>Hence, when <code class="docutils literal"><span class="pre">Connection</span></code> fetched from  <code class="docutils literal"><span class="pre">DataSource</span></code> is set to <code class="docutils literal"><span class="pre">autoCommit=false</span></code>, transaction control is imperative since information to be managed is not registered in DB.
Further, although it is not mandatory when <code class="docutils literal"><span class="pre">autoCommit=true</span></code>, adequate care must be taken since it is necessary to consider transaction control to ensure data consistency.</p>
<p>An example of transaction control when authorization code and authorization information are managed in DB is shown below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;tx:advice</span> <span class="na">id=</span><span class="s">&quot;oauthTransactionAdvice&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;tx:attributes&gt;</span>
        <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">&quot;*&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/tx:attributes&gt;</span>
<span class="nt">&lt;/tx:advice&gt;</span>

<span class="nt">&lt;aop:config&gt;</span>
    <span class="nt">&lt;aop:pointcut</span> <span class="na">id=</span><span class="s">&quot;authorizationOperation&quot;</span>
                  <span class="na">expression=</span><span class="s">&quot;execution(* org.springframework.security.oauth2.provider.code.AuthorizationCodeServices.*(..))&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;aop:pointcut</span> <span class="na">id=</span><span class="s">&quot;approvalOperation&quot;</span>
                  <span class="na">expression=</span><span class="s">&quot;execution(* org.springframework.security.oauth2.provider.approval.UserApprovalHandler.*(..))&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;aop:advisor</span> <span class="na">pointcut-ref=</span><span class="s">&quot;authorizationOperation&quot;</span> <span class="na">advice-ref=</span><span class="s">&quot;oauthTransactionAdvice&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;aop:advisor</span> <span class="na">pointcut-ref=</span><span class="s">&quot;approvalOperation&quot;</span> <span class="na">advice-ref=</span><span class="s">&quot;oauthTransactionAdvice&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/aop:config&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use AOP and set transaction boundary in each method which operates authorization code.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Use AOP and set transaction boundary in each method which operates authorization information.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="implementation-of-resource-server">
<h3><a class="toc-backref" href="#id48">9.10.2.4. Implementation of resource server</a><a class="headerlink" href="#implementation-of-resource-server" title="Permalink to this headline">¶</a></h3>
<p>Here, how to implement a resource server is explained by using implementation example wherein authorization is set for REST API of TODO resource.</p>
<div class="section" id="creating-a-setup-file-resource-server">
<h4><a class="toc-backref" href="#id49">9.10.2.4.1. Creating a setup file (resource server)</a><a class="headerlink" href="#creating-a-setup-file-resource-server" title="Permalink to this headline">¶</a></h4>
<p>A new Bean definition file for OAuth 2.0 is created while implementing a resource server.</p>
<p>Here, it is <code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code>.</p>
<p>Following settings are added to <code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code>.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xmlns:oauth2=</span><span class="s">&quot;http://www.springframework.org/schema/security/oauth2&quot;</span>
       <span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/security</span>
<span class="s">           http://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">           http://www.springframework.org/schema/security/oauth2</span>
<span class="s">           http://www.springframework.org/schema/security/spring-security-oauth2.xsd</span>
<span class="s">           http://www.springframework.org/schema/beans</span>
<span class="s">           http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;sec:http</span> <span class="na">pattern=</span><span class="s">&quot;/api/v1/todos/**&quot;</span> <span class="na">create-session=</span><span class="s">&quot;stateless&quot;</span>
                   <span class="na">entry-point-ref=</span><span class="s">&quot;oauth2AuthenticationEntryPoint&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;sec:access-denied-handler</span> <span class="na">ref=</span><span class="s">&quot;oauth2AccessDeniedHandler&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;sec:csrf</span> <span class="na">disabled=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
        <span class="nt">&lt;sec:custom-filter</span> <span class="na">ref=</span><span class="s">&quot;oauth2AuthenticationFilter&quot;</span>
                                <span class="na">before=</span><span class="s">&quot;PRE_AUTH_FILTER&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
    <span class="nt">&lt;/sec:http&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;oauth2AccessDeniedHandler&quot;</span>
              <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.error.OAuth2AccessDeniedHandler&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (5) --&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;oauth2AuthenticationEntryPoint&quot;</span>
              <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.error.OAuth2AuthenticationEntryPoint&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (6) --&gt;</span>

    <span class="nt">&lt;oauth2:resource-server</span> <span class="na">id=</span><span class="s">&quot;oauth2AuthenticationFilter&quot;</span> <span class="na">resource-id=</span><span class="s">&quot;todoResource&quot;</span>
              <span class="na">token-services-ref=</span><span class="s">&quot;tokenServices&quot;</span> <span class="na">entry-point-ref=</span><span class="s">&quot;oauth2AuthenticationEntryPoint&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (7) --&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the pattern on path that is the target of authorization setting of OAuth 2.0 in  <code class="docutils literal"><span class="pre">pattern</span></code> attribute.</div>
<div class="line">Specify the Bean of <code class="docutils literal"><span class="pre">OAuth2AuthenticationEntryPoint</span></code> in  <code class="docutils literal"><span class="pre">entry-point-ref</span></code>. Settings are required for definition, however the specified Bean is not used.
Actually, the Bean of <code class="docutils literal"><span class="pre">OAuth2AuthenticationEntryPoint</span></code> specified in <code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code> described later is used.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set the Bean of <code class="docutils literal"><span class="pre">OAuth2AccessDeniedHandler</span></code> in <code class="docutils literal"><span class="pre">access-denied-handler</span></code>. Here, <code class="docutils literal"><span class="pre">oauth2AccessDeniedHandler</span></code> described later is specified.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Disable the CSRF since error occurs if the POST, PUT, DELETE requests are received by CSRF token check.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the authentication filter for resource server in <code class="docutils literal"><span class="pre">custom-filter</span></code>. Here <code class="docutils literal"><span class="pre">oauth2AuthenticationFilter</span></code> described later is specified.</div>
<div class="line"><code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code> is set as per this specification.</div>
<div class="line">Since <code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code> is a filter for performing Pre-Authentication by using access token included in request,</div>
<div class="line">Set in such a way that <code class="docutils literal"><span class="pre">OAuth2AuthenticationProcessingFilter</span></code> process is executed before <code class="docutils literal"><span class="pre">PRE_AUTH_FILTER</span></code> by specifying <code class="docutils literal"><span class="pre">PRE_AUTH_FILTER</span></code> in  <code class="docutils literal"><span class="pre">before</span></code>.</div>
<div class="line">For Pre-Authentication, refer  <a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.0.x/reference/preauth.html">http://docs.spring.io/spring-security/site/docs/3.0.x/reference/preauth.html</a>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define <code class="docutils literal"><span class="pre">AccessDeniedHandler</span></code> for resource server provided by Spring Security OAuth.</div>
<div class="line"> <code class="docutils literal"><span class="pre">OAuth2AccessDeniedHandler</span></code> sends the error response by handling the exceptions that occur at the time of authorization error.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define the Bean of <code class="docutils literal"><span class="pre">OAuth2AuthenticationEntryPoint</span></code> for sending the error response for OAuth.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define the ServletFilter for the resource server provided by Spring Security OAuth.</div>
<div class="line">The string specified in <code class="docutils literal"><span class="pre">id</span></code> attribute is the Bean ID. Here,``oauth2AuthenticationFilter`` is specified.</div>
<div class="line">Specify the resource ID provided by server in <code class="docutils literal"><span class="pre">resource-id</span></code> attribute. Here, <code class="docutils literal"><span class="pre">todoResource</span></code> is specified.</div>
<div class="line">It is verified whether the resource ID specified in <code class="docutils literal"><span class="pre">resource-id</span></code> attribute is included for the resource ID of client information linked to access token.</div>
<div class="line">As a result of verification, it is allowed to access the resource only when resource ID is included.</div>
<div class="line">Note that, definition of <code class="docutils literal"><span class="pre">resource-id</span></code>  is optional and when it is not defined, resource ID is not verified.</div>
<div class="line">Specify the ID of <code class="docutils literal"><span class="pre">TokenServices</span></code> in <code class="docutils literal"><span class="pre">token-services-ref</span></code> attribute. <code class="docutils literal"><span class="pre">TokenServices</span></code> is described later.</div>
<div class="line">Specify the Bean of <code class="docutils literal"><span class="pre">OAuth2AuthenticationEntryPoint</span></code> in  <code class="docutils literal"><span class="pre">entry-point-reff</span></code> attribute. Here, <code class="docutils literal"><span class="pre">oauth2AuthenticationEntryPoint</span></code> is specified.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Add the settings in  <code class="docutils literal"><span class="pre">web.xml</span></code> so as to read a created  <code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code>.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">web.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;context-param&gt;</span>
    <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
    <span class="nt">&lt;param-value&gt;</span>
        classpath*:META-INF/spring/applicationContext.xml
        classpath*:META-INF/spring/oauth2-resource.xml <span class="c">&lt;!-- (1) --&gt;</span>
        classpath*:META-INF/spring/spring-security.xml
    <span class="nt">&lt;/param-value&gt;</span>
<span class="nt">&lt;/context-param&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">First read oauth2-resource.xml considering that the path including the path pattern set in oauth2-resource.xml is set as the access control target in <code class="docutils literal"><span class="pre">spring-security.xml</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="setting-of-accessible-scope-for-the-resource">
<h4><a class="toc-backref" href="#id50">9.10.2.4.2. Setting of accessible scope for the resource</a><a class="headerlink" href="#setting-of-accessible-scope-for-the-resource" title="Permalink to this headline">¶</a></h4>
<p>In order to define the accessible scope for each resource, add the scope definition and Bean
definition for supporting SpEL expression in Bean definition file for OAuth 2.0.</p>
<p>Implementation example is as given below.
Note that, Basic authentication is not performed for the Client in the settings of access control since it is assumed that the security between authorization server and resource is secured.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xmlns:oauth2=</span><span class="s">&quot;http://www.springframework.org/schema/security/oauth2&quot;</span>
       <span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/security</span>
<span class="s">           http://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">           http://www.springframework.org/schema/security/oauth2</span>
<span class="s">           http://www.springframework.org/schema/security/spring-security-oauth2.xsd</span>
<span class="s">           http://www.springframework.org/schema/beans</span>
<span class="s">           http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;sec:http</span> <span class="na">pattern=</span><span class="s">&quot;/api/v1/todos/**&quot;</span> <span class="na">create-session=</span><span class="s">&quot;stateless&quot;</span>
                   <span class="na">entry-point-ref=</span><span class="s">&quot;oauth2AuthenticationEntryPoint&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;sec:access-denied-handler</span> <span class="na">ref=</span><span class="s">&quot;oauth2AccessDeniedHandler&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;sec:csrf</span> <span class="na">disabled=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;sec:expression-handler</span> <span class="na">ref=</span><span class="s">&quot;oauth2ExpressionHandler&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/**&quot;</span> <span class="na">method=</span><span class="s">&quot;GET&quot;</span>
                                <span class="na">access=</span><span class="s">&quot;#oauth2.hasScope(&#39;READ&#39;)&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/**&quot;</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span>
                                <span class="na">access=</span><span class="s">&quot;#oauth2.hasScope(&#39;CREATE&#39;)&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;sec:custom-filter</span> <span class="na">ref=</span><span class="s">&quot;oauth2ProviderFilter&quot;</span>
                                <span class="na">before=</span><span class="s">&quot;PRE_AUTH_FILTER&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/sec:http&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;oauth2:web-expression-handler</span> <span class="na">id=</span><span class="s">&quot;oauth2ExpressionHandler&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify a Bean of <code class="docutils literal"><span class="pre">OAuth2WebSecurityExpressionHandler</span></code> in  <code class="docutils literal"><span class="pre">expression-handler</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define access policy as per the scope for the resource by using <code class="docutils literal"><span class="pre">intercept-url</span></code>.</div>
<div class="line">Specify the path pattern of resource to be retained in <code class="docutils literal"><span class="pre">pattern</span></code> attribute. In this implementation example, resource is retained under /api/v1/todos/.</div>
<div class="line">Specify the HTTP method of resource in  <code class="docutils literal"><span class="pre">method</span></code> attribute.</div>
<div class="line">Specify the scope that authorizes the access to resource in <code class="docutils literal"><span class="pre">access</span></code> attribute. Differentiate the setting value by upper-case and lower case characters.</div>
<div class="line">Here, it is specified by using SpEL expression.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define the Bean of  <code class="docutils literal"><span class="pre">OAuth2WebSecurityExpressionHandler</span></code>.</div>
<div class="line">SpeL for performing OAuth 2.0 authorization setting provided by Spring Security OAuth is supported by defining this Bean.</div>
<div class="line">Note that, the value specified in <code class="docutils literal"><span class="pre">id</span></code> attribute is the id for this bean.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>The main Expression provided by Spring Security OAuth is introduced.</p>
<p>For details, refer <a class="reference external" href="http://docs.spring.io/spring-security/oauth/apidocs/org/springframework/security/oauth2/provider/expression/OAuth2SecurityExpressionMethods.html">JavaDoc</a> of <code class="docutils literal"><span class="pre">OAuth2SecurityExpressionMethods</span></code>.</p>
<table border="1" class="colwidths-given docutils" id="id20">
<caption><span class="caption-text"><strong>Expression provided by Spring Security OAuth</strong></span><a class="headerlink" href="#id20" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Expression</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">clientHasRole(String</span> <span class="pre">role)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Return <code class="docutils literal"><span class="pre">true</span></code> when the client performs the role specified in the argument.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">clientHasAnyRole(String...</span> <span class="pre">roles)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Return <code class="docutils literal"><span class="pre">true</span></code> when the client performs one of the roles specified in the argument.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">hasScope(String</span> <span class="pre">scope)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Return <code class="docutils literal"><span class="pre">true</span></code> when the scope authorized by the resource owner and the scope of the argument matches in the client.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">hasAnyScope(String...</span> <span class="pre">scopes)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Return <code class="docutils literal"><span class="pre">true</span></code> when the scope authorized by the resource owner and one of the scopes of the argument matches in the client.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">hasScopeMatching(String</span> <span class="pre">scopeRegex)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Return <code class="docutils literal"><span class="pre">true</span></code> when the scope authorized by the resource owner and the regular expression specified in the argument matches in the client.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">hasAnyScopeMatching(String...</span> <span class="pre">scopesRegex)</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Return <code class="docutils literal"><span class="pre">true</span></code> when the scope authorized by the resource owner and one of the regular expressions specified in the argument matches in the client.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">denyOAuthClient</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Deny request in OAuth 2.0. It is used so that only the resource owner can access the resources.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">isOAuth</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Allow request in OAuth 2.0. It is used so that the client can access the resources.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>SpEL expression can be used with SpEL provided by Spring Security.</p>
<p class="last">Refer to :ref:<cite>built-incommon-expressions</cite>for SpEL provided by Spring Security.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="configuration-of-access-token-resource-server">
<h4><a class="toc-backref" href="#id51">9.10.2.4.3. Configuration of access token (Resource Server)</a><a class="headerlink" href="#configuration-of-access-token-resource-server" title="Permalink to this headline">¶</a></h4>
<p>Authorization Server is linked with Resource Server via access token <code class="docutils literal"><span class="pre">TokenServices</span></code>.</p>
<p>Refer to <a class="reference internal" href="#oauthauthorizationserverhowtoconfigureaccesstoken"><span class="std std-ref">How to share access token with resource server</span></a> for the methods of linking.</p>
<p>Apply settings by the method of sharing database.</p>
<p>Refer to <a class="reference internal" href="#oauthauthorizationserverhowtoconfigureaccesstoken"><span class="std std-ref">How to share access token with resource server</span></a> for the description of settings as the settings are same as <code class="docutils literal"><span class="pre">TokenServices</span></code> settings in authorization server.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;tokenServices&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.DefaultTokenServices&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;tokenStore&quot;</span> <span class="na">ref=</span><span class="s">&quot;tokenStore&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;tokenStore&quot;</span>
  <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.store.JdbcTokenStore&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;tokenDataSource&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A method which use <code class="docutils literal"><span class="pre">RemoteTokenServices</span></code> provided by Spring Security OAuth and a method which use
JSON Web Token are offered as the methods for linking the authorization server and resource server.
Refer to <a class="reference internal" href="#oauthauthorizationserverhowtocooperatewithhttp"><span class="std std-ref">Linkage through HTTP access</span></a> for how to use <code class="docutils literal"><span class="pre">RemoteTokenServices</span></code> provided by Spring Security OAuth.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="fetching-user-information">
<h4><a class="toc-backref" href="#id52">9.10.2.4.4. Fetching user information</a><a class="headerlink" href="#fetching-user-information" title="Permalink to this headline">¶</a></h4>
<p>In the Resource Server, the authenticated resource owner information can be received by specifying <code class="docutils literal"><span class="pre">UserDetails</span></code> in method argument of Controller class and assigning <code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code> annotation similar to fetching method of the authentication information explained in <a class="reference internal" href="Authentication.html#springsecurityauthenticationintegrationwithspringmvc"><span class="std std-ref">Coordination between authentication process and Spring MVC</span></a>.
The implementation example is shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;api&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="o">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;todos&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">list</span><span class="o">(</span><span class="nd">@AuthenticationPrincipal</span> <span class="n">UserDetails</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (1)</span>

        <span class="c1">// omitted</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authentication information of resource owner is stored in the argument ``user``</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>In case of implementation that specifies <code class="docutils literal"><span class="pre">UserDetails</span></code>, it should be noted that the intended information cannot be fetched in the client credential grant wherein authentication process is not carried out.
When client credential grant is used, client ID can be fetched by specifying <code class="docutils literal"><span class="pre">String</span></code> as the method argument of Controller and assigning <code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code> annotation.</p>
<p>Further, in case of implementation that specifies <code class="docutils literal"><span class="pre">UserDetails</span></code>, authentication information of client such as Client ID cannot be fetched.
When client authentication information is to be fetched, &#8220;OAuth2Authentication``  can be specified as the method argument of the Controller class.
An example wherein &#8216;OAuth2Authentication``  is specified in the method argument of Controller class and authentication information of the client and the resource owner is fetched, is given below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;api&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="o">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;todos&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">list</span><span class="o">(</span><span class="n">OAuth2Authentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (1)</span>

        <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getUserAuthentication</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span> <span class="c1">// (2)</span>
        <span class="n">String</span> <span class="n">clientId</span> <span class="o">=</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getOAuth2Request</span><span class="o">().</span><span class="na">getClientId</span><span class="o">();</span>  <span class="c1">// (3)</span>

        <span class="c1">// omitted</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authentication information of the resource owner and the client is stored in the argument <code class="docutils literal"><span class="pre">authentication</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch resource owner name from <code class="docutils literal"><span class="pre">authentication</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch client ID from  <code class="docutils literal"><span class="pre">authentication</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The implementation example is given above wherein <code class="docutils literal"><span class="pre">OAuth2Authentication</span></code> is used in the application layer.
When the implementation is to be done without depending on <code class="docutils literal"><span class="pre">OAuth2Authentication</span></code>, the same function is feasible by implementing <code class="docutils literal"><span class="pre">HandlerMethodArgumentResolver</span></code>.
Refer to <a class="reference internal" href="../ImplementationAtEachLayer/ApplicationLayer.html#methodargumentresolver"><span class="std std-ref">Implementing HandlerMethodArgumentResolver</span></a> for specific implementation method.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="implementation-of-client">
<h3><a class="toc-backref" href="#id53">9.10.2.5. Implementation of client</a><a class="headerlink" href="#implementation-of-client" title="Permalink to this headline">¶</a></h3>
<p>How to implement client is broadly classified into the following 2 methods based on the grant type to be used.</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">How to implement</th>
<th class="head">Grant type</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">OAuth2RestTemplate</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authorization code grant</div>
<div class="line">Resource owner password credential grant</div>
<div class="line">Client credential grant</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">Javascript</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Implicit grant</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>In this guideline, <a class="reference internal" href="#oauthclientusingoauth2resttemplate"><span class="std std-ref">Accessing a resource using OAuth2RestTemplate</span></a> and <a class="reference internal" href="#oauthclientusingjavascript"><span class="std std-ref">Accessing a resource using JavaScript</span></a>are described respectively in classification described above.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="accessing-a-resource-using-oauth2resttemplate">
<span id="oauthclientusingoauth2resttemplate"></span><h4><a class="toc-backref" href="#id54">9.10.2.5.1. Accessing a resource using OAuth2RestTemplate</a><a class="headerlink" href="#accessing-a-resource-using-oauth2resttemplate" title="Permalink to this headline">¶</a></h4>
<p>How to access resource using <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> is described as the implementation of the client for authorization code grant, resource owner password credential grant
and client credential grant.</p>
<p>In Spring Security OAuth, <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> is provided as implementation for OAuth 2.0 of <code class="docutils literal"><span class="pre">RestOperations</span></code>.</p>
<p>In <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>, the functions for fetching access token, sharing access token between multiple requests by <code class="docutils literal"><span class="pre">OAuth2ClientContext</span></code> and error handling when accessing the Resource Server
are implemented as per the grant type by <code class="docutils literal"><span class="pre">AccessTokenProvider</span></code> as independent functions of OAuth 2.0.</p>
<p>In the client, the resource can be accessed using OAuth 2.0 functions by defining the parameters as per the
application requirements such as grant type, scope using <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="creation-of-configuration-file-client">
<h5><a class="toc-backref" href="#id55">9.10.2.5.1.1. Creation of configuration file (Client)</a><a class="headerlink" href="#creation-of-configuration-file-client" title="Permalink to this headline">¶</a></h5>
<p>First create <code class="docutils literal"><span class="pre">oauth2-client.xml</span></code> as the configuration file for defining OAuth 2.0.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
    <span class="na">xmlns:oauth2=</span><span class="s">&quot;http://www.springframework.org/schema/security/oauth2&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;</span>
<span class="s">        http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">        http://www.springframework.org/schema/security/oauth2 http://www.springframework.org/schema/security/spring-security-oauth2.xsd</span>
<span class="s">    &quot;</span><span class="nt">&gt;</span>


<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Add the settings to <code class="docutils literal"><span class="pre">web.xml</span></code>so as to read the created <code class="docutils literal"><span class="pre">oauth2-client.xml</span></code>.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">web.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;context-param&gt;</span>
    <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
    <span class="nt">&lt;param-value&gt;</span>
        classpath*:META-INF/spring/applicationContext.xml
        classpath*:META-INF/spring/oauth2-client.xml  <span class="c">&lt;!-- (1) --&gt;</span>
        classpath*:META-INF/spring/spring-security.xml
    <span class="nt">&lt;/param-value&gt;</span>
<span class="nt">&lt;/context-param&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set so as to read <code class="docutils literal"><span class="pre">oauth2-client.xml</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="applying-oauth2clientcontextfilter">
<h5><a class="toc-backref" href="#id56">9.10.2.5.1.2. Applying OAuth2ClientContextFilter</a><a class="headerlink" href="#applying-oauth2clientcontextfilter" title="Permalink to this headline">¶</a></h5>
<p>Register <code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code> as a servlet filter.</p>
<p>By registering <code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>, when an attempt is made to access the Resource Server when authorization cannot be fetched by the resource owner,
a function to capture <code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code> and redirect to the page for fetching authorization of the resource owner provided by the Authorization Server
can be incorporated.</p>
<p>Add the following settings to <code class="docutils literal"><span class="pre">oauth2-client.xml</span></code>.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:client</span> <span class="na">id=</span><span class="s">&quot;oauth2ClientContextFilter&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Explanation</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Bean is defined for <code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>by using <code class="docutils literal"><span class="pre">&lt;oauth2:client&gt;</span></code>tag. The string specified in <code class="docutils literal"><span class="pre">id</span></code>attribute is used as Bean ID.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Add the settings of <code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>to <code class="docutils literal"><span class="pre">web.xml</span></code>.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">web.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;filter&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>oauth2ClientContextFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;filter-class&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="nt">&lt;/filter-class&gt;</span>
<span class="nt">&lt;/filter&gt;</span>
<span class="nt">&lt;filter-mapping&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>oauth2ClientContextFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/filter-mapping&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Register the Bean wherein Bean ID matches with the filter name (value specified in the <code class="docutils literal"><span class="pre">&lt;filter-name&gt;</span></code> element) as a servlet filter by using  <code class="docutils literal"><span class="pre">DelegatingFilterProxy</span></code>.</div>
<div class="line">Set the value same as the Bean ID specified in <code class="docutils literal"><span class="pre">id</span></code> attribute of <code class="docutils literal"><span class="pre">&lt;oauth2:client&gt;</span></code> in the filter name.</div>
<div class="line">It is recommended to mention <code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code> at the end of servlet filter definition so as not to perform  unintended exception handling of the exception generated in Spring Security OAuth.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">``OAuth2ClientContextFilter``  is applied to the path wherein ``UserRedirectRequiredException``  may occur.</div>
<div class="line">In the above example, &#8220;OAuth2ClientContextFilter``  is applied to all the requests.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since <code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code> generates redirect URL for returning the user agent after the authorization process by the Authorization Server in the pre-process of the filter,
a wide definition such as <code class="docutils literal"><span class="pre">/*</span></code> will result in futile processing in the path where <code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code> does not occur.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">``OAuth2ClientContextFilter``  stores the URL to be redirected after the Authorization Server gets the authorization
from the resource owner with the attribute name <code class="docutils literal"><span class="pre">currentUri</span></code> in the request scope. Therefore, the attribute name <code class="docutils literal"><span class="pre">currentUri</span></code> cannot be used in the client.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>As mentioned above, ``Oauth2ClientContextFilter``  is a servlet filter that captures ``UserRedirectRequiredException`` and redirects it to the Authorization Server.</p>
<p>However, if the ``SystemExceptionResolver``  set in the blank project in advance, handles ``UserRedirectRequiredException``  first,
``Oauth2ClientContextFilter`` will not work as intended.</p>
<p>Therefore, it is necessary to change the setting of <cite>spring-mvc.xml`</cite>  so that the ``SystemExceptionResolver``  does not handle ``UserRedirectRequiredException`` .
Refer to <a class="reference internal" href="../ArchitectureInDetail/WebApplicationDetail/ExceptionHandling.html"><span class="doc">Exception Handling</span></a> for the description of <code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>in detail.</p>
<p>Add <code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code> to <code class="docutils literal"><span class="pre">spring-mvc.xml</span></code> as the exclusion target of <code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">spring-mvc.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;systemExceptionResolver&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.SystemExceptionResolver&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;excludedExceptions&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;array&gt;</span>
            <span class="c">&lt;!-- (1) --&gt;</span>
            <span class="nt">&lt;value&gt;</span>org.springframework.security.oauth2.client.resource.UserRedirectRequiredException
            <span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/array&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Exclude <code class="docutils literal"><span class="pre">UserRedirectRequiredException</span></code> from handling target of <code class="docutils literal"><span class="pre">SystemExceptionResolver</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="settings-of-oauth2resttemplate">
<span id="oauth2resttemplatesettings"></span><h5><a class="toc-backref" href="#id57">9.10.2.5.1.3. Settings of OAuth2RestTemplate</a><a class="headerlink" href="#settings-of-oauth2resttemplate" title="Permalink to this headline">¶</a></h5>
<p>How to set <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> for each grant type is explained.</p>
<div class="section" id="setting-a-resource-while-using-authorization-code-grant">
<h6><a class="toc-backref" href="#id58">9.10.2.5.1.3.1. Setting a resource while using authorization code grant</a><a class="headerlink" href="#setting-a-resource-while-using-authorization-code-grant" title="Permalink to this headline">¶</a></h6>
<p>The setting example of <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> is shown while accessing with authorization code grant.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:resource</span> <span class="na">id=</span><span class="s">&quot;todoAuthCodeGrantResource&quot;</span> <span class="na">client-id=</span><span class="s">&quot;firstSec&quot;</span>
                 <span class="na">client-secret=</span><span class="s">&quot;firstSecSecret&quot;</span>
                 <span class="na">type=</span><span class="s">&quot;authorization_code&quot;</span>
                 <span class="na">scope=</span><span class="s">&quot;READ,WRITE&quot;</span>
                 <span class="na">access-token-uri=</span><span class="s">&quot;${auth.serverUrl}/oth2/token&quot;</span>
                 <span class="na">user-authorization-uri=</span><span class="s">&quot;${auth.serverUrl}/oth2/authorize&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

<span class="nt">&lt;oauth2:rest-template</span> <span class="na">id=</span><span class="s">&quot;todoAuthCodeGrantResourceRestTemplate&quot;</span> <span class="na">resource=</span><span class="s">&quot;todoAuthCodeGrantResource&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define detailed information of the resource to be accessed , to be referred by <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>.</div>
<div class="line">Refer to the following table for the setting value of each item.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>.</div>
<div class="line">Specify Bean ID of <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> in <code class="docutils literal"><span class="pre">id</span></code>.</div>
<div class="line">Specify <code class="docutils literal"><span class="pre">id</span></code> of Bean defined in (1) for <code class="docutils literal"><span class="pre">resource</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils" id="id21">
<caption><span class="caption-text"><strong>Resource detailed information</strong></span><a class="headerlink" href="#id21" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Items</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">id</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Bean ID of resource.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">client-id</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ID for identifying the client in the Authorization Server.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">client-secret</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Password used for authentication of client in the Authorization Server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">type</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Grant type. Specify <code class="docutils literal"><span class="pre">authorization_code</span></code> in case of authorization code grant.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">scope</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Enumerate the scope that requires authorization by separating with commas. Setting value is case-sensitive.</div>
<div class="line">Request all scopes set for the client in Authorization Server at the time of omitting.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">access-token-uri</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">URL of endpoint of the Authorization Server for requesting the issue of access token.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">user-authorization-uri</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">URL of endpoint of the Authorization Server for getting the authorization of resource owner.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>In  <code class="docutils literal"><span class="pre">&lt;oauth2:resource&gt;</span></code>tag,  <code class="docutils literal"><span class="pre">client-authentication-scheme</span></code> parameter is provided as the method to specify
client authentication method at the time of getting access token.
The values that can be specified in <code class="docutils literal"><span class="pre">client-authentication-scheme</span></code> parameter are as follows.</p>
<blockquote class="last">
<div><blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">header</span></code>: Basic authentication using Authorization header. Default value.</li>
<li><code class="docutils literal"><span class="pre">query</span></code> : Authentication using URL query parameter at the time of requesting.</li>
<li><code class="docutils literal"><span class="pre">form</span></code>  : Authentication using body parameter at the time of requesting.</li>
</ul>
</div></blockquote>
<p>In this guideline, since Basic authentication is used for authenticating the client, parameters are not specified in the above-mentioned setting example,
however, parameters should be specified as per the application requirements.</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:resource</span> <span class="na">id=</span><span class="s">&quot;todoAuthCodeGrantResource&quot;</span> <span class="na">client-id=</span><span class="s">&quot;firstSec&quot;</span>
                 <span class="na">client-secret=</span><span class="s">&quot;firstSecSecret&quot;</span>
                 <span class="na">type=</span><span class="s">&quot;authorization_code&quot;</span>
                 <span class="na">scope=</span><span class="s">&quot;READ,WRITE&quot;</span>
                 <span class="na">access-token-uri=</span><span class="s">&quot;${auth.serverUrl}/oth2/token&quot;</span>
                 <span class="na">user-authorization-uri=</span><span class="s">&quot;${auth.serverUrl}/oth2/authorize&quot;</span>
                 <span class="na">client-authentication-scheme=</span><span class="s">&quot;form&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
</div>
</div>
<div class="section" id="settings-of-resource-at-the-time-of-using-resource-owner-password-credential-grant">
<span id="oauth2resourceownerpasswordcredentialgrantresourcesettings"></span><h6><a class="toc-backref" href="#id59">9.10.2.5.1.3.2. Settings of resource at the time of using resource owner password credential grant</a><a class="headerlink" href="#settings-of-resource-at-the-time-of-using-resource-owner-password-credential-grant" title="Permalink to this headline">¶</a></h6>
<div class="line-block">
<div class="line">In the resource owner password credential grant, the client requests the issue of access token by using the user name and password of the resource owner.</div>
<div class="line">There is a need to set the username and password of resource owner as separate parameters in <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code>,
however, when multiple resource owners use the same client, there is a need to consider switching the setting contents for each resource owner.</div>
<div class="line">The method to implement switching of setting contents for each resource owner by setting resource of <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> in the Bean of Session scope and storing the information of resource owner in that Bean
is explained here.</div>
</div>
<p>The setting example of <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> when accessing with resource owner password credential grant, is shown.</p>
<p>Define <code class="docutils literal"><span class="pre">ResourceOwnerPasswordResourceDetails</span></code> in the Session scope and set to <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> to enable switching of setting contents of each resource owner.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
    <span class="na">xmlns:oauth2=</span><span class="s">&quot;http://www.springframework.org/schema/security/oauth2&quot;</span>
    <span class="na">xmlns:aop=</span><span class="s">&quot;http://www.springframework.org/schema/aop&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;</span>
<span class="s">        http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">        http://www.springframework.org/schema/security/oauth2 http://www.springframework.org/schema/security/spring-security-oauth2.xsd</span>
<span class="s">        http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd</span>
<span class="s">    &quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;todoPasswordGrantResource&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.client.token.grant.password.ResourceOwnerPasswordResourceDetails&quot;</span>
        <span class="na">scope=</span><span class="s">&quot;session&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;aop:scoped-proxy&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;clientId&quot;</span> <span class="na">value=</span><span class="s">&quot;firstSec&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;clientSecret&quot;</span> <span class="na">value=</span><span class="s">&quot;firstSecSecret&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;accessTokenUri&quot;</span> <span class="na">value=</span><span class="s">&quot;${auth.serverUrl}/oth2/token&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;scope&quot;</span> <span class="na">value=</span><span class="s">&quot;READ,WRITE&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

    <span class="nt">&lt;oauth2:rest-template</span> <span class="na">id=</span><span class="s">&quot;todoPasswordGrantResourceRestTemplate&quot;</span> <span class="na">resource=</span><span class="s">&quot;todoPasswordGrantResource&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define detailed information of the resource to be accessed, to be referred by ``OAuth2RestTemplate``.</div>
<div class="line">Refer to the following table for the setting value of each item.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define ``OAuth2RestTemplate``.</div>
<div class="line">Specify Bean ID  of <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> in <code class="docutils literal"><span class="pre">id</span></code>.</div>
<div class="line">Specify ``id`` of Bean defined in (1) in <code class="docutils literal"><span class="pre">resource</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Item</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">class</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the Bean that acts as a resource of ``OAuth2RestTemplate`` . Specify ``ResourceOwnerPasswordResourceDetails``  here.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">scope</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify session and consider the scope range as HTTPSession.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;aop:scoped-proxy&gt;</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set Bean of Session scope for injecting it in <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> that is Bean of Singleton.</div>
<div class="line">This is a setting that is necessary because the lifecycle of bean of Singleton is longer than the Bean of Session scope.</div>
<div class="line">In order to use this tag, namespace and schema of &#8220;` aop``  is added.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">clientId</span></code> property</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set ID for identifying the client in the Authorization Server for <code class="docutils literal"><span class="pre">clientId</span></code> of Bean.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">clientSecret</span></code> property</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set password used for client authentication in the Authorization Server for <code class="docutils literal"><span class="pre">clientSecrett</span></code> of Bean.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">accessTokenUri</span></code> property</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify URL of endpoint of the Authorization Server for requesting the issue of access token.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">scope</span></code> property</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set scope list requesting authorization for <code class="docutils literal"><span class="pre">scope</span></code> of Bean.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is assumed that the username and password of resource owner is fetched after it is entered by the resource owner on the client screen when access is required, and is stored in Bean.
In this guideline, the explanation of how to fetch username and password is omitted.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">In the Authorization Server described in this guideline, the password set in `` ResourceOwnerPasswordResourceDetails`` must be in plain text in order to perform comparative verification after hashing the password used for authentication.
Since there is high risk in handling the password of resource owner in plain text by the client, the resource owner password credential grant
should be used in very limited cases such as when there is highly trustworthy relationship between client and resource owner and the client is kept in secure environment.
Refer to <a class="reference internal" href="#oauthauthorizationserverclientauthentication"><span class="std std-ref">Client authentication</span></a> for the settings of hashing in Authorization Server.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="settings-of-resource-at-the-time-of-using-client-credential-grant">
<h6><a class="toc-backref" href="#id60">9.10.2.5.1.3.3. Settings of resource at the time of using client credential grant</a><a class="headerlink" href="#settings-of-resource-at-the-time-of-using-client-credential-grant" title="Permalink to this headline">¶</a></h6>
<p>The setting example of <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> is shown while accessing with client credential grant.</p>
<p>The explanation of settings common to authorization code grant is omitted.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:resource</span> <span class="na">id=</span><span class="s">&quot;todoClientGrantResource&quot;</span> <span class="na">client-id=</span><span class="s">&quot;firstSecClient&quot;</span>
                <span class="na">client-secret=</span><span class="s">&quot;firstSecSecret&quot;</span>
                <span class="na">type=</span><span class="s">&quot;client_credentials&quot;</span>
                <span class="na">access-token-uri=</span><span class="s">&quot;${auth.serverUrl}/oth2/token&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

<span class="nt">&lt;oauth2:rest-template</span> <span class="na">resource=</span><span class="s">id=&quot;todoClientGrantResourceRestTemplate&quot;</span> <span class="na">resource=</span><span class="s">&quot;todoClientGrantResource&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the grant type in <code class="docutils literal"><span class="pre">type</span></code> attribute. Specify <code class="docutils literal"><span class="pre">client_credentials</span></code> in case of client credential grant.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="accessing-a-resource-server">
<h5><a class="toc-backref" href="#id61">9.10.2.5.1.4. Accessing a resource Server</a><a class="headerlink" href="#accessing-a-resource-server" title="Permalink to this headline">¶</a></h5>
<p>How to access the Resource Server using <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> is explained.</p>
<p>Since access to Authorization Server is hidden by <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> and <code class="docutils literal"><span class="pre">OAuth2ClientContextFilter</span></code>,
the process to be performed for REST API provided by the Resource Server is described similar to normal access to REST API without being aware of the Authorization Server at the time of development.</p>
<p>The implementation example of Service class is shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">org.springframework.web.client.RestOperations</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="o">(</span><span class="s">&quot;todoAuthCodeGrantResourceRestTemplate&quot;</span><span class="o">)</span>
    <span class="n">RestOperations</span> <span class="n">restOperations</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${resource.serverUrl}/api/v1/todos&quot;</span><span class="o">)</span>
    <span class="n">String</span> <span class="n">uri</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">getTodoList</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Todo</span><span class="o">[]</span> <span class="n">todoArray</span> <span class="o">=</span> <span class="n">restOperations</span><span class="o">.</span>
            <span class="nf">getForObject</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">Todo</span><span class="o">[].</span><span class="na">class</span><span class="o">);</span> <span class="c1">// (2)</span>
        <span class="k">return</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">todoArray</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inject <code class="docutils literal"><span class="pre">RestOperations</span></code>.</div>
<div class="line">In the above-mentioned example, the Bean whose Bean ID is <code class="docutils literal"><span class="pre">todoAuthCodeGrantResourceRestTemplate</span></code> is Injected. <code class="docutils literal"><span class="pre">&#64;Named</span></code> should be specified when multiple <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> are defined.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Access the specified URL with GET method in REST and receive the result in a list.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>When access token is not issued if <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> is used to access the Resource Server,
it is redirected to the Authorization Server at once.
Thereafter, when the issue of access token is complete, it is redirected to the client and access process to the resource server is called again.
At this time, since redirect to client is performed by GET, the Controller that may be redirected from Authorization Server, must allow GET.</p>
<p class="last">If access to the Resource Server before the redirect is POST, the parameter will be lost in GET after redirect.
In that case, a measure like retaining POST parameter in session, should be taken.
In this guideline, the explanation of specific handling method is omitted.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="accessing-a-resource-using-javascript">
<span id="oauthclientusingjavascript"></span><h4><a class="toc-backref" href="#id62">9.10.2.5.2. Accessing a resource using JavaScript</a><a class="headerlink" href="#accessing-a-resource-using-javascript" title="Permalink to this headline">¶</a></h4>
<p>In the implicit grant, user agent such as Web browser requests authorization for the Authorization Server.</p>
<p>Therefore, implicit grant is usually used in JavaScript that runs on Web browser, however
since JavaScript library is not provided in Spring Security OAuth, client should be implemented independently
when using implicit grant.</p>
<p>In this guideline, how to fetch data in JSON format from the Resource Server using JavaScript and display it on the screen is explained
as the implementation of client for implicit grant.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Use jQuery as JavaScript library in the implementation example to be explained later.
It is assumed to be stored under <code class="docutils literal"><span class="pre">src/main/webapp</span></code> with js file.</p>
</div>
<p>API example wherein OAuth 2.0 function is implemented independently, is shown.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2.js</span></code></li>
</ul>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">oauth2Func</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">exp</span><span class="p">,</span> <span class="nx">$</span><span class="p">)</span> <span class="p">{</span>
    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

    <span class="kd">var</span>
        <span class="nx">config</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">DEFAULT_LIFETIME</span> <span class="o">=</span> <span class="mi">3600</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">uuid</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">&quot;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&quot;</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[xy]/g</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">16</span><span class="o">|</span><span class="mi">0</span><span class="p">,</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">c</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span> <span class="o">?</span> <span class="nx">r</span> <span class="o">:</span> <span class="p">(</span><span class="nx">r</span><span class="o">&amp;</span><span class="mh">0x3</span><span class="o">|</span><span class="mh">0x8</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">v</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">encodeURL</span><span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nx">k</span> <span class="k">in</span> <span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">res</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">i</span><span class="o">++</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">?</span> <span class="s2">&quot;?&quot;</span> <span class="o">:</span> <span class="s2">&quot;&amp;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">params</span><span class="p">[</span><span class="nx">k</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">epoch</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span><span class="o">/</span><span class="mf">1000.0</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">parseQueryString</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">qs</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">e</span><span class="p">,</span>
            <span class="nx">a</span> <span class="o">=</span> <span class="sr">/\+/g</span><span class="p">,</span>
            <span class="nx">r</span> <span class="o">=</span> <span class="sr">/([^&amp;;=]+)=?([^&amp;;]*)/g</span><span class="p">,</span>
            <span class="nx">d</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">));</span> <span class="p">},</span>
            <span class="nx">q</span> <span class="o">=</span> <span class="nx">qs</span><span class="p">,</span>
            <span class="nx">urlParams</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="k">while</span> <span class="p">(</span><span class="nx">e</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">q</span><span class="p">))</span> <span class="p">{</span>
           <span class="nx">urlParams</span><span class="p">[</span><span class="nx">d</span><span class="p">(</span><span class="nx">e</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="nx">d</span><span class="p">(</span><span class="nx">e</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">urlParams</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">saveState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s2">&quot;state-&quot;</span> <span class="o">+</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">obj</span><span class="p">));</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">getState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s2">&quot;state-&quot;</span> <span class="o">+</span> <span class="nx">state</span><span class="p">));</span>
        <span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="s2">&quot;state-&quot;</span> <span class="o">+</span> <span class="nx">state</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">hasScope</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">scope</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">token</span><span class="p">.</span><span class="nx">scopes</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">token</span><span class="p">.</span><span class="nx">scopes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">scopes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">scope</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">filterTokens</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tokens</span><span class="p">,</span> <span class="nx">scopes</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (1)</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">scopes</span><span class="p">)</span> <span class="nx">scopes</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">,</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">now</span> <span class="o">=</span> <span class="nx">epoch</span><span class="p">(),</span>
        <span class="nx">usethis</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">usethis</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">tokens</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">expires</span> <span class="o">&amp;&amp;</span> <span class="nx">tokens</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">expires</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">now</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="nx">usethis</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

            <span class="k">for</span><span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">scopes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasScope</span><span class="p">(</span><span class="nx">tokens</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">scopes</span><span class="p">[</span><span class="nx">j</span><span class="p">]))</span> <span class="nx">usethis</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">usethis</span><span class="p">)</span> <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tokens</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">saveTokens</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">provider</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s2">&quot;tokens-&quot;</span> <span class="o">+</span> <span class="nx">provider</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">tokens</span><span class="p">));</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">getTokens</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">provider</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s2">&quot;tokens-&quot;</span> <span class="o">+</span> <span class="nx">provider</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">tokens</span><span class="p">)</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="k">return</span> <span class="nx">tokens</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">wipeTokens</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">provider</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="s2">&quot;tokens-&quot;</span> <span class="o">+</span> <span class="nx">provider</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">saveToken</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">provider</span><span class="p">,</span> <span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">getTokens</span><span class="p">(</span><span class="nx">provider</span><span class="p">);</span>
        <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">filterTokens</span><span class="p">(</span><span class="nx">tokens</span><span class="p">);</span>
        <span class="nx">tokens</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
        <span class="nx">saveTokens</span><span class="p">(</span><span class="nx">provider</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">getToken</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">provider</span><span class="p">,</span> <span class="nx">scopes</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">getTokens</span><span class="p">(</span><span class="nx">provider</span><span class="p">);</span>
        <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">filterTokens</span><span class="p">(</span><span class="nx">tokens</span><span class="p">,</span> <span class="nx">scopes</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">tokens</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">sendAuthRequest</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">scopes</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (2)</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">config</span><span class="p">[</span><span class="nx">providerId</span><span class="p">])</span> <span class="k">throw</span> <span class="s2">&quot;Could not find configuration for provider &quot;</span> <span class="o">+</span> <span class="nx">providerId</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">co</span> <span class="o">=</span> <span class="nx">config</span><span class="p">[</span><span class="nx">providerId</span><span class="p">];</span>

        <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">uuid</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;response_type&quot;</span><span class="o">:</span> <span class="s2">&quot;token&quot;</span>
        <span class="p">};</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">state</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">co</span><span class="p">[</span><span class="s2">&quot;redirectUrl&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;redirect_uri&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">co</span><span class="p">[</span><span class="s2">&quot;redirectUrl&quot;</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">co</span><span class="p">[</span><span class="s2">&quot;clientId&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;client_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">co</span><span class="p">[</span><span class="s2">&quot;clientId&quot;</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">scopes</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;scope&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">scopes</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">authurl</span> <span class="o">=</span> <span class="nx">encodeURL</span><span class="p">(</span><span class="nx">co</span><span class="p">.</span><span class="nx">authorization</span><span class="p">,</span> <span class="nx">request</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;restoreHash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;providerId&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">providerId</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">scopes</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">request</span><span class="p">[</span><span class="s2">&quot;scopes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">scopes</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">saveState</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">request</span><span class="p">);</span>
        <span class="nx">redirect</span><span class="p">(</span><span class="nx">authurl</span><span class="p">);</span>

    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">checkForToken</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">providerId</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (3)</span>
        <span class="kd">var</span> <span class="nx">h</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (4)</span>
            <span class="nx">h</span> <span class="o">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">errorinfo</span> <span class="o">=</span> <span class="nx">parseQueryString</span><span class="p">(</span><span class="nx">h</span><span class="p">);</span>
            <span class="nx">handleError</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">errorinfo</span><span class="p">);</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;access_token&quot;</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">h</span> <span class="o">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">atoken</span> <span class="o">=</span> <span class="nx">parseQueryString</span><span class="p">(</span><span class="nx">h</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">atoken</span><span class="p">.</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">getState</span><span class="p">(</span><span class="nx">atoken</span><span class="p">.</span><span class="nx">state</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">state</span><span class="p">)</span> <span class="k">throw</span> <span class="s2">&quot;Could not retrieve state&quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">state</span><span class="p">.</span><span class="nx">providerId</span><span class="p">)</span> <span class="k">throw</span> <span class="s2">&quot;Could not get providerId from state&quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">config</span><span class="p">[</span><span class="nx">state</span><span class="p">.</span><span class="nx">providerId</span><span class="p">])</span> <span class="k">throw</span> <span class="s2">&quot;Could not retrieve config for this provider.&quot;</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">now</span> <span class="o">=</span> <span class="nx">epoch</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;expires_in&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;expires&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">now</span> <span class="o">+</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;expires_in&quot;</span><span class="p">]);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;expires&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">now</span> <span class="o">+</span> <span class="nx">DEFAULT_LIFETIME</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;scope&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;scopes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;scope&quot;</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">[</span><span class="s2">&quot;scopes&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">atoken</span><span class="p">[</span><span class="s2">&quot;scopes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">state</span><span class="p">[</span><span class="s2">&quot;scopes&quot;</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="nx">saveToken</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">atoken</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">restoreHash</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">restoreHash</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">handleError</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">cause</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (5)</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">config</span><span class="p">[</span><span class="nx">providerId</span><span class="p">])</span> <span class="k">throw</span> <span class="s2">&quot;Could not retrieve config for this provider.&quot;</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">co</span> <span class="o">=</span> <span class="nx">config</span><span class="p">[</span><span class="nx">providerId</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">errorDetail</span> <span class="o">=</span> <span class="nx">cause</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">];</span>

        <span class="c1">// redirect error page</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">co</span><span class="p">[</span><span class="s2">&quot;errRedirectUrl&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">redirect</span><span class="p">(</span><span class="nx">co</span><span class="p">[</span><span class="s2">&quot;errRedirectUrl&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">errorDetail</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Access Error. cause: &quot;</span> <span class="o">+</span> <span class="nx">errorDetail</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>


    <span class="kd">var</span> <span class="nx">redirect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">initialize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">config</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">providerId</span><span class="p">;</span>
            <span class="k">for</span><span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">providerId</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">checkForToken</span><span class="p">(</span><span class="nx">providerId</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Error when retrieving token from hash: &quot;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">);</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">clearTokens</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">key</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">wipeTokens</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">oajax</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">settings</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (6)</span>
        <span class="kd">var</span> <span class="nx">providerId</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">providerId</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">scopes</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">scopes</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">getToken</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">scopes</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">sendAuthRequest</span><span class="p">(</span><span class="nx">providerId</span><span class="p">,</span> <span class="nx">scopes</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">settings</span><span class="p">.</span><span class="nx">headers</span><span class="p">)</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">headers</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="nx">settings</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;Authorization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Bearer &quot;</span> <span class="o">+</span> <span class="nx">token</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">];</span>

        <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="nx">settings</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">initialize</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="nx">clearTokens</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">clearTokens</span><span class="p">();</span>
        <span class="p">},</span>
        <span class="nx">oajax</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">oajax</span><span class="p">(</span><span class="nx">settings</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

<span class="p">})(</span><span class="nb">window</span><span class="p">,</span> <span class="nx">jQuery</span><span class="p">);</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Function to check the expiry and scope availability of access token.</div>
<div class="line">The client returns the available access token.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Function to request authorization of the Authorization Server.</div>
<div class="line">Fetch the required parameters from the configuration information and create a request.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Function to get access token from authorization response.</div>
<div class="line">When access token can be fetched, store the information in the local storage.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">As the result of authorization, when an error is returned, call <code class="docutils literal"><span class="pre">handleError</span></code> as error handling.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Function to handle authorization error.</div>
<div class="line">In this guideline, redirect to redirect destination URL is carried out at the time of error specified in configuration information
as the implementation example of error handling.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Function to request access resource to the Resource Server.</div>
<div class="line">Fetch access token from local storage and send request to the Resource Server using ajax function of jQuery.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>The implementation example of client is shown below.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">todoList.jsp</span></code></li>
</ul>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;script</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;${pageContext.request.contextPath}/resources/vendor/jquery/jquery.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;script</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;${pageContext.request.contextPath}/resources/app/js/oth2-implicit.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;script</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
&quot;use strict&quot;;

$(document).ready(function() {
    var result = oauth2Func.initialize({ // (2)
        &quot;todo&quot; : { // (3)
            clientId : &quot;client&quot;, // (4)
            redirectUrl : &quot;${client.serverUrl}/oth2/api&quot;, // (5)
            errRedirectUrl : &quot;${client.serverUrl}/oth2/error&quot;, // (6)
            authorization : &quot;${auth.serverUrl}/oth2/authorize&quot; // (7)
        }
    });

    if (result) {
        oauth2Func.oajax({ // (8)
            url : &quot;${resource.serverUrl}/api/v1/todos&quot;, // (9)
            providerId : &quot;todo&quot;,  // (10)
            scopes : [ &quot;READ&quot; ],  // (11)
            dataType : &quot;json&quot;,    // (12)
            type : &quot;GET&quot;,  // (13)
            success : function(data) { // (14)
                $(&quot;#message&quot;).text(JSON.stringify(data));
            },
            error : function() {
                oauth2Func.clearTokens();
            }
        });
    } else {
        oauth2Func.clearTokens(); // (15)
    }


};

<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">&quot;message&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">As described later, specify the path storing js file, jQuery for which OAuth 2.0 function is implemented individually.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define configuration information to be used for authorization request and initialize the same.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify a unique value as an identifier for distinguishing the configuration information of each client.</div>
<div class="line">In the process of accessing resources described later, manage and fetch configuration information by using this item as a key.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify ID identifying the client.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify URL to redirect the client after authenticating the resource owner of authorization server.</div>
<div class="line">In this implementation example, it is assumed that parameters of URL are received from the controller.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify URL for redirecting when an error is received from authorization server as the authorization response.</div>
<div class="line">In this implementation example, it is assumed that parameters of URL are received from the controller.</div>
<div class="line">These guidelines show the method of redirecting to client screen and displaying the error screen, as an example of implementation when error is received.
Description about client Controller is omitted.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify authorization end point of authorization server.</div>
<div class="line">In this implementation example, it is assumed that parameters of URL are received from the controller.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Access the resource.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify access destination of resource server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify identifier of configuration information to be referred.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify scope to be requested to the resource. Setting value is classified by upper case character and lower chase character.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify response type.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(13)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Access resource server GET method.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(14)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify process when processing is successful. Response after successful processing is stored in <code class="docutils literal"><span class="pre">message</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(15)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Clear the access token.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><div class="admonition-todo admonition" id="index-1">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p>When authorization servers and resource server that are not in the same domain are accessed from the clients created in JavaScript, support of <code class="docutils literal"><span class="pre">Cross-Origin</span> <span class="pre">Resource</span> <span class="pre">Sharing</span></code> is required on authorization server and resource server.</p>
<p class="last">Details will be described in the next versions.</p>
</div>
</div></blockquote>
</div>
<div class="section" id="cancellation-of-token-client-server">
<span id="oauthclientserverhowtocanceltoken"></span><h4><a class="toc-backref" href="#id63">9.10.2.5.3. Cancellation of token (Client server)</a><a class="headerlink" href="#cancellation-of-token-client-server" title="Permalink to this headline">¶</a></h4>
<p>Implementation method of cancelling the issued token is described.</p>
<div class="line-block">
<div class="line">For cancelling the access token, request is made to authorization server and access token is deleted from  <code class="docutils literal"><span class="pre">TokenStore</span></code>. Request header of Basic authentication is set in order to perform Basic authentication of client when request is made to authorization server.</div>
<div class="line">Refer to <a class="reference internal" href="#oauthauthorizationserverhowtocanceltoken"><span class="std std-ref">Canceling a token (authorization server)</span></a> , for the cancellation of tokens in authorization server.</div>
<div class="line">Access token retained in <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> should be deleted after requesting the cancellation of access token to authorization server by the client server.</div>
</div>
<p>Implementation example is given below.</p>
<p>At first, settings of <code class="docutils literal"><span class="pre">RestTemplate</span></code> are added in configuration file in order to request cancelation of token to authorization server.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-client.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;revokeRestTemplate&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.web.client.RestTemplate&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;interceptors&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;list&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;basicAuthInterceptor&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;basicAuthInterceptor&quot;</span> <span class="na">class=</span><span class="s">&quot;com.example.oauth2.client.restclient.BasicAuthInterceptor&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define a Bean for <code class="docutils literal"><span class="pre">RestTemplate</span></code> in order to request the cancellation of token to authorization server.</div>
<div class="line">Implementation class <code class="docutils literal"><span class="pre">ClientHttpRequestInterceptor</span></code> is specified in <code class="docutils literal"><span class="pre">interceptors</span></code> property, in order to set request header for basic authentication.</div>
<div class="line">Refer to <a class="reference internal" href="../ArchitectureInDetail/WebServiceDetail/RestClient.html#restclienthowtoextendclienthttprequestinterceptorbasicauthentication"><span class="std std-ref">Process to configure a request header for Basic authentication</span></a>, for the implementation details of <code class="docutils literal"><span class="pre">ClientHttpRequestInterceptor</span></code> implementation class that sets the request header of Basic authentication.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Interface of service class and implementation class are created for cancelling the token.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">RevokeTokenClientService.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RevokeTokenClientService</span> <span class="o">{</span>

    <span class="n">String</span> <span class="nf">revokeToken</span><span class="o">();</span>

<span class="o">}</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">RevokeTokenClientServiceImpl.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RevokeTokenClientServiceImpl</span> <span class="kd">implements</span> <span class="n">RevokeTokenClientService</span> <span class="o">{</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${auth.serverUrl}/api/v1/oth2/tokens/revoke&quot;</span><span class="o">)</span>
    <span class="n">String</span> <span class="n">revokeTokenUrl</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="o">(</span><span class="s">&quot;todoAuthCodeGrantResourceRestTemplate&quot;</span><span class="o">)</span>
    <span class="n">OAuth2RestOperations</span> <span class="n">oauth2RestOperations</span><span class="o">;</span> <span class="c1">// (2)</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="o">(</span><span class="s">&quot;revokeRestTemplate&quot;</span><span class="o">)</span>
    <span class="n">RestOperations</span> <span class="n">revokeRestOperations</span><span class="o">;</span> <span class="c1">// (3)</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">revokeToken</span><span class="o">()</span> <span class="o">{</span>

        <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">getTokenValue</span><span class="o">(</span><span class="n">oauth2RestOperations</span><span class="o">);</span>
        <span class="n">HttpHeaders</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="o">();</span>
        <span class="n">headers</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_FORM_URLENCODED</span><span class="o">);</span>
        <span class="n">MultiValueMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">variables</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedMultiValueMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
        <span class="n">variables</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;token&quot;</span><span class="o">,</span> <span class="n">token</span><span class="o">);</span>

        <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">revokeRestOperations</span><span class="o">.</span><span class="na">postForObject</span><span class="o">(</span><span class="n">revokeTokenUrl</span><span class="o">,</span>
            <span class="k">new</span> <span class="n">HttpEntity</span><span class="o">&lt;</span><span class="n">MultiValueMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;(</span><span class="n">variables</span><span class="o">,</span> <span class="n">headers</span><span class="o">),</span>
            <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span> <span class="c1">// (4)</span>
        <span class="c1">// (5)</span>
        <span class="k">if</span> <span class="o">(</span><span class="s">&quot;success&quot;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">result</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">initContextToken</span><span class="o">(</span><span class="n">oauth2RestOperations</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// (6)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="nf">getTokenValue</span><span class="o">(</span><span class="n">OAuth2RestOperations</span> <span class="n">oauth2RestOperations</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">tokenValue</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
        <span class="n">OAuth2AccessToken</span> <span class="n">token</span> <span class="o">=</span> <span class="n">oauth2RestOperations</span><span class="o">.</span><span class="na">getAccessToken</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">token</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">tokenValue</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">tokenValue</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// (7)</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">initContextToken</span><span class="o">(</span><span class="n">OAuth2RestOperations</span> <span class="n">oauth2RestOperations</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">oauth2RestOperations</span><span class="o">.</span><span class="na">getOAuth2ClientContext</span><span class="o">().</span><span class="na">setAccessToken</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">URL to be used while requesting the cancellation of access token to the authorization server.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inject <code class="docutils literal"><span class="pre">OAuth2RestTemplate</span></code> which retains the access token to be cancelled.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inject <code class="docutils literal"><span class="pre">RestTemplate</span></code> for cancelling the access token.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In order to cancel the access token in authorization server, it is accessed with method POST in REST.</div>
<div class="line">Set value of access token to be cancelled in the request parameter for passing it to the authorization server.</div>
<div class="line">Access token is fetched by passing <code class="docutils literal"><span class="pre">OAuth2RestOperations</span></code> to <code class="docutils literal"><span class="pre">getTokenValue</span></code> method defined in (5).</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Process result of authorization server is determined and only when it is normal, the access token retained by ``OAuth2RestOperations`` is deleted.</div>
<div class="line">Access token is deleted by passing <code class="docutils literal"><span class="pre">OAuth2RestOperations</span></code> retaining the access token in <code class="docutils literal"><span class="pre">initContextToken</span></code> method defined in (6).</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Method of getting the access token retained by <code class="docutils literal"><span class="pre">OAuth2RestOperations</span></code> .</div>
<div class="line">Access token is fetched and returned by calling the <code class="docutils literal"><span class="pre">getAccessToken</span></code> method of <code class="docutils literal"><span class="pre">OAuth2RestOperations</span></code> passed as a parameter.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Method of deleting the access token retained by <code class="docutils literal"><span class="pre">OAuth2RestOperations</span></code> .</div>
<div class="line">Delete the access token by passing the null in <code class="docutils literal"><span class="pre">setAccessToken</span></code> method of <code class="docutils literal"><span class="pre">OAuth2RestOperations</span></code> passed as a parameter.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">Client cancels the token by calling the service created above when the access token is not required.</div>
<div class="line">Since the default implementation of Spring Security OAuth retains the access token in scope of session, the token seems to be cancelled when client user logs-out or when session is revoked due to session timeout.</div>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-extend">
<span id="oauthhowtoextend"></span><h2><a class="toc-backref" href="#id64">9.10.3. How to extend</a><a class="headerlink" href="#how-to-extend" title="Permalink to this headline">¶</a></h2>
<div class="section" id="linking-authorization-server-and-resource-server-through-endpoints">
<h3><a class="toc-backref" href="#id65">9.10.3.1. Linking Authorization Server and Resource Server through endpoints</a><a class="headerlink" href="#linking-authorization-server-and-resource-server-through-endpoints" title="Permalink to this headline">¶</a></h3>
<p>The Resource Server and Authorization Server can be linked by performing HTTP access from the Resource Server to the check token endpoint of the Authorization Server.</p>
<p>Check token endpoint is the endpoint that receives the value of access token from the Resource Server and verifies the token instead of the Resource Server.
Check token endpoint fetches and verifies the access token using ``TokenServices``, and passes the information associated with the access token to the Resource Server when there is no problem in the verification.</p>
<div class="section" id="linkage-through-http-access">
<span id="oauthauthorizationserverhowtocooperatewithhttp"></span><h4><a class="toc-backref" href="#id66">9.10.3.1.1. Linkage through HTTP access</a><a class="headerlink" href="#linkage-through-http-access" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Use ``org.springframework.security.oauth2.provider.token.RemoteTokenServices``  that is the implementation class of `` TokenServices``  for the Resource Server to access the check token endpoint of the Authorization Server.</div>
<div class="line">``RemoteTokenServices`` performs HTTP access of check token endpoint using <code class="docutils literal"><span class="pre">org.springframework.web.client.RestTemplate</span></code> and fetches the information associated with the access token.</div>
<div class="line">Since the access token is verified by the check token endpoint, it is not verified by <code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>.</div>
</div>
<p>The implementation example is shown below.</p>
<p>First, perform the settings for registering <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.endpoint.CheckTokenEndpoint</span></code>class as component for verifying token in the Authorization Server.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span> <span class="na">pattern=</span><span class="s">&quot;/oth2/check-token&quot;</span> <span class="na">security=</span><span class="s">&quot;none&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>

<span class="nt">&lt;oauth2:authorization-server</span>
     <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span>
     <span class="na">token-endpoint-url=</span><span class="s">&quot;/oth2/token&quot;</span>
     <span class="na">authorization-endpoint-url=</span><span class="s">&quot;/oth2/authorize&quot;</span>
     <span class="na">user-approval-handler-ref=</span><span class="s">&quot;userApprovalHandler&quot;</span>
     <span class="na">token-services-ref=</span><span class="s">&quot;tokenServices&quot;</span>
     <span class="na">check-token-enabled=</span><span class="s">&quot;true&quot;</span>
     <span class="na">check-token-endpoint-url=</span><span class="s">&quot;/oth2/check-token&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;oauth2:authorization-code</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:implicit</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:client-credentials</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:password</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In this guideline, it is assumed that access to the check token endpoint is by network configuration that allows only the Resource Server and is excluded from the security function (Security Filter) of Spring Security.</div>
<div class="line">It should be mentioned at the beginning of the configuration file so that it will be evaluated before any other security settings.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">CheckTokenEndpoint</span></code> is registered as the component by specifying <code class="docutils literal"><span class="pre">true</span></code> in <code class="docutils literal"><span class="pre">check-token-enabled</span></code> attribute of <code class="docutils literal"><span class="pre">&lt;oauth2:authorization-server&gt;tag</span></code>.</div>
<div class="line">Specify URL of <code class="docutils literal"><span class="pre">CheckTokenEndpoint</span></code> in <code class="docutils literal"><span class="pre">check-token-endpoint-url</span></code> attribute of <code class="docutils literal"><span class="pre">&lt;oauth2:authorization-server&gt;tag</span></code>. When it is not specified, the default value &#8220;/oauth/check_token&#8221; is specified.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>Security measures of check token endpoint</strong></p>
<ul class="last simple">
<li>Check token endpoint is accessible only between Authorization Server and Resource Server so it cannot be accessed from open network.
When disclosing the check token endpoint, it is necessary to take appropriate security measures.</li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Note that when Spring Security OAuth 2.0.12 or earlier version is used and <code class="docutils literal"><span class="pre">authorization-endpoint-url</span></code> or <code class="docutils literal"><span class="pre">token-endpoint-url</span></code>is not specified in <code class="docutils literal"><span class="pre">check-token-endpoint-url</span></code>, it will not be reflected.
It is addressed in the following issue and is expected to be fixed in Version 2.0.13.</p>
<p class="last"><a class="reference external" href="https://github.com/spring-projects/spring-security-oauth/issues/897">https://github.com/spring-projects/spring-security-oauth/issues/897</a></p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Use <code class="docutils literal"><span class="pre">DefaultTokenServices</span></code> same when linking  <code class="docutils literal"><span class="pre">TokenServices</span></code> through shared DB.
<code class="docutils literal"><span class="pre">TokenStore</span></code> referred by <code class="docutils literal"><span class="pre">TokenServices</span></code> uses the implementation class of the interface as per the application requirements.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Perform the settings to use <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.RemoteTokenServices</span></code> as <code class="docutils literal"><span class="pre">TokenServices</span></code> in the configuration file of the Resource Server.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;tokenServices&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.RemoteTokenServices&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;checkTokenEndpointUrl&quot;</span> <span class="na">value=</span><span class="s">&quot;${auth.serverUrl}/oth2/check-token&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define Bean for <code class="docutils literal"><span class="pre">RemoteTokenServices</span></code> to enable fetching of information associated with the access token by accessing the check token endpoint of the Authorization Server.</div>
<div class="line">Set the URL in <code class="docutils literal"><span class="pre">checkTokenEndpointUrl</span></code> property to access check token endpoint.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When verification error of access token occurs in the check token endpoint, HTTP status code 400(Bad Request) is returned in <code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>.
When HTTP status code 400(Bad Request) is returned in the default implementation of <code class="docutils literal"><span class="pre">RestTemplate</span></code>, error handling is done and client error exception is generated.
<code class="docutils literal"><span class="pre">RestTemplate</span></code>to be used by <code class="docutils literal"><span class="pre">RemoteTokenServices</span></code> by default, is extended so that error handling is not performed when HTTP status code of response is 400 in order to link verification error of the access token to the client server.
When <code class="docutils literal"><span class="pre">RestTemplate</span></code> is injected in <code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>, note that this extension will not be applied.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>When <code class="docutils literal"><span class="pre">RemoteTokenServices</span></code> is used in the Resource Server, the username of the resource owner can be fetched by specifying <code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code> annotation in the handler method as the argument annotation in <code class="docutils literal"><span class="pre">String</span></code>.</p>
<p>The implementation example is as follows.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;api&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="o">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;todos&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">list</span><span class="o">(</span><span class="nd">@AuthenticationPrincipal</span> <span class="n">String</span> <span class="n">userName</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (1)</span>

        <span class="c1">// omitted</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Username of resource owner is stored in argument <code class="docutils literal"><span class="pre">userName</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="extension-of-defaultaccesstokenconverter">
<span id="oauthauthorizationserverhowtogetotherthanusername"></span><h4><a class="toc-backref" href="#id67">9.10.3.1.2. Extension of DefaultAccessTokenConverter</a><a class="headerlink" href="#extension-of-defaultaccesstokenconverter" title="Permalink to this headline">¶</a></h4>
<p>Even in case of the structure where DB is not shared between Authorization Server and Resource Server, there may be a case to link the item corresponding to the user information from the Authorization Server to the Resource Server, however
when <code class="docutils literal"><span class="pre">RemoteTokenServices</span></code> is to be used as <code class="docutils literal"><span class="pre">TokenServices</span></code> by the Resource Server, the information other than the user information cannot be fetched by the annotation <code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>of handler method argument of the Resource Server.</p>
<p>An example of extending <code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.DefaultAccessTokenConverter</span></code>that is a class to be used for linking access token by using <code class="docutils literal"><span class="pre">RemoteTokenServices</span></code>and linking the information other than the username to the Resource Server is shown here.</p>
<div class="section" id="defaultaccesstokenconverter-means">
<h5><a class="toc-backref" href="#id68">9.10.3.1.2.1. DefaultAccessTokenConverter means</a><a class="headerlink" href="#defaultaccesstokenconverter-means" title="Permalink to this headline">¶</a></h5>
<p>Request authentication information of resource owner and client of the access token value to the Authorization Server from the Resource Server by using <code class="docutils literal"><span class="pre">RestTemplate</span></code>and fetch the result as Map for linking access token wherein <code class="docutils literal"><span class="pre">RemoteTokenServices</span></code> is used.
<code class="docutils literal"><span class="pre">DefaultAccessTokenConverter</span></code> is used as a convertor that converts the authentication information in Authorization Server to Map and Map in Resource Server to the authentication information.</p>
<p>By using this, the parameters linked between the Authorization Server and the Resource Server can be customized by extending ``DefaultAccessTokenConverter`` so as to add the return value from the Authorization Server to the Map.</p>
<p>In the following explanation, an example of linking independent items related to user information and independent items other than this to each other by customizing ``DefaultAccessTokenConverter`` and its property ``DefaultUserAuthenticationConverter``  in the Authorization Server, is shown.</p>
</div>
<div class="section" id="id3">
<h5><a class="toc-backref" href="#id69">9.10.3.1.2.2. Implementation of Authorization Server</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h5>
<p>How to implement Authorization Server is explained.</p>
<p>First, extend <code class="docutils literal"><span class="pre">DefaultUserAuthenticationConverter</span></code> for adding independent item of the user information.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">AuthCustomUserTokenConverter.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomUserTokenConverter</span> <span class="kd">extends</span> <span class="n">DefaultUserAuthenticationConverter</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">convertUserAuthentication</span><span class="o">(</span>
            <span class="n">Authentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>
        <span class="n">response</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">USERNAME</span><span class="o">,</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">authentication</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                <span class="o">!</span><span class="n">authentication</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">response</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">AUTHORITIES</span><span class="o">,</span> <span class="n">AuthorityUtils</span><span class="o">.</span><span class="na">authorityListToSet</span><span class="o">(</span>
                    <span class="n">authentication</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">()));</span>
        <span class="o">}</span>
        <span class="n">response</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;user_additional_key&quot;</span><span class="o">,</span> <span class="s">&quot;user_additional_value&quot;</span><span class="o">);</span> <span class="c1">// (1)</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define the information to be passed to the Resource Server as an independent item <code class="docutils literal"><span class="pre">user_additional_key</span></code> and set to <code class="docutils literal"><span class="pre">response</span></code>.</div>
<div class="line">The information set in <code class="docutils literal"><span class="pre">response</span></code>, is returned to the Resource Server in JSON format as response BODY at the time of verifying the token of check token endpoint.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Then, extend <code class="docutils literal"><span class="pre">DefaultAccessTokenConverter</span></code> for adding independent item of other than the user information.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">CustomAccessTokenConverter.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomAccessTokenConverter</span> <span class="kd">extends</span> <span class="n">DefaultAccessTokenConverter</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">convertAccessToken</span><span class="o">(</span><span class="n">OAuth2AccessToken</span> <span class="n">token</span><span class="o">,</span> <span class="n">OAuth2Authentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="o">{</span>

        <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unchecked&quot;</span><span class="o">)</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;)</span> <span class="kd">super</span><span class="o">.</span><span class="na">convertAccessToken</span><span class="o">(</span><span class="n">token</span><span class="o">,</span> <span class="n">authentication</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;client_additional_key&quot;</span><span class="o">,</span><span class="s">&quot;client_additional_value&quot;</span><span class="o">);</span> <span class="c1">// (1)</span>
        <span class="c1">// omitted</span>

        <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define the information to be passed to the Resource Server as an independent item <code class="docutils literal"><span class="pre">client_additional_key</span></code> and set to <code class="docutils literal"><span class="pre">response</span></code>.</div>
<div class="line">The information set in <code class="docutils literal"><span class="pre">response</span></code>, is returned to the Resource Server in JSON format as response BODY at the time of verifying the token of check token endpoint.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Perform the settings of <code class="docutils literal"><span class="pre">CustomUserTokenConverter</span></code> and <code class="docutils literal"><span class="pre">CustomAccessTokenConverter</span></code> created in the configuration file of the Authorization Server.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-auth.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;oauth2:authorization-server</span>
     <span class="na">client-details-service-ref=</span><span class="s">&quot;clientDetailsService&quot;</span>
     <span class="na">token-endpoint-url=</span><span class="s">&quot;/oth2/token&quot;</span>
     <span class="na">authorization-endpoint-url=</span><span class="s">&quot;/oth2/authorize&quot;</span>
     <span class="na">user-approval-handler-ref=</span><span class="s">&quot;userApprovalHandler&quot;</span>
     <span class="na">token-services-ref=</span><span class="s">&quot;tokenServices&quot;</span>
     <span class="na">check-token-endpoint-url=</span><span class="s">&quot;/oth2/check-token&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;oauth2:authorization-code</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:implicit</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:refresh-token</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:client-credentials</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;oauth2:password</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/oauth2:authorization-server&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;checkTokenEndpoint&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.endpoint.CheckTokenEndpoint&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;tokenServices&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;accessTokenConverter&quot;</span> <span class="na">ref=</span><span class="s">&quot;accessTokenConverter&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;accessTokenConverter&quot;</span>
    <span class="na">class=</span><span class="s">&quot;com.example.oauth2.auth.converter.CustomAccessTokenConverter&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;userTokenConverter&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;bean</span>
            <span class="na">class=</span><span class="s">&quot;com.example.oauth2.auth.converter.CustomUserTokenConverter&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the URL of ``CheckTokenEndpoint`` defined in (2) in the <code class="docutils literal"><span class="pre">check-token-endpoint-url</span></code> attribute of ``&lt;oauth2: authorization-server&gt;``tag. When not specified, the default value &#8220;/ oauth / check_token&#8221; is specified.</div>
<div class="line">Since Bean definition for ``CheckTokenEndpoint`` is done independently in (2), do not specify ``check-token-enabled``attribute of ``&lt;oauth2:authorization-server&gt;``tag.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define Bean for <code class="docutils literal"><span class="pre">CheckTokenEndpoint</span></code>.</div>
<div class="line">By specifying Bean of <code class="docutils literal"><span class="pre">CustomAccessTokenConverter</span></code> defined in (2) in <code class="docutils literal"><span class="pre">accessTokenConverter</span></code>property, independent items added in <code class="docutils literal"><span class="pre">CustomAccessTokenConverter</span></code> and <code class="docutils literal"><span class="pre">CustomUserTokenConverter</span></code> can be linked to the Resource Server.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define Bean for <code class="docutils literal"><span class="pre">CustomAccessTokenConverter</span></code> wherein <code class="docutils literal"><span class="pre">DefaultAccessTokenConverter</span></code> is extended.</div>
<div class="line">Specify Bean for <code class="docutils literal"><span class="pre">CustomUserTokenConverter</span></code> wherein <code class="docutils literal"><span class="pre">DefaultUserAuthenticationConverter</span></code> is extended in <code class="docutils literal"><span class="pre">userTokenConverter</span></code> property.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id4">
<h5><a class="toc-backref" href="#id70">9.10.3.1.2.3. Implementation of Resource Server</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h5>
<p>Add the function to fetch the information linked from Authorization Server in the Resource Server by annotation <code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code> of the handler method argument.
First, create <code class="docutils literal"><span class="pre">OauthUser</span></code> class holding the information to be fetched by annotation <code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">OauthUser.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OauthUser</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">userAdditionalValue</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">clientAdditionalValue</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="kd">public</span> <span class="nf">User</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">additionalValue</span><span class="o">){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">username</span> <span class="o">=</span> <span class="n">username</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">additionalValue</span> <span class="o">=</span> <span class="n">additionalValue</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Getters and Setters are omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">org.springframework.security.oauth2.provider.token.DefaultAccessTokenConverter</span></code> which performs setup for enabling fetching of user information by <code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code> annotationverter`` is expanded and a function is added to enable fetching of information other than user name.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">CustomUserTokenConverter.java</span></code></li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomUserTokenConverter</span> <span class="kd">extends</span> <span class="n">DefaultUserAuthenticationConverter</span><span class="o">{</span>

    <span class="kd">private</span> <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">defaultAuthorities</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDefaultAuthorities</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">defaultAuthorities</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">defaultAuthorities</span> <span class="o">=</span> <span class="n">AuthorityUtils</span><span class="o">.</span><span class="na">commaSeparatedStringToAuthorityList</span><span class="o">(</span><span class="n">StringUtils</span>
                <span class="o">.</span><span class="na">arrayToCommaDelimitedString</span><span class="o">(</span><span class="n">defaultAuthorities</span><span class="o">));</span>
    <span class="o">}</span>

     <span class="c1">// (2)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Authentication</span> <span class="nf">extractAuthentication</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">USERNAME</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span> <span class="o">=</span> <span class="n">getAuthorities</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
            <span class="n">OauthUser</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OauthUser</span><span class="o">(</span>
                    <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">USERNAME</span><span class="o">),</span>
                    <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;user_additional_key&quot;</span><span class="o">),</span>
                    <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;client_additional_key&quot;</span><span class="o">),</span>
                    <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;client_id&quot;</span><span class="o">));</span> <span class="c1">// (3)</span>

            <span class="c1">// omitted</span>

            <span class="k">return</span> <span class="k">new</span> <span class="n">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="s">&quot;N/A&quot;</span><span class="o">,</span> <span class="n">authorities</span><span class="o">);</span> <span class="c1">// (4)</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">map</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">AUTHORITIES</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">defaultAuthorities</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">Object</span> <span class="n">authorities</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">AUTHORITIES</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">authorities</span> <span class="k">instanceof</span> <span class="n">String</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">AuthorityUtils</span><span class="o">.</span><span class="na">commaSeparatedStringToAuthorityList</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">authorities</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">authorities</span> <span class="k">instanceof</span> <span class="n">Collection</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">AuthorityUtils</span><span class="o">.</span><span class="na">commaSeparatedStringToAuthorityList</span><span class="o">(</span><span class="n">StringUtils</span>
                    <span class="o">.</span><span class="na">collectionToCommaDelimitedString</span><span class="o">((</span><span class="n">Collection</span><span class="o">&lt;?&gt;)</span> <span class="n">authorities</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;Authorities must be either a String or a Collection&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr.No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Implement <code class="docutils literal"><span class="pre">defaultAuthorities</span></code> used by <code class="docutils literal"><span class="pre">defaultAuthorities</span></code> and <code class="docutils literal"><span class="pre">getAuthorities</span></code> method since <code class="docutils literal"><span class="pre">getAuthorities</span></code> method implemented by <code class="docutils literal"><span class="pre">DefaultUserAuthenticationConverter</span></code> is defined by private.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">A method that extracts authentication information from the information linked from authorization server.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set information linked from authorization server in <code class="docutils literal"><span class="pre">OauthUser</span></code> class.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Information linked from authorization server can be fetched <code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code> annotation by setting <code class="docutils literal"><span class="pre">OauthUser</span></code> in the first argument of <code class="docutils literal"><span class="pre">UsernamePasswordAuthenticationToken</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Configure <code class="docutils literal"><span class="pre">CustomUserTokenConverter</span></code> in setup file of resource server.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">oauth2-resource.xml</span></code></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;tokenServices&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.RemoteTokenServices&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;checkTokenEndpointUrl&quot;</span> <span class="na">value=</span><span class="s">&quot;${auth.serverUrl}/oth2/check-token&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;accessTokenConverter&quot;</span> <span class="na">ref=</span><span class="s">&quot;accessTokenConverter&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;accessTokenConverter&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.oauth2.provider.token.DefaultAccessTokenConverter&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;userTokenConverter&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;com.example.oauth2.resource.converter.CustomUserTokenConverter&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Information other than user name can be fetched  by <code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code> annotation, by specifying <code class="docutils literal"><span class="pre">CustomUserTokenConverter</span></code> class in <code class="docutils literal"><span class="pre">userTokenConverter</span></code> property of <code class="docutils literal"><span class="pre">accessTokenConverter</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../Tutorial/index.html" title="10. Tutorials"
             >next</a> |</li>
        <li class="right" >
          <a href="SecureLoginDemo.html" title="9.9. Implementation Example of Typical Security Requirements"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.3.0.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >9. Security countermeasures</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer">
      © Copyright 2013-2017, NTT DATA Corporation. © Copyright 2017, NTT Corporation.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.4.8.Theme by <a href="http://github.com/vkvn">vkvn</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>5.2. RESTクライアント（HTTPクライアント） &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.9.0.RELEASE documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/solar.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/tabs.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="6. データアクセス" href="../DataAccessDetail/index.html" />
    <link rel="prev" title="5.1. RESTful Web Service" href="REST.html" /><script src="../../_static/jquery.js" type="text/javascript"></script>
<script src="../../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../../_static/solarized-dark.css" rel="stylesheet">
<link href="../../_static/jquery.treeview.css" rel="stylesheet">
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../DataAccessDetail/index.html" title="6. データアクセス"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="REST.html" title="5.1. RESTful Web Service"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.9.0.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U"><span class="section-number">5. </span>Web Service</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">5.2. </span>RESTクライアント（HTTPクライアント）</a></li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox"> scroll sidebar</label>
  <div>
    <h3><a href="../../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">5.2. RESTクライアント（HTTPクライアント）</a><ul>
<li><a class="reference internal" href="#overview">5.2.1. Overview</a><ul>
<li><a class="reference internal" href="#resttemplate">5.2.1.1. <code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>とは</a><ul>
<li><a class="reference internal" href="#httpmessageconverter">5.2.1.1.1. <code class="docutils literal notranslate"><span class="pre">HttpMessageConverter</span></code></a></li>
<li><a class="reference internal" href="#clienthttprequestfactory">5.2.1.1.2. <code class="docutils literal notranslate"><span class="pre">ClientHttpRequestFactory</span></code></a></li>
<li><a class="reference internal" href="#responseerrorhandler">5.2.1.1.3. <code class="docutils literal notranslate"><span class="pre">ResponseErrorHandler</span></code></a></li>
<li><a class="reference internal" href="#clienthttprequestinterceptor">5.2.1.1.4. <code class="docutils literal notranslate"><span class="pre">ClientHttpRequestInterceptor</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">5.2.2. How to use</a><ul>
<li><a class="reference internal" href="#restclienthowtousesetup">5.2.2.1. <code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>のセットアップ</a><ul>
<li><a class="reference internal" href="#id8">5.2.2.1.1. 依存ライブラリ設定</a></li>
<li><a class="reference internal" href="#resttemplatebean">5.2.2.1.2. <code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>のbean定義</a></li>
<li><a class="reference internal" href="#id9">5.2.2.1.3. <code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>の利用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#get">5.2.2.2. GETリクエストの送信</a><ul>
<li><a class="reference internal" href="#getforobject">5.2.2.2.1. <code class="docutils literal notranslate"><span class="pre">getForObject</span></code>メソッドを使用した実装</a></li>
<li><a class="reference internal" href="#getforentity">5.2.2.2.2. <code class="docutils literal notranslate"><span class="pre">getForEntity</span></code>メソッドを使用した実装</a></li>
<li><a class="reference internal" href="#exchange">5.2.2.2.3. <code class="docutils literal notranslate"><span class="pre">exchange</span></code>メソッドを使用した実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#post">5.2.2.3. POSTリクエストの送信</a><ul>
<li><a class="reference internal" href="#postforobject">5.2.2.3.1. <code class="docutils literal notranslate"><span class="pre">postForObject</span></code>メソッドを使用した実装</a></li>
<li><a class="reference internal" href="#postforentity">5.2.2.3.2. <code class="docutils literal notranslate"><span class="pre">postForEntity</span></code>メソッドを使用した実装</a></li>
<li><a class="reference internal" href="#id10">5.2.2.3.3. <code class="docutils literal notranslate"><span class="pre">exchange</span></code>メソッドを使用した実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#restclienthowtousegetcollection">5.2.2.4. コレクション形式のデータ取得</a></li>
<li><a class="reference internal" href="#restclienthowtouserequestheader">5.2.2.5. リクエストヘッダの設定</a><ul>
<li><a class="reference internal" href="#content-type">5.2.2.5.1. Content-Typeヘッダの設定</a></li>
<li><a class="reference internal" href="#accept">5.2.2.5.2. Acceptヘッダの設定</a></li>
<li><a class="reference internal" href="#restclienthowtouserequestheaderanyheader">5.2.2.5.3. 任意のリクエストヘッダの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#restclienthowtouseerrorhandling">5.2.2.6. エラーハンドリング</a><ul>
<li><a class="reference internal" href="#restclienthowtouseerrorhandlinghandleexception">5.2.2.6.1. 例外ハンドリング(デフォルトの動作)</a></li>
<li><a class="reference internal" href="#responseentity">5.2.2.6.2. <code class="docutils literal notranslate"><span class="pre">ResponseEntity</span></code>の返却（エラーハンドラの拡張）</a></li>
</ul>
</li>
<li><a class="reference internal" href="#restclienthowtousetimeoutsettings">5.2.2.7. 通信タイムアウトの設定</a></li>
<li><a class="reference internal" href="#ssl">5.2.2.8. SSL自己署名証明書の使用</a></li>
<li><a class="reference internal" href="#basic">5.2.2.9. Basic認証</a></li>
<li><a class="reference internal" href="#restclienthowtousefileupload">5.2.2.10. ファイルアップロード(マルチパートリクエスト)</a></li>
<li><a class="reference internal" href="#restclienthowtousefiledownload">5.2.2.11. ファイルダウンロード</a></li>
<li><a class="reference internal" href="#restfulurl-uri">5.2.2.12. RESTfulなURL(URIテンプレート)を扱う方法と実装例</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend">5.2.3. How to extend</a><ul>
<li><a class="reference internal" href="#restclienthowtoextendhttpmessageconverter">5.2.3.1. 任意の<code class="docutils literal notranslate"><span class="pre">HttpMessageConverter</span></code>を登録する方法</a></li>
<li><a class="reference internal" href="#restclienthowtoextendclienthttprequestinterceptor">5.2.3.2. 共通処理の適用（<code class="docutils literal notranslate"><span class="pre">ClientHttpRequestInterceptor</span></code>）</a><ul>
<li><a class="reference internal" href="#restclienthowtoextendclienthttprequestinterceptorlogging">5.2.3.2.1. ロギング処理</a></li>
<li><a class="reference internal" href="#restclientbasicauthorizationinterceptorbeandefinition">5.2.3.2.2. Basic認証用のリクエストヘッダ設定処理</a></li>
<li><a class="reference internal" href="#id27">5.2.3.2.3. <code class="docutils literal notranslate"><span class="pre">ClientHttpRequestInterceptor</span></code>の適用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#restclientasync">5.2.3.3. 非同期リクエスト</a><ul>
<li><a class="reference internal" href="#id29">5.2.3.3.1. <code class="docutils literal notranslate"><span class="pre">WebClient</span></code>のセットアップ</a><ul>
<li><a class="reference internal" href="#id30">5.2.3.3.1.1. 依存ライブラリ設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#webclientbean">5.2.3.3.2. <code class="docutils literal notranslate"><span class="pre">WebClient</span></code>のbean定義</a></li>
<li><a class="reference internal" href="#restclientasyncimplementation">5.2.3.3.3. 非同期リクエストの実装</a></li>
<li><a class="reference internal" href="#restclientasynccustomize">5.2.3.3.4. カスタマイズ</a><ul>
<li><a class="reference internal" href="#id34">5.2.3.3.4.1. コネクションプールの設定</a></li>
<li><a class="reference internal" href="#id35">5.2.3.3.4.2. フィルターの設定</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix">5.2.4. Appendix</a><ul>
<li><a class="reference internal" href="#http-proxy">5.2.4.1. HTTP Proxyサーバの設定方法</a><ul>
<li><a class="reference internal" href="#simpleclienthttprequestfactoryhttp-proxy">5.2.4.1.1. SimpleClientHttpRequestFactoryを使用したHTTP Proxyサーバの設定方法</a></li>
<li><a class="reference internal" href="#httpcomponentsclienthttprequestfactoryhttp-proxy">5.2.4.1.2. HttpComponentsClientHttpRequestFactoryを使用したHTTP Proxyサーバの設定方法</a><ul>
<li><a class="reference internal" href="#restclienthttpproxcy">5.2.4.1.2.1. HTTP Proxyサーバの指定方法</a></li>
<li><a class="reference internal" href="#id38">5.2.4.1.2.2. HTTP Proxyサーバの資格情報の指定方法</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="REST.html"
                          title="previous chapter"><span class="section-number">5.1. </span>RESTful Web Service</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="../DataAccessDetail/index.html"
                          title="next chapter"><span class="section-number">6. </span>データアクセス</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/ArchitectureInDetail/WebServiceDetail/RestClient.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="rest-http">
<h1><span class="section-number">5.2. </span>RESTクライアント（HTTPクライアント）<a class="headerlink" href="#rest-http" title="Permalink to this heading">¶</a></h1>
<nav class="contents local" id="id1">
<p class="topic-title">目次</p>
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id42">Overview</a></p>
<ul>
<li><p><a class="reference internal" href="#resttemplate" id="id43"><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>とは</a></p>
<ul>
<li><p><a class="reference internal" href="#httpmessageconverter" id="id44"><code class="docutils literal notranslate"><span class="pre">HttpMessageConverter</span></code></a></p></li>
<li><p><a class="reference internal" href="#clienthttprequestfactory" id="id45"><code class="docutils literal notranslate"><span class="pre">ClientHttpRequestFactory</span></code></a></p></li>
<li><p><a class="reference internal" href="#responseerrorhandler" id="id46"><code class="docutils literal notranslate"><span class="pre">ResponseErrorHandler</span></code></a></p></li>
<li><p><a class="reference internal" href="#clienthttprequestinterceptor" id="id47"><code class="docutils literal notranslate"><span class="pre">ClientHttpRequestInterceptor</span></code></a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#how-to-use" id="id48">How to use</a></p>
<ul>
<li><p><a class="reference internal" href="#restclienthowtousesetup" id="id49"><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>のセットアップ</a></p>
<ul>
<li><p><a class="reference internal" href="#id8" id="id50">依存ライブラリ設定</a></p></li>
<li><p><a class="reference internal" href="#resttemplatebean" id="id51"><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>のbean定義</a></p></li>
<li><p><a class="reference internal" href="#id9" id="id52"><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>の利用</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#get" id="id53">GETリクエストの送信</a></p>
<ul>
<li><p><a class="reference internal" href="#getforobject" id="id54"><code class="docutils literal notranslate"><span class="pre">getForObject</span></code>メソッドを使用した実装</a></p></li>
<li><p><a class="reference internal" href="#getforentity" id="id55"><code class="docutils literal notranslate"><span class="pre">getForEntity</span></code>メソッドを使用した実装</a></p></li>
<li><p><a class="reference internal" href="#exchange" id="id56"><code class="docutils literal notranslate"><span class="pre">exchange</span></code>メソッドを使用した実装</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#post" id="id57">POSTリクエストの送信</a></p>
<ul>
<li><p><a class="reference internal" href="#postforobject" id="id58"><code class="docutils literal notranslate"><span class="pre">postForObject</span></code>メソッドを使用した実装</a></p></li>
<li><p><a class="reference internal" href="#postforentity" id="id59"><code class="docutils literal notranslate"><span class="pre">postForEntity</span></code>メソッドを使用した実装</a></p></li>
<li><p><a class="reference internal" href="#id10" id="id60"><code class="docutils literal notranslate"><span class="pre">exchange</span></code>メソッドを使用した実装</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#restclienthowtousegetcollection" id="id61">コレクション形式のデータ取得</a></p></li>
<li><p><a class="reference internal" href="#restclienthowtouserequestheader" id="id62">リクエストヘッダの設定</a></p>
<ul>
<li><p><a class="reference internal" href="#content-type" id="id63">Content-Typeヘッダの設定</a></p></li>
<li><p><a class="reference internal" href="#accept" id="id64">Acceptヘッダの設定</a></p></li>
<li><p><a class="reference internal" href="#restclienthowtouserequestheaderanyheader" id="id65">任意のリクエストヘッダの設定</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#restclienthowtouseerrorhandling" id="id66">エラーハンドリング</a></p>
<ul>
<li><p><a class="reference internal" href="#restclienthowtouseerrorhandlinghandleexception" id="id67">例外ハンドリング(デフォルトの動作)</a></p></li>
<li><p><a class="reference internal" href="#responseentity" id="id68"><code class="docutils literal notranslate"><span class="pre">ResponseEntity</span></code>の返却（エラーハンドラの拡張）</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#restclienthowtousetimeoutsettings" id="id69">通信タイムアウトの設定</a></p></li>
<li><p><a class="reference internal" href="#ssl" id="id70">SSL自己署名証明書の使用</a></p></li>
<li><p><a class="reference internal" href="#basic" id="id71">Basic認証</a></p></li>
<li><p><a class="reference internal" href="#restclienthowtousefileupload" id="id72">ファイルアップロード(マルチパートリクエスト)</a></p></li>
<li><p><a class="reference internal" href="#restclienthowtousefiledownload" id="id73">ファイルダウンロード</a></p></li>
<li><p><a class="reference internal" href="#restfulurl-uri" id="id74">RESTfulなURL(URIテンプレート)を扱う方法と実装例</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#how-to-extend" id="id75">How to extend</a></p>
<ul>
<li><p><a class="reference internal" href="#restclienthowtoextendhttpmessageconverter" id="id76">任意の<code class="docutils literal notranslate"><span class="pre">HttpMessageConverter</span></code>を登録する方法</a></p></li>
<li><p><a class="reference internal" href="#restclienthowtoextendclienthttprequestinterceptor" id="id77">共通処理の適用（<code class="docutils literal notranslate"><span class="pre">ClientHttpRequestInterceptor</span></code>）</a></p>
<ul>
<li><p><a class="reference internal" href="#restclienthowtoextendclienthttprequestinterceptorlogging" id="id78">ロギング処理</a></p></li>
<li><p><a class="reference internal" href="#restclientbasicauthorizationinterceptorbeandefinition" id="id79">Basic認証用のリクエストヘッダ設定処理</a></p></li>
<li><p><a class="reference internal" href="#id27" id="id80"><code class="docutils literal notranslate"><span class="pre">ClientHttpRequestInterceptor</span></code>の適用</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#restclientasync" id="id81">非同期リクエスト</a></p>
<ul>
<li><p><a class="reference internal" href="#id29" id="id82"><code class="docutils literal notranslate"><span class="pre">WebClient</span></code>のセットアップ</a></p></li>
<li><p><a class="reference internal" href="#webclientbean" id="id83"><code class="docutils literal notranslate"><span class="pre">WebClient</span></code>のbean定義</a></p></li>
<li><p><a class="reference internal" href="#restclientasyncimplementation" id="id84">非同期リクエストの実装</a></p></li>
<li><p><a class="reference internal" href="#restclientasynccustomize" id="id85">カスタマイズ</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#appendix" id="id86">Appendix</a></p>
<ul>
<li><p><a class="reference internal" href="#http-proxy" id="id87">HTTP Proxyサーバの設定方法</a></p>
<ul>
<li><p><a class="reference internal" href="#simpleclienthttprequestfactoryhttp-proxy" id="id88">SimpleClientHttpRequestFactoryを使用したHTTP Proxyサーバの設定方法</a></p></li>
<li><p><a class="reference internal" href="#httpcomponentsclienthttprequestfactoryhttp-proxy" id="id89">HttpComponentsClientHttpRequestFactoryを使用したHTTP Proxyサーバの設定方法</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="overview">
<span id="restclientoverview"></span><h2><a class="toc-backref" href="#id42" role="doc-backlink"><span class="section-number">5.2.1. </span>Overview</a><a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h2>
<p>本節では、Spring Frameworkが提供する<code class="docutils literal notranslate"><span class="pre">org.springframework.web.client.RestTemplate</span></code>を使用してRESTful Web Service(REST API)を呼び出す実装方法について説明する。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="resttemplate">
<span id="restclientoverviewresttemplate"></span><h3><a class="toc-backref" href="#id43" role="doc-backlink"><span class="section-number">5.2.1.1. </span><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>とは</a><a class="headerlink" href="#resttemplate" title="Permalink to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>は、REST API(Web API)を呼び出すためのメソッドを提供するクラスであり、Spring Frameworkが提供するHTTPクライアントである。</p>
<p>具体的な実装方法の説明を行う前に、<code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>がどのようにREST API(Web API)にアクセスしているかを説明する。</p>
<figure class="align-default">
<a class="reference internal image-reference" href="../../_images/RestClientOverview.png"><img alt="Constitution of RestTemplate" src="../../_images/RestClientOverview.png" style="width: 100%;" /></a>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 11.1%" />
<col style="width: 22.2%" />
<col style="width: 66.7%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>コンポーネント</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">アプリケーション</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>のメソッドを呼び出して、REST API(Web API)の呼び出し依頼を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">HttpMessageConverter</span></code>を使用して、Javaオブジェクトをリクエストボディに設定する電文(JSON等)に変換する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ClientHttpRequestFactory</span></code>から<code class="docutils literal notranslate"><span class="pre">ClientHttpRequest</span></code>を取得して、電文(JSON等)の送信依頼を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ClientHttpRequest</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">電文(JSON等)をリクエストボディに設定して、REST API(Web API)にHTTP経由でリクエストを行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ResponseErrorHandler</span></code>を使用して、HTTP通信のエラー判定及びエラー処理を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ResponseErrorHandler</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ClientHttpResponse</span></code>からレスポンスデータを取得して、エラー判定及びエラー処理を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">HttpMessageConverter</span></code>を使用して、レスポンスボディに設定されている電文(JSON等)をJavaオブジェクトに変換する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="line-block">
<div class="line">REST API(Web API)の呼び出し結果(Javaオブジェクト)をアプリケーションへ返却する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>非同期処理への対応</strong></p>
<p>REST APIからの応答を別スレッドで処理したい場合(非同期で処理したい場合)は、<code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>の代わりに<code class="docutils literal notranslate"><span class="pre">org.springframework.web.reactive.function.client.WebClient</span></code>を使用する。</p>
<p>非同期処理の実装例については、<a class="reference internal" href="#restclientasync"><span class="std std-ref">非同期リクエスト</span></a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="httpmessageconverter">
<span id="restclientoverviewhttpmessageconverter"></span><h4><a class="toc-backref" href="#id44" role="doc-backlink"><span class="section-number">5.2.1.1.1. </span><code class="docutils literal notranslate"><span class="pre">HttpMessageConverter</span></code></a><a class="headerlink" href="#httpmessageconverter" title="Permalink to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">org.springframework.http.converter.HttpMessageConverter</span></code>は、アプリケーションで扱うJavaオブジェクトとサーバと通信するための電文(JSON等)を相互に変換するためのインタフェースである。</p>
<p><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>を使用した場合、デフォルトで以下の<code class="docutils literal notranslate"><span class="pre">HttpMessageConverter</span></code>の実装クラスが登録される。</p>
<table class="longtable docutils align-default" id="id39">
<caption><span class="caption-text"><strong>デフォルトで登録されるHttpMessageConverter</strong></span><a class="headerlink" href="#id39" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 5.0%" />
<col style="width: 25.0%" />
<col style="width: 55.0%" />
<col style="width: 15.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>クラス名</p></th>
<th class="head"><p>説明</p></th>
<th class="head"><p>サポート型</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.http.converter.</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ByteArrayHttpMessageConverter</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">「HTTPボディ(テキスト or バイナリデータ)⇔バイト配列」変換用のクラス。</div>
<div class="line">デフォルトですべてのメディアタイプ(<code class="docutils literal notranslate"><span class="pre">*/*</span></code>)をサポートする。</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">byte[]</span></code></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.http.converter.</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">StringHttpMessageConverter</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">「HTTPボディ(テキスト)⇔文字列」変換用のクラス。</div>
<div class="line">デフォルトですべてのテキストメディアタイプ(<code class="docutils literal notranslate"><span class="pre">text/*</span></code>)をサポートする。</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">String</span></code></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.http.converter.</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ResourceHttpMessageConverter</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">「HTTPボディ(バイナリデータ)⇔Springのリソースオブジェクト」変換用のクラス。</div>
<div class="line">デフォルトですべてのメディアタイプ(<code class="docutils literal notranslate"><span class="pre">*/*</span></code>)をサポートする。</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">Resource</span></code><a class="footnote-reference brackets" href="#p1" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.http.converter.xml.</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">SourceHttpMessageConverter</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">「HTTPボディ(XML)⇔XMLソースオブジェクト」変換用のクラス。</div>
<div class="line">デフォルトでXML用のメディアタイプ(<code class="docutils literal notranslate"><span class="pre">text/xml</span></code>,<code class="docutils literal notranslate"><span class="pre">application/xml</span></code>,<code class="docutils literal notranslate"><span class="pre">application/*-xml</span></code>)をサポートする。</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">Source</span></code><a class="footnote-reference brackets" href="#p2" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.http.converter.support.</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">AllEncompassingFormHttpMessageConverter</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">「HTTPボディ⇔<code class="docutils literal notranslate"><span class="pre">MultiValueMap</span></code>オブジェクト」変換用のクラス。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">FormHttpMessageConverter</span></code>の拡張クラスで、multipartのパートデータとしてXMLとJSONへの変換がサポートされている。</div>
<div class="line">デフォルトでフォームデータ用のメディアタイプ(<code class="docutils literal notranslate"><span class="pre">application/x-www-form-urlencoded</span></code>,<code class="docutils literal notranslate"><span class="pre">multipart/form-data</span></code>)をサポートする。</div>
</div>
<ul class="simple">
<li><p>メディアタイプが<code class="docutils literal notranslate"><span class="pre">application/x-www-form-urlencoded</span></code>の場合、<code class="docutils literal notranslate"><span class="pre">MultiValueMap&lt;String,</span> <span class="pre">String&gt;</span></code>として読込/書込される。</p></li>
<li><p>メディアタイプが<code class="docutils literal notranslate"><span class="pre">multipart/form-data</span></code>の場合、<code class="docutils literal notranslate"><span class="pre">MultiValueMap&lt;String,</span> <span class="pre">Object&gt;</span></code>として書込され、<code class="docutils literal notranslate"><span class="pre">Object</span></code>は<code class="docutils literal notranslate"><span class="pre">AllEncompassingFormHttpMessageConverter</span></code>内に別途設定される<code class="docutils literal notranslate"><span class="pre">HttpMessageConveter</span></code>で変換される。（注意： Note 参照）</p></li>
</ul>
<div class="line-block">
<div class="line">デフォルトで登録されるパートデータ変換用の<code class="docutils literal notranslate"><span class="pre">HttpMessageConveter</span></code>は、<a class="reference external" href="https://github.com/spring-projects/spring-framework/blob/v6.1.3/spring-web/src/main/java/org/springframework/http/converter/support/AllEncompassingFormHttpMessageConverter.java">AllEncompassingFormHttpMessageConverter</a>と <a class="reference external" href="https://github.com/spring-projects/spring-framework/blob/v6.1.3/spring-web/src/main/java/org/springframework/http/converter/FormHttpMessageConverter.java">FormHttpMessageConverter</a>のソースを参照されたい。なお、任意の<code class="docutils literal notranslate"><span class="pre">HttpMessageConverter</span></code>を登録することもできる。</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">MultiValueMap</span></code><a class="footnote-reference brackets" href="#p3" id="id4" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a></div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>AllEncompassingFormHttpMessageConverterのメディアタイプがmultipart/form-dataの場合について</strong></p>
<p>メディアタイプが<code class="docutils literal notranslate"><span class="pre">multipart/form-data</span></code>の場合、「<code class="docutils literal notranslate"><span class="pre">MultiValueMap</span></code>オブジェクト から HTTPボディ」への変換は可能だが、「HTTPボディ から <code class="docutils literal notranslate"><span class="pre">MultiValueMap</span></code>オブジェクト」への変換は現状サポートされていない。よって、「HTTPボディ から <code class="docutils literal notranslate"><span class="pre">MultiValueMap</span></code>オブジェクト」への変換を行いたい場合は、独自に実装する必要がある。</p>
</div>
<table class="longtable docutils align-default" id="id40">
<caption><span class="caption-text"><strong>依存ライブラリがクラスパス上に存在する場合に登録されるHttpMessageConverter</strong></span><a class="headerlink" href="#id40" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 5.0%" />
<col style="width: 25.0%" />
<col style="width: 55.0%" />
<col style="width: 15.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>クラス名</p></th>
<th class="head"><p>説明</p></th>
<th class="head"><p>サポート型</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.http.converter.feed.</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">AtomFeedHttpMessageConverter</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">「HTTPボディ(Atom)⇔Atomフィードオブジェクト」変換用のクラス。</div>
<div class="line">デフォルトでATOM用のメディアタイプ(<code class="docutils literal notranslate"><span class="pre">application/atom+xml</span></code>)をサポートする。</div>
<div class="line">(ROMEがクラスパスに存在する場合に登録される)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">Feed</span></code><a class="footnote-reference brackets" href="#p4" id="id5" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.http.converter.feed.</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">RssChannelHttpMessageConverter</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">「HTTPボディ(RSS)⇔Rssチャネルオブジェクト」変換用のクラス。</div>
<div class="line">デフォルトでRSS用のメディアタイプ(<code class="docutils literal notranslate"><span class="pre">application/rss+xml</span></code>)をサポートする。</div>
<div class="line">(ROMEがクラスパスに存在する場合に登録される)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">Channel</span></code><a class="footnote-reference brackets" href="#p5" id="id6" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.http.converter.json.</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">MappingJackson2HttpMessageConverter</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">「HTTPボディ(JSON)⇔JavaBean」変換用のクラス。</div>
<div class="line">デフォルトでJSON用のメディアタイプ(<code class="docutils literal notranslate"><span class="pre">application/json</span></code>,<code class="docutils literal notranslate"><span class="pre">application/*+json</span></code>)をサポートする。</div>
<div class="line">(Jackson2がクラスパスに存在する場合に登録される)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">Object</span></code>(JavaBean)</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Map</span></code></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.http.converter.xml.</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">MappingJackson2XmlHttpMessageConverter</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">「HTTPボディ(XML)⇔JavaBean」変換用のクラス。</div>
<div class="line">デフォルトでXML用のメディアタイプ(<code class="docutils literal notranslate"><span class="pre">text/xml</span></code>,<code class="docutils literal notranslate"><span class="pre">application/xml</span></code>,<code class="docutils literal notranslate"><span class="pre">application/*-xml</span></code>)をサポートする。</div>
<div class="line">(Jackson-dataformat-xmlがクラスパスに存在する場合に登録される)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">Object</span></code>(JavaBean)</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Map</span></code></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.http.converter.xml.</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Jaxb2RootElementHttpMessageConverter</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">「HTTPボディ(XML)⇔JavaBean」変換用のクラス。</div>
<div class="line">デフォルトでXML用のメディアタイプ(<code class="docutils literal notranslate"><span class="pre">text/xml</span></code>,<code class="docutils literal notranslate"><span class="pre">application/xml</span></code>,<code class="docutils literal notranslate"><span class="pre">application/*-xml</span></code>)をサポートする。</div>
<div class="line">(JAXBがクラスパスに存在する場合に登録される)</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Java SE 17環境にてJAXBをクラスパスに登録するには<a class="reference internal" href="../../Appendix/Java17Settings.html#remove-jaxb-from-java11"><span class="std std-ref">JAXBの削除</span></a>を参照されたい。</p>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">Object</span></code>(JavaBean)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.http.converter.json.</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">GsonHttpMessageConverter</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">「HTTPボディ(JSON)⇔JavaBean」変換用のクラス。</div>
<div class="line">デフォルトでJSON用のメディアタイプ(<code class="docutils literal notranslate"><span class="pre">application/json</span></code>,<code class="docutils literal notranslate"><span class="pre">application/*+json</span></code>)をサポートする。</div>
<div class="line">(Gsonがクラスパスに存在する場合に登録される)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">Object</span></code>(JavaBean)</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Map</span></code></div>
</div>
</td>
</tr>
</tbody>
</table>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="p1" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">1</a><span class="fn-bracket">]</span></span>
<p><code class="docutils literal notranslate"><span class="pre">org.springframework.core.io</span></code>パッケージのクラス</p>
</aside>
<aside class="footnote brackets" id="p2" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">2</a><span class="fn-bracket">]</span></span>
<p><code class="docutils literal notranslate"><span class="pre">jakarta.xml.transform</span></code>パッケージのクラス</p>
</aside>
<aside class="footnote brackets" id="p3" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id4">3</a><span class="fn-bracket">]</span></span>
<p><code class="docutils literal notranslate"><span class="pre">org.springframework.util</span></code>パッケージのクラス</p>
</aside>
<aside class="footnote brackets" id="p4" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id5">4</a><span class="fn-bracket">]</span></span>
<p><code class="docutils literal notranslate"><span class="pre">com.rometools.rome.feed.atom</span></code>パッケージのクラス</p>
</aside>
<aside class="footnote brackets" id="p5" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id6">5</a><span class="fn-bracket">]</span></span>
<p><code class="docutils literal notranslate"><span class="pre">com.rometools.rome.feed.rss</span></code>パッケージのクラス</p>
</aside>
</aside>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="clienthttprequestfactory">
<span id="restclientoverviewclienthttprequestfactory"></span><h4><a class="toc-backref" href="#id45" role="doc-backlink"><span class="section-number">5.2.1.1.2. </span><code class="docutils literal notranslate"><span class="pre">ClientHttpRequestFactory</span></code></a><a class="headerlink" href="#clienthttprequestfactory" title="Permalink to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>は、サーバとの通信処理を以下の３つのインタフェースの実装クラスに委譲することで実現している。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">org.springframework.http.client.ClientHttpRequestFactory</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">org.springframework.http.client.ClientHttpRequest</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">org.springframework.http.client.ClientHttpResponse</span></code></p></li>
</ul>
<p>この3つのインタフェースのうち、開発者が意識するのは<code class="docutils literal notranslate"><span class="pre">ClientHttpRequestFactory</span></code>である。<code class="docutils literal notranslate"><span class="pre">ClientHttpRequestFactory</span></code>は、サーバとの通信処理を行うクラス(<code class="docutils literal notranslate"><span class="pre">ClientHttpRequest</span></code>と <code class="docutils literal notranslate"><span class="pre">ClientHttpResponse</span></code>インタフェースの実装クラス)を解決する役割を担っている。</p>
<p>なお、Spring Frameworkが提供している主な<code class="docutils literal notranslate"><span class="pre">ClientHttpRequestFactory</span></code>の実装クラスは以下の通りである。</p>
<table class="docutils align-default" id="id41">
<caption><span class="caption-text"><strong>Spring Frameworkが提供している主なClientHttpRequestFactoryの実装クラス</strong></span><a class="headerlink" href="#id41" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 5.0%" />
<col style="width: 25.0%" />
<col style="width: 70.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>クラス名</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.http.client.</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">SimpleClientHttpRequestFactory</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Java SE標準の<a class="reference external" href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/net/HttpURLConnection.html">HttpURLConnection</a>のAPIを使用して通信処理(同期、非同期)を行うための実装クラス。(デフォルトで使用される実装クラス)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.http.client.</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">HttpComponentsClientHttpRequestFactory</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><a class="reference external" href="https://hc.apache.org/httpcomponents-client-5.2.x/5.2.3/">Apache HttpComponents HttpClient</a>のAPIを使用して同期型の通信処理を行うための実装クラス。(HttpClient 5.2以上が必要)</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.http.client.</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">OkHttpClientHttpRequestFactory</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><a class="reference external" href="https://square.github.io/okhttp/">Square OkHttp</a>のAPIを使用して通信処理（同期、非同期）を行うための実装クラス。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>使用するClientHttpRequestFactoryの実装クラスについて</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>が使用するデフォルト実装は<code class="docutils literal notranslate"><span class="pre">SimpleClientHttpRequestFactory</span></code>であり、本ガイドラインでも<code class="docutils literal notranslate"><span class="pre">SimpleClientHttpRequestFactory</span></code>を使用した際の実装例となっている。Java SEの<code class="docutils literal notranslate"><span class="pre">HttpURLConnection</span></code>で要件が満たせない場合は、Netty、Apache Http Componentsなどのライブラリの利用を検討されたい。</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Content-Lengthヘッダについて</strong></p>
<p>Spring Framework 6.1より、<code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>のメモリ使用量を減らすために、ほとんどの<code class="docutils literal notranslate"><span class="pre">ClientHttpRequestFactory</span></code>実装クラスはサーバーへ送信する前にリクエストボディをバッファリングしなくなった。これにより、Content-Lengthヘッダが設定されなくなったため、Content-Lengthヘッダを設定する必要がある場合は<a class="reference external" href="https://docs.spring.io/spring-framework/docs/6.1.3/javadoc-api/org/springframework/http/client/BufferingClientHttpRequestFactory.html">BufferingClientHttpRequestFactory</a>で<code class="docutils literal notranslate"><span class="pre">ClientHttpRequestFactory</span></code>をラップする必要がある。</p>
<ul>
<li><p><strong>bean定義ファイルの定義例</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-0-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-0-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-0-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-0-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-0-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">ApplicationContextConfig.java</span></code></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;restTemplate&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">RestTemplate</span><span class="w"> </span><span class="nf">restTemplate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RestTemplate</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">BufferingClientHttpRequestFactory</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">SimpleClientHttpRequestFactory</span><span class="p">()));</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
</div><div aria-labelledby="tab-0-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">applicationContext.xml</span></code></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;restTemplate&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.web.client.RestTemplate&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;constructor-arg&gt;</span>
<span class="w">        </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.http.client.BufferingClientHttpRequestFactory&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;constructor-arg&gt;</span>
<span class="w">                </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.http.client.SimpleClientHttpRequestFactory&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;/constructor-arg&gt;</span>
<span class="w">        </span><span class="nt">&lt;/bean&gt;</span>
<span class="w">    </span><span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
</li>
</ul>
</div></div>
</li>
</ul>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="responseerrorhandler">
<span id="restclientoverviewresponseerrorhandler"></span><h4><a class="toc-backref" href="#id46" role="doc-backlink"><span class="section-number">5.2.1.1.3. </span><code class="docutils literal notranslate"><span class="pre">ResponseErrorHandler</span></code></a><a class="headerlink" href="#responseerrorhandler" title="Permalink to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>は、サーバとの通信エラーのハンドリングを<code class="docutils literal notranslate"><span class="pre">org.springframework.web.client.ResponseErrorHandler</span></code>インタフェースに委譲することで実現している。</p>
<p><code class="docutils literal notranslate"><span class="pre">ResponseErrorHandler</span></code>には、</p>
<ul class="simple">
<li><p>エラー判定を行うメソッド(<code class="docutils literal notranslate"><span class="pre">hasError</span></code>)</p></li>
<li><p>エラー処理を行うメソッド(<code class="docutils literal notranslate"><span class="pre">handleError</span></code>)</p></li>
</ul>
<p>が定義されており、Spring Frameworkはデフォルト実装として<code class="docutils literal notranslate"><span class="pre">org.springframework.web.client.DefaultResponseErrorHandler</span></code>を提供している。</p>
<p><code class="docutils literal notranslate"><span class="pre">DefaultResponseErrorHandler</span></code>は、サーバから応答されたHTTPステータスコードの値によって以下のようなエラー処理を行う。</p>
<ul class="simple">
<li><p>レスポンスコードが正常系(2xx)の場合は、エラー処理は行わない。</p></li>
<li><p>レスポンスコードがクライアントエラー系(4xx)の場合は、<code class="docutils literal notranslate"><span class="pre">org.springframework.web.client.HttpClientErrorException</span></code>を発生させる。</p></li>
<li><p>レスポンスコードがサーバエラー系(5xx)の場合は、<code class="docutils literal notranslate"><span class="pre">org.springframework.web.client.HttpServerErrorException</span></code>を発生させる。</p></li>
<li><p>レスポンスコードが未定義のコード(ユーザ定義のカスタムコード)の場合は、<code class="docutils literal notranslate"><span class="pre">org.springframework.web.client.UnknownHttpStatusCodeException</span></code>を発生させる。</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>エラー時のレスポンスデータの取得方法</strong></p>
<p>エラー時のレスポンスデータ(HTTPステータスコード、レスポンスヘッダ、レスポンスボディなど)は、例外クラスのgetterメソッドを呼び出すことで取得することができる。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="clienthttprequestinterceptor">
<span id="restclientoverviewclienthttprequestinterceptor"></span><h4><a class="toc-backref" href="#id47" role="doc-backlink"><span class="section-number">5.2.1.1.4. </span><code class="docutils literal notranslate"><span class="pre">ClientHttpRequestInterceptor</span></code></a><a class="headerlink" href="#clienthttprequestinterceptor" title="Permalink to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">org.springframework.http.client.ClientHttpRequestInterceptor</span></code>は、サーバとの通信の前後に共通的な処理を実装するためのインタフェースである。</p>
<p><code class="docutils literal notranslate"><span class="pre">ClientHttpRequestInterceptor</span></code>を使用すると、</p>
<ul class="simple">
<li><p>サーバとの通信ログ</p></li>
<li><p>認証ヘッダの設定</p></li>
</ul>
<p>といった共通的な処理を<code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>に適用することができる。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>ClientHttpRequestInterceptorの動作仕様</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">ClientHttpRequestInterceptor</span></code>は複数適用することができ、指定した順番でチェーン実行される。これはサーブレットフィルタの動作によく似ており、最後に実行されるチェーン先として<code class="docutils literal notranslate"><span class="pre">ClientHttpRequest</span></code>によるHTTP通信処理が登録されている。例えば、ある条件に一致した際にサーバとの通信処理をキャンセルしたいという要件があった場合は、チェーン先を呼びださなければよい。</p>
<p>この仕組みを活用すると、</p>
<ul class="simple">
<li><p>サーバとの通信の閉塞</p></li>
<li><p>通信処理のリトライ</p></li>
</ul>
<p>といった処理を適用することもできる。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
</section>
<section id="how-to-use">
<span id="restclienthowtouse"></span><h2><a class="toc-backref" href="#id48" role="doc-backlink"><span class="section-number">5.2.2. </span>How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this heading">¶</a></h2>
<p>本節では、<code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>を使用したクライアント処理の実装方法について説明する。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>RestTemplateがサポートするHTTPメソッドについて</strong></p>
<p>本ガイドラインでは、GETメソッドとPOSTメソッドを使用したクライアント処理の実装例のみを紹介するが、<code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>は他のHTTPメソッド(PUT, PATCH, DELETE, HEAD, OPTIONSなど)もサポートしており、同じような要領で使用することができる。</p>
<p>詳細は<a class="reference external" href="https://docs.spring.io/spring-framework/docs/6.1.3/javadoc-api/org/springframework/web/client/RestTemplate.html">RestTemplateのJavadoc</a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="restclienthowtousesetup">
<span id="id7"></span><h3><a class="toc-backref" href="#id49" role="doc-backlink"><span class="section-number">5.2.2.1. </span><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>のセットアップ</a><a class="headerlink" href="#restclienthowtousesetup" title="Permalink to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>を使用する場合は、<code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>をDIコンテナに登録し、<code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>を利用するコンポーネントにインジェクションする。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="id8">
<h4><a class="toc-backref" href="#id50" role="doc-backlink"><span class="section-number">5.2.2.1.1. </span>依存ライブラリ設定</a><a class="headerlink" href="#id8" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>を使用するために<code class="docutils literal notranslate"><span class="pre">pom.xml</span></code>に、Spring Frameworkのspring-webライブラリを追加する。</div>
<div class="line">マルチプロジェクト構成の場合は、domainプロジェクトの<code class="docutils literal notranslate"><span class="pre">pom.xml</span></code>に追加する。</div>
</div>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;dependencies&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
<span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>spring-web<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>

<span class="nt">&lt;/dependencies&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>上記設定例は、依存ライブラリのバージョンを親プロジェクトである terasoluna-gfw-parent で管理する前提であるため、pom.xmlでのバージョンの指定は不要である。</p>
<p>上記の依存ライブラリはterasoluna-gfw-parentが依存している<a class="reference external" href="https://docs.spring.io/spring-boot/docs/3.2.2/reference/htmlsingle/#dependency-versions">Spring Boot</a>で管理されている。</p>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Spring Frameworkの<code class="docutils literal notranslate"><span class="pre">spring-web</span></code>ライブラリをdependenciesに追加する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="resttemplatebean">
<h4><a class="toc-backref" href="#id51" role="doc-backlink"><span class="section-number">5.2.2.1.2. </span><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>のbean定義</a><a class="headerlink" href="#resttemplatebean" title="Permalink to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>のbean定義を行い、DIコンテナに登録する。</p>
<p><strong>bean定義ファイルの定義例</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-1-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-1-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-1-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-1-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-1-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-1-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">ApplicationContextConfig.java</span></code></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;restTemplate&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">RestTemplate</span><span class="w"> </span><span class="nf">restTemplate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RestTemplate</span><span class="p">();</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>をデフォルト設定のまま利用する場合は、デフォルトコンストラクタを使用してbeanを登録する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div><div aria-labelledby="tab-1-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-1-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">applicationContext.xml</span></code></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;restTemplate&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.web.client.RestTemplate&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>をデフォルト設定のまま利用する場合は、デフォルトコンストラクタを使用してbeanを登録する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>RestTemplateのカスタマイズ方法</strong></p>
<p>HTTP通信処理をカスタマイズする場合は、以下のようなbean定義となる。</p>
<blockquote>
<div><div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-2-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-2-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-2-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-2-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-2-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-2-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;clientHttpRequestFactory&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">SimpleClientHttpRequestFactory</span><span class="w"> </span><span class="nf">clientHttpRequestFactory</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">SimpleClientHttpRequestFactory</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SimpleClientHttpRequestFactory</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span>
<span class="p">}</span>

<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;restTemplate&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">RestTemplate</span><span class="w"> </span><span class="nf">restTemplate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RestTemplate</span><span class="p">(</span><span class="n">clientHttpRequestFactory</span><span class="p">());</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ClientHttpRequestFactory</span></code>のbean定義を行う。</div>
<div class="line">本ガイドラインではタイムアウトの設定をカスタマイズする方法を紹介している。</div>
<div class="line">詳細は<a class="reference internal" href="#restclienthowtousetimeoutsettings"><span class="std std-ref">通信タイムアウトの設定</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ClientHttpRequestFactory</span></code>を引数に指定するコンストラクタを使用してbeanを登録する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div><div aria-labelledby="tab-2-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-2-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;clientHttpRequestFactory&quot;</span>
<span class="w">    </span><span class="na">class=</span><span class="s">&quot;org.springframework.http.client.SimpleClientHttpRequestFactory&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- Set properties for customize a http communication (omit on this sample) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;restTemplate&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.web.client.RestTemplate&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;clientHttpRequestFactory&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ClientHttpRequestFactory</span></code>のbean定義を行う。</div>
<div class="line">本ガイドラインではタイムアウトの設定をカスタマイズする方法を紹介している。</div>
<div class="line">詳細は<a class="reference internal" href="#restclienthowtousetimeoutsettings"><span class="std std-ref">通信タイムアウトの設定</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ClientHttpRequestFactory</span></code>を引数に指定するコンストラクタを使用してbeanを登録する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></div>
<p>なお、<code class="docutils literal notranslate"><span class="pre">HttpMessageConverter</span></code>、<code class="docutils literal notranslate"><span class="pre">ResponseErrorHandler</span></code>、<code class="docutils literal notranslate"><span class="pre">ClientHttpRequestInterceptor</span></code>のカスタマイズ方法については、</p>
<ul class="simple">
<li><p><a class="reference internal" href="#restclienthowtoextendhttpmessageconverter"><span class="std std-ref">任意のHttpMessageConverterを登録する方法</span></a></p></li>
<li><p><a class="reference internal" href="#restclienthowtouseerrorhandlingresponseentity"><span class="std std-ref">ResponseEntityの返却（エラーハンドラの拡張）</span></a></p></li>
<li><p><a class="reference internal" href="#restclienthowtoextendclienthttprequestinterceptor"><span class="std std-ref">共通処理の適用（ClientHttpRequestInterceptor）</span></a></p></li>
</ul>
<p>を参照されたい。</p>
</div></blockquote>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id9">
<h4><a class="toc-backref" href="#id52" role="doc-backlink"><span class="section-number">5.2.2.1.3. </span><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>の利用</a><a class="headerlink" href="#id9" title="Permalink to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>を利用する場合は、DIコンテナに登録されている<code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>をインジェクションする。</p>
<p><strong>RestTemplateのインジェクション例</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Service</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AccountServiceImpl</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">AccountService</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Inject</span>
<span class="w">    </span><span class="n">RestTemplate</span><span class="w"> </span><span class="n">restTemplate</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="get">
<span id="restclienthowtouseget"></span><h3><a class="toc-backref" href="#id53" role="doc-backlink"><span class="section-number">5.2.2.2. </span>GETリクエストの送信</a><a class="headerlink" href="#get" title="Permalink to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>は、GETリクエストを行うためのメソッドを複数提供している。</p>
<ul class="simple">
<li><p>通常は<code class="docutils literal notranslate"><span class="pre">getForObject</span></code>メソッド又は<code class="docutils literal notranslate"><span class="pre">getForEntity</span></code>メソッドを使用する。</p></li>
<li><p>任意のヘッダを設定するなどリクエストに細かい設定を行いたい場合は、<code class="docutils literal notranslate"><span class="pre">org.springframework.http.RequestEntity</span></code>と<code class="docutils literal notranslate"><span class="pre">exchange</span></code>メソッドを使用する。</p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="getforobject">
<h4><a class="toc-backref" href="#id54" role="doc-backlink"><span class="section-number">5.2.2.2.1. </span><code class="docutils literal notranslate"><span class="pre">getForObject</span></code>メソッドを使用した実装</a><a class="headerlink" href="#getforobject" title="Permalink to this heading">¶</a></h4>
<p>レスポンスボディのみ取得できればよい場合は、<code class="docutils literal notranslate"><span class="pre">getForObject</span></code>メソッドを使用する。</p>
<p><strong>getForObjectメソッドの使用例</strong></p>
<p>フィールド宣言部</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${api.url:http://localhost:8080/api}&quot;</span><span class="p">)</span>
<span class="n">URI</span><span class="w"> </span><span class="n">uri</span><span class="p">;</span>
</pre></div>
</div>
<p>メソッド内部</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">getForObject</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"> </span><span class="c1">// (1)</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">getForObject</span></code>メソッドを使用した場合は、戻り値はレスポンスボディの値になる。</div>
<div class="line">レスポンスボディのデータは<code class="docutils literal notranslate"><span class="pre">HttpMessageConverter</span></code>によって第2引数に指定したJavaクラスへ変換された後、返却される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="getforentity">
<h4><a class="toc-backref" href="#id55" role="doc-backlink"><span class="section-number">5.2.2.2.2. </span><code class="docutils literal notranslate"><span class="pre">getForEntity</span></code>メソッドを使用した実装</a><a class="headerlink" href="#getforentity" title="Permalink to this heading">¶</a></h4>
<p>HTTPステータスコード、レスポンスヘッダ、レスポンスボディを取得する必要がある場合は、<code class="docutils literal notranslate"><span class="pre">getForEntity</span></code>メソッドを使用する。</p>
<p><strong>getForEntityメソッドの使用例</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="n">responseEntity</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">getForEntity</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="n">HttpStatus</span><span class="w"> </span><span class="n">statusCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">responseEntity</span><span class="p">.</span><span class="na">getStatusCode</span><span class="p">();</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="n">HttpHeaders</span><span class="w"> </span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">responseEntity</span><span class="p">.</span><span class="na">getHeaders</span><span class="p">();</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">responseEntity</span><span class="p">.</span><span class="na">getBody</span><span class="p">();</span><span class="w"> </span><span class="c1">// (4)</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">getForEntity</span></code>メソッドを使用した場合は、戻り値は<code class="docutils literal notranslate"><span class="pre">org.springframework.http.ResponseEntity</span></code>となる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">HTTPステータスコードは<code class="docutils literal notranslate"><span class="pre">getStatusCode</span></code>メソッドを用いて取得する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">レスポンスヘッダは<code class="docutils literal notranslate"><span class="pre">getHeaders</span></code>メソッドを用いて取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">レスポンスボディは<code class="docutils literal notranslate"><span class="pre">getBody</span></code>メソッドを用いて取得する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>ResponseEntityとは</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">ResponseEntity</span></code>はHTTPレスポンスを表すクラスで、HTTPステータスコード、レスポンスヘッダ、レスポンスボディの情報を取得することができる。</p>
<p>詳細は<a class="reference external" href="https://docs.spring.io/spring-framework/docs/6.1.3/javadoc-api/org/springframework/http/ResponseEntity.html">ResponseEntityのJavadoc</a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="exchange">
<h4><a class="toc-backref" href="#id56" role="doc-backlink"><span class="section-number">5.2.2.2.3. </span><code class="docutils literal notranslate"><span class="pre">exchange</span></code>メソッドを使用した実装</a><a class="headerlink" href="#exchange" title="Permalink to this heading">¶</a></h4>
<p>リクエストヘッダを指定する必要がある場合は、<code class="docutils literal notranslate"><span class="pre">org.springframework.http.RequestEntity</span></code>を生成し<code class="docutils literal notranslate"><span class="pre">exchange</span></code>メソッドを使用する。</p>
<p><strong>exchangeメソッドの使用例</strong></p>
<p>import部</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.RequestEntity</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.ResponseEntity</span><span class="p">;</span>
</pre></div>
</div>
<p>フィールド宣言部</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${api.url:http://localhost:8080/api}&quot;</span><span class="p">)</span>
<span class="n">URI</span><span class="w"> </span><span class="n">uri</span><span class="p">;</span>
</pre></div>
</div>
<p>メソッド内部</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">RequestEntity</span><span class="w"> </span><span class="n">requestEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RequestEntity</span>
<span class="w">        </span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span><span class="c1">//(1)</span>
<span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="c1">//(2)</span>

<span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="n">responseEntity</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">exchange</span><span class="p">(</span><span class="n">requestEntity</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="c1">//(3)</span>

<span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">responseEntity</span><span class="p">.</span><span class="na">getBody</span><span class="p">();</span><span class="c1">//(4)</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RequestEntity</span></code>の<code class="docutils literal notranslate"><span class="pre">get</span></code>メソッドを使用し、GETリクエスト用のリクエストビルダを生成する。</div>
<div class="line">パラメータにURIを設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RequestEntity.HeadersBuilder</span></code>の<code class="docutils literal notranslate"><span class="pre">build</span></code>メソッドを使用し、<code class="docutils literal notranslate"><span class="pre">RequestEntity</span></code>オブジェクトを作成する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">exchange</span></code>メソッドを使用し、リクエストを送信する。第二引数に、レスポンスデータの型を指定する。</div>
<div class="line">レスポンスは、<code class="docutils literal notranslate"><span class="pre">ResponseEntity&lt;T&gt;</span></code>になる。型パラメータに、レスポンスデータの型を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">getBody</span></code>メソッドを使用し、レスポンスボディのデータを取得する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>RequestEntityとは</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">RequestEntity</span></code>はHTTPリクエストを表すクラスで、接続URI、HTTPメソッド、リクエストヘッダ、リクエストボディを設定することができる。</p>
<p>詳細は<a class="reference external" href="https://docs.spring.io/spring-framework/docs/6.1.3/javadoc-api/org/springframework/http/RequestEntity.html">RequestEntityのJavadoc</a>を参照されたい。</p>
<p>なお、リクエストヘッダの設定方法については、<a class="reference internal" href="#restclienthowtouserequestheader"><span class="std std-ref">リクエストヘッダの設定</span></a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="post">
<span id="restclienthowtousepost"></span><h3><a class="toc-backref" href="#id57" role="doc-backlink"><span class="section-number">5.2.2.3. </span>POSTリクエストの送信</a><a class="headerlink" href="#post" title="Permalink to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>は、POSTリクエストを行うためのメソッドを複数提供している。</p>
<ul class="simple">
<li><p>通常は、<code class="docutils literal notranslate"><span class="pre">postForObject</span></code>、<code class="docutils literal notranslate"><span class="pre">postForEntity</span></code>を使用する。</p></li>
<li><p>任意のヘッダを設定するなどリクエストに細かい設定を行いたい場合は、<code class="docutils literal notranslate"><span class="pre">RequestEntity</span></code>と <code class="docutils literal notranslate"><span class="pre">exchange</span></code>メソッドを使用する。</p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="postforobject">
<h4><a class="toc-backref" href="#id58" role="doc-backlink"><span class="section-number">5.2.2.3.1. </span><code class="docutils literal notranslate"><span class="pre">postForObject</span></code>メソッドを使用した実装</a><a class="headerlink" href="#postforobject" title="Permalink to this heading">¶</a></h4>
<p>POSTした結果としてレスポンスボディのみ取得できればよい場合は、<code class="docutils literal notranslate"><span class="pre">postForObject</span></code>メソッドを使用する。</p>
<p><strong>postForObjectメソッドの使用例</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">User</span><span class="p">();</span>

<span class="c1">// omitted</span>

<span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">postForObject</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"> </span><span class="c1">// (1)</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">postForObject</span></code>メソッドは、簡易にPOSTリクエストを実装できる。</div>
<div class="line">第二引数には、<code class="docutils literal notranslate"><span class="pre">HttpMessageConverter</span></code>によってリクエストボディに変換されるJavaオブジェクトを設定する。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">postForObject</span></code>メソッドを使用した場合は、戻り値はレスポンスボディの値になる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="postforentity">
<h4><a class="toc-backref" href="#id59" role="doc-backlink"><span class="section-number">5.2.2.3.2. </span><code class="docutils literal notranslate"><span class="pre">postForEntity</span></code>メソッドを使用した実装</a><a class="headerlink" href="#postforentity" title="Permalink to this heading">¶</a></h4>
<p>POSTした結果としてHTTPステータスコード、レスポンスヘッダ、レスポンスボディを取得する必要がある場合は、<code class="docutils literal notranslate"><span class="pre">postForEntity</span></code>メソッドを使用する。</p>
<p><strong>postForEntityメソッドの使用例</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">User</span><span class="p">();</span>

<span class="c1">// omitted</span>

<span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="n">responseEntity</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">postForEntity</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"> </span><span class="c1">// (1)</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">postForEntity</span></code>メソッドも<code class="docutils literal notranslate"><span class="pre">getForObject</span></code>メソッドと同様に簡易にPOSTリクエストを実装できる。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">postForEntity</span></code>メソッドを使用した場合は、戻り値は<code class="docutils literal notranslate"><span class="pre">ResponseEntity</span></code>となる。</div>
<div class="line">レスポンスボディの値は、<code class="docutils literal notranslate"><span class="pre">ResponseEntity</span></code>から取得する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id10">
<h4><a class="toc-backref" href="#id60" role="doc-backlink"><span class="section-number">5.2.2.3.3. </span><code class="docutils literal notranslate"><span class="pre">exchange</span></code>メソッドを使用した実装</a><a class="headerlink" href="#id10" title="Permalink to this heading">¶</a></h4>
<p>リクエストヘッダを指定する必要がある場合は、<code class="docutils literal notranslate"><span class="pre">RequestEntity</span></code>を生成し<code class="docutils literal notranslate"><span class="pre">exchange</span></code>メソッドを使用する。</p>
<p><strong>exchangeメソッドの使用例</strong></p>
<p>import部</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.RequestEntity</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.ResponseEntity</span><span class="p">;</span>
</pre></div>
</div>
<p>フィールド宣言部</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${api.url:http://localhost:8080/api}&quot;</span><span class="p">)</span>
<span class="n">URI</span><span class="w"> </span><span class="n">uri</span><span class="p">;</span>
</pre></div>
</div>
<p>メソッド内部</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">User</span><span class="p">();</span>

<span class="c1">// omitted</span>

<span class="n">RequestEntity</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="n">requestEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RequestEntity</span><span class="c1">//(1)</span>
<span class="w">        </span><span class="p">.</span><span class="na">post</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span><span class="c1">//(2)</span>
<span class="w">        </span><span class="p">.</span><span class="na">body</span><span class="p">(</span><span class="n">user</span><span class="p">);</span><span class="c1">//(3)</span>

<span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="n">responseEntity</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">exchange</span><span class="p">(</span><span class="n">requestEntity</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="c1">//(4)</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RequestEntity</span></code>を使用して、リクエストを生成する。型パラメータに、リクエストボディに設定するデータの型を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">post</span></code>メソッドを使用し、POSTリクエスト用のリクエストビルダを生成する。パラメータにURIを設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RequestEntity.BodyBuilder</span></code>の<code class="docutils literal notranslate"><span class="pre">body</span></code>メソッドを使用し、<code class="docutils literal notranslate"><span class="pre">RequestEntity</span></code>オブジェクトを作成する。</div>
<div class="line">パラメータにリクエストボディに変換するJavaオブジェクトを設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">exchange</span></code>メソッドを使用し、リクエストを送信する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>リクエストヘッダの設定方法</strong></p>
<p>リクエストヘッダの設定方法については、<a class="reference internal" href="#restclienthowtouserequestheader"><span class="std std-ref">リクエストヘッダの設定</span></a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="restclienthowtousegetcollection">
<span id="id11"></span><h3><a class="toc-backref" href="#id61" role="doc-backlink"><span class="section-number">5.2.2.4. </span>コレクション形式のデータ取得</a><a class="headerlink" href="#restclienthowtousegetcollection" title="Permalink to this heading">¶</a></h3>
<p>サーバから応答されるレスポンスボディの電文(JSON等)がコレクション形式の場合は、以下のような実装となる。</p>
<p><strong>コレクション形式のデータの取得例</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">responseEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="c1">//(1)</span>
<span class="w">    </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">exchange</span><span class="p">(</span><span class="n">requestEntity</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ParameterizedTypeReference</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;</span><span class="p">(){});</span><span class="w"> </span><span class="c1">//(2)</span>

<span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="n">userList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">responseEntity</span><span class="p">.</span><span class="na">getBody</span><span class="p">();</span><span class="c1">//(3)</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ResponseEntity</span></code>の型パラメータに<code class="docutils literal notranslate"><span class="pre">List</span></code>&lt;レスポンスデータの型&gt;を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">exchange</span></code>メソッドの第二引数に<code class="docutils literal notranslate"><span class="pre">org.springframework.core.ParameterizedTypeReference</span></code>のインスタンスを指定し、型パラメータに<code class="docutils literal notranslate"><span class="pre">List</span></code>&lt;レスポンスデータの型&gt;を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">getBody</span></code>メソッドで、レスポンスボディのデータを取得する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="restclienthowtouserequestheader">
<span id="id12"></span><h3><a class="toc-backref" href="#id62" role="doc-backlink"><span class="section-number">5.2.2.5. </span>リクエストヘッダの設定</a><a class="headerlink" href="#restclienthowtouserequestheader" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RequestEntity</span></code>と<code class="docutils literal notranslate"><span class="pre">exchange</span></code>メソッドを使用すると、<code class="docutils literal notranslate"><span class="pre">RequestEntity</span></code>のメソッドを使用して特定のヘッダ及び任意のヘッダを設定することができる。</div>
<div class="line">詳細は<a class="reference external" href="https://docs.spring.io/spring-framework/docs/6.1.3/javadoc-api/org/springframework/http/RequestEntity.html">RequestEntityのJavadoc</a>を参照されたい。</div>
</div>
<div class="line-block">
<div class="line">本ガイドラインでは、</div>
</div>
<ul class="simple">
<li><p><a class="reference internal" href="#restclienthowtouserequestheadercontenttype"><span class="std std-ref">Content-Typeヘッダの設定</span></a></p></li>
<li><p><a class="reference internal" href="#restclienthowtouserequestheaderaccept"><span class="std std-ref">Acceptヘッダの設定</span></a></p></li>
<li><p><a class="reference internal" href="#restclienthowtouserequestheaderanyheader"><span class="std std-ref">任意のリクエストヘッダの設定</span></a></p></li>
</ul>
<p>について説明する。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="content-type">
<span id="restclienthowtouserequestheadercontenttype"></span><h4><a class="toc-backref" href="#id63" role="doc-backlink"><span class="section-number">5.2.2.5.1. </span>Content-Typeヘッダの設定</a><a class="headerlink" href="#content-type" title="Permalink to this heading">¶</a></h4>
<p>サーバへデータを送信する場合は、通常Content-Typeヘッダの指定が必要となる。</p>
<p><strong>Content-Typeヘッダの設定例</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">User</span><span class="p">();</span>

<span class="c1">// omitted</span>

<span class="n">RequestEntity</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="n">requestEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RequestEntity</span>
<span class="w">        </span><span class="p">.</span><span class="na">post</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">contentType</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">)</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">        </span><span class="p">.</span><span class="na">body</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RequestEntity.BodyBuilder</span></code>の<code class="docutils literal notranslate"><span class="pre">contentType</span></code>メソッドを使用し、Context-Typeヘッダの値を指定する。</div>
<div class="line">上記の実装例では、データ形式がJSONであることを示す「<code class="docutils literal notranslate"><span class="pre">application/json</span></code>」を設定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="accept">
<span id="restclienthowtouserequestheaderaccept"></span><h4><a class="toc-backref" href="#id64" role="doc-backlink"><span class="section-number">5.2.2.5.2. </span>Acceptヘッダの設定</a><a class="headerlink" href="#accept" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">サーバから取得するデータの形式を指定する場合は、Acceptヘッダの指定が必要となる。</div>
<div class="line">サーバが複数のデータ形式のレスポンスをサポートしていない場合は、Acceptヘッダを明示的に指定しなくてもよいケースもある。</div>
</div>
<p><strong>Acceptヘッダの設定例</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">User</span><span class="p">();</span>

<span class="c1">// omitted</span>

<span class="n">RequestEntity</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="n">requestEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RequestEntity</span>
<span class="w">        </span><span class="p">.</span><span class="na">post</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">)</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">        </span><span class="p">.</span><span class="na">body</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RequestEntity.HeadersBuilder</span></code>の<code class="docutils literal notranslate"><span class="pre">accept</span></code>メソッドを使用して、Acceptヘッダの値を設定する。</div>
<div class="line">上記の実装例では、取得可能なデータ形式がJSONであることを示す「<code class="docutils literal notranslate"><span class="pre">application/json</span></code>」を設定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="restclienthowtouserequestheaderanyheader">
<span id="id14"></span><h4><a class="toc-backref" href="#id65" role="doc-backlink"><span class="section-number">5.2.2.5.3. </span>任意のリクエストヘッダの設定</a><a class="headerlink" href="#restclienthowtouserequestheaderanyheader" title="Permalink to this heading">¶</a></h4>
<p>サーバへアクセスするために、リクエストヘッダの設定が必要になるケースがある。</p>
<p><strong>任意ヘッダの設定例</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">User</span><span class="p">();</span>

<span class="c1">// omitted</span>

<span class="n">RequestEntity</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="n">requestEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RequestEntity</span>
<span class="w">        </span><span class="p">.</span><span class="na">post</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&quot;Authorization&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Basic &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">base64Credentials</span><span class="p">)</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">        </span><span class="p">.</span><span class="na">body</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RequestEntity.HeadersBuilder</span></code>の<code class="docutils literal notranslate"><span class="pre">header</span></code>メソッドを使用してリクエストヘッダの名前と値を設定する。</div>
<div class="line">上記の実装例では、AuthorizationヘッダにBasic認証に必要な資格情報を設定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="restclienthowtouseerrorhandling">
<span id="id15"></span><h3><a class="toc-backref" href="#id66" role="doc-backlink"><span class="section-number">5.2.2.6. </span>エラーハンドリング</a><a class="headerlink" href="#restclienthowtouseerrorhandling" title="Permalink to this heading">¶</a></h3>
<section id="restclienthowtouseerrorhandlinghandleexception">
<span id="id16"></span><h4><a class="toc-backref" href="#id67" role="doc-backlink"><span class="section-number">5.2.2.6.1. </span>例外ハンドリング(デフォルトの動作)</a><a class="headerlink" href="#restclienthowtouseerrorhandlinghandleexception" title="Permalink to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>のデフォルト実装(<code class="docutils literal notranslate"><span class="pre">DefaultResponseErrorHandler</span></code>)では、</p>
<ul class="simple">
<li><p>レスポンスコードがクライアントエラー系(4xx)の場合は、<code class="docutils literal notranslate"><span class="pre">HttpClientErrorException</span></code></p></li>
<li><p>レスポンスコードがサーバエラー系(5xx)の場合は、<code class="docutils literal notranslate"><span class="pre">HttpServerErrorException</span></code></p></li>
<li><p>レスポンスコードが未定義のコード(ユーザ定義のカスタムコード)の場合は、<code class="docutils literal notranslate"><span class="pre">UnknownHttpStatusCodeException</span></code></p></li>
</ul>
<p>が発生するため、必要に応じてこれらの例外をハンドリングする必要がある。</p>
<p><strong>例外ハンドリングの実装例</strong></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>以下の実装例は、サーバエラーが発生した際の例外ハンドリングの一例である。</p>
<p>アプリケーションの要件に応じて<strong>適切な例外ハンドリングを行うこと。</strong></p>
</div>
<p>フィールド宣言部</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${api.retry.maxCount}&quot;</span><span class="p">)</span>
<span class="kt">int</span><span class="w"> </span><span class="n">retryMaxCount</span><span class="p">;</span>

<span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${api.retry.retryWaitTimeCoefficient}&quot;</span><span class="p">)</span>
<span class="kt">int</span><span class="w"> </span><span class="n">retryWaitTimeCoefficient</span><span class="p">;</span>
</pre></div>
</div>
<p>メソッド内部</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">retryCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">responseEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">exchange</span><span class="p">(</span><span class="n">requestEntity</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isInfoEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Success({}) &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">responseEntity</span><span class="p">.</span><span class="na">getStatusCode</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">HttpServerErrorException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (1)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">retryCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">retryMaxCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">retryCount</span><span class="o">++</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isWarnEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;An error ({}) occurred on the server. (The number of retries:{} Times)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getStatusCode</span><span class="p">(),</span>
<span class="w">                </span><span class="n">retryCount</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">retryWaitTimeCoefficient</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">retryCount</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">ie</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">interrupt</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例外をキャッチしてエラー処理を行う。サーバエラー（500系）の場合、<code class="docutils literal notranslate"><span class="pre">HttpServerErrorException</span></code>をキャッチする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="responseentity">
<span id="restclienthowtouseerrorhandlingresponseentity"></span><h4><a class="toc-backref" href="#id68" role="doc-backlink"><span class="section-number">5.2.2.6.2. </span><code class="docutils literal notranslate"><span class="pre">ResponseEntity</span></code>の返却（エラーハンドラの拡張）</a><a class="headerlink" href="#responseentity" title="Permalink to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">org.springframework.web.client.ResponseErrorHandler</span></code>インタフェースの実装クラスを<code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>に設定することで、独自のエラー処理を行うことができる。</p>
<p>以下の例では、サーバエラー及びクライアントエラーが発生した場合でも<code class="docutils literal notranslate"><span class="pre">ResponseEntity</span></code>を返すようにエラーハンドラを拡張している。</p>
<p><strong>エラーハンドラの実装クラスの作成例</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.client.ClientHttpResponse</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.client.DefaultResponseErrorHandler</span><span class="p">;</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CustomErrorHandler</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">DefaultResponseErrorHandler</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (1)</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleError</span><span class="p">(</span><span class="n">ClientHttpResponse</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">//Don&#39;t throw Exception.</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ResponseErrorHandler</span></code>インタフェースの実装クラスを作成する。</div>
<div class="line">上記の作成例では、デフォルトのエラーハンドラの実装クラスである<code class="docutils literal notranslate"><span class="pre">DefaultResponseErrorHandler</span></code>を拡張し、</div>
<div class="line">サーバエラー及びクライアントエラーが発生した際に例外を発生させずに<code class="docutils literal notranslate"><span class="pre">ResponseEntity</span></code>が返るようにしている。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>bean定義ファイルの定義例</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-3-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-3-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-3-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-3-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-3-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-3-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">ApplicationContextConfig.java</span></code></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;customErrorHandler&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">CustomErrorHandler</span><span class="w"> </span><span class="nf">customErrorHandler</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CustomErrorHandler</span><span class="p">();</span>
<span class="p">}</span>

<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;restTemplate&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">RestTemplate</span><span class="w"> </span><span class="nf">restTemplate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">RestTemplate</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RestTemplate</span><span class="p">();</span>
<span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">setErrorHandler</span><span class="p">(</span><span class="n">customErrorHandler</span><span class="p">());</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ResponseErrorHandler</span></code>の実装クラスのbean定義を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">errorHandler</span></code>プロパティに<code class="docutils literal notranslate"><span class="pre">ResponseErrorHandler</span></code>のbeanを設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div><div aria-labelledby="tab-3-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-3-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">applicationContext.xml</span></code></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;customErrorHandler&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;com.example.restclient.CustomErrorHandler&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>

<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;restTemplate&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.web.client.RestTemplate&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;errorHandler&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;customErrorHandler&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ResponseErrorHandler</span></code>の実装クラスのbean定義を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">errorHandler</span></code>プロパティに<code class="docutils literal notranslate"><span class="pre">ResponseErrorHandler</span></code>のbeanをインジェクションする。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div></div>
<p><strong>クライアント処理の実装例</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">retryCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">responseEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">exchange</span><span class="p">(</span><span class="n">requestEntity</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">responseEntity</span><span class="p">.</span><span class="na">getStatusCode</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (1)</span>

<span class="w">        </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">responseEntity</span><span class="p">.</span><span class="na">getStatusCode</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">SERVICE_UNAVAILABLE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (2)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">retryCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">retryMaxCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">retryCount</span><span class="o">++</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isWarnEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;An error ({}) occurred on the server. (The number of retries:{} Times)&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">responseEntity</span><span class="p">.</span><span class="na">getStatusCode</span><span class="p">(),</span><span class="w"> </span><span class="n">retryCount</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">retryWaitTimeCoefficient</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">retryCount</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">ie</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">interrupt</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">上記の実装例では、エラー時にも<code class="docutils literal notranslate"><span class="pre">ResponseEntity</span></code>を返すようにエラーハンドラを拡張しているので、返却された<code class="docutils literal notranslate"><span class="pre">ResponseEntity</span></code>からHTTPステータスコードを取得して、処理結果が正常であったか確認する必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">エラー発生時も返却された<code class="docutils literal notranslate"><span class="pre">ResponseEntity</span></code>からHTTPステータスコードを取得して、その値に応じて処理を制御することができる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="restclienthowtousetimeoutsettings">
<span id="id17"></span><h3><a class="toc-backref" href="#id69" role="doc-backlink"><span class="section-number">5.2.2.7. </span>通信タイムアウトの設定</a><a class="headerlink" href="#restclienthowtousetimeoutsettings" title="Permalink to this heading">¶</a></h3>
<p>サーバとの通信に対してタイムアウト時間を指定したい場合は、以下のようなbean定義を行う。</p>
<p><strong>bean定義ファイルの定義例</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-4-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-4-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-4-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-4-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-4-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-4-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">ApplicationContextConfig.java</span></code></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${api.connectTimeout:2000}&quot;</span><span class="p">)</span>
<span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">connectTimeout</span><span class="p">;</span>

<span class="c1">// (2)</span>
<span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${api.readTimeout:2000}&quot;</span><span class="p">)</span>
<span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">readTimeout</span><span class="p">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;clientHttpRequestFactory&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">SimpleClientHttpRequestFactory</span><span class="w"> </span><span class="nf">clientHttpRequestFactory</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">SimpleClientHttpRequestFactory</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SimpleClientHttpRequestFactory</span><span class="p">();</span>
<span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">setConnectTimeout</span><span class="p">(</span><span class="n">connectTimeout</span><span class="p">);</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">setReadTimeout</span><span class="p">(</span><span class="n">readTimeout</span><span class="p">);</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span>
<span class="p">}</span>

<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;timeoutRestTemplate&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">RestTemplate</span><span class="w"> </span><span class="nf">timeoutRestTemplate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RestTemplate</span><span class="p">(</span><span class="n">clientHttpRequestFactory</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">connectTimeout</span></code>プロパティにサーバとの接続タイムアウト時間(ミリ秒)を設定する。</div>
<div class="line">タイムアウト発生時は<code class="docutils literal notranslate"><span class="pre">org.springframework.web.client.ResourceAccessException</span></code>が発生する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">readTimeout</span></code>プロパティにレスポンスデータの読み込みタイムアウト時間(ミリ秒)を設定する。</div>
<div class="line">タイムアウト発生時は<code class="docutils literal notranslate"><span class="pre">ResourceAccessException</span></code>が発生する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div><div aria-labelledby="tab-4-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-4-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>プロパティが別の型にマッピングされる</strong></p>
<blockquote>
<div></div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">SimpleClientHttpRequestFactory</span></code>のタイムアウト時間の設定に関して、以下の様にXMLConfigで以下の様に定義した場合、誤った型にマッピングされてしまう事象が確認されている。（<a class="reference external" href="https://github.com/spring-projects/spring-framework/issues/31872">Spring#31872</a>, <a class="reference external" href="https://github.com/spring-projects/spring-framework/issues/32159">Spring#32159</a>）</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">applicationContext.xml</span></code></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;clientHttpRequestFactory&quot;</span>
<span class="w">      </span><span class="na">class=</span><span class="s">&quot;org.springframework.http.client.SimpleClientHttpRequestFactory&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;connectTimeout&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${api.connectTimeout: 2000}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;readTimeout&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${api.readTimeout: 2000}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
</li>
</ul>
<p>Spring Framework 6.1.3 では解決されておらず、XMLConfigではタイムアウト時間を設定することができないため、<code class="docutils literal notranslate"><span class="pre">SimpleClientHttpRequestFactory</span></code>にタイムアウト時間を設定したい場合はFactoryBeanで定義すること。</p>
</div>
<p>サーバとの通信に対してタイムアウト時間を指定したい場合は、以下のようなbean定義を行う。</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">SimpleClientHttpRequestFactoryBean.java</span></code></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.restclient</span><span class="p">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SimpleClientHttpRequestFactoryBean</span><span class="w"> </span><span class="kd">implements</span>
<span class="w">                                                </span><span class="n">FactoryBean</span><span class="o">&lt;</span><span class="n">SimpleClientHttpRequestFactory</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${api.connectTimeout:2000}&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">connectTimeout</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${api.readTimeout:2000}&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">readTimeout</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">SimpleClientHttpRequestFactory</span><span class="w"> </span><span class="nf">getObject</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">SimpleClientHttpRequestFactory</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SimpleClientHttpRequestFactory</span><span class="p">();</span>
<span class="w">        </span><span class="n">bean</span><span class="p">.</span><span class="na">setConnectTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">connectTimeout</span><span class="p">);</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">        </span><span class="n">bean</span><span class="p">.</span><span class="na">setReadTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">readTimeout</span><span class="p">);</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">getObjectType</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">SimpleClientHttpRequestFactory</span><span class="p">.</span><span class="na">class</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">connectTimeout</span></code>プロパティにサーバとの接続タイムアウト時間(ミリ秒)を設定する。</div>
<div class="line">タイムアウト発生時は<code class="docutils literal notranslate"><span class="pre">org.springframework.web.client.ResourceAccessException</span></code>が発生する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">readTimeout</span></code>プロパティにレスポンスデータの読み込みタイムアウト時間(ミリ秒)を設定する。</div>
<div class="line">タイムアウト発生時は<code class="docutils literal notranslate"><span class="pre">ResourceAccessException</span></code>が発生する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">applicationContext.xml</span></code></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;clientHttpRequestFactory&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;com.example.restclient.SimpleClientHttpRequestFactoryBean&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>

<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;restTemplate&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.web.client.RestTemplate&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;clientHttpRequestFactory&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
</li>
</ul>
</div></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>タイムアウト発生時の起因例外</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">ResourceAccessException</span></code>は起因例外をラップしており、接続タイムアウト及び読み込みタイムアウト発生時の起因例外は共に<code class="docutils literal notranslate"><span class="pre">java.net.SocketTimeoutException</span></code>である。デフォルト実装(<code class="docutils literal notranslate"><span class="pre">SimpleClientHttpRequestFactory</span></code>)を使用した場合は、どちらのタイムアウトが発生したかを例外クラスの種類で区別できないという点を補足しておく。</p>
<p>なお、他の<code class="docutils literal notranslate"><span class="pre">HttpRequestFactory</span></code>を使用した場合の動作は未検証であるため、起因例外が上記と異なる可能性がある。他の<code class="docutils literal notranslate"><span class="pre">HttpRequestFactory</span></code>を使用する場合は、タイムアウト時に発生する例外を把握した上で適切な例外ハンドリングを行うこと。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="ssl">
<span id="restclienthowtousehttps"></span><h3><a class="toc-backref" href="#id70" role="doc-backlink"><span class="section-number">5.2.2.8. </span>SSL自己署名証明書の使用</a><a class="headerlink" href="#ssl" title="Permalink to this heading">¶</a></h3>
<p>テスト環境などでSSL自己署名証明書を使用する場合は、以下のように実装する。</p>
<p><strong>FactoryBeanの実装例</strong></p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>のBean定義で、コンストラクタの引数に渡す <code class="docutils literal notranslate"><span class="pre">org.springframework.http.client.ClientHttpRequestFactory</span></code>を作成するための <code class="docutils literal notranslate"><span class="pre">org.springframework.beans.factory.FactoryBean</span></code>を実装する。</div>
<div class="line">サンプルコードであるため、<code class="docutils literal notranslate"><span class="pre">HttpClientConnectionManager</span></code>や<code class="docutils literal notranslate"><span class="pre">HttpClient</span></code>の設定値は業務要件に応じ適切に設定されたい。</div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.security.KeyStore</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">javax.net.ssl.KeyManagerFactory</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.net.ssl.SSLContext</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.net.ssl.TrustManagerFactory</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.hc.client5.http.classic.HttpClient</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.hc.client5.http.config.RequestConfig</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.hc.client5.http.cookie.StandardCookieSpec</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.hc.client5.http.impl.classic.CloseableHttpClient</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.hc.client5.http.impl.classic.HttpClientBuilder</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.hc.client5.http.impl.classic.HttpClients</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.hc.client5.http.impl.io.PoolingHttpClientConnectionManager</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.hc.client5.http.impl.io.PoolingHttpClientConnectionManagerBuilder</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.hc.client5.http.ssl.SSLConnectionSocketFactoryBuilder</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.hc.core5.http.io.SocketConfig</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.hc.core5.http.ssl.TLS</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.hc.core5.pool.PoolConcurrencyPolicy</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.hc.core5.pool.PoolReusePolicy</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.hc.core5.util.TimeValue</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.hc.core5.util.Timeout</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.beans.factory.DisposableBean</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.beans.factory.FactoryBean</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.client.ClientHttpRequestFactory</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.client.HttpComponentsClientHttpRequestFactory</span><span class="p">;</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RequestFactoryBean</span><span class="w"> </span><span class="kd">implements</span>
<span class="w">                                </span><span class="n">FactoryBean</span><span class="o">&lt;</span><span class="n">ClientHttpRequestFactory</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">                                </span><span class="n">DisposableBean</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (17)</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">keyStoreFileName</span><span class="p">;</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">char</span><span class="o">[]</span><span class="w"> </span><span class="n">keyStorePassword</span><span class="p">;</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">HttpComponentsClientHttpRequestFactory</span><span class="w"> </span><span class="n">factory</span><span class="p">;</span><span class="w"> </span><span class="c1">// (17)</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ClientHttpRequestFactory</span><span class="w"> </span><span class="nf">getObject</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="c1">// (1)</span>
<span class="w">        </span><span class="n">SSLContext</span><span class="w"> </span><span class="n">sslContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SSLContext</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&quot;TLS&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="n">KeyStore</span><span class="w"> </span><span class="n">ks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyStore</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">KeyStore</span><span class="p">.</span><span class="na">getDefaultType</span><span class="p">());</span>
<span class="w">        </span><span class="n">ks</span><span class="p">.</span><span class="na">load</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getClassLoader</span><span class="p">().</span><span class="na">getResourceAsStream</span><span class="p">(</span>
<span class="w">                </span><span class="k">this</span><span class="p">.</span><span class="na">keyStoreFileName</span><span class="p">),</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">keyStorePassword</span><span class="p">);</span>

<span class="w">        </span><span class="n">KeyManagerFactory</span><span class="w"> </span><span class="n">kmf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyManagerFactory</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">KeyManagerFactory</span>
<span class="w">                </span><span class="p">.</span><span class="na">getDefaultAlgorithm</span><span class="p">());</span>
<span class="w">        </span><span class="n">kmf</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">keyStorePassword</span><span class="p">);</span>

<span class="w">        </span><span class="n">TrustManagerFactory</span><span class="w"> </span><span class="n">tmf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TrustManagerFactory</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span>
<span class="w">                </span><span class="n">TrustManagerFactory</span><span class="p">.</span><span class="na">getDefaultAlgorithm</span><span class="p">());</span>
<span class="w">        </span><span class="n">tmf</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">ks</span><span class="p">);</span>

<span class="w">        </span><span class="n">sslContext</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">kmf</span><span class="p">.</span><span class="na">getKeyManagers</span><span class="p">(),</span><span class="w"> </span><span class="n">tmf</span><span class="p">.</span><span class="na">getTrustManagers</span><span class="p">(),</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// @formatter:off</span>
<span class="w">        </span><span class="n">PoolingHttpClientConnectionManager</span><span class="w"> </span><span class="n">connectionManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PoolingHttpClientConnectionManagerBuilder</span><span class="p">.</span><span class="na">create</span><span class="p">()</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">                </span><span class="p">.</span><span class="na">setSSLSocketFactory</span><span class="p">(</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">                        </span><span class="n">SSLConnectionSocketFactoryBuilder</span><span class="p">.</span><span class="na">create</span><span class="p">()</span>
<span class="w">                        </span><span class="p">.</span><span class="na">setSslContext</span><span class="p">(</span><span class="n">sslContext</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">setTlsVersions</span><span class="p">(</span><span class="n">TLS</span><span class="p">.</span><span class="na">V_1_3</span><span class="p">,</span><span class="w"> </span><span class="n">TLS</span><span class="p">.</span><span class="na">V_1_2</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">build</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">setDefaultSocketConfig</span><span class="p">(</span><span class="w"> </span><span class="c1">// (4)</span>
<span class="w">                        </span><span class="n">SocketConfig</span><span class="p">.</span><span class="na">custom</span><span class="p">()</span>
<span class="w">                        </span><span class="p">.</span><span class="na">setSoTimeout</span><span class="p">(</span><span class="n">Timeout</span><span class="p">.</span><span class="na">ofMinutes</span><span class="p">(</span><span class="mi">1L</span><span class="p">))</span>
<span class="w">                        </span><span class="p">.</span><span class="na">build</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">setMaxConnTotal</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// (5)</span>
<span class="w">                </span><span class="p">.</span><span class="na">setMaxConnPerRoute</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// (6)</span>
<span class="w">                </span><span class="p">.</span><span class="na">setPoolConcurrencyPolicy</span><span class="p">(</span><span class="n">PoolConcurrencyPolicy</span><span class="p">.</span><span class="na">STRICT</span><span class="p">)</span><span class="w"> </span><span class="c1">// (7)</span>
<span class="w">                </span><span class="p">.</span><span class="na">setConnPoolPolicy</span><span class="p">(</span><span class="n">PoolReusePolicy</span><span class="p">.</span><span class="na">LIFO</span><span class="p">)</span><span class="w"> </span><span class="c1">// (8)</span>
<span class="w">                </span><span class="p">.</span><span class="na">setDefaultConnectionConfig</span><span class="p">(</span><span class="w"> </span><span class="c1">// (9)</span>
<span class="w">                        </span><span class="n">ConnectionConfig</span><span class="p">.</span><span class="na">custom</span><span class="p">()</span>
<span class="w">                        </span><span class="p">.</span><span class="na">setTimeToLive</span><span class="p">(</span><span class="n">TimeValue</span><span class="p">.</span><span class="na">ofMinutes</span><span class="p">(</span><span class="mi">1L</span><span class="p">))</span><span class="w"> </span><span class="c1">// (10)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">setConnectTimeout</span><span class="p">(</span><span class="n">Timeout</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="mi">5L</span><span class="p">))</span><span class="w"> </span><span class="c1">// (11)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">build</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// @formatter:on</span>

<span class="w">        </span><span class="c1">// @formatter:off</span>
<span class="w">        </span><span class="n">CloseableHttpClient</span><span class="w"> </span><span class="n">httpClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HttpClients</span><span class="p">.</span><span class="na">custom</span><span class="p">()</span><span class="w"> </span><span class="c1">// (12)</span>
<span class="w">                </span><span class="p">.</span><span class="na">setConnectionManager</span><span class="p">(</span><span class="n">connectionManager</span><span class="p">)</span><span class="w"> </span><span class="c1">// (13)</span>
<span class="w">                </span><span class="p">.</span><span class="na">setDefaultRequestConfig</span><span class="p">(</span>
<span class="w">                        </span><span class="n">RequestConfig</span><span class="p">.</span><span class="na">custom</span><span class="p">()</span>
<span class="w">                        </span><span class="p">.</span><span class="na">setResponseTimeout</span><span class="p">(</span><span class="n">Timeout</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="mi">10L</span><span class="p">))</span><span class="w"> </span><span class="c1">// (14)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">setCookieSpec</span><span class="p">(</span><span class="n">StandardCookieSpec</span><span class="p">.</span><span class="na">STRICT</span><span class="p">)</span><span class="w"> </span><span class="c1">// (15)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">build</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// @formatter:on</span>

<span class="w">        </span><span class="c1">// (16)</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">factory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HttpComponentsClientHttpRequestFactory</span><span class="p">(</span><span class="n">httpClient</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">factory</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">getObjectType</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ClientHttpRequestFactory</span><span class="p">.</span><span class="na">class</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isSingleton</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setKeyStoreFileName</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">keyStoreFileName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">keyStoreFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keyStoreFileName</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setKeyStorePassword</span><span class="p">(</span><span class="kt">char</span><span class="o">[]</span><span class="w"> </span><span class="n">keyStorePassword</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">keyStorePassword</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keyStorePassword</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// (17)</span>
<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">destroy</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">factory</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">factory</span><span class="p">.</span><span class="na">destroy</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">後述のbean定義で指定されたキーストアファイルのファイル名とパスワードを元に、SSLコンテキストを作成する。</div>
<div class="line">使用するSSL自己署名証明書のキーストアファイルは、クラスパス上に配置する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">(1)で作成したSSLコンテキストを設定するための<a class="reference external" href="https://javadoc.io/static/org.apache.httpcomponents.client5/httpclient5/5.2.3/org/apache/hc/client5/http/io/HttpClientConnectionManager.html">HttpClientConnectionManager</a>を作成する。</div>
<div class="line">ここでは、実装クラスとして<code class="docutils literal notranslate"><span class="pre">org.apache.hc.client5.http.impl.io.PoolingHttpClientConnectionManager</span></code>を指定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">(1)で作成したSSLコンテキストを設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Socket Configのデフォルト値を設定する。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Socket</span></code>から提供される<code class="docutils literal notranslate"><span class="pre">InputStream</span></code>の<code class="docutils literal notranslate"><span class="pre">read()</span></code>のブロック時間が<a class="reference external" href="https://hc.apache.org/httpcomponents-core-5.2.x/5.2.3/httpcore5/apidocs/org/apache/hc/core5/http/io/SocketConfig.Builder.html#setSoTimeout(org.apache.hc.core5.util.Timeout)">SoTimeout</a>を越えた場合、通常、<code class="docutils literal notranslate"><span class="pre">java.net.SocketTimeoutException</span></code>が発生するが、TCPコネクション確立後、SSLハンドシェイクを行っている間にこのタイムアウトが起きた場合には、<code class="docutils literal notranslate"><span class="pre">org.apache.hc.client5.http.ConnectTimeoutException</span></code>が発生する。</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>SoTimeoutはSSLハンドシェイクが完了する十分な長さを確保すること。</strong></p>
<p>SSLハンドシェイク完了前に<code class="docutils literal notranslate"><span class="pre">SoTimeout</span></code>によってタイムアウトした際に、SSLハンドシェイクが中断される(SSLハンドシェイクに関する続きの通信を行わなくなる)がTCPコネクションのcloseも行われない事象を確認している。この状態になると、サーバ側で処理を破棄しない限りサーバ側はSSLハンドシェイクの続きを待つこととなってしまう。</p>
<p>そのため、SSLハンドシェイク中に通信障害や通信相手のハードウェア障害等に遭遇し通信相手からのパケットが届かない時間が長く続く場合(クライアント側で通信の継続を諦めなければならない場合)以外においては、<code class="docutils literal notranslate"><span class="pre">SoTimeout</span></code>を利用したタイムアウトは避けたほうが良い。</p>
<p>SSLハンドシェイク完了後のHTTPSリクエストに対するレスポンスのタイムアウトには、後述の<code class="docutils literal notranslate"><span class="pre">ResponseTimeout</span></code>が利用できるため、</p>
<ul class="simple">
<li><p>HTTPSリクエストに対する応答に関するタイムアウトには<code class="docutils literal notranslate"><span class="pre">ResponseTimeout</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ResponseTimeout</span></code>の有効範囲外(HTTPSリクエスト送信前)となるSSLハンドシェイク中の応答に関するタイムアウトには<code class="docutils literal notranslate"><span class="pre">SoTimeout</span></code>(正常稼働時にはタイムアウトしないよう長めに設定)</p></li>
</ul>
<p>という具合に使い分けること。なお、<code class="docutils literal notranslate"><span class="pre">SoTimeout</span></code>のデフォルト値は3分となっている。</p>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">最大合計接続数を設定する。</div>
<div class="line">最大合計接続数を超える場合、後続処理はコネクションの取得を待機する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">宛先（ホスト名 + ポート番号 及び スキーマ定義）ごとの最大接続数を設定する。</div>
<div class="line">最大接続数を超える場合、後続処理はコネクションの取得を待機する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><a class="reference external" href="https://hc.apache.org/httpcomponents-core-5.2.x/5.2.3/httpcore5/apidocs/org/apache/hc/core5/pool/PoolConcurrencyPolicy.html">プール同時実行ポリシー</a>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><a class="reference external" href="https://hc.apache.org/httpcomponents-core-5.2.x/5.2.3/httpcore5/apidocs/org/apache/hc/core5/pool/PoolReusePolicy.html">プールされたコネクションの再利用ポリシー</a>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">コネクションに関連するデフォルト値を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">コネクションが接続されてから切断されるまでの最大生存時間を設定する。</div>
<div class="line">使用状況にかかわらず、<a class="reference external" href="https://javadoc.io/static/org.apache.httpcomponents.client5/httpclient5/5.2.3/org/apache/hc/client5/http/impl/io/PoolingHttpClientConnectionManagerBuilder.html#setConnectionTimeToLive(org.apache.hc.core5.util.TimeValue)">ConnectionTimeToLive</a>を越えた場合にコネクションを破棄する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">新しい接続が確立されるまでのタイムアウトのデフォルト値を設定する。</div>
<div class="line">接続の確立に<a class="reference external" href="https://javadoc.io/static/org.apache.httpcomponents.client5/httpclient5/5.2.3/org/apache/hc/client5/http/config/RequestConfig.Builder.html#setConnectTimeout(org.apache.hc.core5.util.Timeout)">ConnectTimeout</a>以上かかった場合、<code class="docutils literal notranslate"><span class="pre">org.apache.hc.client5.http.HttpHostConnectException</span></code>が発生する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">作成したSSLコンテキストを利用する <code class="docutils literal notranslate"><span class="pre">org.apache.hc.client5.http.impl.classic.CloseableHttpClient</span></code>を作成する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(13)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">(2)で作成した<code class="docutils literal notranslate"><span class="pre">HttpClientConnectionManager</span></code>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(14)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">レスポンスタイムアウトのデフォルト値を設定する。</div>
<div class="line">レスポンス返却に<a class="reference external" href="https://javadoc.io/static/org.apache.httpcomponents.client5/httpclient5/5.2.3/org/apache/hc/client5/http/config/RequestConfig.Builder.html#setResponseTimeout(org.apache.hc.core5.util.Timeout)">ResponseTimeout</a>以上かかった場合、<code class="docutils literal notranslate"><span class="pre">java.net.SocketTimeoutException</span></code>が発生する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(15)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><a class="reference external" href="https://javadoc.io/static/org.apache.httpcomponents.client5/httpclient5/5.2/org/apache/hc/client5/http/cookie/StandardCookieSpec.html">HttpClientがサポートするCookieの仕様</a>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(16)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">作成した<code class="docutils literal notranslate"><span class="pre">HttpClient</span></code>を利用する<code class="docutils literal notranslate"><span class="pre">ClientHttpRequestFactory</span></code>を作成する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(17)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">FactoryBean</span></code>で生成したオブジェクトのライフサイクルはDIコンテナで管理されないため、破棄時に特定の処理を実行するには<code class="docutils literal notranslate"><span class="pre">FactoryBean</span></code>に<code class="docutils literal notranslate"><span class="pre">DisposableBean</span></code>インタフェースの<code class="docutils literal notranslate"><span class="pre">destroy</span></code>メソッドを実装する必要がある。</div>
<div class="line">ここでは、<code class="docutils literal notranslate"><span class="pre">getObject</span></code>メソッドで生成した <code class="docutils literal notranslate"><span class="pre">HttpComponentsClientHttpRequestFactory</span></code>の<code class="docutils literal notranslate"><span class="pre">destroy</span></code>メソッドを呼び出し、<code class="docutils literal notranslate"><span class="pre">HttpClient</span></code>をクローズしている。このため、生成したオブジェクトを変数に保持している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>通信先のアプリケーションがTLS 1.2以前のバージョンにしか対応していない等の理由により、使用するTLSのバージョンをJVMレベルで変更するには<a class="reference internal" href="../../Appendix/Java17Settings.html#support-tls1-3-by-default-from-java11"><span class="std std-ref">HTTP通信におけるTLS(Transport Layer Security) v1.3のサポート</span></a>を参照されたい。</p>
<p>ただし、JVMレベルで設定してしまうと一つのクライアントアプリからTLS 1.2とTLS 1.3を利用した別々のアプリケーションに接続するような要件を実現することができない。このような場合は、<code class="docutils literal notranslate"><span class="pre">HttpClient</span></code>ごとに利用するTLSのバージョンを指定するような実装を検討されたい。</p>
</div>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">HttpClient</span></code>および  <code class="docutils literal notranslate"><span class="pre">HttpClientBuilder</span></code>を使用するためには、Apache HttpComponents HttpClient のライブラリが必要となる。</div>
<div class="line">以下を <code class="file docutils literal notranslate"><span class="pre">pom.xml</span></code>に追加し、Apache HttpComponents HttpClient を依存ライブラリに追加する。</div>
</div>
<ul>
<li><p><code class="file docutils literal notranslate"><span class="pre">pom.xml</span></code></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
<span class="w">    </span><span class="nt">&lt;groupId&gt;</span>org.apache.httpcomponents.client5<span class="nt">&lt;/groupId&gt;</span>
<span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>httpclient5<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>上記設定例は、依存ライブラリのバージョンを親プロジェクトである terasoluna-gfw-parent で管理する前提であるため、pom.xmlでのバージョンの指定は不要である。</p>
<p>上記の依存ライブラリはterasoluna-gfw-parentが依存している<a class="reference external" href="https://docs.spring.io/spring-boot/docs/3.2.2/reference/htmlsingle/#dependency-versions">Spring Boot</a>で管理されている。</p>
</div>
</li>
</ul>
<p><strong>bean定義ファイルの定義例</strong></p>
<p>SSL自己署名証明書を使用したSSL通信を行う <code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>を定義する。</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-5-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-5-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-5-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-5-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-5-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-5-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">ApplicationContextConfig.java</span></code></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${rscl.keystore.filename}&quot;</span><span class="p">)</span>
<span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">keystoreFilename</span><span class="p">;</span>

<span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${rscl.keystore.password}&quot;</span><span class="p">)</span>
<span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">keystorePassword</span><span class="p">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;httpsRestTemplate&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">RestTemplate</span><span class="w"> </span><span class="nf">httpsRestTemplate</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RestTemplate</span><span class="p">(</span><span class="n">httpsRequestFactoryBean</span><span class="p">().</span><span class="na">getObject</span><span class="p">());</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="p">}</span>

<span class="c1">// (1)</span>
<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;httpsRequestFactoryBean&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">RequestFactoryBean</span><span class="w"> </span><span class="nf">httpsRequestFactoryBean</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">RequestFactoryBean</span><span class="w"> </span><span class="n">factory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RequestFactoryBean</span><span class="p">();</span>
<span class="w">    </span><span class="n">factory</span><span class="p">.</span><span class="na">setKeyStoreFileName</span><span class="p">(</span><span class="n">keystoreFilename</span><span class="p">);</span>
<span class="w">    </span><span class="n">factory</span><span class="p">.</span><span class="na">setKeyStorePassword</span><span class="p">(</span><span class="n">keystorePassword</span><span class="p">.</span><span class="na">toCharArray</span><span class="p">());</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">factory</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">作成した <code class="docutils literal notranslate"><span class="pre">RequestFactoryBean</span></code>を <code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>のコンストラクタに指定する。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">RequestFactoryBean</span></code>には、キーストアファイルのファイル名とパスワードを渡す。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div><div aria-labelledby="tab-5-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-5-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">applicationContext.xml</span></code></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;httpsRestTemplate&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.web.client.RestTemplate&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;constructor-arg&gt;</span>
<span class="w">        </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;com.example.restclient.RequestFactoryBean&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">            </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;keyStoreFileName&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${rscl.keystore.filename}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;keyStorePassword&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${rscl.keystore.password}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/bean&gt;</span>
<span class="w">    </span><span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">作成した <code class="docutils literal notranslate"><span class="pre">RequestFactoryBean</span></code>を <code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>のコンストラクタに指定する。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">RequestFactoryBean</span></code>には、キーストアファイルのファイル名とパスワードを渡す。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div></div>
<p><strong>RestTemplateの使用方法</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>の使い方については、SSL自己署名証明書を使用しない場合と同じである。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="basic">
<span id="restclienthowtouseauthentication"></span><h3><a class="toc-backref" href="#id71" role="doc-backlink"><span class="section-number">5.2.2.9. </span>Basic認証</a><a class="headerlink" href="#basic" title="Permalink to this heading">¶</a></h3>
<p>サーバがBasic認証を要求する場合は、以下のように実装する。このとき、Java標準の<code class="docutils literal notranslate"><span class="pre">java.util.Base64</span></code>を使用する。</p>
<p><strong>Basic認証の実装例</strong></p>
<p>フィールド宣言部</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${api.auth.username}&quot;</span><span class="p">)</span>
<span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">;</span>

<span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${api.auth.password}&quot;</span><span class="p">)</span>
<span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>
</pre></div>
</div>
<p>メソッド内部</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">String</span><span class="w"> </span><span class="n">plainCredentials</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;:&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">password</span><span class="p">;</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="n">String</span><span class="w"> </span><span class="n">base64Credentials</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">getEncoder</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">encodeToString</span><span class="p">(</span><span class="n">plainCredentials</span><span class="p">.</span><span class="na">getBytes</span><span class="p">(</span><span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">));</span><span class="w"> </span><span class="c1">// (2)</span>

<span class="n">RequestEntity</span><span class="w"> </span><span class="n">requestEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RequestEntity</span>
<span class="w">      </span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&quot;Authorization&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Basic &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">base64Credentials</span><span class="p">)</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">      </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ユーザ名とパスワードを「”<code class="docutils literal notranslate"><span class="pre">:</span></code>“ 」でつなげる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">（1）をバイト配列に変換して、Base64エンコードする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">AuthorizationヘッダをBasic認証の資格情報を設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Spring Security 5より、<code class="docutils literal notranslate"><span class="pre">org.springframework.security.crypto.codec.Base64</span></code>は非推奨になったため、Java標準の<code class="docutils literal notranslate"><span class="pre">java.util.Base64</span></code>に置き換えることを推奨する。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="restclienthowtousefileupload">
<span id="id21"></span><h3><a class="toc-backref" href="#id72" role="doc-backlink"><span class="section-number">5.2.2.10. </span>ファイルアップロード(マルチパートリクエスト)</a><a class="headerlink" href="#restclienthowtousefileupload" title="Permalink to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>を使用してファイルアップロード(マルチパートリクエスト)を行う場合は、以下のように実装する。</p>
<p><strong>ファイルアップロードの実装例</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">MultiValueMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">multiPartBody</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedMultiValueMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="c1">//(1)</span>
<span class="n">multiPartBody</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;file&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ClassPathResource</span><span class="p">(</span><span class="s">&quot;/uploadFiles/User.txt&quot;</span><span class="p">));</span><span class="c1">//(2)</span>

<span class="n">RequestEntity</span><span class="o">&lt;</span><span class="n">MultiValueMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">requestEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RequestEntity</span>
<span class="w">        </span><span class="p">.</span><span class="na">post</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">contentType</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">MULTIPART_FORM_DATA</span><span class="p">)</span><span class="c1">//(3)</span>
<span class="w">        </span><span class="p">.</span><span class="na">body</span><span class="p">(</span><span class="n">multiPartBody</span><span class="p">);</span><span class="c1">//(4)</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">マルチパートリクエストとして送信するデータを格納するために<code class="docutils literal notranslate"><span class="pre">MultiValueMap</span></code>を生成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">パラメータ名をキーに指定して、アップロードするファイルを<code class="docutils literal notranslate"><span class="pre">MultiValueMap</span></code>に追加する。</div>
<div class="line">上記例では、<code class="docutils literal notranslate"><span class="pre">file</span></code>というパラメータ名を指定して、クラスパス上に配置されているファイルをアップロードファイルとして追加している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Content-Typeヘッダのメディアタイプを<code class="docutils literal notranslate"><span class="pre">multipart/form-data</span></code>に設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">アップロードするファイルが格納されている<code class="docutils literal notranslate"><span class="pre">MultiValueMap</span></code>をリクエストボディに設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Spring Frameworkが提供するResourceクラスについて</strong></p>
<p>Spring Frameworkはリソースを表現するインタフェースとして<code class="docutils literal notranslate"><span class="pre">org.springframework.core.io.Resource</span></code>を提供しており、ファイルをアップロードする際に使用することができる。</p>
<p><code class="docutils literal notranslate"><span class="pre">Resource</span></code>インタフェースの主な実装クラスは以下の通りである。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">org.springframework.core.io.PathResource</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">org.springframework.core.io.FileSystemResource</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">org.springframework.core.io.ClassPathResource</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">org.springframework.core.io.UrlResource</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">org.springframework.core.io.InputStreamResource</span></code> (ファイル名をサーバに連携できない)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">org.springframework.core.io.ByteArrayResource</span></code> (ファイル名をサーバに連携できない)</p></li>
</ul>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="restclienthowtousefiledownload">
<span id="id22"></span><h3><a class="toc-backref" href="#id73" role="doc-backlink"><span class="section-number">5.2.2.11. </span>ファイルダウンロード</a><a class="headerlink" href="#restclienthowtousefiledownload" title="Permalink to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">RestTeamplate</span></code>を使用してファイルダウンロードを行う場合は、以下のように実装する。</p>
<p><strong>ファイルダウンロードの実装例（ファイルサイズが小さい場合）</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">RequestEntity</span><span class="w"> </span><span class="n">requestEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RequestEntity</span>
<span class="w">        </span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>

<span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;</span><span class="w"> </span><span class="n">responseEntity</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">exchange</span><span class="p">(</span><span class="n">requestEntity</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="c1">//(1)</span>

<span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">downloadContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">responseEntity</span><span class="p">.</span><span class="na">getBody</span><span class="p">();</span><span class="c1">//(2)</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ダウンロードファイルを指定したデータ型で扱う。ここでは、バイト配列を指定。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">レスポンスボディからダウンロードしたファイルのデータを取得する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>サイズの大きいファイルをダウンロードする際の注意点</strong></p>
<p>サイズの大きなファイルをデフォルトで登録されている<code class="docutils literal notranslate"><span class="pre">HttpMessageConverter</span></code>を使用して <code class="docutils literal notranslate"><span class="pre">byte</span></code>配列で取得すると、 <code class="docutils literal notranslate"><span class="pre">java.lang.OutOfMemoryError</span></code>が発生する可能性がある。そのため、サイズの大きなファイルをダウンロードしたい場合は、レスポンスから <code class="docutils literal notranslate"><span class="pre">InputStream</span></code>を取得して、ダウンロードデータを少しずつファイルに書き出す必要がある。</p>
</div>
<p id="restclienthowtousebigfiledownload"><strong>ファイルダウンロードの実装例（ファイルサイズが大きい場合）</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="kd">final</span><span class="w"> </span><span class="n">ResponseExtractor</span><span class="o">&lt;</span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">responseExtractor</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">ResponseExtractor</span><span class="o">&lt;</span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">extractData</span><span class="p">(</span><span class="n">ClientHttpResponse</span><span class="w"> </span><span class="n">response</span><span class="p">)</span>
<span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">File</span><span class="w"> </span><span class="n">rcvFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span><span class="p">.</span><span class="na">createTempFile</span><span class="p">(</span><span class="s">&quot;rcvFile&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;zip&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="n">FileCopyUtils</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">getBody</span><span class="p">(),</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="n">rcvFile</span><span class="p">));</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">getStatusCode</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">headers</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">getHeaders</span><span class="p">()).</span><span class="na">body</span><span class="p">(</span><span class="n">rcvFile</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">};</span>

<span class="c1">// (3)</span>
<span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span><span class="w"> </span><span class="n">responseEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">restTemplate</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">targetUri</span><span class="p">,</span>
<span class="w">        </span><span class="n">HttpMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">responseExtractor</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">responseEntity</span><span class="p">.</span><span class="na">getStatusCode</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">File</span><span class="w"> </span><span class="n">getFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">responseEntity</span><span class="p">.</span><span class="na">getBody</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RestTemplate#execute</span></code>で取得されたレスポンスから、<code class="docutils literal notranslate"><span class="pre">RestTemplate#execute</span></code>の戻り値を作成するための処理を作成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">レスポンスボディ(<code class="docutils literal notranslate"><span class="pre">InputStream</span></code>)からデータを読込み、ファイルを作成する。</div>
<div class="line">作成したファイルとHTTPヘッダ、ステータスコードを <code class="docutils literal notranslate"><span class="pre">ResponseEntity&lt;File&gt;</span></code>に格納して返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RestTemplate#execute</span></code>を使用して、ファイルのダウンロードを行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>ファイルダウンロードの実装例（ファイルサイズが大きい場合（ResponseEntityを使わない例））</strong></p>
<p>ステータスコードの判定やHTTPヘッダの参照等が不要な場合は、 以下のように<code class="docutils literal notranslate"><span class="pre">ResponseEntity</span></code>ではなく <code class="docutils literal notranslate"><span class="pre">File</span></code>を返却すればよい。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">final</span><span class="w"> </span><span class="n">ResponseExtractor</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span><span class="w"> </span><span class="n">responseExtractor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ResponseExtractor</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">File</span><span class="w"> </span><span class="nf">extractData</span><span class="p">(</span><span class="n">ClientHttpResponse</span><span class="w"> </span><span class="n">response</span><span class="p">)</span>
<span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">File</span><span class="w"> </span><span class="n">rcvFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span><span class="p">.</span><span class="na">createTempFile</span><span class="p">(</span><span class="s">&quot;rcvFile&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;zip&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="n">FileCopyUtils</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">getBody</span><span class="p">(),</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span>
<span class="w">                </span><span class="n">rcvFile</span><span class="p">));</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">rcvFile</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">};</span>

<span class="n">File</span><span class="w"> </span><span class="n">getFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">restTemplate</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">targetUri</span><span class="p">,</span><span class="w"> </span><span class="n">HttpMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">,</span>
<span class="w">        </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">responseExtractor</span><span class="p">);</span>
<span class="c1">// omitted</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="restfulurl-uri">
<span id="restclienthowtouserestfull"></span><h3><a class="toc-backref" href="#id74" role="doc-backlink"><span class="section-number">5.2.2.12. </span>RESTfulなURL(URIテンプレート)を扱う方法と実装例</a><a class="headerlink" href="#restfulurl-uri" title="Permalink to this heading">¶</a></h3>
<p>RESTfulなURLを扱うには、URIテンプレートを使用して実装を行えばよい。</p>
<p><strong>getForObjectメソッドでの使用例</strong></p>
<p>フィールド宣言部</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${api.serverUrl}/api/users/{userId}&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="n">String</span><span class="w"> </span><span class="n">uriStr</span><span class="p">;</span>
</pre></div>
</div>
<p>メソッド内部</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">getForObject</span><span class="p">(</span><span class="n">uriStr</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;0001&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// (2)</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">URIテンプレートの変数{userId}は、<code class="docutils literal notranslate"><span class="pre">RestTeamplate</span></code>の使用時に指定の値に変換される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">URIテンプレートの変数1つ目が<code class="docutils literal notranslate"><span class="pre">getForObject</span></code>メソッドの第3引数に指定した値で置換され、『<code class="docutils literal notranslate"><span class="pre">http://localhost:8080/api/users/0001</span></code>』として処理される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>exchangeメソッドでの使用例</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${api.serverUrl}/api/users/{action}&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="n">String</span><span class="w"> </span><span class="n">uriStr</span><span class="p">;</span>
</pre></div>
</div>
<p>メソッド内部</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">URI</span><span class="w"> </span><span class="n">targetUri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UriComponentsBuilder</span><span class="p">.</span><span class="na">fromUriString</span><span class="p">(</span><span class="n">uriStr</span><span class="p">).</span>
<span class="w">        </span><span class="n">buildAndExpand</span><span class="p">(</span><span class="s">&quot;create&quot;</span><span class="p">).</span><span class="na">toUri</span><span class="p">();</span><span class="w"> </span><span class="c1">//(2)</span>

<span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">User</span><span class="p">();</span>

<span class="c1">// omitted</span>

<span class="n">RequestEntity</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="n">requestEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RequestEntity</span>
<span class="w">        </span><span class="p">.</span><span class="na">post</span><span class="p">(</span><span class="n">targetUri</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">body</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>

<span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="n">responseEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">exchange</span><span class="p">(</span><span class="n">requestEntity</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">URIテンプレートの変数{action}は、<code class="docutils literal notranslate"><span class="pre">RestTeamplate</span></code>の使用時に指定の値に変換される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">UriComponentsBuilder</span></code>を使用することで、URIテンプレートの変数1つ目が<code class="docutils literal notranslate"><span class="pre">buildAndExpand</span></code>の引数で指定した値に置換され、『<code class="docutils literal notranslate"><span class="pre">http://localhost:8080/api/users/create</span></code>』のURIが作成される。</div>
<div class="line">詳細は<a class="reference external" href="https://docs.spring.io/spring-framework/docs/6.1.3/javadoc-api/org/springframework/web/util/UriComponentsBuilder.html">UriComponentsBuilderのJavadoc</a>を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="how-to-extend">
<span id="restclienthowtoextend"></span><h2><a class="toc-backref" href="#id75" role="doc-backlink"><span class="section-number">5.2.3. </span>How to extend</a><a class="headerlink" href="#how-to-extend" title="Permalink to this heading">¶</a></h2>
<p>本節では、<code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>の拡張方法について説明する。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="restclienthowtoextendhttpmessageconverter">
<span id="id23"></span><h3><a class="toc-backref" href="#id76" role="doc-backlink"><span class="section-number">5.2.3.1. </span>任意の<code class="docutils literal notranslate"><span class="pre">HttpMessageConverter</span></code>を登録する方法</a><a class="headerlink" href="#restclienthowtoextendhttpmessageconverter" title="Permalink to this heading">¶</a></h3>
<p>デフォルトで登録されている <code class="docutils literal notranslate"><span class="pre">HttpMessageConverter</span></code>で電文変換の要件を満たせない場合は、任意の<code class="docutils literal notranslate"><span class="pre">HttpMessageConverter</span></code>を登録することができる。ただし、デフォルトで登録されていた<code class="docutils literal notranslate"><span class="pre">HttpMessageConverter</span></code>は削除されるので、必要な<code class="docutils literal notranslate"><span class="pre">HttpMessageConverter</span></code>をすべて個別に登録する必要がある。</p>
<p><strong>bean定義ファイルの定義例</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-6-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-6-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-6-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-6-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-6-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-6-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">ApplicationContextConfig.java</span></code></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;jaxb2CollectionHttpMessageConverter&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">Jaxb2CollectionHttpMessageConverter</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">jaxb2CollectionHttpMessageConverter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Jaxb2CollectionHttpMessageConverter</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="p">}</span>

<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;collectionRestTemplate&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">RestTemplate</span><span class="w"> </span><span class="nf">collectionRestTemplate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">RestTemplate</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RestTemplate</span><span class="p">();</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">HttpMessageConverter</span><span class="o">&lt;?&gt;&gt;</span><span class="w"> </span><span class="n">messageConverters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">messageConverters</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">jaxb2CollectionHttpMessageConverter</span><span class="p">());</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">setMessageConverters</span><span class="p">(</span><span class="n">messageConverters</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">登録する<code class="docutils literal notranslate"><span class="pre">HttpMessageConverter</span></code>の実装クラスをbean定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">messageConverters</span></code>プロパティに登録する<code class="docutils literal notranslate"><span class="pre">HttpMessageConverter</span></code>のbeanを設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div><div aria-labelledby="tab-6-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-6-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">applicationContext.xml</span></code></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;jaxb2CollectionHttpMessageConverter&quot;</span>
<span class="w">      </span><span class="na">class=</span><span class="s">&quot;org.springframework.http.converter.xml.Jaxb2CollectionHttpMessageConverter&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>

<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;restTemplate&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.web.client.RestTemplate&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;messageConverters&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">        </span><span class="nt">&lt;list&gt;</span>
<span class="w">            </span><span class="nt">&lt;ref</span><span class="w"> </span><span class="na">bean=</span><span class="s">&quot;jaxb2CollectionHttpMessageConverter&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/list&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">登録する<code class="docutils literal notranslate"><span class="pre">HttpMessageConverter</span></code>の実装クラスをbean定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">messageConverters</span></code>プロパティに登録する<code class="docutils literal notranslate"><span class="pre">HttpMessageConverter</span></code>のbeanをインジェクションする。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div></div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="restclienthowtoextendclienthttprequestinterceptor">
<span id="id24"></span><h3><a class="toc-backref" href="#id77" role="doc-backlink"><span class="section-number">5.2.3.2. </span>共通処理の適用（<code class="docutils literal notranslate"><span class="pre">ClientHttpRequestInterceptor</span></code>）</a><a class="headerlink" href="#restclienthowtoextendclienthttprequestinterceptor" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ClientHttpRequestInterceptor</span></code>を使用することで、サーバとの通信処理の前後に任意の処理を実行させることができる。</div>
<div class="line">ここでは、<a class="reference internal" href="#restclienthowtoextendclienthttprequestinterceptorlogging"><span class="std std-ref">ロギング処理</span></a>と、<a class="reference internal" href="#restclientbasicauthorizationinterceptorbeandefinition"><span class="std std-ref">Basic認証用のリクエストヘッダ設定処理</span></a>を適用する方法を紹介する。</div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="restclienthowtoextendclienthttprequestinterceptorlogging">
<span id="id25"></span><h4><a class="toc-backref" href="#id78" role="doc-backlink"><span class="section-number">5.2.3.2.1. </span>ロギング処理</a><a class="headerlink" href="#restclienthowtoextendclienthttprequestinterceptorlogging" title="Permalink to this heading">¶</a></h4>
<p>サーバとの通信ログを出力したい場合は、以下のような実装を行う。</p>
<p><strong>通信ログ出力の実装例</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.restclient</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.nio.charset.StandardCharsets</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">org.slf4j.Logger</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.slf4j.LoggerFactory</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.HttpRequest</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.client.ClientHttpRequestExecution</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.client.ClientHttpRequestInterceptor</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.client.ClientHttpResponse</span><span class="p">;</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LoggingInterceptor</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ClientHttpRequestInterceptor</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">//(1)</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Logger</span><span class="w"> </span><span class="n">logger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LoggerFactory</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">LoggingInterceptor</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ClientHttpResponse</span><span class="w"> </span><span class="nf">intercept</span><span class="p">(</span><span class="n">HttpRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">body</span><span class="p">,</span>
<span class="w">            </span><span class="n">ClientHttpRequestExecution</span><span class="w"> </span><span class="n">execution</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isInfoEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">requestBody</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="w"> </span><span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">);</span>

<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Request Header {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getHeaders</span><span class="p">());</span><span class="w"> </span><span class="c1">//(2)</span>
<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Request Body {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">requestBody</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">ClientHttpResponse</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">execution</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">body</span><span class="p">);</span><span class="w"> </span><span class="c1">//(3)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isInfoEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Response Header {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">getHeaders</span><span class="p">());</span><span class="w"> </span><span class="c1">// (4)</span>
<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Response Status Code {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">getStatusCode</span><span class="p">());</span><span class="w"> </span><span class="c1">// (5)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">response</span><span class="p">;</span><span class="w"> </span><span class="c1">// (6)</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ClientHttpRequestInterceptor</span></code>インタフェースを実装する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">リクエストする前に行いたい共通処理を実装する。</div>
<div class="line">上記の実装例では、リクエストヘッダーとリクエストボディの内容をログに出力している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">intercept</span></code>メソッドの引数として受け取った<code class="docutils literal notranslate"><span class="pre">ClientHttpRequestExecution</span></code>の<code class="docutils literal notranslate"><span class="pre">execute</span></code>メソッドを実行し、リクエストの送信を実行する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">レスポンスを受け取った後に行いたい共通処理を実装する。</div>
<div class="line">上記の実装例では、レスポンスヘッダの内容をログに出力している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">(4)と同様に、ステータスコードの内容をログに出力している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">(3)で受信したレスポンスをリターンする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>bean定義ファイルの定義例</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-7-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-7-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-7-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-7-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-7-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-7-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">ApplicationContextConfig.java</span></code></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;loggingInterceptor&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">LoggingInterceptor</span><span class="w"> </span><span class="nf">loggingInterceptor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LoggingInterceptor</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ClientHttpRequestInterceptor</span></code>の実装クラスのbean定義を行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div><div aria-labelledby="tab-7-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-7-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">applicationContext.xml</span></code></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;loggingInterceptor&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;com.example.restclient.LoggingInterceptor&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ClientHttpRequestInterceptor</span></code>の実装クラスのbean定義を行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div></div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="restclientbasicauthorizationinterceptorbeandefinition">
<span id="id26"></span><h4><a class="toc-backref" href="#id79" role="doc-backlink"><span class="section-number">5.2.3.2.2. </span>Basic認証用のリクエストヘッダ設定処理</a><a class="headerlink" href="#restclientbasicauthorizationinterceptorbeandefinition" title="Permalink to this heading">¶</a></h4>
<p>サーバにアクセスするためにBasic認証用のリクエストヘッダを設定する必要がある場合は、以下のようなbean定義を行う。</p>
<p><strong>bean定義ファイルの定義例</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-8-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-8-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-8-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-8-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-8-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-8-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">ApplicationContextConfig.java</span></code></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// (2)</span>
<span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${api.auth.username}&quot;</span><span class="p">)</span>
<span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">basicAuthUsername</span><span class="p">;</span>

<span class="c1">// (3)</span>
<span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${api.auth.password}&quot;</span><span class="p">)</span>
<span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">basicAuthPassword</span><span class="p">;</span>

<span class="c1">// (1)</span>
<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;basicAuthInterceptor&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">BasicAuthenticationInterceptor</span><span class="w"> </span><span class="nf">basicAuthInterceptor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BasicAuthenticationInterceptor</span><span class="p">(</span><span class="n">basicAuthUsername</span><span class="p">,</span><span class="w"> </span><span class="n">basicAuthPassword</span><span class="p">);</span><span class="w"> </span><span class="c1">// (2)(3)</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ClientHttpRequestInterceptor</span></code>インタフェースを実装した<code class="docutils literal notranslate"><span class="pre">BasicAuthorizationInterceptor</span></code>のbean定義を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">コンストラクタ引数の<code class="docutils literal notranslate"><span class="pre">username</span></code>にユーザ名を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">コンストラクタ引数の<code class="docutils literal notranslate"><span class="pre">password</span></code>にパスワードを設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div><div aria-labelledby="tab-8-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-8-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">applicationContext.xml</span></code></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;basicAuthInterceptor&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.http.client.support.BasicAuthorizationInterceptor&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;username&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${api.auth.username}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;password&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${api.auth.password}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ClientHttpRequestInterceptor</span></code>インタフェースを実装した<code class="docutils literal notranslate"><span class="pre">BasicAuthorizationInterceptor</span></code>のbean定義を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">コンストラクタ引数の<code class="docutils literal notranslate"><span class="pre">username</span></code>にユーザ名を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">コンストラクタ引数の<code class="docutils literal notranslate"><span class="pre">password</span></code>にパスワードを設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div></div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id27">
<h4><a class="toc-backref" href="#id80" role="doc-backlink"><span class="section-number">5.2.3.2.3. </span><code class="docutils literal notranslate"><span class="pre">ClientHttpRequestInterceptor</span></code>の適用</a><a class="headerlink" href="#id27" title="Permalink to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>に作成した<code class="docutils literal notranslate"><span class="pre">ClientHttpRequestInterceptor</span></code>を適用する場合は、以下のようなbean定義を行う。</p>
<p><strong>bean定義ファイルの定義例</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-9-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-9-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-9-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-9-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-9-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-9-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">ApplicationContextConfig.java</span></code></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;basicAuthInterceptor&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">BasicAuthenticationInterceptor</span><span class="w"> </span><span class="nf">basicAuthInterceptor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="p">}</span>

<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;loggingInterceptor&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">LoggingInterceptor</span><span class="w"> </span><span class="nf">loggingInterceptor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="p">}</span>

<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;restTemplate&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">RestTemplate</span><span class="w"> </span><span class="nf">restTemplate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">RestTemplate</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RestTemplate</span><span class="p">();</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">ClientHttpRequestInterceptor</span><span class="o">&gt;</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="n">list</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">basicAuthInterceptor</span><span class="p">());</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="n">list</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">loggingInterceptor</span><span class="p">());</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">setInterceptors</span><span class="p">(</span><span class="n">list</span><span class="p">);</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">interceptors</span></code>プロパティに<code class="docutils literal notranslate"><span class="pre">ClientHttpRequestInterceptor</span></code>のListを設定する。</div>
<div class="line">複数のbeanを設定した場合は、リストの先頭から順にチェーン実行される。</div>
<div class="line">上記の例だと、<code class="docutils literal notranslate"><span class="pre">BasicAuthorizationInterceptor</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">LoggingInterceptor</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">ClientHttpRequest</span></code> の順番でリクエスト前の処理が実行される。(レスポンス後の処理は順番が逆転する)</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div><div aria-labelledby="tab-9-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-9-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">applicationContext.xml</span></code></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;restTemplate&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.web.client.RestTemplate&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;interceptors&quot;</span><span class="nt">&gt;</span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">        </span><span class="nt">&lt;list&gt;</span>
<span class="w">            </span><span class="nt">&lt;ref</span><span class="w"> </span><span class="na">bean=</span><span class="s">&quot;basicAuthInterceptor&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;ref</span><span class="w"> </span><span class="na">bean=</span><span class="s">&quot;loggingInterceptor&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/list&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">interceptors</span></code>プロパティに<code class="docutils literal notranslate"><span class="pre">ClientHttpRequestInterceptor</span></code>のListをインジェクションする。</div>
<div class="line">複数のbeanをインジェクションした場合は、リストの先頭から順にチェーン実行される。</div>
<div class="line">上記の例だと、<code class="docutils literal notranslate"><span class="pre">BasicAuthorizationInterceptor</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">LoggingInterceptor</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">ClientHttpRequest</span></code> の順番でリクエスト前の処理が実行される。(レスポンス後の処理は順番が逆転する)</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div></div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="restclientasync">
<span id="id28"></span><h3><a class="toc-backref" href="#id81" role="doc-backlink"><span class="section-number">5.2.3.3. </span>非同期リクエスト</a><a class="headerlink" href="#restclientasync" title="Permalink to this heading">¶</a></h3>
<p>非同期リクエストを行う場合は、<code class="docutils literal notranslate"><span class="pre">org.springframework.web.reactive.function.client.WebClient</span></code>を使用する。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Spring Framework 6.0から<code class="docutils literal notranslate"><span class="pre">AsyncRestTemplate</span></code>は削除されており、非同期リクエストはSpring Web Reactive APIの<a class="reference external" href="https://docs.spring.io/spring-framework/docs/6.1.3/reference/html/integration.html#rest-webclient">WebClient</a>を使用するように案内されている。</p>
<p>TERASOLUNA Server Framework for Java (5.x)では<code class="docutils literal notranslate"><span class="pre">AsyncRestTemplate</span></code>の代替機能として<code class="docutils literal notranslate"><span class="pre">WebClient</span></code>を案内しているだけであり、Spring Web Reactiveをサポートしているわけではない点に注意されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="id29">
<h4><a class="toc-backref" href="#id82" role="doc-backlink"><span class="section-number">5.2.3.3.1. </span><code class="docutils literal notranslate"><span class="pre">WebClient</span></code>のセットアップ</a><a class="headerlink" href="#id29" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">WebClient</span></code>を使用する場合は、<code class="docutils literal notranslate"><span class="pre">WebClient</span></code>をDIコンテナに登録し、<code class="docutils literal notranslate"><span class="pre">WebClient</span></code>を利用するコンポーネントにインジェクションする。</div>
<div class="line"><br /></div>
</div>
<section id="id30">
<h5><span class="section-number">5.2.3.3.1.1. </span>依存ライブラリ設定<a class="headerlink" href="#id30" title="Permalink to this heading">¶</a></h5>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">WebClient</span></code>を使用するために<code class="docutils literal notranslate"><span class="pre">pom.xml</span></code>に、Spring Frameworkのspring-webfluxライブラリを追加する。</div>
<div class="line">マルチプロジェクト構成の場合は、domainプロジェクトの<code class="docutils literal notranslate"><span class="pre">pom.xml</span></code>に追加する。</div>
</div>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;dependencies&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
<span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>spring-webflux<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<span class="w">          </span><span class="nt">&lt;groupId&gt;</span>io.projectreactor.netty<span class="nt">&lt;/groupId&gt;</span>
<span class="w">          </span><span class="nt">&lt;artifactId&gt;</span>reactor-netty<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>

<span class="nt">&lt;/dependencies&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">spring-webflux</span></code>ライブラリをdependenciesに追加する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">reactor-netty</span></code>ライブラリをdependenciesに追加する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>上記設定例は、依存ライブラリのバージョンを親プロジェクトである terasoluna-gfw-parent で管理する前提であるため、pom.xmlでのバージョンの指定は不要である。</p>
<p>上記の依存ライブラリはterasoluna-gfw-parentが依存している<a class="reference external" href="https://docs.spring.io/spring-boot/docs/3.2.2/reference/htmlsingle/#dependency-versions">Spring Boot</a>で管理されている。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="webclientbean">
<span id="restclientasyncbeandefinition"></span><h4><a class="toc-backref" href="#id83" role="doc-backlink"><span class="section-number">5.2.3.3.2. </span><code class="docutils literal notranslate"><span class="pre">WebClient</span></code>のbean定義</a><a class="headerlink" href="#webclientbean" title="Permalink to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">WebClient</span></code>のbean定義を行い、DIコンテナに登録する。</p>
<p><strong>Bean定義の実装例(WebClientConfig.java)</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Configuration</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">WebClientConfig</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Bean</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">WebClient</span><span class="w"> </span><span class="nf">defaultWebClient</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// (1)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">WebClient</span><span class="p">.</span><span class="na">builder</span><span class="p">().</span><span class="na">build</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">WebClient.Builder</span></code>を<code class="docutils literal notranslate"><span class="pre">build</span></code>することでWebClientを生成しBeanとして登録する。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">WebClient.Builder</span></code>はオプションを付けることでカスタマイズすることが可能である。</div>
<div class="line">設定できるオプションは以下の通り。</div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 30.0%" />
<col style="width: 70.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Configuration</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">uriBuilderFactory</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ベースURLとして使用するUriBuilderFactoryをカスタマイズ。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">defaultUriVariables</div>
</div>
</td>
<td><div class="line-block">
<div class="line">URIテンプレートを展開する際に使用するデフォルト値。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">defaultHeader</div>
</div>
</td>
<td><div class="line-block">
<div class="line">リクエストのHeader。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">defaultCookie</div>
</div>
</td>
<td><div class="line-block">
<div class="line">リクエストごとのCookie。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">defaultRequest</div>
</div>
</td>
<td><div class="line-block">
<div class="line">リクエストをカスタマイズ。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">filter</div>
</div>
</td>
<td><div class="line-block">
<div class="line">リクエスト時に使用されるFilter</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">exchangeStrategies</div>
</div>
</td>
<td><div class="line-block">
<div class="line">HTTP MessageのReader/Writerをカスタマイズ。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">clientConnector</div>
</div>
</td>
<td><div class="line-block">
<div class="line">HTTP Client ライブラリを設定。</div>
</div>
</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="restclientasyncimplementation">
<span id="id32"></span><h4><a class="toc-backref" href="#id84" role="doc-backlink"><span class="section-number">5.2.3.3.3. </span>非同期リクエストの実装</a><a class="headerlink" href="#restclientasyncimplementation" title="Permalink to this heading">¶</a></h4>
<p><strong>非同期リクエストの実装例</strong></p>
<p>フィールド宣言部</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="n">WecClient</span><span class="w"> </span><span class="n">webClient</span><span class="p">;</span>
</pre></div>
</div>
<p>メソッド内部</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">responseEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">webClient</span>
<span class="w">        </span><span class="p">.</span><span class="na">get</span><span class="p">()</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">        </span><span class="p">.</span><span class="na">uri</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">        </span><span class="p">.</span><span class="na">retrieve</span><span class="p">()</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">        </span><span class="p">.</span><span class="na">toEntity</span><span class="p">(</span><span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">        </span><span class="p">.</span><span class="na">doOnSuccess</span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">            </span><span class="c1">// omitted</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">        </span><span class="p">.</span><span class="na">doOnError</span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">            </span><span class="c1">// omitted</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">        </span><span class="p">.</span><span class="na">toFuture</span><span class="p">();</span><span class="w"> </span><span class="c1">// (4)</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">WebClient</span></code>の各メソッドを使用して、非同期リクエストを送信する。</div>
<div class="line">上記の実装例では、<code class="docutils literal notranslate"><span class="pre">uri</span></code>に対しGETメソッドでHTTPリクエストを送信している。</div>
<div class="line">使用できるメソッドについては<a class="reference external" href="https://docs.spring.io/spring-framework/docs/6.1.3/javadoc-api/org/springframework/web/reactive/function/client/WebClient.html#method-summary">WebClientのJavadoc</a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">処理結果の取得方法を定義する。</div>
<div class="line">この例では、<code class="docutils literal notranslate"><span class="pre">User.class</span></code>でレスポンスを受け取れるよう定義している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">成功のレスポンスが返ってきた場合の処理を<code class="docutils literal notranslate"><span class="pre">doOnSuccess</span></code>に実装する。</div>
<div class="line">エラーが発生した場合の処理を<code class="docutils literal notranslate"><span class="pre">doOnError</span></code>に実装する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">非同期処理の結果を<a class="reference external" href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/CompletableFuture.html">CompletableFuture</a>でラップした<code class="docutils literal notranslate"><span class="pre">ResponseEntity&lt;User&gt;</span></code>として受け取る。</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>WebClientの返却値について</strong></p>
<p>Reactive APIが使用する戻り値の型は、単数の場合は<a class="reference external" href="https://javadoc.io/static/io.projectreactor/reactor-core/3.6.2/reactor/core/publisher/Mono.html">reactor.core.publisher.Mono</a>、複数の場合は<a class="reference external" href="https://javadoc.io/static/io.projectreactor/reactor-core/3.6.2/reactor/core/publisher/Flux.html">reactor.core.publisher.Flux</a>が一般的に用いられるが、この例では<code class="docutils literal notranslate"><span class="pre">CompletableFuture</span></code>を返却するようにしている。</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><code class="docutils literal notranslate"><span class="pre">block()</span></code>を使用し、同期的に処理させることも可能である。その場合の戻り値の型は<code class="docutils literal notranslate"><span class="pre">ResponseEntity&lt;User&gt;</span></code>となる。</p>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="restclientasynccustomize">
<span id="id33"></span><h4><a class="toc-backref" href="#id85" role="doc-backlink"><span class="section-number">5.2.3.3.4. </span>カスタマイズ</a><a class="headerlink" href="#restclientasynccustomize" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">WebClient.Builder</span></code>をカスタマイズし、WebClientにデフォルトで設定する方法を説明する。</div>
<div class="line">ここでの説明はあくまで一例であるため、業務要件に合わせ適宜カスタマイズされたい。</div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="id34">
<h5><span class="section-number">5.2.3.3.4.1. </span>コネクションプールの設定<a class="headerlink" href="#id34" title="Permalink to this heading">¶</a></h5>
<div class="line-block">
<div class="line">コネクションプールの設定を行う方法を説明する。</div>
</div>
<p><strong>Bean定義の実装例(WebClientConfig.java)</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Configuration</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">WebClientConfig</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="c1">// omitted</span>

<span class="w">  </span><span class="nd">@Bean</span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">WebClient</span><span class="w"> </span><span class="nf">connectionWebClient</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">      </span><span class="c1">// @formatter:off</span>
<span class="w">      </span><span class="n">ConnectionProvider</span><span class="w"> </span><span class="n">connectionProvider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConnectionProvider</span><span class="p">.</span><span class="na">builder</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">connectionName</span><span class="p">)</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">              </span><span class="p">.</span><span class="na">maxConnections</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">maxConnections</span><span class="p">)</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">              </span><span class="p">.</span><span class="na">pendingAcquireMaxCount</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">pendingAcquireMaxCount</span><span class="p">)</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">              </span><span class="p">.</span><span class="na">pendingAcquireTimeout</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">pendingAcquireTimeout</span><span class="p">))</span><span class="w"> </span><span class="c1">// (4)</span>
<span class="w">              </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="w">      </span><span class="c1">// @formatter:on</span>

<span class="w">      </span><span class="n">HttpClient</span><span class="w"> </span><span class="n">httpClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HttpClient</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">connectionProvider</span><span class="p">);</span><span class="w"> </span><span class="c1">// (5)</span>

<span class="w">      </span><span class="n">ReactorClientHttpConnector</span><span class="w"> </span><span class="n">httpConnector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReactorClientHttpConnector</span><span class="p">(</span><span class="n">httpClient</span><span class="p">);</span><span class="w"> </span><span class="c1">// (6)</span>

<span class="w">      </span><span class="c1">// @formatter:off</span>
<span class="w">      </span><span class="n">WebClient</span><span class="w"> </span><span class="n">webClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WebClient</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">              </span><span class="p">.</span><span class="na">clientConnector</span><span class="p">(</span><span class="n">httpConnector</span><span class="p">)</span><span class="w"> </span><span class="c1">// (7)</span>
<span class="w">              </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="w">      </span><span class="c1">// @formatter:on</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">webClient</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">reactor.netty.resources.ConnectionProvider</span></code>のbuilderを作成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">builderにMaxコネクション数を設定する。</div>
<div class="line">設定しない場合は、デフォルト値<code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">*</span> <span class="pre">プロセッサ数</span></code>が使用される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">builderにMaxプール数を設定する。</div>
<div class="line">“<code class="docutils literal notranslate"><span class="pre">-1</span></code>“を設定した場合は無制限となる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">TimeoutException がスローされるまでの最大時間(ms)を設定する。</div>
<div class="line">設定しない場合は、デフォルト45秒が使用される。</div>
<div class="line">“<code class="docutils literal notranslate"><span class="pre">-1</span></code>“を設定した場合は無制限となる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">(1)~(4)で生成した<code class="docutils literal notranslate"><span class="pre">reactor.netty.resources.ConnectionProvider</span></code>を設定した<code class="docutils literal notranslate"><span class="pre">reactor.netty.http.client.HttpClient</span></code>を生成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">(5)で定義した<code class="docutils literal notranslate"><span class="pre">HttpClient</span></code>を設定した<code class="docutils literal notranslate"><span class="pre">org.springframework.http.client.reactive.ReactorClientHttpConnector</span></code>のbeanを登録する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">(6)で定義した<code class="docutils literal notranslate"><span class="pre">ReactorClientHttpConnector</span></code>を設定した<code class="docutils literal notranslate"><span class="pre">WebClient</span></code>のbeanを登録する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id35">
<h5><span class="section-number">5.2.3.3.4.2. </span>フィルターの設定<a class="headerlink" href="#id35" title="Permalink to this heading">¶</a></h5>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.web.reactive.function.client.ExchangeFilterFunction</span></code>を実装することで、サーバとの通信処理前に任意の処理を実行させることができる。</div>
<div class="line">ここでは単純な例として、通信前のロギング処理の実装例を紹介する。なお、サーバとの通信処理後に任意の処理を実施したい場合は、<code class="docutils literal notranslate"><span class="pre">doOnSuccess</span></code>に実装すればよい。</div>
</div>
<p><strong>通信ログ出力の実装例</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.webclient</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">org.slf4j.Logger</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.slf4j.LoggerFactory</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.reactive.function.client.ClientRequest</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.reactive.function.client.ClientResponse</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.reactive.function.client.ExchangeFilterFunction</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.reactive.function.client.ExchangeFunction</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">reactor.core.publisher.Mono</span><span class="p">;</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">WebClientExchangeFilterFunction</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ExchangeFilterFunction</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (1)</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Logger</span><span class="w"> </span><span class="n">LOGGER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LoggerFactory</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span>
<span class="w">            </span><span class="n">WebClientExchangeFilterFunction</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Mono</span><span class="o">&lt;</span><span class="n">ClientResponse</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">ClientRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span>
<span class="w">            </span><span class="n">ExchangeFunction</span><span class="w"> </span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;External Request to {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">url</span><span class="p">());</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">next</span><span class="p">.</span><span class="na">exchange</span><span class="p">(</span><span class="n">request</span><span class="p">);</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ExchangeFilterFunction</span></code>インタフェースを実装する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">非同期リクエストを送信する前に実行する処理を実装する。</div>
<div class="line">上記の実装例では、通信先のURLを出力している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">次の<code class="docutils literal notranslate"><span class="pre">ExchangeFilterFunction</span></code>を呼び出す。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>Bean定義の実装例(WebClientConfig.java)</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Configuration</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">WebClientConfig</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Bean</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">WebClient</span><span class="w"> </span><span class="nf">loggingWebClient</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="c1">// @formatter:off</span>
<span class="w">        </span><span class="n">WebClient</span><span class="w"> </span><span class="n">webClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WebClient</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">LoggingExchangeFilterFunction</span><span class="p">())</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// @formatter:on</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">webClient</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ExchangeFilterFunction</span></code>の実装クラスをfilterに登録する。</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>複数のFilterを登録したい場合は、<code class="docutils literal notranslate"><span class="pre">filters</span></code>を使用してFilterを登録する。</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">WebClient</span><span class="w"> </span><span class="n">webClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WebClient</span><span class="p">.</span><span class="na">builder</span><span class="p">().</span><span class="na">filters</span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">f</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FirstExchangeFilterFunction</span><span class="p">());</span>
<span class="w">    </span><span class="n">f</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecondExchangeFilterFunction</span><span class="p">());</span>
<span class="w">    </span><span class="n">f</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ThirdExchangeFilterFunction</span><span class="p">());</span>
<span class="p">}).</span><span class="na">build</span><span class="p">();</span>
</pre></div>
</div>
</div></blockquote>
<p>リストに登録された順番に処理されるようになる。</p>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
</section>
</section>
<section id="appendix">
<span id="restclientappendix"></span><h2><a class="toc-backref" href="#id86" role="doc-backlink"><span class="section-number">5.2.4. </span>Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this heading">¶</a></h2>
<section id="http-proxy">
<span id="restclientproxysettings"></span><h3><a class="toc-backref" href="#id87" role="doc-backlink"><span class="section-number">5.2.4.1. </span>HTTP Proxyサーバの設定方法</a><a class="headerlink" href="#http-proxy" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">サーバへアクセスする際にHTTP Proxyサーバを経由する必要がある場合は、システムプロパティやJVM起動引数、または<code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>のBean定義にてHTTP Proxyサーバの設定が必要となる。</div>
<div class="line">システムプロパティやJVM起動引数に設定した場合、アプリケーション全体に影響を与えてしまうため、<code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>毎にHTTP Proxyサーバの設定を行う例を紹介する。</div>
</div>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>毎のHTTP Proxyサーバの設定は、<code class="docutils literal notranslate"><span class="pre">ClientHttpRequestFactory</span></code>インタフェースのデフォルト実装である<code class="docutils literal notranslate"><span class="pre">SimpleClientHttpRequestFactory</span></code>に付与することが可能である。ただし、<code class="docutils literal notranslate"><span class="pre">SimpleClientHttpRequestFactory</span></code>では資格情報を設定することはできないため、Proxy認証を行う場合は<code class="docutils literal notranslate"><span class="pre">HttpComponentsClientHttpRequestFactory</span></code>を使用する。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">HttpComponentsClientHttpRequestFactory</span></code>は、<code class="docutils literal notranslate"><span class="pre">Apache</span> <span class="pre">HttpComponents</span> <span class="pre">HttpClient</span></code>を用いてリクエストを生成する<code class="docutils literal notranslate"><span class="pre">ClientHttpRequestFactory</span></code>インタフェースの実装クラスである。</div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="simpleclienthttprequestfactoryhttp-proxy">
<h4><a class="toc-backref" href="#id88" role="doc-backlink"><span class="section-number">5.2.4.1.1. </span>SimpleClientHttpRequestFactoryを使用したHTTP Proxyサーバの設定方法</a><a class="headerlink" href="#simpleclienthttprequestfactoryhttp-proxy" title="Permalink to this heading">¶</a></h4>
<p>資格情報が不要なHTTP Proxyサーバの接続先の指定については、<code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>がデフォルトで使用する<code class="docutils literal notranslate"><span class="pre">SimpleClientHttpRequestFactory</span></code>で指定することが可能である。</p>
<p><strong>Bean定義ファイル</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-10-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-10-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-10-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-10-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-10-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-10-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// (2)</span>
<span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${rscl.http.proxyHost}&quot;</span><span class="p">)</span>
<span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">httpProxyHost</span><span class="p">;</span>

<span class="c1">// (3)</span>
<span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${rscl.http.proxyPort}&quot;</span><span class="p">)</span>
<span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">httpProxyPort</span><span class="p">;</span>

<span class="c1">// (1)</span>
<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;inetSocketAddress&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">InetSocketAddress</span><span class="w"> </span><span class="nf">inetSocketAddress</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InetSocketAddress</span><span class="p">(</span><span class="n">httpProxyHost</span><span class="p">,</span><span class="w"> </span><span class="n">httpProxyPort</span><span class="p">);</span><span class="w"> </span><span class="c1">// (2)(3)</span>
<span class="p">}</span>

<span class="c1">// (4)</span>
<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;simpleClientRestTemplate&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">RestTemplate</span><span class="w"> </span><span class="nf">simpleClientRestTemplate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RestTemplate</span><span class="p">(</span><span class="n">simpleClientHttpRequestFactory</span><span class="p">());</span><span class="w"> </span><span class="c1">// (5)</span>
<span class="p">}</span>

<span class="c1">// (5)</span>
<span class="nd">@Bean</span>
<span class="kd">public</span><span class="w"> </span><span class="n">SimpleClientHttpRequestFactory</span><span class="w"> </span><span class="nf">simpleClientHttpRequestFactory</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">SimpleClientHttpRequestFactory</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SimpleClientHttpRequestFactory</span><span class="p">();</span>
<span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">setProxy</span><span class="p">(</span><span class="n">proxy</span><span class="p">());</span><span class="w"> </span><span class="c1">// (6)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// (6)</span>
<span class="nd">@Bean</span>
<span class="kd">public</span><span class="w"> </span><span class="n">Proxy</span><span class="w"> </span><span class="nf">proxy</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Proxy</span><span class="p">(</span><span class="n">Proxy</span><span class="p">.</span><span class="na">Type</span><span class="p">.</span><span class="na">HTTP</span><span class="p">,</span><span class="w"> </span><span class="n">inetSocketAddress</span><span class="p">());</span><span class="w"> </span><span class="c1">// (7)</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">java.net.InetSocketAddress</span></code>にHTTP Proxyサーバの設定を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">InetSocketAddress</span></code>のコンストラクタ引数の<code class="docutils literal notranslate"><span class="pre">hostname</span></code>に、プロパティファイルに設定されたキー<code class="docutils literal notranslate"><span class="pre">rscl.http.proxyHost</span></code>の値をHTTP Proxyサーバのホスト名として設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">InetSocketAddress</span></code>のコンストラクタ引数の<code class="docutils literal notranslate"><span class="pre">port</span></code>に、プロパティファイルに設定されたキー<code class="docutils literal notranslate"><span class="pre">rscl.http.proxyPort</span></code>の値をHTTP Proxyサーバのポート番号として設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>のBean定義を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>のコンストラクタの引数に、<code class="docutils literal notranslate"><span class="pre">SimpleClientHttpRequestFactory</span></code>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">SimpleClientHttpRequestFactory</span></code>の<code class="docutils literal notranslate"><span class="pre">proxy</span></code>プロパティに<code class="docutils literal notranslate"><span class="pre">java.net.Proxy</span></code>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">Proxy</span></code>のコンストラクタの引数に、<code class="docutils literal notranslate"><span class="pre">java.net.Proxy.Type.HTTP</span></code>と生成した<code class="docutils literal notranslate"><span class="pre">InetSocketAddress</span></code>を設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div><div aria-labelledby="tab-10-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-10-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;inetSocketAddress&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;java.net.InetSocketAddress&quot;</span><span class="w"> </span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;hostname&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${rscl.http.proxyHost}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w">    </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;port&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${rscl.http.proxyPort}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w">    </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="cm">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;simpleClientRestTemplate&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.web.client.RestTemplate&quot;</span><span class="w"> </span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;constructor-arg&gt;</span>
<span class="w">        </span><span class="cm">&lt;!-- (5) --&gt;</span>
<span class="w">        </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.http.client.SimpleClientHttpRequestFactory&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="cm">&lt;!-- (6) --&gt;</span>
<span class="w">            </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;proxy&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;java.net.Proxy&quot;</span><span class="w"> </span><span class="nt">&gt;</span>
<span class="w">                    </span><span class="cm">&lt;!-- (7) --&gt;</span>
<span class="w">                    </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;type&quot;</span><span class="nt">&gt;</span>
<span class="w">                        </span><span class="nt">&lt;util:constant</span><span class="w"> </span><span class="na">static-field=</span><span class="s">&quot;java.net.Proxy.Type.HTTP&quot;</span><span class="nt">/&gt;</span>
<span class="w">                    </span><span class="nt">&lt;/constructor-arg&gt;</span>
<span class="w">                    </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;sa&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;inetSocketAddress&quot;</span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;/bean&gt;</span>
<span class="w">            </span><span class="nt">&lt;/property&gt;</span>
<span class="w">        </span><span class="nt">&lt;/bean&gt;</span>
<span class="w">    </span><span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">java.net.InetSocketAddress</span></code>にHTTP Proxyサーバの設定を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">InetSocketAddress</span></code>のコンストラクタ引数の<code class="docutils literal notranslate"><span class="pre">hostname</span></code>に、プロパティファイルに設定されたキー<code class="docutils literal notranslate"><span class="pre">rscl.http.proxyHost</span></code>の値をHTTP Proxyサーバのホスト名として設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">InetSocketAddress</span></code>のコンストラクタ引数の<code class="docutils literal notranslate"><span class="pre">port</span></code>に、プロパティファイルに設定されたキー<code class="docutils literal notranslate"><span class="pre">rscl.http.proxyPort</span></code>の値をHTTP Proxyサーバのポート番号として設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>のBean定義を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>のコンストラクタの引数に、<code class="docutils literal notranslate"><span class="pre">SimpleClientHttpRequestFactory</span></code>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">SimpleClientHttpRequestFactory</span></code>の<code class="docutils literal notranslate"><span class="pre">proxy</span></code>プロパティに<code class="docutils literal notranslate"><span class="pre">java.net.Proxy</span></code>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">Proxy</span></code>のコンストラクタの引数に、<code class="docutils literal notranslate"><span class="pre">java.net.Proxy.Type.HTTP</span></code>と生成した<code class="docutils literal notranslate"><span class="pre">InetSocketAddress</span></code>を設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="httpcomponentsclienthttprequestfactoryhttp-proxy">
<h4><a class="toc-backref" href="#id89" role="doc-backlink"><span class="section-number">5.2.4.1.2. </span>HttpComponentsClientHttpRequestFactoryを使用したHTTP Proxyサーバの設定方法</a><a class="headerlink" href="#httpcomponentsclienthttprequestfactoryhttp-proxy" title="Permalink to this heading">¶</a></h4>
<section id="restclienthttpproxcy">
<span id="id36"></span><h5><span class="section-number">5.2.4.1.2.1. </span>HTTP Proxyサーバの指定方法<a class="headerlink" href="#restclienthttpproxcy" title="Permalink to this heading">¶</a></h5>
<p>資格情報が必要なHTTP Proxyサーバの接続先の指定は、<code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>に対して、<code class="docutils literal notranslate"><span class="pre">HttpComponentsClientHttpRequestFactory</span></code>を使用し指定する。</p>
<p><strong>pom.xml</strong></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
<span class="w">    </span><span class="nt">&lt;groupId&gt;</span>org.apache.httpcomponents.client5<span class="nt">&lt;/groupId&gt;</span>
<span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>httpclient5<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">HttpComponentsClientHttpRequestFactory</span></code>内で使用する<code class="docutils literal notranslate"><span class="pre">Apache</span> <span class="pre">HTTP</span> <span class="pre">Client</span></code>を使用するために、<code class="docutils literal notranslate"><span class="pre">Apache</span> <span class="pre">HttpComponents</span> <span class="pre">Client</span></code>を<code class="file docutils literal notranslate"><span class="pre">pom.xml</span></code>の依存ライブラリに追加する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>上記設定例は、依存ライブラリのバージョンを親プロジェクトである terasoluna-gfw-parent で管理する前提であるため、pom.xmlでのバージョンの指定は不要である。</p>
<p>上記の依存ライブラリはterasoluna-gfw-parentが依存している<a class="reference external" href="https://docs.spring.io/spring-boot/docs/3.2.2/reference/htmlsingle/#dependency-versions">Spring Boot</a>で管理されている。</p>
</div>
<p><strong>Bean定義ファイル</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-11-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-11-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-11-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-11-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-11-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-11-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;proxyHttpClientBuilder&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">HttpClientBuilder</span><span class="w"> </span><span class="nf">proxyHttpClientBuilder</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">HttpClientBuilder</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HttpClientBuilder</span><span class="p">.</span><span class="na">create</span><span class="p">();</span>
<span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">setProxy</span><span class="p">(</span><span class="n">httpHost</span><span class="p">());</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// (2)</span>
<span class="nd">@Bean</span>
<span class="kd">public</span><span class="w"> </span><span class="n">HttpHost</span><span class="w"> </span><span class="nf">httpHost</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HttpHost</span><span class="p">(</span><span class="n">httpProxyHost</span><span class="p">,</span><span class="w"> </span><span class="n">httpProxyPort</span><span class="p">);</span><span class="w"> </span><span class="c1">// (3) (4)</span>
<span class="p">}</span>

<span class="c1">// (5)</span>
<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;proxyRestTemplate&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">RestTemplate</span><span class="w"> </span><span class="nf">proxyRestTemplate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RestTemplate</span><span class="p">(</span><span class="n">httpComponentsClientHttpRequestFactory</span><span class="p">());</span><span class="w"> </span><span class="c1">// (6)</span>
<span class="p">}</span>

<span class="c1">// (6)</span>
<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;httpComponentsClientHttpRequestFactory&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">HttpComponentsClientHttpRequestFactory</span><span class="w"> </span><span class="nf">httpComponentsClientHttpRequestFactory</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HttpComponentsClientHttpRequestFactory</span><span class="p">(</span><span class="n">proxyHttpClientBuilder</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">());</span><span class="w"> </span><span class="c1">// (7)</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.apache.hc.client5.http.impl.classic.HttpClientBuilder</span></code>を使用し、<code class="docutils literal notranslate"><span class="pre">org.apache.http.client5.HttpClient</span></code>の設定を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">HttpClientBuilder</span></code>の<code class="docutils literal notranslate"><span class="pre">proxy</span></code>プロパティに、HTTP Proxyサーバの設定を行った<code class="docutils literal notranslate"><span class="pre">org.apache.http.HttpHost</span></code>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">HttpHost</span></code>のコンストラクタ引数の<code class="docutils literal notranslate"><span class="pre">hostname</span></code>に、プロパティファイルに設定されたキー<code class="docutils literal notranslate"><span class="pre">rscl.http.proxyHost</span></code>の値をHTTP Proxyサーバのホスト名として設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">HttpHost</span></code>のコンストラクタ引数の<code class="docutils literal notranslate"><span class="pre">port</span></code>に、プロパティファイルに設定されたキー<code class="docutils literal notranslate"><span class="pre">rscl.http.proxyPort</span></code>の値をHTTP Proxyサーバのポート番号として設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>のBean定義を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>のコンストラクタの引数に、<code class="docutils literal notranslate"><span class="pre">HttpComponentsClientHttpRequestFactory</span></code>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">HttpComponentsClientHttpRequestFactory</span></code>のコンストラクタの引数に、<code class="docutils literal notranslate"><span class="pre">HttpClientBuilder</span></code>から生成した<code class="docutils literal notranslate"><span class="pre">HttpClient</span></code>を設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div><div aria-labelledby="tab-11-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-11-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;proxyHttpClientBuilder&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.apache.hc.client5.http.impl.classic.HttpClientBuilder&quot;</span><span class="w"> </span><span class="na">factory-method=</span><span class="s">&quot;create&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;proxy&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.apache.hc.core5.http.HttpHost&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="w">            </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;java.lang.String&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;hostname&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${rscl.http.proxyHost}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="cm">&lt;!-- (4) --&gt;</span>
<span class="w">            </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;int&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;port&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${rscl.http.proxyPort}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/bean&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="cm">&lt;!-- (5) --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;proxyRestTemplate&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.web.client.RestTemplate&quot;</span><span class="w"> </span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;constructor-arg&gt;</span>
<span class="w">        </span><span class="cm">&lt;!-- (6) --&gt;</span>
<span class="w">        </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.http.client.HttpComponentsClientHttpRequestFactory&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="cm">&lt;!-- (7) --&gt;</span>
<span class="w">            </span><span class="nt">&lt;constructor-arg&gt;</span>
<span class="w">                </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">factory-bean=</span><span class="s">&quot;proxyHttpClientBuilder&quot;</span><span class="w"> </span><span class="na">factory-method=</span><span class="s">&quot;build&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;/constructor-arg&gt;</span>
<span class="w">        </span><span class="nt">&lt;/bean&gt;</span>
<span class="w">    </span><span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.apache.hc.client5.http.impl.classic.HttpClientBuilder</span></code>を使用し、<code class="docutils literal notranslate"><span class="pre">org.apache.http.client5.HttpClient</span></code>の設定を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">HttpClientBuilder</span></code>の<code class="docutils literal notranslate"><span class="pre">proxy</span></code>プロパティに、HTTP Proxyサーバの設定を行った<code class="docutils literal notranslate"><span class="pre">org.apache.http.HttpHost</span></code>を設定する。</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>オーバーロードされている場合に誤ったコンストラクタが使用されることがある</strong></p>
<blockquote>
<div></div></blockquote>
<p>当実装例は、本来であれば以下の様に記述することが可能である。</p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.apache.hc.core5.http.HttpHost&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;hostname&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${rscl.http.proxyHost}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;port&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${rscl.http.proxyPort}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
</div></blockquote>
<p>ただし、<a class="reference external" href="https://github.com/spring-projects/spring-framework/issues/31871">Spring#31871</a>で報告されているように、コンストラクタがオーバーロードされている場合に想定とは異なるコンストラクタが使用されてしまう可能性がある。</p>
<p>そのためtype属性を設定し、明示的に使用するコンストラクタを決定している。</p>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">HttpHost</span></code>のコンストラクタ引数の<code class="docutils literal notranslate"><span class="pre">hostname</span></code>に、プロパティファイルに設定されたキー<code class="docutils literal notranslate"><span class="pre">rscl.http.proxyHost</span></code>の値をHTTP Proxyサーバのホスト名として設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">HttpHost</span></code>のコンストラクタ引数の<code class="docutils literal notranslate"><span class="pre">port</span></code>に、プロパティファイルに設定されたキー<code class="docutils literal notranslate"><span class="pre">rscl.http.proxyPort</span></code>の値をHTTP Proxyサーバのポート番号として設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>のBean定義を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RestTemplate</span></code>のコンストラクタの引数に、<code class="docutils literal notranslate"><span class="pre">HttpComponentsClientHttpRequestFactory</span></code>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">HttpComponentsClientHttpRequestFactory</span></code>のコンストラクタの引数に、<code class="docutils literal notranslate"><span class="pre">HttpClientBuilder</span></code>から生成した<code class="docutils literal notranslate"><span class="pre">HttpClient</span></code>を設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id38">
<h5><span class="section-number">5.2.4.1.2.2. </span>HTTP Proxyサーバの資格情報の指定方法<a class="headerlink" href="#id38" title="Permalink to this heading">¶</a></h5>
<p>HTTP Proxyサーバにアクセスする際に資格情報(ユーザ名とパスワード)が必要な場合は、<code class="docutils literal notranslate"><span class="pre">org.apache.http.impl.client.BasicCredentialsProvider</span></code>を使用し資格情報を設定する。</p>
<p><code class="docutils literal notranslate"><span class="pre">BasicCredentialsProvider</span></code>の<code class="docutils literal notranslate"><span class="pre">setCredentials</span></code>メソッドが引数を2つ取るため、セッターインジェクションを利用してBeanを生成することができない。このため、<code class="docutils literal notranslate"><span class="pre">org.springframework.beans.factory.FactoryBean</span></code>を利用してBeanを生成する。</p>
<p><strong>FactoryBeanクラス</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.hc.client5.http.auth.AuthScope</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.hc.client5.http.auth.UsernamePasswordCredentials</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.hc.client5.http.impl.auth.BasicCredentialsProvider</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.beans.factory.FactoryBean</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="p">;</span>

<span class="c1">// (1)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">BasicCredentialsProviderFactoryBean</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">FactoryBean</span><span class="o">&lt;</span><span class="n">BasicCredentialsProvider</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${rscl.http.proxyHost}&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">host</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// (3)</span>
<span class="w">    </span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${rscl.http.proxyPort}&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// (4)</span>
<span class="w">    </span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${rscl.http.proxyUserName}&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">userName</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// (5)</span>
<span class="w">    </span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${rscl.http.proxyPassword}&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">BasicCredentialsProvider</span><span class="w"> </span><span class="nf">getObject</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="c1">// (6)</span>
<span class="w">        </span><span class="n">AuthScope</span><span class="w"> </span><span class="n">authScope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AuthScope</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">host</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">port</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// (7)</span>
<span class="w">        </span><span class="kt">char</span><span class="o">[]</span><span class="w"> </span><span class="n">passwordCharArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">password</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span>
<span class="w">                </span><span class="p">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">password</span><span class="p">.</span><span class="na">toCharArray</span><span class="p">();</span>
<span class="w">        </span><span class="n">UsernamePasswordCredentials</span><span class="w"> </span><span class="n">usernamePasswordCredentials</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UsernamePasswordCredentials</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">userName</span><span class="p">,</span><span class="w"> </span><span class="n">passwordCharArray</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// (8)</span>
<span class="w">        </span><span class="n">BasicCredentialsProvider</span><span class="w"> </span><span class="n">credentialsProvider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BasicCredentialsProvider</span><span class="p">();</span>

<span class="w">        </span><span class="n">credentialsProvider</span><span class="p">.</span><span class="na">setCredentials</span><span class="p">(</span><span class="n">authScope</span><span class="p">,</span>
<span class="w">                </span><span class="n">usernamePasswordCredentials</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">credentialsProvider</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">getObjectType</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">BasicCredentialsProvider</span><span class="p">.</span><span class="na">class</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isSingleton</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.beans.factory.FactoryBean</span></code>を実装した<code class="docutils literal notranslate"><span class="pre">BasicCredentialsProviderFactoryBean</span></code>クラスを定義する。</div>
<div class="line">Beanの型に<code class="docutils literal notranslate"><span class="pre">BasicCredentialsProvider</span></code>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">プロパティファイルに設定されたキー<code class="docutils literal notranslate"><span class="pre">rscl.http.proxyHost</span></code>の値をHTTP Proxyサーバのホスト名として、インスタンス変数に設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">プロパティファイルに設定されたキー<code class="docutils literal notranslate"><span class="pre">rscl.http.proxyPort</span></code>の値をHTTP Proxyサーバのポート番号として、インスタンス変数に設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">プロパティファイルに設定されたキー<code class="docutils literal notranslate"><span class="pre">rscl.http.proxyUserName</span></code>の値をHTTP Proxyサーバのユーザ名として、インスタンス変数に設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">プロパティファイルに設定されたキー<code class="docutils literal notranslate"><span class="pre">rscl.http.proxyPassword</span></code>の値をHTTP Proxyサーバのパスワードとして、インスタンス変数に設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.apache.http.auth.AuthScope</span></code> を作成し資格情報のスコープを設定する。この例は、HTTP Proxyサーバのホスト名とポート番号を指定したものである。その他の設定方法については、<a class="reference external" href="https://hc.apache.org/httpcomponents-client-5.2.x/current/httpclient5/apidocs/">AuthScope (Apache HttpClient API)</a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.apache.http.auth.UsernamePasswordCredentials</span></code>を作成し資格情報を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.apache.http.impl.client.BasicCredentialsProvider</span></code>を作成し、<code class="docutils literal notranslate"><span class="pre">setCredentials</span></code>メソッドを使用し、資格情報のスコープと資格情報を設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>Bean定義ファイル</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-12-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-12-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-12-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-12-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-12-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-12-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;proxyHttpClientBuilder&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">HttpClientBuilder</span><span class="w"> </span><span class="nf">proxyAuthHttpClientBuilder</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">HttpClientBuilder</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HttpClientBuilder</span><span class="p">.</span><span class="na">create</span><span class="p">();</span>
<span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">setDefaultCredentialsProvider</span><span class="p">(</span><span class="n">basicCredentialsProviderFactoryBean</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">getObject</span><span class="p">());</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">setProxy</span><span class="p">(</span><span class="n">httpHost</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// (1)</span>
<span class="nd">@Bean</span>
<span class="kd">public</span><span class="w"> </span><span class="n">BasicCredentialsProviderFactoryBean</span><span class="w"> </span><span class="nf">basicCredentialsProviderFactoryBean</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BasicCredentialsProviderFactoryBean</span><span class="p">();</span>
<span class="p">}</span>

<span class="nd">@Bean</span>
<span class="kd">public</span><span class="w"> </span><span class="n">HttpHost</span><span class="w"> </span><span class="nf">httpHost</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HttpHost</span><span class="p">(</span><span class="n">httpProxyHost</span><span class="p">,</span><span class="w"> </span><span class="n">httpProxyPort</span><span class="p">);</span>
<span class="p">}</span>

<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;proxyRestTemplate&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">RestTemplate</span><span class="w"> </span><span class="nf">proxyRestTemplate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RestTemplate</span><span class="p">(</span><span class="n">httpComponentsClientHttpRequestFactory</span><span class="p">());</span>
<span class="p">}</span>

<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;httpComponentsClientHttpRequestFactory&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">HttpComponentsClientHttpRequestFactory</span><span class="w"> </span><span class="nf">httpComponentsClientHttpRequestFactory</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HttpComponentsClientHttpRequestFactory</span><span class="p">(</span><span class="n">proxyHttpClientBuilder</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">());</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">HttpClientBuilder</span></code>の<code class="docutils literal notranslate"><span class="pre">defaultCredentialsProvider</span></code>プロパティに、<code class="docutils literal notranslate"><span class="pre">BasicCredentialsProvider</span></code>を設定する。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">BasicCredentialsProvider</span></code>は、<code class="docutils literal notranslate"><span class="pre">FactoryBean</span></code>を実装した<code class="docutils literal notranslate"><span class="pre">BasicCredentialsProviderFactoryBean</span></code>を使用しBeanを作成する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div><div aria-labelledby="tab-12-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-12-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;proxyHttpClientBuilder&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.apache.hc.client5.http.impl.classic.HttpClientBuilder&quot;</span><span class="w"> </span><span class="na">factory-method=</span><span class="s">&quot;create&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;defaultCredentialsProvider&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;com.example.restclient.BasicCredentialsProviderFactoryBean&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;proxy&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;proxyHost&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.apache.hc.core5.http.HttpHost&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;hostname&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${rscl.http.proxyHost}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;port&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${rscl.http.proxyPort}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/bean&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;proxyRestTemplate&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.web.client.RestTemplate&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;constructor-arg&gt;</span>
<span class="w">        </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.http.client.HttpComponentsClientHttpRequestFactory&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;constructor-arg&gt;</span>
<span class="w">                </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">factory-bean=</span><span class="s">&quot;proxyHttpClientBuilder&quot;</span><span class="w"> </span><span class="na">factory-method=</span><span class="s">&quot;build&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;/constructor-arg&gt;</span>
<span class="w">        </span><span class="nt">&lt;/bean&gt;</span>
<span class="w">    </span><span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">HttpClientBuilder</span></code>の<code class="docutils literal notranslate"><span class="pre">defaultCredentialsProvider</span></code>プロパティに、<code class="docutils literal notranslate"><span class="pre">BasicCredentialsProvider</span></code>を設定する。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">BasicCredentialsProvider</span></code>は、<code class="docutils literal notranslate"><span class="pre">FactoryBean</span></code>を実装した<code class="docutils literal notranslate"><span class="pre">BasicCredentialsProviderFactoryBean</span></code>を使用しBeanを作成する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></div>
</section>
</section>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../DataAccessDetail/index.html" title="6. データアクセス"
             >next</a> |</li>
        <li class="right" >
          <a href="REST.html" title="5.1. RESTful Web Service"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.9.0.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" ><span class="section-number">5. </span>Web Service</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">5.2. </span>RESTクライアント（HTTPクライアント）</a></li> 
      </ul>
    </div>
    <div class="footer">
      © Copyright 2024, NTT DATA Group Corporation. © Copyright 2013, NTT Corporation.
      Created using <a href="https://www.sphinx-doc.org/en/master/">Sphinx</a> 7.0.1.Theme is <a href="https://pypi.org/project/solar-theme/">Solar</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    </script>
  </body>
</html>
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>9.3. 認可 &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.9.0.RELEASE documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/solar.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/tabs.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="9.4. セッション管理" href="SessionManagement.html" />
    <link rel="prev" title="9.2. 認証" href="Authentication.html" /><script src="../_static/jquery.js" type="text/javascript"></script>
<script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="SessionManagement.html" title="9.4. セッション管理"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Authentication.html" title="9.2. 認証"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.9.0.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U"><span class="section-number">9. </span>セキュリティ対策</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">9.3. </span>認可</a></li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox"> scroll sidebar</label>
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">9.3. 認可</a><ul>
<li><a class="reference internal" href="#overview">9.3.1. Overview</a><ul>
<li><a class="reference internal" href="#id4">9.3.1.1. 認可処理のアーキテクチャ</a><ul>
<li><a class="reference internal" href="#exceptiontranslationfilter">9.3.1.1.1. ExceptionTranslationFilter</a></li>
<li><a class="reference internal" href="#authorizationfilter">9.3.1.1.2. AuthorizationFilter</a></li>
<li><a class="reference internal" href="#authorizationmanager">9.3.1.1.3. AuthorizationManager</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">9.3.2. How to use</a><ul>
<li><a class="reference internal" href="#springsecurityauthorizationpolicy">9.3.2.1. アクセスポリシーの記述方法</a><ul>
<li><a class="reference internal" href="#id6">9.3.2.1.1. 代表的な認可メソッド</a></li>
<li><a class="reference internal" href="#built-incommon-expressions">9.3.2.1.2. Built-InのCommon Expressions</a></li>
<li><a class="reference internal" href="#built-inweb-expressions">9.3.2.1.3. Built-InのWeb Expressions</a></li>
<li><a class="reference internal" href="#id8">9.3.2.1.4. 演算子の使用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#web">9.3.2.2. Webリソースへの認可</a><ul>
<li><a class="reference internal" href="#id9">9.3.2.2.1. 認可処理の適用</a></li>
<li><a class="reference internal" href="#access-policy-designate-web-resource">9.3.2.2.2. アクセスポリシーの定義</a><ul>
<li><a class="reference internal" href="#id11">9.3.2.2.2.1. アクセスポリシーを適用するWebリソースの指定</a></li>
<li><a class="reference internal" href="#id12">9.3.2.2.2.2. アクセスポリシーの設定例</a></li>
<li><a class="reference internal" href="#id13">9.3.2.2.2.3. パス変数の参照</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#authorizationtomethod">9.3.2.3. メソッドへの認可</a><ul>
<li><a class="reference internal" href="#aop">9.3.2.3.1. AOPの有効化</a></li>
<li><a class="reference internal" href="#id16">9.3.2.3.2. 認可処理の適用</a></li>
<li><a class="reference internal" href="#id17">9.3.2.3.3. アクセスポリシーの定義</a><ul>
<li><a class="reference internal" href="#id18">9.3.2.3.3.1. メソッド実行前に適用するアクセスポリシーの指定</a></li>
<li><a class="reference internal" href="#id19">9.3.2.3.3.2. メソッド実行後に適用するアクセスポリシーの指定</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id20">9.3.2.4. 画面項目への認可</a><ul>
<li><a class="reference internal" href="#id21">9.3.2.4.1. アクセスポリシーの定義</a></li>
<li><a class="reference internal" href="#id22">9.3.2.4.2. Webリソースに指定したアクセスポリシーとの連動</a></li>
<li><a class="reference internal" href="#id23">9.3.2.4.3. 認可処理の判定結果を変数に格納</a></li>
</ul>
</li>
<li><a class="reference internal" href="#authorizationerrorresponse">9.3.2.5. 認可エラー時のレスポンス</a><ul>
<li><a class="reference internal" href="#accessdeniedhandler">9.3.2.5.1. AccessDeniedHandler</a></li>
<li><a class="reference internal" href="#authenticationentrypoint">9.3.2.5.2. AuthenticationEntryPoint</a></li>
<li><a class="reference internal" href="#springsecurityauthorizationonerror">9.3.2.5.3. 認可エラー時の遷移先</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend">9.3.3. How to extend</a><ul>
<li><a class="reference internal" href="#id26">9.3.3.1. 認可エラー時のレスポンス (認証済みユーザー編)</a><ul>
<li><a class="reference internal" href="#springsecurityauthorizationaccessdeniedhandler">9.3.3.1.1. AccessDeniedHandlerの適用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id28">9.3.3.2. 認可エラー時のレスポンス (未認証ユーザー編)</a><ul>
<li><a class="reference internal" href="#id29">9.3.3.2.1. リクエスト毎にAuthenticationEntryPointを適用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id30">9.3.3.3. ロールの階層化</a><ul>
<li><a class="reference internal" href="#id31">9.3.3.3.1. 階層関係の設定</a></li>
<li><a class="reference internal" href="#id32">9.3.3.3.2. Webリソースの認可処理への適用</a></li>
<li><a class="reference internal" href="#id33">9.3.3.3.3. メソッドの認可処理への適用</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix">9.3.4. Appendix</a><ul>
<li><a class="reference internal" href="#spring-security">9.3.4.1. Spring Securityのパスパターンマッチングにおける拡張子および末尾<code class="docutils literal notranslate"><span class="pre">/</span></code>の考慮</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="Authentication.html"
                          title="previous chapter"><span class="section-number">9.2. </span>認証</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="SessionManagement.html"
                          title="next chapter"><span class="section-number">9.4. </span>セッション管理</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/Security/Authorization.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="springsecurityauthorization">
<span id="id1"></span><h1><span class="section-number">9.3. </span>認可<a class="headerlink" href="#springsecurityauthorization" title="Permalink to this heading">¶</a></h1>
<nav class="contents local" id="id2">
<p class="topic-title">目次</p>
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id46">Overview</a></p>
<ul>
<li><p><a class="reference internal" href="#id4" id="id47">認可処理のアーキテクチャ</a></p>
<ul>
<li><p><a class="reference internal" href="#exceptiontranslationfilter" id="id48">ExceptionTranslationFilter</a></p></li>
<li><p><a class="reference internal" href="#authorizationfilter" id="id49">AuthorizationFilter</a></p></li>
<li><p><a class="reference internal" href="#authorizationmanager" id="id50">AuthorizationManager</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#how-to-use" id="id51">How to use</a></p>
<ul>
<li><p><a class="reference internal" href="#springsecurityauthorizationpolicy" id="id52">アクセスポリシーの記述方法</a></p>
<ul>
<li><p><a class="reference internal" href="#id6" id="id53">代表的な認可メソッド</a></p></li>
<li><p><a class="reference internal" href="#built-incommon-expressions" id="id54">Built-InのCommon Expressions</a></p></li>
<li><p><a class="reference internal" href="#built-inweb-expressions" id="id55">Built-InのWeb Expressions</a></p></li>
<li><p><a class="reference internal" href="#id8" id="id56">演算子の使用</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#web" id="id57">Webリソースへの認可</a></p>
<ul>
<li><p><a class="reference internal" href="#id9" id="id58">認可処理の適用</a></p></li>
<li><p><a class="reference internal" href="#access-policy-designate-web-resource" id="id59">アクセスポリシーの定義</a></p>
<ul>
<li><p><a class="reference internal" href="#id11" id="id60">アクセスポリシーを適用するWebリソースの指定</a></p></li>
<li><p><a class="reference internal" href="#id12" id="id61">アクセスポリシーの設定例</a></p></li>
<li><p><a class="reference internal" href="#id13" id="id62">パス変数の参照</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#authorizationtomethod" id="id63">メソッドへの認可</a></p>
<ul>
<li><p><a class="reference internal" href="#aop" id="id64">AOPの有効化</a></p></li>
<li><p><a class="reference internal" href="#id16" id="id65">認可処理の適用</a></p></li>
<li><p><a class="reference internal" href="#id17" id="id66">アクセスポリシーの定義</a></p>
<ul>
<li><p><a class="reference internal" href="#id18" id="id67">メソッド実行前に適用するアクセスポリシーの指定</a></p></li>
<li><p><a class="reference internal" href="#id19" id="id68">メソッド実行後に適用するアクセスポリシーの指定</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#id20" id="id69">画面項目への認可</a></p>
<ul>
<li><p><a class="reference internal" href="#id21" id="id70">アクセスポリシーの定義</a></p></li>
<li><p><a class="reference internal" href="#id22" id="id71">Webリソースに指定したアクセスポリシーとの連動</a></p></li>
<li><p><a class="reference internal" href="#id23" id="id72">認可処理の判定結果を変数に格納</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#authorizationerrorresponse" id="id73">認可エラー時のレスポンス</a></p>
<ul>
<li><p><a class="reference internal" href="#accessdeniedhandler" id="id74">AccessDeniedHandler</a></p></li>
<li><p><a class="reference internal" href="#authenticationentrypoint" id="id75">AuthenticationEntryPoint</a></p></li>
<li><p><a class="reference internal" href="#springsecurityauthorizationonerror" id="id76">認可エラー時の遷移先</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#how-to-extend" id="id77">How to extend</a></p>
<ul>
<li><p><a class="reference internal" href="#id26" id="id78">認可エラー時のレスポンス (認証済みユーザー編)</a></p>
<ul>
<li><p><a class="reference internal" href="#springsecurityauthorizationaccessdeniedhandler" id="id79">AccessDeniedHandlerの適用</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id28" id="id80">認可エラー時のレスポンス (未認証ユーザー編)</a></p>
<ul>
<li><p><a class="reference internal" href="#id29" id="id81">リクエスト毎にAuthenticationEntryPointを適用</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id30" id="id82">ロールの階層化</a></p>
<ul>
<li><p><a class="reference internal" href="#id31" id="id83">階層関係の設定</a></p></li>
<li><p><a class="reference internal" href="#id32" id="id84">Webリソースの認可処理への適用</a></p></li>
<li><p><a class="reference internal" href="#id33" id="id85">メソッドの認可処理への適用</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#appendix" id="id86">Appendix</a></p>
<ul>
<li><p><a class="reference internal" href="#spring-security" id="id87">Spring Securityのパスパターンマッチングにおける拡張子および末尾<code class="docutils literal notranslate"><span class="pre">/</span></code>の考慮</a></p></li>
</ul>
</li>
</ul>
</nav>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="overview">
<h2><a class="toc-backref" href="#id46" role="doc-backlink"><span class="section-number">9.3.1. </span>Overview</a><a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h2>
<p>本節では、Spring Securityが提供している認可機能について説明する。</p>
<div class="line-block">
<div class="line">認可処理は、アプリケーションの利用者がアクセスできるリソースを制御するための処理である。</div>
<div class="line">利用者がアクセスできるリソースを制御するためのもっとも標準的な方法は、リソース(又はリソースの集合)毎にアクセスポリシーを定義しておき、利用者がリソースにアクセスしようとした時にアクセスポリシーを調べて制御する方法である。</div>
</div>
<div class="line-block">
<div class="line">アクセスポリシーには、どのリソースにどのユーザーからのアクセスを許可するかを定義する。</div>
<div class="line">Spring Securityでは、以下の3つのリソースに対してアクセスポリシーを定義することができる。</div>
</div>
<ul class="simple">
<li><p>Webリソース</p></li>
<li><p>Javaメソッド</p></li>
<li><p>ドメインオブジェクト <a class="footnote-reference brackets" href="#fspringsecurityauthorization1" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a></p></li>
<li><p>画面項目</p></li>
</ul>
<p>本節では、「Webリソース」「Javaメソッド」「画面項目」のアクセスに対して認可処理を適用するための実装例(定義例)を紹介しながら、Spring Securityの認可機能について説明する。</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="fspringsecurityauthorization1" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">1</a><span class="fn-bracket">]</span></span>
<p>ドメインオブジェクトのアクセスに対する認可処理については、 <a class="reference external" href="https://docs.spring.io/spring-security/reference/servlet/authorization/acls.html">Spring Security Reference -Domain Object Security (ACLs)-</a>を参照されたい。</p>
</aside>
</aside>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="id4">
<h3><a class="toc-backref" href="#id47" role="doc-backlink"><span class="section-number">9.3.1.1. </span>認可処理のアーキテクチャ</a><a class="headerlink" href="#id4" title="Permalink to this heading">¶</a></h3>
<p>Spring Securityは、以下のような流れで認可処理を行う。</p>
<figure class="align-default" id="id34">
<a class="reference internal image-reference" href="../_images/AuthorizationArchitecture.png"><img alt="../_images/AuthorizationArchitecture.png" src="../_images/AuthorizationArchitecture.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>認可処理のアーキテクチャ</strong></span><a class="headerlink" href="#id34" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">クライアントは、任意のリソースにアクセスする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">AuthorizationFilter</span></code>クラスは、<code class="docutils literal notranslate"><span class="pre">AuthorizationManager</span></code>インタフェースのメソッドを呼び出し、リソースへのアクセス権の有無をチェックする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">AuthorizationManager</span></code>の実装クラスである<code class="docutils literal notranslate"><span class="pre">RequestMatcherDelegatingAuthorizationManager</span></code>が、受け取ったリクエストを適切な<code class="docutils literal notranslate"><span class="pre">AuthorizationManager</span></code>に振り分けてアクセス権の有無をチェックする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">AuthorizationFilter</span></code>は、<code class="docutils literal notranslate"><span class="pre">AuthorizationManager</span></code>によってアクセス権が付与された場合に限り、リソースへアクセスする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="exceptiontranslationfilter">
<h4><a class="toc-backref" href="#id48" role="doc-backlink"><span class="section-number">9.3.1.1.1. </span>ExceptionTranslationFilter</a><a class="headerlink" href="#exceptiontranslationfilter" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ExceptionTranslationFilter</span></code>は、認可処理(<code class="docutils literal notranslate"><span class="pre">AuthorizationManager</span></code>)で発生した例外をハンドリングし、クライアントへ適切なレスポンスを行うためのSecurity Filterである。</div>
<div class="line">デフォルトの実装では、未認証ユーザーからのアクセスの場合は認証を促すレスポンス、認証済みのユーザーからのアクセスの場合は認可エラーを通知するレスポンスを返却する。</div>
<div class="line"><br /></div>
</div>
</section>
<section id="authorizationfilter">
<h4><a class="toc-backref" href="#id49" role="doc-backlink"><span class="section-number">9.3.1.1.2. </span>AuthorizationFilter</a><a class="headerlink" href="#authorizationfilter" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">AuthorizationFilter</span></code>は、HTTPリクエストに対して認可処理を適用するためのSecurity Filterで、実際の認可処理は<code class="docutils literal notranslate"><span class="pre">AuthorizationManager</span></code>に委譲する。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">AuthorizationManager</span></code>インタフェースのメソッドを呼び出す際には、クライアントがアクセスしようとしたリソースに指定されているアクセスポリシーを連携する。</div>
<div class="line">アクセスが許可されると、<code class="docutils literal notranslate"><span class="pre">AuthorizationFilter</span></code>は<code class="docutils literal notranslate"><span class="pre">FilterChain</span></code>を続行する。</div>
<div class="line"><br /></div>
</div>
</section>
<section id="authorizationmanager">
<h4><a class="toc-backref" href="#id50" role="doc-backlink"><span class="section-number">9.3.1.1.3. </span>AuthorizationManager</a><a class="headerlink" href="#authorizationmanager" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">AuthorizationManager</span></code>は、アクセスしようとしたリソースに対してアクセス権があるかチェックを行うためのインタフェースである。</div>
<div class="line">アクセス権がないと判断した場合は、<code class="docutils literal notranslate"><span class="pre">AccessDeniedException</span></code>を発生させアクセスを拒否する。</div>
<div class="line">Spring Securityでは以下の実装クラスを提供している。</div>
<div class="line"><br /></div>
</div>
<table class="docutils align-default" id="id35">
<caption><span class="caption-text"><strong>Spring Securityが提供するAuthorizationManagerの実装クラス</strong></span><a class="headerlink" href="#id35" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 25.0%" />
<col style="width: 75.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>クラス名</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RequestMAtcherDelegatingAuthorizationManager</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">リクエストに一致する<code class="docutils literal notranslate"><span class="pre">RequestMatcher</span></code>を基に、認可処理を特定の<code class="docutils literal notranslate"><span class="pre">AuthorizationManager</span></code>に移譲する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">AuthorityAuthorizationManager</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Spring Securityが提供する一般的な<code class="docutils literal notranslate"><span class="pre">AuthorizationManager</span></code>。</div>
<div class="line">認証情報(<code class="docutils literal notranslate"><span class="pre">Authentication</span></code>)に指定された権限が含まれているかどうかを評価し、現在のユーザーが認可されているかどうかを判別する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">AuthenticatedAuthorizationManager</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">匿名ユーザー、完全認証ユーザー、リメンバー認証ユーザーを区別するために使用される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">JSR250AuthorizationManager</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">認証情報(<code class="docutils literal notranslate"><span class="pre">Authentication</span></code>)がJSR-250セキュリティアノテーションから指定された権限を含んでいるかどうかを評価する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">SecuredAuthorizationManager</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">認証情報(<code class="docutils literal notranslate"><span class="pre">Authentication</span></code>)がSpring Securityの<code class="docutils literal notranslate"><span class="pre">Secured</span></code>アノテーションから指定された権限を含んでいるかどうかを評価する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">PreAuthorizeAuthorizationManager</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">認証情報(<code class="docutils literal notranslate"><span class="pre">Authentication</span></code>)が<code class="docutils literal notranslate"><span class="pre">PreAuthorize</span></code>アノテーションから指定された権限を含んでいるかどうかを評価する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">PreAuthorizaAuthorizationMAnager</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">認証情報(<code class="docutils literal notranslate"><span class="pre">Authentication</span></code>)が<code class="docutils literal notranslate"><span class="pre">PostAuthorize</span></code>アノテーションから指定された権限を含んでいるかどうかを評価する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">Spring Securityが提供する<code class="docutils literal notranslate"><span class="pre">AuthorizationManager</span></code>以外に、独自に構築した<code class="docutils literal notranslate"><span class="pre">RequestMatcherDelegatingAuthorizationManager</span></code>を使用することも可能である。</div>
<div class="line">詳しくは、<a class="reference external" href="https://docs.spring.io/spring-security/reference/servlet/authorization/authorize-http-requests.html#_tabs_17">Configure RequestMatcherDelegatingAuthorizationManager</a>を参照されたい。</div>
<div class="line"><br /></div>
</div>
</section>
</section>
</section>
<section id="how-to-use">
<h2><a class="toc-backref" href="#id51" role="doc-backlink"><span class="section-number">9.3.2. </span>How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this heading">¶</a></h2>
<div class="line-block">
<div class="line">認可機能を使用するために必要となるbean定義例(アクセスポリシーの指定方法)や実装方法について説明する。</div>
<div class="line"><br /></div>
</div>
<section id="springsecurityauthorizationpolicy">
<span id="id5"></span><h3><a class="toc-backref" href="#id52" role="doc-backlink"><span class="section-number">9.3.2.1. </span>アクセスポリシーの記述方法</a><a class="headerlink" href="#springsecurityauthorizationpolicy" title="Permalink to this heading">¶</a></h3>
<p>アクセスポリシーの記述方法を説明する。</p>
<div class="line-block">
<div class="line">Spring Securityは、アクセスポリシーを指定する記述方法として<code class="docutils literal notranslate"><span class="pre">HttpSecurity</span></code>に対するメソッドチェーンをサポートしている。</div>
<div class="line">また、<code class="docutils literal notranslate"><span class="pre">&lt;intercept-url&gt;</span></code>JSP Taglibなど、式が必要な場合に備えSpring Expression Language(SpEL)をサポートしている。</div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>SpELの使い方については本節でも紹介するが、より詳しい使い方を知りたい場合は<a class="reference external" href="https://docs.spring.io/spring-framework/docs/6.1.3/reference/html/core.html#expressions">Spring Framework Documentation -Spring Expression Language (SpEL)-</a>を参照されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="id6">
<h4><a class="toc-backref" href="#id53" role="doc-backlink"><span class="section-number">9.3.2.1.1. </span>代表的な認可メソッド</a><a class="headerlink" href="#id6" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">HttpSecurity#authorizeHttpRequests(Customizer&lt;AuthorizeHttpRequestsConfigurer&lt;HttpSecurity&gt;.AuthorizationManagerRequestMatcherRegistry&gt;</span> <span class="pre">authorizeHttpRequestsCustomizer)</span></code>のCustomizerを実装し、URLパターン経由でHttpServletRequestに基づいてアクセスを制限することができる。</div>
<div class="line">代表的な認可メソッドは以下の通り。</div>
</div>
<table class="longtable docutils align-default" id="id36">
<caption><span class="caption-text"><strong>Spring Securityが提供している認可メソッド</strong></span><a class="headerlink" href="#id36" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 30.0%" />
<col style="width: 70.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>メソッド名</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">hasRole(String</span> <span class="pre">role)</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">ログインユーザーが、引数に指定したロールを保持している場合に<code class="docutils literal notranslate"><span class="pre">true</span></code>を返却する。</div>
<div class="line">ロールの<code class="docutils literal notranslate"><span class="pre">ROLE_</span></code> プレフィックスは省略可能である。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">hasAnyRole(String...</span> <span class="pre">roles)</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">ログインユーザーが、引数に指定したロールのいずれかを保持している場合に<code class="docutils literal notranslate"><span class="pre">true</span></code>を返却する。</div>
<div class="line">ロールの<code class="docutils literal notranslate"><span class="pre">ROLE_</span></code> プレフィックスは省略可能である。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">anonymous()</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">ログインしていない匿名ユーザーの場合に<code class="docutils literal notranslate"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">rememberMe()</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Remember Me認証によってログインしたユーザーの場合に<code class="docutils literal notranslate"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">authenticated()</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">ログイン中の場合に<code class="docutils literal notranslate"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">fullyAuthenticated()</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Remember Me認証ではなく通常の認証プロセスによってログインしたユーザーの場合に<code class="docutils literal notranslate"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">permitAll()</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">常に<code class="docutils literal notranslate"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">denyAll()</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">常に<code class="docutils literal notranslate"><span class="pre">false</span></code>を返却する。(<strong>デフォルト値</strong>)</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">access(AuthorizationManager&lt;RequestAuthorizationContext&gt;</span> <span class="pre">manager)</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">カスタム<code class="docutils literal notranslate"><span class="pre">AuthorizationManager</span></code>を使用して認可処理を実施する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Spring Securityの認可処理のデフォルト値は<code class="docutils literal notranslate"><span class="pre">denyAll</span></code>であるため、業務要件に応じ適切に認可する範囲を指定する必要がある。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="built-incommon-expressions">
<h4><a class="toc-backref" href="#id54" role="doc-backlink"><span class="section-number">9.3.2.1.2. </span>Built-InのCommon Expressions</a><a class="headerlink" href="#built-incommon-expressions" title="Permalink to this heading">¶</a></h4>
<p>Spring Securityが用意している共通的なExpressionは以下の通り。</p>
<table class="longtable docutils align-default" id="id37">
<caption><span class="caption-text"><strong>Spring Securityが提供している共通的なExpression</strong></span><a class="headerlink" href="#id37" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 30.0%" />
<col style="width: 70.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Expression</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">hasRole(String</span> <span class="pre">role)</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">ログインユーザーが、引数に指定したロールを保持している場合に<code class="docutils literal notranslate"><span class="pre">true</span></code>を返却する。</div>
<div class="line">ロールの<code class="docutils literal notranslate"><span class="pre">ROLE_</span></code> プレフィックスは省略可能である。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">hasAnyRole(String...</span> <span class="pre">roles)</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">ログインユーザーが、引数に指定したロールのいずれかを保持している場合に<code class="docutils literal notranslate"><span class="pre">true</span></code>を返却する。</div>
<div class="line">ロールの<code class="docutils literal notranslate"><span class="pre">ROLE_</span></code> プレフィックスは省略可能である。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">isAnonymous()</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">ログインしていない匿名ユーザーの場合に<code class="docutils literal notranslate"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">isRememberMe()</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Remember Me認証によってログインしたユーザーの場合に<code class="docutils literal notranslate"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">isAuthenticated()</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">ログイン中の場合に<code class="docutils literal notranslate"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">isFullyAuthenticated()</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Remember Me認証ではなく通常の認証プロセスによってログインしたユーザーの場合に<code class="docutils literal notranslate"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">permitAll</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">常に<code class="docutils literal notranslate"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">denyAll</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">常に<code class="docutils literal notranslate"><span class="pre">false</span></code>を返却する。(<strong>デフォルト値</strong>)</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">principal</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">認証されたユーザーのユーザー情報(<code class="docutils literal notranslate"><span class="pre">UserDetails</span></code>インタフェースを実装したクラスのオブジェクト)を返却する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">authentication</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">認証されたユーザーの認証情報(<code class="docutils literal notranslate"><span class="pre">Authentication</span></code>インタフェースを実装したクラスのオブジェクト)を返却する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Expressionを使用した認証情報へのアクセス</strong></p>
<p>Expressionとして<code class="docutils literal notranslate"><span class="pre">principal</span></code>や<code class="docutils literal notranslate"><span class="pre">authentication</span></code>を使用すると、ログインユーザーのユーザー情報や認証情報を参照することができるため、ロール以外の属性を使ってアクセスポリシーを設定することが可能になる。</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Spring Secuirtyが提供するその他のExpression</strong></p>
<p>上記に記載した以外にも、Spring Securityではログインユーザーが保持する権限を確認するExpressionとして、<code class="docutils literal notranslate"><span class="pre">hasAuthority(String</span> <span class="pre">authority)</span></code>、<code class="docutils literal notranslate"><span class="pre">hasAnyAuthority(String...</span> <span class="pre">authorities)</span></code>、<code class="docutils literal notranslate"><span class="pre">hasPermission(Object</span> <span class="pre">target,</span> <span class="pre">Object</span> <span class="pre">permission)</span></code>、<code class="docutils literal notranslate"><span class="pre">hasPermission(Object</span> <span class="pre">targetId,</span> <span class="pre">String</span> <span class="pre">targetType,</span> <span class="pre">Object</span> <span class="pre">permission)</span></code>を提供している。</p>
<p>ユーザの属性により権限をグループ化したものがロールであり、一般的には個々の権限による認可ではなくロールによる認可が推奨される。</p>
<p>Spring Securityの認可においてはいずれもログインユーザが「指定した権限（ロール）を保持しているか」を確認するため利用方法に違いはないが、権限名はロール名と異なり<code class="docutils literal notranslate"><span class="pre">ROLE_</span></code>のようなプレフィックスがないため、権限の定義と認可で名称を完全一致させる必要がある。</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Spring Securityの認可処理のデフォルト値は<code class="docutils literal notranslate"><span class="pre">denyAll</span></code>であるため、業務要件に応じ適切に認可する範囲を指定する必要がある。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="built-inweb-expressions">
<span id="id7"></span><h4><a class="toc-backref" href="#id55" role="doc-backlink"><span class="section-number">9.3.2.1.3. </span>Built-InのWeb Expressions</a><a class="headerlink" href="#built-inweb-expressions" title="Permalink to this heading">¶</a></h4>
<p>Spring Securityが用意しているWebアプリケーション向けExpressionは以下の通り。</p>
<table class="docutils align-default" id="id38">
<caption><span class="caption-text"><strong>Spring Securityが提供するWebアプリケーション向けExpression</strong></span><a class="headerlink" href="#id38" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 30.0%" />
<col style="width: 70.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Expression</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">hasIpAddress(String</span> <span class="pre">ipAddress)</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">リクエスト元のIPアドレスが、引数に指定したIPアドレス体系に一致する場合に<code class="docutils literal notranslate"><span class="pre">true</span></code>を返却する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id8">
<h4><a class="toc-backref" href="#id56" role="doc-backlink"><span class="section-number">9.3.2.1.4. </span>演算子の使用</a><a class="headerlink" href="#id8" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">演算子を使用した判定も行うことができる。</div>
<div class="line">以下の例では、ロールと、リクエストされたIPアドレス両方に合致した場合、アクセス可能となる。</div>
</div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-0-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-0-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-0-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-0-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-0-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><ul>
<li><p>SpringSecurityConfig.javaの定義例</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span>
<span class="kd">public</span><span class="w"> </span><span class="n">SecurityFilterChain</span><span class="w"> </span><span class="nf">filterChain</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="n">http</span><span class="p">.</span><span class="na">authorizeHttpRequests</span><span class="p">(</span><span class="n">authz</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">authz</span>
<span class="w">            </span><span class="c1">// omitted</span>
<span class="w">            </span><span class="p">.</span><span class="na">access</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">WebExpressionAuthorizationManager</span><span class="p">(</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;) and hasIpAddress(&#39;192.168.10.1&#39;)&quot;</span><span class="p">))</span>
<span class="w">            </span><span class="c1">// omitted</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">http</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
</div><div aria-labelledby="tab-0-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><ul>
<li><p>spring-security.xmlの定義例</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">request-matcher=</span><span class="s">&quot;ant&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:intercept-url</span><span class="w"> </span><span class="na">pattern=</span><span class="s">&quot;/admin/**&quot;</span><span class="w"> </span><span class="na">access=</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;) and hasIpAddress(&#39;192.168.10.1&#39;)&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
</li>
</ul>
</div></div>
<p><strong>使用可能な演算子一覧</strong></p>
<table class="docutils align-default">
<colgroup>
<col style="width: 20.0%" />
<col style="width: 80.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>演算子</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">[式1]</span> <span class="pre">and</span> <span class="pre">[式2]</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">式1、式2が、どちらも真の場合に、真を返す。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">[式1]</span> <span class="pre">or</span> <span class="pre">[式2]</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">いずれかの式が、真の場合に、真を返す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">![式]</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">式が真の場合は偽を、偽の場合は真を返す。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="web">
<span id="authorizationtowebresources"></span><h3><a class="toc-backref" href="#id57" role="doc-backlink"><span class="section-number">9.3.2.2. </span>Webリソースへの認可</a><a class="headerlink" href="#web" title="Permalink to this heading">¶</a></h3>
<p>Spring Securityは、サーブレットフィルタの仕組みを利用してWebリソース(HTTPリクエスト)に対して認可処理を行う。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="id9">
<h4><a class="toc-backref" href="#id58" role="doc-backlink"><span class="section-number">9.3.2.2.1. </span>認可処理の適用</a><a class="headerlink" href="#id9" title="Permalink to this heading">¶</a></h4>
<p>Webリソースに対して認可処理を適用する場合は、以下のようなbean定義を行う。</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-1-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-1-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-1-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-1-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-1-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-1-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><ul class="simple">
<li><p>SpringSecurityConfig.javaの定義例</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span>
<span class="kd">public</span><span class="w"> </span><span class="n">SecurityFilterChain</span><span class="w"> </span><span class="nf">filterChain</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="n">http</span><span class="p">.</span><span class="na">authorizeHttpRequests</span><span class="p">(</span><span class="n">authz</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">authz</span>
<span class="w">            </span><span class="p">.</span><span class="na">requestMatchers</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">AntPathRequestMatcher</span><span class="p">(</span><span class="s">&quot;/**&quot;</span><span class="p">)).</span><span class="na">authenticated</span><span class="p">()</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">http</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">HttpSecurity</span></code>のメソッドチェーンにより、HTTPリクエストに対してアクセスポリシーを定義する。</div>
<div class="line">ここでは、<code class="docutils literal notranslate"><span class="pre">authenticated()</span></code>メソッドを呼び出し「Webアプリケーション配下の全てのリクエストに対して認証済みのユーザーのみアクセスを許可する」というアクセスポリシーを定義している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div><div aria-labelledby="tab-1-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-1-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><ul class="simple">
<li><p>spring-security.xmlの定義例</p></li>
</ul>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">request-matcher=</span><span class="s">&quot;ant&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:intercept-url</span><span class="w"> </span><span class="na">pattern=</span><span class="s">&quot;/**&quot;</span><span class="w"> </span><span class="na">access=</span><span class="s">&quot;isAuthenticated()&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&lt;sec:intercept-url&gt;</span></code>タグに、HTTPリクエストに対してアクセスポリシーを定義する。</div>
<div class="line">ここでは、SpELを使用して「Webアプリケーション配下の全てのリクエストに対して認証済みのユーザーのみアクセスを許可する」というアクセスポリシーを定義している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="access-policy-designate-web-resource">
<span id="id10"></span><h4><a class="toc-backref" href="#id59" role="doc-backlink"><span class="section-number">9.3.2.2.2. </span>アクセスポリシーの定義</a><a class="headerlink" href="#access-policy-designate-web-resource" title="Permalink to this heading">¶</a></h4>
<p>bean定義ファイルを使用して、Webリソースに対してアクセスポリシーを定義する方法について説明する。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="id11">
<h5><a class="toc-backref" href="#id60" role="doc-backlink"><span class="section-number">9.3.2.2.2.1. </span>アクセスポリシーを適用するWebリソースの指定</a><a class="headerlink" href="#id11" title="Permalink to this heading">¶</a></h5>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-2-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-2-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-2-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-2-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-2-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-2-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><p><code class="docutils literal notranslate"><span class="pre">HttpSecurity#authorizeHttpRequests(Customizer&lt;AuthorizeHttpRequestsConfigurer&lt;HttpSecurity&gt;.AuthorizationManagerRequestMatcherRegistry&gt;</span> <span class="pre">authorizeHttpRequestsCustomizer)</span></code>のCustomizerを実装し、アクセスポリシーを設定する。</p>
<ul>
<li><p>SpringSecurityConfig.javaの定義例</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span>
<span class="kd">public</span><span class="w"> </span><span class="n">SecurityFilterChain</span><span class="w"> </span><span class="nf">filterChain</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="n">http</span><span class="p">.</span><span class="na">authorizeHttpRequests</span><span class="p">(</span><span class="n">authz</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">authz</span>
<span class="w">            </span><span class="p">.</span><span class="na">requestMatchers</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">AntPathRequestMatcher</span><span class="p">(</span><span class="s">&quot;/admin/accounts/**&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">HttpMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">.</span><span class="na">name</span><span class="p">())).</span><span class="na">hasRole</span><span class="p">(</span><span class="s">&quot;ACCOUNT_MANAGER&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// (1)(4)</span>
<span class="w">            </span><span class="p">.</span><span class="na">requestMatchers</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">AntPathRequestMatcher</span><span class="p">(</span><span class="s">&quot;/admin/configurations/**&quot;</span><span class="p">))</span>
<span class="w">                    </span><span class="p">.</span><span class="na">access</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">WebExpressionAuthorizationManager</span><span class="p">(</span><span class="s">&quot;hasIpAddress(&#39;127.0.0.1&#39;) and hasRole(&#39;CONFIGURATION_MANAGER&#39;)&quot;</span><span class="p">))</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">            </span><span class="p">.</span><span class="na">requestMatchers</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">AntPathRequestMatcher</span><span class="p">(</span><span class="s">&quot;/admin/**&quot;</span><span class="p">)).</span><span class="na">hasAnyRole</span><span class="p">(</span><span class="s">&quot;USER&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ADMIN&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">requestMatchers</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">AntPathRequestMatcher</span><span class="p">(</span><span class="s">&quot;/**&quot;</span><span class="p">)).</span><span class="na">denyAll</span><span class="p">()</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">    </span><span class="n">http</span><span class="p">.</span><span class="na">requiresChannel</span><span class="p">(</span><span class="n">channel</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">channel</span><span class="p">.</span><span class="na">anyRequest</span><span class="p">().</span><span class="na">requiresSecure</span><span class="p">());</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">http</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default" id="id39">
<caption><span class="caption-text"><strong>メソッドチェーンによるアクセスポリシーを適用する設定</strong></span><a class="headerlink" href="#id39" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 20.0%" />
<col style="width: 80.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">パスパターンに一致するリソースを適用対象とするため、<code class="docutils literal notranslate"><span class="pre">AuthorizationManagerRequestMatcherRegistry.requestMatchers</span></code>に<code class="docutils literal notranslate"><span class="pre">RequestMatcher</span></code>オブジェクトを設定する。</div>
<div class="line">上記設定例では<code class="docutils literal notranslate"><span class="pre">AntPathRequestMatcher</span></code>を指定している。設定できる項目は以下となる。</div>
</div>
<blockquote>
<div><table class="docutils align-default" id="id40">
<caption><span class="caption-text"><strong>AntPathRequestMatcherの設定項目</strong></span><a class="headerlink" href="#id40" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 20.0%" />
<col style="width: 80.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>変数名</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">pattern</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Ant形式又は正規表現で指定したパスパターンに一致するリソースを適用対象にする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">httpMethod</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">指定したHTTPメソッド(GET,POSTなど)を使ってアクセスがあった場合に適用対象にする。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Expressionsを使用する場合は<code class="docutils literal notranslate"><span class="pre">AuthorizedUrl#access</span></code>を使用し、<code class="docutils literal notranslate"><span class="pre">WebExpressionAuthorizationManager</span></code>を設定する。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">WebExpressionAuthorizationManager</span></code>のコンストラクタ引数に認可制御用のExpressionsを設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">HttpSecurity#requiresChannel(Customizer&lt;ChannelSecurityConfigurer&lt;HttpSecurity&gt;.ChannelRequestMatcherRegistry&gt;</span> <span class="pre">requiresChannelCustomizer)</span></code>のCustomizerを実装し、指定したプロトコルを強制することができる。</div>
<div class="line">上記設定例では<code class="docutils literal notranslate"><span class="pre">http</span></code>でリクエストされた際に<code class="docutils literal notranslate"><span class="pre">https</span></code>へリダイレクトする処理となる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">requestMatchers</span></code>が返却する</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div><div aria-labelledby="tab-2-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-2-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><p><code class="docutils literal notranslate"><span class="pre">&lt;sec:intercept-url&gt;</span></code>タグに、HTTPリクエストに対してアクセスポリシーを定義する。</p>
<ul class="simple">
<li><p>spring-security.xmlの定義例</p></li>
</ul>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">request-matcher=</span><span class="s">&quot;ant&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:intercept-url</span><span class="w"> </span><span class="na">pattern=</span><span class="s">&quot;/admin/accounts/**&quot;</span><span class="w"> </span><span class="na">method=</span><span class="s">&quot;GET&quot;</span><span class="w"> </span><span class="na">requires-channel=</span><span class="s">&quot;https&quot;</span><span class="w"> </span><span class="na">access=</span><span class="s">&quot;hasRole(&#39;ACCOUNT_MANAGER&#39;)&quot;</span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:intercept-url</span><span class="w"> </span><span class="na">pattern=</span><span class="s">&quot;/admin/configurations/**&quot;</span><span class="w"> </span><span class="na">access=</span><span class="s">&quot;hasIpAddress(&#39;127.0.0.1&#39;) and hasRole(&#39;CONFIGURATION_MANAGER&#39;)&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:intercept-url</span><span class="w"> </span><span class="na">pattern=</span><span class="s">&quot;/admin/**&quot;</span><span class="w"> </span><span class="na">access=</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;)&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table class="docutils align-default" id="id41">
<caption><span class="caption-text"><strong>アクセスポリシーを適用する設定</strong></span><a class="headerlink" href="#id41" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 20.0%" />
<col style="width: 80.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">パスパターンに一致するリソースを適用対象とするため、<code class="docutils literal notranslate"><span class="pre">&lt;sec:intercept-url&gt;</span></code>にリソースを設定する。</div>
<div class="line">設定できる属性は以下となる。</div>
</div>
<blockquote>
<div><table class="docutils align-default" id="id42">
<caption><span class="caption-text"><strong>&lt;sec:intercept-url&gt;の属性項目</strong></span><a class="headerlink" href="#id42" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 20.0%" />
<col style="width: 80.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>属性名</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">pattern</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Ant形式又は正規表現で指定したパスパターンに一致するリソースを適用対象にする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">httpMethod</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">指定したHTTPメソッド(GET,POSTなど)を使ってアクセスがあった場合に適用対象にする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">requires-channel</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">「http」もしくは「https」を指定する。指定したプロトコルでのアクセスを強制するための属性。</div>
<div class="line">指定しない場合、どちらでもアクセス可能である。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">access</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">SpELでのアクセス制御式や、アクセス可能なロールを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
</div></div>
<div class="line-block">
<div class="line">Spring Securityは定義した順番でリクエストとのマッチング処理を行い、最初にマッチした定義を適用する。</div>
<div class="line">そのため、bean定義ファイルを使用してアクセスポリシーを指定する場合も定義順番には注意が必要である。</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Spring Security 4.1以降、Spring Securityがデフォルトで使用している<cite>AntPathRequestMatcher</cite> のパスマッチングの仕様が大文字・小文字を区別する様になった。</p>
<p>例えば以下に示すように、<code class="docutils literal notranslate"><span class="pre">/Todo/List</span></code>というパスが割り当てられたSpring MVCのエンドポイントに対してアクセスポリシーを定義する場合は、パスパターンについて<code class="docutils literal notranslate"><span class="pre">/Todo/List</span></code>や <code class="docutils literal notranslate"><span class="pre">/Todo/*</span></code>のように大文字・小文字をそろえる必要がある。</p>
<p>誤って<code class="docutils literal notranslate"><span class="pre">/todo/list</span></code>や<code class="docutils literal notranslate"><span class="pre">/todo/**</span></code>など大文字・小文字がそろっていない値を指定してしまうと、意図した認可制御が行われなくなるので注意されたい。</p>
<ul>
<li><p>Spring MVCのエンドポイントの実装例</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s">&quot;/Todo/List&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">viewTodoList</span><span class="p">(){</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>アクセスポリシーの定義例</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-3-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-3-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-3-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-3-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-3-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-3-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span>
<span class="kd">public</span><span class="w"> </span><span class="n">SecurityFilterChain</span><span class="w"> </span><span class="nf">filterChain</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="n">http</span><span class="p">.</span><span class="na">authorizeHttpRequests</span><span class="p">(</span><span class="n">authz</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">authz</span>
<span class="w">            </span><span class="p">.</span><span class="na">requestMatchers</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">AntPathRequestMatcher</span><span class="p">(</span><span class="s">&quot;/Todo/List&quot;</span><span class="p">)).</span><span class="na">authenticated</span><span class="p">()</span>
<span class="w">            </span><span class="c1">// omitted</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">http</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-3-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-3-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">request-matcher=</span><span class="s">&quot;ant&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:intercept-url</span><span class="w"> </span><span class="na">pattern=</span><span class="s">&quot;/Todo/List&quot;</span><span class="w"> </span><span class="na">access=</span><span class="s">&quot;isAuthenticated()&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
</div></div>
</li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Spring MVCとSpring Securityでは、リクエストとのマッチングの仕組みが厳密には異なっており、この差異を利用してSpring Securityの認可機能を突破し、ハンドラメソッドにアクセスできる脆弱性が存在する。</p>
<p>本事象の詳細は「<a class="reference external" href="https://tanzu.vmware.com/security/cve-2016-5007">CVE-2016-5007 Spring Security / MVC Path Matching Inconsistency</a>」を参照されたい。</p>
<p><code class="docutils literal notranslate"><span class="pre">trimTokens</span></code>プロパティに<code class="docutils literal notranslate"><span class="pre">true</span></code>を設定した<code class="docutils literal notranslate"><span class="pre">org.springframework.util.AntPathMatcher</span></code>のBeanがSpring MVCに適用されている場合に、本事象が発生する。</p>
<p>デフォルト値は<code class="docutils literal notranslate"><span class="pre">false</span></code>であるため、意図的に変更しない限り本事象は発生しない。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id12">
<h5><a class="toc-backref" href="#id61" role="doc-backlink"><span class="section-number">9.3.2.2.2.2. </span>アクセスポリシーの設定例</a><a class="headerlink" href="#id12" title="Permalink to this heading">¶</a></h5>
<div class="line-block">
<div class="line">ログインユーザーに「ROLE_USER」「ROLE_ADMIN」というロールがある場合を例に、設定例を示す。</div>
</div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-4-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-4-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-4-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-4-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-4-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-4-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">SpringSecurityConfig.java</span></code></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span>
<span class="kd">public</span><span class="w"> </span><span class="n">SecurityFilterChain</span><span class="w"> </span><span class="nf">filterChain</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="n">http</span><span class="p">.</span><span class="na">authorizeHttpRequests</span><span class="p">(</span><span class="n">authz</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">authz</span>
<span class="w">            </span><span class="p">.</span><span class="na">requestMatchers</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">AntPathRequestMatcher</span><span class="p">(</span><span class="s">&quot;/reserve/**&quot;</span><span class="p">)).</span><span class="na">hasAnyRole</span><span class="p">(</span><span class="s">&quot;USER&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ADMIN&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">            </span><span class="p">.</span><span class="na">requestMatchers</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">AntPathRequestMatcher</span><span class="p">(</span><span class="s">&quot;/admin/**&quot;</span><span class="p">)).</span><span class="na">hasRole</span><span class="p">(</span><span class="s">&quot;ADMIN&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">            </span><span class="p">.</span><span class="na">requestMatchers</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">AntPathRequestMatcher</span><span class="p">(</span><span class="s">&quot;/**&quot;</span><span class="p">)).</span><span class="na">denyAll</span><span class="p">()</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">http</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">「<code class="docutils literal notranslate"><span class="pre">/reserve/**</span></code>」にアクセスするためには、「ROLE_USER」もしくは「ROLE_ADMIN」ロールが必要である。</div>
<div class="line">ログインユーザーが指定したロールを保持していれば真を返す。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">「<code class="docutils literal notranslate"><span class="pre">/admin/**</span></code>」にアクセスするためには、「ROLE_ADMIN」ロールが必要である。</div>
<div class="line">ログインユーザーが指定したロールを保持していれば真を返す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">denyAll</span></code>を全てのパターンに設定し、</div>
<div class="line">権限設定が記述されていないURLに対してはどのユーザーもアクセス出来ない設定としている。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div><div aria-labelledby="tab-4-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-4-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">spring-security.xml</span></code></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">request-matcher=</span><span class="s">&quot;ant&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:intercept-url</span><span class="w"> </span><span class="na">pattern=</span><span class="s">&quot;/reserve/**&quot;</span><span class="w"> </span><span class="na">access=</span><span class="s">&quot;hasAnyRole(&#39;USER&#39;,&#39;ADMIN&#39;)&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:intercept-url</span><span class="w"> </span><span class="na">pattern=</span><span class="s">&quot;/admin/**&quot;</span><span class="w"> </span><span class="na">access=</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;)&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:intercept-url</span><span class="w"> </span><span class="na">pattern=</span><span class="s">&quot;/**&quot;</span><span class="w"> </span><span class="na">access=</span><span class="s">&quot;denyAll&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">「<code class="docutils literal notranslate"><span class="pre">/reserve/**</span></code>」にアクセスするためには、「ROLE_USER」もしくは「ROLE_ADMIN」ロールが必要である。</div>
<div class="line">ログインユーザーが指定したロールを保持していれば真を返す。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">「<code class="docutils literal notranslate"><span class="pre">/admin/**</span></code>」にアクセスするためには、「ROLE_ADMIN」ロールが必要である。</div>
<div class="line">ログインユーザーが指定したロールを保持していれば真を返す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">denyAll</span></code>を全てのパターンに設定し、</div>
<div class="line">権限設定が記述されていないURLに対してはどのユーザーもアクセス出来ない設定としている。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>URLパターンの記述順序について</strong></p>
<p>クライアントからのリクエストに対して、intercept-urlで記述されているパターンに、上から順にマッチさせ、マッチしたパターンに対してアクセス認可を行う。</p>
<p>そのため、パターンの記述は、必ず、より限定されたパターンから記述すること。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id13">
<h5><a class="toc-backref" href="#id62" role="doc-backlink"><span class="section-number">9.3.2.2.2.3. </span>パス変数の参照</a><a class="headerlink" href="#id13" title="Permalink to this heading">¶</a></h5>
<p>Spring Security 4.1以降では、アクセスポリシーを適用するリソースを指定する際にパス変数<a class="footnote-reference brackets" href="#fpathvariabledescription" id="id14" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>を使用することができ、アクセスポリシーの定義内で<code class="docutils literal notranslate"><span class="pre">#パス変数名</span></code>と指定することで参照できる。</p>
<p>ただし、拡張子を付けてアクセス可能なパスに対してパス変数を使用するアクセスポリシーを定義する場合は、パス変数値に拡張子部分が格納されない様に定義する必要がある。</p>
<p>例えば、パターンに<code class="docutils literal notranslate"><span class="pre">/users/{userName}</span></code>と定義し、<code class="docutils literal notranslate"><span class="pre">/users/personName.json</span></code>というリクエストパスを送信した際、アクセスポリシーの定義内で参照しているパス変数<code class="docutils literal notranslate"><span class="pre">#userName</span></code>には<code class="docutils literal notranslate"><span class="pre">personName</span></code>ではなく<code class="docutils literal notranslate"><span class="pre">personName.json</span></code>が格納され、意図しない認可制御が行われてしまう。</p>
<p>この事象を防ぐためには、「拡張子を付けたパスに対するアクセスポリシー」を定義した後に、「拡張子を付けないパスに対するアクセスポリシー」を定義する必要がある。</p>
<p>以下の例は、ログインユーザが自身のユーザ情報のみアクセスできる様にアクセスポリシーを定義している。</p>
<ul>
<li><p>ワイルドカードを使用する場合</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-5-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-5-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-5-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-5-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-5-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-5-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><ul class="simple">
<li><p>SpringSecurityConfig.javaの定義例</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span>
<span class="kd">public</span><span class="w"> </span><span class="n">SecurityFilterChain</span><span class="w"> </span><span class="nf">filterChain</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="n">http</span><span class="p">.</span><span class="na">authorizeHttpRequests</span><span class="p">(</span><span class="n">authz</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">authz</span>
<span class="w">            </span><span class="p">.</span><span class="na">requestMatchers</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">AntPathRequestMatcher</span><span class="p">(</span><span class="s">&quot;/users/{userName}.*&quot;</span><span class="p">))</span>
<span class="w">                    </span><span class="p">.</span><span class="na">access</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">WebExpressionAuthorizationManager</span><span class="p">(</span><span class="s">&quot;isAuthenticated() and #userName == principal.username&quot;</span><span class="p">))</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">            </span><span class="p">.</span><span class="na">requestMatchers</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">AntPathRequestMatcher</span><span class="p">(</span><span class="s">&quot;/users/{userName}/**&quot;</span><span class="p">))</span>
<span class="w">                    </span><span class="p">.</span><span class="na">access</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">WebExpressionAuthorizationManager</span><span class="p">(</span><span class="s">&quot;isAuthenticated() and #userName == principal.username&quot;</span><span class="p">))</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">            </span><span class="c1">// omitted</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">http</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">「拡張子を付けたパスに対するアクセスポリシー」を定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">「拡張子を付けないパスに対するアクセスポリシー」を定義する。</div>
<div class="line">ワイルドカードを使用して<code class="docutils literal notranslate"><span class="pre">/users/{userName}</span></code>で始まるパスに対するアクセスポリシーを定義する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div><div aria-labelledby="tab-5-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-5-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">request-matcher=</span><span class="s">&quot;ant&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:intercept-url</span><span class="w"> </span><span class="na">pattern=</span><span class="s">&quot;/users/{userName}.*&quot;</span><span class="w">  </span><span class="na">access=</span><span class="s">&quot;isAuthenticated() and #userName == principal.username&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:intercept-url</span><span class="w"> </span><span class="na">pattern=</span><span class="s">&quot;/users/{userName}/**&quot;</span><span class="w"> </span><span class="na">access=</span><span class="s">&quot;isAuthenticated() and #userName == principal.username&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">「拡張子を付けたパスに対するアクセスポリシー」を定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">「拡張子を付けないパスに対するアクセスポリシー」を定義する。</div>
<div class="line">ワイルドカードを使用して<code class="docutils literal notranslate"><span class="pre">/users/{userName}</span></code>で始まるパスに対するアクセスポリシーを定義する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></div>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul>
<li><p>ワイルドカードを使用しない場合</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-6-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-6-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-6-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-6-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-6-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-6-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><ul class="simple">
<li><p>SpringSecurityConfig.javaの定義例</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span>
<span class="kd">public</span><span class="w"> </span><span class="n">SecurityFilterChain</span><span class="w"> </span><span class="nf">filterChain</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="n">http</span><span class="p">.</span><span class="na">authorizeHttpRequests</span><span class="p">(</span><span class="n">authz</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">authz</span>
<span class="w">            </span><span class="p">.</span><span class="na">requestMatchers</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">AntPathRequestMatcher</span><span class="p">(</span><span class="s">&quot;/users/{userName}.*&quot;</span><span class="p">))</span>
<span class="w">                    </span><span class="p">.</span><span class="na">access</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">WebExpressionAuthorizationManager</span><span class="p">(</span><span class="s">&quot;isAuthenticated() and #userName == principal.username&quot;</span><span class="p">))</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">            </span><span class="p">.</span><span class="na">requestMatchers</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">AntPathRequestMatcher</span><span class="p">(</span><span class="s">&quot;/users/{userName}/&quot;</span><span class="p">))</span>
<span class="w">                    </span><span class="p">.</span><span class="na">access</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">WebExpressionAuthorizationManager</span><span class="p">(</span><span class="s">&quot;isAuthenticated() and #userName == principal.username&quot;</span><span class="p">))</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">            </span><span class="p">.</span><span class="na">requestMatchers</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">AntPathRequestMatcher</span><span class="p">(</span><span class="s">&quot;/users/{userName}&quot;</span><span class="p">))</span>
<span class="w">                    </span><span class="p">.</span><span class="na">access</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">WebExpressionAuthorizationManager</span><span class="p">(</span><span class="s">&quot;isAuthenticated() and #userName == principal.username&quot;</span><span class="p">))</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">            </span><span class="c1">// omitted</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">http</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">「拡張子を付けたパスに対するアクセスポリシー」を定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">「拡張子を付けないパスに対するアクセスポリシー」を定義する。</div>
<div class="line">ワイルドカードを使用しない場合、Spring MVCとSpring Securityのパスマッチングの差を吸収するために</div>
<div class="line">末尾が”<code class="docutils literal notranslate"><span class="pre">/</span></code>“で終わるパスに対するアクセスポリシーも定義する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div><div aria-labelledby="tab-6-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-6-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><ul class="simple">
<li><p>spring-security.xmlの定義例</p></li>
</ul>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">request-matcher=</span><span class="s">&quot;ant&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:intercept-url</span><span class="w"> </span><span class="na">pattern=</span><span class="s">&quot;/users/{userName}.*&quot;</span><span class="w"> </span><span class="na">access=</span><span class="s">&quot;isAuthenticated() and #userName == principal.username&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:intercept-url</span><span class="w"> </span><span class="na">pattern=</span><span class="s">&quot;/users/{userName}/&quot;</span><span class="w">  </span><span class="na">access=</span><span class="s">&quot;isAuthenticated() and #userName == principal.username&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:intercept-url</span><span class="w"> </span><span class="na">pattern=</span><span class="s">&quot;/users/{userName}&quot;</span><span class="w">   </span><span class="na">access=</span><span class="s">&quot;isAuthenticated() and #userName == principal.username&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">「拡張子を付けたパスに対するアクセスポリシー」を定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">「拡張子を付けないパスに対するアクセスポリシー」を定義する。</div>
<div class="line">ワイルドカードを使用しない場合、Spring MVCとSpring Securityのパスマッチングの差を吸収するために</div>
<div class="line">末尾が”<code class="docutils literal notranslate"><span class="pre">/</span></code>“で終わるパスに対するアクセスポリシーも定義する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></div>
</li>
</ul>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="fpathvariabledescription" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id14">2</a><span class="fn-bracket">]</span></span>
<p>パス変数の説明は<a class="reference internal" href="../ImplementationAtEachLayer/ApplicationLayer.html"><span class="doc">アプリケーション層の実装</span></a>の<a class="reference internal" href="../ImplementationAtEachLayer/ApplicationLayer.html#controller-method-argument-pathvariable-label"><span class="std std-ref">URLのパスから値を取得する</span></a>を参照されたい。</p>
</aside>
</aside>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
</section>
<section id="authorizationtomethod">
<span id="id15"></span><h3><a class="toc-backref" href="#id63" role="doc-backlink"><span class="section-number">9.3.2.3. </span>メソッドへの認可</a><a class="headerlink" href="#authorizationtomethod" title="Permalink to this heading">¶</a></h3>
<p>Spring Securityは、Spring AOPの仕組みを利用してDIコンテナで管理しているBeanのメソッド呼び出しに対して認可処理を行う。</p>
<div class="line-block">
<div class="line">メソッドに対する認可処理は、ドメイン層(サービス層)のメソッド呼び出しに対して行うことを想定して提供されている。</div>
<div class="line">メソッドに対する認可処理を使用すると、ドメインオブジェクトのプロパティを参照することができるため、きめの細かいアクセスポリシーの定義を行うことが可能になる。</div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="aop">
<h4><a class="toc-backref" href="#id64" role="doc-backlink"><span class="section-number">9.3.2.3.1. </span>AOPの有効化</a><a class="headerlink" href="#aop" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">メソッドへの認可処理を使用する場合は、メソッド呼び出しに対して認可処理を行うためのコンポーネント(AOP)を有効化する必要がある。</div>
<div class="line">AOPを有効化すると、アクセスポリシーをメソッドのアノテーションに定義できるようになる。</div>
</div>
<p>Spring Securityは、以下のアノテーションをサポートしている。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;PreAuthorize</span></code>、<code class="docutils literal notranslate"><span class="pre">&#64;PostAuthorize</span></code>、<code class="docutils literal notranslate"><span class="pre">&#64;PreFilter</span></code>、<code class="docutils literal notranslate"><span class="pre">&#64;PostFilter</span></code></p></li>
<li><p>JSR-250 (<code class="docutils literal notranslate"><span class="pre">jakarta.annotation.security</span></code>パッケージ)のアノテーション(<code class="docutils literal notranslate"><span class="pre">&#64;RolesAllowed</span></code>など)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;Secured</span></code></p></li>
</ul>
<p>本ガイドラインでは、アクセスポリシーをExpressionで使用することができる<code class="docutils literal notranslate"><span class="pre">&#64;PreAuthorize</span></code>、<code class="docutils literal notranslate"><span class="pre">&#64;PostAuthorize</span></code>を使用する方法を説明する。</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-7-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-7-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-7-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-7-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-7-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-7-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><ul class="simple">
<li><p>SpringSecurityConfig.javaの定義例</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Configuration</span>
<span class="nd">@EnableMethodSecurity</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SpringSecurityConfig</span><span class="w"> </span><span class="p">{</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&#64;EnableMethodSecurity</span></code>アノテーションをコンフィグレーションクラスに付与すると、メソッド呼び出しに対する認可処理を行うAOPが有効になる。</div>
<div class="line">なお、<code class="docutils literal notranslate"><span class="pre">prePostEnabled</span></code>プロパティはデフォルトで<code class="docutils literal notranslate"><span class="pre">true</span></code>となっており、Expressionを指定してアクセスポリシーを定義できるアノテーションが有効となっている。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div><div aria-labelledby="tab-7-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-7-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><ul class="simple">
<li><p>spring-security.xmlの定義例</p></li>
</ul>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:method-security</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&lt;sec:method-security&gt;</span></code>タグを付与すると、メソッド呼び出しに対する認可処理を行うAOPが有効になる。</div>
<div class="line">なお、<code class="docutils literal notranslate"><span class="pre">pre-post-annotations</span></code>属性はデフォルトで<code class="docutils literal notranslate"><span class="pre">true</span></code>となっており、Expressionを指定してアクセスポリシーを定義できるアノテーションが有効となっている。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id16">
<h4><a class="toc-backref" href="#id65" role="doc-backlink"><span class="section-number">9.3.2.3.2. </span>認可処理の適用</a><a class="headerlink" href="#id16" title="Permalink to this heading">¶</a></h4>
<p>メソッドに対して認可処理を適用する際は、アクセスポリシーを指定するアノテーションを使用して、メソッド毎にアクセスポリシーを定義する。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id17">
<h4><a class="toc-backref" href="#id66" role="doc-backlink"><span class="section-number">9.3.2.3.3. </span>アクセスポリシーの定義</a><a class="headerlink" href="#id17" title="Permalink to this heading">¶</a></h4>
<section id="id18">
<h5><a class="toc-backref" href="#id67" role="doc-backlink"><span class="section-number">9.3.2.3.3.1. </span>メソッド実行前に適用するアクセスポリシーの指定</a><a class="headerlink" href="#id18" title="Permalink to this heading">¶</a></h5>
<p>メソッドの実行前に適用するアクセスポリシーを指定する場合は、<code class="docutils literal notranslate"><span class="pre">&#64;PreAuthorize</span></code>を使用する。</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&#64;PreAuthorize</span></code>の<code class="docutils literal notranslate"><span class="pre">value</span></code>属性に指定したExpressionの結果が<code class="docutils literal notranslate"><span class="pre">true</span></code>になるとメソッドの実行が許可される。</div>
<div class="line">下記例では、管理者以外は、他人のアカウント情報にアクセスできないように定義している。</div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;PreAuthorize</span></code>の定義例</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// (1) (2)</span>
<span class="nd">@PreAuthorize</span><span class="p">(</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;) or (#username == principal.username)&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">Account</span><span class="w"> </span><span class="nf">findOne</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">findByUsername</span><span class="p">(</span><span class="n">username</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">認可処理を適用したいメソッドに、<code class="docutils literal notranslate"><span class="pre">&#64;PreAuthorize</span></code>を付与する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">value</span></code>属性に、メソッドに対してアクセスポリシーを定義する。</div>
<div class="line">ここでは、「管理者の場合は全てのアカウントへのアクセスを許可する」「管理者以外の場合は自身のアカウントへのアクセスのみ許可する」というアクセスポリシーを定義している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">ここでポイントになるのは、Expressionの中からメソッドの引数にアクセスしている部分である。</div>
<div class="line">具体的には、「<code class="docutils literal notranslate"><span class="pre">#username</span></code>」の部分が引数にアクセスしている部分である。</div>
<div class="line">Expression内で「# + 引数名」形式のExpressionを指定することで、メソッドの引数にアクセスすることができる。</div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><strong>引数名を指定するアノテーション</strong></p>
<p>Spring Securityは、クラスに出力されているデバッグ情報から引数名を解決する仕組みになっているが、アノテーション(<code class="docutils literal notranslate"><span class="pre">&#64;org.springframework.security.core.parameters.P</span></code>)を使用して明示的に引数名を指定することもできる。</p>
<p>以下のケースにあてはまる場合は、アノテーションを使用して明示的に変数名を指定する。</p>
<ul>
<li><p>クラスに変数のデバッグ情報を出力しない</p></li>
<li><p>Expressionの中から実際の変数名とは別の名前を使ってアクセスしたい (例えば短縮した名前)</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@PreAuthorize</span><span class="p">(</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;) or (#username == principal.username)&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">Account</span><span class="w"> </span><span class="nf">findOne</span><span class="p">(</span><span class="nd">@P</span><span class="p">(</span><span class="s">&quot;username&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">findByUsername</span><span class="p">(</span><span class="n">username</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
<p>なお、<code class="docutils literal notranslate"><span class="pre">#username</span></code>と、メソッドの引数である <code class="docutils literal notranslate"><span class="pre">username</span></code>の名称が一致している場合は <code class="docutils literal notranslate"><span class="pre">&#64;P</span></code>を省略することが可能である。</p>
<p>ただし、Spring Securityは引数名の解決を、実装クラスの引数名を使用して行っているため<code class="docutils literal notranslate"><span class="pre">&#64;PreAuthorize</span></code>アノテーションをインターフェースに定義している場合には、<strong>実装クラスの引数名を、 &#64;PreAuthorize 内で指定した #username と一致させる必要がある</strong>ので、注意されたい。</p>
<p>JDK 8 から追加されたコンパイルオプション(<code class="docutils literal notranslate"><span class="pre">-parameters</span></code>)を使用すると、メソッドパラメータにリフレクション用のメタデータが生成されるため、アノテーションを指定しなくても引数名が解決される。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Spring 5から、SpringのコアAPIに<a class="reference external" href="https://docs.spring.io/spring-framework/docs/6.1.3/reference/html/core.html#null-safety">null-safety</a>の機能が取り入れられており、SpELが解釈される際の<code class="docutils literal notranslate"><span class="pre">null</span></code>に対する動作も変更(<a class="reference external" href="https://jira.spring.io/browse/SPR-15540?redirect=false">SPR-15540</a>)されている。</p>
<p>例えば<code class="docutils literal notranslate"><span class="pre">&#64;PreAuthorize</span></code>の引数(<code class="docutils literal notranslate"><span class="pre">#xxx</span></code>)や、<code class="docutils literal notranslate"><span class="pre">&#64;PostAuthorize</span></code>の戻り値（<code class="docutils literal notranslate"><span class="pre">resultObject</span></code>）が<code class="docutils literal notranslate"><span class="pre">Map</span></code>を含む場合、<code class="docutils literal notranslate"><span class="pre">Map</span></code>から値を取得するSpELでキー値に<code class="docutils literal notranslate"><span class="pre">null</span></code>となる値を入力すると、Spring 4以前ではそのまま<code class="docutils literal notranslate"><span class="pre">Map</span></code>に<code class="docutils literal notranslate"><span class="pre">null</span></code>が渡され該当する値がないため<code class="docutils literal notranslate"><span class="pre">null</span></code>が返却されていたが、Spring 5以降ではキーとなるSpELを評価した結果に対する<code class="docutils literal notranslate"><span class="pre">null</span></code>チェックが追加されており、<code class="docutils literal notranslate"><span class="pre">null</span></code>の場合は<code class="docutils literal notranslate"><span class="pre">IllegalStateException</span></code>が発生する。</p>
<p>そのため、キーとする値に対して事前に<code class="docutils literal notranslate"><span class="pre">null</span></code>チェックを行うなど、<code class="docutils literal notranslate"><span class="pre">null</span></code>を考慮した実装が必要となる。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id19">
<h5><a class="toc-backref" href="#id68" role="doc-backlink"><span class="section-number">9.3.2.3.3.2. </span>メソッド実行後に適用するアクセスポリシーの指定</a><a class="headerlink" href="#id19" title="Permalink to this heading">¶</a></h5>
<p>メソッドの実行後に適用するアクセスポリシーを指定する場合は、<code class="docutils literal notranslate"><span class="pre">&#64;PostAuthorize</span></code>を使用する。</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&#64;PostAuthorize</span></code>の<code class="docutils literal notranslate"><span class="pre">value</span></code>属性に指定したExpressionの結果が<code class="docutils literal notranslate"><span class="pre">true</span></code>になるとメソッドの実行結果が呼び出し元に返却される。</div>
<div class="line">下記例では、所属する部署が違うユーザーのアカウント情報にアクセスできないように定義している。</div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;PostAuthorize</span></code>の定義例</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@PreAuthorize</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">)</span>
<span class="nd">@PostAuthorize</span><span class="p">(</span><span class="s">&quot;(returnObject == null) &quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="s">&quot;or (returnObject.departmentCode == principal.account.departmentCode)&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">Account</span><span class="w"> </span><span class="nf">findOne</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">findByUsername</span><span class="p">(</span><span class="n">username</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">ここでポイントになるのは、Expressionの中からメソッドの返り値にアクセスしている部分である。</div>
<div class="line">具体的には、「<code class="docutils literal notranslate"><span class="pre">returnObject.departmentCode</span></code>」の部分が返り値にアクセスしている部分である。</div>
<div class="line">Expression内で「<code class="docutils literal notranslate"><span class="pre">returnObject</span></code>」を指定すると、メソッドの返り値にアクセスすることができる。</div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
</section>
<section id="id20">
<h3><a class="toc-backref" href="#id69" role="doc-backlink"><span class="section-number">9.3.2.4. </span>画面項目への認可</a><a class="headerlink" href="#id20" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">Spring Securityは、JSPタグライブラリを使用してJSPの画面項目に対して認可処理を適用することができる。</div>
<div class="line">また、Spring Security Dialectは、Spring Securityが提供するJSPタグライブラリと同等の認可処理をThymeleafに適用することができる。</div>
</div>
<p>ここでは最もシンプルな定義を例に、画面項目のアクセスに対して認可処理を適用する方法について説明する。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="id21">
<h4><a class="toc-backref" href="#id70" role="doc-backlink"><span class="section-number">9.3.2.4.1. </span>アクセスポリシーの定義</a><a class="headerlink" href="#id21" title="Permalink to this heading">¶</a></h4>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-8-SlNQ" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-8-SlNQ" name="SlNQ" role="tab" tabindex="0">JSP</button><button aria-controls="panel-8-VGh5bWVsZWFm" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-8-VGh5bWVsZWFm" name="VGh5bWVsZWFm" role="tab" tabindex="-1">Thymeleaf</button></div><div aria-labelledby="tab-8-SlNQ" class="sphinx-tabs-panel group-tab" id="panel-8-SlNQ" name="SlNQ" role="tabpanel" tabindex="0"><p>JSPタグライブラリを使用してJSPの画面項目に対してアクセスポリシーを定義する際は、表示を許可する条件(アクセスポリシー)をJSPに定義する。</p>
<ul class="simple">
<li><p>アクセスポリシー定義例</p></li>
</ul>
<div class="highlight-jsp notranslate"><div class="highlight"><pre><span></span><span class="k">&lt;%@</span><span class="w"> </span><span class="n">taglib</span><span class="w"> </span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;sec&quot;</span><span class="w"> </span><span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://www.springframework.org/security/tags&quot;</span><span class="w"> </span><span class="k">%&gt;</span>

<span class="cm">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;sec:authorize</span><span class="w"> </span><span class="na">access=</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;)&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;h2&gt;</span>Admin<span class="w"> </span>Menu<span class="nt">&lt;/h2&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:authorize&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">アクセスポリシーを適用したい部分を<code class="docutils literal notranslate"><span class="pre">&lt;sec:authorize&gt;</span></code>タグで囲む。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">access</span></code>属性にアクセスポリシーを定義する。ここでは、「管理者の場合は表示を許可する」というアクセスポリシーを定義している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div><div aria-labelledby="tab-8-VGh5bWVsZWFm" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-8-VGh5bWVsZWFm" name="VGh5bWVsZWFm" role="tabpanel" tabindex="0"><p>Spring Security Dialectを使用して画面項目に対してアクセスポリシーを定義する際は、表示を許可する条件(アクセスポリシー)をHTMLに定義する。</p>
<ul class="simple">
<li><p>アクセスポリシー定義例</p></li>
</ul>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns:th</span><span class="o">=</span><span class="s">&quot;http://www.thymeleaf.org&quot;</span>
    <span class="na">xmlns:sec</span><span class="o">=</span><span class="s">&quot;http://www.thymeleaf.org/extras/spring-security&quot;</span><span class="p">&gt;</span>

<span class="cm">&lt;!--/* (1) */--&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">sec:authorize</span><span class="o">=</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;)&quot;</span><span class="p">&gt;</span> <span class="cm">&lt;!--/* (2) */--&gt;</span>
    <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>Admin Menu<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
    <span class="cm">&lt;!--/* omitted */--&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">アクセスポリシーを適用したい部分を<code class="docutils literal notranslate"><span class="pre">sec:authorize</span></code>属性を記述したタグで囲む。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">属性値にアクセスポリシーを定義する。ここでは、「管理者の場合は表示を許可する」というアクセスポリシーを定義している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id22">
<h4><a class="toc-backref" href="#id71" role="doc-backlink"><span class="section-number">9.3.2.4.2. </span>Webリソースに指定したアクセスポリシーとの連動</a><a class="headerlink" href="#id22" title="Permalink to this heading">¶</a></h4>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-9-SlNQ" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-9-SlNQ" name="SlNQ" role="tab" tabindex="0">JSP</button><button aria-controls="panel-9-VGh5bWVsZWFm" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-9-VGh5bWVsZWFm" name="VGh5bWVsZWFm" role="tab" tabindex="-1">Thymeleaf</button></div><div aria-labelledby="tab-9-SlNQ" class="sphinx-tabs-panel group-tab" id="panel-9-SlNQ" name="SlNQ" role="tabpanel" tabindex="0"><div class="line-block">
<div class="line">ボタンやリンクなど(サーバーへのリクエストを伴う画面項目)に対してアクセスポリシーを定義する際は、リクエスト先のWebリソースに定義されているアクセスポリシーと連動させる。</div>
<div class="line">Webリソースに指定したアクセスポリシーと連動させる場合は、<code class="docutils literal notranslate"><span class="pre">&lt;sec:authorize&gt;</span></code>タグの<code class="docutils literal notranslate"><span class="pre">url</span></code>属性を使用する。</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">url</span></code>属性に指定したWebリソースにアクセスできる場合に限り<code class="docutils literal notranslate"><span class="pre">&lt;sec:authorize&gt;</span></code>タグの中に実装したJSPの処理が実行される。</p>
<ul class="simple">
<li><p>Webリソースに定義されているアクセスポリシーとの連携例</p></li>
</ul>
<div class="highlight-jsp notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;ul&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:authorize</span><span class="w"> </span><span class="na">url=</span><span class="s">&quot;/admin/accounts&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">        </span><span class="nt">&lt;li&gt;</span>
<span class="w">            </span><span class="nt">&lt;a</span><span class="w"> </span><span class="na">href=</span><span class="s">&quot;&lt;c:url value=&#39;/admin/accounts&#39; /&gt;&quot;</span><span class="nt">&gt;</span>Account<span class="w"> </span>Management<span class="nt">&lt;/a&gt;</span>
<span class="w">        </span><span class="nt">&lt;/li&gt;</span>
<span class="w">    </span><span class="nt">&lt;/sec:authorize&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ボタンやリンクを出力する部分を<code class="docutils literal notranslate"><span class="pre">&lt;sec:authorize&gt;</span></code>タグで囲む。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&lt;sec:authorize&gt;</span></code>タグの<code class="docutils literal notranslate"><span class="pre">url</span></code>属性にWebリソースへアクセスするためのURLを指定する。</div>
<div class="line">ここでは、「<code class="docutils literal notranslate"><span class="pre">/admin/accounts</span></code>というURLが割り振られているWebリソースにアクセス可能な場合は表示を許可する」というアクセスポリシーを定義しており、Webリソースに定義されているアクセスポリシーを直接意識する必要がない。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>HTTPメソッドによるポリシーの指定</strong></p>
<p>Webリソースのアクセスポリシーの定義をする際に、HTTPメソッドによって異なるアクセスポリシーを指定している場合は、<code class="docutils literal notranslate"><span class="pre">&lt;sec:authorize&gt;</span></code>タグの<code class="docutils literal notranslate"><span class="pre">method</span></code>属性を指定して、連動させる定義を特定すること。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>表示制御に関する留意点</strong></p>
<p>ボタンやリンクなどの表示制御を行う場合は、必ずWebリソースに定義されているアクセスポリシーと連動させること。</p>
<p>ボタンやリンクに対して直接アクセスポリシーの指定を行い、Webリソース自体にアクセスポリシーを定義していないと、URLを直接してアクセスするような不正なアクセスを防ぐことができない。</p>
</div>
</div><div aria-labelledby="tab-9-VGh5bWVsZWFm" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-9-VGh5bWVsZWFm" name="VGh5bWVsZWFm" role="tabpanel" tabindex="0"><div class="line-block">
<div class="line">ボタンやリンクなど(サーバーへのリクエストを伴う画面項目)に対してアクセスポリシーを定義する際は、リクエスト先のWebリソースに定義されているアクセスポリシーと連動させる。</div>
<div class="line">Webリソースに指定したアクセスポリシーと連動させる場合は、<code class="docutils literal notranslate"><span class="pre">sec:authorize-url</span></code>属性を使用する。</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">sec:authorize-url</span></code>属性に指定したWebリソースにアクセスできる場合に限り<code class="docutils literal notranslate"><span class="pre">sec:authorize-url</span></code>属性を付与したタグの中に実装したThymeleafの処理が実行される。</p>
<ul class="simple">
<li><p>Webリソースに定義されているアクセスポリシーとの連携例</p></li>
</ul>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
    <span class="cm">&lt;!--/* (1) */--&gt;</span>
    <span class="p">&lt;</span><span class="nt">li</span> <span class="na">sec:authorize-url</span><span class="o">=</span><span class="s">&quot;/admin/accounts&quot;</span><span class="p">&gt;</span> <span class="cm">&lt;!--/* (2) */--&gt;</span>
        <span class="p">&lt;</span><span class="nt">a</span> <span class="na">th:href</span><span class="o">=</span><span class="s">&quot;@{/admin/accounts}&quot;</span><span class="p">&gt;</span>Account Management<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ボタンやリンクを出力する部分を<code class="docutils literal notranslate"><span class="pre">sec:authorize-url</span></code>属性を記述したタグで囲む。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">sec:authorize-url</span></code>属性にWebリソースへアクセスするためのURLを指定する。</div>
<div class="line">ここでは、「<code class="docutils literal notranslate"><span class="pre">/admin/accounts</span></code>というURLが割り振られているWebリソースにアクセス可能な場合は表示を許可する」というアクセスポリシーを定義しており、Webリソースに定義されているアクセスポリシーを直接意識する必要がない。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>HTTPメソッドによるポリシーの指定</strong></p>
<p>Webリソースのアクセスポリシーの定義をする際に、HTTPメソッドによって異なるアクセスポリシーを指定している場合は、<code class="docutils literal notranslate"><span class="pre">sec:authorize-url</span></code>属性の前半にmethodを指定して、スペースで区切りURLを記載することによって連動させる定義を特定すること。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>表示制御に関する留意点</strong></p>
<p>ボタンやリンクなどの表示制御を行う場合は、必ずWebリソースに定義されているアクセスポリシーと連動させること。</p>
<p>ボタンやリンクに対して直接アクセスポリシーの指定を行い、Webリソース自体にアクセスポリシーを定義していないと、URLを直接してアクセスするような不正なアクセスを防ぐことができない。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><strong>#authorizationの紹介</strong></p>
<p>ここでは、<code class="docutils literal notranslate"><span class="pre">sec:authorize</span></code>属性や<code class="docutils literal notranslate"><span class="pre">sec:authorize-url</span></code>属性を用いて、画面項目に対してアクセスポリシーを定義する実装例を説明したが、
<code class="docutils literal notranslate"><span class="pre">#authorization</span></code>を用いても、ThymeleafのテンプレートHTMLから認可情報にアクセスする事が可能である。
<code class="docutils literal notranslate"><span class="pre">#authorization</span></code>は、変数式 <code class="docutils literal notranslate"><span class="pre">${}</span></code> にて使用できるため、条件判定やリテラル置換等<code class="docutils literal notranslate"><span class="pre">sec:authorize</span></code>属性や<code class="docutils literal notranslate"><span class="pre">sec:authorize-url</span></code>属性より複雑な使い方が可能である。</p>
<p>上記の例は、以下のように記述できる</p>
<blockquote>
<div><div class="highlight-HTML notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns:th</span><span class="o">=</span><span class="s">&quot;http://www.thymeleaf.org&quot;</span> <span class="na">xmlns:sec</span><span class="o">=</span><span class="s">&quot;http://www.thymeleaf.org/extras/spring-security&quot;</span><span class="p">&gt;</span><span class="cm">&lt;!--/* (1) */--&gt;</span>
<span class="cm">&lt;!--/* omitted */--&gt;</span>

<span class="p">&lt;</span><span class="nt">div</span> <span class="na">th:if</span><span class="o">=</span><span class="s">&quot;${#authorization.expr(&#39;isAuthenticated()&#39;)}&quot;</span><span class="p">&gt;</span> <span class="cm">&lt;!--/* (2) */--&gt;</span>
    <span class="cm">&lt;!--/* omitted */--&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">div</span> <span class="na">th:if</span><span class="o">=</span><span class="s">&quot;${#authorization.url(&#39;/admin/accounts&#39;)}&quot;</span><span class="p">&gt;</span> <span class="cm">&lt;!--/* (3) */--&gt;</span>
    <span class="cm">&lt;!--/* omitted */--&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 25.0%" />
<col style="width: 75.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">sec:authorize</span></code>属性や<code class="docutils literal notranslate"><span class="pre">sec:authorize-url</span></code>属性を使用する際には<code class="docutils literal notranslate"><span class="pre">&lt;html&gt;</span></code>タグに<code class="docutils literal notranslate"><span class="pre">xmlns:sec</span></code>属性を定義していたが、</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">#authorization</span></code>を使用する際には、<code class="docutils literal notranslate"><span class="pre">xmlns:sec</span></code>属性の定義は不要である。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">#authorization.expr</span></code>の引数には、<code class="docutils literal notranslate"><span class="pre">sec:authorize</span></code>属性と同様にアクセスポリシーを指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">#authorization.url</span></code>の引数には、<code class="docutils literal notranslate"><span class="pre">sec:authorize-url</span></code>属性と同様にWebリソースへアクセスするためのURLを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div></div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id23">
<h4><a class="toc-backref" href="#id72" role="doc-backlink"><span class="section-number">9.3.2.4.3. </span>認可処理の判定結果を変数に格納</a><a class="headerlink" href="#id23" title="Permalink to this heading">¶</a></h4>
<p>JSPにおいて、<code class="docutils literal notranslate"><span class="pre">&lt;sec:authorize&gt;</span></code>タグを使って呼び出した認可処理の判定結果は、変数に格納して使いまわすことができる。</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-10-SlNQ" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-10-SlNQ" name="SlNQ" role="tab" tabindex="0">JSP</button></div><div aria-labelledby="tab-10-SlNQ" class="sphinx-tabs-panel group-tab" id="panel-10-SlNQ" name="SlNQ" role="tabpanel" tabindex="0"><ul class="simple">
<li><p>JSPの実装例</p></li>
</ul>
<div class="highlight-jsp notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:authorize</span><span class="w"> </span><span class="na">url=</span><span class="s">&quot;/admin/accounts&quot;</span>
<span class="w">                </span><span class="na">var=</span><span class="s">&quot;hasAccountsAuthority&quot;</span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>

<span class="nt">&lt;c:if</span><span class="w"> </span><span class="na">test=</span><span class="s">&quot;${hasAccountsAuthority}&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/c:if&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">var</span></code>属性に判定結果を格納するための変数名を指定する。</div>
<div class="line">アクセスが許可された場合は、変数に<code class="docutils literal notranslate"><span class="pre">true</span></code>が設定される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">変数の値を参照して表示処理を実装する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="authorizationerrorresponse">
<span id="id24"></span><h3><a class="toc-backref" href="#id73" role="doc-backlink"><span class="section-number">9.3.2.5. </span>認可エラー時のレスポンス</a><a class="headerlink" href="#authorizationerrorresponse" title="Permalink to this heading">¶</a></h3>
<p>Spring Securityは、リソースへのアクセスを拒否した場合、以下のような流れでエラーをハンドリングしてレスポンスの制御を行う。</p>
<figure class="align-default" id="id43">
<a class="reference internal image-reference" href="../_images/AuthorizationAccessDeniedHandling.png"><img alt="../_images/AuthorizationAccessDeniedHandling.png" src="../_images/AuthorizationAccessDeniedHandling.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>認可エラーのハンドリングの仕組み</strong></span><a class="headerlink" href="#id43" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Spring Securityは、リソースやメソッドへのアクセスを拒否するために、<code class="docutils literal notranslate"><span class="pre">AccessDeniedException</span></code>を発生させる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ExceptionTranslationFilter</span></code>クラスは、<code class="docutils literal notranslate"><span class="pre">AccessDeniedException</span></code>をキャッチし、<code class="docutils literal notranslate"><span class="pre">AccessDeniedHandler</span></code>または<code class="docutils literal notranslate"><span class="pre">AuthenticationEntryPoint</span></code>インタフェースのメソッドを呼び出してエラー応答を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">認証済みのユーザーからのアクセスの場合は、<code class="docutils literal notranslate"><span class="pre">AccessDeniedHandler</span></code>インタフェースのメソッドを呼び出してエラー応答を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">未認証のユーザーからのアクセスの場合は、<code class="docutils literal notranslate"><span class="pre">AuthenticationEntryPoint</span></code>インタフェースのメソッドを呼び出してエラー応答を行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="accessdeniedhandler">
<h4><a class="toc-backref" href="#id74" role="doc-backlink"><span class="section-number">9.3.2.5.1. </span>AccessDeniedHandler</a><a class="headerlink" href="#accessdeniedhandler" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">AccessDeniedHandler</span></code>インタフェースは、認証済みのユーザーからのアクセスを拒否した際のエラー応答を行うためのインタフェースである。</div>
<div class="line">Spring Securityは、<code class="docutils literal notranslate"><span class="pre">AccessDeniedHandler</span></code>インタフェースの実装クラスとして以下のクラスを提供している。</div>
</div>
<table class="docutils align-default" id="id44">
<caption><span class="caption-text"><strong>Spring Securityが提供するAccessDeniedHandlerの実装クラス</strong></span><a class="headerlink" href="#id44" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 25.0%" />
<col style="width: 75.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>クラス名</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">AccessDeniedHandlerImpl</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">HTTPレスポンスコードに403(Forbidden)を設定し、指定されたエラーページに遷移する。</div>
<div class="line">エラーページの指定がない場合は、HTTPレスポンスコードに403(Forbidden)を設定してエラー応答(<code class="docutils literal notranslate"><span class="pre">HttpServletResponse#sendError</span></code>)を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">InvalidSessionAccessDeniedHandler</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">InvalidSessionStrategy</span></code>インタフェースの実装クラスに処理を委譲する。</div>
<div class="line">このクラスは、CSRF対策とセッション管理機能を使用してセッションタイムアウトを検知する設定を有効にした際に、CSRFトークンがセッションに存在しない(つまりセッションタイムアウトが発生している)場合に使用される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">DelegatingAccessDeniedHandler</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">AccessDeniedException</span></code>と<code class="docutils literal notranslate"><span class="pre">AccessDeniedHandler</span></code>インタフェースの実装クラスのマッピングを行い、発生した<code class="docutils literal notranslate"><span class="pre">AccessDeniedException</span></code>に対応する<code class="docutils literal notranslate"><span class="pre">AccessDeniedHandler</span></code>インタフェースの実装クラスに処理を委譲する。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">InvalidSessionAccessDeniedHandler</span></code>はこの仕組みを利用して呼び出されている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RequestMatcherDelegatingAccessDeniedHandler</span></code></div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">RequestMatcher</span></code>インタフェースの仕組みを利用して、指定されたリクエストのパターンに対応する<code class="docutils literal notranslate"><span class="pre">AccessDeniedHandler</span></code>インタフェースの実装クラスに処理を委譲する。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">RequestMatcherDelegatingAccessDeniedHandler</span></code>の設定方法については、<a class="reference internal" href="LinkageWithBrowser.html#linkagewithbrowsereachrequestpattern"><span class="std std-ref">リクエストパターン毎のセキュリティヘッダの出力</span></a>の<code class="docutils literal notranslate"><span class="pre">DelegatingRequestMatcherHeaderWriter</span></code>と同様にリクエストパターンの判定を行う<code class="docutils literal notranslate"><span class="pre">RequestMatcher</span></code>と処理を委譲する<code class="docutils literal notranslate"><span class="pre">AccessDeniedHandler</span></code>を設定すれば良い。</p>
<p>なお、<code class="docutils literal notranslate"><span class="pre">&lt;sec:intercept-url&gt;</span></code>と<code class="docutils literal notranslate"><span class="pre">RequestMatcherDelegatingAccessDeniedHandler</span></code>がパスマッチングを行う間にはリクエストのパスが変わる可能性がある処理が挟まれないため、Warning「指定したパスが意図した通りに認識されない問題」に記載されているような事象は発生しない。</p>
</div>
</td>
</tr>
</tbody>
</table>
<p>Spring Securityのデフォルトの設定では、エラーページの指定がない<code class="docutils literal notranslate"><span class="pre">AccessDeniedHandlerImpl</span></code>が使用される。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="authenticationentrypoint">
<h4><a class="toc-backref" href="#id75" role="doc-backlink"><span class="section-number">9.3.2.5.2. </span>AuthenticationEntryPoint</a><a class="headerlink" href="#authenticationentrypoint" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">AuthenticationEntryPoint</span></code>インタフェースは、未認証のユーザーからのアクセスを拒否した際のエラー応答を行うためのインタフェースである。</div>
<div class="line">Spring Securityは、<code class="docutils literal notranslate"><span class="pre">AuthenticationEntryPoint</span></code>インタフェースの実装クラスとして以下のクラスを提供している。</div>
</div>
<table class="docutils align-default" id="id45">
<caption><span class="caption-text"><strong>Spring Securityが提供する主なAuthenticationEntryPointの実装クラス</strong></span><a class="headerlink" href="#id45" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 25.0%" />
<col style="width: 75.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>クラス名</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">LoginUrlAuthenticationEntryPoint</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">フォーム認証用のログインフォームを表示する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">BasicAuthenticationEntryPoint</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Basic認証用のエラー応答を行う。</div>
<div class="line">具体的には、HTTPレスポンスコードに401(Unauthorized)を、レスポンスヘッダとしてBasic認証用の「<code class="docutils literal notranslate"><span class="pre">WWW-Authenticate</span></code>」ヘッダを設定してエラー応答(<code class="docutils literal notranslate"><span class="pre">HttpServletResponse#sendError</span></code>)を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">DigestAuthenticationEntryPoint</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Digest認証用のエラー応答を行う。</div>
<div class="line">具体的には、HTTPレスポンスコードに401(Unauthorized)を、レスポンスヘッダとしてDigest認証用の「<code class="docutils literal notranslate"><span class="pre">WWW-Authenticate</span></code>」ヘッダを設定してエラー応答(<code class="docutils literal notranslate"><span class="pre">HttpServletResponse#sendError</span></code>)を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">Http403ForbiddenEntryPoint</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">HTTPレスポンスコードに403(Forbidden)を設定してエラー応答(<code class="docutils literal notranslate"><span class="pre">HttpServletResponse#sendError</span></code>)を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">HttpStatusEntryPoint</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">任意のHTTPレスポンスコードを設定して正常応答(<code class="docutils literal notranslate"><span class="pre">HttpServletResponse#setStatus</span></code>)を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">DelegatingAuthenticationEntryPoint</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RequestMatcher</span></code>インタフェースの仕組みを利用して、指定されたリクエストのパターンに対応する<code class="docutils literal notranslate"><span class="pre">AuthenticationEntryPoint</span></code>インタフェースの実装クラスに処理を委譲する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Spring Securityのデフォルトの設定では、認証方式に対応する<code class="docutils literal notranslate"><span class="pre">AuthenticationEntryPoint</span></code>インタフェースの実装クラスが使用される。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="springsecurityauthorizationonerror">
<span id="id25"></span><h4><a class="toc-backref" href="#id76" role="doc-backlink"><span class="section-number">9.3.2.5.3. </span>認可エラー時の遷移先</a><a class="headerlink" href="#springsecurityauthorizationonerror" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">Spring Securityのデフォルトの設定だと、認証済みのユーザーからのアクセスを拒否した際は、アプリケーションサーバのエラーページが表示される。</div>
<div class="line">アプリケーションサーバーのエラーページを表示してしまうと、システムのセキュリティを低下させる要因になるため、適切なエラー画面を表示することを推奨する。</div>
<div class="line">エラーページの指定は、以下のようなbean定義を行うことで可能である。</div>
</div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-11-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-11-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-11-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-11-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-11-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-11-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-12-SlNQ" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-12-SlNQ" name="SlNQ" role="tab" tabindex="0">JSP</button><button aria-controls="panel-12-VGh5bWVsZWFm" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-12-VGh5bWVsZWFm" name="VGh5bWVsZWFm" role="tab" tabindex="-1">Thymeleaf</button></div><div aria-labelledby="tab-12-SlNQ" class="sphinx-tabs-panel group-tab" id="panel-12-SlNQ" name="SlNQ" role="tabpanel" tabindex="0"><ul class="simple">
<li><p>SpringSecurityConfig.javaの定義例</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;accessDeniedHandler&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">AccessDeniedHandler</span><span class="w"> </span><span class="nf">accessDeniedHandler</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">LinkedHashMap</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AccessDeniedException</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">AccessDeniedHandler</span><span class="o">&gt;</span><span class="w"> </span><span class="n">errorHandlers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// omitted</span>

<span class="w">    </span><span class="n">AccessDeniedHandlerImpl</span><span class="w"> </span><span class="n">defaultErrorHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AccessDeniedHandlerImpl</span><span class="p">();</span>
<span class="w">    </span><span class="n">defaultErrorHandler</span><span class="p">.</span><span class="na">setErrorPage</span><span class="p">(</span><span class="s">&quot;/WEB-INF/views/common/error/accessDeniedError.jsp&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// (1)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DelegatingAccessDeniedHandler</span><span class="p">(</span><span class="n">errorHandlers</span><span class="p">,</span><span class="w"> </span><span class="n">defaultErrorHandler</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">AccessDeniedHandler</span></code>をBean定義し、defaultHandlerに認可エラー用のエラーページを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div><div aria-labelledby="tab-12-VGh5bWVsZWFm" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-12-VGh5bWVsZWFm" name="VGh5bWVsZWFm" role="tabpanel" tabindex="0"><ul class="simple">
<li><p>SpringSecurityConfig.javaの定義例</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;accessDeniedHandler&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">AccessDeniedHandler</span><span class="w"> </span><span class="nf">accessDeniedHandler</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">LinkedHashMap</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AccessDeniedException</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">AccessDeniedHandler</span><span class="o">&gt;</span><span class="w"> </span><span class="n">errorHandlers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// omitted</span>

<span class="w">    </span><span class="n">AccessDeniedHandlerImpl</span><span class="w"> </span><span class="n">defaultErrorHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AccessDeniedHandlerImpl</span><span class="p">();</span>
<span class="w">    </span><span class="n">defaultErrorHandler</span><span class="p">.</span><span class="na">setErrorPage</span><span class="p">(</span><span class="s">&quot;/common/error/accessDeniedError&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// (1)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DelegatingAccessDeniedHandler</span><span class="p">(</span><span class="n">errorHandlers</span><span class="p">,</span><span class="w"> </span><span class="n">defaultErrorHandler</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">AccessDeniedHandler</span></code>をBean定義し、defaultHandlerに認可エラー用のエラーページを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></div>
</div><div aria-labelledby="tab-11-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-11-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-13-SlNQ" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-13-SlNQ" name="SlNQ" role="tab" tabindex="0">JSP</button><button aria-controls="panel-13-VGh5bWVsZWFm" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-13-VGh5bWVsZWFm" name="VGh5bWVsZWFm" role="tab" tabindex="-1">Thymeleaf</button></div><div aria-labelledby="tab-13-SlNQ" class="sphinx-tabs-panel group-tab" id="panel-13-SlNQ" name="SlNQ" role="tabpanel" tabindex="0"><ul class="simple">
<li><p>spring-security.xmlの定義例</p></li>
</ul>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">request-matcher=</span><span class="s">&quot;ant&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:access-denied-handler</span>
<span class="w">        </span><span class="na">error-page=</span><span class="s">&quot;/WEB-INF/views/common/error/accessDeniedError.jsp&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&lt;sec:access-denied-handler&gt;</span></code>タグの<code class="docutils literal notranslate"><span class="pre">error-page</span></code>属性に認可エラー用のエラーページを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div><div aria-labelledby="tab-13-VGh5bWVsZWFm" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-13-VGh5bWVsZWFm" name="VGh5bWVsZWFm" role="tabpanel" tabindex="0"><ul class="simple">
<li><p>spring-security.xmlの定義例</p></li>
</ul>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">request-matcher=</span><span class="s">&quot;ant&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:access-denied-handler</span>
<span class="w">        </span><span class="na">error-page=</span><span class="s">&quot;/common/error/accessDeniedError&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&lt;sec:access-denied-handler&gt;</span></code>タグの<code class="docutils literal notranslate"><span class="pre">error-page</span></code>属性に認可エラー用のエラーページを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></div>
</div></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><strong>サーブレットコンテナのエラーページ機能の利用</strong></p>
<p>認可エラーのエラーページは、サーブレットコンテナのエラーページ機能を使って指定することもできる。</p>
<p>サーブレットコンテナのエラーページ機能を使う場合は、<code class="docutils literal notranslate"><span class="pre">web.xml</span></code>の<code class="docutils literal notranslate"><span class="pre">&lt;error-page&gt;</span></code>タグを使用してエラーページを指定する。</p>
<blockquote>
<div><div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-14-SlNQ" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-14-SlNQ" name="SlNQ" role="tab" tabindex="0">JSP</button><button aria-controls="panel-14-VGh5bWVsZWFm" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-14-VGh5bWVsZWFm" name="VGh5bWVsZWFm" role="tab" tabindex="-1">Thymeleaf</button></div><div aria-labelledby="tab-14-SlNQ" class="sphinx-tabs-panel group-tab" id="panel-14-SlNQ" name="SlNQ" role="tabpanel" tabindex="0"><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;error-page&gt;</span>
<span class="w">    </span><span class="nt">&lt;error-code&gt;</span>403<span class="nt">&lt;/error-code&gt;</span>
<span class="w">    </span><span class="nt">&lt;location&gt;</span>/WEB-INF/views/common/error/accessDeniedError.jsp<span class="nt">&lt;/location&gt;</span>
<span class="nt">&lt;/error-page&gt;</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-14-VGh5bWVsZWFm" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-14-VGh5bWVsZWFm" name="VGh5bWVsZWFm" role="tabpanel" tabindex="0"><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;error-page&gt;</span>
<span class="w">    </span><span class="nt">&lt;error-code&gt;</span>403<span class="nt">&lt;/error-code&gt;</span>
<span class="w">    </span><span class="nt">&lt;location&gt;</span>/common/error/accessDeniedError<span class="nt">&lt;/location&gt;</span>
<span class="nt">&lt;/error-page&gt;</span>
</pre></div>
</div>
</div></div>
</div></blockquote>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
</section>
<section id="how-to-extend">
<h2><a class="toc-backref" href="#id77" role="doc-backlink"><span class="section-number">9.3.3. </span>How to extend</a><a class="headerlink" href="#how-to-extend" title="Permalink to this heading">¶</a></h2>
<p>本節では、Spring Securityが用意しているカスタマイズポイントや拡張方法について説明する。</p>
<div class="line-block">
<div class="line">Spring Securityは、多くのカスタマイズポイントを提供しているため、すべてのカスタマイズポイントは紹介しない。</div>
<div class="line">本節では代表的なカスタマイズポイントに絞って説明を行う。</div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="id26">
<h3><a class="toc-backref" href="#id78" role="doc-backlink"><span class="section-number">9.3.3.1. </span>認可エラー時のレスポンス (認証済みユーザー編)</a><a class="headerlink" href="#id26" title="Permalink to this heading">¶</a></h3>
<p>ここでは、認証済みユーザーからのアクセスを拒否した際の動作をカスタマイズする方法を説明する。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="springsecurityauthorizationaccessdeniedhandler">
<span id="id27"></span><h4><a class="toc-backref" href="#id79" role="doc-backlink"><span class="section-number">9.3.3.1.1. </span>AccessDeniedHandlerの適用</a><a class="headerlink" href="#springsecurityauthorizationaccessdeniedhandler" title="Permalink to this heading">¶</a></h4>
<p>Spring Securityが提供しているデフォルトの動作をカスタマイズする仕組みだけでは要件をみたせない場合は、<code class="docutils literal notranslate"><span class="pre">AccessDeniedHandler</span></code>インタフェースの実装クラスを直接適用することができる。</p>
<div class="line-block">
<div class="line">例えば、Ajaxのリクエスト(REST APIなど)で認可エラーが発生した場合は、エラーページ(HTML)ではなくJSON形式でエラー情報を応答することが求められるケースがある。</div>
<div class="line">そのような場合は、<code class="docutils literal notranslate"><span class="pre">AccessDeniedHandler</span></code>インタフェースの実装クラスを作成してSpring Securityに適用することで実現することができる。</div>
</div>
<ul class="simple">
<li><p>AccessDeniedHandlerインタフェースの実装クラスの作成例</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JsonDelegatingAccessDeniedHandler</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">AccessDeniedHandler</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">RequestMatcher</span><span class="w"> </span><span class="n">jsonRequestMatcher</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AccessDeniedHandler</span><span class="w"> </span><span class="n">delegateHandler</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">JsonDelegatingAccessDeniedHandler</span><span class="p">(</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">JsonDelegatingAccessDeniedHandler</span><span class="p">(</span>
<span class="w">            </span><span class="n">RequestMatcher</span><span class="w"> </span><span class="n">jsonRequestMatcher</span><span class="p">,</span><span class="w"> </span><span class="n">AccessDeniedHandler</span><span class="w"> </span><span class="n">delegateHandler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">jsonRequestMatcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jsonRequestMatcher</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">delegateHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">delegateHandler</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span>
<span class="w">                      </span><span class="n">AccessDeniedException</span><span class="w"> </span><span class="n">accessDeniedException</span><span class="p">)</span>
<span class="w">           </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ServletException</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">jsonRequestMatcher</span><span class="p">.</span><span class="na">matches</span><span class="p">(</span><span class="n">request</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">           </span><span class="c1">// response error information of JSON format</span>
<span class="w">           </span><span class="n">response</span><span class="p">.</span><span class="na">setStatus</span><span class="p">(</span><span class="n">HttpServletResponse</span><span class="p">.</span><span class="na">SC_FORBIDDEN</span><span class="p">);</span>
<span class="w">           </span><span class="c1">// omitted</span>
<span class="w">       </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">           </span><span class="c1">// response error page of HTML format</span>
<span class="w">           </span><span class="n">delegateHandler</span><span class="p">.</span><span class="na">handle</span><span class="p">(</span>
<span class="w">                   </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">accessDeniedException</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-15-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-15-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-15-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-15-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-15-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-15-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-16-SlNQ" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-16-SlNQ" name="SlNQ" role="tab" tabindex="0">JSP</button><button aria-controls="panel-16-VGh5bWVsZWFm" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-16-VGh5bWVsZWFm" name="VGh5bWVsZWFm" role="tab" tabindex="-1">Thymeleaf</button></div><div aria-labelledby="tab-16-SlNQ" class="sphinx-tabs-panel group-tab" id="panel-16-SlNQ" name="SlNQ" role="tabpanel" tabindex="0"><ul class="simple">
<li><p>SpringSecurityConfig.javaの定義例</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;accessDeniedHandler&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">JsonDelegatingAccessDeniedHandler</span><span class="w"> </span><span class="nf">accessDeniedHandler</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JsonDelegatingAccessDeniedHandler</span><span class="p">(</span><span class="n">accessAntPathRequestMatcher</span><span class="p">(),</span><span class="w"> </span><span class="n">accessDeniedHandler</span><span class="p">());</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="p">}</span>

<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;accessAntPathRequestMatcher&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">AntPathRequestMatcher</span><span class="w"> </span><span class="nf">accessAntPathRequestMatcher</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AntPathRequestMatcher</span><span class="p">(</span><span class="s">&quot;/api/**&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;accessDeniedHandler&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">AccessDeniedHandler</span><span class="w"> </span><span class="nf">accessDeniedHandler</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">AccessDeniedHandlerImpl</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AccessDeniedHandlerImpl</span><span class="p">();</span>
<span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">setErrorPage</span><span class="p">(</span><span class="s">&quot;/WEB-INF/views/common/error/accessDeniedError.jsp&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span>
<span class="p">}</span>

<span class="nd">@Bean</span>
<span class="kd">public</span><span class="w"> </span><span class="n">SecurityFilterChain</span><span class="w"> </span><span class="nf">filterChain1</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="n">http</span><span class="p">.</span><span class="na">exceptionHandling</span><span class="p">(</span><span class="n">exceptionHandling</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">exceptionHandling</span>
<span class="w">            </span><span class="p">.</span><span class="na">accessDeniedHandler</span><span class="p">(</span><span class="n">accessDeniedHandler</span><span class="p">()));</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">http</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>(1)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">AccessDeniedHandler</span></code>インタフェースの実装クラスをbean定義してDIコンテナに登録する。</p></td>
</tr>
<tr class="row-odd"><td><p>(2)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">HttpSecurity#exceptionHandling</span></code>に<code class="docutils literal notranslate"><span class="pre">AccessDeniedHandler</span></code>のbeanを指定する。</p></td>
</tr>
</tbody>
</table>
</div><div aria-labelledby="tab-16-VGh5bWVsZWFm" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-16-VGh5bWVsZWFm" name="VGh5bWVsZWFm" role="tabpanel" tabindex="0"><ul class="simple">
<li><p>SpringSecurityConfig.javaの定義例</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;accessDeniedHandler&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">JsonDelegatingAccessDeniedHandler</span><span class="w"> </span><span class="nf">accessDeniedHandler</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JsonDelegatingAccessDeniedHandler</span><span class="p">(</span><span class="n">accessAntPathRequestMatcher</span><span class="p">(),</span><span class="w"> </span><span class="n">accessDeniedHandler</span><span class="p">());</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="p">}</span>

<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;accessAntPathRequestMatcher&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">AntPathRequestMatcher</span><span class="w"> </span><span class="nf">accessAntPathRequestMatcher</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AntPathRequestMatcher</span><span class="p">(</span><span class="s">&quot;/api/**&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;accessDeniedHandler&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">AccessDeniedHandler</span><span class="w"> </span><span class="nf">accessDeniedHandler</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">AccessDeniedHandlerImpl</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AccessDeniedHandlerImpl</span><span class="p">();</span>
<span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">setErrorPage</span><span class="p">(</span><span class="s">&quot;/common/error/accessDeniedError&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span>
<span class="p">}</span>

<span class="nd">@Bean</span>
<span class="kd">public</span><span class="w"> </span><span class="n">SecurityFilterChain</span><span class="w"> </span><span class="nf">filterChain1</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="n">http</span><span class="p">.</span><span class="na">exceptionHandling</span><span class="p">(</span><span class="n">exceptionHandling</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">exceptionHandling</span>
<span class="w">            </span><span class="p">.</span><span class="na">accessDeniedHandler</span><span class="p">(</span><span class="n">accessDeniedHandler</span><span class="p">()));</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">http</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>(1)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">AccessDeniedHandler</span></code>インタフェースの実装クラスをbean定義してDIコンテナに登録する。</p></td>
</tr>
<tr class="row-odd"><td><p>(2)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">HttpSecurity#exceptionHandling</span></code>に<code class="docutils literal notranslate"><span class="pre">AccessDeniedHandler</span></code>のbeanを指定する。</p></td>
</tr>
</tbody>
</table>
</div></div>
</div><div aria-labelledby="tab-15-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-15-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-17-SlNQ" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-17-SlNQ" name="SlNQ" role="tab" tabindex="0">JSP</button><button aria-controls="panel-17-VGh5bWVsZWFm" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-17-VGh5bWVsZWFm" name="VGh5bWVsZWFm" role="tab" tabindex="-1">Thymeleaf</button></div><div aria-labelledby="tab-17-SlNQ" class="sphinx-tabs-panel group-tab" id="panel-17-SlNQ" name="SlNQ" role="tabpanel" tabindex="0"><ul class="simple">
<li><p>spring-security.xmlの定義例</p></li>
</ul>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;accessDeniedHandler&quot;</span>
<span class="w">      </span><span class="na">class=</span><span class="s">&quot;com.example.web.security.JsonDelegatingAccessDeniedHandler&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;constructor-arg&gt;</span>
<span class="w">        </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.util.matcher.AntPathRequestMatcher&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;/api/**&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/bean&gt;</span>
<span class="w">    </span><span class="nt">&lt;/constructor-arg&gt;</span>
<span class="w">    </span><span class="nt">&lt;constructor-arg&gt;</span>
<span class="w">        </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.access.AccessDeniedHandlerImpl&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;errorPage&quot;</span>
<span class="w">                      </span><span class="na">value=</span><span class="s">&quot;/WEB-INF/views/common/error/accessDeniedError.jsp&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/bean&gt;</span>
<span class="w">    </span><span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">request-matcher=</span><span class="s">&quot;ant&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:access-denied-handler</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;accessDeniedHandler&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>(1)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">AccessDeniedHandler</span></code>インタフェースの実装クラスをbean定義してDIコンテナに登録する。</p></td>
</tr>
<tr class="row-odd"><td><p>(2)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&lt;sec:access-denied-handler&gt;</span></code>タグの<code class="docutils literal notranslate"><span class="pre">ref</span></code>属性に<code class="docutils literal notranslate"><span class="pre">AccessDeniedHandler</span></code>のbeanを指定する。</p></td>
</tr>
</tbody>
</table>
</div><div aria-labelledby="tab-17-VGh5bWVsZWFm" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-17-VGh5bWVsZWFm" name="VGh5bWVsZWFm" role="tabpanel" tabindex="0"><ul class="simple">
<li><p>spring-security.xmlの定義例</p></li>
</ul>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;accessDeniedHandler&quot;</span>
<span class="w">      </span><span class="na">class=</span><span class="s">&quot;com.example.web.security.JsonDelegatingAccessDeniedHandler&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;constructor-arg&gt;</span>
<span class="w">        </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.util.matcher.AntPathRequestMatcher&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;/api/**&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/bean&gt;</span>
<span class="w">    </span><span class="nt">&lt;/constructor-arg&gt;</span>
<span class="w">    </span><span class="nt">&lt;constructor-arg&gt;</span>
<span class="w">        </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.access.AccessDeniedHandlerImpl&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;errorPage&quot;</span>
<span class="w">                      </span><span class="na">value=</span><span class="s">&quot;/common/error/accessDeniedError&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/bean&gt;</span>
<span class="w">    </span><span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">request-matcher=</span><span class="s">&quot;ant&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:access-denied-handler</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;accessDeniedHandler&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>(1)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">AccessDeniedHandler</span></code>インタフェースの実装クラスをbean定義してDIコンテナに登録する。</p></td>
</tr>
<tr class="row-odd"><td><p>(2)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&lt;sec:access-denied-handler&gt;</span></code>タグの<code class="docutils literal notranslate"><span class="pre">ref</span></code>属性に<code class="docutils literal notranslate"><span class="pre">AccessDeniedHandler</span></code>のbeanを指定する。</p></td>
</tr>
</tbody>
</table>
</div></div>
</div></div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="id28">
<h3><a class="toc-backref" href="#id80" role="doc-backlink"><span class="section-number">9.3.3.2. </span>認可エラー時のレスポンス (未認証ユーザー編)</a><a class="headerlink" href="#id28" title="Permalink to this heading">¶</a></h3>
<p>ここでは、未認証ユーザーからのアクセスを拒否した際の動作をカスタマイズする方法を説明する。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="id29">
<h4><a class="toc-backref" href="#id81" role="doc-backlink"><span class="section-number">9.3.3.2.1. </span>リクエスト毎にAuthenticationEntryPointを適用</a><a class="headerlink" href="#id29" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">認証済みユーザーと同様に、Ajaxのリクエスト(REST APIなど)で認可エラーが発生した場合は、ログインページ(HTML)ではなくJSON形式でエラー情報を応答することが求められるケースがある。</div>
<div class="line">そのような場合は、リクエストのパターン毎に<code class="docutils literal notranslate"><span class="pre">AuthenticationEntryPoint</span></code>インタフェースの実装クラスをSpring Securityに適用することで実現することができる。</div>
</div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-18-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-18-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-18-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-18-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-18-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-18-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><ul class="simple">
<li><p>SpringSecurityConfig.javaの定義例</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;authenticationEntryPoint&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">DelegatingAuthenticationEntryPoint</span><span class="w"> </span><span class="nf">authenticationEntryPoint</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">LinkedHashMap</span><span class="o">&lt;</span><span class="n">RequestMatcher</span><span class="p">,</span><span class="w"> </span><span class="n">AuthenticationEntryPoint</span><span class="o">&gt;</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">antPathRequestMatcher</span><span class="p">(),</span><span class="w"> </span><span class="n">entryPoint</span><span class="p">());</span>
<span class="w">    </span><span class="n">DelegatingAuthenticationEntryPoint</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DelegatingAuthenticationEntryPoint</span><span class="p">(</span><span class="n">map</span><span class="p">);</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">setDefaultEntryPoint</span><span class="p">(</span><span class="n">defaultEntryPoint</span><span class="p">());</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span>
<span class="p">}</span>

<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;antPathRequestMatcher&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">AntPathRequestMatcher</span><span class="w"> </span><span class="nf">antPathRequestMatcher</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AntPathRequestMatcher</span><span class="p">(</span><span class="s">&quot;/api/**&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;entryPoint&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">JsonAuthenticationEntryPoint</span><span class="w"> </span><span class="nf">entryPoint</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JsonAuthenticationEntryPoint</span><span class="p">();</span>
<span class="p">}</span>

<span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;defaultEntryPoint&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">LoginUrlAuthenticationEntryPoint</span><span class="w"> </span><span class="nf">defaultEntryPoint</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LoginUrlAuthenticationEntryPoint</span><span class="p">(</span><span class="s">&quot;/login&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nd">@Bean</span>
<span class="kd">public</span><span class="w"> </span><span class="n">SecurityFilterChain</span><span class="w"> </span><span class="nf">filterChain</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="n">http</span><span class="p">.</span><span class="na">exceptionHandling</span><span class="p">(</span><span class="n">exceptionHandling</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">exceptionHandling</span>
<span class="w">            </span><span class="p">.</span><span class="na">authenticationEntryPoint</span><span class="p">(</span><span class="n">authenticationEntryPoint</span><span class="p">()));</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">http</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">AuthenticationEntryPoint</span></code>インタフェースの実装クラスをbean定義してDIコンテナに登録する。</div>
<div class="line">ここでは、Spring Securityが提供している<code class="docutils literal notranslate"><span class="pre">DelegatingAuthenticationEntryPoint</span></code>クラスを利用して、リクエストのパターン毎に<code class="docutils literal notranslate"><span class="pre">AuthenticationEntryPoint</span></code>インタフェースの実装クラスを適用している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">HttpSecurity#exceptionHandling</span></code>に<code class="docutils literal notranslate"><span class="pre">AuthenticationEntryPoint</span></code>のbeanを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div><div aria-labelledby="tab-18-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-18-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><ul class="simple">
<li><p>spring-security.xmlの定義例</p></li>
</ul>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;authenticationEntryPoint&quot;</span>
<span class="w">      </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.DelegatingAuthenticationEntryPoint&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;constructor-arg&gt;</span>
<span class="w">        </span><span class="nt">&lt;map&gt;</span>
<span class="w">            </span><span class="nt">&lt;entry&gt;</span>
<span class="w">                </span><span class="nt">&lt;key&gt;</span>
<span class="w">                    </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.util.matcher.AntPathRequestMatcher&quot;</span><span class="nt">&gt;</span>
<span class="w">                        </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;/api/**&quot;</span><span class="nt">/&gt;</span>
<span class="w">                    </span><span class="nt">&lt;/bean&gt;</span>
<span class="w">                </span><span class="nt">&lt;/key&gt;</span>
<span class="w">                </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;com.example.web.security.JsonAuthenticationEntryPoint&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;/entry&gt;</span>
<span class="w">        </span><span class="nt">&lt;/map&gt;</span>
<span class="w">    </span><span class="nt">&lt;/constructor-arg&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;defaultEntryPoint&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;/login&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/bean&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">request-matcher=</span><span class="s">&quot;ant&quot;</span><span class="w"> </span><span class="na">entry-point-ref=</span><span class="s">&quot;authenticationEntryPoint&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">AuthenticationEntryPoint</span></code>インタフェースの実装クラスをbean定義してDIコンテナに登録する。</div>
<div class="line">ここでは、Spring Securityが提供している<code class="docutils literal notranslate"><span class="pre">DelegatingAuthenticationEntryPoint</span></code>クラスを利用して、リクエストのパターン毎に<code class="docutils literal notranslate"><span class="pre">AuthenticationEntryPoint</span></code>インタフェースの実装クラスを適用している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&lt;sec:http&gt;</span></code>タグの<code class="docutils literal notranslate"><span class="pre">entry-point-ref</span></code>属性に<code class="docutils literal notranslate"><span class="pre">AuthenticationEntryPoint</span></code>のbeanを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>デフォルトで適用されるAuthenticationEntryPoint</strong></p>
<p>リクエストに対応する<code class="docutils literal notranslate"><span class="pre">AuthenticationEntryPoint</span></code>インタフェースの実装クラスの指定がない場合は、Spring Securityがデフォルトで定義する<code class="docutils literal notranslate"><span class="pre">AuthenticationEntryPoint</span></code>インタフェースの実装クラスが使用される仕組みになっている。</p>
<p>認証方式としてフォーム認証を使用する場合は、<code class="docutils literal notranslate"><span class="pre">LoginUrlAuthenticationEntryPoint</span></code>クラスが使用されログインフォームが表示される。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="id30">
<h3><a class="toc-backref" href="#id82" role="doc-backlink"><span class="section-number">9.3.3.3. </span>ロールの階層化</a><a class="headerlink" href="#id30" title="Permalink to this heading">¶</a></h3>
<p>認可処理では、ロールに階層関係を設けることができる。</p>
<div class="line-block">
<div class="line">上位に指定したロールは、下位のロールにアクセスが許可されているリソースにもアクセスすることができる。</div>
<div class="line">ロールの関係が複雑な場合は、階層関係も設けることも検討されたい。</div>
</div>
<div class="line-block">
<div class="line">例えば、「ROLE_ADMIN」が上位ロール、「ROLE_USER」が下位ロールという階層関係を設けた場合、下記のようアクセスポリシーを設定すると、「ROLE_ADMIN」権限を持つユーザーは、<code class="docutils literal notranslate"><span class="pre">/user</span></code>配下のパス(「ROLE_USER」権限を持つユーザーがアクセスできるパス)にアクセスすることができる。</div>
</div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-19-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-19-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-19-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-19-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-19-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-19-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><ul class="simple">
<li><p>SpringSecurityConfig.javaの定義例</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span>
<span class="kd">public</span><span class="w"> </span><span class="n">SecurityFilterChain</span><span class="w"> </span><span class="nf">filterChain</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="n">http</span><span class="p">.</span><span class="na">authorizeHttpRequests</span><span class="p">(</span><span class="n">authz</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">authz</span>
<span class="w">            </span><span class="p">.</span><span class="na">requestMatchers</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">AntPathRequestMatcher</span><span class="p">(</span><span class="s">&quot;/user/**&quot;</span><span class="p">)).</span><span class="na">hasAnyRole</span><span class="p">(</span><span class="s">&quot;USER&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="c1">// omitted</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">http</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-19-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-19-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><ul class="simple">
<li><p>spring-security.xmlの定義例</p></li>
</ul>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">request-matcher=</span><span class="s">&quot;ant&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:intercept-url</span><span class="w"> </span><span class="na">pattern=</span><span class="s">&quot;/user/**&quot;</span><span class="w"> </span><span class="na">access=</span><span class="s">&quot;hasAnyRole(&#39;USER&#39;)&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
</div></div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="id31">
<h4><a class="toc-backref" href="#id83" role="doc-backlink"><span class="section-number">9.3.3.3.1. </span>階層関係の設定</a><a class="headerlink" href="#id31" title="Permalink to this heading">¶</a></h4>
<p>ロールの階層関係は、<code class="docutils literal notranslate"><span class="pre">org.springframework.security.access.hierarchicalroles.RoleHierarchy</span></code>インタフェースの実装クラスで解決する。</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-20-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-20-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-20-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-20-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-20-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-20-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><ul class="simple">
<li><p>SpringSecurityConfig.javaの定義例</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;roleHierarchy&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">RoleHierarchy</span><span class="w"> </span><span class="nf">roleHierarchy</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">RoleHierarchyImpl</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RoleHierarchyImpl</span><span class="p">();</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">setHierarchy</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">            ROLE_ADMIN &gt; ROLE_STAFF</span>
<span class="s">            ROLE_STAFF &gt; ROLE_USER</span>
<span class="s">            &quot;&quot;&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.security.access.hierarchicalroles.RoleHierarchyImpl</span></code>クラスを指定する。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">RoleHierarchyImpl</span></code>は、Spring Securityが提供するデフォルトの実装クラスである。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">hierarchy</span></code>プロパティに階層関係を定義する。</div>
<div class="line"><br /></div>
<div class="line">書式: [上位ロール] &gt; [下位ロール]</div>
<div class="line"><br /></div>
<div class="line">上記例では、</div>
<div class="line">STAFFは、USERに認可されたリソースにもアクセス可能である。</div>
<div class="line">ADMINは、USERとSTAFFに認可されたリソースにもアクセス可能である。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div><div aria-labelledby="tab-20-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-20-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><ul class="simple">
<li><p>spring-security.xmlの定義例</p></li>
</ul>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;roleHierarchy&quot;</span>
<span class="w">    </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.access.hierarchicalroles.RoleHierarchyImpl&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;hierarchy&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">        </span><span class="nt">&lt;value&gt;</span>
<span class="w">            </span>ROLE_ADMIN<span class="w"> </span>&gt;<span class="w"> </span>ROLE_STAFF
<span class="w">            </span>ROLE_STAFF<span class="w"> </span>&gt;<span class="w"> </span>ROLE_USER
<span class="w">        </span><span class="nt">&lt;/value&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.security.access.hierarchicalroles.RoleHierarchyImpl</span></code>クラスを指定する。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">RoleHierarchyImpl</span></code>は、Spring Securityが提供するデフォルトの実装クラスである。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">hierarchy</span></code>プロパティに階層関係を定義する。</div>
<div class="line"><br /></div>
<div class="line">書式: [上位ロール] &gt; [下位ロール]</div>
<div class="line"><br /></div>
<div class="line">上記例では、</div>
<div class="line">STAFFは、USERに認可されたリソースにもアクセス可能である。</div>
<div class="line">ADMINは、USERとSTAFFに認可されたリソースにもアクセス可能である。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id32">
<h4><a class="toc-backref" href="#id84" role="doc-backlink"><span class="section-number">9.3.3.3.2. </span>Webリソースの認可処理への適用</a><a class="headerlink" href="#id32" title="Permalink to this heading">¶</a></h4>
<p>ロールの階層化を、Webリソースと画面項目に対する認可処理に適用する方法を説明する。</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-21-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-21-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-21-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-21-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-21-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-21-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><ul class="simple">
<li><p>SpringSecurityConfig.javaの定義例</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span>
<span class="nd">@Order</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">SecurityFilterChain</span><span class="w"> </span><span class="nf">filterChain</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">AuthorityAuthorizationManager</span><span class="o">&lt;</span><span class="n">RequestAuthorizationContext</span><span class="o">&gt;</span><span class="w"> </span><span class="n">authManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AuthorityAuthorizationManager</span><span class="p">.</span><span class="na">hasRole</span><span class="p">(</span><span class="s">&quot;STAFF&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">authManager</span><span class="p">.</span><span class="na">setRoleHierarchy</span><span class="p">(</span><span class="n">roleHierarchy</span><span class="p">());</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="n">http</span><span class="p">.</span><span class="na">authorizeHttpRequests</span><span class="p">(</span><span class="n">authz</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">authz</span>
<span class="w">            </span><span class="p">.</span><span class="na">requestMatchers</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">AntPathRequestMatcher</span><span class="p">(</span><span class="s">&quot;/user/**&quot;</span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="na">access</span><span class="p">(</span><span class="n">authManager</span><span class="p">)</span><span class="w"> </span><span class="c1">//(2)</span>
<span class="w">            </span><span class="c1">// omitted</span>
<span class="w">            </span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">http</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.security.authorization.AuthorityAuthorizationManager</span></code>のインスタンスを生成し、<code class="docutils literal notranslate"><span class="pre">roleHierarchy</span></code>プロパティに<code class="docutils literal notranslate"><span class="pre">RoleHierarchy</span></code>インタフェースの実装クラスのBeanを指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">(1)で生成した<code class="docutils literal notranslate"><span class="pre">AuthorizationManager</span></code>を<code class="docutils literal notranslate"><span class="pre">access</span></code>メソッドで設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div><div aria-labelledby="tab-21-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-21-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><ul class="simple">
<li><p>spring-security.xmlの定義例</p></li>
</ul>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;webExpressionHandler&quot;</span>
<span class="w">    </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.access.expression.DefaultWebSecurityExpressionHandler&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;roleHierarchy&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;roleHierarchy&quot;</span><span class="nt">/&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">request-matcher=</span><span class="s">&quot;ant&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:expression-handler</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;webExpressionHandler&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.security.web.access.expression.DefaultWebSecurityExpressionHandler</span></code>のBeanを定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">roleHierarchy</span></code>プロパティに<code class="docutils literal notranslate"><span class="pre">RoleHierarchy</span></code>インタフェースの実装クラスのBeanを指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&lt;sec:expression-handler&gt;</span></code>タグの<code class="docutils literal notranslate"><span class="pre">ref</span></code>属性に、<code class="docutils literal notranslate"><span class="pre">org.springframework.security.access.expression.SecurityExpressionHandler</span></code>インタフェースの実装クラスのBeanを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id33">
<h4><a class="toc-backref" href="#id85" role="doc-backlink"><span class="section-number">9.3.3.3.3. </span>メソッドの認可処理への適用</a><a class="headerlink" href="#id33" title="Permalink to this heading">¶</a></h4>
<p>ロールの階層化を、Javaメソッドに対する認可処理に適用する方法を説明する。</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-22-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-22-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-22-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-22-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-22-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-22-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><ul class="simple">
<li><p>SpringSecurityConfig.javaの定義例</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@EnableMethodSecurity</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SpringSecurityConfig</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="c1">// (3)</span>
<span class="w">    </span><span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;methodExpressionHandler&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">MethodSecurityExpressionHandler</span><span class="w"> </span><span class="nf">methodExpressionHandler</span><span class="p">(</span>
<span class="w">            </span><span class="n">RoleHierarchy</span><span class="w"> </span><span class="n">roleHierarchy</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">DefaultMethodSecurityExpressionHandler</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DefaultMethodSecurityExpressionHandler</span><span class="p">();</span><span class="w">  </span><span class="c1">// (1)</span>
<span class="w">        </span><span class="n">bean</span><span class="p">.</span><span class="na">setRoleHierarchy</span><span class="p">(</span><span class="n">roleHierarchy</span><span class="p">);</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.security.access.expression.method.DefaultMethodSecurityExpressionHandler</span></code>のBeanをstatic定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">roleHierarchy</span></code>プロパティに<code class="docutils literal notranslate"><span class="pre">RoleHierarchy</span></code>インタフェースの実装クラスのBeanを指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&#64;EnableMethodSecurity</span></code>アノテーションを設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div><div aria-labelledby="tab-22-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-22-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><ul class="simple">
<li><p>spring-security.xmlの定義例</p></li>
</ul>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;methodExpressionHandler&quot;</span>
<span class="w">    </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.access.expression.method.DefaultMethodSecurityExpressionHandler&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;roleHierarchy&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;roleHierarchy&quot;</span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;sec:method-security&gt;</span>
<span class="w">  </span><span class="nt">&lt;sec:expression-handler</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;methodExpressionHandler&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/sec:method-security&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.security.access.expression.method.DefaultMethodSecurityExpressionHandler</span></code>のBeanを定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">roleHierarchy</span></code>プロパティに<code class="docutils literal notranslate"><span class="pre">RoleHierarchy</span></code>インタフェースの実装クラスのBeanを指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&lt;sec:method-security&gt;</span></code>タグの<code class="docutils literal notranslate"><span class="pre">ref</span></code>属性に、<code class="docutils literal notranslate"><span class="pre">org.springframework.security.access.expression.SecurityExpressionHandler</span></code>インタフェースの実装クラスのBeanを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
</section>
<section id="appendix">
<h2><a class="toc-backref" href="#id86" role="doc-backlink"><span class="section-number">9.3.4. </span>Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this heading">¶</a></h2>
<section id="spring-security">
<span id="authoziation-expansion-of-path-pattern-match"></span><h3><a class="toc-backref" href="#id87" role="doc-backlink"><span class="section-number">9.3.4.1. </span>Spring Securityのパスパターンマッチングにおける拡張子および末尾<code class="docutils literal notranslate"><span class="pre">/</span></code>の考慮</a><a class="headerlink" href="#spring-security" title="Permalink to this heading">¶</a></h3>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-23-SmF2YSBDb25maWc=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-23-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tab" tabindex="0">Java Config</button><button aria-controls="panel-23-WE1MIENvbmZpZw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-23-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tab" tabindex="-1">XML Config</button></div><div aria-labelledby="tab-23-SmF2YSBDb25maWc=" class="sphinx-tabs-panel group-tab" id="panel-23-SmF2YSBDb25maWc=" name="SmF2YSBDb25maWc=" role="tabpanel" tabindex="0"><div class="line-block">
<div class="line"><a class="reference internal" href="../ImplementationAtEachLayer/ApplicationLayer.html#applicationlayer-expansion-of-path-pattern-match"><span class="std std-ref">Spring MVCのパスパターンマッチングにおける拡張子および末尾/の考慮</span></a>に記載している方法でパスパターンマッチを拡張している場合、<code class="docutils literal notranslate"><span class="pre">RequestMatcher</span></code>オブジェクトの設定が不足していると認可処理を行わずにアクセス出来てしまう。</div>
<div class="line">パスパターンマッチの拡張箇所をカバーできるように、<code class="docutils literal notranslate"><span class="pre">RequestMatcher</span></code>の引数に”<code class="docutils literal notranslate"><span class="pre">*</span></code>“や<code class="docutils literal notranslate"><span class="pre">**</span></code>などのワイルドカード指定を含めている場合は問題とはならないが、そうでない場合は<code class="docutils literal notranslate"><span class="pre">RequestMatcher</span></code>の引数に対して個別に考慮する必要がある。</div>
</div>
<div class="line-block">
<div class="line">下記の設定例は、<code class="docutils literal notranslate"><span class="pre">/restrict</span></code>に対して「ROLE_ADMIN」ロールを持つユーザからのアクセスのみを許可している。</div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span>
<span class="kd">public</span><span class="w"> </span><span class="n">SecurityFilterChain</span><span class="w"> </span><span class="nf">filterChain</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="n">http</span><span class="p">.</span><span class="na">authorizeHttpRequests</span><span class="p">(</span><span class="n">authz</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">authz</span>
<span class="w">            </span><span class="p">.</span><span class="na">requestMatchers</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">AntPathRequestMatcher</span><span class="p">(</span><span class="s">&quot;/restrict.*&quot;</span><span class="p">)).</span><span class="na">hasRole</span><span class="p">(</span><span class="s">&quot;ADMIN&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">            </span><span class="p">.</span><span class="na">requestMatchers</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">AntPathRequestMatcher</span><span class="p">(</span><span class="s">&quot;/restrict/&quot;</span><span class="p">)).</span><span class="na">hasRole</span><span class="p">(</span><span class="s">&quot;ADMIN&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">            </span><span class="p">.</span><span class="na">requestMatchers</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">AntPathRequestMatcher</span><span class="p">(</span><span class="s">&quot;/restrict&quot;</span><span class="p">)).</span><span class="na">hasRole</span><span class="p">(</span><span class="s">&quot;ADMIN&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">http</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 20.0%" />
<col style="width: 80.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">/restrict</span></code>に拡張子を付けたパターン(<code class="docutils literal notranslate"><span class="pre">/restrict.json</span></code>など)のアクセスポリシーを定義する。</div>
<div class="line">個別に拡張子を許容している場合または<code class="docutils literal notranslate"><span class="pre">PathMatchConfigurer#setUseSuffixPatternMatch(true)</span></code>を設定している場合は必須。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">/restrict</span></code>の末尾に”<code class="docutils literal notranslate"><span class="pre">/</span></code>“を付けたパターン(<code class="docutils literal notranslate"><span class="pre">/restrict/</span></code>)のアクセスポリシーを定義する。</div>
<div class="line">個別に末尾の”<code class="docutils literal notranslate"><span class="pre">/</span></code>を許容している場合または<code class="docutils literal notranslate"><span class="pre">PathMatchConfigurer#setUseSuffixPatternMatch(true)</span></code>を設定している場合は必須。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">/restrict</span></code>に対するアクセスポリシーを定義する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div><div aria-labelledby="tab-23-WE1MIENvbmZpZw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-23-WE1MIENvbmZpZw==" name="WE1MIENvbmZpZw==" role="tabpanel" tabindex="0"><div class="line-block">
<div class="line"><a class="reference internal" href="../ImplementationAtEachLayer/ApplicationLayer.html#applicationlayer-expansion-of-path-pattern-match"><span class="std std-ref">Spring MVCのパスパターンマッチングにおける拡張子および末尾/の考慮</span></a>に記載している方法でパスパターンマッチを拡張している場合、<code class="docutils literal notranslate"><span class="pre">sec:intercept-url</span></code>の<code class="docutils literal notranslate"><span class="pre">pattern</span></code>属性の設定が不足していると認可処理を行わずにアクセス出来てしまう。</div>
<div class="line">パスパターンマッチの拡張箇所をカバーできるように、<code class="docutils literal notranslate"><span class="pre">sec:intercept-url</span></code>の<code class="docutils literal notranslate"><span class="pre">pattern</span></code>属性に”<code class="docutils literal notranslate"><span class="pre">*</span></code>“や<code class="docutils literal notranslate"><span class="pre">**</span></code>などのワイルドカード指定を含めている場合は問題とはならないが、そうでない場合は<code class="docutils literal notranslate"><span class="pre">sec:intercept-url</span></code>の<code class="docutils literal notranslate"><span class="pre">pattern</span></code>属性に対して個別に考慮する必要がある。</div>
</div>
<div class="line-block">
<div class="line">下記の設定例は、<code class="docutils literal notranslate"><span class="pre">/restrict</span></code>に対して「ROLE_ADMIN」ロールを持つユーザからのアクセスのみを許可している。</div>
</div>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">request-matcher=</span><span class="s">&quot;ant&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:intercept-url</span><span class="w"> </span><span class="na">pattern=</span><span class="s">&quot;/restrict.*&quot;</span><span class="w"> </span><span class="na">access=</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;)&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:intercept-url</span><span class="w"> </span><span class="na">pattern=</span><span class="s">&quot;/restrict/&quot;</span><span class="w"> </span><span class="na">access=</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;)&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;sec:intercept-url</span><span class="w"> </span><span class="na">pattern=</span><span class="s">&quot;/restrict&quot;</span><span class="w"> </span><span class="na">access=</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;)&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 20.0%" />
<col style="width: 80.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">/restrict</span></code>に拡張子を付けたパターン(<code class="docutils literal notranslate"><span class="pre">/restrict.json</span></code>など)のアクセスポリシーを定義する。</div>
<div class="line">個別に拡張子を許容している場合または<code class="docutils literal notranslate"><span class="pre">suffix-pattern=&quot;true&quot;</span></code>を設定している場合は必須。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">/restrict</span></code>の末尾に”<code class="docutils literal notranslate"><span class="pre">/</span></code>“を付けたパターン(<code class="docutils literal notranslate"><span class="pre">/restrict/</span></code>)のアクセスポリシーを定義する。</div>
<div class="line">個別に末尾の”<code class="docutils literal notranslate"><span class="pre">/</span></code>を許容している場合または<code class="docutils literal notranslate"><span class="pre">trailing-slash=&quot;true&quot;</span></code>を設定している場合は必須。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">/restrict</span></code>に対するアクセスポリシーを定義する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></div>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="SessionManagement.html" title="9.4. セッション管理"
             >next</a> |</li>
        <li class="right" >
          <a href="Authentication.html" title="9.2. 認証"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.9.0.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" ><span class="section-number">9. </span>セキュリティ対策</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">9.3. </span>認可</a></li> 
      </ul>
    </div>
    <div class="footer">
      © Copyright 2024, NTT DATA Group Corporation. © Copyright 2013, NTT Corporation.
      Created using <a href="https://www.sphinx-doc.org/en/master/">Sphinx</a> 7.0.1.Theme is <a href="https://pypi.org/project/solar-theme/">Solar</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    </script>
  </body>
</html>
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>5.16. RESTful Web Service &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.1.0.RELEASE documentation</title>
    <link rel="stylesheet" href="../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '5.1.0.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5.17. RESTクライアント（HTTPクライアント）" href="RestClient.html" />
    <link rel="prev" title="5.15. Ajax" href="Ajax.html" /><script async src="https://www.googletagmanager.com/gtag/js?id=G-847V2Q99G8"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date()); gtag('config', 'G-847V2Q99G8');
</script>
<script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="RestClient.html" title="5.17. RESTクライアント（HTTPクライアント）"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Ajax.html" title="5.15. Ajax"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.1.0.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">5. TERASOLUNA Server Framework for Java (5.x)の機能詳細</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">5.16. RESTful Web Service</a><ul>
<li><a class="reference internal" href="#overview">5.16.1. Overview</a><ul>
<li><a class="reference internal" href="#restoverviewaboutrestfulwebservice">5.16.1.1. RESTful Web Serviceとは</a></li>
<li><a class="reference internal" href="#restoverviewaboutrestfulwebservicedevelopment">5.16.1.2. RESTful Web Serviceの開発について</a><ul>
<li><a class="reference internal" href="#id4">5.16.1.2.1. RESTful Web Serviceのモジュールの構成</a></li>
<li><a class="reference internal" href="#rest-api">5.16.1.2.2. REST APIの実装サンプル</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#architecture">5.16.2. Architecture</a><ul>
<li><a class="reference internal" href="#web">5.16.2.1. Web上のリソースとして公開</a></li>
<li><a class="reference internal" href="#uri">5.16.2.2. URIによるリソースの識別</a></li>
<li><a class="reference internal" href="#http">5.16.2.3. HTTPメソッドによるリソースの操作</a></li>
<li><a class="reference internal" href="#restoverviewresourcerepresentationformat">5.16.2.4. 適切なフォーマットの使用</a></li>
<li><a class="reference internal" href="#restoverviewhttpstatuscode">5.16.2.5. 適切なHTTPステータスコードの使用</a></li>
<li><a class="reference internal" href="#restoverviewclientservercommunicateonstateless">5.16.2.6. ステートレスなクライアント/サーバ間の通信</a></li>
<li><a class="reference internal" href="#restoverviewhypermedialinkstorelatedresources">5.16.2.7. 関連のあるリソースへのリンク</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-design">5.16.3. How to design</a><ul>
<li><a class="reference internal" href="#resthowtodesignextractresource">5.16.3.1. リソースの抽出</a></li>
<li><a class="reference internal" href="#resthowtodesignassignuri">5.16.3.2. URIの割り当て</a><ul>
<li><a class="reference internal" href="#rest-apiuri">5.16.3.2.1. REST APIであることを示すためのURIの割り当て</a></li>
<li><a class="reference internal" href="#apiuri">5.16.3.2.2. APIバージョンを識別するためのURIの割り当て</a></li>
<li><a class="reference internal" href="#resthowtodesignassignuriforresource">5.16.3.2.3. リソースを識別するためのパスの割り当て</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resthowtodesignassignhttpmethod">5.16.3.3. HTTPメソッドの割り当て</a><ul>
<li><a class="reference internal" href="#urihttp">5.16.3.3.1. リソースコレクションのURIに対するHTTPメソッドの割り当て</a></li>
<li><a class="reference internal" href="#resthowtodesignassignhttpmethodforspecifiedresource">5.16.3.3.2. 特定リソースのURIに対するHTTPメソッドの割り当て</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resthowtodesignresourcerepresentationformat">5.16.3.4. リソースのフォーマット</a><ul>
<li><a class="reference internal" href="#json">5.16.3.4.1. JSONのフィールド名</a></li>
<li><a class="reference internal" href="#null">5.16.3.4.2. NULLとブランク文字</a></li>
<li><a class="reference internal" href="#id15">5.16.3.4.3. 日時のフォーマット</a></li>
<li><a class="reference internal" href="#id16">5.16.3.4.4. パイパーメディアリンクの形式</a></li>
<li><a class="reference internal" href="#id17">5.16.3.4.5. エラー応答時のフォーマット</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resthowtodesignhttpstatuscode">5.16.3.5. HTTPステータスコード</a><ul>
<li><a class="reference internal" href="#resthowtodesignhttpstatuscodeforsuccess">5.16.3.5.1. リクエストが成功した場合のHTTPステータスコード</a></li>
<li><a class="reference internal" href="#resthowtodesignhttpstatuscodeforclienterror">5.16.3.5.2. リクエストが失敗した原因がクライアント側にある場合のHTTPステータスコード</a></li>
<li><a class="reference internal" href="#resthowtodesignhttpstatuscodeforservererror">5.16.3.5.3. リクエストが失敗した原因がサーバ側にある場合のHTTPステータスコード</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id22">5.16.3.6. 認証・認可</a></li>
<li><a class="reference internal" href="#id23">5.16.3.7. リソースの条件付き更新の制御</a></li>
<li><a class="reference internal" href="#id24">5.16.3.8. リソースの条件付き取得の制御</a></li>
<li><a class="reference internal" href="#id25">5.16.3.9. リソースのキャッシュ制御</a></li>
<li><a class="reference internal" href="#id26">5.16.3.10. バージョニング</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">5.16.4. How to use</a><ul>
<li><a class="reference internal" href="#resthowtousewebapplicationconstruction">5.16.4.1. Webアプリケーションの構成</a></li>
<li><a class="reference internal" href="#resthowtouseapplicationsettings">5.16.4.2. アプリケーションの設定</a><ul>
<li><a class="reference internal" href="#restful-web-servicespring-mvc">5.16.4.2.1. RESTful Web Serviceで必要となるSpring MVCのコンポーネントを有効化するための設定</a></li>
<li><a class="reference internal" href="#resthowtouseapplicationsettingsofdispatcherservlet">5.16.4.2.2. RESTful Web Service用のサーブレットの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resthowtouseapiimplementation">5.16.4.3. REST APIの実装</a><ul>
<li><a class="reference internal" href="#resthowtousepackage">5.16.4.3.1. REST API用パッケージの作成</a></li>
<li><a class="reference internal" href="#resource">5.16.4.3.2. Resourceクラスの作成</a></li>
<li><a class="reference internal" href="#controller">5.16.4.3.3. Controllerクラスの作成</a></li>
<li><a class="reference internal" href="#resthowtouseapiimplementationofgetcollection">5.16.4.3.4. リソースのコレクションを取得するREST APIの実装</a></li>
<li><a class="reference internal" href="#api-rest">5.16.4.3.5. リソースをコレクションに追加するAPI RESTの実装</a></li>
<li><a class="reference internal" href="#resthowtouseapiimplementationofgetspecifiedresource">5.16.4.3.6. 指定されたリソースを取得するREST APIの実装</a></li>
<li><a class="reference internal" href="#resthowtouseapiimplementationofputspecifiedresource">5.16.4.3.7. 指定されたリソースを更新するREST APIの実装</a></li>
<li><a class="reference internal" href="#resthowtouseapiimplementationofdeletespecifiedresource">5.16.4.3.8. 指定されたリソースを削除するREST APIの実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resthowtouseexceptionhandling">5.16.4.4. 例外のハンドリングの実装</a><ul>
<li><a class="reference internal" href="#body">5.16.4.4.1. レスポンスBodyにエラー情報を出力するための実装</a></li>
<li><a class="reference internal" href="#resthowtouseexceptionhandlingforvalidationerror">5.16.4.4.2. 入力エラー例外のハンドリング実装</a></li>
<li><a class="reference internal" href="#resthowtouseexceptionhandlingfornotfound">5.16.4.4.3. リソース未検出エラー例外のハンドリング実装</a></li>
<li><a class="reference internal" href="#resthowtouseexceptionhandlingforbusinesserror">5.16.4.4.4. 業務エラー例外のハンドリング実装</a></li>
<li><a class="reference internal" href="#resthowtouseexceptionhandlingforexcusionerror">5.16.4.4.5. 排他エラー例外のハンドリング実装</a></li>
<li><a class="reference internal" href="#resthowtouseexceptionhandlingforsystemerror">5.16.4.4.6. システムエラー例外のハンドリング実装</a></li>
<li><a class="reference internal" href="#exceptioncoderesolver">5.16.4.4.7. ExceptionCodeResolverを使ったエラーコードとメッセージの解決</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resthowtouseexceptionhandlingforservletcontainer">5.16.4.5. サーブレットコンテナに通知されたエラーのハンドリングの実装</a><ul>
<li><a class="reference internal" href="#id44">5.16.4.5.1. エラー応答を行うためのControllerの実装</a></li>
<li><a class="reference internal" href="#id45">5.16.4.5.2. 致命的なエラーが発生した際に応答する静的なJSONファイルの作成</a></li>
<li><a class="reference internal" href="#id46">5.16.4.5.3. サーブレットコンテナに通知されたエラーをハンドリングするための設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resthowtousesecurity">5.16.4.6. セキュリティ対策</a><ul>
<li><a class="reference internal" href="#resthowtousesecurityauth">5.16.4.6.1. 認証・認可</a></li>
<li><a class="reference internal" href="#csrf">5.16.4.6.2. CSRF対策</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resthowtouseconditionaloperations">5.16.4.7. リソースの条件付き操作</a></li>
<li><a class="reference internal" href="#resthowtousecachecontrol">5.16.4.8. リソースのキャッシュ制御</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend">5.16.5. How to extend</a><ul>
<li><a class="reference internal" href="#jsonview">5.16.5.1. &#64;JsonViewを使用したレスポンスの出力制御</a></li>
</ul>
</li>
<li><a class="reference internal" href="#appendix">5.16.6. Appendix</a><ul>
<li><a class="reference internal" href="#jsr-310-date-and-time-api-joda-time">5.16.6.1. JSR-310 Date and Time API / Joda Timeを使う場合の設定</a></li>
<li><a class="reference internal" href="#restful-web-serviceweb">5.16.6.2. RESTful Web Serviceとクライアントアプリケーションを同じWebアプリケーションとして動かす際の設定</a><ul>
<li><a class="reference internal" href="#restful-web-servicedispatcherservlet">5.16.6.2.1. RESTful Web Service用の<code class="docutils literal"><span class="pre">DispatcherServlet</span></code>を設ける方法</a></li>
</ul>
</li>
<li><a class="reference internal" href="#restappendixhypermedialink">5.16.6.3. ハイパーメディアリンクの実装</a><ul>
<li><a class="reference internal" href="#id52">5.16.6.3.1. 共通部品の実装</a></li>
<li><a class="reference internal" href="#id53">5.16.6.3.2. リソース毎の実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#httprestful-web-service">5.16.6.4. HTTPの仕様に準拠したRESTful Web Serviceの作成</a><ul>
<li><a class="reference internal" href="#postlocation">5.16.6.4.1. POST時のLocationヘッダの設定</a></li>
<li><a class="reference internal" href="#id54">5.16.6.4.2. リソース毎の実装</a></li>
<li><a class="reference internal" href="#optionscontroller">5.16.6.4.3. OPTIONSメソッドのリクエストをControllerにディスパッチするための設定</a></li>
<li><a class="reference internal" href="#options">5.16.6.4.4. OPTIONSメソッドの実装</a></li>
<li><a class="reference internal" href="#head">5.16.6.4.5. HEADメソッドの実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#restappendixdisabledcsrfprotection">5.16.6.5. CSRF対策の無効化</a></li>
<li><a class="reference internal" href="#xxe-injection">5.16.6.6. XXE Injection対策の有効化</a></li>
<li><a class="reference internal" href="#dozerjoda-time">5.16.6.7. Dozerを使ってJoda-Timeのクラスをコピーする方法</a></li>
<li><a class="reference internal" href="#restappendixsorucecodesofapplicationlayer">5.16.6.8. アプリケーション層のソースコード</a><ul>
<li><a class="reference internal" href="#memberrestcontroller-java">5.16.6.8.1. MemberRestController.java</a></li>
<li><a class="reference internal" href="#apierrorcreator-java">5.16.6.8.2. ApiErrorCreator.java</a></li>
<li><a class="reference internal" href="#apiglobalexceptionhandler-java">5.16.6.8.3. ApiGlobalExceptionHandler.java</a></li>
</ul>
</li>
<li><a class="reference internal" href="#restappendixsorucecodesofdomainlayer">5.16.6.9. REST API実装時に作成したドメイン層のクラスのソースコード</a><ul>
<li><a class="reference internal" href="#member-java">5.16.6.9.1. Member.java</a></li>
<li><a class="reference internal" href="#membercredentia-java">5.16.6.9.2. MemberCredentia.java</a></li>
<li><a class="reference internal" href="#gender-java">5.16.6.9.3. Gender.java</a></li>
<li><a class="reference internal" href="#memberrepository-java">5.16.6.9.4. MemberRepository.java</a></li>
<li><a class="reference internal" href="#memberservice-java">5.16.6.9.5. MemberService.java</a></li>
<li><a class="reference internal" href="#memberserviceimpl-java">5.16.6.9.6. MemberServiceImpl.java</a></li>
<li><a class="reference internal" href="#domainmessagecodes-java">5.16.6.9.7. DomainMessageCodes.java</a></li>
<li><a class="reference internal" href="#gendertypehandler-java">5.16.6.9.8. GenderTypeHandler.java</a></li>
<li><a class="reference internal" href="#member-mapping-xml">5.16.6.9.9. member-mapping.xml</a></li>
<li><a class="reference internal" href="#mybatis-config-xml">5.16.6.9.10. mybatis-config.xml</a></li>
<li><a class="reference internal" href="#memberrepository-xml">5.16.6.9.11. MemberRepository.xml</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="Ajax.html"
                        title="previous chapter">5.15. Ajax</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="RestClient.html"
                        title="next chapter">5.17. RESTクライアント（HTTPクライアント）</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/ArchitectureInDetail/REST.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="restful-web-service">
<h1>5.16. RESTful Web Service<a class="headerlink" href="#restful-web-service" title="Permalink to this headline">¶</a></h1>
<div class="admonition caution">
  <p class="first admonition-title">Caution</p>
  <p><strong>本バージョンの内容は既に古くなっています</strong>。最新のガイドラインは<a href="http://terasolunaorg.github.io/guideline/">こちら</a>からご参照ください。</p>
</div>
<div class="contents local topic" id="id1">
<p class="topic-title">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id58">Overview</a><ul>
<li><a class="reference internal" href="#restoverviewaboutrestfulwebservice" id="id59">RESTful Web Serviceとは</a></li>
<li><a class="reference internal" href="#restoverviewaboutrestfulwebservicedevelopment" id="id60">RESTful Web Serviceの開発について</a><ul>
<li><a class="reference internal" href="#id4" id="id61">RESTful Web Serviceのモジュールの構成</a></li>
<li><a class="reference internal" href="#rest-api" id="id62">REST APIの実装サンプル</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#architecture" id="id63">Architecture</a><ul>
<li><a class="reference internal" href="#web" id="id64">Web上のリソースとして公開</a></li>
<li><a class="reference internal" href="#uri" id="id65">URIによるリソースの識別</a></li>
<li><a class="reference internal" href="#http" id="id66">HTTPメソッドによるリソースの操作</a></li>
<li><a class="reference internal" href="#restoverviewresourcerepresentationformat" id="id67">適切なフォーマットの使用</a></li>
<li><a class="reference internal" href="#restoverviewhttpstatuscode" id="id68">適切なHTTPステータスコードの使用</a></li>
<li><a class="reference internal" href="#restoverviewclientservercommunicateonstateless" id="id69">ステートレスなクライアント/サーバ間の通信</a></li>
<li><a class="reference internal" href="#restoverviewhypermedialinkstorelatedresources" id="id70">関連のあるリソースへのリンク</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-design" id="id71">How to design</a><ul>
<li><a class="reference internal" href="#resthowtodesignextractresource" id="id72">リソースの抽出</a></li>
<li><a class="reference internal" href="#resthowtodesignassignuri" id="id73">URIの割り当て</a><ul>
<li><a class="reference internal" href="#rest-apiuri" id="id74">REST APIであることを示すためのURIの割り当て</a></li>
<li><a class="reference internal" href="#apiuri" id="id75">APIバージョンを識別するためのURIの割り当て</a></li>
<li><a class="reference internal" href="#resthowtodesignassignuriforresource" id="id76">リソースを識別するためのパスの割り当て</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resthowtodesignassignhttpmethod" id="id77">HTTPメソッドの割り当て</a><ul>
<li><a class="reference internal" href="#urihttp" id="id78">リソースコレクションのURIに対するHTTPメソッドの割り当て</a></li>
<li><a class="reference internal" href="#resthowtodesignassignhttpmethodforspecifiedresource" id="id79">特定リソースのURIに対するHTTPメソッドの割り当て</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resthowtodesignresourcerepresentationformat" id="id80">リソースのフォーマット</a><ul>
<li><a class="reference internal" href="#json" id="id81">JSONのフィールド名</a></li>
<li><a class="reference internal" href="#null" id="id82">NULLとブランク文字</a></li>
<li><a class="reference internal" href="#id15" id="id83">日時のフォーマット</a></li>
<li><a class="reference internal" href="#id16" id="id84">パイパーメディアリンクの形式</a></li>
<li><a class="reference internal" href="#id17" id="id85">エラー応答時のフォーマット</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resthowtodesignhttpstatuscode" id="id86">HTTPステータスコード</a><ul>
<li><a class="reference internal" href="#resthowtodesignhttpstatuscodeforsuccess" id="id87">リクエストが成功した場合のHTTPステータスコード</a></li>
<li><a class="reference internal" href="#resthowtodesignhttpstatuscodeforclienterror" id="id88">リクエストが失敗した原因がクライアント側にある場合のHTTPステータスコード</a></li>
<li><a class="reference internal" href="#resthowtodesignhttpstatuscodeforservererror" id="id89">リクエストが失敗した原因がサーバ側にある場合のHTTPステータスコード</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id22" id="id90">認証・認可</a></li>
<li><a class="reference internal" href="#id23" id="id91">リソースの条件付き更新の制御</a></li>
<li><a class="reference internal" href="#id24" id="id92">リソースの条件付き取得の制御</a></li>
<li><a class="reference internal" href="#id25" id="id93">リソースのキャッシュ制御</a></li>
<li><a class="reference internal" href="#id26" id="id94">バージョニング</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use" id="id95">How to use</a><ul>
<li><a class="reference internal" href="#resthowtousewebapplicationconstruction" id="id96">Webアプリケーションの構成</a></li>
<li><a class="reference internal" href="#resthowtouseapplicationsettings" id="id97">アプリケーションの設定</a><ul>
<li><a class="reference internal" href="#restful-web-servicespring-mvc" id="id98">RESTful Web Serviceで必要となるSpring MVCのコンポーネントを有効化するための設定</a></li>
<li><a class="reference internal" href="#resthowtouseapplicationsettingsofdispatcherservlet" id="id99">RESTful Web Service用のサーブレットの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resthowtouseapiimplementation" id="id100">REST APIの実装</a><ul>
<li><a class="reference internal" href="#resthowtousepackage" id="id101">REST API用パッケージの作成</a></li>
<li><a class="reference internal" href="#resource" id="id102">Resourceクラスの作成</a></li>
<li><a class="reference internal" href="#controller" id="id103">Controllerクラスの作成</a></li>
<li><a class="reference internal" href="#resthowtouseapiimplementationofgetcollection" id="id104">リソースのコレクションを取得するREST APIの実装</a></li>
<li><a class="reference internal" href="#api-rest" id="id105">リソースをコレクションに追加するAPI RESTの実装</a></li>
<li><a class="reference internal" href="#resthowtouseapiimplementationofgetspecifiedresource" id="id106">指定されたリソースを取得するREST APIの実装</a></li>
<li><a class="reference internal" href="#resthowtouseapiimplementationofputspecifiedresource" id="id107">指定されたリソースを更新するREST APIの実装</a></li>
<li><a class="reference internal" href="#resthowtouseapiimplementationofdeletespecifiedresource" id="id108">指定されたリソースを削除するREST APIの実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resthowtouseexceptionhandling" id="id109">例外のハンドリングの実装</a><ul>
<li><a class="reference internal" href="#body" id="id110">レスポンスBodyにエラー情報を出力するための実装</a></li>
<li><a class="reference internal" href="#resthowtouseexceptionhandlingforvalidationerror" id="id111">入力エラー例外のハンドリング実装</a></li>
<li><a class="reference internal" href="#resthowtouseexceptionhandlingfornotfound" id="id112">リソース未検出エラー例外のハンドリング実装</a></li>
<li><a class="reference internal" href="#resthowtouseexceptionhandlingforbusinesserror" id="id113">業務エラー例外のハンドリング実装</a></li>
<li><a class="reference internal" href="#resthowtouseexceptionhandlingforexcusionerror" id="id114">排他エラー例外のハンドリング実装</a></li>
<li><a class="reference internal" href="#resthowtouseexceptionhandlingforsystemerror" id="id115">システムエラー例外のハンドリング実装</a></li>
<li><a class="reference internal" href="#exceptioncoderesolver" id="id116">ExceptionCodeResolverを使ったエラーコードとメッセージの解決</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resthowtouseexceptionhandlingforservletcontainer" id="id117">サーブレットコンテナに通知されたエラーのハンドリングの実装</a><ul>
<li><a class="reference internal" href="#id44" id="id118">エラー応答を行うためのControllerの実装</a></li>
<li><a class="reference internal" href="#id45" id="id119">致命的なエラーが発生した際に応答する静的なJSONファイルの作成</a></li>
<li><a class="reference internal" href="#id46" id="id120">サーブレットコンテナに通知されたエラーをハンドリングするための設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resthowtousesecurity" id="id121">セキュリティ対策</a><ul>
<li><a class="reference internal" href="#resthowtousesecurityauth" id="id122">認証・認可</a></li>
<li><a class="reference internal" href="#csrf" id="id123">CSRF対策</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resthowtouseconditionaloperations" id="id124">リソースの条件付き操作</a></li>
<li><a class="reference internal" href="#resthowtousecachecontrol" id="id125">リソースのキャッシュ制御</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend" id="id126">How to extend</a><ul>
<li><a class="reference internal" href="#jsonview" id="id127">&#64;JsonViewを使用したレスポンスの出力制御</a></li>
</ul>
</li>
<li><a class="reference internal" href="#appendix" id="id128">Appendix</a><ul>
<li><a class="reference internal" href="#jsr-310-date-and-time-api-joda-time" id="id129">JSR-310 Date and Time API / Joda Timeを使う場合の設定</a></li>
<li><a class="reference internal" href="#restful-web-serviceweb" id="id130">RESTful Web Serviceとクライアントアプリケーションを同じWebアプリケーションとして動かす際の設定</a><ul>
<li><a class="reference internal" href="#restful-web-servicedispatcherservlet" id="id131">RESTful Web Service用の<code class="docutils literal"><span class="pre">DispatcherServlet</span></code>を設ける方法</a></li>
</ul>
</li>
<li><a class="reference internal" href="#restappendixhypermedialink" id="id132">ハイパーメディアリンクの実装</a><ul>
<li><a class="reference internal" href="#id52" id="id133">共通部品の実装</a></li>
<li><a class="reference internal" href="#id53" id="id134">リソース毎の実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#httprestful-web-service" id="id135">HTTPの仕様に準拠したRESTful Web Serviceの作成</a><ul>
<li><a class="reference internal" href="#postlocation" id="id136">POST時のLocationヘッダの設定</a></li>
<li><a class="reference internal" href="#id54" id="id137">リソース毎の実装</a></li>
<li><a class="reference internal" href="#optionscontroller" id="id138">OPTIONSメソッドのリクエストをControllerにディスパッチするための設定</a></li>
<li><a class="reference internal" href="#options" id="id139">OPTIONSメソッドの実装</a></li>
<li><a class="reference internal" href="#head" id="id140">HEADメソッドの実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#restappendixdisabledcsrfprotection" id="id141">CSRF対策の無効化</a></li>
<li><a class="reference internal" href="#xxe-injection" id="id142">XXE Injection対策の有効化</a></li>
<li><a class="reference internal" href="#dozerjoda-time" id="id143">Dozerを使ってJoda-Timeのクラスをコピーする方法</a></li>
<li><a class="reference internal" href="#restappendixsorucecodesofapplicationlayer" id="id144">アプリケーション層のソースコード</a><ul>
<li><a class="reference internal" href="#memberrestcontroller-java" id="id145">MemberRestController.java</a></li>
<li><a class="reference internal" href="#apierrorcreator-java" id="id146">ApiErrorCreator.java</a></li>
<li><a class="reference internal" href="#apiglobalexceptionhandler-java" id="id147">ApiGlobalExceptionHandler.java</a></li>
</ul>
</li>
<li><a class="reference internal" href="#restappendixsorucecodesofdomainlayer" id="id148">REST API実装時に作成したドメイン層のクラスのソースコード</a><ul>
<li><a class="reference internal" href="#member-java" id="id149">Member.java</a></li>
<li><a class="reference internal" href="#membercredentia-java" id="id150">MemberCredentia.java</a></li>
<li><a class="reference internal" href="#gender-java" id="id151">Gender.java</a></li>
<li><a class="reference internal" href="#memberrepository-java" id="id152">MemberRepository.java</a></li>
<li><a class="reference internal" href="#memberservice-java" id="id153">MemberService.java</a></li>
<li><a class="reference internal" href="#memberserviceimpl-java" id="id154">MemberServiceImpl.java</a></li>
<li><a class="reference internal" href="#domainmessagecodes-java" id="id155">DomainMessageCodes.java</a></li>
<li><a class="reference internal" href="#gendertypehandler-java" id="id156">GenderTypeHandler.java</a></li>
<li><a class="reference internal" href="#member-mapping-xml" id="id157">member-mapping.xml</a></li>
<li><a class="reference internal" href="#mybatis-config-xml" id="id158">mybatis-config.xml</a></li>
<li><a class="reference internal" href="#memberrepository-xml" id="id159">MemberRepository.xml</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<span id="restoverview"></span><h2><a class="toc-backref" href="#id58">5.16.1. Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>本節では、RESTful Web Serviceの基本的な概念とSpring MVCを使った開発について説明する。</p>
<p>RESTful Web Serviceのアーキテクチャ、設計、実装に対する具体的な説明については、</p>
<ul>
<li><div class="first line-block">
<div class="line">「<a class="reference internal" href="#restaboutresourceorientedarchitecture"><span class="std std-ref">Architecture</span></a>」</div>
<div class="line">RESTful Web Serviceの基本的なアーキテクチャについて説明している。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">「<a class="reference internal" href="#resthowtodesign"><span class="std std-ref">How to design</span></a>」</div>
<div class="line">RESTful Web Serviceの設計を行う際に考慮すべき点などを説明している。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">「<a class="reference internal" href="#resthowtouse"><span class="std std-ref">How to use</span></a>」</div>
<div class="line">RESTful Web Serviceのアプリケーション構成やAPIの実装方法について説明している。</div>
</div>
</li>
</ul>
<p>を参照されたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="restoverviewaboutrestfulwebservice">
<span id="id2"></span><h3><a class="toc-backref" href="#id59">5.16.1.1. RESTful Web Serviceとは</a><a class="headerlink" href="#restoverviewaboutrestfulwebservice" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">まずRESTとは、「<strong>RE</strong>presentational <strong>S</strong>tate <strong>T</strong>ransfer」の略であり、</div>
<div class="line">クライアントとサーバ間でデータをやりとりするアプリケーションを構築するための<strong>アーキテクチャスタイル</strong>の一つである。</div>
<div class="line">RESTのアーキテクチャスタイルには、いくつかの重要な原則があり、これらの原則に従っているもの(システムなど)は <strong>RESTful</strong>と表現される。</div>
<div class="line">つまり、「RESTful Web Service」とは、RESTの原則に従って構築されているWeb Serviceという事になる。</div>
</div>
<div class="line-block">
<div class="line"><strong>RESTful Web Serviceにおいて最も重要なのは、「リソース」という概念である。</strong></div>
<div class="line">RESTful Web Serviceでは、データベースなどで管理している情報の中からクライアントに提供すべき情報を「リソース」として抽出し、抽出した「リソース」に対するCRUD操作をHTTPメソッド(POST/GET/PUT/DELETE)を使ってクライアントに提供することになる。</div>
<div class="line">「リソース」に対するCRUD操作は「REST API」や「RESTful API」と呼ばれる事があり、本ガイドラインでは「REST API」と呼ぶ。</div>
<div class="line">また、クライアントとサーバ間でリソースをやりとりする際の電文形式には、電文の視認性、及びデータ構造の表現性が高いJSONやXMLを使用するのが一般的である。</div>
</div>
<div class="line-block">
<div class="line">RESTful Web Serviceを利用するアプリケーションのシステム構成は、主に以下の２パターンとなる。</div>
<div class="line">クライアントとサーバ間で「リソース」をやりとりするための具体的なアーキテクチャについては、「<a class="reference internal" href="#restaboutresourceorientedarchitecture"><span class="std std-ref">Architecture</span></a>」で説明する。</div>
</div>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/RESTExampleSystemConstitution.png"><img alt="Constitution of RESTful Web Service" src="../_images/RESTExampleSystemConstitution.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザインタフェースを持つクライアントアプリケーションとRESTful Web Serviceの間で、直接リソースのやりとりを行う。</div>
<div class="line">このパターンは、要件や仕様の変更頻度が多いユーザインタフェースに依存するロジックと、より普遍的で変更頻度が少ないデータモデルに対するロジックを分離する際に採用される構成である。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザインタフェースを持つクライアントアプリケーションと直接リソースをやり取りするのではなく、システム間でリソースをやりとりを行う。</div>
<div class="line">このパターンは、各システムで管理しているビジネスデータを一元管理するようなシステムを構築する際に採用される構成である。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="restoverviewaboutrestfulwebservicedevelopment">
<span id="id3"></span><h3><a class="toc-backref" href="#id60">5.16.1.2. RESTful Web Serviceの開発について</a><a class="headerlink" href="#restoverviewaboutrestfulwebservicedevelopment" title="Permalink to this headline">¶</a></h3>
<p>TERASOLUNA Server Framework for Java (5.x)では、Spring MVCの機能を利用してRESTful Web Serviceの開発を行う。</p>
<div class="line-block">
<div class="line">Spring MVCでは、RESTful Web Serviceを開発する上で必要となる共通的な機能がデフォルトで組み込まれている。</div>
<div class="line">そのため、特別な設定の追加や実装を行うことなく、RESTful Web Serviceの開発を開始する事ができる。</div>
</div>
<div class="line-block">
<div class="line">Spring MVCにデフォルトで組み込まれている主な共通機能は以下の通りである。</div>
<div class="line">これらの機能は、REST APIを提供するControllerのメソッドにアノテーションを指定だけで有効にする事ができる。</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">機能概要</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエストBODYに設定されているJSONやXML形式の電文をResourceオブジェクト(JavaBean)に変換し、Controllerクラスのメソッド(REST API)に引き渡す機能</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">電文から変換されたResourceオブジェクト(JavaBean)に格納された値に対して入力チェックを実行する機能</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Controllerクラスのメソッド(REST API)から返却したResourceオブジェクト(JavaBean)を、JSONやXML形式に変換しレスポンスBODYに設定する機能</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>例外ハンドリングについて</strong></p>
<p class="last">例外ハンドリングについては、Spring MVCから汎用的な機能の提供がないため、プロジェクト毎に実装が必要となる。
例外ハンドリングの詳細については、「<a class="reference internal" href="#resthowtouseexceptionhandling"><span class="std std-ref">例外のハンドリングの実装</span></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">Spring MVCの機能を利用してRESTful Web Serviceを開発した場合、アプリケーションは以下のような構成となり、そのうち実装が必要なのは、赤枠の部分となる。</div>
</div>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/RESTOverviewApplicationConstitutionOnSpringMVC.png"><img alt="Application constitution of RESTful Web Service on Spring MVC" src="../_images/RESTOverviewApplicationConstitutionOnSpringMVC.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">処理レイヤ</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring MVC</div>
<div class="line">(Framework)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring MVCは、クライアントからのリクエストを受け取り、呼び出すREST API(Controllerのハンドラメソッド)を決定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring MVCは、<code class="docutils literal"><span class="pre">HttpMessageConverter</span></code>を使用して、リクエストBODYに指定されているJSON形式の電文をResourceオブジェクトに変換する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring MVCは、<code class="docutils literal"><span class="pre">Validator</span></code>を使用して、Resourceオブジェクトに格納されて値に対して入力チェックを行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring MVCは、REST APIを呼び出す。</div>
<div class="line">その際に、JSONから変換した入力チェック済みのResourceオブジェクトがREST APIに引き渡される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">REST API</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">REST APIは、Serviceのメソッドを呼び出し、EntityなどのDomainObjectに対する処理を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Serviceのメソッドは、Repositoryのメソッドを呼び出し、EntityなどのDomainObjectのCRUD処理を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring MVC</div>
<div class="line">(Framework)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring MVCは、<code class="docutils literal"><span class="pre">HttpMessageConverter</span></code>を使用して、REST APIから返却されたResourceオブジェクトをJSON形式の電文に変換する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring MVCは、JSON形式の電文をレスポンスBODYに設定し、クライアントにレスポンスする。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="id4">
<h4><a class="toc-backref" href="#id61">5.16.1.2.1. RESTful Web Serviceのモジュールの構成</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Spring MVCから提供されている機能を使うことにより、RESTful Web Service固有の処理の多くをSpring MVCに任せることが出来る。</div>
<div class="line">そのため、開発するモジュールの構成は、HTMLを応答する従来型のWebアプリケーションの開発とほとんど同じ構成となる。</div>
<div class="line">以下に、モジュールの構成要素について説明する。</div>
</div>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/RESTModuleConstitution.png"><img alt="Constitution of Modules" src="../_images/RESTModuleConstitution.png" style="width: 100%;" /></a>
</div>
</div></blockquote>
<ul>
<li><p class="first"><strong>アプリケーション層のモジュール</strong></p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">モジュール名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Controllerクラス</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">REST APIを提供するクラス。</div>
<div class="line">Controllerクラスはリソース単位に作成し、リソース毎のREST APIのエンドポイント(URI)の指定を行う。</div>
<div class="line">リソースに対するCRUD処理は、ドメイン層のServiceに委譲する事で実現する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resourceクラス</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">REST APIの入出力となるJSON(またはXML)を表現するJava Bean。</div>
<div class="line">このクラスには、Bean Validationのアノテーションの指定や、JSONやXMLのフォーマットを制御するためのアノテーションの指定を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Validatorクラス</div>
<div class="line">(Optional)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力値の相関チェックを実装するクラス。</div>
<div class="line">入力値の相関チェックが不要な場合は、本クラスを作成する必要はないため、オプションの扱いとしている。</div>
<div class="line">入力値の相関チェックについては、「<a class="reference internal" href="Validation.html"><span class="doc">入力チェック</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Helperクラス</div>
<div class="line">(Optional)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Controllerで行う処理を補助するための処理を実装するクラス。</div>
<div class="line">本クラスは、Controllerの処理をシンプルに保つことを目的として作成するクラスである。</div>
<div class="line">具体的には、ResourceオブジェクトとDomainObjectのモデル変換処理などを行うメソッドを実装する。</div>
<div class="line">モデル変換が単純な値のコピーのみで済む場合は、Helperクラスは作成せずに「<a class="reference internal" href="Utilities/Dozer.html"><span class="doc">Beanマッピング(Dozer)</span></a>」を使用すればよいため、オプションの扱いにしている。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul>
<li><p class="first"><strong>ドメイン層のモジュール</strong></p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ドメイン層で実装するモジュールは、アプリケーションの種類に依存しないため、本節での説明は割愛する。</div>
<div class="line">各モジュールの役割については「<a class="reference internal" href="../Overview/ApplicationLayering.html"><span class="doc">アプリケーションのレイヤ化</span></a>」を、ドメイン層の開発については「<a class="reference internal" href="../ImplementationAtEachLayer/DomainLayer.html"><span class="doc">ドメイン層の実装</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul>
<li><p class="first"><strong>インフラストラクチャ層のモジュール</strong></p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">インフラストラクチャ層で実装するモジュールは、アプリケーションの種類に依存しないため、本節での説明は割愛する。</div>
<div class="line">各モジュールの役割については「<a class="reference internal" href="../Overview/ApplicationLayering.html"><span class="doc">アプリケーションのレイヤ化</span></a>」を、インフラストラクチャ層の開発については「<a class="reference internal" href="../ImplementationAtEachLayer/InfrastructureLayer.html"><span class="doc">インフラストラクチャ層の実装</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="rest-api">
<h4><a class="toc-backref" href="#id62">5.16.1.2.2. REST APIの実装サンプル</a><a class="headerlink" href="#rest-api" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">詳細な説明を行う前に、どのようなクラスをアプリケーション層に作成する事になるのかを知ってもらうために、ResourceクラスとControllerクラスの実装サンプルを以下に示す。</div>
<div class="line">下記に示す実装サンプルは、「<a class="reference internal" href="../TutorialREST/index.html"><span class="doc">チュートリアル(Todoアプリケーション REST編)</span></a>」で題材としているTodoリソースのREST APIである。</div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>詳細な説明を読む前に、まずは</strong>「<a class="reference internal" href="../TutorialREST/index.html"><span class="doc">チュートリアル(Todoアプリケーション REST編)</span></a>」<strong>を実践する事を強く推奨する。</strong></p>
<p>チュートリアルでは”習うより慣れろ”を目的としており、 詳細な説明の前に実際に手を動かすことでTERASOLUNA Server Framework for Java (5.x)によるRESTful Web Serviceの開発を体感する事が出来る。
RESTful Web Serviceの開発を体感した後に、詳細な説明を読むことで、RESTful Web Serviceの開発に対する理解度がより深まる事が期待できる。</p>
<p class="last">特にRESTful Web Serviceの開発経験がない場合は、「チュートリアルの実践」 → 「アーキテクチャ、設計、開発に関する詳細な説明(次節以降で説明)」 → 「チュートリアルの振り返り(再実践)」というプロセスを踏むことを推奨する。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>実装サンプルで扱うリソース</li>
</ul>
<blockquote>
<div><p>実装サンプルで扱うリソース(Todoリソース)は、以下のJSON形式とする。</p>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;todoId&quot;</span> <span class="p">:</span> <span class="s2">&quot;9aef3ee3-30d4-4a7c-be4a-bc184ca1d558&quot;</span><span class="p">,</span>
    <span class="nt">&quot;todoTitle&quot;</span> <span class="p">:</span> <span class="s2">&quot;Hello World!&quot;</span><span class="p">,</span>
    <span class="nt">&quot;finished&quot;</span> <span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nt">&quot;createdAt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-02-25T02:21:48.493+0000&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Resourceクラスの実装サンプル</li>
</ul>
<blockquote>
<div><p>上記で示したTodoリソースを表現するJavaBeanとして、Resourceクラスを作成する。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">todo.api.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoResource</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">todoId</span><span class="p">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="p">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">todoTitle</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">finished</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">Date</span> <span class="n">createdAt</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTodoId</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">todoId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTodoId</span><span class="p">(</span><span class="n">String</span> <span class="n">todoId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">todoId</span> <span class="o">=</span> <span class="n">todoId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTodoTitle</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">todoTitle</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTodoTitle</span><span class="p">(</span><span class="n">String</span> <span class="n">todoTitle</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">todoTitle</span> <span class="o">=</span> <span class="n">todoTitle</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isFinished</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">finished</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFinished</span><span class="p">(</span><span class="kt">boolean</span> <span class="n">finished</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">finished</span> <span class="o">=</span> <span class="n">finished</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">Date</span> <span class="nf">getCreatedAt</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">createdAt</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCreatedAt</span><span class="p">(</span><span class="n">Date</span> <span class="n">createdAt</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">createdAt</span> <span class="o">=</span> <span class="n">createdAt</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Controllerクラス(REST API)の実装サンプル</li>
</ul>
<blockquote>
<div><p>Todoリソースに対して、以下の5つのREST API(Controllerのハンドラメソッド)を作成する。</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="15%" />
<col width="10%" />
<col width="30%" />
<col width="15%" />
<col width="20%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">API名</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">HTTP</div>
<div class="line">メソッド</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">パス</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">ステータス</div>
<div class="line">コード</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET Todos</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">/api/v1/todos</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">200</div>
<div class="line">(OK)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Todoリソースを全件取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">POST Todos</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">POST</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">/api/v1/todos</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">201</div>
<div class="line">(Created)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Todoリソースを新規作成する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET Todo</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">/api/v1/todos/{todoId}</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">200</div>
<div class="line">(OK)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Todoリソースを一件取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">PUT Todo</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">PUT</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">/api/v1/todos/{todoId}</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">200</div>
<div class="line">(OK)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Todoリソースを完了状態に更新する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">DELETE Todo</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">DELETE</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">/api/v1/todos/{todoId}</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">204</div>
<div class="line">(No Content)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Todoリソースを削除する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">todo.api.todo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.dozer.Mapper</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PathVariable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestBody</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ResponseStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">todo.domain.service.todo.TodoService</span><span class="p">;</span>

<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;todos&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRestController</span> <span class="p">{</span>
    <span class="nd">@Inject</span>
    <span class="n">TodoService</span> <span class="n">todoService</span><span class="p">;</span>
    <span class="nd">@Inject</span>
    <span class="n">Mapper</span> <span class="n">beanMapper</span><span class="p">;</span>

<span class="hll">    <span class="c1">// (1)</span>
</span><span class="hll">    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
</span><span class="hll">    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">TodoResource</span><span class="o">&gt;</span> <span class="nf">getTodos</span><span class="p">()</span> <span class="p">{</span>
</span><span class="hll">        <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span> <span class="o">=</span> <span class="n">todoService</span><span class="p">.</span><span class="na">findAll</span><span class="p">();</span>
</span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">TodoResource</span><span class="o">&gt;</span> <span class="n">todoResources</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span> <span class="p">:</span> <span class="n">todos</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">todoResources</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">todo</span><span class="p">,</span> <span class="n">TodoResource</span><span class="p">.</span><span class="na">class</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">todoResources</span><span class="p">;</span>
    <span class="p">}</span>

<span class="hll">    <span class="c1">// (2)</span>
</span><span class="hll">    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
</span><span class="hll">    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">CREATED</span><span class="p">)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">TodoResource</span> <span class="nf">postTodos</span><span class="p">(</span><span class="nd">@RequestBody</span> <span class="nd">@Validated</span> <span class="n">TodoResource</span> <span class="n">todoResource</span><span class="p">)</span> <span class="p">{</span>
</span>        <span class="n">Todo</span> <span class="n">createdTodo</span> <span class="o">=</span> <span class="n">todoService</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">todoResource</span><span class="p">,</span> <span class="n">Todo</span><span class="p">.</span><span class="na">class</span><span class="p">));</span>
        <span class="n">TodoResource</span> <span class="n">createdTodoResponse</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">createdTodo</span><span class="p">,</span> <span class="n">TodoResource</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">createdTodoResponse</span><span class="p">;</span>
    <span class="p">}</span>

<span class="hll">    <span class="c1">// (3)</span>
</span><span class="hll">    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s">&quot;{todoId}&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
</span><span class="hll">    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">TodoResource</span> <span class="nf">getTodo</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;todoId&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">todoId</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">        <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">todoService</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">todoId</span><span class="p">);</span>
</span>        <span class="n">TodoResource</span> <span class="n">todoResource</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">todo</span><span class="p">,</span> <span class="n">TodoResource</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">todoResource</span><span class="p">;</span>
    <span class="p">}</span>
<span class="hll">
</span><span class="hll">    <span class="c1">// (4)</span>
</span><span class="hll">    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s">&quot;{todoId}&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">PUT</span><span class="p">)</span>
</span><span class="hll">    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">TodoResource</span> <span class="nf">putTodo</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;todoId&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">todoId</span><span class="p">)</span> <span class="p">{</span>
</span>        <span class="n">Todo</span> <span class="n">finishedTodo</span> <span class="o">=</span> <span class="n">todoService</span><span class="p">.</span><span class="na">finish</span><span class="p">(</span><span class="n">todoId</span><span class="p">);</span>
        <span class="n">TodoResource</span> <span class="n">finishedTodoResource</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">finishedTodo</span><span class="p">,</span> <span class="n">TodoResource</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">finishedTodoResource</span><span class="p">;</span>
    <span class="p">}</span>
<span class="hll">
</span><span class="hll">    <span class="c1">// (5)</span>
</span><span class="hll">    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s">&quot;{todoId}&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">DELETE</span><span class="p">)</span>
</span><span class="hll">    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">NO_CONTENT</span><span class="p">)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteTodo</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;todoId&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">todoId</span><span class="p">)</span> <span class="p">{</span>
</span>        <span class="n">todoService</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">todoId</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="architecture">
<span id="restaboutresourceorientedarchitecture"></span><h2><a class="toc-backref" href="#id63">5.16.2. Architecture</a><a class="headerlink" href="#architecture" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line">本節では、RESTful Web Serviceを構築するためのアーキテクチャについて説明する。</div>
</div>
<div class="line-block">
<div class="line">RESTful Web Serviceを構築するためのアーキテクチャとして、リソース指向アーキテクチャ(ROA)というものが存在する。</div>
<div class="line">ROAは、「<strong>R</strong>esource <strong>O</strong>riented <strong>A</strong>rchitecture」の略であり、<strong>RESTのアーキテクチャスタイル(原則)に従ったWeb Serviceを構築するための具体的なアーキテクチャ</strong>を定義している。</div>
<div class="line">RESTful Web Serviceを作る際は、まずROAのアーキテクチャの理解を深めてほしい。</div>
</div>
<div class="line-block">
<div class="line">本節では、ROAのアーキテクチャとして、以下の7つについて説明する。</div>
<div class="line">これらは、RESTful Web Serviceを構築する上で重要なアーキテクチャ要素であるが、必ず全てを適用しなくてはいけないという事ではない。</div>
<div class="line">開発するアプリケーションの特性を考慮し、必要なものを適用してほしい。</div>
</div>
<p>以下の5つのアーキテクチャは、アプリケーションの特性に関係なく適用すべきアーキテクチャである。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="35%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">アーキテクチャ</th>
<th class="head">アーキテクチャの概要</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#restoverviewprovideresourceonweb"><span class="std std-ref">Web上のリソースとして公開</span></a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">システム上で管理する情報をクライアントに提供する手段として、Web上のリソースとして公開する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#restoverviewassignuri"><span class="std std-ref">URIによるリソースの識別</span></a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントに公開するリソースには、Web上のリソースとして一意に識別できるURI(Universal Resource Identifier)を割り当てる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#restoverviewoperatedbyhttpmethod"><span class="std std-ref">HTTPメソッドによるリソースの操作</span></a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースに対する操作は、HTTPメソッド(GET,POST,PUT,DELETE)を使い分けることで実現する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#restoverviewresourcerepresentationformat"><span class="std std-ref">適切なフォーマットの使用</span></a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースのフォーマットは、JSON又はXMLなどのデータ構造を示すためのフォーマットを使用する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#restoverviewhttpstatuscode"><span class="std std-ref">適切なHTTPステータスコードの使用</span></a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントへ返却するレスポンスには、適切なHTTPステータスコードを設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>以下の2つのアーキテクチャは、アプリケーションの特性に応じて、適用するアーキテクチャである。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="35%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">アーキテクチャ</th>
<th class="head">アーキテクチャの概要</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#restoverviewclientservercommunicateonstateless"><span class="std std-ref">ステートレスなクライアント/サーバ間の通信</span></a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">サーバ上でアプリケーションの状態は保持せずに、クライアントからリクエストされてきた情報のみで処理を行うようにする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#restoverviewhypermedialinkstorelatedresources"><span class="std std-ref">関連のあるリソースへのリンク</span></a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースの中には、指定されたリソースと関連をもつ他のリソースへのリンク(URI)を含める。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="web">
<span id="restoverviewprovideresourceonweb"></span><h3><a class="toc-backref" href="#id64">5.16.2.1. Web上のリソースとして公開</a><a class="headerlink" href="#web" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line"><strong>システム上で管理する情報をクライアントに提供する手段として、Web上のリソースとして公開する。</strong></div>
<div class="line">これは、HTTPプロトコルを使ってリソースにアクセスできるようにする事を意味しており、その際にリソースを識別する方法とし、URIが使用される。</div>
</div>
<p>例えば、ショッピングサイトを提供するWebシステムであれば、以下のような情報がWeb上のリソースとして公開する事になる。</p>
<ul class="simple">
<li>商品の情報</li>
<li>在庫の情報</li>
<li>注文の情報</li>
<li>会員の情報</li>
<li>会員毎の認証の情報(ログインIDとパスワードなど)</li>
<li>会員毎の注文履歴の情報</li>
<li>会員毎の認証履歴の情報</li>
<li>and more …</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="uri">
<span id="restoverviewassignuri"></span><h3><a class="toc-backref" href="#id65">5.16.2.2. URIによるリソースの識別</a><a class="headerlink" href="#uri" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line"><strong>クライアントに公開するリソースには、Web上のリソースとして一意に識別できるURI(Universal Resource Identifier)を割り当てる。</strong></div>
<div class="line">実際に使用されるのは、URIのサブセットであるURL(Uniform Resource Locator)となる。</div>
</div>
<div class="line-block">
<div class="line">ROAでは、URIを使用してWeb上のリソースにアクセスできる状態になっていることを「アドレス可能性」と呼んでいる。</div>
<div class="line">これは同じURIを使用すれば、どこからでも同じリソースにアクセスできる状態になっている事を意味している。</div>
</div>
<div class="line-block">
<div class="line">RESTful Web Serviceに割り当てるURIは、「<strong>リソースの種類を表す名詞</strong>」と「<strong>リソースを一意に識別するための値(IDなど)</strong>」の組み合わせとする。</div>
<div class="line">例えば、ショッピングサイトを提供するWebシステムで扱う商品情報のURIは、以下のようになる。</div>
</div>
<ul>
<li><div class="first line-block">
<div class="line"><cite>http://example.com/api/v1/items</cite></div>
<div class="line">「<strong>items</strong>」の部分が「リソースの種類を表す名詞」となり、リソースの数が複数になる場合は、複数系の名詞を使用する。</div>
<div class="line">上記例では、商品情報である事を表す名詞の複数系を指定しており、商品情報を一括で操作する際に使用するURIとなる。これは、ファイルシステムに置き換えると、ディレクトリに相当する。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line"><cite>http://example.com/api/v1/items/I312-535-01216</cite></div>
<div class="line">「<strong>I312-535-01216</strong>」の部分が「リソースを識別するための値」となり、リソース毎に異なる値となる。</div>
<div class="line">上記例では、商品情報を一意に識別するための値として商品IDを指定しており、特定の商品情報を操作する際に使用するURIとなる。これは、ファイルシステムに置き換えると、ディレクトリの中に格納されているファイルに相当する。</div>
</div>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>RESTful Web Serviceに割り当てるURIには、下記で示すような<strong>操作を表す動詞を含んではいけない。</strong></p>
<ul class="simple">
<li><cite>http://example.com/api/v1/items?get&amp;itemId=I312-535-01216</cite></li>
<li><cite>http://example.com/api/v1/items?delete&amp;itemId=I312-535-01216</cite></li>
</ul>
<p>上記例では、 URIの中に<strong>get</strong>や<strong>delete</strong>という動詞を含んでいるため、RESTful Web Serviceに割り当てるURIとして適切ではない。</p>
<p class="last">RESTful Web Serviceでは、<strong>リソースに対する操作はHTTPメソッド(GET,POST,PUT,DELETE)を使用して表現する。</strong></p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="http">
<span id="restoverviewoperatedbyhttpmethod"></span><h3><a class="toc-backref" href="#id66">5.16.2.3. HTTPメソッドによるリソースの操作</a><a class="headerlink" href="#http" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line"><strong>リソースに対する操作は、HTTPメソッド(GET,POST,PUT,DELETE)を使い分けることで実現する。</strong></div>
</div>
<div class="line-block">
<div class="line">ROAでは、HTTPメソッドの事を「統一インタフェース」と呼んでいる。</div>
<div class="line">これは、HTTPメソッドがWeb上で公開される全てのリソースに対して実行する事ができ、且つリソース毎にHTTPメソッドの意味が変わらない事を意味している。</div>
</div>
<p>以下に、HTTPメソッドに割り当てられるリソースに対する操作の対応付けと、それぞれの操作が保証すべき事後条件について説明する。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="35%" />
<col width="35%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">HTTPメソッド</th>
<th class="head">リソースに対する操作</th>
<th class="head">操作が保証すべき事後条件</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースを取得する。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">安全性、べき等性。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">POST</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースの作成する。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">作成したリソースのURIの割り当てはサーバが行い、割り当てたURIはレスポンスのLocationヘッダに設定してクライアントに返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">PUT</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースを作成又は更新する。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">べき等性。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">PATCH</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースを差分更新する。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">べき等性。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">DELETE</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースを削除する。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">べき等性。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">HEAD</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースのメタ情報を取得する。</div>
<div class="line">GETと同じ処理を行いヘッダのみ応答する。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">安全性、べき等性。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OPTIONS</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースに対して使用できるHTTPメソッドの一覧を応答する。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">安全性、べき等性。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>安全性とべき等性の保証について</strong></p>
<p>HTTPメソッドを使ってリソースの操作を行う場合、事後条件として、「安全性」と「べき等性」の保証を行う事が求められる。</p>
<p><strong>【安全性とは】</strong></p>
<blockquote>
<div>ある数字に1を何回掛けても、数字がかわらない事(10に1を何回掛けても結果は10のままである事)を保証する。
これは、同じ操作を何回行ってもリソースの状態が変わらない事を保証する事である。</div></blockquote>
<p><strong>【べき等性とは】</strong></p>
<blockquote class="last">
<div>数字に0を何回掛けても0になる事(10に0を1回掛けても何回掛けても結果は共に0になる事)を保証する。
これは、一度操作を行えば、その後で同じ操作を何回行ってもリソースの状態が変わらない事を保証する事である。
ただし、別のクライアントが同じリソースの状態を変更している場合は、べき等性を保障する必要はなく、事前条件に対するエラーとして扱ってもよい。</div></blockquote>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>クライアントがリソースに割り当てるURIを指定してリソースを作成する場合</strong></p>
<p>リソースを作成する際に、クライアントによってリソースに割り当てるURIを指定する場合は、<strong>作成するリソースに割り当てるURIに対して、PUTメソッドを呼び出すことで実現する。</strong></p>
<p>PUTメソッドを使用してリソースを作成する場合、</p>
<blockquote>
<div><ul class="simple">
<li>指定されたURIにリソースが存在しない場合はリソースを作成</li>
<li>既にリソースが存在する場合はリソースの状態を更新</li>
</ul>
</div></blockquote>
<p>するのが一般的な動作である。</p>
<p>以下に、PUTとPOSTメソッドを使ってリソースを作成する際の処理イメージの違いについて説明する。</p>
<p><strong>【PUTメソッドを使用してリソースを作成する際の処理イメージ】</strong></p>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/RESTCreatedNewResourceUsingByPutMethod.png"><img alt="Image of processing for create new resource using by PUT method" src="../_images/RESTCreatedNewResourceUsingByPutMethod.png" style="width: 70%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">URIに作成するリソースのURI(ID)を指定して、PUTメソッドを呼び出す。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">URIで指定されたIDのEntityを作成する。</div>
<div class="line">既に同じIDで作成済みの場合は、内容を更新する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">作成又は更新したリソースを応答する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><strong>【POSTメソッドを使用してリソースを作成する際の処理イメージ】</strong></p>
<blockquote class="last">
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/RESTCreatedNewResourceUsingByPostMethod.png"><img alt="Image of processing for create new resource using by POST method" src="../_images/RESTCreatedNewResourceUsingByPostMethod.png" style="width: 70%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">POSTメソッドを呼び出す。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエストされリソースを識別するためのIDを生成する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(2)で生成したIDのEntityを作成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">作成したリソースを応答する。</div>
<div class="line">レスポンスのLocationヘッダに生成したリソースにアクセスするためのURIを設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="restoverviewresourcerepresentationformat">
<span id="id5"></span><h3><a class="toc-backref" href="#id67">5.16.2.4. 適切なフォーマットの使用</a><a class="headerlink" href="#restoverviewresourcerepresentationformat" title="Permalink to this headline">¶</a></h3>
<p><strong>リソースのフォーマットは、JSON又はXMLなどのデータ構造を示すためのフォーマットを使用する。</strong></p>
<div class="line-block">
<div class="line">ただし、リソースの種類によっては、JSONやXML以外のフォーマットを使ってもよい。</div>
<div class="line">例えば、統計情報に分類される様なリソースでは、折れ線グラフを画像フォーマット(バイナリデータ)としてリソースを公開する事も考えられる。</div>
</div>
<div class="line-block">
<div class="line">リソースのフォーマットとして、複数のフォーマットをサポートする場合は、以下のどちらかの方法で切り替えを行う。</div>
</div>
<ul>
<li><p class="first"><strong>拡張子によって切り替えを行う。</strong></p>
<div class="line-block">
<div class="line">レスポンスのフォーマットは、拡張子を指定する事で切り替える事ができる。</div>
<div class="line"><strong>本ガイドラインでは、拡張子による切り替えを推奨する。</strong></div>
<div class="line">推奨する理由は、レスポンスするフォーマット指定が簡単であるという点と、レスポンスするフォーマットがURIに含まれ、直感的なURIになるという点である。</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>拡張子で切り替える場合のURI例</strong></p>
<ul class="last simple">
<li><cite>http://example.com/api/v1/items.json</cite></li>
<li><cite>http://example.com/api/v1/items.xml</cite></li>
<li><cite>http://example.com/api/v1/items/I312-535-01216.json</cite></li>
<li><cite>http://example.com/api/v1/items/I312-535-01216.xml</cite></li>
</ul>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul>
<li><p class="first"><strong>リクエストのAcceptヘッダのMIMEタイプによって切り替えを行う。</strong></p>
<p>RESTful Web Serviceで使用される代表的なMIMEタイプを以下に示す。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="30%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">フォーマット</th>
<th class="head">MIMEタイプ</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JSON</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">application/json</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">XML</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">application/xml</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="restoverviewhttpstatuscode">
<span id="id6"></span><h3><a class="toc-backref" href="#id68">5.16.2.5. 適切なHTTPステータスコードの使用</a><a class="headerlink" href="#restoverviewhttpstatuscode" title="Permalink to this headline">¶</a></h3>
<p><strong>クライアントへ返却するレスポンスには、適切なHTTPステータスコードを設定する。</strong></p>
<div class="line-block">
<div class="line">HTTPステータスコードには、クライアントから受け取ったリクエストをサーバがどのように処理したかを示す値を設定する。</div>
<div class="line"><strong>これはHTTPの仕様であり、HTTPの仕様に可能な限り準拠することを推奨する。</strong></div>
</div>
<blockquote>
<div><div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>HTTPの仕様について</strong></p>
<p class="last"><a class="reference external" href="http://tools.ietf.org/search/rfc2616#section-6.1.1">RFC 2616(Hypertext Transfer Protocol – HTTP/1.1)の6.1.1 Status Code and Reason Phrase</a> を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">ブラウザにHTMLを返却するような伝統的なWebシステムでは、処理結果に関係なく<code class="docutils literal"><span class="pre">&quot;200</span> <span class="pre">OK&quot;</span></code>を応答し、処理結果はエンティティボディ(HTML)の中で表現するという事が一般的であった。</div>
<div class="line">HTMLを返却するような伝統的なWebアプリケーションでは、処理結果を判断するのはオペレータ(人間)のため、この仕組みでも問題が発生する事はなかった。</div>
<div class="line">しかし、この仕組みでRESTful Web Serviceを構築した場合、以下のような問題が潜在的に存在することになるため、適切なHTTPステータスコードを設定することを推奨する。</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">潜在的な問題点</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">処理結果(成功と失敗)のみを判断すればよい場合でも、エンティティボディを解析処理が必須になるため、無駄な処理が必要になる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラーハンドリングを行う際に、システム独自に定義されたエラーコードを意識する事が必須になるため、クライアント側のアーキテクチャ(設計及び実装)に悪影響を与える可能性がある。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアント側でエラー原因を解析する際に、システム独自に定義されたエラーコードの意味を理解しておく必要があるため、直感的なエラー解析の妨げになる可能性がある。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="restoverviewclientservercommunicateonstateless">
<span id="id7"></span><h3><a class="toc-backref" href="#id69">5.16.2.6. ステートレスなクライアント/サーバ間の通信</a><a class="headerlink" href="#restoverviewclientservercommunicateonstateless" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line"><strong>サーバ上でアプリケーションの状態は保持せずに、クライアントからリクエストされてきた情報のみで処理を行うようにする。</strong></div>
</div>
<div class="line-block">
<div class="line">ROAでは、サーバ上でアプリケーションの状態を保持しない事を「ステートレス性」と呼んでいる。</div>
<div class="line">これは、アプリケーションサーバのメモリ(HTTPセッションなど)にアプリケーションの状態を保持しない事を意味し、リクエストされた情報のみでリソースに対する操作が完結できる状態にしておく事を意味している。</div>
<div class="line">本ガイドラインでは、<strong>可能な限り「ステートレス性」を保つことを推奨する。</strong></div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>アプリケーションの状態とは</strong></p>
<p class="last">Webページの遷移状態、入力値、プルダウン/チェックボックス/ラジオボタンなどの選択状態、認証状態などの事である。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>CSRF対策との関連</strong></p>
<p>本ガイドラインに記載されているCSRF対策をRESTful Web Serviceに対して行った場合、CSRF対策用のトークン値がHTTPセッションに保存されるため、クライアントとサーバ間の「ステートレス性」を保つ事が出来ないという点を補足しておく。</p>
<p>そのため、CSRF対策を行う場合は、システムの可用性を考慮する必要がある。</p>
<p>高い可用性が求められるシステムでは、</p>
<ul class="simple">
<li>APサーバをクラスタ化し、セッションをレプリケーションする。</li>
<li>セッションの保存先をAPサーバのメモリ以外にする。</li>
</ul>
<p>等の対策が必要となる。
ただし、上記対策は性能への影響があるため、性能要件も考慮する必要がある。</p>
<p class="last">CSRF対策については、<a class="reference internal" href="../Security/CSRF.html"><span class="doc">CSRF対策</span></a>を参照されたい。</p>
</div>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p>高い可用性が求められる場合は、「CSRF対策用のトークン値をAPサーバのメモリ(HTTPセッション)以外に保存する」アーキテクチャを検討した方がよい。</p>
<p class="last">具体的なアーキテクチャについては、現在検討中であり、次版以降に記載する予定である。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="restoverviewhypermedialinkstorelatedresources">
<span id="id8"></span><h3><a class="toc-backref" href="#id70">5.16.2.7. 関連のあるリソースへのリンク</a><a class="headerlink" href="#restoverviewhypermedialinkstorelatedresources" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line"><strong>リソースの中には、指定されたリソースと関連をもつ他のリソースへのハイパーメディアリンク(URI)を含める。</strong></div>
</div>
<div class="line-block">
<div class="line">ROAでは、リソース状態の表現の中に、他のリソースへのハイパーメディアリンクを含めることを「接続性」と呼んでいる。</div>
<div class="line">これは、関連をもつリソース同士が相互にリンクを保持し、そのリンクをたどる事で関連する全てのリソースにアクセスできる状態にしておく事を意味している。</div>
</div>
<p>下記に、ショッピングサイトの会員情報のリソースを例に、リソースの接続性について説明する。</p>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/RESTConnectivity.png"><img alt="Image of resource connectivity" src="../_images/RESTConnectivity.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">会員情報のリソースを取得(<code class="docutils literal"><span class="pre">GET</span> <span class="pre">http://example.com/api/v1/memebers/M000000001</span></code>)を行うと、以下のJSONが返却される。</div>
</div>
<blockquote>
<div><div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;memberId&quot;</span> <span class="p">:</span> <span class="s2">&quot;M000000001&quot;</span><span class="p">,</span>
    <span class="nt">&quot;memberName&quot;</span> <span class="p">:</span> <span class="s2">&quot;John Smith&quot;</span><span class="p">,</span>
    <span class="nt">&quot;address&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;address1&quot;</span> <span class="p">:</span> <span class="s2">&quot;45 West 36th Street&quot;</span><span class="p">,</span>
        <span class="nt">&quot;address2&quot;</span> <span class="p">:</span> <span class="s2">&quot;7th Floor&quot;</span><span class="p">,</span>
        <span class="nt">&quot;city&quot;</span> <span class="p">:</span> <span class="s2">&quot;New York&quot;</span><span class="p">,</span>
        <span class="nt">&quot;state&quot;</span> <span class="p">:</span> <span class="s2">&quot;NY&quot;</span><span class="p">,</span>
        <span class="nt">&quot;zipCode&quot;</span> <span class="p">:</span> <span class="s2">&quot;10018&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;links&quot;</span> <span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
<span class="hll">            <span class="nt">&quot;rel&quot;</span> <span class="p">:</span> <span class="s2">&quot;orders&quot;</span><span class="p">,</span>
</span><span class="hll">            <span class="nt">&quot;href&quot;</span> <span class="p">:</span> <span class="s2">&quot;http://example.com/api/v1/memebers/M000000001/orders&quot;</span>
</span>        <span class="p">},</span>
        <span class="p">{</span>
<span class="hll">            <span class="nt">&quot;rel&quot;</span> <span class="p">:</span> <span class="s2">&quot;authentications&quot;</span><span class="p">,</span>
</span><span class="hll">            <span class="nt">&quot;href&quot;</span> <span class="p">:</span> <span class="s2">&quot;http://example.com/api/v1/memebers/M000000001/authentications&quot;</span>
</span>        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="last line-block">
<div class="line">ハイライトした部分が、関連をもつ他のリソースへのハイパーメディアリンク(URI)となる。</div>
<div class="line">上記例では、会員毎の注文履歴と認証履歴のリソースに対して接続性を保持している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">返却されたJSONに設定されているハイパーメディアリンク(URI)を使用して、注文履歴のリソースを取得(<code class="docutils literal"><span class="pre">GET</span> <span class="pre">http://example.com/api/v1/memebers/M000000001/orders</span></code>)を行うと、以下のJSONが返却される。</div>
</div>
<blockquote>
<div><div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;orders&quot;</span> <span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;orderId&quot;</span> <span class="p">:</span> <span class="s2">&quot;029b49d7-0efa-411b-bc5a-6570ce40ead8&quot;</span><span class="p">,</span>
            <span class="nt">&quot;orderDatetime&quot;</span> <span class="p">:</span> <span class="s2">&quot;2013-12-27T20:34:50.897Z&quot;</span><span class="p">,</span>
            <span class="nt">&quot;orderName&quot;</span> <span class="p">:</span> <span class="s2">&quot;Note PC&quot;</span><span class="p">,</span>
            <span class="nt">&quot;shopName&quot;</span> <span class="p">:</span> <span class="s2">&quot;Global PC Shop&quot;</span><span class="p">,</span>
            <span class="nt">&quot;links&quot;</span> <span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
<span class="hll">                    <span class="nt">&quot;rel&quot;</span> <span class="p">:</span> <span class="s2">&quot;order&quot;</span><span class="p">,</span>
</span><span class="hll">                    <span class="nt">&quot;href&quot;</span> <span class="p">:</span> <span class="s2">&quot;http://example.com/api/v1/memebers/M000000001/orders/029b49d7-0efa-411b-bc5a-6570ce40ead8&quot;</span>
</span>                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;orderId&quot;</span> <span class="p">:</span> <span class="s2">&quot;79bf991d-d42d-4546-9265-c5d4d59a80eb&quot;</span><span class="p">,</span>
            <span class="nt">&quot;orderDatetime&quot;</span> <span class="p">:</span> <span class="s2">&quot;2013-12-03T19:01:44.109Z&quot;</span><span class="p">,</span>
            <span class="nt">&quot;orderName&quot;</span> <span class="p">:</span> <span class="s2">&quot;Orange Juice 100%&quot;</span><span class="p">,</span>
            <span class="nt">&quot;shopName&quot;</span> <span class="p">:</span> <span class="s2">&quot;Global Food Shop&quot;</span><span class="p">,</span>
            <span class="nt">&quot;links&quot;</span> <span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
<span class="hll">                    <span class="nt">&quot;rel&quot;</span> <span class="p">:</span> <span class="s2">&quot;order&quot;</span><span class="p">,</span>
</span><span class="hll">                    <span class="nt">&quot;href&quot;</span> <span class="p">:</span> <span class="s2">&quot;http://example.com/api/v1/memebers/M000000001/orders/79bf991d-d42d-4546-9265-c5d4d59a80eb&quot;</span>
</span>                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&quot;links&quot;</span> <span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
<span class="hll">            <span class="nt">&quot;rel&quot;</span> <span class="p">:</span> <span class="s2">&quot;ownerMember&quot;</span><span class="p">,</span>
</span><span class="hll">            <span class="nt">&quot;href&quot;</span> <span class="p">:</span> <span class="s2">&quot;http://example.com/api/v1/memebers/M000000001&quot;</span>
</span>        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="last line-block">
<div class="line">ハイライトした部分が、関連をもつ他のリソースへのハイパーメディアリンク(URI)となる。</div>
<div class="line">上記例では、注文履歴のオーナの会員情報のリソース及び注文履歴のリソースに対する接続性を保持している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">注文履歴のオーナとなる会員情報のリソースを再度取得(<code class="docutils literal"><span class="pre">GET</span> <span class="pre">http://example.com/api/v1/memebers/M000000001</span></code>)し、返却されたJSONに設定されているハイパーメディアリンク(URI)を使用して、認証履歴のリソースを取得(<code class="docutils literal"><span class="pre">GET</span> <span class="pre">http://example.com/api/v1/memebers/M000000001/authentications/</span></code>)を行うと、以下のJSONが返却される。</div>
</div>
<blockquote>
<div><div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;authentications&quot;</span> <span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;authenticationId&quot;</span> <span class="p">:</span> <span class="s2">&quot;6ae9613b-85b6-4dd1-83da-b53c43994433&quot;</span><span class="p">,</span>
            <span class="nt">&quot;authenticationDatetime&quot;</span> <span class="p">:</span> <span class="s2">&quot;2013-12-27T20:34:50.897Z&quot;</span><span class="p">,</span>
            <span class="nt">&quot;clientIpaddress&quot;</span> <span class="p">:</span> <span class="s2">&quot;230.210.3.124&quot;</span><span class="p">,</span>
            <span class="nt">&quot;authenticationResult&quot;</span> <span class="p">:</span> <span class="kc">true</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;authenticationId&quot;</span> <span class="p">:</span> <span class="s2">&quot;103bf3c5-7707-46eb-b2d8-c00ce6243d5f&quot;</span><span class="p">,</span>
            <span class="nt">&quot;authenticationDatetime&quot;</span> <span class="p">:</span> <span class="s2">&quot;2013-12-26T10:03:45.001Z&quot;</span><span class="p">,</span>
            <span class="nt">&quot;clientIpaddress&quot;</span> <span class="p">:</span> <span class="s2">&quot;230.210.3.124&quot;</span><span class="p">,</span>
            <span class="nt">&quot;authenticationResult&quot;</span> <span class="p">:</span> <span class="kc">false</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&quot;links&quot;</span> <span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
<span class="hll">            <span class="nt">&quot;rel&quot;</span> <span class="p">:</span> <span class="s2">&quot;ownerMember&quot;</span><span class="p">,</span>
</span><span class="hll">            <span class="nt">&quot;href&quot;</span> <span class="p">:</span> <span class="s2">&quot;http://example.com/api/v1/memebers/M000000001&quot;</span>
</span>        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="last line-block">
<div class="line">ハイライトした部分が、関連をもつ他のリソースへのハイパーメディアリンク(URI)となる。</div>
<div class="line">上記例では、認証履歴のオーナとなる会員情報のリソースに対して接続性を保持している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">リソースの中に他のリソースへのハイパーメディアリンク(URI)を含めることは、必須ではない。</div>
<div class="line">事前に全てのREST APIのエンドポイント(URI)を公開している場合、リソースの中に関連リソースへのリンクを設けても、リンクが使用されない可能性が高い。</div>
<div class="line">特に、システム間でリソースのやりとりを行うためのREST APIの場合は、事前に公開されているREST APIのエンドポイントに対して直接アクセスするような実装になる事が多いため、リンクを設ける意味がない事がある。</div>
<div class="line">リンクを設ける意味がない場合は、無理にリンクを設ける必要はない。</div>
</div>
<div class="line-block">
<div class="line">逆に、ユーザインタフェースを持つクライアントアプリケーションとRESTful Web Serviceの間で直接リソースのやりとりを行う場合は、リンクを設けることで、クライアントとサーバ間の疎結合性を高めることが出来る。</div>
<div class="line">クライアントとサーバ間の疎結合性を高めることが出来る理由は以下の通りである。</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">疎結合性を高めることが出来る理由</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントアプリケーションは、リンクの論理名のみ事前に知っていればよいため、REST APIを呼び出すための具体的なURIを意識する必要がなくなる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントアプリケーショが具体的なURIを意識する必要がなくなるため、サーバ側のURIを変更する際に与える影響度を最小限に抑える事ができる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>上記にあげた点を考慮し、他のリソースへのハイパーメディアリンク(URI)を設けるか否かを判断すること。</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>HATEOASとの関係</strong></p>
<p>HATEOASは、「<strong>H</strong>ypermedia <strong>A</strong>s <strong>T</strong>he <strong>E</strong>ngine <strong>O</strong>f <strong>A</strong>pplication <strong>S</strong>tate」の略であり、RESTfulなWebアプリケーションを作成するためのアーキテクチャの一つである。</p>
<p>HATEOASのアーキテクチャでは、</p>
<ul class="simple">
<li>サーバは、クライアントとサーバ間でやり取りするリソース(JSONやXML)の中に、アクセス可能なリソースへのハイパーメディアリンク(URI)を含める。</li>
<li>クライアントは、リソース表現(JSONやXML)の中に含まれるハイパーメディアリンクを介して、サーバから必要なリソースを取得し、アプリケーションの状態(画面の状態など)を変化させる。</li>
</ul>
<p>ことになるため、関連のあるリソースへのリンクを設ける事は、HATEOASのアーキテクチャと一致する。</p>
<p class="last">サーバとクライアントとの疎結合性を高めたい場合は、HATEOASのアーキテクチャを採用する事を検討されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="how-to-design">
<span id="resthowtodesign"></span><h2><a class="toc-backref" href="#id71">5.16.3. How to design</a><a class="headerlink" href="#how-to-design" title="Permalink to this headline">¶</a></h2>
<p>本説では、RESTful Web Serviceの設計について説明する。</p>
<div class="section" id="resthowtodesignextractresource">
<span id="id9"></span><h3><a class="toc-backref" href="#id72">5.16.3.1. リソースの抽出</a><a class="headerlink" href="#resthowtodesignextractresource" title="Permalink to this headline">¶</a></h3>
<p>まず、Web上に公開するリソースを抽出する。</p>
<p>リソースを抽出する際の注意点を以下に示す。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">リソース抽出時の注意点</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Web上に公開するリソースは、データベースなどで管理されている情報になるが、<strong>安易にデータベースのデータモデルをそのままリソースとして公開してはいけない。</strong></div>
<div class="line">データベースに格納されている項目の中には、クライアントに公開すべきでない項目もあるので、精査が必要である。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><strong>データベースの同じテーブルで管理されている情報であっても、情報の種類が異なる場合は、別のリソースとして公開する事を検討する。</strong></div>
<div class="line">本質的には別の情報だが、データ構造が同じという理由で同じテーブルで管理されているケースがあるので、精査が必要である。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">RESTful Web Serviceでは、イベントで操作する情報をリソースとして抽出する。</div>
<div class="line"><strong>イベント自体をリソースとして抽出してはいけない。</strong></div>
<div class="line"><br /></div>
<div class="line">例えば、ワークフロー機能で発生するイベント(承認、否認、差し戻しなど)から呼び出されるRESTful Web Serviceを作成する場合、ワークフロー自体やワークフローの状態を管理するための情報をリソースとして抽出する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="resthowtodesignassignuri">
<span id="id10"></span><h3><a class="toc-backref" href="#id73">5.16.3.2. URIの割り当て</a><a class="headerlink" href="#resthowtodesignassignuri" title="Permalink to this headline">¶</a></h3>
<p>抽出したリソースに対して、リソースを識別するためのURIを割り当てる。</p>
<p>URIは、以下の形式を推奨する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">http(s)://{ドメイン名(:ポート番号)}/{REST</span> <span class="pre">APIであることを示す値}/{APIバージョン}/{リソースを識別するためのパス}</span></code></li>
<li><code class="docutils literal"><span class="pre">http(s)://{REST</span> <span class="pre">APIであることを示すドメイン名(:ポート番号)}/{APIバージョン}/{リソースを識別するためのパス}</span></code></li>
</ul>
<p>具体例は以下の通り。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">http://example.com/api/v1/members/M000000001</span></code></li>
<li><code class="docutils literal"><span class="pre">http://api.example.com/v1/members/M000000001</span></code></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="rest-apiuri">
<span id="resthowtodesignassignuriforpublishapi"></span><h4><a class="toc-backref" href="#id74">5.16.3.2.1. REST APIであることを示すためのURIの割り当て</a><a class="headerlink" href="#rest-apiuri" title="Permalink to this headline">¶</a></h4>
<p>RESTful Web Service(REST API)向けのURIであること明確にするために、URI内のドメイン又はパスに <code class="docutils literal"><span class="pre">api</span></code>を含めることを推奨する。</p>
<p>具体的には、以下のようなURIとする。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">http://example.com/api/...</span></code></li>
<li><code class="docutils literal"><span class="pre">http://api.example.com/...</span></code></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="apiuri">
<span id="resthowtodesignassignuriforapiversion"></span><h4><a class="toc-backref" href="#id75">5.16.3.2.2. APIバージョンを識別するためのURIの割り当て</a><a class="headerlink" href="#apiuri" title="Permalink to this headline">¶</a></h4>
<p>RESTful Web Serviceは、複数のバージョンで稼働が必要になる可能性があるため、クライアントに公開するURIには、APIバージョンを識別するための値を含めるようにする事を推奨する。</p>
<p>具体的には、以下のような形式のURIとする。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">http://example.com/api/{APIバージョン}/{リソースを識別するためのパス}</span></code></li>
<li><code class="docutils literal"><span class="pre">http://api.example.com/{APIバージョン}/{リソースを識別するためのパス}</span></code></li>
</ul>
<div class="admonition-todo admonition" id="index-1">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p class="last">URIの中にAPIバージョンを含めるべきかは、現在検討中である。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="resthowtodesignassignuriforresource">
<span id="id11"></span><h4><a class="toc-backref" href="#id76">5.16.3.2.3. リソースを識別するためのパスの割り当て</a><a class="headerlink" href="#resthowtodesignassignuriforresource" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Web上に公開するリソースに対して、以下の２つのURIを割り当てる。</div>
<div class="line">下記の例では、会員情報をWeb上に公開する場合のURI例を記載している。</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="35%" />
<col width="25%" />
<col width="30%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">URIの形式</th>
<th class="head">URIの具体例</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/{リソースのコレクションを表す名詞}</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/api/v1/members</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースを一括で操作する際に使用するURIとなる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/{リソースのコレクションを表す名詞/リソースの識別子(IDなど)}</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/api/v1/members/M0001</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">特定のリソースを操作する際に使用するURIとなる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">Web上に公開する関連リソースへのURIは、ネストさせて表現する。</div>
<div class="line">下記の例では、会員毎の注文情報をWeb上に公開する場合のURI例を記載している。</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="35%" />
<col width="25%" />
<col width="30%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">URIの形式</th>
<th class="head">URIの具体例</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">{リソースのURI}/{関連リソースのコレクションを表す名詞}</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/api/v1/members/M0001/orders</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">関連リソースを一括で操作する際に使用するURIとなる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">{リソースのURI}/{関連リソースのコレクションを表す名詞}/{関連リソースの識別子(IDなど)}</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/api/v1/members/M0001/orders/O0001</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">特定の関連リソースを操作する際に使用するURIとなる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">Web上に公開する関連リソースの要素が1件の場合は、関連リソースを示す名詞は複数系ではなく単数形とする。</div>
<div class="line">下記の例では、会員毎の資格情報をWeb上に公開する場合のURI例を記載している。</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="35%" />
<col width="25%" />
<col width="30%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">URIの形式</th>
<th class="head">URIの具体例</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">{リソースのURI}/{関連リソースを表す名詞}</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/api/v1/members/M0001/credential</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">要素が1件の関連リソースを操作する際に使用するURI。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="resthowtodesignassignhttpmethod">
<span id="id12"></span><h3><a class="toc-backref" href="#id77">5.16.3.3. HTTPメソッドの割り当て</a><a class="headerlink" href="#resthowtodesignassignhttpmethod" title="Permalink to this headline">¶</a></h3>
<p>リソース毎に割り当てたURIに対して、以下のHTTPメソッドを割り当て、リソースに対するCRUD操作をREST APIとして公開する。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>HEADとOPTIONSメソッドについて</strong></p>
<p>以降の説明では、HEADとOPTIONSメソッドについても触れているが、REST APIとしての提供は任意とする。</p>
<p class="last">HTTPの仕様に準拠したREST APIを作成する場合は、HEAD及びOPTIONSメソッドの提供も必要だが、実際に使われるケースは稀であり、必要ない事が多いためである。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="urihttp">
<span id="resthowtodesignassignhttpmethodforcollectionresource"></span><h4><a class="toc-backref" href="#id78">5.16.3.3.1. リソースコレクションのURIに対するHTTPメソッドの割り当て</a><a class="headerlink" href="#urihttp" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">HTTPメソッド</th>
<th class="head">実装するREST APIの概要</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">URIで指定されたリソースのコレクションを取得するREST APIを実装する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">POST</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">指定されたリソースを作成しコレクションに追加するREST APIを実装する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">PUT</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">URIで指定されたリソースの一括更新を行うREST APIを実装する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">DELETE</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">URIで指定されたリソースの一括削除を行うREST APIを実装する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">HEAD</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">URIで指定されたリソースコレクションのメタ情報を取得するREST APIを実装する。</div>
<div class="line">GETと同じ処理を行いヘッダのみ応答する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OPTIONS</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">URIで指定されたリソースコレクションでサポートされているHTTPメソッド(API)のリストを応答するREST APIを実装する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="resthowtodesignassignhttpmethodforspecifiedresource">
<span id="id13"></span><h4><a class="toc-backref" href="#id79">5.16.3.3.2. 特定リソースのURIに対するHTTPメソッドの割り当て</a><a class="headerlink" href="#resthowtodesignassignhttpmethodforspecifiedresource" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">HTTPメソッド</th>
<th class="head">実装するREST APIの概要</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GET</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">URIで指定されたリソースを取得するREST APIを実装する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">PUT</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">URIで指定されたリソースの作成又は更新を行うREST APIを実装する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">DELETE</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">URIで指定されたリソースの削除を行うREST APIを実装する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">HEAD</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">URIで指定されたリソースのメタ情報を取得するREST APIを実装する。</div>
<div class="line">GETと同じ処理を行いヘッダのみ応答する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OPTIONS</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">URIで指定されたリソースでサポートされているHTTPメソッド(API)のリストを応答するREST APIを実装する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="resthowtodesignresourcerepresentationformat">
<span id="id14"></span><h3><a class="toc-backref" href="#id80">5.16.3.4. リソースのフォーマット</a><a class="headerlink" href="#resthowtodesignresourcerepresentationformat" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">リソースを表現するフォーマットとしては、<strong>JSONを使用する事を推奨する。</strong></div>
<div class="line">以降の説明では、リソースを表現するフォーマットとしてJSONを使用する前提で説明を記載する。</div>
</div>
<div class="section" id="json">
<h4><a class="toc-backref" href="#id81">5.16.3.4.1. JSONのフィールド名</a><a class="headerlink" href="#json" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">JSONのフィールド名は、<strong>「lower camel case」にすることを推奨する。</strong></div>
<div class="line">これはクライアントアプリケーションの一つとして想定されるJavaScriptとの相性を考慮した結果である。</div>
</div>
<div class="line-block">
<div class="line">フィールド名を「lower camel case」にした場合のJSONのサンプルは以下の通り。</div>
<div class="line">「lower camel case」は、先頭文字を小文字にし、単語の先頭文字を大文字にする。</div>
</div>
<blockquote>
<div><div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;memberId&quot;</span> <span class="p">:</span> <span class="s2">&quot;M000000001&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="null">
<h4><a class="toc-backref" href="#id82">5.16.3.4.2. NULLとブランク文字</a><a class="headerlink" href="#null" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">JSONの値として、<strong>NULLとブランク文字は区別する事を推奨する。</strong></div>
<div class="line">アプリケーションの処理としてNULLとブランク文字を同一視する事はよくあるが、JSONに設定する値としては、NULLとブランク文字は区別しておいた方がよい。</div>
</div>
<div class="line-block">
<div class="line">NULLとブランク文字を区別した場合のJSONのサンプルは以下の通り。</div>
</div>
<blockquote>
<div><div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;dateOfBirth&quot;</span> <span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nt">&quot;address1&quot;</span> <span class="p">:</span> <span class="s2">&quot;&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id15">
<h4><a class="toc-backref" href="#id83">5.16.3.4.3. 日時のフォーマット</a><a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">JSONの日時フィールドの形式は、<strong>ISO-8601の拡張形式とする事を推奨する。</strong></div>
<div class="line">ISO-8601の拡張形式以外でもよいが、特に理由がない場合は、ISO-8601の拡張形式にすればよい。</div>
<div class="line">ISO-8601には基本形式と拡張形式があるが、拡張形式の方が視認性が高い表記方法である。</div>
</div>
<p>具体的には、以下の３つの形式となる。</p>
<ol class="arabic simple">
<li>yyyy-MM-dd</li>
</ol>
<blockquote>
<div><div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;dateOfBirth&quot;</span> <span class="p">:</span> <span class="s2">&quot;1977-03-12&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="2">
<li>yyyy-MM-dd’T’HH:mm:ss.SSSZ</li>
</ol>
<blockquote>
<div><div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;lastModifiedAt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-03-12T22:22:36.637+09:00&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="3">
<li>yyyy-MM-dd’T’HH:mm:ss.SSS’Z’ (UTC用の形式)</li>
</ol>
<blockquote>
<div><div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;lastModifiedAt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-03-12T13:11:27.356Z&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id16">
<h4><a class="toc-backref" href="#id84">5.16.3.4.4. パイパーメディアリンクの形式</a><a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">パイパーメディアリンクを設ける場合は、以下に示す形式とすることを推奨する。</div>
<div class="line">推奨する形式のサンプルは以下の通り。</div>
</div>
<blockquote>
<div><div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;links&quot;</span> <span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;rel&quot;</span> <span class="p">:</span> <span class="s2">&quot;ownerMember&quot;</span><span class="p">,</span>
            <span class="nt">&quot;href&quot;</span> <span class="p">:</span> <span class="s2">&quot;http://example.com/api/v1/memebers/M000000001&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">&quot;rel&quot;</span></code>と<code class="docutils literal"><span class="pre">&quot;href&quot;</span></code>という2つのフィールドを持ったLinkオブジェクトをコレクション形式で保持する。</li>
<li><code class="docutils literal"><span class="pre">&quot;rel&quot;</span></code>には、なんのリンクか識別するためのリンク名を指定する。</li>
<li><code class="docutils literal"><span class="pre">&quot;href&quot;</span></code>には、リソースにアクセスするためのURIを指定する。</li>
<li>Linkオブジェクトをコレクション形式で保持するフィールドは、<code class="docutils literal"><span class="pre">&quot;links&quot;</span></code>とする。</li>
</ul>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id17">
<h4><a class="toc-backref" href="#id85">5.16.3.4.5. エラー応答時のフォーマット</a><a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">エラーを検知した場合、どのようなエラーが発生したのか保持できるフォーマットにする事を推奨する。</div>
<div class="line">特に、クライアントが再操作する事でエラーが解消できる可能性がある場合は、より詳細なエラー情報を含めた方がよい。</div>
<div class="line">逆に、システムの脆弱性をさらすような事象が発生した場合は、詳細なエラー情報は含めるべきではない。この場合、詳細なエラー情報はログに出力すべきである。</div>
</div>
<p>エラーを検知した際に応答するフォーマット例を以下に示す。</p>
<blockquote>
<div><div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;code&quot;</span> <span class="p">:</span> <span class="s2">&quot;e.ex.fw.7001&quot;</span><span class="p">,</span>
  <span class="nt">&quot;message&quot;</span> <span class="p">:</span> <span class="s2">&quot;Validation error occurred on item in the request body.&quot;</span><span class="p">,</span>
  <span class="nt">&quot;details&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">{</span>
    <span class="nt">&quot;code&quot;</span> <span class="p">:</span> <span class="s2">&quot;ExistInCodeList&quot;</span><span class="p">,</span>
    <span class="nt">&quot;message&quot;</span> <span class="p">:</span> <span class="s2">&quot;\&quot;genderCode\&quot; must exist in code list of CL_GENDER.&quot;</span><span class="p">,</span>
    <span class="nt">&quot;target&quot;</span> <span class="p">:</span> <span class="s2">&quot;genderCode&quot;</span>
  <span class="p">}</span> <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>上記のフォーマット例では、</p>
<ul class="simple">
<li>エラーコード(code)</li>
<li>エラーメッセージ(message)</li>
<li>エラー詳細リスト(details)</li>
</ul>
<div class="line-block">
<div class="line">をエラー応答時のフォーマットとして用意している。</div>
<div class="line">エラー詳細リストは、入力チェックエラー発生時に利用する事を想定しており、どのフィールドで、どのようなエラーが発生したのかを保持できるフォーマットとしている。</div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="resthowtodesignhttpstatuscode">
<span id="id18"></span><h3><a class="toc-backref" href="#id86">5.16.3.5. HTTPステータスコード</a><a class="headerlink" href="#resthowtodesignhttpstatuscode" title="Permalink to this headline">¶</a></h3>
<p>HTTPステータスコードは、以下の指針に則って応答する。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">方針</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエストが成功した場合は、成功又は転送を示すHTTPステータスコード(2xx又は3xx系)を応答する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエストが失敗した原因がクライアント側にある場合は、クライアントエラーを示すHTTPステータスコード(4xx系)を応答する。</div>
<div class="line">リクエストが失敗した原因はクライアントにはないが、クライアントの再操作によってリクエストが成功する可能性がある場合も、クライアントエラーとする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエストが失敗した原因がサーバ側にある場合は、サーバエラーを示すHTTPステータスコード(5xx系)を応答する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="resthowtodesignhttpstatuscodeforsuccess">
<span id="id19"></span><h4><a class="toc-backref" href="#id87">5.16.3.5.1. リクエストが成功した場合のHTTPステータスコード</a><a class="headerlink" href="#resthowtodesignhttpstatuscodeforsuccess" title="Permalink to this headline">¶</a></h4>
<p>リクエストが成功した場合は、状況に応じて以下のHTTPステータスコードを応答する。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="30%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">HTTP</div>
<div class="line">ステータスコード</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">適用条件</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">200</div>
<div class="line">OK</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエストが成功した事を通知するHTTPステータスコード。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエストが成功した結果として、レスポンスのエンティティボディに、リクエストに対応するリソースの情報を出力する際に応答する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">201</div>
<div class="line">Created</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">新しいリソースを作成した事を通知するHTTPステータスコード。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">POSTメソッドを使用して、新しいリソースを作成した際に使用する。</div>
<div class="line">レスポンスのLocationヘッダに、作成したリソースのURIを設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">204</div>
<div class="line">No Content</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエストが成功した事を通知するHTTPステータスコード。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエストが成功した結果として、レスポンスのエンティティボディに、リクエストに対応するリソースの情報を出力しない時に応答する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last"><code class="docutils literal"><span class="pre">&quot;200</span> <span class="pre">OK</span></code>と <code class="docutils literal"><span class="pre">&quot;204</span> <span class="pre">No</span> <span class="pre">Content&quot;</span></code>の違いは、レスポンスボディにリソースの情報を出力する/しないの違いとなる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="resthowtodesignhttpstatuscodeforclienterror">
<span id="id20"></span><h4><a class="toc-backref" href="#id88">5.16.3.5.2. リクエストが失敗した原因がクライアント側にある場合のHTTPステータスコード</a><a class="headerlink" href="#resthowtodesignhttpstatuscodeforclienterror" title="Permalink to this headline">¶</a></h4>
<p>リクエストが失敗した原因がクライアント側にある場合は、状況に応じて以下のHTTPステータスコードを応答する。</p>
<p>リソースを扱う個々のREST APIで意識する必要があるステータスコードは以下の通り。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="30%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">HTTP</div>
<div class="line">ステータスコード</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">適用条件</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">400</div>
<div class="line">Bad Request</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエストの構文やリクエストされた値が間違っている事を通知するHTTPステータスコード。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エンティティボディに指定されたJSONやXMLの形式不備を検出した場合や、JSONやXML又はリクエストパラメータに指定された入力値の不備を検出した場合に応答する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">404</div>
<div class="line">Not Found</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">指定されたリソースが存在しない事を通知するHTTPステータスコード。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">指定されたURIに対応するリソースがシステム内に存在しない場合に応答する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">409</div>
<div class="line">Conflict</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエストされた内容でリソースの状態を変更すると、リソースの状態に矛盾が発生ため処理を中止した事を通知するHTTPステータスコード。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">排他エラーが発生した場合や業務エラーを検知した場合に応答する。</div>
<div class="line">エンティティボディには矛盾の内容や矛盾を解決するために必要なエラー内容を出力する必要がある。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">リソースを扱う個々のREST APIで意識する必要がないステータスコードは以下の通り。</div>
<div class="line">以下のステータスコードは、フレームワークや共通処理として意識する必要がある。</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="30%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">HTTP</div>
<div class="line">ステータスコード</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">適用条件</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">405</div>
<div class="line">Method Not Allowed</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">使用されたHTTPメソッドが、指定されたリソースでサポートしていない事を通知するHTTPステータスコード。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">サポートされていないHTTPメソッドが使用された事を検知した場合に応答する。</div>
<div class="line">レスポンスのAllowヘッダに、許可されているメソッドの列挙を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">406</div>
<div class="line">Not Acceptable</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">指定された形式でリソースの状態を応答する事が出来ないため、リクエストを受理できない事を通知するHTTPステータスコード。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">レスポンス形式として、拡張子又はAcceptヘッダで指定された形式をサポートしていない場合に応答する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">415</div>
<div class="line">Unsupported Media Type</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エンティティボディに指定された形式をサポートしていないため、リクエストが受け取れない事を通知するHTTPステータスコード。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエスト形式として、Content-Typeヘッダで指定された形式をサポートしていない場合に応答する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="resthowtodesignhttpstatuscodeforservererror">
<span id="id21"></span><h4><a class="toc-backref" href="#id89">5.16.3.5.3. リクエストが失敗した原因がサーバ側にある場合のHTTPステータスコード</a><a class="headerlink" href="#resthowtodesignhttpstatuscodeforservererror" title="Permalink to this headline">¶</a></h4>
<p>リクエストが失敗した原因がサーバ側にある場合は、状況に応じて以下のHTTPステータスコードを応答する。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="30%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">HTTP</div>
<div class="line">ステータスコード</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">適用条件</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">500</div>
<div class="line">Internal Server Error</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">サーバ内部でエラーが発生した事を通知するHTTPステータスコード。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">サーバ内で予期しないエラーが発生した場合や、正常稼働時には発生してはいけない状態を検知した場合に応答する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id22">
<h3><a class="toc-backref" href="#id90">5.16.3.6. 認証・認可</a><a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h3>
<div class="admonition-todo admonition" id="index-2">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p>認証及び認可制御をどのような指針で行うかについて記載する。</p>
<p class="last">OAuth2の仕組みを使って認証・認可を行う仕組みについて、次版以降に記載する予定である。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id23">
<h3><a class="toc-backref" href="#id91">5.16.3.7. リソースの条件付き更新の制御</a><a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h3>
<div class="admonition-todo admonition" id="index-3">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p>HTTPヘッダを使ったリソースの条件付き更新(排他制御)をどのように行うか記載する。</p>
<p class="last">Etag/Last-Modified-Sinceなどのヘッダを使って条件付き更新の仕組みについて、次版以降に記載する予定である。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id24">
<h3><a class="toc-backref" href="#id92">5.16.3.8. リソースの条件付き取得の制御</a><a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h3>
<div class="admonition-todo admonition" id="index-4">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p>HTTPヘッダを使ったリソースの条件付き取得(304 Not Modified制御)をどのように行うか記載する。</p>
<p class="last">Etag/Last-Modifiedなどのヘッダを使ったリソースの条件付き取得の仕組みについて、次版以降に記載する予定である。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id25">
<h3><a class="toc-backref" href="#id93">5.16.3.9. リソースのキャッシュ制御</a><a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h3>
<div class="admonition-todo admonition" id="index-5">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p>HTTPヘッダを使ったリソースのキャッシュ制御をどのように行うか記載する。</p>
<p class="last">Cache-Control/Pragma/Expiresなどのヘッダを使ったリソースのキャッシュ制御の仕組みについて、次版以降に記載する予定である。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id26">
<h3><a class="toc-backref" href="#id94">5.16.3.10. バージョニング</a><a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h3>
<div class="admonition-todo admonition" id="index-6">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p class="last">RESTful Web Service自体のバージョン管理及び複数バージョンの並行稼働をどのように行うかについて、次版以降に記載する予定である。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="how-to-use">
<span id="resthowtouse"></span><h2><a class="toc-backref" href="#id95">5.16.4. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<p>本節では、RESTful Web Serviceの具体的な作成方法について説明する。</p>
<div class="section" id="resthowtousewebapplicationconstruction">
<span id="id27"></span><h3><a class="toc-backref" href="#id96">5.16.4.1. Webアプリケーションの構成</a><a class="headerlink" href="#resthowtousewebapplicationconstruction" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">RESTful Web Serviceを構築する場合は、以下のいずれかの構成でWebアプリケーション(war)を構築する。</div>
<div class="line"><strong>特に理由がない場合は、RESTful Web Service専用のWebアプリケーションとして構築する事を推奨する。</strong></div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="30%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">構成</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">RESTful Web Service専用のWebアプリケーションとして構築する。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">RESTful Web Serviceを利用するクライアントアプリケーション(UI層のアプリケーション)との独立性を確保したい(する必要がある)場合は、RESTful Web Service専用のWebアプリケーション(war)として構築することを推奨する。</div>
<div class="line"><br /></div>
<div class="line">RESTful Web Serviceを利用するクライアントアプリケーションが複数になる場合は、この方法でRESTful Web Serviceを生成することになる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">RESTful Web Service用の<code class="docutils literal"><span class="pre">DispatcherServlet</span></code>を設けて構築する。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">RESTful Web Serviceを利用するクライアントアプリケーション(UI層のアプリケーション)との独立性を確保する必要がない場合は、RESTful Web Serviceとクライアントアプリケーションを一つのWebアプリケーション(war)として構築してもよい。</div>
<div class="line"><br /></div>
<div class="line">ただし、RESTful Web Service用のリクエストを受ける<code class="docutils literal"><span class="pre">DispatcherServlet</span></code>と、クライアントアプリケーション用のリクエストを受け取る<code class="docutils literal"><span class="pre">DispatcherServlet</span></code>は分割して構築することを強く推奨する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>クライアントアプリケーション(UI層のアプリケーション)とは</strong></p>
<p class="last">ここで言うクライアントアプリケーション(UI層のアプリケーション)とは、HTML, JavaScriptなどのスクリプト, CSS(Cascading Style Sheets)といったクライアント層(UI層)のコンポーネントを応答するアプリケーションの事をさす。
JSPなどのテンプレートエンジンによって生成されるHTMLも対象となる。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>DispatcherServletを分割する事を推奨する理由</strong></p>
<p>Spring MVCでは、<code class="docutils literal"><span class="pre">DispatcherServlet</span></code>毎にアプリケーションの動作設定を定義することになる。
そのため、RESTful Web Serviceとクライアントアプリケーション(UI層のアプリケーション)のリクエストを同じ<code class="docutils literal"><span class="pre">DispatcherServlet</span></code>で受ける構成にしてしまうと、RESTful Web Service又はクライアントアプリケーション固有の動作設定を定義する事ができなくなったり、設定が煩雑又は複雑になることがある。</p>
<p class="last">本ガイドラインでは、上記の様な問題が起こらないようにするために、RESTful Web Serviceをクライアントアプリケーションを同じWebアプリケーション(war)として構築する場合は、<code class="docutils literal"><span class="pre">DispatcherServlet</span></code>を分割することを推奨している。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>RESTful Web Service専用のWebアプリケーションとして構築する際の構成イメージは以下の通り。</p>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/RESTWebAppsConstitutionDivideWar.png"><img alt="Constitution of RESTful Web Service" src="../_images/RESTWebAppsConstitutionDivideWar.png" style="width: 100%;" /></a>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>RESTful Web Serviceとクライアントアプリケーションを一つのWebアプリケーションとして構築する際の構成イメージは以下の通り。</p>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/RESTWebAppsConstitutionDivideServlet.png"><img alt="Constitution of RESTful Web Service" src="../_images/RESTWebAppsConstitutionDivideServlet.png" style="width: 100%;" /></a>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="resthowtouseapplicationsettings">
<span id="id28"></span><h3><a class="toc-backref" href="#id97">5.16.4.2. アプリケーションの設定</a><a class="headerlink" href="#resthowtouseapplicationsettings" title="Permalink to this headline">¶</a></h3>
<p>RESTful Web Service向けのアプリケーションの設定について説明する。</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>StAX(Streaming API for XML)使用時のDOS攻撃対策について</strong></p>
<p class="last">XML形式のデータをStAXを使用して解析する場合は、DTDを使ったDOS攻撃を受けないように対応する必要がある。
詳細は、<a class="reference external" href="http://pivotal.io/security/cve-2015-3192">CVE-2015-3192 - DoS Attack with XML Input</a>を参照されたい。</p>
</div>
<div class="section" id="restful-web-servicespring-mvc">
<span id="resthowtouseapplicationsettingsofspringmvc"></span><h4><a class="toc-backref" href="#id98">5.16.4.2.1. RESTful Web Serviceで必要となるSpring MVCのコンポーネントを有効化するための設定</a><a class="headerlink" href="#restful-web-servicespring-mvc" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">RESTful Web Service用のbean定義ファイルを作成する。</div>
<div class="line">以降の説明で示すサンプルを動かす際に必要となる定義を、以下に示す。</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">spring-mvc-rest.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
    <span class="na">xmlns:mvc=</span><span class="s">&quot;http://www.springframework.org/schema/mvc&quot;</span>
    <span class="na">xmlns:util=</span><span class="s">&quot;http://www.springframework.org/schema/util&quot;</span>
    <span class="na">xmlns:aop=</span><span class="s">&quot;http://www.springframework.org/schema/aop&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;</span>
<span class="s">        http://www.springframework.org/schema/mvc</span>
<span class="s">        http://www.springframework.org/schema/mvc/spring-mvc.xsd</span>
<span class="s">        http://www.springframework.org/schema/beans</span>
<span class="s">        http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">        http://www.springframework.org/schema/util</span>
<span class="s">        http://www.springframework.org/schema/util/spring-util.xsd</span>
<span class="s">        http://www.springframework.org/schema/context</span>
<span class="s">        http://www.springframework.org/schema/context/spring-context.xsd</span>
<span class="s">        http://www.springframework.org/schema/aop</span>
<span class="s">        http://www.springframework.org/schema/aop/spring-aop.xsd</span>
<span class="s">&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- Load properties files for placeholder. --&gt;</span>
<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span>    <span class="nt">&lt;context:property-placeholder</span>
        <span class="na">location=</span><span class="s">&quot;classpath*:/META-INF/spring/*.properties&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;jsonMessageConverter&quot;</span>
        <span class="na">class=</span><span class="s">&quot;org.springframework.http.converter.json.MappingJackson2HttpMessageConverter&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;objectMapper&quot;</span> <span class="na">ref=</span><span class="s">&quot;objectMapper&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;objectMapper&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.http.converter.json.Jackson2ObjectMapperFactoryBean&quot;</span><span class="nt">&gt;</span>
<span class="hll">        <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dateFormat&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">            <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;com.fasterxml.jackson.databind.util.StdDateFormat&quot;</span> <span class="nt">/&gt;</span>
</span>        <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!-- Register components of Spring MVC. --&gt;</span>
<span class="hll">    <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">     <span class="nt">&lt;mvc:annotation-driven&gt;</span>
</span><span class="hll">        <span class="nt">&lt;mvc:message-converters</span> <span class="na">register-defaults=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
</span>            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;jsonMessageConverter&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/mvc:message-converters&gt;</span>
<span class="hll">        <span class="c">&lt;!-- (4) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;mvc:argument-resolvers&gt;</span>
</span><span class="hll">            <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.data.web.PageableHandlerMethodArgumentResolver&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">        <span class="nt">&lt;/mvc:argument-resolvers&gt;</span>
</span>    <span class="nt">&lt;/mvc:annotation-driven&gt;</span>

    <span class="c">&lt;!-- Register components of interceptor. --&gt;</span>
<span class="hll">    <span class="c">&lt;!-- (5) --&gt;</span>
</span>    <span class="nt">&lt;mvc:interceptors&gt;</span>
        <span class="nt">&lt;mvc:interceptor&gt;</span>
            <span class="nt">&lt;mvc:mapping</span> <span class="na">path=</span><span class="s">&quot;/**&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.logging.TraceLoggingInterceptor&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/mvc:interceptor&gt;</span>
        <span class="c">&lt;!-- omitted --&gt;</span>
    <span class="nt">&lt;/mvc:interceptors&gt;</span>

    <span class="c">&lt;!-- Scan &amp; register components of RESTful Web Service. --&gt;</span>
<span class="hll">    <span class="c">&lt;!-- (6) --&gt;</span>
</span>    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">&quot;com.example.project.api&quot;</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!-- Register components of AOP. --&gt;</span>
<span class="hll">    <span class="c">&lt;!-- (7) --&gt;</span>
</span>    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;handlerExceptionResolverLoggingInterceptor&quot;</span>
        <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.HandlerExceptionResolverLoggingInterceptor&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionLogger&quot;</span> <span class="na">ref=</span><span class="s">&quot;exceptionLogger&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;aop:config&gt;</span>
        <span class="nt">&lt;aop:advisor</span> <span class="na">advice-ref=</span><span class="s">&quot;handlerExceptionResolverLoggingInterceptor&quot;</span>
            <span class="na">pointcut=</span><span class="s">&quot;execution(* org.springframework.web.servlet.HandlerExceptionResolver.resolveException(..))&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/aop:config&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アプリケーション層のコンポーネントでプロパティファイルに定義されている値を参照する必要がある場合は、<code class="docutils literal"><span class="pre">&lt;context:property-placeholder&gt;</span></code>要素を使用してプロパティファイルを読み込む必要がある。</div>
<div class="line">プロパティファイルから値を取得する方法の詳細ついては、「<a class="reference internal" href="PropertyManagement.html"><span class="doc">プロパティ管理</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JSONの日付フィールドの形式をISO-8601の拡張形式として扱うための設定を追加する。</div>
<div class="line">なお、リソースを表現するJavaBean(Resourceクラス)のプロパティとしてJSR-310 Date and Time APIやJoda Timeのクラスを使用する場合は、「<a class="reference internal" href="#restappendixusingjsr310-jodatime"><span class="std std-ref">JSR-310 Date and Time API / Joda Timeを使う場合の設定</span></a>」を行う必要がある。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">RESTful Web Serviceを提供するために必要となるSpring MVCのフレームワークコンポーネントをbean登録する。</div>
<div class="line">本設定を行うことで、リソースのフォーマットとしてJSONを使用する事ができる。</div>
<div class="line">上記例では、<code class="docutils literal"><span class="pre">&lt;mvc:message-converters</span></code>&gt;要素のregister-defaults属性を<code class="docutils literal"><span class="pre">false</span></code>にしているので、リソースの形式はJSONに限定される。</div>
<div class="line"><br /></div>
<div class="line">リソースのフォーマットとしてXMLを使用する場合は、XXE Injection対策が行われているXML用の<code class="docutils literal"><span class="pre">MessageConverter</span></code>を指定すること。指定方法は、「<a class="reference internal" href="#restappendixenabledxxeinjectprotection"><span class="std std-ref">XXE Injection対策の有効化</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ページ検索機能を有効にするための設定を追加する。</div>
<div class="line">ページ検索の詳細については、「<a class="reference internal" href="Pagination.html"><span class="doc">ページネーション</span></a>」を参照されたい。</div>
<div class="line">ページ検索が必要ない場合は、本設定は不要であるが、定義があっても問題はない。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring MVCのインターセプタをbean登録する。</div>
<div class="line">上記例では、共通ライブラリから提供されている<code class="docutils literal"><span class="pre">TraceLoggingInterceptor</span></code>のみを定義しているが、データアクセスとしてJPAを使う場合は、別途<code class="docutils literal"><span class="pre">OpenEntityManagerInViewInterceptor</span></code>の設定を追加する必要がある。</div>
<div class="line"><code class="docutils literal"><span class="pre">OpenEntityManagerInViewInterceptor</span></code>については、「<a class="reference internal" href="DataAccessJpa.html"><span class="doc">データベースアクセス（JPA編）</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">RESTful Web Service用のアプリケーション層のコンポーネント(ControllerやHelperクラスなど)をスキャンしてbean登録する。</div>
<div class="line"><code class="docutils literal"><span class="pre">&quot;com.example.project.api&quot;</span></code>の部分は<strong>プロジェクト毎のパッケージ名となる。</strong></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring MVCのフレームワークでハンドリングされた例外を、ログ出力するためのAOP定義を指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">HandlerExceptionResolverLoggingInterceptor</span></code>については、「<a class="reference internal" href="ExceptionHandling.html"><span class="doc">例外ハンドリング</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>ObjectMapperのBean定義方法について</strong></p>
<p>Jacksonの<code class="docutils literal"><span class="pre">com.fasterxml.jackson.databind.ObjectMapper</span></code>のBean定義を行う場合は、
Springが提供している<code class="docutils literal"><span class="pre">Jackson2ObjectMapperFactoryBean</span></code>を使用するとよい。
<code class="docutils literal"><span class="pre">Jackson2ObjectMapperFactoryBean</span></code>を使用すると、JSR-310 Date and Time APIやJoda Time用の拡張モジュールを自動登録することができ、
さらにXMLのBean定義ファイル上で表現が難しかった<code class="docutils literal"><span class="pre">ObjectMapper</span></code>のコンフィギュレーションも簡単に行うことができる。</p>
<p>なお、<code class="docutils literal"><span class="pre">ObjectMapper</span></code>を直接Bean定義するスタイルから<code class="docutils literal"><span class="pre">Jackson2ObjectMapperFactoryBean</span></code>を使用するスタイルに変更する場合は、
以下のコンフィギュレーションに対するデフォルト値がJacksonのデフォルト値と異なる(無効化されている)点に注意すること。</p>
<ul class="simple">
<li><a class="reference external" href="http://fasterxml.github.io/jackson-databind/javadoc/2.6/com/fasterxml/jackson/databind/MapperFeature.html?is-external=true#DEFAULT_VIEW_INCLUSION">MapperFeature#DEFAULT_VIEW_INCLUSION</a></li>
<li><a class="reference external" href="http://fasterxml.github.io/jackson-databind/javadoc/2.6/com/fasterxml/jackson/databind/DeserializationFeature.html?is-external=true#FAIL_ON_UNKNOWN_PROPERTIES">DeserializationFeature#FAIL_ON_UNKNOWN_PROPERTIES</a></li>
</ul>
<p><code class="docutils literal"><span class="pre">ObjectMapper</span></code>の動作をJacksonのデフォルト動作にあわせたい場合は、<code class="docutils literal"><span class="pre">featuresToEnable</span></code>プロパティを使用して上記のコンフィギュレーションを有効化する。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;objectMapper&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.http.converter.json.Jackson2ObjectMapperFactoryBean&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;featuresToEnable&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;array&gt;</span>
            <span class="nt">&lt;util:constant</span> <span class="na">static-field=</span><span class="s">&quot;com.fasterxml.jackson.databind.MapperFeature.DEFAULT_VIEW_INCLUSION&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;util:constant</span> <span class="na">static-field=</span><span class="s">&quot;com.fasterxml.jackson.databind.DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/array&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
</div></blockquote>
<p class="last"><code class="docutils literal"><span class="pre">Jackson2ObjectMapperFactoryBean</span></code>の詳細については、 <a class="reference external" href="http://docs.spring.io/spring/docs/4.2.4.RELEASE/javadoc-api/org/springframework/http/converter/json/Jackson2ObjectMapperFactoryBean.html">Jackson2ObjectMapperFactoryBeanのJavaDoc</a>を参照されたい。</p>
</div>
<div class="admonition note" id="rest-note-changed-jackson-version">
<p class="first admonition-title">Note</p>
<p><strong>jackson version 1.x.x から jackson version 2.x.xへ変更する場合の注意点</strong></p>
<ul class="simple">
<li>パッケージの変更</li>
</ul>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">verision</th>
<th class="head">package</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">1.x.x</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><cite>org.codehaus.jackson</cite></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">2.x.x</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><cite>com.fasterxml.jackson</cite></div>
</div>
</td>
</tr>
</tbody>
</table>
<ul class="simple">
<li>注意事項として、配下のパッケージ構成も変更されている。</li>
</ul>
</div></blockquote>
<ul class="simple">
<li>Deprecated一覧</li>
</ul>
<blockquote class="last">
<div><ul class="simple">
<li><a class="reference external" href="http://fasterxml.github.io/jackson-core/javadoc/2.6/deprecated-list.html">http://fasterxml.github.io/jackson-core/javadoc/2.6/deprecated-list.html</a></li>
<li><a class="reference external" href="http://fasterxml.github.io/jackson-databind/javadoc/2.6/deprecated-list.html">http://fasterxml.github.io/jackson-databind/javadoc/2.6/deprecated-list.html</a></li>
<li><a class="reference external" href="http://fasterxml.github.io/jackson-annotations/javadoc/2.6/deprecated-list.html">http://fasterxml.github.io/jackson-annotations/javadoc/2.6/deprecated-list.html</a></li>
</ul>
</div></blockquote>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="resthowtouseapplicationsettingsofdispatcherservlet">
<span id="id29"></span><h4><a class="toc-backref" href="#id99">5.16.4.2.2. RESTful Web Service用のサーブレットの設定</a><a class="headerlink" href="#resthowtouseapplicationsettingsofdispatcherservlet" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">下記の設定は、RESTful Web Serviceとクライアントアプリケーションを別のWebアプリケーションとして構築する場合の設定例となっている。</div>
<div class="line">RESTful Web Serviceとクライアントアプリケーションを同じWebアプリケーションとして構築する場合は、 「<a class="reference internal" href="#restappendixsettingsofdeployinsamewarfilerestandclientapplication"><span class="std std-ref">RESTful Web Serviceとクライアントアプリケーションを同じWebアプリケーションとして動かす際の設定</span></a>」を行う必要がある。</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">web.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;servlet&gt;</span>
<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;servlet-name&gt;</span>restAppServlet<span class="nt">&lt;/servlet-name&gt;</span>
</span>    <span class="nt">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="nt">&lt;/servlet-class&gt;</span>
    <span class="nt">&lt;init-param&gt;</span>
        <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
<span class="hll">        <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;param-value&gt;</span>classpath*:META-INF/spring/spring-mvc-rest.xml<span class="nt">&lt;/param-value&gt;</span>
</span>    <span class="nt">&lt;/init-param&gt;</span>
    <span class="nt">&lt;load-on-startup&gt;</span>1<span class="nt">&lt;/load-on-startup&gt;</span>
<span class="nt">&lt;/servlet&gt;</span>
<span class="hll"><span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll"><span class="nt">&lt;servlet-mapping&gt;</span>
</span><span class="hll">    <span class="nt">&lt;servlet-name&gt;</span>restAppServlet<span class="nt">&lt;/servlet-name&gt;</span>
</span><span class="hll">    <span class="nt">&lt;url-pattern&gt;</span>/api/v1/*<span class="nt">&lt;/url-pattern&gt;</span>
</span><span class="hll"><span class="nt">&lt;/servlet-mapping&gt;</span>
</span>
<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;servlet-name&gt;</span></code>要素に、RESTful Web Service用のサーブレットであることを示す名前を指定する。</div>
<div class="line">上記例では、サーブレット名として<code class="docutils literal"><span class="pre">&quot;restAppServlet&quot;</span></code>を指定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">RESTful Web Service用の<code class="docutils literal"><span class="pre">DispatcherServlet</span></code>を構築する際に使用するSpring MVCのbean定義ファイルを指定する。</div>
<div class="line">上記例では、Spring MVCのbean定義ファイルとして、クラスパス上にある<code class="file docutils literal"><span class="pre">META-INF/spring/spring-mvc-rest.xml</span></code>を指定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">RESTful Web Service用の<code class="docutils literal"><span class="pre">DispatcherServlet</span></code>へマッピングするサーブレットパスのパターンの指定を行う。</div>
<div class="line">上記例では、<code class="docutils literal"><span class="pre">&quot;/api/v1/&quot;</span></code>配下のサーブレットパスをRESTful Web Service用の<code class="docutils literal"><span class="pre">DispatcherServlet</span></code>にマッピングしている。</div>
<div class="line">具体的には、</div>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">&quot;/api/v1/&quot;</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">&quot;/api/v1/members&quot;</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">&quot;/api/v1/members/xxxxx&quot;</span></code></div>
</div>
<div class="line">といったサーブレットパスが、RESTful Web Service用の<code class="docutils literal"><span class="pre">DispatcherServlet</span></code>(<code class="docutils literal"><span class="pre">&quot;restAppServlet&quot;</span></code>)にマッピングされる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>&#64;RequestMappingアノテーションのvalue属性に指定する値について</strong></p>
<p><code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>アノテーションのvalue属性に指定する値は、<code class="docutils literal"><span class="pre">&lt;url-pattern&gt;</span></code>要素で指定したワイルドカード(<code class="docutils literal"><span class="pre">*</span></code>)の部分の値を指定する。</p>
<p>例えば、<code class="docutils literal"><span class="pre">&#64;RequestMapping(value</span> <span class="pre">=</span> <span class="pre">&quot;members&quot;)</span></code>と指定した場合、<code class="docutils literal"><span class="pre">&quot;/api/v1/members&quot;</span></code>といパスに対する処理を行うメソッドとしてデプロイされる。
そのため、<code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>アノテーションのvalue属性には、分割したサーブレットへマッピングするためパス(<code class="docutils literal"><span class="pre">&quot;api/v1&quot;</span></code>)を指定する必要はない。</p>
<p class="last"><code class="docutils literal"><span class="pre">&#64;RequestMapping(value</span> <span class="pre">=</span> <span class="pre">&quot;api/v1/members&quot;)</span></code>と指定すると、<code class="docutils literal"><span class="pre">&quot;/api/v1/api/v1/members&quot;</span></code>というパスに対する処理を行うメソッドとしてデプロイされてしまうので、注意すること。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="resthowtouseapiimplementation">
<span id="id30"></span><h3><a class="toc-backref" href="#id100">5.16.4.3. REST APIの実装</a><a class="headerlink" href="#resthowtouseapiimplementation" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">REST APIの実装方法について説明する。</div>
<div class="line">以降の説明では、ショッピングサイトの会員情報(Memberリソース)に対するREST APIの実装例を使用して、説明を行う。</div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>本節では、ドメイン層の実装の説明は行わないが、「<a class="reference internal" href="#restappendixsorucecodesofdomainlayer"><span class="std std-ref">REST API実装時に作成したドメイン層のクラスのソースコード</span></a>」として、添付しておく。</p>
<p class="last">必要に応じて、参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>まず、説明で使用するREST APIの仕様を以下に示す。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p><strong>リソースの形式</strong></p>
<blockquote>
<div><div class="line-block">
<div class="line">会員情報のリソースの形式は、以下のようなJSON形式とする。</div>
<div class="line">下記の例では、全フィールドを表示しているが、全てのAPIのリクエストとレスポンスで使用するわけではない。</div>
<div class="line">例えば、<code class="docutils literal"><span class="pre">&quot;password&quot;</span></code>はリクエストのみで使用、<code class="docutils literal"><span class="pre">&quot;createdAt&quot;</span></code>や<code class="docutils literal"><span class="pre">&quot;lastModifiedAt&quot;</span></code>はレスポンスのみ使用などの違いがある。</div>
</div>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;memberId&quot;</span> <span class="p">:</span> <span class="s2">&quot;M000000001&quot;</span><span class="p">,</span>
    <span class="nt">&quot;firstName&quot;</span> <span class="p">:</span> <span class="s2">&quot;Firstname&quot;</span><span class="p">,</span>
    <span class="nt">&quot;lastName&quot;</span> <span class="p">:</span> <span class="s2">&quot;Lastname&quot;</span><span class="p">,</span>
    <span class="nt">&quot;genderCode&quot;</span> <span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;dateOfBirth&quot;</span> <span class="p">:</span> <span class="s2">&quot;1977-03-13&quot;</span><span class="p">,</span>
    <span class="nt">&quot;emailAddress&quot;</span> <span class="p">:</span> <span class="s2">&quot;user1@test.com&quot;</span><span class="p">,</span>
    <span class="nt">&quot;telephoneNumber&quot;</span> <span class="p">:</span> <span class="s2">&quot;09012345678&quot;</span><span class="p">,</span>
    <span class="nt">&quot;zipCode&quot;</span> <span class="p">:</span> <span class="s2">&quot;1710051&quot;</span><span class="p">,</span>
    <span class="nt">&quot;address&quot;</span> <span class="p">:</span> <span class="s2">&quot;Tokyo&quot;</span><span class="p">,</span>
    <span class="nt">&quot;credential&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;signId&quot;</span> <span class="p">:</span> <span class="s2">&quot;user1@test.com&quot;</span><span class="p">,</span>
        <span class="nt">&quot;password&quot;</span> <span class="p">:</span> <span class="s2">&quot;zaq12wsx&quot;</span><span class="p">,</span>
        <span class="nt">&quot;passwordLastChangedAt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-03-13T04:39:14.831Z&quot;</span><span class="p">,</span>
        <span class="nt">&quot;lastModifiedAt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-03-13T04:39:14.831Z&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;createdAt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-03-13T04:39:14.831Z&quot;</span><span class="p">,</span>
    <span class="nt">&quot;lastModifiedAt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-03-13T04:39:14.831Z&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">本節では、関連リソースへのハイパーメディアリンクは設けない例となっている。
ハイパーメディアリンクを設ける場合の実装例は、「<a class="reference internal" href="#restappendixhypermedialink"><span class="std std-ref">ハイパーメディアリンクの実装</span></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p><strong>リソースの項目仕様</strong></p>
<blockquote>
<div><p>リソース(JSON)の項目毎の仕様は以下の通りとする。</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="11%" />
<col width="22%" />
<col width="11%" />
<col width="11%" />
<col width="17%" />
<col width="28%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">項目名</th>
<th class="head">型</th>
<th class="head">I/O仕様</th>
<th class="head">桁数
(min-max)</th>
<th class="head">その他の仕様</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>memberId</td>
<td>String</td>
<td>I/O</td>
<td>10-10</td>
<td>POST Membersのリクエスト時は未指定(NULL)であること。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>firstName</td>
<td>String</td>
<td>I/O</td>
<td>1-128</td>
<td>-</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>lastName</td>
<td>String</td>
<td>I/O</td>
<td>1-128</td>
<td>-</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>genderCode</td>
<td><div class="first last line-block">
<div class="line">String</div>
<div class="line">(Code)</div>
</div>
</td>
<td>I/O</td>
<td>1-1</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&quot;0&quot;</span></code> : UNKNOWN</div>
<div class="line"><code class="docutils literal"><span class="pre">&quot;1&quot;</span></code> : MEN</div>
<div class="line"><code class="docutils literal"><span class="pre">&quot;2&quot;</span></code> : WOMEN</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>dateOfBirth</td>
<td>Date</td>
<td>I/O</td>
<td>-</td>
<td><div class="first last line-block">
<div class="line">yyyy-MM-dd形式</div>
<div class="line">(ISO-8601拡張形式)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td>emailAddress</td>
<td><div class="first last line-block">
<div class="line">String</div>
<div class="line">(E-mail)</div>
</div>
</td>
<td>I/O</td>
<td>1-256</td>
<td>-</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td>telephoneNumber</td>
<td>String</td>
<td>I/O</td>
<td>0-20</td>
<td>-</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td>zipCode</td>
<td>String</td>
<td>I/O</td>
<td>0-20</td>
<td>-</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td>address</td>
<td>String</td>
<td>I/O</td>
<td>0-256</td>
<td>-</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td>credential</td>
<td><div class="first last line-block">
<div class="line">Object</div>
<div class="line">(MemberCredential)</div>
</div>
</td>
<td>I/O</td>
<td>-</td>
<td>POST Membersのリクエスト時は指定されていること。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td>credential/signId</td>
<td><div class="first last line-block">
<div class="line">String</div>
<div class="line">(E-mail)</div>
</div>
</td>
<td>I/O</td>
<td>0-256</td>
<td>指定がない場合は、emailAddressの値を適用する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">credential/</div>
<div class="line">password</div>
</div>
</td>
<td>String</td>
<td>I</td>
<td>8-32</td>
<td>-</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(13)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">credential/</div>
<div class="line">passwordLastChangedAt</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Timestamp</div>
<div class="line">with time-zone</div>
</div>
</td>
<td>O</td>
<td>-</td>
<td><div class="first last line-block">
<div class="line">yyyy-MM-dd’T’HH:mm:ss.SSS’Z’形式</div>
<div class="line">(ISO-8601拡張形式)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(14)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">credential/</div>
<div class="line">lastModifiedAt</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Timestamp</div>
<div class="line">with time-zone</div>
</div>
</td>
<td>O</td>
<td>-</td>
<td><div class="first last line-block">
<div class="line">yyyy-MM-dd’T’HH:mm:ss.SSS’Z’形式</div>
<div class="line">(ISO-8601拡張形式)</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(15)</div>
</div>
</td>
<td>createdAt</td>
<td><div class="first last line-block">
<div class="line">Timestamp</div>
<div class="line">with time-zone</div>
</div>
</td>
<td>O</td>
<td>-</td>
<td><div class="first last line-block">
<div class="line">yyyy-MM-dd’T’HH:mm:ss.SSS’Z’形式</div>
<div class="line">(ISO-8601拡張形式)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(16)</div>
</div>
</td>
<td>lastModifiedAt</td>
<td><div class="first last line-block">
<div class="line">Timestamp</div>
<div class="line">with time-zone</div>
</div>
</td>
<td>O</td>
<td>-</td>
<td><div class="first last line-block">
<div class="line">yyyy-MM-dd’T’HH:mm:ss.SSS’Z’形式</div>
<div class="line">(ISO-8601拡張形式)</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p><strong>REST API一覧</strong></p>
<blockquote>
<div><p>実装するREST APIは以下の5つのAPIとする。</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="15%" />
<col width="10%" />
<col width="25%" />
<col width="15%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">API名</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">HTTP</div>
<div class="line">メソッド</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">リソースパス</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">ステータス</div>
<div class="line">コード</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">API概要</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><a class="reference internal" href="#resthowtouseapiimplementationofgetcollection"><span class="std std-ref">GET Members</span></a></td>
<td>GET</td>
<td><code class="docutils literal"><span class="pre">/api/v1/members</span></code></td>
<td><div class="first last line-block">
<div class="line">200</div>
<div class="line">(OK)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">条件に一致するMemberリソースをページ検索する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><a class="reference internal" href="#resthowtouseapiimplementationofpostcollection"><span class="std std-ref">POST Members</span></a></td>
<td>POST</td>
<td><code class="docutils literal"><span class="pre">/api/v1/members</span></code></td>
<td><div class="first last line-block">
<div class="line">201</div>
<div class="line">(Created)</div>
</div>
</td>
<td>Memberリソースを一件作成する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><a class="reference internal" href="#resthowtouseapiimplementationofgetspecifiedresource"><span class="std std-ref">GET Member</span></a></td>
<td>GET</td>
<td><code class="docutils literal"><span class="pre">/api/v1/members/{memberId}</span></code></td>
<td><div class="first last line-block">
<div class="line">200</div>
<div class="line">(OK)</div>
</div>
</td>
<td>Memberリソースの一件取得する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><a class="reference internal" href="#resthowtouseapiimplementationofputspecifiedresource"><span class="std std-ref">PUT Member</span></a></td>
<td>PUT</td>
<td><code class="docutils literal"><span class="pre">/api/v1/members/{memberId}</span></code></td>
<td><div class="first last line-block">
<div class="line">200</div>
<div class="line">(OK)</div>
</div>
</td>
<td>Memberリソースを一件更新する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><a class="reference internal" href="#resthowtouseapiimplementationofdeletespecifiedresource"><span class="std std-ref">DELETE Member</span></a></td>
<td>DELETE</td>
<td><code class="docutils literal"><span class="pre">/api/v1/members/{memberId}</span></code></td>
<td><div class="first last line-block">
<div class="line">204</div>
<div class="line">(No Content)</div>
</div>
</td>
<td>Memberリソースを一件削除する。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">本節では、リソースのCRUD操作の説明に注力するため、HEADとOPTIONSメソッドの説明は行わない。
HTTPの仕様に準拠したRESTful Web Serviceを作成する場合は、「<a class="reference internal" href="#restappendixrestapiofhttpcompliance"><span class="std std-ref">HTTPの仕様に準拠したRESTful Web Serviceの作成</span></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="resthowtousepackage">
<span id="id31"></span><h4><a class="toc-backref" href="#id101">5.16.4.3.1. REST API用パッケージの作成</a><a class="headerlink" href="#resthowtousepackage" title="Permalink to this headline">¶</a></h4>
<p>REST API用のクラスを格納するパッケージを作成する。</p>
<div class="line-block">
<div class="line">REST API用のクラスを格納するルートパッケージのパッケージ名は<code class="docutils literal"><span class="pre">api</span></code>として、配下にリソース毎のパッケージ(リソース名の小文字)を作成する事を推奨する。</div>
<div class="line">説明で扱うリソース名は<code class="docutils literal"><span class="pre">Member</span></code>なので、<code class="docutils literal"><span class="pre">org.terasoluna.examples.rest.api.member</span></code>というパッケージとする。</div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>作成したパッケージに格納するクラスは、通常以下の4種類となる。
作成するクラスのクラス名は、以下のネーミングルールとする事を推奨する。</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">[リソース名]Resource</span></code></li>
<li><code class="docutils literal"><span class="pre">[リソース名]RestController</span></code></li>
<li><code class="docutils literal"><span class="pre">[リソース名]Validator</span></code> (必要に応じて作成する)</li>
<li><code class="docutils literal"><span class="pre">[リソース名]Helper</span></code> (必要に応じて作成する)</li>
</ul>
</div></blockquote>
<p>説明で扱うリソースのリソース名は<code class="docutils literal"><span class="pre">Member</span></code>なので、</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">MemberResource</span></code></li>
<li><code class="docutils literal"><span class="pre">MemberRestController</span></code></li>
<li><code class="docutils literal"><span class="pre">MemberValidator</span></code></li>
<li><code class="docutils literal"><span class="pre">MemberHelper</span></code></li>
</ul>
</div></blockquote>
<p>となる。</p>
<p class="last">関連リソースを扱う場合、関連リソース用のクラスも同じパッケージに配置すればよい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">REST API用の共通部品を格納するパッケージは、REST API用のクラスを格納するルートパッケージ直下に<code class="docutils literal"><span class="pre">common</span></code>という名前で作成し、サブパッケージは機能単位に作成する事を推奨する。</div>
<div class="line">例えば、エラーハンドリングを行う共通部品を格納するサブパッケージの場合、<code class="docutils literal"><span class="pre">error</span></code>という名前でサブパッケージを作成する。</div>
<div class="line">以降の説明で作成する例外ハンドリング用のクラスは、<code class="docutils literal"><span class="pre">org.terasoluna.examples.rest.api.common.error</span></code>というパッケージに格納している。</div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">共通部品が格納されているパッケージという事がわかれば、パッケージ名は<code class="docutils literal"><span class="pre">common</span></code>以外でもよい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="resource">
<span id="resthowtouseresourceclass"></span><h4><a class="toc-backref" href="#id102">5.16.4.3.2. Resourceクラスの作成</a><a class="headerlink" href="#resource" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">本ガイドラインでは、Web上に公開するリソースを表現(JSONやXMLを表現)するクラスとして、Resourceクラスを設けることを推奨する。</div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Resourceクラスを作成する理由</strong></p>
<p>DomainObjectクラス(例えばEntityクラス)があるにも関わらず、Resourceクラスを作成する理由は、
クライアントとの入出力で使用するユーザーインタフェース(UI)上の情報と業務処理で扱う情報は必ずしも一致しないためである。</p>
<p class="last">これらを混同して使用すると、アプリケーション層の影響がドメイン層におよび、保守性を低下させる原因となる。
DomainObjectとResourceクラスは別々に作成し、Dozer等のBeanMapperを利用してデータ変換を行うことを推奨する。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Resourceクラスの役割は以下の通りである。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="30%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">役割</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースのデータ構造の定義を行う。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Web上に公開するリソースのデータ構造を定義する。</div>
<div class="line">データベースなどの永続層で管理しているデータの構造のままWeb上のリソースとして公開する事は、一般的には稀である。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フォーマットに関する定義を行う。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースのフォーマットに関する定義を、アノテーションを使って指定する。</div>
<div class="line">使用するアノテーションは、リソースの形式(JSON/XMLなど)よって異なり、JSON形式の場合はJacksonのアノテーション、XML形式の場合はJAXBのアノテーションを使用する事になる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力チェックルールの定義を行う。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">項目毎の単項目の入力チェックルールを、Bean Validationのアノテーションを使って指定する。</div>
<div class="line">入力チェックの詳細については、「<a class="reference internal" href="Validation.html"><span class="doc">入力チェック</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>循環参照への対策</strong></p>
<p>Resourceクラス(JavaBean)をJSONやXML形式にシリアライズする際に、相互参照関係のオブジェクトをプロパティに保持していると、
循環参照となり<code class="docutils literal"><span class="pre">StackOverflowError</span></code>や<code class="docutils literal"><span class="pre">OutOfMemoryError</span></code>などが発生するので、注意が必要である。</p>
<p>循環参照を回避するためには、</p>
<ul class="simple">
<li>Jacksonを使用してJSON形式にシリアライズする場合は、シリアライズ対象から除外するプロパティに<code class="docutils literal"><span class="pre">&#64;com.fasterxml.jackson.annotation.JsonIgnore</span></code>アノテーション</li>
<li>JAXBを使用してXML形式にシリアライズする場合は、シリアライズ対象から除外するプロパティに<code class="docutils literal"><span class="pre">javax.xml.bind.annotation.XmlTransient</span></code>アノテーション</li>
</ul>
<p>を付与すればよい。</p>
<p>以下にJacksonを使用してJSON形式にシリアライズする際の回避例を示す。</p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">orderId</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">OrderLine</span><span class="o">&gt;</span> <span class="n">orderLines</span><span class="p">;</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderLine</span> <span class="p">{</span>
    <span class="nd">@JsonIgnore</span>
    <span class="kd">private</span> <span class="n">Order</span> <span class="n">order</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">itemCode</span><span class="p">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">quantity</span><span class="p">;</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>シリアライズ対象から除外するプロパティに対して<code class="docutils literal"><span class="pre">&#64;JsonIgnore</span></code>アノテーションを付与する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>以下にResourceクラスの作成例を示す。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">MemberResource.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.examples.rest.api.member</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.Valid</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Null</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Past</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.hibernate.validator.constraints.Email</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.hibernate.validator.constraints.NotEmpty</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.joda.time.DateTime</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.joda.time.LocalDate</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.format.annotation.DateTimeFormat</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.codelist.ExistInCodeList</span><span class="p">;</span>

<span class="hll"><span class="c1">// (1)</span>
</span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberResource</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

<span class="hll">    <span class="c1">// (2)</span>
</span><span class="hll">    <span class="kd">interface</span> <span class="nc">PostMembers</span> <span class="p">{</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="hll">
</span><span class="hll">    <span class="kd">interface</span> <span class="nc">PutMember</span> <span class="p">{</span>
</span><span class="hll">    <span class="p">}</span>
</span>
    <span class="nd">@Null</span><span class="p">(</span><span class="n">groups</span> <span class="o">=</span> <span class="n">PostMembers</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
    <span class="nd">@NotEmpty</span><span class="p">(</span><span class="n">groups</span> <span class="o">=</span> <span class="n">PutMember</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
    <span class="nd">@Size</span><span class="p">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">PutMember</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">memberId</span><span class="p">;</span>

    <span class="nd">@NotEmpty</span>
    <span class="nd">@Size</span><span class="p">(</span><span class="n">max</span> <span class="o">=</span> <span class="mi">128</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">firstName</span><span class="p">;</span>

    <span class="nd">@NotEmpty</span>
    <span class="nd">@Size</span><span class="p">(</span><span class="n">max</span> <span class="o">=</span> <span class="mi">128</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">lastName</span><span class="p">;</span>

    <span class="nd">@NotEmpty</span>
    <span class="nd">@ExistInCodeList</span><span class="p">(</span><span class="n">codeListId</span> <span class="o">=</span> <span class="s">&quot;CL_GENDER&quot;</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">genderCode</span><span class="p">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Past</span>
    <span class="kd">private</span> <span class="n">LocalDate</span> <span class="n">dateOfBirth</span><span class="p">;</span>

    <span class="nd">@NotEmpty</span>
    <span class="nd">@Size</span><span class="p">(</span><span class="n">max</span> <span class="o">=</span> <span class="mi">256</span><span class="p">)</span>
    <span class="nd">@Email</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">emailAddress</span><span class="p">;</span>

    <span class="nd">@Size</span><span class="p">(</span><span class="n">max</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">telephoneNumber</span><span class="p">;</span>

    <span class="nd">@Size</span><span class="p">(</span><span class="n">max</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">zipCode</span><span class="p">;</span>

    <span class="nd">@Size</span><span class="p">(</span><span class="n">max</span> <span class="o">=</span> <span class="mi">256</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">address</span><span class="p">;</span>

    <span class="nd">@NotNull</span><span class="p">(</span><span class="n">groups</span> <span class="o">=</span> <span class="n">PostMembers</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
    <span class="nd">@Null</span><span class="p">(</span><span class="n">groups</span> <span class="o">=</span> <span class="n">PutMember</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
    <span class="nd">@Valid</span>
<span class="hll">    <span class="c1">// (3)</span>
</span>    <span class="kd">private</span> <span class="n">MemberCredentialResource</span> <span class="n">credential</span><span class="p">;</span>

    <span class="nd">@Null</span>
    <span class="kd">private</span> <span class="n">DateTime</span> <span class="n">createdAt</span><span class="p">;</span>

    <span class="nd">@Null</span>
    <span class="kd">private</span> <span class="n">DateTime</span> <span class="n">lastModifiedAt</span><span class="p">;</span>

    <span class="c1">// omitted setter and getter</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Memberリソースを表現するJavaBean。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Bean Validationのバリデーショングループを指定するためのインタフェースを定義している。</div>
<div class="line">実装例では、POSTとPUTで異なる入力チェックを行うため、バリデーションをグループ化して入力チェックを行っている。</div>
<div class="line">バリデーションのグループ化については、「<a class="reference internal" href="Validation.html"><span class="doc">入力チェック</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">関連リソースをネストしたJavaBeanをフィールドに定義している。</div>
<div class="line">実装例では、会員の資格情報(サインIDとパスワード)を関連リソースとして扱っている。</div>
<div class="line">これは、サインIDの変更やパスワードの変更のみ行うという操作を考慮して、関連リソースとして切り出している。</div>
<div class="line">ただし、関連リソースに対するREST APIの実装例については割愛している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">MemberCredentialResource.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.examples.rest.api.member</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Null</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.annotation.JsonInclude</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.hibernate.validator.constraints.Email</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.joda.time.DateTime</span><span class="p">;</span>

<span class="hll"><span class="c1">// (4)</span>
</span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberCredentialResource</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

    <span class="nd">@Size</span><span class="p">(</span><span class="n">max</span> <span class="o">=</span> <span class="mi">256</span><span class="p">)</span>
    <span class="nd">@Email</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">signId</span><span class="p">;</span>

<span class="hll">    <span class="c1">// (5)</span>
</span>    <span class="nd">@JsonInclude</span><span class="p">(</span><span class="n">JsonInclude</span><span class="p">.</span><span class="na">Include</span><span class="p">.</span><span class="na">NON_NULL</span><span class="p">)</span>
    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="p">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">32</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="p">;</span>

    <span class="nd">@Null</span>
    <span class="kd">private</span> <span class="n">DateTime</span> <span class="n">passwordLastChangedAt</span><span class="p">;</span>

    <span class="nd">@Null</span>
    <span class="kd">private</span> <span class="n">DateTime</span> <span class="n">lastModifiedAt</span><span class="p">;</span>

    <span class="c1">// omitted setter and getter</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Memberリソースの関連リソースとなるCredentialリソースを表現するJavaBean。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">値が<code class="docutils literal"><span class="pre">null</span></code>の時に、JSONにフィールド自体を出力しないようにするためのアノテーションを指定している。</div>
<div class="line">これは、レスポンスするJSONの中にパスワードのフィールド出力しないようにするために行っている。</div>
<div class="line">上記例ではNULLの場合(<code class="docutils literal"><span class="pre">Inclusion.NON_NULL</span></code>)に限っているが、値が空の場合(<code class="docutils literal"><span class="pre">Inclusion.NON_EMPTY</span></code>)という指定も可能である。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul>
<li><div class="first line-block">
<div class="line">Beanのマッピング定義の追加</div>
<div class="line">これから説明する実装例では、EntityクラスとResourceクラスのコピーは、「<a class="reference internal" href="Utilities/Dozer.html"><span class="doc">Beanマッピング(Dozer)</span></a>」を使って行う。</div>
<div class="line">上記に示したJavaBeanには、Joda-Timeのクラスである<code class="docutils literal"><span class="pre">org.joda.time.DateTime</span></code>と<code class="docutils literal"><span class="pre">org.joda.time.LocalDate</span></code>が含まれているが、「<a class="reference internal" href="Utilities/Dozer.html"><span class="doc">Beanマッピング(Dozer)</span></a>」を使ってコピーするとJoda-Timeのオブジェクトは正しくコピーされない。</div>
<div class="line">そのため、正しくコピーされるようにするためには、「<a class="reference internal" href="#restappendixcopyjodaobjectbybeanconvert"><span class="std std-ref">Dozerを使ってJoda-Timeのクラスをコピーする方法</span></a>」を適用する必要がある。</div>
</div>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="controller">
<span id="resthowtousecontrollerclass"></span><h4><a class="toc-backref" href="#id103">5.16.4.3.3. Controllerクラスの作成</a><a class="headerlink" href="#controller" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Controllerクラスはリソース毎に作成する。</div>
<div class="line">全てのAPIの実装が完了した際のソースコードについては、<a class="reference internal" href="#restappendixsorucecodesofmemberrestcontroller"><span class="std std-ref">Appendix</span></a>を参照されたい。</div>
</div>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.examples.rest.api.member</span><span class="p">;</span>

<span class="c1">// omitted</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span>
<span class="c1">// omitted</span>

<span class="hll"><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;members&quot;</span><span class="p">)</span> <span class="c1">// (1)</span>
</span><span class="hll"><span class="nd">@RestController</span> <span class="c1">// (2)</span>
</span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRestController</span> <span class="p">{</span>

    <span class="c1">// omitted ...</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Controllerに対して、リソースのコレクション用のURI(サーブレットパス)をマッピングする。</div>
<div class="line">具体的には、<code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>アノテーションのvalue属性に、リソースのコレクションを表すサーブレットパスを指定する。</div>
<div class="line">上記例では、 <code class="docutils literal"><span class="pre">/api/v1/members</span></code>というサーブレットパスをマッピングしている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p class="first">Controllerに対して、<code class="docutils literal"><span class="pre">&#64;RestController</span></code>アノテーションを付与する。</p>
<p><code class="docutils literal"><span class="pre">&#64;RestController</span></code>アノテーションを付与することで、</p>
<ul class="simple">
<li>クラスに<code class="docutils literal"><span class="pre">org.springframework.stereotype.Controller</span></code>アノテーションを付与</li>
<li>以降で説明するControllerのメソッドに<code class="docutils literal"><span class="pre">&#64;org.springframework.web.bind.annotation.ResponseBody</span></code>アノテーションを付与</li>
</ul>
<p>したのと同じ意味となる。</p>
<p class="last">Controllerのメソッドに<code class="docutils literal"><span class="pre">&#64;ResponseBody</span></code>を付与することで、返却したResourceオブジェクトがJSONやXMLにmarshalされ、レスポンスBODYに設定される。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><code class="docutils literal"><span class="pre">&#64;RestController</span></code>アノテーションは、Spring Framework 4.0 から追加されたアノテーションである。</p>
<p><code class="docutils literal"><span class="pre">&#64;RestController</span></code>アノテーションの登場により、Controllerの各メソッドに<code class="docutils literal"><span class="pre">&#64;ResponseBody</span></code>アノテーションを付与する必要がなくなったため、
REST API用のControllerをよりシンプルに作成出来るようになった。
<code class="docutils literal"><span class="pre">&#64;RestController</span></code>アノテーションの詳細については、<a class="reference external" href="http://docs.spring.io/spring/docs/4.2.4.RELEASE/javadoc-api/org/springframework/web/bind/annotation/RestController.html">こちら</a>を参照されたい。</p>
<p>従来通り<code class="docutils literal"><span class="pre">&#64;Controller</span></code>アノテーションと<code class="docutils literal"><span class="pre">&#64;ResponseBody</span></code>アノテーションを組み合わせてREST API用のControllerを作成する例を以下に示す。</p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;members&quot;</span><span class="p">)</span>
<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRestController</span> <span class="p">{</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="kd">public</span> <span class="n">Page</span><span class="o">&lt;</span><span class="n">MemberResource</span><span class="o">&gt;</span> <span class="nf">getMembers</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>

    <span class="c1">// ...</span>

<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="resthowtouseapiimplementationofgetcollection">
<span id="id33"></span><h4><a class="toc-backref" href="#id104">5.16.4.3.4. リソースのコレクションを取得するREST APIの実装</a><a class="headerlink" href="#resthowtouseapiimplementationofgetcollection" title="Permalink to this headline">¶</a></h4>
<p>URIで指定されたMemberリソースのコレクションをページ検索するREST APIの実装例を、以下に示す。</p>
<ul>
<li><div class="first line-block">
<div class="line">検索条件を受け取るためのJavaBeanの作成</div>
<div class="line">リソースのコレクションを取得する際に、検索条件が必要な場合は、検索条件を受け取るためのJavaBeanの作成する。</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="hll"><span class="c1">// (1)</span>
</span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MembersSearchQuery</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

<span class="hll">    <span class="c1">// (2)</span>
</span>    <span class="nd">@NotEmpty</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">検索条件を受け取るためのJavaBeanを作成する</div>
<div class="line">検索条件が不要な場合は、JavaBeanの作成は不要である。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">プロパティ名は、リクエストパラメータのパラメータ名と一致させる。</div>
<div class="line">上記例では、<code class="docutils literal"><span class="pre">/api/v1/members?name=John</span></code>というリクエストの場合、JavaBeanのnameプロパティに <code class="docutils literal"><span class="pre">&quot;John&quot;</span></code>という値が設定される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul>
<li><div class="first line-block">
<div class="line">REST APIの実装</div>
<div class="line">Memberリソースのコレクションをページ検索する処理を実装する。</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;members&quot;</span><span class="p">)</span>
<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRestController</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Inject</span>
    <span class="n">MemberService</span> <span class="n">memberService</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">Mapper</span> <span class="n">beanMapper</span><span class="p">;</span>

<span class="hll">    <span class="c1">// (3)</span>
</span>    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
<span class="hll">    <span class="c1">// (4)</span>
</span>    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">Page</span><span class="o">&lt;</span><span class="n">MemberResource</span><span class="o">&gt;</span> <span class="nf">getMembers</span><span class="p">(</span>
<span class="hll">            <span class="c1">// (5)</span>
</span>            <span class="nd">@Validated</span> <span class="n">MembersSearchQuery</span> <span class="n">query</span><span class="p">,</span>
<span class="hll">            <span class="c1">// (6)</span>
</span>            <span class="n">Pageable</span> <span class="n">pageable</span><span class="p">)</span> <span class="p">{</span>

<span class="hll">        <span class="c1">// (7)</span>
</span>        <span class="n">Page</span><span class="o">&lt;</span><span class="n">Member</span><span class="o">&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">memberService</span><span class="p">.</span><span class="na">searchMembers</span><span class="p">(</span><span class="n">query</span><span class="p">.</span><span class="na">getName</span><span class="p">(),</span> <span class="n">pageable</span><span class="p">);</span>

<span class="hll">        <span class="c1">// (8)</span>
</span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">MemberResource</span><span class="o">&gt;</span> <span class="n">memberResources</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Member</span> <span class="n">member</span> <span class="p">:</span> <span class="n">page</span><span class="p">.</span><span class="na">getContent</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">memberResources</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="n">MemberResource</span><span class="p">.</span><span class="na">class</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="n">Page</span><span class="o">&lt;</span><span class="n">MemberResource</span><span class="o">&gt;</span> <span class="n">responseResource</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PageImpl</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">memberResources</span><span class="p">,</span>
                <span class="n">pageable</span><span class="p">,</span> <span class="n">page</span><span class="p">.</span><span class="na">getTotalElements</span><span class="p">());</span>

<span class="hll">        <span class="c1">// (9)</span>
</span>        <span class="k">return</span> <span class="n">responseResource</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>アノテーションのmethod属性に、<code class="docutils literal"><span class="pre">RequestMethod.GET</span></code>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">メソッドアノテーションとして、<code class="docutils literal"><span class="pre">&#64;org.springframework.web.bind.annotation.ResponseStatus</span></code>アノテーションを付与し、応答するステータスコードを指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;ResponseStatus</span></code>アノテーションのvalue属性には、200(OK)を設定する。</div>
</div>
<div class="last admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>ステータスコードの指定方法について</strong></p>
<p>本例では、<code class="docutils literal"><span class="pre">&#64;ResponseStatus</span></code>アノテーションを使って応答するステータスコードを固定で指定しているが、Controllerのロジック内で指定する事もできる。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Page</span><span class="o">&lt;</span><span class="n">MemberResource</span><span class="o">&gt;&gt;</span> <span class="nf">getMembers</span><span class="p">(</span>
        <span class="nd">@Validated</span> <span class="n">MembersSearchQuery</span> <span class="n">query</span><span class="p">,</span>
        <span class="n">Pageable</span> <span class="n">pageable</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

    <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">().</span><span class="na">body</span><span class="p">(</span><span class="n">responseResource</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p class="last">応答するステータスコードを処理内容や処理結果に応じて変える必要がある場合は、上記実装例の様に、<code class="docutils literal"><span class="pre">org.springframework.http.ResponseEntity</span></code>を使用する事になる。</p>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">検索条件を受け取るためのJavaBeanを引数に指定する。</div>
<div class="line">入力チェックが必要な場合は、引数アノテーションとして、<code class="docutils literal"><span class="pre">&#64;Validated</span></code>アノテーションを付与する。入力チェックの詳細については、「<a class="reference internal" href="Validation.html"><span class="doc">入力チェック</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ページ検索が必要な場合は、<code class="docutils literal"><span class="pre">org.springframework.data.domain.Pageable</span></code>を引数に指定する。</div>
<div class="line">ページ検索の詳細については、「<a class="reference internal" href="Pagination.html"><span class="doc">ページネーション</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ドメイン層のServiceのメソッドを呼び出し、条件に一致するリソースの情報(Entityなど)を取得する。</div>
<div class="line">ドメイン層の実装については、「<a class="reference internal" href="../ImplementationAtEachLayer/DomainLayer.html"><span class="doc">ドメイン層の実装</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">条件に一致したリソースの情報(Entityなど)をもとに、Web上に公開する情報を保持するResourceオブジェクトを生成する。</div>
<div class="line">ページ検索の結果を応答する際は、 <code class="docutils literal"><span class="pre">org.springframework.data.domain.PageImpl</span></code>クラスを使用することで、ページ検索時の応答として必要な項目をクライアントに返却する事ができる。</div>
<div class="line"><br /></div>
<div class="line">上記例では、Beanマッピングライブラリを使用してEntityからResourceオブジェクトを生成している。Beanマッピングライブラリについては、「<a class="reference internal" href="Utilities/Dozer.html"><span class="doc">Beanマッピング(Dozer)</span></a>」を参照されたい。</div>
<div class="line"><strong>Resourceオブジェクトを生成するためのコード量が多くなる場合は、HelperクラスにResourceオブジェクトを生成するためのメソッドを作成することを推奨する。</strong></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(8)で生成したResourceオブジェクトを返却する。</div>
<div class="line">ここで返却したオブジェクトがJSONやXMLにmarshalされ、レスポンスBODYに設定される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">PageImpl</span></code>クラスを使用した時のレスポンスは以下の様になる。</div>
<div class="line">ハイライトしている部分が、ページ検索固有の項目となる。</div>
</div>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;content&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">{</span>
    <span class="nt">&quot;memberId&quot;</span> <span class="p">:</span> <span class="s2">&quot;M000000001&quot;</span><span class="p">,</span>
    <span class="nt">&quot;firstName&quot;</span> <span class="p">:</span> <span class="s2">&quot;John&quot;</span><span class="p">,</span>
    <span class="nt">&quot;lastName&quot;</span> <span class="p">:</span> <span class="s2">&quot;Smith&quot;</span><span class="p">,</span>
    <span class="nt">&quot;genderCode&quot;</span> <span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;dateOfBirth&quot;</span> <span class="p">:</span> <span class="s2">&quot;1977-03-07&quot;</span><span class="p">,</span>
    <span class="nt">&quot;emailAddress&quot;</span> <span class="p">:</span> <span class="s2">&quot;john.smith@test.com&quot;</span><span class="p">,</span>
    <span class="nt">&quot;telephoneNumber&quot;</span> <span class="p">:</span> <span class="s2">&quot;09012345678&quot;</span><span class="p">,</span>
    <span class="nt">&quot;zipCode&quot;</span> <span class="p">:</span> <span class="s2">&quot;1710051&quot;</span><span class="p">,</span>
    <span class="nt">&quot;address&quot;</span> <span class="p">:</span> <span class="s2">&quot;Tokyo&quot;</span><span class="p">,</span>
    <span class="nt">&quot;credential&quot;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;signId&quot;</span> <span class="p">:</span> <span class="s2">&quot;john.smit@test.com&quot;</span><span class="p">,</span>
      <span class="nt">&quot;passwordLastChangedAt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-03-13T10:18:08.003Z&quot;</span><span class="p">,</span>
      <span class="nt">&quot;lastModifiedAt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-03-13T10:18:08.003Z&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;createdAt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-03-13T10:18:08.003Z&quot;</span><span class="p">,</span>
    <span class="nt">&quot;lastModifiedAt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-03-13T10:18:08.003Z&quot;</span>
  <span class="p">},</span> <span class="p">{</span>
    <span class="nt">&quot;memberId&quot;</span> <span class="p">:</span> <span class="s2">&quot;M000000002&quot;</span><span class="p">,</span>
    <span class="nt">&quot;firstName&quot;</span> <span class="p">:</span> <span class="s2">&quot;Sophia&quot;</span><span class="p">,</span>
    <span class="nt">&quot;lastName&quot;</span> <span class="p">:</span> <span class="s2">&quot;Smith&quot;</span><span class="p">,</span>
    <span class="nt">&quot;genderCode&quot;</span> <span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
    <span class="nt">&quot;dateOfBirth&quot;</span> <span class="p">:</span> <span class="s2">&quot;1977-03-07&quot;</span><span class="p">,</span>
    <span class="nt">&quot;emailAddress&quot;</span> <span class="p">:</span> <span class="s2">&quot;sophia.smith@test.com&quot;</span><span class="p">,</span>
    <span class="nt">&quot;telephoneNumber&quot;</span> <span class="p">:</span> <span class="s2">&quot;09012345678&quot;</span><span class="p">,</span>
    <span class="nt">&quot;zipCode&quot;</span> <span class="p">:</span> <span class="s2">&quot;1710051&quot;</span><span class="p">,</span>
    <span class="nt">&quot;address&quot;</span> <span class="p">:</span> <span class="s2">&quot;Tokyo&quot;</span><span class="p">,</span>
    <span class="nt">&quot;credential&quot;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;signId&quot;</span> <span class="p">:</span> <span class="s2">&quot;sophia.smith@test.com&quot;</span><span class="p">,</span>
      <span class="nt">&quot;passwordLastChangedAt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-03-13T10:18:08.003Z&quot;</span><span class="p">,</span>
      <span class="nt">&quot;lastModifiedAt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-03-13T10:18:08.003Z&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;createdAt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-03-13T10:18:08.003Z&quot;</span><span class="p">,</span>
    <span class="nt">&quot;lastModifiedAt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-03-13T10:18:08.003Z&quot;</span>
  <span class="p">}</span> <span class="p">],</span>
<span class="hll">  <span class="nt">&quot;last&quot;</span> <span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class="hll">  <span class="nt">&quot;totalPages&quot;</span> <span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
</span><span class="hll">  <span class="nt">&quot;totalElements&quot;</span> <span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
</span><span class="hll">  <span class="nt">&quot;size&quot;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class="hll">  <span class="nt">&quot;number&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class="hll">  <span class="nt">&quot;sort&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">{</span>
</span><span class="hll">    <span class="nt">&quot;direction&quot;</span> <span class="p">:</span> <span class="s2">&quot;DESC&quot;</span><span class="p">,</span>
</span><span class="hll">    <span class="nt">&quot;property&quot;</span> <span class="p">:</span> <span class="s2">&quot;lastModifiedAt&quot;</span><span class="p">,</span>
</span><span class="hll">    <span class="nt">&quot;ignoreCase&quot;</span> <span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class="hll">    <span class="nt">&quot;nullHandling&quot;</span><span class="p">:</span> <span class="s2">&quot;NATIVE&quot;</span><span class="p">,</span>
</span><span class="hll">    <span class="nt">&quot;ascending&quot;</span> <span class="p">:</span> <span class="kc">false</span>
</span><span class="hll">  <span class="p">}</span> <span class="p">],</span>
</span><span class="hll">  <span class="nt">&quot;numberOfElements&quot;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class="hll">  <span class="nt">&quot;first&quot;</span> <span class="p">:</span> <span class="kc">false</span>
</span><span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Spring Data CommonsのAPI仕様の変更に伴う注意点</strong></p>
<p>terasoluna-gfw-common 5.0.0.RELEASE以上が依存するspring-data-commons(1.9.1.RELEASE以上)では、
ページ検索機能用のインタフェース(<code class="docutils literal"><span class="pre">org.springframework.data.domain.Page</span></code>)とクラス(<code class="docutils literal"><span class="pre">org.springframework.data.domain.PageImpl</span></code>と<code class="docutils literal"><span class="pre">org.springframework.data.domain.Sort.Order</span></code>)のAPI仕様が変更になっている。</p>
<p>具体的には、</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">Page</span></code>インタフェースと<code class="docutils literal"><span class="pre">PageImpl</span></code>クラスでは、<code class="docutils literal"><span class="pre">isFirst()</span></code>と<code class="docutils literal"><span class="pre">isLast()</span></code>メソッドがspring-data-commons 1.8.0.RELEASEで追加、<code class="docutils literal"><span class="pre">isFirstPage()</span></code>と<code class="docutils literal"><span class="pre">isLastPage()</span></code>メソッドがspring-data-commons 1.9.0.RELEASEで削除</li>
<li><code class="docutils literal"><span class="pre">Sort.Order</span></code>クラスでは、 <code class="docutils literal"><span class="pre">nullHandling</span></code>プロパティがspring-data-commons 1.8.0.RELEASEで追加</li>
</ul>
<p>されている。</p>
<p class="last">REST APIのリソースオブジェクトとして<code class="docutils literal"><span class="pre">Page</span></code>インタフェース(<code class="docutils literal"><span class="pre">PageImpl</span></code>クラス)を使用している場合は、
JSONやXMLのフォーマットが変わってしまうため、アプリケーションの修正が必要になるケースがある。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul>
<li><div class="first line-block">
<div class="line">Beanのマッピング定義の追加</div>
<div class="line">上記実装例では、<code class="docutils literal"><span class="pre">Member</span></code>オブジェクトと<code class="docutils literal"><span class="pre">MemberResource</span></code>オブジェクトのコピーは、「<a class="reference internal" href="Utilities/Dozer.html"><span class="doc">Beanマッピング(Dozer)</span></a>」を使って行っている。</div>
<div class="line">単純なフィールド値のコピーのみでよい場合は、Beanのマッピング定義の追加は不要だが、上記実装例では、<code class="docutils literal"><span class="pre">Member</span></code>オブジェクトの内容を<code class="docutils literal"><span class="pre">MemberResource</span></code>オブジェクトにコピーする際に、<code class="docutils literal"><span class="pre">credential.password</span></code>をコピー対象外にする必要がある。</div>
<div class="line">特定のフィールドをコピー対象外にするためには、Beanのマッピング定義の追加が必要となる。</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="hll"><span class="c">&lt;!-- (11) --&gt;</span>
</span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;mappings</span> <span class="na">xmlns=</span><span class="s">&quot;http://dozer.sourceforge.net&quot;</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://dozer.sourceforge.net</span>
<span class="s">          http://dozer.sourceforge.net/schema/beanmapping.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;mapping</span> <span class="na">type=</span><span class="s">&quot;one-way&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;class-a&gt;</span>org.terasoluna.examples.rest.domain.model.MemberCredential<span class="nt">&lt;/class-a&gt;</span>
        <span class="nt">&lt;class-b&gt;</span>org.terasoluna.examples.rest.api.member.MemberCredentialResource<span class="nt">&lt;/class-b&gt;</span>
<span class="hll">        <span class="c">&lt;!-- (12) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;field-exclude&gt;</span>
</span><span class="hll">            <span class="nt">&lt;a&gt;</span>password<span class="nt">&lt;/a&gt;</span>
</span><span class="hll">            <span class="nt">&lt;b&gt;</span>password<span class="nt">&lt;/b&gt;</span>
</span><span class="hll">        <span class="nt">&lt;/field-exclude&gt;</span>
</span>    <span class="nt">&lt;/mapping&gt;</span>

<span class="nt">&lt;/mappings&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Member</span></code>オブジェクトと<code class="docutils literal"><span class="pre">MemberResource</span></code>オブジェクトのマッピングルールを定義するファイルを作成する。</div>
<div class="line">Dozerのマッピング定義ファイルは、リソース毎に作成する事を推奨する。</div>
<div class="line"><br /></div>
<div class="line">今回の実装例では、<code class="file docutils literal"><span class="pre">/xxx-web/src/main/resources/META-INF/dozer/memberResource-mapping.xml</span></code>に格納する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">上記例では、<code class="docutils literal"><span class="pre">Member</span></code>の関連エンティティである<code class="docutils literal"><span class="pre">MemberCredential</span></code>の内容を、<code class="docutils literal"><span class="pre">MemberResource</span></code>の関連リソースである<code class="docutils literal"><span class="pre">MemberCredentialResource</span></code>にコピーする際に、<code class="docutils literal"><span class="pre">password</span></code>フィールドをコピー対象外に指定している。</div>
<div class="line">Beanマッピングの定義方法の詳細については、「<a class="reference internal" href="Utilities/Dozer.html"><span class="doc">Beanマッピング(Dozer)</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>リクエスト例</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="hll"><span class="nf">GET</span> <span class="nn">/rest-api-web/api/v1/members?name=Smith&amp;page=0&amp;size=2</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span><span class="na">Accept</span><span class="o">:</span> <span class="l">text/plain, application/json, application/*+json, */*</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Java/1.7.0_51</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:8080</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">keep-alive</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>レスポンス例</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="hll"><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="n">OK</span><span class="w"></span>
</span><span class="nl">Server</span><span class="p">:</span><span class="w"> </span><span class="n">Apache</span><span class="o">-</span><span class="n">Coyote</span><span class="o">/</span><span class="mf">1.1</span><span class="w"></span>
<span class="n">X</span><span class="o">-</span><span class="nl">Track</span><span class="p">:</span><span class="w"> </span><span class="n">fb63a6d446f849feb8ccaa4c9a794333</span><span class="w"></span>
<span class="n">Content</span><span class="o">-</span><span class="nl">Type</span><span class="p">:</span><span class="w"> </span><span class="n">application</span><span class="o">/</span><span class="n">json</span><span class="p">;</span><span class="n">charset</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span><span class="w"></span>
<span class="n">Transfer</span><span class="o">-</span><span class="nl">Encoding</span><span class="p">:</span><span class="w"> </span><span class="n">chunked</span><span class="w"></span>
<span class="nc">Date</span><span class="err">:</span><span class="w"> </span><span class="n">Thu</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="n">Mar</span><span class="w"> </span><span class="mi">2014</span><span class="w"> </span><span class="mi">11</span><span class="err">:</span><span class="mi">10</span><span class="err">:</span><span class="mi">43</span><span class="w"> </span><span class="n">GMT</span><span class="w"></span>

<span class="err">{</span><span class="ss">&quot;content&quot;</span><span class="err">:</span><span class="o">[</span><span class="n">{&quot;memberId&quot;:&quot;M000000001&quot;,&quot;firstName&quot;:&quot;John&quot;,&quot;lastName&quot;:&quot;Smith&quot;,&quot;genderCode&quot;:&quot;1&quot;,&quot;dateOfBirth&quot;:&quot;2013-03-13&quot;,&quot;emailAddress&quot;:&quot;user1394709042120@test.com&quot;,&quot;telephoneNumber&quot;:&quot;09012345678&quot;,&quot;zipCode&quot;:&quot;1710051&quot;,&quot;address&quot;:&quot;Tokyo&quot;,&quot;credential&quot;:{&quot;signId&quot;:&quot;user1394709042120@test.com&quot;,&quot;passwordLastChangedAt&quot;:&quot;2014-03-13T11:10:43.066Z&quot;,&quot;lastModifiedAt&quot;:&quot;2014-03-13T11:10:43.066Z&quot;},&quot;createdAt&quot;:&quot;2014-03-13T11:10:43.066Z&quot;,&quot;lastModifiedAt&quot;:&quot;2014-03-13T11:10:43.066Z&quot;},{&quot;memberId&quot;:&quot;M000000002&quot;,&quot;firstName&quot;:&quot;Sophia&quot;,&quot;lastName&quot;:&quot;Smith&quot;,&quot;genderCode&quot;:&quot;2&quot;,&quot;dateOfBirth&quot;:&quot;2013-03-13&quot;,&quot;emailAddress&quot;:&quot;user1394709043663@test.com&quot;,&quot;telephoneNumber&quot;:&quot;09012345678&quot;,&quot;zipCode&quot;:&quot;1710051&quot;,&quot;address&quot;:&quot;Tokyo&quot;,&quot;credential&quot;:{&quot;signId&quot;:&quot;user1394709043663@test.com&quot;,&quot;passwordLastChangedAt&quot;:&quot;2014-03-13T11:10:43.678Z&quot;,&quot;lastModifiedAt&quot;:&quot;2014-03-13T11:10:43.678Z&quot;},&quot;createdAt&quot;:&quot;2014-03-13T11:10:43.678Z&quot;,&quot;lastModifiedAt&quot;:&quot;2014-03-13T11:10:43.678Z&quot;}</span><span class="o">]</span><span class="p">,</span><span class="ss">&quot;last&quot;</span><span class="err">:</span><span class="k">true</span><span class="p">,</span><span class="ss">&quot;totalPages&quot;</span><span class="err">:</span><span class="mi">1</span><span class="p">,</span><span class="ss">&quot;totalElements&quot;</span><span class="err">:</span><span class="mi">2</span><span class="p">,</span><span class="ss">&quot;size&quot;</span><span class="err">:</span><span class="mi">2</span><span class="p">,</span><span class="ss">&quot;number&quot;</span><span class="err">:</span><span class="mi">0</span><span class="p">,</span><span class="ss">&quot;sort&quot;</span><span class="err">:</span><span class="k">null</span><span class="p">,</span><span class="ss">&quot;numberOfElements&quot;</span><span class="err">:</span><span class="mi">2</span><span class="p">,</span><span class="ss">&quot;first&quot;</span><span class="err">:</span><span class="k">true</span><span class="err">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>ページ検索が不要な場合は、Resourceクラスのリストを直接扱えばよい。</p>
<p>Resourceクラスのリストを直接扱う場合のControllerのメソッドは以下のような定義となる。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
<span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
<span class="hll"><span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">MemberResource</span><span class="o">&gt;</span> <span class="nf">getMembers</span><span class="p">(</span>
</span>        <span class="nd">@Validated</span> <span class="n">MembersSearchQuery</span> <span class="n">query</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// omitted</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>Resourceクラスのリストを直接扱った場合、以下のようなJSONとなる。</p>
<blockquote class="last">
<div><div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">[</span> <span class="p">{</span>
    <span class="nt">&quot;memberId&quot;</span> <span class="p">:</span> <span class="s2">&quot;M000000001&quot;</span><span class="p">,</span>
    <span class="nt">&quot;firstName&quot;</span> <span class="p">:</span> <span class="s2">&quot;John&quot;</span><span class="p">,</span>
    <span class="nt">&quot;lastName&quot;</span> <span class="p">:</span> <span class="s2">&quot;Smith&quot;</span><span class="p">,</span>
    <span class="nt">&quot;genderCode&quot;</span> <span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;dateOfBirth&quot;</span> <span class="p">:</span> <span class="s2">&quot;1977-03-07&quot;</span><span class="p">,</span>
    <span class="nt">&quot;emailAddress&quot;</span> <span class="p">:</span> <span class="s2">&quot;john.smith@test.com&quot;</span><span class="p">,</span>
    <span class="nt">&quot;telephoneNumber&quot;</span> <span class="p">:</span> <span class="s2">&quot;09012345678&quot;</span><span class="p">,</span>
    <span class="nt">&quot;zipCode&quot;</span> <span class="p">:</span> <span class="s2">&quot;1710051&quot;</span><span class="p">,</span>
    <span class="nt">&quot;address&quot;</span> <span class="p">:</span> <span class="s2">&quot;Tokyo&quot;</span><span class="p">,</span>
    <span class="nt">&quot;credential&quot;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;signId&quot;</span> <span class="p">:</span> <span class="s2">&quot;john.smit@test.com&quot;</span><span class="p">,</span>
      <span class="nt">&quot;passwordLastChangedAt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-03-13T10:18:08.003Z&quot;</span><span class="p">,</span>
      <span class="nt">&quot;lastModifiedAt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-03-13T10:18:08.003Z&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;createdAt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-03-13T10:18:08.003Z&quot;</span><span class="p">,</span>
    <span class="nt">&quot;lastModifiedAt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-03-13T10:18:08.003Z&quot;</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="nt">&quot;memberId&quot;</span> <span class="p">:</span> <span class="s2">&quot;M000000002&quot;</span><span class="p">,</span>
    <span class="nt">&quot;firstName&quot;</span> <span class="p">:</span> <span class="s2">&quot;Sophia&quot;</span><span class="p">,</span>
    <span class="nt">&quot;lastName&quot;</span> <span class="p">:</span> <span class="s2">&quot;Smith&quot;</span><span class="p">,</span>
    <span class="nt">&quot;genderCode&quot;</span> <span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
    <span class="nt">&quot;dateOfBirth&quot;</span> <span class="p">:</span> <span class="s2">&quot;1977-03-07&quot;</span><span class="p">,</span>
    <span class="nt">&quot;emailAddress&quot;</span> <span class="p">:</span> <span class="s2">&quot;sophia.smith@test.com&quot;</span><span class="p">,</span>
    <span class="nt">&quot;telephoneNumber&quot;</span> <span class="p">:</span> <span class="s2">&quot;09012345678&quot;</span><span class="p">,</span>
    <span class="nt">&quot;zipCode&quot;</span> <span class="p">:</span> <span class="s2">&quot;1710051&quot;</span><span class="p">,</span>
    <span class="nt">&quot;address&quot;</span> <span class="p">:</span> <span class="s2">&quot;Tokyo&quot;</span><span class="p">,</span>
    <span class="nt">&quot;credential&quot;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;signId&quot;</span> <span class="p">:</span> <span class="s2">&quot;sophia.smith@test.com&quot;</span><span class="p">,</span>
      <span class="nt">&quot;passwordLastChangedAt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-03-13T10:18:08.003Z&quot;</span><span class="p">,</span>
      <span class="nt">&quot;lastModifiedAt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-03-13T10:18:08.003Z&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;createdAt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-03-13T10:18:08.003Z&quot;</span><span class="p">,</span>
    <span class="nt">&quot;lastModifiedAt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-03-13T10:18:08.003Z&quot;</span>
<span class="p">}</span> <span class="p">]</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="api-rest">
<span id="resthowtouseapiimplementationofpostcollection"></span><h4><a class="toc-backref" href="#id105">5.16.4.3.5. リソースをコレクションに追加するAPI RESTの実装</a><a class="headerlink" href="#api-rest" title="Permalink to this headline">¶</a></h4>
<p>指定されたMemberリソースを作成し、Memberリソースをコレクションに追加するREST APIの実装例を、以下に示す。</p>
<ul>
<li><div class="first line-block">
<div class="line">REST APIの実装</div>
<div class="line">指定されたMemberリソースを作成し、Memberリソースをコレクションに追加する処理を実装する。</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;members&quot;</span><span class="p">)</span>
<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRestController</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

<span class="hll">    <span class="c1">// (1)</span>
</span>    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
<span class="hll">    <span class="c1">// (2)</span>
</span>    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">CREATED</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">MemberResource</span> <span class="nf">postMember</span><span class="p">(</span>
<span class="hll">            <span class="c1">// (3)</span>
</span>            <span class="nd">@RequestBody</span> <span class="nd">@Validated</span><span class="p">({</span> <span class="n">PostMembers</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">Default</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span>
            <span class="n">MemberResource</span> <span class="n">requestedResource</span><span class="p">)</span> <span class="p">{</span>

<span class="hll">        <span class="c1">// (4)</span>
</span>        <span class="n">Member</span> <span class="n">inputMember</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">requestedResource</span><span class="p">,</span> <span class="n">Member</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="n">Member</span> <span class="n">createdMember</span> <span class="o">=</span> <span class="n">memberService</span><span class="p">.</span><span class="na">createMember</span><span class="p">(</span><span class="n">inputMember</span><span class="p">);</span>

        <span class="n">MemberResource</span> <span class="n">responseResource</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">createdMember</span><span class="p">,</span>
                <span class="n">MemberResource</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">responseResource</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>アノテーションのmethod属性に、<code class="docutils literal"><span class="pre">RequestMethod.POST</span></code>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">メソッドアノテーションとして、<code class="docutils literal"><span class="pre">&#64;ResponseStatus</span></code>アノテーションを付与し、応答するステータスコードを指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;ResponseStatus</span></code>アノテーションのvalue属性には、<strong>201(Created)</strong>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">新規に作成するリソースの情報を受け取るためのJavaBean(Resourceクラス)を引数に指定する。</div>
<div class="line">引数アノテーションとして、<code class="docutils literal"><span class="pre">&#64;org.springframework.web.bind.annotation.RequestBody</span></code>アノテーションを付与する。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;RequestBody</span></code>アノテーションを付与することで、リクエストBodyに設定されているJSONやXMLのデータがResourceオブジェクトにunmarshalされる。</div>
<div class="line"><br /></div>
<div class="line">入力チェックを有効化するために、引数アノテーションとして、<code class="docutils literal"><span class="pre">&#64;Validated</span></code>アノテーションを付与する。入力チェックの詳細については、「<a class="reference internal" href="Validation.html"><span class="doc">入力チェック</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ドメイン層のServiceのメソッドを呼び出し、新規にリソースを作成する。</div>
<div class="line">ドメイン層の実装については、「<a class="reference internal" href="../ImplementationAtEachLayer/DomainLayer.html"><span class="doc">ドメイン層の実装</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>リクエスト例</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="hll"><span class="nf">POST</span> <span class="nn">/rest-api-web/api/v1/members</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span><span class="na">Accept</span><span class="o">:</span> <span class="l">text/plain, application/json, application/*+json, */*</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json;charset=UTF-8</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Java/1.7.0_51</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:8080</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">keep-alive</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">248</span>

<span class="p">{</span><span class="nt">&quot;firstName&quot;</span><span class="p">:</span><span class="s2">&quot;John&quot;</span><span class="p">,</span><span class="nt">&quot;lastName&quot;</span><span class="p">:</span><span class="s2">&quot;Smith&quot;</span><span class="p">,</span><span class="nt">&quot;genderCode&quot;</span><span class="p">:</span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="nt">&quot;dateOfBirth&quot;</span><span class="p">:</span><span class="s2">&quot;2013-03-13&quot;</span><span class="p">,</span><span class="nt">&quot;emailAddress&quot;</span><span class="p">:</span><span class="s2">&quot;user1394708306056@test.com&quot;</span><span class="p">,</span><span class="nt">&quot;telephoneNumber&quot;</span><span class="p">:</span><span class="s2">&quot;09012345678&quot;</span><span class="p">,</span><span class="nt">&quot;zipCode&quot;</span><span class="p">:</span><span class="s2">&quot;1710051&quot;</span><span class="p">,</span><span class="nt">&quot;address&quot;</span><span class="p">:</span><span class="s2">&quot;Tokyo&quot;</span><span class="p">,</span><span class="nt">&quot;credential&quot;</span><span class="p">:{</span><span class="nt">&quot;signId&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span><span class="nt">&quot;password&quot;</span><span class="p">:</span><span class="s2">&quot;zaq12wsx&quot;</span><span class="p">}}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>レスポンス例</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="hll"><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span><span class="w"> </span><span class="mi">201</span><span class="w"> </span><span class="n">Created</span><span class="w"></span>
</span><span class="nl">Server</span><span class="p">:</span><span class="w"> </span><span class="n">Apache</span><span class="o">-</span><span class="n">Coyote</span><span class="o">/</span><span class="mf">1.1</span><span class="w"></span>
<span class="n">X</span><span class="o">-</span><span class="nl">Track</span><span class="p">:</span><span class="w"> </span><span class="n">c7e9c8a9aa4f40ff87f3acdb77baccdf</span><span class="w"></span>
<span class="n">Content</span><span class="o">-</span><span class="nl">Type</span><span class="p">:</span><span class="w"> </span><span class="n">application</span><span class="o">/</span><span class="n">json</span><span class="p">;</span><span class="n">charset</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span><span class="w"></span>
<span class="n">Transfer</span><span class="o">-</span><span class="nl">Encoding</span><span class="p">:</span><span class="w"> </span><span class="n">chunked</span><span class="w"></span>
<span class="nc">Date</span><span class="err">:</span><span class="w"> </span><span class="n">Thu</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="n">Mar</span><span class="w"> </span><span class="mi">2014</span><span class="w"> </span><span class="mi">10</span><span class="err">:</span><span class="mi">58</span><span class="err">:</span><span class="mi">26</span><span class="w"> </span><span class="n">GMT</span><span class="w"></span>

<span class="err">{</span><span class="ss">&quot;memberId&quot;</span><span class="err">:</span><span class="ss">&quot;M000000023&quot;</span><span class="p">,</span><span class="ss">&quot;firstName&quot;</span><span class="err">:</span><span class="ss">&quot;John&quot;</span><span class="p">,</span><span class="ss">&quot;lastName&quot;</span><span class="err">:</span><span class="ss">&quot;Smith&quot;</span><span class="p">,</span><span class="ss">&quot;genderCode&quot;</span><span class="err">:</span><span class="ss">&quot;1&quot;</span><span class="p">,</span><span class="ss">&quot;dateOfBirth&quot;</span><span class="err">:</span><span class="ss">&quot;2013-03-13&quot;</span><span class="p">,</span><span class="ss">&quot;emailAddress&quot;</span><span class="err">:</span><span class="ss">&quot;user1394708306056@test.com&quot;</span><span class="p">,</span><span class="ss">&quot;telephoneNumber&quot;</span><span class="err">:</span><span class="ss">&quot;09012345678&quot;</span><span class="p">,</span><span class="ss">&quot;zipCode&quot;</span><span class="err">:</span><span class="ss">&quot;1710051&quot;</span><span class="p">,</span><span class="ss">&quot;address&quot;</span><span class="err">:</span><span class="ss">&quot;Tokyo&quot;</span><span class="p">,</span><span class="ss">&quot;credential&quot;</span><span class="err">:{</span><span class="ss">&quot;signId&quot;</span><span class="err">:</span><span class="ss">&quot;user1394708306056@test.com&quot;</span><span class="p">,</span><span class="ss">&quot;passwordLastChangedAt&quot;</span><span class="err">:</span><span class="ss">&quot;2014-03-13T10:58:26.324Z&quot;</span><span class="p">,</span><span class="ss">&quot;lastModifiedAt&quot;</span><span class="err">:</span><span class="ss">&quot;2014-03-13T10:58:26.324Z&quot;</span><span class="err">}</span><span class="p">,</span><span class="ss">&quot;createdAt&quot;</span><span class="err">:</span><span class="ss">&quot;2014-03-13T10:58:26.324Z&quot;</span><span class="p">,</span><span class="ss">&quot;lastModifiedAt&quot;</span><span class="err">:</span><span class="ss">&quot;2014-03-13T10:58:26.324Z&quot;</span><span class="err">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="resthowtouseapiimplementationofgetspecifiedresource">
<span id="id34"></span><h4><a class="toc-backref" href="#id106">5.16.4.3.6. 指定されたリソースを取得するREST APIの実装</a><a class="headerlink" href="#resthowtouseapiimplementationofgetspecifiedresource" title="Permalink to this headline">¶</a></h4>
<p>URIで指定されたMemberリソースを取得するREST APIの実装例を、以下に示す。</p>
<ul>
<li><div class="first line-block">
<div class="line">REST APIの実装</div>
<div class="line">URIで指定されたMemberリソースを取得する処理を実装する。</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;members&quot;</span><span class="p">)</span>
<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRestController</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

<span class="hll">    <span class="c1">// (1)</span>
</span>    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;{memberId}&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
<span class="hll">    <span class="c1">// (2)</span>
</span>    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">MemberResource</span> <span class="nf">getMember</span><span class="p">(</span>
<span class="hll">            <span class="c1">// (3)</span>
</span>            <span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;memberId&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">memberId</span><span class="p">)</span> <span class="p">{</span>

<span class="hll">        <span class="c1">// (4)</span>
</span>        <span class="n">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberService</span><span class="p">.</span><span class="na">getMember</span><span class="p">(</span><span class="n">memberId</span><span class="p">);</span>

        <span class="n">MemberResource</span> <span class="n">responseResource</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">member</span><span class="p">,</span>
                <span class="n">MemberResource</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">responseResource</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>アノテーションのvalue属性にパス変数(上記例では<code class="docutils literal"><span class="pre">{memberId}</span></code>)を、method属性に<code class="docutils literal"><span class="pre">RequestMethod.GET</span></code>を指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">{memberId}</span></code>には、リソースを一意に識別するための値が指定される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">メソッドアノテーションとして、<code class="docutils literal"><span class="pre">&#64;ResponseStatus</span></code>アノテーションを付与し、応答するステータスコードを指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;ResponseStatus</span></code>アノテーションのvalue属性には、200(OK)を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースを一意に識別するための値を、パス変数から取得する。</div>
<div class="line">引数アノテーションとして、<code class="docutils literal"><span class="pre">&#64;PathVariable(&quot;memberId&quot;)</span></code>を指定することで、パス変数(<code class="docutils literal"><span class="pre">{memberId}</span></code>)に指定された値をメソッドの引数として受け取ることが出来る。</div>
<div class="line">パス変数の詳細については、 「<a class="reference internal" href="../ImplementationAtEachLayer/ApplicationLayer.html#controller-method-argument-pathvariable-label"><span class="std std-ref">URLのパスから値を取得する</span></a>」を参照されたい。</div>
<div class="line">上記例だと、URIが<code class="docutils literal"><span class="pre">/api/v1/members/M12345</span></code>の場合、引数の<code class="docutils literal"><span class="pre">memberId</span></code>に<code class="docutils literal"><span class="pre">&quot;M12345&quot;</span></code>が格納される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ドメイン層のServiceのメソッドを呼び出し、パス変数から取得したIDに一致するリソースの情報(Entityなど)を取得する。</div>
<div class="line">ドメイン層の実装については、「<a class="reference internal" href="../ImplementationAtEachLayer/DomainLayer.html"><span class="doc">ドメイン層の実装</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>リクエスト例</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="hll"><span class="nf">GET</span> <span class="nn">/rest-api-web/api/v1/members/M000000003</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span><span class="na">Accept</span><span class="o">:</span> <span class="l">text/plain, application/json, application/*+json, */*</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Java/1.7.0_51</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:8080</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">keep-alive</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>レスポンス例</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="hll"><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="n">OK</span><span class="w"></span>
</span><span class="nl">Server</span><span class="p">:</span><span class="w"> </span><span class="n">Apache</span><span class="o">-</span><span class="n">Coyote</span><span class="o">/</span><span class="mf">1.1</span><span class="w"></span>
<span class="n">X</span><span class="o">-</span><span class="nl">Track</span><span class="p">:</span><span class="w"> </span><span class="mi">275</span><span class="n">b4e7a61f946eea47672f272315ac2</span><span class="w"></span>
<span class="n">Content</span><span class="o">-</span><span class="nl">Type</span><span class="p">:</span><span class="w"> </span><span class="n">application</span><span class="o">/</span><span class="n">json</span><span class="p">;</span><span class="n">charset</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span><span class="w"></span>
<span class="n">Transfer</span><span class="o">-</span><span class="nl">Encoding</span><span class="p">:</span><span class="w"> </span><span class="n">chunked</span><span class="w"></span>
<span class="nc">Date</span><span class="err">:</span><span class="w"> </span><span class="n">Thu</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="n">Mar</span><span class="w"> </span><span class="mi">2014</span><span class="w"> </span><span class="mi">11</span><span class="err">:</span><span class="mi">25</span><span class="err">:</span><span class="mi">13</span><span class="w"> </span><span class="n">GMT</span><span class="w"></span>

<span class="err">{</span><span class="ss">&quot;memberId&quot;</span><span class="err">:</span><span class="ss">&quot;M000000003&quot;</span><span class="p">,</span><span class="ss">&quot;firstName&quot;</span><span class="err">:</span><span class="ss">&quot;John&quot;</span><span class="p">,</span><span class="ss">&quot;lastName&quot;</span><span class="err">:</span><span class="ss">&quot;Smith&quot;</span><span class="p">,</span><span class="ss">&quot;genderCode&quot;</span><span class="err">:</span><span class="ss">&quot;1&quot;</span><span class="p">,</span><span class="ss">&quot;dateOfBirth&quot;</span><span class="err">:</span><span class="ss">&quot;2013-03-13&quot;</span><span class="p">,</span><span class="ss">&quot;emailAddress&quot;</span><span class="err">:</span><span class="ss">&quot;user1394709913496@test.com&quot;</span><span class="p">,</span><span class="ss">&quot;telephoneNumber&quot;</span><span class="err">:</span><span class="ss">&quot;09012345678&quot;</span><span class="p">,</span><span class="ss">&quot;zipCode&quot;</span><span class="err">:</span><span class="ss">&quot;1710051&quot;</span><span class="p">,</span><span class="ss">&quot;address&quot;</span><span class="err">:</span><span class="ss">&quot;Tokyo&quot;</span><span class="p">,</span><span class="ss">&quot;credential&quot;</span><span class="err">:{</span><span class="ss">&quot;signId&quot;</span><span class="err">:</span><span class="ss">&quot;user1394709913496@test.com&quot;</span><span class="p">,</span><span class="ss">&quot;passwordLastChangedAt&quot;</span><span class="err">:</span><span class="ss">&quot;2014-03-13T11:25:13.762Z&quot;</span><span class="p">,</span><span class="ss">&quot;lastModifiedAt&quot;</span><span class="err">:</span><span class="ss">&quot;2014-03-13T11:25:13.762Z&quot;</span><span class="err">}</span><span class="p">,</span><span class="ss">&quot;createdAt&quot;</span><span class="err">:</span><span class="ss">&quot;2014-03-13T11:25:13.762Z&quot;</span><span class="p">,</span><span class="ss">&quot;lastModifiedAt&quot;</span><span class="err">:</span><span class="ss">&quot;2014-03-13T11:25:13.762Z&quot;</span><span class="err">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="resthowtouseapiimplementationofputspecifiedresource">
<span id="id35"></span><h4><a class="toc-backref" href="#id107">5.16.4.3.7. 指定されたリソースを更新するREST APIの実装</a><a class="headerlink" href="#resthowtouseapiimplementationofputspecifiedresource" title="Permalink to this headline">¶</a></h4>
<p>URIで指定されたMemberリソースを更新するREST APIの実装例を、以下に示す。</p>
<ul>
<li><div class="first line-block">
<div class="line">REST APIの実装</div>
<div class="line">URIで指定されたMemberリソースを更新する処理を実装する。</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;members&quot;</span><span class="p">)</span>
<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRestController</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

<span class="hll">    <span class="c1">// (1)</span>
</span>    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;{memberId}&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">PUT</span><span class="p">)</span>
<span class="hll">    <span class="c1">// (2)</span>
</span>    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">MemberResource</span> <span class="nf">putMember</span><span class="p">(</span>
            <span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;memberId&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">memberId</span><span class="p">,</span>
<span class="hll">            <span class="c1">// (3)</span>
</span>            <span class="nd">@RequestBody</span> <span class="nd">@Validated</span><span class="p">({</span> <span class="n">PutMember</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">Default</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span>
            <span class="n">MemberResource</span> <span class="n">requestedResource</span><span class="p">)</span> <span class="p">{</span>

<span class="hll">        <span class="c1">// (4)</span>
</span>        <span class="n">Member</span> <span class="n">inputMember</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span>
            <span class="n">requestedResource</span><span class="p">,</span> <span class="n">Member</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="n">Member</span> <span class="n">updatedMember</span> <span class="o">=</span> <span class="n">memberService</span><span class="p">.</span><span class="na">updateMember</span><span class="p">(</span>
            <span class="n">memberId</span><span class="p">,</span> <span class="n">inputMember</span><span class="p">);</span>

        <span class="n">MemberResource</span> <span class="n">responseResource</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">updatedMember</span><span class="p">,</span>
                <span class="n">MemberResource</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">responseResource</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>アノテーションのvalue属性にパス変数(上記例では<code class="docutils literal"><span class="pre">{memberId}</span></code>)を、method属性に<code class="docutils literal"><span class="pre">RequestMethod.PUT</span></code>を指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">{memberId}</span></code>には、リソースを一意に識別するための値が指定される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">メソッドアノテーションとして、<code class="docutils literal"><span class="pre">&#64;ResponseStatus</span></code>アノテーションを付与し、応答するステータスコードを指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;ResponseStatus</span></code>アノテーションのvalue属性には、200(OK)を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースの更新内容を受け取るためのJavaBean(Resourceクラス)を引数に指定する。</div>
<div class="line">引数アノテーションとして、<code class="docutils literal"><span class="pre">&#64;RequestBody</span></code>アノテーションを付与することで、リクエストBodyに設定されているJSONやXMLのデータがResourceオブジェクトにunmarshalされる。</div>
<div class="line"><br /></div>
<div class="line">入力チェックを有効化するために、引数アノテーションとして、<code class="docutils literal"><span class="pre">&#64;Validated</span></code>アノテーションを付与する。</div>
<div class="line">入力チェックの詳細については、「<a class="reference internal" href="Validation.html"><span class="doc">入力チェック</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ドメイン層のServiceのメソッドを呼び出し、パス変数から取得したIDに一致するリソースの情報(Entityなど)を更新する。</div>
<div class="line">ドメイン層の実装については、「<a class="reference internal" href="../ImplementationAtEachLayer/DomainLayer.html"><span class="doc">ドメイン層の実装</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>リクエスト例</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="hll"><span class="nf">PUT</span> <span class="nn">/rest-api-web/api/v1/members/M000000004</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span><span class="na">Accept</span><span class="o">:</span> <span class="l">text/plain, application/json, application/*+json, */*</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json;charset=UTF-8</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Java/1.7.0_51</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:8080</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">keep-alive</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">221</span>

<span class="p">{</span><span class="nt">&quot;memberId&quot;</span><span class="p">:</span><span class="s2">&quot;M000000004&quot;</span><span class="p">,</span><span class="nt">&quot;firstName&quot;</span><span class="p">:</span><span class="s2">&quot;John&quot;</span><span class="p">,</span><span class="nt">&quot;lastName&quot;</span><span class="p">:</span><span class="s2">&quot;Smith&quot;</span><span class="p">,</span><span class="nt">&quot;genderCode&quot;</span><span class="p">:</span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="nt">&quot;dateOfBirth&quot;</span><span class="p">:</span><span class="s2">&quot;2013-03-08&quot;</span><span class="p">,</span><span class="nt">&quot;emailAddress&quot;</span><span class="p">:</span><span class="s2">&quot;user1394710559584@test.com&quot;</span><span class="p">,</span><span class="nt">&quot;telephoneNumber&quot;</span><span class="p">:</span><span class="s2">&quot;09012345678&quot;</span><span class="p">,</span><span class="nt">&quot;zipCode&quot;</span><span class="p">:</span><span class="s2">&quot;1710051&quot;</span><span class="p">,</span><span class="nt">&quot;address&quot;</span><span class="p">:</span><span class="s2">&quot;Tokyo&quot;</span><span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>レスポンス例</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="hll"><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="n">OK</span><span class="w"></span>
</span><span class="nl">Server</span><span class="p">:</span><span class="w"> </span><span class="n">Apache</span><span class="o">-</span><span class="n">Coyote</span><span class="o">/</span><span class="mf">1.1</span><span class="w"></span>
<span class="n">X</span><span class="o">-</span><span class="nl">Track</span><span class="p">:</span><span class="w"> </span><span class="mf">5e8</span><span class="n">fea3aae044e94bf20a293e155af57</span><span class="w"></span>
<span class="n">Content</span><span class="o">-</span><span class="nl">Type</span><span class="p">:</span><span class="w"> </span><span class="n">application</span><span class="o">/</span><span class="n">json</span><span class="p">;</span><span class="n">charset</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span><span class="w"></span>
<span class="n">Transfer</span><span class="o">-</span><span class="nl">Encoding</span><span class="p">:</span><span class="w"> </span><span class="n">chunked</span><span class="w"></span>
<span class="nc">Date</span><span class="err">:</span><span class="w"> </span><span class="n">Thu</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="n">Mar</span><span class="w"> </span><span class="mi">2014</span><span class="w"> </span><span class="mi">11</span><span class="err">:</span><span class="mi">35</span><span class="err">:</span><span class="mi">59</span><span class="w"> </span><span class="n">GMT</span><span class="w"></span>

<span class="err">{</span><span class="ss">&quot;memberId&quot;</span><span class="err">:</span><span class="ss">&quot;M000000004&quot;</span><span class="p">,</span><span class="ss">&quot;firstName&quot;</span><span class="err">:</span><span class="ss">&quot;John&quot;</span><span class="p">,</span><span class="ss">&quot;lastName&quot;</span><span class="err">:</span><span class="ss">&quot;Smith&quot;</span><span class="p">,</span><span class="ss">&quot;genderCode&quot;</span><span class="err">:</span><span class="ss">&quot;1&quot;</span><span class="p">,</span><span class="ss">&quot;dateOfBirth&quot;</span><span class="err">:</span><span class="ss">&quot;2013-03-08&quot;</span><span class="p">,</span><span class="ss">&quot;emailAddress&quot;</span><span class="err">:</span><span class="ss">&quot;user1394710559584@test.com&quot;</span><span class="p">,</span><span class="ss">&quot;telephoneNumber&quot;</span><span class="err">:</span><span class="ss">&quot;09012345678&quot;</span><span class="p">,</span><span class="ss">&quot;zipCode&quot;</span><span class="err">:</span><span class="ss">&quot;1710051&quot;</span><span class="p">,</span><span class="ss">&quot;address&quot;</span><span class="err">:</span><span class="ss">&quot;Tokyo&quot;</span><span class="p">,</span><span class="ss">&quot;credential&quot;</span><span class="err">:{</span><span class="ss">&quot;signId&quot;</span><span class="err">:</span><span class="ss">&quot;user1394710559584@test.com&quot;</span><span class="p">,</span><span class="ss">&quot;passwordLastChangedAt&quot;</span><span class="err">:</span><span class="ss">&quot;2014-03-13T11:35:59.847Z&quot;</span><span class="p">,</span><span class="ss">&quot;lastModifiedAt&quot;</span><span class="err">:</span><span class="ss">&quot;2014-03-13T11:35:59.847Z&quot;</span><span class="err">}</span><span class="p">,</span><span class="ss">&quot;createdAt&quot;</span><span class="err">:</span><span class="ss">&quot;2014-03-13T11:35:59.847Z&quot;</span><span class="p">,</span><span class="ss">&quot;lastModifiedAt&quot;</span><span class="err">:</span><span class="ss">&quot;2014-03-13T11:36:00.122Z&quot;</span><span class="err">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="resthowtouseapiimplementationofdeletespecifiedresource">
<span id="id36"></span><h4><a class="toc-backref" href="#id108">5.16.4.3.8. 指定されたリソースを削除するREST APIの実装</a><a class="headerlink" href="#resthowtouseapiimplementationofdeletespecifiedresource" title="Permalink to this headline">¶</a></h4>
<p>URIで指定されたMemberリソースを削除するREST APIの実装例を、以下に示す。</p>
<ul>
<li><div class="first line-block">
<div class="line">REST APIの実装</div>
<div class="line">URIで指定されたMemberリソースを削除する処理を実装する。</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;members&quot;</span><span class="p">)</span>
<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRestController</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

<span class="hll">    <span class="c1">// (1)</span>
</span>    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;{memberId}&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">DELETE</span><span class="p">)</span>
<span class="hll">    <span class="c1">// (2)</span>
</span>    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">NO_CONTENT</span><span class="p">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteMember</span><span class="p">(</span>
            <span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;memberId&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">memberId</span><span class="p">)</span> <span class="p">{</span>

<span class="hll">        <span class="c1">// (3)</span>
</span>        <span class="n">memberService</span><span class="p">.</span><span class="na">deleteMember</span><span class="p">(</span><span class="n">memberId</span><span class="p">);</span>

    <span class="p">}</span>

    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>アノテーションのvalue属性にパス変数(上記例では<code class="docutils literal"><span class="pre">{memberId}</span></code>)を、method属性に<code class="docutils literal"><span class="pre">RequestMethod.DELETE</span></code>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">メソッドアノテーションとして、<code class="docutils literal"><span class="pre">&#64;ResponseStatus</span></code>アノテーションを付与し、応答するステータスコードを指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;ResponseStatus</span></code>アノテーションのvalue属性には、<strong>204(NO_CONTENT)</strong>を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ドメイン層のServiceのメソッドを呼び出し、パス変数から取得したIDに一致するリソースの情報(Entityなど)を削除する。</div>
<div class="line">ドメイン層の実装については、「<a class="reference internal" href="../ImplementationAtEachLayer/DomainLayer.html"><span class="doc">ドメイン層の実装</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">削除したリソースの情報をレスポンスBODYに設定する場合は、ステータスコードには200(OK)を設定する。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>リクエスト例</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="hll"><span class="nf">DELETE</span> <span class="nn">/rest-api-web/api/v1/members/M000000005</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span><span class="na">Accept</span><span class="o">:</span> <span class="l">text/plain, application/json, application/*+json, */*</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Java/1.7.0_51</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:8080</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">keep-alive</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>レスポンス例</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="hll"><span class="err">HTTP/1.1 204 No Content</span>
</span><span class="c">Server: Apache-Coyote/1.1</span>
<span class="c">X-Track: e06c5bd40c864a299c48d9be3f12b2c0</span>
<span class="c">Date: Thu, 13 Mar 2014 11:40:05 GMT</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="resthowtouseexceptionhandling">
<span id="id37"></span><h3><a class="toc-backref" href="#id109">5.16.4.4. 例外のハンドリングの実装</a><a class="headerlink" href="#resthowtouseexceptionhandling" title="Permalink to this headline">¶</a></h3>
<p>RESTful Web Serviceで発生した例外のハンドリング方法について説明する。</p>
<div class="line-block">
<div class="line">Spring MVCでは、RESTful Web Service向けの汎用的な例外ハンドリングの仕組みは用意されていない。</div>
<div class="line">代わりに、RESTful Web Service向けの例外ハンドリングの実装を補助してくれるクラスとして、(<code class="docutils literal"><span class="pre">org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler</span></code>)が提供されている。</div>
<div class="line">本ガイドラインでは、Spring MVCから提供されているクラスを継承した例外ハンドリング用のクラスを作成し、作成した例外ハンドリング用のクラスに<code class="docutils literal"><span class="pre">&#64;ControllerAdvice</span></code>アノテーションを付与する事で、例外ハンドリングを共通的に行う方法を推奨する。</div>
</div>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">ResponseEntityExceptionHandler</span></code>では、Spring MVCのフレームワーク内で発生する例外を<code class="docutils literal"><span class="pre">&#64;ExceptionHandler</span></code>アノテーションを使ってハンドリングするメソッドが予め実装されている。</div>
<div class="line">そのため、Spring MVCのフレームワーク内で発生する例外のハンドリングを個別に実装する必要がない。</div>
<div class="line">また、<code class="docutils literal"><span class="pre">ResponseEntityExceptionHandler</span></code>でハンドリングされる例外に対応するHTTPステータスコードは、<code class="docutils literal"><span class="pre">DefaultHandlerExceptionResolver</span></code>と同様の仕様で設定される。</div>
<div class="line">ハンドリングされる例外と設定されるHTTPステータスコードについては、「<a class="reference internal" href="ExceptionHandling.html#exception-handling-appendix-defaulthandlerexceptionresolver-label"><span class="std std-ref">DefaultHandlerExceptionResolverで設定されるHTTPレスポンスコードについて</span></a>」を参照されたい。</div>
</div>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">ResponseEntityExceptionHandler</span></code>のデフォルトの実装ではレスポンスBodyは空で返却されるが、レスポンスBodyにエラー情報を出力する様に拡張する事ができる。</div>
<div class="line">本ガイドラインでは、レスポンスBodyに適切なエラー情報を出力する事を推奨する。</div>
</div>
<div class="line-block">
<div class="line">具体的な実装例を説明する前に、<code class="docutils literal"><span class="pre">ResponseEntityExceptionHandler</span></code>を継承した例外ハンドリング用のクラスを作成し、例外ハンドリングを共通的に行う際の処理フローについて説明する。</div>
<div class="line">なお、個別に実装が必要になるのは、赤枠の部分となる。</div>
</div>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/RESTHowToUseExceptionHandling.png"><img alt="Image of exception handling by Spring MVC" src="../_images/RESTHowToUseExceptionHandling.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">処理レイヤ</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring MVC</div>
<div class="line">(Framework)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring MVCはクライアントからのリクエストを受け付け、REST APIを呼び出す。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">REST APIの処理中に例外が発生する。</div>
<div class="line">発生した例外は、Spring MVCによって捕捉される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring MVCは、例外ハンドリング用のクラスに処理を委譲する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Custom Exception Handler</div>
<div class="line">(Common Component)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例外ハンドリング用のクラスでは、エラー情報を保持するエラーオブジェクトを生成し、Spring MVCに返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring MVC</div>
<div class="line">(Framework)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring MVCは、<code class="docutils literal"><span class="pre">HttpMessageConverter</span></code>を利用して、エラーオブジェクトをJSON形式の電文に変換する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring MVCは、JSON形式のエラー電文をレスポンスBODYに設定し、クライアントにレスポンスする。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="body">
<span id="resthowtouseexceptionhandlingforerrorcontentinresponsebody"></span><h4><a class="toc-backref" href="#id110">5.16.4.4.1. レスポンスBodyにエラー情報を出力するための実装</a><a class="headerlink" href="#body" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>エラー情報は以下のJSON形式とする。</li>
</ul>
<blockquote>
<div><div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;code&quot;</span> <span class="p">:</span> <span class="s2">&quot;e.ex.fw.7001&quot;</span><span class="p">,</span>
  <span class="nt">&quot;message&quot;</span> <span class="p">:</span> <span class="s2">&quot;Validation error occurred on item in the request body.&quot;</span><span class="p">,</span>
  <span class="nt">&quot;details&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">{</span>
    <span class="nt">&quot;code&quot;</span> <span class="p">:</span> <span class="s2">&quot;ExistInCodeList&quot;</span><span class="p">,</span>
    <span class="nt">&quot;message&quot;</span> <span class="p">:</span> <span class="s2">&quot;\&quot;genderCode\&quot; must exist in code list of CL_GENDER.&quot;</span><span class="p">,</span>
    <span class="nt">&quot;target&quot;</span> <span class="p">:</span> <span class="s2">&quot;genderCode&quot;</span>
  <span class="p">}</span> <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>エラー情報を保持するJavaBeanを作成する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.examples.rest.api.common.error</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.annotation.JsonInclude</span><span class="p">;</span>

<span class="hll"><span class="c1">// (1)</span>
</span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiError</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">code</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">message</span><span class="p">;</span>

    <span class="nd">@JsonInclude</span><span class="p">(</span><span class="n">JsonInclude</span><span class="p">.</span><span class="na">Include</span><span class="p">.</span><span class="na">NON_EMPTY</span><span class="p">)</span>
<span class="hll">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">target</span><span class="p">;</span> <span class="c1">// (2)</span>
</span>
    <span class="nd">@JsonInclude</span><span class="p">(</span><span class="n">JsonInclude</span><span class="p">.</span><span class="na">Include</span><span class="p">.</span><span class="na">NON_EMPTY</span><span class="p">)</span>
<span class="hll">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ApiError</span><span class="o">&gt;</span> <span class="n">details</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span> <span class="c1">// (3)</span>
</span>
    <span class="kd">public</span> <span class="nf">ApiError</span><span class="p">(</span><span class="n">String</span> <span class="n">code</span><span class="p">,</span> <span class="n">String</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="nf">ApiError</span><span class="p">(</span><span class="n">String</span> <span class="n">code</span><span class="p">,</span> <span class="n">String</span> <span class="n">message</span><span class="p">,</span> <span class="n">String</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">code</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="na">message</span> <span class="o">=</span> <span class="n">message</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="na">target</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getCode</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">code</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getMessage</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">message</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTarget</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">target</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ApiError</span><span class="o">&gt;</span> <span class="nf">getDetails</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">details</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addDetail</span><span class="p">(</span><span class="n">ApiError</span> <span class="n">detail</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">details</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">detail</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラー情報を保持するためのクラスを作成する。</div>
<div class="line">上記例では、エラーコード、エラーメッセージ、エラー対象、エラーの詳細情報のリストを保持するクラスとなっている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラーが発生した対象を識別するための値を保持するフィールド。</div>
<div class="line">入力チェックでエラーが発生した場合、どの項目でエラーが発生したのかを識別できる値をクライアントに返却する事が求められるケースがある。</div>
<div class="line">そのような場合は、エラーが発生した項目名を保持するフィールドが必要になる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラーの詳細情報のリストを保持するためのフィールド。</div>
<div class="line">入力チェックでエラーが発生した場合、エラー原因が複数存在する場合があるため、すべてのエラー情報をクライアントに返却する事が求められるケースがある。</div>
<div class="line">そのような場合は、エラーの詳細情報をリストで保持するフィールドが必要になる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">フィールドに<code class="docutils literal"><span class="pre">&#64;JsonInclude(JsonInclude.Include.NON_EMPTY)</span></code>を指定することで、値が<code class="docutils literal"><span class="pre">null</span></code>や空の場合にJSONに項目が出力されないようにする事が出来る。
項目を出力させないための条件を<code class="docutils literal"><span class="pre">null</span></code>に限定したい場合は、<code class="docutils literal"><span class="pre">&#64;JsonInclude(JsonInclude.Include.NON_NULL)</span></code>を指定すればよい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>エラー情報を保持するJavaBeanを生成するためのクラスを作成する。</li>
</ul>
<blockquote>
<div><p>全ての例外ハンドリングの実装が完了した際のソースコードについては、<a class="reference internal" href="#restappendixsorucecodesofapierrorcreator"><span class="std std-ref">Appendix</span></a>を参照されたい。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="hll"><span class="c1">// (4)</span>
</span><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiErrorCreator</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">MessageSource</span> <span class="n">messageSource</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">ApiError</span> <span class="nf">createApiError</span><span class="p">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="p">,</span> <span class="n">String</span> <span class="n">errorCode</span><span class="p">,</span>
            <span class="n">String</span> <span class="n">defaultErrorMessage</span><span class="p">,</span> <span class="n">Object</span><span class="p">...</span> <span class="n">arguments</span><span class="p">)</span> <span class="p">{</span>
<span class="hll">        <span class="c1">// (5)</span>
</span>        <span class="n">String</span> <span class="n">localizedMessage</span> <span class="o">=</span> <span class="n">messageSource</span><span class="p">.</span><span class="na">getMessage</span><span class="p">(</span><span class="n">errorCode</span><span class="p">,</span>
                <span class="n">arguments</span><span class="p">,</span> <span class="n">defaultErrorMessage</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="na">getLocale</span><span class="p">());</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ApiError</span><span class="p">(</span><span class="n">errorCode</span><span class="p">,</span> <span class="n">localizedMessage</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">必要に応じて、エラー情報を生成するためのメソッドを提供するクラスを作成する。</div>
<div class="line">このクラスの作成は必須ではないが、役割を明確に分担するために作成する事を推奨する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラーメッセージは、<code class="docutils literal"><span class="pre">MessageSource</span></code>より取得する。</div>
<div class="line">メッセージの管理方法については、「<a class="reference internal" href="MessageManagement.html"><span class="doc">メッセージ管理</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>上記例では、メッセージのローカライズをサポートするために<code class="docutils literal"><span class="pre">org.springframework.web.context.request.WebRequest</span></code>を引数として受け取っている。
メッセージのローカライズが必要ない場合は、<code class="docutils literal"><span class="pre">WebRequest</span></code>は不要である。</p>
<p class="last"><code class="docutils literal"><span class="pre">java.util.Locale</span></code>ではなく<code class="docutils literal"><span class="pre">WebRequest</span></code>を引数にしている理由は、エラーメッセージの中にHTTPリクエストの内容を埋め込むといった要件が追加される事を考慮したためである。
エラーメッセージの中にHTTPリクエストの内容を埋め込む要件がない場合は、<code class="docutils literal"><span class="pre">Locale</span></code>でもよい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">ResponseEntityExceptionHandler</span></code>のメソッドを拡張し、レスポンスBodyにエラー情報を出力するための実装を行う。</li>
</ul>
<blockquote>
<div><p>全ての例外ハンドリングの実装が完了した際のソースコードについては、<a class="reference internal" href="#restappendixsorucecodesofapiglobalexceptionhandler"><span class="std std-ref">Appendix</span></a>を参照されたい。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="hll"><span class="nd">@ControllerAdvice</span> <span class="c1">// (6)</span>
</span><span class="hll"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiGlobalExceptionHandler</span> <span class="kd">extends</span> <span class="n">ResponseEntityExceptionHandler</span> <span class="p">{</span>
</span>
    <span class="nd">@Inject</span>
    <span class="n">ApiErrorCreator</span> <span class="n">apiErrorCreator</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">ExceptionCodeResolver</span> <span class="n">exceptionCodeResolver</span><span class="p">;</span>

<span class="hll">    <span class="c1">// (7)</span>
</span><span class="hll">    <span class="nd">@Override</span>
</span><span class="hll">    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleExceptionInternal</span><span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">,</span>
</span>            <span class="n">Object</span> <span class="n">body</span><span class="p">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="p">,</span> <span class="n">HttpStatus</span> <span class="n">status</span><span class="p">,</span>
            <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">final</span> <span class="n">Object</span> <span class="n">apiError</span><span class="p">;</span>
<span class="hll">        <span class="c1">// (8)</span>
</span>        <span class="k">if</span> <span class="p">(</span><span class="n">body</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">String</span> <span class="n">errorCode</span> <span class="o">=</span> <span class="n">exceptionCodeResolver</span><span class="p">.</span><span class="na">resolveExceptionCode</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
            <span class="n">apiError</span> <span class="o">=</span> <span class="n">apiErrorCreator</span><span class="p">.</span><span class="na">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">errorCode</span><span class="p">,</span> <span class="n">ex</span>
                    <span class="p">.</span><span class="na">getLocalizedMessage</span><span class="p">());</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">apiError</span> <span class="o">=</span> <span class="n">body</span><span class="p">;</span>
        <span class="p">}</span>
<span class="hll">        <span class="c1">// (9)</span>
</span>        <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">status</span><span class="p">).</span><span class="na">headers</span><span class="p">(</span><span class="n">headers</span><span class="p">).</span><span class="na">body</span><span class="p">(</span><span class="n">apiError</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring MVCから提供されている<code class="docutils literal"><span class="pre">ResponseEntityExceptionHandler</span></code>を継承したクラスを作成し、<code class="docutils literal"><span class="pre">&#64;ControllerAdvice</span></code>アノテーションを付与する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ResponseEntityExceptionHandler</span></code>のhandleExceptionInternalメソッドをオーバライドする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">レスポンスBodyに出力するJavaBeanの指定がない場合は、エラー情報を保持するJavaBeanオブジェクトを生成する。</div>
<div class="line">上記例では、共通ライブラリから提供している<code class="docutils literal"><span class="pre">ExceptionCodeResolver</span></code>を使用して、例外クラスをエラーコードを変換している。</div>
<div class="line"><code class="docutils literal"><span class="pre">ExceptionCodeResolver</span></code>の設定例については、「<a class="reference internal" href="#resthowtouseexceptionhandlingsettingsofexceptioncoderesolver"><span class="std std-ref">ExceptionCodeResolverを使ったエラーコードとメッセージの解決</span></a>」を参照されたい。</div>
<div class="line"><br /></div>
<div class="line">レスポンスBodyに出力するJavaBeanの指定がある場合は、指定されたJavaBeanをそのまま使用する。</div>
<div class="line">この処理は、例外毎のエラーハンドリング処理にて、個別にエラー情報が生成される事を考慮した実装となっている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">レスポンス用のHTTP EntityのBody部分に、(8)で生成したエラー情報を設定し返却する。</div>
<div class="line">返却したエラー情報は、フレームワークによってJSONに変換されレスポンスされる。</div>
<div class="line"><br /></div>
<div class="line">ステータスコードには、Spring MVCから提供されている<code class="docutils literal"><span class="pre">ResponseEntityExceptionHandler</span></code>によって適切な値が設定される。</div>
<div class="line">設定されるステータスコードについては、「<a class="reference internal" href="ExceptionHandling.html#exception-handling-appendix-defaulthandlerexceptionresolver-label"><span class="std std-ref">DefaultHandlerExceptionResolverで設定されるHTTPレスポンスコードについて</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>Spring Framework 4.0 より追加された&#64;ControllerAdviceアノテーションの属性について</strong></p>
<p class="last"><code class="docutils literal"><span class="pre">&#64;ControllerAdvice</span></code>アノテーションの属性を指定することで、
<code class="docutils literal"><span class="pre">&#64;ControllerAdvice</span></code>が付与されたクラスで実装したメソッドを適用するControllerを柔軟に指定できるように改善されている。
属性の詳細については、<a class="reference internal" href="../ImplementationAtEachLayer/ApplicationLayer.html#application-layer-controller-advice-attribute"><span class="std std-ref">&#64;ControllerAdviceの属性</span></a>を参照されたい。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>&#64;ControllerAdviceアノテーションの属性使用時の注意点</strong></p>
<p><code class="docutils literal"><span class="pre">&#64;ControllerAdvice</span></code>アノテーションの属性を使用することで、さまざまな粒度で例外ハンドリングを共通化することができるようになるが、
アプリケーション共通の例外ハンドラクラス(上記例の<code class="docutils literal"><span class="pre">ApiGlobalExceptionHandler</span></code>クラスに相当するクラス)に対しては、<code class="docutils literal"><span class="pre">&#64;ControllerAdvice</span></code>アノテーションの属性を指定しない方がよい。</p>
<p><code class="docutils literal"><span class="pre">ApiGlobalExceptionHandler</span></code>に付与する<code class="docutils literal"><span class="pre">&#64;ControllerAdvice</span></code>アノテーションに属性を指定した場合、Spring MVCが提供するフレームワーク処理の中で発生する一部の例外をハンドリングできないケースがある。</p>
<p class="last">具体的には、リクエストに対応するREST API(Controllerのハンドラメソッド)が見つからない時に発生する例外を<code class="docutils literal"><span class="pre">ApiGlobalExceptionHandler</span></code>クラスでハンドリングする事ができないため、
「405 Method Not Allowed」などのエラーを正しく応答する事が出来なくなってしまう。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>レスポンス例</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="hll"><span class="nt">HTTP</span><span class="o">/</span><span class="nt">1</span><span class="p">.</span><span class="nc">1</span> <span class="nt">400</span> <span class="nt">Bad</span> <span class="nt">Request</span>
</span><span class="nt">Server</span><span class="o">:</span> <span class="nt">Apache-Coyote</span><span class="o">/</span><span class="nt">1</span><span class="p">.</span><span class="nc">1</span>
<span class="nt">X-Track</span><span class="o">:</span> <span class="nt">e60b3b6468194e22852c8bfc7618e625</span>
<span class="nt">Content-Type</span><span class="o">:</span> <span class="nt">application</span><span class="o">/</span><span class="nt">json</span><span class="o">;</span><span class="nt">charset</span><span class="o">=</span><span class="nt">UTF-8</span>
<span class="nt">Transfer-Encoding</span><span class="o">:</span> <span class="nt">chunked</span>
<span class="nt">Date</span><span class="o">:</span> <span class="nt">Thu</span><span class="o">,</span> <span class="nt">13</span> <span class="nt">Mar</span> <span class="nt">2014</span> <span class="nt">12</span><span class="p">:</span><span class="nd">16</span><span class="p">:</span><span class="nd">55</span> <span class="nt">GMT</span>
<span class="nt">Connection</span><span class="o">:</span> <span class="nt">close</span>

<span class="hll"><span class="p">{</span><span class="err">&quot;code&quot;:&quot;e.ex.fw.7001&quot;,&quot;message&quot;:&quot;Validation</span> <span class="err">error</span> <span class="err">occurred</span> <span class="err">on</span> <span class="err">item</span> <span class="err">in</span> <span class="err">the</span> <span class="err">request</span> <span class="err">body.&quot;,&quot;details&quot;:</span><span class="cp">[</span><span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span><span class="s2">&quot;ExistInCodeList&quot;</span><span class="p">,</span><span class="s2">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">genderCode</span><span class="se">\&quot;</span><span class="s2"> must exist in code list of CL_GENDER.&quot;</span><span class="p">,</span><span class="s2">&quot;target&quot;</span><span class="p">:</span><span class="s2">&quot;genderCode&quot;</span><span class="p">}</span><span class="cp">]</span><span class="p">}</span>
</span></pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="resthowtouseexceptionhandlingforvalidationerror">
<span id="id38"></span><h4><a class="toc-backref" href="#id111">5.16.4.4.2. 入力エラー例外のハンドリング実装</a><a class="headerlink" href="#resthowtouseexceptionhandlingforvalidationerror" title="Permalink to this headline">¶</a></h4>
<p>入力エラー（電文不正、単項目チェックエラー、相関項目チェックエラー）を応答するための実装例について説明する。</p>
<p>入力エラーを応答するためには、以下の３つの例外をハンドリングする必要がある。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="35%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">例外</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.web.bind.</div>
<div class="line">MethodArgumentNotValidException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエストBODYに指定されたJSONやXMLに対する入力チェックでエラーが発生した場合、本例外が発生する。</div>
<div class="line">具体的には、リソースのPOST又はPUT時に指定するリソースに不正な値が指定されている場合に発生する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.validation.</div>
<div class="line">BindException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエストパラメータ(key=value形式のクエリ文字列)に対する入力チェックでエラーが発生した場合、本例外が発生する。</div>
<div class="line">具体的には、リソースコレクションのGET時に指定する検索条件に不正な値が指定されている場合に発生する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.http.converter.</div>
<div class="line">HttpMessageNotReadableException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JSONやXMLからResourceオブジェクトを生成する際にエラーが発生した場合は、本例外が発生する。</div>
<div class="line">具体的には、JSONやXMLの構文不正やスキーマ定義に違反などがあった場合に発生する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Spring Frameworkから提供されているアノテーションを使用してリクエストパラメータ、リクエストヘッダ、パス変数から値を取得する際に、値の型変換エラーが発生した場合、<code class="docutils literal"><span class="pre">org.springframework.beans.TypeMismatchException</span></code>が発生する。</p>
<p>Controllerのハンドラメソッドの引数(<code class="docutils literal"><span class="pre">String</span></code>以外の引数)に、以下のアノテーションを指定した場合、<code class="docutils literal"><span class="pre">TypeMismatchException</span></code>が発生する可能性がある。</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">&#64;org.springframework.web.bind.annotation.RequestParam</span></code></li>
<li><code class="docutils literal"><span class="pre">&#64;org.springframework.web.bind.annotation.RequestHeader</span></code></li>
<li><code class="docutils literal"><span class="pre">&#64;org.springframework.web.bind.annotation.Pathvariable</span></code></li>
<li><code class="docutils literal"><span class="pre">&#64;org.springframework.web.bind.annotation.MatrixVariable</span></code></li>
</ul>
</div></blockquote>
<p><code class="docutils literal"><span class="pre">TypeMismatchException</span></code>は、<code class="docutils literal"><span class="pre">ResponseEntityExceptionHandler</span></code>によって例外がハンドリングされ、400(Bad Request)となるので個別にハンドリングしなくてもよい。</p>
<p class="last">エラー情報に設定するエラーコードとエラーメッセージの解決方法については、「<a class="reference internal" href="#resthowtouseexceptionhandlingsettingsofexceptioncoderesolver"><span class="std std-ref">ExceptionCodeResolverを使ったエラーコードとメッセージの解決</span></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>入力チェックエラー用のエラー情報を生成するためのメソッドを作成する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiErrorCreator</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">MessageSource</span> <span class="n">messageSource</span><span class="p">;</span>

    <span class="c1">// omitted</span>

<span class="hll">    <span class="c1">// (1)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">ApiError</span> <span class="nf">createBindingResultApiError</span><span class="p">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="p">,</span>
</span>            <span class="n">String</span> <span class="n">errorCode</span><span class="p">,</span> <span class="n">BindingResult</span> <span class="n">bindingResult</span><span class="p">,</span>
            <span class="n">String</span> <span class="n">defaultErrorMessage</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ApiError</span> <span class="n">apiError</span> <span class="o">=</span> <span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">errorCode</span><span class="p">,</span>
                <span class="n">defaultErrorMessage</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">FieldError</span> <span class="n">fieldError</span> <span class="p">:</span> <span class="n">bindingResult</span><span class="p">.</span><span class="na">getFieldErrors</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">apiError</span><span class="p">.</span><span class="na">addDetail</span><span class="p">(</span><span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">fieldError</span><span class="p">,</span> <span class="n">fieldError</span>
                    <span class="p">.</span><span class="na">getField</span><span class="p">()));</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ObjectError</span> <span class="n">objectError</span> <span class="p">:</span> <span class="n">bindingResult</span><span class="p">.</span><span class="na">getGlobalErrors</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">apiError</span><span class="p">.</span><span class="na">addDetail</span><span class="p">(</span><span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">objectError</span><span class="p">,</span> <span class="n">objectError</span>
                    <span class="p">.</span><span class="na">getObjectName</span><span class="p">()));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">apiError</span><span class="p">;</span>
    <span class="p">}</span>

<span class="hll">    <span class="c1">// (2)</span>
</span><span class="hll">    <span class="kd">private</span> <span class="n">ApiError</span> <span class="nf">createApiError</span><span class="p">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="p">,</span>
</span>            <span class="n">DefaultMessageSourceResolvable</span> <span class="n">messageResolvable</span><span class="p">,</span> <span class="n">String</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">localizedMessage</span> <span class="o">=</span> <span class="n">messageSource</span><span class="p">.</span><span class="na">getMessage</span><span class="p">(</span><span class="n">messageResolvable</span><span class="p">,</span>
                <span class="n">request</span><span class="p">.</span><span class="na">getLocale</span><span class="p">());</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ApiError</span><span class="p">(</span><span class="n">messageResolvable</span><span class="p">.</span><span class="na">getCode</span><span class="p">(),</span> <span class="n">localizedMessage</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力チェック用のエラー情報を生成するためのメソッドを作成する。</div>
<div class="line">上記例では、単項目チェックエラー(<code class="docutils literal"><span class="pre">FieldError</span></code>)と相関項目チェックエラー(<code class="docutils literal"><span class="pre">ObjectError</span></code>)を、エラーの詳細情報に追加している。</div>
<div class="line">項目毎のエラー情報を出力する必要がない場合は、本メソッドを用意する必要はない。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">単項目チェックエラー(<code class="docutils literal"><span class="pre">FieldError</span></code>)と相関項目チェックエラー(<code class="docutils literal"><span class="pre">ObjectError</span></code>)で同じ処理を実装する事になるので、共通メソッドとして本メソッドを作成している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">ResponseEntityExceptionHandler</span></code>のメソッドを拡張し、レスポンスBodyに入力チェック用のエラー情報を出力するための実装を行う。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiGlobalExceptionHandler</span> <span class="kd">extends</span> <span class="n">ResponseEntityExceptionHandler</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ApiErrorCreator</span> <span class="n">apiErrorCreator</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">ExceptionCodeResolver</span> <span class="n">exceptionCodeResolver</span><span class="p">;</span>

    <span class="c1">// omitted</span>

<span class="hll">    <span class="c1">// (3)</span>
</span><span class="hll">    <span class="nd">@Override</span>
</span><span class="hll">    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleMethodArgumentNotValid</span><span class="p">(</span>
</span>            <span class="n">MethodArgumentNotValidException</span> <span class="n">ex</span><span class="p">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="p">,</span>
            <span class="n">HttpStatus</span> <span class="n">status</span><span class="p">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">handleBindingResult</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="na">getBindingResult</span><span class="p">(),</span> <span class="n">headers</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
                <span class="n">request</span><span class="p">);</span>
    <span class="p">}</span>

<span class="hll">    <span class="c1">// (4)</span>
</span><span class="hll">    <span class="nd">@Override</span>
</span><span class="hll">    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleBindException</span><span class="p">(</span><span class="n">BindException</span> <span class="n">ex</span><span class="p">,</span>
</span>            <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="p">,</span> <span class="n">HttpStatus</span> <span class="n">status</span><span class="p">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">handleBindingResult</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="na">getBindingResult</span><span class="p">(),</span> <span class="n">headers</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
                <span class="n">request</span><span class="p">);</span>
    <span class="p">}</span>

<span class="hll">    <span class="c1">// (5)</span>
</span><span class="hll">    <span class="nd">@Override</span>
</span><span class="hll">    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleHttpMessageNotReadable</span><span class="p">(</span>
</span>            <span class="n">HttpMessageNotReadableException</span> <span class="n">ex</span><span class="p">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="p">,</span>
            <span class="n">HttpStatus</span> <span class="n">status</span><span class="p">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
<span class="hll">        <span class="k">if</span> <span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="na">getCause</span><span class="p">()</span> <span class="k">instanceof</span> <span class="n">Exception</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">            <span class="k">return</span> <span class="n">handleExceptionInternal</span><span class="p">((</span><span class="n">Exception</span><span class="p">)</span> <span class="n">ex</span><span class="p">.</span><span class="na">getCause</span><span class="p">(),</span> <span class="kc">null</span><span class="p">,</span>
</span><span class="hll">                    <span class="n">headers</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
</span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">handleExceptionInternal</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// omitted</span>

<span class="hll">    <span class="c1">// (6)</span>
</span><span class="hll">    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleBindingResult</span><span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">,</span>
</span>            <span class="n">BindingResult</span> <span class="n">bindingResult</span><span class="p">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="p">,</span>
            <span class="n">HttpStatus</span> <span class="n">status</span><span class="p">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">code</span> <span class="o">=</span> <span class="n">exceptionCodeResolver</span><span class="p">.</span><span class="na">resolveExceptionCode</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
        <span class="n">String</span> <span class="n">errorCode</span> <span class="o">=</span> <span class="n">exceptionCodeResolver</span><span class="p">.</span><span class="na">resolveExceptionCode</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
        <span class="n">ApiError</span> <span class="n">apiError</span> <span class="o">=</span> <span class="n">apiErrorCreator</span><span class="p">.</span><span class="na">createBindingResultApiError</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span> <span class="n">errorCode</span><span class="p">,</span> <span class="n">bindingResult</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
        <span class="k">return</span> <span class="n">handleExceptionInternal</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">apiError</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ResponseEntityExceptionHandler</span></code>のhandleMethodArgumentNotValidメソッドをオーバライドし、<code class="docutils literal"><span class="pre">MethodArgumentNotValidException</span></code>のエラーハンドリングを拡張する。</div>
<div class="line">上記例では、入力チェックエラーをハンドリングするための共通メソッド(6)に処理を委譲している。</div>
<div class="line">項目毎のエラー情報を出力する必要がない場合は、オーバライドする必要はない。</div>
<div class="line"><br /></div>
<div class="line">ステータスコードには<strong>400(Bad Request)</strong>が設定され、指定されたリソースの項目値に不備がある事を通知する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ResponseEntityExceptionHandler</span></code>のhandleBindExceptionメソッドをオーバライドし、<code class="docutils literal"><span class="pre">BindException</span></code>のエラーハンドリングを拡張する。</div>
<div class="line">上記例では、入力チェックエラーをハンドリングするための共通メソッド(6)に処理を委譲している。</div>
<div class="line">項目毎のエラー情報を出力する必要がない場合は、オーバライドする必要はない。</div>
<div class="line"><br /></div>
<div class="line">ステータスコードには<strong>400(Bad Request)</strong>が設定され、指定されたリクエストパラメータに不備がある事を通知する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ResponseEntityExceptionHandler</span></code>のhandleHttpMessageNotReadableメソッドをオーバライドし、<code class="docutils literal"><span class="pre">HttpMessageNotReadableException</span></code>のエラーハンドリングを拡張する。</div>
<div class="line">上記例では、細かくエラーハンドリングを行うために、原因例外を使ってエラーハンドリングしている。</div>
<div class="line">細かくエラーハンドリングをしなくてもよい場合は、オーバライドする必要はない。</div>
<div class="line"><br /></div>
<div class="line">ステータスコードには<strong>400(Bad Request)</strong>が設定され、指定されたリソースのフォーマットなどに不備がある事を通知する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力チェックエラーのエラー情報を保持するJavaBeanオブジェクトを生成する。</div>
<div class="line">上記例では、handleMethodArgumentNotValidとhandleBindExceptionで同じ処理を実装する事になるので、共通メソッドとして本メソッドを作成している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>JSON使用時のエラーハンドリングについて</strong></p>
<p>リソースのフォーマットとしてJSONを使用する場合、以下の例外が<code class="docutils literal"><span class="pre">HttpMessageNotReadableException</span></code>の原因例外として格納される。</p>
<blockquote class="last">
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="35%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">例外クラス</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">com.fasterxml.jackson.core.</div>
<div class="line">JsonParseException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JSONとして不正な構文が含まれる場合に発生する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">com.fasterxml.jackson.databind.exc.</div>
<div class="line">UnrecognizedPropertyException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Resourceオブジェクトに存在しないフィールドがJSONに指定されている場合に発生する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">com.fasterxml.jackson.databind.</div>
<div class="line">JsonMappingException</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JSONからResourceオブジェクトへ変換する際に、値の型変換エラーが発生した場合に発生する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>入力チェックエラー(単項目チェック、相関項目チェックエラー)が発生した場合、以下のようなエラー応答が行われる。</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="hll"><span class="nt">HTTP</span><span class="o">/</span><span class="nt">1</span><span class="p">.</span><span class="nc">1</span> <span class="nt">400</span> <span class="nt">Bad</span> <span class="nt">Request</span>
</span><span class="nt">Server</span><span class="o">:</span> <span class="nt">Apache-Coyote</span><span class="o">/</span><span class="nt">1</span><span class="p">.</span><span class="nc">1</span>
<span class="nt">X-Track</span><span class="o">:</span> <span class="nt">13522b3badf2432ba4cad0dc7aeaee80</span>
<span class="nt">Content-Type</span><span class="o">:</span> <span class="nt">application</span><span class="o">/</span><span class="nt">json</span><span class="o">;</span><span class="nt">charset</span><span class="o">=</span><span class="nt">UTF-8</span>
<span class="nt">Transfer-Encoding</span><span class="o">:</span> <span class="nt">chunked</span>
<span class="nt">Date</span><span class="o">:</span> <span class="nt">Wed</span><span class="o">,</span> <span class="nt">19</span> <span class="nt">Feb</span> <span class="nt">2014</span> <span class="nt">05</span><span class="p">:</span><span class="nd">08</span><span class="p">:</span><span class="nd">28</span> <span class="nt">GMT</span>
<span class="nt">Connection</span><span class="o">:</span> <span class="nt">close</span>

<span class="hll"><span class="p">{</span><span class="err">&quot;code&quot;:&quot;e.ex.fw.7002&quot;,&quot;message&quot;:&quot;Validation</span> <span class="err">error</span> <span class="err">occurred</span> <span class="err">on</span> <span class="err">item</span> <span class="err">in</span> <span class="err">the</span> <span class="err">request</span> <span class="err">parameters.&quot;,&quot;details&quot;:</span><span class="cp">[</span><span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span><span class="s2">&quot;NotEmpty&quot;</span><span class="p">,</span><span class="s2">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">{0}</span><span class="se">\&quot;</span><span class="s2"> may not be empty.&quot;</span><span class="p">,</span><span class="s2">&quot;target&quot;</span><span class="p">:</span><span class="s2">&quot;name&quot;</span><span class="p">}</span><span class="cp">]</span><span class="p">}</span>
</span></pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>JSONエラー(フォーマットエラーなど)が発生した場合、以下のようなエラー応答が行われる。</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="hll"><span class="nt">HTTP</span><span class="o">/</span><span class="nt">1</span><span class="p">.</span><span class="nc">1</span> <span class="nt">400</span> <span class="nt">Bad</span> <span class="nt">Request</span>
</span><span class="nt">Server</span><span class="o">:</span> <span class="nt">Apache-Coyote</span><span class="o">/</span><span class="nt">1</span><span class="p">.</span><span class="nc">1</span>
<span class="nt">X-Track</span><span class="o">:</span> <span class="nt">ca4c742a6bfd49e5bc01cd0b124738a1</span>
<span class="nt">Content-Type</span><span class="o">:</span> <span class="nt">application</span><span class="o">/</span><span class="nt">json</span><span class="o">;</span><span class="nt">charset</span><span class="o">=</span><span class="nt">UTF-8</span>
<span class="nt">Transfer-Encoding</span><span class="o">:</span> <span class="nt">chunked</span>
<span class="nt">Date</span><span class="o">:</span> <span class="nt">Wed</span><span class="o">,</span> <span class="nt">19</span> <span class="nt">Feb</span> <span class="nt">2014</span> <span class="nt">13</span><span class="p">:</span><span class="nd">32</span><span class="p">:</span><span class="nd">24</span> <span class="nt">GMT</span>
<span class="nt">Connection</span><span class="o">:</span> <span class="nt">close</span>

<span class="hll"><span class="p">{</span><span class="err">&quot;code&quot;:&quot;e.ex.fw.7003&quot;,&quot;message&quot;:&quot;Request</span> <span class="err">body</span> <span class="err">format</span> <span class="err">error</span> <span class="err">occurred.&quot;</span><span class="p">}</span>
</span></pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="resthowtouseexceptionhandlingfornotfound">
<span id="id39"></span><h4><a class="toc-backref" href="#id112">5.16.4.4.3. リソース未検出エラー例外のハンドリング実装</a><a class="headerlink" href="#resthowtouseexceptionhandlingfornotfound" title="Permalink to this headline">¶</a></h4>
<p>リソースが存在しない場合に、リソース未検出エラーを応答するための実装例について説明する。</p>
<div class="line-block">
<div class="line">パス変数から取得したIDに一致するリソースが見つからない場合は、リソースが見つからない事を通知する例外を発生させる。</div>
<div class="line">リソースが見つからなかった事を通知する例外として、共通ライブラリより<code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.exception.ResourceNotFoundException</span></code>を用意している。</div>
<div class="line">以下に実装例を示す。</div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>パス変数から取得したIDに一致するリソースが見つからない場合は、<code class="docutils literal"><span class="pre">ResourceNotFoundException</span></code>を発生させる。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Member</span> <span class="nf">getMember</span><span class="p">(</span><span class="n">String</span> <span class="n">memberId</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">memberId</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">member</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
<span class="hll">        <span class="k">throw</span> <span class="k">new</span> <span class="n">ResourceNotFoundException</span><span class="p">(</span><span class="n">ResultMessages</span><span class="p">.</span><span class="na">error</span><span class="p">().</span><span class="na">add</span><span class="p">(</span>
</span><span class="hll">                <span class="s">&quot;e.ex.mm.5001&quot;</span><span class="p">,</span> <span class="n">memberId</span><span class="p">));</span>
</span>    <span class="p">}</span>
    <span class="k">return</span> <span class="n">member</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">ResultMessages</span></code>用のエラー情報を生成するためのメソッドを作成する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiErrorCreator</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

<span class="hll">    <span class="c1">// (1)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">ApiError</span> <span class="nf">createResultMessagesApiError</span><span class="p">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="p">,</span>
</span>            <span class="n">String</span> <span class="n">rootErrorCode</span><span class="p">,</span> <span class="n">ResultMessages</span> <span class="n">resultMessages</span><span class="p">,</span>
            <span class="n">String</span> <span class="n">defaultErrorMessage</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ApiError</span> <span class="n">apiError</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">resultMessages</span><span class="p">.</span><span class="na">getList</span><span class="p">().</span><span class="na">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ResultMessage</span> <span class="n">resultMessage</span> <span class="o">=</span> <span class="n">resultMessages</span><span class="p">.</span><span class="na">iterator</span><span class="p">().</span><span class="na">next</span><span class="p">();</span>
            <span class="n">String</span> <span class="n">errorCode</span> <span class="o">=</span> <span class="n">resultMessage</span><span class="p">.</span><span class="na">getCode</span><span class="p">();</span>
            <span class="n">String</span> <span class="n">errorText</span> <span class="o">=</span> <span class="n">resultMessage</span><span class="p">.</span><span class="na">getText</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">errorCode</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">errorText</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">errorCode</span> <span class="o">=</span> <span class="n">rootErrorCode</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">apiError</span> <span class="o">=</span> <span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">errorCode</span><span class="p">,</span> <span class="n">errorText</span><span class="p">,</span>
                    <span class="n">resultMessage</span><span class="p">.</span><span class="na">getArgs</span><span class="p">());</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">apiError</span> <span class="o">=</span> <span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">rootErrorCode</span><span class="p">,</span>
                    <span class="n">defaultErrorMessage</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">ResultMessage</span> <span class="n">resultMessage</span> <span class="p">:</span> <span class="n">resultMessages</span><span class="p">.</span><span class="na">getList</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">apiError</span><span class="p">.</span><span class="na">addDetail</span><span class="p">(</span><span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">resultMessage</span>
                        <span class="p">.</span><span class="na">getCode</span><span class="p">(),</span> <span class="n">resultMessage</span><span class="p">.</span><span class="na">getText</span><span class="p">(),</span> <span class="n">resultMessage</span>
                        <span class="p">.</span><span class="na">getArgs</span><span class="p">()));</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">apiError</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">処理結果からエラー情報を生成するためのメソッドを作成する。</div>
<div class="line">上記例では、<code class="docutils literal"><span class="pre">ResultMessages</span></code>が保持しているメッセージ情報を、エラー情報に設定している。</div>
<div class="line"><br /></div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>上記例では、<code class="docutils literal"><span class="pre">ResultMessages</span></code>が複数のメッセージを保持する事ができるため、格納されているメッセージが1件の時と複数件の時で処理をわけている。</p>
<p class="last">複数件のメッセージをサポートする必要がない場合は、先頭の1件をエラー情報として生成する処理にすればよい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>エラーハンドリングを行うクラスに、リソースが見つからない事を通知する例外をハンドリングするためのメソッドを作成する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiGlobalExceptionHandler</span> <span class="kd">extends</span> <span class="n">ResponseEntityExceptionHandler</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ApiErrorCreator</span> <span class="n">apiErrorCreator</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">ExceptionCodeResolver</span> <span class="n">exceptionCodeResolver</span><span class="p">;</span>

    <span class="c1">// omitted</span>

<span class="hll">    <span class="c1">// (2)</span>
</span><span class="hll">    <span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">ResourceNotFoundException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
</span>    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleResourceNotFoundException</span><span class="p">(</span>
            <span class="n">ResourceNotFoundException</span> <span class="n">ex</span><span class="p">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">handleResultMessagesNotificationException</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="p">(),</span>
<span class="hll">                <span class="n">HttpStatus</span><span class="p">.</span><span class="na">NOT_FOUND</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
</span>    <span class="p">}</span>

    <span class="c1">// omitted</span>

<span class="hll">    <span class="c1">// (3)</span>
</span><span class="hll">    <span class="kd">private</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleResultMessagesNotificationException</span><span class="p">(</span>
</span>            <span class="n">ResultMessagesNotificationException</span> <span class="n">ex</span><span class="p">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="p">,</span>
            <span class="n">HttpStatus</span> <span class="n">status</span><span class="p">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">errorCode</span> <span class="o">=</span> <span class="n">exceptionCodeResolver</span><span class="p">.</span><span class="na">resolveExceptionCode</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
        <span class="n">ApiError</span> <span class="n">apiError</span> <span class="o">=</span> <span class="n">apiErrorCreator</span><span class="p">.</span><span class="na">createResultMessagesApiError</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span> <span class="n">errorCode</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="na">getResultMessages</span><span class="p">(),</span> <span class="n">ex</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
        <span class="k">return</span> <span class="n">handleExceptionInternal</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">apiError</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ResourceNotFoundException</span></code>をハンドリングするためのメソッドを追加する。</div>
<div class="line">メソッドアノテーションとして<code class="docutils literal"><span class="pre">&#64;ExceptionHandler(ResourceNotFoundException.class)</span></code>を指定すると、<code class="docutils literal"><span class="pre">ResourceNotFoundException</span></code>の例外をハンドリングする事ができる。</div>
<div class="line">上記例では、<code class="docutils literal"><span class="pre">ResourceNotFoundException</span></code>の親クラス(<code class="docutils literal"><span class="pre">ResultMessagesNotificationException</span></code>)の例外をハンドリングするメソッドに処理を委譲している。</div>
<div class="line"><br /></div>
<div class="line">ステータスコードには<strong>404(Not Found)</strong>を設定し、指定されたリソースがサーバに存在しない事を通知する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソース未検出エラー及び業務エラーのエラー情報を保持するJavaBeanオブジェクトを生成する。</div>
<div class="line">上記例では、以降で説明する業務エラーのハンドリング処理と同じ処理となるので、共通メソッドとして本メソッドを作成している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>リソースが見つからない場合、以下のようなエラー応答が行われる。</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="hll"><span class="nt">HTTP</span><span class="o">/</span><span class="nt">1</span><span class="p">.</span><span class="nc">1</span> <span class="nt">404</span> <span class="nt">Not</span> <span class="nt">Found</span>
</span><span class="nt">Server</span><span class="o">:</span> <span class="nt">Apache-Coyote</span><span class="o">/</span><span class="nt">1</span><span class="p">.</span><span class="nc">1</span>
<span class="nt">X-Track</span><span class="o">:</span> <span class="nt">5ee563877f3140fd904d0acf52eba398</span>
<span class="nt">Content-Type</span><span class="o">:</span> <span class="nt">application</span><span class="o">/</span><span class="nt">json</span><span class="o">;</span><span class="nt">charset</span><span class="o">=</span><span class="nt">UTF-8</span>
<span class="nt">Transfer-Encoding</span><span class="o">:</span> <span class="nt">chunked</span>
<span class="nt">Date</span><span class="o">:</span> <span class="nt">Wed</span><span class="o">,</span> <span class="nt">19</span> <span class="nt">Feb</span> <span class="nt">2014</span> <span class="nt">08</span><span class="p">:</span><span class="nd">46</span><span class="p">:</span><span class="nd">18</span> <span class="nt">GMT</span>

<span class="hll"><span class="p">{</span><span class="err">&quot;code&quot;:&quot;e.ex.mm.5001&quot;,&quot;message&quot;:&quot;Specified</span> <span class="err">member</span> <span class="err">not</span> <span class="err">found.</span> <span class="err">member</span> <span class="n">id</span> <span class="p">:</span> <span class="n">M000000001</span><span class="err">&quot;</span><span class="p">}</span>
</span></pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="resthowtouseexceptionhandlingforbusinesserror">
<span id="id40"></span><h4><a class="toc-backref" href="#id113">5.16.4.4.4. 業務エラー例外のハンドリング実装</a><a class="headerlink" href="#resthowtouseexceptionhandlingforbusinesserror" title="Permalink to this headline">¶</a></h4>
<p>ビジネスルールの違反を検知した場合に、業務エラーを応答するための実装例について説明する。</p>
<p>ビジネスルールのチェックはServiceの処理として行い、ビジネスルールの違反を検知した場合は、業務例外を発生させる。
業務エラーの検知方法については、「<a class="reference internal" href="../ImplementationAtEachLayer/DomainLayer.html#service-return-businesserrormessage-label"><span class="std std-ref">業務エラーを通知する</span></a>」を参照されたい。</p>
<ul class="simple">
<li>エラーハンドリングを行うクラスに、業務例外をハンドリングするためのメソッドを作成する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiGlobalExceptionHandler</span> <span class="kd">extends</span> <span class="n">ResponseEntityExceptionHandler</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

<span class="hll">    <span class="c1">// (1)</span>
</span><span class="hll">    <span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">BusinessException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
</span>    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleBusinessException</span><span class="p">(</span><span class="n">BusinessException</span> <span class="n">ex</span><span class="p">,</span>
            <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">handleResultMessagesNotificationException</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="p">(),</span>
<span class="hll">                <span class="n">HttpStatus</span><span class="p">.</span><span class="na">CONFLICT</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
</span>    <span class="p">}</span>

    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">BusinessException</span></code>をハンドリングするためのメソッドを追加する。</div>
<div class="line">メソッドアノテーションとして<code class="docutils literal"><span class="pre">&#64;ExceptionHandler(BusinessException.class)</span></code>を指定すると、<code class="docutils literal"><span class="pre">BusinessException</span></code>の例外をハンドリングする事ができる。</div>
<div class="line">上記例では、<code class="docutils literal"><span class="pre">BusinessException</span></code>の親クラス(<code class="docutils literal"><span class="pre">ResultMessagesNotificationException</span></code>)の例外をハンドリングするメソッドに処理を委譲している。</div>
<div class="line"><br /></div>
<div class="line">ステータスコードには<strong>409(Conflict)</strong>を設定し、クライアントから指定されたリソース自体には不備はないが、サーバで保持しているリソースを操作するための条件が全て整っていない事を通知する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>業務エラーが発生した場合、以下のようなエラー応答が行われる。</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="hll"><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span><span class="w"> </span><span class="mi">409</span><span class="w"> </span><span class="n">Conflict</span><span class="w"></span>
</span><span class="nl">Server</span><span class="p">:</span><span class="w"> </span><span class="n">Apache</span><span class="o">-</span><span class="n">Coyote</span><span class="o">/</span><span class="mf">1.1</span><span class="w"></span>
<span class="n">X</span><span class="o">-</span><span class="nl">Track</span><span class="p">:</span><span class="w"> </span><span class="mi">37</span><span class="n">c1a899d5f74e7a9c24662292837ef7</span><span class="w"></span>
<span class="n">Content</span><span class="o">-</span><span class="nl">Type</span><span class="p">:</span><span class="w"> </span><span class="n">application</span><span class="o">/</span><span class="n">json</span><span class="p">;</span><span class="n">charset</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span><span class="w"></span>
<span class="n">Transfer</span><span class="o">-</span><span class="nl">Encoding</span><span class="p">:</span><span class="w"> </span><span class="n">chunked</span><span class="w"></span>
<span class="nc">Date</span><span class="err">:</span><span class="w"> </span><span class="n">Wed</span><span class="p">,</span><span class="w"> </span><span class="mi">19</span><span class="w"> </span><span class="n">Feb</span><span class="w"> </span><span class="mi">2014</span><span class="w"> </span><span class="mi">09</span><span class="err">:</span><span class="mi">03</span><span class="err">:</span><span class="mi">26</span><span class="w"> </span><span class="n">GMT</span><span class="w"></span>

<span class="hll"><span class="err">{</span><span class="ss">&quot;code&quot;</span><span class="err">:</span><span class="ss">&quot;e.ex.mm.8001&quot;</span><span class="p">,</span><span class="ss">&quot;message&quot;</span><span class="err">:</span><span class="ss">&quot;Cannot use specified sign id. sign id : user1@test.com&quot;</span><span class="err">}</span><span class="w"></span>
</span></pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="resthowtouseexceptionhandlingforexcusionerror">
<span id="id41"></span><h4><a class="toc-backref" href="#id114">5.16.4.4.5. 排他エラー例外のハンドリング実装</a><a class="headerlink" href="#resthowtouseexceptionhandlingforexcusionerror" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">排他エラーが発生した場合に、排他エラーを応答するための実装例について説明する。</div>
<div class="line">排他制御を行う場合は、排他エラーのハンドリングが必要となる。</div>
<div class="line">排他制御の詳細については、「<a class="reference internal" href="ExclusionControl.html"><span class="doc">排他制御</span></a>」を参照されたい。</div>
</div>
<ul class="simple">
<li>エラーハンドリングを行うクラスに、排他エラーをハンドリングするためのメソッドを作成する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiGlobalExceptionHandler</span> <span class="kd">extends</span> <span class="n">ResponseEntityExceptionHandler</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

<span class="hll">    <span class="c1">// (1)</span>
</span><span class="hll">    <span class="nd">@ExceptionHandler</span><span class="p">({</span> <span class="n">OptimisticLockingFailureException</span><span class="p">.</span><span class="na">class</span><span class="p">,</span>
</span><span class="hll">            <span class="n">PessimisticLockingFailureException</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span>
</span>    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleLockingFailureException</span><span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">,</span>
            <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">handleExceptionInternal</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="p">(),</span>
<span class="hll">                <span class="n">HttpStatus</span><span class="p">.</span><span class="na">CONFLICT</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
</span>    <span class="p">}</span>

    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">排他エラー(<code class="docutils literal"><span class="pre">OptimisticLockingFailureException</span></code>と<code class="docutils literal"><span class="pre">PessimisticLockingFailureException</span></code>)をハンドリングするためのメソッドを追加する。</div>
<div class="line">メソッドアノテーションとして<code class="docutils literal"><span class="pre">&#64;ExceptionHandler({</span> <span class="pre">OptimisticLockingFailureException.class,</span> <span class="pre">PessimisticLockingFailureException.class</span> <span class="pre">})</span></code>を指定すると、排他エラー(<code class="docutils literal"><span class="pre">OptimisticLockingFailureException</span></code>と<code class="docutils literal"><span class="pre">PessimisticLockingFailureException</span></code>)の例外をハンドリングする事ができる。</div>
<div class="line"><br /></div>
<div class="line">ステータスコードには<strong>409(Conflict)</strong>を設定し、クライアントから指定されたリソース自体には不備はないが、処理が競合したためリソースを操作するための条件を満たすことが出来なかった事を通知する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>排他エラーが発生した場合、以下のようなエラー応答が行われる。</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="hll"><span class="nt">HTTP</span><span class="o">/</span><span class="nt">1</span><span class="p">.</span><span class="nc">1</span> <span class="nt">409</span> <span class="nt">Conflict</span>
</span><span class="nt">Server</span><span class="o">:</span> <span class="nt">Apache-Coyote</span><span class="o">/</span><span class="nt">1</span><span class="p">.</span><span class="nc">1</span>
<span class="nt">X-Track</span><span class="o">:</span> <span class="nt">85200b5a51be42b29840e482ee35087f</span>
<span class="nt">Content-Type</span><span class="o">:</span> <span class="nt">application</span><span class="o">/</span><span class="nt">json</span><span class="o">;</span><span class="nt">charset</span><span class="o">=</span><span class="nt">UTF-8</span>
<span class="nt">Transfer-Encoding</span><span class="o">:</span> <span class="nt">chunked</span>
<span class="nt">Date</span><span class="o">:</span> <span class="nt">Wed</span><span class="o">,</span> <span class="nt">19</span> <span class="nt">Feb</span> <span class="nt">2014</span> <span class="nt">16</span><span class="p">:</span><span class="nd">32</span><span class="p">:</span><span class="nd">45</span> <span class="nt">GMT</span>

<span class="hll"><span class="p">{</span><span class="err">&quot;code&quot;:&quot;e.ex.fw.8002&quot;,&quot;message&quot;:&quot;Conflict</span> <span class="err">with</span> <span class="err">other</span> <span class="err">processing</span> <span class="err">occurred.&quot;</span><span class="p">}</span>
</span></pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="resthowtouseexceptionhandlingforsystemerror">
<span id="id42"></span><h4><a class="toc-backref" href="#id115">5.16.4.4.6. システムエラー例外のハンドリング実装</a><a class="headerlink" href="#resthowtouseexceptionhandlingforsystemerror" title="Permalink to this headline">¶</a></h4>
<p>システム異常を検知した場合に、システムエラーを応答するための実装例について説明する。</p>
<p>システム異常の検知した場合は、システム例外を発生させる。
システムエラーの検知方法については、「<a class="reference internal" href="../ImplementationAtEachLayer/DomainLayer.html#service-return-systemerrormessage-label"><span class="std std-ref">システムエラーを通知する</span></a>」を参照されたい。</p>
<ul class="simple">
<li>エラーハンドリングを行うクラスに、システム例外をハンドリングするためのメソッドを作成する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiGlobalExceptionHandler</span> <span class="kd">extends</span> <span class="n">ResponseEntityExceptionHandler</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

<span class="hll">    <span class="c1">// (1)</span>
</span><span class="hll">    <span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">Exception</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
</span>    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleSystemError</span><span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">,</span>
            <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">handleExceptionInternal</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="p">(),</span>
<span class="hll">                <span class="n">HttpStatus</span><span class="p">.</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
</span>    <span class="p">}</span>

    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Exception</span></code>をハンドリングするためのメソッドを追加する。</div>
<div class="line">メソッドアノテーションとして<code class="docutils literal"><span class="pre">&#64;ExceptionHandler(Exception.class)</span></code>を指定すると、<code class="docutils literal"><span class="pre">Exception</span></code>の例外をハンドリングする事ができる。</div>
<div class="line">上記例では、使用している依存ライブラリから発生するシステム例外もハンドリング対象としている。</div>
<div class="line"><br /></div>
<div class="line">ステータスコードには<strong>500(Internal Server Error)</strong>を設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>システムエラーが発生した場合、以下のようなエラー応答が行われる。</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="hll"><span class="nt">HTTP</span><span class="o">/</span><span class="nt">1</span><span class="p">.</span><span class="nc">1</span> <span class="nt">500</span> <span class="nt">Internal</span> <span class="nt">Server</span> <span class="nt">Error</span>
</span><span class="nt">Server</span><span class="o">:</span> <span class="nt">Apache-Coyote</span><span class="o">/</span><span class="nt">1</span><span class="p">.</span><span class="nc">1</span>
<span class="nt">X-Track</span><span class="o">:</span> <span class="nt">3625d5a040a744e49b0a9b3763a24e9c</span>
<span class="nt">Content-Type</span><span class="o">:</span> <span class="nt">application</span><span class="o">/</span><span class="nt">json</span><span class="o">;</span><span class="nt">charset</span><span class="o">=</span><span class="nt">UTF-8</span>
<span class="nt">Transfer-Encoding</span><span class="o">:</span> <span class="nt">chunked</span>
<span class="nt">Date</span><span class="o">:</span> <span class="nt">Wed</span><span class="o">,</span> <span class="nt">19</span> <span class="nt">Feb</span> <span class="nt">2014</span> <span class="nt">12</span><span class="p">:</span><span class="nd">22</span><span class="p">:</span><span class="nd">33</span> <span class="nt">GMT</span>
<span class="nt">Connection</span><span class="o">:</span> <span class="nt">close</span>

<span class="hll"><span class="p">{</span><span class="err">&quot;code&quot;:&quot;e.ex.fw.9003&quot;,&quot;message&quot;:&quot;System</span> <span class="err">error</span> <span class="err">occurred.&quot;</span><span class="p">}</span>
</span></pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>システムエラー時のエラーメッセージについて</strong></p>
<p>システムエラーが発生した場合、クライアントへ返却するメッセージは、エラー原因が特定されないシンプルなエラーメッセージを設定することを推奨する。
エラー原因が特定できるメッセージを設定してしまうと、システムの脆弱性をクライアントに公開する可能性があり、セキュリティー上問題がある。</p>
<p class="last">エラー原因は、エラー解析用にログに出力する。
Blankプロジェクトのデフォルトの設定では、共通ライブラリから提供している<code class="docutils literal"><span class="pre">ExceptionLogger</span></code>によってログが出力されるようなっているため、ログを出力するための設定や実装は不要である。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="exceptioncoderesolver">
<span id="resthowtouseexceptionhandlingsettingsofexceptioncoderesolver"></span><h4><a class="toc-backref" href="#id116">5.16.4.4.7. ExceptionCodeResolverを使ったエラーコードとメッセージの解決</a><a class="headerlink" href="#exceptioncoderesolver" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">共通ライブラリより提供している<code class="docutils literal"><span class="pre">ExceptionCodeResolver</span></code>を使用すると、例外クラスからエラーコードを解決する事ができる。</div>
<div class="line">特に、エラー原因がクライアント側にある場合は、エラー原因に応じたエラーメッセージを設定する事が求められるケースがあるため、そのような場合に便利な機能である。</div>
</div>
<ul>
<li><div class="first line-block">
<div class="line"><code class="file docutils literal"><span class="pre">applicationContext.xml</span></code></div>
<div class="line">例外クラスとエラーコード(例外コード)のマッピングを行う。</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;exceptionCodeResolver&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.common.exception.SimpleMappingExceptionCodeResolver&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionMappings&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;map&gt;</span>
            <span class="c">&lt;!-- omitted --&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;ResourceNotFoundException&quot;</span>              <span class="na">value=</span><span class="s">&quot;e.ex.fw.5001&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;HttpRequestMethodNotSupportedException&quot;</span> <span class="na">value=</span><span class="s">&quot;e.ex.fw.6001&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;MediaTypeNotAcceptableException&quot;</span>        <span class="na">value=</span><span class="s">&quot;e.ex.fw.6002&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;HttpMediaTypeNotSupportedException&quot;</span>     <span class="na">value=</span><span class="s">&quot;e.ex.fw.6003&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;MethodArgumentNotValidException&quot;</span>        <span class="na">value=</span><span class="s">&quot;e.ex.fw.7001&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;BindException&quot;</span>                          <span class="na">value=</span><span class="s">&quot;e.ex.fw.7002&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;JsonParseException&quot;</span>                     <span class="na">value=</span><span class="s">&quot;e.ex.fw.7003&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;UnrecognizedPropertyException&quot;</span>          <span class="na">value=</span><span class="s">&quot;e.ex.fw.7004&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;JsonMappingException&quot;</span>                   <span class="na">value=</span><span class="s">&quot;e.ex.fw.7005&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;TypeMismatchException&quot;</span>                  <span class="na">value=</span><span class="s">&quot;e.ex.fw.7006&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;BusinessException&quot;</span>                      <span class="na">value=</span><span class="s">&quot;e.ex.fw.8001&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;OptimisticLockingFailureException&quot;</span>      <span class="na">value=</span><span class="s">&quot;e.ex.fw.8002&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;PessimisticLockingFailureException&quot;</span>     <span class="na">value=</span><span class="s">&quot;e.ex.fw.8002&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;DataAccessException&quot;</span>                    <span class="na">value=</span><span class="s">&quot;e.ex.fw.9002&quot;</span> <span class="nt">/&gt;</span>
            <span class="c">&lt;!-- omitted --&gt;</span>
        <span class="nt">&lt;/map&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultExceptionCode&quot;</span> <span class="na">value=</span><span class="s">&quot;e.ex.fw.9001&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">エラーコードに対応するメッセージの設定例を以下に示す。</div>
<div class="line">メッセージの管理方法については、「<a class="reference internal" href="MessageManagement.html"><span class="doc">メッセージ管理</span></a>」を参照されたい。</div>
</div>
<ul>
<li><div class="first line-block">
<div class="line"><code class="file docutils literal"><span class="pre">xxx-web/src/main/resources/i18n/application-messages.properties</span></code></div>
<div class="line">アプリケーション層で発生するエラーに対して、エラーコード(例外コード)に対応するメッセージの設定を行う。</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="highlight-properties"><div class="highlight"><pre><span></span><span class="c"># ---</span>
<span class="c"># Application common messages</span>
<span class="c"># ---</span>
<span class="na">e.ex.fw.5001</span> <span class="o">=</span> <span class="s">Resource not found.</span>

<span class="na">e.ex.fw.6001</span> <span class="o">=</span> <span class="s">Request method not supported.</span>
<span class="na">e.ex.fw.6002</span> <span class="o">=</span> <span class="s">Specified representation format not supported.</span>
<span class="na">e.ex.fw.6003</span> <span class="o">=</span> <span class="s">Specified media type in the request body not supported.</span>

<span class="na">e.ex.fw.7001</span> <span class="o">=</span> <span class="s">Validation error occurred on item in the request body.</span>
<span class="na">e.ex.fw.7002</span> <span class="o">=</span> <span class="s">Validation error occurred on item in the request parameters.</span>
<span class="na">e.ex.fw.7003</span> <span class="o">=</span> <span class="s">Request body format error occurred.</span>
<span class="na">e.ex.fw.7004</span> <span class="o">=</span> <span class="s">Unknown field exists in JSON.</span>
<span class="na">e.ex.fw.7005</span> <span class="o">=</span> <span class="s">Type mismatch error occurred in JSON field.</span>
<span class="na">e.ex.fw.7006</span> <span class="o">=</span> <span class="s">Type mismatch error occurred in request parameter or header or path variable.</span>

<span class="na">e.ex.fw.8001</span> <span class="o">=</span> <span class="s">Business error occurred.</span>
<span class="na">e.ex.fw.8002</span> <span class="o">=</span> <span class="s">Conflict with other processing occurred.</span>

<span class="na">e.ex.fw.9001</span> <span class="o">=</span> <span class="s">System error occurred.</span>
<span class="na">e.ex.fw.9002</span> <span class="o">=</span> <span class="s">System error occurred.</span>
<span class="na">e.ex.fw.9003</span> <span class="o">=</span> <span class="s">System error occurred.</span>

<span class="c"># omitted</span>
</pre></div>
</div>
</div></blockquote>
<ul>
<li><div class="first line-block">
<div class="line"><code class="file docutils literal"><span class="pre">xxx-web/src/main/resources/ValidationMessages.properties</span></code></div>
<div class="line">Bean Validationを使った入力チェックで発生するエラーに対して、エラーコードに対応するメッセージの設定を行う。</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="highlight-properties"><div class="highlight"><pre><span></span><span class="c"># ---</span>
<span class="c"># Bean Validation common messages</span>
<span class="c"># ---</span>

<span class="c"># for bean validation of standard</span>
<span class="na">javax.validation.constraints.AssertFalse.message</span> <span class="o">=</span> <span class="s">&quot;{0}&quot; must be false.</span>
<span class="na">javax.validation.constraints.AssertTrue.message</span>  <span class="o">=</span> <span class="s">&quot;{0}&quot; must be true.</span>
<span class="na">javax.validation.constraints.DecimalMax.message</span>  <span class="o">=</span> <span class="s">&quot;{0}&quot; must be less than ${inclusive == true ? &#39;or equal to &#39; : &#39;&#39;}{value}.</span>
<span class="na">javax.validation.constraints.DecimalMin.message</span>  <span class="o">=</span> <span class="s">&quot;{0}&quot; must be greater than ${inclusive == true ? &#39;or equal to &#39; : &#39;&#39;}{value}.</span>
<span class="na">javax.validation.constraints.Digits.message</span>      <span class="o">=</span> <span class="s">&quot;{0}&quot; numeric value out of bounds (&lt;{integer} digits&gt;.&lt;{fraction} digits&gt; expected).</span>
<span class="na">javax.validation.constraints.Future.message</span>      <span class="o">=</span> <span class="s">&quot;{0}&quot; must be in the future.</span>
<span class="na">javax.validation.constraints.Max.message</span>         <span class="o">=</span> <span class="s">&quot;{0}&quot; must be less than or equal to {value}.</span>
<span class="na">javax.validation.constraints.Min.message</span>         <span class="o">=</span> <span class="s">&quot;{0}&quot; must be greater than or equal to {value}.</span>
<span class="na">javax.validation.constraints.NotNull.message</span>     <span class="o">=</span> <span class="s">&quot;{0}&quot; may not be null.</span>
<span class="na">javax.validation.constraints.Null.message</span>        <span class="o">=</span> <span class="s">&quot;{0}&quot; must be null.</span>
<span class="na">javax.validation.constraints.Past.message</span>        <span class="o">=</span> <span class="s">&quot;{0}&quot; must be in the past.</span>
<span class="na">javax.validation.constraints.Pattern.message</span>     <span class="o">=</span> <span class="s">&quot;{0}&quot; must match &quot;{regexp}&quot;.</span>
<span class="na">javax.validation.constraints.Size.message</span>        <span class="o">=</span> <span class="s">&quot;{0}&quot; size must be between {min} and {max}.</span>

<span class="c"># for bean validation of hibernate</span>
<span class="na">org.hibernate.validator.constraints.CreditCardNumber.message</span>        <span class="o">=</span> <span class="s">&quot;{0}&quot; invalid credit card number.</span>
<span class="na">org.hibernate.validator.constraints.EAN.message</span>                     <span class="o">=</span> <span class="s">&quot;{0}&quot; invalid {type} barcode.</span>
<span class="na">org.hibernate.validator.constraints.Email.message</span>                   <span class="o">=</span> <span class="s">&quot;{0}&quot; not a well-formed email address.</span>
<span class="na">org.hibernate.validator.constraints.Length.message</span>                  <span class="o">=</span> <span class="s">&quot;{0}&quot; length must be between {min} and {max}.</span>
<span class="na">org.hibernate.validator.constraints.LuhnCheck.message</span>               <span class="o">=</span> <span class="s">&quot;{0}&quot; The check digit for ${validatedValue} is invalid, Luhn Modulo 10 checksum failed.</span>
<span class="na">org.hibernate.validator.constraints.Mod10Check.message</span>              <span class="o">=</span> <span class="s">&quot;{0}&quot; The check digit for ${validatedValue} is invalid, Modulo 10 checksum failed.</span>
<span class="na">org.hibernate.validator.constraints.Mod11Check.message</span>              <span class="o">=</span> <span class="s">&quot;{0}&quot; The check digit for ${validatedValue} is invalid, Modulo 11 checksum failed.</span>
<span class="na">org.hibernate.validator.constraints.ModCheck.message</span>                <span class="o">=</span> <span class="s">&quot;{0}&quot; The check digit for ${validatedValue} is invalid, ${modType} checksum failed.</span>
<span class="na">org.hibernate.validator.constraints.NotBlank.message</span>                <span class="o">=</span> <span class="s">&quot;{0}&quot; may not be empty.</span>
<span class="na">org.hibernate.validator.constraints.NotEmpty.message</span>                <span class="o">=</span> <span class="s">&quot;{0}&quot; may not be empty.</span>
<span class="na">org.hibernate.validator.constraints.ParametersScriptAssert.message</span>  <span class="o">=</span> <span class="s">&quot;{0}&quot; script expression &quot;{script}&quot; didn&#39;t evaluate to true.</span>
<span class="na">org.hibernate.validator.constraints.Range.message</span>                   <span class="o">=</span> <span class="s">&quot;{0}&quot; must be between {min} and {max}.</span>
<span class="na">org.hibernate.validator.constraints.SafeHtml.message</span>                <span class="o">=</span> <span class="s">&quot;{0}&quot; may have unsafe html content.</span>
<span class="na">org.hibernate.validator.constraints.ScriptAssert.message</span>            <span class="o">=</span> <span class="s">&quot;{0}&quot; script expression &quot;{script}&quot; didn&#39;t evaluate to true.</span>
<span class="na">org.hibernate.validator.constraints.URL.message</span>                     <span class="o">=</span> <span class="s">&quot;{0}&quot; must be a valid URL.</span>

<span class="na">org.hibernate.validator.constraints.br.CNPJ.message</span>                 <span class="o">=</span> <span class="s">&quot;{0}&quot; invalid Brazilian corporate taxpayer registry number (CNPJ).</span>
<span class="na">org.hibernate.validator.constraints.br.CPF.message</span>                  <span class="o">=</span> <span class="s">&quot;{0}&quot; invalid Brazilian individual taxpayer registry number (CPF).</span>
<span class="na">org.hibernate.validator.constraints.br.TituloEleitoral.message</span>      <span class="o">=</span> <span class="s">&quot;{0}&quot; invalid Brazilian Voter ID card number.</span>

<span class="c"># for common library</span>
<span class="na">org.terasoluna.gfw.common.codelist.ExistInCodeList.message</span>   <span class="o">=</span> <span class="s">&quot;{0}&quot; must exist in code list of {codeListId}.</span>
</pre></div>
</div>
</div></blockquote>
<ul>
<li><div class="first line-block">
<div class="line"><code class="file docutils literal"><span class="pre">xxx-domain/src/main/resources/i18n/domain-messages.properties</span></code></div>
<div class="line">ドメイン層で発生するエラーに対して、エラーコード(例外コード)に対応するメッセージの設定を行う。</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="highlight-properties"><div class="highlight"><pre><span></span><span class="c"># omitted</span>

<span class="na">e.ex.mm.5001</span> <span class="o">=</span> <span class="s">Specified member not found. member id : {0}</span>
<span class="na">e.ex.mm.8001</span> <span class="o">=</span> <span class="s">Cannot use specified sign id. sign id : {0}</span>

<span class="c"># omitted</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="resthowtouseexceptionhandlingforservletcontainer">
<span id="id43"></span><h3><a class="toc-backref" href="#id117">5.16.4.5. サーブレットコンテナに通知されたエラーのハンドリングの実装</a><a class="headerlink" href="#resthowtouseexceptionhandlingforservletcontainer" title="Permalink to this headline">¶</a></h3>
<p>Filterでエラーが発生した場合や<code class="docutils literal"><span class="pre">HttpServletResponse#sendError</span></code>を使ってエラーレスポンスが行われた場合は、Spring MVCの例外ハンドリングの仕組みを使ってハンドリングできないため、
これらのエラーはサーブレットコンテナに通知される。</p>
<p>本節では、サーブレットコンテナに通知されたエラーをハンドリングする方法について説明する。</p>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/RESTHowToUseErrorHandlingByServletContainer.png"><img alt="Image of error handling processing by servlet container" src="../_images/RESTHowToUseErrorHandlingByServletContainer.png" style="width: 100%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">処理レイヤ</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Servlet Container</div>
<div class="line">(AP Server)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Servlet Containerはクライアントからのリクエストを受け付け、処理を行う。</div>
<div class="line">Servlet Containerは処理中にエラーを検知する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Servlet Containerは<code class="docutils literal"><span class="pre">web.xml</span></code>のerror-pageの定義に従って、エラー処理を行う。</div>
<div class="line">致命的なエラーでない場合は、エラーハンドリングを行うControllerを呼び出し、エラー処理を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2’)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">致命的なエラーの場合は、予め用意してある静的なJSONファイルを取得し、クライアントへ応答する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring MVC</div>
<div class="line">(Framework)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring MVCは、エラーハンドリングを行うControllerを呼び出す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Controller</div>
<div class="line">(Common Component)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラーハンドリングを行うControllerでは、エラー情報を保持するエラーオブジェクトを生成し、Spring MVCに返却する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring MVC</div>
<div class="line">(Framework)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring MVCは、<code class="docutils literal"><span class="pre">HttpMessageConverter</span></code>を利用して、エラーオブジェクトをJSON形式の電文に変換する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring MVCは、JSON形式のエラー電文をレスポンスBODYに設定し、クライアントにレスポンスする。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="id44">
<h4><a class="toc-backref" href="#id118">5.16.4.5.1. エラー応答を行うためのControllerの実装</a><a class="headerlink" href="#id44" title="Permalink to this headline">¶</a></h4>
<p>サーブレットコンテナに通知されたエラーのエラー応答を行うControllerを作成する。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.examples.rest.api.common.error</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.RequestDispatcher</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.MediaType</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.ResponseEntity</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.context.request.RequestAttributes</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.context.request.WebRequest</span><span class="p">;</span>

<span class="hll"><span class="c1">// (1)</span>
</span><span class="hll"><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;error&quot;</span><span class="p">)</span>
</span><span class="hll"><span class="nd">@RestController</span>
</span><span class="hll"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiErrorPageController</span> <span class="p">{</span>
</span>
<span class="hll">    <span class="nd">@Inject</span>
</span><span class="hll">    <span class="n">ApiErrorCreator</span> <span class="n">apiErrorCreator</span><span class="p">;</span> <span class="c1">// (2)</span>
</span>
<span class="hll">    <span class="c1">// (3)</span>
</span>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">HttpStatus</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">errorCodeMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">HttpStatus</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span><span class="p">();</span>

<span class="hll">    <span class="c1">// (4)</span>
</span>    <span class="kd">public</span> <span class="nf">ApiErrorPageController</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">errorCodeMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">NOT_FOUND</span><span class="p">,</span> <span class="s">&quot;e.ex.fw.5001&quot;</span><span class="p">);</span>
    <span class="p">}</span>

<span class="hll">    <span class="c1">// (5)</span>
</span><span class="hll">    <span class="nd">@RequestMapping</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">ApiError</span><span class="o">&gt;</span> <span class="nf">handleErrorPage</span><span class="p">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">        <span class="c1">// (6)</span>
</span>        <span class="n">HttpStatus</span> <span class="n">httpStatus</span> <span class="o">=</span> <span class="n">HttpStatus</span><span class="p">.</span><span class="na">valueOf</span><span class="p">((</span><span class="n">Integer</span><span class="p">)</span> <span class="n">request</span>
                <span class="p">.</span><span class="na">getAttribute</span><span class="p">(</span><span class="n">RequestDispatcher</span><span class="p">.</span><span class="na">ERROR_STATUS_CODE</span><span class="p">,</span>
                        <span class="n">RequestAttributes</span><span class="p">.</span><span class="na">SCOPE_REQUEST</span><span class="p">));</span>
<span class="hll">        <span class="c1">// (7)</span>
</span>        <span class="n">String</span> <span class="n">errorCode</span> <span class="o">=</span> <span class="n">errorCodeMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">httpStatus</span><span class="p">);</span>
<span class="hll">        <span class="c1">// (8)</span>
</span>        <span class="n">ApiError</span> <span class="n">apiError</span> <span class="o">=</span> <span class="n">apiErrorCreator</span><span class="p">.</span><span class="na">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">errorCode</span><span class="p">,</span>
                <span class="n">httpStatus</span><span class="p">.</span><span class="na">getReasonPhrase</span><span class="p">());</span>
<span class="hll">        <span class="c1">// (9)</span>
</span>        <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">httpStatus</span><span class="p">).</span><span class="na">body</span><span class="p">(</span><span class="n">apiError</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラー応答を行うためのControllerクラスを作成する。</div>
<div class="line">上記例では、「<code class="docutils literal"><span class="pre">/api/v1/error</span></code>」というサーブレットパスにマッピングしている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラー情報を作成するクラスをInjectする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">HTTPステータスコードとエラーコードをマッピングするための <code class="docutils literal"><span class="pre">Map</span></code>を作成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">HTTPステータスコードとエラーコードとのマッピングを登録する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラー応答を行うハンドラメソッドを作成する。</div>
<div class="line">上記例では、レスポンスコード(<code class="docutils literal"><span class="pre">&lt;error-code&gt;</span></code>)を使ってエラーページのハンドリングを行うケースのみを考慮した実装になっている。</div>
<div class="line">したがって、例外タイプ(<code class="docutils literal"><span class="pre">&lt;exception-type&gt;</span></code>)を使ってハンドリングしたエラーページの処理を本メソッドを使って行う場合は、別途考慮が必要である。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエストスコープに格納されているステータスコードを取得する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したステータスコードに対応するエラーコードを取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したエラーコードに対応するエラー情報を生成する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(8)で生成したエラー情報を応答する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id45">
<h4><a class="toc-backref" href="#id119">5.16.4.5.2. 致命的なエラーが発生した際に応答する静的なJSONファイルの作成</a><a class="headerlink" href="#id45" title="Permalink to this headline">¶</a></h4>
<p>致命的なエラーが発生した際に応答する静的なJSONファイルを作成する。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">unhandledSystemError.json</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;code&quot;</span><span class="p">:</span><span class="s2">&quot;e.ex.fw.9999&quot;</span><span class="p">,</span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;Unhandled system error occurred.&quot;</span><span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id46">
<h4><a class="toc-backref" href="#id120">5.16.4.5.3. サーブレットコンテナに通知されたエラーをハンドリングするための設定</a><a class="headerlink" href="#id46" title="Permalink to this headline">¶</a></h4>
<p>ここでは、サーブレットコンテナに通知されたエラーをハンドリングするための設定について説明する。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">web.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="hll"><span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="nt">&lt;error-page&gt;</span>
    <span class="nt">&lt;error-code&gt;</span>404<span class="nt">&lt;/error-code&gt;</span>
    <span class="nt">&lt;location&gt;</span>/api/v1/error<span class="nt">&lt;/location&gt;</span>
<span class="nt">&lt;/error-page&gt;</span>

<span class="hll"><span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="nt">&lt;error-page&gt;</span>
    <span class="nt">&lt;exception-type&gt;</span>java.lang.Exception<span class="nt">&lt;/exception-type&gt;</span>
    <span class="nt">&lt;location&gt;</span>/WEB-INF/views/common/error/unhandledSystemError.json<span class="nt">&lt;/location&gt;</span>
<span class="nt">&lt;/error-page&gt;</span>

<span class="hll"><span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="nt">&lt;mime-mapping&gt;</span>
    <span class="nt">&lt;extension&gt;</span>json<span class="nt">&lt;/extension&gt;</span>
    <span class="nt">&lt;mime-type&gt;</span>application/json;charset=UTF-8<span class="nt">&lt;/mime-type&gt;</span>
<span class="nt">&lt;/mime-mapping&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">必要に応じてレスポンスコードによるエラーページの定義を追加する。</div>
<div class="line">上記例では、<code class="docutils literal"><span class="pre">&quot;404</span> <span class="pre">Not</span> <span class="pre">Found&quot;</span></code>が発生した際に、「<code class="docutils literal"><span class="pre">/api/v1/error</span></code>」というリクエストにマッピングされているController(<code class="docutils literal"><span class="pre">ApiErrorPageController</span></code>)を呼び出してエラー応答を行っている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">致命的なエラーをハンドリングするための定義を追加する。</div>
<div class="line">致命的なエラーが発生していた場合、レスポンス情報を作成する処理で二重障害が発生する可能性があるため、予め用意している静的なJSONを応答する事を推奨する。</div>
<div class="line">上記例では、「<code class="docutils literal"><span class="pre">/WEB-INF/views/common/error/unhandledSystemError.json</span></code>」に定義されている固定のJSONを応答している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">jsonのMIMEタイプを指定する。</div>
<div class="line">(2)で作成するJSONファイルの中にマルチバイト文字を含める場合は、<code class="docutils literal"><span class="pre">charset=UTF-8</span></code>を指定しないと、クライアント側で文字化けする可能性がある。</div>
<div class="line">JSONファイルにマルチバイト文字を含めない場合は、この設定は必須ではないが、設定しておいた方が無難である。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><a class="reference external" href="http://download.oracle.com/otn-pub/jcp/servlet-3_1-fr-spec/servlet-3_1-final.pdf#page=128">Servletの仕様</a>では、 <code class="docutils literal"><span class="pre">&lt;error-page&gt;</span></code>の <code class="docutils literal"><span class="pre">&lt;location&gt;</span></code>にクエリパラメータを付与したパスを指定した場合の挙動について、定義していない。そのため、APサーバによって挙動が異なる可能性がある。
よって、クエリパラメータを使用してエラー時の遷移先に情報を渡すことは推奨しない。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>存在しないパスへリクエストを送った場合、以下のようなエラー応答が行われる。</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="hll"><span class="nt">HTTP</span><span class="o">/</span><span class="nt">1</span><span class="p">.</span><span class="nc">1</span> <span class="nt">404</span> <span class="nt">Not</span> <span class="nt">Found</span>
</span><span class="nt">Server</span><span class="o">:</span> <span class="nt">Apache-Coyote</span><span class="o">/</span><span class="nt">1</span><span class="p">.</span><span class="nc">1</span>
<span class="nt">X-Track</span><span class="o">:</span> <span class="nt">2ad50fb5ba2441699c91a5b01edef83f</span>
<span class="nt">Content-Type</span><span class="o">:</span> <span class="nt">application</span><span class="o">/</span><span class="nt">json</span><span class="o">;</span><span class="nt">charset</span><span class="o">=</span><span class="nt">UTF-8</span>
<span class="nt">Transfer-Encoding</span><span class="o">:</span> <span class="nt">chunked</span>
<span class="nt">Date</span><span class="o">:</span> <span class="nt">Wed</span><span class="o">,</span> <span class="nt">19</span> <span class="nt">Feb</span> <span class="nt">2014</span> <span class="nt">23</span><span class="p">:</span><span class="nd">24</span><span class="p">:</span><span class="nd">20</span> <span class="nt">GMT</span>

<span class="hll"><span class="p">{</span><span class="err">&quot;code&quot;:&quot;e.ex.fw.5001&quot;,&quot;message&quot;:&quot;Resource</span> <span class="err">not</span> <span class="err">found.&quot;</span><span class="p">}</span>
</span></pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>致命的なエラーが発生した場合、以下のようなエラー応答が行われる。</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="hll"><span class="n">HTTP</span><span class="o">/</span><span class="mi">1</span><span class="p">.</span><span class="mi">1</span> <span class="mi">500</span> <span class="n">Internal</span> <span class="n">Server</span> <span class="n">Error</span>
</span><span class="n">Server</span><span class="p">:</span> <span class="n">Apache</span><span class="o">-</span><span class="n">Coyote</span><span class="o">/</span><span class="mi">1</span><span class="p">.</span><span class="mi">1</span>
<span class="n">X</span><span class="o">-</span><span class="n">Track</span><span class="p">:</span> <span class="mi">69</span><span class="n">db3854a19f439781584321d9ce8336</span>
<span class="n">Content</span><span class="o">-</span><span class="k">Type</span><span class="p">:</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span>
<span class="n">Content</span><span class="o">-</span><span class="k">Length</span><span class="p">:</span> <span class="mi">68</span>
<span class="nb">Date</span><span class="p">:</span> <span class="n">Thu</span><span class="p">,</span> <span class="mi">20</span> <span class="n">Feb</span> <span class="mi">2014</span> <span class="mi">00</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mi">43</span> <span class="n">GMT</span>
<span class="k">Connection</span><span class="p">:</span> <span class="k">close</span>

<span class="hll"><span class="err">{</span><span class="ss">&quot;code&quot;</span><span class="p">:</span><span class="ss">&quot;e.ex.fw.9999&quot;</span><span class="p">,</span><span class="ss">&quot;message&quot;</span><span class="p">:</span><span class="ss">&quot;Unhandled system error occurred.&quot;</span><span class="err">}</span>
</span></pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="resthowtousesecurity">
<span id="id47"></span><h3><a class="toc-backref" href="#id121">5.16.4.6. セキュリティ対策</a><a class="headerlink" href="#resthowtousesecurity" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">RESTful Web Serviceに対するセキュリティ対策の実現方法について説明する。</div>
<div class="line">本ガイドラインでは、セキュリティ対策の実現方法として、Spring Securityを使用する事を推奨している。</div>
</div>
<div class="section" id="resthowtousesecurityauth">
<span id="id48"></span><h4><a class="toc-backref" href="#id122">5.16.4.6.1. 認証・認可</a><a class="headerlink" href="#resthowtousesecurityauth" title="Permalink to this headline">¶</a></h4>
<div class="admonition-todo admonition" id="index-7">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p class="last">OAuth2(Spring Security OAuth2)を使用して認証・認可を実現する方法について、次版以降に記載する予定である。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="csrf">
<span id="resthowtousesecuritycsrf"></span><h4><a class="toc-backref" href="#id123">5.16.4.6.2. CSRF対策</a><a class="headerlink" href="#csrf" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>RESTful Web Serviceに対してCSRF対策を行う場合の設定方法については、<a class="reference internal" href="../Security/CSRF.html#csrf-spring-security-setting"><span class="std std-ref">CSRF対策</span></a>を参照されたい。</li>
<li>RESTful Web Serviceに対してCSRF対策を行わない場合の設定方法については、<a class="reference internal" href="#restappendixdisabledcsrfprotection"><span class="std std-ref">CSRF対策の無効化</span></a>を参照されたい。</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="resthowtouseconditionaloperations">
<span id="id49"></span><h3><a class="toc-backref" href="#id124">5.16.4.7. リソースの条件付き操作</a><a class="headerlink" href="#resthowtouseconditionaloperations" title="Permalink to this headline">¶</a></h3>
<div class="admonition-todo admonition" id="index-8">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p class="last">Etagなどのヘッダを使った条件付き処理の制御の実現方法について、次版以降に記載する予定である。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="resthowtousecachecontrol">
<span id="id50"></span><h3><a class="toc-backref" href="#id125">5.16.4.8. リソースのキャッシュ制御</a><a class="headerlink" href="#resthowtousecachecontrol" title="Permalink to this headline">¶</a></h3>
<div class="admonition-todo admonition" id="index-9">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p class="last">Cache-Control/Expires/Pragmaなどのヘッダを使ったキャッシュ制御の実現方法について、次版以降に記載する予定である。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="how-to-extend">
<span id="resthowtoextend"></span><h2><a class="toc-backref" href="#id126">5.16.5. How to extend</a><a class="headerlink" href="#how-to-extend" title="Permalink to this headline">¶</a></h2>
<div class="section" id="jsonview">
<span id="restappendixjsonview"></span><h3><a class="toc-backref" href="#id127">5.16.5.1. &#64;JsonViewを使用したレスポンスの出力制御</a><a class="headerlink" href="#jsonview" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;JsonView</span></code>を使用することによって、Resourceオブジェクト内のプロパティーをグループ分けすることができる。</div>
<div class="line">この機能はSpring FrameworkがJacksonの機能をサポートすることにより実現している。</div>
<div class="line">詳細は、<a class="reference external" href="http://wiki.fasterxml.com/JacksonJsonViews">JacksonJsonViews</a>を参照されたい。</div>
</div>
<div class="line-block">
<div class="line">Controllerにてグループを指定することで、指定したグループに所属するプロパティーのみ出力することができる。</div>
<div class="line">1つのプロパティーは、複数のグループに所属することも可能である。</div>
<div class="line"><br /></div>
<div class="line">以下は、Memberリソースを「概要」と「詳細」の２つのフォーマットで扱う際の実装例である。</div>
<div class="line">「概要フォーマット」はMemberリソースの主要項目を、「詳細フォーマット」はMemberリソースの全項目を出力する。</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">MemberResource.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.examples.rest.api.member</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.joda.time.DateTime</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.joda.time.LocalDate</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.annotation.JsonView</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberResource</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

    <span class="c1">// (1)</span>
    <span class="kd">interface</span> <span class="nc">Summary</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="c1">// (2)</span>
    <span class="kd">interface</span> <span class="nc">Detail</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="c1">// (3)</span>
    <span class="nd">@JsonView</span><span class="p">({</span><span class="n">Summary</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">Detail</span><span class="p">.</span><span class="na">class</span><span class="p">})</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">memberId</span><span class="p">;</span>

    <span class="nd">@JsonView</span><span class="p">({</span><span class="n">Summary</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">Detail</span><span class="p">.</span><span class="na">class</span><span class="p">})</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">firstName</span><span class="p">;</span>

    <span class="nd">@JsonView</span><span class="p">({</span><span class="n">Summary</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">Detail</span><span class="p">.</span><span class="na">class</span><span class="p">})</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">lastName</span><span class="p">;</span>

    <span class="c1">// (4)</span>
    <span class="nd">@JsonView</span><span class="p">(</span><span class="n">Detail</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">genderCode</span><span class="p">;</span>

    <span class="nd">@JsonView</span><span class="p">(</span><span class="n">Detail</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">LocalDate</span> <span class="n">dateOfBirth</span><span class="p">;</span>

    <span class="nd">@JsonView</span><span class="p">(</span><span class="n">Detail</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">emailAddress</span><span class="p">;</span>

    <span class="nd">@JsonView</span><span class="p">(</span><span class="n">Detail</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">telephoneNumber</span><span class="p">;</span>

    <span class="nd">@JsonView</span><span class="p">(</span><span class="n">Detail</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">zipCode</span><span class="p">;</span>

    <span class="nd">@JsonView</span><span class="p">(</span><span class="n">Detail</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">address</span><span class="p">;</span>

    <span class="c1">// (5)</span>
    <span class="kd">private</span> <span class="n">DateTime</span> <span class="n">createdAt</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">DateTime</span> <span class="n">lastModifiedAt</span><span class="p">;</span>

    <span class="c1">// omitted setter and getter</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">出力制御するグループを指定するためのマーカーインターフェースを定義している。</div>
<div class="line">上記例では、概要出力時に指定するグループを定義している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">出力制御するグループを指定するためのマーカーインターフェースを定義している。</div>
<div class="line">上記例では、詳細出力時に指定するグループを定義している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">複数のグループで出力したい項目には、引数を配列にして複数のマーカーインターフェースを渡すことで、複数のグループに所属させることができる。</div>
<div class="line">上記例の場合、概要と詳細の両方のグループに所属させたい項目であるため、2つのマーカーインターフェースを引数にしている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">単一のグループで出力したい項目には、マーカーインターフェースを引数にすることで、</div>
<div class="line">該当のグループに所属させることができる。</div>
<div class="line">この場合は要素が1つため、配列にする必要はない。</div>
<div class="line">上記例の場合、詳細のみのグループに所属させたい項目であるため、1つのマーカーインターフェースを引数にしている。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">グループに所属しない項目には<code class="docutils literal"><span class="pre">&#64;JsonView</span></code>を設定しない。</div>
<div class="line">グループに所属しない項目を出力するかどうかは設定によって変えることができる。</div>
<div class="line">設定方法については後述する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">MemberRestController.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.examples.rest.api.member</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.dozer.Mapper</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PathVariable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestBody</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ResponseStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.examples.rest.domain.model.Member</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.examples.rest.domain.service.member.MemberService</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.annotation.JsonView</span><span class="p">;</span>

<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;members&quot;</span><span class="p">)</span>
<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRestController</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">MemberService</span> <span class="n">memberService</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">Mapper</span> <span class="n">beanMapper</span><span class="p">;</span>

    <span class="c1">// (1)</span>
    <span class="nd">@JsonView</span><span class="p">(</span><span class="n">Summary</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;{memberId}&quot;</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;format=summary&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">MemberResource</span> <span class="nf">getMemberSummary</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;memberId&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">memberId</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberService</span><span class="p">.</span><span class="na">getMember</span><span class="p">(</span><span class="n">memberId</span><span class="p">);</span>

        <span class="n">MemberResource</span> <span class="n">responseResource</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">member</span><span class="p">,</span>
                <span class="n">MemberResource</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">responseResource</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (2)</span>
    <span class="nd">@JsonView</span><span class="p">(</span><span class="n">Detail</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;{memberId}&quot;</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;format=detail&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">MemberResource</span> <span class="nf">getMemberDetail</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;memberId&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">memberId</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberService</span><span class="p">.</span><span class="na">getMember</span><span class="p">(</span><span class="n">memberId</span><span class="p">);</span>

        <span class="n">MemberResource</span> <span class="n">responseResource</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">member</span><span class="p">,</span>
                <span class="n">MemberResource</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">responseResource</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;JsonView</span></code>を付けて、出力したいグループのマーカーインターフェースを設定する。</div>
<div class="line">概要を出力するメソッドに<code class="docutils literal"><span class="pre">Summary</span></code>マーカーインターフェースを設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">詳細を出力するメソッドに<code class="docutils literal"><span class="pre">Detail</span></code>マーカーインターフェースを設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">出力されるボディは、Controllerで指定したグループに所属するプロパティーのみ出力される。</div>
<div class="line">出力例は以下の通りとなる。</div>
</div>
<ul class="simple">
<li>Summary</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s">&quot;memberId&quot;</span> <span class="p">:</span> <span class="s">&quot;M000000001&quot;</span><span class="p">,</span>
  <span class="s">&quot;firstName&quot;</span> <span class="p">:</span> <span class="s">&quot;John&quot;</span><span class="p">,</span>
  <span class="s">&quot;lastName&quot;</span> <span class="p">:</span> <span class="s">&quot;Smith&quot;</span><span class="p">,</span>
  <span class="s">&quot;createdAt&quot;</span> <span class="p">:</span> <span class="s">&quot;2014-03-14T11:02:41.477Z&quot;</span><span class="p">,</span>
  <span class="s">&quot;lastModifiedAt&quot;</span> <span class="p">:</span> <span class="s">&quot;2014-03-14T11:02:41.477Z&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Detail</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s">&quot;memberId&quot;</span> <span class="p">:</span> <span class="s">&quot;M000000001&quot;</span><span class="p">,</span>
  <span class="s">&quot;firstName&quot;</span> <span class="p">:</span> <span class="s">&quot;John&quot;</span><span class="p">,</span>
  <span class="s">&quot;lastName&quot;</span> <span class="p">:</span> <span class="s">&quot;Smith&quot;</span><span class="p">,</span>
  <span class="s">&quot;genderCode&quot;</span> <span class="p">:</span> <span class="s">&quot;1&quot;</span><span class="p">,</span>
  <span class="s">&quot;dateOfBirth&quot;</span> <span class="p">:</span> <span class="s">&quot;2013-03-14&quot;</span><span class="p">,</span>
  <span class="s">&quot;emailAddress&quot;</span> <span class="p">:</span> <span class="s">&quot;user1394794959984@test.com&quot;</span><span class="p">,</span>
  <span class="s">&quot;telephoneNumber&quot;</span> <span class="p">:</span> <span class="s">&quot;09012345678&quot;</span><span class="p">,</span>
  <span class="s">&quot;zipCode&quot;</span> <span class="p">:</span> <span class="s">&quot;1710051&quot;</span><span class="p">,</span>
  <span class="s">&quot;address&quot;</span> <span class="p">:</span> <span class="s">&quot;Tokyo&quot;</span><span class="p">,</span>
  <span class="s">&quot;createdAt&quot;</span> <span class="p">:</span> <span class="s">&quot;2014-03-14T11:02:41.477Z&quot;</span><span class="p">,</span>
  <span class="s">&quot;lastModifiedAt&quot;</span> <span class="p">:</span> <span class="s">&quot;2014-03-14T11:02:41.477Z&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;JsonView</span></code>を付けなかったプロパティーは、<code class="docutils literal"><span class="pre">MapperFeature.DEFAULT_VIEW_INCLUSION</span></code>の設定を有効にすれば出力され、無効にすれば出力されない。</div>
<div class="line">上記の出力例は、<code class="docutils literal"><span class="pre">MapperFeature.DEFAULT_VIEW_INCLUSION</span></code>を有効にした場合の出力例である。</div>
<div class="line"><code class="docutils literal"><span class="pre">MapperFeature.DEFAULT_VIEW_INCLUSION</span></code>を有効にする場合は、以下のように設定する。</div>
</div>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;objectMapper&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.http.converter.json.Jackson2ObjectMapperFactoryBean&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>

    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;featuresToEnable&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;array&gt;</span>
            <span class="nt">&lt;util:constant</span> <span class="na">static-field=</span><span class="s">&quot;com.fasterxml.jackson.databind.MapperFeature.DEFAULT_VIEW_INCLUSION&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/array&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">featuresToEnable</span></code>要素に<code class="docutils literal"><span class="pre">MapperFeature.DEFAULT_VIEW_INCLUSION</span></code>を定義することで設定が有効となる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">MapperFeature.DEFAULT_VIEW_INCLUSION</span></code>を無効にする場合は、以下のように設定する。</div>
</div>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;objectMapper&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.http.converter.json.Jackson2ObjectMapperFactoryBean&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>

    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;featuresToDisable&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;array&gt;</span>
            <span class="nt">&lt;util:constant</span> <span class="na">static-field=</span><span class="s">&quot;com.fasterxml.jackson.databind.MapperFeature.DEFAULT_VIEW_INCLUSION&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/array&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">featuresToDisable</span></code>要素に<code class="docutils literal"><span class="pre">MapperFeature.DEFAULT_VIEW_INCLUSION</span></code>を定義することで設定が無効となる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">MapperFeature.DEFAULT_VIEW_INCLUSION</span></code>が無効の場合、先ほどの出力例は、以下のように出力内容が変更される。</div>
</div>
<ul class="simple">
<li>Summary</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s">&quot;memberId&quot;</span> <span class="p">:</span> <span class="s">&quot;M000000001&quot;</span><span class="p">,</span>
  <span class="s">&quot;firstName&quot;</span> <span class="p">:</span> <span class="s">&quot;John&quot;</span><span class="p">,</span>
  <span class="s">&quot;lastName&quot;</span> <span class="p">:</span> <span class="s">&quot;Smith&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Detail</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s">&quot;memberId&quot;</span> <span class="p">:</span> <span class="s">&quot;M000000001&quot;</span><span class="p">,</span>
  <span class="s">&quot;firstName&quot;</span> <span class="p">:</span> <span class="s">&quot;John&quot;</span><span class="p">,</span>
  <span class="s">&quot;lastName&quot;</span> <span class="p">:</span> <span class="s">&quot;Smith&quot;</span><span class="p">,</span>
  <span class="s">&quot;genderCode&quot;</span> <span class="p">:</span> <span class="s">&quot;1&quot;</span><span class="p">,</span>
  <span class="s">&quot;dateOfBirth&quot;</span> <span class="p">:</span> <span class="s">&quot;2013-03-14&quot;</span><span class="p">,</span>
  <span class="s">&quot;emailAddress&quot;</span> <span class="p">:</span> <span class="s">&quot;user1394794959984@test.com&quot;</span><span class="p">,</span>
  <span class="s">&quot;telephoneNumber&quot;</span> <span class="p">:</span> <span class="s">&quot;09012345678&quot;</span><span class="p">,</span>
  <span class="s">&quot;zipCode&quot;</span> <span class="p">:</span> <span class="s">&quot;1710051&quot;</span><span class="p">,</span>
  <span class="s">&quot;address&quot;</span> <span class="p">:</span> <span class="s">&quot;Tokyo&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><code class="docutils literal"><span class="pre">MapperFeature.DEFAULT_VIEW_INCLUSION</span></code>を指定しない場合のデフォルト値は、<code class="docutils literal"><span class="pre">ObjectMapper</span></code>の設定方法によって異なるデフォルト値となるため注意が必要である。
<a class="reference internal" href="#resthowtouseapplicationsettingsofspringmvc"><span class="std std-ref">RESTful Web Serviceで必要となるSpring MVCのコンポーネントを有効化するための設定</span></a>でも記述しているが、<code class="docutils literal"><span class="pre">ObjectMapper</span></code>のBean定義方法を<code class="docutils literal"><span class="pre">ObjectMapper</span></code>を直接Bean定義するスタイルにすると、デフォルト値が有効になる。<code class="docutils literal"><span class="pre">Jackson2ObjectMapperFactoryBean</span></code>を利用すると、デフォルト値は無効になる。設定を明示するため、どちらのスタイルで設定する場合においても、<code class="docutils literal"><span class="pre">MapperFeature.DEFAULT_VIEW_INCLUSION</span></code>の指定を記述することを推奨する。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><code class="docutils literal"><span class="pre">&#64;JsonView</span></code>は以下の2つの機能を使用して作成されている。これらは、Controller内の<code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>が付けられた処理メソッドで、Objectとのマッピング前後に共通的な処理を実装したい場合に、使用することができる機能である。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">org.springframework.web.servlet.mvc.method.annotation.RequestBodyAdvice</span></code></li>
<li><code class="docutils literal"><span class="pre">org.springframework.web.servlet.mvc.method.annotation.ResponseBodyAdvice</span></code></li>
</ul>
<p><code class="docutils literal"><span class="pre">&#64;ControllerAdvice</span></code>をこれらのインタフェースの実装クラスにつけることで適用することができる。<code class="docutils literal"><span class="pre">&#64;ControllerAdvice</span></code>の詳細は、<a class="reference internal" href="../ImplementationAtEachLayer/ApplicationLayer.html#application-layer-controller-advice"><span class="std std-ref">&#64;ControllerAdviceの実装</span></a>を参照されたい。</p>
<p><code class="docutils literal"><span class="pre">RequestBodyAdvice</span></code>は下記のメソッドを実装することができる。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">org.springframework.web.servlet.mvc.method.annotation.RequestBodyAdvice</span></code></li>
</ul>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">メソッド名</th>
<th class="head">概要</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">supports</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">このAdviceが送信されたリクエストに対して適用されるかどうか決定する。<code class="docutils literal"><span class="pre">true</span></code>だと適用される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">handleEmptyBody</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエストボディの内容をControllerで使用するオブジェクトに反映する前かつ、ボディが空の場合に呼び出される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">beforeBodyRead</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエストボディの内容をControllerで使用するオブジェクトに反映する前に呼び出される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">afterBodyRead</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエストボディの内容をControllerで使用するオブジェクトに反映した後に呼び出される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>上記すべてのタイミングで処理を記述する必要がない場合は、上記のsupports以外のメソッドが何もしない状態で実装された<code class="docutils literal"><span class="pre">org.springframework.web.servlet.mvc.method.annotation.RequestBodyAdviceAdapter</span></code>を継承し、必要な部分だけオーバーライドすることで、簡単に実装することができる。</p>
<p><code class="docutils literal"><span class="pre">ResponseBodyAdvice</span></code>は下記のメソッドを実装することができる。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">org.springframework.web.servlet.mvc.method.annotation.ResponseBodyAdvice</span></code></li>
</ul>
<blockquote class="last">
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">メソッド名</th>
<th class="head">概要</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">supports</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">このAdviceが送信されたリクエストに対して適用されるかどうか決定する。<code class="docutils literal"><span class="pre">true</span></code>だと適用される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">beforeBodyWrite</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Contorollerでの処理終了後、レスポンスに返り値を反映する前に呼び出される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="appendix">
<span id="restappendix"></span><h2><a class="toc-backref" href="#id128">5.16.6. Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this headline">¶</a></h2>
<div class="section" id="jsr-310-date-and-time-api-joda-time">
<span id="restappendixusingjsr310-jodatime"></span><h3><a class="toc-backref" href="#id129">5.16.6.1. JSR-310 Date and Time API / Joda Timeを使う場合の設定</a><a class="headerlink" href="#jsr-310-date-and-time-api-joda-time" title="Permalink to this headline">¶</a></h3>
<p>リソースを表現するJavaBean(Resourceクラス)のプロパティとしてJSR-310 Date and Time APIやJoda Timeのクラスを使用する場合は、
<code class="docutils literal"><span class="pre">pom.xml</span></code>にJacksonから提供されている拡張モジュールを依存ライブラリに追加する。</p>
<p><strong>JSR-310 Date and Time APIのクラスを使用する場合</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.datatype<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>jackson-datatype-jsr310<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
<p><strong>Joda Timeのクラスを使用する場合</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.terasoluna.gfw<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>terasoluna-gfw-jodatime<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
<p>or</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.datatype<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>jackson-datatype-joda<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>上記以外にも、</p>
<ul class="simple">
<li>Java SE 7から追加された<code class="docutils literal"><span class="pre">java.nio.file.Path</span></code></li>
<li>Java SE 8から追加された<code class="docutils literal"><span class="pre">java.util.Optional</span></code></li>
<li>Hibernate ORMのLazy Load機能によってProxy化されたオブジェクト</li>
</ul>
<p class="last">などを扱うための拡張モジュール(<code class="docutils literal"><span class="pre">jackson-datatype-xxx</span></code>)が、別途Jacksonから提供されている。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="restful-web-serviceweb">
<span id="restappendixsettingsofdeployinsamewarfilerestandclientapplication"></span><h3><a class="toc-backref" href="#id130">5.16.6.2. RESTful Web Serviceとクライアントアプリケーションを同じWebアプリケーションとして動かす際の設定</a><a class="headerlink" href="#restful-web-serviceweb" title="Permalink to this headline">¶</a></h3>
<div class="section" id="restful-web-servicedispatcherservlet">
<span id="restappendixdividedispatcherservlet"></span><h4><a class="toc-backref" href="#id131">5.16.6.2.1. RESTful Web Service用の<code class="docutils literal"><span class="pre">DispatcherServlet</span></code>を設ける方法</a><a class="headerlink" href="#restful-web-servicedispatcherservlet" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">RESTful Web Serviceとクライアントアプリケーションを同じWebアプリケーションとして構築する場合、RESTful Web Service用のリクエストを受ける<code class="docutils literal"><span class="pre">DispatcherServlet</span></code>と、クライアントアプリケーション用のリクエストを受け取る<code class="docutils literal"><span class="pre">DispatcherServlet</span></code>を分割する事を推奨する。</div>
<div class="line"><code class="docutils literal"><span class="pre">DispatcherServlet</span></code>を分割する方法について、以下に説明する。</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">web.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="hll"><span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="nt">&lt;servlet&gt;</span>
    <span class="nt">&lt;servlet-name&gt;</span>appServlet<span class="nt">&lt;/servlet-name&gt;</span>
    <span class="nt">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="nt">&lt;/servlet-class&gt;</span>
    <span class="nt">&lt;init-param&gt;</span>
        <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
        <span class="nt">&lt;param-value&gt;</span>classpath*:META-INF/spring/spring-mvc.xml<span class="nt">&lt;/param-value&gt;</span>
    <span class="nt">&lt;/init-param&gt;</span>
    <span class="nt">&lt;load-on-startup&gt;</span>1<span class="nt">&lt;/load-on-startup&gt;</span>
<span class="nt">&lt;/servlet&gt;</span>
<span class="nt">&lt;servlet-mapping&gt;</span>
    <span class="nt">&lt;servlet-name&gt;</span>appServlet<span class="nt">&lt;/servlet-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>/<span class="nt">&lt;/url-pattern&gt;</span>
<span class="nt">&lt;/servlet-mapping&gt;</span>
<span class="hll">
</span><span class="hll"><span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll"><span class="nt">&lt;servlet&gt;</span>
</span><span class="hll">    <span class="nt">&lt;servlet-name&gt;</span>restAppServlet<span class="nt">&lt;/servlet-name&gt;</span>
</span>    <span class="nt">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="nt">&lt;/servlet-class&gt;</span>
    <span class="nt">&lt;init-param&gt;</span>
        <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
<span class="hll">        <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;param-value&gt;</span>classpath*:META-INF/spring/spring-mvc-rest.xml<span class="nt">&lt;/param-value&gt;</span>
</span>    <span class="nt">&lt;/init-param&gt;</span>
    <span class="nt">&lt;load-on-startup&gt;</span>2<span class="nt">&lt;/load-on-startup&gt;</span>
<span class="nt">&lt;/servlet&gt;</span>
<span class="hll"><span class="c">&lt;!-- (4) --&gt;</span>
</span><span class="hll"><span class="nt">&lt;servlet-mapping&gt;</span>
</span><span class="hll">    <span class="nt">&lt;servlet-name&gt;</span>restAppServlet<span class="nt">&lt;/servlet-name&gt;</span>
</span><span class="hll">    <span class="nt">&lt;url-pattern&gt;</span>/api/v1/*<span class="nt">&lt;/url-pattern&gt;</span>
</span><span class="hll"><span class="nt">&lt;/servlet-mapping&gt;</span>
</span>
<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントアプリケーション用のリクエストを受け取る<code class="docutils literal"><span class="pre">DispatcherServlet</span></code>とリクエストマッピング。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">RESTful Web Service用のリクエストを受けるServlet(<code class="docutils literal"><span class="pre">DispatcherServlet</span></code>)を追加する。</div>
<div class="line"><code class="docutils literal"><span class="pre">&lt;servlet-name&gt;</span></code>要素に、RESTful Web Service用サーブレットであることを示す名前を指定する。</div>
<div class="line">上記例では、サーブレット名として<code class="docutils literal"><span class="pre">&quot;restAppServlet&quot;</span></code>を指定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">RESTful Web Service用の<code class="docutils literal"><span class="pre">DispatcherServlet</span></code>を構築する際に使用するSpring MVCのbean定義ファイルを指定する。</div>
<div class="line">上記例では、Spring MVCのbean定義ファイルとして、クラスパス上にある<code class="file docutils literal"><span class="pre">META-INF/spring/spring-mvc-rest.xml</span></code>を指定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">RESTful Web Service用の<code class="docutils literal"><span class="pre">DispatcherServlet</span></code>へマッピングするサーブレットパスのパターンの指定を行う。</div>
<div class="line">上記例では、<code class="docutils literal"><span class="pre">&quot;/api/v1/&quot;</span></code>配下のサーブレットパスをRESTful Web Service用の<code class="docutils literal"><span class="pre">DispatcherServlet</span></code>にマッピングしている。</div>
<div class="line">具体的には、</div>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">&quot;/api/v1/&quot;</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">&quot;/api/v1/members&quot;</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">&quot;/api/v1/members/xxxxx&quot;</span></code></div>
</div>
<div class="line">といったサーブレットパスが、RESTful Web Service用の<code class="docutils literal"><span class="pre">DispatcherServlet</span></code>(<code class="docutils literal"><span class="pre">&quot;restAppServlet&quot;</span></code>)にマッピングされる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>&#64;RequestMappingアノテーションのvalue属性に指定する値について</strong></p>
<p><code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>アノテーションのvalue属性に指定する値は、<code class="docutils literal"><span class="pre">&lt;url-pattern&gt;</span></code>要素で指定したワイルドカード(<code class="docutils literal"><span class="pre">*</span></code>)の部分の値を指定する。</p>
<p>例えば、<code class="docutils literal"><span class="pre">&#64;RequestMapping(value</span> <span class="pre">=</span> <span class="pre">&quot;members&quot;)</span></code>と指定した場合、<code class="docutils literal"><span class="pre">&quot;/api/v1/members&quot;</span></code>といパスに対する処理を行うメソッドとしてデプロイされる。
そのため、<code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>アノテーションのvalue属性には、分割したサーブレットへマッピングするためパス(<code class="docutils literal"><span class="pre">&quot;api/v1&quot;</span></code>)を指定する必要はない。</p>
<p class="last"><code class="docutils literal"><span class="pre">&#64;RequestMapping(value</span> <span class="pre">=</span> <span class="pre">&quot;api/v1/members&quot;)</span></code>と指定すると、<code class="docutils literal"><span class="pre">&quot;/api/v1/api/v1/members&quot;</span></code>というパスに対する処理を行うメソッドとしてデプロイされてしまうので、注意すること。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="restappendixhypermedialink">
<span id="id51"></span><h3><a class="toc-backref" href="#id132">5.16.6.3. ハイパーメディアリンクの実装</a><a class="headerlink" href="#restappendixhypermedialink" title="Permalink to this headline">¶</a></h3>
<p>JSONの中に関連リソースへのハイパーメディアリンクを含める場合の実装について説明する。</p>
<div class="section" id="id52">
<h4><a class="toc-backref" href="#id133">5.16.6.3.1. 共通部品の実装</a><a class="headerlink" href="#id52" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>リンク情報を保持するJavaBeanを作成する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.examples.rest.api.common.resource</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="p">;</span>

<span class="hll"><span class="c1">// (1)</span>
</span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Link</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">rel</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">href</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">Link</span><span class="p">(</span><span class="n">String</span> <span class="n">rel</span><span class="p">,</span> <span class="n">String</span> <span class="n">href</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">rel</span> <span class="o">=</span> <span class="n">rel</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="na">href</span> <span class="o">=</span> <span class="n">href</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getRel</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">rel</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getHref</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">href</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リンク名とURLを保持するリンク情報用のJavaBeanを作成する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>リンク情報のコレクションを保持するResourceの抽象クラスを作成する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.examples.rest.api.common.resource</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.net.URI</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.LinkedHashSet</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.annotation.JsonInclude</span><span class="p">;</span>

<span class="hll"><span class="c1">// (2)</span>
</span><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractLinksSupportedResource</span> <span class="p">{</span>

<span class="hll">    <span class="c1">// (3)</span>
</span>    <span class="nd">@JsonInclude</span><span class="p">(</span><span class="n">JsonInclude</span><span class="p">.</span><span class="na">Include</span><span class="p">.</span><span class="na">NON_EMPTY</span><span class="p">)</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Link</span><span class="o">&gt;</span> <span class="n">links</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashSet</span><span class="o">&lt;&gt;</span><span class="p">();</span>

    <span class="kd">public</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Link</span><span class="o">&gt;</span> <span class="nf">getLinks</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">links</span><span class="p">;</span>
    <span class="p">}</span>

<span class="hll">    <span class="c1">// (4)</span>
</span>    <span class="kd">public</span> <span class="n">AbstractLinksSupportedResource</span> <span class="nf">addLink</span><span class="p">(</span><span class="n">String</span> <span class="n">rel</span><span class="p">,</span> <span class="n">URI</span> <span class="n">href</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">links</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="n">Link</span><span class="p">(</span><span class="n">rel</span><span class="p">,</span> <span class="n">href</span><span class="p">.</span><span class="na">toString</span><span class="p">()));</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>

<span class="hll">    <span class="c1">// (5)</span>
</span>    <span class="kd">public</span> <span class="n">AbstractLinksSupportedResource</span> <span class="nf">addSelf</span><span class="p">(</span><span class="n">URI</span> <span class="n">href</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">addLink</span><span class="p">(</span><span class="s">&quot;self&quot;</span><span class="p">,</span> <span class="n">href</span><span class="p">);</span>
    <span class="p">}</span>

<span class="hll">    <span class="c1">// (5)</span>
</span>    <span class="kd">public</span> <span class="n">AbstractLinksSupportedResource</span> <span class="nf">addParent</span><span class="p">(</span><span class="n">URI</span> <span class="n">href</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">addLink</span><span class="p">(</span><span class="s">&quot;parent&quot;</span><span class="p">,</span> <span class="n">href</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リンク情報のコレクションを保持するResourceの抽象クラス(JavaBean)を作成する。</div>
<div class="line">本クラスは、パイパーメディアリンクをサポートするResourceクラスによって、継承される事を想定したクラスである。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リンク情報を複数保持するフィールドを定義する。</div>
<div class="line">上記例では、リンクの指定がない時にJSONに出力しないようにするために、<code class="docutils literal"><span class="pre">&#64;JsonInclude(JsonInclude.Include.NON_EMPTY)</span></code>を指定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リンク情報を追加するためのメソッドを用意する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">必要に応じて共通的なリンク情報を追加するためのメソッドを用意する。</div>
<div class="line">上記例では、自身のリソースにアクセスするためのリンク情報(<code class="docutils literal"><span class="pre">&quot;self&quot;</span></code>)と、親のリソースにアクセスするためのリンク情報(<code class="docutils literal"><span class="pre">&quot;parent&quot;</span></code>)を追加するためのメソッドを用意している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id53">
<h4><a class="toc-backref" href="#id134">5.16.6.3.2. リソース毎の実装</a><a class="headerlink" href="#id53" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Resourceクラスにて、リンク情報のコレクションを保持するResourceの抽象クラスを継承する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.examples.rest.api.member</span><span class="p">;</span>

<span class="hll"><span class="c1">// (1)</span>
</span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberResource</span> <span class="kd">extends</span>
    <span class="n">AbstractLinksSupportedResource</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リンク情報のコレクションを保持するResourceの抽象クラスを継承する。</div>
<div class="line">継承することで、リンク情報のコレクションを保持するフィールド(<code class="docutils literal"><span class="pre">links</span></code>)が取り込まれ、ハイパーメディアリンクをサポートするResourceクラスとなる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>REST APIの処理で、ハイパーメディアリンクを追加する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;members&quot;</span><span class="p">)</span>
<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRestController</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;{memberId}&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">MemberResource</span> <span class="nf">getMember</span><span class="p">(</span>
            <span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;memberId&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">memberId</span>
<span class="hll">            <span class="c1">// (2)</span>
</span>            <span class="n">UriComponentsBuilder</span> <span class="n">uriBuilder</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberService</span><span class="p">.</span><span class="na">getMember</span><span class="p">(</span><span class="n">memberId</span><span class="p">);</span>

        <span class="n">MemberResource</span> <span class="n">responseResource</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">member</span><span class="p">,</span>
                <span class="n">MemberResource</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

<span class="hll">        <span class="c1">// (3)</span>
</span>        <span class="n">responseResource</span><span class="p">.</span><span class="na">addSelf</span><span class="p">(</span><span class="n">uriBuilder</span><span class="p">.</span><span class="na">path</span><span class="p">(</span><span class="s">&quot;/members&quot;</span><span class="p">).</span><span class="na">pathSegment</span><span class="p">(</span><span class="n">memberId</span><span class="p">)</span>
                <span class="p">.</span><span class="na">build</span><span class="p">().</span><span class="na">toUri</span><span class="p">());</span>

        <span class="k">return</span> <span class="n">responseResource</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リンク情報に設定するURIを組み立てるため、Spring MVCから提供されている<code class="docutils literal"><span class="pre">org.springframework.web.util.UriComponentsBuilder</span></code>クラスをメソッドの引数に指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">UriComponentsBuilder</span></code>クラスをControllerのメソッドの引数に指定すると、メソッド実行時に、Spring MVCにより<code class="docutils literal"><span class="pre">UriComponentsBuilder</span></code>クラスを継承した</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.web.servlet.support.ServletUriComponentsBuilder</span></code>クラスのインスタンスが渡される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースにリンク情報を追加する。</div>
<div class="line">上記例では、リンク情報に設定するURIを組み立てるため <code class="docutils literal"><span class="pre">UriComponentsBuilder</span></code>クラスのメソッドを呼び出し、自身のリソースにアクセスするためのURIをリソースに追加している。</div>
<div class="line"><br /></div>
<div class="line">Controllerのメソッドの引数として渡された<code class="docutils literal"><span class="pre">ServletUriComponentsBuilder</span></code>のインスタンスは、web.xmlに記載の<code class="docutils literal"><span class="pre">&lt;servlet-mapping&gt;</span></code>要素の情報を元に初期化されており、リソースには依存しない。</div>
<div class="line">そのため、Spring Frameworkから提供される <a class="reference external" href="http://docs.spring.io/spring/docs/4.2.4.RELEASE/spring-framework-reference/html/mvc.html#mvc-ann-requestmapping-uri-templates">URI Template Patterns</a>等を利用し、</div>
<div class="line">リクエスト情報をベースにURIを組み立てる事により、リソースに依存しない汎用的な組み立て処理を実装することが可能となる。</div>
<div class="line"><br /></div>
<div class="line">例えば、上記例において<code class="docutils literal"><span class="pre">http://example.com/api/v1/members/M000000001</span></code>に対してGETした場合、組み立てられるURIは、リクエストされたURIと同じ値<code class="docutils literal"><span class="pre">（http://example.com/api/v1/members/M000000001）</span></code>になる。</div>
<div class="line"><br /></div>
<div class="line">必要に応じてリンク情報に設定するURIを組み立てるためのメソッドを実装すること。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last"><code class="docutils literal"><span class="pre">ServletUriComponentsBuilder</span></code>では、URIを組み立てる際に「<code class="docutils literal"><span class="pre">X-Forwarded-Host</span></code>」ヘッダを参照することで、クライアントとアプリケーションサーバの間にロードバランサやWebサーバがある構成を考慮している。
ただし、パスの構成を合わせておかないと期待通りのURIにならないので注意が必要である。</p>
</div>
</div></blockquote>
<ul>
<li><div class="first line-block">
<div class="line">レスポンス例</div>
<div class="line">実際に動かすと、以下のようなレスポンスとなる。</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/rest-api-web/api/v1/members/M000000001</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">text/plain, application/json, application/*+json, */*</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Java/1.7.0_51</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:8080</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">keep-alive</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="hll">  <span class="s">&quot;links&quot;</span> <span class="p">:</span> <span class="o">[</span> <span class="p">{</span>
</span><span class="hll">    <span class="s">&quot;rel&quot;</span> <span class="p">:</span> <span class="s">&quot;self&quot;</span><span class="p">,</span>
</span><span class="hll">    <span class="s">&quot;href&quot;</span> <span class="p">:</span> <span class="s">&quot;http://localhost:8080/rest-api-web/api/v1/members/M000000001&quot;</span>
</span><span class="hll">  <span class="p">}</span> <span class="o">]</span><span class="p">,</span>
</span>  <span class="s">&quot;memberId&quot;</span> <span class="p">:</span> <span class="s">&quot;M000000001&quot;</span><span class="p">,</span>
  <span class="s">&quot;firstName&quot;</span> <span class="p">:</span> <span class="s">&quot;John&quot;</span><span class="p">,</span>
  <span class="s">&quot;lastName&quot;</span> <span class="p">:</span> <span class="s">&quot;Smith&quot;</span><span class="p">,</span>
  <span class="s">&quot;genderCode&quot;</span> <span class="p">:</span> <span class="s">&quot;1&quot;</span><span class="p">,</span>
  <span class="s">&quot;dateOfBirth&quot;</span> <span class="p">:</span> <span class="s">&quot;2013-03-14&quot;</span><span class="p">,</span>
  <span class="s">&quot;emailAddress&quot;</span> <span class="p">:</span> <span class="s">&quot;user1394794959984@test.com&quot;</span><span class="p">,</span>
  <span class="s">&quot;telephoneNumber&quot;</span> <span class="p">:</span> <span class="s">&quot;09012345678&quot;</span><span class="p">,</span>
  <span class="s">&quot;zipCode&quot;</span> <span class="p">:</span> <span class="s">&quot;1710051&quot;</span><span class="p">,</span>
  <span class="s">&quot;address&quot;</span> <span class="p">:</span> <span class="s">&quot;Tokyo&quot;</span><span class="p">,</span>
  <span class="s">&quot;credential&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s">&quot;signId&quot;</span> <span class="p">:</span> <span class="s">&quot;user1394794959984@test.com&quot;</span><span class="p">,</span>
    <span class="s">&quot;passwordLastChangedAt&quot;</span> <span class="p">:</span> <span class="s">&quot;2014-03-14T11:02:41.477Z&quot;</span><span class="p">,</span>
    <span class="s">&quot;lastModifiedAt&quot;</span> <span class="p">:</span> <span class="s">&quot;2014-03-14T11:02:41.477Z&quot;</span>
  <span class="p">},</span>
  <span class="s">&quot;createdAt&quot;</span> <span class="p">:</span> <span class="s">&quot;2014-03-14T11:02:41.477Z&quot;</span><span class="p">,</span>
  <span class="s">&quot;lastModifiedAt&quot;</span> <span class="p">:</span> <span class="s">&quot;2014-03-14T11:02:41.477Z&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="httprestful-web-service">
<span id="restappendixrestapiofhttpcompliance"></span><h3><a class="toc-backref" href="#id135">5.16.6.4. HTTPの仕様に準拠したRESTful Web Serviceの作成</a><a class="headerlink" href="#httprestful-web-service" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">本編で説明したREST APIの実装では、HTTPの仕様に準拠していない箇所がある。</div>
<div class="line">本節では、HTTPの仕様に準拠したRESTful Web Serviceにするための実装例について説明する。</div>
</div>
<div class="section" id="postlocation">
<h4><a class="toc-backref" href="#id136">5.16.6.4.1. POST時のLocationヘッダの設定</a><a class="headerlink" href="#postlocation" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">HTTPの仕様に準拠する場合、POST時のレスポンスヘッダー(「Locationヘッダ」)には、作成したリソースのURIを設定する必要がある。</div>
<div class="line">POST時のレスポンスヘッダ(「Locationヘッダ」)に、作成したリソースのURIを設定するための実装方法について説明する。</div>
</div>
</div>
<div class="section" id="id54">
<h4><a class="toc-backref" href="#id137">5.16.6.4.2. リソース毎の実装</a><a class="headerlink" href="#id54" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>REST APIの処理で、作成したリソースのURIをLocationヘッダに設定する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;members&quot;</span><span class="p">)</span>
<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRestController</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">MemberResource</span><span class="o">&gt;</span> <span class="nf">postMembers</span><span class="p">(</span>
            <span class="nd">@RequestBody</span> <span class="nd">@Validated</span><span class="p">({</span> <span class="n">PostMembers</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">Default</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span>
            <span class="n">MemberResource</span> <span class="n">requestedResource</span><span class="p">,</span>
<span class="hll">            <span class="c1">// (1)</span>
</span>            <span class="n">UriComponentsBuilder</span> <span class="n">uriBuilder</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">Member</span> <span class="n">creatingMember</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">requestedResource</span><span class="p">,</span> <span class="n">Member</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

        <span class="n">Member</span> <span class="n">createdMember</span> <span class="o">=</span> <span class="n">memberService</span><span class="p">.</span><span class="na">createMember</span><span class="p">(</span><span class="n">creatingMember</span><span class="p">);</span>

        <span class="n">MemberResource</span> <span class="n">responseResource</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">createdMember</span><span class="p">,</span>
                <span class="n">MemberResource</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

<span class="hll">        <span class="c1">// (2)</span>
</span>        <span class="n">URI</span> <span class="n">createdUri</span> <span class="o">=</span> <span class="n">uriBuilder</span><span class="p">.</span><span class="na">path</span><span class="p">(</span><span class="s">&quot;/members/{memberId}&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="na">buildAndExpand</span><span class="p">(</span><span class="n">responseResource</span><span class="p">.</span><span class="na">getMemberId</span><span class="p">()).</span><span class="na">toUri</span><span class="p">();</span>

<span class="hll">        <span class="c1">// (3)</span>
</span>        <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">created</span><span class="p">(</span><span class="n">createdUri</span><span class="p">).</span><span class="na">body</span><span class="p">(</span><span class="n">responseResource</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">作成したリソースのURIを組み立てるため、Spring MVCから提供されている<code class="docutils literal"><span class="pre">org.springframework.web.util.UriComponentsBuilder</span></code>クラスをメソッドの引数に指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">UriComponentsBuilder</span></code>クラスをControllerのメソッドの引数に指定すると、メソッド実行時に、Spring MVCにより<code class="docutils literal"><span class="pre">UriComponentsBuilder</span></code>クラスを継承した</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.web.servlet.support.ServletUriComponentsBuilder</span></code>クラスのインスタンスが渡される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">作成したリソースのURIを組み立てる。</div>
<div class="line">上記例では、引数として渡された<code class="docutils literal"><span class="pre">ServletUriComponentsBuilder</span></code>のインスタンスに<code class="docutils literal"><span class="pre">path</span></code>メソッドで、URI Template Patternsを用いたパスを追加し、</div>
<div class="line"><code class="docutils literal"><span class="pre">buildAndExpand</span></code>メソッドを呼び出して、作成したリソースのIDをバインドすることで、作成したリソースのURIを組み立てている。</div>
<div class="line"><br /></div>
<div class="line">Controllerのメソッドの引数として渡された<code class="docutils literal"><span class="pre">ServletUriComponentsBuilder</span></code>のインスタンスは、web.xmlに記載の<code class="docutils literal"><span class="pre">&lt;servlet-mapping&gt;</span></code>要素の情報を元に初期化されており、リソースには依存しない。</div>
<div class="line">そのため、Spring Frameworkから提供される <a class="reference external" href="http://docs.spring.io/spring/docs/4.2.4.RELEASE/spring-framework-reference/html/mvc.html#mvc-ann-requestmapping-uri-templates">URITemplatePatterns</a>等を利用し、</div>
<div class="line">リクエスト情報をベースにURIを組み立てる事により、リソースに依存しない汎用的な組み立て処理を実装することが可能となる。</div>
<div class="line"><br /></div>
<div class="line">例えば、上記例において<code class="docutils literal"><span class="pre">http://example.com/api/v1/members</span></code>に対してPOSTした場合、組み立てられるURIは、「リクエストされたURI + <code class="docutils literal"><span class="pre">&quot;/&quot;</span></code>+ 作成したリソースのID」となる。</div>
<div class="line">具体的には、IDに<code class="docutils literal"><span class="pre">&quot;M000000001&quot;</span></code>を指定した場合、<code class="docutils literal"><span class="pre">http://example.com/api/v1/members/M000000001</span></code>となる。</div>
<div class="line"><br /></div>
<div class="line">必要に応じてリンク情報に設定するURIを組み立てるためのメソッドを実装すること。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">以下のパラメータを使用して<code class="docutils literal"><span class="pre">org.springframework.http.ResponseEntity</span></code>を生成し返却する。</div>
</div>
<ul class="last simple">
<li>ステータスコード : 201(Created)</li>
<li>Locationヘッダ : 作成したリソースのURI</li>
<li>レスポンスBODY : 作成したResourceオブジェクト</li>
</ul>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last"><code class="docutils literal"><span class="pre">ServletUriComponentsBuilder</span></code>では、URIを組み立てる際に「<code class="docutils literal"><span class="pre">X-Forwarded-Host</span></code>」ヘッダを参照することで、クライアントとアプリケーションサーバの間にロードバランサやWebサーバがある構成を考慮している。
ただし、パスの構成を合わせておかないと期待通りのURIにならないので注意が必要である。</p>
</div>
</div></blockquote>
<ul>
<li><div class="first line-block">
<div class="line">レスポンス例</div>
<div class="line">実際に動かすと、以下のようなレスポンスヘッダとなる。</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="err">HTTP/1.1 201 Created</span>
<span class="c">Server: Apache-Coyote/1.1</span>
<span class="c">X-Track: 693e132312d64998a7d8d6cabf3d13ef</span>
<span class="hll"><span class="c">Location: http://localhost:8080/rest-api-web/api/v1/members/M000000001</span>
</span><span class="nt">Content-Type:</span><span class="w"> </span><span class="nl">application</span><span class="dl">/</span><span class="nl">json</span>;<span class="na">charset</span><span class="o">=</span><span class="s">UTF-8</span><span class="w"></span>
<span class="c">Transfer-Encoding: chunked</span>
<span class="c">Date: Fri, 14 Mar 2014 12:34:31 GMT</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="optionscontroller">
<span id="restappendixdispatchoptionsmethod"></span><h4><a class="toc-backref" href="#id138">5.16.6.4.3. OPTIONSメソッドのリクエストをControllerにディスパッチするための設定</a><a class="headerlink" href="#optionscontroller" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">HTTPの仕様に準拠する場合は、、リソース毎に呼び出しが許可されているHTTPメソッドの一覧を返却する必要がある。そのため、OPTIONSメソッドのリクエストをControllerへディスパッチするための設定を追加する必要となる。</div>
<div class="line"><code class="docutils literal"><span class="pre">DispatcherServlet</span></code>のデフォルトの設定では、OPTIONSメソッドのリクエストはControllerにディスパッチされずに、<code class="docutils literal"><span class="pre">DispatcherServlet</span></code>が許可しているメソッドのリストがAllowヘッダに設定されてしまう。</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">web.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;servlet&gt;</span>
    <span class="nt">&lt;servlet-name&gt;</span>appServlet<span class="nt">&lt;/servlet-name&gt;</span>
    <span class="nt">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="nt">&lt;/servlet-class&gt;</span>
    <span class="nt">&lt;init-param&gt;</span>
        <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
        <span class="nt">&lt;param-value&gt;</span>classpath*:META-INF/spring/spring-mvc-rest.xml<span class="nt">&lt;/param-value&gt;</span>
    <span class="nt">&lt;/init-param&gt;</span>
<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;init-param&gt;</span>
</span><span class="hll">        <span class="nt">&lt;param-name&gt;</span>dispatchOptionsRequest<span class="nt">&lt;/param-name&gt;</span>
</span><span class="hll">        <span class="nt">&lt;param-value&gt;</span>true<span class="nt">&lt;/param-value&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/init-param&gt;</span>
</span>    <span class="nt">&lt;load-on-startup&gt;</span>1<span class="nt">&lt;/load-on-startup&gt;</span>
<span class="nt">&lt;/servlet&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">RESTful Web Serviceのリクエストを受け付ける<code class="docutils literal"><span class="pre">DispatcherServlet</span></code>の初期化パラメータ(dispatchOptionsRequest)の値を、<code class="docutils literal"><span class="pre">true</span></code>に設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="options">
<span id="restappendixrestapiofhttpcomplianceimplementationofoptionsspecifiedresource"></span><h4><a class="toc-backref" href="#id139">5.16.6.4.4. OPTIONSメソッドの実装</a><a class="headerlink" href="#options" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">HTTPの仕様に準拠する場合、リソース毎に呼び出しが許可されているHTTPメソッドの一覧を返却する必要がある。</div>
<div class="line">URIで指定されたリソースでサポートされているHTTPメソッド(REST API)のリストを応答するAPIの実装例を、以下に示す。</div>
</div>
<ul>
<li><div class="first line-block">
<div class="line">REST APIの実装</div>
<div class="line">URIで指定されたリソースでサポートされているHTTPメソッド(REST API)のリストを応答する処理を実装する。</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;members&quot;</span><span class="p">)</span>
<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MembersRestController</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;{memberId}&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">OPTIONS</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">optionsMember</span><span class="p">(</span>
        <span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;memberId&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">memberId</span><span class="p">)</span> <span class="p">{</span>

<span class="hll">        <span class="c1">// (1)</span>
</span>        <span class="n">memberService</span><span class="p">.</span><span class="na">getMember</span><span class="p">(</span><span class="n">memberId</span><span class="p">);</span>

<span class="hll">        <span class="c1">// (2)</span>
</span>        <span class="k">return</span> <span class="n">ResponseEntity</span>
                <span class="p">.</span><span class="na">ok</span><span class="p">()</span>
                <span class="p">.</span><span class="na">allow</span><span class="p">(</span><span class="n">HttpMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">,</span> <span class="n">HttpMethod</span><span class="p">.</span><span class="na">HEAD</span><span class="p">,</span> <span class="n">HttpMethod</span><span class="p">.</span><span class="na">PUT</span><span class="p">,</span>
                        <span class="n">HttpMethod</span><span class="p">.</span><span class="na">DELETE</span><span class="p">,</span> <span class="n">HttpMethod</span><span class="p">.</span><span class="na">OPTIONS</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ドメイン層のServiceのメソッドを呼び出し、パス変数から取得したIDに一致するリソースが存在するかチェックを行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><strong>URIで指定されたリソースでサポートされているHTTPメソッドを、Allowヘッダに設定する。</strong></div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>リクエスト例</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="hll"><span class="nf">OPTIONS</span> <span class="nn">/rest-api-web/api/v1/members/M000000004</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span><span class="na">Accept</span><span class="o">:</span> <span class="l">text/plain, application/json, application/*+json, */*</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Java/1.7.0_51</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:8080</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">keep-alive</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>レスポンス例</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="err">HTTP/1.1 200 OK</span>
<span class="c">Server: Apache-Coyote/1.1</span>
<span class="c">X-Track: 6d7bbc818c7f44e7942c54bc0ddc15bb</span>
<span class="hll"><span class="c">Allow: GET,HEAD,PUT,DELETE,OPTIONS</span>
</span><span class="c">Content-Length: 0</span>
<span class="c">Date: Mon, 17 Mar 2014 01:54:27 GMT</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="head">
<h4><a class="toc-backref" href="#id140">5.16.6.4.5. HEADメソッドの実装</a><a class="headerlink" href="#head" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">HTTPの仕様に準拠する場合、GETメソッドを実装する場合、HEADメソッドも実装する必要がある。</div>
<div class="line">URIで指定されたリソースのメタ情報を応答するAPIの実装例を、以下に示す。</div>
</div>
<ul>
<li><div class="first line-block">
<div class="line">REST APIの実装</div>
<div class="line">URIで指定されたリソースのメタ情報を取得する処理を実装する。</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;members&quot;</span><span class="p">)</span>
<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRestController</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;{memberId}&quot;</span><span class="p">,</span>
                    <span class="n">method</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">,</span>
<span class="hll">                               <span class="n">RequestMethod</span><span class="p">.</span><span class="na">HEAD</span> <span class="p">})</span> <span class="c1">// (1)</span>
</span>    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">MemberResource</span> <span class="nf">getMember</span><span class="p">(</span>
            <span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;memberId&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">memberId</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// omitted</span>
    <span class="p">}</span>

    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">GETメソッドの処理を行うREST APIの<code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>アノテーションのmethod属性に<code class="docutils literal"><span class="pre">RequestMethod.HEAD</span></code>を追加する。</div>
<div class="line">HEADメソッドは、GETメソッドと同じ処理を行いヘッダ情報のみレスポンスする必要があるため、<code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code>アノテーションのmethod属性に、<code class="docutils literal"><span class="pre">RequestMethod.HEAD</span></code>も指定する。</div>
<div class="line">レスポンスBODYを空にする処理は、Servlet APIの標準機能で行われるため、Controllerの処理としてはGETメソッドと同じ処理を行えばよい。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div></blockquote>
<ul class="simple">
<li>リクエスト例</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="hll"><span class="nf">HEAD</span> <span class="nn">/rest-api-web/api/v1/members/M000000001</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span><span class="na">Accept</span><span class="o">:</span> <span class="l">text/plain, application/json, application/*+json, */*</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Java/1.7.0_51</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:8080</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">keep-alive</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div></blockquote>
<ul class="simple">
<li>レスポンス例</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="hll"><span class="err">HTTP/1.1 200 OK</span>
</span><span class="c">Server: Apache-Coyote/1.1</span>
<span class="c">X-Track: 71093a551e624c149867b6bfec486d2c</span>
<span class="hll"><span class="nt">Content-Type:</span><span class="w"> </span><span class="nl">application</span><span class="dl">/</span><span class="nl">json</span>;<span class="na">charset</span><span class="o">=</span><span class="s">UTF-8</span><span class="w"></span>
</span><span class="hll"><span class="c">Content-Length: 452</span>
</span><span class="c">Date: Thu, 13 Mar 2014 13:25:23 GMT</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="restappendixdisabledcsrfprotection">
<span id="id55"></span><h3><a class="toc-backref" href="#id141">5.16.6.5. CSRF対策の無効化</a><a class="headerlink" href="#restappendixdisabledcsrfprotection" title="Permalink to this headline">¶</a></h3>
<p>RESTful Web Service向けのリクエストに対して、CSRF対策を行わないようにするための設定方法について説明する。</p>
<blockquote>
<div><div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>CSRF対策を行わない場合は、セッションを利用する必要がなくなる。</p>
<p class="last">下記設定例では、Spring Securityの処理でセッションが使用されなくなる様にしている。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Blankプロジェクトのデフォルトの設定では、CSRF対策が有効化されているため、以下の設定を追加し、
RESTful Web Service向けのリクエストに対して、CSRF対策の処理が行われないようにする。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">spring-security.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="hll"><span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll"><span class="nt">&lt;sec:http</span>
</span><span class="hll">    <span class="na">pattern=</span><span class="s">&quot;/api/v1/**&quot;</span>
</span><span class="hll">    <span class="na">create-session=</span><span class="s">&quot;stateless&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">    <span class="nt">&lt;sec:http-basic/&gt;</span>
</span><span class="hll">    <span class="nt">&lt;sec:csrf</span> <span class="na">disabled=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
</span><span class="hll"><span class="nt">&lt;/sec:http&gt;</span>
</span><span class="hll">
</span><span class="nt">&lt;sec:http&gt;</span>
    <span class="nt">&lt;sec:access-denied-handler</span> <span class="na">ref=</span><span class="s">&quot;accessDeniedHandler&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:custom-filter</span> <span class="na">ref=</span><span class="s">&quot;userIdMDCPutFilter&quot;</span> <span class="na">after=</span><span class="s">&quot;ANONYMOUS_FILTER&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:form-login/&gt;</span>
    <span class="nt">&lt;sec:logout/&gt;</span>
    <span class="nt">&lt;sec:session-management</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">REST API用のSpring Securityの定義を追加する。</div>
<div class="line"><code class="docutils literal"><span class="pre">&lt;sec:http&gt;</span></code>要素の<code class="docutils literal"><span class="pre">pattern</span></code>属性に、REST API用のリクエストパスのURLパターンを指定している。</div>
<div class="line">上記例では、<code class="docutils literal"><span class="pre">/api/v1/</span></code>で始まるリクエストパスをREST API用のリクエストパスとして扱う。</div>
<div class="line">また、<code class="docutils literal"><span class="pre">create-session</span></code>属性を<code class="docutils literal"><span class="pre">stateless</span></code>とする事で、Spring Securityの処理でセッションが使用されなくなる。</div>
<div class="line"><br /></div>
<div class="line">CSRF対策を無効化するために、<code class="docutils literal"><span class="pre">&lt;sec:csrf&gt;</span></code>要素に <code class="docutils literal"><span class="pre">disabled=&quot;true&quot;</span></code>を指定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="xxe-injection">
<span id="restappendixenabledxxeinjectprotection"></span><h3><a class="toc-backref" href="#id142">5.16.6.6. XXE Injection対策の有効化</a><a class="headerlink" href="#xxe-injection" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">RESTful Web ServiceでXML形式のデータを扱う場合は、<a class="reference external" href="https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Processing">XXE(XML External Entity) Injection</a>対策を行う必要がある。</div>
<div class="line">terasoluna-gfw-web 1.0.1.RELEASE以上では、XXE Injection 対策が行われているSpring MVC(3.2.10.RELEASE以上)に依存しているため、個別に対策を行う必要はない。</div>
</div>
<blockquote>
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>XXE(XML External Entity) Injection 対策について</strong></p>
<p class="last">terasoluna-gfw-web 1.0.0.RELEASEを使用している場合は、XXE Injection対策が行われていないSpring MVC(3.2.4.RELEASE)に依存しているため、Spring-oxmから提供されているクラスを使用すること。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Spring-oxmを依存アーティファクトとして追加する。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">pom.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-oxm<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>${org.springframework-version}<span class="nt">&lt;/version&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring-oxm を依存アーティファクトとして追加する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Springのバージョンは、terasoluna-gfw-parent の <code class="file docutils literal"><span class="pre">pom.xml</span></code> に定義されているSpringのバージョン番号を管理するためのプレースフォルダ(${org.springframework-version})から取得すること。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Spring-oxmから提供されているクラスを使用してXMLとオブジェクトの相互変換を行うためのbean定義を行う。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">spring-mvc-rest.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;xmlMarshaller&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.oxm.jaxb.Jaxb2Marshaller&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;packagesToScan&quot;</span> <span class="na">value=</span><span class="s">&quot;com.examples.app&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;mvc:annotation-driven&gt;</span>

    <span class="nt">&lt;mvc:message-converters&gt;</span>
        <span class="c">&lt;!-- (3) --&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.http.converter.xml.MarshallingHttpMessageConverter&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;marshaller&quot;</span> <span class="na">ref=</span><span class="s">&quot;xmlMarshaller&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;unmarshaller&quot;</span> <span class="na">ref=</span><span class="s">&quot;xmlMarshaller&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (5) --&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;/mvc:message-converters&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;/mvc:annotation-driven&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring-oxmから提供されている<code class="docutils literal"><span class="pre">Jaxb2Marshaller</span></code>のbean定義を行う。</div>
<div class="line"><code class="docutils literal"><span class="pre">Jaxb2Marshaller</span></code>はデフォルトの状態で XXE Injection対策が行われている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">packagesToScan</span></code> プロパティに JAXB用のJavaBean( <code class="docutils literal"><span class="pre">javax.xml.bind.annotation.XmlRootElement</span></code> アノテーションなどが付与されているJavaBean)が格納されているパッケージ名を指定する。</div>
<div class="line">指定したパッケージ配下に格納されているJAXB用のJavaBeanがスキャンされ、marshal、unmarshal対象のJavaBeanとして登録される。</div>
<div class="line"><code class="docutils literal"><span class="pre">&lt;context:component-scan&gt;</span></code> の base-package属性と同じ仕組みでスキャンされる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;mvc:annotation-driven&gt;</span></code> の子要素である <code class="docutils literal"><span class="pre">&lt;mvc:message-converters&gt;</span></code> 要素に、 <code class="docutils literal"><span class="pre">MarshallingHttpMessageConverter</span></code> のbean定義を追加する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">marshaller</span></code> プロパティに (1)で定義した <code class="docutils literal"><span class="pre">Jaxb2Marshaller</span></code> のbeanを指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">unmarshaller</span></code> プロパティに (1)で定義した <code class="docutils literal"><span class="pre">Jaxb2Marshaller</span></code> のbeanを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dozerjoda-time">
<span id="restappendixcopyjodaobjectbybeanconvert"></span><h3><a class="toc-backref" href="#id143">5.16.6.7. Dozerを使ってJoda-Timeのクラスをコピーする方法</a><a class="headerlink" href="#dozerjoda-time" title="Permalink to this headline">¶</a></h3>
<p>Dozerを使用して、Joda-Timeのクラス(<code class="docutils literal"><span class="pre">org.joda.time.DateTime</span></code>、<code class="docutils literal"><span class="pre">org.joda.time.LocalDate</span></code>など)をコピーする方法について説明する。</p>
<div class="line-block">
<div class="line">Joda-Timeのクラスを変換するためのカスタムコンバータを作成する。</div>
<div class="line">カスタムコンバータの詳細については、「<a class="reference internal" href="Utilities/Dozer.html"><span class="doc">Beanマッピング(Dozer)</span></a>」を参照されたい。</div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">JodaDateTimeConverter.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.examples.rest.infra.dozer.converter</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.dozer.DozerConverter</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.joda.time.DateTime</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JodaDateTimeConverter</span> <span class="kd">extends</span> <span class="n">DozerConverter</span><span class="o">&lt;</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">DateTime</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="nf">JodaDateTimeConverter</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">super</span><span class="p">(</span><span class="n">DateTime</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">DateTime</span> <span class="nf">convertTo</span><span class="p">(</span><span class="n">DateTime</span> <span class="n">source</span><span class="p">,</span> <span class="n">DateTime</span> <span class="n">destination</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// This method not called, because type of from/to is same.</span>
        <span class="k">return</span> <span class="n">convertFrom</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">DateTime</span> <span class="nf">convertFrom</span><span class="p">(</span><span class="n">DateTime</span> <span class="n">source</span><span class="p">,</span> <span class="n">DateTime</span> <span class="n">destination</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">source</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">JodaLocalDateConverter.java</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.examples.rest.infra.dozer.converter</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.dozer.DozerConverter</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.joda.time.LocalDate</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JodaLocalDateConverter</span> <span class="kd">extends</span>
                                   <span class="n">DozerConverter</span><span class="o">&lt;</span><span class="n">LocalDate</span><span class="p">,</span> <span class="n">LocalDate</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="nf">JodaLocalDateConverter</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">super</span><span class="p">(</span><span class="n">LocalDate</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">LocalDate</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">LocalDate</span> <span class="nf">convertTo</span><span class="p">(</span><span class="n">LocalDate</span> <span class="n">source</span><span class="p">,</span> <span class="n">LocalDate</span> <span class="n">destination</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// This method not called, because type of from/to is same.</span>
        <span class="k">return</span> <span class="n">convertFrom</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">LocalDate</span> <span class="nf">convertFrom</span><span class="p">(</span><span class="n">LocalDate</span> <span class="n">source</span><span class="p">,</span> <span class="n">LocalDate</span> <span class="n">destination</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">source</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">作成したカスタムコンバータをDozerに適用する。</div>
<div class="line">カスタムコンバータの詳細については、「<a class="reference internal" href="Utilities/Dozer.html"><span class="doc">Beanマッピング(Dozer)</span></a>」を参照されたい。</div>
</div>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="hll"><span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;mappings</span> <span class="na">xmlns=</span><span class="s">&quot;http://dozer.sourceforge.net&quot;</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;</span>
<span class="s">        http://dozer.sourceforge.net http://dozer.sourceforge.net/schema/beanmapping.xsd</span>
<span class="s">    &quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;configuration&gt;</span>
        <span class="nt">&lt;custom-converters&gt;</span>
<span class="hll">            <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">            <span class="nt">&lt;converter</span> <span class="na">type=</span><span class="s">&quot;org.terasoluna.examples.rest.infra.dozer.converter.JodaDateTimeConverter&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">                <span class="nt">&lt;class-a&gt;</span>org.joda.time.DateTime<span class="nt">&lt;/class-a&gt;</span>
</span><span class="hll">                <span class="nt">&lt;class-b&gt;</span>org.joda.time.DateTime<span class="nt">&lt;/class-b&gt;</span>
</span><span class="hll">            <span class="nt">&lt;/converter&gt;</span>
</span><span class="hll">            <span class="nt">&lt;converter</span> <span class="na">type=</span><span class="s">&quot;org.terasoluna.examples.rest.infra.dozer.converter.JodaLocalDateConverter&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">                <span class="nt">&lt;class-a&gt;</span>org.joda.time.LocalDate<span class="nt">&lt;/class-a&gt;</span>
</span><span class="hll">                <span class="nt">&lt;class-b&gt;</span>org.joda.time.LocalDate<span class="nt">&lt;/class-b&gt;</span>
</span><span class="hll">            <span class="nt">&lt;/converter&gt;</span>
</span>        <span class="nt">&lt;/custom-converters&gt;</span>
    <span class="nt">&lt;/configuration&gt;</span>

<span class="nt">&lt;/mappings&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Dozerの動作設定を定義するファイルを作成する。</div>
<div class="line"><br /></div>
<div class="line">今回の実装例では、<code class="file docutils literal"><span class="pre">/xxx-domain/src/main/resources/META-INF/dozer/dozer-configration-mapping.xml</span></code>に格納する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">上記例では、Joda-Timeのクラス(<code class="docutils literal"><span class="pre">org.joda.time.DateTime</span></code>と<code class="docutils literal"><span class="pre">org.joda.time.LocalDate</span></code>)に対するカスタムコンバータの定義を追加している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>ドメイン層でもDozerを使用する場合は、Dozerの動作設定を定義するファイルは、ドメイン層用のプロジェクト(<code class="docutils literal"><span class="pre">xxx-domain</span></code>)に格納する事を推奨する。</p>
<p class="last">アプリケーション層のみでDozerを使う場合は、アプリケーション層用のプロジェクト(<code class="docutils literal"><span class="pre">xxx-web</span></code>)に格納してもよい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="restappendixsorucecodesofapplicationlayer">
<span id="id56"></span><h3><a class="toc-backref" href="#id144">5.16.6.8. アプリケーション層のソースコード</a><a class="headerlink" href="#restappendixsorucecodesofapplicationlayer" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line"><a class="reference internal" href="#resthowtouse"><span class="std std-ref">How to use</span></a>の説明で使用したアプリケーション層のソースコードのうち、断片的に貼りつけていたソースコードの完全版を添付しておく。</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="45%" />
<col width="45%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">セクション</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">ファイル名</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#resthowtouseapiimplementation"><span class="std std-ref">REST APIの実装</span></a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#restappendixsorucecodesofmemberrestcontroller"><span class="std std-ref">MemberRestController.java</span></a></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#resthowtouseexceptionhandling"><span class="std std-ref">例外のハンドリングの実装</span></a></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#restappendixsorucecodesofapierrorcreator"><span class="std std-ref">ApiErrorCreator.java</span></a></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#restappendixsorucecodesofapiglobalexceptionhandler"><span class="std std-ref">ApiGlobalExceptionHandler.java</span></a></div>
</div>
</td>
</tr>
</tbody>
</table>
<p>以下のファイルは、除外している。</p>
<ul class="simple">
<li>JavaBean</li>
<li>設定ファイル</li>
</ul>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="memberrestcontroller-java">
<span id="restappendixsorucecodesofmemberrestcontroller"></span><h4><a class="toc-backref" href="#id145">5.16.6.8.1. MemberRestController.java</a><a class="headerlink" href="#memberrestcontroller-java" title="Permalink to this headline">¶</a></h4>
<p><code class="file docutils literal"><span class="pre">java/org/terasoluna/examples/rest/api/member/MemberRestController.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.examples.rest.api.member</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.groups.Default</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.dozer.Mapper</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.domain.Page</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.domain.PageImpl</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.domain.Pageable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PathVariable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestBody</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ResponseStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.examples.rest.api.member.MemberResource.PostMembers</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.examples.rest.api.member.MemberResource.PutMember</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.examples.rest.domain.model.Member</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.examples.rest.domain.service.member.MemberService</span><span class="p">;</span>

<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;members&quot;</span><span class="p">)</span>
<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRestController</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">MemberService</span> <span class="n">memberService</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">Mapper</span> <span class="n">beanMapper</span><span class="p">;</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">Page</span><span class="o">&lt;</span><span class="n">MemberResource</span><span class="o">&gt;</span> <span class="nf">getMembers</span><span class="p">(</span><span class="nd">@Validated</span> <span class="n">MembersSearchQuery</span> <span class="n">query</span><span class="p">,</span>
            <span class="n">Pageable</span> <span class="n">pageable</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">Page</span><span class="o">&lt;</span><span class="n">Member</span><span class="o">&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">memberService</span><span class="p">.</span><span class="na">searchMembers</span><span class="p">(</span><span class="n">query</span><span class="p">.</span><span class="na">getName</span><span class="p">(),</span> <span class="n">pageable</span><span class="p">);</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">MemberResource</span><span class="o">&gt;</span> <span class="n">memberResources</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Member</span> <span class="n">member</span> <span class="p">:</span> <span class="n">page</span><span class="p">.</span><span class="na">getContent</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">memberResources</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="n">MemberResource</span><span class="p">.</span><span class="na">class</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="n">Page</span><span class="o">&lt;</span><span class="n">MemberResource</span><span class="o">&gt;</span> <span class="n">responseResource</span> <span class="o">=</span>
            <span class="k">new</span> <span class="n">PageImpl</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">memberResources</span><span class="p">,</span> <span class="n">pageable</span><span class="p">,</span> <span class="n">page</span><span class="p">.</span><span class="na">getTotalElements</span><span class="p">());</span>

        <span class="k">return</span> <span class="n">responseResource</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">MemberResource</span><span class="o">&gt;</span> <span class="nf">getMembers</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Member</span><span class="o">&gt;</span> <span class="n">members</span> <span class="o">=</span> <span class="n">memberService</span><span class="p">.</span><span class="na">findAll</span><span class="p">();</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">MemberResource</span><span class="o">&gt;</span> <span class="n">memberResources</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Member</span> <span class="n">member</span> <span class="p">:</span> <span class="n">members</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">memberResources</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="n">MemberResource</span><span class="p">.</span><span class="na">class</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">memberResources</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">CREATED</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">MemberResource</span> <span class="nf">postMembers</span><span class="p">(</span><span class="nd">@RequestBody</span> <span class="nd">@Validated</span><span class="p">({</span>
            <span class="n">PostMembers</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">Default</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span> <span class="n">MemberResource</span> <span class="n">requestedResource</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">Member</span> <span class="n">creatingMember</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">requestedResource</span><span class="p">,</span> <span class="n">Member</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

        <span class="n">Member</span> <span class="n">createdMember</span> <span class="o">=</span> <span class="n">memberService</span><span class="p">.</span><span class="na">createMember</span><span class="p">(</span><span class="n">creatingMember</span><span class="p">);</span>

        <span class="n">MemberResource</span> <span class="n">responseResource</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">createdMember</span><span class="p">,</span>
                <span class="n">MemberResource</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">responseResource</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;{memberId}&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">MemberResource</span> <span class="nf">getMember</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;memberId&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">memberId</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberService</span><span class="p">.</span><span class="na">getMember</span><span class="p">(</span><span class="n">memberId</span><span class="p">);</span>

        <span class="n">MemberResource</span> <span class="n">responseResource</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">member</span><span class="p">,</span>
                <span class="n">MemberResource</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">responseResource</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;{memberId}&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">PUT</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">MemberResource</span> <span class="nf">putMember</span><span class="p">(</span>
            <span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;memberId&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">memberId</span><span class="p">,</span>
            <span class="nd">@RequestBody</span> <span class="nd">@Validated</span><span class="p">({</span>
            <span class="n">PutMember</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">Default</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span> <span class="n">MemberResource</span> <span class="n">requestedResource</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">Member</span> <span class="n">updatingMember</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">requestedResource</span><span class="p">,</span> <span class="n">Member</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

        <span class="n">Member</span> <span class="n">updatedMember</span> <span class="o">=</span> <span class="n">memberService</span><span class="p">.</span><span class="na">updateMember</span><span class="p">(</span><span class="n">memberId</span><span class="p">,</span>
                <span class="n">updatingMember</span><span class="p">);</span>

        <span class="n">MemberResource</span> <span class="n">responseResource</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">updatedMember</span><span class="p">,</span>
                <span class="n">MemberResource</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">responseResource</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;{memberId}&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">DELETE</span><span class="p">)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">NO_CONTENT</span><span class="p">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteMember</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;memberId&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">memberId</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">memberService</span><span class="p">.</span><span class="na">deleteMember</span><span class="p">(</span><span class="n">memberId</span><span class="p">);</span>

    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="apierrorcreator-java">
<span id="restappendixsorucecodesofapierrorcreator"></span><h4><a class="toc-backref" href="#id146">5.16.6.8.2. ApiErrorCreator.java</a><a class="headerlink" href="#apierrorcreator-java" title="Permalink to this headline">¶</a></h4>
<p><code class="file docutils literal"><span class="pre">java/org/terasoluna/examples/rest/api/common/error/ApiErrorCreator.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.examples.rest.api.common.error</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.context.MessageSource</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.support.DefaultMessageSourceResolvable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.BindingResult</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.FieldError</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.ObjectError</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.context.request.WebRequest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessage</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessages</span><span class="p">;</span>

<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiErrorCreator</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">MessageSource</span> <span class="n">messageSource</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">ApiError</span> <span class="nf">createApiError</span><span class="p">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="p">,</span> <span class="n">String</span> <span class="n">errorCode</span><span class="p">,</span>
            <span class="n">String</span> <span class="n">defaultErrorMessage</span><span class="p">,</span> <span class="n">Object</span><span class="p">...</span> <span class="n">arguments</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">localizedMessage</span> <span class="o">=</span> <span class="n">messageSource</span><span class="p">.</span><span class="na">getMessage</span><span class="p">(</span><span class="n">errorCode</span><span class="p">,</span>
                <span class="n">arguments</span><span class="p">,</span> <span class="n">defaultErrorMessage</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="na">getLocale</span><span class="p">());</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ApiError</span><span class="p">(</span><span class="n">errorCode</span><span class="p">,</span> <span class="n">localizedMessage</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">ApiError</span> <span class="nf">createBindingResultApiError</span><span class="p">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="p">,</span>
            <span class="n">String</span> <span class="n">errorCode</span><span class="p">,</span> <span class="n">BindingResult</span> <span class="n">bindingResult</span><span class="p">,</span>
            <span class="n">String</span> <span class="n">defaultErrorMessage</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ApiError</span> <span class="n">apiError</span> <span class="o">=</span> <span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">errorCode</span><span class="p">,</span>
                <span class="n">defaultErrorMessage</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">FieldError</span> <span class="n">fieldError</span> <span class="p">:</span> <span class="n">bindingResult</span><span class="p">.</span><span class="na">getFieldErrors</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">apiError</span><span class="p">.</span><span class="na">addDetail</span><span class="p">(</span><span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">fieldError</span><span class="p">,</span> <span class="n">fieldError</span>
                    <span class="p">.</span><span class="na">getField</span><span class="p">()));</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ObjectError</span> <span class="n">objectError</span> <span class="p">:</span> <span class="n">bindingResult</span><span class="p">.</span><span class="na">getGlobalErrors</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">apiError</span><span class="p">.</span><span class="na">addDetail</span><span class="p">(</span><span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">objectError</span><span class="p">,</span> <span class="n">objectError</span>
                    <span class="p">.</span><span class="na">getObjectName</span><span class="p">()));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">apiError</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="n">ApiError</span> <span class="nf">createApiError</span><span class="p">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="p">,</span>
            <span class="n">DefaultMessageSourceResolvable</span> <span class="n">messageResolvable</span><span class="p">,</span> <span class="n">String</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">localizedMessage</span> <span class="o">=</span> <span class="n">messageSource</span><span class="p">.</span><span class="na">getMessage</span><span class="p">(</span><span class="n">messageResolvable</span><span class="p">,</span>
                <span class="n">request</span><span class="p">.</span><span class="na">getLocale</span><span class="p">());</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ApiError</span><span class="p">(</span><span class="n">messageResolvable</span><span class="p">.</span><span class="na">getCode</span><span class="p">(),</span> <span class="n">localizedMessage</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">ApiError</span> <span class="nf">createResultMessagesApiError</span><span class="p">(</span><span class="n">WebRequest</span> <span class="n">request</span><span class="p">,</span>
            <span class="n">String</span> <span class="n">rootErrorCode</span><span class="p">,</span> <span class="n">ResultMessages</span> <span class="n">resultMessages</span><span class="p">,</span>
            <span class="n">String</span> <span class="n">defaultErrorMessage</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ApiError</span> <span class="n">apiError</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">resultMessages</span><span class="p">.</span><span class="na">getList</span><span class="p">().</span><span class="na">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ResultMessage</span> <span class="n">resultMessage</span> <span class="o">=</span> <span class="n">resultMessages</span><span class="p">.</span><span class="na">iterator</span><span class="p">().</span><span class="na">next</span><span class="p">();</span>
            <span class="n">String</span> <span class="n">errorCode</span> <span class="o">=</span> <span class="n">resultMessage</span><span class="p">.</span><span class="na">getCode</span><span class="p">();</span>
            <span class="n">String</span> <span class="n">errorText</span> <span class="o">=</span> <span class="n">resultMessage</span><span class="p">.</span><span class="na">getText</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">errorCode</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">errorText</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">errorCode</span> <span class="o">=</span> <span class="n">rootErrorCode</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">apiError</span> <span class="o">=</span> <span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">errorCode</span><span class="p">,</span> <span class="n">errorText</span><span class="p">,</span>
                    <span class="n">resultMessage</span><span class="p">.</span><span class="na">getArgs</span><span class="p">());</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">apiError</span> <span class="o">=</span> <span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">rootErrorCode</span><span class="p">,</span>
                    <span class="n">defaultErrorMessage</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">ResultMessage</span> <span class="n">resultMessage</span> <span class="p">:</span> <span class="n">resultMessages</span><span class="p">.</span><span class="na">getList</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">apiError</span><span class="p">.</span><span class="na">addDetail</span><span class="p">(</span><span class="n">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">resultMessage</span>
                        <span class="p">.</span><span class="na">getCode</span><span class="p">(),</span> <span class="n">resultMessage</span><span class="p">.</span><span class="na">getText</span><span class="p">(),</span> <span class="n">resultMessage</span>
                        <span class="p">.</span><span class="na">getArgs</span><span class="p">()));</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">apiError</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="apiglobalexceptionhandler-java">
<span id="restappendixsorucecodesofapiglobalexceptionhandler"></span><h4><a class="toc-backref" href="#id147">5.16.6.8.3. ApiGlobalExceptionHandler.java</a><a class="headerlink" href="#apiglobalexceptionhandler-java" title="Permalink to this headline">¶</a></h4>
<p><code class="file docutils literal"><span class="pre">java/org/terasoluna/examples/rest/api/common/error/ApiGlobalExceptionHandler.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.examples.rest.api.common.error</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.dao.OptimisticLockingFailureException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.dao.PessimisticLockingFailureException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpHeaders</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.ResponseEntity</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.converter.HttpMessageNotReadableException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.BindException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.BindingResult</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.MethodArgumentNotValidException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ControllerAdvice</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ExceptionHandler</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.context.request.WebRequest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.BusinessException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.ExceptionCodeResolver</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.ResourceNotFoundException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.ResultMessagesNotificationException</span><span class="p">;</span>

<span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiGlobalExceptionHandler</span> <span class="kd">extends</span> <span class="n">ResponseEntityExceptionHandler</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ApiErrorCreator</span> <span class="n">apiErrorCreator</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">ExceptionCodeResolver</span> <span class="n">exceptionCodeResolver</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleExceptionInternal</span><span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">,</span>
            <span class="n">Object</span> <span class="n">body</span><span class="p">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="p">,</span> <span class="n">HttpStatus</span> <span class="n">status</span><span class="p">,</span>
            <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">final</span> <span class="n">Object</span> <span class="n">apiError</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">body</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">String</span> <span class="n">errorCode</span> <span class="o">=</span> <span class="n">exceptionCodeResolver</span><span class="p">.</span><span class="na">resolveExceptionCode</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
            <span class="n">apiError</span> <span class="o">=</span> <span class="n">apiErrorCreator</span><span class="p">.</span><span class="na">createApiError</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">errorCode</span><span class="p">,</span> <span class="n">ex</span>
                    <span class="p">.</span><span class="na">getLocalizedMessage</span><span class="p">());</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">apiError</span> <span class="o">=</span> <span class="n">body</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">status</span><span class="p">).</span><span class="na">headers</span><span class="p">(</span><span class="n">headers</span><span class="p">).</span><span class="na">body</span><span class="p">(</span><span class="n">apiError</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleMethodArgumentNotValid</span><span class="p">(</span>
            <span class="n">MethodArgumentNotValidException</span> <span class="n">ex</span><span class="p">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="p">,</span>
            <span class="n">HttpStatus</span> <span class="n">status</span><span class="p">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">handleBindingResult</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="na">getBindingResult</span><span class="p">(),</span> <span class="n">headers</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
                <span class="n">request</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleBindException</span><span class="p">(</span><span class="n">BindException</span> <span class="n">ex</span><span class="p">,</span>
            <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="p">,</span> <span class="n">HttpStatus</span> <span class="n">status</span><span class="p">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">handleBindingResult</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="na">getBindingResult</span><span class="p">(),</span> <span class="n">headers</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
                <span class="n">request</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleBindingResult</span><span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">,</span>
            <span class="n">BindingResult</span> <span class="n">bindingResult</span><span class="p">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="p">,</span>
            <span class="n">HttpStatus</span> <span class="n">status</span><span class="p">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">errorCode</span> <span class="o">=</span> <span class="n">exceptionCodeResolver</span><span class="p">.</span><span class="na">resolveExceptionCode</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
        <span class="n">ApiError</span> <span class="n">apiError</span> <span class="o">=</span> <span class="n">apiErrorCreator</span><span class="p">.</span><span class="na">createBindingResultApiError</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span> <span class="n">errorCode</span><span class="p">,</span> <span class="n">bindingResult</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
        <span class="k">return</span> <span class="n">handleExceptionInternal</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">apiError</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleHttpMessageNotReadable</span><span class="p">(</span>
            <span class="n">HttpMessageNotReadableException</span> <span class="n">ex</span><span class="p">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="p">,</span>
            <span class="n">HttpStatus</span> <span class="n">status</span><span class="p">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="na">getCause</span><span class="p">()</span> <span class="k">instanceof</span> <span class="n">Exception</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">handleExceptionInternal</span><span class="p">((</span><span class="n">Exception</span><span class="p">)</span> <span class="n">ex</span><span class="p">.</span><span class="na">getCause</span><span class="p">(),</span> <span class="kc">null</span><span class="p">,</span>
                    <span class="n">headers</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">handleExceptionInternal</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">ResourceNotFoundException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleResourceNotFoundException</span><span class="p">(</span>
            <span class="n">ResourceNotFoundException</span> <span class="n">ex</span><span class="p">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">handleResultMessagesNotificationException</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="p">(),</span>
                <span class="n">HttpStatus</span><span class="p">.</span><span class="na">NOT_FOUND</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">BusinessException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleBusinessException</span><span class="p">(</span><span class="n">BusinessException</span> <span class="n">ex</span><span class="p">,</span>
            <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">handleResultMessagesNotificationException</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="p">(),</span>
                <span class="n">HttpStatus</span><span class="p">.</span><span class="na">CONFLICT</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleResultMessagesNotificationException</span><span class="p">(</span>
            <span class="n">ResultMessagesNotificationException</span> <span class="n">ex</span><span class="p">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="p">,</span>
            <span class="n">HttpStatus</span> <span class="n">status</span><span class="p">,</span> <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">errorCode</span> <span class="o">=</span> <span class="n">exceptionCodeResolver</span><span class="p">.</span><span class="na">resolveExceptionCode</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
        <span class="n">ApiError</span> <span class="n">apiError</span> <span class="o">=</span> <span class="n">apiErrorCreator</span><span class="p">.</span><span class="na">createResultMessagesApiError</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span> <span class="n">errorCode</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="na">getResultMessages</span><span class="p">(),</span> <span class="n">ex</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
        <span class="k">return</span> <span class="n">handleExceptionInternal</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">apiError</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@ExceptionHandler</span><span class="p">({</span> <span class="n">OptimisticLockingFailureException</span><span class="p">.</span><span class="na">class</span><span class="p">,</span>
            <span class="n">PessimisticLockingFailureException</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleLockingFailureException</span><span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">,</span>
            <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">handleExceptionInternal</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="p">(),</span>
                <span class="n">HttpStatus</span><span class="p">.</span><span class="na">CONFLICT</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">Exception</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleSystemError</span><span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">,</span>
            <span class="n">WebRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">handleExceptionInternal</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="p">(),</span>
                <span class="n">HttpStatus</span><span class="p">.</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="restappendixsorucecodesofdomainlayer">
<span id="id57"></span><h3><a class="toc-backref" href="#id148">5.16.6.9. REST API実装時に作成したドメイン層のクラスのソースコード</a><a class="headerlink" href="#restappendixsorucecodesofdomainlayer" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line"><a class="reference internal" href="#resthowtouse"><span class="std std-ref">How to use</span></a>で説明したREST APIから呼び出しているドメイン層のクラスのソースコードを添付しておく。</div>
<div class="line">なお、インフラストラクチャ層は、MyBatis3を使って実装している。</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="35%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">分類</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">ファイル名</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">model</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#restappendixsorucecodesofmember"><span class="std std-ref">Member.java</span></a></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#restappendixsorucecodesofmembercredentia"><span class="std std-ref">MemberCredentia.java</span></a></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#restappendixsorucecodesofgender"><span class="std std-ref">Gender.java</span></a></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">repository</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#restappendixsorucecodesofmemberrepository"><span class="std std-ref">MemberRepository.java</span></a></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">service</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#restappendixsorucecodesofmemberservice"><span class="std std-ref">MemberService.java</span></a></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#restappendixsorucecodesofmemberserviceimpl"><span class="std std-ref">MemberServiceImpl.java</span></a></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">other</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#restappendixsorucecodesofdomainmessagecodes"><span class="std std-ref">DomainMessageCodes.java</span></a></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#restappendixsorucecodesofgendertypehandler"><span class="std std-ref">GenderTypeHandler.java</span></a></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#restappendixsorucecodesofmembermappingxml"><span class="std std-ref">member-mapping.xml</span></a></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#restappendixsorucecodesofmybatisconfig"><span class="std std-ref">mybatis-config.xml</span></a></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#restappendixsorucecodesofmemberrepositoryxml"><span class="std std-ref">MemberRepository.xml</span></a></div>
</div>
</td>
</tr>
</tbody>
</table>
<p>以下のファイルは、除外している。</p>
<ul class="simple">
<li>Entity以外のJavaBean</li>
<li>Dozer以外の設定ファイル</li>
</ul>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="member-java">
<span id="restappendixsorucecodesofmember"></span><h4><a class="toc-backref" href="#id149">5.16.6.9.1. Member.java</a><a class="headerlink" href="#member-java" title="Permalink to this headline">¶</a></h4>
<p><code class="file docutils literal"><span class="pre">java/org/terasoluna/examples/rest/domain/model/Member.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.examples.rest.domain.model</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.joda.time.DateTime</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.joda.time.LocalDate</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Member</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">memberId</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">firstName</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">lastName</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">Gender</span> <span class="n">gender</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">LocalDate</span> <span class="n">dateOfBirth</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">emailAddress</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">telephoneNumber</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">zipCode</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">address</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">DateTime</span> <span class="n">createdAt</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">DateTime</span> <span class="n">lastModifiedAt</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kt">long</span> <span class="n">version</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">MemberCredential</span> <span class="n">credential</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getMemberId</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">memberId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMemberId</span><span class="p">(</span><span class="n">String</span> <span class="n">memberId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">memberId</span> <span class="o">=</span> <span class="n">memberId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getFirstName</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">firstName</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFirstName</span><span class="p">(</span><span class="n">String</span> <span class="n">firstName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">firstName</span> <span class="o">=</span> <span class="n">firstName</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getLastName</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">lastName</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLastName</span><span class="p">(</span><span class="n">String</span> <span class="n">lastName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">lastName</span> <span class="o">=</span> <span class="n">lastName</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">Gender</span> <span class="nf">getGender</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">gender</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setGender</span><span class="p">(</span><span class="n">Gender</span> <span class="n">gender</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">gender</span> <span class="o">=</span> <span class="n">gender</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getGenderCode</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">gender</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">gender</span><span class="p">.</span><span class="na">getCode</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setGenderCode</span><span class="p">(</span><span class="n">String</span> <span class="n">genderCode</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">gender</span> <span class="o">=</span> <span class="n">Gender</span><span class="p">.</span><span class="na">getByCode</span><span class="p">(</span><span class="n">genderCode</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">LocalDate</span> <span class="nf">getDateOfBirth</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">dateOfBirth</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDateOfBirth</span><span class="p">(</span><span class="n">LocalDate</span> <span class="n">dateOfBirth</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">dateOfBirth</span> <span class="o">=</span> <span class="n">dateOfBirth</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getEmailAddress</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">emailAddress</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEmailAddress</span><span class="p">(</span><span class="n">String</span> <span class="n">emailAddress</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">emailAddress</span> <span class="o">=</span> <span class="n">emailAddress</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTelephoneNumber</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">telephoneNumber</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTelephoneNumber</span><span class="p">(</span><span class="n">String</span> <span class="n">telephoneNumber</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">telephoneNumber</span> <span class="o">=</span> <span class="n">telephoneNumber</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getZipCode</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">zipCode</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setZipCode</span><span class="p">(</span><span class="n">String</span> <span class="n">zipCode</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">zipCode</span> <span class="o">=</span> <span class="n">zipCode</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getAddress</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">address</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAddress</span><span class="p">(</span><span class="n">String</span> <span class="n">address</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">address</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">DateTime</span> <span class="nf">getCreatedAt</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">createdAt</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCreatedAt</span><span class="p">(</span><span class="n">DateTime</span> <span class="n">createdAt</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">createdAt</span> <span class="o">=</span> <span class="n">createdAt</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">DateTime</span> <span class="nf">getLastModifiedAt</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">lastModifiedAt</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLastModifiedAt</span><span class="p">(</span><span class="n">DateTime</span> <span class="n">lastModifiedAt</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">lastModifiedAt</span> <span class="o">=</span> <span class="n">lastModifiedAt</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getVersion</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">version</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setVersion</span><span class="p">(</span><span class="kt">long</span> <span class="n">version</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">version</span> <span class="o">=</span> <span class="n">version</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">MemberCredential</span> <span class="nf">getCredential</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">credential</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCredential</span><span class="p">(</span><span class="n">MemberCredential</span> <span class="n">credential</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">credential</span> <span class="o">=</span> <span class="n">credential</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="membercredentia-java">
<span id="restappendixsorucecodesofmembercredentia"></span><h4><a class="toc-backref" href="#id150">5.16.6.9.2. MemberCredentia.java</a><a class="headerlink" href="#membercredentia-java" title="Permalink to this headline">¶</a></h4>
<p><code class="file docutils literal"><span class="pre">java/org/terasoluna/examples/rest/domain/model/MemberCredential.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.examples.rest.domain.model</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.joda.time.DateTime</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberCredential</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">memberId</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">signId</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">previousPassword</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">DateTime</span> <span class="n">passwordLastChangedAt</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">DateTime</span> <span class="n">lastModifiedAt</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kt">long</span> <span class="n">version</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getMemberId</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">memberId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMemberId</span><span class="p">(</span><span class="n">String</span> <span class="n">memberId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">memberId</span> <span class="o">=</span> <span class="n">memberId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getSignId</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">signId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSignId</span><span class="p">(</span><span class="n">String</span> <span class="n">signId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">signId</span> <span class="o">=</span> <span class="n">signId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getPassword</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">password</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPassword</span><span class="p">(</span><span class="n">String</span> <span class="n">password</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">password</span> <span class="o">=</span> <span class="n">password</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getPreviousPassword</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">previousPassword</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPreviousPassword</span><span class="p">(</span><span class="n">String</span> <span class="n">previousPassword</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">previousPassword</span> <span class="o">=</span> <span class="n">previousPassword</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">DateTime</span> <span class="nf">getPasswordLastChangedAt</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">passwordLastChangedAt</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPasswordLastChangedAt</span><span class="p">(</span><span class="n">DateTime</span> <span class="n">passwordLastChangedAt</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">passwordLastChangedAt</span> <span class="o">=</span> <span class="n">passwordLastChangedAt</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">DateTime</span> <span class="nf">getLastModifiedAt</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">lastModifiedAt</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLastModifiedAt</span><span class="p">(</span><span class="n">DateTime</span> <span class="n">lastModifiedAt</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">lastModifiedAt</span> <span class="o">=</span> <span class="n">lastModifiedAt</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getVersion</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">version</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setVersion</span><span class="p">(</span><span class="kt">long</span> <span class="n">version</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">version</span> <span class="o">=</span> <span class="n">version</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="gender-java">
<span id="restappendixsorucecodesofgender"></span><h4><a class="toc-backref" href="#id151">5.16.6.9.3. Gender.java</a><a class="headerlink" href="#gender-java" title="Permalink to this headline">¶</a></h4>
<p><code class="file docutils literal"><span class="pre">java/org/terasoluna/examples/rest/domain/model/Gender.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.examples.rest.domain.model</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.util.Assert</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">enum</span> <span class="n">Gender</span> <span class="p">{</span>

    <span class="n">UNKNOWN</span><span class="p">(</span><span class="s">&quot;0&quot;</span><span class="p">),</span> <span class="n">MEN</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">),</span> <span class="n">WOMEN</span><span class="p">(</span><span class="s">&quot;2&quot;</span><span class="p">);</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Gender</span><span class="o">&gt;</span> <span class="n">genderMap</span><span class="p">;</span>

    <span class="kd">static</span> <span class="p">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Gender</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Gender</span> <span class="n">gender</span> <span class="p">:</span> <span class="n">values</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">gender</span><span class="p">.</span><span class="na">code</span><span class="p">,</span> <span class="n">gender</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">genderMap</span> <span class="o">=</span> <span class="n">Collections</span><span class="p">.</span><span class="na">unmodifiableMap</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">code</span><span class="p">;</span>

    <span class="kd">private</span> <span class="nf">Gender</span><span class="p">(</span><span class="n">String</span> <span class="n">code</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">code</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Gender</span> <span class="nf">getByCode</span><span class="p">(</span><span class="n">String</span> <span class="n">code</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Gender</span> <span class="n">gender</span> <span class="o">=</span> <span class="n">genderMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">code</span><span class="p">);</span>
        <span class="n">Assert</span><span class="p">.</span><span class="na">notNull</span><span class="p">(</span><span class="n">gender</span><span class="p">,</span> <span class="s">&quot;gender code is invalid. code : &quot;</span> <span class="o">+</span> <span class="n">code</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">gender</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getCode</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">code</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="memberrepository-java">
<span id="restappendixsorucecodesofmemberrepository"></span><h4><a class="toc-backref" href="#id152">5.16.6.9.4. MemberRepository.java</a><a class="headerlink" href="#memberrepository-java" title="Permalink to this headline">¶</a></h4>
<p><code class="file docutils literal"><span class="pre">java/org/terasoluna/examples/rest/domain/repository/member/MemberRepository.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.examples.rest.domain.repository.member</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.session.RowBounds</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.terasoluna.examples.rest.domain.model.Member</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberRepository</span> <span class="p">{</span>

    <span class="n">Member</span> <span class="nf">findOne</span><span class="p">(</span><span class="n">String</span> <span class="n">memberId</span><span class="p">);</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">Member</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="p">();</span>

    <span class="kt">long</span> <span class="nf">countByContainsName</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">);</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Member</span><span class="o">&gt;</span> <span class="nf">findPageByContainsName</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">RowBounds</span> <span class="n">rowBounds</span><span class="p">);</span>

    <span class="kt">void</span> <span class="nf">createMember</span><span class="p">(</span><span class="n">Member</span> <span class="n">creatingMember</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">createCredential</span><span class="p">(</span><span class="n">Member</span> <span class="n">creatingMember</span><span class="p">);</span>

    <span class="kt">boolean</span> <span class="nf">updateMember</span><span class="p">(</span><span class="n">Member</span> <span class="n">updatingMember</span><span class="p">);</span>

    <span class="kt">void</span> <span class="nf">deleteMember</span><span class="p">(</span><span class="n">String</span> <span class="n">memberId</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">deleteCredential</span><span class="p">(</span><span class="n">String</span> <span class="n">memberId</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="memberservice-java">
<span id="restappendixsorucecodesofmemberservice"></span><h4><a class="toc-backref" href="#id153">5.16.6.9.5. MemberService.java</a><a class="headerlink" href="#memberservice-java" title="Permalink to this headline">¶</a></h4>
<p><code class="file docutils literal"><span class="pre">java/org/terasoluna/examples/rest/domain/service/member/MemberService.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.examples.rest.domain.service.member</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.domain.Page</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.domain.Pageable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.examples.rest.domain.model.Member</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberService</span> <span class="p">{</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">Member</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="p">();</span>

    <span class="n">Page</span><span class="o">&lt;</span><span class="n">Member</span><span class="o">&gt;</span> <span class="nf">searchMembers</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="p">);</span>

    <span class="n">Member</span> <span class="nf">getMember</span><span class="p">(</span><span class="n">String</span> <span class="n">memberId</span><span class="p">);</span>

    <span class="n">Member</span> <span class="nf">createMember</span><span class="p">(</span><span class="n">Member</span> <span class="n">creatingMember</span><span class="p">);</span>

    <span class="n">Member</span> <span class="nf">updateMember</span><span class="p">(</span><span class="n">String</span> <span class="n">memberId</span><span class="p">,</span> <span class="n">Member</span> <span class="n">updatingMember</span><span class="p">);</span>

    <span class="kt">void</span> <span class="nf">deleteMember</span><span class="p">(</span><span class="n">String</span> <span class="n">memberId</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="memberserviceimpl-java">
<span id="restappendixsorucecodesofmemberserviceimpl"></span><h4><a class="toc-backref" href="#id154">5.16.6.9.6. MemberServiceImpl.java</a><a class="headerlink" href="#memberserviceimpl-java" title="Permalink to this headline">¶</a></h4>
<p><code class="file docutils literal"><span class="pre">java/org/terasoluna/examples/rest/domain/service/member/MemberServiceImpl.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.examples.rest.domain.service.member</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.session.RowBounds</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.dozer.Mapper</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.joda.time.DateTime</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.dao.DuplicateKeyException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.domain.Page</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.domain.PageImpl</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.domain.Pageable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.orm.ObjectOptimisticLockingFailureException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.crypto.password.PasswordEncoder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.StringUtils</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.examples.rest.domain.message.DomainMessageCodes</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.examples.rest.domain.model.Member</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.examples.rest.domain.model.MemberCredential</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.examples.rest.domain.repository.member.MemberRepository</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.date.jodatime.JodaTimeDateFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.BusinessException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.ResourceNotFoundException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessages</span><span class="p">;</span>

<span class="nd">@Transactional</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberServiceImpl</span> <span class="kd">implements</span> <span class="n">MemberService</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">MemberRepository</span> <span class="n">memberRepository</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">JodaTimeDateFactory</span> <span class="n">dateFactory</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">Mapper</span> <span class="n">beanMapper</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">RestMember</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">restMemberRepository</span><span class="p">.</span><span class="na">findAll</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">Page</span><span class="o">&lt;</span><span class="n">Member</span><span class="o">&gt;</span> <span class="nf">searchMembers</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Member</span><span class="o">&gt;</span> <span class="n">members</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="c1">// Count Members by search criteria</span>
        <span class="kt">long</span> <span class="n">total</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="p">.</span><span class="na">countByContainsName</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">total</span><span class="p">)</span> <span class="p">{</span>
             <span class="n">RowBounds</span> <span class="n">rowBounds</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RowBounds</span><span class="p">(</span><span class="n">pageable</span><span class="p">.</span><span class="na">getOffset</span><span class="p">(),</span> <span class="n">pageable</span><span class="p">.</span><span class="na">getPageSize</span><span class="p">());</span>
             <span class="n">members</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="p">.</span><span class="na">findPageByContainsName</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">rowBounds</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">members</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Member</span><span class="o">&gt;</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">PageImpl</span><span class="o">&lt;</span><span class="n">Member</span><span class="o">&gt;</span><span class="p">(</span><span class="n">members</span><span class="p">,</span> <span class="n">pageable</span><span class="p">,</span> <span class="n">total</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">Member</span> <span class="nf">getMember</span><span class="p">(</span><span class="n">String</span> <span class="n">memberId</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// find member</span>
        <span class="n">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">memberId</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">member</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// If member is not exists</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">ResourceNotFoundException</span><span class="p">(</span><span class="n">ResultMessages</span><span class="p">.</span><span class="na">error</span><span class="p">().</span><span class="na">add</span><span class="p">(</span>
                            <span class="n">DomainMessageCodes</span><span class="p">.</span><span class="na">E_EX_MM_5001</span><span class="p">,</span> <span class="n">memberId</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">member</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Member</span> <span class="nf">createMember</span><span class="p">(</span><span class="n">Member</span> <span class="n">creatingMember</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">MemberCredential</span> <span class="n">creatingCredential</span> <span class="o">=</span> <span class="n">creatingMember</span>
                            <span class="p">.</span><span class="na">getCredential</span><span class="p">();</span>

        <span class="c1">// get processing current date time</span>
        <span class="n">DateTime</span> <span class="n">currentDateTime</span> <span class="o">=</span> <span class="n">dateFactory</span><span class="p">.</span><span class="na">newDateTime</span><span class="p">();</span>

        <span class="n">creatingMember</span><span class="p">.</span><span class="na">setCreatedAt</span><span class="p">(</span><span class="n">currentDateTime</span><span class="p">);</span>
        <span class="n">creatingMember</span><span class="p">.</span><span class="na">setLastModifiedAt</span><span class="p">(</span><span class="n">currentDateTime</span><span class="p">);</span>

        <span class="c1">// decide sign id(email-address)</span>
        <span class="n">String</span> <span class="n">signId</span> <span class="o">=</span> <span class="n">creatingCredential</span><span class="p">.</span><span class="na">getSignId</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">hasLength</span><span class="p">(</span><span class="n">signId</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">signId</span> <span class="o">=</span> <span class="n">creatingMember</span><span class="p">.</span><span class="na">getEmailAddress</span><span class="p">();</span>
            <span class="n">creatingCredential</span><span class="p">.</span><span class="na">setSignId</span><span class="p">(</span><span class="n">signId</span><span class="p">.</span><span class="na">toLowerCase</span><span class="p">());</span>
        <span class="p">}</span>

        <span class="c1">// encrypt password</span>
        <span class="n">String</span> <span class="n">rawPassword</span> <span class="o">=</span> <span class="n">creatingCredential</span><span class="p">.</span><span class="na">getPassword</span><span class="p">();</span>
        <span class="n">creatingCredential</span><span class="p">.</span><span class="na">setPassword</span><span class="p">(</span><span class="n">passwordEncoder</span><span class="p">.</span><span class="na">encode</span><span class="p">(</span><span class="n">rawPassword</span><span class="p">));</span>
        <span class="n">creatingCredential</span><span class="p">.</span><span class="na">setPasswordLastChangedAt</span><span class="p">(</span><span class="n">currentDateTime</span><span class="p">);</span>
        <span class="n">creatingCredential</span><span class="p">.</span><span class="na">setLastModifiedAt</span><span class="p">(</span><span class="n">currentDateTime</span><span class="p">);</span>

        <span class="c1">// save member &amp; member credential</span>
        <span class="k">try</span> <span class="p">{</span>

            <span class="c1">// Registering member details</span>
            <span class="n">memberRepository</span><span class="p">.</span><span class="na">createMember</span><span class="p">(</span><span class="n">creatingMember</span><span class="p">);</span>
            <span class="c1">// //Registering credential details</span>
            <span class="n">memberRepository</span><span class="p">.</span><span class="na">createCredential</span><span class="p">(</span><span class="n">creatingMember</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">creatingMember</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">DuplicateKeyException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// If sign id is already used</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="p">(</span><span class="n">ResultMessages</span><span class="p">.</span><span class="na">error</span><span class="p">().</span><span class="na">add</span><span class="p">(</span>
                            <span class="n">DomainMessageCodes</span><span class="p">.</span><span class="na">E_EX_MM_8001</span><span class="p">,</span>
                            <span class="n">creatingCredential</span><span class="p">.</span><span class="na">getSignId</span><span class="p">()),</span> <span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Member</span> <span class="nf">updateMember</span><span class="p">(</span><span class="n">String</span> <span class="n">memberId</span><span class="p">,</span> <span class="n">Member</span> <span class="n">updatingMember</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// get member</span>
        <span class="n">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">getMember</span><span class="p">(</span><span class="n">memberId</span><span class="p">);</span>

        <span class="c1">// override updating member attributes</span>
        <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">updatingMember</span><span class="p">,</span> <span class="n">member</span><span class="p">,</span> <span class="s">&quot;member.update&quot;</span><span class="p">);</span>

        <span class="c1">// get processing current date time</span>
        <span class="n">DateTime</span> <span class="n">currentDateTime</span> <span class="o">=</span> <span class="n">dateFactory</span><span class="p">.</span><span class="na">newDateTime</span><span class="p">();</span>
        <span class="n">member</span><span class="p">.</span><span class="na">setLastModifiedAt</span><span class="p">(</span><span class="n">currentDateTime</span><span class="p">);</span>

        <span class="c1">// save updating member</span>
        <span class="kt">boolean</span> <span class="n">updated</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="p">.</span><span class="na">updateMember</span><span class="p">(</span><span class="n">member</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">ObjectOptimisticLockingFailureException</span><span class="p">(</span><span class="n">Member</span><span class="p">.</span><span class="na">class</span><span class="p">,</span>
                                <span class="n">member</span><span class="p">.</span><span class="na">getMemberId</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">member</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteMember</span><span class="p">(</span><span class="n">String</span> <span class="n">memberId</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// First Delete from credential (Child)</span>
        <span class="n">memberRepository</span><span class="p">.</span><span class="na">deleteCredential</span><span class="p">(</span><span class="n">memberId</span><span class="p">);</span>
        <span class="c1">// Delete member</span>
        <span class="n">memberRepository</span><span class="p">.</span><span class="na">deleteMember</span><span class="p">(</span><span class="n">memberId</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="domainmessagecodes-java">
<span id="restappendixsorucecodesofdomainmessagecodes"></span><h4><a class="toc-backref" href="#id155">5.16.6.9.7. DomainMessageCodes.java</a><a class="headerlink" href="#domainmessagecodes-java" title="Permalink to this headline">¶</a></h4>
<p><code class="file docutils literal"><span class="pre">java/org/terasoluna/examples/rest/domain/message/DomainMessageCodes.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.examples.rest.domain.message</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Message codes of domain layer message.</span>
<span class="cm"> * @author DomainMessageCodesGenerator</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DomainMessageCodes</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="nf">DomainMessageCodes</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// NOP</span>
    <span class="p">}</span>

    <span class="cm">/** e.ex.mm.5001=Specified member not found. member id : {0} */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">E_EX_MM_5001</span> <span class="o">=</span> <span class="s">&quot;e.ex.mm.5001&quot;</span><span class="p">;</span>

    <span class="cm">/** e.ex.mm.8001=Cannot use specified sign id. sign id : {0} */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">E_EX_MM_8001</span> <span class="o">=</span> <span class="s">&quot;e.ex.mm.8001&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="gendertypehandler-java">
<span id="restappendixsorucecodesofgendertypehandler"></span><h4><a class="toc-backref" href="#id156">5.16.6.9.8. GenderTypeHandler.java</a><a class="headerlink" href="#gendertypehandler-java" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Enum型のコード値をマッピングするためのタイプハンドラーとなります。</div>
</div>
<p><code class="file docutils literal"><span class="pre">java/org/terasoluna/examples/infra/mybatis/typehandler/GenderTypeHandler.java</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.terasoluna.examples.infra.mybatis.typehandler</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.sql.CallableStatement</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.sql.PreparedStatement</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.sql.ResultSet</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.sql.SQLException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.examples.domain.model.Gender</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.type.JdbcType</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.type.BaseTypeHandler</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GenderTypeHandler</span> <span class="kd">extends</span> <span class="n">BaseTypeHandler</span><span class="o">&lt;</span><span class="n">Gender</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Gender</span> <span class="nf">getNullableResult</span><span class="p">(</span><span class="n">ResultSet</span> <span class="n">rs</span><span class="p">,</span> <span class="n">String</span> <span class="n">columnName</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">getByCode</span><span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="n">columnName</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Gender</span> <span class="nf">getNullableResult</span><span class="p">(</span><span class="n">ResultSet</span> <span class="n">rs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">columnIndex</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">getByCode</span><span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="n">columnIndex</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Gender</span> <span class="nf">getNullableResult</span><span class="p">(</span><span class="n">CallableStatement</span> <span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">columnIndex</span><span class="p">)</span>
                    <span class="kd">throws</span> <span class="n">SQLException</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">getByCode</span><span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="n">columnIndex</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setNonNullParameter</span><span class="p">(</span><span class="n">PreparedStatement</span> <span class="n">ps</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span>
                    <span class="n">Gender</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">JdbcType</span> <span class="n">jdbcType</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="p">{</span>
            <span class="n">ps</span><span class="p">.</span><span class="na">setString</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">parameter</span><span class="p">.</span><span class="na">getCode</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="n">Gender</span> <span class="nf">getByCode</span><span class="p">(</span><span class="n">String</span> <span class="n">byCode</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">byCode</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">Gender</span><span class="p">.</span><span class="na">getByCode</span><span class="p">(</span><span class="n">byCode</span><span class="p">);</span>
            <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="member-mapping-xml">
<span id="restappendixsorucecodesofmembermappingxml"></span><h4><a class="toc-backref" href="#id157">5.16.6.9.9. member-mapping.xml</a><a class="headerlink" href="#member-mapping-xml" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">実装したServiceクラスでは、クライアントから指定された値を<code class="docutils literal"><span class="pre">Member</span></code>オブジェクトにコピーする際に、「<a class="reference internal" href="Utilities/Dozer.html"><span class="doc">Beanマッピング(Dozer)</span></a>」を使って行っている。</div>
<div class="line">単純なフィールド値のコピーのみでよい場合は、Beanのマッピング定義の追加は不要だが、実装例では、更新対象外の項目(<code class="docutils literal"><span class="pre">memberId</span></code>、<code class="docutils literal"><span class="pre">credential</span></code>、<code class="docutils literal"><span class="pre">createdAt</span></code>、<code class="docutils literal"><span class="pre">version</span></code>)をコピー対象外にする必要がある。</div>
<div class="line">特定のフィールドをコピー対象外にするためには、Beanのマッピング定義の追加が必要となる。</div>
</div>
<p><code class="file docutils literal"><span class="pre">resources/META-INF/dozer/member-mapping.xml</span></code></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;mappings</span> <span class="na">xmlns=</span><span class="s">&quot;http://dozer.sourceforge.net&quot;</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://dozer.sourceforge.net</span>
<span class="s">          http://dozer.sourceforge.net/schema/beanmapping.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;mapping</span> <span class="na">map-id=</span><span class="s">&quot;member.update&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;class-a&gt;</span>org.terasoluna.examples.rest.domain.model.Member<span class="nt">&lt;/class-a&gt;</span>
        <span class="nt">&lt;class-b&gt;</span>org.terasoluna.examples.rest.domain.model.Member<span class="nt">&lt;/class-b&gt;</span>
        <span class="nt">&lt;field-exclude&gt;</span>
            <span class="nt">&lt;a&gt;</span>memberId<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;b&gt;</span>memberId<span class="nt">&lt;/b&gt;</span>
        <span class="nt">&lt;/field-exclude&gt;</span>
        <span class="nt">&lt;field-exclude&gt;</span>
            <span class="nt">&lt;a&gt;</span>credential<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;b&gt;</span>credential<span class="nt">&lt;/b&gt;</span>
        <span class="nt">&lt;/field-exclude&gt;</span>
        <span class="nt">&lt;field-exclude&gt;</span>
            <span class="nt">&lt;a&gt;</span>createdAt<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;b&gt;</span>createdAt<span class="nt">&lt;/b&gt;</span>
        <span class="nt">&lt;/field-exclude&gt;</span>
        <span class="nt">&lt;field-exclude&gt;</span>
            <span class="nt">&lt;a&gt;</span>lastModifiedAt<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;b&gt;</span>lastModifiedAt<span class="nt">&lt;/b&gt;</span>
        <span class="nt">&lt;/field-exclude&gt;</span>
        <span class="nt">&lt;field-exclude&gt;</span>
            <span class="nt">&lt;a&gt;</span>version<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;b&gt;</span>version<span class="nt">&lt;/b&gt;</span>
        <span class="nt">&lt;/field-exclude&gt;</span>
    <span class="nt">&lt;/mapping&gt;</span>

<span class="nt">&lt;/mappings&gt;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="mybatis-config-xml">
<span id="restappendixsorucecodesofmybatisconfig"></span><h4><a class="toc-backref" href="#id158">5.16.6.9.10. mybatis-config.xml</a><a class="headerlink" href="#mybatis-config-xml" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">MyBatis3の動作をカスタマイズする場合は、MyBatis設定ファイルに設定値を追加する。MyBatis3では、Joda-Timeのクラス(org.joda.time.DateTime、org.joda.time.LocalDateTime、org.joda.time.LocalDateなど)はサポートされていない。</div>
<div class="line">そのため、EntityクラスのフィールドにJoda-Timeのクラスを使用する場合は、Joda-Time用のTypeHandlerを用意する必要がある。</div>
<div class="line">org.joda.time.DateTimeとjava.sql.TimestampをマッピングするためのTypeHandlerの実装例、「<a class="reference internal" href="DataAccessMyBatis3.html#dataaccessmybatis3howtoextendtypehandlerjoda"><span class="std std-ref">Joda-Time用のTypeHandlerの実装</span></a>」を使って行っている。</div>
</div>
<p><code class="file docutils literal"><span class="pre">resources/META-INF/mybatis/mybatis-config.xml</span></code></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE configuration PUBLIC &quot;-//mybatis.org/DTD Config 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span>
<span class="nt">&lt;configuration&gt;</span>

    <span class="nt">&lt;settings&gt;</span>
        <span class="nt">&lt;setting</span> <span class="na">name=</span><span class="s">&quot;jdbcTypeForNull&quot;</span> <span class="na">value=</span><span class="s">&quot;NULL&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;setting</span> <span class="na">name=</span><span class="s">&quot;mapUnderscoreToCamelCase&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/settings&gt;</span>

    <span class="nt">&lt;typeAliases&gt;</span>
        <span class="nt">&lt;package</span> <span class="na">name=</span><span class="s">&quot;org.terasoluna.examples.infra.mybatis.typehandler&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/typeAliases&gt;</span>

    <span class="nt">&lt;typeHandlers&gt;</span>
       <span class="nt">&lt;package</span> <span class="na">name=</span><span class="s">&quot;org.terasoluna.examples.infra.mybatis.typehandler&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/typeHandlers&gt;</span>

<span class="nt">&lt;/configuration&gt;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="memberrepository-xml">
<span id="restappendixsorucecodesofmemberrepositoryxml"></span><h4><a class="toc-backref" href="#id159">5.16.6.9.11. MemberRepository.xml</a><a class="headerlink" href="#memberrepository-xml" title="Permalink to this headline">¶</a></h4>
<p><code class="file docutils literal"><span class="pre">resources/org/terasoluna/examples/rest/domain/repository/member/MemberRepository.xml</span></code></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span>
    <span class="na">namespace=</span><span class="s">&quot;org.terasoluna.examples.rest.domain.repository.member.MemberRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;MemberResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Member&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;memberId&quot;</span> <span class="na">column=</span><span class="s">&quot;member_id&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;firstName&quot;</span> <span class="na">column=</span><span class="s">&quot;first_name&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;lastName&quot;</span> <span class="na">column=</span><span class="s">&quot;last_name&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;gender&quot;</span> <span class="na">column=</span><span class="s">&quot;gender&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;dateOfBirth&quot;</span> <span class="na">column=</span><span class="s">&quot;date_of_birth&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;emailAddress&quot;</span> <span class="na">column=</span><span class="s">&quot;email_address&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;telephoneNumber&quot;</span> <span class="na">column=</span><span class="s">&quot;telephone_number&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;zipCode&quot;</span> <span class="na">column=</span><span class="s">&quot;zip_code&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;address&quot;</span> <span class="na">column=</span><span class="s">&quot;address&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;createdAt&quot;</span> <span class="na">column=</span><span class="s">&quot;created_at&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;lastModifiedAt&quot;</span> <span class="na">column=</span><span class="s">&quot;last_modified_at&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;version&quot;</span> <span class="na">column=</span><span class="s">&quot;version&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;credential.memberId&quot;</span> <span class="na">column=</span><span class="s">&quot;member_id&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;credential.signId&quot;</span> <span class="na">column=</span><span class="s">&quot;sign_id&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;credential.password&quot;</span> <span class="na">column=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;credential.previousPassword&quot;</span> <span class="na">column=</span><span class="s">&quot;previous_password&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;credential.passwordLastChangedAt&quot;</span> <span class="na">column=</span><span class="s">&quot;password_last_changed_at&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;credential.lastModifiedAt&quot;</span> <span class="na">column=</span><span class="s">&quot;credential_last_modified_at&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;credential.version&quot;</span> <span class="na">column=</span><span class="s">&quot;credential_version&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/resultMap&gt;</span>

    <span class="nt">&lt;sql</span> <span class="na">id=</span><span class="s">&quot;selectMember&quot;</span><span class="nt">&gt;</span>
        SELECT
         member.member_id as member_id
         ,member.first_name as first_name
         ,member.last_name as last_name
         ,member.gender as gender
         ,member.date_of_birth as date_of_birth
         ,member.email_address as email_address
         ,member.telephone_number as telephone_number
         ,member.zip_code as zip_code
         ,member.address as address
         ,member.created_at as created_at
         ,member.last_modified_at as last_modified_at
         ,member.version as version
         ,credential.sign_id as sign_id
         ,credential.password as password
         ,credential.previous_password as previous_password
         ,credential.password_last_changed_at as password_last_changed_at
         ,credential.last_modified_at as credential_last_modified_at
         ,credential.version as credential_version
        FROM
         t_member member
         INNER JOIN t_member_credential credential ON credential.member_id = member.member_id
    <span class="nt">&lt;/sql&gt;</span>

    <span class="nt">&lt;sql</span> <span class="na">id=</span><span class="s">&quot;whereMember&quot;</span><span class="nt">&gt;</span>
        WHERE
            member.first_name LIKE #{nameContainingCondition} ESCAPE &#39;~&#39;
            OR member.last_name LIKE #{nameContainingCondition} ESCAPE &#39;~&#39;
    <span class="nt">&lt;/sql&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAll&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;RestMemberResultMap&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">&quot;selectRestMember&quot;</span> <span class="nt">/&gt;</span>
        ORDER BY member_id ASC
    <span class="nt">&lt;/select&gt;</span>

        <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;string&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;MemberResultMap&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">&quot;selectMember&quot;</span> <span class="nt">/&gt;</span>
        WHERE
        member.member_id = #{memberId}
    <span class="nt">&lt;/select&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;countByContainsName&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;string&quot;</span> <span class="na">resultType=</span><span class="s">&quot;_long&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;bind</span> <span class="na">name=</span><span class="s">&quot;nameContainingCondition&quot;</span>
        <span class="na">value=</span><span class="s">&quot;@org.terasoluna.gfw.common.query.QueryEscapeUtils@toStartingWithCondition(_parameter)&quot;</span> <span class="nt">/&gt;</span>
        SELECT
        COUNT(*)
        FROM
        t_member member
        <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">&quot;whereMember&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/select&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findPageByContainsName&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;string&quot;</span>
        <span class="na">resultMap=</span><span class="s">&quot;MemberResultMap&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;bind</span> <span class="na">name=</span><span class="s">&quot;nameContainingCondition&quot;</span>
        <span class="na">value=</span><span class="s">&quot;@org.terasoluna.gfw.common.query.QueryEscapeUtils@toStartingWithCondition(_parameter)&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">&quot;selectMember&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">&quot;whereMember&quot;</span> <span class="nt">/&gt;</span>
        ORDER BY member_id ASC
    <span class="nt">&lt;/select&gt;</span>

    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;createMember&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;Member&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;selectKey</span> <span class="na">keyProperty=</span><span class="s">&quot;memberId&quot;</span> <span class="na">resultType=</span><span class="s">&quot;string&quot;</span> <span class="na">order=</span><span class="s">&quot;BEFORE&quot;</span><span class="nt">&gt;</span>
            SELECT &#39;M&#39;||TO_CHAR(NEXTVAL(&#39;s_member&#39;),&#39;FM000000000&#39;)
        <span class="nt">&lt;/selectKey&gt;</span>
        INSERT INTO
        t_member
        (
        member_id
        ,first_name
        ,last_name
        ,gender
        ,date_of_birth
        ,email_address
        ,telephone_number
        ,zip_code
        ,address
        ,created_at
        ,last_modified_at
        ,version
        )
        VALUES
        (
        #{memberId}
        ,#{firstName}
        ,#{lastName}
        ,#{gender}
        ,#{dateOfBirth}
        ,#{emailAddress}
        ,#{telephoneNumber}
        ,#{zipCode}
        ,#{address}
        ,#{createdAt}
        ,#{lastModifiedAt}
        ,1
        )
    <span class="nt">&lt;/insert&gt;</span>

    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;createCredential&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;Member&quot;</span><span class="nt">&gt;</span>
        INSERT INTO
        t_member_credential
        (
        member_id
        ,sign_id
        ,password
        ,previous_password
        ,password_last_changed_at
        ,last_modified_at
        ,version
        )
        VALUES
        (
        #{memberId}
        ,#{credential.signId}
        ,#{credential.password}
        ,#{credential.previousPassword}
        ,#{credential.passwordLastChangedAt}
        ,#{credential.lastModifiedAt}
        ,1
        )
    <span class="nt">&lt;/insert&gt;</span>

    <span class="nt">&lt;update</span> <span class="na">id=</span><span class="s">&quot;updateMember&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;Member&quot;</span><span class="nt">&gt;</span>
        UPDATE
            t_member
        SET
            first_name = #{firstName}
            ,last_name = #{lastName}
            ,gender = #{gender}
            ,date_of_birth = #{dateOfBirth}
            ,email_address = #{emailAddress}
            ,telephone_number = #{telephoneNumber}
            ,zip_code = #{zipCode}
            ,address = #{address}
            ,created_at = #{createdAt}
            ,last_modified_at = #{lastModifiedAt}
            ,version = version + 1
        WHERE
            member_id = #{memberId}
            AND version = #{version}
    <span class="nt">&lt;/update&gt;</span>

    <span class="nt">&lt;delete</span> <span class="na">id=</span><span class="s">&quot;deleteCredential&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;string&quot;</span><span class="nt">&gt;</span>
        DELETE FROM t_member_credential
        WHERE
        member_id = #{memberId}
    <span class="nt">&lt;/delete&gt;</span>

    <span class="nt">&lt;delete</span> <span class="na">id=</span><span class="s">&quot;deleteMember&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;string&quot;</span><span class="nt">&gt;</span>
        DELETE FROM t_member
        WHERE
        member_id = #{memberId}
    <span class="nt">&lt;/delete&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="RestClient.html" title="5.17. RESTクライアント（HTTPクライアント）"
             >next</a> |</li>
        <li class="right" >
          <a href="Ajax.html" title="5.15. Ajax"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.1.0.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >5. TERASOLUNA Server Framework for Java (5.x)の機能詳細</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013-2016, NTT DATA.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3.Theme by <a href="http://github.com/vkvn">vkvn</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>

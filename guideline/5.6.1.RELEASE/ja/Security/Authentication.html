<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>9.2. 認証 &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.6.1.RELEASE documentation</title>
    <link rel="stylesheet" href="../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '5.6.1.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="9.3. 認可" href="Authorization.html" />
    <link rel="prev" title="9.1. Spring Security概要" href="SpringSecurity.html" /><script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="Authorization.html" title="9.3. 認可"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="SpringSecurity.html" title="9.1. Spring Security概要"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.6.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">9. セキュリティ対策</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">9.2. 認証</a><ul>
<li><a class="reference internal" href="#overview">9.2.1. Overview</a><ul>
<li><a class="reference internal" href="#id3">9.2.1.1. 認証処理のアーキテクチャ</a><ul>
<li><a class="reference internal" href="#authentication-filter">9.2.1.1.1. Authentication Filter</a></li>
<li><a class="reference internal" href="#authenticationmanager">9.2.1.1.2. AuthenticationManager</a></li>
<li><a class="reference internal" href="#authenticationprovider">9.2.1.1.3. AuthenticationProvider</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">9.2.2. How to use</a><ul>
<li><a class="reference internal" href="#form-login">9.2.2.1. フォーム認証</a><ul>
<li><a class="reference internal" href="#form-login-usage">9.2.2.1.1. フォーム認証の適用</a></li>
<li><a class="reference internal" href="#form-login-default-operation">9.2.2.1.2. デフォルトの動作</a></li>
<li><a class="reference internal" href="#springsecurityauthenticationloginform">9.2.2.1.3. ログインフォームの作成</a></li>
</ul>
</li>
<li><a class="reference internal" href="#springsecurityauthenticationscreenflowonsuccess">9.2.2.2. 認証成功時のレスポンス</a><ul>
<li><a class="reference internal" href="#id9">9.2.2.2.1. デフォルトの動作</a></li>
</ul>
</li>
<li><a class="reference internal" href="#springsecurityauthenticationscreenflowonfailure">9.2.2.3. 認証失敗時のレスポンス</a><ul>
<li><a class="reference internal" href="#id11">9.2.2.3.1. デフォルトの動作</a></li>
</ul>
</li>
<li><a class="reference internal" href="#db">9.2.2.4. DB認証</a><ul>
<li><a class="reference internal" href="#userdetails">9.2.2.4.1. UserDetailsの作成</a></li>
<li><a class="reference internal" href="#userdetailsservice">9.2.2.4.2. UserDetailsServiceの作成</a></li>
<li><a class="reference internal" href="#authenticationproviderconfiguration">9.2.2.4.3. DB認証の適用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#springsecurityauthenticationpasswordhashing">9.2.2.5. パスワードのハッシュ化</a><ul>
<li><a class="reference internal" href="#delegatingpasswordencoder">9.2.2.5.1. DelegatingPasswordEncoder</a></li>
</ul>
</li>
<li><a class="reference internal" href="#springsecurityauthenticationevent">9.2.2.6. 認証イベントのハンドリング</a><ul>
<li><a class="reference internal" href="#id15">9.2.2.6.1. 認証成功イベント</a></li>
<li><a class="reference internal" href="#id16">9.2.2.6.2. 認証失敗イベント</a></li>
<li><a class="reference internal" href="#springsecurityauthenticationeventlistener">9.2.2.6.3. イベントリスナの作成</a></li>
</ul>
</li>
<li><a class="reference internal" href="#springsecurityauthenticationlogout">9.2.2.7. ログアウト</a><ul>
<li><a class="reference internal" href="#id19">9.2.2.7.1. ログアウト処理の適用</a></li>
<li><a class="reference internal" href="#id20">9.2.2.7.2. デフォルトの動作</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id21">9.2.2.8. ログアウト成功時のレスポンス</a><ul>
<li><a class="reference internal" href="#id22">9.2.2.8.1. デフォルトの動作</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id23">9.2.2.9. ログアウト成功時の認証イベントのハンドリング</a><ul>
<li><a class="reference internal" href="#id24">9.2.2.9.1. ログアウト成功イベント</a></li>
</ul>
</li>
<li><a class="reference internal" href="#springsecurityauthenticationaccess">9.2.2.10. 認証情報へのアクセス</a><ul>
<li><a class="reference internal" href="#java">9.2.2.10.1. Javaからのアクセス</a></li>
<li><a class="reference internal" href="#jsp">9.2.2.10.2. JSPからのアクセス</a></li>
</ul>
</li>
<li><a class="reference internal" href="#spring-mvc">9.2.2.11. 認証処理とSpring MVCの連携</a><ul>
<li><a class="reference internal" href="#id26">9.2.2.11.1. 認証情報へのアクセス</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend">9.2.3. How to extend</a><ul>
<li><a class="reference internal" href="#springsecurityauthenticationcustomizingform">9.2.3.1. フォーム認証のカスタマイズ</a><ul>
<li><a class="reference internal" href="#id29">9.2.3.1.1. 認証パスの変更</a></li>
<li><a class="reference internal" href="#id30">9.2.3.1.2. 資格情報を送るリクエストパラメータ名の変更</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id31">9.2.3.2. 認証成功時のレスポンスのカスタマイズ</a><ul>
<li><a class="reference internal" href="#id32">9.2.3.2.1. デフォルト遷移先の変更</a></li>
<li><a class="reference internal" href="#id33">9.2.3.2.2. 遷移先の固定化</a></li>
<li><a class="reference internal" href="#authenticationsuccesshandler">9.2.3.2.3. AuthenticationSuccessHandlerの適用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#springsecurityauthenticationcustomizingscreenflowonfailure">9.2.3.3. 認証失敗時のレスポンスのカスタマイズ</a><ul>
<li><a class="reference internal" href="#id35">9.2.3.3.1. 遷移先の変更</a></li>
<li><a class="reference internal" href="#authenticationfailurehandler">9.2.3.3.2. AuthenticationFailureHandlerの適用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id36">9.2.3.4. ログアウト処理のカスタマイズ</a><ul>
<li><a class="reference internal" href="#id37">9.2.3.4.1. ログアウトパスの変更</a></li>
</ul>
</li>
<li><a class="reference internal" href="#springsecuritylogoutcustomizingscreenflowonsuccess">9.2.3.5. ログアウト成功時のレスポンスのカスタマイズ</a><ul>
<li><a class="reference internal" href="#id39">9.2.3.5.1. 遷移先の変更</a></li>
<li><a class="reference internal" href="#logoutsuccesshandler">9.2.3.5.2. LogoutSuccessHandlerの適用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#springsecurityauthenticationcustomizingmessage">9.2.3.6. エラーメッセージのカスタマイズ</a><ul>
<li><a class="reference internal" href="#id41">9.2.3.6.1. システムエラー時のメッセージ</a></li>
</ul>
</li>
<li><a class="reference internal" href="#springsecurityauthenticationbeanvalidation">9.2.3.7. 認証時の入力チェック</a><ul>
<li><a class="reference internal" href="#bean-validation">9.2.3.7.1. Bean Validationによる入力チェック</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id43">9.2.3.8. 認証処理の拡張</a><ul>
<li><a class="reference internal" href="#authentication">9.2.3.8.1. Authenticationインタフェースの実装クラスの作成</a></li>
<li><a class="reference internal" href="#id45">9.2.3.8.2. AuthenticationProviderインタフェースの実装クラスの作成</a></li>
<li><a class="reference internal" href="#authentication-custom-usernamepasswordauthenticationfilter">9.2.3.8.3. Authentication Filterの作成</a></li>
<li><a class="reference internal" href="#id47">9.2.3.8.4. ログインフォームの修正</a></li>
<li><a class="reference internal" href="#id48">9.2.3.8.5. 拡張した認証処理の適用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#passwordencoder">9.2.3.9. PasswordEncoderのカスタマイズ</a><ul>
<li><a class="reference internal" href="#pbkdf2passwordencoder">9.2.3.9.1. Pbkdf2PasswordEncoderのカスタマイズ</a></li>
</ul>
</li>
<li><a class="reference internal" href="#authenticationhowtoextendusingdeprecatedpasswordencoder">9.2.3.10. 非推奨アルゴリズムのPasswordEncoderの利用</a><ul>
<li><a class="reference internal" href="#messagedigestpasswordencoder">9.2.3.10.1. MessageDigestPasswordEncoderの利用</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix">9.2.4. Appendix</a><ul>
<li><a class="reference internal" href="#spring-security-authentication-mvc">9.2.4.1. Spring MVCでリクエストを受けてログインフォームを表示する</a></li>
<li><a class="reference internal" href="#remember-me">9.2.4.2. Remember Me認証の利用</a></li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="SpringSecurity.html"
                        title="previous chapter">9.1. Spring Security概要</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="Authorization.html"
                        title="next chapter">9.3. 認可</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/Security/Authentication.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="springsecurityauthentication">
<span id="id1"></span><h1>9.2. 認証<a class="headerlink" href="#springsecurityauthentication" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="id2">
<p class="topic-title">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id71">Overview</a><ul>
<li><a class="reference internal" href="#id3" id="id72">認証処理のアーキテクチャ</a><ul>
<li><a class="reference internal" href="#authentication-filter" id="id73">Authentication Filter</a></li>
<li><a class="reference internal" href="#authenticationmanager" id="id74">AuthenticationManager</a></li>
<li><a class="reference internal" href="#authenticationprovider" id="id75">AuthenticationProvider</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use" id="id76">How to use</a><ul>
<li><a class="reference internal" href="#form-login" id="id77">フォーム認証</a><ul>
<li><a class="reference internal" href="#form-login-usage" id="id78">フォーム認証の適用</a></li>
<li><a class="reference internal" href="#form-login-default-operation" id="id79">デフォルトの動作</a></li>
<li><a class="reference internal" href="#springsecurityauthenticationloginform" id="id80">ログインフォームの作成</a></li>
</ul>
</li>
<li><a class="reference internal" href="#springsecurityauthenticationscreenflowonsuccess" id="id81">認証成功時のレスポンス</a><ul>
<li><a class="reference internal" href="#id9" id="id82">デフォルトの動作</a></li>
</ul>
</li>
<li><a class="reference internal" href="#springsecurityauthenticationscreenflowonfailure" id="id83">認証失敗時のレスポンス</a><ul>
<li><a class="reference internal" href="#id11" id="id84">デフォルトの動作</a></li>
</ul>
</li>
<li><a class="reference internal" href="#db" id="id85">DB認証</a><ul>
<li><a class="reference internal" href="#userdetails" id="id86">UserDetailsの作成</a></li>
<li><a class="reference internal" href="#userdetailsservice" id="id87">UserDetailsServiceの作成</a></li>
<li><a class="reference internal" href="#authenticationproviderconfiguration" id="id88">DB認証の適用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#springsecurityauthenticationpasswordhashing" id="id89">パスワードのハッシュ化</a><ul>
<li><a class="reference internal" href="#delegatingpasswordencoder" id="id90">DelegatingPasswordEncoder</a></li>
</ul>
</li>
<li><a class="reference internal" href="#springsecurityauthenticationevent" id="id91">認証イベントのハンドリング</a><ul>
<li><a class="reference internal" href="#id15" id="id92">認証成功イベント</a></li>
<li><a class="reference internal" href="#id16" id="id93">認証失敗イベント</a></li>
<li><a class="reference internal" href="#springsecurityauthenticationeventlistener" id="id94">イベントリスナの作成</a></li>
</ul>
</li>
<li><a class="reference internal" href="#springsecurityauthenticationlogout" id="id95">ログアウト</a><ul>
<li><a class="reference internal" href="#id19" id="id96">ログアウト処理の適用</a></li>
<li><a class="reference internal" href="#id20" id="id97">デフォルトの動作</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id21" id="id98">ログアウト成功時のレスポンス</a><ul>
<li><a class="reference internal" href="#id22" id="id99">デフォルトの動作</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id23" id="id100">ログアウト成功時の認証イベントのハンドリング</a><ul>
<li><a class="reference internal" href="#id24" id="id101">ログアウト成功イベント</a></li>
</ul>
</li>
<li><a class="reference internal" href="#springsecurityauthenticationaccess" id="id102">認証情報へのアクセス</a><ul>
<li><a class="reference internal" href="#java" id="id103">Javaからのアクセス</a></li>
<li><a class="reference internal" href="#jsp" id="id104">JSPからのアクセス</a></li>
</ul>
</li>
<li><a class="reference internal" href="#spring-mvc" id="id105">認証処理とSpring MVCの連携</a><ul>
<li><a class="reference internal" href="#id26" id="id106">認証情報へのアクセス</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend" id="id107">How to extend</a><ul>
<li><a class="reference internal" href="#springsecurityauthenticationcustomizingform" id="id108">フォーム認証のカスタマイズ</a><ul>
<li><a class="reference internal" href="#id29" id="id109">認証パスの変更</a></li>
<li><a class="reference internal" href="#id30" id="id110">資格情報を送るリクエストパラメータ名の変更</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id31" id="id111">認証成功時のレスポンスのカスタマイズ</a><ul>
<li><a class="reference internal" href="#id32" id="id112">デフォルト遷移先の変更</a></li>
<li><a class="reference internal" href="#id33" id="id113">遷移先の固定化</a></li>
<li><a class="reference internal" href="#authenticationsuccesshandler" id="id114">AuthenticationSuccessHandlerの適用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#springsecurityauthenticationcustomizingscreenflowonfailure" id="id115">認証失敗時のレスポンスのカスタマイズ</a><ul>
<li><a class="reference internal" href="#id35" id="id116">遷移先の変更</a></li>
<li><a class="reference internal" href="#authenticationfailurehandler" id="id117">AuthenticationFailureHandlerの適用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id36" id="id118">ログアウト処理のカスタマイズ</a><ul>
<li><a class="reference internal" href="#id37" id="id119">ログアウトパスの変更</a></li>
</ul>
</li>
<li><a class="reference internal" href="#springsecuritylogoutcustomizingscreenflowonsuccess" id="id120">ログアウト成功時のレスポンスのカスタマイズ</a><ul>
<li><a class="reference internal" href="#id39" id="id121">遷移先の変更</a></li>
<li><a class="reference internal" href="#logoutsuccesshandler" id="id122">LogoutSuccessHandlerの適用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#springsecurityauthenticationcustomizingmessage" id="id123">エラーメッセージのカスタマイズ</a><ul>
<li><a class="reference internal" href="#id41" id="id124">システムエラー時のメッセージ</a></li>
</ul>
</li>
<li><a class="reference internal" href="#springsecurityauthenticationbeanvalidation" id="id125">認証時の入力チェック</a><ul>
<li><a class="reference internal" href="#bean-validation" id="id126">Bean Validationによる入力チェック</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id43" id="id127">認証処理の拡張</a><ul>
<li><a class="reference internal" href="#authentication" id="id128">Authenticationインタフェースの実装クラスの作成</a></li>
<li><a class="reference internal" href="#id45" id="id129">AuthenticationProviderインタフェースの実装クラスの作成</a></li>
<li><a class="reference internal" href="#authentication-custom-usernamepasswordauthenticationfilter" id="id130">Authentication Filterの作成</a></li>
<li><a class="reference internal" href="#id47" id="id131">ログインフォームの修正</a></li>
<li><a class="reference internal" href="#id48" id="id132">拡張した認証処理の適用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#passwordencoder" id="id133">PasswordEncoderのカスタマイズ</a><ul>
<li><a class="reference internal" href="#pbkdf2passwordencoder" id="id134">Pbkdf2PasswordEncoderのカスタマイズ</a></li>
</ul>
</li>
<li><a class="reference internal" href="#authenticationhowtoextendusingdeprecatedpasswordencoder" id="id135">非推奨アルゴリズムのPasswordEncoderの利用</a><ul>
<li><a class="reference internal" href="#messagedigestpasswordencoder" id="id136">MessageDigestPasswordEncoderの利用</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix" id="id137">Appendix</a><ul>
<li><a class="reference internal" href="#spring-security-authentication-mvc" id="id138">Spring MVCでリクエストを受けてログインフォームを表示する</a></li>
<li><a class="reference internal" href="#remember-me" id="id139">Remember Me認証の利用</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<span id="springsecurityauthenticationoverview"></span><h2><a class="toc-backref" href="#id71">9.2.1. Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>本節では、Spring Securityが提供している認証機能について説明する。</p>
<p>認証処理は、アプリケーションを利用するユーザーの正当性を確認するための処理である。</p>
<p>ユーザーの正当性を確認するためのもっとも標準的な方法は、アプリケーションを使用できるユーザーをデータストアに登録しておき、
利用者が入力した認証情報（ユーザー名とパスワードなど）と照合する方法である。
ユーザーの情報を登録しておくデータストアにはリレーショナルデータベースを利用するのが一般的だが、ディレクトリサービスや外部システムなどを利用するケースもある。</p>
<p>また、利用者に認証情報を入力してもらう方式もいくつか存在する。
HTMLの入力フォームを使う方式やRFCで定められているHTTP標準の認証方式(Basic認証やDigest認証など)を利用するのが一般的だが、
OpenID認証やシングルサインオン認証などの認証方式を利用するケースもある。</p>
<p>本節では、HTMLの入力フォームで入力した認証情報とリレーショナルデータベースに格納されているユーザー情報を照合して認証処理を行う実装例を紹介しながら、
Spring Securityの認証機能の使い方を説明する。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id72">9.2.1.1. 認証処理のアーキテクチャ</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>Spring Securityは、以下のような流れで認証処理を行う。</p>
<div class="figure" id="id53">
<a class="reference internal image-reference" href="../_images/AuthenticationArchitecture.png"><img alt="../_images/AuthenticationArchitecture.png" src="../_images/AuthenticationArchitecture.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>認証処理のアーキテクチャ</strong></span></p>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントは、認証処理を行うパスに対して資格情報（ユーザー名とパスワード）を指定してリクエストを送信する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Authentication Filterは、リクエストから資格情報を取得して、<code class="docutils literal"><span class="pre">AuthenticationManager</span></code>クラスの認証処理を呼び出す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ProviderManager</span></code>(デフォルトで使用される<code class="docutils literal"><span class="pre">AuthenticationManager</span></code>の実装クラス)は、実際の認証処理を<code class="docutils literal"><span class="pre">AuthenticationProvider</span></code>インタフェースの実装クラスに委譲する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="authentication-filter">
<span id="springsecurityauthenticationfilter"></span><h4><a class="toc-backref" href="#id73">9.2.1.1.1. Authentication Filter</a><a class="headerlink" href="#authentication-filter" title="Permalink to this headline">¶</a></h4>
<p>Authentication Filterは、認証方式に対する実装を提供するサーブレットフィルタである。
Spring Securityがサポートしている主な認証方式は以下の通り。</p>
<table border="1" class="colwidths-given docutils" id="id54">
<caption><span class="caption-text"><strong>Spring Securityが提供している主なAuthentication Filter</strong></span><a class="headerlink" href="#id54" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">クラス名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UsernamePasswordAuthenticationFilter</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フォーム認証用のサーブレットフィルタクラスで、HTTPリクエストのパラメータから資格情報を取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">BasicAuthenticationFilter</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Basic認証用のサーブレットフィルタクラスで、HTTPリクエストの認証ヘッダから資格情報を取得する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DigestAuthenticationFilter</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Digest認証用のサーブレットフィルタクラスで、HTTPリクエストの認証ヘッダから資格情報を取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RememberMeAuthenticationFilter</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Remember Me認証用のサーブレットフィルタクラスで、HTTPリクエストのCookieから資格情報を取得する。</div>
<div class="line">Remember Me認証を有効にすると、ブラウザを閉じたりセッションタイムアウトが発生しても、ログイン状態を保つことができる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>これらのサーブレットフィルタは、 <a class="reference internal" href="SpringSecurity.html#springsecurityprocess"><span class="std std-ref">フレームワーク処理</span></a>で紹介したAuthentication Filterの１つである。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Spring Securityによってサポートされていない認証方式を実現する必要がある場合は、
認証方式を実現するための<code class="docutils literal"><span class="pre">Authentication</span> <span class="pre">Filter</span></code>を作成し、Spring Securityに組み込むことで実現することが可能である。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="authenticationmanager">
<h4><a class="toc-backref" href="#id74">9.2.1.1.2. AuthenticationManager</a><a class="headerlink" href="#authenticationmanager" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">AuthenticationManager</span></code>は、認証処理を実行するためのインタフェースである。
Spring Securityが提供するデフォルト実装(<code class="docutils literal"><span class="pre">ProviderManager</span></code>)では、
実際の認証処理は<code class="docutils literal"><span class="pre">AuthenticationProvider</span></code>に委譲し、<code class="docutils literal"><span class="pre">AuthenticationProvider</span></code>で行われた認証処理の処理結果をハンドリングする仕組みになっている。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="authenticationprovider">
<h4><a class="toc-backref" href="#id75">9.2.1.1.3. AuthenticationProvider</a><a class="headerlink" href="#authenticationprovider" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">AuthenticationProvider</span></code>は、認証処理の実装を提供するためのインタフェースである。
Spring Securityが提供している主な<code class="docutils literal"><span class="pre">AuthenticationProvider</span></code>の実装クラスは以下の通り。</p>
<table border="1" class="colwidths-given docutils" id="id55">
<caption><span class="caption-text"><strong>Spring Securityが提供している主なAuthenticationProvider</strong></span><a class="headerlink" href="#id55" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">クラス名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DaoAuthenticationProvider</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">データストアに登録しているユーザーの資格情報とユーザーの状態をチェックして認証処理を行う実装クラス。</div>
<div class="line">チェックで必要となる資格情報とユーザーの状態は<code class="docutils literal"><span class="pre">UserDetails</span></code>というインタフェースを実装しているクラスから取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RememberMeAuthenticationProvider</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Remember Me認証用のTokenを検証する<code class="docutils literal"><span class="pre">AuthenticationProvider</span></code>の実装クラス。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Spring Securityが提供していない認証処理を実現する必要がある場合は、
認証処理を実現するための<code class="docutils literal"><span class="pre">AuthenticationProvider</span></code>を作成し、Spring Securityに組み込むことで実現することが可能である。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-use">
<span id="howtouse-springsecurity"></span><h2><a class="toc-backref" href="#id76">9.2.2. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<p>認証機能を使用するために必要となるbean定義例や実装方法について説明する。</p>
<p>本項では <a class="reference internal" href="#springsecurityauthenticationoverview"><span class="std std-ref">Overview</span></a>で説明したとおり、
HTMLの入力フォームで入力した認証情報とリレーショナルデータベースに格納されているユーザー情報を照合して認証処理を行う方法について説明する。</p>
<div class="section" id="form-login">
<span id="id4"></span><h3><a class="toc-backref" href="#id77">9.2.2.1. フォーム認証</a><a class="headerlink" href="#form-login" title="Permalink to this headline">¶</a></h3>
<p>Spring Securityは、以下のような流れでフォーム認証を行う。</p>
<div class="figure" id="id56">
<a class="reference internal image-reference" href="../_images/AuthenticationForm.png"><img alt="../_images/AuthenticationForm.png" src="../_images/AuthenticationForm.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>フォーム認証の仕組み</strong></span></p>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントは、フォーム認証を行うパスに対して資格情報（ユーザー名とパスワード）をリクエストパラメータとして送信する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UsernamePasswordAuthenticationFilter</span></code>クラスは、リクエストパラメータから資格情報を取得して、<code class="docutils literal"><span class="pre">AuthenticationManager</span></code>の認証処理を呼び出す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UsernamePasswordAuthenticationFilter</span></code>クラスは、<code class="docutils literal"><span class="pre">AuthenticationManager</span></code>から返却された認証結果をハンドリングする。</div>
<div class="line">認証処理が成功した場合は <code class="docutils literal"><span class="pre">AuthenticationSuccessHandler</span></code>のメソッドを呼び出し、認証処理が失敗した場合は<code class="docutils literal"><span class="pre">AuthenticationFailureHandler</span></code>のメソッドを呼び出し、画面遷移を行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="form-login-usage">
<span id="id5"></span><h4><a class="toc-backref" href="#id78">9.2.2.1.1. フォーム認証の適用</a><a class="headerlink" href="#form-login-usage" title="Permalink to this headline">¶</a></h4>
<p>フォーム認証を使用する場合は、以下のようなbean定義を行う。</p>
<ul class="simple">
<li>spring-security.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http&gt;</span>
    <span class="nt">&lt;sec:form-login</span> <span class="nt">/&gt;</span>    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;sec:form-login&gt;</span></code>タグを定義することで、フォーム認証が有効になる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>auto-config属性について</strong></p>
<p><code class="docutils literal"><span class="pre">&lt;sec:http&gt;</span></code>には、フォーム認証(<code class="docutils literal"><span class="pre">&lt;sec:form-login&gt;</span></code>タグ)、Basic認証(<code class="docutils literal"><span class="pre">&lt;sec:http-basic&gt;</span></code>タグ)、ログアウト(<code class="docutils literal"><span class="pre">&lt;sec:logout&gt;</span></code>タグ)に対するコンフィギュレーションを自動で行うか否かを指定する<code class="docutils literal"><span class="pre">auto-config</span></code>属性が用意されている。
デフォルト値は<code class="docutils literal"><span class="pre">false</span></code>(自動でコンフィギュレーションしない)となっており、Spring Securityのリファレンスドキュメントでもデフォルト値の使用が推奨されている。</p>
<p>本ガイドラインでも、明示的にタグを指定するスタイルを推奨する。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">要素名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;form-login&gt;</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フォーム認証処理を行うSecurity Filter(<code class="docutils literal"><span class="pre">UsernamePasswordAuthenticationFilter</span></code>)が適用される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;http-basic&gt;</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">RFC1945に準拠したBasic認証を行うSecurity Filter(<code class="docutils literal"><span class="pre">BasicAuthenticationFilter</span></code>)が適用される。</div>
<div class="line">詳細な利用方法は、<a class="reference external" href="https://docs.spring.io/spring-security/site/docs/5.2.1.RELEASE/api/org/springframework/security/web/authentication/www/BasicAuthenticationFilter.html">BasicAuthenticationFilterのJavaDoc</a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;logout&gt;</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ログアウト処理を行うSecurity Filter(<code class="docutils literal"><span class="pre">LogoutFilter</span></code>)が適用される。</div>
<div class="line">ログアウト処理の詳細については、「<a class="reference internal" href="#springsecurityauthenticationlogout"><span class="std std-ref">ログアウト</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p class="last">なお、 <code class="docutils literal"><span class="pre">auto-config</span></code>を定義しない場合は、フォーム認証(<code class="docutils literal"><span class="pre">&lt;sec:form-login&gt;</span></code>タグ)、もしくはBasic認証(<code class="docutils literal"><span class="pre">&lt;sec:http-basic&gt;</span></code>タグ)を定義する必要がある。
これは、ひとつの<code class="docutils literal"><span class="pre">SecurityFilterChain</span></code>(<code class="docutils literal"><span class="pre">&lt;sec:http&gt;</span></code>)内には、ひとつ以上のAuthentication FilterのBean定義が必要であるという、Spring Securityの仕様をみたすためである。</p>
</div>
</div>
<div class="section" id="form-login-default-operation">
<span id="id6"></span><h4><a class="toc-backref" href="#id79">9.2.2.1.2. デフォルトの動作</a><a class="headerlink" href="#form-login-default-operation" title="Permalink to this headline">¶</a></h4>
<p>Spring Securityのデフォルトの動作では、<code class="docutils literal"><span class="pre">/login</span></code>に対してGETメソッドでアクセスするとSpring Securityが用意しているデフォルトのログインフォームが表示され、
ログインボタンを押下すると<code class="docutils literal"><span class="pre">/login</span></code>に対してPOSTメソッドでアクセスして認証処理を行う。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="springsecurityauthenticationloginform">
<span id="id7"></span><h4><a class="toc-backref" href="#id80">9.2.2.1.3. ログインフォームの作成</a><a class="headerlink" href="#springsecurityauthenticationloginform" title="Permalink to this headline">¶</a></h4>
<p>Spring Securityはフォーム認証用のログインフォームをデフォルトで提供しているが、そのまま利用するケースは少ない。
ここでは、自身で作成したログインフォームをSpring Securityに適用する方法を説明する。</p>
<p>まず、ログインフォームを表示するためのJSPを作成する。
ここでは、Spring MVCでリクエストをうけてログインフォームを表示する際の実装例になっている。</p>
<ul class="simple">
<li>ログインフォームを表示するためのJSPの作成例(xxx-web/src/main/webapp/WEB-INF/views/login/loginForm.jsp)</li>
</ul>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="k">&lt;%@</span> <span class="n">page</span> <span class="n">contentType</span><span class="o">=</span><span class="s">&quot;text/html;charset=UTF-8&quot;</span> <span class="n">pageEncoding</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span> <span class="k">%&gt;</span>
<span class="k">&lt;%@</span> <span class="n">taglib</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;c&quot;</span> <span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://java.sun.com/jsp/jstl/core&quot;</span> <span class="k">%&gt;</span>
<span class="k">&lt;%@</span> <span class="n">taglib</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;sec&quot;</span> <span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://www.springframework.org/security/tags&quot;</span> <span class="k">%&gt;</span>
<span class="k">&lt;%-</span><span class="o">-</span> <span class="n">omitted</span> <span class="o">--</span><span class="k">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h3&gt;</span>Login Screen<span class="nt">&lt;/h3&gt;</span>
    <span class="k">&lt;%-</span><span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">--</span><span class="k">%&gt;</span>
    <span class="nt">&lt;c:if</span> <span class="na">test=</span><span class="s">&quot;${param.containsKey(&#39;error&#39;)}&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;t:messagesPanel</span> <span class="na">messagesType=</span><span class="s">&quot;error&quot;</span>
            <span class="na">messagesAttributeName=</span><span class="s">&quot;SPRING_SECURITY_LAST_EXCEPTION&quot;</span><span class="nt">/&gt;</span> <span class="k">&lt;%-</span><span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">--</span><span class="k">%&gt;</span>
    <span class="nt">&lt;/c:if&gt;</span>
    <span class="nt">&lt;form:form</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/login&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span> <span class="k">&lt;%-</span><span class="o">-</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">--</span><span class="k">%&gt;</span>
        <span class="nt">&lt;table&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;username&quot;</span><span class="nt">&gt;</span>User Name<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">id=</span><span class="s">&quot;username&quot;</span> <span class="na">name=</span><span class="s">&quot;username&quot;</span><span class="nt">&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;password&quot;</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="na">id=</span><span class="s">&quot;password&quot;</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span><span class="nt">&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
                <span class="nt">&lt;td&gt;</span><span class="ni">&amp;nbsp;</span><span class="nt">&lt;/td&gt;</span>
                <span class="nt">&lt;td&gt;&lt;button&gt;</span>Login<span class="nt">&lt;/button&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;/table&gt;</span>
    <span class="nt">&lt;/form:form&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="k">&lt;%-</span><span class="o">-</span> <span class="n">omitted</span> <span class="o">--</span><span class="k">%&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証エラーを表示するためのエリア。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証エラー時に出力させる例外メッセージを出力する。</div>
<div class="line">共通ライブラリで提供している<code class="docutils literal"><span class="pre">&lt;t:messagesPanel&gt;</span></code>タグを使用して出力することを推奨する。</div>
<div class="line"><code class="docutils literal"><span class="pre">&lt;t:messagesPanel&gt;</span></code>タグの使用方法については、「<a class="reference internal" href="../ArchitectureInDetail/WebApplicationDetail/MessageManagement.html"><span class="doc">メッセージ管理</span></a>」を参照されたい。</div>
<div class="line">なお、認証エラーが発生した場合、Spring Securityのデフォルトの設定で使用される、<code class="docutils literal"><span class="pre">org.springframework.security.web.authentication.SimpleUrlAuthenticationFailureHandler</span></code>では、認証エラー時に発生した例外オブジェクトを<code class="docutils literal"><span class="pre">SPRING_SECURITY_LAST_EXCEPTION</span></code>という属性名で、リダイレクト時はセッション、フォワード時はリクエストスコープに格納する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザー名とパスワードを入力するためのログインフォーム。</div>
<div class="line">ここではユーザー名を<code class="docutils literal"><span class="pre">username</span></code>、パスワードを<code class="docutils literal"><span class="pre">passowrd</span></code>というリクエストパラメータで送信する。</div>
<div class="line">また、<code class="docutils literal"><span class="pre">&lt;form:form&gt;</span></code>を使用することで、CSRF対策用のトークン値がリクエストパラメータで送信される。</div>
<div class="line">CSRF対策については、「<a class="reference internal" href="CSRF.html#springsecuritycsrf"><span class="std std-ref">CSRF対策</span></a>」で説明する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>つぎに、作成したログインフォームをSpring Securityに適用する。</p>
<ul class="simple">
<li>spring-security.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http&gt;</span>
    <span class="nt">&lt;sec:form-login</span>
        <span class="na">login-page=</span><span class="s">&quot;/login/loginForm&quot;</span>
        <span class="na">login-processing-url=</span><span class="s">&quot;/login&quot;</span>  <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1)(2) --&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/login/**&quot;</span> <span class="na">access=</span><span class="s">&quot;permitAll&quot;</span><span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/**&quot;</span> <span class="na">access=</span><span class="s">&quot;isAuthenticated()&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">login-page</span></code>属性にログインフォームを表示するためのパスを指定する。</div>
<div class="line">匿名ユーザーが認証を必要とするWebリソースにアクセスした場合は、この属性に指定したパスにリダイレクトしてログインフォームを表示する。</div>
<div class="line">ここでは、Spring MVCでリクエストを受けてログインフォームを表示している。</div>
<div class="line">詳細は 「<a class="reference internal" href="#spring-security-authentication-mvc"><span class="std std-ref">Spring MVCでリクエストを受けてログインフォームを表示する</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">login-processing-url</span></code>属性に認証処理を行うためのパスを指定する。</div>
<div class="line">デフォルトのパスも<code class="docutils literal"><span class="pre">/login</span></code>であるが、ここでは明示的に指定することとする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ログインフォームが格納されている<code class="docutils literal"><span class="pre">/login</span></code>パス配下に対し、すべてのユーザーがアクセスできる権限を付与する。</div>
<div class="line">Webリソースに対してアクセスポリシーの指定方法については、「<a class="reference internal" href="Authorization.html#springsecurityauthorization"><span class="std std-ref">認可</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アプリケーションで扱うWebリソースに対してアクセス権を付与する。</div>
<div class="line">上記例では、Webアプリケーションのルートパスの配下に対して、認証済みユーザーのみがアクセスできる権限を付与している。</div>
<div class="line">Webリソースに対してアクセスポリシーの指定方法については、「<a class="reference internal" href="Authorization.html#springsecurityauthorization"><span class="std std-ref">認可</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="springsecurityauthenticationscreenflowonsuccess">
<span id="id8"></span><h3><a class="toc-backref" href="#id81">9.2.2.2. 認証成功時のレスポンス</a><a class="headerlink" href="#springsecurityauthenticationscreenflowonsuccess" title="Permalink to this headline">¶</a></h3>
<p>Spring Securityは、認証成功時のレスポンスを制御するためのコンポーネントとして、
<code class="docutils literal"><span class="pre">AuthenticationSuccessHandler</span></code>というインタフェースと実装クラスを提供している。</p>
<table border="1" class="colwidths-given docutils" id="id57">
<caption><span class="caption-text"><strong>主なAuthenticationSuccessHandlerの実装クラス</strong></span><a class="headerlink" href="#id57" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">実装クラス</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">SavedRequestAwareAuthenticationSuccessHandler</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証前にアクセスを試みたURLにリダイレクトを行う実装クラス。</div>
<div class="line"><strong>デフォルトで使用される実装クラス。</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">SimpleUrlAuthenticationSuccessHandler</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">defaultTargetUrl</span></code>にリダイレクト又はフォワードを行う実装クラス。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="section" id="id9">
<h4><a class="toc-backref" href="#id82">9.2.2.2.1. デフォルトの動作</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<p>Spring Securityのデフォルトの動作では、認証前にアクセスを拒否したリクエストをHTTPセッションに保存しておいて、
認証が成功した際にアクセスを拒否したリクエストを復元してリダイレクトする。
認証したユーザーにリダイレクト先へのアクセス権があればページが表示され、アクセス権がなければ認可エラーとなる。
この動作を実現するために使用されるのが、<code class="docutils literal"><span class="pre">SavedRequestAwareAuthenticationSuccessHandler</span></code>クラスである。</p>
<p>ログインフォームを明示的に表示してから認証処理を行った後の遷移先は、Spring Securityのデフォルトの設定では
Webアプリケーションのルートパス(“<code class="docutils literal"><span class="pre">/</span></code>” )となっているため、認証成功時はWebアプリケーションのルートパスにリダイレクトされる。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="springsecurityauthenticationscreenflowonfailure">
<span id="id10"></span><h3><a class="toc-backref" href="#id83">9.2.2.3. 認証失敗時のレスポンス</a><a class="headerlink" href="#springsecurityauthenticationscreenflowonfailure" title="Permalink to this headline">¶</a></h3>
<p>Spring Securityは、認証失敗時のレスポンスを制御するためのコンポーネントとして、
<code class="docutils literal"><span class="pre">AuthenticationFailureHandler</span></code>というインタフェースと実装クラスを提供している。</p>
<table border="1" class="colwidths-given docutils" id="id58">
<caption><span class="caption-text"><strong>主なAuthenticationFailureHandlerの実装クラス</strong></span><a class="headerlink" href="#id58" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">実装クラス</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">SimpleUrlAuthenticationFailureHandler</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">指定したパス(<code class="docutils literal"><span class="pre">defaultFailureUrl</span></code>)にリダイレクト又はフォワードを行う実装クラス。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ExceptionMappingAuthenticationFailureHandler</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証例外と遷移先のURLをマッピングすることができる実装クラス。</div>
<div class="line">Spring Securityはエラー原因毎に発生する例外クラスが異なるため、この実装クラスを使用するとエラーの種類毎に遷移先を切り替えることが可能である。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DelegatingAuthenticationFailureHandler</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証例外と<code class="docutils literal"><span class="pre">AuthenticationFailureHandler</span></code>をマッピングすることができる実装クラス。</div>
<div class="line"><code class="docutils literal"><span class="pre">ExceptionMappingAuthenticationFailureHandler</span></code>と似ているが、認証例外毎に<code class="docutils literal"><span class="pre">AuthenticationFailureHandler</span></code>を指定できるので、より柔軟な振る舞いをサポートすることができる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="section" id="id11">
<h4><a class="toc-backref" href="#id84">9.2.2.3.1. デフォルトの動作</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<p>Spring Securityのデフォルトの動作では、ログインフォームを表示するためのパスに<code class="docutils literal"><span class="pre">error</span></code>というクエリパラメータが付与されたURLにリダイレクトする。</p>
<p>例として、ログインフォームを表示するためのパスが<code class="docutils literal"><span class="pre">/login</span></code>の場合は<code class="docutils literal"><span class="pre">/login?error</span></code>にリダイレクトされる。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="db">
<h3><a class="toc-backref" href="#id85">9.2.2.4. DB認証</a><a class="headerlink" href="#db" title="Permalink to this headline">¶</a></h3>
<p>Spring Securityは、以下のような流れでDB認証を行う。</p>
<div class="figure" id="id59">
<a class="reference internal image-reference" href="../_images/AuthenticationDatabase.png"><img alt="../_images/AuthenticationDatabase.png" src="../_images/AuthenticationDatabase.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>DB認証の仕組み</strong></span></p>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring Securityはクライアントからの認証依頼を受け、<code class="docutils literal"><span class="pre">DaoAuthenticationProvider</span></code>の認証処理を呼び出す。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DaoAuthenticationProvider</span></code>は、<code class="docutils literal"><span class="pre">UserDetailsService</span></code>のユーザー情報取得処理を呼び出す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UserDetailsService</span></code>の実装クラスは、データストアからユーザー情報を取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UserDetailsService</span></code>の実装クラスは、データストアから取得したユーザー情報から<code class="docutils literal"><span class="pre">UserDetails</span></code>を生成する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DaoAuthenticationProvider</span></code>は、<code class="docutils literal"><span class="pre">UserDetailsService</span></code>から返却された<code class="docutils literal"><span class="pre">UserDetails</span></code>とクライアントが指定した認証情報との照合を行い、クライアントが指定したユーザーの正当性をチェックする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Spring Securityが提供するDB認証</strong></p>
<p>Spring Securityは、ユーザー情報をリレーショナルデータベースからJDBC経由で取得するための実装クラスを提供している。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">org.springframework.security.core.userdetails.User</span></code>(<code class="docutils literal"><span class="pre">UserDetails</span></code>の実装クラス)</li>
<li><code class="docutils literal"><span class="pre">org.springframework.security.core.userdetails.jdbc.JdbcDaoImpl</span></code> (<code class="docutils literal"><span class="pre">UserDetailsService</span></code>の実装クラス)</li>
</ul>
<p class="last">これらの実装クラスは最低限の認証処理(パスワードの照合、有効ユーザーの判定)しか行わないため、そのまま利用できるケースは少ない。
そのため、本ガイドラインでは、<code class="docutils literal"><span class="pre">UserDetails</span></code>と<code class="docutils literal"><span class="pre">UserDetailsService</span></code>の実装クラスを作成する方法について説明する。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="userdetails">
<h4><a class="toc-backref" href="#id86">9.2.2.4.1. UserDetailsの作成</a><a class="headerlink" href="#userdetails" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">UserDetails</span></code>は、認証処理で必要となる資格情報(ユーザー名とパスワード)とユーザーの状態を提供するためのインタフェースで、以下のメソッドが定義されている。
<code class="docutils literal"><span class="pre">AuthenticationProvider</span></code>として<code class="docutils literal"><span class="pre">DaoAuthenticationProvider</span></code>を使用する場合は、アプリケーションの要件に合わせて<code class="docutils literal"><span class="pre">UserDetails</span></code>の実装クラスを作成する。</p>
<p><em>UserDetailsインタフェース</em></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDetails</span> <span class="kd">extends</span> <span class="n">Serializable</span> <span class="p">{</span>
    <span class="n">String</span> <span class="nf">getUsername</span><span class="p">();</span> <span class="c1">// (1)</span>
    <span class="n">String</span> <span class="nf">getPassword</span><span class="p">();</span> <span class="c1">// (2)</span>
    <span class="kt">boolean</span> <span class="nf">isEnabled</span><span class="p">();</span> <span class="c1">// (3)</span>
    <span class="kt">boolean</span> <span class="nf">isAccountNonLocked</span><span class="p">();</span> <span class="c1">// (4)</span>
    <span class="kt">boolean</span> <span class="nf">isAccountNonExpired</span><span class="p">();</span> <span class="c1">// (5)</span>
    <span class="kt">boolean</span> <span class="nf">isCredentialsNonExpired</span><span class="p">();</span> <span class="c1">// (6)</span>
    <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="p">();</span> <span class="c1">// (7)</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="25%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">メソッド名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">getUsername</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザー名を返却する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">getPassword</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">登録されているパスワードを返却する。</div>
<div class="line">このメソッドで返却したパスワードとクライアントから指定されたパスワードが一致しない場合は、<code class="docutils literal"><span class="pre">DaoAuthenticationProvider</span></code>は<code class="docutils literal"><span class="pre">BadCredentialsException</span></code>を発生させる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">isEnabled</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">有効なユーザーかを判定する。有効な場合は<code class="docutils literal"><span class="pre">true</span></code>を返却する。</div>
<div class="line">無効なユーザーの場合は、<code class="docutils literal"><span class="pre">DaoAuthenticationProvider</span></code>は<code class="docutils literal"><span class="pre">DisabledException</span></code>を発生させる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">isAccountNonLocked</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウントのロック状態を判定する。ロックされていない場合は<code class="docutils literal"><span class="pre">true</span></code>を返却する。</div>
<div class="line">アカウントがロックされている場合は、<code class="docutils literal"><span class="pre">DaoAuthenticationProvider</span></code>は<code class="docutils literal"><span class="pre">LockedException</span></code>を発生させる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">isAccountNonExpired</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウントの有効期限の状態を判定する。有効期限内の場合は<code class="docutils literal"><span class="pre">true</span></code>を返却する。</div>
<div class="line">有効期限切れの場合は、<code class="docutils literal"><span class="pre">DaoAuthenticationProvider</span></code>は<code class="docutils literal"><span class="pre">AccountExpiredException</span></code>を発生させる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">isCredentialsNonExpired</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">資格情報の有効期限の状態を判定する。有効期限内の場合は<code class="docutils literal"><span class="pre">true</span></code>を返却する。</div>
<div class="line">有効期限切れの場合は、<code class="docutils literal"><span class="pre">DaoAuthenticationProvider</span></code>は<code class="docutils literal"><span class="pre">CredentialsExpiredException</span></code>を発生させる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">getAuthorities</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザーに与えられている権限リストを返却する。</div>
<div class="line">このメソッドは認可処理で使用される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>認証例外による遷移先の切り替え</strong></p>
<p><code class="docutils literal"><span class="pre">DaoAuthenticationProvider</span></code>が発生させる例外毎に画面遷移を切り替えたい場合は、
<code class="docutils literal"><span class="pre">AuthenticationFailureHandler</span></code>として<code class="docutils literal"><span class="pre">ExceptionMappingAuthenticationFailureHandler</span></code>を使用すると実現することができる。</p>
<p>例として、ユーザーのパスワードの有効期限が切れた際にパスワード変更画面に遷移させたい場合は、
<code class="docutils literal"><span class="pre">ExceptionMappingAuthenticationFailureHandler</span></code>を使って<code class="docutils literal"><span class="pre">CredentialsExpiredException</span></code>をハンドリングすると画面遷移を切り替えることができる。</p>
<p class="last">詳細は、<a class="reference internal" href="#springsecurityauthenticationcustomizingscreenflowonfailure"><span class="std std-ref">認証失敗時のレスポンスのカスタマイズ</span></a>を参照されたい。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Spring Securityが提供する資格情報</strong></p>
<p class="last">Spring Securityは、資格情報(ユーザー名とパスワード)とユーザーの状態を保持するための実装クラス(<code class="docutils literal"><span class="pre">org.springframework.security.core.userdetails.User</span></code>)を提供しているが、
このクラスは認証処理に必要な情報しか保持することができない。
一般的なアプリケーションでは、認証処理で使用しないユーザーの情報（ユーザーの氏名など）も必要になるケースが多いため、<code class="docutils literal"><span class="pre">User</span></code>クラスをそのまま利用できるケースは少ない。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>ここでは、アカウントの情報を保持する<code class="docutils literal"><span class="pre">UserDetails</span></code>の実装クラスを作成する。
本例は<code class="docutils literal"><span class="pre">User</span></code>を継承することでも実現することができるが、<code class="docutils literal"><span class="pre">UserDetails</span></code> を実装する方法の例として紹介している。</p>
<ul class="simple">
<li>UserDetailsの実装クラスの作成例</li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountUserDetails</span> <span class="kd">implements</span> <span class="n">UserDetails</span> <span class="p">{</span> <span class="c1">// (1)</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Account</span> <span class="n">account</span><span class="p">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">AccountUserDetails</span><span class="p">(</span>
        <span class="n">Account</span> <span class="n">account</span><span class="p">,</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// (2)</span>
        <span class="k">this</span><span class="p">.</span><span class="na">account</span> <span class="o">=</span> <span class="n">account</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="na">authorities</span> <span class="o">=</span> <span class="n">authorities</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (3)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getPassword</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">account</span><span class="p">.</span><span class="na">getPassword</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getUsername</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">account</span><span class="p">.</span><span class="na">getUsername</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEnabled</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">account</span><span class="p">.</span><span class="na">isEnabled</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">authorities</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (4)</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isAccountNonExpired</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isAccountNonLocked</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isCredentialsNonExpired</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (5)</span>
    <span class="kd">public</span> <span class="n">Account</span> <span class="nf">getAccount</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">account</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UserDetails</span></code>インタフェースを実装したクラスを作成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザー情報と権限情報をプロパティに保持する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UserDetails</span></code>インタフェースに定義されているメソッドを実装する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本節の例では、「アカウントのロック」「アカウントの有効期限切れ」「資格情報の有効期限切れ」に対するチェックは未実装であるが、要件に合わせて実装されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証処理成功後の処理でアカウント情報にアクセスできるようにするために、getterメソッドを用意する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Spring Securityは、<code class="docutils literal"><span class="pre">UserDetails</span></code>の実装クラスとして<code class="docutils literal"><span class="pre">User</span></code>クラスを提供している。
<code class="docutils literal"><span class="pre">User</span></code>クラスを継承すると資格情報とユーザーの状態を簡単に保持することができる。</p>
<ul class="simple">
<li>Userクラスを継承したUserDetails実装クラスの作成例</li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountUserDetails</span> <span class="kd">extends</span> <span class="n">User</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Account</span> <span class="n">account</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">AccountUserDetails</span><span class="p">(</span><span class="n">Account</span> <span class="n">account</span><span class="p">,</span> <span class="kt">boolean</span> <span class="n">accountNonExpired</span><span class="p">,</span>
            <span class="kt">boolean</span> <span class="n">credentialsNonExpired</span><span class="p">,</span> <span class="kt">boolean</span> <span class="n">accountNonLocked</span><span class="p">,</span>
            <span class="n">Collection</span><span class="o">&lt;</span><span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">super</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getUsername</span><span class="p">(),</span> <span class="n">account</span><span class="p">.</span><span class="na">getPassword</span><span class="p">(),</span>
                <span class="n">account</span><span class="p">.</span><span class="na">isEnabled</span><span class="p">(),</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="n">authorities</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="na">account</span> <span class="o">=</span> <span class="n">account</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">Account</span> <span class="nf">getAccount</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">account</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="userdetailsservice">
<span id="springsecurityauthenticationuserdetailsservice"></span><h4><a class="toc-backref" href="#id87">9.2.2.4.2. UserDetailsServiceの作成</a><a class="headerlink" href="#userdetailsservice" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">UserDetailsService</span></code>は、認証処理で必要となる資格情報とユーザーの状態をデータストア
から取得するためのインタフェースで、以下のメソッドが定義されている。
<code class="docutils literal"><span class="pre">AuthenticationProvider</span></code>として<code class="docutils literal"><span class="pre">DaoAuthenticationProvider</span></code>を使用する場合は、
アプリケーションの要件に合わせて<code class="docutils literal"><span class="pre">UserDetailsService</span></code>の実装クラスを作成する。</p>
<ul class="simple">
<li>UserDetailsServiceインタフェース</li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDetailsService</span> <span class="p">{</span>
    <span class="n">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="p">(</span><span class="n">String</span> <span class="n">username</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">UsernameNotFoundException</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>ここでは、データベースからアカウント情報を検索して、<code class="docutils literal"><span class="pre">UserDetails</span></code>のインスタンス
を生成するためのサービスクラスを作成する。
本サンプルでは、<code class="docutils literal"><span class="pre">SharedService</span></code>を使用して、アカウント情報を取得している。
<code class="docutils literal"><span class="pre">SharedService</span></code>については、<a class="reference internal" href="../ImplementationAtEachLayer/DomainLayer.html#service-label"><span class="std std-ref">Serviceの実装</span></a>を参照されたい。</p>
<ul class="simple">
<li>AccountSharedServiceインタフェースの作成例</li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AccountSharedService</span> <span class="p">{</span>
    <span class="n">Account</span> <span class="nf">findOne</span><span class="p">(</span><span class="n">String</span> <span class="n">username</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li>AccountSharedServiceの実装クラスの作成例</li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountSharedServiceImpl</span> <span class="kd">implements</span> <span class="n">AccountSharedService</span> <span class="p">{</span>
    <span class="nd">@Inject</span>
    <span class="n">AccountRepository</span> <span class="n">accountRepository</span><span class="p">;</span>

    <span class="c1">// (2)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Account</span> <span class="nf">findOne</span><span class="p">(</span><span class="n">String</span> <span class="n">username</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">accountRepository</span><span class="p">.</span><span class="na">findOneByUsername</span><span class="p">(</span><span class="n">username</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">account</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">ResourceNotFoundException</span><span class="p">(</span><span class="s">&quot;The given account is not found! username=&quot;</span>
                    <span class="o">+</span> <span class="n">username</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">account</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AccountSharedService</span></code>インタフェースを実装したクラスを作成し、<code class="docutils literal"><span class="pre">&#64;Service</span></code>を付与する。</div>
<div class="line">上記例では、コンポーネントスキャン機能を使って<code class="docutils literal"><span class="pre">AccountSharedServiceImpl</span></code>をDIコンテナに登録している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">データベースからアカウント情報を検索する。</div>
<div class="line">アカウント情報が見つからない場合は、共通ライブラリの例外である<code class="docutils literal"><span class="pre">ResourceNotFoundException</span></code>を発生させる。</div>
<div class="line">Repositoryの作成例については、「<a class="reference internal" href="../Tutorial/TutorialSecurity.html"><span class="doc">Spring Securityチュートリアル</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
<ul class="simple">
<li>UserDetailsServiceの実装クラスの作成例</li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountUserDetailsService</span> <span class="kd">implements</span> <span class="n">UserDetailsService</span> <span class="p">{</span>
    <span class="nd">@Inject</span>
    <span class="n">AccountSharedService</span> <span class="n">accountSharedService</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="p">(</span><span class="n">String</span> <span class="n">username</span><span class="p">)</span>
            <span class="kd">throws</span> <span class="n">UsernameNotFoundException</span> <span class="p">{</span>

        <span class="k">try</span> <span class="p">{</span>
            <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">accountSharedService</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">username</span><span class="p">);</span>
            <span class="c1">// (2)</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">AccountUserDetails</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">getAuthorities</span><span class="p">(</span><span class="n">account</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">ResourceNotFoundException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// (3)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">UsernameNotFoundException</span><span class="p">(</span><span class="s">&quot;user not found&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// (4)</span>
    <span class="kd">private</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="p">(</span><span class="n">Account</span> <span class="n">account</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">isAdmin</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">AuthorityUtils</span><span class="p">.</span><span class="na">createAuthorityList</span><span class="p">(</span><span class="s">&quot;ROLE_USER&quot;</span><span class="p">,</span> <span class="s">&quot;ROLE_ADMIN&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">AuthorityUtils</span><span class="p">.</span><span class="na">createAuthorityList</span><span class="p">(</span><span class="s">&quot;ROLE_USER&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UserDetailsService</span></code>インタフェースを実装したクラスを作成し、<code class="docutils literal"><span class="pre">&#64;Service</span></code>を付与する。</div>
<div class="line">上記例では、コンポーネントスキャン機能を使って<code class="docutils literal"><span class="pre">UserDetailsService</span></code>をDIコンテナに登録している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AccountSharedService</span></code>を使用してアカウント情報を取得する。</div>
<div class="line">アカウント情報が見つかった場合は、<code class="docutils literal"><span class="pre">UserDetails</span></code>を生成する。</div>
<div class="line">上記例では、ユーザー名、パスワード、ユーザーの有効状態をアカウント情報から取得している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウント情報が見つからない場合は、<code class="docutils literal"><span class="pre">UsernameNotFoundException</span></code>を発生させる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザーが保持する権限(ロール)情報を生成する。ここで生成した権限(ロール)情報は、認可処理で使用される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>認可で使用する権限情報</strong></p>
<p class="last">Spring Securityの認可処理は、<code class="docutils literal"><span class="pre">ROLE_</span></code>で始まる権限情報をロールとして扱う。
そのため、ロールを使用してリソースへのアクセス制御を行う場合は、 ロールとして扱う権限情報に<code class="docutils literal"><span class="pre">ROLE_</span></code>プレフィックスを付与する必要がある。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>認証例外情報の隠蔽</strong></p>
<p class="last">Spring Securityのデフォルトの動作では、<code class="docutils literal"><span class="pre">UsernameNotFoundException</span></code>は<code class="docutils literal"><span class="pre">BadCredentialsException</span></code>という例外に変換してからエラー処理を行う。
<code class="docutils literal"><span class="pre">BadCredentialsException</span></code>は、クライアントから指定された資格情報のいずれかの項目に誤りがあることを通知するための例外であり、具体的なエラー理由がクライアントに通知されることはない。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="authenticationproviderconfiguration">
<span id="id12"></span><h4><a class="toc-backref" href="#id88">9.2.2.4.3. DB認証の適用</a><a class="headerlink" href="#authenticationproviderconfiguration" title="Permalink to this headline">¶</a></h4>
<p>作成した<code class="docutils literal"><span class="pre">UserDetailsService</span></code>を使用して認証処理を行うためには、
<code class="docutils literal"><span class="pre">DaoAuthenticationProvider</span></code>を有効化して、作成した<code class="docutils literal"><span class="pre">UserDetailsService</span></code>を適用する必要がある。</p>
<ul class="simple">
<li>spring-security.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:authentication-manager&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;sec:authentication-provider</span> <span class="na">user-service-ref=</span><span class="s">&quot;accountUserDetailsService&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/sec:authentication-manager&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthenticationManager</span></code>をbean定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;sec:authentication-manager&gt;</span></code>要素内に <code class="docutils literal"><span class="pre">&lt;sec:authentication-provider&gt;</span></code>要素を定義する。</div>
<div class="line"><code class="docutils literal"><span class="pre">user-service-ref</span></code>属性に「<a class="reference internal" href="#springsecurityauthenticationuserdetailsservice"><span class="std std-ref">UserDetailsServiceの作成</span></a>」で作成した <code class="docutils literal"><span class="pre">AccountUserDetailsService</span></code>のbeanを指定する。</div>
<div class="line">本定義により、デフォルト設定の<code class="docutils literal"><span class="pre">DaoAuthenticationProvider</span></code>が有効になる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Spring Security 5から、<code class="docutils literal"><span class="pre">passwordEncoder</span></code>という名前のBeanを定義していると、<code class="docutils literal"><span class="pre">sec:authentication-provider</span></code>配下に<code class="docutils literal"><span class="pre">sec:password-encoder</span></code>要素を指定しない場合に自動的に参照されるようになった。
これにより、TERASOLUNA Server Framework for Java 5.5.1.RELEASEからは基本的に<code class="docutils literal"><span class="pre">sec:password-encoder</span></code>の指定を省略することができる。</p>
<p class="last">Spring Security 4では<code class="docutils literal"><span class="pre">sec:password-encoder</span></code>要素を省略した場合、<code class="docutils literal"><span class="pre">PasswordEncoder</span></code>として<code class="docutils literal"><span class="pre">PlaintextPasswordEncoder</span></code>が使用されていた。Spring Security 5では<code class="docutils literal"><span class="pre">sec:password-encoder</span></code>要素を省略し、かつ<code class="docutils literal"><span class="pre">passwordEncoder</span></code>という名前のBeanが存在しない場合、<code class="docutils literal"><span class="pre">org.springframework.security.crypto.factory.PasswordEncoderFactories</span></code>を利用して生成した<code class="docutils literal"><span class="pre">DelegatingPasswordEncoder</span></code>が使用される。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="springsecurityauthenticationpasswordhashing">
<span id="id13"></span><h3><a class="toc-backref" href="#id89">9.2.2.5. パスワードのハッシュ化</a><a class="headerlink" href="#springsecurityauthenticationpasswordhashing" title="Permalink to this headline">¶</a></h3>
<p>パスワードをデータベースなどに保存する場合は、パスワードそのものではなくパスワードの
ハッシュ値を保存するのが一般的である。</p>
<p>Spring Securityは、パスワードをハッシュ化するためのインタフェースと実装クラスを
提供しており、認証機能と連携して動作する。</p>
<p>Spring Securityは以下のインタフェースを提供している。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">org.springframework.security.crypto.password.PasswordEncoder</span></code></li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Spring Security 3.1.4以降、非推奨のインタフェースであった<code class="docutils literal"><span class="pre">org.springframework.security.authentication.encoding.PasswordEncoder</span></code>は、
Spring Security 5.0で廃止された。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p><em>org.springframework.security.crypto.password.PasswordEncoderのメソッド定義</em></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PasswordEncoder</span> <span class="p">{</span>
    <span class="n">String</span> <span class="nf">encode</span><span class="p">(</span><span class="n">CharSequence</span> <span class="n">rawPassword</span><span class="p">);</span>
    <span class="kt">boolean</span> <span class="nf">matches</span><span class="p">(</span><span class="n">CharSequence</span> <span class="n">rawPassword</span><span class="p">,</span> <span class="n">String</span> <span class="n">encodedPassword</span><span class="p">);</span>
    <span class="k">default</span> <span class="kt">boolean</span> <span class="nf">upgradeEncoding</span><span class="p">(</span><span class="n">String</span> <span class="n">encodedPassword</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils" id="id60">
<caption><span class="caption-text"><strong>PasswordEncoderに定義されているメソッド</strong></span><a class="headerlink" href="#id60" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="15%" />
<col width="85%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">メソッド名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">encode</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワードをハッシュ化するためのメソッド。</div>
<div class="line">アカウントの登録処理やパスワード変更処理などでデータストアに保存するパスワードをハッシュ化する際に使用できる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">matches</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">平文のパスワードとハッシュ化されたパスワードを照合するためのメソッド。</div>
<div class="line">このメソッドはSpring Securityの認証処理でも利用されるが、パスワード変更処理などで現在のパスワードや過去に使用していたパスワードと照合する際にも使用できる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">upgradeEncoding</span></code>(Spring Security 5.1より追加)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ハッシュ化されたパスワードをセキュリティ強化のために再度ハッシュ化する必要があるか検証するためのメソッド。</div>
<div class="line">本メソッドは、DB等から取得したハッシュ化されたパスワードを認証情報として保持する際に、セキュリティ強度の低いハッシュの漏洩を防止するために利用され、主にフレームワーク内部で利用されるメソッドである。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Spring Securityは、<code class="docutils literal"><span class="pre">PasswordEncoder</span></code>インタフェースの実装クラスとして以下の3つのいずれかを使用することを推奨している。
また、本ガイドラインではこれらのクラスを直接使用せず、後述する<code class="docutils literal"><span class="pre">DelegatingPassowordEncoder</span></code>を通して使用することを推奨する。</p>
<table border="1" class="colwidths-given docutils" id="id61">
<caption><span class="caption-text"><strong>PasswordEncoderの実装クラス</strong></span><a class="headerlink" href="#id61" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">実装クラス</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Pbkdf2PasswordEncoder</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">PBKDF2アルゴリズムを使用してパスワードのハッシュ化及び照合を行う実装クラス。</div>
<div class="line">本ガイドラインでは、このクラスを使用することを推奨している。</div>
<div class="line">詳細は、<a class="reference external" href="https://docs.spring.io/spring-security/site/docs/5.2.1.RELEASE/api/org/springframework/security/crypto/password/Pbkdf2PasswordEncoder.html">Pbkdf2PasswordEncoderのJavaDoc</a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">BCryptPasswordEncoder</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">BCryptアルゴリズムを使用してパスワードのハッシュ化及び照合を行う実装クラス。</div>
<div class="line">詳細は、<a class="reference external" href="https://docs.spring.io/spring-security/site/docs/5.2.1.RELEASE/api/org/springframework/security/crypto/bcrypt/BCryptPasswordEncoder.html">BCryptPasswordEncoderのJavaDoc</a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Argon2PasswordEncoder</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Argon2アルゴリズムを使用してパスワードのハッシュ化及び照合を行う実装クラス。</div>
<div class="line">詳細は、<a class="reference external" href="https://docs.spring.io/spring-security/site/docs/5.2.1.RELEASE/api/org/springframework/security/crypto/argon2/Argon2PasswordEncoder.html">Argon2PasswordEncoderのJavaDoc</a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">SCryptPasswordEncoder</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SCryptアルゴリズムを使用してパスワードのハッシュ化及び照合を行う実装クラス。</div>
<div class="line">詳細は、<a class="reference external" href="https://docs.spring.io/spring-security/site/docs/5.2.1.RELEASE/api/org/springframework/security/crypto/scrypt/SCryptPasswordEncoder.html">SCryptPasswordEncoderのJavaDoc</a>を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><a class="reference external" href="https://www.owasp.org/index.php/Password_Storage_Cheat_Sheet">OWASP(Open Web Application Security Project)</a>では<a class="reference external" href="https://www.nist.gov/topics/federal-information-standards-fips">FIPS</a>に準ずるPBKDF2アルゴリズムが推奨されている。</p>
<p class="last">TERASOLUNA Server Framework for Javaでは5.5.1.RELEASEから、OWASP(Open Web Application Security Project)で推奨されるPBKDF2アルゴリズムの使用を推奨する。
これに伴い、ブランクプロジェクトが提供する<code class="docutils literal"><span class="pre">PasswordEncoder</span></code>の定義も、<code class="docutils literal"><span class="pre">BCryptPasswordEncoder</span></code>からデフォルトで<code class="docutils literal"><span class="pre">Pbkdf2PasswordEncoder</span></code>を使用する定義に変更している。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><code class="docutils literal"><span class="pre">Argon2PasswordEncoder</span></code>または<code class="docutils literal"><span class="pre">SCryptPasswordEncoder</span></code>を使用する場合は、ブランクプロジェクトのデフォルト設定から変更する必要がある。</p>
<p><code class="docutils literal"><span class="pre">applicationContext.xml</span></code>のコメントアウトを外し、<code class="docutils literal"><span class="pre">SCryptPasswordEncoder</span></code>の定義を有効化する。</p>
<blockquote>
<div><p><em>applicationContext.xml</em></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;passwordEncoder&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.crypto.password.DelegatingPasswordEncoder&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;idForEncode&quot;</span> <span class="na">value=</span><span class="s">&quot;pbkdf2&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;idToPasswordEncoder&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;map&gt;</span>
            <span class="c">&lt;!-- ommited --&gt;</span>
            <span class="c">&lt;!-- When using commented out PasswordEncoders, you need to add bcprov-jdk15on.jar to the dependency.</span>
<span class="c">            &lt;entry key=&quot;argon2&quot;&gt;</span>
<span class="c">                &lt;bean class=&quot;org.springframework.security.crypto.argon2.Argon2PasswordEncoder&quot; /&gt;</span>
<span class="c">            &lt;/entry&gt;</span>
<span class="c">            &lt;entry key=&quot;scrypt&quot;&gt;</span>
<span class="c">                &lt;bean class=&quot;org.springframework.security.crypto.scrypt.SCryptPasswordEncoder&quot; /&gt;</span>
<span class="c">            &lt;/entry&gt;</span>
<span class="c">            --&gt;</span>
        <span class="nt">&lt;/map&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
</div></blockquote>
<p>依存ライブラリとして不足している<code class="docutils literal"><span class="pre">bcprov-jdk15on</span></code>を追加する。
pom.xmlに以下のdependencyを追加すれば良い。</p>
<blockquote>
<div><p><em>pom.xml</em></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.bouncycastle<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>bcprov-jdk15on<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
</div></blockquote>
<p class="last">上記設定例は、依存ライブラリのバージョンを親プロジェクトである terasoluna-gfw-parent で管理する前提であるため、pom.xmlでのバージョンの指定は不要である。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">アプリケーションの要件によっては、上記以外の非推奨な<code class="docutils literal"><span class="pre">PasswordEncoder</span></code>の実装クラスを利用する必要がある場合もある。
「<a class="reference internal" href="#authenticationhowtoextendusingdeprecatedpasswordencoder"><span class="std std-ref">非推奨アルゴリズムのPasswordEncoderの利用</span></a>」では非推奨の実装クラスの一つである<code class="docutils literal"><span class="pre">MessageDigestPasswordEncoder</span></code>を利用する方法について解説する</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="delegatingpasswordencoder">
<h4><a class="toc-backref" href="#id90">9.2.2.5.1. DelegatingPasswordEncoder</a><a class="headerlink" href="#delegatingpasswordencoder" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">DelegatingPasswordEncoder</span></code>は、ハッシュ化されたパスワードの照合に複数の<code class="docutils literal"><span class="pre">PasswordEncoder</span></code>から適切なものを選択するためのストラテジインタフェースである。
これにより、データベース等に格納された様々なアルゴリズムでハッシュ化されたパスワードを、アプリケーションの変更無しに扱うことが可能となる。
なお、<code class="docutils literal"><span class="pre">DelegatingPasswordEncoder</span></code>がハッシュ化されたアルゴリズムを判定するには、ハッシュ化されたパスワードの先頭にアルゴリズムを示すキーを含む必要があり、<code class="docutils literal"><span class="pre">DelegatingPasswordEncoder</span></code>がパスワードをハッシュ化する際には、このキーが自動的に付与される。</p>
<div class="figure" id="id62">
<a class="reference internal image-reference" href="../_images/AuthenticationDelegatingPasswordEncoder.png"><img alt="../_images/AuthenticationDelegatingPasswordEncoder.png" src="../_images/AuthenticationDelegatingPasswordEncoder.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>DelegatingPasswordEncoderの解説</strong></span></p>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">User1、User2についてパスワードの照合を行う。データストアには<code class="docutils literal"><span class="pre">DelegatingPasswordEncoder</span></code>でハッシュ化したパスワードが格納されている。</div>
<div class="line">データストアに格納されたパスワードは<code class="docutils literal"><span class="pre">DelegatingPasswordEncoder</span></code>がハッシュ化を行っており、User1は<code class="docutils literal"><span class="pre">BCryptPasswordEncoder</span></code>、User2は<code class="docutils literal"><span class="pre">Pbkdf2PasswordEncoder</span></code>が用いられている。</div>
<div class="line">なお、この解説ではデータストアから<code class="docutils literal"><span class="pre">DaoAuthenticationProvider</span></code>にユーザ情報を引き渡す際に経由する<code class="docutils literal"><span class="pre">UserDetailsService</span></code>の実装クラス等を省略しているため注意されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DelegatingPasswordEncoder</span></code>を用いて照合を行う。照合の際は、データストアに格納されたハッシュ化されたパスワードからプレフィックスを読み取り適切な<code class="docutils literal"><span class="pre">PasswordEncoder</span></code>に処理を委譲する。</div>
<div class="line">User1のハッシュ値はプレフィックスとして<code class="docutils literal"><span class="pre">bcrypt</span></code>が付与されているため<code class="docutils literal"><span class="pre">BCryptPasswordEncoder</span></code>で照合が行われ、User2のハッシュ値は<code class="docutils literal"><span class="pre">pbkdf2</span></code>が付与されているため<code class="docutils literal"><span class="pre">Pbksdf2PasswordEncoder</span></code>で照合が行われる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>ブランクプロジェクトでは<code class="docutils literal"><span class="pre">Pbkdf2PasswordEncoder</span></code>を使用する<code class="docutils literal"><span class="pre">DelegatingPasswordEncoder</span></code>が定義されている。</p>
<p>ここではブランクプロジェクトで定義されている<code class="docutils literal"><span class="pre">PasswordEncoder</span></code>をもとに解説を行う。</p>
<ul class="simple">
<li>applicationContext.xmlの定義</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;passwordEncoder&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.crypto.password.DelegatingPasswordEncoder&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;idForEncode&quot;</span> <span class="na">value=</span><span class="s">&quot;pbkdf2&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;idToPasswordEncoder&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
        <span class="nt">&lt;map&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;pbkdf2&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.crypto.password.Pbkdf2PasswordEncoder&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/entry&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;bcrypt&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/entry&gt;</span>
            <span class="c">&lt;!-- When using commented out PasswordEncoders, you need to add bcprov-jdk15on.jar to the dependency.</span>
<span class="c">            &lt;entry key=&quot;argon2&quot;&gt;</span>
<span class="c">                &lt;bean class=&quot;org.springframework.security.crypto.argon2.Argon2PasswordEncoder&quot; /&gt;</span>
<span class="c">            &lt;/entry&gt;</span>
<span class="c">            &lt;entry key=&quot;scrypt&quot;&gt;</span>
<span class="c">                &lt;bean class=&quot;org.springframework.security.crypto.scrypt.SCryptPasswordEncoder&quot; /&gt;</span>
<span class="c">            &lt;/entry&gt;</span>
<span class="c">            --&gt;</span>
        <span class="nt">&lt;/map&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DelegatingPasswordEncoder</span></code>をid <code class="docutils literal"><span class="pre">passwordEncoder</span></code>で定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">idToPasswordEncoder</span></code>で登録した<code class="docutils literal"><span class="pre">PasswordEncoder</span></code>の内、ハッシュ化に使用するものの<code class="docutils literal"><span class="pre">key</span></code>値を<code class="docutils literal"><span class="pre">idForEncode</span></code>に指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">idToPasswordEncoder</span></code>に<code class="docutils literal"><span class="pre">PasswordEncoder</span></code>の実装を格納した<code class="docutils literal"><span class="pre">Map</span></code>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">PasswordEncoder</span></code>の実装を<code class="docutils literal"><span class="pre">Map</span></code>に格納する。</div>
<div class="line">ハッシュ化したパスワードのプレフィックスが<code class="docutils literal"><span class="pre">Map</span></code>の<code class="docutils literal"><span class="pre">key</span></code>と一致すると、その<code class="docutils literal"><span class="pre">key</span></code>で格納された<code class="docutils literal"><span class="pre">PasswordEncoder</span></code>を使用して照合が行われる。</div>
<div class="line">また、前述の<code class="docutils literal"><span class="pre">idForEncode</span></code>と<code class="docutils literal"><span class="pre">key</span></code>が一致する<code class="docutils literal"><span class="pre">PasswordEncoder</span></code>を使用してハッシュ化が行われる。</div>
<div class="line">ハッシュ化の際には<code class="docutils literal"><span class="pre">key</span></code>に指定した値がプレフィックスとして付与される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>セキュリティに関わる注意点</strong></p>
<p>実際のアプリケーション開発では、セキュリティ上のリスクを軽減するため<code class="docutils literal"><span class="pre">idForEncode</span></code>と<code class="docutils literal"><span class="pre">idToPasswordEncoder</span></code>の<code class="docutils literal"><span class="pre">key</span></code>値にアルゴリズム名を推測できないような値を指定することを推奨する。</p>
<p class="last">また、<code class="docutils literal"><span class="pre">PasswordEncoder</span></code>インタフェースの実装クラスを利用する際は <a class="reference internal" href="#authenticationhowtoextendcustompasswordencoder"><span class="std std-ref">PasswordEncoderのカスタマイズ</span></a> についても参照し、セキュリティ要件を満たすように変更を加えられたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>ハッシュ化を行うクラスでは、<code class="docutils literal"><span class="pre">PasswordEncoder</span></code>をDIコンテナからインジェクションして使用する。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountServiceImpl</span> <span class="kd">implements</span> <span class="n">AccountService</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">AccountRepository</span> <span class="n">accountRepository</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="p">;</span> <span class="c1">// (1)</span>

    <span class="kd">public</span> <span class="n">Account</span> <span class="nf">register</span><span class="p">(</span><span class="n">Account</span> <span class="n">account</span><span class="p">,</span> <span class="n">String</span> <span class="n">rawPassword</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// omitted</span>
        <span class="n">String</span> <span class="n">encodedPassword</span> <span class="o">=</span> <span class="n">passwordEncoder</span><span class="p">.</span><span class="na">encode</span><span class="p">(</span><span class="n">rawPassword</span><span class="p">);</span> <span class="c1">// (2)</span>
        <span class="n">account</span><span class="p">.</span><span class="na">setPassword</span><span class="p">(</span><span class="n">encodedPassword</span><span class="p">);</span>
        <span class="c1">// omitted</span>
        <span class="k">return</span> <span class="n">accountRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">account</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">PasswordEncoder</span></code>をインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">インジェクションした<code class="docutils literal"><span class="pre">PasswordEncoder</span></code>のメソッドを呼び出す。</div>
<div class="line">ここでは、データストアに保存するパスワードをハッシュ化している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Pbkdf2以外のアルゴリズムを使用する場合</strong></p>
<p class="last">パスワードのハッシュ化に使用する<code class="docutils literal"><span class="pre">PasswordEncoder</span></code>を変更するには、<code class="docutils literal"><span class="pre">idForEncode</span></code>に使用したい<code class="docutils literal"><span class="pre">PasswordEncoder</span></code>の<code class="docutils literal"><span class="pre">key</span></code>値（<code class="docutils literal"><span class="pre">bcrypt</span></code>や<code class="docutils literal"><span class="pre">scrypt</span></code>）に指定すれば良い。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>既存のアプリケーションにDelegatingPasswordEncoderを適用する際の注意点</strong></p>
<p><strong>PasswordEncoderに関する注意点</strong></p>
<blockquote>
<div><p>既に運用しているシステムでは、パスワードにプレフィックスは付与されていない。
プレフィックスが付与されていないパスワードをそのまま照合に使用するには、以下で示すように<code class="docutils literal"><span class="pre">defaultPasswordEncoderForMatches</span></code>プロパティで照合に使用するエンコーダを指定する必要がある。</p>
<ul class="simple">
<li>applicationContext.xmlの変更</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;passwordEncoder&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.crypto.password.DelegatingPasswordEncoder&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;idForEncode&quot;</span> <span class="na">value=</span><span class="s">&quot;pbkdf2&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;idToPasswordEncoder&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;map&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;pbkdf2&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.crypto.password.Pbkdf2PasswordEncoder&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/entry&gt;</span>
            <span class="c">&lt;!-- omitted --&gt;</span>
        <span class="nt">&lt;/map&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultPasswordEncoderForMatches&quot;</span> <span class="na">ref=</span><span class="s">&quot;passwordEncoderUsedBefore&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">defaultPasswordEncoderForMatches</span></code>に移行前に使用していた<code class="docutils literal"><span class="pre">PasswordEncoder</span></code>を指定する。</div>
<div class="line">これにより、プレフィックスが付与されていないハッシュ値に対して、指定した<code class="docutils literal"><span class="pre">PasswordEncoder</span></code>で照合が行われるようになる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p><code class="docutils literal"><span class="pre">defaultPasswordEncoderForMatches</span></code>プロパティに照合に使用するエンコーダを指定せずに、<code class="docutils literal"><span class="pre">DelegatingPasswordEncoder</span></code>を使用してプレフィックスが付与されていないハッシュ値を照合しようとすると、デフォルトで設定されている<code class="docutils literal"><span class="pre">UnmappedIdPasswordEncoder</span></code>が使用され、<code class="docutils literal"><span class="pre">IllegalArgumentException</span></code>が発生する。</p>
</div></blockquote>
<p><strong>データストアに関する注意点</strong></p>
<blockquote class="last">
<div>ハッシュ化されたパスワードを格納するデータベースなどでは、プレフィックスが付与されることを考慮する必要がある。</div></blockquote>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="springsecurityauthenticationevent">
<span id="id14"></span><h3><a class="toc-backref" href="#id91">9.2.2.6. 認証イベントのハンドリング</a><a class="headerlink" href="#springsecurityauthenticationevent" title="Permalink to this headline">¶</a></h3>
<p>Spring Securityは、Spring Frameworkが提供しているイベント通知の仕組みを利用して、
認証処理の処理結果を他のコンポーネントと連携する仕組みを提供している。</p>
<p>この仕組みを利用すると、以下のようなセキュリティ要件をSpring Securityの認証機能に組み込むことが可能である。</p>
<ul class="simple">
<li>認証成功、失敗などの認証履歴をデータベースやログに保存する。</li>
<li>パスワードを連続して間違った場合にアカウントをロックする。</li>
</ul>
<p>認証イベントの通知は、以下のような仕組みで行われる。</p>
<div class="figure" id="id63">
<a class="reference internal image-reference" href="../_images/AuthenticationEventNotification.png"><img alt="../_images/AuthenticationEventNotification.png" src="../_images/AuthenticationEventNotification.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>イベント通知の仕組み</strong></span></p>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring Securityの認証機能は、認証結果(認証情報や認証例外)を</div>
<div class="line"><code class="docutils literal"><span class="pre">AuthenticationEventPublisher</span></code>に渡して認証イベントの通知依頼を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthenticationEventPublisher</span></code>インタフェースのデフォルトの実装クラスは</div>
<div class="line">認証結果に対応する認証イベントクラスのインスタンスを生成し、<code class="docutils literal"><span class="pre">ApplicationEventPublisher</span></code>に渡してイベントの通知依頼を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ApplicationEventPublisher</span></code>インタフェースの実装クラスは、<code class="docutils literal"><span class="pre">ApplicationListener</span></code>インタフェースの実装クラスにイベントを通知する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">ApplicationListener</span></code>の実装クラスの一つである<code class="docutils literal"><span class="pre">ApplicationListenerMethodAdaptor</span></code>は、</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;org.springframework.context.event.EventListener</span></code>が付与されているメソッドを呼び出してイベントを通知する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>メモ</strong></p>
<p class="last">Spring 4.1までは<code class="docutils literal"><span class="pre">ApplicationListener</span></code>インタフェースの実装クラスを作成してイベントを受け取る必要があったが、
Spring 4.2からはPOJOに<code class="docutils literal"><span class="pre">&#64;EventListener</span></code>を付与したメソッドを実装するだけでイベントを受け取ることが可能である。
なお、Spring 4.2以降でも、従来通り<code class="docutils literal"><span class="pre">ApplicationListener</span></code>インタフェースの実装クラスを作成してイベントを受け取ることも可能である。</p>
</div>
<p>Spring Security使用しているイベントは、認証が成功したことを通知するイベントと認証が失敗したことを通知するイベントの2種類に分類される。
以下にSpring Securityが用意しているイベントクラスを説明する。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="id15">
<h4><a class="toc-backref" href="#id92">9.2.2.6.1. 認証成功イベント</a><a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h4>
<p>認証が成功した時にSpring Securityが通知する主なイベントは以下の3つである。
この3つのイベントは途中でエラーが発生しなければ、以下の順番ですべて通知される。</p>
<table border="1" class="colwidths-given docutils" id="id64">
<caption><span class="caption-text"><strong>認証が成功したことを通知するイベントクラス</strong></span><a class="headerlink" href="#id64" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">イベントクラス</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">AuthenticationSuccessEvent</span></code></td>
<td><code class="docutils literal"><span class="pre">AuthenticationProvider</span></code>による認証処理が成功したことを通知するためのイベントクラス。
このイベントをハンドリングすると、クライアントが正しい認証情報を指定したことを検知することが可能である。
なお、このイベントをハンドリングした後の後続処理でエラーが発生する可能性がある点に注意されたい。</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">SessionFixationProtectionEvent</span></code></td>
<td>セッション固定攻撃対策の処理(セッションIDの変更処理)が成功したことを通知するためのイベントクラス。
このイベントをハンドリングすると、変更後のセッションIDを検知することが可能になる。</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">InteractiveAuthenticationSuccessEvent</span></code></td>
<td>認証処理がすべて成功したことを通知するためのイベントクラス。
このイベントをハンドリングすると、画面遷移を除くすべての認証処理が成功したことを検知することが可能になる。</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id16">
<h4><a class="toc-backref" href="#id93">9.2.2.6.2. 認証失敗イベント</a><a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h4>
<p>認証が失敗した時にSpring Securityが通知する主なイベントは以下の通り。
認証に失敗した場合は、いずれか一つのイベントが通知される。</p>
<table border="1" class="colwidths-given docutils" id="id65">
<caption><span class="caption-text"><strong>認証が失敗したことを通知するイベントクラス</strong></span><a class="headerlink" href="#id65" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">イベントクラス</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthenticationFailureBadCredentialsEvent</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">BadCredentialsException</span></code>が発生したことを通知するためのイベントクラス。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthenticationFailureDisabledEvent</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DisabledException</span></code>が発生したことを通知するためのイベントクラス。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthenticationFailureLockedEvent</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">LockedException</span></code>が発生したことを通知するためのイベントクラス。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthenticationFailureExpiredEvent</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AccountExpiredException</span></code>が発生したことを通知するためのイベントクラス。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthenticationFailureCredentialsExpiredEvent</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">CredentialsExpiredException</span></code>が発生したことを通知するためのイベントクラス。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthenticationFailureServiceExceptionEvent</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthenticationServiceException</span></code>が発生したことを通知するためのイベントクラス。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="springsecurityauthenticationeventlistener">
<span id="id17"></span><h4><a class="toc-backref" href="#id94">9.2.2.6.3. イベントリスナの作成</a><a class="headerlink" href="#springsecurityauthenticationeventlistener" title="Permalink to this headline">¶</a></h4>
<p>認証イベントの通知を受け取って処理を行いたい場合は、<code class="docutils literal"><span class="pre">&#64;EventListener</span></code>を付与したメソッドを実装したクラスを作成し、DIコンテナに登録する。</p>
<ul class="simple">
<li>イベントリスナクラスの実装例</li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.examples.domain.common.event</span><span class="p">;</span> <span class="c1">// (1)</span>

<span class="nd">@Component</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthenticationEventListeners</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span>
            <span class="n">LoggerFactory</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">AuthenticationEventListeners</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

    <span class="nd">@EventListener</span><span class="p">(</span><span class="n">AuthenticationFailureBadCredentialsEvent</span><span class="p">.</span><span class="na">class</span><span class="p">)</span> <span class="c1">// (2)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleBadCredentials</span><span class="p">(</span>
        <span class="n">AuthenticationFailureBadCredentialsEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (3)</span>
        <span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Bad credentials is detected. username : {}&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">.</span><span class="na">getAuthentication</span><span class="p">().</span><span class="na">getName</span><span class="p">());</span>
        <span class="c1">// omitted</span>
    <span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">コンポーネントスキャン機能を利用してイベントリスナクラスを登録するため、<code class="docutils literal"><span class="pre">&#64;Component</span></code>をクラスに付与する。</div>
</div>
<div class="last admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>イベントリスナクラスの配置について</strong></p>
<p>Spring Securityが参照するWebアプリケーション用のアプリケーションコンテキストに登録するため、アプリケーションの <code class="docutils literal"><span class="pre">domain</span></code>パッケージ配下に置くこと。</p>
<p class="last">ただし、<code class="docutils literal"><span class="pre">SessionFixationProtectionEvent</span></code>はspring-security-webに定義されているため、ブランクプロジェクトのデフォルト設定ではdomainモジュールから参照することができない。
このイベントをハンドリングする場合はwebモジュール（ <code class="docutils literal"><span class="pre">web</span></code>パッケージ配下）に置くことになるが、スキャン対象の定義が煩雑になるためコンポーネントスキャン機能を利用せずbean定義することを検討されたい。</p>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;EventListener</span></code>をメソッドに付与したメソッドを作成する。</div>
<div class="line">イベントリスナは属性値に指定された認証イベントクラスを処理する。認証イベントクラスは複数指定することができる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">メソッドの引数にハンドリングしたい認証イベントクラスを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>上記例では、クライアントが指定した認証情報に誤りがあった場合に通知される<code class="docutils literal"><span class="pre">AuthenticationFailureBadCredentialsEvent</span></code>をハンドリングするクラスを作成する例としているが、
他のイベントも同じ要領でハンドリングすることが可能である。</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">総当たり攻撃による不正ログインの兆候を検出するための方法として、ログイン認証時のログを監視することがあげられる。
実装例のような<code class="docutils literal"><span class="pre">AuthenticationFailureBadCredentialsEvent</span></code>をハンドリングするイベントリスナを作成して
認証情報の誤りをログ情報として出力することで、Spring Securityを使用した認証時のログを監視することが可能になる。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="springsecurityauthenticationlogout">
<span id="id18"></span><h3><a class="toc-backref" href="#id95">9.2.2.7. ログアウト</a><a class="headerlink" href="#springsecurityauthenticationlogout" title="Permalink to this headline">¶</a></h3>
<p>Spring Securityは、以下のような流れでログアウト処理を行う。</p>
<div class="figure" id="id66">
<a class="reference internal image-reference" href="../_images/AuthenticationLogout.png"><img alt="../_images/AuthenticationLogout.png" src="../_images/AuthenticationLogout.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>ログアウト処理の仕組み</strong></span></p>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クライアントは、ログアウト処理を行うためのパスにリクエストを送信する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">LogoutFilter</span></code>は、<code class="docutils literal"><span class="pre">LogoutHandler</span></code>のメソッドを呼び出し、実際のログアウト処理を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">LogoutFilter</span></code>は、<code class="docutils literal"><span class="pre">LogoutSuccessHandler</span></code>のメソッドを呼び出し、画面遷移を行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p><code class="docutils literal"><span class="pre">LogoutHandler</span></code>の実装クラスは複数存在し、それぞれ以下の役割をもっている。</p>
<table border="1" class="colwidths-given docutils" id="id67">
<caption><span class="caption-text"><strong>主なLogoutHandlerの実装クラス</strong></span><a class="headerlink" href="#id67" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">実装クラス</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">SecurityContextLogoutHandler</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ログインユーザーの認証情報のクリアとセッションの破棄を行うクラス。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">CookieClearingLogoutHandler</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">指定したクッキーを削除するためのレスポンスを行うクラス。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">CsrfLogoutHandler</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">CSRF対策用トークンの破棄を行うクラス。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">LogoutSuccessEventPublishingLogoutHandler</span></code>(Spring Security 5.2より追加)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">LogoutSuccessEvent</span></code>クラスのインスタンスを生成し、<code class="docutils literal"><span class="pre">ApplicationEventPublisher</span></code>に渡してイベントの通知依頼を行うクラス。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>これらの<code class="docutils literal"><span class="pre">LogoutHandler</span></code>は、Spring Securityが提供しているbean定義をサポートするクラスが自動で<code class="docutils literal"><span class="pre">LogoutFilter</span></code>に設定する仕組みになっているため、
基本的にはアプリケーションの開発者が直接意識する必要はない。
また、<a class="reference internal" href="#springsecurityauthenticationrememberme"><span class="std std-ref">Remember Me認証機能</span></a> を有効にすると、Remember Me認証用のTokenを破棄するための<code class="docutils literal"><span class="pre">LogoutHandler</span></code>の実装クラスも設定される。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Clear-Site-Dataヘッダの付与</strong></p>
<p>Spring Security 5.2より、Webサイトの閲覧用データ（クッキー、ストレージ、キャッシュ）を削除するための<a class="reference external" href="https://docs.spring.io/spring-security/site/docs/5.2.1.RELEASE/reference/htmlsingle/#headers-clearsitedata">Clear-Site-Dataヘッダ</a>を付与する<code class="docutils literal"><span class="pre">org.springframework.security.web.header.writers.ClearSiteDataHeaderWriter</span></code>が提供される。</p>
<p class="last">本機能は<code class="docutils literal"><span class="pre">LogoutHandler</span></code>の仕組みを用いて適用されるが、自動的には適用されない。
適用するには<code class="docutils literal"><span class="pre">LogoutFilter</span></code>をbean定義し、同じく5.2から提供される<code class="docutils literal"><span class="pre">org.springframework.security.web.authentication.logout.HeaderWriterLogoutHandler</span></code>を用いて登録する必要がある。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="id19">
<h4><a class="toc-backref" href="#id96">9.2.2.7.1. ログアウト処理の適用</a><a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h4>
<p>ログアウト処理を適用するためには、以下のようなbean定義を行う。</p>
<ul class="simple">
<li>spring-security.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
    <span class="nt">&lt;sec:logout</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;sec:logout&gt;</span></code>タグを定義することで、ログアウト処理が有効となる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>Cookieの削除</strong></p>
<p>本ガイドラインでは説明を割愛するが、 <code class="docutils literal"><span class="pre">&lt;sec:logout&gt;</span></code>タグには、ログアウト時に指定したCookieを削除するための<code class="docutils literal"><span class="pre">delete-cookies</span></code>属性が存在する。
ただし、この属性を使用しても正常にCookieが削除できないケースが報告されている。</p>
<p>詳細はSpring Securityの以下のJIRAを参照されたい。</p>
<ul class="last simple">
<li><a class="reference external" href="https://jira.spring.io/browse/SEC-2091?redirect=false">https://jira.spring.io/browse/SEC-2091?redirect=false</a></li>
</ul>
</div>
</div>
<div class="section" id="id20">
<h4><a class="toc-backref" href="#id97">9.2.2.7.2. デフォルトの動作</a><a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h4>
<p>Spring Securityのデフォルトの動作では、<code class="docutils literal"><span class="pre">/logout</span></code>というパスにリクエストを送るとログアウト処理が行われる。
ログアウト処理では、「ログインユーザーの認証情報のクリア」「セッションの破棄」が行われる。</p>
<p>また、</p>
<ul class="simple">
<li>CSRF対策を行っている場合は、「CSRF対策用トークンの破棄」</li>
<li>Remember Me認証機能を使用している場合は、「Remember Me認証用のTokenの破棄」</li>
</ul>
<p>も行われる</p>
<ul class="simple" id="springsecurityauthenticationlogoutform">
<li>ログアウト処理を呼び出すためのJSPの実装例</li>
</ul>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="k">&lt;%@</span> <span class="n">taglib</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;c&quot;</span> <span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://java.sun.com/jsp/jstl/core&quot;</span> <span class="k">%&gt;</span>
<span class="k">&lt;%@</span> <span class="n">taglib</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;sec&quot;</span> <span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://www.springframework.org/security/tags&quot;</span> <span class="k">%&gt;</span>
<span class="k">&lt;%-</span><span class="o">-</span> <span class="n">omitted</span> <span class="o">--</span><span class="k">%&gt;</span>
<span class="nt">&lt;form:form</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/logout&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span> <span class="k">&lt;%-</span><span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">--</span><span class="k">%&gt;</span>
    <span class="nt">&lt;button&gt;</span>ログアウト<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/form:form&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ログアウト用のフォームを作成する。</div>
<div class="line">また、<code class="docutils literal"><span class="pre">&lt;form:form&gt;</span></code>を使用することで、CSRF対策用のトークン値がリクエストパラメータで送信される。</div>
<div class="line">CSRF対策については、「<a class="reference internal" href="CSRF.html#springsecuritycsrf"><span class="std std-ref">CSRF対策</span></a>」で説明する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>CSRFトークンの送信</strong></p>
<p class="last">CSRF対策を有効にしている場合は、CSRF対策用のトークンをPOSTメソッドで送信する必要がある。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id21">
<h3><a class="toc-backref" href="#id98">9.2.2.8. ログアウト成功時のレスポンス</a><a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h3>
<p>Spring Securityは、ログアウト成功時のレスポンスを制御するためのコンポーネントとして、
<code class="docutils literal"><span class="pre">LogoutSuccessHandler</span></code>というインタフェースと実装クラスを提供している。</p>
<table border="1" class="colwidths-given docutils" id="id68">
<caption><span class="caption-text"><strong>主なLogoutSuccessHandlerの実装クラス</strong></span><a class="headerlink" href="#id68" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">実装クラス</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">SimpleUrlLogoutSuccessHandler</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">指定したパス(<code class="docutils literal"><span class="pre">defaultTargetUrl</span></code>)にリダイレクトを行う実装クラス。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">HttpStatusReturningLogoutSuccessHandler</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ログアウト成功時のレスポンスに任意のステータスコードを設定する実装クラス。</div>
<div class="line">デフォルトでは200(OK)が設定される。</div>
<div class="line">ログアウト成功時にリダイレクトを行うのが望ましくないRESTful Web Serviceのようなアプリケーションで有用である。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">DelegatingLogoutSuccessHandler</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RequestMatcher</span></code>インタフェースの仕組みを利用して、指定されたリクエストのパターンに対応する<code class="docutils literal"><span class="pre">LogoutSuccessHandler</span></code>インタフェースの実装クラスに処理を委譲する実装クラス。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="section" id="id22">
<h4><a class="toc-backref" href="#id99">9.2.2.8.1. デフォルトの動作</a><a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h4>
<p>Spring Securityのデフォルトの動作では、ログインフォームを表示するためのパスに<code class="docutils literal"><span class="pre">logout</span></code>というクエリパラメータが付与されたURLにリダイレクトする。</p>
<p>例として、ログインフォームを表示するためのパスが<code class="docutils literal"><span class="pre">/login</span></code>の場合は<code class="docutils literal"><span class="pre">/login?logout</span></code>にリダイレクトされる。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id23">
<h3><a class="toc-backref" href="#id100">9.2.2.9. ログアウト成功時の認証イベントのハンドリング</a><a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h3>
<p>Spring Security 5.2より、<a class="reference internal" href="#springsecurityauthenticationevent"><span class="std std-ref">認証イベントのハンドリング</span></a>と同様に、
ログアウト処理の処理結果を他のコンポーネントと連携する仕組みを提供している。</p>
<p>ログアウト成功時の認証イベントの通知は、以下のような仕組みで行われる。</p>
<div class="figure" id="id69">
<a class="reference internal image-reference" href="../_images/AuthenticationLogoutEvent.png"><img alt="../_images/AuthenticationLogoutEvent.png" src="../_images/AuthenticationLogoutEvent.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>イベント通知の仕組み</strong></span></p>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ログアウト処理が成功した後、<code class="docutils literal"><span class="pre">LogoutSuccessEventPublishingLogoutHandler</span></code>は認証イベントクラスのインスタンスを生成し、<code class="docutils literal"><span class="pre">ApplicationEventPublisher</span></code>に渡してイベントの通知依頼を行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>以下にSpring Securityが用意しているイベントクラスを説明する。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="id24">
<h4><a class="toc-backref" href="#id101">9.2.2.9.1. ログアウト成功イベント</a><a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h4>
<p>ログアウトが成功した時にSpring Securityが通知するイベントは以下の1つである。</p>
<table border="1" class="colwidths-given docutils" id="id70">
<caption><span class="caption-text"><strong>ログアウトが成功したことを通知するイベントクラス</strong></span><a class="headerlink" href="#id70" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">イベントクラス</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">LogoutSuccessEvent</span></code></td>
<td>ログアウトが成功したことを通知するためのイベントクラス。
このイベントをハンドリングすると、クライアントがログアウトし、認証情報が破棄されたことを検知することが可能である。
なお、このイベントをハンドリングした後の後続処理でエラーが発生する可能性がある点に注意されたい。</td>
</tr>
</tbody>
</table>
<p>ログアウト成功イベントの通知を受け取って処理を行う方法については、<a class="reference internal" href="#springsecurityauthenticationeventlistener"><span class="std std-ref">イベントリスナの作成</span></a>を参照されたい。</p>
</div>
</div>
<div class="section" id="springsecurityauthenticationaccess">
<span id="id25"></span><h3><a class="toc-backref" href="#id102">9.2.2.10. 認証情報へのアクセス</a><a class="headerlink" href="#springsecurityauthenticationaccess" title="Permalink to this headline">¶</a></h3>
<p>認証されたユーザーの認証情報は、Spring Securityのデフォルト実装ではセッションに格納される。
セッションに格納された認証情報は、リクエスト毎に<code class="docutils literal"><span class="pre">SecurityContextPersistenceFilter</span></code>クラスによって<code class="docutils literal"><span class="pre">SecurityContextHolder</span></code>というクラスに格納され、同一スレッド内であればどこからでもアクセスすることができるようになる。</p>
<p>ここでは、認証情報から<code class="docutils literal"><span class="pre">UserDetails</span></code>を取得し、取得した<code class="docutils literal"><span class="pre">UserDetails</span></code>が保持している情報にアクセスする方法を説明する。</p>
<div class="section" id="java">
<h4><a class="toc-backref" href="#id103">9.2.2.10.1. Javaからのアクセス</a><a class="headerlink" href="#java" title="Permalink to this headline">¶</a></h4>
<p>一般的な業務アプリケーションでは、「いつ」「誰が」「どのデータに」「どのようなアクセスをしたか」を記録する監査ログを取得することがある。
このような要件を実現する際の「誰が」は、認証情報から取得することができる。</p>
<ul class="simple">
<li>Javaから認証情報へアクセスする実装例</li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">Authentication</span> <span class="n">authentication</span> <span class="o">=</span>
        <span class="n">SecurityContextHolder</span><span class="p">.</span><span class="na">getContext</span><span class="p">().</span><span class="na">getAuthentication</span><span class="p">();</span> <span class="c1">// (1)</span>
<span class="n">String</span> <span class="n">userUuid</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">authentication</span><span class="p">.</span><span class="na">getPrincipal</span><span class="p">()</span> <span class="k">instanceof</span> <span class="n">AccountUserDetails</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">AccountUserDetails</span> <span class="n">userDetails</span> <span class="o">=</span>
            <span class="n">AccountUserDetails</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">cast</span><span class="p">(</span><span class="n">authentication</span><span class="p">.</span><span class="na">getPrincipal</span><span class="p">());</span> <span class="c1">// (2)</span>
    <span class="n">userUuid</span> <span class="o">=</span> <span class="n">userDetails</span><span class="p">.</span><span class="na">getAccount</span><span class="p">().</span><span class="na">getUserUuid</span><span class="p">();</span> <span class="c1">// (3)</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isInfoEnabled</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;type:Audit\tuserUuid:{}\tresource:{}\tmethod:{}&quot;</span><span class="p">,</span>
            <span class="n">userUuid</span><span class="p">,</span> <span class="n">httpRequest</span><span class="p">.</span><span class="na">getRequestURI</span><span class="p">(),</span> <span class="n">httpRequest</span><span class="p">.</span><span class="na">getMethod</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">SecurityContextHolder</span></code>から認証情報(<code class="docutils literal"><span class="pre">Authentication</span></code>オブジェクト) を取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Authentication#getPrincipal()</span></code>メソッドを呼び出して、<code class="docutils literal"><span class="pre">UserDetails</span></code>オブジェクトを取得する。</div>
<div class="line">認証済みでない場合(匿名ユーザーの場合)は、匿名ユーザーであることを示す文字列が返却されるため注意されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UserDetails</span></code>から処理に必要な情報を取得する。</div>
<div class="line">ここでは、ユーザーを一意に識別するための値(UUID)を取得している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>認証情報へのアクセスと結合度</strong></p>
<p>Spring Securityのデフォルト実装では、認証情報をスレッドローカルの変数に格納しているため、リクエストを受けたスレッドと同じスレッドであればどこからでもアクセス可能である。
この仕組みは便利ではあるが、認証情報を必要とするクラスが<code class="docutils literal"><span class="pre">SecurityContextHolder</span></code>クラスに直接依存してしまうため、乱用するとコンポーネントの疎結合性が低下するので注意が必要である。</p>
<p class="last">Spring Securityでは、Spring MVCの機能と連携してコンポーネント間の疎結合性を保つための仕組みを別途提供している。
Spring MVCとの連携方法については、「<a class="reference internal" href="#springsecurityauthenticationintegrationwithspringmvc"><span class="std std-ref">認証処理とSpring MVCの連携</span></a>」で説明する。
<strong>本ガイドラインではSpring MVCとの連携を使用して認証情報を取得することを推奨する。</strong></p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>認証処理用のフィルタ(FORM_LOGIN_FILTER)をカスタマイズする場合は、
<code class="docutils literal"><span class="pre">&lt;sec:concurrency-control&gt;</span></code>要素の指定に加えて、以下の２つの<code class="docutils literal"><span class="pre">SessionAuthenticationStrategy</span></code>クラスを有効化する必要がある。</p>
<ul>
<li><div class="first line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.web.authentication.session.ConcurrentSessionControlAuthenticationStrategy</span></code></div>
<div class="line">認証成功後にログインユーザ毎のセッション数をチェックするクラス。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.web.authentication.session.RegisterSessionAuthenticationStrategy</span></code></div>
<div class="line">認証に成功したセッションをセッション管理領域に登録するクラス。</div>
</div>
</li>
</ul>
<p>version 1.0.x.RELEASEで依存しているSpring Security 3.1では、<code class="docutils literal"><span class="pre">org.springframework.security.web.authentication.session.ConcurrentSessionControlStrategy</span></code>というクラスが提供されていたが、
Spring Security 3.2より非推奨のAPIになり、Spring Security 4.0より廃止になっている。
Spring Security 3.1からSpring Security 3.2以降にバージョンアップする場合は、以下のクラスを組み合わせて使用するように変更する必要がある。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">ConcurrentSessionControlAuthenticationStrategy</span></code> (Spring Security 3.2で追加)</li>
<li><code class="docutils literal"><span class="pre">RegisterSessionAuthenticationStrategy</span></code> (Spring Security 3.2で追加)</li>
<li><code class="docutils literal"><span class="pre">org.springframework.security.web.authentication.session.SessionFixationProtectionStrategy</span></code></li>
</ul>
<p class="last">具体的な定義方法については、
<a class="reference external" href="https://docs.spring.io/spring-security/site/docs/5.2.1.RELEASE/reference/htmlsingle/#concurrent-sessions">Spring Security Reference -Web Application Security (Concurrency Control)-</a> のサンプルコードを参考にされたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="jsp">
<h4><a class="toc-backref" href="#id104">9.2.2.10.2. JSPからのアクセス</a><a class="headerlink" href="#jsp" title="Permalink to this headline">¶</a></h4>
<p>一般的なWebアプリケーションでは、ログインユーザーのユーザー情報などを画面に表示することがある。
このような要件を実現する際のログインユーザーのユーザー情報は、認証情報から取得することができる。</p>
<ul class="simple">
<li>JSPから認証情報へアクセスする実装例</li>
</ul>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="k">&lt;%@</span> <span class="n">taglib</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;sec&quot;</span> <span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://www.springframework.org/security/tags&quot;</span> <span class="k">%&gt;</span>
<span class="k">&lt;%-</span><span class="o">-</span> <span class="n">omitted</span> <span class="o">--</span><span class="k">%&gt;</span>
ようこそ、
<span class="nt">&lt;sec:authentication</span> <span class="na">property=</span><span class="s">&quot;principal.account.lastName&quot;</span><span class="nt">/&gt;</span> <span class="k">&lt;%-</span><span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">--</span><span class="k">%&gt;</span>
さん。
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring Securityから提供されている<code class="docutils literal"><span class="pre">&lt;sec:authentication&gt;</span></code>タグを使用して、認証情報(<code class="docutils literal"><span class="pre">Authentication</span></code>オブジェクト) を取得する。</div>
<div class="line"><code class="docutils literal"><span class="pre">property</span></code>属性にアクセスしたいプロパティへのパスを指定する。</div>
<div class="line">ネストしているオブジェクトへアクセスしたい場合は、プロパティ名を”<code class="docutils literal"><span class="pre">.</span></code>” でつなげればよい。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>認証情報の表示方法</strong></p>
<p>ここでは、認証情報が保持するユーザー情報を表示する際の実装例を説明したが、<code class="docutils literal"><span class="pre">var</span></code>属性と<code class="docutils literal"><span class="pre">scope</span></code>属性を組み合わせて任意のスコープ変数に値を格納することも可能である。
ログインユーザーの状態によって表示内容を切り替えたい場合は、ユーザー情報を変数に格納しておき、JSTLのタグライブラリなどを使って表示を切り替えることが可能である。</p>
<p>上記の例は、以下のように記述することでも実現することができる。
本例では、<code class="docutils literal"><span class="pre">scope</span></code>属性を省略しているため、<code class="docutils literal"><span class="pre">page</span></code>スコープが適用される。</p>
<blockquote class="last">
<div><div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="k">&lt;%@</span> <span class="n">taglib</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;sec&quot;</span> <span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://www.springframework.org/security/tags&quot;</span> <span class="k">%&gt;</span>
<span class="k">&lt;%-</span><span class="o">-</span> <span class="n">omitted</span> <span class="o">--</span><span class="k">%&gt;</span>
<span class="nt">&lt;sec:authentication</span> <span class="na">var=</span><span class="s">&quot;principal&quot;</span> <span class="na">property=</span><span class="s">&quot;principal&quot;</span><span class="nt">/&gt;</span>
<span class="k">&lt;%-</span><span class="o">-</span> <span class="n">omitted</span> <span class="o">--</span><span class="k">%&gt;</span>
ようこそ、
${f:h(principal.account.lastName)}
さん。
</pre></div>
</div>
</div></blockquote>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="spring-mvc">
<span id="springsecurityauthenticationintegrationwithspringmvc"></span><h3><a class="toc-backref" href="#id105">9.2.2.11. 認証処理とSpring MVCの連携</a><a class="headerlink" href="#spring-mvc" title="Permalink to this headline">¶</a></h3>
<p>Spring Securityは、Spring MVCと連携するためのコンポーネントをいくつか提供している。
ここでは、認証処理と連携するためのコンポーネントの使い方を説明する。</p>
<div class="section" id="id26">
<h4><a class="toc-backref" href="#id106">9.2.2.11.1. 認証情報へのアクセス</a><a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h4>
<p>Spring Securityは、認証情報(<code class="docutils literal"><span class="pre">UserDetails</span></code>)をSpring MVCのコントローラーのメソッドに引き渡すためのコンポーネントとして、<code class="docutils literal"><span class="pre">AuthenticationPrincipalArgumentResolver</span></code>クラスを提供している。
<code class="docutils literal"><span class="pre">AuthenticationPrincipalArgumentResolver</span></code>を使用すると、コントローラーのメソッド引数として<code class="docutils literal"><span class="pre">UserDetails</span></code>インタフェースまたはその実装クラスのインスタンスを受け取ることができるため、コンポーネントの疎結合性を高めることができる。</p>
<p>認証情報(<code class="docutils literal"><span class="pre">UserDetails</span></code>)をコントローラーの引数として受け取るためには、まず<code class="docutils literal"><span class="pre">AuthenticationPrincipalArgumentResolver</span></code>をSpring MVCに適用する必要がある。
<code class="docutils literal"><span class="pre">AuthenticationPrincipalArgumentResolver</span></code>を適用するためのbean定義は以下の通りである。
なお、<a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw-web-multi-blank">ブランクプロジェクト</a>には<code class="docutils literal"><span class="pre">AuthenticationPrincipalArgumentResolver</span></code>が設定済みである。</p>
<ul class="simple">
<li>spring-mvc.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span>  <span class="nt">&lt;mvc:annotation-driven&gt;</span>
      <span class="nt">&lt;mvc:argument-resolvers&gt;</span>
          <span class="c">&lt;!-- omitted --&gt;</span>
          <span class="c">&lt;!-- (1) --&gt;</span>
          <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.method.annotation.AuthenticationPrincipalArgumentResolver&quot;</span> <span class="nt">/&gt;</span>
          <span class="c">&lt;!-- omitted --&gt;</span>
      <span class="nt">&lt;/mvc:argument-resolvers&gt;</span>
<span class="nt">&lt;/mvc:annotation-driven&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">HandlerMethodArgumentResolver</span></code>の実装クラスとして、<code class="docutils literal"><span class="pre">AuthenticationPrincipalArgumentResolver</span></code>をSpring MVCに適用する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>認証情報(<code class="docutils literal"><span class="pre">UserDetails</span></code>)をコントローラーのメソッドで受け取る際は、以下のようなメソッドを作成する。</p>
<ul class="simple">
<li>認証情報(UserDetails)を受け取るメソッドの作成例</li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;account&quot;</span><span class="p">)</span>
<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountController</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">view</span><span class="p">(</span>
            <span class="nd">@AuthenticationPrincipal</span> <span class="n">AccountUserDetails</span> <span class="n">userDetails</span><span class="p">,</span> <span class="c1">// (1)</span>
            <span class="n">Model</span> <span class="n">model</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="n">userDetails</span><span class="p">.</span><span class="na">getAccount</span><span class="p">());</span>
        <span class="k">return</span> <span class="s">&quot;profile&quot;</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証情報(<code class="docutils literal"><span class="pre">UserDetails</span></code>) を受け取るための引数を宣言し、<code class="docutils literal"><span class="pre">&#64;org.springframework.security.core.annotation.AuthenticationPrincipal</span></code>を引数アノテーションとして指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">AuthenticationPrincipalArgumentResolver</span></code>は、<code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code>が付与されている引数に認証情報(<code class="docutils literal"><span class="pre">UserDetails</span></code>)が設定される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-extend">
<span id="springsecurityauthenticationhowtoextend"></span><h2><a class="toc-backref" href="#id107">9.2.3. How to extend</a><a class="headerlink" href="#how-to-extend" title="Permalink to this headline">¶</a></h2>
<p>本節では、Spring Securityが用意しているカスタマイズポイントや拡張方法について説明する。</p>
<p>Spring Securityは、多くのカスタマイズポイントを提供しているため、すべてのカスタマイズポイントを紹介することはできないため、ここでは代表的なカスタマイズポイントに絞って説明を行う。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="springsecurityauthenticationcustomizingform">
<span id="id28"></span><h3><a class="toc-backref" href="#id108">9.2.3.1. フォーム認証のカスタマイズ</a><a class="headerlink" href="#springsecurityauthenticationcustomizingform" title="Permalink to this headline">¶</a></h3>
<p>フォーム認証処理のカスタマイズポイントを説明する。</p>
<div class="section" id="id29">
<h4><a class="toc-backref" href="#id109">9.2.3.1.1. 認証パスの変更</a><a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h4>
<p>Spring Securityのデフォルトでは、認証処理を実行するためのパスは「<code class="docutils literal"><span class="pre">/login</span></code>」であるが、
以下のようなbean定義を行うことで変更することが可能である。</p>
<ul class="simple">
<li>spring-security.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http&gt;</span>
    <span class="nt">&lt;sec:form-login</span> <span class="na">login-processing-url=</span><span class="s">&quot;/authentication&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">login-processing-url</span></code>属性に認証処理を行うためのパスを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">認証処理のパスを変更した場合は、<a class="reference internal" href="#springsecurityauthenticationloginform"><span class="std std-ref">ログインフォーム</span></a> のリクエスト先も変更する必要がある。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id30">
<h4><a class="toc-backref" href="#id110">9.2.3.1.2. 資格情報を送るリクエストパラメータ名の変更</a><a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h4>
<p>Spring Securityのデフォルトでは、資格情報(ユーザー名とパスワード)を送るためのリクエストパラメータは「<code class="docutils literal"><span class="pre">username</span></code>」と「<code class="docutils literal"><span class="pre">password</span></code>」であるが、
以下のようなbean定義を行うことで変更することが可能である。</p>
<ul class="simple">
<li>spring-security.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http&gt;</span>
    <span class="nt">&lt;sec:form-login</span>
        <span class="na">username-parameter=</span><span class="s">&quot;uid&quot;</span>
        <span class="na">password-parameter=</span><span class="s">&quot;pwd&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) (2) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">username-parameter</span></code>属性にユーザー名のリクエストパラメータ名を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">password-parameter</span></code>属性にパスワードのリクエストパラメータ名を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">リクエストパラメータ名を変更した場合は、<a class="reference internal" href="#springsecurityauthenticationloginform"><span class="std std-ref">ログインフォーム</span></a> 内の項目名も変更する必要がある。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id31">
<h3><a class="toc-backref" href="#id111">9.2.3.2. 認証成功時のレスポンスのカスタマイズ</a><a class="headerlink" href="#id31" title="Permalink to this headline">¶</a></h3>
<p>認証成功時のレスポンスのカスタマイズポイントを説明する。</p>
<div class="section" id="id32">
<h4><a class="toc-backref" href="#id112">9.2.3.2.1. デフォルト遷移先の変更</a><a class="headerlink" href="#id32" title="Permalink to this headline">¶</a></h4>
<p>ログインフォームを自分で表示して認証処理を行った後の遷移先(デフォルトURL)は、
Webアプリケーションのルートパス(“<code class="docutils literal"><span class="pre">/</span></code>” )だが、以下のようなbean定義を行うことで変更することが可能である。</p>
<ul class="simple">
<li>spring-security.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http&gt;</span>
    <span class="nt">&lt;sec:form-login</span> <span class="na">default-target-url=</span><span class="s">&quot;/menu&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">default-target-url</span></code>属性に認証成功時に遷移するデフォルトのパスを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id33">
<h4><a class="toc-backref" href="#id113">9.2.3.2.2. 遷移先の固定化</a><a class="headerlink" href="#id33" title="Permalink to this headline">¶</a></h4>
<p>Spring Securityのデフォルトの動作では、未認証時に認証が必要なページへのリクエストを受信した場合は、受信したリクエストを一旦HTTPセッションに保存し、認証ページに遷移する。
認証成功時にリクエストを復元してリダイレクトするが、以下のようなbean定義を行うことで常に同じ画面に遷移させることが可能である。</p>
<ul class="simple">
<li>spring-security.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http&gt;</span>
    <span class="nt">&lt;sec:form-login</span>
        <span class="na">default-target-url=</span><span class="s">&quot;/menu&quot;</span>
        <span class="na">always-use-default-target=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">always-use-default-target</span></code>属性に<code class="docutils literal"><span class="pre">true</span></code>を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="authenticationsuccesshandler">
<h4><a class="toc-backref" href="#id114">9.2.3.2.3. AuthenticationSuccessHandlerの適用</a><a class="headerlink" href="#authenticationsuccesshandler" title="Permalink to this headline">¶</a></h4>
<p>Spring Securityが提供しているデフォルトの動作をカスタマイズする仕組みだけでは要件をみたせない場合は、
以下のようなbean定義を行うことで<code class="docutils literal"><span class="pre">AuthenticationSuccessHandler</span></code>インタフェースの実装クラスを直接適用することができる。</p>
<ul class="simple">
<li>spring-security.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;authenticationSuccessHandler&quot;</span> <span class="na">class=</span><span class="s">&quot;com.example.app.security.handler.MyAuthenticationSuccessHandler&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

<span class="nt">&lt;sec:http&gt;</span>
    <span class="nt">&lt;sec:form-login</span> <span class="na">authentication-success-handler-ref=</span><span class="s">&quot;authenticationSuccessHandler&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthenticationSuccessHandler</span></code>インタフェースの実装クラスをbean定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">authentication-success-handler-ref</span></code>属性に定義した<code class="docutils literal"><span class="pre">authenticationSuccessHandler</span></code>を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>AuthenticationSuccessHandlerの責務</strong></p>
<p><code class="docutils literal"><span class="pre">AuthenticationSuccessHandler</span></code>は、認証成功時におけるWeb層の処理(主に画面遷移に関する処理)を行うためのインタフェースである。
そのため、認証失敗回数のクリアなどのビジネスルールに依存する処理（ビジネスロジック）をこのインタフェースの実装クラスを経由して呼び出すべきではない。</p>
<p class="last">ビジネスルールに依存する処理の呼び出しは、前節で紹介している「<a class="reference internal" href="#springsecurityauthenticationevent"><span class="std std-ref">認証イベントのハンドリング</span></a>」の仕組みを使用されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="springsecurityauthenticationcustomizingscreenflowonfailure">
<span id="id34"></span><h3><a class="toc-backref" href="#id115">9.2.3.3. 認証失敗時のレスポンスのカスタマイズ</a><a class="headerlink" href="#springsecurityauthenticationcustomizingscreenflowonfailure" title="Permalink to this headline">¶</a></h3>
<p>認証失敗時のレスポンスのカスタマイズポイントを説明する。</p>
<div class="section" id="id35">
<h4><a class="toc-backref" href="#id116">9.2.3.3.1. 遷移先の変更</a><a class="headerlink" href="#id35" title="Permalink to this headline">¶</a></h4>
<p>Spring Securityのデフォルトの動作では、ログインフォームを表示するためのパスに<code class="docutils literal"><span class="pre">error</span></code>というクエリパラメータが付与されたURLにリダイレクトするが、
以下のようなbean定義を行うことで変更することが可能である。</p>
<ul class="simple">
<li>spring-security.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http&gt;</span>
    <span class="nt">&lt;sec:form-login</span> <span class="na">authentication-failure-url=</span><span class="s">&quot;/loginFailure&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">authentication-failure-url</span></code>属性に認証失敗時に遷移するパスを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="authenticationfailurehandler">
<h4><a class="toc-backref" href="#id117">9.2.3.3.2. AuthenticationFailureHandlerの適用</a><a class="headerlink" href="#authenticationfailurehandler" title="Permalink to this headline">¶</a></h4>
<p>Spring Securityが提供しているデフォルトの動作をカスタマイズする仕組みだけでは要件をみたせない場合は、
以下のようなbean定義を行うことで<code class="docutils literal"><span class="pre">AuthenticationFailureHandler</span></code>インタフェースの実装クラスを直接適用することができる。</p>
<ul class="simple">
<li>spring-security.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span> <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;authenticationFailureHandler&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.ExceptionMappingAuthenticationFailureHandler&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultFailureUrl&quot;</span> <span class="na">value=</span><span class="s">&quot;/login/systemError&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionMappings&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
        <span class="nt">&lt;props&gt;</span>
            <span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">&quot;org.springframework.security.authentication.BadCredentialsException&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
                /login/badCredentials
            <span class="nt">&lt;/prop&gt;</span>
            <span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">&quot;org.springframework.security.core.userdetails.UsernameNotFoundException&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (5) --&gt;</span>
                /login/usernameNotFound
            <span class="nt">&lt;/prop&gt;</span>
            <span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">&quot;org.springframework.security.authentication.DisabledException&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (6) --&gt;</span>
                /login/disabled
            <span class="nt">&lt;/prop&gt;</span>
            <span class="c">&lt;!-- omitted --&gt;</span>
        <span class="nt">&lt;/props&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;sec:http&gt;</span>
    <span class="nt">&lt;sec:form-login</span> <span class="na">authentication-failure-handler-ref=</span><span class="s">&quot;authenticationFailureHandler&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (7) --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthenticationFailureHandler</span></code>インタフェースの実装クラスをbean定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">defaultFailureUrl</span></code>属性にデフォルトの遷移先のURLを指定する。</div>
<div class="line">下記(4)-(6)の定義に合致しない例外が発生した際は、本設定の遷移先に遷移する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">exceptionMappings</span></code>プロパティにハンドルする<code class="docutils literal"><span class="pre">org.springframework.security.authentication.AuthenticationServiceException</span></code>の実装クラスと例外発生時の遷移先を <code class="docutils literal"><span class="pre">Map</span></code>形式で設定する。</div>
<div class="line">キーに<code class="docutils literal"><span class="pre">org.springframework.security.authentication.AuthenticationServiceException</span></code>実装クラスを設定し、値に遷移先URLを設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">BadCredentialsException</span></code></div>
<div class="line">パスワード照合失敗による認証エラー時にスローされる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UsernameNotFoundException</span></code></div>
<div class="line">不正ユーザーID（存在しないユーザーID）による認証エラー時にスローされる。</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.security.authentication.dao.AbstractUserDetailsAuthenticationProvider</span></code>を</div>
<div class="line">継承したクラスを認証プロバイダに指定している場合、<code class="docutils literal"><span class="pre">hideUserNotFoundExceptions</span></code>プロパティを<code class="docutils literal"><span class="pre">false</span></code>に変更しないと本例外は、<code class="docutils literal"><span class="pre">BadCredentialsException</span></code>に変更される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"> <code class="docutils literal"><span class="pre">DisabledException</span></code></div>
<div class="line">無効ユーザーIDによる認証エラー時にスローされる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">authentication-failure-handler-ref</span></code>属性に<code class="docutils literal"><span class="pre">authenticationFailureHandler</span></code>を設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>例外発生時の制御</strong></p>
<p><code class="docutils literal"><span class="pre">exceptionMappings</span></code>プロパティに定義した例外が発生した場合、例外にマッピングした遷移先にリダイレクトされるが、
発生した例外オブジェクトがセッションスコープに格納されないため、Spring Securityが生成したエラーメッセージを画面に表示する事ができない。</p>
<p>そのため、遷移先の画面で表示するエラーメッセージは、リダイレクト先の処理(Controller又はViewの処理)で生成する必要がある。</p>
<p>また、以下のプロパティを参照する処理が呼び出されないため、設定値を変更しても動作が変わらないという点を補足しておく。</p>
<ul class="last simple">
<li><code class="docutils literal"><span class="pre">useForward</span></code></li>
<li><code class="docutils literal"><span class="pre">allowSessionCreation</span></code></li>
</ul>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id36">
<h3><a class="toc-backref" href="#id118">9.2.3.4. ログアウト処理のカスタマイズ</a><a class="headerlink" href="#id36" title="Permalink to this headline">¶</a></h3>
<p>ログアウト処理のカスタマイズポイントを説明する。</p>
<div class="section" id="id37">
<h4><a class="toc-backref" href="#id119">9.2.3.4.1. ログアウトパスの変更</a><a class="headerlink" href="#id37" title="Permalink to this headline">¶</a></h4>
<p>Spring Securityのデフォルトでは、ログアウト処理を実行するためのパスは「<code class="docutils literal"><span class="pre">/logout</span></code>」であるが、
以下のようなbean定義を行うことで変更することが可能である。</p>
<ul class="simple">
<li>spring-security.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
    <span class="nt">&lt;sec:logout</span> <span class="na">logout-url=</span><span class="s">&quot;/auth/logout&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">logout-url</span></code>属性を設定し、ログアウト処理を行うパスを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ログアウトパスを変更した場合は、<a class="reference internal" href="#springsecurityauthenticationlogoutform"><span class="std std-ref">ログアウトフォーム</span></a> のリクエスト先も変更する必要がある。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>システムエラー発生時の振る舞い</strong>
システムエラーが発生した場合は、業務継続不可となるケースが多いと考えられる。
システムエラー発生後、業務を継続させたくない場合は、以下のような対策を講じることを推奨する。</p>
<blockquote>
<div><ul class="simple">
<li>システムエラー発生時にセッション情報をクリアする。</li>
<li>システムエラー発生時に認証情報をクリアする。</li>
</ul>
</div></blockquote>
<p>ここでは、共通ライブラリの例外ハンドリング機能を使用してシステム例外発生時に認証情報をクリアする例を説明する。
例外ハンドリング機能の詳細については「<a class="reference internal" href="../ArchitectureInDetail/WebApplicationDetail/ExceptionHandling.html"><span class="doc">例外ハンドリング</span></a>」を参照されたい。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogoutSystemExceptionResolver</span> <span class="kd">extends</span> <span class="n">SystemExceptionResolver</span> <span class="p">{</span>
    <span class="c1">// (2)</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">ModelAndView</span> <span class="nf">doResolveException</span><span class="p">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="p">,</span>
            <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="p">,</span> <span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">Object</span> <span class="n">handler</span><span class="p">,</span>
            <span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">Exception</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// SystemExceptionResolverの処理を行う</span>
        <span class="n">ModelAndView</span> <span class="n">resulut</span> <span class="o">=</span> <span class="kd">super</span><span class="p">.</span><span class="na">doResolveException</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span>
                <span class="n">handler</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>

        <span class="c1">// 認証情報をクリアする (2)</span>
        <span class="n">SecurityContextHolder</span><span class="p">.</span><span class="na">clearContext</span><span class="p">();</span>

        <span class="k">return</span> <span class="n">resulut</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.terasoluna.gfw.web.exception.SystemExceptionResolver.SystemExceptionResolver</span></code>を拡張する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証情報をクリアする。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p class="last">なお、認証情報をクリアする方法以外にも、セッションをクリアすることでも、同様の要件を満たすことができる。
プロジェクトの要件に合わせて実装されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="springsecuritylogoutcustomizingscreenflowonsuccess">
<span id="id38"></span><h3><a class="toc-backref" href="#id120">9.2.3.5. ログアウト成功時のレスポンスのカスタマイズ</a><a class="headerlink" href="#springsecuritylogoutcustomizingscreenflowonsuccess" title="Permalink to this headline">¶</a></h3>
<p>ログアウト処理成功時のレスポンスのカスタマイズポイントを説明する。</p>
<div class="section" id="id39">
<h4><a class="toc-backref" href="#id121">9.2.3.5.1. 遷移先の変更</a><a class="headerlink" href="#id39" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>spring-security.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
    <span class="nt">&lt;sec:logout</span> <span class="na">logout-success-url=</span><span class="s">&quot;/logoutSuccess&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">logout-success-url</span></code>属性を設定し、ログアウト成功時に遷移するパスを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="logoutsuccesshandler">
<h4><a class="toc-backref" href="#id122">9.2.3.5.2. LogoutSuccessHandlerの適用</a><a class="headerlink" href="#logoutsuccesshandler" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>spring-security.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;logoutSuccessHandler&quot;</span> <span class="na">class=</span><span class="s">&quot;com.example.app.security.handler.MyLogoutSuccessHandler&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;sec:http&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
    <span class="nt">&lt;sec:logout</span> <span class="na">success-handler-ref=</span><span class="s">&quot;logoutSuccessHandler&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">LogoutSuccessHandler</span></code>インタフェースの実装クラスをbean定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">success-handler-ref</span></code>属性に<code class="docutils literal"><span class="pre">LogoutSuccessHandler</span></code>を設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="springsecurityauthenticationcustomizingmessage">
<span id="id40"></span><h3><a class="toc-backref" href="#id123">9.2.3.6. エラーメッセージのカスタマイズ</a><a class="headerlink" href="#springsecurityauthenticationcustomizingmessage" title="Permalink to this headline">¶</a></h3>
<p>認証に失敗した場合、Spring Securityが用意しているエラーメッセージが表示されるが、
このエラーメッセージは変更することが可能である。</p>
<p>メッセージ変更方法の詳細については、<a class="reference internal" href="../ArchitectureInDetail/WebApplicationDetail/MessageManagement.html"><span class="doc">メッセージ管理</span></a>を参照されたい。</p>
<div class="section" id="id41">
<h4><a class="toc-backref" href="#id124">9.2.3.6.1. システムエラー時のメッセージ</a><a class="headerlink" href="#id41" title="Permalink to this headline">¶</a></h4>
<p>認証処理の中で予期しないエラー（システムエラーなど）が発生した場合、<code class="docutils literal"><span class="pre">InternalAuthenticationServiceException</span></code>という例外が発生する。
<code class="docutils literal"><span class="pre">InternalAuthenticationServiceException</span></code>が保持するメッセージには、原因例外のメッセージが設定されるため、画面にそのまま表示するのは適切ではない。</p>
<p>例えばユーザー情報をデーターベースから取得する時にDBアクセスエラーが発生した場合、<code class="docutils literal"><span class="pre">SQLException</span></code>が保持する例外メッセージが画面に表示されることになる。
システムエラーの例外メッセージを画面に表示させないためには、<code class="docutils literal"><span class="pre">ExceptionMappingAuthenticationFailureHandler</span></code>を使用して<code class="docutils literal"><span class="pre">InternalAuthenticationServiceException</span></code>をハンドリングし、
システムエラーが発生したことを通知するためのパスに遷移させるなどの対応が必要となる。</p>
<ul class="simple">
<li>spring-security.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span>  <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;authenticationFailureHandler&quot;</span>
      <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.ExceptionMappingAuthenticationFailureHandler&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultFailureUrl&quot;</span> <span class="na">value=</span><span class="s">&quot;/login?error&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionMappings&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;props&gt;</span>
              <span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">&quot;org.springframework.security.authentication.InternalAuthenticationServiceException&quot;</span><span class="nt">&gt;</span>
                  /login?systemError
              <span class="nt">&lt;/prop&gt;</span>
              <span class="c">&lt;!-- omitted --&gt;</span>
          <span class="nt">&lt;/props&gt;</span>
      <span class="nt">&lt;/property&gt;</span>
  <span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;sec:http&gt;</span>
    <span class="nt">&lt;sec:form-login</span> <span class="na">authentication-failure-handler-ref=</span><span class="s">&quot;authenticationFailureHandler&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>ここでは、システムエラーが発生したことを識別するためのクエリパラメータ(<code class="docutils literal"><span class="pre">systemError</span></code>)を付けてログインフォームに遷移させている。
遷移先に指定したログインフォームでは、クエリパラメータに<code class="docutils literal"><span class="pre">systemError</span></code>が指定されている場合は、認証例外のメッセージを表示するのではなく、
固定のエラーメッセージを表示するようにしている。</p>
<ul class="simple">
<li>ログインフォームの実装例</li>
</ul>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;c:choose&gt;</span>
    <span class="nt">&lt;c:when</span> <span class="na">test=</span><span class="s">&quot;${param.containsKey(&#39;error&#39;)}&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;span</span> <span class="na">style=</span><span class="s">&quot;color: red;&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;c:out</span> <span class="na">value=</span><span class="s">&quot;${SPRING_SECURITY_LAST_EXCEPTION.message}&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;/c:when&gt;</span>
    <span class="nt">&lt;c:when</span> <span class="na">test=</span><span class="s">&quot;${param.containsKey(&#39;systemError&#39;)}&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;span</span> <span class="na">style=</span><span class="s">&quot;color: red;&quot;</span><span class="nt">&gt;</span>
            System Error occurred.
        <span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;/c:when&gt;</span>
<span class="nt">&lt;/c:choose&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ここでは、ログインフォームに遷移させる場合の実装例を紹介したが、システムエラー画面に遷移させてもよい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="springsecurityauthenticationbeanvalidation">
<span id="id42"></span><h3><a class="toc-backref" href="#id125">9.2.3.7. 認証時の入力チェック</a><a class="headerlink" href="#springsecurityauthenticationbeanvalidation" title="Permalink to this headline">¶</a></h3>
<p>DBサーバへの負荷軽減等で、認証ページにおける、あきらかな入力誤りに対しては、事前にチェックを行いたい場合がある。
このような場合は、Bean Validationを使用した入力チェックも可能である。</p>
<div class="section" id="bean-validation">
<h4><a class="toc-backref" href="#id126">9.2.3.7.1. Bean Validationによる入力チェック</a><a class="headerlink" href="#bean-validation" title="Permalink to this headline">¶</a></h4>
<p>以下にBean Validationを使用した入力チェックの例を説明する。
Bean Validationに関する詳細は <a class="reference internal" href="../ArchitectureInDetail/WebApplicationDetail/Validation.html"><span class="doc">入力チェック</span></a>を参照すること。</p>
<ul class="simple">
<li>フォームクラスの実装例</li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="c1">// omitted</span>
    <span class="nd">@NotEmpty</span> <span class="c1">// (1)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="p">;</span>

    <span class="nd">@NotEmpty</span> <span class="c1">// (1)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="p">;</span>
    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本例では、<code class="docutils literal"><span class="pre">username</span></code>、<code class="docutils literal"><span class="pre">password</span></code>をそれぞれ必須入力としている。</div>
</div>
</td>
</tr>
</tbody>
</table>
<ul class="simple">
<li>コントローラクラスの実装例</li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@ModelAttribute</span>
<span class="kd">public</span> <span class="n">LoginForm</span> <span class="nf">setupForm</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// (1)</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">LoginForm</span><span class="p">();</span>
<span class="p">}</span>

<span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;login&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">login</span><span class="p">(</span><span class="nd">@Validated</span> <span class="n">LoginForm</span> <span class="n">form</span><span class="p">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// omitted</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">hasErrors</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">// omitted</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="s">&quot;forward:/authenticate&quot;</span><span class="p">;</span> <span class="c1">// (2)</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">LoginForm</span></code>を初期化する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">forwardで<code class="docutils literal"><span class="pre">&lt;sec:form-login&gt;</span></code>要素の<code class="docutils literal"><span class="pre">login-processing-url</span></code>属性に指定したパスに <strong>Forward</strong> する。</div>
<div class="line">認証に関する設定は、<a class="reference internal" href="#springsecurityauthenticationcustomizingform"><span class="std std-ref">フォーム認証のカスタマイズ</span></a>を参照すること。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>加えて、Forwardによる遷移でもSpring Securityの処理が行われるよう、認証パスをSpring Securityサーブレットフィルタに追加する。</p>
<ul class="simple">
<li>web.xmlの設定例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;filter&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>springSecurityFilterChain<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;filter-class&gt;</span>
        org.springframework.web.filter.DelegatingFilterProxy
    <span class="nt">&lt;/filter-class&gt;</span>
<span class="nt">&lt;/filter&gt;</span>
<span class="nt">&lt;filter-mapping&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>springSecurityFilterChain<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
<span class="nt">&lt;/filter-mapping&gt;</span>
<span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;filter-mapping&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>springSecurityFilterChain<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>/authenticate<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;dispatcher&gt;</span>FORWARD<span class="nt">&lt;/dispatcher&gt;</span>
<span class="nt">&lt;/filter-mapping&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Forwardで認証するためのパターンを指定する</div>
<div class="line">ここでは認証パスである<code class="docutils literal"><span class="pre">/authenticate</span></code>を指定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id43">
<h3><a class="toc-backref" href="#id127">9.2.3.8. 認証処理の拡張</a><a class="headerlink" href="#id43" title="Permalink to this headline">¶</a></h3>
<p>Spring Securityから提供されている<a class="reference external" href="https://docs.spring.io/spring-security/site/docs/5.2.1.RELEASE/api/org/springframework/security/authentication/AuthenticationProvider.html">認証プロバイダ</a>で対応できない認証要件がある場合は、
<code class="docutils literal"><span class="pre">org.springframework.security.authentication.AuthenticationProvider</span></code>インタフェースを実装したクラスを作成する必要がある。</p>
<p>ここでは、ユーザー名、パスワード、<strong>会社識別子(独自の認証パラメータ)</strong>の3つのパラメータを使用してDB認証を行うための拡張例を示す。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/Authentication_HowToExtends_LoginForm.png"><img alt="Authentication_HowToExtends_LoginForm" src="../_images/Authentication_HowToExtends_LoginForm.png" style="width: 50%;" /></a>
</div>
<p>上記の要件を実現するためには、以下に示すクラスを作成する必要がある。</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザー名、パスワード、会社識別子を保持する<code class="docutils literal"><span class="pre">org.springframework.security.core.Authentication</span></code>インタフェースの実装クラス。</div>
<div class="line">ここでは、<code class="docutils literal"><span class="pre">org.springframework.security.authentication.UsernamePasswordAuthenticationToken</span></code>クラスを継承して作成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザー名、パスワード、会社識別子を使用してDB認証を行う<code class="docutils literal"><span class="pre">org.springframework.security.authentication.AuthenticationProvider</span></code>の実装クラス。</div>
<div class="line">ここでは、<code class="docutils literal"><span class="pre">org.springframework.security.authentication.dao.DaoAuthenticationProvider</span></code>クラスを継承して作成する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザー名、パスワード、会社識別子をリクエストパラメータから取得して、<code class="docutils literal"><span class="pre">AuthenticationManager</span></code>(<code class="docutils literal"><span class="pre">AuthenticationProvider</span></code>)に渡す<code class="docutils literal"><span class="pre">Authentication</span></code>を生成するためのAuthentication Filterクラス。</div>
<div class="line">ここでは、<code class="docutils literal"><span class="pre">org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter</span></code>クラスを継承して作成する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>ここでは、認証用のパラメータとして独自のパラメータを追加する例にしているため、
<code class="docutils literal"><span class="pre">Authentication</span></code>インタフェースの実装クラスと<code class="docutils literal"><span class="pre">Authentication</span></code>を生成するためのAuthentication Filterクラスの拡張が必要となる。</p>
<p class="last">ユーザー名とパスワードのみで認証する場合は、<code class="docutils literal"><span class="pre">AuthenticationProvider</span></code>インタフェースの実装クラスを作成するだけで、
認証処理を拡張することができる。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="authentication">
<h4><a class="toc-backref" href="#id128">9.2.3.8.1. Authenticationインタフェースの実装クラスの作成</a><a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">UsernamePasswordAuthenticationToken</span></code>クラスを継承し、ユーザー名とパスワードに加えて、会社識別子(独自の認証パラメータ)を保持するクラスを作成する。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// import omitted</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompanyIdUsernamePasswordAuthenticationToken</span> <span class="kd">extends</span>
    <span class="n">UsernamePasswordAuthenticationToken</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">SpringSecurityCoreVersion</span><span class="p">.</span><span class="na">SERIAL_VERSION_UID</span><span class="p">;</span>

    <span class="c1">// (1)</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">companyId</span><span class="p">;</span>

    <span class="c1">// (2)</span>
    <span class="kd">public</span> <span class="nf">CompanyIdUsernamePasswordAuthenticationToken</span><span class="p">(</span>
            <span class="n">Object</span> <span class="n">principal</span><span class="p">,</span> <span class="n">Object</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">String</span> <span class="n">companyId</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">super</span><span class="p">(</span><span class="n">principal</span><span class="p">,</span> <span class="n">credentials</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="na">companyId</span> <span class="o">=</span> <span class="n">companyId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// (3)</span>
    <span class="kd">public</span> <span class="nf">CompanyIdUsernamePasswordAuthenticationToken</span><span class="p">(</span>
            <span class="n">Object</span> <span class="n">principal</span><span class="p">,</span> <span class="n">Object</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">String</span> <span class="n">companyId</span><span class="p">,</span>
            <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">super</span><span class="p">(</span><span class="n">principal</span><span class="p">,</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">authorities</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="na">companyId</span> <span class="o">=</span> <span class="n">companyId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getCompanyId</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">companyId</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">会社識別子を保持するフィールドを作成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証前の情報(リクエストパラメータで指定された情報)を保持するインスタンスを作成する際に使用するコンストラクタを作成する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証済みの情報を保持するインスタンスを作成する際に使用するコンストラクタを作成する。</div>
<div class="line">親クラスのコンストラクタの引数に認可情報を渡すことで、認証済みの状態となる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id45">
<h4><a class="toc-backref" href="#id129">9.2.3.8.2. AuthenticationProviderインタフェースの実装クラスの作成</a><a class="headerlink" href="#id45" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">DaoAuthenticationProvider</span></code>クラスを継承し、ユーザー名、パスワード、会社識別子を使用してDB認証を行うクラスを作成する。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// import omitted</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompanyIdUsernamePasswordAuthenticationProvider</span> <span class="kd">extends</span>
    <span class="n">DaoAuthenticationProvider</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">additionalAuthenticationChecks</span><span class="p">(</span><span class="n">UserDetails</span> <span class="n">userDetails</span><span class="p">,</span>
            <span class="n">UsernamePasswordAuthenticationToken</span> <span class="n">authentication</span><span class="p">)</span>
            <span class="kd">throws</span> <span class="n">AuthenticationException</span> <span class="p">{</span>

        <span class="c1">// (1)</span>
        <span class="kd">super</span><span class="p">.</span><span class="na">additionalAuthenticationChecks</span><span class="p">(</span><span class="n">userDetails</span><span class="p">,</span> <span class="n">authentication</span><span class="p">);</span>

        <span class="c1">// (2)</span>
        <span class="n">CompanyIdUsernamePasswordAuthenticationToken</span> <span class="n">companyIdUsernamePasswordAuthentication</span> <span class="o">=</span>
                <span class="p">(</span><span class="n">CompanyIdUsernamePasswordAuthenticationToken</span><span class="p">)</span> <span class="n">authentication</span><span class="p">;</span>
        <span class="n">String</span> <span class="n">requestedCompanyId</span> <span class="o">=</span> <span class="n">companyIdUsernamePasswordAuthentication</span><span class="p">.</span><span class="na">getCompanyId</span><span class="p">();</span>
        <span class="n">String</span> <span class="n">companyId</span> <span class="o">=</span> <span class="p">((</span><span class="n">SampleUserDetails</span><span class="p">)</span> <span class="n">userDetails</span><span class="p">).</span><span class="na">getAccount</span><span class="p">().</span><span class="na">getCompanyId</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">companyId</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">requestedCompanyId</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">BadCredentialsException</span><span class="p">(</span><span class="n">messages</span><span class="p">.</span><span class="na">getMessage</span><span class="p">(</span>
                    <span class="s">&quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;</span><span class="p">,</span>
                    <span class="s">&quot;Bad credentials&quot;</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">Authentication</span> <span class="nf">createSuccessAuthentication</span><span class="p">(</span><span class="n">Object</span> <span class="n">principal</span><span class="p">,</span>
            <span class="n">Authentication</span> <span class="n">authentication</span><span class="p">,</span> <span class="n">UserDetails</span> <span class="n">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">companyId</span> <span class="o">=</span> <span class="p">((</span><span class="n">SampleUserDetails</span><span class="p">)</span> <span class="n">user</span><span class="p">).</span><span class="na">getAccount</span><span class="p">()</span>
                <span class="p">.</span><span class="na">getCompanyId</span><span class="p">();</span>
        <span class="c1">// (3)</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">CompanyIdUsernamePasswordAuthenticationToken</span><span class="p">(</span><span class="n">user</span><span class="p">,</span>
                <span class="n">authentication</span><span class="p">.</span><span class="na">getCredentials</span><span class="p">(),</span> <span class="n">companyId</span><span class="p">,</span>
                <span class="n">user</span><span class="p">.</span><span class="na">getAuthorities</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supports</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">authentication</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// (4)</span>
        <span class="k">return</span> <span class="n">CompanyIdUsernamePasswordAuthenticationToken</span><span class="p">.</span><span class="na">class</span>
                <span class="p">.</span><span class="na">isAssignableFrom</span><span class="p">(</span><span class="n">authentication</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">親クラスのメソッドを呼び出し、Spring Securityが提供しているチェック処理を実行する。</div>
<div class="line">この処理にはパスワード認証処理も含まれる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード認証が成功した場合は、会社識別子(独自の認証パラメータ)の妥当性をチェックする。</div>
<div class="line">上記例では、リクエストされた会社識別子とテーブルに保持している会社識別子が一致するかをチェックしている。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード認証及び独自の認証処理が成功した場合は、認証済み状態の<code class="docutils literal"><span class="pre">CompanyIdUsernamePasswordAuthenticationToken</span></code>を作成して返却する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">CompanyIdUsernamePasswordAuthenticationToken</span></code>にキャスト可能な<code class="docutils literal"><span class="pre">Authentication</span></code>が指定された場合に、本クラスを使用して認証処理を行うようにする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ユーザーの存在チェック、ユーザーの状態チェック(無効ユーザー、ロック中ユーザー、利用期限切れユーザーなどのチェック)は、
<code class="docutils literal"><span class="pre">additionalAuthenticationChecks</span></code>メソッドが呼び出される前に親クラスの処理として行われる。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="authentication-custom-usernamepasswordauthenticationfilter">
<span id="id46"></span><h4><a class="toc-backref" href="#id130">9.2.3.8.3. Authentication Filterの作成</a><a class="headerlink" href="#authentication-custom-usernamepasswordauthenticationfilter" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">UsernamePasswordAuthenticationFilter</span></code>クラスを継承し、
認証情報(ユーザー名、パスワード、会社識別子)を<code class="docutils literal"><span class="pre">AuthenticationProvider</span></code>に引き渡すためのAuthentication Filterクラスを作成する。</p>
<p><code class="docutils literal"><span class="pre">attemptAuthentication</span></code>メソッドの実装は、<code class="docutils literal"><span class="pre">UsernamePasswordAuthenticationFilter</span></code>クラスのメソッドをコピーしてカスタマイズしたものである。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// import omitted</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompanyIdUsernamePasswordAuthenticationFilter</span> <span class="kd">extends</span>
    <span class="n">UsernamePasswordAuthenticationFilter</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Authentication</span> <span class="nf">attemptAuthentication</span><span class="p">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="p">,</span>
            <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">AuthenticationException</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request</span><span class="p">.</span><span class="na">getMethod</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;POST&quot;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">AuthenticationServiceException</span><span class="p">(</span><span class="s">&quot;Authentication method not supported: &quot;</span>
                    <span class="o">+</span> <span class="n">request</span><span class="p">.</span><span class="na">getMethod</span><span class="p">());</span>
        <span class="p">}</span>

        <span class="c1">// (1)</span>
        <span class="c1">// Obtain UserName, Password, CompanyId</span>
        <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="kd">super</span><span class="p">.</span><span class="na">obtainUsername</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
        <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="kd">super</span><span class="p">.</span><span class="na">obtainPassword</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
        <span class="n">String</span> <span class="n">companyId</span> <span class="o">=</span> <span class="n">obtainCompanyId</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">username</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">username</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">username</span><span class="p">.</span><span class="na">trim</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">password</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">password</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">CompanyIdUsernamePasswordAuthenticationToken</span> <span class="n">authRequest</span> <span class="o">=</span>
            <span class="k">new</span> <span class="n">CompanyIdUsernamePasswordAuthenticationToken</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">companyId</span><span class="p">);</span>

        <span class="c1">// Allow subclasses to set the &quot;details&quot; property</span>
        <span class="n">setDetails</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">authRequest</span><span class="p">);</span>

        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">getAuthenticationManager</span><span class="p">().</span><span class="na">authenticate</span><span class="p">(</span><span class="n">authRequest</span><span class="p">);</span> <span class="c1">// (2)</span>
    <span class="p">}</span>

    <span class="c1">// (3)</span>
    <span class="kd">protected</span> <span class="n">String</span> <span class="nf">obtainCompanyId</span><span class="p">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">request</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&quot;companyId&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエストパラメータから取得した認証情報(ユーザー名、パスワード、会社識別子)より、<code class="docutils literal"><span class="pre">CompanyIdUsernamePasswordAuthenticationToken</span></code>のインスタンスを生成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエストパラメータで指定された認証情報(<code class="docutils literal"><span class="pre">CompanyIdUsernamePasswordAuthenticationToken</span></code>のインスタンス)を指定して、<code class="docutils literal"><span class="pre">org.springframework.security.authentication.AuthenticationManager</span></code>の<code class="docutils literal"><span class="pre">authenticate</span></code>メソッドを呼び出す。</div>
<div class="line"><br /></div>
<div class="line"><code class="docutils literal"><span class="pre">AuthenticationManager</span></code>のメソッドを呼び出すと、<code class="docutils literal"><span class="pre">AuthenticationProvider</span></code>の認証処理が呼び出される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">会社識別子は、<code class="docutils literal"><span class="pre">companyId</span></code>というリクエストパラメータより取得する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id47">
<h4><a class="toc-backref" href="#id131">9.2.3.8.4. ログインフォームの修正</a><a class="headerlink" href="#id47" title="Permalink to this headline">¶</a></h4>
<p><a class="reference internal" href="#springsecurityauthenticationloginform"><span class="std std-ref">ログインフォームの作成</span></a>で作成したログインフォーム(JSP)に対して、会社識別子を追加する。</p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;form:form</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/login&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;username&quot;</span><span class="nt">&gt;</span>User Name<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">id=</span><span class="s">&quot;username&quot;</span> <span class="na">name=</span><span class="s">&quot;username&quot;</span><span class="nt">&gt;&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;companyId&quot;</span><span class="nt">&gt;</span>Company Id<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">id=</span><span class="s">&quot;companyId&quot;</span> <span class="na">name=</span><span class="s">&quot;companyId&quot;</span><span class="nt">&gt;&lt;/td&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;password&quot;</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="na">id=</span><span class="s">&quot;password&quot;</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span><span class="nt">&gt;&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/form:form&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">会社識別子の入力フィールド名に<code class="docutils literal"><span class="pre">companyId</span></code>を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id48">
<h4><a class="toc-backref" href="#id132">9.2.3.8.5. 拡張した認証処理の適用</a><a class="headerlink" href="#id48" title="Permalink to this headline">¶</a></h4>
<p>ユーザー名、パスワード、会社識別子(独自の認証パラメータ)を使用したDB認証機能をSpring Securityに適用する。</p>
<ul class="simple">
<li>spring-security.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;sec:http</span>
    <span class="na">entry-point-ref=</span><span class="s">&quot;loginUrlAuthenticationEntryPoint&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;sec:custom-filter</span>
        <span class="na">position=</span><span class="s">&quot;FORM_LOGIN_FILTER&quot;</span> <span class="na">ref=</span><span class="s">&quot;companyIdUsernamePasswordAuthenticationFilter&quot;</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;sec:csrf</span> <span class="na">token-repository-ref=</span><span class="s">&quot;csrfTokenRepository&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;sec:logout</span>
        <span class="na">logout-url=</span><span class="s">&quot;/logout&quot;</span>
        <span class="na">logout-success-url=</span><span class="s">&quot;/login&quot;</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/login&quot;</span> <span class="na">access=</span><span class="s">&quot;permitAll&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/**&quot;</span> <span class="na">access=</span><span class="s">&quot;isAuthenticated()&quot;</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;/sec:http&gt;</span>

<span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;loginUrlAuthenticationEntryPoint&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">value=</span><span class="s">&quot;/login&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;companyIdUsernamePasswordAuthenticationFilter&quot;</span>
    <span class="na">class=</span><span class="s">&quot;com.example.app.common.security.CompanyIdUsernamePasswordAuthenticationFilter&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- (5) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;requiresAuthenticationRequestMatcher&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.util.matcher.AntPathRequestMatcher&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">value=</span><span class="s">&quot;/authentication&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span> <span class="na">value=</span><span class="s">&quot;POST&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
    <span class="c">&lt;!-- (6) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;authenticationManager&quot;</span> <span class="na">ref=</span><span class="s">&quot;authenticationManager&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- (7) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;sessionAuthenticationStrategy&quot;</span> <span class="na">ref=</span><span class="s">&quot;sessionAuthenticationStrategy&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- (8) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;authenticationFailureHandler&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.SimpleUrlAuthenticationFailureHandler&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;constructor-arg</span> <span class="na">value=</span><span class="s">&quot;/login?error=true&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
    <span class="c">&lt;!-- (9) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;authenticationSuccessHandler&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.SimpleUrlAuthenticationSuccessHandler&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- (6&#39;) --&gt;</span>
<span class="nt">&lt;sec:authentication-manager</span> <span class="na">alias=</span><span class="s">&quot;authenticationManager&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;sec:authentication-provider</span> <span class="na">ref=</span><span class="s">&quot;companyIdUsernamePasswordAuthenticationProvider&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/sec:authentication-manager&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;companyIdUsernamePasswordAuthenticationProvider&quot;</span>
    <span class="na">class=</span><span class="s">&quot;com.example.app.common.security.CompanyIdUsernamePasswordAuthenticationProvider&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;userDetailsService&quot;</span> <span class="na">ref=</span><span class="s">&quot;sampleUserDetailsService&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;passwordEncoder&quot;</span> <span class="na">ref=</span><span class="s">&quot;passwordEncoder&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- (7&#39;) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sessionAuthenticationStrategy&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.session.CompositeSessionAuthenticationStrategy&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg&gt;</span>
        <span class="nt">&lt;util:list&gt;</span>
            <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.csrf.CsrfAuthenticationStrategy&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">&quot;csrfTokenRepository&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/bean&gt;</span>
            <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.session.SessionFixationProtectionStrategy&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/util:list&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;csrfTokenRepository&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.csrf.HttpSessionCsrfTokenRepository&quot;</span> <span class="nt">/&gt;</span>


<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">(2)の<code class="docutils literal"><span class="pre">&lt;sec:custom-filter&gt;</span></code>タグを使用して<code class="docutils literal"><span class="pre">FORM_LOGIN_FILTER</span></code>を差し替える場合は、<code class="docutils literal"><span class="pre">&lt;sec:http&gt;</span></code>タグの属性に以下の設定を行う必要がある。</div>
</div>
<ul class="last simple">
<li>自動設定を使用することができないため、<code class="docutils literal"><span class="pre">auto-config=&quot;false&quot;</span></code>を指定するか、<code class="docutils literal"><span class="pre">auto-config</span></code>属性を削除する。</li>
<li><code class="docutils literal"><span class="pre">&lt;sec:form-login&gt;</span></code>タグが使用できないため、<code class="docutils literal"><span class="pre">entry-point-ref</span></code>属性を使用して<code class="docutils literal"><span class="pre">AuthenticationEntryPoint</span></code>を明示的に指定する。</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;sec:custom-filter&gt;</span></code>タグを使用して<code class="docutils literal"><span class="pre">FORM_LOGIN_FILTER</span></code>を差し替える。</div>
<div class="line"><br /></div>
<div class="line"><code class="docutils literal"><span class="pre">&lt;sec:custom-filter&gt;</span></code>タグの<code class="docutils literal"><span class="pre">position</span></code>属性に<code class="docutils literal"><span class="pre">FORM_LOGIN_FILTER</span></code>を指定し、<code class="docutils literal"><span class="pre">ref</span></code>属性に拡張したAuthentication Filterのbeanを指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;sec:http&gt;</span></code>タグの<code class="docutils literal"><span class="pre">entry-point-ref</span></code>属性に使用する<code class="docutils literal"><span class="pre">AuthenticationEntryPoint</span></code>のbeanを指定する。</div>
<div class="line"><br /></div>
<div class="line">ここでは、<code class="docutils literal"><span class="pre">&lt;sec:form-login&gt;</span></code>タグを指定した際に使用される<code class="docutils literal"><span class="pre">org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint</span></code>クラスのbeanを指定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">FORM_LOGIN_FILTER</span></code>として使用するAuthentication Filterクラスのbeanを定義する。</div>
<div class="line"><br /></div>
<div class="line">ここでは、拡張したAuthentication Filterクラス(<code class="docutils literal"><span class="pre">CompanyIdUsernamePasswordAuthenticationFilter</span></code>)のbeanを定義している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">requiresAuthenticationRequestMatcher</span></code>プロパティに、認証処理を行うリクエストを検出するための<code class="docutils literal"><span class="pre">RequestMatcher</span></code>インスタンスを指定する。</div>
<div class="line"><br /></div>
<div class="line">ここでは、<code class="docutils literal"><span class="pre">/authentication</span></code>というパスにリクエストがあった場合に認証処理を行うように設定している。</div>
<div class="line">これは、<code class="docutils literal"><span class="pre">&lt;sec:form-login&gt;</span></code>タグの<code class="docutils literal"><span class="pre">login-processing-url</span></code>属性に<code class="docutils literal"><span class="pre">/authentication</span></code>を指定したのと同義である。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">authenticationManager</span></code>プロパティに、<code class="docutils literal"><span class="pre">&lt;sec:authentication-manager&gt;</span></code>タグの<code class="docutils literal"><span class="pre">alias</span></code>属性に設定した値を指定する。</div>
<div class="line"><br /></div>
<div class="line"><code class="docutils literal"><span class="pre">&lt;sec:authentication-manager&gt;</span></code>タグの<code class="docutils literal"><span class="pre">alias</span></code>属性を指定すると、</div>
<div class="line">Spring Securityが生成した<code class="docutils literal"><span class="pre">AuthenticationManager</span></code>のbeanを、他のbeanへDIすることができる様になる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(6’)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring Securityが生成する<code class="docutils literal"><span class="pre">AuthenticationManager</span></code>に対して、拡張した<code class="docutils literal"><span class="pre">AuthenticationProvider</span></code>(<code class="docutils literal"><span class="pre">CompanyIdUsernamePasswordAuthenticationProvider</span></code>)を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">sessionAuthenticationStrategy</span></code>プロパティに、認証成功時のセッションの取り扱いを制御するコンポーネント(<code class="docutils literal"><span class="pre">SessionAuthenticationStrategy</span></code>)のbeanを指定する。</div>
<div class="line"><br /></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7’)</div>
</div>
</td>
<td><div class="first line-block">
<div class="line">認証成功時のセッションの取り扱いを制御するコンポーネント(<code class="docutils literal"><span class="pre">SessionAuthenticationStrategy</span></code>)のbeanを定義する。</div>
<div class="line"><br /></div>
<div class="line">ここでは、Spring Securityから提供されている、</div>
</div>
<ul class="simple">
<li>CSRFトークンを作り直すコンポーネント(<code class="docutils literal"><span class="pre">CsrfAuthenticationStrategy</span></code>)</li>
<li>セッション・フィクセーション攻撃を防ぐために新しいセッションを生成するコンポーネント(<code class="docutils literal"><span class="pre">SessionFixationProtectionStrategy</span></code>)</li>
</ul>
<div class="last line-block">
<div class="line">を有効化している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">authenticationFailureHandler</span></code>プロパティに、認証失敗時に呼ばれるハンドラクラスを指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">authenticationSuccessHandler</span></code>プロパティに、認証成功時に呼ばれるハンドラクラスを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>auto-configについて</strong></p>
<p class="last"><code class="docutils literal"><span class="pre">auto-config=&quot;false&quot;</span></code>を指定又は指定を省略した際にBasic認証処理とログアウト処理を有効化したい場合は、<code class="docutils literal"><span class="pre">&lt;sec:http-basic&gt;</span></code>タグと<code class="docutils literal"><span class="pre">&lt;sec:logout&gt;</span></code>タグを明示的に定義する必要がある。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="passwordencoder">
<span id="authenticationhowtoextendcustompasswordencoder"></span><h3><a class="toc-backref" href="#id133">9.2.3.9. PasswordEncoderのカスタマイズ</a><a class="headerlink" href="#passwordencoder" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">DelegatingPasswordEncoder</span></code> で使用される<code class="docutils literal"><span class="pre">PasswordEncoder</span></code>インタフェースの実装は全てデフォルトの設定であるが、システムの要件によってはカスタマイズを行う必要がある。
ここでは<code class="docutils literal"><span class="pre">PasswordEncoder</span></code>インタフェースの実装のカスタマイズ方法を紹介する。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">OWASP(Open Web Application Security Project)ではハッシュ関数に使用するイテレーションカウント（ハッシュ化の繰返し回数）について、ユーザに影響を与えない範囲で出来る限り攻撃を対策できる値を設定することが推奨されている。
ハードウェアの処理速度に比例してユーザに影響を与えない範囲が変化するため、実際に設定すべきイテレーションカウントは環境によって異なる。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="pbkdf2passwordencoder">
<h4><a class="toc-backref" href="#id134">9.2.3.9.1. Pbkdf2PasswordEncoderのカスタマイズ</a><a class="headerlink" href="#pbkdf2passwordencoder" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">Pbkdf2PasswordEncoder</span></code>では、<a class="reference internal" href="#springsecurityauthenticationpasswordhashsalt"><span class="std std-ref">ソルト</span></a> に8バイトの乱数(<code class="docutils literal"><span class="pre">java.security.SecureRandom</span></code>)が使用され、
<a class="reference internal" href="#springsecurityauthenticationpasswordhashiterations"><span class="std std-ref">イテレーション</span></a> カウントはデフォルトでは185,000回に設定されている。</p>
<p>ここではイテレーションカウントの変更方法を紹介する。</p>
<p><code class="docutils literal"><span class="pre">applicationContext.xml</span></code>を以下のように変更する。</p>
<ul class="simple">
<li>applicationContext.xmlの変更</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;passwordEncoder&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.crypto.password.DelegatingPasswordEncoder&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;idForEncode&quot;</span> <span class="na">value=</span><span class="s">&quot;pbkdf2&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;idToPasswordEncoder&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;map&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;pbkdf2&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.crypto.password.Pbkdf2PasswordEncoder&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
                    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;secret&quot;</span> <span class="na">value=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
                    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;iterations&quot;</span> <span class="na">value=</span><span class="s">&quot;1000000&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
                    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;hashWidth&quot;</span> <span class="na">value=</span><span class="s">&quot;256&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
                <span class="nt">&lt;/bean&gt;</span>
            <span class="nt">&lt;/entry&gt;</span>
            <span class="c">&lt;!-- omitted --&gt;</span>
        <span class="nt">&lt;/map&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">Pbkdf2PasswordEncoder</span></code>をカスタマイズするため、使用するコンストラクタをデフォルトコンストラクタから変更する</div>
<div class="line">コンストラクタに指定する引数については以下で解説を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">secret</span></code>にはハッシュ化で使用する秘密鍵を指定する。</div>
<div class="line">デフォルトは空（””）である。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">iterations</span></code>にはハッシュ化のiterations(反復)回数を指定する。</div>
<div class="line">ここでは1,000,000回を指定する。</div>
<div class="line">デフォルトでは185000が設定されている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">hashWidth</span></code>には出力されるハッシュ値の長さを指定する。</div>
<div class="line">デフォルトでは256が設定されている。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>SecureRandomの使用について</strong></p>
<p>Linux環境で<code class="docutils literal"><span class="pre">SecureRandom</span></code>を使用する場合、処理の遅延やタイムアウトが発生する場合がある。
これは使用する乱数生成器に左右される事象であり、以下のドキュメントに説明がある。</p>
<ul class="simple">
<li><a class="reference external" href="https://docs.oracle.com/javase/8/docs/api/java/security/SecureRandom.html">https://docs.oracle.com/javase/8/docs/api/java/security/SecureRandom.html</a></li>
</ul>
<p>本事象が発生する場合は、以下のいずれかの設定を追加することで回避することができる。</p>
<ul class="last simple">
<li>Javaコマンド実行時に <code class="docutils literal"><span class="pre">-Djava.security.egd=file:/dev/urandom</span></code> を指定する。</li>
<li><code class="docutils literal"><span class="pre">${JAVA_HOME}/jre/lib/security/java.security</span></code> 内の <code class="docutils literal"><span class="pre">securerandom.source=/dev/random</span></code> を <code class="docutils literal"><span class="pre">securerandom.source=/dev/urandom</span></code> に変更する。</li>
</ul>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note" id="springsecurityauthenticationpasswordhashsalt">
<p class="first admonition-title">Note</p>
<p><strong>ソルト</strong></p>
<p class="last">ハッシュ化対象のデータに追加する文字列のことである。
ソルトをパスワードに付与することで、実際のパスワードより桁数が長くなるため、レインボークラックなどのパスワード解析を困難にすることができる。
なお、<strong>ソルトはユーザーごとに異なる値（ランダム値等）を設定することを推奨する。</strong>
これは、同じソルトを使用していると、ハッシュ値からハッシュ化前の文字列(パスワード)がわかってしまう可能性があるためである。</p>
</div>
<div class="admonition note" id="springsecurityauthenticationpasswordhashiterations">
<p class="first admonition-title">Note</p>
<p><strong>イテレーション</strong></p>
<p>ハッシュ関数の計算を繰り返し行うことで、保管するパスワードに関する情報を繰り返し暗号化することである。
パスワードの総当たり攻撃への対策として、パスワード解析に必要な時間を延ばすために行う。
しかし、イテレーションはシステムの性能に影響を与えるので、システムの性能を考慮してイテレーションカウントを決める必要がある。</p>
<p class="last">Spring Securityのデフォルトでは185,000回イテレーションを行うが、この回数はコンストラクタ引数(<code class="docutils literal"><span class="pre">iterations</span></code>)で変更することができる。
イテレーションカウントが多いほどパスワードの強度は増すが、計算量が多くなるため性能にあたえる影響も大きくなる。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="authenticationhowtoextendusingdeprecatedpasswordencoder">
<span id="id49"></span><h3><a class="toc-backref" href="#id135">9.2.3.10. 非推奨アルゴリズムのPasswordEncoderの利用</a><a class="headerlink" href="#authenticationhowtoextendusingdeprecatedpasswordencoder" title="Permalink to this headline">¶</a></h3>
<p>セキュリティ要件によっては、前述した<code class="docutils literal"><span class="pre">PasswordEncoder</span></code>を実装したクラスでは実現できない場合がある。
特に、既存のアカウント情報で使用しているハッシュ化要件を踏襲する必要がある場合は、前述の<code class="docutils literal"><span class="pre">PasswordEncoder</span></code>では要件を満たせないことがある。</p>
<p>具体的には、既存のハッシュ化要件が以下のようなケースである。</p>
<ul class="simple">
<li>アルゴリズムがSHA-512である。</li>
<li>ハッシュ化回数が1000回である。</li>
</ul>
<p>このようなケースでは、<code class="docutils literal"><span class="pre">PasswordEncoder</span></code>の実装クラスの一つである<code class="docutils literal"><span class="pre">MessageDigestPasswordEncoder</span></code>を利用することで要件を満たすことができる。</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Spring Security 4では、Spring Security 3.1.4で非推奨になった<code class="docutils literal"><span class="pre">org.springframework.security.authentication.encoding.PasswordEncoder</span></code>を実装したクラスをハッシュ化に使用していたが、Spring Security 5では廃止されている。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="messagedigestpasswordencoder">
<h4><a class="toc-backref" href="#id136">9.2.3.10.1. MessageDigestPasswordEncoderの利用</a><a class="headerlink" href="#messagedigestpasswordencoder" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">MessageDigestPasswordEncoder</span></code>はJavaが提供する<code class="docutils literal"><span class="pre">java.security.MessageDigest</span></code>クラスを利用してハッシュ化を行う。
<code class="docutils literal"><span class="pre">MessageDigest</span></code>クラスはMD-5、SHA-1、SHA-256等のハッシュアルゴリズムを提供している。
詳細については<a class="reference external" href="https://docs.oracle.com/javase/jp/8/docs/api/java/security/MessageDigest.html">Javadoc</a>を参照されたい。</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><code class="docutils literal"><span class="pre">MessageDigestPasswordEncoder</span></code>は旧式の実装であることを示すため非推奨となっている。
このクラスが廃止される予定はないが、セキュリティ上のリスクが想定されるため、Pbkdf2アルゴリズムやBCryptアルゴリズムを利用することを検討されたい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>本ガイドラインでは、<code class="docutils literal"><span class="pre">DelegatingPassowordEncoder</span></code>を通して<code class="docutils literal"><span class="pre">MessageDigestPasswordEncoder</span></code>を利用する方法について説明する。</p>
<p>ここでは以下のハッシュ化要件を満たす<code class="docutils literal"><span class="pre">PasswordEncoder</span></code>を実装する。</p>
<ul class="simple">
<li>アルゴリズムがSHA-512である。</li>
<li>ハッシュ化回数が1000回である。</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>MessageDigestPasswordEncoderの仕様</strong></p>
<p><code class="docutils literal"><span class="pre">MessageDigestPasswordEncoder</span></code>でハッシュ化を行うと以下のフォーマットで出力される。</p>
<blockquote>
<div>{<code class="docutils literal"><span class="pre">salt</span></code>}<code class="docutils literal"><span class="pre">hashValue</span></code></div></blockquote>
<p>ソルトはSpring Security 5からランダムに生成するようになったため、安全性が向上している。</p>
<p>ハッシュ化したパスワードに付与されたソルトは照合の際に使用される。</p>
<p><strong>既に固定のソルトを用いてハッシュ化したパスワードについて</strong></p>
<p>先述の通り、Spring Security 5の<code class="docutils literal"><span class="pre">MessageDigestPasswordEncoder</span></code>はソルトをランダムに生成するが、
既に固定のソルトを用いてパスワードをハッシュ化していた場合も、パスワードにソルトを付与する移行処理を行うことで、
照合することができるようになる。</p>
<p>パスワードデータの移行については、<a class="reference external" href="https://docs.spring.io/spring-security/site/docs/5.2.1.RELEASE/api/org/springframework/security/crypto/password/MessageDigestPasswordEncoder.html">MessageDigestPasswordEncoderのJavadoc</a>を参照されたい。</p>
<p class="last">この場合、既存のパスワードは固定のソルトを用いて照合が行われるが、パスワードを新規に設定または変更した場合はランダムなソルトが用いられる。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><code class="docutils literal"><span class="pre">MessageDigestPasswordEncoder</span></code>を使用する際は、以下の点に注意する必要がある。</p>
<ul class="last simple">
<li>既存のハッシュ値より文字数が多くなる</li>
<li>エンコードしたパスワードからソルトの情報が得られる</li>
</ul>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>まず、<code class="docutils literal"><span class="pre">MessageDigestPasswordEncoder</span></code>でハッシュ化を行う<code class="docutils literal"><span class="pre">DelegatingPasswordEncoder</span></code>のbeanを定義する。</p>
<ul class="simple">
<li>applicationContext.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;passwordEncoder&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.crypto.password.DelegatingPasswordEncoder&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;idForEncode&quot;</span> <span class="na">value=</span><span class="s">&quot;MD&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;idToPasswordEncoder&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;map&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;MD&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.crypto.password.MessageDigestPasswordEncoder&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
                    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;algorithm&quot;</span> <span class="na">value=</span><span class="s">&quot;SHA-512&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
                    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;iterations&quot;</span> <span class="na">value=</span><span class="s">&quot;1000&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
                <span class="nt">&lt;/bean&gt;</span>
            <span class="nt">&lt;/entry&gt;</span>
            <span class="c">&lt;!-- omitted --&gt;</span>
        <span class="nt">&lt;/map&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ここではbeanのidに<code class="docutils literal"><span class="pre">passwordEncoder</span></code>を指定し、<code class="docutils literal"><span class="pre">sec:authentication-provider</span></code>配下に自動的に参照されるように設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ハッシュ化に使用する<code class="docutils literal"><span class="pre">PasswordEncoder</span></code>として<code class="docutils literal"><span class="pre">MessageDigestPasswordEncoder</span></code>をbean定義する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">MessageDigestPasswordEncoder</span></code>で使用するハッシュアルゴリズムを指定する。</div>
<div class="line">ここには<code class="docutils literal"><span class="pre">MessageDigest</span></code>クラスが対応するアルゴリズムを指定することができる。</div>
<div class="line">指定できる値については、<a class="reference external" href="https://docs.oracle.com/javase/jp/8/docs/technotes/guides/security/StandardNames.html#MessageDigest">Java暗号化アーキテクチャ標準アルゴリズム名のドキュメント</a> を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ハッシュ化のiterations(反復)回数を指定する。</div>
<div class="line">設定を行わなかった場合、1回となる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">実際のアプリケーション開発では、セキュリティ上のリスクを軽減するため<code class="docutils literal"><span class="pre">idForEncode</span></code>と<code class="docutils literal"><span class="pre">idToPasswordEncoder</span></code>の<code class="docutils literal"><span class="pre">key</span></code>値にアルゴリズム名を推測できないような値を指定することを推奨する。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="appendix">
<h2><a class="toc-backref" href="#id137">9.2.4. Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this headline">¶</a></h2>
<div class="section" id="spring-security-authentication-mvc">
<span id="id51"></span><h3><a class="toc-backref" href="#id138">9.2.4.1. Spring MVCでリクエストを受けてログインフォームを表示する</a><a class="headerlink" href="#spring-security-authentication-mvc" title="Permalink to this headline">¶</a></h3>
<p>Spring MVCでリクエストを受けてログインフォームを表示する方法を説明する。</p>
<ul class="simple">
<li>ログインフォームを表示するControllerの定義例</li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;/login&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginController</span> <span class="p">{</span> <span class="c1">// (1)</span>

    <span class="nd">@RequestMapping</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">index</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;login&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">view名として”login”を返却する。<code class="docutils literal"><span class="pre">InternalResourceViewResolver</span></code>によってsrc/main/webapp/WEB-INF/views/login.jspが出力される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>本例のように、単純にview名を返すだけのメソッドが一つだけあるControllerであれば、<code class="docutils literal"><span class="pre">&lt;mvc:view-controller&gt;</span></code>を使用して代用することも可能である。</p>
<p>詳しくは、<a class="reference internal" href="../ImplementationAtEachLayer/ApplicationLayer.html#controller-method-return-html-label"><span class="std std-ref">HTMLを応答する</span></a>を参照されたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="remember-me">
<span id="springsecurityauthenticationrememberme"></span><h3><a class="toc-backref" href="#id139">9.2.4.2. Remember Me認証の利用</a><a class="headerlink" href="#remember-me" title="Permalink to this headline">¶</a></h3>
<p>「<a class="reference external" href="https://docs.spring.io/spring-security/site/docs/5.2.1.RELEASE/reference/htmlsingle/#ns-remember-me">Remember Me認証</a>」とは、
Webサイトに頻繁にアクセスするユーザーの利便性を高めるための機能の一つで、ログイン状態を通常のライフサイクルより長く保持するための機能である。
本機能を使用すると、ブラウザを閉じた後やセッションタイムが発生した後でも、Cookieに保持しているRemember Me認証用のTokenを使用して、
ユーザ名とパスワードを再入力することなく自動でログインすることができる。
なお、本機能は、ユーザーがログイン状態を保持することを許可した場合のみ有効となる。</p>
<p>Spring Securityは、「<a class="reference external" href="https://docs.spring.io/spring-security/site/docs/5.2.1.RELEASE/reference/htmlsingle/#remember-me-hash-token">Hash-Based Token</a> 方式のRemember Me認証」と「<a class="reference external" href="https://docs.spring.io/spring-security/site/docs/5.2.1.RELEASE/reference/htmlsingle/#remember-me-persistent-token">Persistent Token</a> 方式のRemember Me認証」をサポートしており、
デフォルトではHash-Based Token方式が使用される。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Remember Me認証を利用する場合は、<code class="docutils literal"><span class="pre">&lt;sec:remember-me&gt;</span></code>タグを追加する。</p>
<ul class="simple">
<li>spring-security.xmlの定義例</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;sec:http&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
    <span class="nt">&lt;sec:remember-me</span> <span class="na">key=</span><span class="s">&quot;terasoluna-tourreservation-km/ylnHv&quot;</span>
        <span class="na">token-validity-seconds=</span><span class="s">&quot;#{30 * 24 * 60 * 60}&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) (2) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">key</span></code>属性に、Remember Me認証用のTokenを生成したアプリケーションを識別するキー値を指定する。</div>
<div class="line">キー値の指定が無い場合、アプリケーションの起動毎にユニークな値が生成される。</div>
<div class="line">なお、Hash-Based Tokenが保持しているキー値とサーバーで保持しているキー値が異なる場合、無効なTokenとして扱われる。</div>
<div class="line">つまり、アプリケーションを再起動する前に生成したHash-Based Tokenを有効なTokenとして扱いたい場合は、<code class="docutils literal"><span class="pre">key</span></code>属性の指定は必須である。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">token-validity-seconds</span></code>属性に、Remember Me認証用のTokenの有効時間を秒単位で指定する。</div>
<div class="line">指定が無い場合、デフォルトで14日間が有効時間になる。</div>
<div class="line">上記例では、有効時間として30日間を設定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>上記以外の属性については、<a class="reference external" href="https://docs.spring.io/spring-security/site/docs/5.2.1.RELEASE/reference/htmlsingle/#nsa-remember-me">Spring Security Reference -The Security Namespace (&lt;remember-me&gt;) -</a>を参照されたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>ログインフォームには、「Remember Me認証」機能の利用有無を指定するためのフラグ(チェックボックス項目)を用意する。</p>
<ul class="simple">
<li>ログインフォームのJSPの実装例</li>
</ul>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;form:form</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/login&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- omitted --&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;remember-me&quot;</span><span class="nt">&gt;</span>Remember Me : <span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">name=</span><span class="s">&quot;remember-me&quot;</span> <span class="na">id=</span><span class="s">&quot;remember-me&quot;</span> <span class="na">type=</span><span class="s">&quot;checkbox&quot;</span> <span class="na">checked=</span><span class="s">&quot;checked&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;&lt;/td&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/form:form&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">「Remember Me認証」機能の利用有無を指定するためのフラグ(チェックボックス項目)を追加し、フィールド名(リクエストパラメータ名)には、<code class="docutils literal"><span class="pre">remember-me-parameter</span></code>のデフォルト値である<code class="docutils literal"><span class="pre">remember-me</span></code>を指定する。</div>
<div class="line">チェックボックスの<code class="docutils literal"><span class="pre">value</span></code>属性には、<code class="docutils literal"><span class="pre">true</span></code>を設定する。</div>
<div class="line">チェックボックスをチェック状態にしてから認証処理を実行すると、以降のリクエストから「Remember Me認証」機能が適用される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>value属性の設定値について</strong></p>
<p class="last"><code class="docutils literal"><span class="pre">value</span></code>属性には、<code class="docutils literal"><span class="pre">true</span></code>を設定する旨が<a class="reference external" href="https://docs.spring.io/spring-security/site/docs/5.2.1.RELEASE/api/org/springframework/security/web/authentication/rememberme/AbstractRememberMeServices.html#rememberMeRequested-javax.servlet.http.HttpServletRequest-java.lang.String-">rememberMeRequestedのJavaDoc</a>に記載されているが、
実装上は<code class="docutils literal"><span class="pre">on</span></code>、<code class="docutils literal"><span class="pre">yes</span></code>、”<code class="docutils literal"><span class="pre">1</span></code>” も設定可能である。</p>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="Authorization.html" title="9.3. 認可"
             >next</a> |</li>
        <li class="right" >
          <a href="SpringSecurity.html" title="9.1. Spring Security概要"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.6.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >9. セキュリティ対策</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer">
      © Copyright 2013, NTT DATA Corporation. © Copyright 2013, NTT Corporation.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3.Theme is <a href="http://github.com/vimalkvn/solar-theme">Solar</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>
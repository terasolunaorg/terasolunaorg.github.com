<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>4.2. Domain Layer Implementation &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.0.2.RELEASE documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/solar.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="4.3. Implementation of Infrastructure Layer" href="InfrastructureLayer.html" />
    <link rel="prev" title="4.1. Create Web application development project" href="CreateWebApplicationProject.html" /><script async src="https://www.googletagmanager.com/gtag/js?id=G-847V2Q99G8"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date()); gtag('config', 'G-847V2Q99G8');
</script>
<script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="InfrastructureLayer.html" title="4.3. Implementation of Infrastructure Layer"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="CreateWebApplicationProject.html" title="4.1. Create Web application development project"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.0.2.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U"><span class="section-number">4. </span>Application Development using TERASOLUNA Server Framework for Java (5.x)</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">4.2. </span>Domain Layer Implementation</a></li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">4.2. Domain Layer Implementation</a><ul>
<li><a class="reference internal" href="#roles-of-domain-layer">4.2.1. Roles of domain layer</a></li>
<li><a class="reference internal" href="#flow-of-development-of-domain-layer">4.2.2. Flow of development of domain layer</a></li>
<li><a class="reference internal" href="#implementation-of-entity">4.2.3. Implementation of Entity</a><ul>
<li><a class="reference internal" href="#policy-of-creating-entity-class">4.2.3.1. Policy of creating Entity class</a></li>
<li><a class="reference internal" href="#example-of-creating-entity-class">4.2.3.2. Example of creating Entity class</a><ul>
<li><a class="reference internal" href="#table-structure">4.2.3.2.1. Table structure</a></li>
<li><a class="reference internal" href="#entity-structure">4.2.3.2.2. Entity structure</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-of-repository">4.2.4. Implementation of Repository</a><ul>
<li><a class="reference internal" href="#roles-of-repository">4.2.4.1. Roles of Repository</a></li>
<li><a class="reference internal" href="#structure-of-repository">4.2.4.2. Structure of Repository</a></li>
<li><a class="reference internal" href="#creation-of-repository">4.2.4.3. Creation of Repository</a></li>
<li><a class="reference internal" href="#example-of-creating-repository">4.2.4.4. Example of creating Repository</a><ul>
<li><a class="reference internal" href="#id1">4.2.4.4.1. Structure of Repository</a></li>
</ul>
</li>
<li><a class="reference internal" href="#definition-of-repository-interface">4.2.4.5. Definition of Repository interface</a><ul>
<li><a class="reference internal" href="#creation-of-repository-interface">4.2.4.5.1. Creation of Repository interface</a></li>
<li><a class="reference internal" href="#method-definition-of-repository-interface">4.2.4.5.2. Method definition of Repository interface</a></li>
<li><a class="reference internal" href="#creation-of-repositoryimpl">4.2.4.5.3. Creation of RepositoryImpl</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-of-service">4.2.5. Implementation of Service</a><ul>
<li><a class="reference internal" href="#roles-of-service">4.2.5.1. Roles of Service</a></li>
<li><a class="reference internal" href="#structure-of-service-class">4.2.5.2. Structure of Service class</a><ul>
<li><a class="reference internal" href="#reason-for-separating-service-and-sharedservice">4.2.5.2.1. Reason for separating Service and SharedService</a></li>
<li><a class="reference internal" href="#reason-for-prohibiting-the-calling-of-other-service-classes-from-service-class">4.2.5.2.2. Reason for prohibiting the calling of other Service classes from Service class</a></li>
<li><a class="reference internal" href="#regarding-interface-and-base-classes-to-limit-signature-of-method">4.2.5.2.3. Regarding interface and base classes to limit signature of method</a></li>
</ul>
</li>
<li><a class="reference internal" href="#patterns-of-creating-service-class">4.2.5.3. Patterns of creating service class</a><ul>
<li><a class="reference internal" href="#image-of-application-development-creating-service-for-each-entity">4.2.5.3.1. Image of Application development - Creating Service for each Entity</a></li>
<li><a class="reference internal" href="#image-of-application-development-creating-service-for-each-use-case">4.2.5.3.2. Image of Application development - Creating Service for each use case</a></li>
<li><a class="reference internal" href="#image-of-application-development-creating-service-for-each-use-event">4.2.5.3.3. Image of Application development - Creating Service for each use event</a></li>
</ul>
</li>
<li><a class="reference internal" href="#creation-of-service-class">4.2.5.4. Creation of Service class</a><ul>
<li><a class="reference internal" href="#methods-of-creating-service-class">4.2.5.4.1. Methods of creating Service class</a></li>
<li><a class="reference internal" href="#creation-of-methods-of-service-class">4.2.5.4.2. Creation of methods of Service class</a></li>
<li><a class="reference internal" href="#regarding-arguments-and-return-values-of-methods-of-service-class">4.2.5.4.3. Regarding arguments and return values of methods of Service class</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-of-sharedservice-class">4.2.5.5. Implementation of SharedService class</a><ul>
<li><a class="reference internal" href="#creation-of-sharedservice-class">4.2.5.5.1. Creation of SharedService class</a></li>
<li><a class="reference internal" href="#creation-of-sharedservice-class-method">4.2.5.5.2. Creation of SharedService class method</a></li>
<li><a class="reference internal" href="#regarding-arguments-and-return-values-of-sharedservice-class-method">4.2.5.5.3. Regarding arguments and return values of SharedService class method</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-of-logic">4.2.5.6. Implementation of logic</a><ul>
<li><a class="reference internal" href="#operate-on-business-data">4.2.5.6.1. Operate on business data</a></li>
<li><a class="reference internal" href="#returning-messages">4.2.5.6.2. Returning messages</a></li>
<li><a class="reference internal" href="#returning-warning-message">4.2.5.6.3. Returning warning message</a></li>
<li><a class="reference internal" href="#notifying-business-error">4.2.5.6.4. Notifying business error</a></li>
<li><a class="reference internal" href="#notifying-system-error">4.2.5.6.5. Notifying system error</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#regarding-transaction-management">4.2.6. Regarding transaction management</a><ul>
<li><a class="reference internal" href="#method-of-transaction-management">4.2.6.1. Method of transaction management</a><ul>
<li><a class="reference internal" href="#declarative-transaction-management">4.2.6.1.1. Declarative transaction management</a></li>
<li><a class="reference internal" href="#information-required-for-declarative-transaction-management">4.2.6.1.2. Information required for “Declarative transaction management”</a></li>
<li><a class="reference internal" href="#propagation-of-transaction">4.2.6.1.3. Propagation of transaction</a></li>
<li><a class="reference internal" href="#way-of-calling-the-method-which-is-under-transaction-control">4.2.6.1.4. Way of calling the method which is under transaction control</a></li>
</ul>
</li>
<li><a class="reference internal" href="#settings-for-using-transaction-management">4.2.6.2. Settings for using transaction management</a><ul>
<li><a class="reference internal" href="#platformtransactionmanager-settings">4.2.6.2.1. PlatformTransactionManager settings</a></li>
<li><a class="reference internal" href="#settings-for-enabling-transactional">4.2.6.2.2. Settings for enabling &#64;Transactional</a></li>
<li><a class="reference internal" href="#regarding-attributes-of-tx-annotation-driven-element">4.2.6.2.3. Regarding attributes of &lt;tx:annotation-driven&gt; element</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix">4.2.7. Appendix</a><ul>
<li><a class="reference internal" href="#regarding-drawbacks-of-transaction-management">4.2.7.1. Regarding drawbacks of transaction management</a></li>
<li><a class="reference internal" href="#programmatic-transaction-management">4.2.7.2. Programmatic transaction management</a></li>
<li><a class="reference internal" href="#sample-of-implementation-of-interface-and-base-classes-to-limit-signature">4.2.7.3. Sample of implementation of interface and base classes to limit signature</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tips">4.2.8. Tips</a><ul>
<li><a class="reference internal" href="#method-of-dealing-with-violation-of-business-rules-as-field-error">4.2.8.1. Method of dealing with violation of business rules as field error</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="CreateWebApplicationProject.html"
                          title="previous chapter"><span class="section-number">4.1. </span>Create Web application development project</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="InfrastructureLayer.html"
                          title="next chapter"><span class="section-number">4.3. </span>Implementation of Infrastructure Layer</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/ImplementationAtEachLayer/DomainLayer.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="domain-layer-implementation">
<h1><span class="section-number">4.2. </span>Domain Layer Implementation<a class="headerlink" href="#domain-layer-implementation" title="Permalink to this heading">¶</a></h1>
<nav class="contents local" id="index">
<p class="topic-title">Index</p>
<ul class="simple">
<li><p><a class="reference internal" href="#roles-of-domain-layer" id="id3">Roles of domain layer</a></p></li>
<li><p><a class="reference internal" href="#flow-of-development-of-domain-layer" id="id4">Flow of development of domain layer</a></p></li>
<li><p><a class="reference internal" href="#implementation-of-entity" id="id5">Implementation of Entity</a></p>
<ul>
<li><p><a class="reference internal" href="#policy-of-creating-entity-class" id="id6">Policy of creating Entity class</a></p></li>
<li><p><a class="reference internal" href="#example-of-creating-entity-class" id="id7">Example of creating Entity class</a></p>
<ul>
<li><p><a class="reference internal" href="#table-structure" id="id8">Table structure</a></p></li>
<li><p><a class="reference internal" href="#entity-structure" id="id9">Entity structure</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#implementation-of-repository" id="id10">Implementation of Repository</a></p>
<ul>
<li><p><a class="reference internal" href="#roles-of-repository" id="id11">Roles of Repository</a></p></li>
<li><p><a class="reference internal" href="#structure-of-repository" id="id12">Structure of Repository</a></p></li>
<li><p><a class="reference internal" href="#creation-of-repository" id="id13">Creation of Repository</a></p></li>
<li><p><a class="reference internal" href="#example-of-creating-repository" id="id14">Example of creating Repository</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id15">Structure of Repository</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#definition-of-repository-interface" id="id16">Definition of Repository interface</a></p>
<ul>
<li><p><a class="reference internal" href="#creation-of-repository-interface" id="id17">Creation of Repository interface</a></p></li>
<li><p><a class="reference internal" href="#method-definition-of-repository-interface" id="id18">Method definition of Repository interface</a></p></li>
<li><p><a class="reference internal" href="#creation-of-repositoryimpl" id="id19">Creation of RepositoryImpl</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#implementation-of-service" id="id20">Implementation of Service</a></p>
<ul>
<li><p><a class="reference internal" href="#roles-of-service" id="id21">Roles of Service</a></p></li>
<li><p><a class="reference internal" href="#structure-of-service-class" id="id22">Structure of Service class</a></p>
<ul>
<li><p><a class="reference internal" href="#reason-for-separating-service-and-sharedservice" id="id23">Reason for separating Service and SharedService</a></p></li>
<li><p><a class="reference internal" href="#reason-for-prohibiting-the-calling-of-other-service-classes-from-service-class" id="id24">Reason for prohibiting the calling of other Service classes from Service class</a></p></li>
<li><p><a class="reference internal" href="#regarding-interface-and-base-classes-to-limit-signature-of-method" id="id25">Regarding interface and base classes to limit signature of method</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#patterns-of-creating-service-class" id="id26">Patterns of creating service class</a></p>
<ul>
<li><p><a class="reference internal" href="#image-of-application-development-creating-service-for-each-entity" id="id27">Image of Application development - Creating Service for each Entity</a></p></li>
<li><p><a class="reference internal" href="#image-of-application-development-creating-service-for-each-use-case" id="id28">Image of Application development - Creating Service for each use case</a></p></li>
<li><p><a class="reference internal" href="#image-of-application-development-creating-service-for-each-use-event" id="id29">Image of Application development - Creating Service for each use event</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#creation-of-service-class" id="id30">Creation of Service class</a></p>
<ul>
<li><p><a class="reference internal" href="#methods-of-creating-service-class" id="id31">Methods of creating Service class</a></p></li>
<li><p><a class="reference internal" href="#creation-of-methods-of-service-class" id="id32">Creation of methods of Service class</a></p></li>
<li><p><a class="reference internal" href="#regarding-arguments-and-return-values-of-methods-of-service-class" id="id33">Regarding arguments and return values of methods of Service class</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#implementation-of-sharedservice-class" id="id34">Implementation of SharedService class</a></p>
<ul>
<li><p><a class="reference internal" href="#creation-of-sharedservice-class" id="id35">Creation of SharedService class</a></p></li>
<li><p><a class="reference internal" href="#creation-of-sharedservice-class-method" id="id36">Creation of SharedService class method</a></p></li>
<li><p><a class="reference internal" href="#regarding-arguments-and-return-values-of-sharedservice-class-method" id="id37">Regarding arguments and return values of SharedService class method</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#implementation-of-logic" id="id38">Implementation of logic</a></p>
<ul>
<li><p><a class="reference internal" href="#operate-on-business-data" id="id39">Operate on business data</a></p></li>
<li><p><a class="reference internal" href="#returning-messages" id="id40">Returning messages</a></p></li>
<li><p><a class="reference internal" href="#returning-warning-message" id="id41">Returning warning message</a></p></li>
<li><p><a class="reference internal" href="#notifying-business-error" id="id42">Notifying business error</a></p></li>
<li><p><a class="reference internal" href="#notifying-system-error" id="id43">Notifying system error</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#regarding-transaction-management" id="id44">Regarding transaction management</a></p>
<ul>
<li><p><a class="reference internal" href="#method-of-transaction-management" id="id45">Method of transaction management</a></p>
<ul>
<li><p><a class="reference internal" href="#declarative-transaction-management" id="id46">Declarative transaction management</a></p></li>
<li><p><a class="reference internal" href="#information-required-for-declarative-transaction-management" id="id47">Information required for “Declarative transaction management”</a></p></li>
<li><p><a class="reference internal" href="#propagation-of-transaction" id="id48">Propagation of transaction</a></p></li>
<li><p><a class="reference internal" href="#way-of-calling-the-method-which-is-under-transaction-control" id="id49">Way of calling the method which is under transaction control</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#settings-for-using-transaction-management" id="id50">Settings for using transaction management</a></p>
<ul>
<li><p><a class="reference internal" href="#platformtransactionmanager-settings" id="id51">PlatformTransactionManager settings</a></p></li>
<li><p><a class="reference internal" href="#settings-for-enabling-transactional" id="id52">Settings for enabling &#64;Transactional</a></p></li>
<li><p><a class="reference internal" href="#regarding-attributes-of-tx-annotation-driven-element" id="id53">Regarding attributes of &lt;tx:annotation-driven&gt; element</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#appendix" id="id54">Appendix</a></p>
<ul>
<li><p><a class="reference internal" href="#regarding-drawbacks-of-transaction-management" id="id55">Regarding drawbacks of transaction management</a></p></li>
<li><p><a class="reference internal" href="#programmatic-transaction-management" id="id56">Programmatic transaction management</a></p></li>
<li><p><a class="reference internal" href="#sample-of-implementation-of-interface-and-base-classes-to-limit-signature" id="id57">Sample of implementation of interface and base classes to limit signature</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#tips" id="id58">Tips</a></p>
<ul>
<li><p><a class="reference internal" href="#method-of-dealing-with-violation-of-business-rules-as-field-error" id="id59">Method of dealing with violation of business rules as field error</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="roles-of-domain-layer">
<h2><a class="toc-backref" href="#id3" role="doc-backlink"><span class="section-number">4.2.1. </span>Roles of domain layer</a><a class="headerlink" href="#roles-of-domain-layer" title="Permalink to this heading">¶</a></h2>
<p>Domain layer <strong>implements business logic</strong>to be provided to the application layer.</p>
<p>Implementation of domain layer is classified into the following.</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 30%" />
<col style="width: 60%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Classification</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">1.</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><a class="reference internal" href="#domainlayer-entity"><span class="std std-ref">Implementation of Entity</span></a></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Creation of classes (Entity class) to hold business data.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">2.</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><a class="reference internal" href="#repository-label"><span class="std std-ref">Implementation of Repository</span></a></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Implementation of the methods to operate on business data. These methods are provided to Service classes.</div>
<div class="line">These are in particular the CRUD operations on Entity object.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">3.</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><a class="reference internal" href="#service-label"><span class="std std-ref">Implementation of Service</span></a></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Implementation of the methods for executing business logic. These methods are provided to the application layer.</div>
<div class="line">Business data required by the business logic is fetched as the Entity object through the Repository.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>This guideline recommends the structure of creating Entity classes and Repository for the following reasons.</p>
<ol class="arabic simple">
<li><p><strong>By splitting the overall logic into business logic (Service) and the logic to access business data, the implementation scope of business logic gets limited to the implementation of business rules</strong>,</p></li>
<li><p><strong>Access logic to business data is standardized</strong> by consolidating the operations of business data in the Repository.</p></li>
</ol>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>Though this guideline recommends a structure to create Entity classes and Repository, it is not mandatory to perform development in this structure.</p>
<p>Decide a structure by taking into account the characteristics of the application as well as the project (structure of development team and development methodology).</p>
</div>
</div></blockquote>
</section>
<section id="flow-of-development-of-domain-layer">
<h2><a class="toc-backref" href="#id4" role="doc-backlink"><span class="section-number">4.2.2. </span>Flow of development of domain layer</a><a class="headerlink" href="#flow-of-development-of-domain-layer" title="Permalink to this heading">¶</a></h2>
<div class="line-block">
<div class="line">Flow of development of domain layer and allocation of roles is explained here.</div>
<div class="line">A case where application is created by multiple development teams is assumed; however, the flow itself remains same even if developed by a single team.</div>
</div>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../_images/service_implementation_flow.png"><img alt="implementation flow of domain layer" src="../_images/service_implementation_flow.png" style="width: 100%;" /></a>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 9%" />
<col style="width: 18%" />
<col style="width: 73%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Team in-charge</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Common development team</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Common development team designs and creates Entity classes.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Common development team</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Common development team works out access pattern for the Entity classes extracted in (1) and designs methods of Repository interface.</div>
<div class="line">Common development team should implement the methods to be shared by multiple development teams.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Common development team</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Common development team provides Entity classes and Repository created in (1) and (2) to the business application development team.</div>
<div class="line">At this time, it requests each business application development team to implement the Repository interface.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Business application development team</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Business application development team takes charge of the implementation of Repository interface.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Business application development team</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Business application development team develops Service interface and Service class using the Entity class and Repository provided by</div>
<div class="line">the common development team and the Repository implementation class created by the team itself.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>A system having a large development scope is often developed by assigning the application to multiple teams.
In that case, it is strongly recommended to provide a common team to design Entity classes and Repository.</p>
<p>When there is no common team, O/R Mapper(MyBatis, etc.) should be called directly from Service and a method to
access business data should be adopted without creating Entity classes and Repository .</p>
</div>
</div></blockquote>
</section>
<section id="implementation-of-entity">
<span id="domainlayer-entity"></span><h2><a class="toc-backref" href="#id5" role="doc-backlink"><span class="section-number">4.2.3. </span>Implementation of Entity</a><a class="headerlink" href="#implementation-of-entity" title="Permalink to this heading">¶</a></h2>
<section id="policy-of-creating-entity-class">
<h3><a class="toc-backref" href="#id6" role="doc-backlink"><span class="section-number">4.2.3.1. </span>Policy of creating Entity class</a><a class="headerlink" href="#policy-of-creating-entity-class" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">Create an Entity using the following method.</div>
<div class="line">Specific creation method is shown in <a class="reference internal" href="#domainlayer-entity-example"><span class="std std-ref">Example of creating Entity class</span></a>.</div>
</div>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 35%" />
<col style="width: 55%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Method</p></th>
<th class="head"><p>Supplementary</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">1.</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Create Entity class for each table.</div>
</div>
</td>
<td><div class="line-block">
<div class="line">However, Entity class is not required for mapping tables which represent the relationship between the tables.</div>
<div class="line">Further, when the tables are not normalized, Entity class for each table rule may not be applicable. Refer to the <a class="reference internal" href="#domainlayer-entity-policy-warning-note"><span class="std std-ref">Warning as well as Note outside this table</span></a></div>
<div class="line">for the approach related to not-normalized tables.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">2.</div>
</div>
</td>
<td><div class="line-block">
<div class="line">When there is a FK (Foreign Key) in the table, the Entity class of FK destination table must be defined as one of the properties of this Entity.</div>
</div>
</td>
<td><div class="line-block">
<div class="line">When there is 1:N relationship with FK destination table, use either <code class="docutils literal notranslate"><span class="pre">java.util.List&lt;E&gt;</span></code> or <code class="docutils literal notranslate"><span class="pre">java.util.Set&lt;E&gt;</span></code>.</div>
<div class="line">The Entity corresponding to the FK destination table is called as the related Entity in this guideline.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">3.</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Treat the code related tables as <code class="docutils literal notranslate"><span class="pre">java.lang.String</span></code> rather than as an Entity.</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Code related tables are to manage the pairs of code value and name.</div>
<div class="line">When there is a need to bifurcate the process as per code values, <code class="docutils literal notranslate"><span class="pre">enum</span></code> class corresponding to code value should be created and it must be defined as property.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<blockquote id="domainlayer-entity-policy-warning-note">
<div><div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>When table is not normalized, <strong>check whether to use the method of creating the Entity classes and Repository</strong> by considering the following points.
Since the unnormalized tables do not have good compatibility with JPA, it is better not to use JPA.</p>
<ul>
<li><div class="line-block">
<div class="line">Creating an appropriate Entity class may often not be possible because of increased difficulty in creating entities if the tables are not normalized.</div>
<div class="line">In addition, efforts to create an Entity classes also increases.</div>
<div class="line">Two viewpoints must be taken into consideration here. Firstly “Can we assign an engineer who can perform normalization properly?” and secondly “Is it worth taking efforts for creating normalized Entity classes?”.</div>
</div>
</li>
<li><div class="line-block">
<div class="line">If the tables are not normalized, the logic to fill the gap of differences between the Entity class and structure of table is required in data access.</div>
<div class="line">Here the viewpoint to be considered is, “Is it worth taking efforts to fill the gap of differences between the Entity class and structure of table ?”.</div>
</div>
</li>
</ul>
<p>The method of creating Entity classes and Repository is recommended; however, the characteristics of the application as well as the project (structure of
development team and development methodology) must also be taken into account.</p>
</div>
</div></blockquote>
<blockquote id="domainlayer-entity-policy-note">
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you want to operate business data as application, and as normalized Entity even if the tables are not normalized,
it is recommended to use MyBatis as an implementation of RepositoryImpl of the infrastructure layer.</p>
<p>MyBatis is the O/R Mapper developed to map the SQL with object and not to map the database table record with object.
Therefore, mapping to the object independent of table structure is possible depending on the implementation of SQL, .</p>
</div>
</div></blockquote>
</section>
<section id="example-of-creating-entity-class">
<span id="domainlayer-entity-example"></span><h3><a class="toc-backref" href="#id7" role="doc-backlink"><span class="section-number">4.2.3.2. </span>Example of creating Entity class</a><a class="headerlink" href="#example-of-creating-entity-class" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">The creation of Entity class is explained using specific examples.</div>
<div class="line">Following is an example of creating the business data of Entity classes required for purchasing a product on some shopping site.</div>
</div>
<section id="table-structure">
<h4><a class="toc-backref" href="#id8" role="doc-backlink"><span class="section-number">4.2.3.2.1. </span>Table structure</a><a class="headerlink" href="#table-structure" title="Permalink to this heading">¶</a></h4>
<p>The table structure is as given below:</p>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../_images/service_entity_table_layout.png"><img alt="Example of table layout" src="../_images/service_entity_table_layout.png" style="width: 100%;" /></a>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 20%" />
<col style="width: 15%" />
<col style="width: 55%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Classification</p></th>
<th class="head"><p>Table name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Transaction related</div>
</div>
</td>
<td><div class="line-block">
<div class="line">t_order</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Table to store orders. 1 record is stored for 1 order.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="line-block">
<div class="line">t_order_item</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Table to store the products purchased in 1 order. Record of each product is stored when multiple products are purchased in 1 order.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="line-block">
<div class="line">t_order_coupon</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Table to store the coupon used in a single order. Record of each coupon is stored when multiple coupons are used in 1 order. No record is stored when coupon is not used.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Master related</div>
</div>
</td>
<td><div class="line-block">
<div class="line">m_item</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Master table to define products.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="line-block">
<div class="line">m_category</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Master table to define product category.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="line-block">
<div class="line">m_item_category</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Master table to define the category of the product. Mapping between product and category is maintained. Model where 1 product belongs to multiple categories.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="line-block">
<div class="line">m_coupon</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Master table to define coupons.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Code related</div>
</div>
</td>
<td><div class="line-block">
<div class="line">c_order_status</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Code table to define order status.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="entity-structure">
<h4><a class="toc-backref" href="#id9" role="doc-backlink"><span class="section-number">4.2.3.2.2. </span>Entity structure</a><a class="headerlink" href="#entity-structure" title="Permalink to this heading">¶</a></h4>
<p>If Entity classes are created with the help of policy defined by the above table, it results into the following structure.</p>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../_images/service_entity_entity_layout.png"><img alt="Example of entity layout" src="../_images/service_entity_entity_layout.png" style="width: 100%;" /></a>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 17%" />
<col style="width: 72%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Class name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Order</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Entity class indicating 1 record of t_order table.</div>
<div class="line">Multiple <code class="docutils literal notranslate"><span class="pre">OrderItem</span></code> and <code class="docutils literal notranslate"><span class="pre">OrderCoupon</span></code> are stored as the related Entity.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">OrderItem</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Entity class indicating 1 record of t_order_item table.</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Item</span></code> is stored as the related Entity.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">OrderCoupon</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Entity class indicating 1 record of t_order_coupon table.</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Coupon</span></code> is stored as the related Entity.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Item</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Entity class indicating 1 record of m_item table.</div>
<div class="line">Multiple <code class="docutils literal notranslate"><span class="pre">Category</span></code> are stored as the related Entity. The association between <code class="docutils literal notranslate"><span class="pre">Item</span></code> and <code class="docutils literal notranslate"><span class="pre">Category</span></code> is done using m_item_category table.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Category</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Entity class indicating 1 record of m_category table.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ItemCategory</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Entity class is not created since m_item_category table is the mapping table to store the relationship between m_item table and m_category table.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Coupon</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Entity class indicating 1 record of m_coupon table.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">OrderStatus</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Entity class is not created since c_order_status table is code table.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>As it can be observed from the above entity diagram, it might first seem that Order class is the only main entity class
in the shopping site application; however, there are other main entity class as well other than Order class.</p>
<p>Below is the classification of main Entity classes as well as Entity class which are not main.</p>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../_images/service_entity_entity_class_layout.png"><img alt="Example of entity layout" src="../_images/service_entity_entity_class_layout.png" style="width: 100%;" /></a>
</figure>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>The following 4 Entities are treated as the main Entity for creating shopping site application.</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 30%" />
<col style="width: 60%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Entity class</p></th>
<th class="head"><p>Reasons for treating as the main Entity.</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Order class</div>
</div>
</td>
<td><div class="line-block">
<div class="line">It is one of the most important Entity class in the shopping site.</div>
<div class="line">Order class is the Entity indicating the order itself and a shopping site cannot be created without the Order class.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Item class</div>
</div>
</td>
<td><div class="line-block">
<div class="line">It is one of the most important Entity class in the shopping site.</div>
<div class="line">Item class is the Entity indicating the products handled in the shopping site and a shopping site cannot be created without Item class.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Category class</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Product categories are displayed usually on the top page or as a common menu in shopping sites. In such shopping sites, Category becomes a main entity.
Usually operations like ‘search category list’ can be expected.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Coupon class</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Often discounts through coupons are offered in the shopping sites as a measure of promoting sales of the products.</div>
<div class="line">In such shopping sites, Coupon becomes a main entity. Usually operations like ‘search coupon list’ can be expected.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>The following are not main Entities for creating shopping site application.</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 30%" />
<col style="width: 60%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Entity class</p></th>
<th class="head"><p>Reason of not treating Entity as main Entity</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">OrderItem class</div>
</div>
</td>
<td><div class="line-block">
<div class="line">This class indicates 1 product purchased in 1 order and exists only as the related Entity of Order class.</div>
<div class="line">So OrderItem class should not be considered as main Entity.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">OrderCoupon</div>
</div>
</td>
<td><div class="line-block">
<div class="line">This class indicates 1 coupon used in 1 order and exists only as the related Entity of Order class.</div>
<div class="line">So, OrderCoupon class should not be considered as main Entity.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
</section>
</section>
<section id="implementation-of-repository">
<span id="repository-label"></span><h2><a class="toc-backref" href="#id10" role="doc-backlink"><span class="section-number">4.2.4. </span>Implementation of Repository</a><a class="headerlink" href="#implementation-of-repository" title="Permalink to this heading">¶</a></h2>
<section id="roles-of-repository">
<h3><a class="toc-backref" href="#id11" role="doc-backlink"><span class="section-number">4.2.4.1. </span>Roles of Repository</a><a class="headerlink" href="#roles-of-repository" title="Permalink to this heading">¶</a></h3>
<p>Repository has following 2 roles.</p>
<ol class="arabic">
<li><div class="line-block">
<div class="line"><strong>To provide to Service, the operations necessary to control Entity lifecycle (Repository interface).</strong></div>
<div class="line">The operations for controlling Entity lifecycle are CRUD operations.</div>
</div>
</li>
</ol>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../_images/repository_responsibility_1.png"><img alt="provide access operations to entity" src="../_images/repository_responsibility_1.png" style="width: 100%;" /></a>
</figure>
</div></blockquote>
<ol class="arabic" start="2">
<li><div class="line-block">
<div class="line"><strong>To provide persistence logic for Entity (implementation class of Repository interface).</strong></div>
<div class="line">Entity object should persist irrespective of the lifecycle (start and stop of server) of application.</div>
<div class="line">Mostly relational database is the permanent destination of Entity. However, NoSQL database, cache server, external system and file (shared disk) can also be the permanent destination.</div>
<div class="line">The actual persistence processing is done using O/R Mapper API.</div>
<div class="line">This role is implemented in the RepositoryImpl of the infrastructure layer. Refer to <a class="reference internal" href="InfrastructureLayer.html"><span class="doc">Implementation of Infrastructure Layer</span></a> for details.</div>
</div>
</li>
</ol>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../_images/repository_responsibility_2.png"><img alt="persist entity" src="../_images/repository_responsibility_2.png" style="width: 100%;" /></a>
</figure>
</div></blockquote>
</section>
<section id="structure-of-repository">
<h3><a class="toc-backref" href="#id12" role="doc-backlink"><span class="section-number">4.2.4.2. </span>Structure of Repository</a><a class="headerlink" href="#structure-of-repository" title="Permalink to this heading">¶</a></h3>
<p>Repository consists of Repository interface and RepositoryImpl and performs the following roles.</p>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../_images/repository_classes_responsibility.png"><img alt="persist entity" src="../_images/repository_classes_responsibility.png" style="width: 100%;" /></a>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 20%" />
<col style="width: 30%" />
<col style="width: 40%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Class(Interface)</p></th>
<th class="head"><p>Role</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Repository interface</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Defines methods to control Entity lifecycle required for implementing business logic (Service).</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Defines methods for CRUD operations of the Entity and is not dependent on persistence layer.</div>
<div class="line">Repository interface belongs to the domain layer since it plays the roles of defining the operations on Entity required for implementing business logic (Service).</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">RepositoryImpl</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Implements the methods defined in Repository interface.</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Implements CRUD operations of the Entity and is dependent on persistence layer. Performs actual CRUD processes using API that performs persistence provided by Spring Framework, O/R Mapper and middleware.</div>
<div class="line">RepositoryImpl belongs to infrastructure layer since it plays the role of implementing the operations defined in Repository interface.</div>
<div class="line">Refer to <a class="reference internal" href="InfrastructureLayer.html"><span class="doc">Implementation of Infrastructure Layer</span></a> for the implementation of RepositoryImpl.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line">In case of multiple destinations in persistence layer, the resulting configuration as follows.</div>
<div class="line">due to this, the logic depending on persistence platform of Entity is hidden from business logic (Service).</div>
</div>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../_images/repository_not_depends_on.png"><img alt="persist entity" src="../_images/repository_not_depends_on.png" style="width: 100%;" /></a>
</figure>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Is it possible to hide 100% of persistence platform dependent logic from the Service class ?</strong></p>
<p>In some cases it cannot be hidden completely due to constraints of persistence platform and the libraries used to access the platform.
As much as possible, platform dependent logic should be implemented in RepositoryImpl instead of Service class.
When it is difficult to exclude the platform dependent logic and merits of doing so are less,
persistence platform dependent logic can be implemented as a part of business logic (Service) process.</p>
<p>A specific example of this is given here. There are cases when unique constraints violation error is needed to be handled when save method
of <code class="docutils literal notranslate"><span class="pre">org.springframework.data.jpa.repository.JpaRepository</span></code> interface provided by Spring Data JPA is called.
In case of JPA, there is a mechanism of cache entity operations and SQL is executed when transactions are committed.
Therefore, since SQL is not executed even if save method of JpaRepository is called, unique constraints violation error cannot be handled in logic.
There is a method (flush method) to reflect cached operations as means to explicitly issue SQLs in JPA.
saveAndFlush and flush methods are also provided in JpaRepository for the same purpose.
Therefore, when unique constraints violation error needs to be handled using JpaRepository of Spring Data JPA,
JPA dependent method (saveAndFlush or flush) must be called.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The most important purpose of creating Repository is not to exclude the persistence platform dependent logic from business logic.
The most important purpose is to limit the implementation scope of business logic (Service) to the implementation of business rules.
This is done by separating the operations to access business data in Repository. As an outcome of this, persistence platform dependent logic gets
implemented in Repository instead of business logic (Service).</p>
</div>
</div></blockquote>
</section>
<section id="creation-of-repository">
<h3><a class="toc-backref" href="#id13" role="doc-backlink"><span class="section-number">4.2.4.3. </span>Creation of Repository</a><a class="headerlink" href="#creation-of-repository" title="Permalink to this heading">¶</a></h3>
<p>Repository must be created using the following policy only.</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 35%" />
<col style="width: 55%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Method</p></th>
<th class="head"><p>Supplementary</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">1.</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Create Repository for the main Entity only.</div>
</div>
</td>
<td><div class="line-block">
<div class="line">This means separate Repository for operations of related Entity is not required.</div>
<div class="line">However, there are case when it is better to provide Repository for the related Entity in specific applications (for example,</div>
<div class="line">application having high performance requirements etc).</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">2.</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Place Repository interface and RepositoryImpl in the same package of domain layer.</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Repository interface belongs to domain layer and RepositoryImpl belongs to infrastructure layer. However,</div>
<div class="line">Java package of RepositoryImpl can be same as the Repository interface of domain layer.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">3.</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Place DTO used in Repository in the same package as Repository interface.</div>
</div>
</td>
<td><div class="line-block">
<div class="line">For example, DTO to store search criteria or summary DTO for that defines only a few items of Entity.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="example-of-creating-repository">
<h3><a class="toc-backref" href="#id14" role="doc-backlink"><span class="section-number">4.2.4.4. </span>Example of creating Repository</a><a class="headerlink" href="#example-of-creating-repository" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">An example of creating Repository is explained here.</div>
<div class="line">An example of creating Repository of Entity class used in the explanation of <a class="reference internal" href="#domainlayer-entity-example"><span class="std std-ref">Example of creating Entity class</span></a> is as follows.</div>
</div>
<section id="id1">
<h4><a class="toc-backref" href="#id15" role="doc-backlink"><span class="section-number">4.2.4.4.1. </span>Structure of Repository</a><a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h4>
<p>Entity class used in the explanation of <a class="reference internal" href="#domainlayer-entity-example"><span class="std std-ref">Example of creating Entity class</span></a> is used as an example, the resulting configuration is as follows:</p>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../_images/domainlayer_repository_layout.png"><img alt="Example of repository layout" src="../_images/domainlayer_repository_layout.png" style="width: 100%;" /></a>
</figure>
</div></blockquote>
<div class="line-block">
<div class="line">Repository is created for the main Entity class.</div>
<div class="line">Refer to <a class="reference internal" href="../Overview/ApplicationLayering.html#application-layering-project-structure"><span class="std std-ref">Project structure</span></a> for the recommended package structure.</div>
</div>
</section>
</section>
<section id="definition-of-repository-interface">
<span id="repository-interface-label"></span><h3><a class="toc-backref" href="#id16" role="doc-backlink"><span class="section-number">4.2.4.5. </span>Definition of Repository interface</a><a class="headerlink" href="#definition-of-repository-interface" title="Permalink to this heading">¶</a></h3>
<section id="creation-of-repository-interface">
<h4><a class="toc-backref" href="#id17" role="doc-backlink"><span class="section-number">4.2.4.5.1. </span>Creation of Repository interface</a><a class="headerlink" href="#creation-of-repository-interface" title="Permalink to this heading">¶</a></h4>
<p>An example of creating Repository interface is introduced below.</p>
<ul class="simple">
<li><p><code class="file docutils literal notranslate"><span class="pre">SimpleCrudRepository.java</span></code></p></li>
</ul>
<blockquote>
<div><div class="line-block">
<div class="line">This interface provides only simple CRUD operations.</div>
<div class="line">Method signature is created by referring to <code class="docutils literal notranslate"><span class="pre">CrudRepository</span></code> interface and <code class="docutils literal notranslate"><span class="pre">PagingAndSortingRepository</span></code> provided by Spring Data.</div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">SimpleCrudRepository</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Serializable</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="nf">findOne</span><span class="p">(</span><span class="n">ID</span><span class="w"> </span><span class="n">id</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">exists</span><span class="p">(</span><span class="n">ID</span><span class="w"> </span><span class="n">id</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// (3)</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findAll</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// (4)</span>
<span class="w">    </span><span class="n">Page</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findAll</span><span class="p">(</span><span class="n">Pageable</span><span class="w"> </span><span class="n">pageable</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// (5)</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="nf">count</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// (6)</span>
<span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">entity</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// (7)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">entity</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Method to fetch the Entity object of specified ID.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Method to determine if the Entity of specified ID exists or not.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Method to retrieve the list of all Entities. In Spring Data, it was <code class="docutils literal notranslate"><span class="pre">java.util.Iterable</span></code>. Here as a sample, it is set to <code class="docutils literal notranslate"><span class="pre">java.util.List</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Method to fetch collection of Entity objects corresponding to the specified pagination information (start position, record count, sort information).</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Pageable</span></code> and <code class="docutils literal notranslate"><span class="pre">Page</span></code> are the interfaces provided by Spring Data.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Method to fetch total number of Entity objects.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Method to save (create, update) the specified Entity collection.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Method to delete the specified Entity.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><p><code class="file docutils literal notranslate"><span class="pre">TodoRepository.java</span></code></p></li>
</ul>
<blockquote>
<div><p>An example of creating Repository of Todo Entity, which was created in tutorial, on the basis of <code class="docutils literal notranslate"><span class="pre">SimpleCrudRepository</span></code> interface created above is shown below.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">TodoRepository</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">SimpleCrudRepository</span><span class="o">&lt;</span><span class="n">Todo</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="nf">countByFinished</span><span class="p">(</span><span class="kt">boolean</span><span class="w"> </span><span class="n">finished</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">TodoRepository interface is created by specifying Todo entity in the generic type parameter “T” and</div>
<div class="line">String class in the generic type parameter “ID”.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Methods not provided by <code class="docutils literal notranslate"><span class="pre">SimpleCrudRepository</span></code> interface are added in this interface.</div>
<div class="line">In this case, “Method for acquiring count of Todo entity objects for which specified tasks have been finished” is added.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="method-definition-of-repository-interface">
<h4><a class="toc-backref" href="#id18" role="doc-backlink"><span class="section-number">4.2.4.5.2. </span>Method definition of Repository interface</a><a class="headerlink" href="#method-definition-of-repository-interface" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">It is recommended to have the same signature as <code class="docutils literal notranslate"><span class="pre">CrudRepository</span></code> and <code class="docutils literal notranslate"><span class="pre">PagingAndSortingRepository</span></code> provided by Spring Data for the methods performing general CRUD operations.</div>
<div class="line">However, in case of returning collection, (<code class="docutils literal notranslate"><span class="pre">java.util.Collection</span></code> or <code class="docutils literal notranslate"><span class="pre">java.util.List</span></code>) interfaces which can be handled in a better way in logic are better than <code class="docutils literal notranslate"><span class="pre">java.lang.Iterable</span></code>.</div>
<div class="line">In real development environment, it is difficult to develop an application using only general CRUD operations. Hence additional methods are required.</div>
<div class="line">It is recommended to add the methods as per the following rules.</div>
</div>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 20%" />
<col style="width: 70%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Types of methods</p></th>
<th class="head"><p>Rules</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li></li>
</ol>
</td>
<td><p>Method for searching a single record</p></td>
<td><ol class="arabic simple">
<li><p>Method name beginning with <strong>findOneBy</strong>to indicate that this method fetches a single record that matches with the condition.</p></li>
<li><p>In the method name after “findOneBy”, physical or logical name of the field used as search condition must be specified. Hence, the method name must be such that it becomes possible to estimate “the kind of entity that can be fetched using this method”.</p></li>
<li><p>There must be an argument for each search condition. However, when there are many conditions, DTO containing all search conditions can be provided.</p></li>
<li><p>Return value must be Entity class.</p></li>
</ol>
</td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p>Method for searching multiple records</p></td>
<td><ol class="arabic simple">
<li><p>Method name beginning with <strong>findAllBy</strong>to indicate that this method fetches all the records that matches with the condition.</p></li>
<li><p>In the method name after “findAllBy”, physical or logical name of the field used as search condition must be specified. Hence, the method name must be such that it becomes possible to estimate “the kind of entity that can be fetched using this method”.</p></li>
<li><p>There must be an argument for each search condition. However, when there are many conditions, DTO containing all search conditions can be provided.</p></li>
<li><p>Return value must be collection of Entity class.</p></li>
</ol>
</td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p>Method for searching multiple records with pagination</p></td>
<td><ol class="arabic simple">
<li><p>Method name beginning with <strong>findPageBy</strong>to indicate that this method fetches pages that matches with the condition.</p></li>
<li><p>In the method name after “findPageBy”, physical or logical name of the field used as search condition must be specified. Hence, the method name must be such that it becomes possible to estimate “the kind of entity that can be fetched using this method”.</p></li>
<li><p>There must be an argument for each search condition. However, when there are many conditions, DTO containing all search conditions can be provided. <code class="docutils literal notranslate"><span class="pre">Pageable</span></code> provided by Spring Data should be the interface for pagination information (start position, record count, sort information).</p></li>
<li><p>Return value should be <code class="docutils literal notranslate"><span class="pre">Page</span></code> interface provided by Spring Data.</p></li>
</ol>
</td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p>Count related method</p></td>
<td><ol class="arabic simple">
<li><p>Method name beginning with <strong>countBy</strong> to indicate that this method fetches count of Entities which matches with the condition.</p></li>
<li><p>Return value must be long type.</p></li>
<li><p>In the method name after “countBy”, physical or logical name of the field used as search condition must be specified. Hence, the method name must be such that it becomes possible to estimate “the kind of entity that can be fetched using this method”.</p></li>
<li><p>There must be an argument for each search condition. However, when there are many conditions, DTO containing all search conditions can be provided.</p></li>
</ol>
</td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="5">
<li></li>
</ol>
</td>
<td><p>Method for existence check</p></td>
<td><ol class="arabic simple">
<li><p>Method name beginning with <strong>existsBy</strong> to indicate that this method checks the existence of Entity which matches with the condition.</p></li>
<li><p>In the method name after “existsBy”physical or logical name of the field used as search condition must be specified. Hence, the method name must be such that it becomes possible to estimate “the kind of entity that can be fetched using this method”.</p></li>
<li><p>There must be an argument for each search condition. However, when there are many conditions, DTO containing all search conditions can be provided.</p></li>
<li><p>Return value must be boolean type.</p></li>
</ol>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In case of methods related to update processing, it is recommended to construct methods in the same way as shown above.
“find” in the method name above can be replaced by “update” or “delete”.</p>
</div>
</div></blockquote>
<ul class="simple">
<li><p><code class="file docutils literal notranslate"><span class="pre">Todo.java</span></code> (Entity)</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Todo</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Serializable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">todoId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">todoTitle</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">finished</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Date</span><span class="w"> </span><span class="n">createdAt</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li><p><code class="file docutils literal notranslate"><span class="pre">TodoRepository.java</span></code></p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">TodoRepository</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">SimpleCrudRepository</span><span class="o">&lt;</span><span class="n">Todo</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="n">Todo</span><span class="w"> </span><span class="nf">findOneByTodoTitle</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">todoTitle</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findAllByUnfinished</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// (3)</span>
<span class="w">    </span><span class="n">Page</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findPageByUnfinished</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// (4)</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="nf">countByExpired</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">validDays</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// (5)</span>
<span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">existsByCreateAt</span><span class="p">(</span><span class="n">Date</span><span class="w"> </span><span class="n">date</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Example of method that fetches TODO objects whose title matches with specified value (TODO in which todoTitle=[argument value]).</div>
<div class="line">Physical name(todoTitle) of condition field is specified after findOneBy.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Example of method that fetches unfinished TODO objects (TODO objects where finished=false).</div>
<div class="line">Logical condition name is specified after findAllBy.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Example of method that fetches pages of unfinished TODOs (TODO objects where finished=false).</div>
<div class="line">Logical condition name is specified after findPageBy.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Example of method that fetches count of TODO objects for which the finish deadline has already passed (TODO for which createdAt &lt; sysdate - [finish deadline in days] &amp;&amp; finished=false).</div>
<div class="line">Logical condition name is specified after countBy.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Example of method that checks whether a TODO is created on a specific date (createdAt=specified date).</div>
<div class="line">Physical name (createdAt) is specified after existsBy.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="creation-of-repositoryimpl">
<h4><a class="toc-backref" href="#id19" role="doc-backlink"><span class="section-number">4.2.4.5.3. </span>Creation of RepositoryImpl</a><a class="headerlink" href="#creation-of-repositoryimpl" title="Permalink to this heading">¶</a></h4>
<p>Refer to <a class="reference internal" href="InfrastructureLayer.html"><span class="doc">Implementation of Infrastructure Layer</span></a> for the implementation of RepositoryImpl.</p>
</section>
</section>
</section>
<section id="implementation-of-service">
<span id="service-label"></span><h2><a class="toc-backref" href="#id20" role="doc-backlink"><span class="section-number">4.2.5. </span>Implementation of Service</a><a class="headerlink" href="#implementation-of-service" title="Permalink to this heading">¶</a></h2>
<section id="roles-of-service">
<h3><a class="toc-backref" href="#id21" role="doc-backlink"><span class="section-number">4.2.5.1. </span>Roles of Service</a><a class="headerlink" href="#roles-of-service" title="Permalink to this heading">¶</a></h3>
<p>Service plays the following 2 roles.</p>
<ol class="arabic">
<li><div class="line-block">
<div class="line"><strong>Provides business logic to Controller.</strong></div>
<div class="line">Business logic consists of create, update, consistency check etc of business data as well as all the processes related to business logic.</div>
<div class="line">Create and update process of business data should be delegated to Repository(or O/R Mapper) and <strong>service should be limited to implementation of business rules.</strong></div>
</div>
</li>
</ol>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Regarding distribution of logic between Controller and Service</strong></p>
<p>In this guideline, the logic to be implemented by Controller and Service should be as per the rules given below.</p>
<ol class="arabic simple">
<li><p>For the data requested from the client, single item check and correlated item check is to be performed in Controller (Bean Validation or Spring Validator).</p></li>
<li><p>Conversion processes (Bean conversion, Type conversion and Format conversion) for the data to be passed to Service, must be performed in Controller instead of Service.</p></li>
<li><p><strong>Business rules should be implemented in Service.</strong>Access to business data is to be delegated to Repository or O/R Mapper.</p></li>
<li><p>Conversion processes (Type conversion and Format conversion) for the data received from Service (data to respond to the client), must be performed in Controller (View class etc).</p></li>
</ol>
</div>
<figure class="align-center">
<a class="reference internal image-reference" href="../_images/service_responsibility-of-logic.png"><img alt="responsibility of logic" src="../_images/service_responsibility-of-logic.png" style="width: 90%;" /></a>
</figure>
</div></blockquote>
<ol class="arabic" start="2">
<li><div class="line-block">
<div class="line"><strong>Declare transaction boundary.</strong></div>
<div class="line">Declare transaction boundary when business logic is performing any operation which requires ensuring data consistency (mainly data update process).</div>
<div class="line">Even in case of logic that just read the data, often there are cases where transaction management is required due to the nature of business requirements. In such cases, declare transaction boundary.</div>
<div class="line"><strong>Transaction boundary must be set in Service layer as a principle rule.</strong> If it is found to be set in application layer (Web layer), there is a possibility that the extraction of business logic has</div>
<div class="line">not been performed correctly.</div>
</div>
</li>
</ol>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../_images/service_transaction-boundary.png"><img alt="transaction boundary" src="../_images/service_transaction-boundary.png" style="width: 90%;" /></a>
</figure>
<p>Refer to <a class="reference internal" href="#service-transaction-management"><span class="std std-ref">Regarding transaction management</span></a> for details.</p>
</div></blockquote>
</section>
<section id="structure-of-service-class">
<span id="service-constitution-role-label"></span><h3><a class="toc-backref" href="#id22" role="doc-backlink"><span class="section-number">4.2.5.2. </span>Structure of Service class</a><a class="headerlink" href="#structure-of-service-class" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">Service consists of Service classes and SharedService classes and plays the following role.</div>
<div class="line">In this guideline, POJO (Plain Old Java Object) having <code class="docutils literal notranslate"><span class="pre">&#64;Service</span></code> annotation is defined as Service or SharedService class.</div>
<div class="line">We are not preventing the creation of interface and base classes that limit the signature of methods.</div>
</div>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 15%" />
<col style="width: 30%" />
<col style="width: 45%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Class</p></th>
<th class="head"><p>Role</p></th>
<th class="head"><p>Notes related to dependency relationship</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li></li>
</ol>
</td>
<td><p>Service class</p></td>
<td><div class="line-block">
<div class="line"><strong>Provides business logic to the specific Controller.</strong></div>
<div class="line">Service class methods <strong>must not implement logic that need to be reused.</strong></div>
</div>
</td>
<td><ol class="arabic simple">
<li><p><strong>It is prohibited to call a method of Service class from another Service class method (Figure 1-1).</strong>For shared logic, create SharedService class.</p></li>
<li><p>Method of Service class can be called from multiple Controllers (Figure 1-2). However, <strong>it must be created for each controller when processing is to be branched based on the calling controller.</strong>In such a scenario, create a method in SharedService class and call that method from the individual Service class methods.</p></li>
</ol>
</td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>SharedService class</p></td>
<td><div class="line-block">
<div class="line"><strong>Provides shared (reusable) logic</strong>for multiple Controllers and Service classes.</div>
</div>
</td>
<td><ol class="arabic simple">
<li><p>Methods of other SharedService classes can be called from a SharedService (Figure 2-1). However, <strong>Calling hierarchy should not become complicated.</strong> If calling hierarchy becomes complicated, there is a risk of reduction in maintainability.</p></li>
<li><p>Methods of SharedService classes can be called from Controller (Figure 2-2). However, <strong>it can be only be done if there is no problem from transaction management perspective.</strong>If there is a problem from transaction management perspective, first create a method in Service class and implement transaction management in this method.</p></li>
<li><p><strong>It is prohibited to call methods of Service class from SharedService (Figure 2-3).</strong></p></li>
</ol>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line">Dependency relationship of Service class and SharedService class is shown below.</div>
<div class="line">The numbers inside the diagram are related to the numbering in “Notes related to dependency relationship” column of the above table.</div>
</div>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../_images/service_class-dependency.png"><img alt="class dependency" src="../_images/service_class-dependency.png" style="width: 100%;" /></a>
</figure>
</div></blockquote>
<section id="reason-for-separating-service-and-sharedservice">
<h4><a class="toc-backref" href="#id23" role="doc-backlink"><span class="section-number">4.2.5.2.1. </span>Reason for separating Service and SharedService</a><a class="headerlink" href="#reason-for-separating-service-and-sharedservice" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">Logic that cannot be (should not be) reused and logic that can be (should be) reused exist in the business logic.</div>
<div class="line">To implement these 2 logics in the same class, it is difficult to decide whether a method can be re-used or not.</div>
<div class="line">To avoid this problem, <strong>it is strongly recommended to implement the method to be re-used in the SharedService class</strong>in this guideline.</div>
</div>
</section>
<section id="reason-for-prohibiting-the-calling-of-other-service-classes-from-service-class">
<h4><a class="toc-backref" href="#id24" role="doc-backlink"><span class="section-number">4.2.5.2.2. </span>Reason for prohibiting the calling of other Service classes from Service class</a><a class="headerlink" href="#reason-for-prohibiting-the-calling-of-other-service-classes-from-service-class" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">In this guideline, calling methods of other Service classes from a Service class is prohibited.</div>
<div class="line">Service provides business logic to a specific controller and is not created with the assumption of using it from other services.</div>
<div class="line">If it is called directly from other Service classes, the following situations can easily occur <strong>and there is a risk of reduced maintainability.</strong></div>
</div>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Situations that can occur</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li></li>
</ol>
</td>
<td><div class="line-block">
<div class="line">The logic that must be implemented in the calling service class, gets implemented in the called service class for reasons like “having the logic at a single location” etc.</div>
<div class="line">As a result, <strong>arguments for identifying the caller, get added to the method easily; Ultimately, the logic is incorrectly abstracted out as shared logic (like utilities). It results into a modular structure without much insight.</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="2">
<li></li>
</ol>
</td>
<td><div class="line-block">
<div class="line">If the stack patterns or stack of services calling each other is large in number, <strong>understanding the impact of modifications in source-code due to change in specifications or bug fixes, becomes difficult.</strong></div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="regarding-interface-and-base-classes-to-limit-signature-of-method">
<h4><a class="toc-backref" href="#id25" role="doc-backlink"><span class="section-number">4.2.5.2.3. </span>Regarding interface and base classes to limit signature of method</a><a class="headerlink" href="#regarding-interface-and-base-classes-to-limit-signature-of-method" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">In order to bring consistency in development of business logic, interfaces and base classes are created which limit the signature of the methods.</div>
<div class="line">The purpose is also to prevent the injection of differences due to development style of each developer by limiting the signature through interfaces and base classes.</div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>In large scale development, there are situations where not every single developer is highly skilled or situations like having consistency in development of business logic considering maintainability after servicing.
In such situations, limiting the signature through interfaces can be an appropriate decision.</p>
<p>In this guideline, we do not specifically recommended to create interface to limit signature; however, type of architecture must be selected on the basis of characteristics of the project.
decide the type of architecture taking into account the project properties.</p>
</div>
</div></blockquote>
<p></p>
<div class="line-block">
<div class="line">Appendix has a sample of creating interface and base classes to limit the signature.</div>
<div class="line">Refer to <a class="reference internal" href="#domainlayer-appendix-blogic"><span class="std std-ref">Sample of implementation of interface and base classes to limit signature</span></a> for details.</div>
</div>
</section>
</section>
<section id="patterns-of-creating-service-class">
<span id="service-creation-unit-label"></span><h3><a class="toc-backref" href="#id26" role="doc-backlink"><span class="section-number">4.2.5.3. </span>Patterns of creating service class</a><a class="headerlink" href="#patterns-of-creating-service-class" title="Permalink to this heading">¶</a></h3>
<p>There are mainly 3 patterns for creating Service.</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 15%" />
<col style="width: 25%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Unit</p></th>
<th class="head"><p>Creation method</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li></li>
</ol>
</td>
<td><div class="line-block">
<div class="line">For each Entity</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Create Service paired with the main Entity.</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Main Entity is in other words, business data. <strong>If the application is to be designed and implemented with focus on business data, then Service classes should be created in this way.</strong></div>
<div class="line"><br /></div>
<div class="line">If service is created in this way, business logic will also be created for each entity and it will become to extract shared logic.</div>
<div class="line">However, if Service is created using this pattern, its affinity is not so good with the type of application which has to be developed</div>
<div class="line">by introducing a large number of developers at the same time.</div>
<div class="line">It can be said that the pattern is suitable when for the developing small or medium sized application.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="2">
<li></li>
</ol>
</td>
<td><div class="line-block">
<div class="line">For each use-case</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Create Service paired with the use-case.</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><strong>If the application is to be designed and implemented with focus on events on the screen, Service should be created in this way.</strong></div>
<div class="line"><br /></div>
<div class="line">If the Service is created using this pattern, it is possible to assign a person to each use case; hence, its affinity is good with</div>
<div class="line">the type of application which has to be developed by introducing a large number of developer at the same time.</div>
<div class="line"><br /></div>
<div class="line">On the other hand, if Service is created using this pattern, shared logic within use case can be extracted to a single location;</div>
<div class="line">however, shared logic which spans across multiple use-case might not get extracted to a single location.</div>
<div class="line">When it is very important to have extract shared logic out to a single location, it becomes necessary devise measures like having</div>
<div class="line">a separate team to look after designing shared components of business logic that span across multiple use cases.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="3">
<li></li>
</ol>
</td>
<td><div class="line-block">
<div class="line">For each event</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Create Service paired with the events generated from screen.</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><strong>If the application is to be designed and implemented with focus on events on the screen and BLogic class is auto-generated using TERASOLUNA ViSC, Service should be created in this way.</strong></div>
<div class="line">In this guideline, the Service class created using this pattern is called <code class="docutils literal notranslate"><span class="pre">BLogic</span></code>.</div>
<div class="line"><br /></div>
<div class="line">The characteristics of the application if creating Service using this pattern are basically same as those when creating Service for each use case.</div>
<div class="line"><br /></div>
<div class="line">However, in this case extracting shared logic out of business logic might get more difficult compared to creation of Service for each use-case (Pattern No. 2).</div>
<div class="line">In this guideline, pattern of creating Service for each event is not specifically recommended. However, in large scale development, creating Service using this</div>
<div class="line">pattern can be considered as one of the options with the view of having consistency in development style of business logic from maintainability point of view.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>The pattern of Service creation must be decided by taking into account the features of application to be developed and the structure of development team.</strong></p>
<p><strong>It is not necessary to narrow down to any one pattern</strong> out of the 3 indicated patterns.
Creating Services using different patterns randomly should be avoided for sure; however, <strong>patterns can be used in combinations, if policy of usage of patterns in certain
specific conditions has been well-thought decision and has been directed by the architect.</strong>
For example, the following combinations are possible.</p>
<p>[Example of usage of patterns in combination]</p>
<ul class="simple">
<li><p>For the business logic very important to the whole application, create as SharedService class for each Entity.</p></li>
<li><p>For the business logic to be processed for the events from the screen, create as Service class for each Controller.</p></li>
<li><p>In the Service class for each controller, implement business logic by calling the sharedService as and when required.</p></li>
</ul>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>BLogic is generated directly from design documents when using “TERASOLUNA ViSC”.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="image-of-application-development-creating-service-for-each-entity">
<h4><a class="toc-backref" href="#id27" role="doc-backlink"><span class="section-number">4.2.5.3.1. </span>Image of Application development - Creating Service for each Entity</a><a class="headerlink" href="#image-of-application-development-creating-service-for-each-entity" title="Permalink to this heading">¶</a></h4>
<p>Following is the image of application development when creating a Service for each Entity.</p>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>An example of a typical application in which a Service is created for each Entity is a REST application. REST application provides CRUD operations (POST, GET, PUT, DELETE of HTTP)
for published resources on HTTP. Most of the times, the resources published on HTTP are business data (Entity) or part of business data (Entity), they have good compatibility
with the pattern of creating Service for each Entity.</p>
<p>In case of REST application, most of the times, use-cases are also extracted on a “per Entity” basis. Hence, the structure is similar to the case when Service is created for on a “per use-case” basis.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../_images/service_unit_resource.png"><img alt="multiple controller unit" src="../_images/service_unit_resource.png" style="width: 100%;" /></a>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Implement Service by assigning a person for each Entity.</div>
<div class="line">If there is no specific reason, it is desirable that Controller must also be created for each Entity and must be developed by the same developer who created the Service class.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Implement SharedService if there is shared logic between multiple business logics.</div>
<div class="line">In the above figure, different person is assigned as the in-charge. However, he may be the same person as (1) depending per the project structure.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="image-of-application-development-creating-service-for-each-use-case">
<h4><a class="toc-backref" href="#id28" role="doc-backlink"><span class="section-number">4.2.5.3.2. </span>Image of Application development - Creating Service for each use case</a><a class="headerlink" href="#image-of-application-development-creating-service-for-each-use-case" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">Following is the image of application development when creating a Service for each use-case.</div>
<div class="line">In case of use-case which performs CRUD operations on the Entity, structure is same as in case of creating Service for each Entity.</div>
</div>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../_images/service_unit_controller.png"><img alt="controller unit" src="../_images/service_unit_controller.png" style="width: 100%;" /></a>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Implement Service by assigning a person for each use-case.</div>
<div class="line">If there is no specific reason, it is desirable that Controller must also be created for each use-case and must be developed by the same developer who created the Service class.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Implement SharedService if there is shared logic between multiple business logics.</div>
<div class="line">In the above figure, different person is assigned as the in-charge. However, he may be the same person as (1) depending per the project structure.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>With an increase in the size of the use-cases, the development scope of a person increases. At such a point of time, it becomes difficult to divide the work of this use-case
with other developers. In case of application which has to be developed by introducing a large number of developer at the same time, the use-case can be further split into finer
use-cases and which can then be allocated to more number of developers.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">Below is the image of application development when the use-case is further split.</div>
<div class="line">Splitting a use-case has no impact on SharedService. Hence, the explanation is omitted here.</div>
</div>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../_images/service_unit_controller2.png"><img alt="multiple controller unit" src="../_images/service_unit_controller2.png" style="width: 100%;" /></a>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Divide the use-case into finer processes which make-up the complete use-case. Assign each fine process to a developer. Each developer creates the Service for assigned process.</div>
<div class="line">Note that the processes here are operations like search, create, update, delete etc. and these processes do not have a direct mapping to the processing required to be done for</div>
<div class="line">each event generated on screen.</div>
<div class="line">For example, if it the event generated on screen is “Update”, it includes multiple finer processes such as “Fetching the data to be updated”, “Compatibility check of update contents” etc.</div>
<div class="line">If there is no specific reason, it is desirable that Controller must also be created for each of these finer processes and must be developed by the same developer who creates the Service class.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>In some projects, “group of use-cases” and “use-cases” are used in place of “use-case” and “processes” used in this guideline.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="image-of-application-development-creating-service-for-each-use-event">
<h4><a class="toc-backref" href="#id29" role="doc-backlink"><span class="section-number">4.2.5.3.3. </span>Image of Application development - Creating Service for each use event</a><a class="headerlink" href="#image-of-application-development-creating-service-for-each-use-event" title="Permalink to this heading">¶</a></h4>
<p>Following is the image of application development when creating a Service(BLogic) for each event.</p>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../_images/service_unit_business-ligic.png"><img alt="constitution image of business logic unit" src="../_images/service_unit_business-ligic.png" style="width: 100%;" /></a>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Implement Service(BLogic) by assigning a person for each event.</div>
<div class="line">Above example is an extreme case where separate developer is assigned for each service(BLogic).</div>
<div class="line">In reality, a single person must be assigned for a use-case.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">If there is no specific reason, controller also should be created on “per use-case” basis.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Even if the separate Service(BLogic) is created for each event, it is recommended that same person is the in-charge of the complete use-case.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Implement in SharedService to share the logic with multiple business logics.</div>
<div class="line">In the above figure, different person is assigned as the in-charge. However, he may be the same person as (1) depending per the project structure.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>With an increase in the size of the use-cases, the development scope of a person increases. At such a point of time, it becomes difficult to divide the work of this use-case
with other developers. In case of application which has to be developed by introducing a large number of developer at the same time, the use-case can be further split into finer
use-cases and which can then be allocated to more number of developers.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">Below is the image of application development when the use-case is further split.</div>
<div class="line">Splitting a use-case has no impact on SharedService. Hence, the explanation is omitted here.</div>
</div>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../_images/service_unit_business-ligic2.png"><img alt="multiple controller unit" src="../_images/service_unit_business-ligic2.png" style="width: 100%;" /></a>
</figure>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Divide the use-case into finer processes which make-up the complete use-case. Assign each fine process to a developer. Each developer creates the Service for assigned process.</div>
<div class="line">Note that the processes here are operations like search, create, update, delete etc. and these processes do not have a direct mapping to the processing required to be done for</div>
<div class="line">each event generated on screen.</div>
<div class="line">For example, if it the event generated on screen is “Update”, it includes multiple finer processes such as “Fetching the data to be updated”, “Compatibility check of update contents” etc.</div>
<div class="line">If there is no specific reason, it is desirable that Controller must also be created for each of these finer processes and must be developed by the same developer who creates the Service class.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
</section>
<section id="creation-of-service-class">
<span id="service-class-label"></span><h3><a class="toc-backref" href="#id30" role="doc-backlink"><span class="section-number">4.2.5.4. </span>Creation of Service class</a><a class="headerlink" href="#creation-of-service-class" title="Permalink to this heading">¶</a></h3>
<section id="methods-of-creating-service-class">
<span id="service-class-creation-label"></span><h4><a class="toc-backref" href="#id31" role="doc-backlink"><span class="section-number">4.2.5.4.1. </span>Methods of creating Service class</a><a class="headerlink" href="#methods-of-creating-service-class" title="Permalink to this heading">¶</a></h4>
<p>Below are the points to be taken care of while creating Service class.</p>
<ul class="simple">
<li><p>Creation of Service interface</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">CartService</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><strong>It is recommended to create Service interface.</strong></div>
<div class="line">By providing an interface, it is possible to execute the method published as Service explicitly.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p></p>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Merits from architecture perspective</strong></p>
<ol class="arabic simple">
<li><p>If interface is there, When using AOP, Dynamic proxies functionality of standard JDK is used.
In case of no interface, CGLIB included in Spring Framework is used. In case of CGLIB there are certain restrictions like “Advice cannot be applied on final methods” etc.
Refer to <a class="reference external" href="http://docs.spring.io/spring/docs/4.1.9.RELEASE/spring-framework-reference/html/aop.html#aop-proxying">Spring Reference Document -Aspect Oriented Programming with Spring(Proxying mechanisms)-</a>for details.</p></li>
<li><p>It becomes easier to create a stub of business logic. When application layer and domain layer are developed in parallel using different development teams, stubs of Service
are required. When there is a need to create stubs, it is recommended to have interface .</p></li>
</ol>
</div>
</div></blockquote>
<ul class="simple">
<li><p>Creation of Service class</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Service</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="nd">@Transactional</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CartServiceImpl</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">CartService</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (3) (4)</span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;context:component-scan</span><span class="w"> </span><span class="na">base-package=</span><span class="s">&quot;xxx.yyy.zzz.domain&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><strong>Add &#64;Service annotation to class.</strong></div>
<div class="line">By adding the above annotation, bean definition in configuration file is not required.</div>
<div class="line">Specify package for component scanning in <code class="docutils literal notranslate"><span class="pre">base-package</span></code> attribute of &lt;context:component-scan&gt; element.</div>
<div class="line">In case of this example, all the classes in “xxx.yyy.zzz.domain” is registered in container.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><strong>Add &#64;Transactional annotation to class.</strong></div>
<div class="line">By adding the above annotation, transaction boundary is set for to the all the methods of the Service class.</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">value</span></code> attribute should be specified as required.</div>
<div class="line">Refer to <a class="reference internal" href="#transaction-management-declare-transaction-info-label"><span class="std std-ref">Information required for “Declarative transaction management”</span></a> for details.</div>
</div>
<div class="line-block">
<div class="line">Moreover, to understand the points to be noted when using <code class="docutils literal notranslate"><span class="pre">&#64;Transactional</span></code> annotation, it is advisable to confirm with “<a class="reference internal" href="#domainlayerappendixtransactionmanagement"><span class="std std-ref">Regarding drawbacks of transaction management</span></a>”.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><strong>Consider interface name as XxxService and class name as XxxServiceImpl.</strong></div>
<div class="line">Any naming conventions can be used. However, it is recommended to use distinguishable naming conventions for Service class and SharedService class.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><strong>Service class must not maintain state. Register it in container as bean of singleton scope .</strong></div>
<div class="line">Objects (POJO such as Entity/DTO/VO) and values (primitive type, primitive wrapper class) where state changes in each thread should not be maintained in class level fields.</div>
<div class="line">Setting scope to any value other than singleton (prototype, request, session)  using <code class="docutils literal notranslate"><span class="pre">&#64;Scope</span></code>  annotation is also prohibited.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p></p>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Reason for adding &#64;Transactional annotation to class</strong></p>
<p>Transaction boundary is required only for the business logic that updates the database. However, it is recommended to apply the annotation at class level to prevent bugs due to skipped annotation.
However, defining <code class="docutils literal notranslate"><span class="pre">&#64;Transactional</span></code> annotation only at required places (methods which update the database) is also fine.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Reason to prohibit non-singleton scopes</strong></p>
<ol class="arabic simple">
<li><p>prototype, request, session are the scopes for registering bean that maintains state. Hence they must not be used in Service class.</p></li>
<li><p>When scope is set to request or prototype, performance is affected as the bean generation frequency is high in DI container.</p></li>
<li><p>When scope is set to request or session, it cannot be used in non Web applications (for example, Batch application).</p></li>
</ol>
</div>
</div></blockquote>
</section>
<section id="creation-of-methods-of-service-class">
<span id="service-class-method-creation-label"></span><h4><a class="toc-backref" href="#id32" role="doc-backlink"><span class="section-number">4.2.5.4.2. </span>Creation of methods of Service class</a><a class="headerlink" href="#creation-of-methods-of-service-class" title="Permalink to this heading">¶</a></h4>
<p>Below are the points to be taken care of while writing methods of Service class.</p>
<ul class="simple">
<li><p>Creation of method of Service interface</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">CartService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Cart</span><span class="w"> </span><span class="nf">createCart</span><span class="p">();</span><span class="w"> </span><span class="c1">// (1) (2)</span>
<span class="w">    </span><span class="n">Cart</span><span class="w"> </span><span class="nf">findCart</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">cartId</span><span class="p">);</span><span class="w"> </span><span class="c1">// (1) (2)</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>Creation of methods of Service class</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CartServiceImpl</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">CartService</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Inject</span>
<span class="w">    </span><span class="n">CartRepository</span><span class="w"> </span><span class="n">cartRepository</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Cart</span><span class="w"> </span><span class="nf">createCart</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (1) (2)</span>
<span class="w">        </span><span class="n">Cart</span><span class="w"> </span><span class="n">cart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Cart</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">        </span><span class="n">cartRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">cart</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">cart</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Cart</span><span class="w"> </span><span class="nf">findCart</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">cartId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (1) (2)</span>
<span class="w">        </span><span class="n">Cart</span><span class="w"> </span><span class="n">cart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cartRepository</span><span class="p">.</span><span class="na">findByCartId</span><span class="p">(</span><span class="n">cartId</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">cart</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><strong>Create a method of Service class for each business logic.</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><strong>Define methods in Service interface and implement business logic in its implementation class.</strong></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><strong>Add &#64;Transactional annotation for changes to default transaction definition (class level annotation).</strong></div>
<div class="line">Attributes should be specified as per the requirement.</div>
<div class="line">Refer to <a class="reference internal" href="#transaction-management-declare-transaction-info-label"><span class="std std-ref">Information required for “Declarative transaction management”</span></a> for details.</div>
</div>
<div class="line-block">
<div class="line">Moreover, to understand the points to be noted when using <code class="docutils literal notranslate"><span class="pre">&#64;Transactional</span></code> annotation, it is advisable to confirm with “<a class="reference internal" href="#domainlayerappendixtransactionmanagement"><span class="std std-ref">Regarding drawbacks of transaction management</span></a>”.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p></p>
<blockquote>
<div><div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><strong>Transaction definition of business logic for reference</strong></p>
<p>When business logic for reference is to be implemented, by specifying <code class="docutils literal notranslate"><span class="pre">&#64;Transactional(readOnly</span> <span class="pre">=</span> <span class="pre">true)</span></code>,
instruction can be given to run the SQL under “Read-only transactions” for JDBC driver.</p>
<p>The way of handling read-only transactions depends on the implementation of JDBC driver; hence, confirm the specifications of JDBC driver to be used.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Points to be noted when using “Read-only transactions”</strong></p>
<p>If it is set to “perform health check” when retrieving a connection from connection pool, “Read-only transactions” may not be enabled.
For details on this event and to avoid the same, refer to <a class="reference internal" href="#domainlayertransactionmanagementwarningdisablecase"><span class="std std-ref">About cases where “Read-only transactions” are not enabled</span></a>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Transaction definition when a new transaction is required to be started</strong></p>
<p>Set <code class="docutils literal notranslate"><span class="pre">&#64;Transactional(propagation</span> <span class="pre">=</span> <span class="pre">Propagation.REQUIRES_NEW)</span></code> to start a new transaction
without participating in the transaction of the caller method.</p>
</div>
</div></blockquote>
</section>
<section id="regarding-arguments-and-return-values-of-methods-of-service-class">
<span id="service-class-method-args-return-label"></span><h4><a class="toc-backref" href="#id33" role="doc-backlink"><span class="section-number">4.2.5.4.3. </span>Regarding arguments and return values of methods of Service class</a><a class="headerlink" href="#regarding-arguments-and-return-values-of-methods-of-service-class" title="Permalink to this heading">¶</a></h4>
<p>The below points must be considered for arguments and return values of methods of Service class.</p>
<div class="line-block">
<div class="line">Serializable classes (class implementing <code class="docutils literal notranslate"><span class="pre">java.io.Serializable</span></code>) must be used for arguments and return values of Service class.</div>
<div class="line">Since there is possibility of Service class getting deployed as distributed application, it is recommended to allow only Serializable class.</div>
</div>
<p><strong>Typical arguments and return values of the methods are as follows.</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>Primitive types (<code class="docutils literal notranslate"><span class="pre">int</span></code>, <code class="docutils literal notranslate"><span class="pre">long</span></code>)</p></li>
<li><p>Primitive wrapper classes (<code class="docutils literal notranslate"><span class="pre">java.lang.Integer</span></code>, <code class="docutils literal notranslate"><span class="pre">java.lang.Long</span></code>)</p></li>
<li><p>java standard classes (<code class="docutils literal notranslate"><span class="pre">java.lang.String</span></code>, <code class="docutils literal notranslate"><span class="pre">java.util.Date</span></code>)</p></li>
<li><p>Domain objects (Entity, DTO)</p></li>
<li><p>Input/output objects (DTO)</p></li>
<li><p>Collection (implementation class of <code class="docutils literal notranslate"><span class="pre">java.util.Collection</span></code>) of above types</p></li>
<li><p>void</p></li>
<li><p>etc …</p></li>
</ul>
</div></blockquote>
<p></p>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Input/Output objects</strong></p>
<ol class="arabic simple">
<li><p>Input object indicates the object that has all the input values required for executing Service method.</p></li>
<li><p>Output object indicates the object that has all the execution results (output values) of Service method.</p></li>
</ol>
<blockquote>
<div><p>If business logic(BLogic class) is generated using “TERASOLUNA ViSC” then, input and output objects are used as argument and return value of the of BLogic class.</p>
</div></blockquote>
</div>
</div></blockquote>
<p><strong>Values that are forbidden as arguments and return values are as follows.</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>Objects (<code class="docutils literal notranslate"><span class="pre">javax.servlet.http.HttpServletRequest</span></code> , <code class="docutils literal notranslate"><span class="pre">javax.servlet.http.HttpServletResponse</span></code> , <code class="docutils literal notranslate"><span class="pre">javax.servlet.http.HttpSession</span></code> , <code class="docutils literal notranslate"><span class="pre">org.springframework.http.server.ServletServerHttpRequest</span></code>) which are dependent on implementation architecture of application layer (Servlet API or web layer API of Spring).</p></li>
<li><p>Model(Form, DTO) classes of application layer</p></li>
<li><p>Implementation classes of <code class="docutils literal notranslate"><span class="pre">java.util.Map</span></code></p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Reason for prohibition</strong></p>
<ol class="arabic simple">
<li><p>If objects depending on implementation architecture of application layer are allowed, then application layer and domain layer get tightly coupled.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">java.util.Map</span></code> is too generalized. Using it for method arguments and return values makes it difficult to understand what type of object is stored inside it. Further, since the values are managed using keys, the following problems may occur.</p></li>
</ol>
<blockquote>
<div><ul class="simple">
<li><p>Values are mapped to a unique key and hence cannot be retrieved by specifying a key name which is different from the one specified at the time of inserting the value.</p></li>
<li><p>When key name has to be changed, it becomes difficult to determine the impacted area.</p></li>
</ul>
</div></blockquote>
</div>
</div></blockquote>
<p><strong>How to sharing the same DTO between the application layer and domain layer is shown below.</strong></p>
<ul class="simple">
<li><p>DTO belonging to the package of domain layer can be used in application layer.</p></li>
</ul>
<p></p>
<blockquote>
<div><div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Form and DTO of application layer should not be used in domain layer.</p>
</div>
</div></blockquote>
</section>
</section>
<section id="implementation-of-sharedservice-class">
<span id="shared-service-class-label"></span><h3><a class="toc-backref" href="#id34" role="doc-backlink"><span class="section-number">4.2.5.5. </span>Implementation of SharedService class</a><a class="headerlink" href="#implementation-of-sharedservice-class" title="Permalink to this heading">¶</a></h3>
<section id="creation-of-sharedservice-class">
<span id="shared-service-class-creation-label"></span><h4><a class="toc-backref" href="#id35" role="doc-backlink"><span class="section-number">4.2.5.5.1. </span>Creation of SharedService class</a><a class="headerlink" href="#creation-of-sharedservice-class" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">Below are the points to be taken care of while creating SharedService class.</div>
<div class="line">Only the points which are different from Service class are explained here.</div>
</div>
<ol class="arabic">
<li><div class="line-block">
<div class="line"><strong>Add &#64;Transactional annotation to class as and when required.</strong></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">&#64;Transactional</span></code> annotation is not required when data access is not involved.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Interface name should be XxxSharedService and class name should be XxxSharedServiceImpl.</strong></div>
<div class="line">Any other naming conventions can also be used. However, it is recommended to use distinguishable naming conventions for Service class and SharedService class.</div>
</div>
</li>
</ol>
</section>
<section id="creation-of-sharedservice-class-method">
<span id="shared-service-class-method-creation-label"></span><h4><a class="toc-backref" href="#id36" role="doc-backlink"><span class="section-number">4.2.5.5.2. </span>Creation of SharedService class method</a><a class="headerlink" href="#creation-of-sharedservice-class-method" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">Below are the points to be taken care of while writing methods of SharedService class.</div>
<div class="line">Only the points which are different from Service class are explained here.</div>
</div>
<ol class="arabic">
<li><p><strong>Methods in SharedService class must be created for each logic which is shared between multiple business logics.</strong></p></li>
<li><div class="line-block">
<div class="line"><strong>Add &#64;Transactional annotation to class as and when required.</strong></div>
<div class="line">Annotation is not required when data access is not involved.</div>
</div>
</li>
</ol>
</section>
<section id="regarding-arguments-and-return-values-of-sharedservice-class-method">
<span id="shared-service-class-method-args-return-label"></span><h4><a class="toc-backref" href="#id37" role="doc-backlink"><span class="section-number">4.2.5.5.3. </span>Regarding arguments and return values of SharedService class method</a><a class="headerlink" href="#regarding-arguments-and-return-values-of-sharedservice-class-method" title="Permalink to this heading">¶</a></h4>
<p>Points are same as <a class="reference internal" href="#service-class-method-args-return-label"><span class="std std-ref">Regarding arguments and return values of methods of Service class</span></a>.</p>
</section>
</section>
<section id="implementation-of-logic">
<span id="service-implementation-label"></span><h3><a class="toc-backref" href="#id38" role="doc-backlink"><span class="section-number">4.2.5.6. </span>Implementation of logic</a><a class="headerlink" href="#implementation-of-logic" title="Permalink to this heading">¶</a></h3>
<p>Implementation in Service and SharedService is explained here.</p>
<p>Service and SharedService has implementation of logic related to operations such as data fetch, update, consistency check  of business data
and implementation related to business rules.</p>
<p>Example of a typical logic is explained below.</p>
<section id="operate-on-business-data">
<h4><a class="toc-backref" href="#id39" role="doc-backlink"><span class="section-number">4.2.5.6.1. </span>Operate on business data</a><a class="headerlink" href="#operate-on-business-data" title="Permalink to this heading">¶</a></h4>
<p>Refer to the following for the examples of data (Entity) fetch and update.</p>
<ul class="simple">
<li><p>When using MyBatis3, <a class="reference internal" href="../ArchitectureInDetail/DataAccessMyBatis3.html"><span class="doc">Database Access (MyBatis3)</span></a></p></li>
<li><p>When using JPA, <a class="reference internal" href="../ArchitectureInDetail/DataAccessJpa.html"><span class="doc">Database Access (JPA)</span></a></p></li>
</ul>
</section>
<section id="returning-messages">
<span id="service-return-message-label"></span><h4><a class="toc-backref" href="#id40" role="doc-backlink"><span class="section-number">4.2.5.6.2. </span>Returning messages</a><a class="headerlink" href="#returning-messages" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">Warning message and business error message are the two type of messages which must be resolved in Service (refer to the figure in red broken line below).</div>
<div class="line">Other messages should be resolved in application layer.</div>
<div class="line">Refer to <a class="reference internal" href="../ArchitectureInDetail/MessageManagement.html"><span class="doc">Message Management</span></a> for message types and message pattern.</div>
</div>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../_images/service_target-resolving-message.png"><img alt="target of resolving message" src="../_images/service_target-resolving-message.png" style="width: 100%;" /></a>
</figure>
</div></blockquote>
<p></p>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Regarding resolving message</strong></p>
<p>In service, instead of the actual message <strong>the information required for building the message  (message code, message insert value) is resolved</strong>.</p>
</div>
</div></blockquote>
<p>Refer to the following for detailed implementation method.</p>
<ul class="simple">
<li><p><a class="reference internal" href="#service-return-warnmessage-label"><span class="std std-ref">Returning warning message</span></a></p></li>
<li><p><a class="reference internal" href="#service-return-businesserrormessage-label"><span class="std std-ref">Notifying business error</span></a></p></li>
</ul>
</section>
<section id="returning-warning-message">
<span id="service-return-warnmessage-label"></span><h4><a class="toc-backref" href="#id41" role="doc-backlink"><span class="section-number">4.2.5.6.3. </span>Returning warning message</a><a class="headerlink" href="#returning-warning-message" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">Message object must be returned for warning message. If domain object such as Entity needs to be returned with it,</div>
<div class="line">message object and domain object should inserted into output object (DTO) and this output object must be returned.</div>
</div>
<div class="line-block">
<div class="line">Message object ( <code class="docutils literal notranslate"><span class="pre">org.terasoluna.gfw.common.message.ResultMessages</span></code> ) is provided as common library. When the class provided in common library</div>
<div class="line">does not fulfill the requirements, message object should be created for each project.</div>
</div>
<ul class="simple">
<li><p>Creation of DTO</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OrderResult</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Serializable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ResultMessages</span><span class="w"> </span><span class="n">warnMessages</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Order</span><span class="w"> </span><span class="n">order</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul>
<li><p>Implementation of method of Service class</p>
<p>Following is an example of implementation of displaying a warning message.
The message is “Products may not be delivered together since the order includes products which are not available right now”.</p>
</li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="n">OrderResult</span><span class="w"> </span><span class="nf">submitOrder</span><span class="p">(</span><span class="n">Order</span><span class="w"> </span><span class="n">order</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="c1">// omitted</span>

<span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">hasOrderProduct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orderRepository</span><span class="p">.</span><span class="na">existsByOrderProduct</span><span class="p">(</span><span class="n">order</span><span class="p">);</span><span class="w"> </span><span class="c1">// (1)</span>

<span class="w">    </span><span class="c1">// omitted</span>

<span class="w">    </span><span class="n">Order</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orderRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">order</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// omitted</span>

<span class="w">    </span><span class="n">ResultMessages</span><span class="w"> </span><span class="n">warnMessages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">hasOrderProduct</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">warnMessages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ResultMessages</span><span class="p">.</span><span class="na">warn</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;w.xx.xx.0001&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// (3)</span>
<span class="w">    </span><span class="n">OrderResult</span><span class="w"> </span><span class="n">orderResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">OrderResult</span><span class="p">();</span>
<span class="w">    </span><span class="n">orderResult</span><span class="p">.</span><span class="na">setOrder</span><span class="p">(</span><span class="n">order</span><span class="p">);</span>
<span class="w">    </span><span class="n">orderResult</span><span class="p">.</span><span class="na">setWarnMessages</span><span class="p">(</span><span class="n">warnMessages</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">orderResult</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">When the order includes products which are not available right now, set  <code class="docutils literal notranslate"><span class="pre">hasOrderProduct</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">In the above example, when the order includes products which are not available right now, a warning message occurs.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">In the above example, the registered <code class="docutils literal notranslate"><span class="pre">Order</span></code> object and warning message are returned by storing objects in a DTO called <code class="docutils literal notranslate"><span class="pre">OrderResult</span></code>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="notifying-business-error">
<span id="service-return-businesserrormessage-label"></span><h4><a class="toc-backref" href="#id42" role="doc-backlink"><span class="section-number">4.2.5.6.4. </span>Notifying business error</a><a class="headerlink" href="#notifying-business-error" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">Business exception is thrown when business rules are violated while executing business logic.</div>
<div class="line">The following can be the cases.</div>
</div>
<ul class="simple">
<li><p>When reservation date exceeds deadline while making tour reservation</p></li>
<li><p>When the product is out of stock at the time of placing an order</p></li>
<li><p>etc …</p></li>
</ul>
<div class="line-block">
<div class="line">Business exception ( <code class="docutils literal notranslate"><span class="pre">org.terasoluna.gfw.common.exception.BusinessException</span></code> ) is provided as common library.</div>
<div class="line">When business exception class provided in common library does not fulfill the requirements, business exception class should be created in the project.</div>
<div class="line"><strong>It is recommended to create business exception class as subclass of java.lang.RuntimeException</strong>.</div>
</div>
<p></p>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Reason for considering business exception as an unchecked exception</strong></p>
<p>Since business exceptions need to be handled in controller class, they can be configured as checked exception.
However in this guideline, it is recommended that business exception be subclass of unchecked exception (<code class="docutils literal notranslate"><span class="pre">java.lang.RuntimeException</span></code>). By default,
if there is a RuntimeException, transaction will be rolled back. Hence, doing this will prevent leaving a bug in the source-code due to inadequate settings of &#64;Transactional annotation.
Obviously, if settings are changed such that transaction rollbacks even in case checked exceptions, business exception can be configured as subclass of checked exceptions.</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">Example of throwing business exception.</div>
<div class="line">Below example notifies that reservation is past the deadline and a business error.</div>
</div>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// omitted</span>

<span class="k">if</span><span class="p">(</span><span class="n">currentDate</span><span class="p">.</span><span class="na">after</span><span class="p">(</span><span class="n">reservationLimitDate</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">ResultMessages</span><span class="p">.</span><span class="na">error</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;e.xx.xx.0001&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">// omitted</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>Business exception is thrown since reservation date is past the deadline at the time of making reservation.</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>Refer to <a class="reference internal" href="../ArchitectureInDetail/ExceptionHandling.html"><span class="doc">Exception Handling</span></a> for details of entire exception handling.</p>
</section>
<section id="notifying-system-error">
<span id="service-return-systemerrormessage-label"></span><h4><a class="toc-backref" href="#id43" role="doc-backlink"><span class="section-number">4.2.5.6.5. </span>Notifying system error</a><a class="headerlink" href="#notifying-system-error" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">System exception is thrown when error occurs in system while executing business logic.</div>
<div class="line">The following can be the cases.</div>
</div>
<ul class="simple">
<li><p>When master data, directories and files that should already exist, do not exist</p></li>
<li><p>When a checked exception generated by a library method is caught and this exception indicates abnormal system state.</p></li>
<li><p>etc …</p></li>
</ul>
<div class="line-block">
<div class="line">System exception (<code class="docutils literal notranslate"><span class="pre">org.terasoluna.gfw.common.exception.SystemException</span></code>) is provided as common library.</div>
<div class="line">When system exception class provided in common library does not fulfill the requirements, system exception class should be created in the project.</div>
<div class="line"><strong>It is recommended to create system exception class as subclass of java.lang.RuntimeException</strong>.</div>
<div class="line">The reason is system exception should not be handled by application code and rollback target of <code class="docutils literal notranslate"><span class="pre">&#64;Transactinal</span></code> annotation is set to <code class="docutils literal notranslate"><span class="pre">java.lang.RuntimeException</span></code> by default.</div>
</div>
<div class="line-block">
<div class="line">Example of throwing system exception.</div>
<div class="line">Example notifying the non-existence of the specific product in product master as system error is shown below.</div>
</div>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">ItemMaster</span><span class="w"> </span><span class="n">itemMaster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">itemMasterRepository</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">itemCode</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="n">itemMaster</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SystemException</span><span class="p">(</span><span class="s">&quot;e.xx.fw.0001&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;Item master data is not found. item code is &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">itemCode</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>System exception is thrown since master data that should already exist does not exist. Example of case when system error is detected in logic）</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>Example that throws system exception while catching IO exception while copying the file is shown below.</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">FileUtils</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span><span class="n">srcFile</span><span class="p">,</span><span class="w"> </span><span class="n">destFile</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SystemException</span><span class="p">(</span><span class="s">&quot;e.xx.fw.0002&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;Failed file copy. src file &#39;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">srcFile</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39; dest file &#39;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">destFile</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">System exception that is classified into invalid system state is thrown by the library method.</div>
<div class="line"><strong>The exception generated by library must be passed to system exception class as cause exception.</strong></div>
<div class="line">If cause exception is lost, error occurrence location and basic error cause cannot be traced from the stack trace.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p></p>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Regarding handling of data access error</strong></p>
<p>When data access error occurs in Repository and O/R Mapper while executing business logic, it is converted to subclass of
<code class="docutils literal notranslate"><span class="pre">org.springframework.dao.DataAccessException</span></code> and thrown.
Error can be handled in application layer instead of catching in business logic.
However, some errors like unique constraints violation error should be handled in business logic as per business requirements.
Refer to <a class="reference internal" href="../ArchitectureInDetail/DataAccessCommon.html"><span class="doc">Database Access (Common)</span></a> for details.</p>
</div>
</div></blockquote>
</section>
</section>
</section>
<section id="regarding-transaction-management">
<span id="service-transaction-management"></span><h2><a class="toc-backref" href="#id44" role="doc-backlink"><span class="section-number">4.2.6. </span>Regarding transaction management</a><a class="headerlink" href="#regarding-transaction-management" title="Permalink to this heading">¶</a></h2>
<p>Transaction management is required in the logic where data consistency must be ensured.</p>
<section id="method-of-transaction-management">
<h3><a class="toc-backref" href="#id45" role="doc-backlink"><span class="section-number">4.2.6.1. </span>Method of transaction management</a><a class="headerlink" href="#method-of-transaction-management" title="Permalink to this heading">¶</a></h3>
<p>There are various transaction management methods. However, in this guideline, <strong>it is recommended to use “Declarative Transaction Management” provided by Spring Framework.</strong></p>
<section id="declarative-transaction-management">
<h4><a class="toc-backref" href="#id46" role="doc-backlink"><span class="section-number">4.2.6.1.1. </span>Declarative transaction management</a><a class="headerlink" href="#declarative-transaction-management" title="Permalink to this heading">¶</a></h4>
<p>In “Declarative transaction management”, the information required for transaction management can be declared by the following 2 methods.</p>
<ul class="simple">
<li><p>Declaration in XML(bean definition file).</p></li>
<li><p><strong>Declaration using annotation (&#64;Transactional) (Recommended).</strong></p></li>
</ul>
<p>Refer to <a class="reference external" href="http://docs.spring.io/spring/docs/4.1.9.RELEASE/spring-framework-reference/html/transaction.html#transaction-declarative">Spring Reference Document -Transaction Management(Declarative transaction management)-</a> for
the details on “Declarative type transaction management” provided by Spring Framework.
</p>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Reason for recommending annotation method</strong></p>
<ol class="arabic simple">
<li><p>The transaction management to be performed can be understood by just looking at the source code.</p></li>
<li><p>AOP settings for transaction management is not required if annotations are used and so XML becomes simple.</p></li>
</ol>
</div>
</div></blockquote>
</section>
<section id="information-required-for-declarative-transaction-management">
<span id="transaction-management-declare-transaction-info-label"></span><h4><a class="toc-backref" href="#id47" role="doc-backlink"><span class="section-number">4.2.6.1.2. </span>Information required for “Declarative transaction management”</a><a class="headerlink" href="#information-required-for-declarative-transaction-management" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">Specify <code class="docutils literal notranslate"><span class="pre">&#64;Transactional</span></code> annotation for at class level or method level which are considered as target of transaction management and specify the information required for</div>
<div class="line">transaction control in attributes of <code class="docutils literal notranslate"><span class="pre">&#64;Transactional</span></code> annotation.</div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>In this guideline, it is a prerequisite to use <code class="docutils literal notranslate"><span class="pre">&#64;org.springframework.transaction.annotation.Transactional</span></code>  annotation provided by Spring Framework.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>From Spring 4, it is possible to use <code class="docutils literal notranslate"><span class="pre">&#64;javax.transaction.Transactional</span></code>  annotation added from JTA 1.2.</p>
<p>However, in this guideline, it is recommended to use an annotation of Spring Framework that can specify the information required for “Declarative transaction management” in a much more detailed way.</p>
<p>Following attributes can be specified if Spring Framework annotation is used.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">NESTED</span></code>(JDBC savepoint) as an attribute value of the propagation method of transaction (<code class="docutils literal notranslate"><span class="pre">propagation</span></code> attribute).</p></li>
<li><p>Isolation level of transaction (<code class="docutils literal notranslate"><span class="pre">isolation</span></code> attribute)</p></li>
<li><p>Timeout period of transaction (<code class="docutils literal notranslate"><span class="pre">timeout</span></code> attribute)</p></li>
<li><p>Read-only flag of transaction (<code class="docutils literal notranslate"><span class="pre">readOnly</span></code> attribute)</p></li>
</ul>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 80%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Attribute name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>propagation</p></td>
<td><div class="line-block">
<div class="line">Specify transaction propagation method.</div>
<div class="line"><br /></div>
<div class="line"><strong>[REQUIRED]</strong></div>
<div class="line">Starts transaction if not started. (default when omitted)</div>
<div class="line"><strong>[REQUIRES_NEW]</strong></div>
<div class="line">Always starts a new transaction.</div>
<div class="line"><strong>[SUPPORTS]</strong></div>
<div class="line">Uses transaction if started. Does not use if not started.</div>
<div class="line"><strong>[NOT_SUPPORTED]</strong></div>
<div class="line">Does not use transaction.</div>
<div class="line"><strong>[MANDATORY]</strong></div>
<div class="line">Transaction should start. An exception occurs if not started.</div>
<div class="line"><strong>[NEVER]</strong></div>
<div class="line">Does not use transaction (never start). An exception occurs if started.</div>
<div class="line"><strong>[NESTED]</strong></div>
<div class="line">save points are set. They are valid only in JDBC.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>isolation</p></td>
<td><div class="line-block">
<div class="line">Specify isolation level of transaction.</div>
<div class="line">Since this setting depends on DB specifications, settings should be decided by checking DB specifications.</div>
<div class="line"><br /></div>
<div class="line"><strong>[DEFAULT]</strong></div>
<div class="line">Isolation level provided by DB by default.(default when omitted)</div>
<div class="line"><strong>[READ_UNCOMMITTED]</strong></div>
<div class="line">Reads (uncommitted) data modified in other transactions.</div>
<div class="line"><strong>[READ_COMMITTED]</strong></div>
<div class="line">Does not read (uncommitted) data modified in other transactions.</div>
<div class="line"><strong>[REPEATABLE_READ]</strong></div>
<div class="line">Data read by other transactions cannot be updated.</div>
<div class="line"><strong>[SERIALIZABLE]</strong></div>
<div class="line">Isolates transactions completely.</div>
<div class="line"><br /></div>
<div class="line">Isolation level of transaction is considered as the parameter related to exclusion control.</div>
<div class="line">Refer to <a class="reference internal" href="../ArchitectureInDetail/ExclusionControl.html"><span class="doc">Exclusive Control</span></a> for exclusion control.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>timeout</p></td>
<td><div class="line-block">
<div class="line">Specify timeout of transaction (seconds).</div>
<div class="line">-1 by default (Depends on specifications and settings of DB to be used)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>readOnly</p></td>
<td><div class="line-block">
<div class="line">Specify Read-only flag of transaction.</div>
<div class="line">false by default (Not read-only)</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p>rollbackFor</p></td>
<td><div class="line-block">
<div class="line">Specify list of exception classes to rollback transactions.</div>
<div class="line">Blank by default (Not specified)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>6</p></td>
<td><p>rollbackForClassName</p></td>
<td><div class="line-block">
<div class="line">Specify list of exception class names to rollback transactions.</div>
<div class="line">Blank by default (Not specified)</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>7</p></td>
<td><p>noRollbackFor</p></td>
<td><div class="line-block">
<div class="line">Specify list of exception classes to commit transactions.</div>
<div class="line">Blank by default (Not specified)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>8</p></td>
<td><p>noRollbackForClassName</p></td>
<td><div class="line-block">
<div class="line">Specify list of exception classes to commit transactions.</div>
<div class="line">Blank by default (Not specified)</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p></p>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Location to specify the &#64;Transactional annotation</strong></p>
<p><strong>It is recommended to specify the annotation at the class level or method level of the class.</strong>
Must be noted that it should not interface or method of interface.
For the reason, refer to 2nd Tips of <a class="reference external" href="http://docs.spring.io/spring/docs/4.1.9.RELEASE/spring-framework-reference/html/transaction.html#transaction-declarative-annotations">Spring Reference Document -Transaction Management(Using &#64;Transactional)-</a>.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>Default operations of rollback and commit when exception occurs</strong></p>
<p>When rollbackFor and noRollbackFor is not specified, Spring Framework performs the following operations.</p>
<ul class="simple">
<li><p>Rollback when unchecked exception of (java.lang.RuntimeException and java.lang.Error) class or its subclass occurs.</p></li>
<li><p>Commit when checked exception of (java.lang.Exception) class or its subclass occurs. <strong>(Necessary to note)</strong></p></li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Regarding value attributes of &#64;Transactional annotation</strong></p>
<p>There is a value attribute in <code class="docutils literal notranslate"><span class="pre">&#64;Transactional</span></code> annotation. However, this attribute specifies which Transaction Manager to be used when multiple Transaction Managers are declared.
It is not required to specify when there is only one Transaction Manager.
When multiple Transaction Managers need to be used, refer to <a class="reference external" href="http://docs.spring.io/spring/docs/4.1.9.RELEASE/spring-framework-reference/html/transaction.html#tx-multiple-tx-mgrs-with-attransactional">Spring Reference Document -Transaction Management(Multiple Transaction Managers with &#64;Transactional)-</a>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Default isolation levels of main DB are given below.</strong></p>
<p>Default isolation levels of main DB are given below.</p>
<ul class="simple">
<li><p>Oracle : READ_COMMITTED</p></li>
<li><p>DB2 : READ_COMMITTED</p></li>
<li><p>PostgreSQL : READ_COMMITTED</p></li>
<li><p>SQL Server : READ_COMMITTED</p></li>
<li><p>MySQL : REPEATABLE_READ</p></li>
</ul>
</div>
</div></blockquote>
<blockquote id="domainlayertransactionmanagementwarningdisablecase">
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Cases where “Read-only transactions” are not enabled</strong></p>
<p>A mechanism is provided to run SQL under “Read-only transactions” by specifying <code class="docutils literal notranslate"><span class="pre">readOnly</span> <span class="pre">=</span> <span class="pre">true</span></code>; however,
when all of the following conditions are satisfied, there will be a JDBC driver where “Read-only transactions” are not enabled.</p>
<p><strong>[Conditions to generate this event]</strong></p>
<ul class="simple">
<li><p>Perform health check when retrieving a connection from connection pool.</p></li>
<li><p>Disable ‘Auto commit’ of connection retrieved from connection pool.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">DataSourceTransactionManager</span></code> or <code class="docutils literal notranslate"><span class="pre">JpaTransactionManager</span></code> as <code class="docutils literal notranslate"><span class="pre">PlatformTransactionManager</span></code>. (This event does not occur when using <code class="docutils literal notranslate"><span class="pre">JtaTransactionManager</span></code>).</p></li>
</ul>
<p><strong>[JDBC driver where occurrence of this event is confirmed]</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">org.postgresql:postgresql:9.3-1102-jdbc41</span></code> (JDBC 4.1 compatible JDBC driver for PostgreSQL 9.3)</p></li>
</ul>
<p><strong>[Method to avoid this event]</strong></p>
<p>In a case where “Read-only transactions” are not enabled,
if <code class="docutils literal notranslate"><span class="pre">readOnly</span> <span class="pre">=</span> <span class="pre">true</span></code> is specified, it ends up carrying out the unnecessary processes.
Therefore, it is recommended to execute the SQL under “Updatable transactions” even for the reference processes.</p>
<p>Other methods to avoid this event are as follows:</p>
<ul class="simple">
<li><p>Do not perform health check when retrieving a connection from connection pool.</p></li>
<li><p>Enable ‘Auto commit’ of the connection retrieved from connection pool. (Disable ‘Auto commit’ only when transaction management is required)</p></li>
</ul>
<p>However, However, do not change the design for ‘health check’ and ‘auto commit’ to avoid this event.</p>
<p><strong>[Remarks]</strong></p>
<ul class="simple">
<li><p>Reproduction of this event is confirmed on PostgreSQL 9.3 and Oracle 12c. It is not performed on any other database and versions.</p></li>
<li><p>In PostgreSQL 9.3, <code class="docutils literal notranslate"><span class="pre">SQLException</span></code> occurs when <code class="docutils literal notranslate"><span class="pre">java.sql.Connection#setReadOnly(boolean)</span></code> method is called.</p></li>
<li><p>When SQL or API call of JDBC is logged in using <a class="reference internal" href="../ArchitectureInDetail/DataAccessCommon.html#dataaccesscommondatasourcedebug"><span class="std std-ref">log4jdbc</span></a>, <code class="docutils literal notranslate"><span class="pre">SQLException</span></code> occurred from JDBC driver is output to log with ERROR level.</p></li>
<li><p><strong>SQL Exception occurred from JDBC driver is ignored by exception handling of Spring Framework. Hence, even though it is not an error as application behavior, the “Read-only transactions” is not enabled.</strong></p></li>
<li><p>Occurrence of this event is not confirmed in Oracle 12c.</p></li>
</ul>
<p><strong>[Reference]</strong></p>
<p>When following log is output using <a class="reference internal" href="../ArchitectureInDetail/DataAccessCommon.html#dataaccesscommondatasourcedebug"><span class="std std-ref">log4jdbc</span></a>, it will be treated as a case corresponding to this event.</p>
<blockquote>
<div><div class="highlight-text notranslate"><div class="highlight"><pre><span></span>date:2015-02-20 16:11:56        thread:main     user:   X-Track:        level:ERROR     logger:jdbc.audit                                       message:3. Connection.setReadOnly(true)
org.postgresql.util.PSQLException: Cannot change transaction read-only property in the middle of a transaction.
    at org.postgresql.jdbc2.AbstractJdbc2Connection.setReadOnly(AbstractJdbc2Connection.java:741) ~[postgresql-9.3-1102-jdbc41.jar:na]
    ...
</pre></div>
</div>
</div></blockquote>
</div>
</div></blockquote>
</section>
<section id="propagation-of-transaction">
<h4><a class="toc-backref" href="#id48" role="doc-backlink"><span class="section-number">4.2.6.1.3. </span>Propagation of transaction</a><a class="headerlink" href="#propagation-of-transaction" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">In most of the cases, Propagation method of transaction is “REQUIRED”.</div>
<div class="line">However, since  <strong>“REQUIRES_NEW” is also used according to the requirements of Application</strong>, transaction control flow in case of “REQUIRED” and “REQUIRES_NEW” is explained below.</div>
<div class="line">The explanation of other propagation methods is omitted in this guideline since their usage frequency is very low.</div>
</div>
<div class="line-block">
<div class="line"><strong>Transaction control flow when propagation method of transaction is set to “REQUIRED”</strong></div>
<div class="line">When propagation method of transaction is set to “REQUIRED”, all sequential processes called from controller are processed in the same transaction.</div>
</div>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../_images/service_transaction-propagation-required.png"><img alt="transaction management flow of REQUIRED" src="../_images/service_transaction-propagation-required.png" style="width: 100%;" /></a>
</figure>
</div></blockquote>
<ol class="arabic simple">
<li><p>Controller calls a method of Service class.
At this time, since started transaction does not exist, transaction is started using <code class="docutils literal notranslate"><span class="pre">TransactionInterceptor</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TransactionInterceptor</span></code> calls the method of service class after starting the transaction.</p></li>
<li><p>Service class calls a method of <code class="docutils literal notranslate"><span class="pre">SharedService</span></code>. This method is also under transaction control.
At this time, though started transaction exists, <code class="docutils literal notranslate"><span class="pre">TransactionInterceptor</span></code> participates in the started transaction without starting a new transaction.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TransactionInterceptor</span></code> calls the method under transaction control after participating in the started transaction.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TransactionInterceptor</span></code> performs commit or rollback according to result of processing and ends the transaction.</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Reason for occurrence of org.springframework.transaction.UnexpectedRollbackException</strong></p>
<p>When propagation method of transaction is set to “REQUIRED”, though there is only one physical transaction, internally Spring Framework creates transaction boundaries.
In case of above example, when a method of SharedService is called, a TransactionInterceptor is started which internally provides transaction control boundary at SharedService level.
Therefore, when an exception (which is set as target of rollback) occurs in <code class="docutils literal notranslate"><span class="pre">SharedService</span></code> method, status of transaction is set to rollback (rollback-only) by <code class="docutils literal notranslate"><span class="pre">TransactionInterceptor</span></code>.
This transaction now cannot be committed.
Going further, if the Service method tries to commit this transaction due to conflicting settings of rollback target exception between Service method and SharedShared method,
<code class="docutils literal notranslate"><span class="pre">UnexpectedRollbackException</span></code> is generated by Spring Framework notifying that there is inconsistency in transaction control settings. When UnexpectedRollbackException is generated, it should be checked that there is no inconsistency in rollbackFor and noRollbackFor settings.</p>
</div>
<div class="line-block">
<div class="line"><strong>Transaction management flow when propagation method of transaction is set to “REQUIRES_NEW”</strong></div>
<div class="line">When propagation method of transaction is set to “REQUIRES_NEW”, a part of the sequence of processing (Processing done in SharedService) are processed in another transaction when called from Controller.</div>
</div>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../_images/service_transaction-propagation-requires_new.png"><img alt="transaction management flow of REQUIRES_NEW" src="../_images/service_transaction-propagation-requires_new.png" style="width: 100%;" /></a>
</figure>
</div></blockquote>
<ol class="arabic simple">
<li><p>Controller calls a method of Service class. This method is under transaction control. At this time, since started transaction does not exist, transaction is started by <code class="docutils literal notranslate"><span class="pre">TransactionInterceptor</span></code> (Hereafter, the started transaction is referred as “Transaction A”).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TransactionInterceptor</span></code> calls the method of service class after transaction (Transaction A) is started.</p></li>
<li><p>Service class calls a method of <code class="docutils literal notranslate"><span class="pre">SharedService</span></code> class. At this time, though started transaction (Transaction A) exists, since propagation method of transaction is “REQUIRES_NEW”, new transaction is started by <code class="docutils literal notranslate"><span class="pre">TransactionInterceptor</span></code>. (Hereafter, started transaction is referred as “Transaction B”). At this time, “Transaction A” is interrupted and the status changes to ‘Awaiting to resume’.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TransactionInterceptor</span></code> calls the method of SharedService class after Transaction B is started.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TransactionInterceptor</span></code> performs commit or rollback according to the process result and ends the Transaction B.
At this time, “Transaction A” is resumed and status is changed to Active.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TransactionInterceptor</span></code> performs commit or rollback according to the process result and ends the Transaction A.</p></li>
</ol>
</section>
<section id="way-of-calling-the-method-which-is-under-transaction-control">
<h4><a class="toc-backref" href="#id49" role="doc-backlink"><span class="section-number">4.2.6.1.4. </span>Way of calling the method which is under transaction control</a><a class="headerlink" href="#way-of-calling-the-method-which-is-under-transaction-control" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">Since “Declarative transaction management” provided by Spring Framework is implemented using AOP, transaction management is applied only for method calls for which AOP is enabled.</div>
<div class="line">Since the default mode of AOP is <strong>“proxy” mode, transaction control will be applied only when public method is called from another class.</strong></div>
<div class="line">Note that <strong>transaction control is not applied if the target method is called from an internal method even if the target method is a public method</strong>.</div>
</div>
<ul class="simple">
<li><p><strong>Way of calling the method which is under transaction control</strong></p></li>
</ul>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../_images/service_transaction-valid-call.png"><img alt="enabled method calls of transaction management" src="../_images/service_transaction-valid-call.png" style="width: 100%;" /></a>
</figure>
</div></blockquote>
<ul class="simple">
<li><p><strong>Way of calling the method which is not under transaction control</strong></p></li>
</ul>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../_images/service_transaction-invalid-call.png"><img alt="not enabled method calls of transaction management" src="../_images/service_transaction-invalid-call.png" style="width: 100%;" /></a>
</figure>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>In order to bring internal method calls under transaction control</strong></p>
<p>It is possible to enable transaction control for internal method calls as well by setting the AOP mode to <code class="docutils literal notranslate"><span class="pre">&quot;aspectj&quot;</span></code>.
However, if internal method call of transaction management is enabled, the route of transaction management may become complicated;
hence it is recommended to use the default “proxy” for AOP mode.</p>
</div>
</div></blockquote>
</section>
</section>
<section id="settings-for-using-transaction-management">
<span id="service-enable-transaction-management"></span><h3><a class="toc-backref" href="#id50" role="doc-backlink"><span class="section-number">4.2.6.2. </span>Settings for using transaction management</a><a class="headerlink" href="#settings-for-using-transaction-management" title="Permalink to this heading">¶</a></h3>
<p>The settings required for using transaction management are explained.</p>
<section id="platformtransactionmanager-settings">
<h4><a class="toc-backref" href="#id51" role="doc-backlink"><span class="section-number">4.2.6.2.1. </span>PlatformTransactionManager settings</a><a class="headerlink" href="#platformtransactionmanager-settings" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">In order to have transaction management done, it is necessary to define the bean of <code class="docutils literal notranslate"><span class="pre">PlatformTransactionManager</span></code>.</div>
<div class="line">Spring Framework has provided  couple of classes based on the purpose; any class can be specified that meets the requirement of the application.</div>
</div>
<ul class="simple">
<li><p><code class="file docutils literal notranslate"><span class="pre">xxx-env.xml</span></code></p></li>
</ul>
<blockquote>
<div><p>Example of settings for managing the transaction using JDBC connection which is fetched from DataSource is given below.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;transactionManager&quot;</span>
<span class="w">      </span><span class="na">class=</span><span class="s">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;dataSource&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Specify the implementation class of PlatformTransactionManager.</div>
<div class="line">It is recommended to set id as “transactionManager”.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p></p>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>When transaction management (Global transaction management) is required for multiple DBs (Multiple resources)</strong></p>
<ul class="simple">
<li><p>It is necessary to use <code class="docutils literal notranslate"><span class="pre">org.springframework.transaction.jta.JtaTransactionManager</span></code> and manage transactions by using JTA functionality provided by application server.</p></li>
<li><p>When JTA is to be used in WebSphere and Oracle WebLogic Server, a <code class="docutils literal notranslate"><span class="pre">JtaTransactionManager</span></code> which is extended for the application server is automatically set
by specifying &lt;tx:jta-transaction-manager/&gt;.</p></li>
</ul>
</div>
<table class="docutils align-default" id="id2">
<caption><span class="caption-text"><strong>Implementation class of PlatformTransactionManager provided by Spring Framework</strong></span><a class="headerlink" href="#id2" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 10%" />
<col style="width: 35%" />
<col style="width: 55%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Class name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li></li>
</ol>
</td>
<td><div class="line-block">
<div class="line">org.springframework.jdbc.datasource.</div>
<div class="line">DataSourceTransactionManager</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Implementation class for managing the transaction by calling API of JDBC(<code class="docutils literal notranslate"><span class="pre">java.sql.Connection</span></code>).</div>
<div class="line">Use this class when MyBatis and <code class="docutils literal notranslate"><span class="pre">JdbcTemplate</span></code> is to be used.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="2">
<li></li>
</ol>
</td>
<td><div class="line-block">
<div class="line">org.springframework.orm.jpa.</div>
<div class="line">JpaTransactionManager</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Implementation class for managing the transaction by calling API of JPA(<code class="docutils literal notranslate"><span class="pre">javax.persistence.EntityTransaction</span></code>).</div>
<div class="line">Use this class when JPA is to be used.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="3">
<li></li>
</ol>
</td>
<td><div class="line-block">
<div class="line">org.springframework.transaction.jta.</div>
<div class="line">JtaTransactionManager</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Implementation class for managing the transaction by calling API of JTA(<code class="docutils literal notranslate"><span class="pre">javax.transaction.UserTransaction</span></code>).</div>
<div class="line">Use this class to manage transaction with resources (Database/Messaging service/General-purpose EIS(Enterprise Information System) etc.) using JTS (Java Transaction Service) provided by application server.</div>
<div class="line">When it is necessary to execute the operations with multiple resources in a single transaction, it is necessary to  use JTA for managing transactions.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="settings-for-enabling-transactional">
<h4><a class="toc-backref" href="#id52" role="doc-backlink"><span class="section-number">4.2.6.2.2. </span>Settings for enabling &#64;Transactional</a><a class="headerlink" href="#settings-for-enabling-transactional" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">In this guideline, it is recommended to manage transaction by using “Declarative transaction management” where <code class="docutils literal notranslate"><span class="pre">&#64;Transactional</span></code> annotation is used.</div>
<div class="line">Here, the settings required for using <code class="docutils literal notranslate"><span class="pre">&#64;Transactional</span></code> annotation are explained.</div>
</div>
<ul class="simple">
<li><p><code class="file docutils literal notranslate"><span class="pre">xxx-domain.xml</span></code></p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;tx:annotation-driven</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>With use of &lt;tx:annotation-driven&gt; element in XML (bean definition file), transaction control gets enabled at the locations where <code class="docutils literal notranslate"><span class="pre">&#64;Transactional</span></code> annotation is used.</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="regarding-attributes-of-tx-annotation-driven-element">
<h4><a class="toc-backref" href="#id53" role="doc-backlink"><span class="section-number">4.2.6.2.3. </span>Regarding attributes of &lt;tx:annotation-driven&gt; element</a><a class="headerlink" href="#regarding-attributes-of-tx-annotation-driven-element" title="Permalink to this heading">¶</a></h4>
<p>Various attributes can be specified in &lt;tx:annotation-driven&gt; and default behavior can be customized.</p>
<ul class="simple">
<li><p><code class="file docutils literal notranslate"><span class="pre">xxx-domain.xml</span></code></p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;tx:annotation-driven</span>
<span class="w">     </span><span class="na">transaction-manager=</span><span class="s">&quot;txManager&quot;</span>
<span class="w">     </span><span class="na">mode=</span><span class="s">&quot;aspectj&quot;</span>
<span class="w">     </span><span class="na">proxy-target-class=</span><span class="s">&quot;true&quot;</span>
<span class="w">     </span><span class="na">order=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 15%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Attribute</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>transaction-manager</p></td>
<td><p>Specify <code class="docutils literal notranslate"><span class="pre">PlatformTransactionManager</span></code> bean. When omitted, bean registered with the name “transactionManager” is used.</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>mode</p></td>
<td><p>Specify AOP mode. When omitted, <code class="docutils literal notranslate"><span class="pre">&quot;proxy&quot;</span></code> is the default value. <code class="docutils literal notranslate"><span class="pre">&quot;aspectj&quot;</span></code> can be also be specified. It is recommended to use <code class="docutils literal notranslate"><span class="pre">&quot;proxy&quot;</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>proxy-target-class</p></td>
<td><p>Flag to specify whether proxy target is limited to class (this is valid only in case of mode=”proxy”). When omitted, it will be “false”.</p>
<ul class="simple">
<li><p>In case of false, if the target class has an interface, proxy is done using dynamic proxies functionality of standard JDK.
When there is no interface, proxy is done using GCLIB functionality.</p></li>
<li><p>In case of true, proxy is done using GCLIB function irrespective of whether interface is available or not.</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>order</p></td>
<td><p>Order of Advice of AOP (Priority). When omitted, it will be “Last (Lowest priority)”.</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
</section>
<section id="appendix">
<h2><a class="toc-backref" href="#id54" role="doc-backlink"><span class="section-number">4.2.7. </span>Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this heading">¶</a></h2>
<section id="regarding-drawbacks-of-transaction-management">
<span id="domainlayerappendixtransactionmanagement"></span><h3><a class="toc-backref" href="#id55" role="doc-backlink"><span class="section-number">4.2.7.1. </span>Regarding drawbacks of transaction management</a><a class="headerlink" href="#regarding-drawbacks-of-transaction-management" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">There is a description regarding “Understanding drawbacks of transaction” in IBM DeveloperWorks.</div>
<div class="line">Read this article about pitfalls of transaction management and pitfalls while using &#64;Transactional of Spring Framework.
Refer to <a class="reference external" href="http://www.ibm.com/developerworks/java/library/j-ts1/index.html">Article on IBM DeveloperWorks</a>for details.</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Since the article of IBM DeveloperWorks is an old article (year 2009), some of the content is different than the behavior when using Spring Framework 4.1.</p>
<p>Specifically, the contents of “Listing 7. Using read-only with REQUIRED propagation mode - JPA”.</p>
<p>From Spring Framework 4.1, when Hibernate ORM 4.2 or higher version is used as JPA provider,
it has been improved so that instruction can be given to run the SQL under “Read-only transactions” for JDBC driver (<a class="reference external" href="https://jira.spring.io/browse/SPR-8959">SPR-8959</a>).</p>
<p>The way of handling read-only transactions depends on the implementation of JDBC driver; hence, confirm the specifications of JDBC driver to be used.</p>
</div>
</section>
<section id="programmatic-transaction-management">
<h3><a class="toc-backref" href="#id56" role="doc-backlink"><span class="section-number">4.2.7.2. </span>Programmatic transaction management</a><a class="headerlink" href="#programmatic-transaction-management" title="Permalink to this heading">¶</a></h3>
<p>In this guideline, “Declarative transaction management” is recommended. However, programmatic transaction management is also possible.
Refer to <a class="reference external" href="http://docs.spring.io/spring/docs/4.1.9.RELEASE/spring-framework-reference/html/transaction.html#transaction-programmatic">Spring Reference Document -Transaction Management(Programmatic transaction management)-</a> for details.</p>
</section>
<section id="sample-of-implementation-of-interface-and-base-classes-to-limit-signature">
<span id="domainlayer-appendix-blogic"></span><h3><a class="toc-backref" href="#id57" role="doc-backlink"><span class="section-number">4.2.7.3. </span>Sample of implementation of interface and base classes to limit signature</a><a class="headerlink" href="#sample-of-implementation-of-interface-and-base-classes-to-limit-signature" title="Permalink to this heading">¶</a></h3>
<ul class="simple">
<li><p>Interface to limit signature</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">BLogic</span><span class="o">&lt;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">O</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="n">I</span><span class="w"> </span><span class="n">input</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Interface to limit signature of implementation method of business logic.</div>
<div class="line">In the above example, it is defined as generic type of input (I) and output (O) information having one method (execute) for executing business logic.</div>
<div class="line">In this guideline, the above interface is called BLogic interface.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><p>Controller</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// (2)</span>
<span class="nd">@Inject</span>
<span class="n">XxxBLogic</span><span class="o">&lt;</span><span class="n">XxxInput</span><span class="p">,</span><span class="w"> </span><span class="n">XxxOutput</span><span class="o">&gt;</span><span class="w"> </span><span class="n">xxxBLogic</span><span class="p">;</span>

<span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">reserve</span><span class="p">(</span><span class="n">XxxForm</span><span class="w"> </span><span class="n">form</span><span class="p">,</span><span class="w"> </span><span class="n">RedirectAttributes</span><span class="w"> </span><span class="n">redirectAttributes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">XxxInput</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">XxxInput</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// omitted</span>

<span class="w">    </span><span class="c1">// (3)</span>
<span class="w">    </span><span class="n">XxxOutput</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xxxBlogic</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// omitted</span>

<span class="w">    </span><span class="n">redirectAttributes</span><span class="p">.</span><span class="na">addFlashAttribute</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="na">getTourReservation</span><span class="p">());</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;redirect:/xxx?complete&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Controller injects calling BLogic interface.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Controller calls execute method of BLogic interface and executes business logic.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>To standardize process flow of business logic when a fixed common process is included in Service, base classes are created to limit signature of method.</p>
<ul class="simple">
<li><p>Base classes to limit signature</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AbstractBLogic</span><span class="o">&lt;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">BLogic</span><span class="o">&lt;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">O</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="n">I</span><span class="w"> </span><span class="n">input</span><span class="p">){</span>
<span class="w">      </span><span class="k">try</span><span class="p">{</span>

<span class="w">          </span><span class="c1">// omitted</span>

<span class="w">          </span><span class="c1">// (4)</span>
<span class="w">          </span><span class="n">preExecute</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>

<span class="w">          </span><span class="c1">// (5)</span>
<span class="w">          </span><span class="n">O</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">doExecute</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>

<span class="w">          </span><span class="c1">// omitted</span>

<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">output</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// omitted</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">preExecute</span><span class="p">(</span><span class="n">I</span><span class="w"> </span><span class="n">input</span><span class="p">);</span>

<span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="n">O</span><span class="w"> </span><span class="nf">doExecute</span><span class="p">(</span><span class="n">I</span><span class="w"> </span><span class="n">input</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Call the method to perform pre-processing before executing business logic from base classes.</div>
<div class="line">In the preExecute method, business rules are checked.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Call the method executing business logic from the base classes.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>Sample of extending base classes to limit signature is shown below.</p>
<ul class="simple">
<li><p>BLogic class (Service)</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">XxxBLogic</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractBLogic</span><span class="o">&lt;</span><span class="n">XxxInput</span><span class="p">,</span><span class="w"> </span><span class="n">XxxOutput</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="c1">// (6)</span>
<span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">preExecute</span><span class="p">(</span><span class="n">XxxInput</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="c1">// omitted</span>
<span class="w">        </span><span class="n">Tour</span><span class="w"> </span><span class="n">tour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tourRepository</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="na">getTourId</span><span class="p">());</span>
<span class="w">        </span><span class="n">Date</span><span class="w"> </span><span class="n">reservationLimitDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tour</span><span class="p">.</span><span class="na">reservationLimitDate</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="na">getReservationDate</span><span class="p">().</span><span class="na">after</span><span class="p">(</span><span class="n">reservationLimitDate</span><span class="p">)){</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">ResultMessages</span><span class="p">.</span><span class="na">error</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;e.xx.xx.0001&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// (7)</span>
<span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">XxxOutput</span><span class="w"> </span><span class="nf">doExecute</span><span class="p">(</span><span class="n">XxxInput</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">TourReservation</span><span class="w"> </span><span class="n">tourReservation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TourReservation</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// omitted</span>

<span class="w">        </span><span class="n">tourReservationRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">tourReservation</span><span class="p">);</span>
<span class="w">        </span><span class="n">XxxOutput</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">XxxOutput</span><span class="p">();</span>
<span class="w">        </span><span class="n">output</span><span class="p">.</span><span class="na">setTourReservation</span><span class="p">(</span><span class="n">tourReservation</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// omitted</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">output</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Sr. No.</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Implement pre-process before executing business logic.</div>
<div class="line">Business rules are checked.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Implement business logic.</div>
<div class="line">Logic is implemented to satisfy business rules.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="tips">
<h2><a class="toc-backref" href="#id58" role="doc-backlink"><span class="section-number">4.2.8. </span>Tips</a><a class="headerlink" href="#tips" title="Permalink to this heading">¶</a></h2>
<section id="method-of-dealing-with-violation-of-business-rules-as-field-error">
<span id="tips-business-error-label"></span><h3><a class="toc-backref" href="#id59" role="doc-backlink"><span class="section-number">4.2.8.1. </span>Method of dealing with violation of business rules as field error</a><a class="headerlink" href="#method-of-dealing-with-violation-of-business-rules-as-field-error" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">When it is necessary to output the error of business rules for each field, the mechanism of (Bean Validation or Spring Validator) on the Controller side should be used.</div>
<div class="line">In this case, It is recommended to implement check logic as Service class and then to call the method of Service class from Bean Validation or Spring Validator.</div>
<div class="line">Refer to <a class="reference internal" href="../ArchitectureInDetail/Validation.html"><span class="doc">Input Validation</span></a> business logic approach for details.</div>
</div>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="InfrastructureLayer.html" title="4.3. Implementation of Infrastructure Layer"
             >next</a> |</li>
        <li class="right" >
          <a href="CreateWebApplicationProject.html" title="4.1. Create Web application development project"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.0.2.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" ><span class="section-number">4. </span>Application Development using TERASOLUNA Server Framework for Java (5.x)</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">4.2. </span>Domain Layer Implementation</a></li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013-2016, NTT DATA.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 5.3.0.Theme by <a href="http://github.com/vkvn">vkvn</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>6.3. データベースアクセス（JPA編） &#8212; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.4.2.RELEASE documentation</title>
    <link rel="stylesheet" href="../../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '5.4.2.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="6.4. 排他制御" href="ExclusionControl.html" />
    <link rel="prev" title="6.2. データベースアクセス（MyBatis3編）" href="DataAccessMyBatis3.html" /><script src="../../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../../_static/solarized-dark.css" rel="stylesheet">
<link href="../../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ExclusionControl.html" title="6.4. 排他制御"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="DataAccessMyBatis3.html" title="6.2. データベースアクセス（MyBatis3編）"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.4.2.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">6. データアクセス</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">6.3. データベースアクセス（JPA編）</a><ul>
<li><a class="reference internal" href="#overview">6.3.1. Overview</a><ul>
<li><a class="reference internal" href="#id2">6.3.1.1. JPAについて</a><ul>
<li><a class="reference internal" href="#jpao-r-mapping">6.3.1.1.1. JPAのO/R Mapping</a></li>
<li><a class="reference internal" href="#id3">6.3.1.1.2. JPAの基本用語</a></li>
<li><a class="reference internal" href="#entity">6.3.1.1.3. Entityのライフサイクル管理</a></li>
</ul>
</li>
<li><a class="reference internal" href="#spring-data-jpa">6.3.1.2. Spring Data JPAについて</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">6.3.2. How to use</a><ul>
<li><a class="reference internal" href="#pom-xml">6.3.2.1. pom.xmlの設定</a></li>
<li><a class="reference internal" href="#id4">6.3.2.2. アプリケーションの設定</a><ul>
<li><a class="reference internal" href="#id5">6.3.2.2.1. データソースの設定</a></li>
<li><a class="reference internal" href="#entitymanager">6.3.2.2.2. EntityManagerの設定</a></li>
<li><a class="reference internal" href="#platformtransactionmanager">6.3.2.2.3. PlatformTransactionManagerの設定</a></li>
<li><a class="reference internal" href="#persistence-xml">6.3.2.2.4. persistence.xmlの設定</a></li>
<li><a class="reference internal" href="#id6">6.3.2.2.5. Spring Data JPAを有効化するための設定</a></li>
<li><a class="reference internal" href="#id7">6.3.2.2.6. JPAのアノテーションを使用するための設定</a></li>
<li><a class="reference internal" href="#jpa-dataaccessexception">6.3.2.2.7. JPAの例外を DataAccessExceptionに変換するための設定</a></li>
<li><a class="reference internal" href="#openentitymanagerinviewinterceptor">6.3.2.2.8. OpenEntityManagerInViewInterceptorの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#repository">6.3.2.3. Repositoryインタフェースの作成</a><ul>
<li><a class="reference internal" href="#spring-data">6.3.2.3.1. Spring Data提供のインタフェースを継承する</a></li>
<li><a class="reference internal" href="#how-to-create-repository-extends-myinterface-label">6.3.2.3.2. 必要なメソッドのみ定義したインタフェースを継承する</a></li>
<li><a class="reference internal" href="#how-to-create-repository-notextends-label">6.3.2.3.3. インタフェースの継承は行わない</a></li>
</ul>
</li>
<li><a class="reference internal" href="#query">6.3.2.4. Queryメソッドの追加</a><ul>
<li><a class="reference internal" href="#id10">6.3.2.4.1. Queryメソッドを定義する</a></li>
<li><a class="reference internal" href="#id11">6.3.2.4.2. 実行するQueryを指定する</a></li>
<li><a class="reference internal" href="#id12">6.3.2.4.3. Entityのロックを取得する</a></li>
<li><a class="reference internal" href="#data-access-jpa-howtouse-querymethod-modifying">6.3.2.4.4. 永続層のEntityを直接操作する</a></li>
<li><a class="reference internal" href="#id14">6.3.2.4.5. Queryヒントを設定する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#queryquery">6.3.2.5. QueryメソッドのQuery指定</a><ul>
<li><a class="reference internal" href="#how-to-specify-query-annotation-label">6.3.2.5.1. &#64;Query アノテーションで指定する</a></li>
<li><a class="reference internal" href="#how-to-specify-query-mathodname-label">6.3.2.5.2. 命名規約ベースのメソッド名で指定する</a></li>
<li><a class="reference internal" href="#named-query">6.3.2.5.3. プロパティファイルにNamed queryとして指定する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id17">6.3.2.6. Entityの検索処理の実装</a><ul>
<li><a class="reference internal" href="#id18">6.3.2.6.1. 条件に一致するEntityを全件検索</a></li>
<li><a class="reference internal" href="#dataaccessjpahowtousefindpage">6.3.2.6.2. 条件に一致するEntityのページ検索</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id20">6.3.2.7. Entityの動的条件による検索処理の実装</a><ul>
<li><a class="reference internal" href="#id21">6.3.2.7.1. 動的条件に一致するEntityを全件検索</a></li>
<li><a class="reference internal" href="#id22">6.3.2.7.2. 動的条件に一致するEntityをページ検索</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id23">6.3.2.8. Entityの取得処理の実装</a><ul>
<li><a class="reference internal" href="#identity1">6.3.2.8.1. IDを指定してEntityを1件取得</a></li>
<li><a class="reference internal" href="#id24">6.3.2.8.2. ID以外の条件を指定してEntityを1件取得</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id25">6.3.2.9. Entityの追加処理の実装</a><ul>
<li><a class="reference internal" href="#data-access-jpa-how-to-use-way-to-add-entity">6.3.2.9.1. Entityの追加</a></li>
<li><a class="reference internal" href="#entityentity">6.3.2.9.2. Entityと関連Entityの追加</a></li>
<li><a class="reference internal" href="#id28">6.3.2.9.3. 関連Entityの追加</a></li>
<li><a class="reference internal" href="#id29">6.3.2.9.4. 関連Entityの直接追加</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id30">6.3.2.10. Entityの更新処理の実装</a><ul>
<li><a class="reference internal" href="#id31">6.3.2.10.1. Entityの更新</a></li>
<li><a class="reference internal" href="#id32">6.3.2.10.2. 関連Entityの更新</a></li>
<li><a class="reference internal" href="#id33">6.3.2.10.3. 関連Entityの直接更新</a></li>
<li><a class="reference internal" href="#id34">6.3.2.10.4. Queryメソッドを使用して更新</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id35">6.3.2.11. Entityの削除処理の実装</a><ul>
<li><a class="reference internal" href="#id36">6.3.2.11.1. Entityと関連Entityの削除</a></li>
<li><a class="reference internal" href="#daba-access-jpa-howtouse-remove-relationship">6.3.2.11.2. 関連Entityの削除</a></li>
<li><a class="reference internal" href="#id38">6.3.2.11.3. 関連Entityの直接削除</a></li>
<li><a class="reference internal" href="#id39">6.3.2.11.4. Queryメソッドを使用して削除</a></li>
</ul>
</li>
<li><a class="reference internal" href="#like">6.3.2.12. LIKE検索時のエスケープについて</a><ul>
<li><a class="reference internal" href="#id40">6.3.2.12.1. 一致方法をQuery側で指定する場合の使用方法</a></li>
<li><a class="reference internal" href="#id41">6.3.2.12.2. 一致方法をロジック側で指定する場合の使用方法</a></li>
</ul>
</li>
<li><a class="reference internal" href="#join-fetch">6.3.2.13. JOIN FETCHについて</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend">6.3.3. How to extend</a><ul>
<li><a class="reference internal" href="#data-access-jpa-how-to-extends-custommethod">6.3.3.1. カスタムメソッドの追加方法</a><ul>
<li><a class="reference internal" href="#entityrepository">6.3.3.1.1. Entity毎のRepositoryインタフェースに個別に追加する</a></li>
<li><a class="reference internal" href="#custommethod-all-label">6.3.3.1.2. すべてのRepositoryインタフェースに一括で追加する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#entityquery">6.3.3.2. Entity以外のオブジェクトにQueryの取得結果を格納する方法</a></li>
<li><a class="reference internal" href="#audit">6.3.3.3. Audit用プロパティの設定方法</a></li>
<li><a class="reference internal" href="#entityjpql">6.3.3.4. 永続層からEntityを取得するJPQLに共通条件を加える方法</a><ul>
<li><a class="reference internal" href="#id44">6.3.3.4.1. Entityを取得するJPQLに共通条件を加える</a></li>
<li><a class="reference internal" href="#id45">6.3.3.4.2. 関連Entityを取得するJPQLに共通条件を加える</a></li>
</ul>
</li>
<li><a class="reference internal" href="#persistenceunit">6.3.3.5. 複数のPersistenceUnitを使用する方法</a></li>
<li><a class="reference internal" href="#native">6.3.3.6. Nativeクエリの使用方法</a></li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="DataAccessMyBatis3.html"
                        title="previous chapter">6.2. データベースアクセス（MyBatis3編）</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="ExclusionControl.html"
                        title="next chapter">6.4. 排他制御</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/ArchitectureInDetail/DataAccessDetail/DataAccessJpa.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="jpa">
<h1>6.3. データベースアクセス（JPA編）<a class="headerlink" href="#jpa" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="id1">
<p class="topic-title first">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id57">Overview</a><ul>
<li><a class="reference internal" href="#id2" id="id58">JPAについて</a><ul>
<li><a class="reference internal" href="#jpao-r-mapping" id="id59">JPAのO/R Mapping</a></li>
<li><a class="reference internal" href="#id3" id="id60">JPAの基本用語</a></li>
<li><a class="reference internal" href="#entity" id="id61">Entityのライフサイクル管理</a></li>
</ul>
</li>
<li><a class="reference internal" href="#spring-data-jpa" id="id62">Spring Data JPAについて</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use" id="id63">How to use</a><ul>
<li><a class="reference internal" href="#pom-xml" id="id64">pom.xmlの設定</a></li>
<li><a class="reference internal" href="#id4" id="id65">アプリケーションの設定</a><ul>
<li><a class="reference internal" href="#id5" id="id66">データソースの設定</a></li>
<li><a class="reference internal" href="#entitymanager" id="id67">EntityManagerの設定</a></li>
<li><a class="reference internal" href="#platformtransactionmanager" id="id68">PlatformTransactionManagerの設定</a></li>
<li><a class="reference internal" href="#persistence-xml" id="id69">persistence.xmlの設定</a></li>
<li><a class="reference internal" href="#id6" id="id70">Spring Data JPAを有効化するための設定</a></li>
<li><a class="reference internal" href="#id7" id="id71">JPAのアノテーションを使用するための設定</a></li>
<li><a class="reference internal" href="#jpa-dataaccessexception" id="id72">JPAの例外を DataAccessExceptionに変換するための設定</a></li>
<li><a class="reference internal" href="#openentitymanagerinviewinterceptor" id="id73">OpenEntityManagerInViewInterceptorの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#repository" id="id74">Repositoryインタフェースの作成</a><ul>
<li><a class="reference internal" href="#spring-data" id="id75">Spring Data提供のインタフェースを継承する</a></li>
<li><a class="reference internal" href="#how-to-create-repository-extends-myinterface-label" id="id76">必要なメソッドのみ定義したインタフェースを継承する</a></li>
<li><a class="reference internal" href="#how-to-create-repository-notextends-label" id="id77">インタフェースの継承は行わない</a></li>
</ul>
</li>
<li><a class="reference internal" href="#query" id="id78">Queryメソッドの追加</a><ul>
<li><a class="reference internal" href="#id10" id="id79">Queryメソッドを定義する</a></li>
<li><a class="reference internal" href="#id11" id="id80">実行するQueryを指定する</a></li>
<li><a class="reference internal" href="#id12" id="id81">Entityのロックを取得する</a></li>
<li><a class="reference internal" href="#data-access-jpa-howtouse-querymethod-modifying" id="id82">永続層のEntityを直接操作する</a></li>
<li><a class="reference internal" href="#id14" id="id83">Queryヒントを設定する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#queryquery" id="id84">QueryメソッドのQuery指定</a><ul>
<li><a class="reference internal" href="#how-to-specify-query-annotation-label" id="id85">&#64;Query アノテーションで指定する</a></li>
<li><a class="reference internal" href="#how-to-specify-query-mathodname-label" id="id86">命名規約ベースのメソッド名で指定する</a></li>
<li><a class="reference internal" href="#named-query" id="id87">プロパティファイルにNamed queryとして指定する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id17" id="id88">Entityの検索処理の実装</a><ul>
<li><a class="reference internal" href="#id18" id="id89">条件に一致するEntityを全件検索</a></li>
<li><a class="reference internal" href="#dataaccessjpahowtousefindpage" id="id90">条件に一致するEntityのページ検索</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id20" id="id91">Entityの動的条件による検索処理の実装</a><ul>
<li><a class="reference internal" href="#id21" id="id92">動的条件に一致するEntityを全件検索</a></li>
<li><a class="reference internal" href="#id22" id="id93">動的条件に一致するEntityをページ検索</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id23" id="id94">Entityの取得処理の実装</a><ul>
<li><a class="reference internal" href="#identity1" id="id95">IDを指定してEntityを1件取得</a></li>
<li><a class="reference internal" href="#id24" id="id96">ID以外の条件を指定してEntityを1件取得</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id25" id="id97">Entityの追加処理の実装</a><ul>
<li><a class="reference internal" href="#data-access-jpa-how-to-use-way-to-add-entity" id="id98">Entityの追加</a></li>
<li><a class="reference internal" href="#entityentity" id="id99">Entityと関連Entityの追加</a></li>
<li><a class="reference internal" href="#id28" id="id100">関連Entityの追加</a></li>
<li><a class="reference internal" href="#id29" id="id101">関連Entityの直接追加</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id30" id="id102">Entityの更新処理の実装</a><ul>
<li><a class="reference internal" href="#id31" id="id103">Entityの更新</a></li>
<li><a class="reference internal" href="#id32" id="id104">関連Entityの更新</a></li>
<li><a class="reference internal" href="#id33" id="id105">関連Entityの直接更新</a></li>
<li><a class="reference internal" href="#id34" id="id106">Queryメソッドを使用して更新</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id35" id="id107">Entityの削除処理の実装</a><ul>
<li><a class="reference internal" href="#id36" id="id108">Entityと関連Entityの削除</a></li>
<li><a class="reference internal" href="#daba-access-jpa-howtouse-remove-relationship" id="id109">関連Entityの削除</a></li>
<li><a class="reference internal" href="#id38" id="id110">関連Entityの直接削除</a></li>
<li><a class="reference internal" href="#id39" id="id111">Queryメソッドを使用して削除</a></li>
</ul>
</li>
<li><a class="reference internal" href="#like" id="id112">LIKE検索時のエスケープについて</a><ul>
<li><a class="reference internal" href="#id40" id="id113">一致方法をQuery側で指定する場合の使用方法</a></li>
<li><a class="reference internal" href="#id41" id="id114">一致方法をロジック側で指定する場合の使用方法</a></li>
</ul>
</li>
<li><a class="reference internal" href="#join-fetch" id="id115">JOIN FETCHについて</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend" id="id116">How to extend</a><ul>
<li><a class="reference internal" href="#data-access-jpa-how-to-extends-custommethod" id="id117">カスタムメソッドの追加方法</a><ul>
<li><a class="reference internal" href="#entityrepository" id="id118">Entity毎のRepositoryインタフェースに個別に追加する</a></li>
<li><a class="reference internal" href="#custommethod-all-label" id="id119">すべてのRepositoryインタフェースに一括で追加する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#entityquery" id="id120">Entity以外のオブジェクトにQueryの取得結果を格納する方法</a></li>
<li><a class="reference internal" href="#audit" id="id121">Audit用プロパティの設定方法</a></li>
<li><a class="reference internal" href="#entityjpql" id="id122">永続層からEntityを取得するJPQLに共通条件を加える方法</a><ul>
<li><a class="reference internal" href="#id44" id="id123">Entityを取得するJPQLに共通条件を加える</a></li>
<li><a class="reference internal" href="#id45" id="id124">関連Entityを取得するJPQLに共通条件を加える</a></li>
</ul>
</li>
<li><a class="reference internal" href="#persistenceunit" id="id125">複数のPersistenceUnitを使用する方法</a></li>
<li><a class="reference internal" href="#native" id="id126">Nativeクエリの使用方法</a></li>
</ul>
</li>
</ul>
</div>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p>本章では以下の内容について、現在精査中である。</p>
<ul class="last">
<li><div class="first line-block">
<div class="line"><code class="file docutils literal"><span class="pre">persistence.xml</span></code> の設定項目について。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">QueryDSLを使用した動的Queryの実装方法について。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">関連エンティティのfetch方法を指定する設定値をデフォルト値から変更した方がよいケースの具体例について。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">複数のPersistenceUnitを使用する方法について。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Nativeクエリの使用方法について。</div>
</div>
</li>
</ul>
</div>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id57">6.3.1. Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line">本節では、JPAを使ってデータベースにアクセスする方法について、説明する。</div>
<div class="line">本ガイドラインでは、JPAプロバイダとしてHibernateを、JPAのラッパーとしてSpring Data JPAを使用することを前提としている。</div>
</div>
<blockquote>
<div><div class="figure align-center" id="id46">
<a class="reference internal image-reference" href="../../_images/dataaccess_jpa.png"><img alt="Target of description" src="../../_images/dataaccess_jpa.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Target of description</strong></span></p>
</div>
</div></blockquote>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">本節で説明した内容がEclipseLinkなど、Hibernate以外のJPAプロバイダでも動作することは保証しない。</p>
</div>
<div class="section" id="id2">
<h3><a class="toc-backref" href="#id58">6.3.1.1. JPAについて</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>JPA(Java Persistence API)は、リレーショナルデータベースで管理されているレコードを、Javaオブジェクトにマッピングする方法と、
マッピングされたJavaオブジェクトに対して行われた操作を、リレーショナルデータベースのレコードに反映するための仕組みをJavaのAPI仕様として定義したものである。</p>
<div class="line-block">
<div class="line">JPAは、仕様の定義をしているだけで、実装は提供していない。</div>
<div class="line">JPAの実装は、HibernateのようなO/R Mapperを開発しているベンダーによって、参照実装として提供されている。</div>
<div class="line">このように、O/R Mapperを開発しているベンダーによって実装された参照実装のことを、JPAプロバイダと呼ぶ。</div>
</div>
<div class="section" id="jpao-r-mapping">
<h4><a class="toc-backref" href="#id59">6.3.1.1.1. JPAのO/R Mapping</a><a class="headerlink" href="#jpao-r-mapping" title="Permalink to this headline">¶</a></h4>
<p>JPAを使用した際の、リレーショナルデータベースで管理されているレコードとJavaオブジェクトは、以下のようなイメージでマッピングされる。</p>
<blockquote>
<div><div class="figure align-center" id="id47">
<a class="reference internal image-reference" href="../../_images/dataaccess_jpa_mapping.png"><img alt="Image of O/R Mapping" src="../../_images/dataaccess_jpa_mapping.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Image of O/R Mapping</strong></span></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">JPAでは、「管理状態」と呼ばれる状態のEntityが保持している値を、変更(setterメソッドを呼び出して値を変更)した場合、変更内容が、リレーショナルデータベースに反映される仕組みになっている。</div>
<div class="line">これは、編集機能をもつテーブルビューアなどのクライアントソフトウェアに、よく似ている仕組みである。</div>
<div class="line">テーブルビューアなどのクライアントソフトウェアでは、ビューア上の値を変更すると、データベースに反映されるが、JPAでは、Entityと呼ばれるJavaオブジェクト(JavaBean)の値を変更すると、データベースに反映されることになる。</div>
</div>
</div>
<div class="section" id="id3">
<h4><a class="toc-backref" href="#id60">6.3.1.1.2. JPAの基本用語</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>以下に、JPAを使う上で、最低限知っていてほしい用語について、簡単に説明する。</p>
<blockquote>
<div><table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">用語</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">Entityクラス</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リレーショナルデータベースで管理されているレコードを表現するJavaクラス。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;javax.persistence.Entity</span></code>アノテーションを付与されたクラスが、Entityクラスとなる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">EntityManager</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Entityのライフサイクルを管理するために、必要なAPIを提供するインタフェース。</div>
<div class="line">アプリケーションは、<code class="docutils literal"><span class="pre">javax.persistence.EntityManager</span></code>のメソッドを使用して、リレーショナルデータベースで管理されているレコードを、Javaオブジェクトとして操作する。</div>
<div class="line">Spring Data JPAを使う場合は、直接、使用することはないが、Spring Data JPAの仕組みでは表現できないような、Queryを発行する必要がある場合は、このインタフェースを経由してEntityを取得することになる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">TypedQuery</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Entityを検索するためのAPIを提供するインタフェース。</div>
<div class="line">アプリケーションは、<code class="docutils literal"><span class="pre">javax.persistence.TypedQuery</span></code>のメソッドを使用して、ID以外の条件に一致するEntityを検索する。</div>
<div class="line">Spring Data JPAを使う場合は、直接使用することはないが、Spring Data JPAの仕組みでは、表現できないようなQueryを発行する必要がある場合は、このインタフェースを使用してEntityを検索することになる。</div>
<div class="line">条件に一致する永続層(DB)のEntityを直接操作(更新または削除)するためのメソッドもこのインタフェースに用意されている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">PersistenceContext</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Entityを管理するための領域。</div>
<div class="line"><code class="docutils literal"><span class="pre">EntityManager</span></code> を経由して取得または作成されたEntityは、この領域に格納されてライフサイクル管理される。この領域で管理されているEntityの事を「管理状態のEntity」と呼ぶ。</div>
<div class="line">この領域は、アプリケーションから直接アクセスすることはできない。</div>
<div class="line">Entityの状態は「管理状態」以外に、「作成状態」「削除状態」「分離状態」が存在する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">findメソッド</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">管理状態のEntityを取得するためのメソッド。</div>
<div class="line">IDに対応するEntityがPersistenceContextに存在しない場合は、リレーショナルデータベースに格納されているレコードを取得(SELECT)し、管理状態のEntityを生成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">persistメソッド</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アプリケーションで作成した作成状態のEntityを、管理状態のEntityにするためのメソッド。</div>
<div class="line"><code class="docutils literal"><span class="pre">EntityManager</span></code> のメソッドとして提供されており、リレーショナルデータベースにレコードのINSERTを実行するための操作がPersistenceContextに蓄積される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">mergeメソッド</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">PersistenceContextで管理されていない分離状態のEntityを、管理状態のEntityにするためのメソッド。</div>
<div class="line"><code class="docutils literal"><span class="pre">EntityManager</span></code>のメソッドとして提供されており、基本的にはリレーショナルデータベースに格納されているレコードに対して、UPDATEを実行するための操作がPersistenceContextに蓄積される。</div>
<div class="line">ただし、リレーショナルデータベースにIDに一致するレコードが存在しない場合は、UPDATEではなくINSERTが実行される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="8">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">removeメソッド</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">管理状態のEntityを、削除状態のEntityにするためのメソッド。</div>
<div class="line"><code class="docutils literal"><span class="pre">EntityManager</span></code>のメソッドとして提供されており、リレーショナルデータベースに格納されているレコードに対して、DELETEを実行するための操作がPersistenceContextに蓄積される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="9">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">flushメソッド</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">PersistenceContextで管理されているEntityに対して行われた操作を、リレーショナルデータベースに強制的に反映するためのメソッド。</div>
<div class="line"><code class="docutils literal"><span class="pre">EntityManager</span></code>のメソッドとして提供されており、蓄積された未反映の操作をリレーショナルデータベースに対して実行する。</div>
<div class="line">通常、リレーショナルデータベースへの反映は、トランザクションコミット時に行われるが、コミットより前に反映する必要がある場合は、メソッドを使用する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="entity">
<h4><a class="toc-backref" href="#id61">6.3.1.1.3. Entityのライフサイクル管理</a><a class="headerlink" href="#entity" title="Permalink to this headline">¶</a></h4>
<p>Entityのライフサイクル管理イメージは、以下の通りである。</p>
<blockquote>
<div><div class="figure align-center" id="id48">
<a class="reference internal image-reference" href="../../_images/dataaccess_jpa_lifecycle.png"><img alt="Life cycle of entity" src="../../_images/dataaccess_jpa_lifecycle.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Life cycle of entity</strong></span></p>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">EntityManager</span></code>のpersistメソッドを呼び出すと、引数に渡したEntity(作成状態のEntity)が、管理状態のEntityとして、PersistenceContextに格納される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">EntityManager</span></code>のfindメソッドを呼び出すと、引数に渡したIDをもつ管理状態の、Entityが返却される。</div>
<div class="line">PersistenceContextに存在しない場合は、Queryを発行して、リレーショナルデータベースよりマッピング対象のレコードを取得し、管理状態のEntityとして格納する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">EntityManager</span></code>のmergeメソッドを呼び出すと、引数に渡したEntity(分離状態のEntity)の状態が、管理状態のEntityにマージされる。</div>
<div class="line">PersistenceContextに存在しない場合は、Queryを発行してリレーショナルデータベースよりマッピング対象のレコードを取得し、管理状態のEntityを格納した後に、引数に渡されたEntityの状態がマージされる。</div>
<div class="line">このメソッドを呼び出した場合、persistメソッドとは異なり、引数に渡したEntityが管理状態のEntityとして格納されるわけではないという点に注意すること。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">EntityManager</span></code>のremoveメソッドを呼び出すと、引数に渡した管理状態のEntityが削除状態のEntityとなる。</div>
<div class="line">このメソッドを呼び出した場合、削除状態となったEntityを取得することはできなくなる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">EntityManager</span></code>のflushメソッドを呼び出すと、persist、merge、removeメソッドによって、蓄積されたEntityへの操作が、リレーショナルデータベースに反映される。</div>
<div class="line">このメソッドを呼び出すことで、Entityに対して行った変更内容が、リレーショナルデータベースのレコードに同期される。</div>
<div class="line">ただし、リレーショナルデータベース側のレコードに対してのみ行われた変更は、Entityには同期されない</div>
<div class="line"><br /></div>
<div class="line"><code class="docutils literal"><span class="pre">EntityManager</span></code>のfindメソッドを使わずにQueryを発行してEntityを検索すると、検索処理を行う前に、<code class="docutils literal"><span class="pre">EntityManager</span></code>内部の処理でflushメソッドと同等の処理が実行され、蓄積されていたEntityへの操作がリレーショナルデータベースに反映される仕組みになっている。</div>
<div class="line">Spring Data JPAを使用した際の永続操作の反映タイミングについては、</div>
<div class="line-block">
<div class="line"><a class="reference internal" href="#how-to-create-repository-extends-springdata-flush-timing-note1"><span class="std std-ref">永続操作の反映タイミングについて(その１)</span></a></div>
<div class="line"><a class="reference internal" href="#how-to-create-repository-extends-springdata-flush-timing-note2"><span class="std std-ref">永続操作の反映タイミングについて(その2)</span></a></div>
</div>
<div class="line">を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p></p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>他のライフサイクル管理用のメソッドについて</strong></p>
<p><code class="docutils literal"><span class="pre">EntityManager</span></code>には、Entityのライフサイクルを管理するためのメソッドとして、detachメソッド、refreshメソッド、clearメソッドなどがあるが、
Spring Data JPAを使用する場合、デフォルトの機能で、これらのメソッドを呼び出す仕組みが存在しないため、メソッドの役割のみ説明しておく。</p>
<ul class="simple">
<li>detachメソッドは、管理状態のEntityを分離状態のEntityにするためのメソッド。</li>
<li>refreshメソッドは、管理状態のEntityをリレーショナルデータベースの状態で最新化するためのメソッド。</li>
<li>clearメソッドは、PersistenceContextで、管理されているEntityおよび蓄積された操作をメモリ上から破棄するためのメソッド。</li>
</ul>
<p class="last">clearメソッドについては、Spring Data JPAより提供されている<code class="docutils literal"><span class="pre">&#64;Modifying</span></code>アノテーションのclearAutomatically属性を、<code class="docutils literal"><span class="pre">true</span></code>に設定することで、呼び出すことができる。
詳細については、<a class="reference internal" href="#data-access-jpa-howtouse-querymethod-modifying"><span class="std std-ref">永続層のEntityを直接操作する</span></a>を参照されたい。</p>
</div>
</div></blockquote>
<p></p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>作成状態と分離状態のEntityへの操作について</strong></p>
<p class="last">作成状態のEntityや、分離状態のEntityに行った操作は、persistメソッドまたはmergeメソッドを呼び出さないと、リレーショナルデータベースには反映されない。</p>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="spring-data-jpa">
<h3><a class="toc-backref" href="#id62">6.3.1.2. Spring Data JPAについて</a><a class="headerlink" href="#spring-data-jpa" title="Permalink to this headline">¶</a></h3>
<p>Spring Data JPAは、JPAを使ってRepositoryを作成するための、ライブラリを提供している。</p>
<div class="line-block">
<div class="line">Spring Data JPAを使用すると、Queryメソッドと呼ばれるメソッドを、Repositoryインタフェースに定義するだけで、</div>
<div class="line">指定した条件に一致するEntityを取得することが出来るため、Entityの操作を行うための実装を減らすことができる。</div>
<div class="line">ただし、Queryメソッドで定義できるのはアノテーションで表現できる静的なQueryのみなので、</div>
<div class="line">動的Queryなどのアノテーションで表現できないQueryについては、カスタムRepositoryクラスの実装が必要となる。</div>
</div>
<p>Spring Data JPAを使ってデータベースにアクセスする際の基本フローを以下に示す。</p>
<blockquote>
<div><div class="figure align-center" id="id49">
<a class="reference internal image-reference" href="../../_images/dataaccess_jpa_basic_flow.png"><img alt="Basic flow of Spring Data JPA" src="../../_images/dataaccess_jpa_basic_flow.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Basic flow of Spring Data JPA</strong></span></p>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Serviceから、Repositoryインタフェースのメソッドを呼び出す。</div>
<div class="line">メソッドの呼び出しパラメータとして、Entityオブジェクト、EntityのIDなどが渡される。上記例ではEntityを渡しているが、プリミティブな値となることもある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Repositoryインタフェースを動的に実装したProxyクラスは、<code class="docutils literal"><span class="pre">org.springframework.data.jpa.repository.support.SimpleJpaRepository</span></code>や、 カスタムRepositoryクラスに処理を委譲する。</div>
<div class="line">Serviceから指定されたパラメータが渡される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Repositoryの実装クラスは、JPAのAPIを呼び出す。</div>
<div class="line">Serviceから指定されたパラメータや、Repositoryの実装クラスで生成したパラメータなどが渡される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">HibernateのJPA参照実装は、 HibernateのコアAPIの処理を呼び出す。</div>
<div class="line">Repositoryの実装クラスから指定されたパラメータやHibernateのJPA参照実装のクラスで生成したパラメータなどが渡される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">HibernateのコアAPIは、指定されたパラメータからSQLとバインド値を生成しJDBCドライバに渡す。</div>
<div class="line">(実際の値のバインドは、java.sql.PreparedStatement のAPIが使われている)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JDBCドライバは、渡されたSQLとバインド値をデータベースに送信することで、SQLを実行する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line">Spring Data JPAを使用してRepositoryを作成する場合、JPAのAPIを直接呼び出す必要はないが、Spring Data JPAのRepositoryインタフェースのメソッドが、</div>
<div class="line">JPAのどのメソッドを呼び出しているのかは、意識しておいた方がよい。</div>
<div class="line">以下に、Spring Data JPAの、Repositoryインタフェースの代表的なメソッドが、JPAのどのメソッドを呼び出しているのかを示す。</div>
</div>
<blockquote>
<div><div class="figure align-center" id="id50">
<a class="reference internal image-reference" href="../../_images/dataaccess_jpa_api-mapping.png"><img alt="API Mapping of Spring Data JPA and JPA" src="../../_images/dataaccess_jpa_api-mapping.png" style="width: 90%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - API Mapping of Spring Data JPA and JPA</strong></span></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="how-to-use">
<h2><a class="toc-backref" href="#id63">6.3.2. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<div class="section" id="pom-xml">
<h3><a class="toc-backref" href="#id64">6.3.2.1. pom.xmlの設定</a><a class="headerlink" href="#pom-xml" title="Permalink to this headline">¶</a></h3>
<p>インフラストラクチャ層にJPA(Spring Data JPA)を使用する場合、以下のdependencyを、pom.xmlに追加する。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.terasoluna.gfw<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>terasoluna-gfw-jpa-dependencies<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JPAに関連するライブラリ群が定義してある<code class="docutils literal"><span class="pre">terasoluna-gfw-jpa-dependencies</span></code>を、dependencyに追加する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">上記設定例は、依存ライブラリのバージョンを親プロジェクトである terasoluna-gfw-parent で管理する前提であるため、pom.xmlでのバージョンの指定は不要である。</p>
</div>
</div></blockquote>
</div>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id65">6.3.2.2. アプリケーションの設定</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id5">
<h4><a class="toc-backref" href="#id66">6.3.2.2.1. データソースの設定</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">データベースの接続情報をデータソースに設定する。</div>
<div class="line">データソースの設定については、共通編の<a class="reference internal" href="DataAccessCommon.html#data-access-common-howtouse-datasource"><span class="std std-ref">データソースの設定</span></a>を参照されたい。</div>
</div>
</div>
<div class="section" id="entitymanager">
<h4><a class="toc-backref" href="#id67">6.3.2.2.2. EntityManagerの設定</a><a class="headerlink" href="#entitymanager" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">EntityManager</span></code>を使用するための設定を行う。</p>
<ul class="simple">
<li>xxx-infra.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;jpaVendorAdapter&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;showSql&quot;</span> <span class="na">value=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;database&quot;</span> <span class="na">value=</span><span class="s">&quot;POSTGRESQL&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;entityManagerFactory&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- (5) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;packagesToScan&quot;</span> <span class="na">value=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- (6) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- (7) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;jpaVendorAdapter&quot;</span> <span class="na">ref=</span><span class="s">&quot;jpaVendorAdapter&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- (8) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;jpaPropertyMap&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:map&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.hbm2ddl.auto&quot;</span> <span class="na">value=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.ejb.naming_strategy&quot;</span>
                <span class="na">value=</span><span class="s">&quot;org.hibernate.cfg.ImprovedNamingStrategy&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.connection.charSet&quot;</span> <span class="na">value=</span><span class="s">&quot;UTF-8&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.show_sql&quot;</span> <span class="na">value=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.format_sql&quot;</span> <span class="na">value=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.use_sql_comments&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.jdbc.batch_size&quot;</span> <span class="na">value=</span><span class="s">&quot;30&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.jdbc.fetch_size&quot;</span> <span class="na">value=</span><span class="s">&quot;100&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/util:map&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JPAプロバイダが提供する実装クラスとのアダプタクラスを指定する。</div>
<div class="line">JPAプロバイダとしてHibernateを使用するので、<code class="docutils literal"><span class="pre">org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter</span></code>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>SQLの出力有無を指定する。設定例では、「false:出力しない 」を指定している。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">使用するRDBMSに対応する値を設定する。<code class="docutils literal"><span class="pre">org.springframework.orm.jpa.vendor.Database</span></code>列挙型に定義されている値を、指定することができる。</div>
<div class="line">設定例では「PostgreSQL」を指定している。</div>
<div class="line"><strong>【プロジェクトで使用するデータベースに対応する値に変更が必要】</strong></div>
<div class="line">環境によって使用するデータベースがかわる場合は、プロパティファイルに値を定義すること。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">javax.persistence.EntityManagerFactory</span></code> のインスタンスを作成するFactoryBeanのクラスを指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean</span></code> を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Entityクラスが格納されているパッケージを指定する。</div>
<div class="line">指定したパッケージに格納されているEntityクラスが、<code class="docutils literal"><span class="pre">javax.persistence.EntityManager</span></code>で管理することができるEntityクラスとなる。</div>
<div class="line"><strong>【プロジェクトのパッケージに変更が必要】</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">永続層(DB)にアクセスする際に使用するデータソースを指定する。</div>
<div class="line">設定済みのデータソースのbeanを指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JpaVendorAdapter</span></code> のbeanを指定する。</div>
<div class="line">(1)で設定済みのbeanを指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Hibernateから提供されている <code class="docutils literal"><span class="pre">EntityManager</span></code> の動作設定を指定する。</div>
<div class="line">詳細については「<a class="reference external" href="http://docs.jboss.org/hibernate/orm/5.0/manual/en-US/html/ch03.html#configuration-optional">Hibernate Reference Documentation</a>」を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p></p>
<blockquote>
<div><div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>データベースにOracleを使う際に、テーブル結合を行うSQLにANSI標準のJOINを使用したい場合は、(8)の<code class="docutils literal"><span class="pre">jpaPropertyMap</span></code>に、以下の設定を指定することで実現できる。</p>
<blockquote class="last">
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;entityManagerFactory&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;jpaPropertyMap&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:map&gt;</span>
            <span class="c">&lt;!-- omitted --&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.dialect&quot;</span>
                   <span class="na">value=</span><span class="s">&quot;org.hibernate.dialect.Oracle12cDialect&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (9) --&gt;</span>
        <span class="nt">&lt;/util:map&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">hibernate.dialect</span></code>に<code class="docutils literal"><span class="pre">org.hibernate.dialect.Oracle12cDialect</span></code>を指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">Oracle12cDialect</span></code>を指定することで、テーブル結合を行うSQLにANSI標準のJOIN句が使用される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">アプリケーションサーバから提供されているトランザクションマネージャ(JTA)を使用する場合は、以下の設定を行う。</div>
<div class="line">JTAを使用しない場合との差分について、説明する。</div>
<div class="line">特に説明がない箇所については、JTAを使用しない場合と同じ設定でよい。</div>
</div>
<ul class="simple">
<li>xxx-infra.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;entityManagerFactory&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="c">&lt;!-- (10) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;jtaDataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;jpaPropertyMap&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:map&gt;</span>

            <span class="c">&lt;!-- omitted --&gt;</span>

            <span class="c">&lt;!-- (11)  --&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.transaction.jta.platform&quot;</span>
                <span class="na">value=</span><span class="s">&quot;org.hibernate.service.jta.platform.internal.WeblogicJtaPlatform&quot;</span> <span class="nt">/&gt;</span>

        <span class="nt">&lt;/util:map&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">永続層(DB)にアクセスする際に使用するデータソースを指定する。</div>
<div class="line">JTAを使用する場合は、<code class="docutils literal"><span class="pre">dataSource</span></code>プロパティではなく、<code class="docutils literal"><span class="pre">jtaDataSource</span></code>プロパティに、アプリケーションサーバで定義したDataSourceを指定する。</div>
<div class="line">アプリケーションサーバで定義したDataSourceの取得方法については、共通編の<a class="reference internal" href="DataAccessCommon.html#data-access-common-howtouse-datasource"><span class="std std-ref">データソースの設定</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">jpaPropertyMap</span></code> プロパティに、JTAのプラットフォームの指定を追加する。</div>
<div class="line">上記は、WeblogicのJTAを使用する場合の設定例となる。</div>
<div class="line">設定可能な値(プラットフォーム)は、 <code class="docutils literal"><span class="pre">org.hibernate.service.jta.platform.spi.JtaPlatform</span></code> の実装クラスのFQCNとなる。</div>
<div class="line">主なアプリケーションサーバ向けの実装クラスについては、Hibernateから提供されている。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p></p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>環境によって使用するトランザクションマネージャを切り替える必要がある場合は、 <code class="docutils literal"><span class="pre">entityManagerFactory</span></code> のbean定義は <code class="file docutils literal"><span class="pre">xxx-infra.xml</span></code> ではなく、 <code class="file docutils literal"><span class="pre">xxx-env.xml</span></code> に行うことを推奨する。</p>
<p class="last">トランザクションマネージャを環境によって切り替える必要がある具体例としては、ローカルの開発環境ではTomcatなどJTAの機能を持たないアプリケーションサーバを使用し、
本番および各試験環境では、WeblogicなどのJTAの機能をもつアプリケーションサーバを使用するといったケースがあげられる。</p>
</div>
</div></blockquote>
</div>
<div class="section" id="platformtransactionmanager">
<h4><a class="toc-backref" href="#id68">6.3.2.2.3. PlatformTransactionManagerの設定</a><a class="headerlink" href="#platformtransactionmanager" title="Permalink to this headline">¶</a></h4>
<p>ローカルトランザクションを使用する場合は、以下の設定を行う。</p>
<ul class="simple">
<li>xxx-env.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;transactionManager&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.orm.jpa.JpaTransactionManager&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;entityManagerFactory&quot;</span> <span class="na">ref=</span><span class="s">&quot;entityManagerFactory&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="6%" />
<col width="94%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><code class="docutils literal"><span class="pre">org.springframework.orm.jpa.JpaTransactionManager</span></code> を指定する。 このクラスは、JPAのAPIを呼び出してトランザクション制御を行う。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">トランザクション内で使用する<code class="docutils literal"><span class="pre">EntityManager</span></code>の、Factoryを指定する。</div>
<div class="line">設定済みのEntityManagerFactoryのbeanを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>アプリケーションサーバから提供されているトランザクションマネージャ(JTA)を使用する場合は、以下の設定を行う。</p>
<ul class="simple">
<li>xxx-env.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;tx:jta-transaction-manager</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="6%" />
<col width="94%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>アプリケーションがデプロイされているアプリケーションサーバに最適な<code class="docutils literal"><span class="pre">org.springframework.transaction.jta.JtaTransactionManager</span></code>が、”transactionManager”というidで、bean定義される。
bean定義されたクラスは、JTAのAPIを呼び出して、トランザクション制御を行う。</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="persistence-xml">
<h4><a class="toc-backref" href="#id69">6.3.2.2.4. persistence.xmlの設定</a><a class="headerlink" href="#persistence-xml" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">LocalContainerEntityManagerFactoryBean</span></code> を使用する場合は、 <code class="file docutils literal"><span class="pre">persistence.xml</span></code> に必ず設定しなくてはいけない設定項目はない。</div>
</div>
<p></p>
<blockquote>
<div><div class="admonition-todo admonition" id="index-1">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p>現時点では、<code class="file docutils literal"><span class="pre">persistence.xml</span></code> に必ず設定しなくてはいけない設定項目はないが、今後増える可能性はある。</p>
<p class="last">また、Java EEのアプリケーションサーバー上のEntityManagerFactoryを使用する場合は、
<code class="file docutils literal"><span class="pre">persistence.xml</span></code>に、設定が必要となると思われるので、Java EEのアプリケーションサーバー上のEntityManagerFactoryを使用する場合の設定については、今後整備する予定である。</p>
</div>
</div></blockquote>
</div>
<div class="section" id="id6">
<h4><a class="toc-backref" href="#id70">6.3.2.2.5. Spring Data JPAを有効化するための設定</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>xxx-infra.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:jpa=</span><span class="s">&quot;http://www.springframework.org/schema/data/jpa&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;.....</span>
<span class="s">    http://www.springframework.org/schema/data/jpa</span>
<span class="s">    https://www.springframework.org/schema/data/jpa/spring-jpa.xsd&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

    <span class="c">&lt;!-- ... --&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;jpa:repositories</span> <span class="na">base-package=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.repository&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="6%" />
<col width="94%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring Data JPAのコンフィギュレーション用のスキーマ定義を取り込み、ネームスペースとして(<code class="docutils literal"><span class="pre">jpa</span></code>)を付与する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">RepositoryインタフェースおよびカスタムRepositoryクラスが格納されているベースパッケージを指定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.data.repository.Repository</span></code> を継承しているインタフェースと、<code class="docutils literal"><span class="pre">org.springframework.data.repository.RepositoryDefinition</span></code>アノテーションが付与されているインタフェースが、 Spring Data JPAのRepositoryクラスとして自動的にbean定義される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul>
<li><dl class="first docutils">
<dt>&lt;jpa:repositories&gt;要素の属性について</dt>
<dd><div class="first last line-block">
<div class="line">属性として、entity-manager-factory-ref、transaction-manager-ref、named-queries-location、query-lookup-strategy、factory-class、repository-impl-postfixが存在する。</div>
</div>
</dd>
</dl>
</li>
</ul>
<blockquote>
<div><table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="6%" />
<col width="20%" />
<col width="74%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">要素</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>entity-manager-factory-ref</td>
<td><div class="first last line-block">
<div class="line">Repositoryで使用する <code class="docutils literal"><span class="pre">EntityManager</span></code> を生成するためのFactoryを指定する。</div>
<div class="line">通常指定する必要はないが、 <code class="docutils literal"><span class="pre">EntityManager</span></code> のFactoryを複数用意する場合は、使用するbeanを指定する必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>transaction-manager-ref</td>
<td><div class="first last line-block">
<div class="line">Repositoryのメソッドが呼び出された際に使用する <code class="docutils literal"><span class="pre">PlatformTransactionManager</span></code> を指定する。</div>
<div class="line">デフォルトは  <code class="docutils literal"><span class="pre">transactionManager</span></code> というbean名で登録されているbeanが使用される。</div>
<div class="line">使用する <code class="docutils literal"><span class="pre">PlatformTransactionManager</span></code> のbean名が <code class="docutils literal"><span class="pre">transactionManager</span></code> でない場合は指定が必要である。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>named-queries-location</td>
<td><div class="first last line-block">
<div class="line">Named Queryが指定されているSpring Data JPAのプロパティファイルのロケーションを指定する。</div>
<div class="line">デフォルトは「classpath:META-INF/jpa-named-queries.properties」が使用される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>query-lookup-strategy</td>
<td><div class="first last line-block">
<div class="line">Queryメソッドが呼び出された特に実行するQueryをLookupする方法を指定する。</div>
<div class="line">デフォルトは <code class="docutils literal"><span class="pre">CREATE_IF_NOT_FOUND</span></code> となっている。詳細は、<a class="reference external" href="https://docs.spring.io/spring-data/commons/docs/1.13.20.RELEASE/reference/html/#repositories.query-methods.query-lookup-strategies">Spring Data Commons - Reference Documentationの “Query lookup strategies”</a>を参照されたい。 特に理由がない場合は、デフォルトのままでよい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>factory-class</td>
<td><div class="first last line-block">
<div class="line">Repositoryインタフェースのメソッドが呼び出された際の処理を実装するクラスを生成するためのFactoryを指定する。</div>
<div class="line">デフォルトでは、 <code class="docutils literal"><span class="pre">org.springframework.data.jpa.repository.support.JpaRepositoryFactory</span></code> が使用される。Spring Data JPAのデフォルト実装を変更する場合や、新しいメソッドを追加する場合に作成したFactoryを指定する。</div>
<div class="line">新しいメソッドを追加する方法については、<a class="reference internal" href="#custommethod-all-label"><span class="std std-ref">すべてのRepositoryインタフェースに一括で追加する</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>repository-impl-postfix</td>
<td><div class="first last line-block">
<div class="line">カスタムRepositoryの実装クラスであることを表す接尾辞を指定する。</div>
<div class="line">デフォルトは <code class="docutils literal"><span class="pre">Impl</span></code> となっている。例えば、Repositoryインタフェースの名前が <code class="docutils literal"><span class="pre">OrderRepository</span></code> の場合は、 <code class="docutils literal"><span class="pre">OrderRepositoryImpl</span></code> がカスタムRepositoryの実装クラスとなる。特に理由がない場合は、デフォルトのままでよい。</div>
<div class="line">カスタムRepositoryについては、「<a class="reference internal" href="#custommethod-individual-label"><span class="std std-ref">Entity毎のRepositoryインタフェースに個別に追加する</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id7">
<h4><a class="toc-backref" href="#id71">6.3.2.2.6. JPAのアノテーションを使用するための設定</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">JPAから提供されているアノテーション（<code class="docutils literal"><span class="pre">javax.persistence.PersistenceContext</span></code>と、<code class="docutils literal"><span class="pre">javax.persistence.PersistenceUnit</span></code>）を使用して、 <code class="docutils literal"><span class="pre">javax.persistence.EntityManagerFactory</span></code> と <code class="docutils literal"><span class="pre">javax.persistence.EntityManager</span></code> をInjectするためには、 <code class="docutils literal"><span class="pre">org.springframework.orm.jpa.support.PersistenceAnnotationBeanPostProcessor</span></code> をbean定義する必要がある。</div>
<div class="line"><code class="docutils literal"><span class="pre">&lt;jpa:repositories&gt;</span></code> 要素を指定した場合、デフォルトでbeanが定義されるため、bean定義の必要はない。</div>
</div>
</div>
<div class="section" id="jpa-dataaccessexception">
<h4><a class="toc-backref" href="#id72">6.3.2.2.7. JPAの例外を DataAccessExceptionに変換するための設定</a><a class="headerlink" href="#jpa-dataaccessexception" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">JPAの例外をSpring Frameworkから提供されている <code class="docutils literal"><span class="pre">DataAccessException</span></code> に変換するためには、<code class="docutils literal"><span class="pre">org.springframework.dao.annotation.PersistenceExceptionTranslationPostProcessor</span></code> をbean定義する必要がある。</div>
<div class="line"><code class="docutils literal"><span class="pre">&lt;jpa:repositories&gt;</span></code> 要素を指定した場合、デフォルトでbeanが定義されるため、bean定義の必要はない。</div>
</div>
</div>
<div class="section" id="openentitymanagerinviewinterceptor">
<h4><a class="toc-backref" href="#id73">6.3.2.2.8. OpenEntityManagerInViewInterceptorの設定</a><a class="headerlink" href="#openentitymanagerinviewinterceptor" title="Permalink to this headline">¶</a></h4>
<p>ControllerやJSP等のアプリケーション層でEntityのLazy Fetchを行うためには、<code class="docutils literal"><span class="pre">org.springframework.orm.jpa.support.OpenEntityManagerInViewInterceptor</span></code>を使用して、
<code class="docutils literal"><span class="pre">EntityManager</span></code> の生存期間をアプリケーション層まで伸ばす必要がある。</p>
<blockquote>
<div><div class="figure align-center" id="id51">
<a class="reference internal image-reference" href="../../_images/dataaccess_jpa_entitymanager-lifetime-interceptor.png"><img alt="Lifetime of EntityManager on OpenEntityManagerInViewInterceptor" src="../../_images/dataaccess_jpa_entitymanager-lifetime-interceptor.png" style="width: 80%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Lifetime of EntityManager on OpenEntityManagerInViewInterceptor</strong></span></p>
</div>
</div></blockquote>
<p><code class="docutils literal"><span class="pre">OpenEntityManagerInViewInterceptor</span></code> を使用しない場合は、 <code class="docutils literal"><span class="pre">EntityManager</span></code> の生存期間はトランザクションと同じになるため、
アプリケーション層で必要となるデータをServiceクラスの処理としてFetchするか、Lazy Fetchを使わずにEager Fetchを使用する必要がある。</p>
<blockquote>
<div><div class="figure align-center" id="id52">
<a class="reference internal image-reference" href="../../_images/dataaccess_jpa_entitymanager-lifetime-default.png"><img alt="Default lifetime of EntityManager" src="../../_images/dataaccess_jpa_entitymanager-lifetime-default.png" style="width: 80%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Default Life time of EntityManager</strong></span></p>
</div>
</div></blockquote>
<p>下記の点から、基本的にはFetch方法はLazy Fetchとして、<code class="docutils literal"><span class="pre">OpenEntityManagerInViewInterceptor</span></code>を使用することを推奨する。</p>
<ul class="simple">
<li>Serviceクラスの処理としてFetchした場合、getterメソッドを呼び出すだけの処理やgetterメソッドへアクセスしたコレクションへのアクセスなど、一見意味のない処理を実装することになってしまう。</li>
<li>Eager Fetchにした場合、アプリケーション層で使用しないデータへのFetchも行われる可能性があるため、性能に影響を与える可能性がある。</li>
</ul>
<p>以下に <code class="docutils literal"><span class="pre">OpenEntityManagerInViewInterceptor</span></code> の設定例を示す。</p>
<ul class="simple">
<li>spring-mvc.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;mvc:interceptors&gt;</span>
    <span class="nt">&lt;mvc:interceptor&gt;</span>
        <span class="nt">&lt;mvc:mapping</span> <span class="na">path=</span><span class="s">&quot;/**&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/resources/**&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;bean</span>
            <span class="na">class=</span><span class="s">&quot;org.springframework.orm.jpa.support.OpenEntityManagerInViewInterceptor&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/mvc:interceptor&gt;</span>
<span class="nt">&lt;/mvc:interceptors&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="6%" />
<col width="94%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Interceptorを適用するパスと、除外パスを指定する。</div>
<div class="line">例では、リソースファイル(js、css、imageなど)のパス以外のリクエストに対してInterceptorを適用している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.orm.jpa.support.OpenEntityManagerInViewInterceptor</span></code> を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>静的リソースへのパスを適用対象外とする</strong></p>
<p class="last">静的リソース(js、css、image、htmlなど)のパスについては、データアクセスが発生しないため、Interceptorの適用外とすることを推奨する。
適用対象にしてしまうと、 <code class="docutils literal"><span class="pre">EntityManager</span></code> に対して無駄な処理（インスタンス生成とクローズ処理）が実行されることになる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">Servlet FilterでLazy Fetchが必要な場合は、 <code class="docutils literal"><span class="pre">org.springframework.orm.jpa.support.OpenEntityManagerInViewFilter</span></code> を使用して、EntityManagerの生存期間をServlet Filter層まで伸ばす必要がある。</div>
<div class="line">例えば、 SpringSecurityの <code class="docutils literal"><span class="pre">org.springframework.security.core.userdetails.UserDetailsService</span></code> を拡張実装し、拡張した処理の中でEntityオブジェクトにアクセスする場合、このケースにあてはまる。</div>
<div class="line">ただし、Lazy Fetchの必要がないのであれば、 <code class="docutils literal"><span class="pre">EntityManager</span></code> の生存期間をServlet Filter層まで伸ばす必要はない。</div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Servlet Filter層でのLazy Fetchについて</strong></p>
<p class="last"><strong>Servlet Filter層でLazy Fetchが発生しないように設計および実装することを推奨する。</strong>
<code class="docutils literal"><span class="pre">OpenEntityManagerInViewInterceptor</span></code> を使用した方が、 適用パターンと除外パターンを柔軟に指定できるため、 <code class="docutils literal"><span class="pre">EntityManager</span></code> の生存期間をアプリケーション層まで伸ばす対象のパスを指定しやすくなる。
Servlet Filterで必要となるデータへのアクセスについては、Serviceクラスの処理として事前にFetchしておくか、またはEager Fetchを使用して事前にロードしておくことで、Lazy Fetchが発生しないようにする。</p>
</div>
<div class="figure align-center" id="id53">
<a class="reference internal image-reference" href="../../_images/dataaccess_jpa_entitymanager-lifetime-filter.png"><img alt="Lifetime of EntityManager on OpenEntityManagerInViewFilter" src="../../_images/dataaccess_jpa_entitymanager-lifetime-filter.png" style="width: 80%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Lifetime of EntityManager on OpenEntityManagerInViewFilter</strong></span></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>以下に <code class="docutils literal"><span class="pre">OpenEntityManagerInViewFilter</span></code> の設定例を示す。</p>
<ul class="simple">
<li>web.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;filter&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>Spring OpenEntityManagerInViewFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;filter-class&gt;</span>org.springframework.orm.jpa.support.OpenEntityManagerInViewFilter<span class="nt">&lt;/filter-class&gt;</span>
<span class="nt">&lt;/filter&gt;</span>
<span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;filter-mapping&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>Spring OpenEntityManagerInViewFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
<span class="nt">&lt;/filter-mapping&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="6%" />
<col width="94%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.orm.jpa.support.OpenEntityManagerInViewFilter</span></code> を指定する。</div>
<div class="line">このServlet Filterは、 <strong>Lazy Fetchが発生するServlet Filterより前に定義する必要がある。</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フィルタを適用するURLのパターンを指定する。可能な限り必要なパスのみに適用することを推奨するが、設定が煩雑になってしまうのであれば、「/*」（すべてのリクエスト）としてもよい。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">OpenEntityManagerInViewFilter</span></code> を適用するURLのパターンに「/*」（すべてのリクエスト）を指定した場合は、 <code class="docutils literal"><span class="pre">OpenEntityManagerInViewInterceptor</span></code> の設定は不要となる。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>意図せぬLazyInitializationExceptionの発生を防止するために</strong></p>
<p class="last"><code class="docutils literal"><span class="pre">OpenEntityManagerInViewInterceptor</span></code> や <code class="docutils literal"><span class="pre">OpenEntityManagerInViewFilter</span></code> を利用するかどうかに関わらず、Lazy Fetchが行われないままのEntityをEntityManagerの生存期間外まで引き継いでしまうと、意図せぬところで <code class="docutils literal"><span class="pre">org.hibernate.LazyInitializationException</span></code> が発生する可能性がある。
例として、SessionやFlash scopeに登録後、別リクエストやリダイレクト先で取得する場合が挙げられる。
上記のような場合には、あらかじめEntityManagerの生存期間内でFetchを行い、取得したデータを別オブジェクトに入れ替えて引き継ぐように実装することを推奨する。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="repository">
<h3><a class="toc-backref" href="#id74">6.3.2.3. Repositoryインタフェースの作成</a><a class="headerlink" href="#repository" title="Permalink to this headline">¶</a></h3>
<p>Spring DataではEntity毎のRepositoryインタフェースを作成する方法として、以下3つの方法を提供している。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="35%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">作成方法</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><a class="reference internal" href="#how-to-create-repository-extends-springdata-label"><span class="std std-ref">Spring Data提供のインタフェースを継承する</span></a></td>
<td>Spring Dataから提供されているインタフェースを継承することで、Entity毎のRepositoryインタフェースを作成する。
<strong>特に理由がない場合は、この方法で、Entity毎のRepositoryインタフェースを作成することを推奨する。</strong></td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><a class="reference internal" href="#how-to-create-repository-extends-myinterface-label"><span class="std std-ref">必要なメソッドのみ定義したインタフェースを継承する</span></a></td>
<td>Spring Dataから提供されているRepositoryインタフェースのメソッドの中から、必要なメソッドのみ定義したプロジェクト用の共通インタフェースを作成し、作成した共通インタフェースを継承することでEntity毎のRepositoryインタフェースを作成する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><a class="reference internal" href="#how-to-create-repository-notextends-label"><span class="std std-ref">インタフェースの継承は行わない</span></a></td>
<td>Spring Dataから提供されているインタフェースやプロジェクト用の共通インタフェースの継承は行わずに、Entity毎にRepositoryインタフェースを作成する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="spring-data">
<span id="how-to-create-repository-extends-springdata-label"></span><h4><a class="toc-backref" href="#id75">6.3.2.3.1. Spring Data提供のインタフェースを継承する</a><a class="headerlink" href="#spring-data" title="Permalink to this headline">¶</a></h4>
<p>Spring Dataから提供されているインタフェースを継承してEntity毎のRepositoryインタフェースを作成する方法について説明する。</p>
<p>継承することができるインタフェースは以下の通り。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="35%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">インタフェース</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.data.repository</div>
<div class="line">CrudRepository</div>
</div>
</td>
<td>汎用的なCRUD操作を行うメソッドを提供しているRepositoryインタフェース。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.data.repository</div>
<div class="line">PagingAndSortingRepository</div>
</div>
</td>
<td><code class="docutils literal"><span class="pre">CrudRepository</span></code> のfindAllメソッドにページネーション機能とソート機能を追加したRepositoryインタフェース。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>org.springframework.data.jpa.repository
JpaRepository</td>
<td><div class="first last line-block">
<div class="line">JPAの仕様に依存するメソッドを提供しているRepositoryインタフェース。</div>
<div class="line"><code class="docutils literal"><span class="pre">PagingAndSortingRepository</span></code> を継承しているため、 <code class="docutils literal"><span class="pre">PagingAndSortingRepository</span></code> および <code class="docutils literal"><span class="pre">CrudRepository</span></code> のメソッドも使用する事ができる。</div>
<div class="line"><strong>特に理由がない場合は、本インタフェースを継承してEntity毎のRepositoryインタフェースを作成することを推奨する。</strong></div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Spring Data提供のRepositoryインタフェースのデフォルト実装について</strong></p>
<p class="last">上記インタフェースで定義されているメソッドの実装は、Spring Data JPAより提供されている
<code class="docutils literal"><span class="pre">org.springframework.data.jpa.repository.support.SimpleJpaRepository</span></code> で行われている。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>以下に、作成例を示す。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="o">{</span> <span class="c1">// (1)</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">JpaRepository</span></code> を継承し、ジェネリック型 <code class="docutils literal"><span class="pre">&lt;T&gt;</span></code> にEntityの型、ジェネリック型 <code class="docutils literal"><span class="pre">&lt;ID</span> <span class="pre">extends</span> <span class="pre">Serializable&gt;</span></code> にEntityのIDの型を指定する。</div>
<div class="line">上記例では、Entityに<code class="docutils literal"><span class="pre">Order</span></code>型、EntityのIDに<code class="docutils literal"><span class="pre">Integer</span></code>型を指定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p><code class="docutils literal"><span class="pre">JpaRepository</span></code> を継承してEntity毎のRepositoryインタフェースを作成すると、以下のメソッドに対する実装を得ることが出来る。</p>
<blockquote>
<div><table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="35%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">メソッド</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>&lt;S extends T&gt; S save(S entity)</td>
<td><div class="first last line-block">
<div class="line">指定されたEntityに対する永続操作(INSERT/UPDATE)を <code class="docutils literal"><span class="pre">javax.persistence.EntityManger</span></code> に蓄積するためのメソッド。</div>
<div class="line">IDプロパティ(<code class="docutils literal"><span class="pre">&#64;javax.persistence.Id</span></code> アノテーションまたは <code class="docutils literal"><span class="pre">&#64;javax.persistence.EmbeddedId</span></code> アノテーションが付与されているプロパティ)に値が設定されていない場合は <code class="docutils literal"><span class="pre">EntityManager</span></code> の <code class="docutils literal"><span class="pre">persist</span></code> メソッドが呼ばれ、値が設定されている場合は <code class="docutils literal"><span class="pre">merge</span></code> メソッドが呼び出される。</div>
<div class="line">mergeメソッドが呼び出された場合、返却されるEntityオブジェクトは、引数で渡されたEntityとは別のオブジェクトとなるので注意すること。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>&lt;S extends T&gt; List&lt;S&gt; save(Iterable&lt;S&gt; entities)</td>
<td><div class="first last line-block">
<div class="line">指定された複数のEntityに対する永続操作を <code class="docutils literal"><span class="pre">EntityManger</span></code> に蓄積するためのメソッド。</div>
<div class="line"><code class="docutils literal"><span class="pre">&lt;S</span> <span class="pre">extends</span> <span class="pre">T&gt;</span> <span class="pre">S</span> <span class="pre">save(S</span> <span class="pre">entity)</span></code> メソッドを繰り返し呼び出す事で実現している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>T saveAndFlush(T entity)</td>
<td><div class="first last line-block">
<div class="line">指定されたEntityに対する永続操作を <code class="docutils literal"><span class="pre">EntityManger</span></code> に蓄積した後に、蓄積されている永続操作(INSERT/UPDATE/DELETE)を永続層(DB)に反映するためのメソッド。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>void flush()</td>
<td><code class="docutils literal"><span class="pre">EntityManager</span></code> に蓄積されたEntityへの永続操作(INSERT/UPDATE/DELETE)を永続層(DB)に実行するためのメソッド。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>void delete(ID id)</td>
<td><div class="first last line-block">
<div class="line">指定されたIDのEntityに対する削除操作を <code class="docutils literal"><span class="pre">EntityManger</span></code> に蓄積するためのメソッド。</div>
<div class="line">このメソッドは <code class="docutils literal"><span class="pre">T</span> <span class="pre">findOne(ID)</span></code> メソッドを呼び出してEntityオブジェクトを <code class="docutils literal"><span class="pre">EntityManger</span></code> の管理下にしてから削除している。</div>
<div class="line"><code class="docutils literal"><span class="pre">T</span> <span class="pre">findOne(ID)</span></code> メソッドの呼び出し時にEntityが存在しない場合は、 <code class="docutils literal"><span class="pre">org.springframework.dao.EmptyResultDataAccessException</span></code> が発生する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>void delete(T entity)</td>
<td><div class="first last line-block">
<div class="line">指定されたEntityに対する削除操作を <code class="docutils literal"><span class="pre">EntityManger</span></code> に蓄積するためのメソッド。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td>void delete(Iterable&lt;? extends T&gt; entities)</td>
<td><div class="first last line-block">
<div class="line">指定された複数のEntityに対する削除操作を <code class="docutils literal"><span class="pre">EntityManger</span></code> に蓄積するためのメソッド。</div>
<div class="line"><code class="docutils literal"><span class="pre">void</span> <span class="pre">delete(T</span> <span class="pre">entity)</span></code>  メソッドを繰り返し呼び出す事で実現している。削除対象のEntityが大量になる場合は、 <code class="docutils literal"><span class="pre">void</span> <span class="pre">deleteInBatch(Iterable&lt;T&gt;</span> <span class="pre">entities)</span></code> メソッドを使用した方が効率的に削除することができる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="8">
<li></li>
</ol>
</td>
<td>void deleteAll()</td>
<td><div class="first last line-block">
<div class="line">すべてのEntityに対する削除操作を <code class="docutils literal"><span class="pre">EntityManger</span></code> に蓄積するためのメソッド。</div>
<div class="line"><code class="docutils literal"><span class="pre">List&lt;T&gt;</span> <span class="pre">findAll()</span></code> メソッドで取得したEntityに対して <code class="docutils literal"><span class="pre">void</span> <span class="pre">delete(T</span> <span class="pre">entity)</span></code> メソッドを繰り返し呼び出す事で実現している。</div>
<div class="line">削除対象のEntityが大量になる場合は、 <code class="docutils literal"><span class="pre">void</span> <span class="pre">deleteAllInBatch()</span></code> メソッドを使用すること。このメソッドは削除するEntityをすべてアプリケーション上に読み込むので、メモリ枯渇の原因になる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="9">
<li></li>
</ol>
</td>
<td>void deleteInBatch(Iterable&lt;T&gt; entities)</td>
<td><div class="first last line-block">
<div class="line">指定された複数のEntityを直接永続層(DB)から削除するためのメソッド。</div>
<div class="line">このメソッドを使って削除した場合、 <code class="docutils literal"><span class="pre">EntityManager</span></code> 上で管理(キャッシュ)されているEntityは削除されないため、 本メソッドで削除した後に <code class="docutils literal"><span class="pre">T</span> <span class="pre">findOne(ID</span> <span class="pre">id)</span></code> メソッドを呼び出すと <code class="docutils literal"><span class="pre">EntityManager</span></code> 上で管理されているEntityが返却されるので注意が必要。</div>
<div class="line">後続処理で削除したEntityに対して <code class="docutils literal"><span class="pre">T</span> <span class="pre">findOne(ID</span> <span class="pre">id)</span></code> メソッドなどの <code class="docutils literal"><span class="pre">EntityManager</span></code> 上で管理(キャッシュ)されているEntityオブジェクトを返却するメソッドを呼び出す可能性がある場合は、 <code class="docutils literal"><span class="pre">void</span> <span class="pre">delete(Iterable&lt;?</span> <span class="pre">extends</span> <span class="pre">T&gt;</span> <span class="pre">entities)</span></code> メソッドを使用して削除すること。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="10">
<li></li>
</ol>
</td>
<td>void deleteAllInBatch()</td>
<td><div class="first last line-block">
<div class="line">すべてのEntityを直接永続層(DB)から削除するためのメソッド。</div>
<div class="line"><code class="docutils literal"><span class="pre">void</span> <span class="pre">deleteInBatch(Iterable&lt;T&gt;</span> <span class="pre">entities)</span></code> メソッドと同様、<code class="docutils literal"><span class="pre">EntityManager</span></code> 上で管理(キャッシュ)されているEntityは削除されない点に注意すること。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="11">
<li></li>
</ol>
</td>
<td>T findOne(ID id)</td>
<td><div class="first last line-block">
<div class="line">指定されたIDのEntityを永続層(DB)から取得するためのメソッド。</div>
<div class="line">永続層から取得されたEntityは <code class="docutils literal"><span class="pre">EntityManager</span></code> によって管理(キャッシュ)されるため、2回目以降のアクセスでは永続層へのアクセスは発生せず、キャッシュされているEntityが返却される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="12">
<li></li>
</ol>
</td>
<td>List&lt;T&gt; findAll()</td>
<td><div class="first last line-block">
<div class="line">すべてのEntityを永続層(DB)から取得するためのメソッド。</div>
<div class="line">永続層から取得されたEntityは <code class="docutils literal"><span class="pre">EntityManager</span></code> によって管理(キャッシュ)される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="13">
<li></li>
</ol>
</td>
<td>Iterable&lt;T&gt; findAll(Iterable&lt;ID&gt; ids)</td>
<td><div class="first last line-block">
<div class="line">指定された複数のIDのEntityを永続層(DB)から取得するためのメソッド。</div>
<div class="line">永続層から取得されたEntityは <code class="docutils literal"><span class="pre">EntityManager</span></code> によって管理(キャッシュ)される。 指定されたIDはIN句を使って検索されるため、OracleなどIN句に指定できる値の数に制限があるDBを使う場合は注意すること。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="14">
<li></li>
</ol>
</td>
<td>List&lt;T&gt; findAll(Sort sort)</td>
<td><div class="first last line-block">
<div class="line">指定された並び順ですべてのEntityを永続層(DB)から取得するためのメソッド。</div>
<div class="line">永続層から取得されたEntityは <code class="docutils literal"><span class="pre">EntityManager</span></code> によって管理(キャッシュ)される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="15">
<li></li>
</ol>
</td>
<td>Page&lt;T&gt; findAll(Pageable pageable)</td>
<td><div class="first last line-block">
<div class="line">指定されたページ(並び順、ページ数、ページ内に表示する件数)に一致するEntityを永続層(DB)から取得するためのメソッド。</div>
<div class="line">永続層から取得されたEntityは <code class="docutils literal"><span class="pre">EntityManager</span></code> によって管理(キャッシュ)される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="16">
<li></li>
</ol>
</td>
<td>boolean exists(ID id)</td>
<td><div class="first last line-block">
<div class="line">指定されたIDのEntityが存在するかチェックするためのメソッド。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="17">
<li></li>
</ol>
</td>
<td>long count()</td>
<td><div class="first last line-block">
<div class="line">永続化対象のEntityの件数を取得するためのメソッド。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>JPAの楽観ロック(&#64;javax.persistence.Version)使用時の動作について</strong></p>
<p>JPAの楽観ロック( <code class="docutils literal"><span class="pre">&#64;Version</span></code> )使用時に更新対象のEntityが更新または削除された場合は、<code class="docutils literal"><span class="pre">org.springframework.dao.OptimisticLockingFailureException</span></code>が発生する。
<code class="docutils literal"><span class="pre">OptimisticLockingFailureException</span></code> が発生する可能性があるメソッドは、以下の通りである。</p>
<blockquote>
<div><ul class="simple">
<li>&lt;S extends T&gt; S save(S entity)</li>
<li>&lt;S extends T&gt; List&lt;S&gt; save(Iterable&lt;S&gt; entities)</li>
<li>T saveAndFlush(T entity)</li>
<li>void delete(ID id)</li>
<li>void delete(T entity)</li>
<li>void delete(Iterable&lt;? extends T&gt; entities)</li>
<li>void deleteAll()</li>
<li>void flush()</li>
</ul>
</div></blockquote>
<p class="last">JPAの楽観ロックの詳細については <a class="reference internal" href="ExclusionControl.html"><span class="doc">排他制御</span></a> を参照されたい。</p>
</div>
</div></blockquote>
<blockquote id="how-to-create-repository-extends-springdata-flush-timing-note1">
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>永続操作の反映タイミングについて(その１)</strong></p>
<p><code class="docutils literal"><span class="pre">EntityManager</span></code>に蓄積されたEntityへの永続操作は、トランザクションをコミットする直前に実行され永続層(DB)に反映される。
そのため、一意制約違反などのエラーをトランザクション管理内の処理(Serviceの処理)でハンドリングしたい場合は、 <code class="docutils literal"><span class="pre">saveAndFlush</span></code> メソッドまたは <code class="docutils literal"><span class="pre">flush</span></code> メソッドを呼び出して <code class="docutils literal"><span class="pre">EntityManager</span></code> 内に蓄積されているEntityへの永続操作を強制的に実行する必要がある。
単にエラーをクライアントに通知するだけでよければ、Controllerで例外ハンドリングを行い適切なメッセージを設定すればよい。</p>
<p class="last"><code class="docutils literal"><span class="pre">saveAndFlush</span></code>メソッドおよび<code class="docutils literal"><span class="pre">flush</span></code>メソッドはJPA依存のメソッドなので、意図なく使用しないように注意すること。</p>
</div>
<ul class="simple">
<li>通常のフロー</li>
</ul>
<blockquote>
<div><div class="figure align-center" id="id54">
<a class="reference internal image-reference" href="../../_images/dataaccess_jpa_persistence_flow_normal.png"><img alt="Normal sequence of persistence processing" src="../../_images/dataaccess_jpa_persistence_flow_normal.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Normal sequence of persistence processing</strong></span></p>
</div>
</div></blockquote>
<ul class="simple">
<li>flush時のフロー</li>
</ul>
<blockquote>
<div><div class="figure align-center" id="id55">
<a class="reference internal image-reference" href="../../_images/dataaccess_jpa_persistence_flow_flush.png"><img alt="Sequence of persistence processing when using flush method" src="../../_images/dataaccess_jpa_persistence_flow_flush.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Sequence of persistence processing when using flush method</strong></span></p>
</div>
</div></blockquote>
</div></blockquote>
<blockquote id="how-to-create-repository-extends-springdata-flush-timing-note2">
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>永続操作の反映タイミングについて(その２)</strong></p>
<p>以下のメソッドを呼び出した場合、<code class="docutils literal"><span class="pre">EntityManager</span></code>と、永続層(DB)で管理しているデータの不整合が発生しないようにするために、
メインの処理が行われる前に <code class="docutils literal"><span class="pre">EntityManager</span></code> に蓄積されているEntityへの永続操作が永続層(DB)に反映される。</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">List&lt;T&gt;</span> <span class="pre">findAll</span></code> 系メソッド</li>
<li><code class="docutils literal"><span class="pre">boolean</span> <span class="pre">exists(ID</span> <span class="pre">id)</span></code></li>
<li><code class="docutils literal"><span class="pre">long</span> <span class="pre">count()</span></code></li>
</ul>
</div></blockquote>
<p class="last">上記のメソッドは、永続層(DB)に直接Queryを発行するため、 メインの処理が行われる前に永続層(DB)に反映されないとデータの不整合が発生することになる。
後述するQueryメソッドを呼び出した際も、 <code class="docutils literal"><span class="pre">EntityManager</span></code> に蓄積されていたEntityへの永続操作が、永続層(DB)に反映されるトリガーとなる。</p>
</div>
<ul class="simple">
<li>Query発行時のフロー</li>
</ul>
<blockquote>
<div><div class="figure align-center" id="id56">
<a class="reference internal image-reference" href="../../_images/dataaccess_jpa_persistence_flow_query.png"><img alt="Sequence of persistence processing when using query method" src="../../_images/dataaccess_jpa_persistence_flow_query.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Picture - Sequence of persistence processing when using query method</strong></span></p>
</div>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="how-to-create-repository-extends-myinterface-label">
<span id="id8"></span><h4><a class="toc-backref" href="#id76">6.3.2.3.2. 必要なメソッドのみ定義したインタフェースを継承する</a><a class="headerlink" href="#how-to-create-repository-extends-myinterface-label" title="Permalink to this headline">¶</a></h4>
<p>Spring Dataから提供されているインタフェースに定義されているメソッドの中から、必要なメソッドのみ定義した共通インタフェースを
作成し継承する事でEntity毎のRepositoryインタフェースを作成する方法について説明する。</p>
<p>メソッドのシグネチャをSpring Dataから提供されているRepositoryインタフェースのメソッドと一致させる必要があるが、Spring Data提供の
Repositoryインタフェースを継承して作成した際と同様、メソッドの実装は不要である。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>想定される適用ケース</strong></p>
<p class="last">Spring Dataから提供されているRepositoryインタフェースのメソッドの中には、実際のアプリケーションでは使用しないまたは使用しない方がよいメソッドもある。
そのようなメソッドをRepositoryインタフェースから削除したい場合は、この方法で作成する。
インタフェースに定義したメソッドの実装は、Spring Data JPAより提供されている<code class="docutils literal"><span class="pre">org.springframework.data.jpa.repository.support.SimpleJpaRepository</span></code>で行われている。</p>
</div>
</div></blockquote>
<p>以下に、作成例を示す。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@NoRepositoryBean</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MyProjectRepository</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ID</span> <span class="kd">extends</span> <span class="n">Serializable</span><span class="o">&gt;</span> <span class="kd">extends</span>
        <span class="n">Repository</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ID</span><span class="o">&gt;</span> <span class="o">{</span> <span class="c1">// (2)</span>

    <span class="n">T</span> <span class="nf">findOne</span><span class="o">(</span><span class="n">ID</span> <span class="n">id</span><span class="o">);</span> <span class="c1">// (3)</span>

    <span class="n">T</span> <span class="nf">save</span><span class="o">(</span><span class="n">T</span> <span class="n">entity</span><span class="o">);</span> <span class="c1">// (3)</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderRepository</span> <span class="kd">extends</span> <span class="n">MyProjectRepository</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="o">{</span> <span class="c1">// (4)</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;NoRepositoryBean</span></code> を指定し、Spring Dataによる <code class="docutils literal"><span class="pre">Repository</span></code> インターフェースのインスタンス化対象から外す。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.data.repository.Repository</span></code> を継承しプロジェクト用の汎用インタフェースを作成する。</div>
<div class="line">汎用インタフェースなので、ジェネリック型を使用する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>Spring Dataから提供されているRepositoryインタフェースのメソッドの中から必要なメソッドを選んで定義する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>プロジェクト用の汎用インタフェースを継承し、ジェネリック型 <code class="docutils literal"><span class="pre">&lt;T&gt;</span></code> にEntityの型、ジェネリック型 <code class="docutils literal"><span class="pre">&lt;ID</span> <span class="pre">extends</span> <span class="pre">Serializable&gt;</span></code> にEntityのIDの型を指定する。例では、Entityに<code class="docutils literal"><span class="pre">Order</span></code>型、EntityのIDに<code class="docutils literal"><span class="pre">Integer</span></code>型を指定している。</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="how-to-create-repository-notextends-label">
<span id="id9"></span><h4><a class="toc-backref" href="#id77">6.3.2.3.3. インタフェースの継承は行わない</a><a class="headerlink" href="#how-to-create-repository-notextends-label" title="Permalink to this headline">¶</a></h4>
<p>Spring Dataより提供されているインタフェースや共通インタフェースを継承しないで、Entity毎のRepositoryインタフェースを作成する方法について、説明する。</p>
<div class="line-block">
<div class="line">クラスアノテーションとして<code class="docutils literal"><span class="pre">&#64;org.springframework.data.repository.RepositoryDefinition</span></code>アノテーションを指定し、 domainClass属性にEntityの型を、idClass属性にEntityのIDの型を指定する。</div>
<div class="line">Spring Dataから提供されているRepositoryインタフェースに定義されているメソッドと同じシグネチャのメソッドについては、Spring Data提供のRepositoryインタフェースを継承して作成した際と同様、メソッドの実装は不要である。</div>
</div>
<p></p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>想定される適用ケース</strong></p>
<p class="last">共通的なEntityの操作が必要ない場合は、この方法で作成してもよい。
Spring Dataから提供されているRepositoryインタフェースに定義されているメソッドと同じシグネチャのメソッドの実装は、Spring Data JPAより提供されている <code class="docutils literal"><span class="pre">org.springframework.data.jpa.repository.support.SimpleJpaRepository</span></code> で行われている。</p>
</div>
</div></blockquote>
<p>以下に、作成例を示す。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RepositoryDefinition</span><span class="o">(</span><span class="n">domainClass</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">idClass</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderRepository</span> <span class="o">{</span> <span class="c1">//(2)</span>

    <span class="n">Order</span> <span class="nf">findOne</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">);</span> <span class="c1">// (3)</span>

    <span class="n">Order</span> <span class="nf">save</span><span class="o">(</span><span class="n">Order</span> <span class="n">entity</span><span class="o">);</span> <span class="c1">// (3)</span>

    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;RepositoryDefinition</span></code> アノテーションを指定する。</div>
<div class="line">例では、domainClass属性(Entityの型)に<code class="docutils literal"><span class="pre">Order</span></code>型、idClass属性(EntityのIDの型)に<code class="docutils literal"><span class="pre">Integer</span></code>型を指定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>Spring Dataから提供されているインタフェース(<code class="docutils literal"><span class="pre">org.springframework.data.repository.Repository</span></code>)の継承は不要である。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>Entity毎に必要なメソッドを定義する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div>
<div class="section" id="query">
<span id="data-access-jpa-how-to-use-querymethod"></span><h3><a class="toc-backref" href="#id78">6.3.2.4. Queryメソッドの追加</a><a class="headerlink" href="#query" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Spring Dataより提供されている汎用的なCRUD操作を行うためのインタフェースだけでは、実際のアプリケーションを構築する事は難しい。</div>
<div class="line">そのためSpring Dataでは、Entity毎のRepositoryインタフェースに対して任意の永続操作(SELECT/UPDATE/DELETE)を行うためのQueryメソッドを追加できる仕組みを提供している。</div>
<div class="line">追加したQueryメソッドでは、Query言語(JPQLまたはNativeなSQL)を使用してEntityの操作を行う。</div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>JPQLとは</strong></p>
<p>JPQLとは”Java Persistence Query Language”の略で、永続層(DB)のレコードに対応するEntityを操作(SELECT/UPDATE/DELETE)するためのQuery言語である。
文法はSQLに似ているが、永続層(DB)のレコードを直接操作するのではなく、永続層のレコードにマッピングされているEntityを操作することになる。
Entityに対して行った操作の永続層(DB)への反映は、JPAプロバイダ(Hibernate)によって行われる。</p>
<p class="last">JPQLの詳細については、<a class="reference external" href="http://download.oracle.com/otn-pub/jcp/persistence-2_1-fr-eval-spec/JavaPersistence.pdf">JSR 338: Java Persistence API, Version 2.1のSpecification(PDF)「Chapter 4 Query Language」</a>を参照されたい。</p>
</div>
</div></blockquote>
<div class="section" id="id10">
<h4><a class="toc-backref" href="#id79">6.3.2.4.1. Queryメソッドを定義する</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<p>Queryメソッドは、Entity毎のRepositoryインタフェースのメソッドとして定義する。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findByStatusCode</span><span class="o">(</span><span class="n">String</span> <span class="n">statusCode</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="id11">
<h4><a class="toc-backref" href="#id80">6.3.2.4.2. 実行するQueryを指定する</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Queryメソッド呼び出し時に実行するQueryを指定する必要がある。</div>
<div class="line">指定方法は以下の通り。詳細は、<a class="reference internal" href="#how-to-specify-query-label"><span class="std std-ref">QueryメソッドのQuery指定</span></a>を参照されたい。</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="30%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">Queryの指定方法</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#how-to-specify-query-annotation-label"><span class="std std-ref">&#64;Query アノテーション</span></a></div>
<div class="line">(Spring Dataの機能)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Entity毎のRepositoryインタフェースに追加したメソッドに <code class="docutils literal"><span class="pre">&#64;org.springframework.data.jpa.repository.Query</span></code> アノテーションを指定し、実行するQueryを指定する。</div>
<div class="line"><strong>特に理由がない場合は、この方法で指定することを推奨する。</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#how-to-specify-query-mathodname-label"><span class="std std-ref">命名規約ベースのメソッド名</span></a></div>
<div class="line">(Spring Dataの機能)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring Dataが定めた命名規約に則りメソッド名を付与することで実行するQueryを指定する。</div>
<div class="line">Spring Data JPAの機能によってメソッド名から実行するQuery(JPQL)が生成される。生成できるJPQLはSELECTのみとなっている。</div>
<div class="line"><strong>条件が少なくシンプルなQueryの場合は、 &#64;Query アノテーションを使わずにこの方法を使ってもよい。</strong> ただし、条件が多く複雑なQueryの場合は、メソッド名は振る舞いを表すシンプルな名前にして <code class="docutils literal"><span class="pre">&#64;Query</span></code> アノテーションでQueryを指定すること。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference internal" href="#how-to-specify-query-namedquery-properties-label"><span class="std std-ref">プロパティファイルのNamed query</span></a></div>
<div class="line">(Spring Dataの機能)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring Data JPAから提供されているプロパティファイルに実行するQueryを指定する。</div>
<div class="line"><strong>メソッド定義とQuery指定を行う箇所が分離してしまうので、基本的にはこの方法での指定は推奨しない。</strong></div>
<div class="line"><strong>ただし、QueryとしてNativeなSQLを使用する場合は、データベースに依存するSQLをプロパティファイルに定義する必要があるか確認すること。</strong></div>
<div class="line">使用するデータベースを任意に選択できるアプリケーションや、実行環境によって用意できるデータベースが変わる(変わる可能性がある)場合には、この方法でQueryを指定し、プロパティファイルを環境依存資材として管理する必要がある。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Query指定方法の併用について</strong></p>
<p class="last">複数のQueryの指定方法を併用することに対して、特に制限は設けない。プロジェクトで使用する指定方法や併用の制限については、プロジェクト毎に判断すること。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>QueryのLookup方法について</strong></p>
<p>Spring Dataデフォルトの動作は、 <code class="docutils literal"><span class="pre">CREATE_IF_NOT_FOUND</span></code> に設定されているため、以下の動作となる。</p>
<ol class="arabic simple">
<li><code class="docutils literal"><span class="pre">&#64;Query</span></code> アノテーションに指定されているQueryを取得し、指定があればそのQueryを使用する。</li>
<li>Named queryから対応するQueryを取得し、対応するQueryが見つかった場合はそのQueryを使用する。</li>
<li>メソッド名からQuery(JPQL)を作成して使用する。</li>
<li>メソッド名からQuery(JPQL)が作成できない場合は、エラーとなる。</li>
</ol>
<p class="last">QueryのLookup方法の詳細については、 <a class="reference external" href="https://docs.spring.io/spring-data/commons/docs/1.13.20.RELEASE/reference/html/#repositories.query-methods.query-lookup-strategies">Spring Data Commons - Reference Documentation「Defining query methods」の
「Query lookup strategies」</a>を参照されたい。</p>
</div>
</div></blockquote>
</div>
<div class="section" id="id12">
<h4><a class="toc-backref" href="#id81">6.3.2.4.3. Entityのロックを取得する</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Entityのロックを取得する必要がある場合は、Queryメソッドに <code class="docutils literal"><span class="pre">&#64;org.springframework.data.jpa.repository.Lock</span></code> アノテーションを追加し、ロックモードを指定する。</div>
<div class="line">詳細については、 <a class="reference internal" href="ExclusionControl.html"><span class="doc">排他制御</span></a> を参照されたい。</div>
</div>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Query</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;SELECT o FROM Order o WHERE o.status.code = :statusCode ORDER BY o.id DESC&quot;</span><span class="o">)</span>
<span class="nd">@Lock</span><span class="o">(</span><span class="n">LockModeType</span><span class="o">.</span><span class="na">PESSIMISTIC_WRITE</span><span class="o">)</span> <span class="c1">// (1)</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findByStatusCode</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;statusCode&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">statusCode</span><span class="o">);</span>
</pre></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (2) statusCode=&#39;accepted&#39;</span>
<span class="k">SELECT</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">id1_5_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="k">AS</span> <span class="n">status2_5_</span>
    <span class="k">FROM</span>
        <span class="n">t_order</span> <span class="n">order0_</span>
    <span class="k">WHERE</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="s1">&#39;accepted&#39;</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="k">DESC</span>
    <span class="k">FOR</span> <span class="k">UPDATE</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;Lock</span></code> アノテーションのvalue属性にロックモードを指定する。</div>
<div class="line">指定可能なロックモードについては、<a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/persistence/LockModeType.html">Java Platform, Enterprise Edition API Specification</a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JPQLから変換されたNativeなSQL。(使用DBはPostgreSQL)</div>
<div class="line">例では、<code class="docutils literal"><span class="pre">LockModeType.PESSIMISTIC_WRITE</span></code> を指定しているので、SQLに”FOR UPDATE”句が追加される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="data-access-jpa-howtouse-querymethod-modifying">
<span id="id13"></span><h4><a class="toc-backref" href="#id82">6.3.2.4.4. 永続層のEntityを直接操作する</a><a class="headerlink" href="#data-access-jpa-howtouse-querymethod-modifying" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Entityの更新および削除の操作は、原則 <code class="docutils literal"><span class="pre">EntityManager</span></code> 上で管理されているEntityオブジェクトに対して行うことを推奨する。</div>
<div class="line">ただし、Entityを一括で更新または削除する必要がある場合は、Queryメソッドを使って永続層(DB)のEntityを直接操作することを検討すること。</div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>性能劣化の要因軽減</strong></p>
<p>永続層のEntityを直接操作することで、Entityの操作を行うためのSQLの発行回数を減らすことができる。
そのため、高い性能要件があるアプリケーションの場合は、この方法でEntityの一括操作を行うことで、性能劣化の要因を減らす事ができる。
減らすことが出来るSQLは以下の通り。</p>
<ul class="last simple">
<li>Entityオブジェクトを<code class="docutils literal"><span class="pre">EntityManager</span></code>上に読み込むためのSQL。発行が不要となる。</li>
<li>Entityを更新および削除するためのSQL。n回の発行が必要だったものが1回の発行で済む。</li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>永続層のEntityを直接操作するかの判断基準について</strong></p>
<p class="last">永続層のEntityを直接操作する場合、機能的な注意点がいくつかあるため、 <strong>性能要件が高くないアプリケーションの場合は、
一括操作についても EntityManager 上で管理されているEntityオブジェクトに対して行うことを推奨する。</strong>
具体的な注意点については、実装例を参照されたい。</p>
</div>
</div></blockquote>
<p>以下に、Queryメソッドを使って、永続層のEntityを直接操作する実装例を示す。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Modifying</span> <span class="c1">// (1)</span>
<span class="nd">@Query</span><span class="o">(</span><span class="s">&quot;UPDATE OrderItem oi SET oi.logicalDelete = true WHERE oi.id.orderId = :orderId &quot;</span><span class="o">)</span> <span class="c1">// (2)</span>
<span class="kt">int</span> <span class="nf">updateToLogicalDelete</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;orderId&quot;</span><span class="o">)</span> <span class="n">Integer</span> <span class="n">orderId</span><span class="o">);</span> <span class="c1">// (3)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">更新系のQueryメソッドであることを示す <code class="docutils literal"><span class="pre">&#64;org.springframework.data.jpa.repository.Modifying</span></code> アノテーションを指定する。</div>
<div class="line">指定しないと実行時にエラーとなる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">更新系(UPDATEまたはDELETE)用のQueryを指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">更新件数や削除件数が必要な場合は、<code class="docutils literal"><span class="pre">int</span></code> または <code class="docutils literal"><span class="pre">java.lang.Integer</span></code> を戻り値の型として指定し、件数が必要ない場合は、 <code class="docutils literal"><span class="pre">void</span></code> を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>EntityManager上で管理しているEntityとの整合性について</strong></p>
<p>Queryメソッドを使って永続層のEntityを直接操作した場合、Spring Data JPAのデフォルト動作ではEntityManager上で管理されているEntityに反映されない。
そのため、直後に <code class="docutils literal"><span class="pre">JpaRepository#findOne(ID)</span></code> メソッドを呼び出して取得されるEntityオブジェクトは、操作前の状態である点に注意すること。</p>
<p class="last">この動作を回避する方法として、 <code class="docutils literal"><span class="pre">&#64;Modifying</span></code> アノテーションのclearAutomatically属性を <code class="docutils literal"><span class="pre">true</span></code> に指定する方法がある。
clearAutomatically属性に <code class="docutils literal"><span class="pre">true</span></code> を指定した場合、永続層のEntityを直接操作した後に、 <code class="docutils literal"><span class="pre">EntityManager</span></code> の <code class="docutils literal"><span class="pre">clear()</span></code> メソッドが呼び出され、 <code class="docutils literal"><span class="pre">EntityManager</span></code> 上で管理されていたEntityオブジェクトと蓄積されていた永続操作が <code class="docutils literal"><span class="pre">EntityManager</span></code> 上から破棄される。
そのため、直後に <code class="docutils literal"><span class="pre">JpaRepository#findOne(ID)</span></code> メソッドを呼び出した場合、永続層から最新状態のEntityが取得され、永続層と <code class="docutils literal"><span class="pre">EntityManager</span></code> の状態が同期される仕組みになっている。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>&#64;Modifying(clearAutomatically = true) 使用時の注意点</strong></p>
<p><code class="docutils literal"><span class="pre">&#64;Modifying(clearAutomatically</span> <span class="pre">=</span> <span class="pre">true)</span></code> とすることで、蓄積されていた永続操作(INSERT/UPDATE/DELETE)も <code class="docutils literal"><span class="pre">EntityManager</span></code> 上から破棄されてしまうという点に注意が必要となる。
これは、必要な永続操作が永続層に反映されない可能性がある事を意味するため、バグを引き起こす要因となりうる。</p>
<p class="last">この問題を回避するためには、 永続層のEntityを直接操作する前に <code class="docutils literal"><span class="pre">JpaRepository#saveAndFlush(T</span> <span class="pre">entity)</span></code> または <code class="docutils literal"><span class="pre">JpaRepository#flush()</span></code> メソッドを呼び出し、蓄積されている永続操作を永続層に反映しておく必要がある。</p>
</div>
</div></blockquote>
</div>
<div class="section" id="id14">
<h4><a class="toc-backref" href="#id83">6.3.2.4.5. Queryヒントを設定する</a><a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h4>
<p>Queryにヒントを設定する必要がある場合は、Queryメソッドに <code class="docutils literal"><span class="pre">&#64;org.springframework.data.jpa.repository.QueryHints</span></code> アノテーションを追加し、
value属性にQueryヒント( <code class="docutils literal"><span class="pre">&#64;javax.persistence.QueryHint</span></code> )を指定する。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Query</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;SELECT o FROM Order o WHERE o.status.code = :statusCode ORDER BY o.id DESC&quot;</span><span class="o">)</span>
<span class="nd">@Lock</span><span class="o">(</span><span class="n">LockModeType</span><span class="o">.</span><span class="na">PESSIMISTIC_WRITE</span><span class="o">)</span>
<span class="nd">@QueryHints</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="o">{</span> <span class="nd">@QueryHint</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;javax.persistence.lock.timeout&quot;</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;0&quot;</span><span class="o">)</span> <span class="o">})</span> <span class="c1">// (1)</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findByStatusCode</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;statusCode&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">statusCode</span><span class="o">);</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;QueryHint</span></code> アノテーションのname属性にヒント名、value属性にヒント値を設定する。</div>
<div class="line">指定できるヒントは、JPAの仕様で決められているものに加え、プロバイダ固有のものがある。</div>
<div class="line">上記例では、ロックタイムアウトを “<code class="docutils literal"><span class="pre">0</span></code>” に設定している(使用DBはOracle)。SQLに”FOR UPDATE NOWAIT”句が追加される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Hibernateで指定できるQueryヒントについて</strong></p>
<p>JPA仕様で決められているQueryヒントは以下の通り。
詳細は、<a class="reference external" href="http://download.oracle.com/otn-pub/jcp/persistence-2_1-fr-eval-spec/JavaPersistence.pdf">JSR 338: Java Persistence API, Version 2.1のSpecification(PDF)</a>を参照されたい。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">javax.persistence.query.timeout</span></code></li>
<li><code class="docutils literal"><span class="pre">javax.persistence.lock.timeout</span></code></li>
<li><code class="docutils literal"><span class="pre">javax.persistence.cache.retrieveMode</span></code></li>
<li><code class="docutils literal"><span class="pre">javax.persistence.cache.storeMode</span></code></li>
</ul>
<p class="last">Hibernate固有のQueryヒントについては、 <a class="reference external" href="https://access.redhat.com/documentation/en-us/jboss_enterprise_application_platform/5/html/hibernate_entity_manager_reference_guide/ch03s04#idm140663886142976">Hibernate EntityManager Reference guide</a>の「3.4.1.7. Query hints」を参照されたい。</p>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="queryquery">
<span id="how-to-specify-query-label"></span><h3><a class="toc-backref" href="#id84">6.3.2.5. QueryメソッドのQuery指定</a><a class="headerlink" href="#queryquery" title="Permalink to this headline">¶</a></h3>
<p>Queryメソッド呼び出し時に実行するQueryの指定方法について説明する。</p>
<ul class="simple">
<li><a class="reference internal" href="#how-to-specify-query-annotation-label"><span class="std std-ref">&#64;Query アノテーションで指定する</span></a></li>
<li><a class="reference internal" href="#how-to-specify-query-mathodname-label"><span class="std std-ref">命名規約ベースのメソッド名で指定する</span></a></li>
<li><a class="reference internal" href="#how-to-specify-query-namedquery-properties-label"><span class="std std-ref">プロパティファイルにNamed queryとして指定する</span></a></li>
</ul>
<div class="section" id="how-to-specify-query-annotation-label">
<span id="id15"></span><h4><a class="toc-backref" href="#id85">6.3.2.5.1. &#64;Query アノテーションで指定する</a><a class="headerlink" href="#how-to-specify-query-annotation-label" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">&#64;Query</span></code> アノテーションのvalue属性に実行するQuery(JPQL)を指定する。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Query</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;SELECT o FROM Order o WHERE o.status.code = :statusCode ORDER BY o.id DESC&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findByStatusCode</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;statusCode&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">statusCode</span><span class="o">);</span>
</pre></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (2) statusCode=&#39;accepted&#39;</span>
<span class="k">SELECT</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">id1_5_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="k">AS</span> <span class="n">status2_5_</span>
    <span class="k">FROM</span>
        <span class="n">t_order</span> <span class="n">order0_</span>
    <span class="k">WHERE</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="s1">&#39;accepted&#39;</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="k">DESC</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;Query</span></code> アノテーションのvalue属性に実行するQuery(JPQL)を指定する。</div>
<div class="line">上記例では、<code class="docutils literal"><span class="pre">Order</span></code> オブジェクトで保持している <code class="docutils literal"><span class="pre">status</span></code> プロパティ( <code class="docutils literal"><span class="pre">OrderStatus</span></code> 型)の <code class="docutils literal"><span class="pre">code</span></code> プロパティ( <code class="docutils literal"><span class="pre">String</span></code> 型) の値が指定したパラメータ値( <code class="docutils literal"><span class="pre">statusCode</span></code> )と一致する <code class="docutils literal"><span class="pre">Order</span></code> オブジェクトを <code class="docutils literal"><span class="pre">id</span></code> プロパティの降順に並べて取得するためのQueryを指定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>JPQLから変換されたNativeなSQL。<code class="docutils literal"><span class="pre">&#64;Query</span></code> アノテーションのvalue属性に指定したQuery(JPQL)は、使用するデータベースのNativeなSQLに変換され実行される。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>JPQLではなくNativeなSQLを直接指定する方法</strong></p>
<p>QueryとしてJPQLではなくNativeなSQLを直接指定したい場合は、 nativeQuery属性を <code class="docutils literal"><span class="pre">true</span></code> に設定することで指定可能となる。
<strong>基本的にはJPQLを使用する事を推奨するが、JPQLで表現できないQueryを発行する必要がある場合はNativeなSQLを直接指定してもよい。</strong>
データベースに依存するSQLを指定する場合は、SQLをプロパティファイルに定義することを検討すること。</p>
<p class="last">SQLをプロパティファイルに定義する方法については、「<a class="reference internal" href="#how-to-specify-query-namedquery-properties-label"><span class="std std-ref">プロパティファイルにNamed queryとして指定する</span></a>」を参照されたい。</p>
</div>
<div class="admonition note" id="dataaccessjpanotenamedparameters">
<p class="first admonition-title">Note</p>
<p><strong>Named Parametersについて</strong></p>
<p>Queryにバインドするパラメータに対して名前を付与し、Query内からはパラメータ名を指定することで値をバインドすることができる。
Named Parameterを使用する場合は、 <code class="docutils literal"><span class="pre">&#64;org.springframework.data.repository.query.Param</span></code> アノテーションを対象とする引数に追加し、value属性にパラメータ名を指定する。
Queryでは、バインドしたい位置に「:パラメータ名」の形式で指定する。</p>
<p class="last"><strong>特に理由がない場合は、 Queryのメンテナンス性と可読性を考慮し、Named Parametersを使用することを推奨する。</strong></p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>Query(JPQL)解釈のバグについて</strong></p>
<p class="last">Hibernate 5.2.10以前においては、Query(JPQL)に余分な閉じ括弧があった場合、それ以降が無視された不完全なQuery(JPQL)が実行されてしまうバグが存在する。
TERASOLUNA Server Framework for Java 5.4.2ではHibernate 5.0.12を使用しているため、バグの影響を受け不完全なSQLが実行される恐れがある。
不完全なSQLが実行されたことをログ等から確認することが困難であるため、コーディング時に十分注意されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">LIKE検索の一致方法(前方一致、後方一致、部分一致)が固定の場合は、JPQL内に “<code class="docutils literal"><span class="pre">%</span></code>” を指定することが出来る。</div>
<div class="line">ただし、これはJPQLの標準形式ではなくSpring Data JPAの拡張形式になるので、<code class="docutils literal"><span class="pre">&#64;Query</span></code> アノテーションで指定するJPQLでのみ指定することが出来る。</div>
<div class="line">Named queryとして指定するJPQL内に “<code class="docutils literal"><span class="pre">%</span></code>” を指定するとエラーになるので注意すること。</div>
</div>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="20%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">一致方法</th>
<th class="head">形式</th>
<th class="head">具体例</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>前方一致</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">:parameterName%</span></code></div>
<div class="line">or</div>
<div class="line"><code class="docutils literal"><span class="pre">?n%</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">SELECT</span> <span class="pre">a</span> <span class="pre">FROM</span> <span class="pre">Account</span> <span class="pre">WHERE</span> <span class="pre">a.firstName</span> <span class="pre">LIKE</span> <span class="pre">:firstName%</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">SELECT</span> <span class="pre">a</span> <span class="pre">FROM</span> <span class="pre">Account</span> <span class="pre">WHERE</span> <span class="pre">a.firstName</span> <span class="pre">LIKE</span> <span class="pre">?1%</span></code></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>後方一致</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">%:parameterName</span></code></div>
<div class="line">or</div>
<div class="line"><code class="docutils literal"><span class="pre">%?n</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">SELECT</span> <span class="pre">a</span> <span class="pre">FROM</span> <span class="pre">Account</span> <span class="pre">WHERE</span> <span class="pre">a.firstName</span> <span class="pre">LIKE</span> <span class="pre">%:firstName</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">SELECT</span> <span class="pre">a</span> <span class="pre">FROM</span> <span class="pre">Account</span> <span class="pre">WHERE</span> <span class="pre">a.firstName</span> <span class="pre">LIKE</span> <span class="pre">%?1</span></code></div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>部分一致</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">%:parameterName%</span></code></div>
<div class="line">or</div>
<div class="line"><code class="docutils literal"><span class="pre">%?n%</span></code></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">SELECT</span> <span class="pre">a</span> <span class="pre">FROM</span> <span class="pre">Account</span> <span class="pre">WHERE</span> <span class="pre">a.firstName</span> <span class="pre">LIKE</span> <span class="pre">%:firstName%</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">SELECT</span> <span class="pre">a</span> <span class="pre">FROM</span> <span class="pre">Account</span> <span class="pre">WHERE</span> <span class="pre">a.firstName</span> <span class="pre">LIKE</span> <span class="pre">%?1%</span></code></div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>LIKE検索時のエスケープについて</strong></p>
<p>LIKE検索を行う場合は、検索条件となる値をLIKE検索用にエスケープする必要がある。</p>
<p class="last"><code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.query.QueryEscapeUtils</span></code> クラスにエスケープするためのメソッドが用意されているため、要件を充たせる場合は使用を検討すること。
<code class="docutils literal"><span class="pre">QueryEscapeUtils</span></code> クラスの詳細については、「<a class="reference internal" href="DataAccessCommon.html"><span class="doc">データベースアクセス（共通編）</span></a>」の「<a class="reference internal" href="DataAccessCommon.html#data-access-common-appendix-like-escape"><span class="std std-ref">LIKE検索時のエスケープについて</span></a>」を参照されたい。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>一致方法を動的に変化させる必要がある場合</strong></p>
<p>一致方法(前方一致、後方一致、部分一致)を動的に変化させる必要がある場合は、
JPQL内に “<code class="docutils literal"><span class="pre">%</span></code>” を指定するのではなく、従来通りバインドするパラメータ値の前後に “<code class="docutils literal"><span class="pre">%</span></code>” を追加すること。</p>
<p class="last"><code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.query.QueryEscapeUtils</span></code> クラスに一致方法に対応する検索条件値に変換するメソッドが用意されているため、
要件を充たせる場合は、使用を検討すること。
<code class="docutils literal"><span class="pre">QueryEscapeUtils</span></code> クラスの詳細については、「<a class="reference internal" href="DataAccessCommon.html"><span class="doc">データベースアクセス（共通編）</span></a>」の「<a class="reference internal" href="DataAccessCommon.html#data-access-common-appendix-like-escape"><span class="std std-ref">LIKE検索時のエスケープについて</span></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">ソート条件は、Query内に直接指定することができる。</div>
<div class="line">以下に、実装例を示す。</div>
</div>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="o">@</span><span class="n">Query</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="ss">&quot;SELECT o FROM Order o WHERE o.status.code = :statusCode ORDER BY o.id DESC&quot;</span><span class="p">)</span>
<span class="n">Page</span><span class="o">&lt;</span><span class="k">Order</span><span class="o">&gt;</span> <span class="n">findByStatusCode</span><span class="p">(</span><span class="o">@</span><span class="n">Param</span><span class="p">(</span><span class="ss">&quot;statusCode&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">statusCode</span><span class="p">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="p">);</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>Queryに <code class="docutils literal"><span class="pre">ORDER</span> <span class="pre">BY</span></code> を指定する。降順にする場合は <code class="docutils literal"><span class="pre">DESC</span></code> を、昇順にする場合は <code class="docutils literal"><span class="pre">ASC</span></code> を指定する。DESC/ASCを省略した場合は、 <code class="docutils literal"><span class="pre">ASC</span></code> が適用される。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">ソート条件はQuery内に直接指定する以外に、 <code class="docutils literal"><span class="pre">Pageable</span></code> オブジェクト内に保持している <code class="docutils literal"><span class="pre">org.springframework.data.domain.Sort</span></code> オブジェクトに指定することが出来る。</div>
<div class="line">この方法でソート条件を指定する場合は、countQuery属性の指定は不要。</div>
<div class="line">以下に、<code class="docutils literal"><span class="pre">Pageable</span></code> オブジェクト内に保持している <code class="docutils literal"><span class="pre">Sort</span></code> オブジェクトを使用してソートする実装例を示す。</div>
</div>
<ul class="simple">
<li>Controller</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;list&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">list</span><span class="o">(</span><span class="nd">@PageableDefault</span><span class="o">(</span>
                        <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="o">,</span>
                        <span class="n">sort</span> <span class="o">=</span> <span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="c1">// (1)</span>
                        <span class="n">direction</span> <span class="o">=</span> <span class="n">Direction</span><span class="o">.</span><span class="na">DESC</span> <span class="c1">// (1)</span>
                        <span class="o">)</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">,</span>
                          <span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Page</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">orderPage</span> <span class="o">=</span> <span class="n">orderService</span><span class="o">.</span><span class="na">getOrders</span><span class="o">(</span><span class="n">pageable</span><span class="o">);</span> <span class="c1">// (2)</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;orderPage&quot;</span><span class="o">,</span> <span class="n">orderPage</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">&quot;order/list&quot;</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ソート条件を指定する。 <code class="docutils literal"><span class="pre">Pageable#getSort()</span></code> メソッドで取得できる <code class="docutils literal"><span class="pre">Sort</span></code> オブジェクトにソート条件が設定される。</div>
<div class="line">上記例では、 idフィールドの降順をソート条件として指定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><code class="docutils literal"><span class="pre">Pageable</span></code> オブジェクトを指定してServiceのメソッドを呼び出す。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Service (Caller)</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">String</span> <span class="nf">getOrders</span><span class="o">(</span><span class="n">Pageable</span> <span class="n">pageable</span><span class="o">){</span>
    <span class="k">return</span> <span class="n">orderRepository</span><span class="o">.</span><span class="na">findByStatusCode</span><span class="o">(</span><span class="s">&quot;accepted&quot;</span><span class="o">,</span> <span class="n">pageable</span><span class="o">);</span> <span class="c1">// (3)</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>Controllerから渡された <code class="docutils literal"><span class="pre">Pageable</span></code> オブジェクトを指定してRepositoryのメソッドを呼び出す。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Repositoryインタフェース</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Query</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;SELECT o FROM Order o WHERE o.status.code = :statusCode&quot;</span><span class="o">)</span> <span class="c1">// (4)</span>
<span class="n">Page</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findByStatusCode</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;statusCode&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">statusCode</span><span class="o">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
</pre></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (5) statusCode=&#39;accepted&#39;</span>
<span class="k">SELECT</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="n">order0_</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">col_0_0_</span>
    <span class="k">FROM</span>
        <span class="n">t_order</span> <span class="n">order0_</span>
    <span class="k">WHERE</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="s1">&#39;accepted&#39;</span>

<span class="c1">-- (6) statusCode=&#39;accepted&#39;</span>
<span class="k">SELECT</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">id1_5_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="k">AS</span> <span class="n">status2_5_</span>
    <span class="k">FROM</span>
        <span class="n">t_order</span> <span class="n">order0_</span>
    <span class="k">WHERE</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="s1">&#39;accepted&#39;</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="k">DESC</span>
    <span class="k">LIMIT</span> <span class="mi">5</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>Queryに”ORDER BY”句の指定は行わない。countQuery属性の指定も不要。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>JPQLから変換された件数カウント用のNativeなSQL。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JPQLから変換された「指定されたページ位置のEntityを取得する」ためのNativeなSQL。</div>
<div class="line">Queryに指定はしていないが、<code class="docutils literal"><span class="pre">Pageable</span></code>オブジェクト内に保持している <code class="docutils literal"><span class="pre">Sort</span></code> オブジェクトに指定した条件で”ORDER BY”句が追加される。例では、PostgreSQL用のSQLになっている。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="how-to-specify-query-mathodname-label">
<span id="id16"></span><h4><a class="toc-backref" href="#id86">6.3.2.5.2. 命名規約ベースのメソッド名で指定する</a><a class="headerlink" href="#how-to-specify-query-mathodname-label" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Spring Dataが定めた命名規約に則ったメソッド名にすることで実行するQuery(JPQL)を指定する。</div>
<div class="line">Spring Data JPAの機能によってメソッド名からJPQLが生成される。</div>
<div class="line">ただし、メソッド名からJPQLを作成できるのはSELECTのみで、UPDATEおよびDELETEのJPQLは生成できない。</div>
</div>
<p>メソッド名からJPQLを生成するための命名規約などのルールについては、以下のページを参照されたい。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="45%" />
<col width="45%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">参照ページ</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><a class="reference external" href="https://docs.spring.io/spring-data/commons/docs/1.13.20.RELEASE/reference/html/#repositories.query-methods.query-creation">Spring Data Commons - Reference Documentation「Defining query methods」の「Query creation」</a></td>
<td>Distinct、ORDER BY、Case insensitiveの指定方法などが記載されている。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><a class="reference external" href="https://docs.spring.io/spring-data/commons/docs/1.13.20.RELEASE/reference/html/#repositories.query-methods.query-property-expressions">Spring Data Commons - Reference Documentation「Defining query methods」の「Property expressions」</a></td>
<td>ネストされたEntityのプロパティを条件に指定する方法などが記載されている。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><a class="reference external" href="https://docs.spring.io/spring-data/commons/docs/1.13.20.RELEASE/reference/html/#repositories.special-parameters">Spring Data Commons - Reference Documentation「Defining query methods」の「Special parameter handling」</a></td>
<td>特別なメソッド引数(<code class="docutils literal"><span class="pre">Pageable</span></code> 、 <code class="docutils literal"><span class="pre">Sort</span></code>)についての説明が記載されている。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><a class="reference external" href="https://docs.spring.io/spring-data/jpa/docs/1.11.20.RELEASE/reference/html/#jpa.query-methods.query-creation">Spring Data JPA - Reference Documentation「Query methods」の「Query creation」</a></td>
<td>JPQLを組み立てるための命名規約(キーワード)に関する説明が記載されている。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><a class="reference external" href="https://docs.spring.io/spring-data/commons/docs/1.13.20.RELEASE/reference/html/#repository-query-keywords">Spring Data Commons - Reference Documentation「Appendix C. Repository query keywords」</a></td>
<td>JPQLを組み立てるための命名規約(キーワード)に関する説明が記載されている。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>以下に、実装例を示す。</p>
<ul class="simple">
<li>OrderRepositry.java</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">Page</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findByStatusCode</span><span class="o">(</span><span class="n">String</span> <span class="n">statusCode</span><span class="o">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">);</span> <span class="c1">// (1)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">メソッド名が <code class="docutils literal"><span class="pre">^(find|read|get).*By(.+)</span></code> のパターンに一致する場合、メソッド名からJPQLを生成する対象のメソッドとなる。</div>
<div class="line"><code class="docutils literal"><span class="pre">(.+)</span></code> の部分に条件となるEntityのプロパティや操作を示すキーワードを指定する。</div>
<div class="line">例では、<code class="docutils literal"><span class="pre">Order</span></code> オブジェクトで保持している <code class="docutils literal"><span class="pre">status</span></code> プロパティ( <code class="docutils literal"><span class="pre">OrderStatus</span></code> 型)の <code class="docutils literal"><span class="pre">code</span></code> プロパティ( <code class="docutils literal"><span class="pre">String</span></code> 型) の値が指定したパラメータ値( <code class="docutils literal"><span class="pre">statusCode</span></code> )と一致する <code class="docutils literal"><span class="pre">Order</span></code> オブジェクトをページ形式で取得している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>件数カウント用Query</li>
</ul>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (2) JPQL</span>
<span class="k">SELECT</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
    <span class="k">FROM</span>
        <span class="k">ORDER</span> <span class="k">AS</span> <span class="n">generatedAlias0</span>
            <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">generatedAlias0</span><span class="p">.</span><span class="n">status</span> <span class="k">AS</span> <span class="n">generatedAlias1</span>
        <span class="k">WHERE</span>
            <span class="n">generatedAlias1</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="o">?</span><span class="mi">1</span>

<span class="c1">-- (3) SQL statusCode=&#39;accepted&#39;</span>
<span class="k">SELECT</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">col_0_0_</span>
    <span class="k">FROM</span>
        <span class="n">t_order</span> <span class="n">order0_</span>
            <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">c_order_status</span> <span class="n">orderstatu1_</span>
                <span class="k">ON</span> <span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">orderstatu1_</span><span class="p">.</span><span class="n">code</span>
    <span class="k">WHERE</span>
        <span class="n">orderstatu1_</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;accepted&#39;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>メソッド名から生成された件数カウント用のJPQLのQuery。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>(2)のJPQLから変換された件数カウント用のNativeなSQL。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Entity取得用Query</li>
</ul>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (4) JPQL</span>
<span class="k">SELECT</span>
        <span class="n">generatedAlias0</span>
    <span class="k">FROM</span>
        <span class="k">ORDER</span> <span class="k">AS</span> <span class="n">generatedAlias0</span>
            <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">generatedAlias0</span><span class="p">.</span><span class="n">status</span> <span class="k">AS</span> <span class="n">generatedAlias1</span>
        <span class="k">WHERE</span>
            <span class="n">generatedAlias1</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="o">?</span><span class="mi">1</span>
        <span class="k">ORDER</span> <span class="k">BY</span>
            <span class="n">generatedAlias0</span><span class="p">.</span><span class="n">id</span> <span class="k">DESC</span><span class="p">;</span>

<span class="c1">-- (5) statusCode=&#39;accepted&#39;</span>
<span class="k">SELECT</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">id1_5_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="k">AS</span> <span class="n">status2_5_</span>
    <span class="k">FROM</span>
        <span class="n">t_order</span> <span class="n">order0_</span>
            <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">c_order_status</span> <span class="n">orderstatu1_</span>
                <span class="k">ON</span> <span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">orderstatu1_</span><span class="p">.</span><span class="n">code</span>
    <span class="k">WHERE</span>
        <span class="n">orderstatu1_</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;accepted&#39;</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="k">DESC</span>
    <span class="k">LIMIT</span> <span class="mi">5</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>メソッド名から生成されたEntity取得用のJPQLのQuery。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>(4)のJPQLから変換されたEntity取得用のNativeなSQL。</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="named-query">
<span id="how-to-specify-query-namedquery-properties-label"></span><h4><a class="toc-backref" href="#id87">6.3.2.5.3. プロパティファイルにNamed queryとして指定する</a><a class="headerlink" href="#named-query" title="Permalink to this headline">¶</a></h4>
<p>Spring Data JPAから提供されているプロパティファイル(classpath:META-INF/jpa-named-queries.properties)に、実行するQueryを指定する。</p>
<div class="line-block">
<div class="line"><strong>この方法は、QueryとしてNativeQueryを使用する際に、データベース固有のSQLを記載する必要が出た場合に使用するか検討すること。</strong></div>
<div class="line"><strong>データベース固有のSQLであっても、実行環境に依存しないのであれば &#64;Queryアノテーションに直接指定する方法を推奨する。</strong></div>
</div>
<ul class="simple">
<li>OrderRepositry.java</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Query</span><span class="o">(</span><span class="n">nativeQuery</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findAllByStatusCode</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;statusCode&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">statusCode</span><span class="o">);</span> <span class="c1">// (1)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>Named queryのLookup名は、Entityのクラス名とメソッド名を “<code class="docutils literal"><span class="pre">.</span></code>” (dot) で連結したものが使用される。
上記例だと、 <code class="docutils literal"><span class="pre">Order.findAllByStatusCode</span></code> がLookup名となる。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>Named queryのLookup名を指定する方法</strong></p>
<p>デフォルトの動作では、Entityのクラス名とメソッド名を “<code class="docutils literal"><span class="pre">.</span></code>” (dot) で連結したものがLookup名として使用されるが、任意のクエリ名を指定することも出来る。</p>
<ul class="last simple">
<li>Entity取得用のLookup名に任意のクエリ名を指定したい場合は、 <code class="docutils literal"><span class="pre">&#64;Query</span></code> アノテーションのname属性にクエリ名を指定する。</li>
<li>ページ検索時の件数カウント用のLookup名に任意のクエリ名を指定したい場合は、 <code class="docutils literal"><span class="pre">&#64;Query</span></code> アノテーションのcountName属性にクエリ名を指定する。</li>
</ul>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Query</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;OrderRepository.findAllByStatusCode&quot;</span><span class="o">,</span> <span class="n">nativeQuery</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <span class="c1">// (2)</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findAllByStatusCode</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;statusCode&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">statusCode</span><span class="o">);</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>上記例では、<code class="docutils literal"><span class="pre">OrderRepository.findAllByStatusCode</span></code> をLookup用のクエリ名として指定している。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">jpa-named-queries.properties</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-properties"><div class="highlight"><pre><span></span><span class="c"># (3)</span>
<span class="na">Order.findAllByStatusCode</span><span class="o">=</span><span class="s">SELECT * FROM order WHERE status_code = :statusCode</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クエリー名をキーとして、実行するSQLを指定する。</div>
<div class="line">上記例では、<code class="docutils literal"><span class="pre">Order.findAllByStatusCode</span></code> をキーに、実行するSQLを指定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Spring Data JPAから提供されているプロパティファイルではなく、任意のプロパティファイルにNamed Queryを指定する方法を以下に紹介する。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">xxx-infra.xml</span></code></li>
</ul>
<blockquote class="last">
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;jpa:repositories</span> <span class="na">base-package=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.repository&quot;</span>
    <span class="na">named-queries-location=</span><span class="s">&quot;classpath:META-INF/jpa/jpa-named-queries.properties&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">&lt;jpa:repositories&gt;要素のnamed-queries-location属性に、任意のプロパティファイルを指定する。</div>
<div class="line">上記例では、クラスパス上にある<code class="file docutils literal"><span class="pre">META-INF/jpa/jpa-named-queries.properties</span></code>が使用される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="id17">
<h3><a class="toc-backref" href="#id88">6.3.2.6. Entityの検索処理の実装</a><a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h3>
<p>Entityの検索方法について、目的別に説明する。</p>
<div class="section" id="id18">
<h4><a class="toc-backref" href="#id89">6.3.2.6.1. 条件に一致するEntityを全件検索</a><a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h4>
<p>条件に一致するEntityを全件取得するQueryメソッドを呼び出す。</p>
<ul class="simple">
<li>Repositroyインタフェース</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AccountRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="c1">// (1)</span>
    <span class="nd">@Query</span><span class="o">(</span><span class="s">&quot;SELECT a FROM Account a WHERE :createdDateFrom &lt;= a.createdDate AND a.createdDate &lt; :createdDateTo ORDER BY a.createdDate DESC&quot;</span><span class="o">)</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="nf">findByCreatedDate</span><span class="o">(</span>
            <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;createdDateFrom&quot;</span><span class="o">)</span> <span class="n">Date</span> <span class="n">createdDateFrom</span><span class="o">,</span>
            <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;createdDateTo&quot;</span><span class="o">)</span> <span class="n">Date</span> <span class="n">createdDateTo</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">java.util.List</span></code> インタフェースを返却するQueryメソッドを定義する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Service</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="nf">getAccounts</span><span class="o">(</span><span class="n">Date</span> <span class="n">targetDate</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">LocalDate</span> <span class="n">targetLocalDate</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LocalDate</span><span class="o">(</span><span class="n">targetDate</span><span class="o">);</span>
    <span class="n">Date</span> <span class="n">fromDate</span> <span class="o">=</span> <span class="n">targetLocalDate</span><span class="o">.</span><span class="na">toDate</span><span class="o">();</span>
    <span class="n">Date</span> <span class="n">toDate</span> <span class="o">=</span> <span class="n">targetLocalDate</span><span class="o">.</span><span class="na">dayOfYear</span><span class="o">().</span><span class="na">addToCopy</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="na">toDate</span><span class="o">();</span>

    <span class="c1">// (2)</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="n">accounts</span> <span class="o">=</span> <span class="n">accountRepository</span><span class="o">.</span><span class="na">findByCreatedDate</span><span class="o">(</span><span class="n">fromDate</span><span class="o">,</span>
            <span class="n">toDate</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">accounts</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// (3)</span>
        <span class="c1">// ...</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">accounts</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Repositryインタフェースに実装したQueryメソッドを呼び出す。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">検索結果が0件の場合は、空のリストが返却される。nullは返却されないのでnullチェックは不要。</div>
<div class="line">必要に応じて、検索結果が0件の場合の処理を実装する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessjpahowtousefindpage">
<span id="id19"></span><h4><a class="toc-backref" href="#id90">6.3.2.6.2. 条件に一致するEntityのページ検索</a><a class="headerlink" href="#dataaccessjpahowtousefindpage" title="Permalink to this headline">¶</a></h4>
<p>条件に一致するEntityの中から指定ページに該当するEntityを取得するQueryメソッドを呼び出す。</p>
<ul class="simple">
<li>Repositroyインタフェース</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AccountRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="c1">// (1)</span>
    <span class="nd">@Query</span><span class="o">(</span><span class="s">&quot;SELECT a FROM Account a WHERE :createdDateFrom &lt;= a.createdDate AND a.createdDate &lt; :createdDateTo&quot;</span><span class="o">)</span>
    <span class="n">Page</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="nf">findByCreatedDate</span><span class="o">(</span>
            <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;createdDateFrom&quot;</span><span class="o">)</span> <span class="n">Date</span> <span class="n">createdDateFrom</span><span class="o">,</span>
            <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;createdDateTo&quot;</span><span class="o">)</span> <span class="n">Date</span> <span class="n">createdDateTo</span><span class="o">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数として <code class="docutils literal"><span class="pre">org.springframework.data.domain.Pageable</span></code> インタフェースを受け取り、 <code class="docutils literal"><span class="pre">org.springframework.data.domain.Page</span></code> インタフェースを返却するQueryメソッドを定義する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Controller</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;list&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">list</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;targetDate&quot;</span><span class="o">)</span> <span class="n">Date</span> <span class="n">targetDate</span><span class="o">,</span>
                   <span class="nd">@PageableDefault</span><span class="o">(</span>
                       <span class="n">page</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span>
                       <span class="n">value</span> <span class="o">=</span> <span class="mi">5</span><span class="o">,</span>
                       <span class="n">sort</span> <span class="o">=</span> <span class="o">{</span> <span class="s">&quot;createdDate&quot;</span> <span class="o">},</span>
                       <span class="n">direction</span> <span class="o">=</span> <span class="n">Direction</span><span class="o">.</span><span class="na">DESC</span><span class="o">)</span>
                       <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">,</span> <span class="c1">// (2)</span>
                   <span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Page</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">accountPage</span> <span class="o">=</span> <span class="n">accountService</span><span class="o">.</span><span class="na">getAccounts</span><span class="o">(</span><span class="n">targetDate</span><span class="o">,</span> <span class="n">pageable</span><span class="o">);</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;accountPage&quot;</span><span class="o">,</span> <span class="n">accountPage</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">&quot;account/list&quot;</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring Dataより提供されているページング検索用のオブジェクト（  <code class="docutils literal"><span class="pre">org.springframework.data.domain.Pageable</span></code> ）を生成する。</div>
<div class="line">詳細は「<a class="reference internal" href="../WebApplicationDetail/Pagination.html"><span class="doc">ページネーション</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Service</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Page</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="nf">getAccounts</span><span class="o">(</span><span class="n">Date</span> <span class="n">targetDate</span> <span class="o">,</span><span class="n">Pageable</span> <span class="n">pageable</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">LocalDate</span> <span class="n">targetLocalDate</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LocalDate</span><span class="o">(</span><span class="n">targetDate</span><span class="o">);</span>
    <span class="n">Date</span> <span class="n">fromDate</span> <span class="o">=</span> <span class="n">targetLocalDate</span><span class="o">.</span><span class="na">toDate</span><span class="o">();</span>
    <span class="n">Date</span> <span class="n">toDate</span> <span class="o">=</span> <span class="n">targetLocalDate</span><span class="o">.</span><span class="na">dayOfYear</span><span class="o">().</span><span class="na">addToCopy</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="na">toDate</span><span class="o">();</span>

    <span class="c1">// (3)</span>
    <span class="n">Page</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">accountRepository</span><span class="o">.</span><span class="na">findByCreatedDate</span><span class="o">(</span><span class="n">fromDate</span><span class="o">,</span>
            <span class="n">toDate</span><span class="o">,</span> <span class="n">pageable</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">page</span><span class="o">.</span><span class="na">hasContent</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// (4)</span>
        <span class="c1">// ...</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">page</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Repositryインタフェースに実装したQueryメソッドを呼び出す。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">検索結果が0件の場合は、<code class="docutils literal"><span class="pre">Page</span></code> オブジェクトに空のリストが設定され、 <code class="docutils literal"><span class="pre">Page#hasContent()</span></code> メソッドの返り値が <code class="docutils literal"><span class="pre">false</span></code> になる。</div>
<div class="line">必要に応じて、検索結果が0件の場合の処理を実装する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id20">
<h3><a class="toc-backref" href="#id91">6.3.2.7. Entityの動的条件による検索処理の実装</a><a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h3>
<p>動的条件によるEntityの検索を行うQueryメソッドをRepositoryメソッドに追加する場合は、 Entity毎のRepositoryインタフェースに対して、
カスタムRepositoryインタフェースとカスタムRepositoryインタフェースの実装クラスを用意する方法で実装する。
カスタムRepositoryインタフェースとカスタムRepositoryクラスの作成方法については、「<a class="reference internal" href="#custommethod-individual-label"><span class="std std-ref">Entity毎のRepositoryインタフェースに個別に追加する</span></a>」を参照されたい。</p>
<p>以降では、動的条件を適用してEntityを検索する方法について、目的別に説明する。</p>
<div class="admonition-todo admonition" id="index-2">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p>今後、以下の内容を追加する予定である。</p>
<ul class="last simple">
<li>QueryDSLを使用した動的Queryの実装例。</li>
</ul>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="id21">
<h4><a class="toc-backref" href="#id92">6.3.2.7.1. 動的条件に一致するEntityを全件検索</a><a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h4>
<p>動的条件に一致するEntityを全件取得するQueryメソッドを実装し、呼び出す。</p>
<p>以下の実装例を示す。</p>
<p>実装例では、動的条件として、</p>
<ul class="simple">
<li>注文ID</li>
<li>商品名</li>
<li>注文状態(複数指定可能)</li>
</ul>
<p>を指定可能とし、指定された条件に一致する注文をAND条件で絞り込む検索とする。
なお、条件の指定がない場合は、検索は行わず空のリストを返却する。</p>
<ul class="simple">
<li>Criteria (JavaBean)</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderCriteria</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span> <span class="c1">// (1)</span>

    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">itemName</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">statusCodes</span><span class="o">;</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">検索条件を保持するCriteriaオブジェクト(JavaBean)を作成する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>カスタムRepositoryインタフェース</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderRepositoryCustom</span> <span class="o">{</span>

    <span class="n">Page</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findAllByCriteria</span><span class="o">(</span><span class="n">OrderCriteria</span> <span class="n">criteria</span><span class="o">);</span> <span class="c1">// (2)</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">カスタムRepositoryインタフェースに、Criteriaオブジェクトを引数にとり、Listを返却するメソッドを定義する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>カスタムRepositoryクラス</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderRepositoryImpl</span> <span class="kd">implements</span> <span class="n">OrderRepositoryCustom</span> <span class="o">{</span> <span class="c1">// (3)</span>

    <span class="nd">@PersistenceContext</span>
    <span class="n">EntityManager</span> <span class="n">entityManager</span><span class="o">;</span> <span class="c1">// (4)</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findAllByCriteria</span><span class="o">(</span><span class="n">OrderCriteria</span> <span class="n">criteria</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (5)</span>

        <span class="c1">// Collect dynamic conditions.</span>
        <span class="c1">// (6)</span>
        <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">andConditions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
        <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">joinConditions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
        <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">bindParameters</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>

        <span class="c1">// (7)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">criteria</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">andConditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;o.id = :id&quot;</span><span class="o">);</span>
            <span class="n">bindParameters</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="n">criteria</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">CollectionUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">criteria</span><span class="o">.</span><span class="na">getStatusCodes</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">andConditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;o.status.code IN :statusCodes&quot;</span><span class="o">);</span>
            <span class="n">bindParameters</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;statusCodes&quot;</span><span class="o">,</span> <span class="n">criteria</span><span class="o">.</span><span class="na">getStatusCodes</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">hasLength</span><span class="o">(</span><span class="n">criteria</span><span class="o">.</span><span class="na">getItemName</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">joinConditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;o.orderItems oi&quot;</span><span class="o">);</span>
            <span class="n">joinConditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;oi.item i&quot;</span><span class="o">);</span>
            <span class="n">andConditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;i.name LIKE :itemName ESCAPE &#39;~&#39;&quot;</span><span class="o">);</span>
            <span class="n">bindParameters</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;itemName&quot;</span><span class="o">,</span> <span class="n">QueryEscapeUtils</span>
                    <span class="o">.</span><span class="na">toLikeCondition</span><span class="o">(</span><span class="n">criteria</span><span class="o">.</span><span class="na">getItemName</span><span class="o">()));</span>
        <span class="o">}</span>

        <span class="c1">// (8)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">andConditions</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="c1">// (9)</span>
        <span class="c1">// Create dynamic query.</span>
        <span class="kd">final</span> <span class="n">StringBuilder</span> <span class="n">queryString</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>

        <span class="c1">// (10)</span>
        <span class="n">queryString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;SELECT o FROM Order o&quot;</span><span class="o">);</span>

        <span class="c1">// (11)</span>
        <span class="c1">// add join conditions.</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">joinCondition</span> <span class="o">:</span> <span class="n">joinConditions</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">queryString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot; LEFT JOIN &quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">joinCondition</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// add conditions.</span>
        <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">andConditionsIt</span> <span class="o">=</span> <span class="n">andConditions</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">andConditionsIt</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">queryString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot; WHERE &quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">andConditionsIt</span><span class="o">.</span><span class="na">next</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">andConditionsIt</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">queryString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot; AND &quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">andConditionsIt</span><span class="o">.</span><span class="na">next</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="c1">// (12)</span>
        <span class="c1">// add order by condition.</span>
        <span class="n">queryString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot; ORDER BY o.id&quot;</span><span class="o">);</span>

        <span class="c1">// (13)</span>
        <span class="c1">// Create typed query.</span>
        <span class="kd">final</span> <span class="n">TypedQuery</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">findQuery</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span>
                <span class="n">queryString</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">Order</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">// Bind parameters.</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">bindParameter</span> <span class="o">:</span> <span class="n">bindParameters</span>
                <span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">findQuery</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="n">bindParameter</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">bindParameter</span>
                    <span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="c1">// (14)</span>
        <span class="c1">// Execute query.</span>
        <span class="k">return</span> <span class="n">findQuery</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>

    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">カスタムRepositoryインタフェースの実装クラスを作成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">EntityManager</span></code> をInjectする。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;javax.persistence.PersistenceContext</span></code> アノテーションを使用してInjectすること。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">動的条件に一致するEntityを全件取得するQueryメソッドを実装する。</div>
<div class="line">上記実装例では説明のためにメソッド分割はしていないが、必要に応じてメソッド分割すること。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">動的クエリを組み立てるための変数（AND条件用リスト、結合条件用リスト、バインドパラメータ用マップ）を定義している。</div>
<div class="line">OrderCriteriaオブジェクトに条件の指定があるものについて、これらの変数に必要な情報を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OrderCriteriaオブジェクトに条件の指定があるか判定し、動的クエリを組み立てるために必要な情報を設定していく。</div>
<div class="line">上記例では、<code class="docutils literal"><span class="pre">id</span></code> は指定した値と完全一致するもの、 <code class="docutils literal"><span class="pre">statusCodes</span></code> は指定したリストに含まれるもの、 <code class="docutils literal"><span class="pre">itemName</span></code> は指定した値と前方一致するものを取得対象とするための情報を設定している。</div>
<div class="line"><code class="docutils literal"><span class="pre">itemName</span></code> については、比較対象の値を保持する関連Entityが複雑なネスト関係になっているため、関連EntityをJOINする必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">上記実装例では条件が指定されていない場合は、検索する必要がないため、空のリストを返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">条件が指定されている場合は、Entityを検索するためのQueryを組み立てる。</div>
<div class="line">上記例では実行するQueryを <code class="docutils literal"><span class="pre">java.lang.StringBuilder</span></code> クラスを使って組み立てる実装例となっている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">静的なQuery要素を組み立てる。</div>
<div class="line">上記例では、SELECT句とFROM句は静的なQueryの構成要素として組み立てている。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">動的なQuery要素を組み立てる。</div>
<div class="line">上記例では、結合条件用リスト(JOIN句)とAND条件用リスト(WHERE句)に設定する条件を動的なQuery要素として組み立てている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">静的なQuery要素を組み立てる。</div>
<div class="line">上記例では、ORDER BY句は静的なQuery要素として組み立てている。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(13)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">動的に組み立てたQuery文字列を <code class="docutils literal"><span class="pre">javax.persistence.TypedQuery</span></code> に変換し、Query実行に必要なバインド用のパラメータを設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(14)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">動的に組み立てたQueryを実行し、条件に一致するEntityを全件取得する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Entity毎のRepositoryインタフェース</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;,</span>
                                <span class="n">OrderRepositoryCustom</span> <span class="o">{</span> <span class="c1">// (15)</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(15)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Entity毎のRepositoryインタフェースに、カスタムRepositoryインタフェースを継承する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Service (Caller)</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// condition values for sample.</span>
<span class="n">Integer</span> <span class="n">conditionValueOfId</span> <span class="o">=</span> <span class="mi">4</span><span class="o">;</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">conditionValueOfStatusCodes</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">&quot;accepted&quot;</span><span class="o">);</span>
<span class="n">String</span> <span class="n">conditionValueOfItemName</span> <span class="o">=</span> <span class="s">&quot;Wat&quot;</span><span class="o">;</span>

<span class="c1">// implementation of sample.</span>
<span class="c1">// (16)</span>
<span class="n">OrderCriteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OrderCriteria</span><span class="o">();</span>
<span class="n">criteria</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">conditionValueOfId</span><span class="o">);</span>
<span class="n">criteria</span><span class="o">.</span><span class="na">setStatusCodes</span><span class="o">(</span><span class="n">conditionValueOfStatusCodes</span><span class="o">);</span>
<span class="n">criteria</span><span class="o">.</span><span class="na">setItemName</span><span class="o">(</span><span class="n">conditionValueOfItemName</span><span class="o">);</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">orderRepository</span><span class="o">.</span><span class="na">findAllByCriteria</span><span class="o">(</span><span class="n">criteria</span><span class="o">);</span> <span class="c1">// (17)</span>
<span class="k">if</span> <span class="o">(</span><span class="n">orders</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// (18)</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(16)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OrderCriteriaオブジェクトに検索条件を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(17)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OrderCriteriaオブジェクトを引数として、動的条件に一致するEntityを全件取得するQueryメソッドを呼び出す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(18)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">必要に応じて検索結果を判定し、0件の場合の処理を行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>実行されるJPQL(SQL)</li>
</ul>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (19)</span>
<span class="c1">--   conditionValueOfId=4</span>
<span class="c1">--   conditionValueOfStatusCodes = [&quot;accepted&quot;]</span>
<span class="c1">--   conditionValueOfItemName = &quot;Wat&quot;</span>

<span class="c1">-- JPQL</span>
<span class="k">SELECT</span>
        <span class="n">o</span>
    <span class="k">FROM</span>
        <span class="k">ORDER</span> <span class="n">o</span>
            <span class="k">JOIN</span> <span class="n">o</span><span class="p">.</span><span class="n">orderItems</span> <span class="n">oi</span>
                <span class="k">JOIN</span> <span class="n">oi</span><span class="p">.</span><span class="n">item</span> <span class="n">i</span>
            <span class="k">WHERE</span>
                <span class="n">o</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="p">:</span><span class="n">id</span>
                <span class="k">AND</span> <span class="n">o</span><span class="p">.</span><span class="n">status</span><span class="p">.</span><span class="n">code</span> <span class="k">IN</span> <span class="p">:</span><span class="n">statusCodes</span>
                <span class="k">AND</span> <span class="n">i</span><span class="p">.</span><span class="n">name</span> <span class="k">LIKE</span> <span class="p">:</span><span class="n">itemName</span> <span class="k">ESCAPE</span> <span class="s1">&#39;~&#39;</span>
            <span class="k">ORDER</span> <span class="k">BY</span>
                <span class="n">o</span><span class="p">.</span><span class="n">id</span>

<span class="c1">-- SQL</span>
<span class="k">SELECT</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">id1_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">created_by</span> <span class="k">AS</span> <span class="n">created2_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">created_date</span> <span class="k">AS</span> <span class="n">created3_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">last_modified_by</span> <span class="k">AS</span> <span class="n">last4_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">last_modified_date</span> <span class="k">AS</span> <span class="n">last5_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="k">AS</span> <span class="n">status6_6_</span>
    <span class="k">FROM</span>
        <span class="n">t_order</span> <span class="n">order0_</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">t_order_item</span> <span class="n">orderitems1_</span>
            <span class="k">ON</span> <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">orderitems1_</span><span class="p">.</span><span class="n">order_id</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">m_item</span> <span class="n">item2_</span>
            <span class="k">ON</span> <span class="n">orderitems1_</span><span class="p">.</span><span class="n">item_code</span> <span class="o">=</span> <span class="n">item2_</span><span class="p">.</span><span class="n">code</span>
<span class="k">WHERE</span>
    <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">AND</span> <span class="p">(</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">&#39;accepted&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">AND</span> <span class="p">(</span>
        <span class="n">item2_</span><span class="p">.</span><span class="n">name</span> <span class="k">LIKE</span> <span class="s1">&#39;Wat%&#39;</span> <span class="k">ESCAPE</span> <span class="s1">&#39;~&#39;</span>
    <span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">order0_</span><span class="p">.</span><span class="n">id</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(19)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">すべての条件を指定した場合に発行されるJPQLとSQLの例。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (20)</span>
<span class="c1">--   conditionValueOfId=4</span>
<span class="c1">--   conditionValueOfStatusCodes = [&quot;accepted&quot;]</span>
<span class="c1">--   conditionValueOfItemName = &quot;&quot;</span>
<span class="c1">-- JPQL</span>
<span class="k">SELECT</span>
        <span class="n">o</span>
    <span class="k">FROM</span>
        <span class="k">ORDER</span> <span class="n">o</span>
    <span class="k">WHERE</span>
        <span class="n">o</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="p">:</span><span class="n">id</span>
        <span class="k">AND</span> <span class="n">o</span><span class="p">.</span><span class="n">status</span><span class="p">.</span><span class="n">code</span> <span class="k">IN</span> <span class="p">:</span><span class="n">statusCodes</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="n">o</span><span class="p">.</span><span class="n">id</span>

<span class="c1">-- SQL</span>
<span class="k">SELECT</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">id1_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">created_by</span> <span class="k">AS</span> <span class="n">created2_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">created_date</span> <span class="k">AS</span> <span class="n">created3_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">last_modified_by</span> <span class="k">AS</span> <span class="n">last4_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">last_modified_date</span> <span class="k">AS</span> <span class="n">last5_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="k">AS</span> <span class="n">status6_6_</span>
    <span class="k">FROM</span>
        <span class="n">t_order</span> <span class="n">order0_</span>
    <span class="k">WHERE</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">AND</span> <span class="p">(</span>
            <span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">&#39;accepted&#39;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(20)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">iteName</span></code> 以外の条件を指定した場合に発行されるJPQLとSQLの例。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- (21)</span>
<span class="c1">--   conditionValueOfId=4</span>
<span class="c1">--   conditionValueOfStatusCodes = []</span>
<span class="c1">--   conditionValueOfItemName = &quot;&quot;</span>
<span class="c1">-- JPQL</span>
<span class="k">SELECT</span>
        <span class="n">o</span>
    <span class="k">FROM</span>
        <span class="k">ORDER</span> <span class="n">o</span>
    <span class="k">WHERE</span>
        <span class="n">o</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="p">:</span><span class="n">id</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="n">o</span><span class="p">.</span><span class="n">id</span>

<span class="c1">-- SQL</span>
<span class="k">SELECT</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">id1_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">created_by</span> <span class="k">AS</span> <span class="n">created2_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">created_date</span> <span class="k">AS</span> <span class="n">created3_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">last_modified_by</span> <span class="k">AS</span> <span class="n">last4_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">last_modified_date</span> <span class="k">AS</span> <span class="n">last5_6_</span>
        <span class="p">,</span><span class="n">order0_</span><span class="p">.</span><span class="n">status_code</span> <span class="k">AS</span> <span class="n">status6_6_</span>
    <span class="k">FROM</span>
        <span class="n">t_order</span> <span class="n">order0_</span>
    <span class="k">WHERE</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(21)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">id</span></code> のみを指定した場合に発行されるJPQLとSQLの例。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id22">
<h4><a class="toc-backref" href="#id93">6.3.2.7.2. 動的条件に一致するEntityをページ検索</a><a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h4>
<p>動的条件に一致するEntityの中から指定ページに該当するEntityを取得するQueryメソッドを実装し、呼び出す。</p>
<p>以下に実装例を示すが、該当ページを取得する箇所以外は、全件取得する場合と同じ仕様とする。
なお、全件取得で説明した箇所の説明は省略する。</p>
<ul class="simple">
<li>カスタムRepositoryインタフェース</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderRepositoryCustom</span> <span class="o">{</span>

    <span class="n">Page</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findPageByCriteria</span><span class="o">(</span><span class="n">OrderCriteria</span> <span class="n">criteria</span><span class="o">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">);</span> <span class="c1">// (1)</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">動的条件に一致するEntityの中から指定ページに該当するEntityを取得するQueryメソッドを定義する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>カスタムRepositoryクラス</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderRepositoryCustomImpl</span> <span class="kd">implements</span> <span class="n">OrderRepositoryCustom</span> <span class="o">{</span>

    <span class="nd">@PersistenceContext</span>
    <span class="n">EntityManager</span> <span class="n">entityManager</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">Page</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findPageByCriteria</span><span class="o">(</span><span class="n">OrderCriteria</span> <span class="n">criteria</span><span class="o">,</span>
            <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (2)</span>

        <span class="c1">// collect dynamic conditions.</span>
        <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">andConditions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
        <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">joinConditions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
        <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">bindParameters</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">criteria</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">andConditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;o.id = :id&quot;</span><span class="o">);</span>
            <span class="n">bindParameters</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="n">criteria</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">CollectionUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">criteria</span><span class="o">.</span><span class="na">getStatusCodes</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">andConditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;o.status.code IN :statusCodes&quot;</span><span class="o">);</span>
            <span class="n">bindParameters</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;statusCodes&quot;</span><span class="o">,</span> <span class="n">criteria</span><span class="o">.</span><span class="na">getStatusCodes</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">hasLength</span><span class="o">(</span><span class="n">criteria</span><span class="o">.</span><span class="na">getItemName</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">joinConditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;o.orderItems oi&quot;</span><span class="o">);</span>
            <span class="n">joinConditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;oi.item i&quot;</span><span class="o">);</span>
            <span class="n">andConditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;i.name LIKE :itemName ESCAPE &#39;~&#39;&quot;</span><span class="o">);</span>
            <span class="n">bindParameters</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;itemName&quot;</span><span class="o">,</span> <span class="n">QueryEscapeUtils</span><span class="o">.</span><span class="na">toLikeCondition</span><span class="o">(</span><span class="n">criteria</span>
                    <span class="o">.</span><span class="na">getItemName</span><span class="o">()));</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">andConditions</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">PageImpl</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;(</span><span class="n">orders</span><span class="o">,</span> <span class="n">pageable</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span> <span class="c1">// (3)</span>
        <span class="o">}</span>

        <span class="c1">// create dynamic query.</span>
        <span class="kd">final</span> <span class="n">StringBuilder</span> <span class="n">queryString</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
        <span class="kd">final</span> <span class="n">StringBuilder</span> <span class="n">countQueryString</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span> <span class="c1">// (4)</span>
        <span class="kd">final</span> <span class="n">StringBuilder</span> <span class="n">conditionsString</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span> <span class="c1">// (4)</span>

        <span class="n">queryString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;SELECT o FROM Order o&quot;</span><span class="o">);</span>
        <span class="n">countQueryString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;SELECT COUNT(o) FROM Order o&quot;</span><span class="o">);</span> <span class="c1">// (5)</span>

        <span class="c1">// add join conditions.</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">joinCondition</span> <span class="o">:</span> <span class="n">joinConditions</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">conditionsString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot; JOIN &quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">joinCondition</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// add conditions.</span>
        <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">andConditionsIt</span> <span class="o">=</span> <span class="n">andConditions</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">andConditionsIt</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">conditionsString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot; WHERE &quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">andConditionsIt</span><span class="o">.</span><span class="na">next</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">andConditionsIt</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">conditionsString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot; AND &quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">andConditionsIt</span><span class="o">.</span><span class="na">next</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="n">queryString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">conditionsString</span><span class="o">);</span> <span class="c1">// (6)</span>
        <span class="n">countQueryString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">conditionsString</span><span class="o">);</span> <span class="c1">// (6)</span>

        <span class="c1">// add order by condition.</span>
        <span class="c1">// (7)</span>
        <span class="n">String</span> <span class="n">orderByString</span> <span class="o">=</span> <span class="n">QueryUtils</span><span class="o">.</span><span class="na">applySorting</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">,</span> <span class="n">pageable</span><span class="o">.</span><span class="na">getSort</span><span class="o">(),</span> <span class="s">&quot;o&quot;</span><span class="o">);</span>
        <span class="n">queryString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">orderByString</span><span class="o">);</span>

        <span class="c1">// create typed query.</span>
        <span class="kd">final</span> <span class="n">TypedQuery</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">countQuery</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span>
                <span class="n">countQueryString</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">Long</span><span class="o">.</span><span class="na">class</span><span class="o">);</span> <span class="c1">// (8)</span>

        <span class="kd">final</span> <span class="n">TypedQuery</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">findQuery</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span>
                <span class="n">queryString</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">Order</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="c1">// bind parameters.</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">bindParameter</span> <span class="o">:</span> <span class="n">bindParameters</span>
                <span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">countQuery</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="n">bindParameter</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">bindParameter</span>
                    <span class="o">.</span><span class="na">getValue</span><span class="o">());</span> <span class="c1">// (8)</span>
            <span class="n">findQuery</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="n">bindParameter</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">bindParameter</span>
                    <span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="kt">long</span> <span class="n">total</span> <span class="o">=</span> <span class="n">countQuery</span><span class="o">.</span><span class="na">getSingleResult</span><span class="o">().</span><span class="na">longValue</span><span class="o">();</span> <span class="c1">// (9)</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">orders</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">total</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (10)</span>
            <span class="n">findQuery</span><span class="o">.</span><span class="na">setFirstResult</span><span class="o">(</span><span class="n">pageable</span><span class="o">.</span><span class="na">getOffset</span><span class="o">());</span>
            <span class="n">findQuery</span><span class="o">.</span><span class="na">setMaxResults</span><span class="o">(</span><span class="n">pageable</span><span class="o">.</span><span class="na">getPageSize</span><span class="o">());</span>
            <span class="c1">// execute query.</span>
            <span class="n">orders</span> <span class="o">=</span> <span class="n">findQuery</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span> <span class="c1">// (11)</span>
            <span class="n">orders</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="k">new</span> <span class="n">PageImpl</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;(</span><span class="n">orders</span><span class="o">,</span> <span class="n">pageable</span><span class="o">,</span> <span class="n">total</span><span class="o">);</span> <span class="c1">// (12)</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">動的条件に一致するEntityの中から指定ページに該当するEntityを取得するQueryメソッドを実装する。</div>
<div class="line">上記実装例では説明のためにメソッド分割はしていないが、必要に応じてメソッド分割すること。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">上記実装例では条件が指定されていない場合は、検索する必要がないため、空のページ情報を返却する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">件数取得用のQueryを組み立てるための変数と、条件(結合条件とAND条件)を組み立てるための変数を用意する。</div>
<div class="line">Entity取得用のQueryと件数取得用のQueryで同じ条件を使用する必要があるため、条件(結合条件とAND条件)を組み立てるための変数を用意している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">件数取得用Queryの静的なQuery要素を組み立てる。</div>
<div class="line">上記例では、SELECT句とFROM句は静的なQueryの構成要素として組み立てている。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Entity取得用Queryと件数取得用Queryの動的なQuery要素を組み立てる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Entity取得用Queryに対してソート条件(ORDER BY句)を動的なQuery要素として組み立てている。</div>
<div class="line">ORDER BY句の組み立ては、 Spring Data JPAから提供されているユーティリティ部品( <code class="docutils literal"><span class="pre">org.springframework.data.jpa.repository.query.QueryUtils</span></code> )を使用している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">動的に組み立てた件数取得用のQuery文字列を <code class="docutils literal"><span class="pre">javax.persistence.TypedQuery</span></code> に変換し、Query実行に必要なバインド用のパラメータを設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">件数取得用のQueryを実行し、条件に一致する合計件数を取得する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">条件に一致するEntityが存在する場合は、Entity取得用Queryを実行し、該当ページの情報を取得する。</div>
<div class="line">Entity取得用Queryを実行する際は、取得開始位置( <code class="docutils literal"><span class="pre">TypedQuery#setFirstResult</span></code> )と取得件数( <code class="docutils literal"><span class="pre">TypedQuery#setMaxResults</span></code> )を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">条件に一致するEntityが存在しない場合は、空のリストを取得結果とする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">該当ページのEntityのリスト、ページ情報、条件に条件した合計件数を引数に指定して、 <code class="docutils literal"><span class="pre">Page</span></code> オブジェクトを生成し返却する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Service (Caller)</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// condition values for sample.</span>
<span class="n">Integer</span> <span class="n">conditionValueOfId</span> <span class="o">=</span> <span class="mi">4</span><span class="o">;</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">conditionValueOfStatusCodes</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">&quot;accepted&quot;</span><span class="o">);</span>
<span class="n">String</span> <span class="n">conditionValueOfItemName</span> <span class="o">=</span> <span class="s">&quot;Wat&quot;</span><span class="o">;</span>

<span class="c1">// implementation of sample.</span>
<span class="n">OrderCriteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OrderCriteria</span><span class="o">();</span>
<span class="n">criteria</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">conditionValueOfId</span><span class="o">);</span>
<span class="n">criteria</span><span class="o">.</span><span class="na">setStatusCodes</span><span class="o">(</span><span class="n">conditionValueOfStatusCodes</span><span class="o">);</span>
<span class="n">criteria</span><span class="o">.</span><span class="na">setItemName</span><span class="o">(</span><span class="n">conditionValueOfItemName</span><span class="o">);</span>
<span class="n">Page</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">orderPage</span> <span class="o">=</span> <span class="n">orderRepository</span><span class="o">.</span><span class="na">findPageByCriteria</span><span class="o">(</span><span class="n">criteria</span><span class="o">,</span>
        <span class="n">pageable</span><span class="o">);</span> <span class="c1">// (13)</span>
<span class="k">if</span> <span class="o">(!</span><span class="n">orderPage</span><span class="o">.</span><span class="na">hasContent</span><span class="o">())</span> <span class="o">{</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(13)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">動的条件に一致するEntityの中から指定ページに該当するEntityを取得するQueryメソッドを呼び出す。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id23">
<h3><a class="toc-backref" href="#id94">6.3.2.8. Entityの取得処理の実装</a><a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h3>
<p>Entityの取得方法について、目的別に説明する。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="identity1">
<h4><a class="toc-backref" href="#id95">6.3.2.8.1. IDを指定してEntityを1件取得</a><a class="headerlink" href="#identity1" title="Permalink to this headline">¶</a></h4>
<p>ID(Primary Key)がわかっている場合は、RepositryインタフェースのfindOneメソッドを呼び出してEntityオブジェクトを取得する。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Account</span> <span class="nf">getAccount</span><span class="o">(</span><span class="n">String</span> <span class="n">accountUuid</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">accountRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">accountUuid</span><span class="o">);</span> <span class="c1">// (1)</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">account</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (2)</span>
        <span class="c1">// ...</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">account</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">EntityのID(Primary Key)を指定して、RepositryインタフェースのfindOne(ID)メソッドを呼び出す。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">指定したIDのEntityが存在しない場合は、返却値がnullになるので、null判定が必要となる。</div>
<div class="line">必要に応じて、指定したIDのEntityが存在しない場合の処理を実装する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>返却されるEntityオブジェクトについて</strong></p>
<p class="last">指定したIDのEntityオブジェクトが、既に <code class="docutils literal"><span class="pre">EntityManager</span></code> 上で管理されている場合は、永続層(DB)へのアクセスは行われずに、
<code class="docutils literal"><span class="pre">EntityManager</span></code> 上で管理されているEntityオブジェクトが返却される。
そのため、 findOneメソッドを使用すると、永続層への無駄なアクセスを抑えることが出来る。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>関連Entityのロードタイミングについて</strong></p>
<p>Query実行時の関連Entityのロードは、Entityの関連付けアノテーション( <code class="docutils literal"><span class="pre">&#64;javax.persistence.OneToOne</span></code> 、 <code class="docutils literal"><span class="pre">&#64;javax.persistence.OneToMany</span></code> 、 <code class="docutils literal"><span class="pre">&#64;javax.persistence.ManyToOne</span></code> 、 <code class="docutils literal"><span class="pre">&#64;javax.persistence.ManyToMany</span></code> )の
fetch属性に指定されている値によって決定される。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">javax.persistence.FetchType#LAZY</span></code> の場合は、JOIN FETCH対象からはずれるため、関連Entityのロードは初回アクセス時に行われる。</li>
<li><code class="docutils literal"><span class="pre">javax.persistence.FetchType#EAGER</span></code> の場合は、 JOIN FETCHされるため、関連Entityがロードされる。</li>
</ul>
<p>fetch属性のデフォルトはアノテーションによって異なる。デフォルト値は以下の通り。</p>
<ul class="last simple">
<li><code class="docutils literal"><span class="pre">&#64;OneToOne</span></code> アノテーション : <code class="docutils literal"><span class="pre">EAGER</span></code></li>
<li><code class="docutils literal"><span class="pre">&#64;ManyToOne</span></code> アノテーション : <code class="docutils literal"><span class="pre">EAGER</span></code></li>
<li><code class="docutils literal"><span class="pre">&#64;OneToMany</span></code> アノテーション : <code class="docutils literal"><span class="pre">LAZY</span></code></li>
<li><code class="docutils literal"><span class="pre">&#64;ManyToMany</span></code> アノテーション : <code class="docutils literal"><span class="pre">LAZY</span></code></li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>1:N(N:M)の関連をもつ関連Entityの並び順について</strong></p>
<p class="last">関連Entityのプロパティのアノテーションに、 <code class="docutils literal"><span class="pre">&#64;javax.persistence.OrderBy</span></code> アノテーションを指定して制御する。</p>
</div>
<p>例を以下に示す。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">&quot;order&quot;</span><span class="o">,</span> <span class="n">cascade</span> <span class="o">=</span> <span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span> <span class="n">orphanRemoval</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="nd">@OrderBy</span> <span class="c1">// (1)</span>
<span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">OrderItem</span><span class="o">&gt;</span> <span class="n">orderItems</span><span class="o">;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">value属性を指定しない場合は、 IDの昇順となる。</div>
<div class="line">詳細は、 <a class="reference external" href="http://download.oracle.com/otn-pub/jcp/persistence-2_1-fr-eval-spec/JavaPersistence.pdf">JSR 338: Java Persistence API, Version 2.1のSpecification(PDF)「11.1.42 OrderBy Annotation」</a></div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition-todo admonition" id="index-3">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p>今後、以下の内容を追加する予定である。</p>
<ul class="last simple">
<li>fetch属性をデフォルト値から変更した方がよいケースの例。</li>
</ul>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id24">
<h4><a class="toc-backref" href="#id96">6.3.2.8.2. ID以外の条件を指定してEntityを1件取得</a><a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h4>
<p>IDがわからない場合は、ID以外の条件でEntityを検索するQueryメソッドを呼び出す。</p>
<ul class="simple">
<li>Repositroyインタフェース</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AccountRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="c1">// (1)</span>
    <span class="nd">@Query</span><span class="o">(</span><span class="s">&quot;SELECT a FROM Account a WHERE a.accountId = :accountId&quot;</span><span class="o">)</span>
    <span class="n">Account</span> <span class="nf">findByAccountId</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;accountId&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">accountId</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ID以外の項目を条件として、Entityを1件検索するQueryメソッドを定義する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Service</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Account</span> <span class="nf">getAccount</span><span class="o">(</span><span class="n">String</span> <span class="n">accountId</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">accountRepository</span><span class="o">.</span><span class="na">findByAccountId</span><span class="o">(</span><span class="n">accountId</span><span class="o">);</span> <span class="c1">// (2)</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">account</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (3)</span>
        <span class="c1">// ...</span>
    <span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Repositryインタフェースに実装したQueryメソッドを呼び出す。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">RepositryインタフェースのfindOneメソッドと同様に、条件に一致するEntityが存在しない場合は、返却値がnullになるので、null判定が必要となる。</div>
<div class="line">必要に応じて、指定した条件に一致するEntityが存在しない場合の処理を実装する。</div>
<div class="line">条件に一致するEntityが複数存在した場合は、 <code class="docutils literal"><span class="pre">org.springframework.dao.IncorrectResultSizeDataAccessException</span></code> が発生する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>返却されるEntityオブジェクトについて</strong></p>
<p class="last">Queryメソッドを呼び出した場合、必ず永続層(DB)に対してQueryが実行される。
ただし、Queryを実行して取得されたEntityが既に <code class="docutils literal"><span class="pre">EntityManager</span></code> 上で管理されている場合は、 Queryを実行して取得されたEntityオブジェクトは破棄され、 <code class="docutils literal"><span class="pre">EntityManager</span></code>
上で管理されているEntityオブジェクトが返却される。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>ID + α を条件とするQueryメソッドについて</strong></p>
<p>ID + α を条件とするQueryメソッドは、原則作成しないようにすることを推奨する。
このケースは、 findOneメソッドを呼び出して取得したEntityオブジェクトのプロパティ値を比較するロジックを組むことで、同じことが実現できる。</p>
<p>原則作成しないことを推奨する理由は、Queryを実行して取得されたEntityオブジェクトが破棄される可能性があり、無駄なQueryの実行となってしまうためである。
IDがわかっているのであれば、 無駄なQueryの実行が行われないfindOneメソッドを使用した方がよい。
特に、性能要件が高いアプリケーションの場合は、意識して実装すること。</p>
<p>ただし、以下の条件に当てはまる場合は、Queryメソッドを使用した方がQueryの実行回数が少なくなる事もあるので、その場合はQueryメソッドを使用してもよい。</p>
<ul class="last simple">
<li>+ α の条件の部分に関連オブジェクトのプロパティ(関連テーブルのカラム)が含まれる。</li>
<li>条件となる関連EntityへのFetchTypeに <code class="docutils literal"><span class="pre">LAZY</span></code> が含まれる。</li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>関連Entityのロードタイミングについて</strong></p>
<p>JOIN FETCHに指定された関連Entityは、Query実行直後にロードされる。</p>
<p>JOIN FETCHに指定がない関連Entityは、関連付けアノテーション( <code class="docutils literal"><span class="pre">&#64;OneToOne</span></code> 、 <code class="docutils literal"><span class="pre">&#64;OneToMany</span></code> 、 <code class="docutils literal"><span class="pre">&#64;ManyToOne</span></code> 、 <code class="docutils literal"><span class="pre">&#64;ManyToMany</span></code> )の
fetch属性に指定されている値によって以下の動作になる。</p>
<ul class="last simple">
<li><code class="docutils literal"><span class="pre">javax.persistence.FetchType#LAZY</span></code> の場合は、Lazy Load対象となり、関連Entityのロードは初回アクセス時に行われる。</li>
<li><code class="docutils literal"><span class="pre">javax.persistence.FetchType#EAGER</span></code> の場合は、 関連EntityをロードするためのQueryが実行され、関連Entityのオブジェクトがロードされる。</li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>1:N(N:M)の関連をもつ関連Entityの並び順について</p>
<ul class="last simple">
<li>JOIN FETCHに指定された関連Entityの並び順は、JPQLに”ORDER BY”句を指定して制御する。</li>
<li>Query実行後にロードされる関連Entityの並び順は、  関連Entityのプロパティのアノテーションに、 <code class="docutils literal"><span class="pre">&#64;javax.persistence.OrderBy</span></code> アノテーションを指定して制御する。</li>
</ul>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id25">
<h3><a class="toc-backref" href="#id97">6.3.2.9. Entityの追加処理の実装</a><a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h3>
<p>Entityの追加方法について、目的別に実装例を説明する。</p>
<div class="section" id="data-access-jpa-how-to-use-way-to-add-entity">
<span id="id26"></span><h4><a class="toc-backref" href="#id98">6.3.2.9.1. Entityの追加</a><a class="headerlink" href="#data-access-jpa-how-to-use-way-to-add-entity" title="Permalink to this headline">¶</a></h4>
<p>Entityを追加したい場合は、Entityオブジェクトを生成し、Repositryインタフェースのsaveメソッドを呼び出す。</p>
<ul class="simple">
<li>Service</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Order</span><span class="o">(</span><span class="s">&quot;accepted&quot;</span><span class="o">);</span> <span class="c1">// (1)</span>
<span class="n">order</span> <span class="o">=</span> <span class="n">orderRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">order</span><span class="o">);</span> <span class="c1">// (2)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Entityオブジェクトのインスタンスを生成し、必要なプロパティに値を設定する。</div>
<div class="line">上記例では、IDの設定はJPAのID採番機能を使用している。JPAのID採番機能を使用する場合は、アプリケーションコードでIDの設定は行ってはいけない。</div>
<div class="line">アプリケーションコードでIDを設定してしまうと、 <code class="docutils literal"><span class="pre">EntityManager</span></code> のmergeメソッドが呼び出されるため、不要な処理が実行されてしまう。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Repositoryインタフェースのsaveメソッドを呼び出し、(1)で生成したEntityオブジェクトを <code class="docutils literal"><span class="pre">EntityManager</span></code> の管理対象にする。</div>
<div class="line"><code class="docutils literal"><span class="pre">EntityManager</span></code> によって管理されるEntityオブジェクトは、saveメソッドの引数に渡したEntityオブジェクトではなく、saveメソッドから返却されたEntityオブジェクトになるので注意すること。</div>
<div class="line">IDは、このタイミングでJPAのID採番機能によって設定される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>mergeメソッドが呼び出されるデメリット</strong></p>
<p class="last"><code class="docutils literal"><span class="pre">EntityManager</span></code> のmergeメソッドは、Entityを <code class="docutils literal"><span class="pre">EntityManager</span></code> の管理対象にする際に、永続層(DB)から同じIDをもつEntityを取得する仕組みになっている。
Entityの追加処理としては、Entityの取得処理は無駄な処理となる。高い性能要件があるアプリケーションの場合は、IDの採番タイミングを意識すること。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>制約エラーのハンドリング</strong></p>
<p class="last">saveメソッドを呼び出したタイミングでは、永続層(DB)にQuery(INSERT)は実行されない。
そのため、一意制約違反などの制約系のエラーをハンドリングする必要がある場合は、Repositoryインタフェースのsaveメソッドではなく、
saveAndFlushメソッドまたはflushメソッドを呼び出す必要がある。</p>
</div>
</div></blockquote>
<ul class="simple">
<li>Entity</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Entity</span> <span class="c1">// (3)</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;t_order&quot;</span><span class="o">)</span> <span class="c1">// (4)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="c1">// (5)</span>
    <span class="nd">@SequenceGenerator</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GEN_ORDER_ID&quot;</span><span class="o">,</span> <span class="n">sequenceName</span> <span class="o">=</span> <span class="s">&quot;s_order_id&quot;</span><span class="o">,</span>
                       <span class="n">allocationSize</span> <span class="o">=</span> <span class="mi">1</span><span class="o">)</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">GenerationType</span><span class="o">.</span><span class="na">SEQUENCE</span><span class="o">,</span>
                    <span class="n">generator</span> <span class="o">=</span> <span class="s">&quot;GEN_ORDER_ID&quot;</span><span class="o">)</span>
    <span class="nd">@Id</span> <span class="c1">// (6)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>

    <span class="c1">// (7)</span>
    <span class="nd">@ManyToOne</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;status_code&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">OrderStatus</span> <span class="n">status</span><span class="o">;</span>

    <span class="c1">// ...</span>

    <span class="kd">public</span> <span class="nf">Order</span><span class="o">(</span><span class="n">String</span> <span class="n">statusCode</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">status</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OrderStatus</span><span class="o">(</span><span class="n">statusCode</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Entityクラスには <code class="docutils literal"><span class="pre">&#64;javax.persistence.Entity</span></code> アノテーションを付与する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Entityクラスとマッピングするテーブル名は <code class="docutils literal"><span class="pre">&#64;javax.persistence.Table</span></code> アノテーションのname属性に指定する。</div>
<div class="line">エンティティ名からテーブル名が解決できる場合は指定しなくてもよいが、解決できない場合は指定すること。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JPAのID採番機能を使用するために必要なアノテーションを指定している。</div>
<div class="line">JPAのID採番機能を使用する場合は、 <code class="docutils literal"><span class="pre">&#64;javax.persistence.GeneratedValue</span></code> アノテーションを指定する。</div>
<div class="line">シーケンスオブジェクトを使用する場合は、 <code class="docutils literal"><span class="pre">&#64;javax.persistence.SequenceGenerator</span></code> アノテーション、採番テーブルを使用する場合は、 <code class="docutils literal"><span class="pre">&#64;javax.persistence.TableGenerator</span></code> アノテーションの指定も必要となる。</div>
<div class="line">上記例では、 <code class="docutils literal"><span class="pre">s_order_id</span></code> という名前のシーケンスオブジェクトを使ってIDを採番している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">主キーを保持するプロパティに、 <code class="docutils literal"><span class="pre">&#64;javax.persistence.Id</span></code> アノテーションを付与する。</div>
<div class="line">複合キーの場合は、 <code class="docutils literal"><span class="pre">&#64;javax.persistence.EmbeddedId</span></code> アノテーションを付与する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">別のEntityとの関連を保持するプロパティに、 関連付けアノテーション( <code class="docutils literal"><span class="pre">&#64;OneToOne</span></code> 、 <code class="docutils literal"><span class="pre">&#64;OneToMany</span></code> 、 <code class="docutils literal"><span class="pre">&#64;ManyToOne</span></code> 、 <code class="docutils literal"><span class="pre">&#64;ManyToMany</span></code> )を付与する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>ID採番用のアノテーションについて</strong></p>
<p>各アノテーションの詳細は、<a class="reference external" href="http://download.oracle.com/otn-pub/jcp/persistence-2_1-fr-eval-spec/JavaPersistence.pdf">JSR 338: Java Persistence API, Version 2.1のSpecification(PDF)</a>を参照されたい。</p>
<ul class="last simple">
<li><code class="docutils literal"><span class="pre">&#64;GeneratedValue</span></code> : 11.1.20 GeneratedValue Annotation</li>
<li><code class="docutils literal"><span class="pre">&#64;SequenceGenerator</span></code> : 11.1.48 SequenceGenerator Annotation</li>
<li><code class="docutils literal"><span class="pre">&#64;TableGenerator</span></code> : 11.1.50 TableGenerator Annotation</li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>IDの採番方法について</strong></p>
<p>採番方法は、 <code class="docutils literal"><span class="pre">&#64;GeneratedValue</span></code> アノテーションのstrategy属性に <code class="docutils literal"><span class="pre">javax.persistence.GenerationType</span></code> 列挙の値を指定する。
指定可能な値は以下の通り。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">TABLE</span></code> : 永続層(DB)のテーブルを使用してIDを採番する。</li>
<li><code class="docutils literal"><span class="pre">SEQUENCE</span></code> : 永続層(DB)のシーケンスオブジェクトを使用してIDを採番する。</li>
<li><code class="docutils literal"><span class="pre">IDENTITY</span></code> : 永続層(DB)のidentity列を使用してIDを採番する。</li>
<li><code class="docutils literal"><span class="pre">AUTO</span></code> : 永続層(DB)に最も適切な採番方法を選択してIDを採番する。</li>
</ul>
<p class="last">原則 <code class="docutils literal"><span class="pre">AUTO</span></code> は使用せず、明示的に使用するタイプを指定することを推奨する。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="entityentity">
<h4><a class="toc-backref" href="#id99">6.3.2.9.2. Entityと関連Entityの追加</a><a class="headerlink" href="#entityentity" title="Permalink to this headline">¶</a></h4>
<p>Entityと関連Entityを一緒に追加したい場合は、Repositryインタフェースのsaveメソッドを呼び出してEntityオブジェクトを <code class="docutils literal"><span class="pre">EntityManager</span></code> の管理対象にした後に、
関連Entityのオブジェクトを生成し、Entityオブジェクトに関連づける。</p>
<p>この方法を使用するためには、関連EntityのCascade対象の操作に、<code class="docutils literal"><span class="pre">persist</span></code> が含まれている必要がある。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Cascade対象となった場合の挙動について</strong></p>
<p>関連EntityがCascade対象に指定されている場合、Entityに対するJPAの操作( <code class="docutils literal"><span class="pre">persist</span></code> , <code class="docutils literal"><span class="pre">merge</span></code> , <code class="docutils literal"><span class="pre">remove</span></code> , <code class="docutils literal"><span class="pre">refresh</span></code> , <code class="docutils literal"><span class="pre">detach</span></code> )
が関連Entityに対して、連鎖して行われる。</p>
<p>Spring Data JPAのRepositoryインタフェースの操作に対するマッピングは以下の通り。</p>
<ul class="simple">
<li>saveメソッド : <code class="docutils literal"><span class="pre">persist</span></code> or <code class="docutils literal"><span class="pre">merge</span></code></li>
<li>deleteメソッド : <code class="docutils literal"><span class="pre">remove</span></code></li>
</ul>
<p class="last"><code class="docutils literal"><span class="pre">refresh</span></code> , <code class="docutils literal"><span class="pre">detach</span></code> は Spring Data JPAのデフォルト実装で実行されることはない。</p>
</div>
</div></blockquote>
<ul class="simple">
<li>Service</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">itemCode</span> <span class="o">=</span> <span class="s">&quot;ITM0000001&quot;</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">itemQuantity</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
<span class="n">String</span> <span class="n">wayToPay</span> <span class="o">=</span> <span class="s">&quot;card&quot;</span><span class="o">;</span>

<span class="n">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Order</span><span class="o">(</span><span class="s">&quot;accepted&quot;</span><span class="o">);</span>
<span class="n">order</span> <span class="o">=</span> <span class="n">orderRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">order</span><span class="o">);</span> <span class="c1">// (1)</span>

<span class="n">OrderItem</span> <span class="n">orderItem</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OrderItem</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">itemCode</span><span class="o">,</span>
        <span class="n">itemQuantity</span><span class="o">);</span>
<span class="n">order</span><span class="o">.</span><span class="na">setOrderItems</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">singleton</span><span class="o">(</span><span class="n">orderItem</span><span class="o">));</span>    <span class="c1">// (2)</span>
<span class="n">order</span><span class="o">.</span><span class="na">setOrderPay</span><span class="o">(</span><span class="k">new</span> <span class="n">OrderPay</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">wayToPay</span><span class="o">));</span> <span class="c1">// (2)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Repositoryインタフェースのsaveメソッドを呼び出し、まずEntityオブジェクトを <code class="docutils literal"><span class="pre">EntityManager</span></code> の管理対象にする。</div>
<div class="line">上記例では、Entityオブジェクトに対して、関連Entityのオブジェクトを設定する前に、saveメソッドを呼び出している。これは、関連EntityのIDの一部として使用されるEntityのID(orderId)を採番する必要があるためである。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">EntityManager</span></code> の管理対象となっているEntityオブジェクトに対して、関連Entityのオブジェクトを設定する。</div>
<div class="line">トランザクションのコミット時に、Entityオブジェクトへのpersist操作(INSERT)が、関連Entityのオブジェクトに対して連鎖される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Entity</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;t_order&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="nd">@Id</span>
    <span class="nd">@SequenceGenerator</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GEN_ORDER_ID&quot;</span><span class="o">,</span> <span class="n">sequenceName</span> <span class="o">=</span> <span class="s">&quot;s_order_id&quot;</span><span class="o">,</span>
                       <span class="n">allocationSize</span> <span class="o">=</span> <span class="mi">1</span><span class="o">)</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">GenerationType</span><span class="o">.</span><span class="na">SEQUENCE</span><span class="o">,</span>
                    <span class="n">generator</span> <span class="o">=</span> <span class="s">&quot;GEN_ORDER_ID&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">&quot;order&quot;</span><span class="o">,</span> <span class="n">cascade</span> <span class="o">=</span> <span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span>  <span class="c1">// (3)</span>
               <span class="n">orphanRemoval</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="nd">@OrderBy</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">OrderItem</span><span class="o">&gt;</span> <span class="n">orderItems</span><span class="o">;</span>

    <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">&quot;order&quot;</span><span class="o">,</span> <span class="n">cascade</span> <span class="o">=</span> <span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span>
              <span class="n">orphanRemoval</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">OrderPay</span> <span class="n">orderPay</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;status_code&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">OrderStatus</span> <span class="n">status</span><span class="o">;</span>

    <span class="c1">// ...</span>

    <span class="kd">public</span> <span class="nf">Order</span><span class="o">(</span><span class="n">String</span> <span class="n">statusCode</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">status</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OrderStatus</span><span class="o">(</span><span class="n">statusCode</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">関連アノテーションのcascade属性に、Cascade対象にする操作のタイプ( <code class="docutils literal"><span class="pre">javax.persistence.CascadeType</span></code> )を指定する。</div>
<div class="line">上記例では、すべての操作を関連EntityのCascade対象としている。</div>
<div class="line">特に理由がない場合は、すべての操作をCascade対象にしておくことを推奨する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>cascade属性を指定してはいけない関連Entityについて</strong></p>
<p class="last">トランザクション系のEntityからコード系およびマスタ系のEntityに関連をもつ場合は、cascade属性は指定してはいけない。
上記例だと、<code class="docutils literal"><span class="pre">OrderStatus</span></code> はコード系のEntityになるので <code class="docutils literal"><span class="pre">Order</span></code> の <code class="docutils literal"><span class="pre">status</span></code> プロパティの <code class="docutils literal"><span class="pre">&#64;ManyToOne</span></code> アノテーションにcascade属性は指定してはいけない。</p>
</div>
</div></blockquote>
<ul class="simple">
<li>関連Entity</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;t_order_item&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderItem</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="nd">@EmbeddedId</span>
    <span class="kd">private</span> <span class="n">OrderItemPK</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">quantity</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;order_id&quot;</span><span class="o">,</span> <span class="n">insertable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">updatable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Order</span> <span class="n">order</span><span class="o">;</span>

    <span class="c1">// ...</span>

    <span class="kd">public</span> <span class="nf">OrderItem</span><span class="o">(</span><span class="n">Integer</span> <span class="n">orderId</span><span class="o">,</span> <span class="n">String</span> <span class="n">itemCode</span><span class="o">,</span> <span class="kt">int</span> <span class="n">quantity</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OrderItemPK</span><span class="o">(</span><span class="n">orderId</span><span class="o">,</span> <span class="n">itemCode</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">quantity</span> <span class="o">=</span> <span class="n">quantity</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// ...</span>

<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;t_order_pay&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderPay</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;order_id&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">orderId</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;way_to_pay&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">wayToPay</span><span class="o">;</span>

    <span class="nd">@OneToOne</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;order_id&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Order</span> <span class="n">order</span><span class="o">;</span>

    <span class="c1">// ...</span>

    <span class="kd">public</span> <span class="nf">OrderPay</span><span class="o">(</span><span class="kt">int</span> <span class="n">orderId</span><span class="o">,</span> <span class="n">String</span> <span class="n">wayToPay</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">orderId</span> <span class="o">=</span> <span class="n">orderId</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">wayToPay</span> <span class="o">=</span> <span class="n">wayToPay</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id28">
<h4><a class="toc-backref" href="#id100">6.3.2.9.3. 関連Entityの追加</a><a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h4>
<p>関連Entityを追加したい場合は、Repositoryインタフェース経由で取得したEntityオブジェクトに対して、生成した関連Entityのオブジェクトを関連付ける。</p>
<p>この方法を使用するためには、関連EntityのCascade対象の操作に、<code class="docutils literal"><span class="pre">persist</span></code> と <code class="docutils literal"><span class="pre">merge</span></code> が含まれている必要がある。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">itemCode</span> <span class="o">=</span> <span class="s">&quot;ITM0000003&quot;</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">quantity</span> <span class="o">=</span> <span class="mi">30</span><span class="o">;</span>

<span class="n">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">orderRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">orderId</span><span class="o">);</span> <span class="c1">// (1)</span>

<span class="n">OrderItem</span> <span class="n">orderItem</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OrderItem</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">itemCode</span><span class="o">,</span> <span class="n">quantity</span><span class="o">);</span>
<span class="n">order</span><span class="o">.</span><span class="na">getOrderItems</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">orderItem</span><span class="o">);</span> <span class="c1">// (2)</span>

<span class="n">OrderPay</span> <span class="n">orderPay</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="na">getOrderPay</span><span class="o">();</span>
<span class="k">if</span> <span class="o">(</span><span class="n">orderPay</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">order</span><span class="o">.</span><span class="na">setOrderPay</span><span class="o">(</span><span class="k">new</span> <span class="n">OrderPay</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="s">&quot;cash&quot;</span><span class="o">));</span> <span class="c1">// (3)</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">orderPay</span><span class="o">.</span><span class="na">setWayToPay</span><span class="o">(</span><span class="s">&quot;cash&quot;</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Repositoryインタフェースのメソッドを使用して、Entityオブジェクトを取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">1:Nの関連Entityの場合、生成した関連Entityのオブジェクトを、Entityオブジェクトから取得したコレクションに追加する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">1:1の関連Entityの場合、生成した関連EntityのオブジェクトをEntityオブジェクトに設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id29">
<h4><a class="toc-backref" href="#id101">6.3.2.9.4. 関連Entityの直接追加</a><a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h4>
<p>関連Entityを、親のEntityオブジェクトに関連付けせずに直接追加したい場合は、関連Entity用のRepositoryインタフェースを使用して保存する。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">itemCode</span> <span class="o">=</span> <span class="s">&quot;ITM0000003&quot;</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">quantity</span> <span class="o">=</span> <span class="mi">40</span><span class="o">;</span>

<span class="n">OrderItem</span> <span class="n">orderItem</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OrderItem</span><span class="o">(</span><span class="n">orderId</span><span class="o">,</span> <span class="n">itemCode</span><span class="o">,</span> <span class="n">quantity</span><span class="o">);</span> <span class="c1">// (1)</span>

<span class="n">orderItemRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">orderItem</span><span class="o">);</span> <span class="c1">// (2)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">関連Entityのオブジェクトを生成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">関連Entity用のRepositoryインタフェースのsaveメソッドを呼び出す。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>関連Entityを直接保存するメリット</strong></p>
<p class="last">生成されるオブジェクトの数が少なくなる。 親のEntityオブジェクトを取得する場合、処理に不要な関連Entityのオブジェクトが生成される可能性がある。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>関連Entityを直接保存するデメリット</strong></p>
<p class="last">IDの一部に親EntityのIDを使用している場合、saveメソッドを呼び出す前にIDを設定しておく必要がある。
IDを設定してしまうとSpring Data JPAのデフォルト実装は <code class="docutils literal"><span class="pre">EntityManager</span></code> のmergeメソッドを呼び出す。
そのため、必ず永続層(DB)からIDが同じEntityを取得する処理が実行されてしまう。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>追加後に親のEntityオブジェクトを利用する際の注意点</strong></p>
<p>関連Entity用Repositoryのsaveメソッドを使って関連Entity追加した場合は、
親にあたるEntityオブジェクトには関連付けられていないため、親のEntityオブジェクトを経由して取得することができない。</p>
<p>回避方法は、</p>
<ol class="arabic simple">
<li>関連Entityのオブジェクトを直接追加するのではなく、親のEntityオブジェクトに関連付けて追加するようにする。</li>
<li>saveAndFlushメソッドを使用することで、永続層(DB)と同期を親のEntityを取得する前に行う。</li>
</ol>
<p class="last">このケースの場合、特に理由がないのであれば、前者の方法で関連Entityのオブジェクトを追加すること。
後者は、親にあたるEntityオブジェクトが既に管理状態のEntityになっていた場合に、問題を回避することができない。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id30">
<h3><a class="toc-backref" href="#id102">6.3.2.10. Entityの更新処理の実装</a><a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h3>
<p>Entityの更新方法について、目的別に実装例を説明する。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="id31">
<h4><a class="toc-backref" href="#id103">6.3.2.10.1. Entityの更新</a><a class="headerlink" href="#id31" title="Permalink to this headline">¶</a></h4>
<p>Entityを更新したい場合は、Repositoryインタフェースのメソッドを使用して取得したEntityオブジェクトに対して、変更したい値を設定する。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">orderRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">orderId</span><span class="o">);</span> <span class="c1">// (1)</span>
<span class="n">order</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="k">new</span> <span class="n">OrderStatus</span><span class="o">(</span><span class="s">&quot;checking&quot;</span><span class="o">));</span> <span class="c1">// (2)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Repositoryインタフェースのメソッドを使用して、Entityオブジェクトを取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Entityオブジェクトの状態を、setterメソッドを呼び出して更新する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Repositoryのsaveメソッドの呼び出しについて</strong></p>
<p>Repositoryインタフェースのメソッドを使用して取得したEntityオブジェクトは、 <code class="docutils literal"><span class="pre">EntityManager</span></code> 上で管理されている。
<code class="docutils literal"><span class="pre">EntityManager</span></code> 上で管理されているEntityオブジェクトは、setterメソッドを使ってオブジェクトの状態を変更するだけで、
トランザクションコミット時に変更内容が永続層(DB)に反映される仕組みになっている。
そのため、Repositoryインタフェースのsaveメソッドを明示的に呼び出す必要はない。</p>
<p class="last">ただし、Entityオブジェクトが <code class="docutils literal"><span class="pre">EntityManager</span></code> 上で管理されていない場合は、 saveメソッドを呼び出す必要がある。
例えば、画面から送信されたリクエストパラメータをもとにEntityオブジェクトを生成した場合などが、このケースに当てはまる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id32">
<h4><a class="toc-backref" href="#id104">6.3.2.10.2. 関連Entityの更新</a><a class="headerlink" href="#id32" title="Permalink to this headline">¶</a></h4>
<p>関連Entityを更新したい場合は、Repositoryインタフェースのメソッドを使用して取得したEntityオブジェクトから取得した関連Entityのオブジェクトに対して、変更したい値を設定する。</p>
<p>この方法を使用するためには、関連EntityのCascade対象の操作に、<code class="docutils literal"><span class="pre">merge</span></code> が含まれている必要がある。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">orderRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">orderId</span><span class="o">);</span> <span class="c1">// (1)</span>

<span class="k">for</span> <span class="o">(</span><span class="n">OrderItem</span> <span class="n">orderItem</span> <span class="o">:</span> <span class="n">order</span><span class="o">.</span><span class="na">getOrderItems</span><span class="o">())</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">newQuantity</span> <span class="o">=</span> <span class="n">quantityMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">orderItem</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">getItemCode</span><span class="o">());</span>
    <span class="n">orderItem</span><span class="o">.</span><span class="na">setQuantity</span><span class="o">(</span><span class="n">newQuantity</span><span class="o">);</span> <span class="c1">// (2)</span>
<span class="o">}</span>

<span class="n">order</span><span class="o">.</span><span class="na">getOrderPay</span><span class="o">().</span><span class="na">setWayToPay</span><span class="o">(</span><span class="s">&quot;cash&quot;</span><span class="o">);</span> <span class="c1">// (3)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Repositoryインタフェースのメソッドを使用して、Entityオブジェクトを取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">1:Nの関連Entityの場合、Entityオブジェクトから取得したコレクションに格納されている関連Entityのオブジェクトの状態を、setterメソッドを呼び出して更新する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">1:1の関連Entityの場合、Entityオブジェクトから取得した関連Entityのオブジェクトの状態を、setterメソッドを呼び出して更新する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id33">
<h4><a class="toc-backref" href="#id105">6.3.2.10.3. 関連Entityの直接更新</a><a class="headerlink" href="#id33" title="Permalink to this headline">¶</a></h4>
<p>関連Entityを、親のEntityを使用せず直接更新したい場合は、関連Entity用のRepositoryインタフェースのメソッドを使用して取得したEntityオブジェクトに対して、変更したい値を設定する。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">quantity</span> <span class="o">=</span> <span class="mi">43</span><span class="o">;</span>

<span class="n">OrderItem</span> <span class="n">orderItem</span> <span class="o">=</span> <span class="n">orderItemRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="k">new</span> <span class="n">OrderItemPK</span><span class="o">(</span>
        <span class="n">orderId</span><span class="o">,</span> <span class="n">itemCode</span><span class="o">));</span> <span class="c1">// (1)</span>

<span class="n">orderItem</span><span class="o">.</span><span class="na">setQuantity</span><span class="o">(</span><span class="n">quantity</span><span class="o">);</span> <span class="c1">// (2)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">関連EntityのRepositoryインタフェースのfindOneメソッドを呼び出して、関連Entityのオブジェクトを取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">関連Entityのオブジェクトの状態を、setterメソッドを使って更新する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>更新後に親のEntityを利用した場合の動作について</strong></p>
<p class="last">関連Entity用Repositoryのsaveメソッドを使って関連Entityを更新した場合は、
追加時とは異なり、親のEntityオブジェクトで保持している関連Entityにも反映される。
これは、<code class="docutils literal"><span class="pre">EntityManager</span></code> 上で管理されている同じインスタンスの参照を保持しているためである。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id34">
<h4><a class="toc-backref" href="#id106">6.3.2.10.4. Queryメソッドを使用して更新</a><a class="headerlink" href="#id34" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">永続層(DB)のEntityを直接更新したい場合は、Queryメソッドを使用して更新する。</div>
<div class="line">詳細は、「<a class="reference internal" href="#data-access-jpa-howtouse-querymethod-modifying"><span class="std std-ref">永続層のEntityを直接操作する</span></a>」を参照されたい。</div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id35">
<h3><a class="toc-backref" href="#id107">6.3.2.11. Entityの削除処理の実装</a><a class="headerlink" href="#id35" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id36">
<h4><a class="toc-backref" href="#id108">6.3.2.11.1. Entityと関連Entityの削除</a><a class="headerlink" href="#id36" title="Permalink to this headline">¶</a></h4>
<p>Entityと関連Entityを一緒に削除したい場合は、Repositryインタフェースのdeleteメソッドを呼び出す。</p>
<p>この方法を使用するためには、関連EntityのCascade対象の操作に <code class="docutils literal"><span class="pre">remove</span></code> が含まれているか、
または関連Entityを削除するための設定を有効(関連付けアノテーションのorphanRemoval属性を <code class="docutils literal"><span class="pre">true</span></code> )にする必要がある。</p>
<ul class="simple">
<li>Service</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">orderRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">orderId</span><span class="o">);</span> <span class="c1">// (1)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">IDまたはEntityオブジェクトを指定してRepositryインタフェースのdeleteメソッドを呼び出す。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Entity</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;t_order&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="c1">// ...</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">&quot;order&quot;</span><span class="o">,</span>
               <span class="n">cascade</span> <span class="o">=</span> <span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span> <span class="n">orphanRemoval</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <span class="c1">// (2)</span>
    <span class="nd">@OrderBy</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">OrderItem</span><span class="o">&gt;</span> <span class="n">orderItems</span><span class="o">;</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Cascade対象の操作に <code class="docutils literal"><span class="pre">remove</span></code> を含め、 関連Entityを削除するための設定を有効 (関連付けアノテーションのorphanRemoval属性を <code class="docutils literal"><span class="pre">true</span></code> )にする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>関連Entityの削除について</strong></p>
<p class="last">関連Entityのオブジェクトを一緒に削除したくない場合は、 Cascade対象の操作に <code class="docutils literal"><span class="pre">remove</span></code> が含まれないようにしておく必要がある。
また、関連付けアノテーションのorphanRemoval属性も <code class="docutils literal"><span class="pre">false</span></code> に指定しておくこと。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="daba-access-jpa-howtouse-remove-relationship">
<span id="id37"></span><h4><a class="toc-backref" href="#id109">6.3.2.11.2. 関連Entityの削除</a><a class="headerlink" href="#daba-access-jpa-howtouse-remove-relationship" title="Permalink to this headline">¶</a></h4>
<p>関連Entityを削除したい場合は、Repositoryインタフェース経由で取得したEntityオブジェクトから、関連Entityのオブジェクトを削除する。</p>
<p>この方法を使用するためには、関連Entityを削除するための設定を有効(関連付けアノテーションのorphanRemoval属性を <code class="docutils literal"><span class="pre">true</span></code> )にする必要がある。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>関連Entityを削除する設定を有効にした場合の挙動について</strong></p>
<p>関連Entityを削除する設定を有効にした場合、以下の動作になる。</p>
<ul class="simple">
<li>1:Nの関連Entityの場合は、関連Entityのオブジェクトをコレクションの中から削除すると、トランザクションコミット時に永続層(DB)からも削除される。</li>
<li>1:1の関連Entityの場合は、関連Entityを <code class="docutils literal"><span class="pre">null</span></code> に設定すると、トランザクションコミット時に永続層(DB)からも削除される。</li>
</ul>
<p class="last">orphanRemoval属性のデフォルト値となっている <code class="docutils literal"><span class="pre">false</span></code> が指定されている場合は、メモリ上からは消えるが、
削除した関連Entityのオブジェクトに対する永続処理(UPDATE/DELETE)は行われない。</p>
</div>
</div></blockquote>
<ul class="simple">
<li>Service</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">orderRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">orderId</span><span class="o">);</span> <span class="c1">// (1)</span>

<span class="c1">// (2)</span>
<span class="n">Set</span><span class="o">&lt;</span><span class="n">OrderItem</span><span class="o">&gt;</span> <span class="n">orderItemsOfRemoveTarget</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashSet</span><span class="o">&lt;</span><span class="n">OrderItem</span><span class="o">&gt;();</span> <span class="c1">// (3)</span>
<span class="k">for</span> <span class="o">(</span><span class="n">OrderItem</span> <span class="n">orderItem</span> <span class="o">:</span> <span class="n">order</span><span class="o">.</span><span class="na">getOrderItems</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">itemCode</span> <span class="o">=</span> <span class="n">orderItem</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">getItemCode</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">quantityMap</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">itemCode</span><span class="o">))</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">newQuantity</span> <span class="o">=</span> <span class="n">quantityMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">itemCode</span><span class="o">);</span>
        <span class="n">orderItem</span><span class="o">.</span><span class="na">setQuantity</span><span class="o">(</span><span class="n">newQuantity</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">orderItemsOfRemoveTarget</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">orderItem</span><span class="o">);</span> <span class="c1">// (4)</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="n">order</span><span class="o">.</span><span class="na">getOrderItems</span><span class="o">().</span><span class="na">removeAll</span><span class="o">(</span><span class="n">orderItemsOfRemoveTarget</span><span class="o">);</span> <span class="c1">// (5)</span>

<span class="n">order</span><span class="o">.</span><span class="na">setOrderPay</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span> <span class="c1">// (6)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Repositoryインタフェースのメソッドを使用して、Entityオブジェクトを取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">1:Nの関連Entityを削除する実装例について説明する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">削除する関連Entityのオブジェクトを格納しておくコレクションを用意する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">削除対象の関連Entityのオブジェクトを、(3)のコレクションに追加する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">削除対象の関連Entityのオブジェクトから取得したコレクションの中から削除する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">1:1の関連Entityの場合、削除したい関連Entityのオブジェクトを保持するプロパティを <code class="docutils literal"><span class="pre">null</span></code> に設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Entity</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;t_order&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="nd">@SequenceGenerator</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GEN_ORDER_ID&quot;</span><span class="o">,</span> <span class="n">sequenceName</span> <span class="o">=</span> <span class="s">&quot;s_order_id&quot;</span><span class="o">,</span> <span class="n">allocationSize</span> <span class="o">=</span> <span class="mi">1</span><span class="o">)</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">GenerationType</span><span class="o">.</span><span class="na">SEQUENCE</span><span class="o">,</span> <span class="n">generator</span> <span class="o">=</span> <span class="s">&quot;GEN_ORDER_ID&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">&quot;order&quot;</span><span class="o">,</span> <span class="n">cascade</span> <span class="o">=</span> <span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span>
               <span class="n">orphanRemoval</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <span class="c1">// (7)</span>
    <span class="nd">@OrderBy</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">OrderItem</span><span class="o">&gt;</span> <span class="n">orderItems</span><span class="o">;</span>

    <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">&quot;order&quot;</span><span class="o">,</span> <span class="n">cascade</span> <span class="o">=</span> <span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span>
              <span class="n">orphanRemoval</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <span class="c1">// (7)</span>
    <span class="kd">private</span> <span class="n">OrderPay</span> <span class="n">orderPay</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;status_code&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">OrderStatus</span> <span class="n">status</span><span class="o">;</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">関連Entityを削除するための設定を有効(関連付けアノテーションのorphanRemoval属性を <code class="docutils literal"><span class="pre">true</span></code> )にする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>orphanRemoval属性が指定できる関連付けアノテーションについて</strong></p>
<p class="last">orphanRemoval属性が指定できる関連付けアノテーションは、 <code class="docutils literal"><span class="pre">&#64;OneToOne</span></code> と <code class="docutils literal"><span class="pre">&#64;OneToMany</span></code> の2つとなっている。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id38">
<h4><a class="toc-backref" href="#id110">6.3.2.11.3. 関連Entityの直接削除</a><a class="headerlink" href="#id38" title="Permalink to this headline">¶</a></h4>
<p>関連Entityを、親のEntityを使用せず直接削除したい場合は、関連EntityのRepositoryインタフェースのdeleteメソッドを呼び出す。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">quantity</span> <span class="o">=</span> <span class="mi">43</span><span class="o">;</span>

<span class="n">orderItemRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="k">new</span> <span class="n">OrderItemPK</span><span class="o">(</span><span class="n">orderId</span><span class="o">,</span> <span class="n">itemCode</span><span class="o">));</span> <span class="c1">// (1)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">IDまたはEntityオブジェクトを指定して関連Entity用Repositryインタフェースのdeleteメソッドを呼び出す。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>直接削除の注意点</strong></p>
<p>関連Entity用Repositoryのdeleteメソッドを呼び出した場合、永続層(DB)から削除されないケースがあるので注意すること。</p>
<p>削除されないケースは以下の通り。</p>
<ul class="simple">
<li>deleteメソッド内の中でfindOneメソッドを呼び出しているため、親のEntityとの関連が <code class="docutils literal"><span class="pre">&#64;OneToOne</span></code> の場合は、親のEntityが <code class="docutils literal"><span class="pre">EntityManager</span></code> 上で管理されてしまう。
親のEntityが管理対象になった際に、deleteメソッドで削除しようとしていた関連Entityが親のEntityオブジェクト内にロードされる可能性がある。
親のEntityオブジェクト内にロードされてしまうと、永続層(DB)から削除されない。</li>
<li>deleteメソッド呼び出し後に、親のEntityオブジェクトを取得した場合、deleteメソッドで削除した関連Entityが親のEntityオブジェクト内にロードされる可能性がある。
親のEntityオブジェクト内にロードされてしまうと、永続層(DB)から削除されない。</li>
</ul>
<p>回避方法は、</p>
<ol class="arabic simple">
<li>関連Entityのオブジェクトを直接削除するのではなく、親のEntityとの関連付けを削除するようにする。</li>
</ol>
<p class="last">関連付けアノテーションの見直しを行うことで回避出来る可能性はあるが、確実な回避方法は、直接削除を行わないようにする方法である。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id39">
<h4><a class="toc-backref" href="#id111">6.3.2.11.4. Queryメソッドを使用して削除</a><a class="headerlink" href="#id39" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">永続層(DB)からEntityを直接削除したい場合は、Queryメソッドを使用して削除する。</div>
<div class="line">詳細は、「<a class="reference internal" href="#data-access-jpa-howtouse-querymethod-modifying"><span class="std std-ref">永続層のEntityを直接操作する</span></a>」を参照されたい。</div>
</div>
<blockquote>
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>関連オブジェクトの扱いについて</strong></p>
<p>Queryメソッドを使用して永続層(DB)から直接Entityを削除した場合、関連付けアノテーションの指定に関係なく、
関連Entityのオブジェクトは永続層から削除されない。</p>
<p class="last">Repositoryインタフェースの <code class="docutils literal"><span class="pre">void</span> <span class="pre">deleteInBatch(Iterable&lt;T&gt;</span> <span class="pre">entities)</span></code> と <code class="docutils literal"><span class="pre">void</span> <span class="pre">deleteAllInBatch()</span></code> も同様の動作となる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="like">
<span id="data-access-jpa-howtouse-like-escape"></span><h3><a class="toc-backref" href="#id112">6.3.2.12. LIKE検索時のエスケープについて</a><a class="headerlink" href="#like" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">LIKE検索を行う場合は、検索条件として使用する値をLIKE検索用にエスケープする必要がある。</div>
<div class="line">LIKE検索用のエスケープ処理は、共通ライブラリから提供している <code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.query.QueryEscapeUtils</span></code> クラスのメソッドを使用する事で実現することができる。</div>
<div class="line">共通ライブラリから提供しているエスケープ処理の仕様については、「<a class="reference internal" href="DataAccessCommon.html"><span class="doc">データベースアクセス（共通編）</span></a>」の「<a class="reference internal" href="DataAccessCommon.html#data-access-common-appendix-like-escape"><span class="std std-ref">LIKE検索時のエスケープについて</span></a>」を参照されたい。</div>
</div>
<p>以下に、共通ライブラリから提供しているエスケープ処理の使用方法について説明する。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="id40">
<h4><a class="toc-backref" href="#id113">6.3.2.12.1. 一致方法をQuery側で指定する場合の使用方法</a><a class="headerlink" href="#id40" title="Permalink to this headline">¶</a></h4>
<p>一致方法(前方一致、後方一致、部分一致)の指定をJPQLとして指定する場合は、エスケープのみ行うメソッドを使用する。</p>
<ul class="simple">
<li>Repository</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (1) (2)</span>
<span class="nd">@Query</span><span class="o">(</span><span class="s">&quot;SELECT a FROM Article a WHERE&quot;</span>
        <span class="o">+</span> <span class="s">&quot; (a.title LIKE %:word% ESCAPE &#39;~&#39; OR a.overview LIKE %:word% ESCAPE &#39;~&#39;)&quot;</span><span class="o">)</span>
<span class="n">Page</span><span class="o">&lt;</span><span class="n">Article</span><span class="o">&gt;</span> <span class="nf">findPageBy</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;word&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">word</span><span class="o">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;Query</span></code> アノテーションに指定するJPQL内にLIKE検索用のワイルドカード( “<code class="docutils literal"><span class="pre">%</span></code>” または “<code class="docutils literal"><span class="pre">_</span></code>” )を指定する。</div>
<div class="line">上記例では、引数 <code class="docutils literal"><span class="pre">word</span></code> の前後にワイルドカード( “<code class="docutils literal"><span class="pre">%</span></code>” )を指定することで、一致方法を部分一致にしている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">共通ライブラリから提供しているエスケープ処理は、エスケープ文字として “<code class="docutils literal"><span class="pre">~</span></code>” を使用しているため、 LIKE句の後ろに <code class="docutils literal"><span class="pre">ESCAPE</span> <span class="pre">'~'</span></code> を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>ワイルドカード文字 “_” について</strong></p>
<p>ワイルドカード文字 “<code class="docutils literal"><span class="pre">%</span></code>” は、「<a class="reference internal" href="#how-to-specify-query-annotation-label"><span class="std std-ref">&#64;Query アノテーションで指定する</span></a>」で説明しているように、 <code class="docutils literal"><span class="pre">&#64;Query</span></code> アノテーションを利用した場合に限り直接JPQL内で使用することができる。
ワイルドカード文字 “<code class="docutils literal"><span class="pre">_</span></code>” は直接JPQL内のLIKE検索に利用することはできないため、下記2方法で利用すること。</p>
<ol class="last arabic simple">
<li>ワイルドカード文字 “<code class="docutils literal"><span class="pre">_</span></code>” をバインド変数内に含める。</li>
<li>ワイルドカード文字 “<code class="docutils literal"><span class="pre">_</span></code>” を <code class="docutils literal"><span class="pre">CONCAT</span></code> などのデータベース製品が持つ文字列結合機能を利用してバインド変数に結合する。</li>
</ol>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Service</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">Page</span><span class="o">&lt;</span><span class="n">Article</span><span class="o">&gt;</span> <span class="nf">searchArticle</span><span class="o">(</span><span class="n">ArticleSearchCriteria</span> <span class="n">criteria</span><span class="o">,</span>
        <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">String</span> <span class="n">escapedWord</span> <span class="o">=</span> <span class="n">QueryEscapeUtils</span><span class="o">.</span><span class="na">toLikeCondition</span><span class="o">(</span><span class="n">criteria</span><span class="o">.</span><span class="na">getWord</span><span class="o">());</span> <span class="c1">// (3)</span>

    <span class="n">Page</span><span class="o">&lt;</span><span class="n">Article</span><span class="o">&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">articleRepository</span><span class="o">.</span><span class="na">findPageBy</span><span class="o">(</span><span class="n">escapedWord</span><span class="o">,</span> <span class="n">pageable</span><span class="o">);</span> <span class="c1">// (4)</span>

    <span class="k">return</span> <span class="n">page</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">LIKE検索の一致方法をQuery側で指定する場合は、<code class="docutils literal"><span class="pre">QueryEscapeUtils#toLikeCondition(String)</span></code> メソッドを呼び出し、LIKE検索用のエスケープのみ行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">LIKE検索用にエスケープされた値をQueryメソッドの引数に渡す。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id41">
<h4><a class="toc-backref" href="#id114">6.3.2.12.2. 一致方法をロジック側で指定する場合の使用方法</a><a class="headerlink" href="#id41" title="Permalink to this headline">¶</a></h4>
<p>一致方法(前方一致、後方一致、部分一致)をロジック側で判定する場合は、エスケープされた値にワイルドカードを付与するメソッドを使用する。</p>
<ul class="simple">
<li>Repository</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="nd">@Query</span><span class="o">(</span><span class="s">&quot;SELECT a FROM Article a WHERE&quot;</span>
        <span class="o">+</span> <span class="s">&quot; (a.title LIKE :word ESCAPE &#39;~&#39; OR a.overview LIKE :word ESCAPE &#39;~&#39;)&quot;</span><span class="o">)</span>
<span class="n">Page</span><span class="o">&lt;</span><span class="n">Article</span><span class="o">&gt;</span> <span class="nf">findPageBy</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;word&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">word</span><span class="o">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;Query</span></code> アノテーションに指定するJPQL内にLIKE検索用のワイルドカードは指定しない。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Service</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">Page</span><span class="o">&lt;</span><span class="n">Article</span><span class="o">&gt;</span> <span class="nf">searchArticle</span><span class="o">(</span><span class="n">ArticleSearchCriteria</span> <span class="n">criteria</span><span class="o">,</span>
        <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">String</span> <span class="n">word</span> <span class="o">=</span> <span class="n">QueryEscapeUtils</span>
            <span class="o">.</span><span class="na">toContainingCondition</span><span class="o">(</span><span class="n">criteria</span><span class="o">.</span><span class="na">getWord</span><span class="o">());</span> <span class="c1">// (2)</span>

    <span class="n">Page</span><span class="o">&lt;</span><span class="n">Article</span><span class="o">&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">articleRepository</span><span class="o">.</span><span class="na">findPageBy</span><span class="o">(</span><span class="n">word</span><span class="o">,</span> <span class="n">pageable</span><span class="o">);</span> <span class="c1">// (3)</span>

    <span class="k">return</span> <span class="n">page</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ロジック側で一致方法を指定する場合は、  以下の何れかのメソッドを呼び出し、LIKE検索用のエスケープとLIKE検索用のワイルドカードを付与する。</div>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">QueryEscapeUtils#toStartingWithCondition(String)</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">QueryEscapeUtils#toEndingWithCondition(String)</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">QueryEscapeUtils#toContainingCondition(String)</span></code></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">LIKE検索用にエスケープ＋ワイルドカードが付与された値をQueryメソッドの引数に渡す。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="join-fetch">
<span id="data-access-jpa-howtouse-join-fetch"></span><h3><a class="toc-backref" href="#id115">6.3.2.13. JOIN FETCHについて</a><a class="headerlink" href="#join-fetch" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">JOIN FETCHは、関連するEntityをJOINして一括で取得することで、Entityを取得するために発行するQueryの数を減らすための仕組みである。</div>
</div>
<div class="line-block">
<div class="line">任意のQueryを実行してEntityを取得する場合、関連付けアノテーションのfetch属性が <code class="docutils literal"><span class="pre">EAGER</span></code> となっているプロパティは必ず JOIN FETCH すること。</div>
<div class="line">JOIN FETCHしないと、関連Entityを取得するためのQueryが別途発行されるため、性能に影響を与える可能性がある。</div>
</div>
<div class="line-block">
<div class="line">関連付けアノテーションのfetch属性が <code class="docutils literal"><span class="pre">LAZY</span></code> となっているプロパティについては、使用頻度を考慮して JOIN FETCH するか判断すること。</div>
<div class="line">必ず参照される関連Entityの場合は JOIN FETCHすべきであるが、参照されるケースが少ないのであれば JOIN FETCH せず、初回アクセス時にQueryを発行して取得する方がよい。</div>
</div>
<ul class="simple">
<li>Repository</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Query</span><span class="o">(</span><span class="s">&quot;SELECT a FROM Article a&quot;</span>
        <span class="o">+</span> <span class="s">&quot; INNER JOIN FETCH a.articleClass&quot;</span>   <span class="c1">// (1)</span>
        <span class="o">+</span> <span class="s">&quot; WHERE a.publishedDate = :publishedDate&quot;</span>
        <span class="o">+</span> <span class="s">&quot; ORDER BY a.articleId DESC&quot;</span><span class="o">)</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Article</span><span class="o">&gt;</span> <span class="nf">findAllByPublishedDate</span><span class="o">(</span>
        <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;publishedDate&quot;</span><span class="o">)</span> <span class="n">Date</span> <span class="n">publishedDate</span><span class="o">);</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">[LEFT</span> <span class="pre">[OUTER]</span> <span class="pre">|</span> <span class="pre">INNER]</span> <span class="pre">JOIN</span> <span class="pre">FETCH</span> <span class="pre">Join対象のプロパティ</span></code> の形式で指定する。</div>
<div class="line">具体的には以下のパターンとなる。</div>
<div class="line"><br /></div>
<div class="line">1. <code class="docutils literal"><span class="pre">LEFT</span> <span class="pre">JOIN</span> <span class="pre">FETCH</span></code></div>
<div class="line-block">
<div class="line">関連Entityが存在しない場合でもEntityは取得される。</div>
<div class="line">SQLとしては、 <code class="docutils literal"><span class="pre">left</span> <span class="pre">outer</span> <span class="pre">join</span> <span class="pre">RelatedTable</span> <span class="pre">r</span> <span class="pre">on</span> <span class="pre">m.fkColumn</span> <span class="pre">=</span> <span class="pre">r.fkColumn</span></code> となる。</div>
</div>
<div class="line">2. <code class="docutils literal"><span class="pre">LEFT</span> <span class="pre">OUTER</span> <span class="pre">JOIN</span> <span class="pre">FETCH</span></code></div>
<div class="line-block">
<div class="line">1と同様。</div>
</div>
<div class="line">3. <code class="docutils literal"><span class="pre">INNER</span> <span class="pre">JOIN</span> <span class="pre">FETCH</span></code></div>
<div class="line-block">
<div class="line">関連Entityが存在しない場合は、Entityは取得されない。</div>
<div class="line">SQLとしては、 <code class="docutils literal"><span class="pre">inner</span> <span class="pre">join</span> <span class="pre">RelatedTable</span> <span class="pre">r</span> <span class="pre">on</span> <span class="pre">m.fkColumn</span> <span class="pre">=</span> <span class="pre">r.fkColumn</span></code> となる。</div>
</div>
<div class="line">4. <code class="docutils literal"><span class="pre">JOIN</span> <span class="pre">FETCH</span></code></div>
<div class="line-block">
<div class="line">3と同様。</div>
<div class="line"><br /></div>
</div>
<div class="line">上記例では、ArticleクラスのarticleClassプロパティをJOIN FETCH対象として指定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">JOIN FETCHはN+1問題の解決策の一つとして使用される。
N+1問題については、「<a class="reference internal" href="DataAccessCommon.html#data-access-common-howtosolve-n-plus-1"><span class="std std-ref">N+1問題の対策方法</span></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="how-to-extend">
<h2><a class="toc-backref" href="#id116">6.3.3. How to extend</a><a class="headerlink" href="#how-to-extend" title="Permalink to this headline">¶</a></h2>
<div class="section" id="data-access-jpa-how-to-extends-custommethod">
<span id="id42"></span><h3><a class="toc-backref" href="#id117">6.3.3.1. カスタムメソッドの追加方法</a><a class="headerlink" href="#data-access-jpa-how-to-extends-custommethod" title="Permalink to this headline">¶</a></h3>
<p>Spring Dataでは、Repositoryインタフェースに対して、任意のカスタムメソッドを追加する仕組みを提供している。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="35%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">追加方法</th>
<th class="head">使用ケース</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><a class="reference internal" href="#custommethod-individual-label"><span class="std std-ref">Entity毎のRepositoryインタフェースに個別に追加する</span></a></td>
<td><div class="first last line-block">
<div class="line">Spring Dataより提供されているQueryメソッドの仕組みで表現できないQueryを実装する必要がある場合に使用する。</div>
<div class="line">動的Queryを実装する場合は、この方法を使用してメソッドを追加する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><a class="reference internal" href="#custommethod-all-label"><span class="std std-ref">すべてのRepositoryインタフェースに一括で追加する</span></a></td>
<td><div class="first last line-block">
<div class="line">すべてのRepositoryインタフェースで使用できるような汎用的なQueryを実装する必要がある場合に使用する。</div>
<div class="line">プロジェクト固有の汎用Queryを実装する場合は、この方法を使用してメソッドを追加する。</div>
<div class="line">Spring Data JPAから提供されているデフォルト実装( <code class="docutils literal"><span class="pre">SimpleJpaRepository</span></code> )の振る舞いを変更する必要がある場合、この仕組みを使用してメソッドをオーバーライドすることで対応することが出来る。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="entityrepository">
<span id="custommethod-individual-label"></span><h4><a class="toc-backref" href="#id118">6.3.3.1.1. Entity毎のRepositoryインタフェースに個別に追加する</a><a class="headerlink" href="#entityrepository" title="Permalink to this headline">¶</a></h4>
<p>Entity毎のRepositoryインタフェースに個別にカスタムメソッドを追加する方法について説明する。</p>
<ul class="simple">
<li>Entity毎のカスタムRepositoryインタフェース</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderRepositoryCustom</span> <span class="o">{</span>

    <span class="c1">// (2)</span>
    <span class="n">Page</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findByCriteria</span><span class="o">(</span><span class="n">OrderCriteria</span> <span class="n">criteria</span><span class="o">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">カスタムメソッドを定義するカスタムインタフェースを作成する。</div>
<div class="line">インタフェース名に特に制約はないが、Entity毎のRepositoryインタフェース名 + <code class="docutils literal"><span class="pre">Custom</span></code> とすることを推奨する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">カスタムメソッドを定義する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Entity毎のカスタムRepositoryクラス</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (3)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderRepositoryImpl</span> <span class="kd">implements</span> <span class="n">OrderRepositoryCustom</span> <span class="o">{</span>

    <span class="nd">@PersistenceContext</span>
    <span class="n">EntityManager</span> <span class="n">entityManager</span><span class="o">;</span> <span class="c1">// (4)</span>

    <span class="c1">// (5)</span>
    <span class="kd">public</span> <span class="n">Page</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">findByCriteria</span><span class="o">(</span><span class="n">OrderCriteria</span> <span class="n">criteria</span><span class="o">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ...</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">PageImpl</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;(</span><span class="n">orders</span><span class="o">,</span> <span class="n">pageable</span><span class="o">,</span> <span class="n">totalCount</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">カスタムインタフェースの実装クラスを作成する。</div>
<div class="line">クラス名は、Entity毎のRepositoryインタフェース名 + <code class="docutils literal"><span class="pre">Impl</span></code> とすること。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Queryを実行するために必要となる <code class="docutils literal"><span class="pre">javax.persistence.EntityManager</span></code> は <code class="docutils literal"><span class="pre">&#64;javax.persistence.PersistenceContext</span></code> アノテーションを使ってインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">カスタムインタフェースに定義したメソッドを実装する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Entity毎のRepositoryインタフェース</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;,</span>
        <span class="n">OrderRepositoryCustom</span> <span class="o">{</span> <span class="c1">// (6)</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Entity毎のRepositoryインタフェースでカスタムインタフェースを継承する。</div>
<div class="line">Repositoryインタフェースを継承することで、実行時にカスタムインタフェースの実装クラスのメソッドが呼び出される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Service(Caller)</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Page</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">search</span><span class="o">(</span><span class="n">OrderCriteria</span> <span class="n">criteria</span><span class="o">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">orderRepository</span><span class="o">.</span><span class="na">findByCriteria</span><span class="o">(</span><span class="n">criteria</span><span class="o">,</span> <span class="n">pageable</span><span class="o">);</span> <span class="c1">// (7)</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">呼び出し側は、他のメソッドと同様にEntity毎のRepositoryインタフェースのメソッドを呼び出せばよい。</div>
<div class="line">上記例では、<code class="docutils literal"><span class="pre">OrderRepository#findByCriteria(OrderCriteria,</span> <span class="pre">Pageable)</span></code> を呼び出すと <code class="docutils literal"><span class="pre">OrderRepositoryImpl#findByCriteria(OrderCriteria,</span> <span class="pre">Pageable)</span></code> が実行される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="custommethod-all-label">
<span id="id43"></span><h4><a class="toc-backref" href="#id119">6.3.3.1.2. すべてのRepositoryインタフェースに一括で追加する</a><a class="headerlink" href="#custommethod-all-label" title="Permalink to this headline">¶</a></h4>
<p>すべてのRepositoryインタフェースに一括でカスタムメソッドを追加する方法について説明する。</p>
<p>下記の実装例では、取得したEntityとのバージョンチェックを行い、バージョンが異なる場合に楽観排他エラーとするメソッドを追加している。</p>
<ul class="simple">
<li>共通のRepositoryインタフェース</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="nd">@NoRepositoryBean</span> <span class="c1">// (2)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MyProjectRepository</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ID</span> <span class="kd">extends</span> <span class="n">Serializable</span><span class="o">&gt;</span> <span class="kd">extends</span>
        <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ID</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="c1">// (3)</span>
    <span class="n">T</span> <span class="nf">findOneWithValidVersion</span><span class="o">(</span><span class="n">ID</span> <span class="n">id</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">version</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">追加するメソッドを定義するための共通Repositoryインタフェースを作成する。</div>
<div class="line">上記例では、Spring Dataから提供されている <code class="docutils literal"><span class="pre">JpaRepository</span></code> を継承して共通Repositoryインタフェースを作成している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">共通Repositoryインタフェースの実装クラス( 例だと <code class="docutils literal"><span class="pre">MyProjectRepositoryImpl</span></code> )が、RepositoryのBeanとして自動登録されないようにするためのアノテーション。</div>
<div class="line">共通Repositoryインタフェースの実装クラスを&lt;jpa:repositories&gt;要素のbase-package属性で指定したパッケージ配下に格納する場合は、このアノテーションを指定しないと起動時にエラーとなる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">追加するメソッドを定義する。例では、取得したEntityのバージョンチェックを行うメソッドを追加している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>共通Repositoryインタフェースの実装クラス</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (6)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyProjectRepositoryImpl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ID</span> <span class="kd">extends</span> <span class="n">Serializable</span><span class="o">&gt;</span>
        <span class="kd">extends</span> <span class="n">SimpleJpaRepository</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ID</span><span class="o">&gt;</span>
        <span class="kd">implements</span> <span class="n">MyProjectRepository</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ID</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">JpaEntityInformation</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ID</span><span class="o">&gt;</span> <span class="n">entityInformation</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">EntityManager</span> <span class="n">entityManager</span><span class="o">;</span>
    <span class="n">Method</span> <span class="n">versionMethod</span><span class="o">;</span>

    <span class="c1">// (7)</span>
    <span class="kd">public</span> <span class="nf">MyProjectRepositoryImpl</span><span class="o">(</span>
            <span class="n">JpaEntityInformation</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ID</span><span class="o">&gt;</span> <span class="n">entityInformation</span><span class="o">,</span>
            <span class="n">EntityManager</span> <span class="n">entityManager</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">entityInformation</span><span class="o">,</span> <span class="n">entityManager</span><span class="o">);</span>

        <span class="k">this</span><span class="o">.</span><span class="na">entityInformation</span> <span class="o">=</span> <span class="n">entityInformation</span><span class="o">;</span> <span class="c1">// (8)</span>
        <span class="k">this</span><span class="o">.</span><span class="na">entityManager</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">;</span> <span class="c1">// (8)</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">versionMethod</span> <span class="o">=</span> <span class="n">entityInformation</span><span class="o">.</span><span class="na">getJavaType</span><span class="o">().</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&quot;getVersion&quot;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchMethodException</span> <span class="o">|</span> <span class="n">SecurityException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span> <span class="o">}</span>

    <span class="o">}</span>

    <span class="c1">// (9)</span>
    <span class="kd">public</span> <span class="n">T</span> <span class="nf">findOneWithValidVersion</span><span class="o">(</span><span class="n">ID</span> <span class="n">id</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">version</span><span class="o">)</span> <span class="o">{</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">versionMethod</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">UnsupportedOperationException</span><span class="o">(</span>
                    <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
                            <span class="s">&quot;Does not found version field in entity class. class is &#39;%s&#39;.&quot;</span><span class="o">,</span>
                            <span class="n">entityInformation</span><span class="o">.</span><span class="na">getJavaType</span><span class="o">().</span><span class="na">getName</span><span class="o">()));</span>
        <span class="o">}</span>

        <span class="n">T</span> <span class="n">entity</span> <span class="o">=</span> <span class="n">findOne</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">entity</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">version</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Integer</span> <span class="n">currentVersion</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">currentVersion</span> <span class="o">=</span> <span class="o">(</span><span class="n">Integer</span><span class="o">)</span> <span class="n">versionMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="o">|</span> <span class="n">IllegalArgumentException</span>
                    <span class="o">|</span> <span class="n">InvocationTargetException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">version</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">currentVersion</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">ObjectOptimisticLockingFailureException</span><span class="o">(</span>
                        <span class="n">entityInformation</span><span class="o">.</span><span class="na">getJavaType</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span> <span class="n">id</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">entity</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">共通Repositoryインタフェース(例だと、 <code class="docutils literal"><span class="pre">MyProjectRepository</span></code> )の実装クラスを作成する。</div>
<div class="line">上記例では、Spring Dataから提供されている <code class="docutils literal"><span class="pre">SimpleJpaRepository</span></code> を継承して実装クラスを作成している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.data.jpa.repository.support.JpaEntityInformation</span></code> と <code class="docutils literal"><span class="pre">javax.persistence.EntityManager</span></code> を引数にとるコンストラクタを作成する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">追加するメソッドの処理で必要な場合は、 <code class="docutils literal"><span class="pre">JpaEntityInformation</span></code> および <code class="docutils literal"><span class="pre">EntityManager</span></code> をフィールドに保持しておく。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">共通Repositoryインタフェースに定義したメソッドの実装を行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>デフォルト実装の変更</strong></p>
<p class="last">デフォルト実装( <code class="docutils literal"><span class="pre">SimpleJpaRepository</span></code> )の振る舞いを変更する場合は、このクラスで振る舞いを変更したいメソッドをオーバーライドすればよい。</p>
</div>
</div></blockquote>
<ul class="simple">
<li>Entity毎のRepositoryインタフェース</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderRepository</span> <span class="kd">extends</span> <span class="n">MyProjectRepository</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="o">{</span> <span class="c1">// (10)</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Entity毎のRepositoryインタフェースでは、作成した共通インタフェース(例だと <code class="docutils literal"><span class="pre">MyProjectRepository</span></code> )を継承先として指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">xxx-infra.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;jpa:repositories</span> <span class="na">base-package=</span><span class="s">&quot;x.y.z.domain.repository&quot;</span>
    <span class="na">base-class=</span><span class="s">&quot;x.y.z.domain.repository.MyProjectRepositoryImpl&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (11) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">&lt;jpa:repositories&gt;要素のbase-class属性に、作成した共通Repositoryインタフェースの実装クラス(例だと <code class="docutils literal"><span class="pre">MyProjectRepositoryImpl</span></code>) のクラス名を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Service(Caller)</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Order</span> <span class="nf">updateOrder</span><span class="o">(</span><span class="n">Order</span> <span class="n">chngedOrder</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">version</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">orderRepository</span><span class="o">.</span><span class="na">findOneWithValidVersion</span><span class="o">(</span><span class="n">chngedOrder</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">version</span><span class="o">);</span> <span class="c1">// (12)</span>

    <span class="c1">// ....</span>

    <span class="k">return</span> <span class="n">order</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">呼び出し側は、他のメソッドと同様にEntity毎のRepositoryインタフェースのメソッドを呼び出せばよい。</div>
<div class="line">上記例では、<code class="docutils literal"><span class="pre">OrderRepository#findOneWithValidVersion(Integer,</span> <span class="pre">Integer)</span></code> を呼び出すと <code class="docutils literal"><span class="pre">MyProjectRepositoryImpl#findOneWithValidVersion(Integer,</span> <span class="pre">Integer)</span></code> が実行される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="entityquery">
<h3><a class="toc-backref" href="#id120">6.3.3.2. Entity以外のオブジェクトにQueryの取得結果を格納する方法</a><a class="headerlink" href="#entityquery" title="Permalink to this headline">¶</a></h3>
<p>Queryの取得結果をEntityにマッピングするのではなく、別のオブジェクトにマッピングすることができる。
これは、永続層(DB)に格納されているレコードをEntity以外のオブジェクト(JavaBean)として扱いたい時に使用する。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>想定される適用ケース</strong></p>
<ol class="last arabic simple">
<li>Query内で集計関数を使用して集計済みの情報を取得したい場合は、集計結果をEntityにマッピングすることはできたいため、別のオブジェクトにマッピングする必要がある。</li>
<li>巨大なEntityの中の一部の情報のみ参照したい場合や、ネストが深い関連Entityの一部の情報のみ参照したい場合は、必要なプロパティのみ定義したJavaBeanにマッピングして取得する事を検討した方がよい場合がある。
Entityとして取得した場合、アプリケーションの処理に不要な項目に対するマッピング処理が行われる点や、処理に不要な情報を取得することでメモリを無駄に使用する点などにより、処理性能に影響を与える場合があるためである。
処理性能に大きな影響を与えない場合は、Entityとして取得してよい。</li>
</ol>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>以下の実装例を示す。</p>
<ul class="simple">
<li>JavaBean</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderSummary</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">totalPrice</span><span class="o">;</span>

    <span class="c1">// ...</span>

    <span class="kd">public</span> <span class="nf">OrderSummary</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">,</span> <span class="n">Long</span> <span class="n">totalPrice</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (2)</span>
        <span class="kd">super</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">totalPrice</span> <span class="o">=</span> <span class="n">totalPrice</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Query結果を格納するJavaBeanを作成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Queryを実行した結果でオブジェクト生成するためのコンストラクタを用意する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Repositoryインタフェース</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (3)</span>
<span class="nd">@Query</span><span class="o">(</span><span class="s">&quot;SELECT NEW x.y.z.domain.model.OrderSummary(o.id, SUM(i.price*oi.quantity))&quot;</span>
        <span class="o">+</span> <span class="s">&quot; FROM Order o LEFT JOIN o.orderItems oi LEFT JOIN oi.item i&quot;</span>
        <span class="o">+</span> <span class="s">&quot; GROUP BY o.id ORDER BY o.id DESC&quot;</span><span class="o">)</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">OrderSummary</span><span class="o">&gt;</span> <span class="nf">findOrderSummaries</span><span class="o">();</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(2)で作成したコンストラクタを指定する。</div>
<div class="line">“NEW”キーワードの後に FQCNでコンストラクタを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="audit">
<h3><a class="toc-backref" href="#id121">6.3.3.3. Audit用プロパティの設定方法</a><a class="headerlink" href="#audit" title="Permalink to this headline">¶</a></h3>
<p>Spring Data JPAより提供されている、永続層のAudit用プロパティ(作成者、作成日時、最終更新者、最終更新日時)に値を設定する仕組みと適用方法について説明する。</p>
<p>Spring Data JPAでは、新たに作成されたEntityと更新されたEntityに対して、Audit用プロパティに値を設定する仕組みを提供している。
この仕組みを使用すると、ServiceなどのアプリケーションのコードからAudit用プロパティに値を設定する処理を切り離すことができる。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>アプリケーションのコードからAudit用プロパティに値を設定する処理を切り離す理由</strong></p>
<ol class="last arabic simple">
<li>Audit用プロパティへの値の設定は、一般的にアプリケーション要件ではなく、データの監査要件によって必要になる処理である。
本質的にはServiceなどのアプリケーション内のコードで意識すべき処理ではないため、
アプリケーションのコードから切り離した方がよい。</li>
<li>JPAでは、永続層から取得したEntityに対して値の変更があった場合のみ、永続層へ反映(SQLを発行)する仕様になっており、
永続層へ無駄なアクセスが行われないように制御されている。
ServiceなどのアプリケーションのコードでAudit用プロパティに無条件に値を設定してしまうと、
Audit用プロパティ以外に変更がない場合でも、永続層への反映が行われることになるため、JPAの有効な機能を無駄にしてしまう。
値の変更があった場合のみAudit用プロパティに値を設定するように制御すればこの問題は回避できるが、
アプリケーションのコードが煩雑になるため推奨できない。</li>
</ol>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>値の変更有無に関係なく永続層のAudit用カラムを更新する必要がある場合</strong></p>
<p>値に変更がなくても永続層のAudit用カラム(最終更新者、最終更新日時)を更新するのが、アプリケーションの仕様となっている場合は、
ServiceなどのアプリケーションのコードでAudit用プロパティを設定する必要がある。</p>
<p class="last">ただし、このケースではデータモデリングまたはアプリケーション仕様が間違っている可能性があるため、データモデリングおよびアプリケーション仕様の見直しを行った方がよい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>以下に、適用時の実装例を示す。</p>
<ul class="simple">
<li>Entityクラス</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">XxxEntity</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="c1">// ...</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;created_by&quot;</span><span class="o">)</span>
    <span class="nd">@CreatedBy</span> <span class="c1">// (1)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">createdBy</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;created_date&quot;</span><span class="o">)</span>
    <span class="nd">@CreatedDate</span> <span class="c1">// (2)</span>
    <span class="nd">@Type</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;org.jadira.usertype.dateandtime.joda.PersistentDateTime&quot;</span><span class="o">)</span> <span class="c1">// (3)</span>
    <span class="kd">private</span> <span class="n">DateTime</span> <span class="n">createdDate</span><span class="o">;</span> <span class="c1">// (4)</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;last_modified_by&quot;</span><span class="o">)</span>
    <span class="nd">@LastModifiedBy</span> <span class="c1">// (5)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">lastModifiedBy</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;last_modified_date&quot;</span><span class="o">)</span>
    <span class="nd">@LastModifiedDate</span> <span class="c1">// (6)</span>
    <span class="nd">@Type</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;org.jadira.usertype.dateandtime.joda.PersistentDateTime&quot;</span><span class="o">)</span> <span class="c1">// (3)</span>
    <span class="kd">private</span> <span class="n">DateTime</span> <span class="n">lastModifiedDate</span><span class="o">;</span> <span class="c1">// (4)</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">作成者を保持するフィールドに <code class="docutils literal"><span class="pre">&#64;org.springframework.data.annotation.CreatedBy</span></code> アノテーションを付与する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">作成日時を保持するフィールドに <code class="docutils literal"><span class="pre">&#64;org.springframework.data.annotation.CreatedDate</span></code> アノテーションを付与する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.joda.time.DateTime</span></code> 型を使用する場合は、Hibernateで扱えるようにするために、 フィールドに <code class="docutils literal"><span class="pre">&#64;org.hibernate.annotations.Type</span></code> アノテーションを付与する。</div>
<div class="line">type属性は、 <code class="docutils literal"><span class="pre">org.jadira.usertype.dateandtime.joda.PersistentDateTime</span></code> 固定。最終更新日時のフィールドも同様。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">作成日時を保持するフィールドの型は、 <code class="docutils literal"><span class="pre">org.joda.time.DateTime</span></code> 、<code class="docutils literal"><span class="pre">java.util.Date</span></code> 、<code class="docutils literal"><span class="pre">java.util.Calendar</span></code> 、 <code class="docutils literal"><span class="pre">java.lang.Long</span></code> 、 <code class="docutils literal"><span class="pre">long</span></code> 型 、Java 8から追加されたDate and Time APIなどをサポートしている。</div>
<div class="line">最終更新日時のフィールドも同様。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">最終更新者を保持するフィールドの型に <code class="docutils literal"><span class="pre">&#64;org.springframework.data.annotation.LastModifiedBy</span></code> アノテーションを付与する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">最終更新日時を保持するフィールドに <code class="docutils literal"><span class="pre">&#64;org.springframework.data.annotation.LastModifiedDate</span></code> アノテーションを付与する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><code class="docutils literal"><span class="pre">&#64;Type</span></code> アノテーションは、JPAの標準アノテーションではなく、Hibernate独自のアノテーションである。</p>
</div>
</div></blockquote>
<ul class="simple">
<li>AuditorAwareインタフェースの実装クラス</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (7)</span>
<span class="nd">@Component</span> <span class="c1">// (8)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringSecurityAuditorAware</span> <span class="kd">implements</span> <span class="n">AuditorAware</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="c1">// (9)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getCurrentAuditor</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">()</span>
                <span class="o">.</span><span class="na">getAuthentication</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">authentication</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">authentication</span><span class="o">.</span><span class="na">isAuthenticated</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="o">((</span><span class="n">UserDetails</span><span class="o">)</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">()).</span><span class="na">getUsername</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.data.domain.AuditorAware</span></code> インタフェースの実装クラスを作成する。</div>
<div class="line"><code class="docutils literal"><span class="pre">AuditorAware</span></code> インタフェースは、Entityの操作者(作成者または最終更新者)を解決するためのインタフェースとなっている。</div>
<div class="line">このクラスはプロジェクト毎に作成する必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;Component</span></code> アノテーションを付与することで、component-scan対象になるようにしている。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;Component</span></code> アノテーションを付けずに、Bean定義ファイルにbean定義してもよい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Entityの操作者(作成者または最終更新者)のプロパティに設定するオブジェクトを返却する。</div>
<div class="line">上記例では、SpringSecurityによって認証されたログインユーザのユーザ名(文字列)をEntityの操作者として返却している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Object/relational mapping file( <code class="docutils literal"><span class="pre">orm.xml</span></code> )</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>

<span class="nt">&lt;entity-mappings</span> <span class="na">xmlns=</span><span class="s">&quot;http://java.sun.com/xml/ns/persistence/orm&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://java.sun.com/xml/ns/persistence/orm</span>
<span class="s">    http://java.sun.com/xml/ns/persistence/orm_2_0.xsd&quot;</span>
    <span class="na">version=</span><span class="s">&quot;2.0&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;persistence-unit-metadata&gt;</span>
        <span class="nt">&lt;persistence-unit-defaults&gt;</span>
            <span class="nt">&lt;entity-listeners&gt;</span>
                <span class="nt">&lt;entity-listener</span>
                    <span class="na">class=</span><span class="s">&quot;org.springframework.data.jpa.domain.support.AuditingEntityListener&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (10) --&gt;</span>
            <span class="nt">&lt;/entity-listeners&gt;</span>
        <span class="nt">&lt;/persistence-unit-defaults&gt;</span>
    <span class="nt">&lt;/persistence-unit-metadata&gt;</span>

<span class="nt">&lt;/entity-mappings&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Entity Listenerとして、 <code class="docutils literal"><span class="pre">org.springframework.data.jpa.domain.support.AuditingEntityListener</span></code> クラスを指定する。</div>
<div class="line">このクラスで実装しているメソッドにて、Audit用プロパティに値を設定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">infra.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;jpa:auditing</span> <span class="na">auditor-aware-ref=</span><span class="s">&quot;springSecurityAuditorAware&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (11) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">&lt;jpa:auditing&gt;要素のauditor-aware-ref属性に、(7)で作成したEntityの操作者を解決するためのクラスのbeanを指定する。</div>
<div class="line">上記例では、 <code class="docutils literal"><span class="pre">SpringSecurityAuditorAware</span></code> という実装クラスをcomponent-scanしているので、 <code class="docutils literal"><span class="pre">springSecurityAuditorAware</span></code> というbean名を指定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p><code class="docutils literal"><span class="pre">&#64;CreatedDate</span></code> および <code class="docutils literal"><span class="pre">&#64;LastModifiedDate</span></code> アノテーションが付与されたフィールドに設定される値は、
デフォルト実装だと <code class="docutils literal"><span class="pre">org.springframework.data.auditing.CurrentDateTimeProvider</span></code> の <code class="docutils literal"><span class="pre">getNow()</span></code> メソッド
から返却される <code class="docutils literal"><span class="pre">java.util.Calendar</span></code> のインスタンスの値が使用される。</p>
<p>以下に、使用する値の生成方法を変更する場合の拡張例を示す。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="nd">@Component</span> <span class="c1">// (2)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuditDateTimeProvider</span> <span class="kd">implements</span> <span class="n">DateTimeProvider</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">JodaTimeDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="c1">// (3)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Calendar</span> <span class="nf">getNow</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">DateTime</span> <span class="n">currentDateTime</span> <span class="o">=</span> <span class="n">dateFactory</span><span class="o">.</span><span class="na">newDateTime</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">currentDateTime</span><span class="o">.</span><span class="na">toGregorianCalendar</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.data.auditing.DateTimeProvider</span></code> インタフェースの実装クラスを作成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;Component</span></code> アノテーションを付与することで、component-scan対象になるようにしている。</div>
<div class="line"><code class="docutils literal"><span class="pre">&#64;Component</span></code> アノテーションを付けずに、Bean定義ファイルにbean定義してもよい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Entityの操作日時(作成日時、最終更新日時)のプロパティに設定するインスタンスを返却する。</div>
<div class="line">上記例では、共通ライブラリから提供している <code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.date.jodatime.JodaTimeDateFactory</span></code> から取得したインスタンスを操作日時として返却している。</div>
<div class="line"><code class="docutils literal"><span class="pre">JodaTimeDateFactory</span></code> の詳細については、「<a class="reference internal" href="../GeneralFuncDetail/SystemDate.html"><span class="doc">システム時刻</span></a>」を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">infra.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;jpa:auditing</span>
    <span class="na">auditor-aware-ref=</span><span class="s">&quot;springSecurityAuditorAware&quot;</span>
    <span class="na">date-time-provider-ref=</span><span class="s">&quot;auditDateTimeProvider&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">&lt;jpa:auditing&gt;要素のdate-time-provider-ref属性に、(1)で作成したEntityの操作日時に設定する値を返却するクラスのbeanを指定する。</div>
<div class="line">上記例では、 <code class="docutils literal"><span class="pre">AuditDateTimeProvider</span></code> という実装クラスをcomponent-scanしているので、 <code class="docutils literal"><span class="pre">auditDateTimeProvider</span></code> というbean名を指定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="entityjpql">
<h3><a class="toc-backref" href="#id122">6.3.3.4. 永続層からEntityを取得するJPQLに共通条件を加える方法</a><a class="headerlink" href="#entityjpql" title="Permalink to this headline">¶</a></h3>
<p>永続層(DB)からEntityを取得するためのJPQLに共通条件を加える仕組みを紹介する。
これはJPAの標準仕様ではなく、Hibernateが拡張した仕組み機能である。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>想定される適用ケース</strong></p>
<p class="last">データの監査やデータの保存期間などの要件により、Entityを削除する際に、レコードの物理削除(DELETE)ではなく、論理削除(論理削除フラグのUPDATE)を行うようなアプリケーションが有効である。
このケースでは、アプリケーションとしては論理削除されたレコードは一律検索対象から除外する必要があるため、Queryひとつひとつに除外するための条件を加えるより、共通条件として指定した方がよい。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>適用範囲について</strong></p>
<p class="last">この仕組みを適用したEntityを操作するすべてのQueryに対して、指定した条件が追加される点に注意すること。条件を加えたくないQueryが1つでもある場合は、この仕組みは使用できない。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="id44">
<h4><a class="toc-backref" href="#id123">6.3.3.4.1. Entityを取得するJPQLに共通条件を加える</a><a class="headerlink" href="#id44" title="Permalink to this headline">¶</a></h4>
<p>Repositoryインタフェースのメソッド呼び出し時に実行されるJPQLに対して、共通の条件を加える方法を以下に示す。</p>
<ul class="simple">
<li>Entity</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;t_order&quot;</span><span class="o">)</span>
<span class="nd">@Where</span><span class="o">(</span><span class="n">clause</span> <span class="o">=</span> <span class="s">&quot;is_logical_delete = false&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="c1">// ...</span>
    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>RepositoryインタフェースのfindOneメソッドを呼び出した時に発行されるSQL</li>
</ul>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
        <span class="c1">-- ....</span>
    <span class="k">FROM</span>
        <span class="n">t_order</span> <span class="n">order0_</span>
   <span class="k">WHERE</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">AND</span> <span class="p">(</span>
            <span class="n">order0_</span><span class="p">.</span><span class="n">is_logical_delete</span> <span class="o">=</span> <span class="k">false</span> <span class="c1">-- (2)</span>
        <span class="p">);</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Entityのクラスアノテーションとして、 <code class="docutils literal"><span class="pre">&#64;org.hibernate.annotations.Where</span></code> アノテーションを付与し、 clause属性に共通の条件を指定する。</div>
<div class="line">ここで指定するWHERE句の書式は、JPQLではなく、SQLで指定する必要がある。つまりJavaオブジェクトのプロパティ名ではなくカラム名を指定する必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;Where</span></code> アノテーションで指定した条件が追加されている。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Dialect 拡張について</strong></p>
<p class="last"><code class="docutils literal"><span class="pre">&#64;Where</span></code> アノテーション内でSQL固有のキーワードを指定する場合、HibernateがSQL固有のキーワードを一般的な文字列として認識されてしまい、期待したSQLへ変換されないケースがある。
SQL固有のキーワードを利用する場合に、 <code class="docutils literal"><span class="pre">Dialect</span></code> を拡張して使用する必要がある。</p>
</div>
</div></blockquote>
<ul class="simple">
<li>標準的なキーワード <code class="docutils literal"><span class="pre">true</span></code> 、<code class="docutils literal"><span class="pre">false</span></code> 、<code class="docutils literal"><span class="pre">unknown</span></code> などを登録するための <code class="docutils literal"><span class="pre">Dialect</span></code> を拡張する</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.infra.hibernate</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExtendedPostgreSQL9Dialect</span> <span class="kd">extends</span> <span class="n">PostgreSQL9Dialect</span> <span class="o">{</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="nf">ExtendedPostgreSQL9Dialect</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">();</span>
        <span class="c1">// (2)</span>
        <span class="n">registerKeyword</span><span class="o">(</span><span class="s">&quot;true&quot;</span><span class="o">);</span>
        <span class="n">registerKeyword</span><span class="o">(</span><span class="s">&quot;false&quot;</span><span class="o">);</span>
        <span class="n">registerKeyword</span><span class="o">(</span><span class="s">&quot;unknown&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Hibernate 4.3のデフォルトの状態では、SQLのキーワードを正しく認識できない場合がある。例えば、PostgreSQL向けのキーワードを管理する <code class="docutils literal"><span class="pre">org.hibernate.dialect.PostgreSQL9Dialect</span></code> にはキーワードとしてBOOLEAN型の <code class="docutils literal"><span class="pre">true</span></code> 、<code class="docutils literal"><span class="pre">false</span></code> 、<code class="docutils literal"><span class="pre">unknown</span></code> などが登録されていないため、一般的な文字列として認識されてしまい、正しいSQLへ変換されない。</div>
<div class="line">そのため、必要に応じて <code class="docutils literal"><span class="pre">org.hibernate.dialect.Dialect</span></code> を拡張し、キーワードを登録する必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;Where</span></code> で利用する可能性のあるSQLキーワードを登録する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>拡張したDialectを設定する</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;jpaVendorAdapter&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;databasePlatform&quot;</span> <span class="na">value=</span><span class="s">&quot;com.example.infra.hibernate.ExtendedPostgreSQL9Dialect&quot;</span><span class="nt">/&gt;</span> // (3)
    // ...
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">拡張した <code class="docutils literal"><span class="pre">Dialect</span></code> を <code class="docutils literal"><span class="pre">EntityManager</span></code> である <code class="docutils literal"><span class="pre">JpaVendorAdapter</span></code> の <code class="docutils literal"><span class="pre">databasePlatform</span></code> プロパティの値に設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>指定可能なクラスについて</strong></p>
<p class="last"><code class="docutils literal"><span class="pre">&#64;Where</span></code> アノテーションは、 <code class="docutils literal"><span class="pre">&#64;Entity</span></code> が付与されているクラスでのみ有効である。
つまり、 <code class="docutils literal"><span class="pre">&#64;javax.persistence.MappedSuperclass</span></code> を付与した基底Entityクラスに付与してもSQLに付与されない。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><code class="docutils literal"><span class="pre">&#64;Where</span></code> アノテーションは、JPAの標準アノテーションではなく、Hibernate独自のアノテーションである。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id45">
<h4><a class="toc-backref" href="#id124">6.3.3.4.2. 関連Entityを取得するJPQLに共通条件を加える</a><a class="headerlink" href="#id45" title="Permalink to this headline">¶</a></h4>
<p>Repositoryインタフェースのメソッド呼び出して取得したEntityの関連Entityを取得するためのJPQLに対して、共通の条件を加える方法を以下に示す。</p>
<ul class="simple">
<li>Entity</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;t_order&quot;</span><span class="o">)</span>
<span class="nd">@Where</span><span class="o">(</span><span class="n">clause</span> <span class="o">=</span> <span class="s">&quot;is_logical_delete = false&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="c1">// ...</span>
    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">&quot;order&quot;</span><span class="o">,</span> <span class="n">cascade</span> <span class="o">=</span> <span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span> <span class="n">orphanRemoval</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="nd">@OrderBy</span>
    <span class="nd">@Where</span><span class="o">(</span><span class="n">clause</span><span class="o">=</span><span class="s">&quot;is_logical_delete = false&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">OrderItem</span><span class="o">&gt;</span> <span class="n">orderItems</span><span class="o">;</span>
    <span class="c1">// ...</span>

<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>関連Entityにアクセスした際に発行されるSQL(Lazy Load)</li>
</ul>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
        <span class="c1">-- ...</span>
    <span class="k">FROM</span>
        <span class="n">t_order_item</span> <span class="n">orderitems0_</span>
    <span class="k">WHERE</span>
        <span class="p">(</span><span class="n">orderitems0</span><span class="p">.</span><span class="n">is_logical_delete</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span> <span class="c1">-- (2)</span>
        <span class="k">AND</span> <span class="n">orderitems0_</span><span class="p">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="n">orderitems0_</span><span class="p">.</span><span class="n">item_code</span> <span class="k">ASC</span>
        <span class="p">,</span><span class="n">orderitems0_</span><span class="p">.</span><span class="n">order_id</span> <span class="k">ASC</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>Entityと関連Entityを同時に取得する際に発行されるSQL(Eager Load / Join Fetch)</li>
</ul>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
    <span class="c1">-- ...</span>
    <span class="k">FROM</span>
        <span class="n">t_order</span> <span class="n">order0_</span>
            <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">t_order_item</span> <span class="n">orderitems1_</span>
                <span class="k">ON</span> <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">orderitems1_</span><span class="p">.</span><span class="n">order_id</span>
                <span class="k">AND</span> <span class="p">(</span><span class="n">orderitems1_</span><span class="p">.</span><span class="n">is_logical_delete</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span> <span class="c1">-- (2)</span>
    <span class="k">WHERE</span>
        <span class="n">order0_</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">AND</span> <span class="p">(</span>
            <span class="n">order0_</span><span class="p">.</span><span class="n">is_logical_delete</span> <span class="o">=</span> <span class="k">false</span>
        <span class="p">)</span>
    <span class="k">ORDER</span> <span class="k">BY</span>
        <span class="n">orderitems1_</span><span class="p">.</span><span class="n">item_code</span> <span class="k">ASC</span>
        <span class="p">,</span><span class="n">orderitems1_</span><span class="p">.</span><span class="n">order_id</span> <span class="k">ASC</span><span class="p">;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">関連Entityのフィールドアノテーションとして、 <code class="docutils literal"><span class="pre">&#64;org.hibernate.annotations.Where</span></code> アノテーションを付与し、 clause属性に共通の条件を指定する。</div>
<div class="line">ここで指定するWHERE句の書式は、JPQLではなく、SQLで指定する必要がある。つまりJavaオブジェクトのプロパティ名ではなくカラム名を指定する必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;Where</span></code> アノテーションで指定した条件が追加されている。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>指定可能な関連の種類について</strong></p>
<p class="last">関連Entityを取得する際のSQLに共通の条件を加えることができるのは、 <code class="docutils literal"><span class="pre">&#64;OneToMany</span></code> および <code class="docutils literal"><span class="pre">&#64;ManyToMany</span></code> の関連をもつEntityに対してのみとなる。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><code class="docutils literal"><span class="pre">&#64;Where</span></code> アノテーションは、JPAの標準アノテーションではなく、Hibernate独自のアノテーションである。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="persistenceunit">
<h3><a class="toc-backref" href="#id125">6.3.3.5. 複数のPersistenceUnitを使用する方法</a><a class="headerlink" href="#persistenceunit" title="Permalink to this headline">¶</a></h3>
<div class="admonition-todo admonition" id="index-4">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<blockquote class="last">
<div><p>今後、以下の内容を追加する予定である。</p>
<ul class="simple">
<li>複数のPersistenceUnitの使用例。</li>
</ul>
</div></blockquote>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="native">
<h3><a class="toc-backref" href="#id126">6.3.3.6. Nativeクエリの使用方法</a><a class="headerlink" href="#native" title="Permalink to this headline">¶</a></h3>
<div class="admonition-todo admonition" id="index-5">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<blockquote class="last">
<div><p>今後、以下の内容を追加する予定である。</p>
<ul class="simple">
<li>Nativeクエリを使用したQueryの実装例。</li>
</ul>
</div></blockquote>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ExclusionControl.html" title="6.4. 排他制御"
             >next</a> |</li>
        <li class="right" >
          <a href="DataAccessMyBatis3.html" title="6.2. データベースアクセス（MyBatis3編）"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.4.2.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >6. データアクセス</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer">
      © Copyright 2013, NTT DATA Corporation. © Copyright 2013, NTT Corporation.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3.Theme is <a href="http://github.com/vimalkvn/solar-theme">Solar</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>
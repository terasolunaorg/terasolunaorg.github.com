<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>2.4. アプリケーションのレイヤ化 &#8212; TERASOLUNA Global Framework Development Guideline 1.0.1.RELEASE documentation</title>
    <link rel="stylesheet" href="../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0.1.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3. チュートリアル(Todoアプリケーション)" href="../TutorialTodo/index.html" />
    <link rel="prev" title="2.3. はじめてのSpring MVCアプリケーション" href="FirstApplication.html" /><script async src="https://www.googletagmanager.com/gtag/js?id=G-847V2Q99G8"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date()); gtag('config', 'G-847V2Q99G8');
</script>
<script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../TutorialTodo/index.html" title="3. チュートリアル(Todoアプリケーション)"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="FirstApplication.html" title="2.3. はじめてのSpring MVCアプリケーション"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Global Framework Development Guideline 1.0.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">2. TERASOLUNA Global Frameworkのアーキテクチャ概要</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">2.4. アプリケーションのレイヤ化</a><ul>
<li><a class="reference internal" href="#id3">2.4.1. レイヤの定義</a><ul>
<li><a class="reference internal" href="#id4">2.4.1.1. アプリケーション層</a><ul>
<li><a class="reference internal" href="#controller">2.4.1.1.1. Controller</a></li>
<li><a class="reference internal" href="#view">2.4.1.1.2. View</a></li>
<li><a class="reference internal" href="#form">2.4.1.1.3. Form</a></li>
<li><a class="reference internal" href="#helper">2.4.1.1.4. Helper</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id5">2.4.1.2. ドメイン層</a><ul>
<li><a class="reference internal" href="#domain-object">2.4.1.2.1. Domain Object</a></li>
<li><a class="reference internal" href="#repository">2.4.1.2.2. Repository</a></li>
<li><a class="reference internal" href="#service">2.4.1.2.3. Service</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id8">2.4.1.3. インフラストラクチャ層</a><ul>
<li><a class="reference internal" href="#repositoryimpl">2.4.1.3.1. RepositoryImpl</a></li>
<li><a class="reference internal" href="#o-r-mapper">2.4.1.3.2. O/R Mapper</a></li>
<li><a class="reference internal" href="#integration-system-connector">2.4.1.3.3. Integration System Connector</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id9">2.4.2. レイヤ間の依存関係</a></li>
<li><a class="reference internal" href="#application-layering-project-structure">2.4.3. プロジェクト構成</a><ul>
<li><a class="reference internal" href="#projectname-domain">2.4.3.1. [projectname]-domain</a></li>
<li><a class="reference internal" href="#projectname-web">2.4.3.2. [projectname]-web</a></li>
<li><a class="reference internal" href="#projectname-env">2.4.3.3. [projectname]-env</a></li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="FirstApplication.html"
                        title="previous chapter">2.3. はじめてのSpring MVCアプリケーション</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../TutorialTodo/index.html"
                        title="next chapter">3. チュートリアル(Todoアプリケーション)</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/Overview/ApplicationLayering.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="id1">
<h1>2.4. アプリケーションのレイヤ化<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<div class="admonition caution">
  <p class="first admonition-title">Caution</p>
  <p><strong>本バージョンの内容は既に古くなっています</strong>。最新のガイドラインは<a href="http://terasolunaorg.github.io/guideline/">こちら</a>からご参照ください。</p>
</div>
<div class="contents local topic" id="id2">
<p class="topic-title">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#id3" id="id15">レイヤの定義</a><ul>
<li><a class="reference internal" href="#id4" id="id16">アプリケーション層</a><ul>
<li><a class="reference internal" href="#controller" id="id17">Controller</a></li>
<li><a class="reference internal" href="#view" id="id18">View</a></li>
<li><a class="reference internal" href="#form" id="id19">Form</a></li>
<li><a class="reference internal" href="#helper" id="id20">Helper</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id5" id="id21">ドメイン層</a><ul>
<li><a class="reference internal" href="#domain-object" id="id22">Domain Object</a></li>
<li><a class="reference internal" href="#repository" id="id23">Repository</a></li>
<li><a class="reference internal" href="#service" id="id24">Service</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id8" id="id25">インフラストラクチャ層</a><ul>
<li><a class="reference internal" href="#repositoryimpl" id="id26">RepositoryImpl</a></li>
<li><a class="reference internal" href="#o-r-mapper" id="id27">O/R Mapper</a></li>
<li><a class="reference internal" href="#integration-system-connector" id="id28">Integration System Connector</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id9" id="id29">レイヤ間の依存関係</a></li>
<li><a class="reference internal" href="#application-layering-project-structure" id="id30">プロジェクト構成</a><ul>
<li><a class="reference internal" href="#projectname-domain" id="id31">[projectname]-domain</a></li>
<li><a class="reference internal" href="#projectname-web" id="id32">[projectname]-web</a></li>
<li><a class="reference internal" href="#projectname-env" id="id33">[projectname]-env</a></li>
</ul>
</li>
</ul>
</div>
<p>本ガイドラインでは、アプリケーションを、次の3レイヤで分割する。</p>
<ul class="simple">
<li>アプリケーション層</li>
<li>ドメイン層</li>
<li>インフラストラクチャ層</li>
</ul>
<p>各層には、以下のコンポーネントが含まれる。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/ApplicationLayer.png"><img alt="application layers" src="../_images/ApplicationLayer.png" style="width: 80%;" /></a>
</div>
<div class="line-block">
<div class="line">アプリケーション層も、インフラストラクチャ層も、ドメイン層に依存するが、<strong>ドメイン層が、他の層に依存してはいけない。</strong></div>
<div class="line">ドメイン層の変更によって、アプリケーション層に変更が生じるのは良いが、</div>
<div class="line">アプリケーション層の変更によって、ドメイン層の変更が生じるべきではない。</div>
</div>
<p>各層について、説明する。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">アプリケーション層、ドメイン層、インフラストラクチャー層は
Eric Evansの”Domain-Driven Design (2004, Addison-Wesley)”で説明されてる用語である。
ただし、用語は使用しているが以後Domain Driven Designの考えにのっとっているわけではない。</p>
</div>
<div class="section" id="id3">
<h2><a class="toc-backref" href="#id15">2.4.1. レイヤの定義</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>入力から出力までのデータの流れは、アプリケーション層→ドメイン層→インフラストラクチャ層であるため、
この順に説明する。</p>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id16">2.4.1.1. アプリケーション層</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">情報の入出力となるUIを提供したり、リクエスト情報をドメイン層や、他システムから呼び出し、表示用の出力を返す手続きを行うなど、</div>
<div class="line">アプリケーションを構築するための層である。<strong>この層は、できるだけ薄く保たれるべきであり、ビジネスルールを含んではいけない。</strong></div>
</div>
<div class="section" id="controller">
<h4><a class="toc-backref" href="#id17">2.4.1.1.1. Controller</a><a class="headerlink" href="#controller" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">基本的には、リクエストを処理にマッピングし、結果をViewに渡すという画面遷移と、セッション管理を担う。</div>
<div class="line">主処理は、Controller内では行わず、ドメイン層のServiceを呼び出す。</div>
</div>
<p>Spring MVCでは、<code class="docutils literal"><span class="pre">&#64;Controller</span></code>アノテーションがついた、POJOクラスが該当する。
Controllerの結果がView(の論理名)になる。</p>
</div>
<div class="section" id="view">
<h4><a class="toc-backref" href="#id18">2.4.1.1.2. View</a><a class="headerlink" href="#view" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">クライアントへの出力を担う。JSP/PDF/Excel/JSONなど、様々な出力結果を返す。</div>
<div class="line">Spring MVCでは、<code class="docutils literal"><span class="pre">View</span></code>クラスが該当する。</div>
</div>
</div>
<div class="section" id="form">
<h4><a class="toc-backref" href="#id19">2.4.1.1.3. Form</a><a class="headerlink" href="#form" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">画面のフォームを表現する。フォームの情報をControllerに渡したり、Contollerからフォームに出力する際に用いられる。</div>
<div class="line">ドメイン層がアプリケーション層に依存しないように、FormからDomain Object(Entity等)への変換や、</div>
<div class="line">Domain ObjectからFormへの変換は、アプリケーション層で行う必要ある。</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">変換処理を実装する際、Controller内で行うと、ソースコードが長くなり、
本来のControllerの処理(画面遷移など)の見通しが、悪くなりがちである。
その場合は、Helperクラスを作成し、変換処理を委譲することを推奨する。</p>
</div>
<p>Spring MVCでは、Formオブジェクトは、リクエストパラメータを保持するPOJOクラスが該当する。form backing beanと呼ばれる。</p>
</div>
<div class="section" id="helper">
<h4><a class="toc-backref" href="#id20">2.4.1.1.4. Helper</a><a class="headerlink" href="#helper" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Controllerを補助する役割を担い、Application層とDomain層のモデル相互変換など、Controller本来の処理以外の処理を行う。</div>
<div class="line">Controllerの一部とみなしてよい。</div>
</div>
<p>Helperはoptionであり、必要に応じて、POJOクラスとして作成すること。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>HelperはControllerの見通しを良くするためのものであり、HelperはControllerの一部だと思えばよい。</p>
<p>Controllerの役割はルーティング(URLマッピングと遷移先の返却)であり、それ以外の処理(JavaBeanの変換等)が必要になったらHelperに切り出してそちらに処理を移すことを推奨する。</p>
<p class="last">あくまでもControllerをすっきりさせて、本来のControllerの処理が見やすくなることを目的としており、Controller内のprivateメソッドみたいなものである。</p>
</div>
</div>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id21">2.4.1.2. ドメイン層</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">ドメイン層は、アプリケーションのコアとなる層である。ビジネス上の解決すべき問題を表現し、</div>
<div class="line">ビジネスオブジェクトや、ビジネスルールを含む(口座へ入金する場合に、残高が十分であるかどうかのチェックなど)。</div>
<div class="line">ドメイン層は、他の層からは疎であり、再利用できる。</div>
</div>
<div class="section" id="domain-object">
<h4><a class="toc-backref" href="#id22">2.4.1.2.1. Domain Object</a><a class="headerlink" href="#domain-object" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Domain Objectはビジネスを行う上で必要な資源や、ビジネスを行っていく過程で発生するものを表現するモデル。</div>
<div class="line">大きく分けて、以下3つに分類される。</div>
</div>
<ul class="simple">
<li>EmployeeやCustomer, Productなどのリソース系モデル(一般的には、名詞で表現される）,</li>
<li>Order, Paymentなどイベント系モデル(一般的には動詞で表現される)、</li>
<li>YearlySales, MonthlySalesなどのサマリ系モデル</li>
</ul>
<p>データベースのあるテーブルの、1レコードを表現するオブジェクトを表現するEntityは、Domain Objectである。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>本ガイドラインでは主に、<a class="reference external" href="http://martinfowler.com/bliki/AnemicDomainModel.html">状態のみもつモデル</a>を扱う。</p>
<p>Martin Fowlerの”Patterns of Enterprise Application Architecture (2002, Addison-Wesley)”では、
Domain Modelは、<a class="reference external" href="http://martinfowler.com/eaaCatalog/domainModel.html">状態と振る舞いをもつもの</a>と定義されているが、
厳密には触れない。</p>
<p class="last">Eric Evansの提唱するような<a class="reference external" href="http://domaindrivendesign.org">Richなドメインモデル</a>も、本ガイドラインでは扱わないが、
分類上はここに含まれる。</p>
</div>
</div>
<div class="section" id="repository">
<h4><a class="toc-backref" href="#id23">2.4.1.2.2. Repository</a><a class="headerlink" href="#repository" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Domain Objectのコレクションのような位置づけであり、Domain Objectの問い合わせや、作成、更新、削除のようなCRUD処理を担う。</div>
<div class="line">この層では、インタフェースのみ定義され、実体は、インフラストラクチャ層のRepositoryImplで実装されるため、</div>
<div class="line">どのようなデータアクセスが行われているかについての情報は持たない。</div>
</div>
</div>
<div class="section" id="service">
<h4><a class="toc-backref" href="#id24">2.4.1.2.3. Service</a><a class="headerlink" href="#service" title="Permalink to this headline">¶</a></h4>
<p>業務処理を提供する。
この処理も、トランザクション境界となる。</p>
<div class="line-block">
<div class="line">Serviceでは、FormやHttpRequestなど、Webに関わる情報を扱うべきではない。</div>
<div class="line">これらの情報は、Serviceの前のApplication層で、ドメイン層のオブジェクトに変換されるべきである。</div>
</div>
</div>
</div>
<div class="section" id="id8">
<h3><a class="toc-backref" href="#id25">2.4.1.3. インフラストラクチャ層</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">インフラストラクチャ層では、ドメイン層(Repositoryインタフェース)の実装を提供する。</div>
<div class="line">データストア(RDBMSや、NoSQLなどのデータを格納する場所)への永続化や、メッセージの送信などを担う。</div>
</div>
<div class="section" id="repositoryimpl">
<h4><a class="toc-backref" href="#id26">2.4.1.3.1. RepositoryImpl</a><a class="headerlink" href="#repositoryimpl" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">RepositoryImplは、Repositoryの実装であり、Domain Objectのライフサイクル管理を隠蔽する。</div>
<div class="line">これにより、ドメイン層がどのようにデータアクセスされているか意識しなくて済む。</div>
</div>
<p>Spring Data JPAを使用する場合は、Spring Data JPAが実体を(一部)自動で作成する。</p>
</div>
<div class="section" id="o-r-mapper">
<h4><a class="toc-backref" href="#id27">2.4.1.3.2. O/R Mapper</a><a class="headerlink" href="#o-r-mapper" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">データベースとEntityの相互マッピングを担う。</div>
<div class="line">JPAや、MyBatis, Spring JDBCが本機能を提供する。</div>
<div class="line">特に、JPAを用いる場合はEntityManager、MyBatis2(TERASOLUNA DAO)を用いる場合は、QueryDAO, UpdateDAOが該当する。</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">MyBatis, Spring JDBCは「O/R Mapper」というより、「SQL Mapper」と呼んだ方が正確であるが、本ガイドラインでは「O/R Mapper」に分類する。</p>
</div>
</div>
<div class="section" id="integration-system-connector">
<h4><a class="toc-backref" href="#id28">2.4.1.3.3. Integration System Connector</a><a class="headerlink" href="#integration-system-connector" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">メッセージングシステムや、Key-Value-Store、Webサービス、既存システムなど、</div>
<div class="line">データベース以外のデータストア、あるいは外部システムとの連携を担う。</div>
<div class="line">Repositoryの実装に用いられる。</div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="id9">
<h2><a class="toc-backref" href="#id29">2.4.2. レイヤ間の依存関係</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line">冒頭で説明したとおり、ドメイン層がコアとなり、アプリケーション層、インフラストラクチャ層がそれに依存する形となる。</div>
</div>
<div class="line-block">
<div class="line">本ガイドラインでは、実装技術として、</div>
</div>
<ul class="simple">
<li>アプリケーション層にSpring MVC</li>
<li>インフラストラクチャ層にSpring Data JPA, MyBatis</li>
</ul>
<div class="line-block">
<div class="line">を使用することを想定しているが、本質的には、実装技術が変わっても、それぞれの層で違いが吸収され、ドメイン層には影響を与えない。</div>
<div class="line">レイヤ間の結合部は、インタフェースとして公開することで、各層が使用している実装技術に依存しない形式とすることができる。</div>
</div>
<p>レイヤ化を意識して、疎結合な設計を行うことを推奨する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/LayerDependencies.png"><img alt="../_images/LayerDependencies.png" src="../_images/LayerDependencies.png" style="width: 80%;" /></a>
</div>
<p>各レイヤのオブジェクトの依存関係は、DIコンテナによって解決される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/LayerDependencyInjection.png"><img alt="../_images/LayerDependencyInjection.png" src="../_images/LayerDependencyInjection.png" style="width: 90%;" /></a>
</div>
<p>入力から出力までの流れで表現すると、次の図のようになる。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/LayeringPattern1.png"><img alt="Data flow from request to reponse" src="../_images/LayeringPattern1.png" style="width: 100%;" /></a>
</div>
<p>更新系の処理を例に、シーケンスを説明する。</p>
<ol class="arabic simple">
<li>Controllerが、Requestを受け付ける</li>
<li>(Optional) Controllerは、Helperを呼び出し、Formの情報を、Domain ObjectまたはDTOに変換する</li>
<li>Controllerは、Domain ObjectまたはDTOを用いて、Serviceを呼び出す</li>
<li>Serviceは、Repositoryを呼び出して、業務処理を行う</li>
<li>Repositoryは、O/R Mapperを呼び出し、Domain ObjectまたはDTOを永続化する</li>
<li>(実装依存) O/R Mapperは、DBにDomain ObjectまたはDTOの情報を保存する</li>
<li>Serviceは、業務処理結果のDomain ObjectまたはDTOを、Controllerに返却する</li>
<li>(Optional) Controllerは、Helperを呼び出し、Domain ObjectまたはDTOを、Formに変換する</li>
<li>Controllerは、遷移先のView名を返却する</li>
<li>Viewは、Responseを出力する。</li>
</ol>
<p>この場合の各コンポーネント間の呼び出し可否を、以下にまとめる。</p>
<table border="1" class="docutils" id="id13">
<caption><span class="caption-text">コンポーネント間の呼び出し可否</span><a class="headerlink" href="#id13" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="20%" />
<col width="20%" />
<col width="20%" />
<col width="20%" />
<col width="20%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">Caller/Callee</th>
<th class="head">Controller</th>
<th class="head">Service</th>
<th class="head">Repository</th>
<th class="head">O/R Mapper</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">Controller</th>
<td><img alt="../_images/cross.png" class="first last align-center" src="../_images/cross.png" />
</td>
<td><img alt="../_images/tick.png" class="first last align-center" src="../_images/tick.png" />
</td>
<td><img alt="../_images/cross.png" class="first last align-center" src="../_images/cross.png" />
</td>
<td><img alt="../_images/cross.png" class="first last align-center" src="../_images/cross.png" />
</td>
</tr>
<tr class="row-odd"><th class="stub">Service</th>
<td><img alt="../_images/cross.png" class="first last align-center" src="../_images/cross.png" />
</td>
<td><img alt="../_images/exclamation.png" class="first last align-center" src="../_images/exclamation.png" />
</td>
<td><img alt="../_images/tick.png" class="first last align-center" src="../_images/tick.png" />
</td>
<td><img alt="../_images/cross.png" class="first last align-center" src="../_images/cross.png" />
</td>
</tr>
<tr class="row-even"><th class="stub">Repository</th>
<td><img alt="../_images/cross.png" class="first last align-center" src="../_images/cross.png" />
</td>
<td><img alt="../_images/cross.png" class="first last align-center" src="../_images/cross.png" />
</td>
<td><img alt="../_images/cross.png" class="first last align-center" src="../_images/cross.png" />
</td>
<td><img alt="../_images/tick.png" class="first last align-center" src="../_images/tick.png" />
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">注意するべきことは、<strong>基本的にServiceからServiceの呼び出しは、禁止している</strong>点である。</div>
<div class="line">もし他のサービスからも利用可能なサービスが必要な場合は、呼び出し可否を明確にするために、SharedServiceを作成すること。</div>
<div class="line">詳細については、<a class="reference internal" href="../ImplementationAtEachLayer/DomainLayer.html"><span class="doc">ドメイン層の実装</span></a>を参照されたい。</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">この呼び出し可否ルールを守ることは、アプリケーション開発の初期段階では、煩わしく感じられるかもしれない。
確かに、一つの処理だけみると、たとえばControllerから直接Repositoryを呼び出したほうが、速くアプリケーションを作成できる。
しかし、ルールを守らない場合、開発規模が大きくなった際に、修正の影響範囲が分かりにくくなったり、横断的な共通処理を追加しにくくなるなど、
保守性に大きな問題が生じることが多い。後で問題にならないように、初めから依存関係に気を付けて開発することを強く推奨する。</p>
</div>
<div class="line-block">
<div class="line">Repositoryを作成することにより、永続化技術を隠蔽できたり、データアクセス処理を共通化できるなどのメリットがある。</div>
<div class="line">しかし、プロジェクトのチーム体制によっては、データアクセスの共通化が難しい場合がある（複数の会社が、別々に業務処理を実装し、共通化のコントロールが難しい場合など）。</div>
<div class="line">その場合、データアクセスの抽象化が必要ないのであれば、Repositoryは作成せず、以下の図のように、Serviceから直接O/R Mapperを呼び出すようにすればよい。</div>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../_images/LayeringPattern2.png"><img alt="Data flow from request to reponse (without Repository)" src="../_images/LayeringPattern2.png" style="width: 100%;" /></a>
</div>
<p>この場合の呼び出し可否は、次のようになる。</p>
<table border="1" class="docutils" id="id14">
<caption><span class="caption-text">コンポーネント間の呼び出し可否 (without Repository)</span><a class="headerlink" href="#id14" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">Caller/Callee</th>
<th class="head">Controller</th>
<th class="head">Service</th>
<th class="head">O/R Mapper</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">Controller</th>
<td><img alt="../_images/cross.png" class="first last align-center" src="../_images/cross.png" />
</td>
<td><img alt="../_images/tick.png" class="first last align-center" src="../_images/tick.png" />
</td>
<td><img alt="../_images/cross.png" class="first last align-center" src="../_images/cross.png" />
</td>
</tr>
<tr class="row-odd"><th class="stub">Service</th>
<td><img alt="../_images/cross.png" class="first last align-center" src="../_images/cross.png" />
</td>
<td><img alt="../_images/exclamation.png" class="first last align-center" src="../_images/exclamation.png" />
</td>
<td><img alt="../_images/tick.png" class="first last align-center" src="../_images/tick.png" />
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="application-layering-project-structure">
<span id="id10"></span><h2><a class="toc-backref" href="#id30">2.4.3. プロジェクト構成</a><a class="headerlink" href="#application-layering-project-structure" title="Permalink to this headline">¶</a></h2>
<p>上記のように、アプリケーションのレイヤ化を行った場合に推奨する構成について、説明する。</p>
<p>ここでは、Mavenの標準ディレクトリ構造を前提とする。</p>
<p>基本的には、以下の構成でマルチプロジェクトを作成することを推奨する。</p>
<ul class="simple">
<li>[projectname]-domain … ドメイン層に関するクラス・設定ファイルを格納するプロジェクト</li>
<li>[projectname]-web … アプリケーション層に関するクラス・設定ファイルを格納するプロジェクト</li>
<li>[projectname]-env … 環境に依存するファイル等を格納するプロジェクト</li>
</ul>
<p>([projectname]には、対象のプロジェクト名を入れること)</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>RepositoryImplなどインフラストラクチャ層のクラスも、project-domainに含める。</p>
<p class="last">本来は、[projectname]-infraプロジェクトを別途作成すべきであるが、
通常infraプロジェクトを隠蔽化する必要がなく、domainプロジェクトに格納されている方が開発しやすいためである。
必要であれば、[projectname]-infraプロジェクトを作成してよい。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">マルチプロジェクト構成の例として、<a class="reference external" href="https://github.com/terasolunaorg/terasoluna-tourreservation">サンプルアプリケーション</a>や<a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw-functionaltest">共通ライブラリのテストアプリケーション</a>を参照されたい。</p>
</div>
<div class="section" id="projectname-domain">
<h3><a class="toc-backref" href="#id31">2.4.3.1. [projectname]-domain</a><a class="headerlink" href="#projectname-domain" title="Permalink to this headline">¶</a></h3>
<p>[projectname]-domainのプロジェクト推奨構成を、以下に示す。</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">[projectName]-domain</span>
<span class="go">  └src</span>
<span class="go">      └main</span>
<span class="go">          ├java</span>
<span class="go">          │  └com</span>
<span class="go">          │      └example</span>
<span class="go">          │          └domain ...(1)</span>
<span class="go">          │              ├model</span>
<span class="go">          │              │  ├Xxx.java</span>
<span class="go">          │              │  ├Yyy.java</span>
<span class="go">          │              │  └Zzz.java</span>
<span class="go">          │              ├repository ...(2)</span>
<span class="go">          │              │  ├xxx</span>
<span class="go">          │              │  │  └XxxRepository.java</span>
<span class="go">          │              │  ├yyy</span>
<span class="go">          │              │  │  └YyyRepository.java</span>
<span class="go">          │              │  └zzz</span>
<span class="go">          │              │      ├ZzzRepository.java</span>
<span class="go">          │              │      └ZzzRepositoryImpl.java</span>
<span class="go">          │              └service ...(3)</span>
<span class="go">          │                  ├aaa</span>
<span class="go">          │                  │  ├AaaService.java</span>
<span class="go">          │                  │  └AaaServiceImpl.java</span>
<span class="go">          │                  └bbb</span>
<span class="go">          │                      ├BbbService.java</span>
<span class="go">          │                      └BbbServiceImpl.java</span>
<span class="go">          └resources</span>
<span class="go">              └META-INF</span>
<span class="go">                  └spring</span>
<span class="go">                      ├[projectname]-domain.xml ...(4)</span>
<span class="go">                      └[projectname]-infra.xml ...(5)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ドメインオブジェクトを格納する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リポジトリを格納する。エンティティごとにパッケージを作成する。</div>
<div class="line">関連するエンティティがあれば、主となるエンティティのパッケージに、従となるエンティティのRepositoryも配置する。</div>
<div class="line">(OrderとOrderLineなど)。DTOが必要な場合は、このパッケージに配置する。</div>
<div class="line">RepositoryImplは、インフラストラクチャ層に属するが、通常、このプロジェクトに含めても問題ない。</div>
<div class="line">異なるデータストアを使うなど、複数の永続化先があり、実装を隠蔽したい場合は、別プロジェクト(またはパッケージ)に、RepositoryImplを実装するようにする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">サービスを格納する。業務(またはエンティティ)ごとに、パッケージインタフェースと実装を、同じ階層に配置する。</div>
<div class="line">入出力クラスが必要な場合は、このパッケージに配置する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ドメイン層に関するBean定義を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">インフラストラクチャ層に関するBean定義を行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="projectname-web">
<h3><a class="toc-backref" href="#id32">2.4.3.2. [projectname]-web</a><a class="headerlink" href="#projectname-web" title="Permalink to this headline">¶</a></h3>
<p>[projectname]-webのプロジェクト推奨構成を、以下に示す。</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">[projectName]-web</span>
<span class="go">  └src</span>
<span class="go">      └main</span>
<span class="go">          ├java</span>
<span class="go">          │  └com</span>
<span class="go">          │      └example</span>
<span class="go">          │          └app ...(1)</span>
<span class="go">          │              ├abc</span>
<span class="go">          │              │  ├AbcController.java</span>
<span class="go">          │              │  ├AbcForm.java</span>
<span class="go">          │              │  └AbcHelper.java</span>
<span class="go">          │              └def</span>
<span class="go">          │                  ├DefController.java</span>
<span class="go">          │                  ├DefForm.java</span>
<span class="go">          │                  └DefOutput.java</span>
<span class="go">          ├resources</span>
<span class="go">          │  ├META-INF</span>
<span class="go">          │  │  └spring</span>
<span class="go">          │  │      ├applicationContext.xml ...(2)</span>
<span class="go">          │  │      ├application.properties ...(3)</span>
<span class="go">          │  │      ├spring-mvc.xml ...(4)</span>
<span class="go">          │  │      └spring-security.xml ...(5)</span>
<span class="go">          │  └i18n</span>
<span class="go">          │      └application-messages.properties ...(6)</span>
<span class="go">          └webapp</span>
<span class="go">              └WEB-INF</span>
<span class="go">                  ├views ...(7)</span>
<span class="go">                  │  ├abc</span>
<span class="go">                  │  │ ├list.jsp</span>
<span class="go">                  │  │ └createForm.jsp</span>
<span class="go">                  │  └def</span>
<span class="go">                  │     ├list.jsp</span>
<span class="go">                  │     └createForm.jsp</span>
<span class="go">                  └web.xml</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アプリケーション層の構成要素を格納するパッケージ。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アプリケーション全体に関するBean定義を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アプリケーションで使用するプロパティを定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SpringMVCの設定を行うBean定義を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SpringSecurityの設定を行うBean定義を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">画面表示用のメッセージ(国際化対応)定義を行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">View(jsp)を格納する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="projectname-env">
<h3><a class="toc-backref" href="#id33">2.4.3.3. [projectname]-env</a><a class="headerlink" href="#projectname-env" title="Permalink to this headline">¶</a></h3>
<p>[projectname]-envのプロジェクト推奨構成を、以下に示す。</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">[projectName]-env</span>
<span class="go">  └src</span>
<span class="go">      └main</span>
<span class="go">          └resources</span>
<span class="go">              └META-INF</span>
<span class="go">                  └spring</span>
<span class="go">                      ├[projectname]-env.xml ...(1)</span>
<span class="go">                      └[projectname]-infra.properties ...(2)</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">環境に依存するBean定義(DataSource等)を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">環境に依存するプロパティを定義する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>[projectname]-domainと[projectname]-webを別プロジェクトに分ける理由は、依存関係の逆転を防ぐためである。</p>
<p>[projectname]-webが[projectname]-domainを使用するのは当然であるが、[projectname]-domainが[projectname]-webを参照してはいけない。</p>
<p class="last">1つのプロジェクトに[projectname]-webと[projectname]-domainの構成要素をまとめてしまうと、誤って不正な参照してしまうことがある。
プロジェクトを分けて参照順序をつけることで[projectname]-domainが[projectname]-webを参照できないようにすることを強く推奨する。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>[projectname]-envを作成する理由は環境に依存する情報を外出し、環境毎に切り替えられるようにするためである。</p>
<p>たとえばデフォルトではローカル開発環境用の設定をして、アプリビルド時には[projectname]-envを除いてwarを作成する。
結合テスト用の環境やシステムテスト用の環境を別々のjarとして作成すると、そこだけ差し替えてデプロイするということが可能である。</p>
<p>また使用するRDBMSが変わるようなプロジェクトの場合にも影響を最小限に抑えることができる。</p>
<p>この点を考慮しない場合は、環境ごとに設定ファイルの内容を行いビルドしなおすという作業が入る。</p>
<p class="last">環境依存に関するファイルを別プロジェクトにする意義については、<a class="reference internal" href="../Appendix/EnvironmentIndependency.html"><span class="doc">環境依存性の排除</span></a>を参照されたい。</p>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../TutorialTodo/index.html" title="3. チュートリアル(Todoアプリケーション)"
             >next</a> |</li>
        <li class="right" >
          <a href="FirstApplication.html" title="2.3. はじめてのSpring MVCアプリケーション"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Global Framework Development Guideline 1.0.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >2. TERASOLUNA Global Frameworkのアーキテクチャ概要</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013-2014, NTT DATA.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3.Theme by <a href="http://github.com/vkvn">vkvn</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>

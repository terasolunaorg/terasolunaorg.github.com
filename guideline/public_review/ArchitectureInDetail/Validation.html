<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>5.5. 入力チェック &mdash; TERASOLUNA Global Framework Development Guideline 1.0.0.publicreview documentation</title>
    
    <link rel="stylesheet" href="../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0.0.publicreview',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="TERASOLUNA Global Framework Development Guideline 1.0.0.publicreview documentation" href="../index.html" />
    <link rel="up" title="5. TERASOLUNA Global Frameworkの機能詳細" href="index.html" />
    <link rel="next" title="5.6. ロギング" href="Logging.html" />
    <link rel="prev" title="5.4. 排他制御" href="ExclusionControl.html" /><script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="Logging.html" title="5.6. ロギング"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ExclusionControl.html" title="5.4. 排他制御"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">TERASOLUNA Global Framework Development Guideline 1.0.0.publicreview documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">5. TERASOLUNA Global Frameworkの機能詳細</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">5.5. 入力チェック</a><ul>
<li><a class="reference internal" href="#overview">5.5.1. Overview</a><ul>
<li><a class="reference internal" href="#id3">5.5.1.1. 入力チェックの分類</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">5.5.2. How to use</a><ul>
<li><a class="reference internal" href="#validation-single-check">5.5.2.1. 単項目チェック</a><ul>
<li><a class="reference internal" href="#validation-basic-validation">5.5.2.1.1. 基本的な単項目チェック</a></li>
<li><a class="reference internal" href="#bean">5.5.2.1.2. ネストしたBeanの単項目チェック</a></li>
<li><a class="reference internal" href="#id6">5.5.2.1.3. バリデーションのグループ化</a></li>
</ul>
</li>
<li><a class="reference internal" href="#validation-correlation-check">5.5.2.2. 相関項目チェック</a><ul>
<li><a class="reference internal" href="#spring-validator">5.5.2.2.1. Spring Validatorによる相関項目チェック実装</a></li>
<li><a class="reference internal" href="#bean-validation">5.5.2.2.2. Bean Validationによる相関項目チェック実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#validation-message-def">5.5.2.3. エラーメッセージの定義</a><ul>
<li><a class="reference internal" href="#validationmessages-properties">5.5.2.3.1. ValidationMessages.propertiesに定義するメッセージ</a></li>
<li><a class="reference internal" href="#application-messages-properties">5.5.2.3.2. application-messages.propertiesに定義するメッセージ</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend">5.5.3. How to extend</a><ul>
<li><a class="reference internal" href="#id10">5.5.3.1. 既存ルールを組み合わせたBean Validationアノテーションの作成</a></li>
<li><a class="reference internal" href="#id11">5.5.3.2. 新規ルールを実装したBean Validationアノテーションの作成</a><ul>
<li><a class="reference internal" href="#id12">5.5.3.2.1. 既存のルールの組み合わせでは表現できないルール</a></li>
<li><a class="reference internal" href="#id13">5.5.3.2.2. 相関項目チェックルール</a></li>
<li><a class="reference internal" href="#id14">5.5.3.2.3. 業務ロジックチェック</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix">5.5.4. Appendix</a><ul>
<li><a class="reference internal" href="#id15">5.5.4.1. Hibernate Validatorが用意する入力チェックルール</a><ul>
<li><a class="reference internal" href="#jsr-303">5.5.4.1.1. JSR-303のチェックルール</a></li>
<li><a class="reference internal" href="#validation-validator-list">5.5.4.1.2. Hibernate Validatorのチェックルール</a></li>
</ul>
</li>
<li><a class="reference internal" href="#validation-default-message-in-hibernate-validator">5.5.4.2. Hibernate Validatorが用意するデフォルトメッセージ</a></li>
<li><a class="reference internal" href="#id20">5.5.4.3. 型のミスマッチ</a></li>
<li><a class="reference internal" href="#null">5.5.4.4. 文字列フィールドが未入力の場合にnullをバインドする</a></li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="ExclusionControl.html"
                        title="previous chapter">5.4. 排他制御</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="Logging.html"
                        title="next chapter">5.6. ロギング</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/ArchitectureInDetail/Validation.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="id1">
<div class="admonition caution">
  <p class="first admonition-title">Caution</p>
  <p><strong>本バージョンの内容は既に古くなっています</strong>。最新のガイドラインは<a href="http://terasolunaorg.github.io/guideline/">こちら</a>からご参照ください。</p>
</div>
<h1><a class="toc-backref" href="#id22">5.5. 入力チェック</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="id2">
<p class="topic-title first">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#id1" id="id22">入力チェック</a><ul>
<li><a class="reference internal" href="#overview" id="id23">Overview</a><ul>
<li><a class="reference internal" href="#id3" id="id24">入力チェックの分類</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use" id="id25">How to use</a><ul>
<li><a class="reference internal" href="#validation-single-check" id="id26">単項目チェック</a><ul>
<li><a class="reference internal" href="#validation-basic-validation" id="id27">基本的な単項目チェック</a></li>
<li><a class="reference internal" href="#bean" id="id28">ネストしたBeanの単項目チェック</a></li>
<li><a class="reference internal" href="#id6" id="id29">バリデーションのグループ化</a></li>
</ul>
</li>
<li><a class="reference internal" href="#validation-correlation-check" id="id30">相関項目チェック</a><ul>
<li><a class="reference internal" href="#spring-validator" id="id31">Spring Validatorによる相関項目チェック実装</a></li>
<li><a class="reference internal" href="#bean-validation" id="id32">Bean Validationによる相関項目チェック実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#validation-message-def" id="id33">エラーメッセージの定義</a><ul>
<li><a class="reference internal" href="#validationmessages-properties" id="id34">ValidationMessages.propertiesに定義するメッセージ</a></li>
<li><a class="reference internal" href="#application-messages-properties" id="id35">application-messages.propertiesに定義するメッセージ</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend" id="id36">How to extend</a><ul>
<li><a class="reference internal" href="#id10" id="id37">既存ルールを組み合わせたBean Validationアノテーションの作成</a></li>
<li><a class="reference internal" href="#id11" id="id38">新規ルールを実装したBean Validationアノテーションの作成</a><ul>
<li><a class="reference internal" href="#id12" id="id39">既存のルールの組み合わせでは表現できないルール</a></li>
<li><a class="reference internal" href="#id13" id="id40">相関項目チェックルール</a></li>
<li><a class="reference internal" href="#id14" id="id41">業務ロジックチェック</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix" id="id42">Appendix</a><ul>
<li><a class="reference internal" href="#id15" id="id43">Hibernate Validatorが用意する入力チェックルール</a><ul>
<li><a class="reference internal" href="#jsr-303" id="id44">JSR-303のチェックルール</a></li>
<li><a class="reference internal" href="#validation-validator-list" id="id45">Hibernate Validatorのチェックルール</a></li>
</ul>
</li>
<li><a class="reference internal" href="#validation-default-message-in-hibernate-validator" id="id46">Hibernate Validatorが用意するデフォルトメッセージ</a></li>
<li><a class="reference internal" href="#id20" id="id47">型のミスマッチ</a></li>
<li><a class="reference internal" href="#null" id="id48">文字列フィールドが未入力の場合にnullをバインドする</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id23">5.5.1. Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>ユーザーが入力した値が不正かどうかを検証することは必須である。
入力値の検証は大きく分けて、</p>
<ol class="arabic simple">
<li>長さや形式など、文脈によらず入力値だけを見て、それが妥当かどうかを判定できる検証</li>
<li>システムの状態によって入力値が妥当かどうかが変わる検証</li>
</ol>
<p>がある。</p>
<p>1.の例としては必須チェックや、桁数チェックがあり、2.の例としては
登録済みのEMailかどうかのチェックや、注文数が在庫数以内であるかどうかのチェックが挙げられる。</p>
<p>本節では、基本的には前者のことを説明し、このチェックのことを「入力チェック」を呼ぶ。
後者のチェックは「業務ロジックチェック」と呼ぶ。業務ロジックチェックについては
<a class="reference internal" href="../ImplementationAtEachLayer/DomainLayer.html"><em>ドメイン層の実装</em></a>を参照されたい。</p>
<p>本ガイドラインでは、基本的に入力チェックをアプリケーション層で行い、
業務ロジックチェックは、ドメイン層で行うことをポリシーとする。</p>
<p>Webアプリケーションの入力チェックには、サーバサイドで行うチェックと、クライアントサイド(JavaScript)で行うチェックがある。
サーバーサイドのチェックは必須であるが、クライアントサイドでも同じチェックを実施すると、
サーバー通信なしでチェック結果が分かるため、ユーザビリティが向上する。</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">JavaScriptによるクライアントサイドの処理は、改ざん可能であるため、サーバーサイドのチェックは、必ず行うこと。
クライアントサイドのみでチェックを行い、サーバーサイドでチェックを省略した場合は、システムが危険な状態に晒されていることになる。</p>
</div>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">クライアントサイドの入力チェックについては今後追記する。初版では、サーバーサイドの入力チェックのみ言及する。</p>
</div>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id24">5.5.1.1. 入力チェックの分類</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>入力チェックは、単項目チェック、相関項目チェックに分類される。</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="30%" />
<col width="25%" />
<col width="30%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">種類</th>
<th class="head">説明</th>
<th class="head">例</th>
<th class="head">実現方法</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>単項目チェック</td>
<td><div class="first last line-block">
<div class="line">単一のフィールドで完結するチェック</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力必須チェック</div>
<div class="line">桁チェック</div>
<div class="line">型チェック</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Bean Validation (実装ライブラリとしてHibernate Validatorを使用)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td>相関項目チェック</td>
<td><div class="first last line-block">
<div class="line">複数のフィールドを比較するチェック</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワードと確認用パスワードの一致チェック</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><a class="reference external" href="http://docs.spring.io/spring/docs/3.2.x/spring-framework-reference/html/validation.html#validator">org.springframework.validation.Validator</a>インタフェースを実装したValidationクラス</div>
<div class="line">または Bean Validation</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Spring は、Java標準であるJSR-303のBean Validationをサポートしている。
単項目チェックには、このBean Validationを利用する。
相関項目チェックの場合は、Bean ValidationまたはSpringが提供している<tt class="docutils literal"><span class="pre">org.springframework.validation.Validator</span></tt>インタフェースを利用する。</p>
</div>
</div>
<div class="section" id="how-to-use">
<span id="validation-how-to-use"></span><h2><a class="toc-backref" href="#id25">5.5.2. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<div class="section" id="validation-single-check">
<span id="id4"></span><h3><a class="toc-backref" href="#id26">5.5.2.1. 単項目チェック</a><a class="headerlink" href="#validation-single-check" title="Permalink to this headline">¶</a></h3>
<p>単項目チェックを実装するには、</p>
<ul class="simple">
<li>フォームクラスのフィールドに、Bean Validation用のアノテーションを付与する</li>
<li>Controllerに、検証するための<tt class="docutils literal"><span class="pre">&#64;Validated</span></tt>アノテーションを付与する</li>
<li>JSPに、検証エラーメッセージを表示するためのタグを追加する</li>
</ul>
<p>が必要である。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">spring-mvc.xmlに<tt class="docutils literal"><span class="pre">&lt;mvc:annotation-driven&gt;</span></tt>の設定が行われていれば、Bean Validationは有効になる。</p>
</div>
<div class="section" id="validation-basic-validation">
<span id="id5"></span><h4><a class="toc-backref" href="#id27">5.5.2.1.1. 基本的な単項目チェック</a><a class="headerlink" href="#validation-basic-validation" title="Permalink to this headline">¶</a></h4>
<p>「新規ユーザー登録」処理を例に用いて、実装方法を説明する。ここでは「新規ユーザー登録」のフォームに、以下のチェックルールを設ける。</p>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="30%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">フィールド名</th>
<th class="head">型</th>
<th class="head">ルール</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">name</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">java.lang.String</span></tt></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力必須</div>
<div class="line">1文字以上</div>
<div class="line">20文字以下</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">email</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">java.lang.String</span></tt></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力必須</div>
<div class="line">1文字以上</div>
<div class="line">50文字以下</div>
<div class="line">Email形式</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">age</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">java.lang.Integer</span></tt></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力必須</div>
<div class="line">1以上</div>
<div class="line">200以下</div>
</div>
</td>
</tr>
</tbody>
</table>
<ul>
<li><p class="first">フォームクラス</p>
<p>フォームクラスの各フィールドに、Bean Validationのアノテーションを付ける。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">sample</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.constraints.Max</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Min</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.hibernate.validator.constraints.Email</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

  <span class="nd">@NotNull</span> <span class="c1">// (1)</span>
  <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">20</span><span class="o">)</span> <span class="c1">// (2)</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

  <span class="nd">@NotNull</span>
  <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">50</span><span class="o">)</span>
  <span class="nd">@Email</span> <span class="c1">// (3)</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>

  <span class="nd">@NotNull</span> <span class="c1">// (4)</span>
  <span class="nd">@Min</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="c1">// (5)</span>
  <span class="nd">@Max</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span> <span class="c1">// (6)</span>
  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">age</span><span class="o">;</span>

  <span class="c1">// omitted setter/getter</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">項番</p>
</th>
<th class="head"><p class="first last">説明</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">対象のフィールドが<tt class="docutils literal"><span class="pre">null</span></tt>でないことを示す<tt class="docutils literal"><span class="pre">javax.validation.constraints.NotNull</span></tt>を付ける。</div>
<div class="line"><br /></div>
<div class="line">Spring MVCでは、文字列の入力フィールドに未入力の状態でフォームを送信した場合、</div>
<div class="line">デフォルトではフォームオブジェクトに<strong>nullではなく、空文字がバインドされる</strong>。</div>
<div class="line">この<tt class="docutils literal"><span class="pre">&#64;NotNull</span></tt>は、そもそもリクエストパラメータとして<tt class="docutils literal"><span class="pre">name</span></tt>が存在することをチェックする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">対象のフィールドの文字列長(またはコレクションのサイズ)が指定したサイズの範囲内にあることを示す<tt class="docutils literal"><span class="pre">javax.validation.constraints.Size</span></tt>を付ける。</div>
<div class="line"><br /></div>
<div class="line">上記の通り、Spring MVCではデフォルトで、未入力の文字列フィールドには、空文字がバインドされるため、</div>
<div class="line">1文字以上というルールが入力必須を表す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">対象のフィールドがRFC2822準拠のE-mail形式であることを示す<tt class="docutils literal"><span class="pre">org.hibernate.validator.constraints.Email</span></tt>を付ける。</div>
<div class="line">E-mail形式の要件がRFC2822準拠の制限よりも緩い場合は、<tt class="docutils literal"><span class="pre">&#64;Email</span></tt>を使用せず、<tt class="docutils literal"><span class="pre">javax.validation.constraints.Pattern</span></tt>を用いて、正規表現を指定する必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">数値の入力フィールドに未入力の状態でフォームを送信した場合、フォームオブジェクトに<tt class="docutils literal"><span class="pre">null</span></tt> がバインドされるため、<tt class="docutils literal"><span class="pre">&#64;NotNull</span></tt>が<tt class="docutils literal"><span class="pre">age</span></tt>の入力必須条件を表す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">対象のフィールドが指定した数値の以上であることを示す<tt class="docutils literal"><span class="pre">javax.validation.constraints.Min</span></tt>を付ける。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">対象のフィールドが指定した数値の以下であることを示す<tt class="docutils literal"><span class="pre">javax.validation.constraints.Max</span></tt>を付ける。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Bean Validation標準のアノテーション、Hibernate Validationが用意しているアノテーションについては、<a class="reference internal" href="#validation-jsr303-doc"><em>JSR-303のチェックルール</em></a>、<a class="reference internal" href="#validation-validator-list"><em>Hibernate Validatorのチェックルール</em></a>を参照されたい。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">入力フィールドに未入力の場合に、空文字では<tt class="docutils literal"><span class="pre">null</span></tt>にバインドする方法に関しては、<a class="reference internal" href="#validation-string-trimmer-editor"><em>文字列フィールドが未入力の場合にnullをバインドする</em></a>を参照されたい、</p>
</div>
</li>
<li><p class="first">Controllerクラス</p>
<p>入力チェック対象のフォームクラスに、<tt class="docutils literal"><span class="pre">&#64;Validated</span></tt>を付ける。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">sample</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.BindingResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ModelAttribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>

  <span class="nd">@ModelAttribute</span>
  <span class="kd">public</span> <span class="n">UserForm</span> <span class="nf">setupForm</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">UserForm</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form&quot;</span><span class="o">)</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">createForm</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="s">&quot;user/createForm&quot;</span><span class="o">;</span> <span class="c1">// (1)</span>
  <span class="o">}</span>

  <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;confirm&quot;</span><span class="o">)</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">createConfirm</span><span class="o">(</span><span class="nd">@Validated</span> <span class="cm">/* (2) */</span> <span class="n">UserForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="cm">/* (3) */</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// (4)</span>
      <span class="k">return</span> <span class="s">&quot;user/createForm&quot;</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="s">&quot;user/createConfirm&quot;</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">create</span><span class="o">(</span><span class="nd">@Validated</span> <span class="n">UserForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (5)</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">return</span> <span class="s">&quot;user/createForm&quot;</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// omitted business logic</span>
    <span class="k">return</span> <span class="s">&quot;redirect:/user/create?complete&quot;</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;complete&quot;</span><span class="o">)</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">createComplete</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="s">&quot;user/createComplete&quot;</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">項番</p>
</th>
<th class="head"><p class="first last">説明</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">「新規ユーザー登録」フォーム画面を表示する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フォームにつけたアノテーションで入力チェックをするために、フォームの引数に <tt class="docutils literal"><span class="pre">org.springframework.validation.annotation.Validated</span></tt>を付ける。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(2)のチェック結果を格納する<tt class="docutils literal"><span class="pre">org.springframework.validation.BindingResult</span></tt>を、引数に加える。</div>
<div class="line">この<tt class="docutils literal"><span class="pre">BindingResult</span></tt>は、フォームの直後に記述する必要がある。</div>
<div class="line"><br /></div>
<div class="line">直後に指定されていない場合は、検証後に結果をバインドできず、<tt class="docutils literal"><span class="pre">org.springframework.validation.BindException</span></tt>がスローされる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(2)のチェック結果は、<tt class="docutils literal"><span class="pre">BindingResult.hasErrors()</span></tt>メソッドで判定できる。</div>
<div class="line"><tt class="docutils literal"><span class="pre">hasErrors()</span></tt>の結果が<tt class="docutils literal"><span class="pre">true</span></tt>の場合は、入力値に問題があるため、フォーム表示画面に戻す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力内容確認画面から新規作成処理にリクエストを送る際にも、<strong>入力チェックを必ず再実行すること</strong>。</div>
<div class="line">途中でデータを改ざんすることは可能であるため、必ず業務処理の直前で入力チェックは必要である。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><tt class="docutils literal"><span class="pre">&#64;Validated</span></tt>は、Bean Validation標準ではなく、Springの独自アノテーションである。
Bean Validation標準の<tt class="docutils literal"><span class="pre">javax.validation.Valid</span></tt>アノテーションも使用できるが、<tt class="docutils literal"><span class="pre">&#64;Validated</span></tt>は<tt class="docutils literal"><span class="pre">&#64;Valid</span></tt>に比べて、
バリデーションのグループを指定できる点で優れているため、本ガイドラインではControllerの引数には、<tt class="docutils literal"><span class="pre">&#64;Validated</span></tt>を使用することを推奨する。</p>
</div>
</li>
</ul>
<ul id="validation-jsp-impl-sample">
<li><p class="first">JSP</p>
<p><tt class="docutils literal"><span class="pre">&lt;form:errors&gt;</span></tt>タグで、入力エラーがある場合にエラーメッセージを表示できる。</p>
<div class="highlight-jsp"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="k">&lt;%-</span><span class="o">-</span> <span class="n">WEB</span><span class="o">-</span><span class="n">INF</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">createForm</span><span class="o">.</span><span class="na">jsp</span> <span class="o">--</span><span class="k">%&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;form:form</span> <span class="na">modelAttribute=</span><span class="s">&quot;userForm&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span>
        <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/user/create&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>Name:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="nt">/&gt;</span><span class="k">&lt;%-</span><span class="o">-(</span><span class="mi">1</span><span class="o">)</span> <span class="o">--</span><span class="k">%&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span><span class="nt">&gt;</span>Email:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span><span class="nt">&gt;</span>Age:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;form:button</span> <span class="na">name=</span><span class="s">&quot;confirm&quot;</span><span class="nt">&gt;</span>Confirm<span class="nt">&lt;/form:button&gt;</span>
    <span class="nt">&lt;/form:form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">項番</p>
</th>
<th class="head"><p class="first last">説明</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">&lt;form:errors&gt;</span></tt>タグの<tt class="docutils literal"><span class="pre">path</span></tt>属性に、対象のフィールド名を指定する。</div>
<div class="line">この例では、フィールド毎に入力フィールドの横にエラーメッセージを表示する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<p>フォームは、以下のように表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/validations-first-sample1.png"><img alt="../_images/validations-first-sample1.png" src="../_images/validations-first-sample1.png" style="width: 60%;" /></a>
</div>
<p>このフォームに対して、すべての入力フィールドを未入力のまま送信すると、以下のようにエラーメッセージが表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/validations-first-sample2.png"><img alt="../_images/validations-first-sample2.png" src="../_images/validations-first-sample2.png" style="width: 60%;" /></a>
</div>
<p>NameとEmailが空文字であることに対するエラーメッセージと、Agが<tt class="docutils literal"><span class="pre">null</span></tt>であることに対するエラーメッセージが表示されている。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Bean Validationでは、通常、入力値が<tt class="docutils literal"><span class="pre">null</span></tt>の場合は正常な値とみなす。ただし、
以下のアノテーションを除く。</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">javax.validation.constraints.NotNull</span></tt></li>
<li><tt class="docutils literal"><span class="pre">org.hibernate.validator.constraints.NotEmpty</span></tt></li>
<li><tt class="docutils literal"><span class="pre">org.hibernate.validator.constraints.NotBlank</span></tt></li>
</ul>
<p class="last">上記の例では、Ageの値は<tt class="docutils literal"><span class="pre">null</span></tt>であるため、<tt class="docutils literal"><span class="pre">&#64;Min</span></tt>と<tt class="docutils literal"><span class="pre">&#64;Max</span></tt>によるチェックは正常とみなされ、
エラーメッセージは出力されていない。</p>
</div>
<p>次に、フィールドに何らかの値を入力してフォームを送信する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/validations-first-sample3.png"><img alt="../_images/validations-first-sample3.png" src="../_images/validations-first-sample3.png" style="width: 60%;" /></a>
</div>
<div class="line-block">
<div class="line">Nameの入力値は、チェック条件を満たすため、エラーメッセージが表示されない。</div>
<div class="line">Emailの入力値は文字列長に関する条件は満たすが、Email形式ではないため、エラーメッセージが表示される。</div>
<div class="line">Ageの入力値は最大値を超えているため、エラーメッセージが表示される。</div>
</div>
<p>エラー時にスタイルを変更したい場合は、前述のフォームを、以下のように変更する。</p>
<div class="highlight-jsp"><div class="highlight"><pre><span class="nt">&lt;form:form</span> <span class="na">modelAttribute=</span><span class="s">&quot;userForm&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span>
    <span class="na">class=</span><span class="s">&quot;form-horizontal&quot;</span>
    <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/user/create&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Name:<span class="nt">&lt;/form:label&gt;</span><span class="k">&lt;%-</span><span class="o">-</span> <span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">--</span><span class="k">%&gt;</span>
    <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span><span class="k">&lt;%-</span><span class="o">-</span> <span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="o">--</span><span class="k">%&gt;</span>
    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span><span class="k">&lt;%-</span><span class="o">-</span> <span class="o">(</span><span class="mi">3</span><span class="o">)</span> <span class="o">--</span><span class="k">%&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Email:<span class="nt">&lt;/form:label&gt;</span>
    <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Age:<span class="nt">&lt;/form:label&gt;</span>
    <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;form:button</span> <span class="na">name=</span><span class="s">&quot;confirm&quot;</span><span class="nt">&gt;</span>Confirm<span class="nt">&lt;/form:button&gt;</span>
<span class="nt">&lt;/form:form&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラー時に<tt class="docutils literal"><span class="pre">&lt;label&gt;</span></tt>タグへ加えるクラス名を、<tt class="docutils literal"><span class="pre">cssErrorClass</span></tt>属性で指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラー時に<tt class="docutils literal"><span class="pre">&lt;input&gt;</span></tt>タグへ加えるクラス名を、<tt class="docutils literal"><span class="pre">cssErrorClass</span></tt>属性で指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラーメッセージに加えるクラス名を、<tt class="docutils literal"><span class="pre">cssClass</span></tt>属性で指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>このJSPに対して、例えば以下のCSSを適用すると、</p>
<div class="highlight-css"><div class="highlight"><pre><span class="nc">.form-horizontal</span> <span class="nt">input</span> <span class="p">{</span>
    <span class="k">display</span><span class="o">:</span> <span class="k">block</span><span class="p">;</span>
    <span class="k">float</span><span class="o">:</span> <span class="k">left</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.form-horizontal</span> <span class="nt">label</span> <span class="p">{</span>
    <span class="k">display</span><span class="o">:</span> <span class="k">block</span><span class="p">;</span>
    <span class="k">float</span><span class="o">:</span> <span class="k">left</span><span class="p">;</span>
    <span class="k">text-align</span><span class="o">:</span> <span class="k">right</span><span class="p">;</span>
    <span class="k">float</span><span class="o">:</span> <span class="k">left</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.form-horizontal</span> <span class="nt">br</span> <span class="p">{</span>
    <span class="k">clear</span><span class="o">:</span> <span class="k">left</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.error-label</span> <span class="p">{</span>
    <span class="k">color</span><span class="o">:</span> <span class="m">#b94a48</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.error-input</span> <span class="p">{</span>
    <span class="k">border-color</span><span class="o">:</span> <span class="m">#b94a48</span><span class="p">;</span>
    <span class="k">margin-left</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.error-messages</span> <span class="p">{</span>
    <span class="k">color</span><span class="o">:</span> <span class="m">#b94a48</span><span class="p">;</span>
    <span class="k">display</span><span class="o">:</span> <span class="k">block</span><span class="p">;</span>
    <span class="k">padding-left</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
    <span class="k">overflow-x</span><span class="o">:</span> <span class="k">auto</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>エラー画面は、以下のように表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/validations-has-errors1.png"><img alt="../_images/validations-has-errors1.png" src="../_images/validations-has-errors1.png" style="width: 60%;" /></a>
</div>
<p>画面の要件に応じてCSSをカスタマイズすればよい。</p>
<p>エラーメッセージを、入力フィールドの横に一件一件出力する代わりに、
まとめて出力することもできる。</p>
<div class="highlight-jsp"><div class="highlight"><pre><span class="nt">&lt;form:form</span> <span class="na">modelAttribute=</span><span class="s">&quot;userForm&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span>
    <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/user/create&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;*&quot;</span> <span class="na">element=</span><span class="s">&quot;div&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-message-list&quot;</span> <span class="nt">/&gt;</span><span class="k">&lt;%-</span><span class="o">-</span> <span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">--</span><span class="k">%&gt;</span>

    <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Name:<span class="nt">&lt;/form:label&gt;</span>
    <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Email:<span class="nt">&lt;/form:label&gt;</span>
    <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Age:<span class="nt">&lt;/form:label&gt;</span>
    <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;form:button</span> <span class="na">name=</span><span class="s">&quot;confirm&quot;</span><span class="nt">&gt;</span>Confirm<span class="nt">&lt;/form:button&gt;</span>
<span class="nt">&lt;/form:form&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">&lt;form:form&gt;</span></tt>タグ内で、<tt class="docutils literal"><span class="pre">&lt;form:errors&gt;</span></tt>の<tt class="docutils literal"><span class="pre">path</span></tt>属性に<tt class="docutils literal"><span class="pre">*</span></tt>を指定することで、</div>
<div class="line"><tt class="docutils literal"><span class="pre">&lt;form:form&gt;</span></tt>の<tt class="docutils literal"><span class="pre">modelAttribute</span></tt>属性に指定したModelに関する全エラーメッセージを出力できる。</div>
<div class="line"><tt class="docutils literal"><span class="pre">element</span></tt>属性に、これらのエラーメッセージを包含するタグ名を指定できる。デフォルトでは、<tt class="docutils literal"><span class="pre">span</span></tt>であるが、</div>
<div class="line">ここではエラーメッセージ一覧をブロック要素として出力するために、<tt class="docutils literal"><span class="pre">div</span></tt>を指定する。</div>
<div class="line">また、CSSのクラスを <tt class="docutils literal"><span class="pre">cssClass</span></tt>属性に指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>例として、以下のCSSクラスを適用した場合の、エラーメッセージ出力例を示す。</p>
<div class="highlight-css"><div class="highlight"><pre><span class="nc">.form-horizontal</span> <span class="nt">input</span> <span class="p">{</span>
    <span class="k">display</span><span class="o">:</span> <span class="k">block</span><span class="p">;</span>
    <span class="k">float</span><span class="o">:</span> <span class="k">left</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.form-horizontal</span> <span class="nt">label</span> <span class="p">{</span>
    <span class="k">display</span><span class="o">:</span> <span class="k">block</span><span class="p">;</span>
    <span class="k">float</span><span class="o">:</span> <span class="k">left</span><span class="p">;</span>
    <span class="k">text-align</span><span class="o">:</span> <span class="k">right</span><span class="p">;</span>
    <span class="k">float</span><span class="o">:</span> <span class="k">left</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.form-horizontal</span> <span class="nt">br</span> <span class="p">{</span>
    <span class="k">clear</span><span class="o">:</span> <span class="k">left</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.error-label</span> <span class="p">{</span>
    <span class="k">color</span><span class="o">:</span> <span class="m">#b94a48</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.error-input</span> <span class="p">{</span>
    <span class="k">border-color</span><span class="o">:</span> <span class="m">#b94a48</span><span class="p">;</span>
    <span class="k">margin-left</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.error-message-list</span> <span class="p">{</span>
    <span class="k">color</span><span class="o">:</span> <span class="m">#b94a48</span><span class="p">;</span>
    <span class="k">padding</span><span class="o">:</span><span class="m">5px</span> <span class="m">10px</span><span class="p">;</span>
    <span class="k">background-color</span><span class="o">:</span> <span class="m">#fde9f3</span><span class="p">;</span>
    <span class="k">border</span><span class="o">:</span><span class="m">1px</span> <span class="k">solid</span> <span class="m">#c98186</span><span class="p">;</span>
    <span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span><span class="m">5px</span><span class="p">;</span>
    <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../_images/validations-has-errors2.png"><img alt="../_images/validations-has-errors2.png" src="../_images/validations-has-errors2.png" style="width: 60%;" /></a>
</div>
<div class="line-block">
<div class="line">デフォルトでは、エラーメッセージにフィールド名は含まれず、どのフィールドのエラーメッセージなのかが分かりにくい。</div>
<div class="line">そのため、エラーメッセージを一覧で表示する場合は、フィールド単位にエラーメッセージが出力されるようにメッセージを定義する必要がある。</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>エラーメッセージの出力順序はデフォルトでは順不同である。
<a class="reference external" href="http://docs.jboss.org/hibernate/validator/4.3/reference/en-US/html/validator-usingvalidator.html#section-default-group-class">&#64;GroupSequenceアノテーション</a>によって、
順序制御することもできるが、対応コストが高い。</p>
<p>「エラーメッセージを一覧で表示する」方式では、</p>
<ul class="simple">
<li>フィード単位のエラーメッセージ定義</li>
<li>エラーメッセージの順序制御</li>
</ul>
<p class="last">のコストがかかるため、
画面要件による制約がなければ、「入力フィールドの横にエラーメッセージを表示する」方式を推奨する。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>エラーメッセージまとめて表示する際に、<tt class="docutils literal"><span class="pre">&lt;form:form&gt;</span></tt>タグの外に表示したい場合は以下のように<tt class="docutils literal"><span class="pre">&lt;spring:nestedPath&gt;</span></tt>タグを使用する。</p>
<blockquote class="last">
<div><div class="highlight-jsp"><div class="highlight"><pre><span class="hll"><span class="nt">&lt;spring:nestedPath</span> <span class="na">path=</span><span class="s">&quot;userForm&quot;</span><span class="nt">&gt;</span>
</span>    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;*&quot;</span> <span class="na">element=</span><span class="s">&quot;div&quot;</span>
        <span class="na">cssClass=</span><span class="s">&quot;error-message-list&quot;</span> <span class="nt">/&gt;</span>
<span class="hll"><span class="nt">&lt;/spring:nestedPath&gt;</span>
</span><span class="nt">&lt;hr&gt;</span>
<span class="nt">&lt;form:form</span> <span class="na">modelAttribute=</span><span class="s">&quot;userForm&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span>
    <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/user/create&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Name:<span class="nt">&lt;/form:label&gt;</span>
    <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Email:<span class="nt">&lt;/form:label&gt;</span>
    <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Age:<span class="nt">&lt;/form:label&gt;</span>
    <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;form:button</span> <span class="na">name=</span><span class="s">&quot;confirm&quot;</span><span class="nt">&gt;</span>Confirm<span class="nt">&lt;/form:button&gt;</span>
<span class="nt">&lt;/form:form&gt;</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="bean">
<h4><a class="toc-backref" href="#id28">5.5.2.1.2. ネストしたBeanの単項目チェック</a><a class="headerlink" href="#bean" title="Permalink to this headline">¶</a></h4>
<p>ネストしたBeanをBean Validationで検証する方法を説明する。</p>
<p>ECサイトにおける「注文」処理の例を考える。「注文」フォームでは、以下のチェックルールを設ける。</p>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="30%" />
<col width="30%" />
<col width="20%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">フィールド名</th>
<th class="head">型</th>
<th class="head">ルール</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">coupon</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">java.lang.String</span></tt></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">5文字以下</div>
<div class="line">半角英数字</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クーポンコード</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">receiverAddress.name</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">java.lang.String</span></tt></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力必須</div>
<div class="line">1文字以上</div>
<div class="line">50文字以下</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">お届け先氏名</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">receiverAddress.postcode</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">java.lang.String</span></tt></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力必須</div>
<div class="line">1文字以上</div>
<div class="line">10文字以下</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">お届け先郵便番号</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">receiverAddress.address</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">java.lang.String</span></tt></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力必須</div>
<div class="line">1文字以上</div>
<div class="line">100文字以下</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">お届け先住所</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">senderAddress.name</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">java.lang.String</span></tt></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力必須</div>
<div class="line">1文字以上</div>
<div class="line">50文字以下</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">請求先氏名</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">senderAddress.postcode</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">java.lang.String</span></tt></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力必須</div>
<div class="line">1文字以上</div>
<div class="line">10文字以下</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">請求先郵便番号</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">senderAddress.address</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">java.lang.String</span></tt></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力必須</div>
<div class="line">1文字以上</div>
<div class="line">100文字以下</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">請求先住所</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal"><span class="pre">receiverAddress</span></tt>と<tt class="docutils literal"><span class="pre">senderAddress</span></tt>は、同じ項目であるため、同じフォームクラスを使用する。</p>
<ul>
<li><p class="first">フォームクラス</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">sample</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.Valid</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Pattern</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="nd">@Size</span><span class="o">(</span><span class="n">max</span> <span class="o">=</span> <span class="mi">5</span><span class="o">)</span>
    <span class="nd">@Pattern</span><span class="o">(</span><span class="n">regexp</span> <span class="o">=</span> <span class="s">&quot;[a-zA-Z0-9]*&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">coupon</span><span class="o">;</span>

    <span class="nd">@NotNull</span> <span class="c1">// (1)</span>
    <span class="nd">@Valid</span> <span class="c1">// (2)</span>
    <span class="kd">private</span> <span class="n">AddressForm</span> <span class="n">receiverAddress</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Valid</span>
    <span class="kd">private</span> <span class="n">AddressForm</span> <span class="n">senderAddress</span><span class="o">;</span>

    <span class="c1">// omitted setter/getter</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">sample</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AddressForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">50</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">10</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">postcode</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">address</span><span class="o">;</span>

    <span class="c1">// omitted setter/getter</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">項番</p>
</th>
<th class="head"><p class="first last">説明</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">子フォーム自体が必須であることを示す。</div>
<div class="line">この設定がない場合、<tt class="docutils literal"><span class="pre">receiverAddress</span></tt>に<tt class="docutils literal"><span class="pre">null</span></tt>が設定されても、正常とみなされる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ネストしたBeanのBean Validationを有効にするために、<tt class="docutils literal"><span class="pre">javax.validation.Valid</span></tt>アノテーションを付与する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Controllerクラス</p>
<p>前述のControllerと違いはない。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">sample</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.BindingResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ModelAttribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="o">;</span>

<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;order&quot;</span><span class="o">)</span>
<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderController</span> <span class="o">{</span>

    <span class="nd">@ModelAttribute</span>
    <span class="kd">public</span> <span class="n">OrderForm</span> <span class="nf">setupForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">OrderForm</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;order&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">orderForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;order/orderForm&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;order&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;confirm&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">orderConfirm</span><span class="o">(</span><span class="nd">@Validated</span> <span class="n">OrderForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">&quot;order/orderForm&quot;</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="s">&quot;order/orderConfirm&quot;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">JSP</p>
<div class="highlight-jsp"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="k">&lt;%-</span><span class="o">-</span> <span class="n">WEB</span><span class="o">-</span><span class="n">INF</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">order</span><span class="o">/</span><span class="n">orderForm</span><span class="o">.</span><span class="na">jsp</span> <span class="o">--</span><span class="k">%&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;style</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
  /* omitted (same as previous sample) */
<span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;form:form</span> <span class="na">modelAttribute=</span><span class="s">&quot;orderForm&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span>
        <span class="na">class=</span><span class="s">&quot;form-horizontal&quot;</span>
        <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/order/order&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;coupon&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Coupon Code:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;coupon&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;coupon&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;fieldset&gt;</span>
        <span class="nt">&lt;legend&gt;</span>Receiver<span class="nt">&lt;/legend&gt;</span>
        <span class="k">&lt;%-</span><span class="o">-</span> <span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">--</span><span class="k">%&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;receiverAddress&quot;</span>
            <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
        <span class="k">&lt;%-</span><span class="o">-</span> <span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="o">--</span><span class="k">%&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;receiverAddress.name&quot;</span>
            <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Name:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;receiverAddress.name&quot;</span>
            <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;receiverAddress.name&quot;</span>
            <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;receiverAddress.postcode&quot;</span>
            <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Postcode:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;receiverAddress.postcode&quot;</span>
            <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;receiverAddress.postcode&quot;</span>
            <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;receiverAddress.address&quot;</span>
            <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Address:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;receiverAddress.address&quot;</span>
            <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;receiverAddress.address&quot;</span>
            <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/fieldset&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;fieldset&gt;</span>
        <span class="nt">&lt;legend&gt;</span>Sender<span class="nt">&lt;/legend&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;senderAddress&quot;</span>
            <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;senderAddress.name&quot;</span>
            <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Name:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;senderAddress.name&quot;</span>
            <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;senderAddress.name&quot;</span>
            <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;senderAddress.postcode&quot;</span>
            <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Postcode:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;senderAddress.postcode&quot;</span>
            <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;senderAddress.postcode&quot;</span>
            <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;senderAddress.address&quot;</span>
            <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Address:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;senderAddress.address&quot;</span>
            <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;senderAddress.address&quot;</span>
            <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/fieldset&gt;</span>

        <span class="nt">&lt;form:button</span> <span class="na">name=</span><span class="s">&quot;confirm&quot;</span><span class="nt">&gt;</span>Confirm<span class="nt">&lt;/form:button&gt;</span>
    <span class="nt">&lt;/form:form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">項番</p>
</th>
<th class="head"><p class="first last">説明</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">不正な操作により、<tt class="docutils literal"><span class="pre">receiverAddress.name</span></tt>、<tt class="docutils literal"><span class="pre">receiverAddress.postcode</span></tt>、<tt class="docutils literal"><span class="pre">receiverAddress.address</span></tt>のすべて</div>
<div class="line">がリクエストパラメータとして送信されない場合、<tt class="docutils literal"><span class="pre">receiverAddress</span></tt>が<tt class="docutils literal"><span class="pre">null</span></tt>とみなされ、この位置にエラーメッセージが表示される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">子フォームのフィールドは、<tt class="docutils literal"><span class="pre">親フィールド名.子フィールド名</span></tt>で指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<p>フォームは、以下のように表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/validations-nested1.png"><img alt="../_images/validations-nested1.png" src="../_images/validations-nested1.png" style="width: 60%;" /></a>
</div>
<p>このフォームに対して、すべての入力フィールドを未入力のまま送信すると、以下のようにエラーメッセージが表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/validations-nested2.png"><img alt="../_images/validations-nested2.png" src="../_images/validations-nested2.png" style="width: 60%;" /></a>
</div>
<p>ネストしたBeanのバリデーションはコレクションに対しても有効である。</p>
<p>最初に説明した「ユーザー登録」フォームに住所を3件まで登録できるようにフィールドを追加する。
住所には、前述の<tt class="docutils literal"><span class="pre">AddressForm</span></tt>を利用する。</p>
<ul>
<li><p class="first">フォームクラス
<tt class="docutils literal"><span class="pre">AddressForm</span></tt>のリストを、フィールドに追加する。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">sample</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.Valid</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Max</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Min</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.hibernate.validator.constraints.Email</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">20</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">50</span><span class="o">)</span>
    <span class="nd">@Email</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Min</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
    <span class="nd">@Max</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">age</span><span class="o">;</span>

<span class="hll">    <span class="nd">@NotNull</span>
</span><span class="hll">    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">3</span><span class="o">)</span> <span class="c1">// (1)</span>
</span><span class="hll">    <span class="nd">@Valid</span>
</span><span class="hll">    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">AddressForm</span><span class="o">&gt;</span> <span class="n">addresses</span><span class="o">;</span>
</span>
    <span class="c1">// omitted setter/getter</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">項番</p>
</th>
<th class="head"><p class="first last">説明</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">コレクションのサイズチェックにも、<tt class="docutils literal"><span class="pre">&#64;Size</span></tt>アノテーションを使用できる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">JSP</p>
<div class="highlight-jsp"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="k">&lt;%-</span><span class="o">-</span> <span class="n">WEB</span><span class="o">-</span><span class="n">INF</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">createForm</span><span class="o">.</span><span class="na">jsp</span> <span class="o">--</span><span class="k">%&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;style</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
  /* omitted (same as previous sample) */
<span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

    <span class="nt">&lt;form:form</span> <span class="na">modelAttribute=</span><span class="s">&quot;userForm&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span>
        <span class="na">class=</span><span class="s">&quot;form-horizontal&quot;</span>
        <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/user/create&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Name:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Email:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Age:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;br&gt;</span>
<span class="hll">        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;addresses&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span><span class="k">&lt;%-</span><span class="o">-</span> <span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">--</span><span class="k">%&gt;</span>
</span><span class="hll">        <span class="nt">&lt;c:forEach</span> <span class="na">items=</span><span class="s">&quot;${userForm.addresses}&quot;</span> <span class="na">varStatus=</span><span class="s">&quot;status&quot;</span><span class="nt">&gt;</span><span class="k">&lt;%-</span><span class="o">-</span> <span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="o">--</span><span class="k">%&gt;</span>
</span><span class="hll">            <span class="nt">&lt;fieldset</span> <span class="na">class=</span><span class="s">&quot;address&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">                <span class="nt">&lt;legend&gt;</span>Address${f:h(status.index + 1)}<span class="nt">&lt;/legend&gt;</span>
</span><span class="hll">                <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;addresses[${status.index}].name&quot;</span>
</span><span class="hll">                    <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Name:<span class="nt">&lt;/form:label&gt;</span><span class="k">&lt;%-</span><span class="o">-</span> <span class="o">(</span><span class="mi">3</span><span class="o">)</span> <span class="o">--</span><span class="k">%&gt;</span>
</span><span class="hll">                <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;addresses[${status.index}].name&quot;</span>
</span><span class="hll">                    <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">                <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;addresses[${status.index}].name&quot;</span>
</span><span class="hll">                    <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">                <span class="nt">&lt;br&gt;</span>
</span><span class="hll">                <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;addresses[${status.index}].postcode&quot;</span>
</span><span class="hll">                    <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Postcode:<span class="nt">&lt;/form:label&gt;</span>
</span><span class="hll">                <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;addresses[${status.index}].postcode&quot;</span>
</span><span class="hll">                    <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">                <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;addresses[${status.index}].postcode&quot;</span>
</span><span class="hll">                    <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">                <span class="nt">&lt;br&gt;</span>
</span><span class="hll">                <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;addresses[${status.index}].address&quot;</span>
</span><span class="hll">                    <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Address:<span class="nt">&lt;/form:label&gt;</span>
</span><span class="hll">                <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;addresses[${status.index}].address&quot;</span>
</span><span class="hll">                    <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">                <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;addresses[${status.index}].address&quot;</span>
</span><span class="hll">                    <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">                <span class="nt">&lt;c:if</span> <span class="na">test=</span><span class="s">&quot;${status.index &gt; 0}&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">                    <span class="nt">&lt;br&gt;</span>
</span><span class="hll">                    <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">&quot;remove-address-button&quot;</span><span class="nt">&gt;</span>Remove<span class="nt">&lt;/button&gt;</span>
</span><span class="hll">                <span class="nt">&lt;/c:if&gt;</span>
</span><span class="hll">            <span class="nt">&lt;/fieldset&gt;</span>
</span><span class="hll">            <span class="nt">&lt;br&gt;</span>
</span><span class="hll">        <span class="nt">&lt;/c:forEach&gt;</span>
</span><span class="hll">        <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">&quot;add-address-button&quot;</span><span class="nt">&gt;</span>Add address<span class="nt">&lt;/button&gt;</span>
</span><span class="hll">        <span class="nt">&lt;br&gt;</span>
</span>        <span class="nt">&lt;form:button</span> <span class="na">name=</span><span class="s">&quot;confirm&quot;</span><span class="nt">&gt;</span>Confirm<span class="nt">&lt;/form:button&gt;</span>
    <span class="nt">&lt;/form:form&gt;</span>
    <span class="nt">&lt;script</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span>
        <span class="na">src=</span><span class="s">&quot;${pageContext.request.contextPath}/resources/vendor/js/jquery-1.10.2.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span>
        <span class="na">src=</span><span class="s">&quot;${pageContext.request.contextPath}/resources/app/js/AddressesView.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">項番</p>
</th>
<th class="head"><p class="first last">説明</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">address</span></tt>フィールドに対するエラーメッセージを表示する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">子フォームのコレクションを、<tt class="docutils literal"><span class="pre">&lt;c:forEach&gt;</span></tt>タグを使ってループで処理する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">コレクション中の子フォームのフィールドは、<tt class="docutils literal"><span class="pre">親フィールド名[インデックス].子フィールド名</span></tt>で指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Controllerクラス</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">sample</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.BindingResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ModelAttribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>

    <span class="nd">@ModelAttribute</span>
    <span class="kd">public</span> <span class="n">UserForm</span> <span class="nf">setupForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">UserForm</span> <span class="n">form</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserForm</span><span class="o">();</span>
<span class="hll">        <span class="n">List</span><span class="o">&lt;</span><span class="n">AddressForm</span><span class="o">&gt;</span> <span class="n">addresses</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">AddressForm</span><span class="o">&gt;();</span>
</span><span class="hll">        <span class="n">addresses</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">AddressForm</span><span class="o">());</span>
</span><span class="hll">        <span class="n">form</span><span class="o">.</span><span class="na">setAddresses</span><span class="o">(</span><span class="n">addresses</span><span class="o">);</span> <span class="c1">// (1)</span>
</span>        <span class="k">return</span> <span class="n">form</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;user/createForm&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;confirm&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createConfirm</span><span class="o">(</span><span class="nd">@Validated</span> <span class="n">UserForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">&quot;user/createForm&quot;</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="s">&quot;user/createConfirm&quot;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">項番</p>
</th>
<th class="head"><p class="first last">説明</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">「ユーザー登録」フォーム初期表示時に、一件の住所フォームを表示させるために、フォームオブジェクトを編集する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">JavaScript</p>
<p>動的にアドレス入力フィールドを追加するためのJavaScriptも記載するが、このコードの説明は、本質的ではないため割愛する。</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="c1">// webapp/resources/app/js/AddressesView.js</span>

<span class="kd">function</span> <span class="nx">AddressesView</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">addressSize</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;fieldset.address&#39;</span><span class="p">).</span><span class="nx">size</span><span class="p">();</span>
<span class="p">};</span>

<span class="nx">AddressesView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addAddress</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">$address</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;fieldset.address&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">newHtml</span> <span class="o">=</span> <span class="nx">addressTemplate</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">addressSize</span><span class="o">++</span><span class="p">);</span>
  <span class="nx">$address</span><span class="p">.</span><span class="nx">last</span><span class="p">().</span><span class="nx">next</span><span class="p">().</span><span class="nx">after</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">newHtml</span><span class="p">));</span>
<span class="p">};</span>

<span class="nx">AddressesView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">removeAddress</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$fieldset</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">$fieldset</span><span class="p">.</span><span class="nx">next</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span> <span class="c1">// remove &lt;br&gt;</span>
  <span class="nx">$fieldset</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span> <span class="c1">// remove &lt;fieldset&gt;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">addressTemplate</span><span class="p">(</span><span class="nx">number</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="s1">&#39;\</span>
<span class="s1">&lt;fieldset class=&quot;address&quot;&gt;\</span>
<span class="s1">    &lt;legend&gt;Address&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;/legend&gt;\</span>
<span class="s1">    &lt;label for=&quot;addresses&#39;</span> <span class="o">+</span> <span class="nx">number</span> <span class="o">+</span> <span class="s1">&#39;.name&quot;&gt;Name:&lt;/label&gt;\</span>
<span class="s1">    &lt;input id=&quot;addresses&#39;</span> <span class="o">+</span> <span class="nx">number</span> <span class="o">+</span> <span class="s1">&#39;.name&quot; name=&quot;addresses[&#39;</span> <span class="o">+</span> <span class="nx">number</span> <span class="o">+</span> <span class="s1">&#39;].name&quot; type=&quot;text&quot; value=&quot;&quot;/&gt;&lt;br&gt;\</span>
<span class="s1">    &lt;label for=&quot;addresses&#39;</span> <span class="o">+</span> <span class="nx">number</span> <span class="o">+</span> <span class="s1">&#39;.postcode&quot;&gt;Postcode:&lt;/label&gt;\</span>
<span class="s1">    &lt;input id=&quot;addresses&#39;</span> <span class="o">+</span> <span class="nx">number</span> <span class="o">+</span> <span class="s1">&#39;.postcode&quot; name=&quot;addresses[&#39;</span> <span class="o">+</span> <span class="nx">number</span> <span class="o">+</span> <span class="s1">&#39;].postcode&quot; type=&quot;text&quot; value=&quot;&quot;/&gt;&lt;br&gt;\</span>
<span class="s1">    &lt;label for=&quot;addresses&#39;</span> <span class="o">+</span> <span class="nx">number</span> <span class="o">+</span> <span class="s1">&#39;.address&quot;&gt;Address:&lt;/label&gt;\</span>
<span class="s1">    &lt;input id=&quot;addresses&#39;</span> <span class="o">+</span> <span class="nx">number</span> <span class="o">+</span> <span class="s1">&#39;.address&quot; name=&quot;addresses[&#39;</span> <span class="o">+</span> <span class="nx">number</span> <span class="o">+</span> <span class="s1">&#39;].address&quot; type=&quot;text&quot; value=&quot;&quot;/&gt;&lt;br&gt;\</span>
<span class="s1">    &lt;button class=&quot;remove-address-button&quot;&gt;Remove&lt;/button&gt;\</span>
<span class="s1">&lt;/fieldset&gt;\</span>
<span class="s1">&lt;br&gt;\</span>
<span class="s1">&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">addressesView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AddressesView</span><span class="p">();</span>

  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#add-address-button&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="nx">addressesView</span><span class="p">.</span><span class="nx">addAddress</span><span class="p">();</span>
  <span class="p">});</span>

  <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="s1">&#39;.remove-address-button&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span> <span class="o">===</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">$this</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">);</span> <span class="c1">// this button</span>
      <span class="kd">var</span> <span class="nx">$fieldset</span> <span class="o">=</span> <span class="nx">$this</span><span class="p">.</span><span class="nx">parent</span><span class="p">();</span> <span class="c1">// fieldset</span>
      <span class="nx">addressesView</span><span class="p">.</span><span class="nx">removeAddress</span><span class="p">(</span><span class="nx">$fieldset</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>

<span class="p">});</span>
</pre></div>
</div>
</li>
</ul>
<p>フォームは、以下のように表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/validations-nested-collection1.png"><img alt="../_images/validations-nested-collection1.png" src="../_images/validations-nested-collection1.png" style="width: 60%;" /></a>
</div>
<p>「Add address」ボタンを2回押して、住所フォームを2件追加する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/validations-nested-collection2.png"><img alt="../_images/validations-nested-collection2.png" src="../_images/validations-nested-collection2.png" style="width: 60%;" /></a>
</div>
<p>このフォームに対して、すべての入力フィールドを未入力のまま送信すると、以下のようにエラーメッセージが表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/validations-nested-collection3.png"><img alt="../_images/validations-nested-collection3.png" src="../_images/validations-nested-collection3.png" style="width: 60%;" /></a>
</div>
</div>
<div class="section" id="id6">
<h4><a class="toc-backref" href="#id29">5.5.2.1.3. バリデーションのグループ化</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<p>バリデーショングループを作成し、一つのフィールドに対して、グループごとに入力チェックルールを指定することができる。</p>
<p>前述の「新規ユーザー登録」の例で、<tt class="docutils literal"><span class="pre">age</span></tt>フィールドに「成年であること」というルールを追加する。
「成年」かどうかは国によってルールが違うため、<tt class="docutils literal"><span class="pre">country</span></tt>フィールドも追加する。</p>
<p>Bean Validationでグループを指定する場合、アノテーションの<tt class="docutils literal"><span class="pre">group</span></tt>属性に、グループを示す任意の<tt class="docutils literal"><span class="pre">java.lang.Class</span></tt>オブジェクトを設定する。</p>
<p>ここでは、以下の3グループ(interface)を作成する。</p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">グループ</th>
<th class="head">成人条件</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Chinese</span></tt></td>
<td>18歳以上</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">Japanese</span></tt></td>
<td>20歳以上</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Singaporean</span></tt></td>
<td>21歳以上</td>
</tr>
</tbody>
</table>
<p>このグループをつかって、バリデーションを実行する例を示す。</p>
<ul>
<li><p class="first">フォームクラス</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">sample</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.Valid</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Max</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Min</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.hibernate.validator.constraints.Email</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

<span class="hll">    <span class="c1">// (1)</span>
</span><span class="hll">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">Chinese</span> <span class="o">{</span>
</span><span class="hll">    <span class="o">};</span>
</span><span class="hll">
</span><span class="hll">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">Japanese</span> <span class="o">{</span>
</span><span class="hll">    <span class="o">};</span>
</span><span class="hll">
</span><span class="hll">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">Singaporean</span> <span class="o">{</span>
</span><span class="hll">    <span class="o">};</span>
</span>
    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">20</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">50</span><span class="o">)</span>
    <span class="nd">@Email</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
<span class="hll">    <span class="nd">@Min.List</span><span class="o">({</span> <span class="c1">// (2)</span>
</span><span class="hll">            <span class="nd">@Min</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="mi">18</span><span class="o">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">Chinese</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="c1">// (3)</span>
</span><span class="hll">            <span class="nd">@Min</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="mi">20</span><span class="o">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">Japanese</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
</span><span class="hll">            <span class="nd">@Min</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="mi">21</span><span class="o">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">Singaporean</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class="hll">            <span class="o">})</span>
</span>    <span class="nd">@Max</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">age</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">2</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">2</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">country</span><span class="o">;</span> <span class="c1">// (4)</span>

    <span class="c1">// omitted setter/getter</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">項番</p>
</th>
<th class="head"><p class="first last">説明</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">グループクラスを指定するために、各グループをインタフェースで定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">一つのフィールドに同じルールを複数指定するために、<tt class="docutils literal"><span class="pre">&#64;Min.List</span></tt>アノテーションを使用する。</div>
<div class="line">他のアノテーションを使用する場合も同様である。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">各グループごとにルールを定義し、グループを指定するために、<tt class="docutils literal"><span class="pre">group</span></tt>属性に対象のグループクラスを指定する。</div>
<div class="line"><tt class="docutils literal"><span class="pre">group</span></tt>属性を省略した場合、<tt class="docutils literal"><span class="pre">javax.validation.groups.Default</span></tt>グループが使用される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">グループを振り分けるための、フィールドを追加する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">JSP</p>
<p>JSPに大きな変更はない。</p>
<div class="highlight-jsp"><div class="highlight"><pre><span class="nt">&lt;form:form</span> <span class="na">modelAttribute=</span><span class="s">&quot;userForm&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span>
    <span class="na">class=</span><span class="s">&quot;form-horizontal&quot;</span>
    <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/user/create&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Name:<span class="nt">&lt;/form:label&gt;</span>
    <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;name&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Email:<span class="nt">&lt;/form:label&gt;</span>
    <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;email&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Age:<span class="nt">&lt;/form:label&gt;</span>
    <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;age&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;br&gt;</span>
<span class="hll">    <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;country&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Country:<span class="nt">&lt;/form:label&gt;</span>
</span><span class="hll">    <span class="nt">&lt;form:select</span> <span class="na">path=</span><span class="s">&quot;country&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">        <span class="nt">&lt;form:option</span> <span class="na">value=</span><span class="s">&quot;cn&quot;</span><span class="nt">&gt;</span>China<span class="nt">&lt;/form:option&gt;</span>
</span><span class="hll">        <span class="nt">&lt;form:option</span> <span class="na">value=</span><span class="s">&quot;jp&quot;</span><span class="nt">&gt;</span>Japan<span class="nt">&lt;/form:option&gt;</span>
</span><span class="hll">        <span class="nt">&lt;form:option</span> <span class="na">value=</span><span class="s">&quot;sg&quot;</span><span class="nt">&gt;</span>Singapore<span class="nt">&lt;/form:option&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/form:select&gt;</span>
</span><span class="hll">    <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;country&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
</span>    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;form:button</span> <span class="na">name=</span><span class="s">&quot;confirm&quot;</span><span class="nt">&gt;</span>Confirm<span class="nt">&lt;/form:button&gt;</span>
<span class="nt">&lt;/form:form&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first">Controllerクラス</p>
<p><tt class="docutils literal"><span class="pre">&#64;Validated</span></tt>に、対象のグループを設定することで、バリデーションルールを変更できる。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">sample</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">javax.validation.groups.Default</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.BindingResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ModelAttribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.sample.app.validation.UserForm.Chinese</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.sample.app.validation.UserForm.Japanese</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.sample.app.validation.UserForm.Singaporean</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>

    <span class="nd">@ModelAttribute</span>
    <span class="kd">public</span> <span class="n">UserForm</span> <span class="nf">setupForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">UserForm</span> <span class="n">form</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserForm</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">form</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;user/createForm&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">String</span> <span class="nf">createConfirm</span><span class="o">(</span><span class="n">UserForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">&quot;user/createForm&quot;</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="s">&quot;user/createConfirm&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="o">{</span>
            <span class="s">&quot;confirm&quot;</span><span class="o">,</span>  <span class="cm">/* (1) */</span> <span class="s">&quot;country=cn&quot;</span> <span class="o">})</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createConfirmForChinese</span><span class="o">(</span><span class="nd">@Validated</span><span class="o">({</span> <span class="cm">/* (2) */</span> <span class="n">Chinese</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">Default</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span> <span class="n">UserForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">createConfirm</span><span class="o">(</span><span class="n">form</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>

<span class="hll">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="hll">            <span class="s">&quot;confirm&quot;</span><span class="o">,</span> <span class="s">&quot;country=jp&quot;</span> <span class="o">})</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createConfirmForJapanese</span><span class="o">(</span><span class="nd">@Validated</span><span class="o">({</span> <span class="n">Japanese</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
</span><span class="hll">            <span class="n">Default</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span> <span class="n">UserForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
</span><span class="hll">        <span class="k">return</span> <span class="nf">createConfirm</span><span class="o">(</span><span class="n">form</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
</span><span class="hll">    <span class="o">}</span>
</span><span class="hll">
</span><span class="hll">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="hll">            <span class="s">&quot;confirm&quot;</span><span class="o">,</span> <span class="s">&quot;country=sg&quot;</span> <span class="o">})</span>
</span><span class="hll">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createConfirmForSingaporean</span><span class="o">(</span><span class="nd">@Validated</span><span class="o">({</span> <span class="n">Singaporean</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
</span><span class="hll">            <span class="n">Default</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span> <span class="n">UserForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
</span><span class="hll">        <span class="k">return</span> <span class="nf">createConfirm</span><span class="o">(</span><span class="n">form</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
</span><span class="hll">    <span class="o">}</span>
</span><span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">項番</p>
</th>
<th class="head"><p class="first last">説明</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">グループを振り分けるためのパラメータの条件を、<tt class="docutils literal"><span class="pre">param</span></tt>属性に追加する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">age</span></tt>フィールドの<tt class="docutils literal"><span class="pre">&#64;Min</span></tt>以外のアノテーションは、<tt class="docutils literal"><span class="pre">Default</span></tt>グループに属しているため、<tt class="docutils literal"><span class="pre">Default</span></tt>の指定も必要である。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<p>この例では、各入力値の組み合わせに対するチェック結果は、以下の表の通りである。</p>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="20%" />
<col width="20%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><tt class="docutils literal"><span class="pre">age</span></tt>の値</th>
<th class="head"><tt class="docutils literal"><span class="pre">country</span></tt>の値</th>
<th class="head">入力チェック結果</th>
<th class="head">エラーメッセージ</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">17</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">cn</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">NG</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">must be greater than or equal to 18</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">jp</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">NG</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">must be greater than or equal to 20</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">sg</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">NG</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">must be greater than or equal to 21</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">18</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">cn</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OK</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">jp</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">NG</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">must be greater than or equal to 20</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">sg</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">NG</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">must be greater than or equal to 21</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">20</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">cn</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OK</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">jp</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OK</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">sg</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">NG</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">must be greater than or equal to 21</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">21</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">cn</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OK</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">jp</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OK</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">sg</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">OK</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">このControllerの実装は、<tt class="docutils literal"><span class="pre">country</span></tt>の値が、&#8221;cn&#8221;、&#8221;jp&#8221;、&#8221;sg&#8221;のいづれでもない場合のハンドリングが行われておらず、不十分である。
<tt class="docutils literal"><span class="pre">country</span></tt>の値が、想定外の場合に、400エラーが返却される。</p>
</div>
<p>次にチェック対象の国が増えたため、成人条件18歳以上をデフォルトルールとしたい場合を考える。</p>
<p>ルールは、以下のようになる。</p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">グループ</th>
<th class="head">成人条件</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Japanese</span></tt></td>
<td>20歳以上</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">Singaporean</span></tt></td>
<td>21歳以上</td>
</tr>
<tr class="row-even"><td>上記以外の国(<tt class="docutils literal"><span class="pre">Default</span></tt>)</td>
<td>18歳以上</td>
</tr>
</tbody>
</table>
<ul>
<li><p class="first">フォームクラス</p>
<p><tt class="docutils literal"><span class="pre">Default</span></tt>グループに意味を持たせるため、<tt class="docutils literal"><span class="pre">&#64;Min</span></tt>以外のアノテーションにも、明示的に全グループを指定する必要がある。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">sample</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.Valid</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Max</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Min</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.groups.Default</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.hibernate.validator.constraints.Email</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">Japanese</span> <span class="o">{</span>
    <span class="o">};</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">Singaporean</span> <span class="o">{</span>
    <span class="o">};</span>

    <span class="nd">@NotNull</span><span class="o">(</span><span class="n">groups</span> <span class="o">=</span> <span class="o">{</span> <span class="n">Default</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Japanese</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Singaporean</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span> <span class="c1">// (1)</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">20</span><span class="o">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="o">{</span> <span class="n">Default</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Japanese</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">Singaporean</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="nd">@NotNull</span><span class="o">(</span><span class="n">groups</span> <span class="o">=</span> <span class="o">{</span> <span class="n">Default</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Japanese</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Singaporean</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">50</span><span class="o">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="o">{</span> <span class="n">Default</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Japanese</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">Singaporean</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
    <span class="nd">@Email</span><span class="o">(</span><span class="n">groups</span> <span class="o">=</span> <span class="o">{</span> <span class="n">Default</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Japanese</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Singaporean</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>

    <span class="nd">@NotNull</span><span class="o">(</span><span class="n">groups</span> <span class="o">=</span> <span class="o">{</span> <span class="n">Default</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Japanese</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Singaporean</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
    <span class="nd">@Min.List</span><span class="o">({</span>
            <span class="nd">@Min</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="mi">18</span><span class="o">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">Default</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="c1">// (2)</span>
            <span class="nd">@Min</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="mi">20</span><span class="o">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">Japanese</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
            <span class="nd">@Min</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="mi">21</span><span class="o">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">Singaporean</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">})</span>
    <span class="nd">@Max</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">age</span><span class="o">;</span>

    <span class="nd">@NotNull</span><span class="o">(</span><span class="n">groups</span> <span class="o">=</span> <span class="o">{</span> <span class="n">Default</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Japanese</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Singaporean</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">2</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">2</span><span class="o">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="o">{</span> <span class="n">Default</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Japanese</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">Singaporean</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">country</span><span class="o">;</span>

    <span class="c1">// omitted setter/getter</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">項番</p>
</th>
<th class="head"><p class="first last">説明</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">age</span></tt>フィールドの<tt class="docutils literal"><span class="pre">&#64;Min</span></tt>以外のアノテーションにも、全グループを設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">Default</span></tt>グループに対するルールを設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">JSP</p>
<p>JSPに変更はない</p>
</li>
<li><p class="first">Controllerクラス</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">sample</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.BindingResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ModelAttribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.sample.app.validation.UserForm.Japanese</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.sample.app.validation.UserForm.Singaporean</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>

    <span class="nd">@ModelAttribute</span>
    <span class="kd">public</span> <span class="n">UserForm</span> <span class="nf">setupForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">UserForm</span> <span class="n">form</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserForm</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">form</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;user/createForm&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">String</span> <span class="nf">createConfirm</span><span class="o">(</span><span class="n">UserForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">&quot;user/createForm&quot;</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="s">&quot;user/createConfirm&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="o">{</span> <span class="s">&quot;confirm&quot;</span> <span class="o">})</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createConfirmForDefault</span><span class="o">(</span><span class="nd">@Validated</span> <span class="cm">/* (1) */</span> <span class="n">UserForm</span> <span class="n">form</span><span class="o">,</span>
            <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">createConfirm</span><span class="o">(</span><span class="n">form</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="o">{</span>
            <span class="s">&quot;confirm&quot;</span><span class="o">,</span> <span class="s">&quot;country=jp&quot;</span> <span class="o">})</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createConfirmForJapanese</span><span class="o">(</span>
            <span class="nd">@Validated</span><span class="o">(</span><span class="n">Japanese</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>  <span class="cm">/* (2) */</span> <span class="n">UserForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">createConfirm</span><span class="o">(</span><span class="n">form</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="o">{</span>
            <span class="s">&quot;confirm&quot;</span><span class="o">,</span> <span class="s">&quot;country=sg&quot;</span> <span class="o">})</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createConfirmForSingaporean</span><span class="o">(</span>
            <span class="nd">@Validated</span><span class="o">(</span><span class="n">Singaporean</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="n">UserForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">createConfirm</span><span class="o">(</span><span class="n">form</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">項番</p>
</th>
<th class="head"><p class="first last">説明</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">country</span></tt>フィールド指定がない場合に、<tt class="docutils literal"><span class="pre">Default</span></tt>グループが使用されるように設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">country</span></tt>フィールド指定がある場合に、<tt class="docutils literal"><span class="pre">Default</span></tt>グループが含まれないように設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<p>バリデーショングループを使用する方法について、2パターン説明した。</p>
<p>前者は<tt class="docutils literal"><span class="pre">Default</span></tt>グループをControllerクラスで使用し、後者は<tt class="docutils literal"><span class="pre">Default</span></tt>グループをフォームクラスで使用した。</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">パターン</th>
<th class="head">メリット</th>
<th class="head">デメリット</th>
<th class="head">使用の判断ポイント</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Default</span></tt>グループをControllerクラスで使用</td>
<td>グループ化する必要のないルールは、<tt class="docutils literal"><span class="pre">group</span></tt>属性を設定する必要がない。</td>
<td>グループの全パターンを定義する必要があるので、グループパターンが多いと、定義が困難になる。</td>
<td>グループパターンが、数種類の場合に使用すべき(新規作成グループ、更新グループ、削除グループ等)</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">Default</span></tt>グループをフォームクラスで使用</td>
<td>デフォルトに属さないグループのみ定義すればよいため、パターンが多くても対応できる。</td>
<td>グループ化する必要のないルールにも、<tt class="docutils literal"><span class="pre">group</span></tt>属性を設定する必要があり、管理が煩雑になる。</td>
<td>グループパターンにデフォルト値を設定できる(グループの大多数に共通項がある)場合に使用すべき</td>
</tr>
</tbody>
</table>
<p><strong>使用の判断ポイントのどちらにも当てはまらない場合は、Bean Validationの使用が不適切であることが考えられる。</strong>設計を見直したうえで、Spring Validatorの使用または業務ロジックチェックでの実装を検討すること。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>これまでの例ではバリデーショングループの切り替えは、リクエストパラメータ等、<tt class="docutils literal"><span class="pre">&#64;RequestMapping</span></tt>アノテーションで指定できるパラメータによって行った。
この方法では認証オブジェクトが有する権限情報など、<tt class="docutils literal"><span class="pre">&#64;RequestMapping</span></tt>アノテーションでは扱えない情報でグループを切り替えることはできない。</p>
<p>この場合は、<tt class="docutils literal"><span class="pre">&#64;Validated</span></tt>アノテーションを使用せず、<tt class="docutils literal"><span class="pre">org.springframework.validation.SmartValidator</span></tt>を使用し、Controllerの処理メソッド内でグループを指定したバリデーションを行えばよい。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">SmartValidator</span> <span class="n">smartValidator</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;confirm&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createConfirm</span><span class="o">(</span><span class="cm">/* (2) */</span> <span class="n">UserForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">validationGroup</span> <span class="o">=</span> <span class="n">Default</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
        <span class="c1">// logic to determine validation group</span>
        <span class="c1">// if (xxx) {</span>
        <span class="c1">//     validationGroup = Xxx.class;</span>
        <span class="c1">// }</span>
        <span class="n">smartValidator</span><span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">form</span><span class="o">,</span> <span class="n">result</span><span class="o">,</span> <span class="n">validationGroup</span><span class="o">);</span> <span class="c1">// (3)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">&quot;user/createForm&quot;</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="s">&quot;user/createConfirm&quot;</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">SmartValidator</span></tt>をインジェクションする。<tt class="docutils literal"><span class="pre">SmartValidator</span></tt>は<tt class="docutils literal"><span class="pre">&lt;mvc:annotation-driven&gt;</span></tt>の設定が行われていれば使用できるため、別途Bean定義不要である。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">&#64;Validated</span></tt>アノテーションは使わない。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">SmartValidator</span></tt>の<tt class="docutils literal"><span class="pre">validate</span></tt>メソッドを使用して、グループを指定したバリデーションを実行する。</div>
<div class="line">グループの指定は可変長引数になっており、複数指定できる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p class="last">基本的には、Controllerにロジックを書くべきではないため、<tt class="docutils literal"><span class="pre">&#64;RequestMapping</span></tt>の属性でルールを切り替えられるのであれば、<tt class="docutils literal"><span class="pre">SmartValidator</span></tt>は使わない方がよい。</p>
</div>
</div>
</div>
<div class="section" id="validation-correlation-check">
<span id="id7"></span><h3><a class="toc-backref" href="#id30">5.5.2.2. 相関項目チェック</a><a class="headerlink" href="#validation-correlation-check" title="Permalink to this headline">¶</a></h3>
<p>複数フィールドにまたがる相関項目チェックには、
Spring Validator(<tt class="docutils literal"><span class="pre">org.springframework.validation.Validator</span></tt>インタフェースを実装した<tt class="docutils literal"><span class="pre">Validator</span></tt>)、
または、Bean Validationを用いる。</p>
<p>それぞれ説明するが、先にそれぞれの特徴と推奨する使い分けを述べる。</p>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="40%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">方式</th>
<th class="head">特徴</th>
<th class="head">用途</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">Spring Validator</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">特定のクラスに対する入力チェックの作成が容易である。</div>
<div class="line">Controllerでの利用が不便。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">特定のフォームに依存した業務要件固有の入力チェック実装</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">Bean Validation</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力チェックの作成はSpring Validatorほど容易でない。</div>
<div class="line">Controllerでの利用が容易。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">特定のフォームに依存しない、開発プロジェクト共通の入力チェック実装</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="section" id="spring-validator">
<h4><a class="toc-backref" href="#id31">5.5.2.2.1. Spring Validatorによる相関項目チェック実装</a><a class="headerlink" href="#spring-validator" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">「パスワードリセット」処理を例に実装方法を説明する。</div>
<div class="line">以下のルールを実装する。ここでは「パスワードリセット」のフォームに以下のチェックルールを設ける。</div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="30%" />
<col width="30%" />
<col width="20%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">フィールド名</th>
<th class="head">型</th>
<th class="head">ルール</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">password</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">java.lang.String</span></tt></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力必須</div>
<div class="line">8文字以上</div>
<div class="line"><strong>confirmPasswordと同じ値であること</strong></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">confirmPassword</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">java.lang.String</span></tt></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">特になし</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">確認用パスワード</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>「confirmPasswordと同じ値であること」というルールは<tt class="docutils literal"><span class="pre">password</span></tt>フィールドと<tt class="docutils literal"><span class="pre">passwordConfirm</span></tt>フィールドの両方の情報が必要であるため、相関項目チェックルールである。</p>
<ul>
<li><p class="first">フォームクラス</p>
<p>相関項目チェックルール以外は、これまで通りBean Validationのアノテーションで実装する。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">sample</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordResetForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">8</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">confirmPassword</span><span class="o">;</span>

    <span class="c1">// omitted setter/getter</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">パスワードは、通常ハッシュ化してデータベースに保存するため、最大値のチェックは行わなくても良い。</p>
</div>
</li>
<li><p class="first">Validatorクラス</p>
<p><tt class="docutils literal"><span class="pre">org.springframework.validation.Validator</span></tt>インタフェースを実装して、相関項目チェックルールを実現する。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">sample</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.Errors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.Validator</span><span class="o">;</span>

<span class="nd">@Component</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordEqualsValidator</span> <span class="kd">implements</span> <span class="n">Validator</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">PasswordResetForm</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span> <span class="c1">// (2)</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">validate</span><span class="o">(</span><span class="n">Object</span> <span class="n">target</span><span class="o">,</span> <span class="n">Errors</span> <span class="n">errors</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">PasswordResetForm</span> <span class="n">form</span> <span class="o">=</span> <span class="o">(</span><span class="n">PasswordResetForm</span><span class="o">)</span> <span class="n">target</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="na">getPassword</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">confirmPassword</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="na">getConfirmPassword</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">password</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">confirmPassword</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (3)</span>
            <span class="c1">// must be checked by @NotNull</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">password</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">confirmPassword</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// (4)</span>
            <span class="n">errors</span><span class="o">.</span><span class="na">rejectValue</span><span class="o">(</span><span class="cm">/* (5) */</span> <span class="s">&quot;password&quot;</span><span class="o">,</span>
            <span class="cm">/* (6) */</span> <span class="s">&quot;PasswordEqualsValidator.passwordResetForm.password&quot;</span><span class="o">,</span>
            <span class="cm">/* (7) */</span> <span class="s">&quot;password and confirm password must be same.&quot;</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">項番</p>
</th>
<th class="head"><p class="first last">説明</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">&#64;Component</span></tt>を付与し、Validatorをコンポーネントスキャン対象にする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">このValidatorのチェック対象であるかどうかを判別する。ここでは、<tt class="docutils literal"><span class="pre">PasswordResetForm</span></tt>クラスをチェック対象とする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Bean Validationのルールと同様に、フィールドが<tt class="docutils literal"><span class="pre">null</span></tt>かどうかのチェックは、<tt class="docutils literal"><span class="pre">&#64;NotNull</span></tt>アノテーションに任せ、このValidatorでは、フィールドが<tt class="docutils literal"><span class="pre">null</span></tt>の場合は正常値とみなす。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">チェックロジックを実装する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラー対象のフィールド名を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラーメッセージのコード名を指定する。ここではコードを、</div>
<div class="line">&#8220;バリデータ名.フォーム属性名.プロパティ名&#8221;</div>
<div class="line">とする。メッセージ定義は<a class="reference internal" href="#validation-message-in-application-messages"><em>application-messages.propertiesに定義するメッセージ</em></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラーメッセージをコードで解決できなかった場合に使用する、デフォルトメッセージを設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Spring Validator実装クラスは、使用するControllerと同じパッケージに配置することを推奨する。</p>
</div>
</li>
<li><p class="first">Controllerクラス</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">sample</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.BindingResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.WebDataBinder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.InitBinder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ModelAttribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;password&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordResetController</span> <span class="o">{</span>
    <span class="nd">@Inject</span>
    <span class="n">PasswordEqualsValidator</span> <span class="n">passwordEqualsValidator</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="nd">@ModelAttribute</span>
    <span class="kd">public</span> <span class="n">PasswordResetForm</span> <span class="nf">setupForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">PasswordResetForm</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@InitBinder</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initBinder</span><span class="o">(</span><span class="n">WebDataBinder</span> <span class="n">binder</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">binder</span><span class="o">.</span><span class="na">addValidators</span><span class="o">(</span><span class="n">passwordEqualsValidator</span><span class="o">);</span> <span class="c1">// (2)</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;reset&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">resetForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;password/resetForm&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;reset&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">reset</span><span class="o">(</span><span class="nd">@Validated</span> <span class="n">PasswordResetForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (3)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">&quot;password/resetForm&quot;</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="s">&quot;redirect:/password/reset?complete&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;reset&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;complete&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">resetComplete</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;password/resetComplete&quot;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">項番</p>
</th>
<th class="head"><p class="first last">説明</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">使用するSpring Validatorを、インジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">&#64;InitBinder</span></tt>アノテーションがついたメソッド内で、<tt class="docutils literal"><span class="pre">WebDataBinder.addValidators</span></tt>メソッドにより、Validatorを追加する。</div>
<div class="line">これにより、<tt class="docutils literal"><span class="pre">&#64;Validated</span></tt>アノテーションでバリデーションをする際に、追加したValidatorも呼び出される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力チェックの実装は、これまで通りである。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">JSP</p>
<p>JSPに特筆すべき点はない。</p>
<div class="highlight-jsp"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="k">&lt;%-</span><span class="o">-</span> <span class="n">WEB</span><span class="o">-</span><span class="n">INF</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">password</span><span class="o">/</span><span class="n">resetForm</span><span class="o">.</span><span class="na">jsp</span> <span class="o">--</span><span class="k">%&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;style</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
/* omitted */
<span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;form:form</span> <span class="na">modelAttribute=</span><span class="s">&quot;passwordResetForm&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span>
        <span class="na">class=</span><span class="s">&quot;form-horizontal&quot;</span>
        <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/password/reset&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;password&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Password:<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:password</span> <span class="na">path=</span><span class="s">&quot;password&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;password&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;confirmPassword&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Password (Confirm):<span class="nt">&lt;/form:label&gt;</span>
        <span class="nt">&lt;form:password</span> <span class="na">path=</span><span class="s">&quot;confirmPassword&quot;</span>
            <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;confirmPassword&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;form:button&gt;</span>Reset<span class="nt">&lt;/form:button&gt;</span>
    <span class="nt">&lt;/form:form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
</li>
</ul>
<p><tt class="docutils literal"><span class="pre">password</span></tt>フィールドと、<tt class="docutils literal"><span class="pre">confirmPassword</span></tt>フィールドに、別の値を入力してフォームを送信した場合は、以下のようにエラーメッセージが表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/validations-correlation-check1.png"><img alt="../_images/validations-correlation-check1.png" src="../_images/validations-correlation-check1.png" style="width: 60%;" /></a>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><tt class="docutils literal"><span class="pre">&lt;form:password&gt;</span></tt>タグを使用すると、再表示時に、データがクリアされる。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>一つのControllerで複数のフォームを扱う場合は、Validatorの対象を限定するために、<tt class="docutils literal"><span class="pre">&#64;InitBinder(&quot;xxx&quot;)</span></tt>でモデル名を指定する必要がある。</p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;xxx&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">XxxController</span> <span class="o">{</span>
    <span class="c1">// omitted</span>
    <span class="nd">@ModelAttribute</span><span class="o">(</span><span class="s">&quot;aaa&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nf">AaaForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">AaaForm</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@ModelAttribute</span><span class="o">(</span><span class="s">&quot;bbb&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nf">BbbForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">BbbForm</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@InitBinder</span><span class="o">(</span><span class="s">&quot;aaa&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initBinderForAaa</span><span class="o">(</span><span class="n">WebDataBinder</span> <span class="n">binder</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// add validators for AaaForm</span>
        <span class="n">binder</span><span class="o">.</span><span class="na">addValidators</span><span class="o">(</span><span class="n">aaaValidator</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@InitBinder</span><span class="o">(</span><span class="s">&quot;bbb&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initBinderForBbb</span><span class="o">(</span><span class="n">WebDataBinder</span> <span class="n">binder</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// add validators for BbbForm</span>
        <span class="n">binder</span><span class="o">.</span><span class="na">addValidators</span><span class="o">(</span><span class="n">bbbValidator</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// omitted</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="bean-validation">
<h4><a class="toc-backref" href="#id32">5.5.2.2.2. Bean Validationによる相関項目チェック実装</a><a class="headerlink" href="#bean-validation" title="Permalink to this headline">¶</a></h4>
<p>Bean Validationによって、相関項目チェックの実装するためには、独自バリデーションルールの追加を行う必要がある。</p>
<p><a class="reference internal" href="#validation-custom-constraint"><em>How to extend</em></a>にて説明する。</p>
</div>
</div>
<div class="section" id="validation-message-def">
<span id="id8"></span><h3><a class="toc-backref" href="#id33">5.5.2.3. エラーメッセージの定義</a><a class="headerlink" href="#validation-message-def" title="Permalink to this headline">¶</a></h3>
<p>入力チェックエラーメッセージを変更する方法を説明する。</p>
<p>Spring MVCによるBean Validationのエラーメッセージは、以下の順で解決される。</p>
<ol class="arabic simple">
<li><tt class="docutils literal"><span class="pre">org.springframework.context.MessageSource</span></tt>に定義されているメッセージの中に、ルールに合致するものがあればそれをエラーメッセージとして使用する (Springのルール)</li>
<li>1.でメッセージが見つからない場合、アノテーションの<tt class="docutils literal"><span class="pre">message</span></tt>属性に、指定されたメッセージからエラーメッセージを取得する (Bean Validationのルール)</li>
</ol>
<blockquote>
<div><ol class="arabic simple">
<li><tt class="docutils literal"><span class="pre">message</span></tt>属性に指定されたメッセージが、&#8221;{メッセージキー}&#8221;形式でない場合、そのテキストをエラーメッセージとして使用する。</li>
<li><tt class="docutils literal"><span class="pre">message</span></tt>属性に指定されたメッセージが、&#8221;{メッセージキー}&#8221;形式の場合、クラスパス直下のValidationMessages.propertiesから、メッセージキーに対応するメッセージを探す。</li>
</ol>
<blockquote>
<div><ol class="arabic simple">
<li>メッセージキーに対応するメッセージが定義されている場合は、そのメッセージを使用する</li>
<li>メッセージキーに対応するメッセージが定義されていない場合は、&#8221;{メッセージキー}&#8221;をそのままエラーメッセージとして使用する</li>
</ol>
</div></blockquote>
</div></blockquote>
<p>基本的にエラーメッセージは、propertiesファイルに定義することを推奨する。</p>
<p>定義する箇所は、以下の2パターン存在する。</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">org.springframework.context.MessageSource</span></tt>が読み込むpropertiesファイル</li>
<li>クラスパス直下のValidationMessages.properties</li>
</ul>
<p>以下の説明では、applicationContext.xmlに次の設定があることを前提とし、前者を&#8221;application-messages.properties&#8221;、後者を&#8221;ValidationMessages.properties&#8221;と呼ぶ。</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;messageSource&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.context.support.ResourceBundleMessageSource&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;basenames&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;list&gt;</span>
            <span class="nt">&lt;value&gt;</span>i18n/application-messages<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../_images/validations-message-properties-position-image.png"><img alt="../_images/validations-message-properties-position-image.png" src="../_images/validations-message-properties-position-image.png" style="width: 40%;" /></a>
</div>
<p>本ガイドラインでは、以下のように定義を分けることを推奨する。</p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">プロパティファイル名</th>
<th class="head">定義する内容</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">ValidationMessages.properties</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">システムで定めたBean Validationのデフォルトエラーメッセージ</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">application-messages.properties</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">個別で上書きしたいBean Validationのエラーメッセージ</div>
<div class="line">Spring Validatorで実装した入力チェックのエラーメッセージ</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>ValidationMessages.propertiesを用意しない場合は、<a class="reference internal" href="#validation-default-message-in-hibernate-validator"><em>Hibernate Validatorが用意するデフォルトメッセージ</em></a>が使用される。</p>
<div class="section" id="validationmessages-properties">
<span id="validation-message-in-validationmessages"></span><h4><a class="toc-backref" href="#id34">5.5.2.3.1. ValidationMessages.propertiesに定義するメッセージ</a><a class="headerlink" href="#validationmessages-properties" title="Permalink to this headline">¶</a></h4>
<p>クラスパス直下(通常src/main/resources)のValidationMessages.properties内の、
Bean Validationのアノテーションの<tt class="docutils literal"><span class="pre">message</span></tt>属性に指定されたメッセージキーに対して、メッセージを定義する。</p>
<p><a class="reference internal" href="#validation-basic-validation"><em>基本的な単項目チェック</em></a>の初めに使用した、以下のフォームを用いて説明する。</p>
<ul>
<li><p class="first">フォームクラス(再掲)</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">20</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">50</span><span class="o">)</span>
    <span class="nd">@Email</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Min</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
    <span class="nd">@Max</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">age</span><span class="o">;</span>

    <span class="c1">// omitted getter/setter</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">ValidationMessages.properties</p>
<p><tt class="docutils literal"><span class="pre">&#64;NotNull</span></tt>, <tt class="docutils literal"><span class="pre">&#64;Size</span></tt>, <tt class="docutils literal"><span class="pre">&#64;Min</span></tt>, <tt class="docutils literal"><span class="pre">&#64;Max</span></tt>, <tt class="docutils literal"><span class="pre">&#64;Email</span></tt>のエラーメッセージを変更する。</p>
<div class="highlight-properties"><div class="highlight"><pre><span class="na">javax.validation.constraints.NotNull.message</span><span class="o">=</span><span class="s">is required.</span>
<span class="c"># (1)</span>
<span class="na">javax.validation.constraints.Size.message</span><span class="o">=</span><span class="s">size is not in the range {min} through {max}.</span>
<span class="c"># (2)</span>
<span class="na">javax.validation.constraints.Min.message</span><span class="o">=</span><span class="s">can not be less than {value}.</span>
<span class="na">javax.validation.constraints.Max.message</span><span class="o">=</span><span class="s">can not be greater than {value}.</span>
<span class="na">org.hibernate.validator.constraints.Email.message</span><span class="o">=</span><span class="s">is an invalid e-mail address.</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">項番</p>
</th>
<th class="head"><p class="first last">説明</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アノテーションに指定した属性値は、<tt class="docutils literal"><span class="pre">{属性名}</span></tt>で埋め込むことができる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">不正となった入力値は、<tt class="docutils literal"><span class="pre">{value}</span></tt>で埋め込むことができる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<p>この設定を加えた状態で、すべての入力フィールドを未入力のままフォームを送信すると、以下のように変更したエラーメッセージが、表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/validations-customize-message1.png"><img alt="../_images/validations-customize-message1.png" src="../_images/validations-customize-message1.png" style="width: 60%;" /></a>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Bean Validation標準のアノテーションやHibernate Validator独自のアノテーションには<tt class="docutils literal"><span class="pre">message</span></tt>属性に<tt class="docutils literal"><span class="pre">{アノテーションのFQCN.message}</span></tt>という値が設定されているため、</p>
<blockquote>
<div><div class="highlight-properties"><div class="highlight"><pre><span class="na">アノテーションのFQCN.message</span><span class="o">=</span><span class="s">メッセージ</span>
</pre></div>
</div>
</div></blockquote>
<p class="last">という形式でプロパティファイルにメッセージを定義すればよいが、すべてのアノテーションが、この形式になっているわけではないので、
対象のアノテーションのJavadocまたはソースコードを確認すること。</p>
</div>
<p>エラーメッセージに、フィールド名を含める場合は、以下のように、メッセージに<tt class="docutils literal"><span class="pre">{0}</span></tt>を加える。</p>
<ul>
<li><p class="first">ValidationMessages.properties</p>
<p><tt class="docutils literal"><span class="pre">&#64;NotNull</span></tt>、<tt class="docutils literal"><span class="pre">&#64;Size</span></tt>、<tt class="docutils literal"><span class="pre">&#64;Min</span></tt>、<tt class="docutils literal"><span class="pre">&#64;Max</span></tt>、<tt class="docutils literal"><span class="pre">&#64;Email</span></tt>のエラーメッセージを変更する。</p>
<div class="highlight-properties"><div class="highlight"><pre><span class="na">javax.validation.constraints.NotNull.message</span><span class="o">=</span><span class="s">&quot;{0}&quot; is required.</span>
<span class="na">javax.validation.constraints.Size.message</span><span class="o">=</span><span class="s">The size of &quot;{0}&quot; is not in the range {min} through {max}.</span>
<span class="na">javax.validation.constraints.Min.message</span><span class="o">=</span><span class="s">&quot;{0}&quot; can not be less than {value}.</span>
<span class="na">javax.validation.constraints.Max.message</span><span class="o">=</span><span class="s">&quot;{0}&quot; can not be greater than {value}.</span>
<span class="na">org.hibernate.validator.constraints.Email.message</span><span class="o">=</span><span class="s">&quot;{0}&quot; is an invalid e-mail address.</span>
</pre></div>
</div>
</li>
</ul>
<p>エラーメッセージは、以下のように変更される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/validations-customize-message2.png"><img alt="../_images/validations-customize-message2.png" src="../_images/validations-customize-message2.png" style="width: 60%;" /></a>
</div>
<p>このままでは、フォームクラスのプロパティ名が表示されてしまい、ユーザーフレンドリではない。
適切なフィールド名を表示したい場合は、<strong>application-messages.propertiesに</strong></p>
<div class="highlight-properties"><div class="highlight"><pre><span class="na">フォームのプロパティ名</span><span class="o">=</span><span class="s">表示するフィールド名</span>
</pre></div>
</div>
<p>形式でフィールド名を定義すればよい。</p>
<p>これまでの例に、以下の設定を追加する。</p>
<ul>
<li><p class="first">application-messages.properties</p>
<div class="highlight-properties"><div class="highlight"><pre><span class="na">name</span><span class="o">=</span><span class="s">Name</span>
<span class="na">email</span><span class="o">=</span><span class="s">Email</span>
<span class="na">age</span><span class="o">=</span><span class="s">Age</span>
</pre></div>
</div>
</li>
</ul>
<p>エラーメッセージは、以下のように変更される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/validations-customize-message3.png"><img alt="../_images/validations-customize-message3.png" src="../_images/validations-customize-message3.png" style="width: 60%;" /></a>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><tt class="docutils literal"><span class="pre">{0}</span></tt>でフィールド名を埋め込めむのは、Bean Validationの機能ではなく、Springの機能である。
したがって、フィールド名変更の設定は、Spring管理下のapplication-messages.properties(<tt class="docutils literal"><span class="pre">ResourceBundleMessageSource</span></tt>)に定義する必要がある。</p>
</div>
</div>
<div class="section" id="application-messages-properties">
<span id="validation-message-in-application-messages"></span><h4><a class="toc-backref" href="#id35">5.5.2.3.2. application-messages.propertiesに定義するメッセージ</a><a class="headerlink" href="#application-messages-properties" title="Permalink to this headline">¶</a></h4>
<p>ValidationMessages.propertiesでシステムで利用するデフォルトのメッセージを定義したが、
画面によっては、デフォルトメッセージから変更したい場合が出てくる。</p>
<p>その場合、application-messages.propertiesに、以下の形式でメッセージを定義する。</p>
<div class="highlight-properties"><div class="highlight"><pre><span class="na">アノテーション名.フォーム属性名.プロパティ名</span><span class="o">=</span><span class="s">対象のメッセージ</span>
</pre></div>
</div>
<p><a class="reference internal" href="#validation-message-in-validationmessages"><em>ValidationMessages.propertiesに定義するメッセージ</em></a>の設定がある前提で、以下の設定で<tt class="docutils literal"><span class="pre">age</span></tt>フィールドのメッセージを上書きする。</p>
<ul>
<li><p class="first">application-messages.properties</p>
<div class="highlight-properties"><div class="highlight"><pre><span class="c"># override messages</span>
<span class="na">NotNull.userForm.age</span><span class="o">=</span><span class="s">&quot;{0}&quot; is compulsory.</span>
<span class="na">Max.userForm.age</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be less than or equal to {1}.</span>
<span class="na">Max.userForm.age</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be less than or equal to {1}.</span>
<span class="na">NotNull.userForm.email</span><span class="o">=</span><span class="s">&quot;{0}&quot; is compulsory.</span>
<span class="na">Size.userForm.age</span><span class="o">=</span><span class="s">The size of &quot;{0}&quot; must be between {2} and {1}.</span>
<span class="c"># filed names</span>
<span class="na">name</span><span class="o">=</span><span class="s">Name</span>
<span class="na">email</span><span class="o">=</span><span class="s">Email</span>
<span class="na">age</span><span class="o">=</span><span class="s">Age</span>
</pre></div>
</div>
</li>
</ul>
<p>アノテーションの属性値は、<tt class="docutils literal"><span class="pre">{1}</span></tt>以降に埋め込まれる。</p>
<p>エラーメッセージは以下のように変更される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/validations-customize-message4.png"><img alt="../_images/validations-customize-message4.png" src="../_images/validations-customize-message4.png" style="width: 60%;" /></a>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">application-messages.propertiesのメッセージキーの形式は、<a class="reference external" href="http://docs.spring.io/spring/docs/3.2.x/javadoc-api/org/springframework/validation/DefaultMessageCodesResolver.html">これ以外にも用意されている</a>が、
デフォルトメッセージを一部上書きする目的で使用するのであれば、基本的に、<tt class="docutils literal"><span class="pre">アノテーション名.フォーム属性名.プロパティ名</span></tt>形式でよい。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-extend">
<span id="validation-custom-constraint"></span><h2><a class="toc-backref" href="#id36">5.5.3. How to extend</a><a class="headerlink" href="#how-to-extend" title="Permalink to this headline">¶</a></h2>
<p>Bean Validationは標準で用意されているチェックルール以外に、独自ルール用アノテーションを作成する仕組みをもつ。</p>
<p>作成方法は大きく分けて、以下の観点で分かれる。</p>
<ul class="simple">
<li>既存ルールの組み合わせ</li>
<li>新規ルールの作成</li>
</ul>
<p>基本的には、以下の雛形を使用して、ルール毎にアノテーションを作成する。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.Documented</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Constraint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Payload</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">ANNOTATION_TYPE</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">CONSTRUCTOR</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">FIELD</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">PARAMETER</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">;</span>

<span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{})</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">Xxx</span> <span class="o">{</span>
    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{com.example.common.validation.Xxx.message}&quot;</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="n">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">Xxx</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="section" id="id10">
<h3><a class="toc-backref" href="#id37">5.5.3.1. 既存ルールを組み合わせたBean Validationアノテーションの作成</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>システム共通で、</p>
<ul class="simple">
<li>文字列は半角英数字の文字種に限定したい</li>
<li>数値は正の数に限定したい</li>
</ul>
<div class="line-block">
<div class="line">または、ドメイン共通で、</div>
</div>
<ul class="simple">
<li>「ユーザーID」は、特定の4文字以上20文字以下の半角英字に制限したい</li>
<li>「年齢」は、特定の1歳以上150歳以下に制限したい</li>
</ul>
<div class="line-block">
<div class="line">という制約がある場合を考える。</div>
<div class="line">これらは既存ルールの<tt class="docutils literal"><span class="pre">&#64;Pattern</span></tt>、<tt class="docutils literal"><span class="pre">&#64;Size</span></tt>、<tt class="docutils literal"><span class="pre">&#64;Min</span></tt>、<tt class="docutils literal"><span class="pre">&#64;Max</span></tt>等を組み合わせることでも実現できるが、</div>
<div class="line">同じルールを複数の箇所で使用すると、設定内容が分散してしまい、メンテナンス性が悪化する。</div>
</div>
<p>複数のルールを組み合わせて一つのルールを作成することができる。
独自アノテーションを作成すると、正規表現パターンや、最大値・最小値などの値を共通化できるだけでなく、エラーメッセージも共通化できるというメリットがある。
これにより、再利用性や保守性が高まる。複数のルールの組み合わせではなくても、一つのルールの属性を特定するだけでも効果的である。</p>
<p>以下に、実装例を示す。</p>
<ul>
<li><p class="first">半角英数字の文字種に限定する<tt class="docutils literal"><span class="pre">&#64;Alphanumeric</span></tt>アノテーションの実装例</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.Documented</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Constraint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Payload</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.ReportAsSingleViolation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Pattern</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">ANNOTATION_TYPE</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">CONSTRUCTOR</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">FIELD</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">PARAMETER</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">;</span>

<span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{})</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="hll"><span class="nd">@ReportAsSingleViolation</span> <span class="c1">// (1)</span>
</span><span class="hll"><span class="nd">@Pattern</span><span class="o">(</span><span class="n">regexp</span> <span class="o">=</span> <span class="s">&quot;[a-zA-Z0-9]*&quot;</span><span class="o">)</span> <span class="c1">// (2)</span>
</span><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">AlphaNumeric</span> <span class="o">{</span>
<span class="hll">    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{com.example.common.validation.AlphaNumeric.message}&quot;</span><span class="o">;</span> <span class="c1">// (3)</span>
</span>
    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="n">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">AlphaNumeric</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">項番</p>
</th>
<th class="head"><p class="first last">説明</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラーメッセージをまとめ、エラー時はこのアノテーションによるメッセージだけを変えるようにする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">このアノテーションにより使用されるルールを定義する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラーメッセージのデフォルト値を定義する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">正の数に限定する<tt class="docutils literal"><span class="pre">&#64;NotNegaitive</span></tt>アノテーションの実装例</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.Documented</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Constraint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Payload</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.ReportAsSingleViolation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Min</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">ANNOTATION_TYPE</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">CONSTRUCTOR</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">FIELD</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">PARAMETER</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">;</span>

<span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{})</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="hll"><span class="nd">@ReportAsSingleViolation</span>
</span><span class="hll"><span class="nd">@Min</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="o">)</span>
</span><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">NotNegaitive</span> <span class="o">{</span>
<span class="hll">    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{com.example.common.validation.NotNegaitive.message}&quot;</span><span class="o">;</span>
</span>
    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="n">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">NotNegaitive</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">「ユーザーID」のフォーマットを規定する<tt class="docutils literal"><span class="pre">&#64;UserId</span></tt>アノテーションの実装例</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">sample</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.Documented</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Constraint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Payload</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.ReportAsSingleViolation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Pattern</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">ANNOTATION_TYPE</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">CONSTRUCTOR</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">FIELD</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">PARAMETER</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">;</span>

<span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{})</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="hll"><span class="nd">@ReportAsSingleViolation</span>
</span><span class="hll"><span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">4</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">20</span><span class="o">)</span>
</span><span class="hll"><span class="nd">@Pattern</span><span class="o">(</span><span class="n">regexp</span> <span class="o">=</span> <span class="s">&quot;[a-z]*&quot;</span><span class="o">)</span>
</span><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">UserId</span> <span class="o">{</span>
<span class="hll">    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{com.example.sample.domain.validation.UserId.message}&quot;</span><span class="o">;</span>
</span>
    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="n">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">UserId</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">「年齢」の制限を規定する<tt class="docutils literal"><span class="pre">&#64;Age</span></tt>アノテーションの実装例</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">sample</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.Documented</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Constraint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Payload</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.ReportAsSingleViolation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Max</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Min</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">ANNOTATION_TYPE</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">CONSTRUCTOR</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">FIELD</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">PARAMETER</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">;</span>

<span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{})</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="hll"><span class="nd">@ReportAsSingleViolation</span>
</span><span class="hll"><span class="nd">@Min</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
</span><span class="hll"><span class="nd">@Max</span><span class="o">(</span><span class="mi">150</span><span class="o">)</span>
</span><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">Age</span> <span class="o">{</span>
<span class="hll">    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{com.example.sample.domain.validation.Age.message}&quot;</span><span class="o">;</span>
</span>
    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="n">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">Age</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">1つのアノテーションに複数のルールを設定した場合、それらのAND条件が複合ルールとなる。
Hibernate Validatorでは、OR条件を実現するための<tt class="docutils literal"><span class="pre">&#64;ConstraintComposition</span></tt>アノテーションが用意されている。
詳細は、<a class="reference external" href="http://docs.jboss.org/hibernate/validator/4.3/reference/en-US/html/validator-specifics.html#d0e3701">Hibernate Validatorのドキュメント</a>を参照されたい。</p>
</div>
</li>
</ul>
</div>
<div class="section" id="id11">
<h3><a class="toc-backref" href="#id38">5.5.3.2. 新規ルールを実装したBean Validationアノテーションの作成</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<p><tt class="docutils literal"><span class="pre">javax.validation.ConstraintValidator</span></tt>インタフェースを実装し、そのValidatorを使用するアノテーションを作成することで、任意のルールを作成することができる。</p>
<p>用途としては、以下の3通りが挙げられる。</p>
<ul class="simple">
<li>既存のルールの組み合わせでは表現できないルール</li>
<li>相関項目チェックルール</li>
<li>業務ロジックチェック</li>
</ul>
<div class="section" id="id12">
<h4><a class="toc-backref" href="#id39">5.5.3.2.1. 既存のルールの組み合わせでは表現できないルール</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<p><tt class="docutils literal"><span class="pre">&#64;Pattern</span></tt>、<tt class="docutils literal"><span class="pre">&#64;Size</span></tt>、<tt class="docutils literal"><span class="pre">&#64;Min</span></tt>、<tt class="docutils literal"><span class="pre">&#64;Max</span></tt>等を組み合わせても表現できないルールは、<tt class="docutils literal"><span class="pre">javax.validation.ConstraintValidator</span></tt>実装クラスに記述する。</p>
<p>例として、ISBN(International Standard Book Number)-13の形式をチェックするルールを挙げる。</p>
<ul>
<li><p class="first">アノテーション</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.Documented</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Constraint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Payload</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">ANNOTATION_TYPE</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">CONSTRUCTOR</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">FIELD</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">PARAMETER</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">;</span>

<span class="nd">@Documented</span>
<span class="hll"><span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{</span> <span class="n">ISBN13Validator</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span> <span class="c1">// (1)</span>
</span><span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">ISBN13</span> <span class="o">{</span>
    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{com.example.common.validation.ISBN13.message}&quot;</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="n">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">ISBN13</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">項番</p>
</th>
<th class="head"><p class="first last">説明</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">このアノテーションを使用したときに実行される<tt class="docutils literal"><span class="pre">ConstraintValidator</span></tt>を指定する。複数指定することができる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Validator</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.ConstraintValidator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.ConstraintValidatorContext</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ISBN13Validator</span> <span class="kd">implements</span> <span class="n">ConstraintValidator</span><span class="o">&lt;</span><span class="n">ISBN13</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span> <span class="c1">// (1)</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">ISBN13</span> <span class="n">constraintAnnotation</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (2)</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isValid</span><span class="o">(</span><span class="n">String</span> <span class="n">value</span><span class="o">,</span> <span class="n">ConstraintValidatorContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (3)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">// (4)</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nf">isISBN13Valid</span><span class="o">(</span><span class="n">value</span><span class="o">);</span> <span class="c1">// (5)</span>
    <span class="o">}</span>

    <span class="c1">// This logic is written in http://en.wikipedia.org/wiki/International_Standard_Book_Number</span>
    <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isISBN13Valid</span><span class="o">(</span><span class="n">String</span> <span class="n">isbn</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isbn</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">13</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kt">int</span> <span class="n">check</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="o">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">check</span> <span class="o">+=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">isbn</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">));</span>
            <span class="o">}</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="o">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">check</span> <span class="o">+=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">isbn</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">))</span> <span class="o">*</span> <span class="mi">3</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">check</span> <span class="o">+=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">isbn</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">12</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NumberFormatException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">check</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">項番</p>
</th>
<th class="head"><p class="first last">説明</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ジェネリクスのパラメータに、対象のアノテーションとフィールドの型を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">initialize</span></tt>メソッドに、初期化処理を実装する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">isValid</span></tt>メソッドで入力チェック処理を実装する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力値が、<tt class="docutils literal"><span class="pre">null</span></tt>の場合は、正常とみなす。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ISBN-13の形式のチェックを行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last"><a class="reference internal" href="FileUpload.html#fileupload-validator"><em>ファイルアップロードのBean Validation</em></a>の例も、ここに分類される。また共通ライブラリでは、この実装として<a class="reference internal" href="Codelist.html#codelist-validate"><em>&#64;ExistInCodeList</em></a>を用意している。</p>
</div>
</div>
<div class="section" id="id13">
<h4><a class="toc-backref" href="#id40">5.5.3.2.2. 相関項目チェックルール</a><a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><a class="reference internal" href="#validation-correlation-check"><em>相関項目チェック</em></a>で説明したように、Bean Validationによって複数のフィールドにまたがる相関項目チェックを実装できる。</div>
<div class="line">Bean Validationで相関項目チェックルールを実装する場合は、汎用的なルールを対象とすることを推奨する。</div>
</div>
<p>以下では、「あるフィールドとその確認用フィールドの内容が一致すること」というルールを実現する例を挙げる。</p>
<p>ここでは、確認用フィールドの先頭に、「confirm」を付与する規約を設ける。</p>
<ul>
<li><p class="first">アノテーション</p>
<p>相関項目チェック用のアノテーションはクラスレベルに付与できるようにする。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.Documented</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Constraint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Payload</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">ANNOTATION_TYPE</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">;</span>

<span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{</span> <span class="n">ConfirmValidator</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
<span class="hll"><span class="nd">@Target</span><span class="o">({</span> <span class="n">TYPE</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span> <span class="o">})</span> <span class="c1">// (1)</span>
</span><span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">Confirm</span> <span class="o">{</span>
    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{com.example.common.validation.Confirm.message}&quot;</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="n">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="cm">/**</span>
<span class="cm">     * Field name</span>
<span class="cm">     */</span>
<span class="hll">    <span class="n">String</span> <span class="nf">field</span><span class="o">();</span> <span class="c1">// (2)</span>
</span>
    <span class="nd">@Target</span><span class="o">({</span> <span class="n">TYPE</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">Confirm</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">項番</p>
</th>
<th class="head"><p class="first last">説明</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">このアノテーションが、クラスまたはアノテーションにのみ付加できるように、対象を絞る。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アノテーションに渡すパラメータを定義する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Validator</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.ConstraintValidator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.ConstraintValidatorContext</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.BeanWrapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.BeanWrapperImpl</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.ObjectUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.StringUtils</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConfirmValidator</span> <span class="kd">implements</span> <span class="n">ConstraintValidator</span><span class="o">&lt;</span><span class="n">Confirm</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">field</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">confirmField</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">message</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">Confirm</span> <span class="n">constraintAnnotation</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">constraintAnnotation</span><span class="o">.</span><span class="na">field</span><span class="o">();</span>
        <span class="n">confirmField</span> <span class="o">=</span> <span class="s">&quot;confirm&quot;</span> <span class="o">+</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">capitalize</span><span class="o">(</span><span class="n">field</span><span class="o">);</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">constraintAnnotation</span><span class="o">.</span><span class="na">message</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isValid</span><span class="o">(</span><span class="n">Object</span> <span class="n">value</span><span class="o">,</span> <span class="n">ConstraintValidatorContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">BeanWrapper</span> <span class="n">beanWrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BeanWrapperImpl</span><span class="o">(</span><span class="n">value</span><span class="o">);</span> <span class="c1">// (1)</span>
        <span class="n">Object</span> <span class="n">fieldValue</span> <span class="o">=</span> <span class="n">beanWrapper</span><span class="o">.</span><span class="na">getPropertyValue</span><span class="o">(</span><span class="n">field</span><span class="o">);</span> <span class="c1">// (2)</span>
        <span class="n">Object</span> <span class="n">confirmFieldValue</span> <span class="o">=</span> <span class="n">beanWrapper</span><span class="o">.</span><span class="na">getPropertyValue</span><span class="o">(</span><span class="n">confirmField</span><span class="o">);</span>
        <span class="kt">boolean</span> <span class="n">matched</span> <span class="o">=</span> <span class="n">ObjectUtils</span><span class="o">.</span><span class="na">nullSafeEquals</span><span class="o">(</span><span class="n">fieldValue</span><span class="o">,</span>
                <span class="n">confirmFieldValue</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">matched</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">context</span><span class="o">.</span><span class="na">disableDefaultConstraintViolation</span><span class="o">();</span> <span class="c1">// (3)</span>
            <span class="n">context</span><span class="o">.</span><span class="na">buildConstraintViolationWithTemplate</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">addNode</span><span class="o">(</span><span class="n">field</span><span class="o">).</span><span class="na">addConstraintViolation</span><span class="o">();</span> <span class="c1">// (4)</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">項番</p>
</th>
<th class="head"><p class="first last">説明</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JavaBeanのプロパティにアクセスする際に便利な<tt class="docutils literal"><span class="pre">org.springframework.beans.BeanWrapper</span></tt>を使用する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">BeanWrapper</span></tt>経由で、フォームオブジェクトからプロパティ値を取得する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">デフォルトの<tt class="docutils literal"><span class="pre">ConstraintViolation</span></tt>オブジェクトの生成を無効にする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">独自<tt class="docutils literal"><span class="pre">ConstraintViolation</span></tt>オブジェクトを生成する。</div>
<div class="line"><tt class="docutils literal"><span class="pre">ConstraintValidatorContext.buildConstraintViolationWithTemplate</span></tt>で出力するメッセージを定義する。</div>
<div class="line">本例では、<tt class="docutils literal"><span class="pre">ConstraintValidatorContext.getDefaultConstraintMessageTemplate</span></tt>メソッドで、デフォルトのメッセージ定義を引き継いで設定する。</div>
<div class="line"><tt class="docutils literal"><span class="pre">ConstraintViolationBuilder.addNode</span></tt>でエラーメッセージを出力したいフィールド名を指定する。</div>
<div class="line">詳細は、以下の<a class="reference external" href="http://docs.oracle.com/javaee/6/api/javax/validation/ConstraintValidatorContext.html">JavaDoc</a>を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<p>この<tt class="docutils literal"><span class="pre">&#64;Confirm</span></tt>アノテーションを使用して、前述の「パスワードリセット」処理を再実装すると、以下のようになる。</p>
<ul>
<li><p class="first">フォームクラス</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">sample</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.common.validation.Confirm</span><span class="o">;</span>

<span class="nd">@Confirm</span><span class="o">(</span><span class="n">field</span> <span class="o">=</span> <span class="s">&quot;password&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordResetForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">8</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">confirmPassword</span><span class="o">;</span>

    <span class="c1">// omitted geter/setter</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">項番</p>
</th>
<th class="head"><p class="first last">説明</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クラスレベルに<tt class="docutils literal"><span class="pre">&#64;Confirm</span></tt>アノテーションを付与する。</div>
<div class="line">これにより<tt class="docutils literal"><span class="pre">ConstraintValidator.isValid</span></tt>の引数にはフォームオブジェクトが渡る。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Controllerクラス</p>
<p>Validatorのインジェクションおよび<tt class="docutils literal"><span class="pre">&#64;InitBinder</span></tt>によるValidatorの追加は、不要になる。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">sample</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.BindingResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ModelAttribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;password&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordResetController</span> <span class="o">{</span>

    <span class="nd">@ModelAttribute</span>
    <span class="kd">public</span> <span class="n">PasswordResetForm</span> <span class="nf">setupForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">PasswordResetForm</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;reset&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">resetForm</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;password/resetForm&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;reset&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">reset</span><span class="o">(</span><span class="nd">@Validated</span> <span class="n">PasswordResetForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">&quot;password/resetForm&quot;</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="s">&quot;redirect:/password/reset?complete&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;reset&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;complete&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">resetComplete</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;password/resetComplete&quot;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="id14">
<h4><a class="toc-backref" href="#id41">5.5.3.2.3. 業務ロジックチェック</a><a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">業務ロジックチェックは、基本的には<a class="reference internal" href="../ImplementationAtEachLayer/DomainLayer.html#service-implementation-label"><em>ドメイン層のServiceで実装</em></a>し、結果メッセージは<tt class="docutils literal"><span class="pre">ResultMessages</span></tt>オブジェクトに格納することを推奨している。</div>
<div class="line">したがって、<a class="reference internal" href="MessageManagement.html#message-display"><em>通常画面の上部などに表示されることを想定している</em></a>。</div>
</div>
<p>一方で、「入力されたユーザー名が既に登録済みかどうか」など、対象の入力フィールドに対する業務ロジックエラーメッセージを、フィールドの横に表示したい場合もある。
このような場合は、ValidatorクラスにServiceクラスをインジェクションして、業務ロジックチェックを実行し、その結果を、<tt class="docutils literal"><span class="pre">ConstraintValidator.isValid</span></tt>の結果に使用すればよい。</p>
<p>「入力されたユーザー名が既に登録済みかどうか」をBean Validationで実現する例を示す。</p>
<ul>
<li><p class="first">Serviceクラス</p>
<p>実装クラス(UserServiceImpl)は割愛する。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">sample</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">user</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserService</span> <span class="o">{</span>

    <span class="kt">boolean</span> <span class="nf">isUnusedUserId</span><span class="o">(</span><span class="n">String</span> <span class="n">userId</span><span class="o">);</span>

    <span class="c1">// omitted other methods</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">アノテーション</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">sample</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.Documented</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Constraint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Payload</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">ANNOTATION_TYPE</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">CONSTRUCTOR</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">FIELD</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ElementType</span><span class="o">.</span><span class="na">PARAMETER</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">;</span>

<span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{</span> <span class="n">UnusedUserIdValidator</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">UnusedUserId</span> <span class="o">{</span>
    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{com.example.sample.domain.validation.UnusedUserId.message}&quot;</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="n">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">UnusedUserId</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Validatorクラス</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">sample</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">validation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.ConstraintValidator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.ConstraintValidatorContext</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.sample.domain.service.user.UserService</span><span class="o">;</span>

<span class="hll"><span class="nd">@Component</span> <span class="c1">// (1)</span>
</span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UnusedUserIdValidator</span> <span class="kd">implements</span>
                                  <span class="n">ConstraintValidator</span><span class="o">&lt;</span><span class="n">UnusedUserId</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>

<span class="hll">    <span class="nd">@Inject</span> <span class="c1">// (2)</span>
</span><span class="hll">    <span class="n">UserService</span> <span class="n">userService</span><span class="o">;</span>
</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">UnusedUserId</span> <span class="n">constraintAnnotation</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isValid</span><span class="o">(</span><span class="n">String</span> <span class="n">value</span><span class="o">,</span> <span class="n">ConstraintValidatorContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">userService</span><span class="o">.</span><span class="na">isUnusedUserId</span><span class="o">(</span><span class="n">value</span><span class="o">);</span> <span class="c1">// (3)</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">項番</p>
</th>
<th class="head"><p class="first last">説明</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Validatorクラスをコンポーネントスキャンの対象にする。</div>
<div class="line">パッケージがBean定義ファイルの<tt class="docutils literal"><span class="pre">&lt;context:component-scan</span> <span class="pre">base-package=&quot;...&quot;</span> <span class="pre">/&gt;</span></tt>の設定に含まれている必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">呼び出すServiceクラスを、インジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">業務ロジックの結果を返却する。<tt class="docutils literal"><span class="pre">isValid</span></tt>メソッド名で業務ロジックを記述せず、かならずServiceに処理を委譲すること。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="appendix">
<h2><a class="toc-backref" href="#id42">5.5.4. Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id15">
<h3><a class="toc-backref" href="#id43">5.5.4.1. Hibernate Validatorが用意する入力チェックルール</a><a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Hibernate ValidatorはJSR-303で定義されたアノテーションに加え、検証できるアノテーションを追加している。</div>
<div class="line">検証に使用することができるアノテーションのリストは、<a class="reference external" href="http://docs.jboss.org/hibernate/validator/4.3/reference/en-US/html_single/#section-builtin-constraints">こちら</a>を参照されたい。</div>
</div>
<div class="section" id="jsr-303">
<span id="validation-jsr303-doc"></span><h4><a class="toc-backref" href="#id44">5.5.4.1.1. JSR-303のチェックルール</a><a class="headerlink" href="#jsr-303" title="Permalink to this headline">¶</a></h4>
<p>JSR-303アノテーションを、以下に示す。</p>
<p>詳細は、<a class="reference external" href="http://download.oracle.com/otn-pub/jcp/bean_validation-1.0-fr-oth-JSpec/bean_validation-1_0-final-spec.pdf">JSR-303 Specification</a>の6章を参照されたい。</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">アノテーション(javax.validation.*)</th>
<th class="head">対象の型</th>
<th class="head">用途</th>
<th class="head">使用例</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">&#64;NotNull</span></tt></td>
<td>任意</td>
<td>対象のフィールドが、nullでないことを検証する。</td>
<td><div class="first last line-block">
<div class="line">&#64;NotNull</div>
<div class="line">private String id;</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">&#64;Null</span></tt></td>
<td>任意</td>
<td><div class="first last line-block">
<div class="line">対象のフィールドが、nullであることを検証する。</div>
<div class="line">(例：グループ検証での使用)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">&#64;Nulll(groups={Update.class})</div>
<div class="line">private String id;</div>
</div>
</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">&#64;Pattern</span></tt></td>
<td>String</td>
<td><div class="first last line-block">
<div class="line">対象のフィールドが正規表現にマッチするかどうか</div>
<div class="line">(Hibernate Validator実装では、任意のCharSequence継承クラスにも適用可能)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">&#64;Pattern(regexp = &#8220;[0-9]+&#8221;)</div>
<div class="line">private String tel;</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">&#64;Min</span></tt></td>
<td><div class="first last line-block">
<div class="line">BigDecimal, BigInteger, byte, short, int, longおよびラッパー</div>
<div class="line">(Hibernate Validator実装では、任意のNumber,CharSequence継承クラスにも適用可能。ただし、文字列が数値表現の場合に限る。)</div>
</div>
</td>
<td>値が、最小値以上であるかどうかを検証する。</td>
<td>&#64;Max参照</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">&#64;Max</span></tt></td>
<td><div class="first last line-block">
<div class="line">BigDecimal, BigInteger, byte, short, int, longおよびラッパー</div>
<div class="line">(Hibernate Validator実装では任意のNumber,CharSequence継承クラスにも適用可能。ただし、文字列が数値表現の場合に限る。)</div>
</div>
</td>
<td>値が、最大値以下であるかどうかを検証する。</td>
<td><div class="first last line-block">
<div class="line">&#64;Min(1)</div>
<div class="line">&#64;Max(100)</div>
<div class="line">private int quantity;</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">&#64;DecimalMin</span></tt></td>
<td>BigDecimal, BigInteger, String, byte, short, int, longおよびラッパー
(Hibernate Validator実装では任意のNumber,CharSequence継承クラスにも適用可能)</td>
<td>Decimal型の値が最小値以上であるかどうかを検証する。</td>
<td>&#64;DecimalMax参照</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">&#64;DecimalMax</span></tt></td>
<td>BigDecimal, BigInteger, String, byte, short, int, longおよびラッパー
(Hibernate Validator実装では任意のNumber,CharSequence継承クラスにも適用可能)</td>
<td>Decimal型の値が、最大値以下であるかどうかを検証する。</td>
<td><div class="first last line-block">
<div class="line">&#64;DecimalMin(&#8220;0.0&#8221;)</div>
<div class="line">&#64;DecimalMax(&#8220;99999.99&#8221;)</div>
<div class="line">private BigDecimal price;</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">&#64;Size</span></tt></td>
<td>String(length), Collection(size), Map(size), Array(length)
(Hibernate Validator実装では、任意のCharSequence継承クラスにも適用可能)</td>
<td><div class="first last line-block">
<div class="line">lengthがminとmaxの間のサイズか検証する。</div>
<div class="line">minとmaxは省略可能であるが、デフォルトはmin=0,max= Integer.MAX_VALUEとなる。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">&#64;Size(min=4, max=64)</div>
<div class="line">private String password;</div>
</div>
</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">&#64;Digits</span></tt></td>
<td>BigDecimal, BigInteger, String, byte, short, int, longおよびラッパー</td>
<td><div class="first last line-block">
<div class="line">値が指定された範囲内の数値であるかチェックする。</div>
<div class="line">integerに最大整数の桁を指定し、fractionに最大小数桁を指定する。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">&#64;Digits(integer=6, fraction=2)</div>
<div class="line">private BigDecimal price;</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">&#64;AssertTrue</span></tt></td>
<td>boolean,Boolean</td>
<td>対象のフィールドがtrueであることを検証する(例：規約に同意したかどうか）</td>
<td><div class="first last line-block">
<div class="line">&#64;AssertTrue</div>
<div class="line">private boolean checked;</div>
</div>
</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">&#64;AssertFalse</span></tt></td>
<td>boolean,Boolean</td>
<td>対象のフィールドがfalseであることを検証する(例：規約に同意したかどうか）</td>
<td><div class="first last line-block">
<div class="line">&#64;AssertFalse</div>
<div class="line">private boolean checked;</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">&#64;Future</span></tt></td>
<td>Date, Calender
(Hibernate Validator実装ではJoda-Timeのクラスにも適用可能)</td>
<td>未来日付であるか検証する。</td>
<td><div class="first last line-block">
<div class="line">&#64;Future</div>
<div class="line">private Date eventDate;</div>
</div>
</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">&#64;Past</span></tt></td>
<td>Date, Calender
(Hibernate Validator実装ではJoda-Timeのクラスにも適用可能)</td>
<td>過去日付であるか検証する。</td>
<td><div class="first last line-block">
<div class="line">&#64;Past</div>
<div class="line">private Date eventDate;</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">&#64;Valid</span></tt></td>
<td>任意の非プリミティブ型</td>
<td>関連付けられているオブジェクトについて、再帰的に検証を行う。</td>
<td><div class="first last line-block">
<div class="line">&#64;Valid</div>
<div class="line">private List&lt;Employer&gt; employers;</div>
<div class="line"><br /></div>
<div class="line">&#64;Valid</div>
<div class="line">private Dept dept;</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="validation-validator-list">
<span id="id17"></span><h4><a class="toc-backref" href="#id45">5.5.4.1.2. Hibernate Validatorのチェックルール</a><a class="headerlink" href="#validation-validator-list" title="Permalink to this headline">¶</a></h4>
<p>Hibernate Validatorの代表的なアノテーションを、以下に示す。</p>
<p>詳細は、<a class="reference external" href="http://docs.jboss.org/hibernate/validator/4.3/reference/en-US/html_single/#table-custom-constraints">Hibernate Validator仕様</a>を参照されたい。</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">アノテーション(org.hibernate.validator.constraints.*)</th>
<th class="head">対象の型</th>
<th class="head">用途</th>
<th class="head">使用例</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">&#64;CreditCardNumber</span></tt></td>
<td>任意のCharSequence継承クラスに適用可能</td>
<td>Luhnアルゴリズムでクレジットカード番号が妥当かどうかを検証する。使用可能な番号かどうかをチェックするわけではない。</td>
<td><div class="first last line-block">
<div class="line">&#64;CreditCardNumber</div>
<div class="line">private String cardNumber;</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">&#64;Email</span></tt></td>
<td>任意のCharSequence継承クラスに適用可能</td>
<td>RFC2822に準拠したEmailアドレスかどうか検証する。</td>
<td><div class="first last line-block">
<div class="line">&#64;Email</div>
<div class="line">private String email;</div>
</div>
</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">&#64;URL</span></tt></td>
<td>任意のCharSequence継承クラスに適用可能</td>
<td>RFC2396に準拠しているかどうか検証する。</td>
<td><div class="first last line-block">
<div class="line">&#64;URL</div>
<div class="line">private String url;</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">&#64;NotBlank</span></tt></td>
<td>任意のCharSequence継承クラスに適用可能</td>
<td>Null、空文字(&#8220;&#8221;)、空白のみでないことを検証する。</td>
<td><div class="first last line-block">
<div class="line">&#64;NotBlank</div>
<div class="line">private String userId;</div>
</div>
</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">&#64;NotEmpty</span></tt></td>
<td>Collection、Map、arrays、任意のCharSequence継承クラスに適用可能</td>
<td><div class="first last line-block">
<div class="line">Null、または空でないことを検証する。</div>
<div class="line">&#64;NotNull + &#64;Min(1)の組み合わせでチェックする場合は、&#64;NotEmptyを使用すること。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">&#64;NotEmpty</div>
<div class="line">private String password;</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="validation-default-message-in-hibernate-validator">
<span id="id19"></span><h3><a class="toc-backref" href="#id46">5.5.4.2. Hibernate Validatorが用意するデフォルトメッセージ</a><a class="headerlink" href="#validation-default-message-in-hibernate-validator" title="Permalink to this headline">¶</a></h3>
<p>hibernate-validator-&lt;version&gt;.jar内のorg/hibernate/validatorに、ValidationMessages.propertiesのデフォルト値が定義されている。</p>
<div class="highlight-properties"><div class="highlight"><pre><span class="na">javax.validation.constraints.AssertFalse.message</span> <span class="o">=</span> <span class="s">must be false</span>
<span class="na">javax.validation.constraints.AssertTrue.message</span>  <span class="o">=</span> <span class="s">must be true</span>
<span class="na">javax.validation.constraints.DecimalMax.message</span>  <span class="o">=</span> <span class="s">must be less than or equal to {value}</span>
<span class="na">javax.validation.constraints.DecimalMin.message</span>  <span class="o">=</span> <span class="s">must be greater than or equal to {value}</span>
<span class="na">javax.validation.constraints.Digits.message</span>      <span class="o">=</span> <span class="s">numeric value out of bounds (&lt;{integer} digits&gt;.&lt;{fraction} digits&gt; expected)</span>
<span class="na">javax.validation.constraints.Future.message</span>      <span class="o">=</span> <span class="s">must be in the future</span>
<span class="na">javax.validation.constraints.Max.message</span>         <span class="o">=</span> <span class="s">must be less than or equal to {value}</span>
<span class="na">javax.validation.constraints.Min.message</span>         <span class="o">=</span> <span class="s">must be greater than or equal to {value}</span>
<span class="na">javax.validation.constraints.NotNull.message</span>     <span class="o">=</span> <span class="s">may not be null</span>
<span class="na">javax.validation.constraints.Null.message</span>        <span class="o">=</span> <span class="s">must be null</span>
<span class="na">javax.validation.constraints.Past.message</span>        <span class="o">=</span> <span class="s">must be in the past</span>
<span class="na">javax.validation.constraints.Pattern.message</span>     <span class="o">=</span> <span class="s">must match &quot;{regexp}&quot;</span>
<span class="na">javax.validation.constraints.Size.message</span>        <span class="o">=</span> <span class="s">size must be between {min} and {max}</span>

<span class="na">org.hibernate.validator.constraints.CreditCardNumber.message</span> <span class="o">=</span> <span class="s">invalid credit card number</span>
<span class="na">org.hibernate.validator.constraints.Email.message</span>            <span class="o">=</span> <span class="s">not a well-formed email address</span>
<span class="na">org.hibernate.validator.constraints.Length.message</span>           <span class="o">=</span> <span class="s">length must be between {min} and {max}</span>
<span class="na">org.hibernate.validator.constraints.NotBlank.message</span>         <span class="o">=</span> <span class="s">may not be empty</span>
<span class="na">org.hibernate.validator.constraints.NotEmpty.message</span>         <span class="o">=</span> <span class="s">may not be empty</span>
<span class="na">org.hibernate.validator.constraints.Range.message</span>            <span class="o">=</span> <span class="s">must be between {min} and {max}</span>
<span class="na">org.hibernate.validator.constraints.SafeHtml.message</span>         <span class="o">=</span> <span class="s">may have unsafe html content</span>
<span class="na">org.hibernate.validator.constraints.ScriptAssert.message</span>     <span class="o">=</span> <span class="s">script expression &quot;{script}&quot; didn&#39;t evaluate to true</span>
<span class="na">org.hibernate.validator.constraints.URL.message</span>              <span class="o">=</span> <span class="s">must be a valid URL</span>
<span class="na">org.hibernate.validator.constraints.br.CNPJ.message</span>          <span class="o">=</span> <span class="s">invalid Brazilian corporate taxpayer registry number (CNPJ)</span>
<span class="na">org.hibernate.validator.constraints.br.CPF.message</span>           <span class="o">=</span> <span class="s">invalid Brazilian individual taxpayer registry number (CPF)</span>
<span class="na">org.hibernate.validator.constraints.br.TituloEleitor.message</span> <span class="o">=</span> <span class="s">invalid Brazilian Voter ID card number</span>
</pre></div>
</div>
</div>
<div class="section" id="id20">
<h3><a class="toc-backref" href="#id47">5.5.4.3. 型のミスマッチ</a><a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h3>
<p>フォームオブジェクトの<tt class="docutils literal"><span class="pre">String</span></tt>以外のフィールドに対して、変換不可能な値を送信した場合は<tt class="docutils literal"><span class="pre">org.springframework.beans.TypeMismatchException</span></tt>がスローされる。</p>
<p>「新規ユーザー登録」処理の例では「Age」フィールドは<tt class="docutils literal"><span class="pre">Integer</span></tt>で定義されているが、このフィールドに対して整数に変換できない値を入力すると、以下のようなエラーメッセージが表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/validations-typemismatch1.png"><img alt="../_images/validations-typemismatch1.png" src="../_images/validations-typemismatch1.png" style="width: 60%;" /></a>
</div>
<p>例外の原因がそのまま表示されてしまい、エラーメッセージとしては不適切である。
型がミスマッチの場合のエラーメッセージは、<tt class="docutils literal"><span class="pre">org.springframework.context.MessageSource</span></tt>が読み込むpropertiesファイル(application-messages.properties)に定義できる。</p>
<p>以下のルールで、エラーメッセージを定義すればよい。</p>
<table border="1" class="docutils">
<colgroup>
<col width="35%" />
<col width="40%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">メッセージキー</th>
<th class="head">メッセージ内容</th>
<th class="head">用途</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">typeMismatch</span></tt></td>
<td>型ミスマッチエラーのデフォルトメッセージ</td>
<td>システム全体のデフォルト値</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">typeMismatch.対象のFQCN</span></tt></td>
<td>特定の型ミスマッチエラーのデフォルトメッセージ</td>
<td>システム全体のデフォルト値</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">typeMismatch.フォーム属性名.プロパティ名</span></tt></td>
<td>特定のフォームのフィールドに対する型ミスマッチエラーのメッセージ</td>
<td>画面毎に変更したいメッセージ</td>
</tr>
</tbody>
</table>
<p>application-messages.propertiesに以下の定義を行った場合、</p>
<div class="highlight-properties"><div class="highlight"><pre><span class="c"># typemismatch</span>
<span class="na">typeMismatch</span><span class="o">=</span><span class="s">&quot;{0}&quot; is invalid.</span>
<span class="na">typeMismatch.int</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be an integer.</span>
<span class="na">typeMismatch.double</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be a double.</span>
<span class="na">typeMismatch.float</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be a float.</span>
<span class="na">typeMismatch.long</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be a long.</span>
<span class="na">typeMismatch.short</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be a short.</span>
<span class="na">typeMismatch.java.lang.Integer</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be an integer.</span>
<span class="na">typeMismatch.java.lang.Double</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be a double.</span>
<span class="na">typeMismatch.java.lang.Float</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be a float.</span>
<span class="na">typeMismatch.java.lang.Long</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be a long.</span>
<span class="na">typeMismatch.java.lang.Short</span><span class="o">=</span><span class="s">&quot;{0}&quot; must be a short.</span>
<span class="na">typeMismatch.java.util.Date</span><span class="o">=</span><span class="s">&quot;{0}&quot; is not a date.</span>

<span class="c"># filed names</span>
<span class="na">name</span><span class="o">=</span><span class="s">Name</span>
<span class="na">email</span><span class="o">=</span><span class="s">Email</span>
<span class="na">age</span><span class="o">=</span><span class="s">Age</span>
</pre></div>
</div>
<p>エラーメッセージは、次のように変更される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/validations-typemismatch2.png"><img alt="../_images/validations-typemismatch2.png" src="../_images/validations-typemismatch2.png" style="width: 60%;" /></a>
</div>
<div class="line-block">
<div class="line"><a class="reference internal" href="#validation-message-in-application-messages"><em>application-messages.propertiesに定義するメッセージ</em></a>で説明したように、<tt class="docutils literal"><span class="pre">{0}</span></tt>でフィールド名を埋めることができる。</div>
<div class="line"><strong>基本的にデフォルトメッセージは定義しておくこと</strong>。</div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">メッセージキーのルールの詳細は、<a class="reference external" href="http://docs.spring.io/spring/docs/3.2.x/javadoc-api/org/springframework/validation/DefaultMessageCodesResolver.html">Javadoc</a>を参照されたい。</p>
</div>
</div>
<div class="section" id="null">
<span id="validation-string-trimmer-editor"></span><h3><a class="toc-backref" href="#id48">5.5.4.4. 文字列フィールドが未入力の場合にnullをバインドする</a><a class="headerlink" href="#null" title="Permalink to this headline">¶</a></h3>
<p>これまで説明してきたように、Spring MVCでは文字列の入力フィールドに未入力の状態でフォームを送信した場合、
デフォルトでは、フォームオブジェクトに<tt class="docutils literal"><span class="pre">null</span></tt>ではなく、空文字がバインドされる。</p>
<p>この場合、「未入力は許容するが、入力された場合は6文字以上であること」という要件を、既存のアノテーションで満たすことができない。</p>
<div class="line-block">
<div class="line">文字列フィールドが未入力の場合に、空文字ではなく、<tt class="docutils literal"><span class="pre">null</span></tt>をフォームオブジェクトにバインドするには、</div>
<div class="line">以下のように<tt class="docutils literal"><span class="pre">org.springframework.beans.propertyeditors.StringTrimmerEditor</span></tt>を使用すればよい。</div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;xxx&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">XxxController</span> <span class="o">{</span>

    <span class="nd">@InitBinder</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initBinder</span><span class="o">(</span><span class="n">WebDataBinder</span> <span class="n">binder</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// bind empty strings as null</span>
        <span class="n">binder</span><span class="o">.</span><span class="na">registerCustomEditor</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">StringTrimmerEditor</span><span class="o">(</span><span class="kc">true</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">// omitted ...</span>
<span class="o">}</span>
</pre></div>
</div>
<p>この設定により、Controller毎に空文字を<tt class="docutils literal"><span class="pre">null</span></tt>とみなすかどうかを設定できる。</p>
<p>プロジェクト全体で空文字を<tt class="docutils literal"><span class="pre">null</span></tt>にしたい場合は、プロジェクト共通設定として<a class="reference internal" href="../ImplementationAtEachLayer/ApplicationLayer.html#application-layer-controller-advice"><em>&#64;ControllerAdvice</em></a>で設定すればよい。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">XxxControllerAdvice</span> <span class="o">{</span>

    <span class="nd">@InitBinder</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initBinder</span><span class="o">(</span><span class="n">WebDataBinder</span> <span class="n">binder</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// bind empty strings as null</span>
        <span class="n">binder</span><span class="o">.</span><span class="na">registerCustomEditor</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">StringTrimmerEditor</span><span class="o">(</span><span class="kc">true</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">// omitted ...</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">この設定を行った場合は、フォームオブジェクトの文字列フィールドに設定される空文字がすべて<tt class="docutils literal"><span class="pre">null</span></tt>になる。</div>
<div class="line">したがって、必須チェックに、かならず<tt class="docutils literal"><span class="pre">&#64;NotNull</span></tt>が必要であることに注意しないといけない。</div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="Logging.html" title="5.6. ロギング"
             >next</a> |</li>
        <li class="right" >
          <a href="ExclusionControl.html" title="5.4. 排他制御"
             >previous</a> |</li>
        <li><a href="../index.html">TERASOLUNA Global Framework Development Guideline 1.0.0.publicreview documentation</a> &raquo;</li>
          <li><a href="index.html" >5. TERASOLUNA Global Frameworkの機能詳細</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, NTT DATA.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.Theme by <a href="http://github.com/vkvn">vkvn</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>
<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>5.3. データベースアクセス（Mybatis2編） &mdash; TERASOLUNA Global Framework Development Guideline 1.0.0.publicreview documentation</title>
    
    <link rel="stylesheet" href="../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0.0.publicreview',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="TERASOLUNA Global Framework Development Guideline 1.0.0.publicreview documentation" href="../index.html" />
    <link rel="up" title="5. TERASOLUNA Global Frameworkの機能詳細" href="index.html" />
    <link rel="next" title="5.4. 排他制御" href="ExclusionControl.html" />
    <link rel="prev" title="5.2. データベースアクセス（JPA編）" href="DataAccessJpa.html" /><script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ExclusionControl.html" title="5.4. 排他制御"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="DataAccessJpa.html" title="5.2. データベースアクセス（JPA編）"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">TERASOLUNA Global Framework Development Guideline 1.0.0.publicreview documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">5. TERASOLUNA Global Frameworkの機能詳細</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">5.3. データベースアクセス（Mybatis2編）</a><ul>
<li><a class="reference internal" href="#overview">5.3.1. Overview</a><ul>
<li><a class="reference internal" href="#mybatis">5.3.1.1. Mybatisについて</a></li>
<li><a class="reference internal" href="#terasoluna-dao">5.3.1.2. TERASOLUNA DAOについて</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">5.3.2. How to use</a><ul>
<li><a class="reference internal" href="#pom-xml">5.3.2.1. pom.xmlの設定</a></li>
<li><a class="reference internal" href="#id2">5.3.2.2. アプリケーションの設定</a><ul>
<li><a class="reference internal" href="#id3">5.3.2.2.1. データソースの設定</a></li>
<li><a class="reference internal" href="#platformtransactionmanager">5.3.2.2.2. PlatformTransactionManagerの設定</a></li>
<li><a class="reference internal" href="#id4">5.3.2.2.3. TERASOLUNA DAOの設定</a></li>
<li><a class="reference internal" href="#lob">5.3.2.2.4. LOB型を扱う場合の設定</a></li>
<li><a class="reference internal" href="#sqlmapconfig-label">5.3.2.2.5. Mybatisの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sql">5.3.2.3. SQLマッピングの実装(基本編)</a><ul>
<li><a class="reference internal" href="#select">5.3.2.3.1. select要素の実装例</a></li>
<li><a class="reference internal" href="#insert">5.3.2.3.2. insert要素の実装例</a></li>
<li><a class="reference internal" href="#update">5.3.2.3.3. update要素の実装例</a></li>
<li><a class="reference internal" href="#delete">5.3.2.3.4. delete要素の実装例</a></li>
<li><a class="reference internal" href="#procedure">5.3.2.3.5. procedure要素の実装例</a></li>
<li><a class="reference internal" href="#id6">5.3.2.3.6. sql要素の実装例</a></li>
<li><a class="reference internal" href="#data-access-mybatis2-howtouse-lob-update">5.3.2.3.7. LOB型更新の実装例</a></li>
<li><a class="reference internal" href="#id8">5.3.2.3.8. LOB型取得の実装例</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sql-sql">5.3.2.4. SQLマッピングの実装例(動的SQL編)</a><ul>
<li><a class="reference internal" href="#id9">5.3.2.4.1. パラメータオブジェクトの指定有無を判定</a></li>
<li><a class="reference internal" href="#javabean">5.3.2.4.2. パラメータオブジェクト(JavaBean)のプロパティの存在有無を判定</a></li>
<li><a class="reference internal" href="#id10">5.3.2.4.3. パラメータオブジェクト(JavaBean)のプロパティ値の設定有無を判定</a></li>
<li><a class="reference internal" href="#id11">5.3.2.4.4. パラメータオブジェクト(JavaBean)のプロパティ値を判定</a></li>
<li><a class="reference internal" href="#id12">5.3.2.4.5. 判定要素の共通属性</a></li>
<li><a class="reference internal" href="#id13">5.3.2.4.6. コレクションの繰り返し</a></li>
<li><a class="reference internal" href="#id14">5.3.2.4.7. 動的SQLのブロック化</a></li>
</ul>
</li>
<li><a class="reference internal" href="#querydao">5.3.2.5. QueryDAOの使用例</a><ul>
<li><a class="reference internal" href="#id15">5.3.2.5.1. 1件検索</a></li>
<li><a class="reference internal" href="#id16">5.3.2.5.2. 複数件検索</a></li>
<li><a class="reference internal" href="#id17">5.3.2.5.3. ページネーション検索（TERASOLUNA DAO標準機能方式）</a></li>
<li><a class="reference internal" href="#id18">5.3.2.5.4. ページネーション検索（SQL絞り込み方式）</a></li>
</ul>
</li>
<li><a class="reference internal" href="#updatedao">5.3.2.6. UpdateDAOの使用例</a><ul>
<li><a class="reference internal" href="#id19">5.3.2.6.1. 1件挿入</a></li>
<li><a class="reference internal" href="#id20">5.3.2.6.2. 複数件挿入(バッチ実行)</a></li>
<li><a class="reference internal" href="#id21">5.3.2.6.3. 1件更新</a></li>
<li><a class="reference internal" href="#id22">5.3.2.6.4. 複数件更新(バッチ実行)</a></li>
<li><a class="reference internal" href="#where">5.3.2.6.5. 複数件更新(WHERE句指定)</a></li>
<li><a class="reference internal" href="#id23">5.3.2.6.6. 1件削除</a></li>
<li><a class="reference internal" href="#id24">5.3.2.6.7. 複数件削除(バッチ実行)</a></li>
<li><a class="reference internal" href="#id25">5.3.2.6.8. 複数件削除(WHERE句指定)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#storedproceduredao">5.3.2.7. StoredProcedureDAOの使用例</a></li>
<li><a class="reference internal" href="#queryrowhandledao">5.3.2.8. QueryRowHandleDAOの使用例</a></li>
<li><a class="reference internal" href="#like">5.3.2.9. LIKE検索時のエスケープについて</a><ul>
<li><a class="reference internal" href="#query">5.3.2.9.1. 一致方法をQuery側で指定する場合の使用方法</a></li>
<li><a class="reference internal" href="#id26">5.3.2.9.2. 一致方法をロジック側で指定する場合の使用方法</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sql-injection">5.3.2.10. SQL Injection対策について</a><ul>
<li><a class="reference internal" href="#id27">5.3.2.10.1. バインド変数を使って埋め込む方法</a></li>
<li><a class="reference internal" href="#id28">5.3.2.10.2. 置換変数を使って埋め込む方法</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix">5.3.3. Appendix</a><ul>
<li><a class="reference internal" href="#id29">5.3.3.1. 関連オブジェクトを１回のSQLでまとめて取得する実装例</a></li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="DataAccessJpa.html"
                        title="previous chapter">5.2. データベースアクセス（JPA編）</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="ExclusionControl.html"
                        title="next chapter">5.4. 排他制御</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/ArchitectureInDetail/DataAccessMybatis2.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="mybatis2">
<div class="admonition caution">
  <p class="first admonition-title">Caution</p>
  <p><strong>本バージョンの内容は既に古くなっています</strong>。最新のガイドラインは<a href="http://terasolunaorg.github.io/guideline/">こちら</a>からご参照ください。</p>
</div>
<h1>5.3. データベースアクセス（Mybatis2編）<a class="headerlink" href="#mybatis2" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="id1">
<p class="topic-title first">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id30">Overview</a><ul>
<li><a class="reference internal" href="#mybatis" id="id31">Mybatisについて</a></li>
<li><a class="reference internal" href="#terasoluna-dao" id="id32">TERASOLUNA DAOについて</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use" id="id33">How to use</a><ul>
<li><a class="reference internal" href="#pom-xml" id="id34">pom.xmlの設定</a></li>
<li><a class="reference internal" href="#id2" id="id35">アプリケーションの設定</a><ul>
<li><a class="reference internal" href="#id3" id="id36">データソースの設定</a></li>
<li><a class="reference internal" href="#platformtransactionmanager" id="id37">PlatformTransactionManagerの設定</a></li>
<li><a class="reference internal" href="#id4" id="id38">TERASOLUNA DAOの設定</a></li>
<li><a class="reference internal" href="#lob" id="id39">LOB型を扱う場合の設定</a></li>
<li><a class="reference internal" href="#sqlmapconfig-label" id="id40">Mybatisの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sql" id="id41">SQLマッピングの実装(基本編)</a><ul>
<li><a class="reference internal" href="#select" id="id42">select要素の実装例</a></li>
<li><a class="reference internal" href="#insert" id="id43">insert要素の実装例</a></li>
<li><a class="reference internal" href="#update" id="id44">update要素の実装例</a></li>
<li><a class="reference internal" href="#delete" id="id45">delete要素の実装例</a></li>
<li><a class="reference internal" href="#procedure" id="id46">procedure要素の実装例</a></li>
<li><a class="reference internal" href="#id6" id="id47">sql要素の実装例</a></li>
<li><a class="reference internal" href="#data-access-mybatis2-howtouse-lob-update" id="id48">LOB型更新の実装例</a></li>
<li><a class="reference internal" href="#id8" id="id49">LOB型取得の実装例</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sql-sql" id="id50">SQLマッピングの実装例(動的SQL編)</a><ul>
<li><a class="reference internal" href="#id9" id="id51">パラメータオブジェクトの指定有無を判定</a></li>
<li><a class="reference internal" href="#javabean" id="id52">パラメータオブジェクト(JavaBean)のプロパティの存在有無を判定</a></li>
<li><a class="reference internal" href="#id10" id="id53">パラメータオブジェクト(JavaBean)のプロパティ値の設定有無を判定</a></li>
<li><a class="reference internal" href="#id11" id="id54">パラメータオブジェクト(JavaBean)のプロパティ値を判定</a></li>
<li><a class="reference internal" href="#id12" id="id55">判定要素の共通属性</a></li>
<li><a class="reference internal" href="#id13" id="id56">コレクションの繰り返し</a></li>
<li><a class="reference internal" href="#id14" id="id57">動的SQLのブロック化</a></li>
</ul>
</li>
<li><a class="reference internal" href="#querydao" id="id58">QueryDAOの使用例</a><ul>
<li><a class="reference internal" href="#id15" id="id59">1件検索</a></li>
<li><a class="reference internal" href="#id16" id="id60">複数件検索</a></li>
<li><a class="reference internal" href="#id17" id="id61">ページネーション検索（TERASOLUNA DAO標準機能方式）</a></li>
<li><a class="reference internal" href="#id18" id="id62">ページネーション検索（SQL絞り込み方式）</a></li>
</ul>
</li>
<li><a class="reference internal" href="#updatedao" id="id63">UpdateDAOの使用例</a><ul>
<li><a class="reference internal" href="#id19" id="id64">1件挿入</a></li>
<li><a class="reference internal" href="#id20" id="id65">複数件挿入(バッチ実行)</a></li>
<li><a class="reference internal" href="#id21" id="id66">1件更新</a></li>
<li><a class="reference internal" href="#id22" id="id67">複数件更新(バッチ実行)</a></li>
<li><a class="reference internal" href="#where" id="id68">複数件更新(WHERE句指定)</a></li>
<li><a class="reference internal" href="#id23" id="id69">1件削除</a></li>
<li><a class="reference internal" href="#id24" id="id70">複数件削除(バッチ実行)</a></li>
<li><a class="reference internal" href="#id25" id="id71">複数件削除(WHERE句指定)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#storedproceduredao" id="id72">StoredProcedureDAOの使用例</a></li>
<li><a class="reference internal" href="#queryrowhandledao" id="id73">QueryRowHandleDAOの使用例</a></li>
<li><a class="reference internal" href="#like" id="id74">LIKE検索時のエスケープについて</a><ul>
<li><a class="reference internal" href="#query" id="id75">一致方法をQuery側で指定する場合の使用方法</a></li>
<li><a class="reference internal" href="#id26" id="id76">一致方法をロジック側で指定する場合の使用方法</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sql-injection" id="id77">SQL Injection対策について</a><ul>
<li><a class="reference internal" href="#id27" id="id78">バインド変数を使って埋め込む方法</a></li>
<li><a class="reference internal" href="#id28" id="id79">置換変数を使って埋め込む方法</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix" id="id80">Appendix</a><ul>
<li><a class="reference internal" href="#id29" id="id81">関連オブジェクトを１回のSQLでまとめて取得する実装例</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id30">5.3.1. Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line">本節では、MyBatis2.xを使って、データベースにアクセスする方法について説明する。</div>
<div class="line">本ガイドラインでは、TERASOLUNA DAO(MybatisのラッパーDAO)を使用することを前提としている。</div>
</div>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/dataaccess_mybatis.png"><img alt="Target of description" src="../_images/dataaccess_mybatis.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - Target of description</strong></p>
</div>
</div></blockquote>
<div class="section" id="mybatis">
<h3><a class="toc-backref" href="#id31">5.3.1.1. Mybatisについて</a><a class="headerlink" href="#mybatis" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Mybatisは、O/R Mapperの一つだが、データベースで管理されているレコードと、オブジェクトをマッピングするという考え方ではなく、</div>
<div class="line">SQLとオブジェクトをマッピングするという考え方で開発されたO/R Mapperである。</div>
<div class="line">そのため、正規化されていないデータベースへアクセスする場合や、発行するSQLをO/R Mapperに任せずに、アプリケーション側で完全に制御したい場合に有効なO/R Mapperである。</div>
<div class="line">Mybatis2.xの詳細については、<a class="reference external" href="https://mybatis.googlecode.com/files/MyBatis-SqlMaps-2_en.pdf">Mybatis Developer Guide(PDF)</a>を参照されたい。</div>
</div>
</div>
<div class="section" id="terasoluna-dao">
<h3><a class="toc-backref" href="#id32">5.3.1.2. TERASOLUNA DAOについて</a><a class="headerlink" href="#terasoluna-dao" title="Permalink to this headline">¶</a></h3>
<p>TERASOLUNA DAOは、O/R Mapperに依存する処理を隠蔽するためのDAOインタフェースと、Mybatis2.xを使用したDAO実装クラスを提供している。</p>
<p>TERASOLUNA DAOから提供されているDAOインタフェースは、以下の通りである。</p>
<blockquote>
<div><table border="1" class="docutils">
<caption><strong>TERASOLUNA DAOから提供されているDAOインタフェース</strong></caption>
<colgroup>
<col width="10%" />
<col width="35%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">クラス名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">jp.terasoluna.fw.dao.</div>
<div class="line">QueryDAO</div>
</div>
</td>
<td>参照系SQLを実行するためのDAOインタフェース</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">jp.terasoluna.fw.dao.</div>
<div class="line">UpdateDAO</div>
</div>
</td>
<td>更新系SQLを実行するためのDAOインタフェース</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">jp.terasoluna.fw.dao.</div>
<div class="line">StoredProcedureDAO</div>
</div>
</td>
<td>StoredProcedureを実行するためのDAOインタフェース</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">jp.terasoluna.fw.dao.</div>
<div class="line">QueryRowHandleDAO</div>
</div>
</td>
<td>参照系SQLを実行して取得されるレコードに対して、一レコードずつ処理を行うためのDAOインタフェース。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>TERASOLUNA DAO(Mybatis実装)を使って、データベースにアクセスする際の基本フローを、以下に示す。</p>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/dataaccess_mybatis_basic_flow.png"><img alt="Basic flow of TERASOLUNA DAO" src="../_images/dataaccess_mybatis_basic_flow.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - Basic flow of TERASOLUNA DAO</strong></p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ServiceまたはRepositoryから、TERASOLUNA DAOから提供されているDAOインタフェースのメソッドを呼び出す。</div>
<div class="line">メソッドの呼び出しパラメータとして、SQLIDとSQLに埋め込む値を保持しているオブジェクトを渡す。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">TERASOLUNA DAOは、MybatisのAPIに、処理を委譲する。</div>
<div class="line">ServiceまたはRepositoryから指定されたSQLIDと、SQLに埋め込む値を保持しているオブジェクトもMybatisに渡される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Mybatisは、指定されたSQLIDに対応するSQLを、設定ファイル(<tt class="docutils literal"><span class="pre">sqlMap.xml</span></tt>)から取得し、SQLとバインド値を、JDBCドライバに渡す。</div>
<div class="line">(実際の値のバインドは、<tt class="docutils literal"><span class="pre">java.sql.PreparedStatement</span></tt>のAPIが使われている)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>JDBCドライバは、渡されたSQLとバインド値を、データベースに送信することで、SQLを実行する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="how-to-use">
<h2><a class="toc-backref" href="#id33">5.3.2. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<div class="section" id="pom-xml">
<h3><a class="toc-backref" href="#id34">5.3.2.1. pom.xmlの設定</a><a class="headerlink" href="#pom-xml" title="Permalink to this headline">¶</a></h3>
<p>インフラストラクチャ層にMyBatis2(TERASOLUNA DAO)を使用する場合、以下のdependencyをpom.xmlに追加する。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.terasoluna.gfw<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>terasoluna-gfw-mybatis2<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">MyBatis2に関連するライブラリ群が定義してある <tt class="docutils literal"><span class="pre">terasoluna-gfw-mybatis2</span></tt> をdependencyに追加する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id2">
<h3><a class="toc-backref" href="#id35">5.3.2.2. アプリケーションの設定</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id3">
<h4><a class="toc-backref" href="#id36">5.3.2.2.1. データソースの設定</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>データソースに設定は、共通編の<a class="reference internal" href="DataAccessCommon.html#data-access-common-howtouse-datasource"><em>データソースの設定</em></a>を参照されたい。</p>
</div>
<div class="section" id="platformtransactionmanager">
<h4><a class="toc-backref" href="#id37">5.3.2.2.2. PlatformTransactionManagerの設定</a><a class="headerlink" href="#platformtransactionmanager" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">ローカルトランザクションを使用する場合は、以下の通りに設定する。</div>
</div>
<blockquote>
<div>ローカルトランザクションを使用する場合、JDBCのAPIを呼び出してトランザクション制御を行う<tt class="docutils literal"><span class="pre">org.springframework.jdbc.datasource.DataSourceTransactionManager</span></tt>を使用する。</div></blockquote>
<ul class="simple">
<li>xxx-env.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;transactionManager&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><tt class="docutils literal"><span class="pre">org.springframework.jdbc.datasource.DataSourceTransactionManager</span></tt>を指定する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>設定済みのデータソースのbeanを指定する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>アプリケーションサーバから提供されているトランザクションマネージャを使用する場合は、以下の通りに設定する。</p>
<blockquote>
<div>アプリケーションサーバから提供されているトランザクションマネージャを使用する場合、JTAのAPIを呼び出してトランザクション制御を行う<tt class="docutils literal"><span class="pre">org.springframework.transaction.jta.JtaTransactionManager</span></tt>を使用する。</div></blockquote>
<ul class="simple">
<li>xxx-env.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;tx:jta-transaction-manager</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アプリケーションがデプロイされているアプリケーションサーバに、最適な<tt class="docutils literal"><span class="pre">JtaTransactionManager</span></tt>が、<tt class="docutils literal"><span class="pre">&quot;transactionManager&quot;</span></tt>というidで、bean定義される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id4">
<h4><a class="toc-backref" href="#id38">5.3.2.2.3. TERASOLUNA DAOの設定</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p>Spring Frameworkから提供されている<tt class="docutils literal"><span class="pre">SqlMapClient</span></tt>のファクトリクラスと、TERASOLUNA DAOのbean定義を行う。</p>
<ul class="simple">
<li>xxx-infra.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sqlMapClient&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.orm.ibatis.SqlMapClientFactoryBean&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;configLocations&quot;</span>
        <span class="na">value=</span><span class="s">&quot;classpath*:/META-INF/mybatis/config/*sqlMapConfig.xml&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;mappingLocations&quot;</span>
        <span class="na">value=</span><span class="s">&quot;classpath*:/META-INF/mybatis/sql/**/*-sqlmap.xml&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;queryDAO&quot;</span>
    <span class="na">class=</span><span class="s">&quot;jp.terasoluna.fw.dao.ibatis.QueryDAOiBatisImpl&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (5) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;sqlMapClient&quot;</span> <span class="na">ref=</span><span class="s">&quot;sqlMapClient&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (6) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- (5) (6) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;updateDAO&quot;</span>
    <span class="na">class=</span><span class="s">&quot;jp.terasoluna.fw.dao.ibatis.UpdateDAOiBatisImpl&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;sqlMapClient&quot;</span> <span class="na">ref=</span><span class="s">&quot;sqlMapClient&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- (5) (6) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;spDAO&quot;</span>
    <span class="na">class=</span><span class="s">&quot;jp.terasoluna.fw.dao.ibatis.StoredProcedureDAOiBatisImpl&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;sqlMapClient&quot;</span> <span class="na">ref=</span><span class="s">&quot;sqlMapClient&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- (5) (6) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;queryRowHandleDAO&quot;</span>
    <span class="na">class=</span><span class="s">&quot;jp.terasoluna.fw.dao.ibatis.QueryRowHandleDAOiBatisImpl&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;sqlMapClient&quot;</span> <span class="na">ref=</span><span class="s">&quot;sqlMapClient&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><tt class="docutils literal"><span class="pre">SqlMapClient</span></tt>クラスのファクトリクラスとして、<tt class="docutils literal"><span class="pre">org.springframework.orm.ibatis.SqlMapClientFactoryBean</span></tt>を指定する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Mybatisの設定ファイルのロケーションを指定する。</div>
<div class="line">例では、クラスパス上の「<tt class="docutils literal"><span class="pre">/META-INF/mybatis/config/</span></tt>」ディレクトリに格納されている「<tt class="docutils literal"><span class="pre">sqlMapConfig.xml</span></tt>」で終わるファイルが、対象ファイルとなる。</div>
<div class="line">設定ファイルについては、<a class="reference internal" href="#sqlmapconfig-label"><em>Mybatisの設定</em></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">MybatisのSQLマッピングファイルのロケーションを指定する。</div>
<div class="line">例では、クラスパス上の「<tt class="docutils literal"><span class="pre">/META-INF/mybatis/sql/</span></tt>」ディレクトリ配下（サブディレクトリも含む）に格納されている「<tt class="docutils literal"><span class="pre">-sqlmap.xml</span></tt>」で終わるファイルが、対象ファイルとなる。</div>
<div class="line">SQLマッピングファイルについては、<a class="reference internal" href="#sqlmap-label"><em>SQLマッピングの実装(基本編)</em></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>設定済みのデータソースのbeanを指定する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>TERASOLUNA DAOのMybatis実装クラスを指定して、bean定義する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td>(1)で定義した<tt class="docutils literal"><span class="pre">SqlMapClient</span></tt>クラスのファクトリクラスのbeanを指定する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="lob">
<h4><a class="toc-backref" href="#id39">5.3.2.2.4. LOB型を扱う場合の設定</a><a class="headerlink" href="#lob" title="Permalink to this headline">¶</a></h4>
<p>BLOBやCLOBなどのLarge Objectを扱う場合は、<tt class="docutils literal"><span class="pre">SqlMapClient</span></tt>クラスのファクトリクラスに、<tt class="docutils literal"><span class="pre">LobHandler</span></tt>を指定する。</p>
<ul class="simple">
<li>xxx-infra.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre> <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;nativeJdbcExtractor&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.jdbc.support.nativejdbc.SimpleNativeJdbcExtractor&quot;</span> <span class="nt">/&gt;</span>

<span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;lobHandler&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.jdbc.support.lob.OracleLobHandler&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;nativeJdbcExtractor&quot;</span> <span class="na">ref=</span><span class="s">&quot;nativeJdbcExtractor&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sqlMapClient&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.orm.ibatis.SqlMapClientFactoryBean&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;configLocations&quot;</span>
        <span class="na">value=</span><span class="s">&quot;classpath*:/META-INF/mybatis/config/*sqlMapConfig.xml&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;mappingLocations&quot;</span>
        <span class="na">value=</span><span class="s">&quot;classpath*:/META-INF/mybatis/sql/**/*-sqlmap.xml&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
   <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;lobHandler&quot;</span> <span class="na">ref=</span><span class="s">&quot;lobHandler&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">org.springframework.jdbc.support.nativejdbc.NativeJdbcExtractor</span></tt>インタフェースの実装クラスを、bean定義する。</div>
<div class="line">例では、<tt class="docutils literal"><span class="pre">org.springframework.jdbc.support.nativejdbc.SimpleNativeJdbcExtractor</span></tt>を指定しているが、</div>
<div class="line">Tomcat以外のAPサーバでは、nativeデータソースを取得できない場合があるので、</div>
<div class="line">Springが提供している他のNativeJdbcExtractorを指定するか、各APサーバ用に、新たに<tt class="docutils literal"><span class="pre">NativeJdbcExtractor</span></tt>を作成する必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">org.springframework.jdbc.support.lob.LobHandler</span></tt>インタフェースの実装クラスをbean定義する。</div>
<div class="line">例では、Oracle使用時に指定する<tt class="docutils literal"><span class="pre">org.springframework.jdbc.support.lob.OracleLobHandler</span></tt>を指定しているが、</div>
<div class="line">Oracle以外の場合は、<tt class="docutils literal"><span class="pre">org.springframework.jdbc.support.lob.DefaultLobHandler</span></tt>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(1)で定義した<tt class="docutils literal"><span class="pre">NativeJdbcExtractor</span></tt>のbeanを指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(3)で定義した<tt class="docutils literal"><span class="pre">LobHandler</span></tt>のbeanを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="sqlmapconfig-label">
<span id="id5"></span><h4><a class="toc-backref" href="#id40">5.3.2.2.5. Mybatisの設定</a><a class="headerlink" href="#sqlmapconfig-label" title="Permalink to this headline">¶</a></h4>
<p><tt class="docutils literal"><span class="pre">SqlMapClient</span></tt>のデフォルトの動作をカスタマイズする。必要に応じてカスタマイズすること。</p>
<ul class="simple">
<li>sqlMapConfig.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE sqlMapConfig</span>
<span class="cp">            PUBLIC &quot;-//ibatis.apache.org//DTD SQL Map Config 2.0//EN&quot;</span>
<span class="cp">            &quot;http://ibatis.apache.org/dtd/sql-map-config-2.dtd&quot;&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

<span class="nt">&lt;sqlMapConfig&gt;</span>
    <span class="nt">&lt;settings</span> <span class="na">useStatementNamespaces=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/sqlMapConfig&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="6%" />
<col width="94%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>DTDファイルを指定する。指定することで、スキーマのチェックと、IDE上でのコード補完が有効となる。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><tt class="docutils literal"><span class="pre">useStatementNamespaces=&quot;true&quot;</span></tt>を設定することで、SQLマッピングファイルで指定するネームスペースを、SQLIDとして使用するように設定している。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>sqlMapConfigの子要素について</li>
</ul>
<blockquote>
<div><div class="line-block">
<div class="line">子要素として、<tt class="docutils literal"><span class="pre">properties</span></tt>, <tt class="docutils literal"><span class="pre">settings</span></tt>,<tt class="docutils literal"><span class="pre">resultObjectFactory</span></tt>, <tt class="docutils literal"><span class="pre">typeAlias</span></tt>, <tt class="docutils literal"><span class="pre">transactionManager</span></tt>, <tt class="docutils literal"><span class="pre">sqlMap</span></tt>が存在する。</div>
<div class="line">必要に応じて、設定を行うこと。</div>
<div class="line">詳細は、Mybatis Developer Guide(PDF)の「The SQL Map XML Configuration File」(P.8-16)を参照されたい。</div>
</div>
<table border="1" class="docutils">
<caption><strong>sqlMapConfigの子要素</strong></caption>
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">要素</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>properties</td>
<td><div class="first last line-block">
<div class="line">プロパティファイルを読み込むための要素。読み込んだプロパティファイルに定義されているプロパティは、</div>
<div class="line">Mybatisの設定ファイルおよびSQLマッピングファイル内から、<tt class="docutils literal"><span class="pre">&quot;${プロパティ名}&quot;</span></tt>の形式で参照することができる。</div>
<div class="line">環境に依存する値や、共通的な設定値を定義する際に使用する。</div>
<div class="line">詳細は、Mybatis Developer Guide(PDF)の「The SQL Map XML Configuration File」(P.9)を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>settings</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">SqlMapClient</span></tt>のデフォルト動作のカスタマイズを行うための要素。</div>
<div class="line">設定項目の詳細については、Mybatis Developer Guide(PDF)の「The SQL Map XML Configuration File」(P.9-11)を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>resultObjectFactory</td>
<td><div class="first last line-block">
<div class="line">SQLマッピングファイルのselect要素、statement要素、procedure要素のresultClass属性、または、resultMap要素のclass属性に指定されたクラスのインスタンスを生成するファクトリクラスを指定する要素。</div>
<div class="line">指定しない場合は、デフォルト実装である<tt class="docutils literal"><span class="pre">java.lang.Class#newInstance()</span></tt>メソッドで生成されたインスタンスが使用される。</div>
<div class="line">詳細については、Mybatis Developer Guide(PDF)の「The SQL Map XML Configuration File」(P.11-12)を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>typeAlias</td>
<td><div class="first last line-block">
<div class="line">クラス名(FQCN)に別名（短縮名）を付けるための要素。</div>
<div class="line">ここで定義した別名は、Mybatisの設定ファイルおよびSQLマッピングファイルのクラスを指定する箇所で使うことができる。通常、パッケージを除いたシンプルなクラス名を指定することが多い。</div>
<div class="line">詳細については、Mybatis Developer Guide(PDF)の「The SQL Map XML Configuration File」(P.12)を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>transactionManager</td>
<td>トランザクション管理は、Spring Frameworkの機能を使うため、定義は不要である。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>sqlMap</td>
<td>TERASOLUNA DAOの設定で設定済みのため、定義は不要である。</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div>
<div class="section" id="sql">
<span id="sqlmap-label"></span><h3><a class="toc-backref" href="#id41">5.3.2.3. SQLマッピングの実装(基本編)</a><a class="headerlink" href="#sql" title="Permalink to this headline">¶</a></h3>
<p>以下に、基本的なSQLマッピングの実装例を示す。</p>
<p>アプリケーション内で使用するSQLを実装する。</p>
<ul class="simple">
<li>xxx-sqlmap.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE sqlMap</span>
<span class="cp">            PUBLIC &quot;-//ibatis.apache.org//DTD SQL Map 2.0//EN&quot;</span>
<span class="cp">            &quot;http://ibatis.apache.org/dtd/sql-map-2.dtd&quot;&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

<span class="nt">&lt;sqlMap</span> <span class="na">namespace=</span><span class="s">&quot;xxx&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>

    <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- ... --&gt;</span>
    <span class="nt">&lt;/select&gt;</span>

    <span class="c">&lt;!-- ... --&gt;</span>

<span class="nt">&lt;/sqlMap&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>DTDファイルを指定する。指定することで、スキーマのチェックと、STS上でのコード補完が有効となる。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>ネームスペースを指定する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><tt class="docutils literal"><span class="pre">sqlMapConfig.xml</span></tt>にて、ネームスペースをSQLIDとして使用するように設定しているので、このSQLを実行するために指定するSQLIDは「<tt class="docutils literal"><span class="pre">xxx.findOne</span></tt>」となる。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>sqlMapの子要素について</li>
</ul>
<blockquote>
<div><p>子要素として、<tt class="docutils literal"><span class="pre">cacheModel</span></tt>, <tt class="docutils literal"><span class="pre">typeAlias</span></tt>, <tt class="docutils literal"><span class="pre">parameterMap</span></tt>, <tt class="docutils literal"><span class="pre">resultMap</span></tt>, <tt class="docutils literal"><span class="pre">select</span></tt>, <tt class="docutils literal"><span class="pre">insert</span></tt>, <tt class="docutils literal"><span class="pre">update</span></tt>, <tt class="docutils literal"><span class="pre">delete</span></tt>, <tt class="docutils literal"><span class="pre">statement</span></tt>, <tt class="docutils literal"><span class="pre">sql</span></tt>, <tt class="docutils literal"><span class="pre">procedure</span></tt>が存在する。</p>
<table border="1" class="docutils">
<caption><strong>sqlMapの子要素</strong></caption>
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">要素</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>typeAlias</td>
<td><tt class="docutils literal"><span class="pre">sqlMapConfig.xml</span></tt>の<tt class="docutils literal"><span class="pre">typeAlias</span></tt>と同じ。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>cacheModel</td>
<td>オブジェクトのキャッシュの定義を行う要素</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>parameterMap</td>
<td>SQLにバインドするパラメータ（オブジェクト）のマッピングに関する定義を行う要素</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>resultMap</td>
<td>SQLの実行結果として返却されるレコードとオブジェクトのマッピングに関する定義を行う要素</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>select</td>
<td>SELECT文を記載する要素</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>insert</td>
<td>INSERT文を記載する要素</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td>update</td>
<td>UPDATE文を記載する要素</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="8">
<li></li>
</ol>
</td>
<td>delete</td>
<td>DELETE文を記載する要素</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="9">
<li></li>
</ol>
</td>
<td>statement</td>
<td><tt class="docutils literal"><span class="pre">select</span></tt>, <tt class="docutils literal"><span class="pre">insert</span></tt>, <tt class="docutils literal"><span class="pre">update</span></tt>, <tt class="docutils literal"><span class="pre">delete</span></tt>, <tt class="docutils literal"><span class="pre">procedure</span></tt> 要素を包含している汎用要素。個別の要素(<tt class="docutils literal"><span class="pre">select</span></tt>, <tt class="docutils literal"><span class="pre">insert</span></tt>, <tt class="docutils literal"><span class="pre">update</span></tt>, <tt class="docutils literal"><span class="pre">delete</span></tt>, <tt class="docutils literal"><span class="pre">procedure</span></tt>)を使用することを推奨する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="10">
<li></li>
</ol>
</td>
<td>sql</td>
<td><tt class="docutils literal"><span class="pre">select</span></tt>, <tt class="docutils literal"><span class="pre">insert</span></tt>, <tt class="docutils literal"><span class="pre">update</span></tt>, <tt class="docutils literal"><span class="pre">delete</span></tt>, <tt class="docutils literal"><span class="pre">statement</span></tt>からインクルードするためのSQL文（SQL文の一部）を記載する要素。この要素をうまく使うことで、複数のSQLで重複している部分を、共通化することができる。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="11">
<li></li>
</ol>
</td>
<td>procedure</td>
<td>PROCEDURE呼び出しを記載する要素</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>詳細は、Mybatis Developer Guide(PDF)の、以下の章を参照されたい。</p>
<ul class="last">
<li><div class="first line-block">
<div class="line">The SQL Map XML File(P.17-18)</div>
<div class="line">SQLマッピングファイルの簡単な定義例が記載されている。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Mapped Statements(P.18-26)</div>
<div class="line">SQLを組み立てるための要素の、基本的な使い方が記載されている。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Parameter Maps and Inline Parameters(P.27-31)</div>
<div class="line">SQLにバインドするパラメータ（オブジェクト）のマッピングに関する、詳細な説明が記載されている。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Substitution Strings(P.32)</div>
<div class="line">SQLのバインド変数について、記載されている。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Result Maps(P.32-41)</div>
<div class="line">SQLの実行結果として返却されるレコードと、オブジェクトのマッピングに関する、詳細な説明が記載されている。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Supported Types for Parameter Maps and Result Maps(P.42-43)</div>
<div class="line">ParameterMapと、ResultMapでサポートされている型と、拡張方法が記載されている。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Caching Mapped Statement Results(P.44-47)</div>
<div class="line">キャッシュに関する詳細な説明が、記載されている。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Dynamic Mapped Statements(P.48-53)</div>
<div class="line">動的SQLに関する詳細な説明が、記載されている。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Simple Dynamic SQL Elements(P.53)</div>
<div class="line">動的SQLの簡易的な実装方法の説明が、記載されている。</div>
</div>
</li>
</ul>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><tt class="docutils literal"><span class="pre">statement</span></tt>, <tt class="docutils literal"><span class="pre">select</span></tt>, <tt class="docutils literal"><span class="pre">procedure</span></tt>要素を使用して、大量データを返すようなクエリを記述する場合には、fetchSize属性に適切な値を設定しておくこと。
fetchSize属性は、JDBCドライバとデータベース間の通信において、一度の通信で取得するデータの件数を設定するパラメータである。
fetchSize属性を省略した場合は、各JDBCドライバのデフォルト値が利用されるため、デフォルト値が全件取得するJDBCドライバの場合、メモリの枯渇の原因になる可能性があるので、注意が必要となる。</p>
</div>
</div></blockquote>
<div class="section" id="select">
<h4><a class="toc-backref" href="#id42">5.3.2.3.1. select要素の実装例</a><a class="headerlink" href="#select" title="Permalink to this headline">¶</a></h4>
<p>select要素を実装する前に、検索したレコードのカラムと、JavaBeanのプロパティのマッピング定義を行う。</p>
<ul class="simple">
<li>xxx-sqlmap.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;resultMap_Todo&quot;</span>
           <span class="na">class=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model.Todo&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;todoId&quot;</span> <span class="na">column=</span><span class="s">&quot;todo_id&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;todoTitle&quot;</span> <span class="na">column=</span><span class="s">&quot;todo_title&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;finished&quot;</span> <span class="na">column=</span><span class="s">&quot;finished&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;createdAt&quot;</span> <span class="na">column=</span><span class="s">&quot;created_at&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;version&quot;</span> <span class="na">column=</span><span class="s">&quot;version&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="10%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
<td>検索したレコードとJavaBeanのマッピングを行う。詳細は、Developer Guideを参照されたい。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">id</div>
</div>
</td>
<td>マッピングを識別するためのIDを指定する。select属性から参照される。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">class</div>
</div>
</td>
<td>マッピングするJavaBeanのFQCNを指定する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
<td>JavaBeanのプロパティと、検索したレコードのカラムのマッピングを行う。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">property</div>
</div>
</td>
<td>JavaBeanのプロパティ名を指定する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">column</div>
</div>
</td>
<td>property属性で指定したプロパティに、マッピングするレコードのカラム名を指定する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>select要素を実装する。</p>
<ul class="simple">
<li>xxx-sqlmap.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span>
        <span class="na">parameterClass=</span><span class="s">&quot;java.lang.String&quot;</span>
        <span class="na">resultMap=</span><span class="s">&quot;resultMap_Todo&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
    SELECT
        *
    FROM
        todo
    WHERE
        todo_id = #todoId#   /* (4) */
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="10%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
<td>検索用SQLを実装する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">id</div>
</div>
</td>
<td>検索SQLを識別するためのIDを指定する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">parameterClass</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">バインド用オブジェクトの型を指定する。</div>
<div class="line">例では、<tt class="docutils literal"><span class="pre">java.lang.String</span></tt>を指定しているが、複数のパラメータ(検索条件)を渡したい場合は、JavaBeanを指定することもできる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">resultMap</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(1)で定義したresultMapを指定する。</div>
<div class="line">resultMapを使わずに、自動的にclass属性で指定したJavaBeanのプロパティにマッピングすることもできるが、取得レコードのカラム名と、JavaBeanのプロパティ名が一致している必要がある。</div>
<div class="line">取得レコードのカラム名とJavaBeanのプロパティ名を一致させる方法として、AS句を使って、カラム名に別名を付与する方法がある。</div>
<div class="line">例えば、SQLを<tt class="docutils literal"><span class="pre">&quot;SELECT</span> <span class="pre">todo_title</span> <span class="pre">AS</span> <span class="pre">todoTitle,</span> <span class="pre">...&quot;</span></tt>とすると、JavaBeanのtodoTitleプロパティに、値が設定される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SQLにバインド値を指定する。</div>
<div class="line">例では、JavaBeanではなく単一オブジェクト（<tt class="docutils literal"><span class="pre">java.lang.String</span></tt>）を使用しているので、バインド変数名は任意の名前を指定することができる。</div>
<div class="line">バインド用オブジェクトにJavaBeanを使用する場合は、バインド用の変数名は、JavaBeanのプロパティ名と一致させる必要がある。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>自動マッピングについて</strong></p>
<p>resultMap属性を使わずに、resultClass属性で指定したJavaBeanのプロパティに、自動的にマッピングすることもできるが、取得レコードのカラム名と、JavaBeanのプロパティ名が一致している必要がある。
取得レコードのカラム名と、JavaBeanのプロパティ名を一致させる方法として、AS句を使って、カラム名に別名を付与する方法がある。下記に、自動マッピングを使用した場合の実装例を示す。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span>
        <span class="na">parameterClass=</span><span class="s">&quot;java.lang.String&quot;</span>
<span class="hll">        <span class="na">resultClass=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model.Todo&quot;</span><span class="nt">&gt;</span>
</span>    SELECT
<span class="hll">        todo_id AS todoId,
</span><span class="hll">        todo_title AS todoTitle,
</span>        finished,
<span class="hll">        created_at AS createdAt,
</span>        version
    FROM
        todo
    WHERE
        todo_id = #todoId#
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
</div></blockquote>
<p>自動マッピングは、取得したレコードとJavaBeanをマッピングする手段としては、もっとも簡単な方法である。ただし、自動マッピングを使用した場合は、以下の制約や注意点があることを考慮し、使用すること。</p>
<ul class="last simple">
<li>SQLで取得した値の型宣言や、変換定義などが行えない。</li>
<li>複雑なマッピング（例えば、ネストされているJavaBeanへのマッピング）が行えない。</li>
<li>マッピングする際に、<tt class="docutils literal"><span class="pre">java.sql.ResultSetMetaData</span></tt>にアクセスするため、若干のパフォーマンス劣化が発生する。</li>
</ul>
</div>
</div></blockquote>
</div>
<div class="section" id="insert">
<h4><a class="toc-backref" href="#id43">5.3.2.3.2. insert要素の実装例</a><a class="headerlink" href="#insert" title="Permalink to this headline">¶</a></h4>
<p>insert要素を実装する。</p>
<ul class="simple">
<li>xxx-sqlmap.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;insert&quot;</span>
        <span class="na">parameterClass=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model.Todo&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    INSERT INTO todo
        (
            todo_id
            ,todo_title
            ,finished
            ,created_at
            ,version
        )
        values(
            #todoId#       /* (2) */
            ,#todoTitle#
            ,#finished#
            ,#createdAt#
            ,1
        )
<span class="nt">&lt;/insert&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="10%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
<td>挿入用SQLを実装する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">id</div>
</div>
</td>
<td>挿入用SQLを識別するためのIDを指定する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">parameterClass</div>
</div>
</td>
<td>バインド用オブジェクトの型を指定する。JavaBeanを指定することもできる。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
<td>SQLにバインド値を指定する。バインド用オブジェクトにJavaBeanを使用する場合は、バインド用の変数名は、JavaBeanのプロパティ名と一致させる必要がある。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">parameterMap属性や、&#8221;Inline Parameter Maps&#8221;の仕組みを使用することで、SQLにバインドする値の型の宣言や、変換定義を行うことができる。
例えば、バインド値が<tt class="docutils literal"><span class="pre">null</span></tt>の場合に、デフォルト値を設定することができる。詳細は、Mybatis Developer Guide(PDF)の「Parameter Maps and Inline Parameters」(P.27-31)を参照されたい。</p>
</div>
</div></blockquote>
</div>
<div class="section" id="update">
<h4><a class="toc-backref" href="#id44">5.3.2.3.3. update要素の実装例</a><a class="headerlink" href="#update" title="Permalink to this headline">¶</a></h4>
<p>update要素を実装する。</p>
<ul class="simple">
<li>xxx-sqlmap.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;update</span> <span class="na">id=</span><span class="s">&quot;update&quot;</span>
        <span class="na">parameterClass=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model.Todo&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    UPDATE todo SET
        todo_id = #todoId#
        ,todo_title = #todoTitle#
        ,finished = #finished#
        ,version = (#version# + 1)
    WHERE
        todo_id = #todoId#
    AND version = #version#
<span class="nt">&lt;/update&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>更新用SQLを実装する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="delete">
<h4><a class="toc-backref" href="#id45">5.3.2.3.4. delete要素の実装例</a><a class="headerlink" href="#delete" title="Permalink to this headline">¶</a></h4>
<p>delete要素を実装する。</p>
<ul class="simple">
<li>xxx-sqlmap.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;delete</span> <span class="na">id=</span><span class="s">&quot;delete&quot;</span> <span class="na">parameterClass=</span><span class="s">&quot;java.lang.String&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    DELETE FROM
        todo
    WHERE
        todo_id = #todoId#
<span class="nt">&lt;/delete&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>削除用SQLを実装する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="procedure">
<h4><a class="toc-backref" href="#id46">5.3.2.3.5. procedure要素の実装例</a><a class="headerlink" href="#procedure" title="Permalink to this headline">¶</a></h4>
<p>以下は、PostgreSQLに作成したファンクションを、procedure要素を使って呼び出す例となっている。</p>
<p>テーブルと、ファンクション(PL/pgSQL実装)を作成するSQLは、以下の通りである。</p>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">sales</span> <span class="p">(</span>
    <span class="n">itemno</span> <span class="n">INT4</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">quantity</span> <span class="n">INT4</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">price</span> <span class="n">INT4</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">);</span>
</pre></div>
</div>
<div class="highlight-guess"><div class="highlight"><pre><span class="n">CREATE</span>
    <span class="n">FUNCTION</span> <span class="n">sales_item</span><span class="p">(</span><span class="n">p_itemno</span> <span class="n">INT4</span><span class="p">)</span> <span class="n">RETURNS</span> <span class="n">TABLE</span> <span class="p">(</span>
        <span class="n">quantity</span> <span class="n">INT4</span>
        <span class="p">,</span><span class="n">total</span> <span class="n">INT4</span>
    <span class="p">)</span> <span class="n">AS</span> <span class="err">$$</span> <span class="n">BEGIN</span> <span class="n">RETURN</span> <span class="n">QUERY</span>
        <span class="n">SELECT</span>
                <span class="n">s</span><span class="p">.</span><span class="n">quantity</span>
                <span class="p">,</span><span class="n">s</span><span class="p">.</span><span class="n">quantity</span> <span class="o">*</span> <span class="n">s</span><span class="p">.</span><span class="n">price</span>
            <span class="n">FROM</span>
                <span class="n">sales</span> <span class="n">s</span>
            <span class="n">WHERE</span>
                <span class="n">itemno</span> <span class="o">=</span> <span class="n">p_itemno</span><span class="p">;</span>
<span class="n">END</span><span class="p">;</span>
<span class="err">$$</span> <span class="n">LANGUAGE</span> <span class="n">plpgsql</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>parameterMap要素を実装する。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;parameterMap</span> <span class="na">id=</span><span class="s">&quot;salesItemMap&quot;</span> <span class="na">class=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model.SalesItem&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;parameter</span> <span class="na">property=</span><span class="s">&quot;id&quot;</span> <span class="na">jdbcType=</span><span class="s">&quot;INTEGER&quot;</span> <span class="na">mode=</span><span class="s">&quot;IN&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;parameter</span> <span class="na">property=</span><span class="s">&quot;quantity&quot;</span> <span class="na">jdbcType=</span><span class="s">&quot;INTEGER&quot;</span> <span class="na">mode=</span><span class="s">&quot;OUT&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;parameter</span> <span class="na">property=</span><span class="s">&quot;total&quot;</span> <span class="na">jdbcType=</span><span class="s">&quot;INTEGER&quot;</span> <span class="na">mode=</span><span class="s">&quot;OUT&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/parameterMap&gt;</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="c1">// (4)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SalesItem</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">quantity</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">total</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>ファンクションに渡すINパラメータと、OUTパラメータのマッピングを定義する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>INパラメータのマッピングを定義している。INパラメータに、<tt class="docutils literal"><span class="pre">SalesItem#id</span></tt>をマッピングしている。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>OUTパラメータのマッピングを定義している。OUTパラメータの1番目を<tt class="docutils literal"><span class="pre">SalesItem#quantity</span></tt>に、2番目を<tt class="docutils literal"><span class="pre">SalesItem#total</span></tt>にマッピングしている。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>マッピング対象となるJavaBean。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">parameterMap属性を使わずに、&#8221;Inline Parameter Maps&#8221;の仕組みでマッピングする事もできる。
具体例は、Mybatis Developer Guide(PDF)の「Parameter Maps and Inline Parameters」(P.31)を参照されたい。</p>
</div>
</div></blockquote>
<p>procedure要素を実装する。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;procedure</span> <span class="na">id=</span><span class="s">&quot;findSalesItem&quot;</span> <span class="na">parameterMap=</span><span class="s">&quot;salesItemMap&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    {call sales_item(?,?,?)}
<span class="nt">&lt;/procedure&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">呼び出すProcedureやFunctionを、&#8221;{call Procedure/Function名(INパラメータ ...,OUTパラメータ...)}&#8221;の形式で指定する。</div>
<div class="line">例では、<tt class="docutils literal"><span class="pre">sales_item</span></tt>というFunctionに対して、INパラメータ1つと、OUTパラメータ2つを指定している。</div>
<div class="line">バインドされる値は、parameterMap要素で指定したマッピング定義の定義順となる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id6">
<h4><a class="toc-backref" href="#id47">5.3.2.3.6. sql要素の実装例</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<p>sql要素の実装する。</p>
<ul class="simple">
<li>xxx-sqlmap.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;sql</span> <span class="na">id=</span><span class="s">&quot;fragment_where_byFinished&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    WHERE
        finished = #finished#
<span class="nt">&lt;/sql&gt;</span>

<span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findByFinished&quot;</span>
        <span class="na">parameterClass=</span><span class="s">&quot;boolean&quot;</span>
        <span class="na">resultMap=</span><span class="s">&quot;resultMap_Todo&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
    SELECT
        *
    FROM
        todo
    <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">&quot;fragment_where_byFinished&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
    ORDER BY
        created_at DESC
<span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;countByFinished&quot;</span>
        <span class="na">parameterClass=</span><span class="s">&quot;boolean&quot;</span>
        <span class="na">resultClass=</span><span class="s">&quot;long&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
    SELECT
        count(*)
    FROM
        todo
    <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">&quot;fragment_where_byFinished&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (5) --&gt;</span>
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>(2)と(4)のSQLで共有するWHERE句を定義している。includeされるSQLの定義は、includeする側のSQLより先に、定義する必要がある。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>条件に一致するデータを取得するためのSQL</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>(1)で定義したWHERE句が実装されているSQLを、includeする。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>条件に一致するデータ件数を取得するためのSQL</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>(1)で定義したWHERE句が実装されているSQLを、includeする。</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="data-access-mybatis2-howtouse-lob-update">
<span id="id7"></span><h4><a class="toc-backref" href="#id48">5.3.2.3.7. LOB型更新の実装例</a><a class="headerlink" href="#data-access-mybatis2-howtouse-lob-update" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">BLOBおよびCLOBなどのLarge Objectを、データベースに更新する場合の実装例を、以下に示す。</div>
<div class="line">下記は、BLOBを扱うテーブルへレコードを挿入する例となっている。</div>
</div>
<ul class="simple">
<li>DDL</li>
</ul>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">upload_binary</span> <span class="p">(</span>
    <span class="n">file_id</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">file_name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">content</span> <span class="nb">BLOB</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="c1">-- (1)</span>
    <span class="k">CONSTRAINT</span> <span class="n">pk_upload_binary</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">file_id</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">BLOB型のカラムを定義する。</div>
<div class="line">上記例では、データベースとしてOracleを使用する前提のDDLとなっている。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>DTO(JavaBean)</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BinaryFile</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="c1">// omitted</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">fileId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">fileName</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">InputStream</span> <span class="n">content</span><span class="o">;</span> <span class="c1">// (2)</span>

    <span class="c1">// omitted setter/getter</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">BLOB型の値を保持するプロパティを<tt class="docutils literal"><span class="pre">java.io.InputStream</span></tt>型で定義する。</div>
<div class="line">上記例では、<tt class="docutils literal"><span class="pre">InputStream</span></tt>に、アップロードされたファイルの入力ストリームが設定される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>BLOBを扱う プロパティの型は、原則<tt class="docutils literal"><span class="pre">InputStream</span></tt>型で定義することを推奨する。
BLOBはバイト配列として扱うこともできるが、データの容量が大きくなると、メモリ枯渇の原因となる可能性がある。</p>
<p class="last">CLOBを扱うプロパティの型は、 原則<tt class="docutils literal"><span class="pre">java.io.Reader</span></tt>型で定義することを推奨する。
CLOBは文字列として扱うこともできるが、データの容量が大きくなると、メモリ枯渇の原因となる可能性がある。</p>
</div>
</div></blockquote>
<ul class="simple">
<li>xxx-sqlmap.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;parameterMap</span> <span class="na">id=</span><span class="s">&quot;uploadBinaryParameterMap&quot;</span>
              <span class="na">class=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.service.BinaryFile&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parameter</span> <span class="na">property=</span><span class="s">&quot;fileId&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;parameter</span> <span class="na">property=</span><span class="s">&quot;fileName&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;parameter</span> <span class="na">property=</span><span class="s">&quot;content&quot;</span>
               <span class="na">jdbcType=</span><span class="s">&quot;BLOB&quot;</span>
               <span class="na">typeHandler=</span><span class="s">&quot;jp.terasoluna.fw.orm.ibatis.support.BlobInputStreamTypeHandler&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/parameterMap&gt;</span>

<span class="c">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;uploadBinary&quot;</span> <span class="na">parameterMap=</span><span class="s">&quot;uploadBinaryParameterMap&quot;</span><span class="nt">&gt;</span>
    INSERT INTO upload_binary
    (
        file_id
        ,file_name
        ,content
    )
    VALUES
    (
        ?
        ,?
        ,?
    )
<span class="nt">&lt;/insert&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">BLOB型のカラムの登録値を保持するパラメータに対して、登録するために必要な定義を指定する。</div>
<div class="line">jdbcType属性には<tt class="docutils literal"><span class="pre">&quot;BLOB&quot;</span></tt>を、typeHandler属性には<tt class="docutils literal"><span class="pre">&quot;jp.terasoluna.fw.orm.ibatis.support.BlobInputStreamTypeHandler&quot;</span></tt>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">BLOB型のカラムをもつテーブルに、レコードを登録するためのSQL。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">CLOBを扱う場合は、jdbcType属性には<tt class="docutils literal"><span class="pre">&quot;CLOB&quot;</span></tt>を、typeHandler属性には<tt class="docutils literal"><span class="pre">&quot;jp.terasoluna.fw.orm.ibatis.support.ClobReaderTypeHandler&quot;</span></tt>を指定する。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>FQCNで指定しているクラス名は、 typeAlias要素を使って別名を付与することで、シンプルに記載することができる。</p>
<blockquote class="last">
<div><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- (5) --&gt;</span>
<span class="nt">&lt;typeAlias</span> <span class="na">alias=</span><span class="s">&quot;BinaryFile&quot;</span>
           <span class="na">type=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.service.BinaryFile&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;typeAlias</span> <span class="na">alias=</span><span class="s">&quot;BlobInputStreamTypeHandler&quot;</span>
           <span class="na">type=</span><span class="s">&quot;jp.terasoluna.fw.orm.ibatis.support.BlobInputStreamTypeHandler&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;parameterMap</span> <span class="na">id=</span><span class="s">&quot;uploadBinaryParameterMap&quot;</span>
              <span class="na">class=</span><span class="s">&quot;BinaryFile&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (6) --&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;parameter</span> <span class="na">property=</span><span class="s">&quot;content&quot;</span> <span class="na">jdbcType=</span><span class="s">&quot;BLOB&quot;</span>
               <span class="na">typeHandler=</span><span class="s">&quot;BlobInputStreamTypeHandler&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (6) --&gt;</span>

<span class="nt">&lt;/parameterMap&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">typeAlias要素を使って、クラス名(FQCN)に別名を付与する。</div>
<div class="line">上記例では、<tt class="docutils literal"><span class="pre">BinaryFile</span></tt>と<tt class="docutils literal"><span class="pre">BlobInputStreamTypeHandler</span></tt>クラスに対して、別名を付与している。</div>
<div class="line">typeAlias要素は、<tt class="file docutils literal"><span class="pre">sqlMapConfig.xml</span></tt>と<tt class="file docutils literal"><span class="pre">xxx-sqlmap.xml</span></tt>の両方で、定義することができる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(5)で付与したクラス名(FQCN)の別名を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div></blockquote>
<ul class="simple">
<li>Service</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="c1">// omitted</span>

<span class="nd">@Inject</span>
<span class="n">UpdateDAO</span> <span class="n">updateDAO</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="n">BinaryFile</span> <span class="nf">uploadBinaryFile</span><span class="o">(</span><span class="n">String</span> <span class="n">fileName</span><span class="o">,</span>
        <span class="n">InputStream</span> <span class="n">contentInputStream</span><span class="o">)</span> <span class="o">{</span>

    <span class="c1">// (7)</span>
    <span class="n">BinaryFile</span> <span class="n">inputtedFile</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BinaryFile</span><span class="o">();</span>
    <span class="n">inputtedFile</span><span class="o">.</span><span class="na">setFileId</span><span class="o">(</span><span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
    <span class="n">inputtedFile</span><span class="o">.</span><span class="na">setFileName</span><span class="o">(</span><span class="n">fileName</span><span class="o">);</span>
    <span class="n">inputtedFile</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="n">contentInputStream</span><span class="o">);</span>

    <span class="c1">// (8)</span>
    <span class="n">updateDAO</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">&quot;example.uploadBinary&quot;</span><span class="o">,</span> <span class="n">inputtedFile</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">inputtedFile</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">// omitted</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">レコードを登録するために必要な情報を、DTOに設定する。</div>
<div class="line">上記例では、ファイルIDをUUIDとして採番し、引数で受け取ったファイル名と、ファイルの中身が格納されている<tt class="docutils literal"><span class="pre">InputStream</span></tt>オブジェクトを、DTOに設定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">登録するために必要な情報を、保持するDTOを引数に、<tt class="docutils literal"><span class="pre">UpdateDAO</span></tt>を呼び出す。</div>
<div class="line">DAOの呼び出し方法は、BLOBを扱わない場合と同じである。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Controller</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;uploadBinary&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">uploadBinaryFile</span><span class="o">(</span>
        <span class="nd">@RequestPart</span><span class="o">(</span><span class="s">&quot;file&quot;</span><span class="o">)</span> <span class="n">MultipartFile</span> <span class="n">multipartFile</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="c1">// (9)</span>
    <span class="n">BinaryFile</span> <span class="n">uploadedFile</span> <span class="o">=</span> <span class="n">uploadService</span><span class="o">.</span><span class="na">uploadBinaryFile</span><span class="o">(</span><span class="n">multipartFile</span>
            <span class="o">.</span><span class="na">getOriginalFilename</span><span class="o">(),</span> <span class="n">multipartFile</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">uploadedFile</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">&quot;upload/form&quot;</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アップロードされたファイルのファイル名と、ファイルの中身が格納されている<tt class="docutils literal"><span class="pre">InputStream</span></tt>を引数に、Serviceのメソッドを呼び出す。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id8">
<h4><a class="toc-backref" href="#id49">5.3.2.3.8. LOB型取得の実装例</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">BLOBおよびCLOBなどのLarge Objectを、データベースから取得する場合の実装例を、以下に示す。</div>
<div class="line">下記は、BLOBを扱うテーブルからレコードを取得する例となっている。</div>
<div class="line">必要なテーブルを作成するDDLやDTO(JavaBean)は、<a class="reference internal" href="#data-access-mybatis2-howtouse-lob-update"><em>LOB型更新の実装例</em></a>を参照されたい。</div>
</div>
<ul class="simple">
<li>xxx-sqlmap.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;selectBinaryResultMap&quot;</span> <span class="na">class=</span><span class="s">&quot;BinaryFile&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;fileId&quot;</span> <span class="na">column=</span><span class="s">&quot;file_id&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;fileName&quot;</span> <span class="na">column=</span><span class="s">&quot;file_name&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;content&quot;</span> <span class="na">column=</span><span class="s">&quot;content&quot;</span> <span class="na">jdbcType=</span><span class="s">&quot;BLOB&quot;</span>
            <span class="na">typeHandler=</span><span class="s">&quot;BlobInputStreamTypeHandler&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>

<span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;selectBinary&quot;</span> <span class="na">parameterClass=</span><span class="s">&quot;java.lang.String&quot;</span>
        <span class="na">resultMap=</span><span class="s">&quot;selectBinaryResultMap&quot;</span><span class="nt">&gt;</span>
    SELECT
        *
    FROM
        upload_binary
    WHERE
        file_id = #fileId#
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">BLOB型のカラムから取得した値を保持するプロパティに対して、値を取得するために必要な定義を指定する。</div>
<div class="line">jdbcType属性には<tt class="docutils literal"><span class="pre">&quot;BLOB&quot;</span></tt>を、typeHandler属性には<tt class="docutils literal"><span class="pre">&quot;jp.terasoluna.fw.orm.ibatis.support.BlobInputStreamTypeHandler&quot;</span></tt>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">BLOB型のカラムをもつテーブルから、レコードを取得するためのSQL。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">CLOBを扱う場合は、jdbcType属性には<tt class="docutils literal"><span class="pre">&quot;CLOB&quot;</span></tt>を、typeHandler属性には<tt class="docutils literal"><span class="pre">&quot;jp.terasoluna.fw.orm.ibatis.support.ClobReaderTypeHandler&quot;</span></tt>を指定する。</p>
</div>
</div></blockquote>
<ul class="simple">
<li>Service / Repository</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="c1">// omitted</span>

<span class="nd">@Inject</span>
<span class="n">QueryDAO</span> <span class="n">queryDAO</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="n">BinaryFile</span> <span class="nf">getBinaryFile</span><span class="o">(</span><span class="n">String</span> <span class="n">fileId</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// (3)</span>
    <span class="n">BinaryFile</span> <span class="n">loadedFile</span> <span class="o">=</span> <span class="n">queryDAO</span><span class="o">.</span><span class="na">executeForObject</span><span class="o">(</span>
            <span class="s">&quot;article.selectBinary&quot;</span><span class="o">,</span> <span class="n">fileId</span><span class="o">,</span> <span class="n">BinaryFile</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">loadedFile</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">// omitted</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Controllerから指定された取得条件を引数に、<tt class="docutils literal"><span class="pre">QueryDAO</span></tt>を呼び出す。</div>
<div class="line">上記例では、ファイルIDに一致するアップロードファイルの情報を取得している。</div>
<div class="line">DAOの呼び出し方法は、BLOBを扱わない場合と同じである。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div>
<div class="section" id="sql-sql">
<h3><a class="toc-backref" href="#id50">5.3.2.4. SQLマッピングの実装例(動的SQL編)</a><a class="headerlink" href="#sql-sql" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Mybatisでは、動的にSQLを組み立てる仕組みが、デフォルトで用意されている。</div>
<div class="line">以下に、動的にSQLを組み立てる方法について説明する。</div>
<div class="line">詳細については、Developer Guide(PDF)の「Dynamic Mapped Statements」(P.48-53)を参照されたい。</div>
</div>
<div class="section" id="id9">
<h4><a class="toc-backref" href="#id51">5.3.2.4.1. パラメータオブジェクトの指定有無を判定</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<p>SQLに渡されたパラメータオブジェクトが指定されているかを判定し、SQLを組み立てることができる。</p>
<p>判定用の要素は、以下の通りである。</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="15%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">要素</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>isParameterPresent</td>
<td>パラメータオブジェクトが指定されている(NULLでない)時のSQLを組み立てるための要素。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>isNotParameterPresent</td>
<td>パラメータオブジェクトが指定されていない(NULLである)時のSQLを組み立てるための要素。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>実装例は、以下の通りである。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterClass=</span><span class="s">&quot;java.lang.Integer&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;...&quot;</span><span class="nt">&gt;</span>
    SELECT
        *
    FROM
        t_order
    WHERE

    <span class="nt">&lt;isParameterPresent&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        id = #id#
    <span class="nt">&lt;/isParameterPresent&gt;</span>

    <span class="nt">&lt;isNotParameterPresent&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
        1 = 2
    <span class="nt">&lt;/isNotParameterPresent&gt;</span>

    <span class="c">&lt;!-- ... --&gt;</span>

<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例では、パラメータオブジェクトが指定されている時に、idカラムをWHERE句に設定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例では、パラメータオブジェクトが指定されていない時に、一致するレコードが0件になるように、条件「<tt class="docutils literal"><span class="pre">1=2</span></tt>」を設定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>上記の動的SQLで生成されるSQLは、以下2パターンとなる。</p>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- (1) parameterObject(id)=1</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">t_order</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1">-- (2)</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">t_order</span> <span class="k">WHERE</span> <span class="mi">1</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="javabean">
<h4><a class="toc-backref" href="#id52">5.3.2.4.2. パラメータオブジェクト(JavaBean)のプロパティの存在有無を判定</a><a class="headerlink" href="#javabean" title="Permalink to this headline">¶</a></h4>
<p>SQLに渡されたパラメータオブジェクト(JavaBean)に指定したプロパティが存在するか判定し、SQLを組み立てることができる。</p>
<p>判定用の要素は、以下の通りである。</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="15%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">要素</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>isPropertyAvailable</td>
<td>指定したプロパティが、存在する時のSQLを組み立てるための要素。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>isNotPropertyAvailable</td>
<td>指定したプロパティが、存在しない時のSQLを組み立てるための要素。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>実装例は、以下の通りである。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterClass=</span><span class="s">&quot;OrderCriteria&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;...&quot;</span><span class="nt">&gt;</span>
    SELECT
        *
    FROM
        t_order
    WHERE

    <span class="nt">&lt;isPropertyAvailable</span> <span class="na">property=</span><span class="s">&quot;statusCode&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        status_code = #statusCode#
    <span class="nt">&lt;/isPropertyAvailable&gt;</span>

    <span class="nt">&lt;isNotPropertyAvailable</span> <span class="na">property=</span><span class="s">&quot;statusCode&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="cp">&lt;![CDATA[</span>
<span class="cp">        status_code &lt;&gt; &#39;completed&#39;</span>
<span class="cp">        ]]&gt;</span>
    <span class="nt">&lt;/isNotPropertyAvailable&gt;</span>

    <span class="c">&lt;!-- ... --&gt;</span>

<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例では、<tt class="docutils literal"><span class="pre">statusCode</span></tt>プロパティが存在する場合に、status_codeカラムが、<tt class="docutils literal"><span class="pre">statusCode</span></tt>と一致するレコードが取得されるように、WHERE句を設定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例では、<tt class="docutils literal"><span class="pre">statusCode</span></tt>プロパティが存在しない場合に、status_codeカラムが、<tt class="docutils literal"><span class="pre">'completed'</span></tt>以外のレコードが取得されるように、WHERE句を設定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>上記の動的SQLで生成されるSQLは、以下2パターンとなる。</p>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- (1) statusCode=&#39;checking&#39;</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">t_order</span> <span class="k">WHERE</span> <span class="n">status_code</span> <span class="o">=</span> <span class="s1">&#39;checking&#39;</span>

<span class="c1">-- (2)</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">t_order</span> <span class="k">WHERE</span> <span class="n">status_code</span> <span class="o">&lt;&gt;</span> <span class="s1">&#39;completed&#39;</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="id10">
<h4><a class="toc-backref" href="#id53">5.3.2.4.3. パラメータオブジェクト(JavaBean)のプロパティ値の設定有無を判定</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<p>SQLに渡されたパラメータオブジェクト(JavaBean)のプロパティに値が指定されているか判定し、SQLを組み立てることができる。</p>
<p>判定用の要素は、以下の通りである。</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="15%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">要素</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>isNull</td>
<td>プロパティの値が、<tt class="docutils literal"><span class="pre">null</span></tt>時のSQLを組み立てるための要素。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>isNotNull</td>
<td>プロパティの値が、<tt class="docutils literal"><span class="pre">null</span></tt>でない時のSQLを組み立てるための要素。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>isEmpty</td>
<td>プロパティの値が、<tt class="docutils literal"><span class="pre">null</span></tt>または、空の時のSQLを組み立てるための要素。
<tt class="docutils literal"><span class="pre">Collection</span></tt>および、<tt class="docutils literal"><span class="pre">String</span></tt>に対して、指定することができる。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>isNotEmpty</td>
<td>プロパティの値が、<tt class="docutils literal"><span class="pre">null</span></tt>および、空でない時のSQLを組み立てるための要素。
<tt class="docutils literal"><span class="pre">Collection</span></tt>および、<tt class="docutils literal"><span class="pre">String</span></tt>に対して、指定することができる。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>実装例は、以下の通りである。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterClass=</span><span class="s">&quot;OrderCriteria&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
    SELECT
        *
    FROM
        t_order
    WHERE

    <span class="nt">&lt;isNull</span> <span class="na">property=</span><span class="s">&quot;orderedDate&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="cp">&lt;![CDATA[</span>
<span class="cp">        CURRENT_DATE - &#39;1 months&#39;::interval &lt;= ordered_date</span>
<span class="cp">        ]]&gt;</span>
    <span class="nt">&lt;/isNull&gt;</span>

    <span class="nt">&lt;isNotNull</span> <span class="na">property=</span><span class="s">&quot;orderedDate&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
        ordered_date = #orderedDate#
    <span class="nt">&lt;/isNotNull&gt;</span>

    <span class="nt">&lt;isEmpty</span> <span class="na">property=</span><span class="s">&quot;statusCodes&quot;</span> <span class="na">prepend=</span><span class="s">&quot;AND&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
        <span class="cp">&lt;![CDATA[</span>
<span class="cp">        status_code &lt;&gt; &#39;completed&#39;</span>
<span class="cp">        ]]&gt;</span>
    <span class="nt">&lt;/isEmpty&gt;</span>

    <span class="nt">&lt;isNotEmpty</span> <span class="na">property=</span><span class="s">&quot;statusCodes&quot;</span> <span class="na">prepend=</span><span class="s">&quot;AND&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
        status_code IN
        <span class="nt">&lt;iterate</span> <span class="na">property=</span><span class="s">&quot;statusCodes&quot;</span> <span class="na">open=</span><span class="s">&quot;(&quot;</span> <span class="na">close=</span><span class="s">&quot;)&quot;</span> <span class="na">conjunction=</span><span class="s">&quot;,&quot;</span><span class="nt">&gt;</span>
            #statusCodes[]#
        <span class="nt">&lt;/iterate&gt;</span>
    <span class="nt">&lt;/isNotEmpty&gt;</span>

<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例では、<tt class="docutils literal"><span class="pre">orderedDate</span></tt>プロパティ(Date型)の値が<tt class="docutils literal"><span class="pre">null</span></tt>の場合に、ordered_dateカラムが、1ヶ月前以降のレコードが取得されるように、WHERE句を設定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例では、<tt class="docutils literal"><span class="pre">orderedDate</span></tt>プロパティ(Date型) の値が<tt class="docutils literal"><span class="pre">null</span></tt>でない場合に、ordered_dateカラムが<tt class="docutils literal"><span class="pre">orderedDate</span></tt>と一致するレコードが取得されるように、WHERE句を設定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例では、<tt class="docutils literal"><span class="pre">statusCodes</span></tt>プロパティ(List&lt;String&gt;型)の値が、空の場合に、status_codeカラムが、<tt class="docutils literal"><span class="pre">'completed'</span></tt>以外のレコードが取得されるように、WHERE句を設定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例では、<tt class="docutils literal"><span class="pre">statusCodes</span></tt>プロパティ(List&lt;String&gt;型)の値が、空でない場合に、status_codeカラムが、<tt class="docutils literal"><span class="pre">statusCodes</span></tt>に格納されているいずれかの値と一致するレコードが取得されるように、WHERE句を設定している。</div>
<div class="line">iterate要素の説明は、後述する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>上記の動的SQLで生成されるSQLは、以下4パターンとなる。</p>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- (1) orderedDate=null, statusCodes=[]</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">t_order</span> <span class="k">WHERE</span> <span class="k">CURRENT_DATE</span> <span class="o">-</span> <span class="s1">&#39;1 months&#39;</span><span class="p">::</span><span class="nb">interval</span> <span class="o">&lt;=</span> <span class="n">ordered_date</span>
    <span class="k">AND</span> <span class="n">status_code</span> <span class="o">&lt;&gt;</span> <span class="s1">&#39;completed&#39;</span>

<span class="c1">-- (2) orderedDate=null, statusCodes=[&#39;accepted&#39;,&#39;checking&#39;]</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">t_order</span> <span class="k">WHERE</span> <span class="k">CURRENT_DATE</span> <span class="o">-</span> <span class="s1">&#39;1 months&#39;</span><span class="p">::</span><span class="nb">interval</span> <span class="o">&lt;=</span> <span class="n">ordered_date</span>
    <span class="k">AND</span> <span class="n">status_code</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">&#39;accepted&#39;</span><span class="p">,</span><span class="s1">&#39;checking&#39;</span><span class="p">)</span>

<span class="c1">-- (3) orderedDate=2013/12/31, statusCodes=null</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">t_order</span> <span class="k">WHERE</span> <span class="n">ordered_date</span> <span class="o">=</span> <span class="s1">&#39;2013/12/31&#39;</span>
    <span class="k">AND</span> <span class="n">status_code</span> <span class="o">&lt;&gt;</span> <span class="s1">&#39;completed&#39;</span>

<span class="c1">-- (4) orderedDate=2013/12/31, statusCodes=[&#39;accepted&#39;]</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">t_order</span> <span class="k">WHERE</span> <span class="n">ordered_date</span> <span class="o">=</span> <span class="s1">&#39;2013/12/31&#39;</span>
    <span class="k">AND</span> <span class="n">status_code</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">&#39;accepted&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id11">
<h4><a class="toc-backref" href="#id54">5.3.2.4.4. パラメータオブジェクト(JavaBean)のプロパティ値を判定</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<p>SQLに渡されたパラメータオブジェクト(JavaBean)のプロパティに指定されている値を判定し、SQLを組み立てることができる。</p>
<p>判定用の要素は、以下の通りである。</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="15%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">要素</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>isEqual</td>
<td>プロパティの値が、指定した値と一致する時のSQLを組み立てるための要素。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>isNotEqual</td>
<td>プロパティの値が、指定した値と一致しない時のSQLを組み立てるための要素。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>isGreaterThan</td>
<td>プロパティの値が、指定した値より大きい時のSQLを組み立てるための要素。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>isGreaterEqual</td>
<td>プロパティの値が、指定した値以上の時のSQLを組み立てるための要素。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>isLessThan</td>
<td>プロパティの値が、指定した値より小さい時のSQLを組み立てるための要素。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>isLessEqual</td>
<td>プロパティの値が、指定した値以下の時のSQLを組み立てるための要素。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>実装例は、以下の通りである。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterClass=</span><span class="s">&quot;OrderCriteria&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;...&quot;</span><span class="nt">&gt;</span>
    SELECT
        *
    FROM
        t_order
    WHERE
        (
        <span class="cp">&lt;![CDATA[</span>
<span class="cp">        status_code &lt;&gt; &#39;completed&#39;</span>
<span class="cp">        ]]&gt;</span>
        <span class="nt">&lt;isEqual</span> <span class="na">property=</span><span class="s">&quot;containCompletedOrder&quot;</span>
                 <span class="na">compareValue=</span><span class="s">&quot;true&quot;</span>
                 <span class="na">prepend=</span><span class="s">&quot;OR&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
            status_code = &#39;completed&#39;
        <span class="nt">&lt;/isNull&gt;</span>
        )

<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例では、<tt class="docutils literal"><span class="pre">containCompletedOrder</span></tt>プロパティ(Boolean型)の値が、<tt class="docutils literal"><span class="pre">true</span></tt>の場合に、status_codeカラムが<tt class="docutils literal"><span class="pre">'completed'</span></tt>のレコードも取得されるように、WHERE句を設定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">compareProperty属性を使用することで、JavaBean内の別のプロパティの値と、比較することもできる。</p>
</div>
</div></blockquote>
<p>上記の動的SQLで生成されるSQLは、以下2パターンとなる。</p>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- (1) containCompletedOrder=false</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">t_order</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">status_code</span> <span class="o">&lt;&gt;</span>  <span class="s1">&#39;completed&#39;</span><span class="p">)</span>

<span class="c1">-- (2) containCompletedOrder=true</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">t_order</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">status_code</span> <span class="o">&lt;&gt;</span>  <span class="s1">&#39;completed&#39;</span> <span class="k">OR</span> <span class="n">status_code</span> <span class="o">=</span> <span class="s1">&#39;completed&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="id12">
<h4><a class="toc-backref" href="#id55">5.3.2.4.5. 判定要素の共通属性</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<p>動的SQLを組み立てるための要素には、以下の共通的な属性が存在する。</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="15%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>prepend</td>
<td>動的SQLを組み立てるための判定要素で、<tt class="docutils literal"><span class="pre">true</span></tt>と判断され、SQLが組み立てられた際に、SQLの先頭に設定する文字列を指定する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>open</td>
<td>動的SQLを組み立てるための判定要素の中で、組み立てたSQLの前に追加する文字列を指定する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>close</td>
<td>動的SQLを組み立てるための判定要素の中で、組み立てたSQLの後に付与する文字列を指定する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>実装例は、以下の通りである。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterClass=</span><span class="s">&quot;OrderCriteria&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;...&quot;</span><span class="nt">&gt;</span>
    SELECT
        *
    FROM
        t_order

    <span class="nt">&lt;isNotEmpty</span> <span class="na">property=</span><span class="s">&quot;statusCode&quot;</span>
                <span class="na">prepend=</span><span class="s">&quot;WHERE&quot;</span>
                <span class="na">open=</span><span class="s">&quot;(&quot;</span>
                <span class="na">close=</span><span class="s">&quot;)&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        status_code = #statusCode#
        <span class="nt">&lt;isEqual</span> <span class="na">property=</span><span class="s">&quot;containCompletedOrder&quot;</span> <span class="na">compareValue=</span><span class="s">&quot;true&quot;</span> <span class="na">prepend=</span><span class="s">&quot;OR&quot;</span><span class="nt">&gt;</span>
            status_code = &#39;completed&#39;
        <span class="nt">&lt;/isEqual&gt;</span>
    <span class="nt">&lt;/isNotEmpty&gt;</span>

<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="15%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例では、<tt class="docutils literal"><span class="pre">statusCode</span></tt>プロパティに値が指定されている場合に、status_codeカラムをWHERE句にし、</div>
<div class="line"><tt class="docutils literal"><span class="pre">containCompletedOrder</span></tt>プロパティ(Boolean型)の値が<tt class="docutils literal"><span class="pre">true</span></tt>の場合は、status_codeカラムが<tt class="docutils literal"><span class="pre">'completed'</span></tt>のレコードも取得されるように、WHERE句を設定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">prepend</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">statusCode</span></tt>プロパティに値が指定されている場合に、SQLに<tt class="docutils literal"><span class="pre">&quot;WHERE&quot;</span></tt>を設定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">open</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">containCompletedOrder</span></tt>プロパティ(Boolean型)の値が、<tt class="docutils literal"><span class="pre">true</span></tt>の場合は、OR条件を加えるため、</div>
<div class="line">status_codeカラムに対する条件をグループ化するための開始文^<tt class="docutils literal"><span class="pre">&quot;(&quot;</span></tt>を指定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">close</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">status_codeカラムに対する条件をグループ化するための終了文字<tt class="docutils literal"><span class="pre">&quot;)&quot;</span></tt>を指定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>上記の動的SQLで生成されるSQLは、以下3パターンとなる。</p>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- (1) statusCode=null, containCompletedOrder=false</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">t_order</span>

<span class="c1">-- (2) statusCode=&#39;accepted&#39;, containCompletedOrder=false</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">t_order</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">status_code</span> <span class="o">=</span> <span class="s1">&#39;accepted&#39;</span><span class="p">)</span>

<span class="c1">-- (3) statusCode=&#39;checking&#39;, containCompletedOrder=true</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">t_order</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">status_code</span> <span class="o">=</span> <span class="s1">&#39;checking&#39;</span> <span class="k">OR</span> <span class="n">status_code</span> <span class="o">=</span> <span class="s1">&#39;completed&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="id13">
<h4><a class="toc-backref" href="#id56">5.3.2.4.6. コレクションの繰り返し</a><a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h4>
<p>SQLに渡されたバインド値が、コレクションや配列の場合、コレクションおよび配列の要素分処理を繰り返して、SQLを組み立てることができる。</p>
<p>要素は、以下の通りである。</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="15%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">要素</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>iterate</td>
<td>コレクションおよび配列に対して、繰り返し処理を行い、SQLを組み立てるための要素。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>実装例は、以下の通りである。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterClass=</span><span class="s">&quot;OrderCriteria&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;...&quot;</span><span class="nt">&gt;</span>
    SELECT
        *
    FROM
        t_order

    <span class="nt">&lt;isNotNull</span> <span class="na">property=</span><span class="s">&quot;statusCodes&quot;</span> <span class="na">prepend=</span><span class="s">&quot;WHERE&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;iterate</span> <span class="na">property=</span><span class="s">&quot;statusCodes&quot;</span>
                 <span class="na">prepend=</span><span class="s">&quot;status_code IN&quot;</span>
                 <span class="na">open=</span><span class="s">&quot;(&quot;</span>
                 <span class="na">conjunction=</span><span class="s">&quot;,&quot;</span>
                 <span class="na">close=</span><span class="s">&quot;)&quot;</span> <span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
            #statusCodes[]#
        <span class="nt">&lt;/iterate&gt;</span>
    <span class="nt">&lt;/isNotNull&gt;</span>

<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="15%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">例では、<tt class="docutils literal"><span class="pre">statusCodes</span></tt>プロパティ(List&lt;String&gt;)に格納されている値を、IN句の値として設定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">prepend</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">コレクションまたは配列の要素が存在する場合に、最初に設定する文字列を指定する。例では、条件に加えるカラム名と、IN句を指定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">open</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">コレクションまたは配列の最初の要素を処理する前に設定する文字列を指定する。例では、IN句に指定する値の開始囲い文字<tt class="docutils literal"><span class="pre">&quot;(&quot;</span></tt>を指定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">conjunction</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">次の要素がある場合、次の要素の処理を行う前に設定する文字列を指定する。例では、IN句に指定する値の区切り文字<tt class="docutils literal"><span class="pre">&quot;,&quot;</span></tt>を指定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">close</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">コレクションまたは配列の最後の要素の処理を行った後に、設定する文字列を指定する。例では、IN句に指定する値の終了囲い文字<tt class="docutils literal"><span class="pre">&quot;)&quot;</span></tt>を指定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>上記例は、JavaBeanの中のプロパティがコレクションの場合の実装例であるが、パラメータオブジェクト自体をコレクションにすることもできる。
その場合は、property属性は指定せず、<tt class="docutils literal"><span class="pre">#[]#</span></tt>という形式でアクセスすることができる。</p>
<p class="last">コレクションには、JavaBeanを格納することもでき、JavaBeanにネストされているコレクションにも、アクセスすることができる。
詳細は、Developer Guide(PDF)の「Dynamic Mapped Statements」(P.52)を参照されたい。</p>
</div>
</div></blockquote>
<p>上記の動的SQLで生成されるSQLは、以下3パターンとなる。</p>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- (1) statusCodes=null</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">t_order</span>

<span class="c1">-- (2) statusCodes=[]</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">t_order</span>

<span class="c1">-- (3) statusCodes=[&#39;accepted&#39;,&#39;checking&#39;]</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">t_order</span> <span class="k">WHERE</span> <span class="n">status_code</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">&#39;accepted&#39;</span> <span class="p">,</span> <span class="s1">&#39;checking&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="id14">
<h4><a class="toc-backref" href="#id57">5.3.2.4.7. 動的SQLのブロック化</a><a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h4>
<p>個々の動的SQLをブロック化することで、ブロック全体として、prepend, open, close属性を制御することができる。</p>
<p>要素は、以下の通りである。</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="15%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">要素</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>dynamic</td>
<td>動的SQLを組み立てる要素をブロック化するための要素。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>実装例は、以下の通りである。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterClass=</span><span class="s">&quot;OrderCriteria&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;...&quot;</span><span class="nt">&gt;</span>
    SELECT
        *
    FROM
        t_order
    WHERE

    <span class="nt">&lt;dynamic</span> <span class="na">prepend=</span><span class="s">&quot;WHERE&quot;</span>
             <span class="na">open=</span><span class="s">&quot;(&quot;</span>
             <span class="na">close=</span><span class="s">&quot;)&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

        <span class="nt">&lt;isNotEmpty</span> <span class="na">property=</span><span class="s">&quot;id&quot;</span> <span class="na">prepend=</span><span class="s">&quot;AND&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
            id = #id#
        <span class="nt">&lt;/isNotEmpty&gt;</span>

        <span class="nt">&lt;isNotEmpty</span> <span class="na">property=</span><span class="s">&quot;statusCode&quot;</span> <span class="na">prepend=</span><span class="s">&quot;AND&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
            status_code = #statusCode#
        <span class="nt">&lt;/isNotEmpty&gt;</span>

    <span class="nt">&lt;/dynamic&gt;</span>

<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="15%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(2)と(3)の動的SQLを、ブロック化している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">prepend</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ブロック内で組み立てたSQLの先頭に設定する文字列を指定する。ここで指定した値は、ブロック内で最初に一致した動的SQLのprepend属性の値として使用される。</div>
<div class="line">上記例だと、<tt class="docutils literal"><span class="pre">id</span></tt>プロパティに値を指定した場合、(2)のprepend属性の値は、<tt class="docutils literal"><span class="pre">&quot;AND&quot;</span></tt>ではなく、<tt class="docutils literal"><span class="pre">&quot;WHERE&quot;</span></tt>となる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">open</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ブロック中で組み立てたSQLの前に、追加する文字列を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">close</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ブロック中で組み立てたSQLの後に、追加する文字列を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>上記の動的SQLで生成されるSQLは、以下4パターンとなる。</p>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- (1) id=null, statusCode=null</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">t_order</span>

<span class="c1">-- (2) id=1, statusCode=null</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">t_order</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1">-- (3) id=null, statusCode=&#39;accepted&#39;</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">t_order</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">status_code</span> <span class="o">=</span> <span class="s1">&#39;accepted&#39;</span><span class="p">)</span>

<span class="c1">-- (4) id=1, statusCode=&#39;accepted&#39;</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">t_order</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">AND</span> <span class="n">status_code</span> <span class="o">=</span> <span class="s1">&#39;accepted&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="querydao">
<h3><a class="toc-backref" href="#id58">5.3.2.5. QueryDAOの使用例</a><a class="headerlink" href="#querydao" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id15">
<h4><a class="toc-backref" href="#id59">5.3.2.5.1. 1件検索</a><a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h4>
<p>検索結果が、0～1件となるクエリを発行したい場合、以下のような実装となる。</p>
<ul class="simple">
<li>Xxx.java</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="n">String</span> <span class="n">todoId</span> <span class="o">=</span> <span class="s">&quot;xxxxx....&quot;</span><span class="o">;</span>
<span class="n">Todo</span> <span class="n">loadedTodo</span> <span class="o">=</span> <span class="n">queryDAO</span><span class="o">.</span><span class="na">executeForObject</span><span class="o">(</span> <span class="c1">// (1)</span>
        <span class="s">&quot;todo.findOne&quot;</span><span class="o">,</span>    <span class="c1">// (2)</span>
        <span class="n">todoId</span><span class="o">,</span>            <span class="c1">// (3)</span>
        <span class="n">Todo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>       <span class="c1">// (4)</span>
<span class="k">if</span> <span class="o">(</span><span class="n">loadedTodo</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>  <span class="c1">// (5)</span>
    <span class="c1">// ...                 // (6)</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>検索結果を(4)で指定した型のオブジェクトとして取得するためのメソッド(<tt class="docutils literal"><span class="pre">QueryDAO#executeForObject</span></tt>)を呼び出す。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">検索結果が0～1件となるSQLのSQLIDを指定する。</div>
<div class="line">検索結果が複数件になる場合は、Mybatisが<tt class="docutils literal"><span class="pre">java.sql.SQLException</span></tt>を発生させる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SQLのバインドパラメータを指定する。</div>
<div class="line">例では、<tt class="docutils literal"><span class="pre">java.lang.String</span></tt>にしているが、複数のパラメータ(検索条件)を渡したい場合は、JavaBeanを指定することもできる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>SQLの取得結果をマッピングするオブジェクトの型を指定する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>検索結果が0件の場合は、nullになるので、null判定が必要である。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td>検索結果が、0件の場合の処理を実装する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id16">
<h4><a class="toc-backref" href="#id60">5.3.2.5.2. 複数件検索</a><a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h4>
<p>検索結果が、0～N件となるクエリを発行し、条件に一致するデータをすべて取得する場合は、以下のような実装となる。</p>
<ul class="simple">
<li>Xxx.java</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kt">boolean</span> <span class="n">finished</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">unfinishedTodoList</span> <span class="o">=</span> <span class="n">queryDAO</span><span class="o">.</span><span class="na">executeForObjectList</span><span class="o">(</span> <span class="c1">// (1)</span>
        <span class="s">&quot;todo.findByFinished&quot;</span><span class="o">,</span>     <span class="c1">// (2)</span>
        <span class="n">finished</span><span class="o">);</span>                 <span class="c1">// (3)</span>
<span class="k">if</span><span class="o">(</span><span class="n">unfinishedTodoList</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()){</span>  <span class="c1">// (4)</span>
    <span class="c1">// ...                         // (5)</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>オブジェクトのリストを取得するための、メソッドを呼び出す。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>検索結果が、0～N件となるSQLのSQLIDを指定する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SQLのバインドパラメータを指定する。</div>
<div class="line">例では、booleanにしているが、複数のパラメータ(検索条件)を渡したい場合は、JavaBeanを指定することもできる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>検索結果が0件の場合は、空のリストが返却される。nullは返却されないので、nullチェックは不要である。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>検索結果が、0件の場合の処理を実装する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id17">
<h4><a class="toc-backref" href="#id61">5.3.2.5.3. ページネーション検索（TERASOLUNA DAO標準機能方式）</a><a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">検索結果が、0～N件となるクエリを発行し、条件に一致するデータの一部(指定ページ部分)を取得する場合は、以下のような実装となる。</div>
<div class="line">以下の例では、TERASOLUNA DAOから提供されているAPIを使って、実現する実装例となっている。</div>
</div>
<dl class="docutils">
<dt></dt>
<dd><div class="first last admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>検索条件に一致するデータ件数が非常に多くなる場合の注意点</strong></p>
<p class="last">TERASOLUNA DAO標準機能のページネーション検索は、<tt class="docutils literal"><span class="pre">java.sql.ResultSet#next</span></tt>を使って取得するレコードの開始位置までスキップする実装となっているため、
検索条件に一致するデータ件数が、非常に多い場合、処理性能に影響を与える可能性がある。
検索条件に一致するデータ件数が、非常に多くなる可能性がある場合は、TERASOLUNA DAO標準機能のページネーション検索ではなく、SQL絞り込み方式の採用を検討すること。</p>
</div>
</dd>
</dl>
<ul class="simple">
<li>Xxx.java</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="n">Pageable</span> <span class="n">pageable</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PageRequest</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">10</span><span class="o">);</span> <span class="c1">// (1)</span>
<span class="kt">boolean</span> <span class="n">finished</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="kt">long</span> <span class="n">totalCount</span> <span class="o">=</span> <span class="n">queryDAO</span><span class="o">.</span><span class="na">executeForObject</span><span class="o">(</span>
        <span class="s">&quot;todo.countByFinished&quot;</span><span class="o">,</span> <span class="c1">// (2)</span>
        <span class="n">finished</span><span class="o">,</span>
        <span class="n">Long</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>            <span class="c1">// (3)</span>

<span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">unfinishedTodoList</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="k">if</span><span class="o">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">totalCount</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">unfinishedTodoList</span> <span class="o">=</span> <span class="n">queryDAO</span><span class="o">.</span><span class="na">executeForObjectList</span><span class="o">(</span>
        <span class="s">&quot;todo.findByFinished&quot;</span><span class="o">,</span>   <span class="c1">// (4)</span>
        <span class="n">finished</span><span class="o">,</span>
        <span class="n">pageable</span><span class="o">.</span><span class="na">getOffset</span><span class="o">(),</span>    <span class="c1">// (5)</span>
        <span class="n">pageable</span><span class="o">.</span><span class="na">getPageSize</span><span class="o">());</span> <span class="c1">// (6)</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">unfinishedTodoList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;();</span>
<span class="o">}</span>

<span class="n">Page</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PageImpl</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;(</span> <span class="c1">// (7)</span>
        <span class="n">unfinishedTodoList</span><span class="o">,</span> <span class="c1">// (8)</span>
        <span class="n">pageable</span><span class="o">,</span>           <span class="c1">// (9)</span>
        <span class="n">totalCount</span><span class="o">);</span>        <span class="c1">// (10)</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>xxx-sqlmap.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findByFinished&quot;</span>
        <span class="na">parameterClass=</span><span class="s">&quot;boolean&quot;</span>
        <span class="na">resultMap=</span><span class="s">&quot;resultMap_Todo&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (11) --&gt;</span>
    SELECT
        *
    FROM
        todo
    WHERE
        finished = #finished#
    ORDER BY
        created_at DESC
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>Spring Dataより提供されているページング検索用のオブジェクト（<tt class="docutils literal"><span class="pre">org.springframework.data.domain.PageRequest</span></tt>）を生成する。
Pageableオブジェクトは、リクエストパラメータに指定して、Controllerの引数として受け事もできる。詳細は、<a class="reference internal" href="Pagination.html"><em>ページネーション</em></a>を参照されたい。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>条件に一致するデータの合計件数を、取得するためのSQLの、SQLIDを指定して実行する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>件数の取得なので、Long.classを指定する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>検索結果が、0～N件となるSQLの、SQLIDを指定して実行する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得開始位置を指定する。</div>
<div class="line">0開始。取得件数が10件のときに、10を指定すると、11～20件目が取得される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得件数を指定する。</div>
<div class="line">取得開始位置が0のときに、10を指定すると、1～10件目が取得される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td>Spring Dataより提供されているページ用のオブジェクト（<tt class="docutils literal"><span class="pre">org.springframework.data.domain.PageImpl</span></tt>）を生成する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td>ページネーション検索して、取得したリストを指定する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td>ページネーション検索で使用したページング検索用のオブジェクト(Pageable)を指定する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td>条件に一致するデータの、合計件数を指定する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td>SQLの実装例。SQLとしては、取得位置を意識する必要はない。</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id18">
<h4><a class="toc-backref" href="#id62">5.3.2.5.4. ページネーション検索（SQL絞り込み方式）</a><a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">検索結果が0～N件となるクエリを発行し、条件に一致するデータの一部(指定ページ部分)を取得する場合は、以下のような実装となる。</div>
<div class="line">以下の例では、TERASOLUNA DAOから提供されているAPIを使わずに、SQLを使って実現する実装例となっている。</div>
</div>
<ul class="simple">
<li>PageableBindParams.java (サンプルクラス)</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PageableBindParams</span><span class="o">&lt;</span><span class="n">P</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span> <span class="c1">// (1)</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">P</span> <span class="n">bindParams</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">PageableBindParams</span><span class="o">(</span><span class="n">P</span> <span class="n">bindParams</span><span class="o">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">bindParams</span> <span class="o">=</span> <span class="n">bindParams</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">pageable</span> <span class="o">=</span> <span class="n">pageable</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">P</span> <span class="nf">getBindParams</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">bindParams</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Pageable</span> <span class="nf">getPageable</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">pageable</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>Xxx.java</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="n">Pageable</span> <span class="n">pageable</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PageRequest</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">10</span><span class="o">);</span>
<span class="kt">boolean</span> <span class="n">finished</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="kt">long</span> <span class="n">totalCount</span> <span class="o">=</span> <span class="n">queryDAO</span><span class="o">.</span><span class="na">executeForObject</span><span class="o">(</span>
        <span class="s">&quot;todo.countByFinished&quot;</span><span class="o">,</span>
        <span class="n">finished</span><span class="o">,</span>
        <span class="n">Long</span><span class="o">.</span><span class="na">class</span><span class="o">);</span> <span class="c1">// (2)</span>

<span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">unfinishedTodoList</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="k">if</span><span class="o">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">totalCount</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">PageableBindParams</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span> <span class="n">pageableBindParams</span> <span class="o">=</span>
            <span class="k">new</span> <span class="n">PageableBindParams</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;(</span> <span class="c1">// (3)</span>
                    <span class="n">finished</span><span class="o">,</span>  <span class="c1">// (4)</span>
                    <span class="n">pageable</span><span class="o">);</span> <span class="c1">// (5)</span>
    <span class="n">unfinishedTodoList</span> <span class="o">=</span> <span class="n">queryDAO</span><span class="o">.</span><span class="na">executeForObjectList</span><span class="o">(</span>
            <span class="s">&quot;todo.findPageByFinished&quot;</span><span class="o">,</span> <span class="c1">// (6)</span>
            <span class="n">pageableBindParams</span><span class="o">);</span>       <span class="c1">// (7)</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">unfinishedTodoList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;();</span>
<span class="o">}</span>

<span class="n">Page</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PageImpl</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;(</span>
        <span class="n">unfinishedTodoList</span><span class="o">,</span>
        <span class="n">pageable</span><span class="o">,</span>
        <span class="n">totalCount</span><span class="o">);</span> <span class="c1">// (8)</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>xxx-sqlmap.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre> <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findPageByFinished&quot;</span>
         <span class="na">parameterClass=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.dto.PageableBindParams&quot;</span>
         <span class="na">resultMap=</span><span class="s">&quot;resultMap_Todo&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (9) --&gt;</span>
     SELECT
         *
     FROM
         todo
     WHERE
         finished = #bindParams#
     ORDER BY
         created_at DESC
     OFFSET
         #pageable.offset#    /* (10) */
     LIMIT
         #pageable.pageSize#  /* (11) */
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>検索条件となるパラメータ（バインドパラメータ）と、Spring Dataより提供されているページング検索用のオブジェクト（<tt class="docutils literal"><span class="pre">org.springframework.data.domain.Pageable</span></tt>）を保持するJavaBean。
DAOに渡せるバインドオブジェクトは一つのみなので、本クラスのような集約オブジェクトが、必要となる。本クラスは、サンプル実装なので、各プロジェクトで必要に応じて用意すること。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>TERASOLUNA DAO標準機能使用時と同様に、合計件数を取得する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">DAOに渡すバインド用オブジェクトを生成する。</div>
<div class="line">例では、(1)で用意したクラスを使用する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">対象データを絞り込むための、検索条件を指定する。</div>
<div class="line">例では、finishedの値として、「false」を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">該当ページのデータを絞り込むための、検索条件を指定する。</div>
<div class="line">例では、Spring Dataより提供されているページング検索用のオブジェクト（<tt class="docutils literal"><span class="pre">org.springframework.data.domain.PageRequest</span></tt>）を指定している。</div>
<div class="line">Pageableオブジェクトは、リクエストパラメータに指定して、Controllerの引数として受けることもできる。詳細は、<a class="reference internal" href="Pagination.html"><em>ページネーション</em></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td>該当ページのデータを抽出するSQLが実装されているSQLのSQLIDを指定する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td>(3)で生成したバインド用オブジェクトを指定する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td>TERASOLUNA DAO標準機能使用時と同様に、Spring Dataより提供されているページ用のオブジェクト（ <tt class="docutils literal"><span class="pre">org.springframework.data.domain.PageImpl</span></tt> ）を生成する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td>SQLの実装例。例では、PostgreSQLから提供されている機能(OFFSET,LIMIT)を使用している。SQLとして、取得位置を意識する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得開始位置を指定する。</div>
<div class="line">0開始。取得件数が10件のときに、10を指定すると、11～20件目が取得される。(PostgreSQLの機能を使用する)</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得件数を指定する。</div>
<div class="line">取得開始位置が、0のときに、10を指定すると、1～10件目が取得される。(PostgreSQLの機能を使用する)</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div>
<div class="section" id="updatedao">
<h3><a class="toc-backref" href="#id63">5.3.2.6. UpdateDAOの使用例</a><a class="headerlink" href="#updatedao" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id19">
<h4><a class="toc-backref" href="#id64">5.3.2.6.1. 1件挿入</a><a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h4>
<p>1件のデータの挿入する場合、以下のような実装となる。</p>
<ul class="simple">
<li>Xxx.java</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="c1">// (1)</span>
<span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Todo</span><span class="o">();</span>
<span class="n">todo</span><span class="o">.</span><span class="na">setTodoId</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span>
<span class="n">todo</span><span class="o">.</span><span class="na">setTodoTitle</span><span class="o">(</span><span class="n">todoTitle</span><span class="o">);</span>
<span class="n">todo</span><span class="o">.</span><span class="na">setFinished</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
<span class="n">todo</span><span class="o">.</span><span class="na">setCreatedAt</span><span class="o">(</span><span class="n">now</span><span class="o">);</span>
<span class="kt">int</span> <span class="n">insertedCount</span> <span class="o">=</span> <span class="n">updateDAO</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">&quot;todo.insert&quot;</span><span class="o">,</span> <span class="n">todo</span><span class="o">);</span> <span class="c1">// (2)</span>
<span class="k">if</span><span class="o">(</span><span class="n">insertedCount</span> <span class="o">!=</span> <span class="mi">1</span><span class="o">){</span>  <span class="c1">// (3)</span>
    <span class="c1">// ...               // (4)</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>挿入対象のデータ(JavaBean)を生成する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>挿入用SQLのSQLIDと、挿入対象のデータ(JavaBean)を指定して、DAOを実行する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>必要に応じて、実際に挿入されたデータの件数を、チェックする。例では、挿入件数が1件であるかをチェックしている。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>必要に応じて、実際に挿入された件数が、想定件数と異なる場合の処理を行う。</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id20">
<h4><a class="toc-backref" href="#id65">5.3.2.6.2. 複数件挿入(バッチ実行)</a><a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">複数のSQLを、バッチ実行することで、複数件のデータを挿入する場合は、以下のような実装となる。</div>
<div class="line">TERASOLUNA DAOから提供されている<tt class="docutils literal"><span class="pre">jp.terasoluna.fw.dao.SqlHolder</span></tt>を使用する。</div>
</div>
<ul class="simple">
<li>Xxx.java</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="c1">// (1)</span>
<span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Todo</span><span class="o">();</span>
<span class="n">todo</span><span class="o">.</span><span class="na">setTodoId</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span>
<span class="n">todo</span><span class="o">.</span><span class="na">setTodoTitle</span><span class="o">(</span><span class="n">todoTitle</span><span class="o">);</span>
<span class="n">todo</span><span class="o">.</span><span class="na">setFinished</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
<span class="n">todo</span><span class="o">.</span><span class="na">setCreatedAt</span><span class="o">(</span><span class="n">now</span><span class="o">);</span>

<span class="c1">// (2)</span>
<span class="n">Todo</span> <span class="n">todo2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Todo</span><span class="o">();</span>
<span class="n">todo2</span><span class="o">.</span><span class="na">setTodoId</span><span class="o">(</span><span class="n">todoId2</span><span class="o">);</span>
<span class="n">todo2</span><span class="o">.</span><span class="na">setTodoTitle</span><span class="o">(</span><span class="n">todoTitle2</span><span class="o">);</span>
<span class="n">todo2</span><span class="o">.</span><span class="na">setFinished</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
<span class="n">todo2</span><span class="o">.</span><span class="na">setCreatedAt</span><span class="o">(</span><span class="n">now</span><span class="o">);</span>

<span class="n">List</span><span class="o">&lt;</span><span class="n">SqlHolder</span><span class="o">&gt;</span> <span class="n">sqlHolders</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">SqlHolder</span><span class="o">&gt;();</span> <span class="c1">// (3)</span>
<span class="n">sqlHolders</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">SqlHolder</span><span class="o">(</span><span class="s">&quot;todo.insert&quot;</span><span class="o">,</span> <span class="n">todo</span><span class="o">));</span>      <span class="c1">// (4)</span>
<span class="n">sqlHolders</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">SqlHolder</span><span class="o">(</span><span class="s">&quot;todo.insert&quot;</span><span class="o">,</span> <span class="n">todo2</span><span class="o">));</span>     <span class="c1">// (4)</span>
<span class="kt">int</span> <span class="n">insertedCount</span> <span class="o">=</span> <span class="n">updateDAO</span><span class="o">.</span><span class="na">executeBatch</span><span class="o">(</span><span class="n">sqlHolders</span><span class="o">);</span>  <span class="c1">// (5)</span>
<span class="k">if</span><span class="o">(</span><span class="n">insertedCount</span> <span class="o">!=</span> <span class="mi">2</span><span class="o">){</span>  <span class="c1">// (6)</span>
    <span class="c1">// ...               // (7)</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>挿入対象のデータ(JavaBean)を生成する。1件目のデータ。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>挿入対象のデータ(JavaBean)を生成する。2件目のデータ。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>バッチ実行用に、TERASOLUNA DAOから提供されている<tt class="docutils literal"><span class="pre">jp.terasoluna.fw.dao.SqlHolder</span></tt>のリストを生成する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>(1), (2)で生成したデータを、バインド用オブジェクトとして、SqlHolderのリストに追加する。例では、2件リストに追加している。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>(1)～(4)で生成したSqlHolderのリストを指定して、バッチを実行する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">必要に応じて、実際に挿入されたデータの件数をチェックする。</div>
<div class="line">例では、挿入件数が2件であるかをチェックしている。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td>必要に応じて、実際に挿入された件数が、想定件数と異なる場合の処理を行う。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<dl class="docutils">
<dt></dt>
<dd><div class="first last admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>バッチ実行における挿入件数について</strong></p>
<p class="last">バッチ実行した場合、JDBCドライバによっては、正確な行数が取得できないケースがある。
正確に取得できないドライバを使用する場合に、挿入件数をチェックする必要があるケースで、バッチ実行を使用しないこと。
(更新時の更新件数、削除時の削除件数も同様である。)</p>
</div>
</dd>
</dl>
</div>
<div class="section" id="id21">
<h4><a class="toc-backref" href="#id66">5.3.2.6.3. 1件更新</a><a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">1件のデータの更新する場合、以下のような実装となる。</div>
<div class="line">1件挿入の場合と同じである。使用するSQLが、更新用のSQLになる。</div>
</div>
<ul class="simple">
<li>Xxx.java</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="n">Todo</span> <span class="n">loadedTodo</span> <span class="o">=</span> <span class="n">queryDAO</span><span class="o">.</span><span class="na">executeForObject</span><span class="o">(</span><span class="s">&quot;todo.findOne&quot;</span><span class="o">,</span>
        <span class="n">todoId</span><span class="o">,</span>
        <span class="n">Todo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>     <span class="c1">// (1)</span>
<span class="n">todo2</span><span class="o">.</span><span class="na">setFinished</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span> <span class="c1">// (2)</span>
<span class="kt">int</span> <span class="n">updatedCount</span> <span class="o">=</span> <span class="n">updateDAO</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">&quot;todo.update&quot;</span><span class="o">,</span> <span class="n">todo</span><span class="o">);</span> <span class="c1">// (3)</span>
<span class="k">if</span><span class="o">(</span><span class="n">updatedCount</span> <span class="o">!=</span> <span class="mi">1</span><span class="o">){</span>   <span class="c1">// (4)</span>
    <span class="c1">// ...               // (5)</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>更新対象のデータ(JavaBean)を、検索する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>データを更新する。例では、finishedを、falseからtrueに更新する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>更新用SQLのSQLIDと、更新対象のデータ(JavaBean)を指定して、DAOを実行する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">必要に応じて、実際の更新されたデータの件数をチェックする。</div>
<div class="line">例では、更新件数が1件であるかをチェックしている。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>必要に応じて、実際に更新された件数が、想定件数と異なる場合の処理を行う。</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id22">
<h4><a class="toc-backref" href="#id67">5.3.2.6.4. 複数件更新(バッチ実行)</a><a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">複数のSQLをバッチ実行することで、複数件のデータを更新する場合の実装例は、複数件挿入(バッチ実行)と同じである。</div>
<div class="line">更新値が、レコード毎に異なる場合、バッチ実行による複数件更新が有効である。</div>
</div>
</div>
<div class="section" id="where">
<h4><a class="toc-backref" href="#id68">5.3.2.6.5. 複数件更新(WHERE句指定)</a><a class="headerlink" href="#where" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">SQLで指定した条件に一致するデータを一括で更新する場合、以下のような実装となる。</div>
<div class="line">全レコードを同じ値に一括更新する場合は、WHERE句指定による複数件更新が有効的である。</div>
</div>
<ul class="simple">
<li>Xxx.java</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kt">int</span> <span class="n">deadlineDays</span> <span class="o">=</span> <span class="mi">7</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">updatedCount</span> <span class="o">=</span> <span class="n">updateDAO</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">&quot;todo.update&quot;</span><span class="o">,</span> <span class="n">deadlineDays</span><span class="o">);</span> <span class="c1">// (1)</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>xxx-sqlmap.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre> <span class="nt">&lt;update</span> <span class="na">id=</span><span class="s">&quot;updateFinishedDeadlineByUnfinished&quot;</span> <span class="na">parameterClass=</span><span class="s">&quot;int&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
     <span class="cp">&lt;![CDATA[</span>
<span class="cp">     UPDATE</span>
<span class="cp">         todo</span>
<span class="cp">     SET</span>
<span class="cp">         todo_title = &#39;[Finished Deadline] &#39; || todo_title</span>
<span class="cp">         ,version = (version + 1)</span>
<span class="cp">     WHERE</span>
<span class="cp">         finished = false</span>
<span class="cp">     AND</span>
<span class="cp">         created_at &lt; current_date - #deadlineDays#</span>
<span class="cp">     ]]&gt;</span>
<span class="nt">&lt;/update&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>一括更新用SQLのSQLIDと、更新対象のデータを抽出するための条件を指定して、DAOを実行する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>一括更新するSQLの実装例。例では、作成してから7日経過して、完了していないTODOのタイトルに&#8221;[Finished Deadline] &#8220;という文字列を先頭に付与している。</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id23">
<h4><a class="toc-backref" href="#id69">5.3.2.6.6. 1件削除</a><a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h4>
<p>1件のデータの削除する場合、以下のような実装となる。</p>
<ul class="simple">
<li>Xxx.java</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="n">String</span> <span class="n">todoId</span> <span class="o">=</span> <span class="s">&quot;xxxxx....&quot;</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">deletedCount</span> <span class="o">=</span> <span class="n">updateDAO</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">&quot;todo.delete&quot;</span><span class="o">,</span> <span class="n">todoId</span><span class="o">);</span> <span class="c1">// (1)</span>
<span class="k">if</span><span class="o">(</span><span class="n">deletedCount</span> <span class="o">!=</span> <span class="mi">1</span><span class="o">){</span>
    <span class="c1">// ...               // (2)</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">削除用SQLのSQLIDとPKを指定して、DAOを実行する。</div>
<div class="line">例では、<tt class="docutils literal"><span class="pre">java.lang.String</span></tt>にしているが、複合キーの場合は、JavaBeanを指定することもできる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>必要に応じて、実際に削除された件数が、想定件数と異なる場合の処理を行う。</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id24">
<h4><a class="toc-backref" href="#id70">5.3.2.6.7. 複数件削除(バッチ実行)</a><a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">複数のSQLをバッチ実行することで、複数件のデータを削除する場合の実装例は、複数件更新(バッチ実行)と同じである。</div>
<div class="line">1件削除時の処理を共有する必要がある場合は、バッチ実行による複数件削除を使用する。ただし、削除する対象データが大量になる場合は、WHERE句指定による一括削除の方式を検討した方がよい。</div>
</div>
</div>
<div class="section" id="id25">
<h4><a class="toc-backref" href="#id71">5.3.2.6.8. 複数件削除(WHERE句指定)</a><a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">SQLで指定した条件に一致するデータを一括で削除する場合の実装例は、複数件更新(WHERE句指定)と同じである。</div>
<div class="line">削除対象のレコードが大量になる場合は、WHERE句指定による複数件削除が有効的である。</div>
</div>
</div>
</div>
<div class="section" id="storedproceduredao">
<h3><a class="toc-backref" href="#id72">5.3.2.7. StoredProcedureDAOの使用例</a><a class="headerlink" href="#storedproceduredao" title="Permalink to this headline">¶</a></h3>
<p>プロシージャや、ファンクションを呼び出す場合、以下のような実装となる。</p>
<ul class="simple">
<li>Xxx.java</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="n">SalesItem</span> <span class="n">item</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SalesItem</span><span class="o">();</span> <span class="c1">// (1)</span>
<span class="n">item</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>  <span class="c1">// (2)</span>
<span class="n">storedProcedureDAO</span><span class="o">.</span><span class="na">executeForObject</span><span class="o">(</span><span class="s">&quot;todo.findSalesItem&quot;</span><span class="o">,</span> <span class="n">item</span><span class="o">);</span>  <span class="c1">// (3)</span>
<span class="c1">// (4)</span>
<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Quantity is {}.&quot;</span><span class="o">,</span> <span class="n">item</span><span class="o">.</span><span class="na">getQuantity</span><span class="o">());</span>
<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Total is {}.&quot;</span><span class="o">,</span> <span class="n">item</span><span class="o">.</span><span class="na">getTotal</span><span class="o">());</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>プロシージャや、ファンクションのINパラメータを、OUTパラメータを保持するバインド用オブジェクトを生成する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>INパラメータとして、IDをを設定する。例では、IDとして、<tt class="docutils literal"><span class="pre">1</span></tt>を設定している。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>ストアードプロシージャ呼び出し用SQLの、SQLIDとバインド用オブジェクトを引数に、<tt class="docutils literal"><span class="pre">StoredProcedureDAO</span></tt>のメソッドを呼び出す。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">StoredProcedureDAO</span></tt>のメソッドの呼び出しが、正常に終了した場合、</div>
<div class="line">プロシージャや、ファンクションのOUTパラメータが、バインド用オブジェクトに設定される。</div>
<div class="line">例では、バインド用オブジェクトに設定されたOUTパラメータの値を、ログに出力している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="queryrowhandledao">
<h3><a class="toc-backref" href="#id73">5.3.2.8. QueryRowHandleDAOの使用例</a><a class="headerlink" href="#queryrowhandledao" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Xxx.java</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kt">boolean</span> <span class="n">finished</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="n">queryRowHandleDAO</span><span class="o">.</span><span class="na">executeWithRowHandler</span><span class="o">(</span>
        <span class="s">&quot;todo.findByFinished&quot;</span><span class="o">,</span>            <span class="c1">// (1)</span>
        <span class="n">finished</span><span class="o">,</span>                         <span class="c1">// (2)</span>
        <span class="k">new</span> <span class="nf">DataRowHandler</span><span class="o">()</span> <span class="o">{</span>            <span class="c1">// (3)</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleRow</span><span class="o">(</span><span class="n">Object</span> <span class="n">valueObject</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (4)</span>
                <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="o">(</span><span class="n">Todo</span><span class="o">)</span> <span class="n">valueObject</span><span class="o">;</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">todo</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>  <span class="c1">// (5)</span>
            <span class="o">}</span>
        <span class="o">});</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>検索結果が、0～N件となるSQLの、SQLIDを指定する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SQLのバインドパラメータを指定する。</div>
<div class="line">例では、booleanにしているが、複数のパラメータ(検索条件)を渡したい場合は、JavaBeanを指定することもできる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">jp.terasoluna.fw.dao.event.DataRowHandler</span></tt>の実装オブジェクトを指定する。</div>
<div class="line">例では、無名クラスを使用しているが、実際のプロジェクトでは、実装クラスを作成することを検討すること。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">検索結果の1レコード毎に、handleRowメソッドが呼び出される。</div>
<div class="line">引数にわたってくるオブジェクトは、select要素にresultClass属性、または、resultMap要素のclass属性に指定したクラスのオブジェクトとなる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>例では、ログ出力しているだけだが、実際のプロジェクトで使う場合は、値の加工、各レコード値の集計、ファイル出力などの処理を行うことになる。</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="like">
<span id="data-access-mybatis2-howtouse-like-escape"></span><h3><a class="toc-backref" href="#id74">5.3.2.9. LIKE検索時のエスケープについて</a><a class="headerlink" href="#like" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">LIKE検索を行う場合は、検索条件として使用する値を、LIKE検索用にエスケープする必要がある。</div>
<div class="line">LIKE検索用のエスケープ処理は、共通ライブラリから提供している<tt class="docutils literal"><span class="pre">org.terasoluna.gfw.common.query.QueryEscapeUtils</span></tt>クラスのメソッドを使用することで、実現できる。</div>
<div class="line">共通ライブラリから提供しているエスケープ処理の仕様については、<a class="reference internal" href="DataAccessCommon.html"><em>データベースアクセス（共通編）</em></a>の<a class="reference internal" href="DataAccessCommon.html#data-access-common-appendix-like-escape"><em>LIKE検索時のエスケープについて</em></a>を参照されたい。</div>
</div>
<div class="line-block">
<div class="line">以下に、共通ライブラリから提供しているエスケープ処理の、使用方法について説明する。</div>
</div>
<div class="section" id="query">
<h4><a class="toc-backref" href="#id75">5.3.2.9.1. 一致方法をQuery側で指定する場合の使用方法</a><a class="headerlink" href="#query" title="Permalink to this headline">¶</a></h4>
<p>一致方法(前方一致、後方一致、部分一致)の指定をJPQLとして指定する場合は、エスケープのみ行うメソッドを使用する。</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">xxx-sqlmap.xml</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre>// (1) (2)
<span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAllByWord&quot;</span> <span class="na">parameterClass=</span><span class="s">&quot;String&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;resultMap_Article&quot;</span><span class="nt">&gt;</span>
  SELECT
      *
  FROM
      article
  WHERE
      title LIKE &#39;%&#39; || #word# || &#39;%&#39; ESCAPE &#39;~&#39;
  OR
      overview LIKE &#39;%&#39; || #word# || &#39;%&#39; ESCAPE &#39;~&#39;
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SQL内に、LIKE検索用のワイルドカード(<tt class="docutils literal"><span class="pre">&quot;%&quot;</span></tt>または<tt class="docutils literal"><span class="pre">&quot;_&quot;</span></tt>)を指定する。</div>
<div class="line">上記例では、引数<tt class="docutils literal"><span class="pre">word</span></tt>の前後に、ワイルドカード(<tt class="docutils literal"><span class="pre">&quot;%&quot;</span></tt>)を指定することで、一致方法を部分一致にしている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">共通ライブラリから提供しているエスケープ処理は、エスケープ文字として<tt class="docutils literal"><span class="pre">&quot;~&quot;</span></tt>を使用しているため、 LIKE句の後ろに<tt class="docutils literal"><span class="pre">&quot;ESCAPE</span> <span class="pre">'~'&quot;</span></tt>を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Service or Repository</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="nd">@Inject</span>
<span class="n">QueryDAO</span> <span class="n">queryDAO</span><span class="o">;</span>

<span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">Page</span><span class="o">&lt;</span><span class="n">Article</span><span class="o">&gt;</span> <span class="nf">searchArticle</span><span class="o">(</span><span class="n">ArticleSearchCriteria</span> <span class="n">criteria</span><span class="o">,</span>
        <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">String</span> <span class="n">escapedWord</span> <span class="o">=</span> <span class="n">QueryEscapeUtils</span><span class="o">.</span><span class="na">toLikeCondition</span><span class="o">(</span><span class="n">criteria</span><span class="o">.</span><span class="na">getWord</span><span class="o">());</span> <span class="c1">// (3)</span>

    <span class="kt">long</span> <span class="n">total</span> <span class="o">=</span> <span class="n">queryDAO</span><span class="o">.</span><span class="na">executeForObject</span><span class="o">(</span><span class="s">&quot;article.countByWord&quot;</span><span class="o">,</span>
            <span class="n">escapedWord</span><span class="o">,</span> <span class="n">Long</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Article</span><span class="o">&gt;</span> <span class="n">contents</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">total</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">queryDAO</span><span class="o">.</span><span class="na">executeForObjectList</span><span class="o">(</span><span class="s">&quot;article.findAllByWord&quot;</span><span class="o">,</span>
                <span class="n">escapedWord</span><span class="o">,</span> <span class="n">pageable</span><span class="o">.</span><span class="na">getOffset</span><span class="o">(),</span> <span class="n">pageable</span><span class="o">.</span><span class="na">getPageSize</span><span class="o">());</span> <span class="c1">// (4)</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">PageImpl</span><span class="o">&lt;</span><span class="n">Article</span><span class="o">&gt;(</span><span class="n">contents</span><span class="o">,</span> <span class="n">pageable</span><span class="o">,</span> <span class="n">total</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">LIKE検索の一致方法をQuery側で指定する場合は、<tt class="docutils literal"><span class="pre">QueryEscapeUtils#toLikeCondition(String)</span></tt>メソッドを呼び出し、LIKE検索用のエスケープのみ行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">LIKE検索用にエスケープされた値を、<tt class="docutils literal"><span class="pre">QueryDAO</span></tt>のバインドパラメータに渡す。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id26">
<h4><a class="toc-backref" href="#id76">5.3.2.9.2. 一致方法をロジック側で指定する場合の使用方法</a><a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h4>
<p>一致方法(前方一致、後方一致、部分一致)をロジック側で判定する場合は、エスケープされた値にワイルドカードを付与するメソッドを使用する。</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">xxx-sqlmap.xml</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre>// (1)
<span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAllByWord&quot;</span> <span class="na">parameterClass=</span><span class="s">&quot;String&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;resultMap_Article&quot;</span><span class="nt">&gt;</span>
  SELECT
      *
  FROM
      article
  WHERE
      title LIKE #word# ESCAPE &#39;~&#39;
  OR
      overview LIKE #word# ESCAPE &#39;~&#39;
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SQL内に、LIKE検索用のワイルドカードは、指定しない。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Service or Repository</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="nd">@Inject</span>
<span class="n">QueryDAO</span> <span class="n">queryDAO</span><span class="o">;</span>

<span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">Page</span><span class="o">&lt;</span><span class="n">Article</span><span class="o">&gt;</span> <span class="nf">searchArticle</span><span class="o">(</span><span class="n">ArticleSearchCriteria</span> <span class="n">criteria</span><span class="o">,</span>
        <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">String</span> <span class="n">escapedWord</span>  <span class="o">=</span> <span class="n">QueryEscapeUtils</span>
            <span class="o">.</span><span class="na">toContainingCondition</span><span class="o">(</span><span class="n">criteria</span><span class="o">.</span><span class="na">getWord</span><span class="o">());</span> <span class="c1">// (2)</span>

    <span class="kt">long</span> <span class="n">total</span> <span class="o">=</span> <span class="n">queryDAO</span><span class="o">.</span><span class="na">executeForObject</span><span class="o">(</span><span class="s">&quot;article.countByWord&quot;</span><span class="o">,</span>
            <span class="n">escapedWord</span><span class="o">,</span> <span class="n">Long</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Article</span><span class="o">&gt;</span> <span class="n">contents</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">total</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">queryDAO</span><span class="o">.</span><span class="na">executeForObjectList</span><span class="o">(</span><span class="s">&quot;article.findAllByWord&quot;</span><span class="o">,</span>
                <span class="n">escapedWord</span><span class="o">,</span> <span class="n">pageable</span><span class="o">.</span><span class="na">getOffset</span><span class="o">(),</span> <span class="n">pageable</span><span class="o">.</span><span class="na">getPageSize</span><span class="o">());</span> <span class="c1">// (3)</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">PageImpl</span><span class="o">&lt;</span><span class="n">Article</span><span class="o">&gt;(</span><span class="n">contents</span><span class="o">,</span> <span class="n">pageable</span><span class="o">,</span> <span class="n">total</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ロジック側で一致方法を指定する場合は、  以下の何れかのメソッドを呼び出し、LIKE検索用のエスケープとLIKE検索用のワイルドカードを付与する。</div>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">QueryEscapeUtils#toStartingWithCondition(String)</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">QueryEscapeUtils#toEndingWithCondition(String)</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">QueryEscapeUtils#toContainingCondition(String)</span></tt></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">LIKE検索用にエスケープ＋ワイルドカードが付与された値を、<tt class="docutils literal"><span class="pre">QueryDAO</span></tt>のバインドパラメータに渡す。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div>
<div class="section" id="sql-injection">
<h3><a class="toc-backref" href="#id77">5.3.2.10. SQL Injection対策について</a><a class="headerlink" href="#sql-injection" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">SQLを組み立てる際は、SQL Injectionが発生しないように、注意する必要がある。</div>
<div class="line">Mybatis2では、SQLに値を埋め込む仕組みを、2つ提供している。</div>
</div>
<ul>
<li><div class="first line-block">
<div class="line">バインド変数を使って埋め込む方法。</div>
<div class="line">この方法を使用すると、 SQL組み立て後に<tt class="docutils literal"><span class="pre">java.sql.PreparedStatement</span></tt>を使用して、値が埋め込められるため、安全に値を埋め込むことができる。</div>
<div class="line"><strong>ユーザからの入力値をSQLに埋め込む場合は、原則バインド変数を使用すること。</strong></div>
</div>
</li>
<li><div class="first line-block">
<div class="line">置換変数を使って埋め込む方法。</div>
<div class="line">この方法を使用すると、SQLを組み立てるタイミングで、文字列として置換されてしまうため、安全な値の埋め込みは、保証されない。</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>ユーザからの入力値を置換変数を使って埋め込むと、SQL Injectionが発生する危険性が高くなることを意識すること。
ユーザからの入力値を置換変数を使って埋め込む必要がある場合は、かならずSQL Injectionが発生しないことを保障するための、入力チェックを実施すること。</p>
<p class="last">基本的には、 <strong>ユーザからの入力値はそのまま使わないことを強く推奨する。</strong></p>
</div>
</div></blockquote>
<div class="section" id="id27">
<h4><a class="toc-backref" href="#id78">5.3.2.10.1. バインド変数を使って埋め込む方法</a><a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">バインド変数を使用する場合は、 ParameterMapまたはInline Parametersを使用する。</div>
<div class="line">以下に、使用例を示す。</div>
</div>
<p>ParameterMapの使用例を、以下に示す。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;parameterMap</span> <span class="na">id=</span><span class="s">&quot;uploadBinaryParameterMap&quot;</span> <span class="na">class=</span><span class="s">&quot;BinaryFile&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parameter</span> <span class="na">property=</span><span class="s">&quot;fileId&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;parameter</span> <span class="na">property=</span><span class="s">&quot;fileName&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;parameter</span> <span class="na">property=</span><span class="s">&quot;content&quot;</span> <span class="na">jdbcType=</span><span class="s">&quot;BLOB&quot;</span> <span class="na">typeHandler=</span><span class="s">&quot;BlobInputStreamTypeHandler&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/parameterMap&gt;</span>

<span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;uploadBinary&quot;</span> <span class="na">parameterMap=</span><span class="s">&quot;uploadBinaryParameterMap&quot;</span><span class="nt">&gt;</span>
    INSERT INTO upload_binary
    (
        file_id
        ,file_name
        ,content
    )
    VALUES
    (
        ?   /* (2) */
        ,?
        ,?
    )
<span class="nt">&lt;/insert&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">バインド変数として値を埋め込むプロパティを定義する。定義した順番が、(2)で指定している<tt class="docutils literal"><span class="pre">?</span></tt>の位置に対応する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SQLにバインド変数を指定する。(1)で定義した順番で、<tt class="docutils literal"><span class="pre">?</span></tt>の部分に、値がバインドされる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>Inline Parametersの使用例を、以下に示す。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;insert&quot;</span>
        <span class="na">parameterClass=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model.Todo&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    INSERT INTO todo
        (
            todo_id
            ,todo_title
            ,finished
            ,created_at
            ,version
        )
        values(
            #todoId#       /* (3) */
            ,#todoTitle#
            ,#finished#
            ,#createdAt#
            ,1
        )
<span class="nt">&lt;/insert&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">バインドする値が格納されているプロパティのプロパティ名を、<tt class="docutils literal"><span class="pre">#</span></tt>で囲み、バインド変数として指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id28">
<h4><a class="toc-backref" href="#id79">5.3.2.10.2. 置換変数を使って埋め込む方法</a><a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h4>
<p>バインド変数を使用する場合の使用例を、以下に示す。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findByFinished&quot;</span>
        <span class="na">parameterClass=</span><span class="s">&quot;...&quot;</span>
        <span class="na">resultMap=</span><span class="s">&quot;resultMap_Todo&quot;</span><span class="nt">&gt;</span>
    SELECT
        *
    FROM
        todo
    WHERE
        finished = #finished#
    ORDER BY
        created_at $direction$  /* (4) */
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">置換する値が格納されているプロパティのプロパティ名を<tt class="docutils literal"><span class="pre">$</span></tt>で囲み、置換変数として指定する。</div>
<div class="line">上記例では、<tt class="docutils literal"><span class="pre">$direction$</span></tt>の部分は、<tt class="docutils literal"><span class="pre">&quot;DESC&quot;</span></tt>または<tt class="docutils literal"><span class="pre">&quot;ASC&quot;</span></tt>で置換される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>置換変数による埋め込みは、必ずアプリケーションとして安全な値であることを担保した上で、テーブル名、カラム名、ソート条件などに限定して、使用することを推奨する。</p>
<p>例えば、以下のようにコード値と実際に使用する安全な値をペアでMapに格納し、</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">safeValueMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
<span class="n">safeValueMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;1&quot;</span><span class="o">,</span> <span class="s">&quot;ASC&quot;</span><span class="o">);</span>
<span class="n">safeValueMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;2&quot;</span><span class="o">,</span> <span class="s">&quot;DESC&quot;</span><span class="o">);</span>
</pre></div>
</div>
</div></blockquote>
<p>実際の入力はコード値になるようにして、SQLを実行する処理中で変換することが望ましい。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="n">String</span> <span class="n">direction</span> <span class="o">=</span> <span class="n">safeValueMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">input</span><span class="o">.</span><span class="na">getDirection</span><span class="o">());</span>
</pre></div>
</div>
</div></blockquote>
<p class="last"><a class="reference internal" href="Codelist.html"><em>コードリスト</em></a>を使用しても良い。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="appendix">
<h2><a class="toc-backref" href="#id80">5.3.3. Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id29">
<h3><a class="toc-backref" href="#id81">5.3.3.1. 関連オブジェクトを１回のSQLでまとめて取得する実装例</a><a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">テーブル毎にEntityのようなJavaBeanを用意して、データベースにアクセスする際に、関連オブジェクトを、1回のSQLでまとめて取得する方法について説明する。</div>
<div class="line">この方法は、N+1問題を回避する手段としても使用される。</div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>以下の点に注意して、使用すること。</p>
<ul class="last simple">
<li>本例では、使い方を説明するために、すべての関連オブジェクトを、1回のSQLでまとめて取得している。
しかしながら、実際のプロジェクトで使用する場合は、処理で必要となる関連オブジェクトのみ取得するようにすること。
なぜなら、使用しない関連オブジェクトを、同時に取得してしまった場合、性能劣化の原因となるケースがあるからである。</li>
<li>使用頻度の低い、1:Nの関係をもつ関連オブジェクトについては、まとめて取得しない。
必要なときに、個別に取得する方法を採用した方がよいケースがある。
性能要件を満たせる場合は、まとめて取得してもよい。</li>
<li>1:Nの関係となる関連オブジェクトが、多く含まれる場合、まとめて取得すると、マッピング処理に使用されない無駄なデータの取得が行われ、性能劣化の原因となるケースがある。
性能要件を満たせる場合は、まとめて取得してもよいが、他の方法を検討した方がよい。</li>
</ul>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">N+1問題の回避手段については、Mybatis Developer Guide(PDF)の「Result Maps/Avoiding N+1 Selects (1:1)」(P.37-38)及び「Result Maps/Avoiding N+1 Selects (1:M and M:N)」(P.39-40)を参照されたい。</p>
</div>
<div class="line-block">
<div class="line">以降では、注文テーブルを使って、具体的に実装例について説明する。</div>
<div class="line">説明で使用するテーブルは、以下の通りである。</div>
</div>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/dataaccess_er.png"><img alt="ER diagram" src="../_images/dataaccess_er.png" style="width: 90%;" /></a>
<p class="caption"><strong>Picture - ER diagram</strong></p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="15%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">カテゴリ</th>
<th class="head">テーブル名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>トランザクション系</td>
<td>t_order</td>
<td>注文を保持するテーブル。１つの注文に対して、1レコードが格納される。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>&nbsp;</td>
<td>t_order_item</td>
<td>１つの注文で購入された商品を保持するテーブル。1つの注文で、複数の商品が購入された場合は、商品数分レコードが格納される。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>&nbsp;</td>
<td>t_order_coupon</td>
<td>１つの注文で使用されたクーポンを保持するテーブル。1つの注文で、複数のクーポンが使用された場合は、クーポン数分レコードが格納される。クーポンを使用しなかった場合は、レコードは格納されない。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>マスタ系</td>
<td>m_item</td>
<td>商品を定義するマスタテーブル。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>&nbsp;</td>
<td>m_category</td>
<td>カテゴリを定義するマスタテーブル。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td>&nbsp;</td>
<td>m_item_category</td>
<td>商品が所属するカテゴリを定義するマスタテーブル。商品とカテゴリのマッピングを保持している。1つの商品は、複数のカテゴリに属すことができるモデルとなっている。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td>&nbsp;</td>
<td>m_coupon</td>
<td>クーポンを定義するマスタテーブル。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td>コード系</td>
<td>c_order_status</td>
<td>注文ステータスを定義するコードテーブル。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>トランザクション系テーブルのレイアウトと、格納されているレコードは、以下の通りである。</p>
<blockquote>
<div><p><strong>t_order</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">id(PK)</th>
<th class="head">status_code</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>accepted</td>
</tr>
<tr class="row-odd"><td>2</td>
<td>checking</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><p><strong>t_order_item</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">order_id(PK)</th>
<th class="head">item_code(PK)</th>
<th class="head">quantity</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>ITM0000001</td>
<td>10</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>ITM0000002</td>
<td>20</td>
</tr>
<tr class="row-even"><td>2</td>
<td>ITM0000001</td>
<td>30</td>
</tr>
<tr class="row-odd"><td>2</td>
<td>ITM0000002</td>
<td>40</td>
</tr>
</tbody>
</table>
<p><strong>t_order_coupon</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">order_id(PK)</th>
<th class="head">coupon_code(PK)</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>CPN0000001</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>CPN0000002</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>マスタ系テーブルのレイアウトと、格納されているレコードは、以下の通りである。</p>
<blockquote>
<div><p><strong>m_item</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">code(PK)</th>
<th class="head">name</th>
<th class="head">price</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>ITM0000001</td>
<td>Orange juice</td>
<td>100</td>
</tr>
<tr class="row-odd"><td>ITM0000002</td>
<td>NotePC</td>
<td>100000</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><p><strong>m_category</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">code(PK)</th>
<th class="head">name</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>CTG0000001</td>
<td>Drink</td>
</tr>
<tr class="row-odd"><td>CTG0000002</td>
<td>PC</td>
</tr>
<tr class="row-even"><td>CTG0000003</td>
<td>Hot selling</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><p><strong>m_item_category</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">item_code(PK)</th>
<th class="head">category_code(PK)</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>ITM0000001</td>
<td>CTG0000001</td>
</tr>
<tr class="row-odd"><td>ITM0000002</td>
<td>CTG0000002</td>
</tr>
<tr class="row-even"><td>ITM0000002</td>
<td>CTG0000003</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><p><strong>m_coupon</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">code(PK)</th>
<th class="head">name</th>
<th class="head">price</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>CPN0000001</td>
<td>Join coupon</td>
<td>3000</td>
</tr>
<tr class="row-odd"><td>CPN0000002</td>
<td>PC coupon</td>
<td>30000</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>コード系テーブルのレイアウトと、格納されているレコードは、以下の通りである。</p>
<blockquote>
<div><p><strong>c_order_status</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">code(PK)</th>
<th class="head">name</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>accepted</td>
<td>Order accepted</td>
</tr>
<tr class="row-odd"><td>checking</td>
<td>Stock checking</td>
</tr>
<tr class="row-even"><td>shipped</td>
<td>Item Shipped</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>以降で説明する実装例では、上記テーブルに格納されているデータを、以下のJavaBeanにマッピングして、取得する。</p>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/dataaccess_entity.png"><img alt="Class(JavaBean) diagram" src="../_images/dataaccess_entity.png" style="width: 90%;" /></a>
<p class="caption"><strong>Picture - Class(JavaBean) diagram</strong></p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="17%" />
<col width="72%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">クラス名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>Order</td>
<td>t_orderテーブルの1レコードを表現するJavaBean。 関連オブジェクトとして、<tt class="docutils literal"><span class="pre">OrderStatus</span></tt>と<tt class="docutils literal"><span class="pre">OrderItem</span></tt>および<tt class="docutils literal"><span class="pre">OrderCoupon</span></tt>を複数保持する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>OrderItem</td>
<td>t_order_itemテーブルの1レコードを表現するJavaBean。 関連オブジェクトとして、<tt class="docutils literal"><span class="pre">Item</span></tt>を保持する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>OrderCoupon</td>
<td>t_order_couponテーブルの1コードを表現するJavaBean。関連オブジェクトとして、<tt class="docutils literal"><span class="pre">Coupon</span></tt>を保持する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>Item</td>
<td>m_itemテーブルの1コードを表現するJavaBean。 関連オブジェクトとして、所属している<tt class="docutils literal"><span class="pre">Category</span></tt>を複数保持する。<tt class="docutils literal"><span class="pre">Item</span></tt>と<tt class="docutils literal"><span class="pre">Category</span></tt>の紐づけは、m_item_categoryテーブルによって行われる。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>Category</td>
<td>m_categoryテーブルの1レコードを表現するJavaBean。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td>Coupon</td>
<td>m_couponテーブルの1レコードを表現するJavaBean。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td>OrderStatus</td>
<td>c_order_statusテーブルの1レコードを表現するJavaBean。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>JavaBeanのプロパティ定義は、以下の通りである。</p>
<ul class="simple">
<li>Order.java</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">OrderItem</span><span class="o">&gt;</span> <span class="n">orderItems</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">OrderCoupon</span><span class="o">&gt;</span> <span class="n">orderCoupons</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">OrderStatus</span> <span class="n">status</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>OrderItem.java</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderItem</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">orderId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">itemCode</span><span class="o">;</span> <span class="c1">// &lt;!-- (1) --&gt;</span>
    <span class="kd">private</span> <span class="n">Item</span> <span class="n">item</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">quantity</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>保持する値が、直後の変数<tt class="docutils literal"><span class="pre">item</span></tt>の<tt class="docutils literal"><span class="pre">code</span></tt>プロパティと重複する。これは、後述するresultMap要素の、groupBy属性によるレコードの、グルーピングを行う際に必要になるため、定義している。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>OrderCoupon.java</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderCoupon</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">orderId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">couponCode</span><span class="o">;</span> <span class="c1">// (1)</span>
    <span class="kd">private</span> <span class="n">Coupon</span> <span class="n">coupon</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>保持する値が、直後の変数<tt class="docutils literal"><span class="pre">Coupon</span></tt>の<tt class="docutils literal"><span class="pre">code</span></tt>プロパティと重複する。これは、後述するresultMap要素の、groupBy属性によるレコードの、グルーピングを行う際に必要になるため、定義している。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Item.java</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Item</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">code</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">price</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="n">categories</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>Category.java</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Category</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">code</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>Coupon.java</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Coupon</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">code</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">price</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>OrderStatus.java</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderStatus</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">code</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">SQLマッピングを実装する。</div>
<div class="line">関連するオブジェクトを、1回のSQLでまとめて取得する場合、取得したいテーブルをJOINして、マッピングに必要なすべてのレコードを取得する。</div>
<div class="line">取得したレコードは、resultMap要素にマッピング定義を行い、JavaBeanにマッピングする。</div>
</div>
<div class="line-block">
<div class="line">以下では、1件のOrderを取得するSQL(findOne)と、すべてのOrderを取得するSQL(findAll)の実装例となっている。</div>
<div class="line">なお、以下の実装例では、ネームスペースに<tt class="docutils literal"><span class="pre">&quot;order&quot;</span></tt>を指定し、 マッピングするJavaBeanは、typeAliasを使って、パッケージ名を除いたクラス名が定義してある前提となっている。</div>
</div>
<ul class="simple">
<li>sqlMapConfig.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;typeAlias</span> <span class="na">alias=</span><span class="s">&quot;Order&quot;</span> <span class="na">type=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model.Order&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;typeAlias</span> <span class="na">alias=</span><span class="s">&quot;OrderStatus&quot;</span> <span class="na">type=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model.OrderStatus&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;typeAlias</span> <span class="na">alias=</span><span class="s">&quot;OrderItem&quot;</span> <span class="na">type=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model.OrderItem&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;typeAlias</span> <span class="na">alias=</span><span class="s">&quot;OrderCoupon&quot;</span> <span class="na">type=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model.OrderCoupon&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;typeAlias</span> <span class="na">alias=</span><span class="s">&quot;Item&quot;</span> <span class="na">type=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model.Item&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;typeAlias</span> <span class="na">alias=</span><span class="s">&quot;Category&quot;</span> <span class="na">type=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model.Category&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;typeAlias</span> <span class="na">alias=</span><span class="s">&quot;Coupon&quot;</span> <span class="na">type=</span><span class="s">&quot;xxxxxx.yyyyyy.zzzzzz.domain.model.Coupon&quot;</span><span class="nt">/&gt;</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>order-sqlmap.xml</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;sqlMap</span> <span class="na">namespace=</span><span class="s">&quot;order&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- ... --&gt;</span>

<span class="nt">&lt;/sqlMap&gt;</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">まず、SQLについて説明する。</div>
<div class="line">実際の定義は、resultMap要素の後に、定義すること。</div>
</div>
<p>SQLの実装</p>
<ul class="simple">
<li>findOne/findAll共通部分のSQL定義(sql要素)</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;sql</span> <span class="na">id=</span><span class="s">&quot;fragment_selectFormJoin&quot;</span><span class="nt">&gt;</span>         <span class="c">&lt;!-- (1) --&gt;</span>
    SELECT                                   /* (2) */
        o.id
        ,os.code AS status_code
        ,os.name AS status_name
        ,ol.quantity
        ,i.code AS item_code
        ,i.name AS item_name
        ,i.price AS item_price
        ,ct.code AS category_code
        ,ct.name AS category_name
        ,cp.code AS coupon_code
        ,cp.name AS coupon_name
        ,cp.price AS coupon_price
    FROM
        t_order o
    INNER JOIN                                /* (3) */
        c_order_status os
            ON os.code = o.status_code
    INNER JOIN
        t_orderline ol
            ON ol.order_id = o.id
    INNER JOIN
        m_item i
            ON i.code = ol.item_code
    INNER JOIN
        m_item_category ic
            ON ic.item_code = i.code
    INNER JOIN
        m_category ct
            ON ct.code = ic.category_code
    LEFT JOIN                                  /* (4) */
        t_order_coupon oc
            ON oc.order_id = o.id
    LEFT JOIN
        m_coupon cp
            ON cp.code = oc.coupon_code
<span class="nt">&lt;/sql&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>findOneと、findAllでSELECT句、FROM句、JOIN句を共有するためのsql要素。findOneとfindAllで、多くの共通部分があったので共通化している。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>関連オブジェクトを生成するために、必要なデータをすべて取得する。カラム名は、重複しないようにする必要がある。上記例では、<tt class="docutils literal"><span class="pre">code</span></tt>, <tt class="docutils literal"><span class="pre">name</span></tt>, <tt class="docutils literal"><span class="pre">price</span></tt>が重複するため、AS句で別名を指定している。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>関連オブジェクトを生成するために、必要なデータが格納されているテーブルを結合する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>データが格納されない可能性のあるテーブルについては、外部結合とする。クーポンを使用しない場合、t_group_couponにレコードが格納されないので外部結合にする必要がある。t_group_couponと結合するt_couponも同様である。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>findOneのSQL定義</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterClass=</span><span class="s">&quot;java.lang.Integer&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;orderResultMap&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">&quot;fragment_selectFormJoin&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    WHERE
        o.id = #id#         /* (3) */
    ORDER BY                /* (4) */
        item_code ASC       /* (5) */
        ,category_code ASC  /* (6) */
        ,coupon_code ASC    /* (7) */
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>指定された注文IDの、<tt class="docutils literal"><span class="pre">Order</span></tt>オブジェクトおよび関連オブジェクトを取得するためのSQL。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>findAllと共有するSELECT句、FROM句、JOIN句が実装されたSQLを、インクルードしている。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>バインド値で渡された注文IDを、WHERE句に指定する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>1:Nの関係の関連オブジェクトがある場合は、リスト内の並び順を制御するための、ORDER BY句を指定する。並び順を意識する必要がない場合は、指定は不要である。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><tt class="docutils literal"><span class="pre">Order#orderItems</span></tt>のリストを、t_itemテーブルのcodeカラムの昇順にするための指定。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><tt class="docutils literal"><span class="pre">Item#categories</span></tt>のリストを、t_categoryテーブルのcodeカラムの昇順にするための指定。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><tt class="docutils literal"><span class="pre">Order#orderCoupons</span></tt>のリストを、t_couponのcodeの昇順にするための指定。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>findAllのSQL定義</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAll&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;orderResultMap&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">&quot;fragment_selectFormJoin&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    ORDER BY
        o.id DESC     /* (3) */
        ,i.code ASC
        ,ct.code ASC
        ,cp.code ASC
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>すべてのOrder、および、関連オブジェクトを取得するためのSQL。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>findOneとfindAllでSELECT句、FROM句、JOIN句を共有するためのsql要素。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>取得されるリストの並び順を、t_orderのidの降順にするための指定。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line">上記SQL(findAll)を実行した結果、以下のレコードが取得される。</div>
<div class="line">注文レコードとしては2件だが、レコードが複数件格納される関連テーブルと結合しているため、合計で9レコードが取得される。</div>
<div class="line">1～3行目は、注文IDが<tt class="docutils literal"><span class="pre">2</span></tt>の <tt class="docutils literal"><span class="pre">Order</span></tt>オブジェクトを生成するためのレコード、4～9行目は注文IDが<tt class="docutils literal"><span class="pre">1</span></tt>の <tt class="docutils literal"><span class="pre">Order</span></tt>オブジェクトを生成するためのレコードとなる。</div>
</div>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/dataaccess_sql_result.png"><img alt="Result Set of findAll" src="../_images/dataaccess_sql_result.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - Result Set of findAll</strong></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>上記レコードを、<tt class="docutils literal"><span class="pre">Order</span></tt>オブジェクト、および、関連オブジェクトにマッピングする方法について説明する。</p>
<div class="line-block">
<div class="line">resultMap要素の実装</div>
<div class="line">それぞれの説明については、後述する。</div>
</div>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;orderResultMap&quot;</span> <span class="na">class=</span><span class="s">&quot;Order&quot;</span> <span class="na">groupBy=</span><span class="s">&quot;id&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;id&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;status&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;order.orderStatusResultMap&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderItems&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;order.orderItemResultMap&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderCoupons&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;order.orderCouponResultMap&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>

<span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;orderStatusResultMap&quot;</span> <span class="na">class=</span><span class="s">&quot;OrderStatus&quot;</span> <span class="na">groupBy=</span><span class="s">&quot;code&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;code&quot;</span> <span class="na">column=</span><span class="s">&quot;status_code&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;status_name&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>

<span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;orderItemResultMap&quot;</span> <span class="na">class=</span><span class="s">&quot;OrderItem&quot;</span> <span class="na">groupBy=</span><span class="s">&quot;itemCode&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;itemCode&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;item&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;order.itemResultMap&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;quantity&quot;</span> <span class="na">column=</span><span class="s">&quot;quantity&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>

<span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;itemResultMap&quot;</span> <span class="na">class=</span><span class="s">&quot;Item&quot;</span> <span class="na">groupBy=</span><span class="s">&quot;code&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;code&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;item_name&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;price&quot;</span> <span class="na">column=</span><span class="s">&quot;item_price&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;categories&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;order.categoryResultMap&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>

<span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;categoryResultMap&quot;</span> <span class="na">class=</span><span class="s">&quot;Category&quot;</span> <span class="na">groupBy=</span><span class="s">&quot;code&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;code&quot;</span> <span class="na">column=</span><span class="s">&quot;category_code&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;category_name&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>

<span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;orderCouponResultMap&quot;</span> <span class="na">class=</span><span class="s">&quot;OrderCoupon&quot;</span> <span class="na">groupBy=</span><span class="s">&quot;couponCode&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;couponCode&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_code&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;coupon&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;order.couponResultMap&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>

<span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;couponResultMap&quot;</span> <span class="na">class=</span><span class="s">&quot;Coupon&quot;</span> <span class="na">groupBy=</span><span class="s">&quot;code&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;code&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_code&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_name&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;price&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_price&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>各resultMap要素の役割と依存関係を、以下に示す。</p>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/dataaccess_resultmap.png"><img alt="Implementation of ResultMap" src="../_images/dataaccess_resultmap.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - Implementation of ResultMap</strong></p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したレコードを<tt class="docutils literal"><span class="pre">Order</span></tt>オブジェクトにマッピングするための定義。</div>
<div class="line">関連オブジェクト(<tt class="docutils literal"><span class="pre">OrderStatus</span></tt>, <tt class="docutils literal"><span class="pre">OrderItem</span></tt>, <tt class="docutils literal"><span class="pre">OrderCoupon</span></tt>)のマッピングは、別のresultMapに委譲している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したレコードを、<tt class="docutils literal"><span class="pre">OrderStatus</span></tt>オブジェクトにマッピングするための定義。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したレコードを、<tt class="docutils literal"><span class="pre">OrderItem</span></tt>オブジェクトにマッピングするための定義。</div>
<div class="line">関連オブジェクト(<tt class="docutils literal"><span class="pre">Item</span></tt>)のマッピングは別のresultMapに委譲している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したレコードを、<tt class="docutils literal"><span class="pre">Item</span></tt>オブジェクトにマッピングするための定義。</div>
<div class="line">関連オブジェクト(<tt class="docutils literal"><span class="pre">Category</span></tt>)のマッピングは、別のresultMapに委譲している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したレコードを、<tt class="docutils literal"><span class="pre">Category</span></tt>オブジェクトにマッピングするための定義。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したレコードを、<tt class="docutils literal"><span class="pre">OrderCoupon</span></tt>オブジェクトにマッピングするための定義。</div>
<div class="line">関連オブジェクト(<tt class="docutils literal"><span class="pre">Coupon</span></tt>)のマッピングは、別のresultMapに委譲している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したレコードを、<tt class="docutils literal"><span class="pre">Coupon</span></tt>オブジェクトにマッピングするための定義。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><tt class="docutils literal"><span class="pre">Order</span></tt>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;orderResultMap&quot;</span> <span class="na">class=</span><span class="s">&quot;Order&quot;</span> <span class="na">groupBy=</span><span class="s">&quot;id&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;id&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;status&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;order.orderStatusResultMap&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderItems&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;order.orderItemResultMap&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderCoupons&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;order.orderCouponResultMap&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (5) --&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/dataaccess_resultmap_order.png"><img alt="ResultMap for Order" src="../_images/dataaccess_resultmap_order.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - ResultMap for Order</strong></p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したレコードは、注文毎にグループ化する必要があるため、注文を一意に識別するための値が格納されている<tt class="docutils literal"><span class="pre">id</span></tt>プロパティを、groupBy属性に指定する。</div>
<div class="line">本例では、<tt class="docutils literal"><span class="pre">id</span></tt>プロパティでグループ化されるため、<tt class="docutils literal"><span class="pre">id=1</span></tt>と<tt class="docutils literal"><span class="pre">id=2</span></tt>の２つの<tt class="docutils literal"><span class="pre">Order</span></tt>オブジェクトが、生成される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したレコードの<tt class="docutils literal"><span class="pre">id</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">Order#id</span></tt>に設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">OrderStatus</span></tt>オブジェクトの生成を、<tt class="docutils literal"><span class="pre">id=&quot;order.orderStatusResultMap&quot;</span></tt>のresultMapに委譲し、生成されたオブジェクトを、<tt class="docutils literal"><span class="pre">Order#status</span></tt>に設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">OrderItem</span></tt>オブジェクトの生成を、<tt class="docutils literal"><span class="pre">id=&quot;order.orderItemResultMap&quot;</span></tt>のresultMapに委譲し、生成されたオブジェクトを、<tt class="docutils literal"><span class="pre">Order#orderItems</span></tt>のリストに追加する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><tt class="docutils literal"><span class="pre">OrderCoupon</span></tt>オブジェクトの生成を、<tt class="docutils literal"><span class="pre">id=&quot;order.orderCouponResultMap&quot;</span></tt>のresultMapに委譲し、生成されたオブジェクトを、<tt class="docutils literal"><span class="pre">Order#orderCoupons</span></tt>のリストに追加する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>以降では、<tt class="docutils literal"><span class="pre">id=1</span></tt>の<tt class="docutils literal"><span class="pre">Order</span></tt>オブジェクトへのマッピングに、焦点を当てて説明する。</p>
<p><tt class="docutils literal"><span class="pre">OrderStatus</span></tt>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;orderStatusResultMap&quot;</span> <span class="na">class=</span><span class="s">&quot;OrderStatus&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;code&quot;</span> <span class="na">column=</span><span class="s">&quot;status_code&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;status_name&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/dataaccess_resultmap_orderstatus.png"><img alt="ResultMap for OrderStatus" src="../_images/dataaccess_resultmap_orderstatus.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - ResultMap for OrderStatus</strong></p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"> <tt class="docutils literal"><span class="pre">Order</span></tt>と、<tt class="docutils literal"><span class="pre">OrderStatus</span></tt>オブジェクトは、1:1の関係なので、groupBy属性の指定は不要である。</div>
<div class="line">本例では、<tt class="docutils literal"><span class="pre">code=accepted</span></tt>の<tt class="docutils literal"><span class="pre">OrderStatus</span></tt>オブジェクトが生成される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したレコードの、<tt class="docutils literal"><span class="pre">status_code</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">OrderStatus#code</span></tt>に設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したレコードの、<tt class="docutils literal"><span class="pre">status_name</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">OrderStatus#name</span></tt>に設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><tt class="docutils literal"><span class="pre">OrderItem</span></tt>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;orderItemResultMap&quot;</span> <span class="na">class=</span><span class="s">&quot;OrderItem&quot;</span> <span class="na">groupBy=</span><span class="s">&quot;itemCode&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;itemCode&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;item&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;order.itemResultMap&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;quantity&quot;</span> <span class="na">column=</span><span class="s">&quot;quantity&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/dataaccess_resultmap_orderitem.png"><img alt="ResultMap for OrderItem" src="../_images/dataaccess_resultmap_orderitem.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - ResultMap for OrderItem</strong></p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">Order</span></tt>と<tt class="docutils literal"><span class="pre">OrderItem</span></tt>は、1:Nの関係なので、groupBy属性の指定が必要である。</div>
<div class="line">注文商品は、t_order_itemのプライマリキー(order_id,item_code)でグループ化する必要があるが、order_idカラムについては、親のresultMapで指定されているため、ここでは、item_codeカラムの値を保持する<tt class="docutils literal"><span class="pre">itemCode</span></tt>プロパティのみ指定する。</div>
<div class="line">本例では、<tt class="docutils literal"><span class="pre">itemCode</span></tt>プロパティでグループ化されるため、<tt class="docutils literal"><span class="pre">itemCode=ITM0000001</span></tt>と<tt class="docutils literal"><span class="pre">itemCode=ITM0000002</span></tt>の、２つの<tt class="docutils literal"><span class="pre">OrderItem</span></tt>オブジェクトが生成される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したレコードの<tt class="docutils literal"><span class="pre">item_code</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">OrderItem#itemCode</span></tt>に設定する。</div>
<div class="line">(3)で生成される<tt class="docutils literal"><span class="pre">Item#code</span></tt>と重複するが、<tt class="docutils literal"><span class="pre">itemCode</span></tt>プロパティは、<tt class="docutils literal"><span class="pre">OrderItem</span></tt>をグループ化するために必要なプロパティとなる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">Item</span></tt>オブジェクトの生成を、<tt class="docutils literal"><span class="pre">id=&quot;order.itemResultMap&quot;</span></tt>のresultMapに委譲し、生成されたオブジェクトを<tt class="docutils literal"><span class="pre">OrderItem#item</span></tt>に設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したレコードの<tt class="docutils literal"><span class="pre">quantity</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">OrderItem#quantity</span></tt>に設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><tt class="docutils literal"><span class="pre">Item</span></tt>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;itemResultMap&quot;</span> <span class="na">class=</span><span class="s">&quot;Item&quot;</span> <span class="na">groupBy=</span><span class="s">&quot;code&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;code&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;item_name&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;price&quot;</span> <span class="na">column=</span><span class="s">&quot;item_price&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;categories&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;order.categoryResultMap&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (5) --&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/dataaccess_resultmap_item.png"><img alt="ResultMap for Item" src="../_images/dataaccess_resultmap_item.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - ResultMap for Item</strong></p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"> <tt class="docutils literal"><span class="pre">OrderItem</span></tt>と<tt class="docutils literal"><span class="pre">Item</span></tt>オブジェクトは、1:1の関係だが、<tt class="docutils literal"><span class="pre">Item</span></tt>と<tt class="docutils literal"><span class="pre">Category</span></tt>は、1:Nの関係なので、groupBy属性の指定が必要である。</div>
<div class="line">カテゴリは商品毎にグループ化する必要があるため、商品を一意に識別するための値が格納されている<tt class="docutils literal"><span class="pre">code</span></tt>プロパティを、groupBy属性に指定する。</div>
<div class="line">本例では、<tt class="docutils literal"><span class="pre">OrderItem#itemCode=ITM0000001</span></tt>用に、 <tt class="docutils literal"><span class="pre">code=ITM0000001</span></tt>の<tt class="docutils literal"><span class="pre">Item</span></tt>オブジェクトが、<tt class="docutils literal"><span class="pre">OrderItem#itemCode=ITM0000002</span></tt>用に、<tt class="docutils literal"><span class="pre">code=ITM0000002</span></tt>の<tt class="docutils literal"><span class="pre">Item</span></tt>オブジェクトが生成される。(計２つのオブジェクトが生成される。)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したレコードの<tt class="docutils literal"><span class="pre">item_code</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">Item#code</span></tt>に設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したレコードの<tt class="docutils literal"><span class="pre">item_name</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">Item#name</span></tt>に設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したレコードの<tt class="docutils literal"><span class="pre">item_price</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">Item#price</span></tt>に設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">Category</span></tt>オブジェクトの生成を、<tt class="docutils literal"><span class="pre">id=&quot;order.categoryResultMap&quot;</span></tt>のresultMapに委譲し、生成されたオブジェクトを <tt class="docutils literal"><span class="pre">Item#categories</span></tt> のリストに追加する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><tt class="docutils literal"><span class="pre">Category</span></tt>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;categoryResultMap&quot;</span> <span class="na">class=</span><span class="s">&quot;Category&quot;</span> <span class="na">groupBy=</span><span class="s">&quot;code&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;code&quot;</span> <span class="na">column=</span><span class="s">&quot;category_code&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;category_name&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/dataaccess_resultmap_category.png"><img alt="ResultMap for Item" src="../_images/dataaccess_resultmap_category.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - ResultMap for Item</strong></p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">本例では、1:Nの関係のテーブル(t_orderとt_order_line、t_orderとt_order_coupon)を複数結合しているため、 t_order_couponに複数レコードが格納されていると <tt class="docutils literal"><span class="pre">Item</span></tt>オブジェクト内に保持する<tt class="docutils literal"><span class="pre">Category</span></tt>オブジェクトのリストが、重複してしまう。</div>
<div class="line">重複をなくすために、カテゴリを一意に識別するための値が格納されている<tt class="docutils literal"><span class="pre">code</span></tt>プロパティを、groupBy属性に指定する。<tt class="docutils literal"><span class="pre">code</span></tt>プロパティの値が、同じ<tt class="docutils literal"><span class="pre">Category</span></tt>オブジェクトが一つにマージされ、重複をなくすことができる。</div>
<div class="line">本例では、<tt class="docutils literal"><span class="pre">Item#code=ITM0000001</span></tt>用に、<tt class="docutils literal"><span class="pre">code=CTG0000001</span></tt>の<tt class="docutils literal"><span class="pre">Category</span></tt>オブジェクトが、<tt class="docutils literal"><span class="pre">Item#code=ITM0000002</span></tt>用に、<tt class="docutils literal"><span class="pre">code=CTG0000002</span></tt>と、<tt class="docutils literal"><span class="pre">code=CTG0000003</span></tt>の2つの<tt class="docutils literal"><span class="pre">Category</span></tt>オブジェクトが生成される。(計3つのオブジェクトが生成される。)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したレコードの <tt class="docutils literal"><span class="pre">item_code</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">Item#code</span></tt>に設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したレコードの <tt class="docutils literal"><span class="pre">item_name</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">Item#name</span></tt>に設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><tt class="docutils literal"><span class="pre">OrderCoupon</span></tt>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;orderCouponResultMap&quot;</span> <span class="na">class=</span><span class="s">&quot;OrderCoupon&quot;</span> <span class="na">groupBy=</span><span class="s">&quot;couponCode&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;couponCode&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_code&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;coupon&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;order.couponResultMap&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/dataaccess_resultmap_ordercoupon.png"><img alt="ResultMap for OrderCoupon" src="../_images/dataaccess_resultmap_ordercoupon.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - ResultMap for OrderCoupon</strong></p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"> <tt class="docutils literal"><span class="pre">Order</span></tt>と<tt class="docutils literal"><span class="pre">OrderCoupon</span></tt>は、1:Nの関係なので、groupBy属性の指定が必要である。</div>
<div class="line">注文クーポンは、t_order_couponのプライマリキー(order_id,coupon_code)でグループ化する必要があるが、order_idカラムについては親のresultMapで指定されているため、ここでは、coupon_codeカラムの値を保持する<tt class="docutils literal"><span class="pre">couponCode</span></tt>プロパティのみ指定する。</div>
<div class="line">本例では、<tt class="docutils literal"><span class="pre">couponCode</span></tt>プロパティでグループ化されるため、<tt class="docutils literal"><span class="pre">couponCode=CPN0000001</span></tt>と<tt class="docutils literal"><span class="pre">couponCode=CPN0000002</span></tt> 、の2つの <tt class="docutils literal"><span class="pre">OrderCoupon</span></tt>オブジェクトが生成される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したレコードの<tt class="docutils literal"><span class="pre">coupon_code</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">OrderCoupon#couponCode</span></tt>に設定する。</div>
<div class="line">(3)で生成される<tt class="docutils literal"><span class="pre">Coupon#code</span></tt>と重複するが、<tt class="docutils literal"><span class="pre">couponCode</span></tt>プロパティは、<tt class="docutils literal"><span class="pre">OrderCoupon</span></tt>をグループ化するために必要なプロパティとなる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">Coupon</span></tt>オブジェクトの生成を<tt class="docutils literal"><span class="pre">id=&quot;order.couponResultMap&quot;</span></tt>のresultMapに委譲し、生成されたオブジェクトを<tt class="docutils literal"><span class="pre">OrderCoupon#coupon</span></tt>に設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><tt class="docutils literal"><span class="pre">Coupon</span></tt>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;couponResultMap&quot;</span> <span class="na">class=</span><span class="s">&quot;Coupon&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;code&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_code&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_name&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;price&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_price&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/dataaccess_resultmap_coupon.png"><img alt="ResultMap for Coupon" src="../_images/dataaccess_resultmap_coupon.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - ResultMap for Coupon</strong></p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">OrderCoupon</span></tt>と<tt class="docutils literal"><span class="pre">Coupon</span></tt>オブジェクトは、1:1の関係なので、groupBy属性の指定が不要である。</div>
<div class="line">本例では、<tt class="docutils literal"><span class="pre">OrderCoupon#couponCode=CPN0000001</span></tt>用に、<tt class="docutils literal"><span class="pre">code=CPN0000001</span></tt>の<tt class="docutils literal"><span class="pre">Coupon</span></tt>オブジェクトが、<tt class="docutils literal"><span class="pre">OrderCoupon#couponCode=CPN0000001</span></tt>用に、<tt class="docutils literal"><span class="pre">code=CPN0000001</span></tt>の<tt class="docutils literal"><span class="pre">Coupon</span></tt>オブジェクトが生成される。(計２つのオブジェクトが生成される。)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したレコードの<tt class="docutils literal"><span class="pre">coupon_code</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">Coupon#code</span></tt>に設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したレコードの<tt class="docutils literal"><span class="pre">coupon_name</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">Coupon#name</span></tt>に設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したレコードの<tt class="docutils literal"><span class="pre">coupon_price</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">Coupon#price</span></tt>に設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line">JavaBeanにマッピングされたレコードとカラムは、以下の通りである。</div>
<div class="line">グレーアウトしている部分は、groupBy属性に指定によって、グレーアウトされていない部分にマージされる。</div>
</div>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/dataaccess_sql_result_used.png"><img alt="Valid Result Set for result mapping" src="../_images/dataaccess_sql_result_used.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - Valid Result Set for result mapping</strong></p>
</div>
</div></blockquote>
<blockquote id="data-access-mybatis2-warning-sqlmapping-bulk">
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>1:Nの関連をもつレコードをJOINしてマッピングする場合、グレーアウトされている部分のデータの取得が無駄になる点を、意識しておくこと。</p>
<p class="last">Nの部分のデータを使用しない処理で、同じSQLを使用した場合、さらに無駄なデータの取得となってしまうので、Nの部分を取得するSQLと、取得しないSQLを、別々に用意しておくなどの工夫を行うこと。</p>
</div>
</div></blockquote>
<p>実際にマッピングされた<tt class="docutils literal"><span class="pre">Order</span></tt>オブジェクトおよび関連オブジェクトの状態は、以下の通りである。</p>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/dataaccess_object.png"><img alt="Mapped object diagram" src="../_images/dataaccess_object.png" style="width: 90%;" /></a>
<p class="caption"><strong>Picture - Mapped object diagram</strong></p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>関連オブジェクトを取得する別の方法として、取得したレコードの値を使って、内部で別のSQLを実行して、取得する方法がある。
内部で別のSQLを実行する方法は、個々のSQLや、resultMap要素の定義が、非常にシンプルとなる。
ただし、この方法で取得する場合は、N+1問題を引き起こす要因となることを、意識しておく必要がある。</p>
<p class="last">内部で別のSQLを実行する方法については、Mybatis Developer Guide(PDF)の「Result Maps/Complex Properties」(P.36-37)および「Result Maps/Composite Keys or Multiple Complex Parameters Properties」(P.40-41)を参照されたい。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>内部で別のSQLを実行する方法を使う場合、関連オブジェクトは &#8220;Eager Load&#8221; されるため、関連オブジェクトを使用しない場合も、SQLが実行されてしまう。
この動作回避する方法として、Mybatisでは、関連オブジェクトを &#8220;Lazy Load&#8221; する方法を、オプションとして提供している。</p>
<p>&#8220;Lazy Load&#8221;を有効にするための設定は、以下の通りである。</p>
<ul class="last simple">
<li>Mybatis設定ファイルのsetting要素のenhancementEnabled属性を、<tt class="docutils literal"><span class="pre">true</span></tt>に設定する。</li>
<li>CGLIB 2.xを、クラスパスに追加する。</li>
</ul>
</div>
</div></blockquote>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ExclusionControl.html" title="5.4. 排他制御"
             >next</a> |</li>
        <li class="right" >
          <a href="DataAccessJpa.html" title="5.2. データベースアクセス（JPA編）"
             >previous</a> |</li>
        <li><a href="../index.html">TERASOLUNA Global Framework Development Guideline 1.0.0.publicreview documentation</a> &raquo;</li>
          <li><a href="index.html" >5. TERASOLUNA Global Frameworkの機能詳細</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, NTT DATA.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.Theme by <a href="http://github.com/vkvn">vkvn</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>